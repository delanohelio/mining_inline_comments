{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NDAxNDI5", "number": 888, "title": "(fix) Fail early and throw useful exception if customer forgets to call Amplify.configure", "bodyText": "Fixes #868 by throwing a useful exception if customer tries to use a plugin before calling Amplify.configure().\nOne consequence of this new exception being thrown is that plugins need to be configured in a particular order now.  That is, Auth must be configured before Analytics, API, Storage, and Predictions now.  I accomplished this by moving Auth to the top of the list of the Amplify.buildCategoriesMap() method.    Previously, the API category was actually being configured before the Auth category.  During configuration of API, it actually grabs a reference to the Auth plugin, and saves a reference to the Auth escape hatch, the AWSMobileClient.   At this point, the AWSMobileClient is instantiated, but not initialized.  The AWSApiPlugin only saves a reference to it during configuration, so the fact that initialization happens later is actually okay, for now.  That said, if the AWSApiPlugin configure method is modified in the future to call any methods on the AWSMobileClient, it could cause issues that would be hard to debug.  This PR adds some safety to ensure that no plugin is used before it is configured.\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-10-07T17:18:42Z", "url": "https://github.com/aws-amplify/amplify-android/pull/888", "merged": true, "mergeCommit": {"oid": "62a51404377e2503aa694f21c57a698d4fb6247d"}, "closed": true, "closedAt": "2020-10-08T11:39:40Z", "author": {"login": "richardmcclellan"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQO457gH2gAyNDk5NDAxNDI5OmEyNzYzMWQxNjM5MjUxNTg2ZTg1M2FkNzA1MjRlNmI0ODk3MTU0ZTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQZzd8AFqTUwNDQxOTI3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a27631d1639251586e853ad70524e6b4897154e4", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a27631d1639251586e853ad70524e6b4897154e4", "committedDate": "2020-10-07T15:40:51Z", "message": "(fix) Fail early and throw useful exception if customer forgets to call Amplify.configure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MjkxMjAz", "url": "https://github.com/aws-amplify/amplify-android/pull/888#pullrequestreview-504291203", "createdAt": "2020-10-07T21:47:25Z", "commit": {"oid": "a27631d1639251586e853ad70524e6b4897154e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTo0NzoyNVrOHeGsMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTo0NzoyNVrOHeGsMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyODk0NQ==", "bodyText": "Suggested change", "url": "https://github.com/aws-amplify/amplify-android/pull/888#discussion_r501328945", "createdAt": "2020-10-07T21:47:25Z", "author": {"login": "richardmcclellan"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java", "diffHunk": "@@ -323,6 +324,7 @@ private void assertSyncProcessorNotStarted(ApiCategory mockApi) {\n     private ApiCategory mockApiCategoryWithGraphQlApi() throws AmplifyException {\n         ApiCategory mockApiCategory = spy(ApiCategory.class);\n         ApiPlugin<?> mockApiPlugin = mock(ApiPlugin.class);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a27631d1639251586e853ad70524e6b4897154e4"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8a6e1cc18fc0e663e585f0591d03587ff849880", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/e8a6e1cc18fc0e663e585f0591d03587ff849880", "committedDate": "2020-10-07T21:47:29Z", "message": "Update aws-datastore/src/test/java/com/amplifyframework/datastore/AWSDataStorePluginTest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MjkxMzIw", "url": "https://github.com/aws-amplify/amplify-android/pull/888#pullrequestreview-504291320", "createdAt": "2020-10-07T21:47:38Z", "commit": {"oid": "e8a6e1cc18fc0e663e585f0591d03587ff849880"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTo0NzozOFrOHeGsiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTo0NzozOFrOHeGsiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyOTAzNQ==", "bodyText": "Suggested change", "url": "https://github.com/aws-amplify/amplify-android/pull/888#discussion_r501329035", "createdAt": "2020-10-07T21:47:38Z", "author": {"login": "richardmcclellan"}, "path": "aws-auth-cognito/src/test/java/com/amplifyframework/auth/cognito/AuthComponentTest.java", "diffHunk": "@@ -1124,6 +1081,7 @@ public void signedInSessionWithExpiredTokens() throws AuthException {\n     @Test\n     public void getCurrentUser() {\n         doAnswer(invocation -> USERNAME).when(mobileClient).getUsername();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8a6e1cc18fc0e663e585f0591d03587ff849880"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4969657434073b8fa87bdc1da3c1429a0206b66", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/e4969657434073b8fa87bdc1da3c1429a0206b66", "committedDate": "2020-10-07T21:47:41Z", "message": "Update aws-auth-cognito/src/test/java/com/amplifyframework/auth/cognito/AuthComponentTest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MjkxNzA3", "url": "https://github.com/aws-amplify/amplify-android/pull/888#pullrequestreview-504291707", "createdAt": "2020-10-07T21:48:24Z", "commit": {"oid": "e4969657434073b8fa87bdc1da3c1429a0206b66"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTo0ODoyNFrOHeGtwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTo0ODoyNFrOHeGtwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyOTM0NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"Tried to get a plugin but that plugin was not present. \" +\n          \n          \n            \n                            \"Tried to get a plugin but that plugin was not present. \" +", "url": "https://github.com/aws-amplify/amplify-android/pull/888#discussion_r501329344", "createdAt": "2020-10-07T21:48:24Z", "author": {"login": "richardmcclellan"}, "path": "core/src/main/java/com/amplifyframework/core/category/Category.java", "diffHunk": "@@ -172,18 +174,21 @@ public final void removePlugin(@NonNull P plugin) {\n      * Retrieve a plugin by its key.\n      * @param pluginKey A key that identifies a plugin implementation\n      * @return The plugin object associated to pluginKey, if registered\n-     * @throws IllegalStateException If the requested plugin does not exist\n+     * @throws IllegalStateException If the requested plugin does not exist, or has not been configured.\n      */\n     @NonNull\n     public final P getPlugin(@NonNull final String pluginKey) throws IllegalStateException {\n         P plugin = plugins.get(pluginKey);\n-        if (plugin != null) {\n-            return plugin;\n-        } else {\n+        if (plugin == null) {\n             throw new IllegalStateException(\n-                \"Tried to get a plugin but that plugin was not present. \" +\n-                \"Check if the plugin was added originally or perhaps was already removed.\"\n+                    \"Tried to get a plugin but that plugin was not present. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4969657434073b8fa87bdc1da3c1429a0206b66"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d09d7fa1ccf5a05e98e7570a934ae35eed1dd43", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/4d09d7fa1ccf5a05e98e7570a934ae35eed1dd43", "committedDate": "2020-10-07T21:48:28Z", "message": "Update core/src/main/java/com/amplifyframework/core/category/Category.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MjkxODc0", "url": "https://github.com/aws-amplify/amplify-android/pull/888#pullrequestreview-504291874", "createdAt": "2020-10-07T21:48:43Z", "commit": {"oid": "4d09d7fa1ccf5a05e98e7570a934ae35eed1dd43"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTo0ODo0M1rOHeGuOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTo0ODo0M1rOHeGuOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyOTQ2NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        \"Check if the plugin was added originally or perhaps was already removed.\"\n          \n          \n            \n                                \"Check if the plugin was added originally or perhaps was already removed.\"", "url": "https://github.com/aws-amplify/amplify-android/pull/888#discussion_r501329464", "createdAt": "2020-10-07T21:48:43Z", "author": {"login": "richardmcclellan"}, "path": "core/src/main/java/com/amplifyframework/core/category/Category.java", "diffHunk": "@@ -172,18 +174,21 @@ public final void removePlugin(@NonNull P plugin) {\n      * Retrieve a plugin by its key.\n      * @param pluginKey A key that identifies a plugin implementation\n      * @return The plugin object associated to pluginKey, if registered\n-     * @throws IllegalStateException If the requested plugin does not exist\n+     * @throws IllegalStateException If the requested plugin does not exist, or has not been configured.\n      */\n     @NonNull\n     public final P getPlugin(@NonNull final String pluginKey) throws IllegalStateException {\n         P plugin = plugins.get(pluginKey);\n-        if (plugin != null) {\n-            return plugin;\n-        } else {\n+        if (plugin == null) {\n             throw new IllegalStateException(\n                 \"Tried to get a plugin but that plugin was not present. \" +\n-                \"Check if the plugin was added originally or perhaps was already removed.\"\n+                            \"Check if the plugin was added originally or perhaps was already removed.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d09d7fa1ccf5a05e98e7570a934ae35eed1dd43"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "906fd31557f3e3e5211925a6d5918af633be1a45", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/906fd31557f3e3e5211925a6d5918af633be1a45", "committedDate": "2020-10-07T21:48:47Z", "message": "Update core/src/main/java/com/amplifyframework/core/category/Category.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MjkxOTkx", "url": "https://github.com/aws-amplify/amplify-android/pull/888#pullrequestreview-504291991", "createdAt": "2020-10-07T21:48:59Z", "commit": {"oid": "906fd31557f3e3e5211925a6d5918af633be1a45"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTo0ODo1OVrOHeGunA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTo0ODo1OVrOHeGunA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyOTU2NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"Check if the plugin was added originally or perhaps was already removed.\"\n          \n          \n            \n                            \"Check if the plugin was added originally or perhaps was already removed.\"", "url": "https://github.com/aws-amplify/amplify-android/pull/888#discussion_r501329564", "createdAt": "2020-10-07T21:48:59Z", "author": {"login": "richardmcclellan"}, "path": "core/src/main/java/com/amplifyframework/core/category/Category.java", "diffHunk": "@@ -172,18 +174,21 @@ public final void removePlugin(@NonNull P plugin) {\n      * Retrieve a plugin by its key.\n      * @param pluginKey A key that identifies a plugin implementation\n      * @return The plugin object associated to pluginKey, if registered\n-     * @throws IllegalStateException If the requested plugin does not exist\n+     * @throws IllegalStateException If the requested plugin does not exist, or has not been configured.\n      */\n     @NonNull\n     public final P getPlugin(@NonNull final String pluginKey) throws IllegalStateException {\n         P plugin = plugins.get(pluginKey);\n-        if (plugin != null) {\n-            return plugin;\n-        } else {\n+        if (plugin == null) {\n             throw new IllegalStateException(\n                 \"Tried to get a plugin but that plugin was not present. \" +\n-                \"Check if the plugin was added originally or perhaps was already removed.\"\n+                    \"Check if the plugin was added originally or perhaps was already removed.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "906fd31557f3e3e5211925a6d5918af633be1a45"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76ce438e82de6d795a2a1b46e109e5b351adf1c9", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/76ce438e82de6d795a2a1b46e109e5b351adf1c9", "committedDate": "2020-10-07T21:49:02Z", "message": "Update core/src/main/java/com/amplifyframework/core/category/Category.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NDE5Mjc5", "url": "https://github.com/aws-amplify/amplify-android/pull/888#pullrequestreview-504419279", "createdAt": "2020-10-08T04:23:52Z", "commit": {"oid": "76ce438e82de6d795a2a1b46e109e5b351adf1c9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1743, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}