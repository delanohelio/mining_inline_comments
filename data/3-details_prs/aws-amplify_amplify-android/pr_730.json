{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NDM3MzMy", "number": 730, "title": "fix[aws-datastore] selection set for nested custom types", "bodyText": "This PR fixes a bug in the selection set involving fields of custom types.\nIssue #, if available:\n#702\nCustom types were not being transversed to build selection sets.\nDescription of changes:\nThis PR recursively introspects a custom type and adds its properties to the selection set.\nTODO\n\n Tests to ensure that mutation selection sets with inputs are being properly built.\n Tests to ensure serialization and deserialization to/from SQLite works as expected\n\nNot Handled*\n\nthere are instances that might lead to infinite recursion, e.g. circular relationships so we may want to set a hard max_depth unrelated to datastore's model association max_depth .\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-08-16T12:15:04Z", "url": "https://github.com/aws-amplify/amplify-android/pull/730", "merged": true, "mergeCommit": {"oid": "c0134e1effa6a660362cbc5bc74e2e97159274a7"}, "closed": true, "closedAt": "2020-08-31T13:16:00Z", "author": {"login": "saltonmassally"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_cpgFgH2gAyNDY4NDM3MzMyOmYxMjgwNjJjMmFiNTIxMWY4NjI5Nzc2ZGM5YmQ5YWU2MGI2NTRiMWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDueljgFqTQ3ODE0OTA2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f128062c2ab5211f8629776dc9bd9ae60b654b1d", "author": {"user": {"login": "saltonmassally", "name": "Salton Massally"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/f128062c2ab5211f8629776dc9bd9ae60b654b1d", "committedDate": "2020-08-16T12:05:59Z", "message": "fix[aws-datastore] selection set for nested custom types\n\nThis PR fixes a bug in the selection set invovling fields of custom types.\n\nResolves: https://github.com/aws-amplify/amplify-android/issues/702"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "818b8c9a72ecce0a156b45a32b7b5815816f64b0", "author": {"user": {"login": "saltonmassally", "name": "Salton Massally"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/818b8c9a72ecce0a156b45a32b7b5815816f64b0", "committedDate": "2020-08-19T08:08:25Z", "message": "add further test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3", "author": {"user": {"login": "saltonmassally", "name": "Salton Massally"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/c4f10f8cf97206ac2b3750f8fab29447eebfa7a3", "committedDate": "2020-08-19T10:06:45Z", "message": "check for custom type checks against the generic type if collection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMjQ4MjAw", "url": "https://github.com/aws-amplify/amplify-android/pull/730#pullrequestreview-471248200", "createdAt": "2020-08-20T05:00:06Z", "commit": {"oid": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNTowMDowNlrOHDpnYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMTo1NjowMFrOHHfH1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4OTYwMg==", "bodyText": "If possible, please avoid single letter variable names. They're hard to search for with tooling. For this one, maybe fieldContainerClazz?", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r473589602", "createdAt": "2020-08-20T05:00:06Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/SelectionSet.java", "diffHunk": "@@ -246,5 +252,75 @@ private SelectionSet wrapPagination(SelectionSet node) {\n             }\n             return result;\n         }\n+\n+        /**\n+         * We handle customType fields differently as DEPTH does not apply here.\n+         * @param clazz class we wish to build selection set for\n+         * @return\n+         */\n+        private Set<SelectionSet> getNestedCustomTypeFields(Class<?> clazz) {\n+            Set<SelectionSet> result = new HashSet<>();\n+            for (Field field : findFieldsIn(clazz)) {\n+                String fieldName = field.getName();\n+                if (isCustomType(field)) {\n+                    result.add(new SelectionSet(fieldName, getNestedCustomTypeFields(getClassForField(field))));\n+                } else {\n+                    result.add(new SelectionSet(fieldName, null));\n+                }\n+            }\n+            return result;\n+        }\n+\n+        /**\n+         * Helper for finding fields in a class.\n+         * @param clazz class we wish to introspect\n+         * @return\n+         */\n+        private List<Field> findFieldsIn(@NonNull Class<?> clazz) {\n+            final List<Field> fields = new ArrayList<>();\n+            Class<?> c = clazz;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4OTc4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    static boolean isCustomType(@NonNull Field field) {\n          \n          \n            \n                    private static boolean isCustomType(@NonNull Field field) {", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r473589782", "createdAt": "2020-08-20T05:00:30Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/SelectionSet.java", "diffHunk": "@@ -246,5 +252,75 @@ private SelectionSet wrapPagination(SelectionSet node) {\n             }\n             return result;\n         }\n+\n+        /**\n+         * We handle customType fields differently as DEPTH does not apply here.\n+         * @param clazz class we wish to build selection set for\n+         * @return\n+         */\n+        private Set<SelectionSet> getNestedCustomTypeFields(Class<?> clazz) {\n+            Set<SelectionSet> result = new HashSet<>();\n+            for (Field field : findFieldsIn(clazz)) {\n+                String fieldName = field.getName();\n+                if (isCustomType(field)) {\n+                    result.add(new SelectionSet(fieldName, getNestedCustomTypeFields(getClassForField(field))));\n+                } else {\n+                    result.add(new SelectionSet(fieldName, null));\n+                }\n+            }\n+            return result;\n+        }\n+\n+        /**\n+         * Helper for finding fields in a class.\n+         * @param clazz class we wish to introspect\n+         * @return\n+         */\n+        private List<Field> findFieldsIn(@NonNull Class<?> clazz) {\n+            final List<Field> fields = new ArrayList<>();\n+            Class<?> c = clazz;\n+            while (c != null) {\n+                for (Field field : c.getDeclaredFields()) {\n+                    fields.add(field);\n+                }\n+                c = c.getSuperclass();\n+            }\n+            Collections.sort(fields, Comparator.comparing(Field::getName));\n+            return Immutable.of(fields);\n+        }\n+\n+        /**\n+         * Helper to determine if field is a custom type. If custom types we need to build nested selection set.\n+         * @param field field we wish to check\n+         * @return\n+         */\n+        static boolean isCustomType(@NonNull Field field) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU5MDM1MA==", "bodyText": "There is a FieldFinder utility class which I believe is supposed do something like this? You could feel free to update/augment it, if it doesn't currently meet your needs.", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r473590350", "createdAt": "2020-08-20T05:01:30Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/SelectionSet.java", "diffHunk": "@@ -246,5 +252,75 @@ private SelectionSet wrapPagination(SelectionSet node) {\n             }\n             return result;\n         }\n+\n+        /**\n+         * We handle customType fields differently as DEPTH does not apply here.\n+         * @param clazz class we wish to build selection set for\n+         * @return\n+         */\n+        private Set<SelectionSet> getNestedCustomTypeFields(Class<?> clazz) {\n+            Set<SelectionSet> result = new HashSet<>();\n+            for (Field field : findFieldsIn(clazz)) {\n+                String fieldName = field.getName();\n+                if (isCustomType(field)) {\n+                    result.add(new SelectionSet(fieldName, getNestedCustomTypeFields(getClassForField(field))));\n+                } else {\n+                    result.add(new SelectionSet(fieldName, null));\n+                }\n+            }\n+            return result;\n+        }\n+\n+        /**\n+         * Helper for finding fields in a class.\n+         * @param clazz class we wish to introspect\n+         * @return\n+         */\n+        private List<Field> findFieldsIn(@NonNull Class<?> clazz) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxMTM5OQ==", "bodyText": ":-D", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r477611399", "createdAt": "2020-08-26T21:54:44Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java", "diffHunk": "@@ -161,7 +214,7 @@ public void validateSubscriptionGenerationOnUpdatePost() throws DataStoreExcepti\n     }\n \n     /**\n-     * Validates generation of a GraphQL document which requests a subscription for updates\n+     * Validates generation of a GraphQL document which requests a subscription for deletes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxMTQ3MQ==", "bodyText": "Suggested change", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r477611471", "createdAt": "2020-08-26T21:54:53Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java", "diffHunk": "@@ -195,4 +248,49 @@ public void validateMutationGenerationOnCreateComment() throws DataStoreExceptio\n \n         );\n     }\n+\n+    /**\n+     * Validates creation of a \"create a model\" request for nested custom type.\n+     * @throws DataStoreException On failure to interrogate the model fields.\n+     * @throws JSONException from JSONAssert.assertEquals.\n+     */\n+    @Test\n+    public void validateMutationGenerationOnCreateNestedCustomType() throws DataStoreException, JSONException {\n+        JSONAssert.assertEquals(\n+                Resources.readAsString(\"create-parent-request.txt\"),\n+                AppSyncRequestFactory.buildCreationRequest(buildTestParentModel()).getContent(),\n+                true\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxMTk4OA==", "bodyText": "Can you align the formatting in this file, so all blocks use all +2 or all +4? (What do the other .graphql files in the code base currently use?)", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r477611988", "createdAt": "2020-08-26T21:56:00Z", "author": {"login": "jamesonwilliams"}, "path": "testmodels/src/main/java/com/amplifyframework/testmodels/parenting/schema.graphql", "diffHunk": "@@ -0,0 +1,25 @@\n+type Parent @model {\n+  id: ID!\n+  name: String!\n+  address: Address!\n+  children: [Child]\n+}\n+\n+type Child {\n+\tname: String!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2MDEwNTUw", "url": "https://github.com/aws-amplify/amplify-android/pull/730#pullrequestreview-476010550", "createdAt": "2020-08-26T22:47:49Z", "commit": {"oid": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c6634219252c9267623a3b44b1ff431a63fb0fc", "author": {"user": {"login": "saltonmassally", "name": "Salton Massally"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/5c6634219252c9267623a3b44b1ff431a63fb0fc", "committedDate": "2020-08-29T04:34:42Z", "message": "Update aws-api-appsync/src/main/java/com/amplifyframework/api/aws/SelectionSet.java\n\nCo-authored-by: Jameson Williams <jhwilliams@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edaa92a54fcd45549e3f11f0a2c5332b07960f4e", "author": {"user": {"login": "saltonmassally", "name": "Salton Massally"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/edaa92a54fcd45549e3f11f0a2c5332b07960f4e", "committedDate": "2020-08-29T05:26:23Z", "message": "Update aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java\n\nCo-authored-by: Jameson Williams <jhwilliams@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d39e734912f0c346e7a33f2acb600632b7c2ea53", "author": {"user": {"login": "saltonmassally", "name": "Salton Massally"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/d39e734912f0c346e7a33f2acb600632b7c2ea53", "committedDate": "2020-08-29T05:52:06Z", "message": "move fieldFindIn to FieldFinder and some cosmetics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MTQ5MDIz", "url": "https://github.com/aws-amplify/amplify-android/pull/730#pullrequestreview-478149023", "createdAt": "2020-08-29T19:07:26Z", "commit": {"oid": "d39e734912f0c346e7a33f2acb600632b7c2ea53"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOVQxOTowNzoyNlrOHJdWcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOVQxOTowNzoyNlrOHJdWcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY4MDExNQ==", "bodyText": "Oh, ha, it was already a single letter variable. \ud83d\ude0a  Thanks for improving it.", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r479680115", "createdAt": "2020-08-29T19:07:26Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/util/FieldFinder.java", "diffHunk": "@@ -45,21 +46,40 @@ private FieldFinder() {\n      * @return set of fields\n      */\n     @NonNull\n-    public static List<Field> findFieldsIn(@NonNull Class<?> clazz) {\n+    public static List<Field> findModelFieldsIn(@NonNull Class<?> clazz) {\n         final List<Field> fields = new ArrayList<>();\n-        Class<?> c = clazz;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d39e734912f0c346e7a33f2acb600632b7c2ea53"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MTQ5MDY2", "url": "https://github.com/aws-amplify/amplify-android/pull/730#pullrequestreview-478149066", "createdAt": "2020-08-29T19:08:03Z", "commit": {"oid": "d39e734912f0c346e7a33f2acb600632b7c2ea53"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1961, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}