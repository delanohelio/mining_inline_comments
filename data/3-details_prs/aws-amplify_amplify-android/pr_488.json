{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwMzI1MjQw", "number": 488, "title": "[aws-api] add pagination", "bodyText": "Three big changes in this PR:\n\n\nRefactor GraphQLResponseFactory\n\nMoves most of logic from GraphQLResponseFactory into several JsonDeserializer objects.\nEliminates duplicated logic that was in place for serializing a response with one result vs multiple results.  The new approach is more generic and can handle any type of response.\nAllows serializing a response to any provided Type, instead of just T or Iterable<T>.\n\n\n\nRefactor what the type variables represent in GraphQLBehavior\n\nR is a new type variable representing the type of data on the GraphQLResponse.  (this can be either Model, Iterable<Model>, or Page<Model>, or other types in the future)\nT used to have multiple meanings - sometimes Model, sometimes type of data inside GraphQLResponse.  It now only represents Model, which makes all related code much easier to understand.\nThis is the same as the implementation on iOS.\n\n\n\nAdd pagination support (the smallest part of this PR)\n\nAdds an abstract Page class which contains a list of items and also and provides paging context (boolean hasNextPage(), and GraphQLRequest getRequestForNextPage()\nAdds an AppSyncPage concrete class to encapsulate AppSync specific paging logic, and associated AppSyncPageDeserializer\n\n\n\nDeveloper Experience:\n    private void listTodos() {\n        try {\n            int limit = 2;\n            String nextToken = null;\n            listTodos(AppSyncGraphQLRequestFactory.buildPagedQuery(Todo.class, null, limit, nextToken));\n        } catch (ApiException apiFailure) {\n            handleError(apiFailure);\n        }\n    }\n\n    private void listTodos(GraphQLRequest<Page<Todo>> request) {\n        Amplify.API.query(request, response -> {\n            if (response.hasData()) {\n                for (Todo todo : response.getData().getItems()) {\n                    Log.d(TAG, \"todo: \" + todo.getName());\n                }\n            }\n            if (response.hasErrors()) {\n                errors.addAll(response.getErrors());\n            }\n            if(response.getData().hasNextPage()) {\n                listTodos(response.getData().getRequestForNextPage());\n            }\n        }, apiException -> { \n             Log.e(TAG, exception.getMessage(), exception); \n        });\n    }\n\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-05-19T19:40:04Z", "url": "https://github.com/aws-amplify/amplify-android/pull/488", "merged": true, "mergeCommit": {"oid": "d87ac4acc104e05442a5c30c5f1a510fdd6a6920"}, "closed": true, "closedAt": "2020-05-21T23:52:44Z", "author": {"login": "richardmcclellan"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcinXESAH2gAyNDIwMzI1MjQwOmI4Y2I1ZDc2MGVlYjQ3ZmMzNTllNGE5N2Y2MzM0NGIxOWFiODIzNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjnuAlgFqTQxNDkwNDc0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b8cb5d760eeb47fc359e4a97f63344b19ab82340", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/b8cb5d760eeb47fc359e4a97f63344b19ab82340", "committedDate": "2020-05-18T22:11:00Z", "message": "Refactor GraphQLResponseFactory into JsonDeserializers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0ODk1NDQ2", "url": "https://github.com/aws-amplify/amplify-android/pull/488#pullrequestreview-414895446", "createdAt": "2020-05-19T23:37:40Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMzozNzo0MVrOGX2RKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMzo0NjowNVrOGX2bjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY1OTU2Mg==", "bodyText": "The current Checkstyle likes android and androidx together.", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r427659562", "createdAt": "2020-05-19T23:37:41Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLOperation.java", "diffHunk": "@@ -16,6 +16,7 @@\n package com.amplifyframework.api.aws;\n \n import android.annotation.SuppressLint;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MTA0Ng==", "bodyText": "Looks reasonable, remember to add equals, hashCode, toString before pushing", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r427661046", "createdAt": "2020-05-19T23:42:38Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncPage.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.amplifyframework.api.aws;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.GraphQLResponse;\n+import com.amplifyframework.api.graphql.Page;\n+\n+final class AppSyncPage<M> extends Page<M> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MTc4Mg==", "bodyText": "I guess this will mutate the existing request. It'd be better to return a new, immutable copy.\nTo illustate, consider what happens when:\nGraphQLRequest request = buildOne();\nrequest.getVaraiables() // state A \nnew AppSyncPage(response, request, token).getRequestForNextPage();\nrequest.getVariables(); // state B.", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r427661782", "createdAt": "2020-05-19T23:44:54Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncPage.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.amplifyframework.api.aws;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.GraphQLResponse;\n+import com.amplifyframework.api.graphql.Page;\n+\n+final class AppSyncPage<M> extends Page<M> {\n+    private final String NEXT_TOKEN_KEY = \"nextToken\";\n+\n+    private GraphQLRequest<Page<M>> request;\n+    private String nextToken;\n+\n+    public AppSyncPage(@NonNull GraphQLResponse<Iterable<M>> response,\n+                       @NonNull GraphQLRequest<Page<M>> request,\n+                       String nextToken) {\n+        super(response);\n+        this.request = request;\n+        this.nextToken = nextToken;\n+    }\n+\n+    @Override\n+    public boolean hasNextPage() {\n+        return nextToken != null;\n+    }\n+\n+    @Override\n+    public GraphQLRequest<Page<M>> getRequestForNextPage() {\n+        this.request.addVariable(NEXT_TOKEN_KEY, nextToken);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MjIyMw==", "bodyText": "Ah, I guess this thing here, the listTodos and under. This is the \"page\" right?", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r427662223", "createdAt": "2020-05-19T23:46:05Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncPageDeserializer.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.amplifyframework.api.aws;\n+\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.GraphQLResponse;\n+import com.amplifyframework.api.graphql.Page;\n+import com.google.gson.JsonDeserializationContext;\n+import com.google.gson.JsonDeserializer;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParseException;\n+import com.google.gson.reflect.TypeToken;\n+\n+import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+\n+/**\n+ * Takes an input such as the following and deserializes to an AppSyncPage\n+ * {\n+ *   \"data\": {\n+ *     \"listTodos\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTAxMzky", "url": "https://github.com/aws-amplify/amplify-android/pull/488#pullrequestreview-414901392", "createdAt": "2020-05-19T23:53:13Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NzY4OTY0", "url": "https://github.com/aws-amplify/amplify-android/pull/488#pullrequestreview-415768964", "createdAt": "2020-05-20T22:53:26Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMjo1MzoyNlrOGYgkCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMjo1MzoyNlrOGYgkCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM1MjUyMw==", "bodyText": "I'm open to suggestions on other names for this class.  We actually already have a Page object defined in core, which is used for local pagination via DataStore, so it's kinda confusing to have this one with the same name.", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r428352523", "createdAt": "2020-05-20T22:53:26Z", "author": {"login": "richardmcclellan"}, "path": "core/src/main/java/com/amplifyframework/api/graphql/Page.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package com.amplifyframework.api.graphql;\n+\n+public abstract class Page<M> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 3}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "d6fba48dbc1cee1568bd1c953c290978ffd0da5a", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/d6fba48dbc1cee1568bd1c953c290978ffd0da5a", "committedDate": "2020-05-20T22:54:15Z", "message": "Refactor API so that the response object type can be any provided Type and add API pagination support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6fba48dbc1cee1568bd1c953c290978ffd0da5a", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/d6fba48dbc1cee1568bd1c953c290978ffd0da5a", "committedDate": "2020-05-20T22:54:15Z", "message": "Refactor API so that the response object type can be any provided Type and add API pagination support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a4d00541d8afc6dc393960349d802eee063bf1b", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/8a4d00541d8afc6dc393960349d802eee063bf1b", "committedDate": "2020-05-21T02:06:26Z", "message": "Checkstyle issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cd28c7464cb0c04b5828c6d98873c732cdae4ca", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/7cd28c7464cb0c04b5828c6d98873c732cdae4ca", "committedDate": "2020-05-21T02:13:23Z", "message": "Merge from master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0fa1f311dcb9fc909ab1320b3fde8ac67cf1682", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/c0fa1f311dcb9fc909ab1320b3fde8ac67cf1682", "committedDate": "2020-05-21T15:05:47Z", "message": "Add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff2bbd95335b0bff0597949ca70e22a6fbf13ca2", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/ff2bbd95335b0bff0597949ca70e22a6fbf13ca2", "committedDate": "2020-05-21T15:55:33Z", "message": "Create TypeMaker utility class to wrap creating of Types so we arent leaking Gson TypeToken all over the codebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "578c6b1a2f234119e10aed86b181270c22883796", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/578c6b1a2f234119e10aed86b181270c22883796", "committedDate": "2020-05-21T16:46:06Z", "message": "Allow TypeMaker.getParameterizedType to accept multiple args"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "269ed552f41fa15ca746d6048cc98152e93fae8a", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/269ed552f41fa15ca746d6048cc98152e93fae8a", "committedDate": "2020-05-21T22:50:32Z", "message": "Rename Page to PaginatedResult so it is named the same thing as the Page for local datastore pagination"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5c8cd1b6901f24d57ba48849c33fa8b7ade5aa7", "author": {"user": {"login": "richardmcclellan", "name": "Richard McClellan"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/d5c8cd1b6901f24d57ba48849c33fa8b7ade5aa7", "committedDate": "2020-05-21T23:02:36Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTUzNzY0", "url": "https://github.com/aws-amplify/amplify-android/pull/488#pullrequestreview-416553764", "createdAt": "2020-05-21T23:16:43Z", "commit": {"oid": "d5c8cd1b6901f24d57ba48849c33fa8b7ade5aa7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTA0NzQ2", "url": "https://github.com/aws-amplify/amplify-android/pull/488#pullrequestreview-414904746", "createdAt": "2020-05-20T00:02:12Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMDowMjoxMlrOGX2wEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMTowNzo1N1rOGZHp3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2NzQ3Mw==", "bodyText": "Whoa", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r427667473", "createdAt": "2020-05-20T00:02:12Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/GsonFactory.java", "diffHunk": "@@ -60,7 +59,10 @@ private static void withDeserializers(GsonBuilder builder) {\n             .registerTypeAdapter(AWSTime.class, new TemporalDeserializers.AWSTimeDeserializer())\n             .registerTypeAdapter(AWSTimestamp.class, new TemporalDeserializers.AWSTimestampDeserializer())\n             .registerTypeAdapter(AWSDateTime.class, new TemporalDeserializers.AWSDateTimeDeserializer())\n-            .registerTypeAdapter(GraphQLResponse.Error.class, new GsonErrorDeserializer());\n+            .registerTypeAdapter(GraphQLResponse.class, new GraphQLResponseDeserializer())\n+            .registerTypeAdapter(GraphQLResponse.Error.class, new GsonErrorDeserializer())\n+            .registerTypeHierarchyAdapter(Iterable.class, new IterableDeserializer())", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5Mjk5MA==", "bodyText": "Yess!!! Love it :-D", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r428992990", "createdAt": "2020-05-22T01:07:57Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/GsonErrorDeserializer.java", "diffHunk": "@@ -66,7 +65,7 @@\n                     message = context.deserialize(value, String.class);\n                     break;\n                 case LOCATIONS_KEY:\n-                    Type locationsType = new TypeToken<List<GraphQLLocation>>() {}.getType();\n+                    Type locationsType = TypeMaker.getParameterizedType(List.class, GraphQLLocation.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5c8cd1b6901f24d57ba48849c33fa8b7ade5aa7"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2510, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}