{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NTY3OTQ3", "number": 658, "title": "fix(api): now correctly signs requests with query string params", "bodyText": "Issue #, if available:\n#650 #644\nDescription of changes:\n\nThe request was being SigV4 signed without adding the query parameters. This was fixed.\n\nMinor changes:\n\nURL is now decoded and re-encoded inside RestRequestFactory to ensure correct encoding.\nSigner now distinguishes AppSync and API gateway when signing\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-07-21T15:06:48Z", "url": "https://github.com/aws-amplify/amplify-android/pull/658", "merged": true, "mergeCommit": {"oid": "bf805a5758cbe09a23fd62859e681c8e9762dde0"}, "closed": true, "closedAt": "2020-07-24T00:47:40Z", "author": {"login": "raphkim"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc22ABAgH2gAyNDU0NTY3OTQ3OjRjZGYzMDM3YzJmNTg3MGFkMTFmZDAzYjBmYjY1YmZiZDQ3ZjJjZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc320CpAFqTQ1NDUyNjU5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4cdf3037c2f5870ad11fd03b0fb65bfbd47f2cf5", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/4cdf3037c2f5870ad11fd03b0fb65bfbd47f2cf5", "committedDate": "2020-07-20T18:32:53Z", "message": "Re-encode URL inside request factory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51f74e85afd374a14166d3dd707ff5c995bc9786", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/51f74e85afd374a14166d3dd707ff5c995bc9786", "committedDate": "2020-07-21T14:33:33Z", "message": "Make API signer service name account for REST"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fc55d4766e40124004e5a7d12a44c9c6a5f955d", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/3fc55d4766e40124004e5a7d12a44c9c6a5f955d", "committedDate": "2020-07-21T14:57:52Z", "message": "Add query string param in signer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5057021d135c5ebd52724dc3c377be0c7be8d9a", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/f5057021d135c5ebd52724dc3c377be0c7be8d9a", "committedDate": "2020-07-21T15:09:16Z", "message": "Checkstyle fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fed76a6d34c712bbe63c45bf0fe8c0de2376868", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/9fed76a6d34c712bbe63c45bf0fe8c0de2376868", "committedDate": "2020-07-21T15:12:09Z", "message": "Null-check query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTQ2ODAz", "url": "https://github.com/aws-amplify/amplify-android/pull/658#pullrequestreview-452946803", "createdAt": "2020-07-22T02:09:54Z", "commit": {"oid": "9fed76a6d34c712bbe63c45bf0fe8c0de2376868"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMjowOTo1NFrOG1QHoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMjoxNToxMlrOG1QNLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5MTgwOA==", "bodyText": "This enters the project from a transitive dependency. IMO we should minimize our use of com.amazonaws.* overall, and try to stick to public APIs related to the per-category functionalities.\nSince you're only using it for an isBlank(...) check, use our Empty.check(...) instead.", "url": "https://github.com/aws-amplify/amplify-android/pull/658#discussion_r458491808", "createdAt": "2020-07-22T02:09:54Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/sigv4/AppSyncSigV4SignerInterceptor.java", "diffHunk": "@@ -25,9 +25,15 @@\n import com.amazonaws.auth.AWSCredentialsProvider;\n import com.amazonaws.http.HttpMethodName;\n import com.amazonaws.util.IOUtils;\n+import com.amazonaws.util.StringUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fed76a6d34c712bbe63c45bf0fe8c0de2376868"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5MzIzMQ==", "bodyText": "I had some similar code recently and @richardmcclellan raised some good points: what would happen here if the URL were malformed? Is a null pointer or out-of-range error thrown?", "url": "https://github.com/aws-amplify/amplify-android/pull/658#discussion_r458493231", "createdAt": "2020-07-22T02:15:12Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/sigv4/AppSyncSigV4SignerInterceptor.java", "diffHunk": "@@ -221,23 +236,23 @@ public Response intercept(Chain chain) throws IOException {\n         return chain.proceed(okReqBuilder.build());\n     }\n \n-    // Utility method to convert string to human-readable format\n-    private String toHumanReadableAscii(String str) {\n-        for (int i = 0, length = str.length(), c; i < length; i += Character.charCount(c)) {\n-            c = str.codePointAt(i);\n-            if (c > '\\u001f' && c < '\\u007f') {\n-                continue;\n-            }\n-            Buffer buffer = new Buffer();\n-            buffer.writeUtf8(str, 0, i);\n-            for (int j = i; j < length; j += Character.charCount(c)) {\n-                c = str.codePointAt(j);\n-                if (c > '\\u001f' && c < '\\u007f') {\n-                    buffer.writeUtf8CodePoint(c);\n-                }\n-            }\n-            return buffer.readUtf8();\n+    // Extracts query string parameters from a URL.\n+    // Source: https://stackoverflow.com/questions/13592236/parse-a-uri-string-into-name-value-collection\n+    @NonNull\n+    private static Map<String, String> splitQuery(URL url) throws UnsupportedEncodingException {\n+        Map<String, String> queryPairs = new LinkedHashMap<>();\n+        String query = url.getQuery();\n+        if (StringUtils.isBlank(query)) {\n+            return Collections.emptyMap();\n+        }\n+        String[] pairs = query.split(\"&\");\n+        for (String pair : pairs) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fed76a6d34c712bbe63c45bf0fe8c0de2376868"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28ab2ce983d451887483ea80bc4d86551a8cab64", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/28ab2ce983d451887483ea80bc4d86551a8cab64", "committedDate": "2020-07-23T18:32:49Z", "message": "Apply PR suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fec16cbb02cbb52d3dcd68017e8fc67e1efb73a8", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/fec16cbb02cbb52d3dcd68017e8fc67e1efb73a8", "committedDate": "2020-07-23T19:04:31Z", "message": "Checkstyle fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTI2NTky", "url": "https://github.com/aws-amplify/amplify-android/pull/658#pullrequestreview-454526592", "createdAt": "2020-07-23T22:03:38Z", "commit": {"oid": "fec16cbb02cbb52d3dcd68017e8fc67e1efb73a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1876, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}