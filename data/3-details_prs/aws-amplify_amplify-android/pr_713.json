{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MjQ2MjE1", "number": 713, "title": "Adding SyncType to LastSyncMetadata", "bodyText": "Issue #, if available:\nDescription of changes:\nAs part of implementing the hub events for DataStore sync (#710), we need to save sync type (BASE or DELTA) as part of the LastSyncMetadata system model. This will allow us to decouple the process of tracking the sync metrics from the actual sync process.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-08-10T02:43:36Z", "url": "https://github.com/aws-amplify/amplify-android/pull/713", "merged": true, "mergeCommit": {"oid": "60618849e3fea04c5ed4ca076e354fd350f43298"}, "closed": true, "closedAt": "2020-08-11T01:25:16Z", "author": {"login": "rjuliano"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9Y588gH2gAyNDY1MjQ2MjE1OjAyMGY4YmQzNjExYzhlNDY5ZWZjNzdmMzVlNDVkNDVmYWU3ZWUwNWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9scyqAH2gAyNDY1MjQ2MjE1OjUwNzVlZGNiNzZjNjkzZmFhNmE0ZjA1MjYzNWJmZWExMzMyODg0ZGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "020f8bd3611c8e469efc77f35e45d45fae7ee05a", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/020f8bd3611c8e469efc77f35e45d45fae7ee05a", "committedDate": "2020-08-10T02:36:29Z", "message": "Adding SyncType to LastSyncMetadata"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzOTQxNzkw", "url": "https://github.com/aws-amplify/amplify-android/pull/713#pullrequestreview-463941790", "createdAt": "2020-08-10T03:28:30Z", "commit": {"oid": "020f8bd3611c8e469efc77f35e45d45fae7ee05a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMzoyODozMFrOG-AgXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMzozMzowNlrOG-AjOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzE4MQ==", "bodyText": "To cut down on the number of arguments, and since there is already a create(...), how about we replace lastSyncedAt with:\nstatic <T extends Model> LastSyncMetadata baseSyncedAt(@NonNull Class<T> modelClass, long lastBaseSyncTime) {\n    ....\n}\n\nstatic <T extends Model> LastSyncMetadata deltaSyncedAt(@NonNull Class<T> modelClass, long lastDeltaSyncTime) {\n    ....\n}\n\nstatic <T extends Model> LastSyncMetadata neverSynced(@NonNull Class<T> modelClass) {\n    ...\n}", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r467673181", "createdAt": "2020-08-10T03:28:30Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java", "diffHunk": "@@ -53,9 +55,11 @@ private LastSyncMetadata(String id, String modelClassName, Long lastSyncTime) {\n      * @param lastSyncTime Last time it was synced\n      * @return {@link LastSyncMetadata} for the model class\n      */\n-    static <T extends Model> LastSyncMetadata lastSyncedAt(@NonNull Class<T> modelClass, long lastSyncTime) {\n+    static <T extends Model> LastSyncMetadata lastSyncedAt(@NonNull Class<T> modelClass,\n+                                                           @Nullable long lastSyncTime,\n+                                                           @NonNull SyncType syncType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "020f8bd3611c8e469efc77f35e45d45fae7ee05a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzI1Mg==", "bodyText": "Make sure to update equals(), hashCode(), and toString(), as well.", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r467673252", "createdAt": "2020-08-10T03:29:04Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java", "diffHunk": "@@ -38,12 +38,14 @@\n     private final @ModelField(targetType = \"ID\", isRequired = true) String id;\n     private final @ModelField(targetType = \"String\", isRequired = true) String modelClassName;\n     private final @ModelField(targetType = \"AWSTimestamp\", isRequired = true) Long lastSyncTime;\n+    private final @ModelField(targetType = \"String\", isRequired = true) String lastSyncType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "020f8bd3611c8e469efc77f35e45d45fae7ee05a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzgxNw==", "bodyText": "Seems like we should just keep the return type from this .map(...) as LastSyncMetadata, here. If you do that, you won't need the AtomicReference. And, you can access the component data in the syncModel(...) call, below, by pulling out getModelClass() and getLastSyncTime().", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r467673817", "createdAt": "2020-08-10T03:32:17Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java", "diffHunk": "@@ -102,8 +103,17 @@ Completable hydrate() {\n \n     private Completable createHydrationTask(\n             ModelWithMetadataComparator modelWithMetadataComparator, Class<? extends Model> modelClass) {\n+        // Default this to BASE since if there is no LastSyncMetadata record for this\n+        // model, a BASE sync will be performed.\n+        AtomicReference<SyncType> syncType = new AtomicReference<>(SyncType.BASE);\n+\n         return syncTimeRegistry.lookupLastSyncTime(modelClass)\n             .map(this::filterOutOldSyncTimes)\n+            .map(lastSyncTime -> {\n+                long syncIntervalMs = dataStoreConfigurationProvider.getConfiguration().getSyncIntervalMs();\n+                syncType.set(SyncType.fromSyncTimeAndThreshold(lastSyncTime, syncIntervalMs));\n+                return lastSyncTime;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "020f8bd3611c8e469efc77f35e45d45fae7ee05a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MzkxMw==", "bodyText": "Possibly, consider the same saveBaseSyncTime(...) and saveDeltaSyncTime(...) to keep the arg count down? (As with the factories on LastSyncMetadata.)", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r467673913", "createdAt": "2020-08-10T03:33:06Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java", "diffHunk": "@@ -55,9 +56,11 @@\n         });\n     }\n \n-    <T extends Model> Completable saveLastSyncTime(@NonNull Class<T> modelClazz, SyncTime syncTime) {\n+    <T extends Model> Completable saveLastSyncTime(@NonNull Class<T> modelClazz,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "020f8bd3611c8e469efc77f35e45d45fae7ee05a"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ef80ca60316125c6f9551bcf14ef240e098d5ca", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/7ef80ca60316125c6f9551bcf14ef240e098d5ca", "committedDate": "2020-08-10T11:51:50Z", "message": "Updating equals, hashCode and toString"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32b7de1ca26134a987ab80aec917c841e9d54ab8", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/32b7de1ca26134a987ab80aec917c841e9d54ab8", "committedDate": "2020-08-10T12:14:43Z", "message": "Refactored syncedAt methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "205a7c8da6787a3041d3375c610c141301c7186c", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/205a7c8da6787a3041d3375c610c141301c7186c", "committedDate": "2020-08-10T18:42:15Z", "message": "Addressing PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NjgxNDM4", "url": "https://github.com/aws-amplify/amplify-android/pull/713#pullrequestreview-464681438", "createdAt": "2020-08-11T01:00:18Z", "commit": {"oid": "205a7c8da6787a3041d3375c610c141301c7186c"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMTowMDoxOFrOG-kvWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMTowMTozNVrOG-kwnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI2Njg0MA==", "bodyText": "Are these two LastSyncMetadata equals()? Should they have the same hashCode()?\n\nPerson.class, null, SyncType.BASE\nPerson.class, null, SyncType.DELTA\n\nMight be an edge case / not super relevant.", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r468266840", "createdAt": "2020-08-11T01:00:18Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/LastSyncMetadata.java", "diffHunk": "@@ -67,22 +83,23 @@ private LastSyncMetadata(String id, String modelClassName, Long lastSyncTime) {\n      */\n     static <T extends Model> LastSyncMetadata neverSynced(@NonNull Class<T> modelClass) {\n         Objects.requireNonNull(modelClass);\n-        return create(modelClass, null);\n+        return create(modelClass, null, SyncType.BASE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "205a7c8da6787a3041d3375c610c141301c7186c"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI2NzE2NA==", "bodyText": "nit: alignment -- i'd either align arg, or wrap and +8 indent from method head", "url": "https://github.com/aws-amplify/amplify-android/pull/713#discussion_r468267164", "createdAt": "2020-08-11T01:01:35Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncTimeRegistry.java", "diffHunk": "@@ -55,9 +56,26 @@\n         });\n     }\n \n-    <T extends Model> Completable saveLastSyncTime(@NonNull Class<T> modelClazz, SyncTime syncTime) {\n+    <T extends Model> Completable saveLastDeltaSyncTime(@NonNull Class<T> modelClazz,\n+                                                   @Nullable SyncTime syncTime) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "205a7c8da6787a3041d3375c610c141301c7186c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5075edcb76c693faa6a4f052635bfea1332884dc", "author": {"user": {"login": "rjuliano", "name": "Rafael Juliano"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/5075edcb76c693faa6a4f052635bfea1332884dc", "committedDate": "2020-08-11T01:22:44Z", "message": "Fixed alignment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1937, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}