{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MTA3ODI4", "number": 217, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMToxNToxNlrODVwMOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzoxNzozMlrODWHPgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTM2MjUxOnYy", "diffSide": "RIGHT", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMToxNToxNlrOFaJiiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMToyNDo1NVrOFaJsgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2MzU5Mg==", "bodyText": "This variable was named connectionAcknowledgement since it was in response to a connection_ack message type. If we use it for two distinct (though closely related purposes), perhaps it should be renamed as connectionResponsesPending, or something.", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362963592", "createdAt": "2020-01-03T21:15:16Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -195,6 +200,10 @@ private void processJsonMessage(WebSocket webSocket, String message) throws ApiE\n                     );\n                     connectionAcknowledgement.countDown();\n                     break;\n+                case CONNECTION_ERROR:\n+                    connectionFailure = message;\n+                    connectionAcknowledgement.countDown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c51b91881729a6e9116470c545ef0ad26bfdf541"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NjE0NQ==", "bodyText": "Makes sense", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362966145", "createdAt": "2020-01-03T21:24:55Z", "author": {"login": "TrekSoft"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -195,6 +200,10 @@ private void processJsonMessage(WebSocket webSocket, String message) throws ApiE\n                     );\n                     connectionAcknowledgement.countDown();\n                     break;\n+                case CONNECTION_ERROR:\n+                    connectionFailure = message;\n+                    connectionAcknowledgement.countDown();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2MzU5Mg=="}, "originalCommit": {"oid": "c51b91881729a6e9116470c545ef0ad26bfdf541"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTM3MTk0OnYy", "diffSide": "RIGHT", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMToyMDo1MVrOFaJocQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMToyNzoxM1rOFaJuww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NTEwNQ==", "bodyText": "Since this is in response to a bug report, and is the primary intent of the PR, we should add some test to cover this scenario.", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362965105", "createdAt": "2020-01-03T21:20:51Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -77,23 +77,32 @@\n \n         if (webSocket == null) {\n             try {\n+                connectionFailure = null;\n                 webSocket = createWebSocket();\n             } catch (ApiException exception) {\n                 responseListener.onError(new ApiException(\n                         \"Failed to create websocket for subscription\",\n                         exception,\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                 ));\n+                return null;\n             }\n \n             try {\n                 connectionAcknowledgement.await(CONNECTION_ACKNOWLEDGEMENT_TIMEOUT, TimeUnit.SECONDS);\n-            } catch (InterruptedException interruptedException) {\n+            } catch (InterruptedException interruptedException) { }\n+\n+            if (connectionAcknowledgement.getCount() != 0) {\n                 responseListener.onError(new ApiException(\n                         \"Subscription timed out waiting for acknowledgement\",\n-                        interruptedException,\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                 ));\n+                return null;\n+            } else if (connectionFailure != null) {\n+                responseListener.onError(\n+                    new ApiException(connectionFailure, \"Check if you are authorized to make this subscription\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c51b91881729a6e9116470c545ef0ad26bfdf541"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NjI0Ng==", "bodyText": "Alright - also in running the integration tests I'm seeing a problem with a normal subscription now so trying to figure out the issue.", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362966246", "createdAt": "2020-01-03T21:25:20Z", "author": {"login": "TrekSoft"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -77,23 +77,32 @@\n \n         if (webSocket == null) {\n             try {\n+                connectionFailure = null;\n                 webSocket = createWebSocket();\n             } catch (ApiException exception) {\n                 responseListener.onError(new ApiException(\n                         \"Failed to create websocket for subscription\",\n                         exception,\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                 ));\n+                return null;\n             }\n \n             try {\n                 connectionAcknowledgement.await(CONNECTION_ACKNOWLEDGEMENT_TIMEOUT, TimeUnit.SECONDS);\n-            } catch (InterruptedException interruptedException) {\n+            } catch (InterruptedException interruptedException) { }\n+\n+            if (connectionAcknowledgement.getCount() != 0) {\n                 responseListener.onError(new ApiException(\n                         \"Subscription timed out waiting for acknowledgement\",\n-                        interruptedException,\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                 ));\n+                return null;\n+            } else if (connectionFailure != null) {\n+                responseListener.onError(\n+                    new ApiException(connectionFailure, \"Check if you are authorized to make this subscription\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NTEwNQ=="}, "originalCommit": {"oid": "c51b91881729a6e9116470c545ef0ad26bfdf541"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NjcyMw==", "bodyText": "It might be the race condition we were talking about earlier, where a couple of different tests try to use subscriptions for the same model type, but the order of execution of the tests matters, or something?", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362966723", "createdAt": "2020-01-03T21:27:13Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -77,23 +77,32 @@\n \n         if (webSocket == null) {\n             try {\n+                connectionFailure = null;\n                 webSocket = createWebSocket();\n             } catch (ApiException exception) {\n                 responseListener.onError(new ApiException(\n                         \"Failed to create websocket for subscription\",\n                         exception,\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                 ));\n+                return null;\n             }\n \n             try {\n                 connectionAcknowledgement.await(CONNECTION_ACKNOWLEDGEMENT_TIMEOUT, TimeUnit.SECONDS);\n-            } catch (InterruptedException interruptedException) {\n+            } catch (InterruptedException interruptedException) { }\n+\n+            if (connectionAcknowledgement.getCount() != 0) {\n                 responseListener.onError(new ApiException(\n                         \"Subscription timed out waiting for acknowledgement\",\n-                        interruptedException,\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                 ));\n+                return null;\n+            } else if (connectionFailure != null) {\n+                responseListener.onError(\n+                    new ApiException(connectionFailure, \"Check if you are authorized to make this subscription\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NTEwNQ=="}, "originalCommit": {"oid": "c51b91881729a6e9116470c545ef0ad26bfdf541"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NDk1NjI1OnYy", "diffSide": "RIGHT", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMTo0Njo0MFrOFaqLvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzo0NToyNVrOFbnRKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ5ODQzMQ==", "bodyText": "is this in-line with the recent changes that Jameson made to accommodate lambdas?", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r363498431", "createdAt": "2020-01-06T21:46:40Z", "author": {"login": "raphkim"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionOperation.java", "diffHunk": "@@ -47,12 +49,14 @@ private SubscriptionOperation(\n             @NonNull final OkHttpClient client,\n             @NonNull final GraphQLRequest<T> graphQLRequest,\n             @NonNull final GraphQLResponse.Factory responseFactory,\n-            @NonNull final StreamListener<GraphQLResponse<T>, ApiException> subscriptionListener) {\n+            @NonNull final StreamListener<GraphQLResponse<T>, ApiException> subscriptionListener,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5OTI0MQ==", "bodyText": "Updated PR to account for this", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r364499241", "createdAt": "2020-01-08T23:45:25Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionOperation.java", "diffHunk": "@@ -47,12 +49,14 @@ private SubscriptionOperation(\n             @NonNull final OkHttpClient client,\n             @NonNull final GraphQLRequest<T> graphQLRequest,\n             @NonNull final GraphQLResponse.Factory responseFactory,\n-            @NonNull final StreamListener<GraphQLResponse<T>, ApiException> subscriptionListener) {\n+            @NonNull final StreamListener<GraphQLResponse<T>, ApiException> subscriptionListener,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ5ODQzMQ=="}, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NDk1ODk4OnYy", "diffSide": "RIGHT", "path": "build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMTo0Nzo0OFrOFaqNXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxODozMTo0MFrOFb_biw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ5ODg0NQ==", "bodyText": "Perhaps we should use 2.16.+ so that each minor version update doesn't break our compiler?", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r363498845", "createdAt": "2020-01-06T21:47:48Z", "author": {"login": "raphkim"}, "path": "build.gradle", "diffHunk": "@@ -48,7 +48,7 @@ task clean(type: Delete) {\n }\n \n ext {\n-    awsSdkVersion = '2.16.5'\n+    awsSdkVersion = '2.16.6'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg5NTExNQ==", "bodyText": "(There was a thread of discussion around this, I think I might have accidentally deleted it.)\nTLDR sounds good, let's do that in another PR", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r364895115", "createdAt": "2020-01-09T18:31:40Z", "author": {"login": "jamesonwilliams"}, "path": "build.gradle", "diffHunk": "@@ -48,7 +48,7 @@ task clean(type: Delete) {\n }\n \n ext {\n-    awsSdkVersion = '2.16.5'\n+    awsSdkVersion = '2.16.6'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ5ODg0NQ=="}, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NTEzNjU1OnYy", "diffSide": "RIGHT", "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/CodeGenerationInstrumentationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzoxNTo0NlrOFar-EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzo0NDoxNFrOFbnP6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUyNzY5Ng==", "bodyText": "Instead of defining this constant, you could consider to use TimeUnit.SECONDS.toMilliseconds(1) as an in-line constant - or atlernately, use a semantic label, like:\nprivate static final int MAX_SUBSCRIPTION_FAILURE_TIME_MS = TimeUnit.SECONDS.toMillseconds(1);\n\nwhich sort of achieves two purposes of documentation - how long it is, and what it purpose is", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r363527696", "createdAt": "2020-01-06T23:15:46Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/CodeGenerationInstrumentationTest.java", "diffHunk": "@@ -45,6 +47,9 @@\n     private static final String PERSON_API_NAME = \"personApi\";\n     private static final String PROJECT_API_NAME = \"projectApi\";\n     private static final String BLOG_API_NAME = \"blogApi\";\n+    private static final String NOTES_WITH_AUTH_API_NAME = \"notesWithAuthApi\";\n+\n+    private static final int ONE_SECOND_OF_MILLISECONDS = 1000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5ODkyMg==", "bodyText": "Updated PR", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r364498922", "createdAt": "2020-01-08T23:44:14Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/CodeGenerationInstrumentationTest.java", "diffHunk": "@@ -45,6 +47,9 @@\n     private static final String PERSON_API_NAME = \"personApi\";\n     private static final String PROJECT_API_NAME = \"projectApi\";\n     private static final String BLOG_API_NAME = \"blogApi\";\n+    private static final String NOTES_WITH_AUTH_API_NAME = \"notesWithAuthApi\";\n+\n+    private static final int ONE_SECOND_OF_MILLISECONDS = 1000;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUyNzY5Ng=="}, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NTEzOTIxOnYy", "diffSide": "RIGHT", "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/CodeGenerationInstrumentationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzoxNzozMlrOFar_5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzo0NDo1M1rOFbnQjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUyODE2Nw==", "bodyText": "Ah crumbs. I think this is why I had left this part of the method as blocking. If the subscription call returns before getting acknowledgement, we have this new issue - how to do we convey the acknowledgement to the user? It used to be synonymous with getting a subscription ID back.\nThe user would also need to sleep for a random amount of time, like this test does.\nIf that part is now async, we can provide the information with a callback. Like:\n/**\n * Subscribe to mutations that occur for a given model class.\n * @param clazz Type of model being subscribed\n * @param subscriptionType type of events to subscribe to\n * @param onSubscriptionStarted Called when a subscription begins; a subscription ID is passed\n * @param onNextItem Called when a new subscription item is available\n * @param onSubscriptionFailed Called when the subscription terminates due to a failure\n * @param onSubscriptionCompleted Called when a subscription terminates gracefully\n */\n<T extends Model> void subscribe(\n    Class<T> clazz,\n    SubscriptionType subscriptionType,\n    Consumer<String> onSubscriptionStarted,\n    Consumer<T> onNextItem,\n    Consumer<ApiException> onSubscriptionFailed,\n    Action onSubscriptionCompleted\n);\n\nAm (irrelevant) note on mechanics, here -- you can use the Sleep#milliseconds(long) test utility to clean things up a bit and get rid of this exception block.", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r363528167", "createdAt": "2020-01-06T23:17:32Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/CodeGenerationInstrumentationTest.java", "diffHunk": "@@ -118,6 +123,12 @@ public void subscribeReceivesMutationEvent() {\n         SynchronousApi.Subscription<Person> subscription =\n             api.onCreate(PERSON_API_NAME, Person.class);\n \n+        // Give the subscription time to complete the connection before running the mutation.\n+        // This should happen within 1 second - if not, it's good that this fails so we can investigate.\n+        try {\n+            Thread.sleep(ONE_SECOND_OF_MILLISECONDS);\n+        } catch (InterruptedException exception) { }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5OTA4Ng==", "bodyText": "Updated PR to do this", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r364499086", "createdAt": "2020-01-08T23:44:53Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/CodeGenerationInstrumentationTest.java", "diffHunk": "@@ -118,6 +123,12 @@ public void subscribeReceivesMutationEvent() {\n         SynchronousApi.Subscription<Person> subscription =\n             api.onCreate(PERSON_API_NAME, Person.class);\n \n+        // Give the subscription time to complete the connection before running the mutation.\n+        // This should happen within 1 second - if not, it's good that this fails so we can investigate.\n+        try {\n+            Thread.sleep(ONE_SECOND_OF_MILLISECONDS);\n+        } catch (InterruptedException exception) { }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUyODE2Nw=="}, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1496, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}