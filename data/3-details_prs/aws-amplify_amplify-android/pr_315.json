{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMzkxODQ1", "number": 315, "title": "Versions in datastore", "bodyText": "Write model versions to a local store, while working over the results from a base sync.\nRead and post model versions to AppSync when publishing updates/deleted to AppSync.\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-03-20T07:38:46Z", "url": "https://github.com/aws-amplify/amplify-android/pull/315", "merged": true, "mergeCommit": {"oid": "b51490076170dcef438ab3c7b4f8acf9202e8f69"}, "closed": true, "closedAt": "2020-03-23T20:49:15Z", "author": {"login": "jamesonwilliams"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPhcVrAFqTM3ODUzNDcyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQfd2gAFqTM3OTUwMTQ5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTM0NzI1", "url": "https://github.com/aws-amplify/amplify-android/pull/315#pullrequestreview-378534725", "createdAt": "2020-03-20T14:32:46Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozMjo0NlrOF5WJ7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozMjo0NlrOF5WJ7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3NjE0MQ==", "bodyText": "This looks like the default equals functionality - is there a need to override it that I'm missing here?", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395676141", "createdAt": "2020-03-20T14:32:46Z", "author": {"login": "TrekSoft"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/StorageItemChange.java", "diffHunk": "@@ -133,12 +131,13 @@ public T item() {\n      * @param recordFactory A component capable of generating records.\n      * @return A Record representation of this instance.\n      */\n+    @NonNull\n     public Record toRecord(@NonNull RecordFactory recordFactory) {\n         return Objects.requireNonNull(recordFactory).toRecord(this);\n     }\n \n     @Override\n-    public boolean equals(Object thatObject) {\n+    public boolean equals(@Nullable Object thatObject) {\n         if (this == thatObject) {\n             return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 113}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTQ4MDM5", "url": "https://github.com/aws-amplify/amplify-android/pull/315#pullrequestreview-378548039", "createdAt": "2020-03-20T14:48:23Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDo0ODoyM1rOF5WyNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDo0ODoyM1rOF5WyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4NjQ1Mg==", "bodyText": "What's the idea behind using caps to distinguish between these two classes vs. a naming difference?", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395686452", "createdAt": "2020-03-20T14:48:23Z", "author": {"login": "TrekSoft"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -85,20 +103,78 @@ void stopDrainingMutationOutbox() {\n     }\n \n     /**\n-     * To process a StorageItemChange, we try to publish it to the remote GraphQL\n-     * API. If that succeeds, then we can remove it from the outbox. Otherwise,\n-     * we have to keep the mutation in the outbox, so that we can try to publish\n-     * it again later, when network conditions become favorable again.\n+     * Attempt to publish a change (update, delete, creation) over the network.\n      * @param storageItemChange A storage item change to be published to remote API\n-     * @return A single which completes with the successfully published item, or errors\n+     * @return A single which completes with the successfully published item, or emits error\n      *         if the publication fails\n      */\n-    @SuppressWarnings(\"checkstyle:MethodTypeParameterName\") // The generics are complex, so use meaningful names\n     private <MODEL extends Model, SIC extends StorageItemChange<MODEL>> Single<SIC> publishToNetwork(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTc0ODE2", "url": "https://github.com/aws-amplify/amplify-android/pull/315#pullrequestreview-378574816", "createdAt": "2020-03-20T15:18:42Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNToxODo0MlrOF5YEKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNToxODo0MlrOF5YEKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwNzQzMg==", "bodyText": "Do you think in this case it'd make sense to throw a custom error with an explanation if it is null since this isn't checking input provided by the customer but rather the result we're returning? Same for below on line 73?", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395707432", "createdAt": "2020-03-20T15:18:42Z", "author": {"login": "TrekSoft"}, "path": "core/src/main/java/com/amplifyframework/core/model/ModelSchemaRegistry.java", "diffHunk": "@@ -57,8 +55,10 @@ public synchronized void load(@NonNull Set<Class<? extends Model>> models) throw\n      *                        {@link Class#getSimpleName()} method.\n      * @return the ModelSchema object for the given Model class.\n      */\n+    @NonNull\n     public synchronized ModelSchema getModelSchemaForModelClass(@NonNull String classSimpleName) {\n-        return modelSchemaMap.get(classSimpleName);\n+        final ModelSchema result = modelSchemaMap.get(classSimpleName);\n+        return Objects.requireNonNull(result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTc1ODk2", "url": "https://github.com/aws-amplify/amplify-android/pull/315#pullrequestreview-378575896", "createdAt": "2020-03-20T15:19:52Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNToxOTo1MlrOF5YHdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNToxOTo1MlrOF5YHdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwODI3Nw==", "bodyText": "Why do we have what looks like the same enum here as well as in StorageItemChange.java in the DataStore project?", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395708277", "createdAt": "2020-03-20T15:19:52Z", "author": {"login": "TrekSoft"}, "path": "core/src/main/java/com/amplifyframework/datastore/DataStoreItemChange.java", "diffHunk": "@@ -259,9 +263,14 @@ public String toString() {\n      */\n     public enum Type {\n         /**\n-         * An item has been saved into the DataStore.\n+         * An item with a new ID has been saved into the DataStore.\n+         */\n+        CREATE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "44099623494636d9d41f359ab76529f2efa97ee7", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/44099623494636d9d41f359ab76529f2efa97ee7", "committedDate": "2020-03-21T03:51:18Z", "message": "[aws-datastore] Perform base sync at startup and save model versions\n\nPerform a base sync as part of starting up the DataStore.\n\nModelMetadata is used to record the version of particular models managed\nby the DataStore. A table for this structure must be created while the\nstorage adapter is initializing.\n\nItems coming back from the base sync must be applied with respect to the\ntopological ordering of their model classes. For example, given a\nrelationship:\n\n 1 Blog - n Posts - n Comments\n\nThe blog must be created, so that a post can \"belongsTo\" it, and the\npost must be created next, so that a comment can \"belongsTo\" that."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b32cf9a48dde4fb120d1e9a3307725b30ef6c864", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/b32cf9a48dde4fb120d1e9a3307725b30ef6c864", "committedDate": "2020-03-21T03:51:18Z", "message": "[aws-datastore] Separate create and update types for storage adapter\n\nWhile publishing a local change, the sync engine needs to know if the\nchange was a create or an update.\n\nThe storage adatper knows whether or not a save resulted in the creation\nof a new record, or an update to an existing record. So, the storage\napdater is able to communicate out this information to its listeners."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20d99b8c6b755c15dd61e89f99150321b9cc7087", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/20d99b8c6b755c15dd61e89f99150321b9cc7087", "committedDate": "2020-03-21T03:51:54Z", "message": "[aws-datastore] Don't ignore update and delete outbox tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5ef0fd8ccbf373deebe9e066b5add9973628250", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/b5ef0fd8ccbf373deebe9e066b5add9973628250", "committedDate": "2020-03-21T03:51:54Z", "message": "[aws-datastore] Handle create update and delete in MutationProcessor\n\nWhile draining changes from the mutation outbox, correctly handle all\nof create, update, delete.\n\nPreviously, only creations were being dispatched.\n\nUpdates and deletes additionally require the presence of a version, in\nthe outgoing request to AppSync."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13a001d81c15717d7d1b4da3be9d3e09eb67b422", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/13a001d81c15717d7d1b4da3be9d3e09eb67b422", "committedDate": "2020-03-21T06:21:10Z", "message": "[aws-datastore] All network data passed through merger\n\nSyncProcessor, MutationProcessor, SubscriptionProcessor all forward\ntheir GraphQLResponse entities - as ModelWithMetadata - into a new\nMerger component.\n\nAll versioning information is obtained from a new VersionRegistry\ncomponent.\n\nBoth VersionRegistry and Merger wrap the LocalStorageAdapter."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "13a001d81c15717d7d1b4da3be9d3e09eb67b422", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/13a001d81c15717d7d1b4da3be9d3e09eb67b422", "committedDate": "2020-03-21T06:21:10Z", "message": "[aws-datastore] All network data passed through merger\n\nSyncProcessor, MutationProcessor, SubscriptionProcessor all forward\ntheir GraphQLResponse entities - as ModelWithMetadata - into a new\nMerger component.\n\nAll versioning information is obtained from a new VersionRegistry\ncomponent.\n\nBoth VersionRegistry and Merger wrap the LocalStorageAdapter."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "13a001d81c15717d7d1b4da3be9d3e09eb67b422", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/13a001d81c15717d7d1b4da3be9d3e09eb67b422", "committedDate": "2020-03-21T06:21:10Z", "message": "[aws-datastore] All network data passed through merger\n\nSyncProcessor, MutationProcessor, SubscriptionProcessor all forward\ntheir GraphQLResponse entities - as ModelWithMetadata - into a new\nMerger component.\n\nAll versioning information is obtained from a new VersionRegistry\ncomponent.\n\nBoth VersionRegistry and Merger wrap the LocalStorageAdapter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NTAxNDk5", "url": "https://github.com/aws-amplify/amplify-android/pull/315#pullrequestreview-379501499", "createdAt": "2020-03-23T14:48:32Z", "commit": {"oid": "13a001d81c15717d7d1b4da3be9d3e09eb67b422"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2594, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}