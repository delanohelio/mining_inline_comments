{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MTA3ODI4", "number": 217, "title": "[API] Fixes #187: Subscription blocking + web socket connection error not correctly reported", "bodyText": "Issue #, if available:\n#187\nDescription of changes:\nMakes subscription a non blocking operation and handles the case of the web socket being unable to establish a connection correctly. Also updates the version of the AWS SDK as it was required for linting.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-01-03T20:08:08Z", "url": "https://github.com/aws-amplify/amplify-android/pull/217", "merged": true, "mergeCommit": {"oid": "3db2838cfdb5f7b10535d744363bdfc7748899ed"}, "closed": true, "closedAt": "2020-01-09T18:42:12Z", "author": {"login": "TrekSoft"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2z7ITgH2gAyMzU5MTA3ODI4OjNjOWYwOWEwZTk1NmFhYWMwNWEyYTI0YzdiMTk4NDk2NWRkNGM0YWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4uc2bAFqTM0MDczMzA0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3c9f09a0e956aaac05a2a24c7b1984965dd4c4aa", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/3c9f09a0e956aaac05a2a24c7b1984965dd4c4aa", "committedDate": "2020-01-03T19:56:35Z", "message": "Fix for issue #187"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c78c140afa0167baa493885a58979ef4d1b77416", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/c78c140afa0167baa493885a58979ef4d1b77416", "committedDate": "2020-01-03T20:02:59Z", "message": "Fixed linting issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c51b91881729a6e9116470c545ef0ad26bfdf541", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/c51b91881729a6e9116470c545ef0ad26bfdf541", "committedDate": "2020-01-03T20:04:59Z", "message": "Reset connection failure on new request"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4Mjc3MTUw", "url": "https://github.com/aws-amplify/amplify-android/pull/217#pullrequestreview-338277150", "createdAt": "2020-01-03T21:12:19Z", "commit": {"oid": "c51b91881729a6e9116470c545ef0ad26bfdf541"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMToxNToxNlrOFaJiiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMToyMDo1MVrOFaJocQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2MzU5Mg==", "bodyText": "This variable was named connectionAcknowledgement since it was in response to a connection_ack message type. If we use it for two distinct (though closely related purposes), perhaps it should be renamed as connectionResponsesPending, or something.", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362963592", "createdAt": "2020-01-03T21:15:16Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -195,6 +200,10 @@ private void processJsonMessage(WebSocket webSocket, String message) throws ApiE\n                     );\n                     connectionAcknowledgement.countDown();\n                     break;\n+                case CONNECTION_ERROR:\n+                    connectionFailure = message;\n+                    connectionAcknowledgement.countDown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c51b91881729a6e9116470c545ef0ad26bfdf541"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NTEwNQ==", "bodyText": "Since this is in response to a bug report, and is the primary intent of the PR, we should add some test to cover this scenario.", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362965105", "createdAt": "2020-01-03T21:20:51Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -77,23 +77,32 @@\n \n         if (webSocket == null) {\n             try {\n+                connectionFailure = null;\n                 webSocket = createWebSocket();\n             } catch (ApiException exception) {\n                 responseListener.onError(new ApiException(\n                         \"Failed to create websocket for subscription\",\n                         exception,\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                 ));\n+                return null;\n             }\n \n             try {\n                 connectionAcknowledgement.await(CONNECTION_ACKNOWLEDGEMENT_TIMEOUT, TimeUnit.SECONDS);\n-            } catch (InterruptedException interruptedException) {\n+            } catch (InterruptedException interruptedException) { }\n+\n+            if (connectionAcknowledgement.getCount() != 0) {\n                 responseListener.onError(new ApiException(\n                         \"Subscription timed out waiting for acknowledgement\",\n-                        interruptedException,\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                 ));\n+                return null;\n+            } else if (connectionFailure != null) {\n+                responseListener.onError(\n+                    new ApiException(connectionFailure, \"Check if you are authorized to make this subscription\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c51b91881729a6e9116470c545ef0ad26bfdf541"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "554986ae59ae9e3d82c98ab33edb217b6eb67d84", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/554986ae59ae9e3d82c98ab33edb217b6eb67d84", "committedDate": "2020-01-06T16:21:04Z", "message": "Adds/fixes integ tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e", "author": {"user": {"login": "TrekSoft", "name": "David Daudelin"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/9973478f35e7eb02d0e18b2e16de35e04170057e", "committedDate": "2020-01-06T16:36:16Z", "message": "Fixes integ tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTE1Mzc4", "url": "https://github.com/aws-amplify/amplify-android/pull/217#pullrequestreview-338915378", "createdAt": "2020-01-06T21:46:39Z", "commit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMTo0Njo0MFrOFaqLvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMTo0Njo0MFrOFaqLvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ5ODQzMQ==", "bodyText": "is this in-line with the recent changes that Jameson made to accommodate lambdas?", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r363498431", "createdAt": "2020-01-06T21:46:40Z", "author": {"login": "raphkim"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionOperation.java", "diffHunk": "@@ -47,12 +49,14 @@ private SubscriptionOperation(\n             @NonNull final OkHttpClient client,\n             @NonNull final GraphQLRequest<T> graphQLRequest,\n             @NonNull final GraphQLResponse.Factory responseFactory,\n-            @NonNull final StreamListener<GraphQLResponse<T>, ApiException> subscriptionListener) {\n+            @NonNull final StreamListener<GraphQLResponse<T>, ApiException> subscriptionListener,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTE1OTQ1", "url": "https://github.com/aws-amplify/amplify-android/pull/217#pullrequestreview-338915945", "createdAt": "2020-01-06T21:47:48Z", "commit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMTo0Nzo0OFrOFaqNXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMTo0Nzo0OFrOFaqNXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ5ODg0NQ==", "bodyText": "Perhaps we should use 2.16.+ so that each minor version update doesn't break our compiler?", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r363498845", "createdAt": "2020-01-06T21:47:48Z", "author": {"login": "raphkim"}, "path": "build.gradle", "diffHunk": "@@ -48,7 +48,7 @@ task clean(type: Delete) {\n }\n \n ext {\n-    awsSdkVersion = '2.16.5'\n+    awsSdkVersion = '2.16.6'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTQ5NjQ2", "url": "https://github.com/aws-amplify/amplify-android/pull/217#pullrequestreview-338949646", "createdAt": "2020-01-06T23:06:31Z", "commit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzoxNTo0NlrOFar-EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzoxNzozMlrOFar_5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUyNzY5Ng==", "bodyText": "Instead of defining this constant, you could consider to use TimeUnit.SECONDS.toMilliseconds(1) as an in-line constant - or atlernately, use a semantic label, like:\nprivate static final int MAX_SUBSCRIPTION_FAILURE_TIME_MS = TimeUnit.SECONDS.toMillseconds(1);\n\nwhich sort of achieves two purposes of documentation - how long it is, and what it purpose is", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r363527696", "createdAt": "2020-01-06T23:15:46Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/CodeGenerationInstrumentationTest.java", "diffHunk": "@@ -45,6 +47,9 @@\n     private static final String PERSON_API_NAME = \"personApi\";\n     private static final String PROJECT_API_NAME = \"projectApi\";\n     private static final String BLOG_API_NAME = \"blogApi\";\n+    private static final String NOTES_WITH_AUTH_API_NAME = \"notesWithAuthApi\";\n+\n+    private static final int ONE_SECOND_OF_MILLISECONDS = 1000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUyODE2Nw==", "bodyText": "Ah crumbs. I think this is why I had left this part of the method as blocking. If the subscription call returns before getting acknowledgement, we have this new issue - how to do we convey the acknowledgement to the user? It used to be synonymous with getting a subscription ID back.\nThe user would also need to sleep for a random amount of time, like this test does.\nIf that part is now async, we can provide the information with a callback. Like:\n/**\n * Subscribe to mutations that occur for a given model class.\n * @param clazz Type of model being subscribed\n * @param subscriptionType type of events to subscribe to\n * @param onSubscriptionStarted Called when a subscription begins; a subscription ID is passed\n * @param onNextItem Called when a new subscription item is available\n * @param onSubscriptionFailed Called when the subscription terminates due to a failure\n * @param onSubscriptionCompleted Called when a subscription terminates gracefully\n */\n<T extends Model> void subscribe(\n    Class<T> clazz,\n    SubscriptionType subscriptionType,\n    Consumer<String> onSubscriptionStarted,\n    Consumer<T> onNextItem,\n    Consumer<ApiException> onSubscriptionFailed,\n    Action onSubscriptionCompleted\n);\n\nAm (irrelevant) note on mechanics, here -- you can use the Sleep#milliseconds(long) test utility to clean things up a bit and get rid of this exception block.", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r363528167", "createdAt": "2020-01-06T23:17:32Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/CodeGenerationInstrumentationTest.java", "diffHunk": "@@ -118,6 +123,12 @@ public void subscribeReceivesMutationEvent() {\n         SynchronousApi.Subscription<Person> subscription =\n             api.onCreate(PERSON_API_NAME, Person.class);\n \n+        // Give the subscription time to complete the connection before running the mutation.\n+        // This should happen within 1 second - if not, it's good that this fails so we can investigate.\n+        try {\n+            Thread.sleep(ONE_SECOND_OF_MILLISECONDS);\n+        } catch (InterruptedException exception) { }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06e1c03dcf102dc5634601fd80da1fc47c6a7874", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/06e1c03dcf102dc5634601fd80da1fc47c6a7874", "committedDate": "2020-01-08T23:38:08Z", "message": "Merge remote-tracking branch 'origin/master' into fix187"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0acb9a08ad0f02eebfe176d0323b94fcf89c126c", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/0acb9a08ad0f02eebfe176d0323b94fcf89c126c", "committedDate": "2020-01-08T23:39:50Z", "message": "Remove wait from GraphQLInstrumentationTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNzE4NDgw", "url": "https://github.com/aws-amplify/amplify-android/pull/217#pullrequestreview-340718480", "createdAt": "2020-01-09T18:16:51Z", "commit": {"oid": "0acb9a08ad0f02eebfe176d0323b94fcf89c126c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNzMzMDQz", "url": "https://github.com/aws-amplify/amplify-android/pull/217#pullrequestreview-340733043", "createdAt": "2020-01-09T18:41:50Z", "commit": {"oid": "0acb9a08ad0f02eebfe176d0323b94fcf89c126c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2780, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}