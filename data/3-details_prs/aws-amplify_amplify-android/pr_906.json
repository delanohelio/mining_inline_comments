{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNTQxNDg3", "number": 906, "title": "feat(aws-api): support owner-based auth with oidc", "bodyText": "Description of changes:\nOwner-based auth currently works only for Cognito User Pools. This PR lets the plugin determine which auth provider to obtain the JWT token from instead of always assuming Cognito User Pools.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-10-14T17:49:53Z", "url": "https://github.com/aws-amplify/amplify-android/pull/906", "merged": true, "mergeCommit": {"oid": "525af3fd60878fae95e1459d67a76be36db57438"}, "closed": true, "closedAt": "2020-10-20T18:46:34Z", "author": {"login": "raphkim"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSg2OqAH2gAyNTAzNTQxNDg3OjMwZDk5ODg4ZjMzN2I5MDhlOGJhZTI2YmZkNzQ3MmU2OTNiM2MwMGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUciG3gFqTUxMjk4NzkxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "30d99888f337b908e8bae26bfd7472e693b3c00e", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/30d99888f337b908e8bae26bfd7472e693b3c00e", "committedDate": "2020-10-14T17:44:04Z", "message": "feat(aws-api): support owner-based auth with oidc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NzA4Nzcx", "url": "https://github.com/aws-amplify/amplify-android/pull/906#pullrequestreview-508708771", "createdAt": "2020-10-14T20:36:17Z", "commit": {"oid": "30d99888f337b908e8bae26bfd7472e693b3c00e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NzU2ODQ5", "url": "https://github.com/aws-amplify/amplify-android/pull/906#pullrequestreview-508756849", "createdAt": "2020-10-14T21:26:22Z", "commit": {"oid": "30d99888f337b908e8bae26bfd7472e693b3c00e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMToyNjoyM1rOHhloVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTozNzo1M1rOHhl9Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4MTU5MQ==", "bodyText": "What needs to happen to support this?\nInstead of leaving this TODO here, can we either:\n\nAdd support for it\nOr, throw an exception if a customer tries to use it?", "url": "https://github.com/aws-amplify/amplify-android/pull/906#discussion_r504981591", "createdAt": "2020-10-14T21:26:23Z", "author": {"login": "richardmcclellan"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -383,13 +388,13 @@ private String getIdentityValue(String identityClaim) throws ApiException {\n         return identityValue;\n     }\n \n-    private ArrayList<String> getUserGroups() throws ApiException {\n-        CognitoUserPoolsAuthProvider cognitoProvider = getAuthProvider();\n+    private ArrayList<String> getUserGroups(AuthorizationType authType) throws ApiException {\n+        // TODO: this doesn't work with OIDC right now. Implement custom groups claim.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d99888f337b908e8bae26bfd7472e693b3c00e"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4NjExMA==", "bodyText": "getPayload can throw an CognitoParameterInvalidException.  Can we catch it and wrap it in an APIException?  You could throw the same one that is thrown for a JsonException below.", "url": "https://github.com/aws-amplify/amplify-android/pull/906#discussion_r504986110", "createdAt": "2020-10-14T21:36:08Z", "author": {"login": "richardmcclellan"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -383,13 +388,13 @@ private String getIdentityValue(String identityClaim) throws ApiException {\n         return identityValue;\n     }\n \n-    private ArrayList<String> getUserGroups() throws ApiException {\n-        CognitoUserPoolsAuthProvider cognitoProvider = getAuthProvider();\n+    private ArrayList<String> getUserGroups(AuthorizationType authType) throws ApiException {\n+        // TODO: this doesn't work with OIDC right now. Implement custom groups claim.\n         ArrayList<String> groups = new ArrayList<>();\n         final String GROUPS_KEY = \"cognito:groups\";\n \n         try {\n-            JSONObject accessToken = CognitoJWTParser.getPayload(cognitoProvider.getLatestAuthToken());\n+            JSONObject accessToken = CognitoJWTParser.getPayload(getAuthToken(authType));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d99888f337b908e8bae26bfd7472e693b3c00e"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4NjkwMw==", "bodyText": "Can we catch a CognitoParameterInvalidException here as well?", "url": "https://github.com/aws-amplify/amplify-android/pull/906#discussion_r504986903", "createdAt": "2020-10-14T21:37:53Z", "author": {"login": "richardmcclellan"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -358,17 +364,16 @@ private boolean isReadRestrictingStaticGroup(AuthRule authRule) {\n             && authRule.getOperationsOrDefault().contains(ModelOperation.READ);\n     }\n \n-    private String getIdentityValue(String identityClaim) throws ApiException {\n-        CognitoUserPoolsAuthProvider cognitoProvider = getAuthProvider();\n-\n-        String identityValue;\n+    private String getIdentityValue(String identityClaim, AuthorizationType authType) throws ApiException {\n+        String identityValue = null;\n \n         try {\n             identityValue = CognitoJWTParser\n-                    .getPayload(cognitoProvider.getLatestAuthToken())\n+                    .getPayload(getAuthToken(authType))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d99888f337b908e8bae26bfd7472e693b3c00e"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4OTMwMTU0", "url": "https://github.com/aws-amplify/amplify-android/pull/906#pullrequestreview-508930154", "createdAt": "2020-10-15T04:35:05Z", "commit": {"oid": "30d99888f337b908e8bae26bfd7472e693b3c00e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDozNTowNVrOHhwa1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDozNTowNVrOHhwa1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1ODM1OQ==", "bodyText": "The last few PRs for auth have gone right into the main body of this AWSApiPlugin. I'm worried about this. We should really be breaking the auth logic out into smaller classes.\nPlugins, in a perfect world, are simply adapters between our business logic and the Amplify framework.\nHowever, increasingly, this AWSApiPlugin is host to business logic.\n@raphkim The model you used for your Predictions category -- where you had business logic services, and used the plugin as a thin-veneer into them -- was architecturally correct, for example.", "url": "https://github.com/aws-amplify/amplify-android/pull/906#discussion_r505158359", "createdAt": "2020-10-15T04:35:05Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -409,20 +414,34 @@ private String getIdentityValue(String identityClaim) throws ApiException {\n         return groups;\n     }\n \n-    private CognitoUserPoolsAuthProvider getAuthProvider() throws ApiException {\n-        CognitoUserPoolsAuthProvider cognitoProvider = authProvider.getCognitoUserPoolsAuthProvider();\n-        if (cognitoProvider == null) {\n-            try {\n-                cognitoProvider = new DefaultCognitoUserPoolsAuthProvider();\n-            } catch (ApiException exception) {\n+    private String getAuthToken(AuthorizationType authType) throws ApiException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d99888f337b908e8bae26bfd7472e693b3c00e"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a488b769b0b8618106860b2eee8c425bb91e3466", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/a488b769b0b8618106860b2eee8c425bb91e3466", "committedDate": "2020-10-16T08:41:07Z", "message": "address pr comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12d37e4f30d50dc9d7fd1c585901f9fb34540570", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/12d37e4f30d50dc9d7fd1c585901f9fb34540570", "committedDate": "2020-10-16T09:12:33Z", "message": "fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40faff3e83939cd3e3242944343c8074f9ad873a", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/40faff3e83939cd3e3242944343c8074f9ad873a", "committedDate": "2020-10-19T20:25:57Z", "message": "replace todo message with exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyOTg3OTE4", "url": "https://github.com/aws-amplify/amplify-android/pull/906#pullrequestreview-512987918", "createdAt": "2020-10-20T17:50:19Z", "commit": {"oid": "40faff3e83939cd3e3242944343c8074f9ad873a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1759, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}