{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MTQwNjAy", "number": 263, "title": "Patch flaky tests for CI/CD", "bodyText": "This is an extension of PR #262 that also includes timeout extension for API instrumentation tests\nContent of #262 copied here:\n\nSplit SQLiteStorageAdapterInstrumentationTest into three tests (separated by method being tested) for both abstraction + load reduction.\nI noticed that the CI/CD test often fails near the end due to process unexpectedly dying where it shouldn't. It may be because the instrumentation test has very heavy workload PER test-suite (i.e. setting up SQliteStorageAdapter instance from scratch and terminating it after) and contains several test suites. This PR is mainly an experiment to test my hypothesis.\n\nTimeout duration changes made:\n\nAPI connection error response threshold: 1s -> 2s (removed)\nAPI synchronous operation timeout: 5s -> 10s\nStorage Engine timeout: 1s -> 2s\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-02-13T23:35:01Z", "url": "https://github.com/aws-amplify/amplify-android/pull/263", "merged": true, "mergeCommit": {"oid": "63532d0eb074f7bb220b41f59f54cd55fc33bb21"}, "closed": true, "closedAt": "2020-02-14T22:27:11Z", "author": {"login": "raphkim"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEC0m1gH2gAyMzc1MTQwNjAyOjhiZmExYjMxOTY5MzJkMmIyMTdiMDI0YjU0ZjM2OTRkOTZlMjBhYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEXPpOgFqTM1OTI1NDUxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8bfa1b3196932d2b217b024b54f3694d96e20ab5", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/8bfa1b3196932d2b217b024b54f3694d96e20ab5", "committedDate": "2020-02-13T22:39:03Z", "message": "Split SQLiteStorageAdapter tests to reduce load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42207af3ed33b6bf918531ed7d3749467116f98d", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/42207af3ed33b6bf918531ed7d3749467116f98d", "committedDate": "2020-02-13T22:51:20Z", "message": "Checkstyle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13b3b7c4ba774194e3c16bec01dbaf66d590e1c2", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/13b3b7c4ba774194e3c16bec01dbaf66d590e1c2", "committedDate": "2020-02-13T23:29:44Z", "message": "Extend synchronous API timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9e84de98204a5a132a90088043b23555c1b2044", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/d9e84de98204a5a132a90088043b23555c1b2044", "committedDate": "2020-02-13T23:40:38Z", "message": "Whitespace fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d1b2329c3f4ac8a469f99c2aadd30225c10e0f6", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/1d1b2329c3f4ac8a469f99c2aadd30225c10e0f6", "committedDate": "2020-02-13T23:51:19Z", "message": "Extend Sqlite operation timeout duration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc2f31027e03d1a496bed2fc674898b7590a020f", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/cc2f31027e03d1a496bed2fc674898b7590a020f", "committedDate": "2020-02-14T00:06:57Z", "message": "Extend connection error threshold"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MTg3NTUy", "url": "https://github.com/aws-amplify/amplify-android/pull/263#pullrequestreview-359187552", "createdAt": "2020-02-14T20:02:06Z", "commit": {"oid": "cc2f31027e03d1a496bed2fc674898b7590a020f"}, "state": "DISMISSED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMDowMjowNlrOFqCJ4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMDoxMDoxMFrOFqCXHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYxOTgwOQ==", "bodyText": "If they are utility methods, then I recommend to put them into utility classes, not into an abstract base.\nAbstract classes are good candidates for enforcing policy on an interface. But, that\u2019s not really what\u2019s needed here. Here, you\u2019re just trying to re-use some utility code in a few places.", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379619809", "createdAt": "2020-02-14T20:02:06Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/storage/sqlite/StorageAdapterInstrumentedTestBase.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.storage.sqlite;\n+\n+import android.content.Context;\n+import android.os.StrictMode;\n+import androidx.annotation.NonNull;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelProvider;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.core.model.query.predicate.QueryPredicate;\n+import com.amplifyframework.datastore.DataStoreException;\n+import com.amplifyframework.datastore.storage.StorageItemChange;\n+import com.amplifyframework.testmodels.commentsblog.AmplifyModelProvider;\n+import com.amplifyframework.testutils.Await;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+/**\n+ * Test the functionality of {@link SQLiteStorageAdapter} operations.\n+ */\n+@SuppressWarnings(\"DesignForExtension\") // Utility methods shouldn't be overwritten\n+public abstract class StorageAdapterInstrumentedTestBase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc2f31027e03d1a496bed2fc674898b7590a020f"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYxOTkzNg==", "bodyText": "Change to 2020 in all new files", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379619936", "createdAt": "2020-02-14T20:02:24Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/storage/sqlite/SQLiteStorageAdapterDeleteTest.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc2f31027e03d1a496bed2fc674898b7590a020f"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyMDY3NQ==", "bodyText": "A final utility class StrictMode with a single static enable method?", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379620675", "createdAt": "2020-02-14T20:04:04Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/storage/sqlite/StorageAdapterInstrumentedTestBase.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.storage.sqlite;\n+\n+import android.content.Context;\n+import android.os.StrictMode;\n+import androidx.annotation.NonNull;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelProvider;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.core.model.query.predicate.QueryPredicate;\n+import com.amplifyframework.datastore.DataStoreException;\n+import com.amplifyframework.datastore.storage.StorageItemChange;\n+import com.amplifyframework.testmodels.commentsblog.AmplifyModelProvider;\n+import com.amplifyframework.testutils.Await;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+/**\n+ * Test the functionality of {@link SQLiteStorageAdapter} operations.\n+ */\n+@SuppressWarnings(\"DesignForExtension\") // Utility methods shouldn't be overwritten\n+public abstract class StorageAdapterInstrumentedTestBase {\n+    private static final long SQLITE_OPERATION_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(2);\n+    private static final String DATABASE_NAME = \"AmplifyDatastore.db\";\n+\n+    private SQLiteStorageAdapter sqliteStorageAdapter;\n+    private Context context;\n+\n+    /**\n+     * Enable strict mode for catching SQLite leaks.\n+     */\n+    @BeforeClass\n+    public static void enableStrictMode() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc2f31027e03d1a496bed2fc674898b7590a020f"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyMjQxMQ==", "bodyText": "These methods should go in a class called SynchronousStorageAdapter that lives in the test sources. It would be analogous to the existing SynchronousApi and SynchronousDataStore, but it would pose a synchronous version of the storage adapter interface.\nIf you do it that way, then any test class may use this functionality, not just those who (must) extend this base class.", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379622411", "createdAt": "2020-02-14T20:08:10Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/storage/sqlite/StorageAdapterInstrumentedTestBase.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.storage.sqlite;\n+\n+import android.content.Context;\n+import android.os.StrictMode;\n+import androidx.annotation.NonNull;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelProvider;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.core.model.query.predicate.QueryPredicate;\n+import com.amplifyframework.datastore.DataStoreException;\n+import com.amplifyframework.datastore.storage.StorageItemChange;\n+import com.amplifyframework.testmodels.commentsblog.AmplifyModelProvider;\n+import com.amplifyframework.testutils.Await;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+/**\n+ * Test the functionality of {@link SQLiteStorageAdapter} operations.\n+ */\n+@SuppressWarnings(\"DesignForExtension\") // Utility methods shouldn't be overwritten\n+public abstract class StorageAdapterInstrumentedTestBase {\n+    private static final long SQLITE_OPERATION_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(2);\n+    private static final String DATABASE_NAME = \"AmplifyDatastore.db\";\n+\n+    private SQLiteStorageAdapter sqliteStorageAdapter;\n+    private Context context;\n+\n+    /**\n+     * Enable strict mode for catching SQLite leaks.\n+     */\n+    @BeforeClass\n+    public static void enableStrictMode() {\n+        StrictMode.setVmPolicy(new StrictMode.VmPolicy.Builder()\n+            .detectLeakedSqlLiteObjects()\n+            .detectLeakedClosableObjects()\n+            .penaltyLog()\n+            .penaltyDeath()\n+            .build());\n+    }\n+\n+    /**\n+     * Setup the required information for SQLiteStorageHelper construction.\n+     * @throws DataStoreException If initialization of storage adapter fails\n+     */\n+    @Before\n+    public void setUp() throws DataStoreException {\n+        context = ApplicationProvider.getApplicationContext();\n+        context.deleteDatabase(DATABASE_NAME);\n+\n+        ModelProvider modelProvider = AmplifyModelProvider.getInstance();\n+        sqliteStorageAdapter = SQLiteStorageAdapter.forModels(modelProvider);\n+        List<ModelSchema> setupResults = Await.result(\n+            SQLITE_OPERATION_TIMEOUT_MS,\n+            (Consumer<List<ModelSchema>> onResult, Consumer<DataStoreException> onError) ->\n+                sqliteStorageAdapter.initialize(context, onResult, onError)\n+        );\n+\n+        List<Class<? extends Model>> expectedModels = new ArrayList<>(modelProvider.models());\n+        expectedModels.add(StorageItemChange.Record.class); // Internal\n+        expectedModels.add(PersistentModelVersion.class); // Internal\n+        assertEquals(expectedModels.size(), setupResults.size());\n+    }\n+\n+    /**\n+     * Drop all tables and database, terminate and delete the database.\n+     * @throws DataStoreException from possible underlying DataStore exceptions\n+     */\n+    @After\n+    public void tearDown() throws DataStoreException {\n+        sqliteStorageAdapter.terminate();\n+        context.deleteDatabase(DATABASE_NAME);\n+    }\n+\n+    <T extends Model> void saveModel(@NonNull T model) throws DataStoreException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc2f31027e03d1a496bed2fc674898b7590a020f"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyMzE5OA==", "bodyText": "this seems dubious. If we have >5 second round trips to AppSync, we have bigger problems. I suspect there\u2019s something else going on here aside from the timeout being too short. Did you measure the response time of the actual network call?", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379623198", "createdAt": "2020-02-14T20:10:10Z", "author": {"login": "jamesonwilliams"}, "path": "testutils/src/main/java/com/amplifyframework/testutils/SynchronousApi.java", "diffHunk": "@@ -45,6 +46,10 @@\n  * performing various operations.\n  */\n public final class SynchronousApi {\n+\n+    private static final long EXTENDED_TIMEOUT_IN_MILLISECONDS =\n+            TimeUnit.SECONDS.toMillis(10); // 5 seconds is insufficient", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc2f31027e03d1a496bed2fc674898b7590a020f"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44f10a27884bfac102bb138e2c09f30f2925ae85", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/44f10a27884bfac102bb138e2c09f30f2925ae85", "committedDate": "2020-02-14T21:23:03Z", "message": "Update copyright year"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjI5NjMz", "url": "https://github.com/aws-amplify/amplify-android/pull/263#pullrequestreview-359229633", "createdAt": "2020-02-14T21:29:32Z", "commit": {"oid": "44f10a27884bfac102bb138e2c09f30f2925ae85"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fb36a2abb3df74774b9f112ad5950a9381d2e6f", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/7fb36a2abb3df74774b9f112ad5950a9381d2e6f", "committedDate": "2020-02-14T21:52:27Z", "message": "Remove time threshold for auth failure since latch takes care of it"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjU0NTE2", "url": "https://github.com/aws-amplify/amplify-android/pull/263#pullrequestreview-359254516", "createdAt": "2020-02-14T22:26:41Z", "commit": {"oid": "7fb36a2abb3df74774b9f112ad5950a9381d2e6f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2832, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}