{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMjMyMjg1", "number": 287, "title": "[aws-datastore] Wait for initialization before attempting operations", "bodyText": "The Category initialize(...) is called on a background thread, and\nthe Amplify framework does not wait around for it to complete. However,\na user may attempt to use a category before initialize(...) has completed.\nAs a work-around to this problem, for DataStore only, listen for an\nevent that signifies initialization is complete. Only after this, begin\nexecuting DataStore operations.\nThis approach was verified from a sample app, using the code in the below-referenced Gist.\nRefer: https://gist.github.com/jamesonwilliams/032bfaa23020a04b4b5561bc85b33f00#file-simple-datastore-consumer-md\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-02-28T06:49:25Z", "url": "https://github.com/aws-amplify/amplify-android/pull/287", "merged": true, "mergeCommit": {"oid": "0755ff395f8894912b1cc75a6762051c1b38b022"}, "closed": true, "closedAt": "2020-03-06T18:16:56Z", "author": {"login": "jamesonwilliams"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIqO9rAH2gAyMzgxMjMyMjg1OjQyMTk4NTNjOGYzMDEzNDZjZTZkMjEyZmJmODI4ZDAyOTdiYzg4OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKxCsegFqTM2OTg2ODIwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4219853c8f301346ce6d212fbf828d0297bc8891", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/4219853c8f301346ce6d212fbf828d0297bc8891", "committedDate": "2020-02-28T06:49:50Z", "message": "[aws-datastore] Wait for initialization before attempting operations\n\nThe initialize() category behavior is called on a background thread, and\nthe Amplify framework does not wait around for it to complete. However,\na user may attempt to use a category before initialize() has completed.\n\nAs a work-around to this problem, for DataStore only, listen for an\nevent that signifies initialization is complete. Only after this, begin\nexecuting DataStore operations."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "4219853c8f301346ce6d212fbf828d0297bc8891", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/4219853c8f301346ce6d212fbf828d0297bc8891", "committedDate": "2020-02-28T06:49:50Z", "message": "[aws-datastore] Wait for initialization before attempting operations\n\nThe initialize() category behavior is called on a background thread, and\nthe Amplify framework does not wait around for it to complete. However,\na user may attempt to use a category before initialize() has completed.\n\nAs a work-around to this problem, for DataStore only, listen for an\nevent that signifies initialization is complete. Only after this, begin\nexecuting DataStore operations."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTEyMjkx", "url": "https://github.com/aws-amplify/amplify-android/pull/287#pullrequestreview-369112291", "createdAt": "2020-03-04T20:50:43Z", "commit": {"oid": "4219853c8f301346ce6d212fbf828d0297bc8891"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "457d4bd2f06a82cd2ff22c6b9c8b50f9379c0b69", "author": {"user": {"login": "jamesonwilliams", "name": "Jameson Williams"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/457d4bd2f06a82cd2ff22c6b9c8b50f9379c0b69", "committedDate": "2020-03-05T17:14:57Z", "message": "Merge remote-tracking branch 'origin/master' into wait_for_init_datastore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODM3MTUy", "url": "https://github.com/aws-amplify/amplify-android/pull/287#pullrequestreview-369837152", "createdAt": "2020-03-05T19:07:57Z", "commit": {"oid": "457d4bd2f06a82cd2ff22c6b9c8b50f9379c0b69"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTowNzo1N1rOFygPzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTowNzo1N1rOFygPzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUwMTQ1NQ==", "bodyText": "Minor nit but maybe since this is effectively the latch variable we're using for concurrency management in category initialization we could have explicit naming of categoryInitializationLatch?", "url": "https://github.com/aws-amplify/amplify-android/pull/287#discussion_r388501455", "createdAt": "2020-03-05T19:07:57Z", "author": {"login": "undefobj"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java", "diffHunk": "@@ -56,13 +60,17 @@\n     // local storage adapter, and a remote API\n     private final Orchestrator orchestrator;\n \n+    // Keeps track of whether of not the category is initialized yet\n+    private final CountDownLatch categoryInitializationsPending;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "457d4bd2f06a82cd2ff22c6b9c8b50f9379c0b69"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODQxODM1", "url": "https://github.com/aws-amplify/amplify-android/pull/287#pullrequestreview-369841835", "createdAt": "2020-03-05T19:14:48Z", "commit": {"oid": "457d4bd2f06a82cd2ff22c6b9c8b50f9379c0b69"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOToxNDo0OFrOFygfdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOToxNDo0OFrOFygfdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUwNTQ2Mg==", "bodyText": "I like this refactor out of the individual overrides, basically lifecycle checks. I wonder do we need a separate beforeInitialization to ensure everything is in a good state? Could that be used for the race condition issue we saw the other day on app startup instead of requiring a singleton?", "url": "https://github.com/aws-amplify/amplify-android/pull/287#discussion_r388505462", "createdAt": "2020-03-05T19:14:48Z", "author": {"login": "undefobj"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/AWSDataStorePlugin.java", "diffHunk": "@@ -314,20 +329,24 @@ public Cancelable observe(\n             },\n             onObservationFailure,\n             onObservationCompleted\n-        );\n+        )));\n     }\n \n-    @SuppressWarnings(\"checkstyle:WhitespaceAround\") // () -> {}\n-    @NonNull\n     @Override\n-    public <T extends Model> Cancelable observe(\n+    public <T extends Model> void observe(\n             @NonNull Class<T> itemClass,\n             @NonNull QueryPredicate selectionCriteria,\n+            @NonNull Consumer<Cancelable> onObservationStarted,\n             @NonNull Consumer<DataStoreItemChange<T>> onDataStoreItemChange,\n             @NonNull Consumer<DataStoreException> onObservationFailure,\n             @NonNull Action onObservationCompleted) {\n         onObservationFailure.accept(new DataStoreException(\"Not implemented yet, buster!\", \"Check back later!\"));\n-        return () -> {};\n+    }\n+\n+    private void afterInitialization(@NonNull final Runnable runnable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "457d4bd2f06a82cd2ff22c6b9c8b50f9379c0b69"}, "originalPosition": 196}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODY2MzU1", "url": "https://github.com/aws-amplify/amplify-android/pull/287#pullrequestreview-369866355", "createdAt": "2020-03-05T19:51:01Z", "commit": {"oid": "457d4bd2f06a82cd2ff22c6b9c8b50f9379c0b69"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTo1MTowMlrOFyhvJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTo1MTowMlrOFyhvJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUyNTg2MA==", "bodyText": "I really like the new State enum here but I will admit that readability of the if-not-equals-get is a bit much and someone could introduce a bug in the future if they're not careful. Not sure I have an answer just calling it out.", "url": "https://github.com/aws-amplify/amplify-android/pull/287#discussion_r388525860", "createdAt": "2020-03-05T19:51:02Z", "author": {"login": "undefobj"}, "path": "core/src/main/java/com/amplifyframework/core/category/Category.java", "diffHunk": "@@ -101,25 +98,47 @@ public final boolean isConfigured() {\n      * the category has been successfully configured. Whereas configuration is a short-lived\n      * synchronous phase of setup, initialization may require disk/network resources, etc.\n      * @param context An Android Context\n-     * @param onInitializationAttempted Called when initialization has been attempted.\n-     *                                  The result contains information about each plugin,\n-     *                                  and whether or not its initialization succeeded.\n+     * @return A category initialization result\n      */\n-    public final synchronized void initialize(\n-            @NonNull Context context,\n-            @NonNull Consumer<CategoryInitializationResult> onInitializationAttempted) {\n-        Map<String, InitializationResult> pluginInitializationResults = new HashMap<>();\n-        for (P plugin : getPlugins()) {\n-            InitializationResult result;\n-            try {\n-                plugin.initialize(context);\n-                result = InitializationResult.success();\n-            } catch (AmplifyException pluginInitializationFailure) {\n-                result = InitializationResult.failure(pluginInitializationFailure);\n+    @NonNull\n+    @WorkerThread\n+    public final synchronized CategoryInitializationResult initialize(@NonNull Context context) {\n+        final Map<String, InitializationResult> pluginInitializationResults = new HashMap<>();\n+        if (!State.CONFIGURED.equals(state.get())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "457d4bd2f06a82cd2ff22c6b9c8b50f9379c0b69"}, "originalPosition": 118}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODY4MjAx", "url": "https://github.com/aws-amplify/amplify-android/pull/287#pullrequestreview-369868201", "createdAt": "2020-03-05T19:53:38Z", "commit": {"oid": "457d4bd2f06a82cd2ff22c6b9c8b50f9379c0b69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2857, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}