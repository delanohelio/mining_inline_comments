{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2NDQxMTcx", "number": 447, "title": "[DataStore] fix type conversion for enums and dates", "bodyText": "Notes:\n\nreuse the type converter logic on predicate values\nfix enum conversion\nfix date types conversion\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-05-12T02:05:37Z", "url": "https://github.com/aws-amplify/amplify-android/pull/447", "merged": true, "mergeCommit": {"oid": "b352d8b86f75e9192b737a673c55124a04854377"}, "closed": true, "closedAt": "2020-05-13T00:21:22Z", "author": {"login": "drochetti"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgaeV-AH2gAyNDE2NDQxMTcxOjUwZjUwMWY1ZmUxZDMxOGE3N2VhOTA1NGEyODIyMzNjMjc5ZGRkMjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgtkscAFqTQxMDUwNzExNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "50f501f5fe1d318a77ea9054a282233c279ddd22", "author": {"user": {"login": "drochetti", "name": "Daniel Rochetti"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/50f501f5fe1d318a77ea9054a282233c279ddd22", "committedDate": "2020-05-12T02:02:20Z", "message": "fix query predicate bindings type conversion\n\n**Notes:**\n\n- reuse the type converter logic on predicate values\n- fix enum conversion\n- fix date types conversion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0280a88c0095c2a2b01dd502b1d3a3168060a538", "author": {"user": {"login": "drochetti", "name": "Daniel Rochetti"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/0280a88c0095c2a2b01dd502b1d3a3168060a538", "committedDate": "2020-05-12T02:03:25Z", "message": "Merge remote-tracking branch 'origin/master' into fix/datastore-predicate-bindings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "245b1522508c98ff2110e323988d0518b7139786", "author": {"user": {"login": "drochetti", "name": "Daniel Rochetti"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/245b1522508c98ff2110e323988d0518b7139786", "committedDate": "2020-05-12T02:20:22Z", "message": "fix checkstyle errors (yet again...)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5Njc1NTMx", "url": "https://github.com/aws-amplify/amplify-android/pull/447#pullrequestreview-409675531", "createdAt": "2020-05-12T03:35:38Z", "commit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMzozNTozOVrOGT02kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwMzo0MDoxOFrOGT07mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ0MjA2Ng==", "bodyText": "@SuppressWarnings({\"rawtypes\", \"unchecked\"}) can just go directly on the method itself to make it cleaner :)\nActually, rawtypes should be avoidable by doing this:\nfinal Class<?> enumClass = field.getType().asSubclass(Enum.class);\nfinal Enum<?> enumValue = Enum.valueOf(enumClass, valueAsString);", "url": "https://github.com/aws-amplify/amplify-android/pull/447#discussion_r423442066", "createdAt": "2020-05-12T03:35:39Z", "author": {"login": "raphkim"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/SQLiteModelFieldTypeConverter.java", "diffHunk": "@@ -106,6 +152,11 @@ public Object convertValueFromSource(\n                 case MODEL:\n                     return convertModelAssociationToTarget(cursor, field);\n                 case ENUM:\n+                    @SuppressWarnings(\"rawtypes\")\n+                    final Class<? extends Enum> enumClass = field.getType().asSubclass(Enum.class);\n+                    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+                    final Enum enumValue = Enum.valueOf(enumClass, valueAsString);\n+                    return enumValue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ0MjM2NQ==", "bodyText": "maybe \"date-time\" instead of just \"date\"?", "url": "https://github.com/aws-amplify/amplify-android/pull/447#discussion_r423442365", "createdAt": "2020-05-12T03:36:53Z", "author": {"login": "raphkim"}, "path": "core/src/main/java/com/amplifyframework/core/model/types/JavaFieldType.java", "diffHunk": "@@ -50,14 +53,19 @@\n     STRING(String.class.getSimpleName()),\n \n     /**\n-     * Represents the java.util.Date data type.\n+     * Represents the Date data type.\n      */\n-    DATE(java.util.Date.class.getSimpleName()),\n+    DATE(AWSDate.class.getSimpleName()),\n \n     /**\n-     * Represents the java.sql.Time data type.\n+     * Represents the Date data type.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ0MzM1Mw==", "bodyText": "Actually, I'm not sure what the best way to represent Class<T extends Enum<T>> would be with a ?, since Class<? extends Enum<?>> doesn't sufficiently enforce the two types to be the same... hmm", "url": "https://github.com/aws-amplify/amplify-android/pull/447#discussion_r423443353", "createdAt": "2020-05-12T03:40:18Z", "author": {"login": "raphkim"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/SQLiteModelFieldTypeConverter.java", "diffHunk": "@@ -106,6 +152,11 @@ public Object convertValueFromSource(\n                 case MODEL:\n                     return convertModelAssociationToTarget(cursor, field);\n                 case ENUM:\n+                    @SuppressWarnings(\"rawtypes\")\n+                    final Class<? extends Enum> enumClass = field.getType().asSubclass(Enum.class);\n+                    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+                    final Enum enumValue = Enum.valueOf(enumClass, valueAsString);\n+                    return enumValue;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ0MjA2Ng=="}, "originalCommit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5OTQ1NjA2", "url": "https://github.com/aws-amplify/amplify-android/pull/447#pullrequestreview-409945606", "createdAt": "2020-05-12T11:25:40Z", "commit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMToyNTo0MFrOGUCF4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMjowOTowMlrOGUDeIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY1ODk3Ng==", "bodyText": "Is it possible, now, to convert all of these discrete assertEquals(..., ...,) calls into one simple, higher-level, assertEquals(todo, queriedTodo), and compare via Todo#equals(Object obj), instead of directly on each field's equals(...)?", "url": "https://github.com/aws-amplify/amplify-android/pull/447#discussion_r423658976", "createdAt": "2020-05-12T11:25:40Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/storage/sqlite/SQLiteStorageAdapterModelConverterTest.java", "diffHunk": "@@ -102,8 +102,8 @@ public void saveModelWithAllTypesThenQuery() throws DataStoreException {\n \n         // Test date scalars\n         // TODO fix tests once new Date/Time handling is done\n-        // assertEquals(todo.getCreatedAt(), queriedTodo.getCreatedAt());\n-        // assertEquals(todo.getDueDate(), queriedTodo.getDueDate());\n+        assertEquals(todo.getCreatedAt(), queriedTodo.getCreatedAt());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY2MDAyMg==", "bodyText": "Should this be public AWSTimestamp getLastUpdated(), to exercise the fourth type?", "url": "https://github.com/aws-amplify/amplify-android/pull/447#discussion_r423660022", "createdAt": "2020-05-12T11:27:31Z", "author": {"login": "jamesonwilliams"}, "path": "testmodels/src/main/java/com/amplifyframework/testmodels/todo/Todo.java", "diffHunk": "@@ -73,15 +74,15 @@ public TodoStatus getStatus() {\n         return status;\n     }\n \n-    public Date getCreatedAt() {\n+    public AWSDateTime getCreatedAt() {\n         return createdAt;\n     }\n \n     public Long getLastUpdated() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY2MDgwNA==", "bodyText": "There is a fourth AWSTimestamp, too", "url": "https://github.com/aws-amplify/amplify-android/pull/447#discussion_r423660804", "createdAt": "2020-05-12T11:29:07Z", "author": {"login": "jamesonwilliams"}, "path": "core/src/main/java/com/amplifyframework/core/model/types/JavaFieldType.java", "diffHunk": "@@ -17,6 +17,9 @@\n \n import androidx.annotation.NonNull;\n \n+import com.amplifyframework.core.model.AWSDate;\n+import com.amplifyframework.core.model.AWSDateTime;\n+import com.amplifyframework.core.model.AWSTime;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY2MzA1MQ==", "bodyText": "On the typing -- use of Object, and erasure or template type --\nAny benefit to capturing the <T> here, for this call? e.g.\n// I guess you don't actually use value, just it's .getClass() ....\npublic static <T> JavaFieldType getJavaFieldTypeFromValue(@NonNull Class<T> valueClass) {\n    if (Model.class.isAssignableFrom(valueClass)) {\n        // Hey, it's a model, that's neat.\n    } else if (Enum.class.isAssignableFrom(valueClass)) {\n        // An enum!\n    }\n    try {\n        return JavaFieldType.<T>from(/* Class<T> continued through ... */ valueClass);\n    } catch (...) {\n        ...\n    }\n}", "url": "https://github.com/aws-amplify/amplify-android/pull/447#discussion_r423663051", "createdAt": "2020-05-12T11:33:41Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/TypeConverter.java", "diffHunk": "@@ -81,6 +83,26 @@ static JavaFieldType getJavaFieldType(@NonNull ModelField field) {\n         }\n     }\n \n+    /**\n+     * Gets the {@link JavaFieldType} from the value class.\n+     * @param value The value to guess the type from.\n+     * @return the {@link JavaFieldType} from the value class.\n+     */\n+    public static JavaFieldType getJavaFieldTypeFromValue(@NonNull Object value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY2NDc1NQ==", "bodyText": "Woo-hoo!", "url": "https://github.com/aws-amplify/amplify-android/pull/447#discussion_r423664755", "createdAt": "2020-05-12T11:37:02Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/SQLiteModelFieldTypeConverter.java", "diffHunk": "@@ -36,10 +40,6 @@\n import com.google.gson.Gson;\n \n import java.io.IOException;\n-import java.sql.Time;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY4MTU2OQ==", "bodyText": "Meh. Yea, I wasn't able to get rid of one final unchecked warning.\n    @Test\n    public void testEnumConversion() {\n        assertEquals(Foo.BAR, valueOf(Foo.class, Foo.BAR.name()));\n    }\n\n    private static <E extends Enum<E>> Object valueOf(Class<?> clazz, String fieldName) {\n        @SuppressWarnings(\"unchecked\")\n        Class<E> enumClazz = (Class<E>) clazz.asSubclass(Enum.class);\n        return Enum.valueOf(enumClazz, fieldName);\n    }\n\n    enum Foo {\n        BAR,\n    }", "url": "https://github.com/aws-amplify/amplify-android/pull/447#discussion_r423681569", "createdAt": "2020-05-12T12:09:02Z", "author": {"login": "jamesonwilliams"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/SQLiteModelFieldTypeConverter.java", "diffHunk": "@@ -106,6 +152,11 @@ public Object convertValueFromSource(\n                 case MODEL:\n                     return convertModelAssociationToTarget(cursor, field);\n                 case ENUM:\n+                    @SuppressWarnings(\"rawtypes\")\n+                    final Class<? extends Enum> enumClass = field.getType().asSubclass(Enum.class);\n+                    @SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+                    final Enum enumValue = Enum.valueOf(enumClass, valueAsString);\n+                    return enumValue;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ0MjA2Ng=="}, "originalCommit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMjk0NDU1", "url": "https://github.com/aws-amplify/amplify-android/pull/447#pullrequestreview-410294455", "createdAt": "2020-05-12T18:04:42Z", "commit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODowNDo0MlrOGUSttA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODo0MDozNVrOGUUAgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzMTMxNg==", "bodyText": "Does this need to be public?", "url": "https://github.com/aws-amplify/amplify-android/pull/447#discussion_r423931316", "createdAt": "2020-05-12T18:04:42Z", "author": {"login": "richardmcclellan"}, "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/SQLiteModelFieldTypeConverter.java", "diffHunk": "@@ -49,7 +49,7 @@\n  * to <code>Model</code> properties and from <code>Model</code> properties to values that are\n  * valid in a <code>SQLiteStatement</code>.\n  */\n-final class SQLiteModelFieldTypeConverter implements ModelFieldTypeConverter<Cursor, Model> {\n+public final class SQLiteModelFieldTypeConverter implements ModelFieldTypeConverter<Cursor, Model> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1MjUxNA==", "bodyText": "As written, a customer might get confused thinking Date is java.util.Date.    This should be AWSDate (or whatever the model class is renamed, if we are renaming it).\nIf we do rename AWSDate, I don't like just dropping the AWS prefix, since Date would be confused with java.util.Date.  Maybe AmplifyDate?  Not sure about that either though.", "url": "https://github.com/aws-amplify/amplify-android/pull/447#discussion_r423952514", "createdAt": "2020-05-12T18:40:35Z", "author": {"login": "richardmcclellan"}, "path": "core/src/main/java/com/amplifyframework/core/model/types/JavaFieldType.java", "diffHunk": "@@ -50,14 +53,19 @@\n     STRING(String.class.getSimpleName()),\n \n     /**\n-     * Represents the java.util.Date data type.\n+     * Represents the Date data type.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245b1522508c98ff2110e323988d0518b7139786"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13431a96755f94fa5c0fd31fd104207e984b7064", "author": {"user": {"login": "drochetti", "name": "Daniel Rochetti"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/13431a96755f94fa5c0fd31fd104207e984b7064", "committedDate": "2020-05-12T22:16:32Z", "message": "Merge remote-tracking branch 'origin/master' into fix/datastore-predicate-bindings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49e229f0e32ee96c1189b7edf99b1b5241e5010a", "author": {"user": {"login": "drochetti", "name": "Daniel Rochetti"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/49e229f0e32ee96c1189b7edf99b1b5241e5010a", "committedDate": "2020-05-12T22:36:32Z", "message": "address PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2610da425d09e9291c949f4b68f28b3c459976c2", "author": {"user": {"login": "drochetti", "name": "Daniel Rochetti"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/2610da425d09e9291c949f4b68f28b3c459976c2", "committedDate": "2020-05-12T22:36:56Z", "message": "Merge remote-tracking branch 'origin/master' into fix/datastore-predicate-bindings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNTA1ODUy", "url": "https://github.com/aws-amplify/amplify-android/pull/447#pullrequestreview-410505852", "createdAt": "2020-05-13T00:13:03Z", "commit": {"oid": "2610da425d09e9291c949f4b68f28b3c459976c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNTA3MTE3", "url": "https://github.com/aws-amplify/amplify-android/pull/447#pullrequestreview-410507117", "createdAt": "2020-05-13T00:17:28Z", "commit": {"oid": "2610da425d09e9291c949f4b68f28b3c459976c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2474, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}