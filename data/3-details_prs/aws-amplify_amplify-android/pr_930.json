{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMTgxNzcw", "number": 930, "title": "feature(aws-api): support custom group claim", "bodyText": "Description of changes:\nSupport custom group claim for OIDC @auth use-case.\nNo tests are included in this PR, but the changes were tested in a sample app. Explicit unit tests will follow in a separate PR unless requested otherwise.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-10-26T17:12:48Z", "url": "https://github.com/aws-amplify/amplify-android/pull/930", "merged": true, "mergeCommit": {"oid": "5cf0cee7d86643c26e7b3caf9055f88652780294"}, "closed": true, "closedAt": "2020-10-28T21:02:40Z", "author": {"login": "raphkim"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWXPUVgH2gAyNTEwMTgxNzcwOjE1ZWQ2OWU4M2MwNTQ5NzA2ODdmYjAxZTc4Yzk1ZDliNTE5MzgxOGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXEADHAH2gAyNTEwMTgxNzcwOmU0MzM1ZDlhYzVlZDhjMzFkOGMxMDBkN2ZkZjJhODMxM2U0YjYyOWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "15ed69e83c054970687fb01e78c95d9b5193818b", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/15ed69e83c054970687fb01e78c95d9b5193818b", "committedDate": "2020-10-26T16:48:07Z", "message": "support custom group claim"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "902bb379f6a2fd2e60c5796cabb19849dfab3f69", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/902bb379f6a2fd2e60c5796cabb19849dfab3f69", "committedDate": "2020-10-26T17:12:31Z", "message": "update error message for groups getter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDI4Mzgx", "url": "https://github.com/aws-amplify/amplify-android/pull/930#pullrequestreview-517028381", "createdAt": "2020-10-26T17:44:12Z", "commit": {"oid": "902bb379f6a2fd2e60c5796cabb19849dfab3f69"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNzo0NDoxMlrOHobSHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNzo0NjowN1rOHobXaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE1MjA5NQ==", "bodyText": "The data type here is starting to look like a poor-man's data structure. Does it make sense to create a class ReadAuthorizedGroups, to encapsulate the data?", "url": "https://github.com/aws-amplify/amplify-android/pull/930#discussion_r512152095", "createdAt": "2020-10-26T17:44:12Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -291,7 +292,7 @@ public String getVersion() {\n             try {\n                 AppSyncGraphQLRequest<R> appSyncRequest = (AppSyncGraphQLRequest<R>) request;\n                 AuthRule ownerRuleWithReadRestriction = null;\n-                ArrayList<String> readAuthorizedGroups = new ArrayList<>();\n+                Map<String, List<String>> readAuthorizedGroupsMap = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "902bb379f6a2fd2e60c5796cabb19849dfab3f69"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE1MjYwMA==", "bodyText": "How can we carve more of this logic out of the AWSApiPlugin?", "url": "https://github.com/aws-amplify/amplify-android/pull/930#discussion_r512152600", "createdAt": "2020-10-26T17:44:57Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -361,65 +363,61 @@ private boolean isReadRestrictingOwner(AuthRule authRule) {\n \n     private boolean isReadRestrictingStaticGroup(AuthRule authRule) {\n         return AuthStrategy.GROUPS.equals(authRule.getAuthStrategy())\n-            && authRule.getGroups() != null && !authRule.getGroups().isEmpty()\n+            && !authRule.getGroups().isEmpty()\n             && authRule.getOperationsOrDefault().contains(ModelOperation.READ);\n     }\n \n     private String getIdentityValue(String identityClaim, AuthorizationType authType) throws ApiException {\n-        String identityValue = null;\n-\n         try {\n-            identityValue = CognitoJWTParser\n+            return CognitoJWTParser\n                     .getPayload(getAuthToken(authType))\n                     .getString(identityClaim);\n         } catch (JSONException | CognitoParameterInvalidException error) {\n-            // Could not read identity value from the token...\n-            // Exception will be thrown so do nothing for now\n-        }\n-\n-        if (identityValue == null || identityValue.isEmpty()) {\n             throw new ApiException(\n-                    \"Attempted to subscribe to a model with owner based authorization without \" + identityClaim + \" \" +\n-                    \"which was specified (or defaulted to) as the identity claim.\",\n+                    \"Attempted to subscribe to a model with owner-based authorization without \" + identityClaim + \" \" +\n+                            \"which was specified (or defaulted to) as the identity claim.\",\n                     \"If you did not specify a custom identityClaim in your schema, make sure you are logged in. If \" +\n                             \"you did, check that the value you specified in your schema is present in the access key.\"\n             );\n         }\n-\n-        return identityValue;\n     }\n \n-    private ArrayList<String> getUserGroups(AuthorizationType authType) throws ApiException {\n-        // Custom groups claim isn't supported yet.\n-        if (!AuthorizationType.AMAZON_COGNITO_USER_POOLS.equals(authType)) {\n-            throw new ApiException(\"Custom groups claim is not supported yet.\",\n-                    \"Please use Amazon Cognito User Pools to authorize your API.\");\n-        }\n-\n+    private ArrayList<String> getUserGroups(String groupClaim, AuthorizationType authType) throws ApiException {\n         ArrayList<String> groups = new ArrayList<>();\n-        final String GROUPS_KEY = \"cognito:groups\";\n-\n         try {\n-            JSONObject accessToken = CognitoJWTParser.getPayload(getAuthToken(authType));\n-\n-            if (accessToken.has(GROUPS_KEY)) {\n-                JSONArray jsonGroups = accessToken.getJSONArray(GROUPS_KEY);\n-\n-                for (int i = 0; i < jsonGroups.length(); i++) {\n-                    groups.add(jsonGroups.getString(i));\n+            JSONObject accessToken = CognitoJWTParser\n+                    .getPayload(getAuthToken(authType));\n+            if (accessToken.has(groupClaim)) {\n+                JSONArray jsonGroups = accessToken.getJSONArray(groupClaim);\n+                for (int index = 0; index < jsonGroups.length(); index++) {\n+                    groups.add(jsonGroups.getString(index));\n                 }\n             }\n         } catch (JSONException | CognitoParameterInvalidException error) {\n             throw new ApiException(\n-                    \"Failed to parse groups from auth rule.\",\n-                    error,\n-                    \"This should never happen - see attached exception for more details and report to us on GitHub.\"\n+                    \"Failed to parse group claim from the token.\",\n+                    AmplifyException.REPORT_BUG_TO_AWS_SUGGESTION\n             );\n         }\n \n         return groups;\n     }\n \n+    private boolean userNotInReadRestrictingGroups(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "902bb379f6a2fd2e60c5796cabb19849dfab3f69"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE1MzQ1MQ==", "bodyText": "How are group A and B different? Can  you give semantic names, PRIVILEGED_GROUP, NO_ACCESS_GROUP Or ALICE_GROUP and BOB_GROUP, with a little comment about the security relationship between Alice and Bob?", "url": "https://github.com/aws-amplify/amplify-android/pull/930#discussion_r512153451", "createdAt": "2020-10-26T17:46:07Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/test/java/com/amplifyframework/api/aws/auth/OwnerBasedAuthTest.java", "diffHunk": "@@ -68,6 +68,9 @@\n     private static final String GRAPHQL_API_WITH_COGNITO = \"graphQlApi_cognito\";\n     private static final String GRAPHQL_API_WITH_OIDC = \"graphQlApi_oidc\";\n \n+    private static final String GROUP_A = \"http://myapp1.com/claims/groups\";\n+    private static final String GROUP_B = \"http://myapp2.com/claims/groups\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "902bb379f6a2fd2e60c5796cabb19849dfab3f69"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDUzMTA2", "url": "https://github.com/aws-amplify/amplify-android/pull/930#pullrequestreview-517053106", "createdAt": "2020-10-26T18:14:22Z", "commit": {"oid": "902bb379f6a2fd2e60c5796cabb19849dfab3f69"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxODoxNDoyMlrOHoccVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxODoxNDoyMlrOHoccVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3MTA5Mg==", "bodyText": "Yea, it's not a big deal either way. Up to you. The benefit of doing the class is that you'll get to give a semantic label to the key and to the values. Looking at this readAuthorizedGroupsMap right now, I'm not certain what the key is, until I scroll down and look at the impl.", "url": "https://github.com/aws-amplify/amplify-android/pull/930#discussion_r512171092", "createdAt": "2020-10-26T18:14:22Z", "author": {"login": "jamesonwilliams"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -291,7 +292,7 @@ public String getVersion() {\n             try {\n                 AppSyncGraphQLRequest<R> appSyncRequest = (AppSyncGraphQLRequest<R>) request;\n                 AuthRule ownerRuleWithReadRestriction = null;\n-                ArrayList<String> readAuthorizedGroups = new ArrayList<>();\n+                Map<String, List<String>> readAuthorizedGroupsMap = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE1MjA5NQ=="}, "originalCommit": {"oid": "902bb379f6a2fd2e60c5796cabb19849dfab3f69"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTU5NjIx", "url": "https://github.com/aws-amplify/amplify-android/pull/930#pullrequestreview-517159621", "createdAt": "2020-10-26T20:42:55Z", "commit": {"oid": "902bb379f6a2fd2e60c5796cabb19849dfab3f69"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMDo0Mjo1NlrOHohmBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMDo0Mjo1NlrOHohmBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI1NTQ5NA==", "bodyText": "Why remove the null check?", "url": "https://github.com/aws-amplify/amplify-android/pull/930#discussion_r512255494", "createdAt": "2020-10-26T20:42:56Z", "author": {"login": "TrekSoft"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -361,65 +363,61 @@ private boolean isReadRestrictingOwner(AuthRule authRule) {\n \n     private boolean isReadRestrictingStaticGroup(AuthRule authRule) {\n         return AuthStrategy.GROUPS.equals(authRule.getAuthStrategy())\n-            && authRule.getGroups() != null && !authRule.getGroups().isEmpty()\n+            && !authRule.getGroups().isEmpty()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "902bb379f6a2fd2e60c5796cabb19849dfab3f69"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3ODE3MjUy", "url": "https://github.com/aws-amplify/amplify-android/pull/930#pullrequestreview-517817252", "createdAt": "2020-10-27T15:11:58Z", "commit": {"oid": "902bb379f6a2fd2e60c5796cabb19849dfab3f69"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNToxMTo1OFrOHpBb8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNToxMTo1OFrOHpBb8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc3NzIwMw==", "bodyText": "The reason this was done the way it was is because an error won't be thrown if the identityClaim key is present but empty. And it seemed to make sense to throw the error in that case.", "url": "https://github.com/aws-amplify/amplify-android/pull/930#discussion_r512777203", "createdAt": "2020-10-27T15:11:58Z", "author": {"login": "TrekSoft"}, "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -361,65 +363,61 @@ private boolean isReadRestrictingOwner(AuthRule authRule) {\n \n     private boolean isReadRestrictingStaticGroup(AuthRule authRule) {\n         return AuthStrategy.GROUPS.equals(authRule.getAuthStrategy())\n-            && authRule.getGroups() != null && !authRule.getGroups().isEmpty()\n+            && !authRule.getGroups().isEmpty()\n             && authRule.getOperationsOrDefault().contains(ModelOperation.READ);\n     }\n \n     private String getIdentityValue(String identityClaim, AuthorizationType authType) throws ApiException {\n-        String identityValue = null;\n-\n         try {\n-            identityValue = CognitoJWTParser\n+            return CognitoJWTParser\n                     .getPayload(getAuthToken(authType))\n                     .getString(identityClaim);\n         } catch (JSONException | CognitoParameterInvalidException error) {\n-            // Could not read identity value from the token...\n-            // Exception will be thrown so do nothing for now\n-        }\n-\n-        if (identityValue == null || identityValue.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "902bb379f6a2fd2e60c5796cabb19849dfab3f69"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae3a20507dd4a49258e740372fcd95e3fe22504b", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/ae3a20507dd4a49258e740372fcd95e3fe22504b", "committedDate": "2020-10-28T20:56:58Z", "message": "address pr comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4335d9ac5ed8c31d8c100d7fdf2a8313e4b629d", "author": {"user": {"login": "raphkim", "name": "Raphael Kim"}}, "url": "https://github.com/aws-amplify/amplify-android/commit/e4335d9ac5ed8c31d8c100d7fdf2a8313e4b629d", "committedDate": "2020-10-28T20:57:10Z", "message": "Merge branch 'main' of https://github.com/aws-amplify/amplify-android into custom-groups-claim"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1786, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}