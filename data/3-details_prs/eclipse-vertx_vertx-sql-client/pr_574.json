{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NjEzNDYw", "number": 574, "title": "Simplified transaction API improvements", "bodyText": "This PR attempts to provide a better simplified transaction API.\nThe current API manages the connection on behalf of the user avoiding the tedious return to a pool:\npool.begin()\n  .flatMap(tx -> tx\n    .query(\"INSERT INTO Users (first_name,last_name) VALUES ('Julien','Viet')\")\n    .execute()\n    .flatMap(res1 -> tx\n      .query(\"INSERT INTO Users (first_name,last_name) VALUES ('Emad','Alblueshi')\")\n      .execute())\n    .compose(\n      res2 -> tx.commit(), \n      err -> tx.rollback())\n  ).onComplete(ar3 -> {\n  if (ar3.succeeded()) {\n    System.out.println(\"Transaction succeeded\");\n  } else {\n    System.out.println(\"Transaction failed \" + ar3.cause().getMessage());\n  }\n});\nThe new API relies on the user providing a function that maps a client to a Future<T> on which depends the overall result and the transaction management:\n\nwhen the future succeeds the transaction is committed\nwhen the future fails the transaction is rolled back\n\nThe overall result function result is returned as completion of the overall operation\n// Acquire a transaction and begin the transaction\npool.withTransaction(client -> client\n  .query(\"INSERT INTO Users (first_name,last_name) VALUES ('Julien','Viet')\")\n  .execute()\n  .flatMap(res -> client\n    .query(\"INSERT INTO Users (first_name,last_name) VALUES ('Julien','Viet')\")\n    .execute()\n    // Map to a message result\n    .map(\"Users inserted\"))\n).onComplete(ar -> {\n  // The connection was automatically return to the pool\n  if (ar.succeeded()) {\n    // Transaction was committed\n    String message = ar.result();\n    System.out.println(\"Transaction succeeded: \" + message);\n  } else {\n    // Transaction was rolled back\n    System.out.println(\"Transaction failed \" + ar.cause().getMessage());\n  }\n});", "createdAt": "2020-04-06T12:33:10Z", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574", "merged": true, "mergeCommit": {"oid": "b170bdc05859ced53d1eb02a2a629e8053fe72db"}, "closed": true, "closedAt": "2020-04-11T07:12:00Z", "author": {"login": "vietj"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUv5TpAH2gAyMzk5NjEzNDYwOjM3ZDRhZjA0YjQwZTk1ZjM4ZmM0NTMxZGJhN2Q3ODgyNTdlYzE0MDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWTF_EgBqjMyMjIyNTIyNzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "37d4af04b40e95f38fc4531dba7d788257ec1400", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/37d4af04b40e95f38fc4531dba7d788257ec1400", "committedDate": "2020-04-05T20:12:42Z", "message": "TransactionImpl should use TxCommand instead of comparing SQL for isComplete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01f86383a77899bd84c3d4d788ea8a25b1265c1b", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/01f86383a77899bd84c3d4d788ea8a25b1265c1b", "committedDate": "2020-04-06T09:17:45Z", "message": "Now Transaction provides a result that can be used to track the transaction outcome"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "630a0f3fbefe8f459ac245875978de106469c1ca", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/630a0f3fbefe8f459ac245875978de106469c1ca", "committedDate": "2020-04-06T09:17:51Z", "message": "Use an enum for TxCommand kind instead of being singletons"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNjcwOTc3", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#pullrequestreview-390670977", "createdAt": "2020-04-09T10:23:30Z", "commit": {"oid": "060c1dec62332a2862d03f187ab7d6adb4d17ede"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMDoyMzozMFrOGDSzuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMDoyMzozMFrOGDSzuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEwNzA2NQ==", "bodyText": "Can you clarify is it necessary that Transaction does not extend SqlClient anymore? I think it becomes more complicated since users have to use the connection API directly if doing some operations on a transaction.", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406107065", "createdAt": "2020-04-09T10:23:30Z", "author": {"login": "BillyYccc"}, "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/Transaction.java", "diffHunk": "@@ -26,7 +26,7 @@\n  * A transaction that allows to control the transaction and receive events.\n  */\n @VertxGen\n-public interface Transaction extends SqlClient {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "060c1dec62332a2862d03f187ab7d6adb4d17ede"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTc0MTg1", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#pullrequestreview-391174185", "createdAt": "2020-04-09T22:31:40Z", "commit": {"oid": "4797965a02ce7ee9e917b03be64ae2245f389582"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMjozMTo0MFrOGDrmSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMjozMTo0MFrOGDrmSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxMzIyNQ==", "bodyText": "the field could be removed and use completionPromise.future() instead.", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406513225", "createdAt": "2020-04-09T22:31:40Z", "author": {"login": "BillyYccc"}, "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/TransactionImpl.java", "diffHunk": "@@ -209,24 +218,12 @@ public void rollback(Handler<AsyncResult<Void>> handler) {\n     }\n   }\n \n-  @Override\n-  public void close() {\n-    rollback();\n-  }\n-\n-  @Override\n-  public io.vertx.sqlclient.Transaction abortHandler(Handler<Void> handler) {\n-    failedHandler = handler;\n-    return this;\n-  }\n-\n-  private ScheduledCommand<Void> doQuery(TxCommand cmd, Promise<Void> handler) {\n+  private <R> ScheduledCommand<R> doQuery(TxCommand<R> cmd, Promise<R> handler) {\n     return new ScheduledCommand<>(cmd, handler);\n   }\n-  \n+\n   @Override\n-  boolean autoCommit() {\n-    return false;\n+  public Future<Void> completion() {\n+    return completionFuture;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4797965a02ce7ee9e917b03be64ae2245f389582"}, "originalPosition": 243}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTc0OTE5", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#pullrequestreview-391174919", "createdAt": "2020-04-09T22:33:28Z", "commit": {"oid": "4797965a02ce7ee9e917b03be64ae2245f389582"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMjozMzoyOFrOGDrouA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMjozMzoyOFrOGDrouA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxMzg0OA==", "bodyText": "we can let the TransactionRollbackException include the failure context here, like new TransactionRollbackException(ar.cause).", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/574#discussion_r406513848", "createdAt": "2020-04-09T22:33:28Z", "author": {"login": "BillyYccc"}, "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/TransactionImpl.java", "diffHunk": "@@ -58,21 +64,61 @@\n     }\n   }\n \n-  @Override\n-  protected <T> Promise<T> promise() {\n-    return context.promise();\n+  Future<Transaction> begin() {\n+    PromiseInternal<Transaction> promise = context.promise(this::afterBegin);\n+    ScheduledCommand<Transaction> b = doQuery(new TxCommand<>(TxCommand.Kind.BEGIN, this), promise);\n+    doSchedule(b.cmd, b.handler);\n+    return promise.future();\n   }\n \n-  @Override\n-  protected <T> Promise<T> promise(Handler<AsyncResult<T>> handler) {\n-    return context.promise(handler);\n+  private <R> void doSchedule(CommandBase<R> cmd, Handler<AsyncResult<R>> handler) {\n+    connection.schedule(cmd, context.promise(handler));\n   }\n \n-  private <R> void doSchedule(CommandBase<R> cmd, Handler<AsyncResult<R>> handler) {\n-    conn.schedule(cmd, context.promise(handler));\n+  private <R> void wrapAndSchedule(ScheduledCommand<R> scheduled) {\n+    CommandBase<R> cmd = scheduled.cmd;\n+    if (isComplete(cmd)) {\n+      status = ST_COMPLETED;\n+      doSchedule(cmd, ar -> {\n+        if (ar.succeeded()) {\n+          if (cmd == COMMIT) {\n+            completionPromise.tryComplete();\n+          } else {\n+            completionPromise.tryFail(TransactionRollbackException.INSTANCE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4797965a02ce7ee9e917b03be64ae2245f389582"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "949961b1284ada235558dfaa1ad332230a129195", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/949961b1284ada235558dfaa1ad332230a129195", "committedDate": "2020-04-10T11:45:55Z", "message": "TxCommand now has a generic result instead of a void result"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4710fbef5579034045de5e11dcb0849bf8b1ffbe", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/4710fbef5579034045de5e11dcb0849bf8b1ffbe", "committedDate": "2020-04-10T11:45:55Z", "message": "SqlConnection begin returns a Future<Transaction>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f707f523845f7209b9384aa001111548035569f", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/5f707f523845f7209b9384aa001111548035569f", "committedDate": "2020-04-10T12:08:46Z", "message": "Transaction API improvements\n- Transaction does not extend anymore SqlClient\n- Pool#begin is removed\n- new simplified transaction API with Pool#withTransaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82024de2d86459f0224dc8c19f4a2cb9e1329269", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/82024de2d86459f0224dc8c19f4a2cb9e1329269", "committedDate": "2020-04-10T12:08:47Z", "message": "Remove prepare method on Transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efe6539fd01aaee37875cde8dde2289528ce0afc", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/efe6539fd01aaee37875cde8dde2289528ce0afc", "committedDate": "2020-04-10T12:08:47Z", "message": "Remove abort handler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc069553c33b0b14c81e95847b949e2bf6723b98", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/fc069553c33b0b14c81e95847b949e2bf6723b98", "committedDate": "2020-04-10T12:08:47Z", "message": "Rename Transaction#result() => Transaction#completion()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf02d3a9e1f2149b49fa29b5824ce7fc12d92aad", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/bf02d3a9e1f2149b49fa29b5824ce7fc12d92aad", "committedDate": "2020-04-10T12:08:47Z", "message": "Remove Transaction#close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16cc918ac56366a069ce7d8282546f0f68fdca5e", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/16cc918ac56366a069ce7d8282546f0f68fdca5e", "committedDate": "2020-04-10T12:08:47Z", "message": "Only keep the completion Promise in Transaction and remove the future field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0453bb30caf6cbd9434b7ae6936a789202a5ac7e", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/0453bb30caf6cbd9434b7ae6936a789202a5ac7e", "committedDate": "2020-04-10T12:08:47Z", "message": "More improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88f8a396d78a3a519164736e46270d4fcda4d407", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/88f8a396d78a3a519164736e46270d4fcda4d407", "committedDate": "2020-04-10T15:46:48Z", "message": "Fix autocommit bug with DB2"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e8f6ce1695e16470b4c26d151e36d7eba4dfe35", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/2e8f6ce1695e16470b4c26d151e36d7eba4dfe35", "committedDate": "2020-04-10T09:18:54Z", "message": "Make work on DB2"}, "afterCommit": {"oid": "88f8a396d78a3a519164736e46270d4fcda4d407", "author": {"user": {"login": "vietj", "name": "Julien Viet"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/88f8a396d78a3a519164736e46270d4fcda4d407", "committedDate": "2020-04-10T15:46:48Z", "message": "Fix autocommit bug with DB2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1597, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}