{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MDc1NDEz", "number": 662, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoyOToxNFrOEAZDvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoyOToxNFrOEAZDvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4ODQ2MDE0OnYy", "diffSide": "RIGHT", "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/pool/ConnectionPool.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoyOToxNFrOGbo7Cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNjo0NzoxOFrOGb97FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzNTIxMQ==", "bodyText": "did you check this case can happen ? this code is single threaded, i.e always the same thread shall access the pool (perhaps it does not and in that case it's a bug), so the expression available.size() > 0 being true implies that proxy != null is true as well", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/662#discussion_r431635211", "createdAt": "2020-05-28T07:29:14Z", "author": {"login": "vietj"}, "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/pool/ConnectionPool.java", "diffHunk": "@@ -242,6 +242,10 @@ private void check() {\n         while (waiters.size() > 0) {\n           if (available.size() > 0) {\n             PooledConnection proxy = available.poll();\n+            if (proxy == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cbb5177792db22d0e2c5ff9f71008c029600822"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3OTI4NQ==", "bodyText": "Yes the connection pool actions should be all emitted on the eventloop context associated with the pool so it should be impossible for that to happen.\nBut I found it incorrect for the closing method which might cause different threads access the states in connection pool. The close method is not called on the associated context\n\n  \n    \n      vertx-sql-client/vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/pool/ConnectionPool.java\n    \n    \n        Lines 171 to 186\n      in\n      04f1f41\n    \n    \n    \n    \n\n        \n          \n           public void close(Holder holder, Promise<Void> promise) { \n        \n\n        \n          \n             if (holder != this.holder) { \n        \n\n        \n          \n               String msg; \n        \n\n        \n          \n               if (this.holder == null) { \n        \n\n        \n          \n                 msg = \"Connection released twice\"; \n        \n\n        \n          \n               } else { \n        \n\n        \n          \n                 msg = \"Connection released by \" + holder + \" owned by \" + this.holder; \n        \n\n        \n          \n               } \n        \n\n        \n          \n               // Log it ? \n        \n\n        \n          \n               promise.fail(msg); \n        \n\n        \n          \n               return; \n        \n\n        \n          \n             } \n        \n\n        \n          \n             this.holder = null; \n        \n\n        \n          \n             release(this); \n        \n\n        \n          \n             promise.complete(); \n        \n\n        \n          \n           }", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/662#discussion_r431979285", "createdAt": "2020-05-28T16:47:18Z", "author": {"login": "BillyYccc"}, "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/impl/pool/ConnectionPool.java", "diffHunk": "@@ -242,6 +242,10 @@ private void check() {\n         while (waiters.size() > 0) {\n           if (available.size() > 0) {\n             PooledConnection proxy = available.poll();\n+            if (proxy == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzNTIxMQ=="}, "originalCommit": {"oid": "2cbb5177792db22d0e2c5ff9f71008c029600822"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4379, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}