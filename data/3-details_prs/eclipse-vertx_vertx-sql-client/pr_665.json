{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MjY2MzU3", "number": 665, "title": "Initial database metadata API", "bodyText": "Closes #645\nThis allows a new DatabaseMetaData object to be retrieved from any SqlConnection via getDatabaseMetaData().\nCurrently the DB metadata has 3 properties:\n\nDB product name (String)\nDB major version (int)\nDB minor version (int)\n\nCC @gavinking to make sure this is what you need in HR", "createdAt": "2020-05-28T05:57:11Z", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665", "merged": true, "mergeCommit": {"oid": "e87b0a1488d6320b6c8fb1f9179079ae732b69a3"}, "closed": true, "closedAt": "2020-05-29T13:55:47Z", "author": {"login": "aguibert"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclowKEgFqTQxOTg0NTYxNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl_-KkAFqTQyMDgzNzM3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODQ1NjE1", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#pullrequestreview-419845615", "createdAt": "2020-05-28T07:30:05Z", "commit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzozMDowNVrOGbo8xQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzozMDowNVrOGbo8xQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzNTY1Mw==", "bodyText": "DatabaseMetadata , metadata is a single word (https://en.wikipedia.org/wiki/Metadata)", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#discussion_r431635653", "createdAt": "2020-05-28T07:30:05Z", "author": {"login": "vietj"}, "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/spi/DatabaseMetaData.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package io.vertx.sqlclient.spi;\n+\n+import io.vertx.codegen.annotations.VertxGen;\n+\n+/**\n+ * Contains static metadata about the backend database server \n+ */\n+@VertxGen\n+public interface DatabaseMetaData {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODQ1ODQz", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#pullrequestreview-419845843", "createdAt": "2020-05-28T07:30:25Z", "commit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzozMDoyNlrOGbo9fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzozMDoyNlrOGbo9fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzNTgzOQ==", "bodyText": "simply productName(), no need to prefix with database as we are in a class prefixed Database", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#discussion_r431635839", "createdAt": "2020-05-28T07:30:26Z", "author": {"login": "vietj"}, "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/spi/DatabaseMetaData.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package io.vertx.sqlclient.spi;\n+\n+import io.vertx.codegen.annotations.VertxGen;\n+\n+/**\n+ * Contains static metadata about the backend database server \n+ */\n+@VertxGen\n+public interface DatabaseMetaData {\n+  \n+  /**\n+   * @return The product name of the backend database server\n+   */\n+  public String getDatabaseProductName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODQ2NTIx", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#pullrequestreview-419846521", "createdAt": "2020-05-28T07:31:31Z", "commit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzozMTozMVrOGbo_jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzozMTozMVrOGbo_jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzNjM2NQ==", "bodyText": "simply majorVersion(), no need to prefix with database as we are in a class prefixed Database", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#discussion_r431636365", "createdAt": "2020-05-28T07:31:31Z", "author": {"login": "vietj"}, "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/spi/DatabaseMetaData.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package io.vertx.sqlclient.spi;\n+\n+import io.vertx.codegen.annotations.VertxGen;\n+\n+/**\n+ * Contains static metadata about the backend database server \n+ */\n+@VertxGen\n+public interface DatabaseMetaData {\n+  \n+  /**\n+   * @return The product name of the backend database server\n+   */\n+  public String getDatabaseProductName();\n+  \n+  /**\n+   * @return The major version of the backend database server\n+   */\n+  public int getDatabaseMajorVersion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODQ2NjE5", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#pullrequestreview-419846619", "createdAt": "2020-05-28T07:31:39Z", "commit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzozMTozOVrOGbo_3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzozMTozOVrOGbo_3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzNjQ0Nw==", "bodyText": "simply minorVersion(), no need to prefix with database as we are in a class prefixed Database", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#discussion_r431636447", "createdAt": "2020-05-28T07:31:39Z", "author": {"login": "vietj"}, "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/spi/DatabaseMetaData.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package io.vertx.sqlclient.spi;\n+\n+import io.vertx.codegen.annotations.VertxGen;\n+\n+/**\n+ * Contains static metadata about the backend database server \n+ */\n+@VertxGen\n+public interface DatabaseMetaData {\n+  \n+  /**\n+   * @return The product name of the backend database server\n+   */\n+  public String getDatabaseProductName();\n+  \n+  /**\n+   * @return The major version of the backend database server\n+   */\n+  public int getDatabaseMajorVersion();\n+  \n+  /**\n+   * @return The minor version of the backend database server\n+   */\n+  public int getDatabaseMinorVersion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODQ3MTIx", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#pullrequestreview-419847121", "createdAt": "2020-05-28T07:32:28Z", "commit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzozMjoyOFrOGbpBaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzozMjoyOFrOGbpBaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzNjg0Mw==", "bodyText": "rename to databaseMetadata() - I'm wondering if that should not be directly on SqlClient", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#discussion_r431636843", "createdAt": "2020-05-28T07:32:28Z", "author": {"login": "vietj"}, "path": "vertx-sql-client/src/main/java/io/vertx/sqlclient/SqlConnection.java", "diffHunk": "@@ -88,5 +89,7 @@\n    * @param handler the completion handler\n    */\n   void close(Handler<AsyncResult<Void>> handler);\n+  \n+  DatabaseMetaData getDatabaseMetaData();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTcyMzQw", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#pullrequestreview-420172340", "createdAt": "2020-05-28T14:30:38Z", "commit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDozMDozOFrOGb35LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDozMDozOFrOGb35LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4MDQ5Mg==", "bodyText": "I think I need to rewrite the parser sometime later as it does not consider the situations of different database version semantics.", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#discussion_r431880492", "createdAt": "2020-05-28T14:30:38Z", "author": {"login": "BillyYccc"}, "path": "vertx-mysql-client/src/main/java/io/vertx/mysqlclient/impl/MySQLDatabaseMetaData.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package io.vertx.mysqlclient.impl;\n+\n+import io.vertx.sqlclient.spi.DatabaseMetaData;\n+\n+public class MySQLDatabaseMetaData implements DatabaseMetaData {\n+  \n+  private final int majorVersion;\n+  private final int minorVersion;\n+  private final int microVersion;\n+  \n+  public MySQLDatabaseMetaData(String serverVersion) {\n+    // we assume the server version follows ${major}.${minor}.${micro} in https://dev.mysql.com/doc/refman/8.0/en/which-version.html\n+    String[] versionNumbers = serverVersion.split(\"\\\\.\");\n+    majorVersion = Integer.parseInt(versionNumbers[0]);\n+    minorVersion = Integer.parseInt(versionNumbers[1]);\n+    // we should truncate the possible suffixes here\n+    String releaseVersion = versionNumbers[2];\n+    int indexOfFirstSeparator = releaseVersion.indexOf(\"-\");\n+    if (indexOfFirstSeparator != -1) {\n+      // handle unstable release suffixes\n+      String releaseNumberString = releaseVersion.substring(0, indexOfFirstSeparator);\n+      microVersion = Integer.parseInt(releaseNumberString);\n+    } else {\n+      microVersion = Integer.parseInt(versionNumbers[2]);\n+    }\n+  }\n+\n+  @Override\n+  public String getDatabaseProductName() {\n+    return \"MySQL\"; // TODO: Should this return MariaDB sometimes?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c671fe2ede20312b6217472b16e78cf40ca1a204", "author": {"user": {"login": "aguibert", "name": "Andrew Guibert"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/c671fe2ede20312b6217472b16e78cf40ca1a204", "committedDate": "2020-05-28T18:33:41Z", "message": "Initial database metadata API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "569eb4d2bd8e2bba656bcedd5b8aa959154c21d9", "author": {"user": {"login": "aguibert", "name": "Andrew Guibert"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/569eb4d2bd8e2bba656bcedd5b8aa959154c21d9", "committedDate": "2020-05-28T05:54:26Z", "message": "Initial database metadata API"}, "afterCommit": {"oid": "ea444bb3c932ad9bbddea59165781afba02be1d9", "author": {"user": {"login": "aguibert", "name": "Andrew Guibert"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/ea444bb3c932ad9bbddea59165781afba02be1d9", "committedDate": "2020-05-28T18:34:10Z", "message": "Handling for MariaDB versions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea444bb3c932ad9bbddea59165781afba02be1d9", "author": {"user": {"login": "aguibert", "name": "Andrew Guibert"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/ea444bb3c932ad9bbddea59165781afba02be1d9", "committedDate": "2020-05-28T18:34:10Z", "message": "Handling for MariaDB versions"}, "afterCommit": {"oid": "d9ffef6296cf2f758e7ce4d078ff163c693c8fb9", "author": {"user": {"login": "aguibert", "name": "Andrew Guibert"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/d9ffef6296cf2f758e7ce4d078ff163c693c8fb9", "committedDate": "2020-05-28T23:21:47Z", "message": "Handling for MariaDB versions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c56cb017496e700f8564a362f8b2b82f358d68da", "author": {"user": {"login": "aguibert", "name": "Andrew Guibert"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/c56cb017496e700f8564a362f8b2b82f358d68da", "committedDate": "2020-05-29T02:30:24Z", "message": "Handling for MariaDB versions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9ffef6296cf2f758e7ce4d078ff163c693c8fb9", "author": {"user": {"login": "aguibert", "name": "Andrew Guibert"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/d9ffef6296cf2f758e7ce4d078ff163c693c8fb9", "committedDate": "2020-05-28T23:21:47Z", "message": "Handling for MariaDB versions"}, "afterCommit": {"oid": "c56cb017496e700f8564a362f8b2b82f358d68da", "author": {"user": {"login": "aguibert", "name": "Andrew Guibert"}}, "url": "https://github.com/eclipse-vertx/vertx-sql-client/commit/c56cb017496e700f8564a362f8b2b82f358d68da", "committedDate": "2020-05-29T02:30:24Z", "message": "Handling for MariaDB versions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNzI2NTI2", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#pullrequestreview-420726526", "createdAt": "2020-05-29T07:48:55Z", "commit": {"oid": "c56cb017496e700f8564a362f8b2b82f358d68da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwODM3Mzcw", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#pullrequestreview-420837370", "createdAt": "2020-05-29T10:32:58Z", "commit": {"oid": "c56cb017496e700f8564a362f8b2b82f358d68da"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMDozMjo1OFrOGcXgnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMDozMjo1OFrOGcXgnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM5ODQ5Mg==", "bodyText": "There're a wide range of database servers supporting MySQL C/S protocol such as Percona, Vitess, TiDB... and their reponse version strings differ much. Don't worry about this, I will fix this in another PR since the version string is also used to control the EOF header flag setting in MySQL.", "url": "https://github.com/eclipse-vertx/vertx-sql-client/pull/665#discussion_r432398492", "createdAt": "2020-05-29T10:32:58Z", "author": {"login": "BillyYccc"}, "path": "vertx-mysql-client/src/main/java/io/vertx/mysqlclient/impl/MySQLDatabaseMetadata.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package io.vertx.mysqlclient.impl;\n+\n+import java.util.Objects;\n+\n+import io.vertx.sqlclient.spi.DatabaseMetadata;\n+\n+public class MySQLDatabaseMetadata implements DatabaseMetadata {\n+  \n+  private final String fullVersion;\n+  private final boolean isMariaDB;\n+  private final int majorVersion;\n+  private final int minorVersion;\n+  private final int microVersion;\n+  \n+  public MySQLDatabaseMetadata(String serverVersion) {\n+    fullVersion = serverVersion;\n+    isMariaDB = serverVersion.toUpperCase().contains(\"MARIADB\");  \n+    String[] versionNumbers;\n+    if (!isMariaDB) {\n+      // we assume the server version follows ${major}.${minor}.${micro} in https://dev.mysql.com/doc/refman/8.0/en/which-version.html\n+      versionNumbers = serverVersion.split(\"\\\\.\");\n+    } else {\n+      // server version follows ${junk}-${major}.${minor}.${micro}-MariaDB-${junk}\n+      String[] parts = serverVersion.split(\"-\");\n+      versionNumbers = parts[1].split(\"\\\\.\");\n+    }\n+    majorVersion = Integer.parseInt(versionNumbers[0]);\n+    minorVersion = Integer.parseInt(versionNumbers[1]);\n+    // we should truncate the possible suffixes here\n+    String releaseVersion = versionNumbers[2];\n+    int indexOfFirstSeparator = releaseVersion.indexOf(\"-\");\n+    if (indexOfFirstSeparator != -1) {\n+      // handle unstable release suffixes\n+      String releaseNumberString = releaseVersion.substring(0, indexOfFirstSeparator);\n+      microVersion = Integer.parseInt(releaseNumberString);\n+    } else {\n+      microVersion = Integer.parseInt(versionNumbers[2]);\n+    }\n+  }\n+  \n+  public boolean isMariaDB() {\n+    return isMariaDB;\n+  }\n+\n+  @Override\n+  public String productName() {\n+    return isMariaDB ? \"MariaDB\" : \"MySQL\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c56cb017496e700f8564a362f8b2b82f358d68da"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1495, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}