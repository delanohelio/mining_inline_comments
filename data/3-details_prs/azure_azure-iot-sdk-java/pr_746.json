{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0OTUyOTI1", "number": 746, "title": "refactor(prov-dev, deps): Add better logging to provisioning device client", "bodyText": "Also fixing an issue where provisioning device client didn't propagate up the error code if an http exception was returned from service\nAlso fixing a bug where if the provisioning device client ignored amqp messages getting rejected from service. Now the sdk responds and throws appropriately", "createdAt": "2020-03-27T20:20:55Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746", "merged": true, "mergeCommit": {"oid": "64ca3e13eda9575f5e762a2c017f6e735dd0bf49"}, "closed": true, "closedAt": "2020-03-30T19:54:27Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcR34AkgBqjMxNzQxOTk0Nzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSycycgH2gAyMzk0OTUyOTI1OjM5YzhiOTkzZmIzMzBhNWM5MmEwZDQ5OTRhNzNiMWZkYmVhYzhhZTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b05f0d5f8ed7c41dd3d8a05207a60e0dc223fab", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/2b05f0d5f8ed7c41dd3d8a05207a60e0dc223fab", "committedDate": "2020-03-27T20:20:26Z", "message": "refactor(prov-dev, deps): Add better logging to provisioning device client\n\nAlso fixing an issue where provisioning device client didn't propagate up the error code if an http exception was returned from service\n\nAlso fixing a bug where if the provisioning device client ignored amqp messages getting rejected from service. Now the sdk responds and throws appropriately"}, "afterCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/ff2bae9c7f6835545cfa4e0037437da66421c7bc", "committedDate": "2020-03-27T21:48:36Z", "message": "refactor(prov-dev, deps): Add better logging to provisioning device client\n\nAlso fixing an issue where provisioning device client didn't propagate up the error code if an http exception was returned from service\n\nAlso fixing a bug where if the provisioning device client ignored amqp messages getting rejected from service. Now the sdk responds and throws appropriately"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjIxMDc0", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#pullrequestreview-383221074", "createdAt": "2020-03-27T21:53:08Z", "commit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMTo1MzowOVrOF9C7Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMTo1MzowOVrOF9C7Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU1NTM5NA==", "bodyText": "Previously, we ignored if our sent message was accepted or not. Now we fire a callback up to the listener to notify it if any message that was sent was rejected/abandoned/released/etc by the service so that it can stop waiting and propagate up the exception to the user", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#discussion_r399555394", "createdAt": "2020-03-27T21:53:09Z", "author": {"login": "timtay-microsoft"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/AmqpsConnection.java", "diffHunk": "@@ -494,31 +463,45 @@ public boolean sendAmqpMessage(AmqpMessage message) throws Exception\n     @Override\n     public void onDelivery(Event event)\n     {\n-        logger.LogDebug(\"Entered in method %s\", logger.getMethodName());\n+        Link link = event.getLink();\n \n-        AmqpMessage message = amqpDeviceOperations.receiverMessageFromLink(event.getLink().getName());\n-        if (message == null)\n+        if (link instanceof Sender)\n         {\n-            //Sender specific section for dispositions it receives\n-            if (event.getType() == Event.Type.DELIVERY)\n+            // Codes_SRS_AMQPSIOTHUBCONNECTION_15_038: [If this link is the Sender link and the event type is DELIVERY, the event handler shall get the Delivery (Proton) object from the event.]\n+            Delivery d = event.getDelivery();\n+            DeliveryState remoteState = d.getRemoteState();\n+\n+            // Codes_SRS_AMQPSIOTHUBCONNECTION_15_039: [The event handler shall note the remote delivery state and use it and the Delivery (Proton) hash code to inform the AmqpsIotHubConnection of the message receipt.]\n+            boolean messageAcknowledgedAsSuccess = remoteState.equals(Accepted.getInstance());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "originalPosition": 374}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjIxOTI0", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#pullrequestreview-383221924", "createdAt": "2020-03-27T21:55:09Z", "commit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMTo1NTowOVrOF9C-JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMTo1NTowOVrOF9C-JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU1NjEzMg==", "bodyText": "There is no reason for us to parse the error message considering it will just be a string to the exception we give it to. Parsing this error message may even filter out important information from the service, so we're better off just giving the full error payload string to the user", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#discussion_r399556132", "createdAt": "2020-03-27T21:55:09Z", "author": {"login": "timtay-microsoft"}, "path": "provisioning/provisioning-device-client/src/main/java/com/microsoft/azure/sdk/iot/provisioning/device/internal/exceptions/ProvisioningDeviceClientExceptionManager.java", "diffHunk": "@@ -18,38 +18,30 @@ public static void verifyHttpResponse(HttpResponse httpResponse) throws Provisio\n     {\n         int responseStatus = httpResponse.getStatus();\n \n-        String errorMessage = ErrorMessageParser.bestErrorMessage(new String(httpResponse.getErrorReason(), StandardCharsets.UTF_8));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjIyMTE4", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#pullrequestreview-383222118", "createdAt": "2020-03-27T21:55:38Z", "commit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMTo1NTozOFrOF9C-uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMTo1NTozOFrOF9C-uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU1NjI4MA==", "bodyText": "Previously, we didn't include the status code in this error message, but we should as it helps debug customer issues", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#discussion_r399556280", "createdAt": "2020-03-27T21:55:38Z", "author": {"login": "timtay-microsoft"}, "path": "provisioning/provisioning-device-client/src/main/java/com/microsoft/azure/sdk/iot/provisioning/device/internal/exceptions/ProvisioningDeviceClientExceptionManager.java", "diffHunk": "@@ -18,38 +18,30 @@ public static void verifyHttpResponse(HttpResponse httpResponse) throws Provisio\n     {\n         int responseStatus = httpResponse.getStatus();\n \n-        String errorMessage = ErrorMessageParser.bestErrorMessage(new String(httpResponse.getErrorReason(), StandardCharsets.UTF_8));\n+        byte[] errorReason = httpResponse.getErrorReason();\n+\n+        String errorMessage = httpResponse.getStatus() + \" : \" + new String(errorReason, StandardCharsets.UTF_8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjIyMzUy", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#pullrequestreview-383222352", "createdAt": "2020-03-27T21:56:08Z", "commit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMTo1NjowOFrOF9C_aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMTo1NjowOFrOF9C_aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU1NjQ1Nw==", "bodyText": "This was a strange switch case where almost all cases did the exact same thing. Just using a fall through to simplify it a bit", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#discussion_r399556457", "createdAt": "2020-03-27T21:56:08Z", "author": {"login": "timtay-microsoft"}, "path": "provisioning/provisioning-device-client/src/main/java/com/microsoft/azure/sdk/iot/provisioning/device/internal/exceptions/ProvisioningDeviceClientExceptionManager.java", "diffHunk": "@@ -18,38 +18,30 @@ public static void verifyHttpResponse(HttpResponse httpResponse) throws Provisio\n     {\n         int responseStatus = httpResponse.getStatus();\n \n-        String errorMessage = ErrorMessageParser.bestErrorMessage(new String(httpResponse.getErrorReason(), StandardCharsets.UTF_8));\n+        byte[] errorReason = httpResponse.getErrorReason();\n+\n+        String errorMessage = httpResponse.getStatus() + \" : \" + new String(errorReason, StandardCharsets.UTF_8);\n \n         switch (responseStatus)\n         {\n             case 400:\n-                throw new ProvisioningDeviceHubException(errorMessage);\n             case 401:\n-                throw new ProvisioningDeviceHubException(errorMessage);\n             case 403:\n-                throw new ProvisioningDeviceHubException(errorMessage);\n             case 404:\n-                throw new ProvisioningDeviceHubException(errorMessage);\n             case 412:\n-                throw new ProvisioningDeviceHubException(errorMessage);\n             case 429:\n-                throw new ProvisioningDeviceHubException(errorMessage);\n             case 500:\n-                throw new ProvisioningDeviceHubException(errorMessage);\n             case 502:\n-                throw new ProvisioningDeviceHubException(errorMessage);\n             case 503:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjUwMzMz", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#pullrequestreview-383250333", "createdAt": "2020-03-27T23:25:52Z", "commit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMzoyNTo1MlrOF9Efpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzozMToxN1rOF9c3ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4MTA5NA==", "bodyText": "Is this to prevent re-wrapping the IOException inside another IOException?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#discussion_r399581094", "createdAt": "2020-03-27T23:25:52Z", "author": {"login": "abhipsaMisra"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/AmqpsConnection.java", "diffHunk": "@@ -95,24 +94,16 @@ public AmqpsConnection(String hostName, AmqpDeviceOperations amqpDeviceOperation\n         this.closeLock  = new ObjectLock();\n \n         this.sslContext = sslContext;\n-        this.isOpen  = false;\n+        this.isOpen = false;\n         this.fullHostAddress = String.format(\"%s:%d\", hostName, this.useWebSockets ? AMQP_WEB_SOCKET_PORT : AMQP_PORT );\n         this.hostName = hostName;\n \n         add(new Handshaker());\n         add(new FlowController());\n \n-        try\n-        {\n-            ReactorOptions options = new ReactorOptions();\n-            options.setEnableSaslByDefault(false);\n-            reactor = Proton.reactor(options, this);\n-        }\n-        catch (IOException e)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4Mjg2NA==", "bodyText": "Wouldn't onConnectionInit() be a better place for this check?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#discussion_r399582864", "createdAt": "2020-03-27T23:33:38Z", "author": {"login": "abhipsaMisra"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/AmqpsConnection.java", "diffHunk": "@@ -139,6 +130,11 @@ public boolean isConnected() throws Exception\n             throw this.saslListener.getSavedException();\n         }\n \n+        if (this.protonJExceptionParser != null && this.protonJExceptionParser.getError() != null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4MzcwOQ==", "bodyText": "method name is not passed to the logger.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#discussion_r399583709", "createdAt": "2020-03-27T23:37:37Z", "author": {"login": "abhipsaMisra"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/AmqpsConnection.java", "diffHunk": "@@ -168,18 +165,23 @@ public void open() throws IOException\n             }\n             catch (InterruptedException e)\n             {\n-                logger.LogError(e);\n+                String errorMessage = \"Amqp connection was interrupted while opening.\";\n+                log.error(errorMessage, e);\n                 this.close();\n-                throw new IOException(\"Waited too long for the connection to open.\");\n+                throw new IOException(errorMessage, e);\n             }\n         }\n+        else\n+        {\n+            log.trace(\"Open called while amqp connection was already open\");\n+        }\n \n         if (!this.isOpen)\n         {\n-            throw new IOException(\"Failed to open the connection\");\n+            throw new IOException(\"Timed out  to open the amqp connection\");\n         }\n \n-        logger.LogDebug(\"Exited from method %s\", logger.getMethodName());\n+        log.debug(\"Exited from method %s\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4NDQ1OQ==", "bodyText": "Should we be swallowing these exceptions? Is this retried?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#discussion_r399584459", "createdAt": "2020-03-27T23:41:12Z", "author": {"login": "abhipsaMisra"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/AmqpsConnection.java", "diffHunk": "@@ -315,16 +307,15 @@ public void onConnectionInit(Event event)\n         }\n         catch (Exception e)\n         {\n-            logger.LogDebug(\"openLinks has thrown exception: %s\", e.getMessage());\n+            log.error(\"Encountered an exception while opening amqp links\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "originalPosition": 218}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU4NDYyMA==", "bodyText": "Same, should we silently swallow these exceptions?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#discussion_r399584620", "createdAt": "2020-03-27T23:41:59Z", "author": {"login": "abhipsaMisra"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/AmqpsConnection.java", "diffHunk": "@@ -383,17 +365,15 @@ public void onConnectionUnbound(Event event)\n     @Override\n     public void onLinkInit(Event event)\n     {\n-        logger.LogDebug(\"Entered in method %s\", logger.getMethodName());\n         try\n         {\n             Link link = event.getLink();\n             amqpDeviceOperations.initLink(link);\n         }\n         catch (Exception e)\n         {\n-            logger.LogDebug(\"Exception in onLinkInit: %s\", e.getMessage());\n+            log.error(\"Amqp exception encountered during onLinkInit\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "originalPosition": 294}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk3ODcxMA==", "bodyText": "q - what does sendStatusMessage do? when/ how is it triggered?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#discussion_r399978710", "createdAt": "2020-03-30T07:28:02Z", "author": {"login": "abhipsaMisra"}, "path": "provisioning/provisioning-device-client/src/main/java/com/microsoft/azure/sdk/iot/provisioning/device/internal/contract/amqp/ProvisioningAmqpOperations.java", "diffHunk": "@@ -226,12 +227,18 @@ public void sendStatusMessage(String operationId, ResponseCallback responseCallb\n             {\n                 this.receiveLock.waitLock(MAX_WAIT_TO_SEND_MSG);\n             }\n+\n+            if (this.messageSendFailedExceptionMessage != null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4MDQyNg==", "bodyText": "so we were propagating the exception message before and now we are propagating the http error response? what was the exception message before?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/746#discussion_r399980426", "createdAt": "2020-03-30T07:31:17Z", "author": {"login": "abhipsaMisra"}, "path": "provisioning/provisioning-device-client/src/main/java/com/microsoft/azure/sdk/iot/provisioning/device/internal/contract/http/ContractAPIHttp.java", "diffHunk": "@@ -211,7 +217,8 @@ public synchronized void requestNonceForTPM(RequestData requestData, ResponseCal\n                 //SRS_ContractAPIHttp_25_008: [If service return a status as 404 then this method shall trigger the callback to the user with the response message.]\n                 if (httpResponse.getStatus() == ACCEPTABLE_NONCE_HTTP_STATUS)\n                 {\n-                    TpmRegistrationResultParser registerResponseTPMParser = TpmRegistrationResultParser.createFromJson(new String(e.getMessage()));\n+                    String tpmRegistrationResultJson = new String(httpResponse.getErrorReason(), StandardCharsets.UTF_8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2bae9c7f6835545cfa4e0037437da66421c7bc"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fc4c8be02428ed51a3d7efb71161c0cc994d8b3", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/0fc4c8be02428ed51a3d7efb71161c0cc994d8b3", "committedDate": "2020-03-30T17:53:13Z", "message": "refactor(prov-dev, deps): Add better logging to provisioning device client\n\nAlso fixing an issue where provisioning device client didn't propagate up the error code if an http exception was returned from service\n\nAlso fixing a bug where if the provisioning device client ignored amqp messages getting rejected from service. Now the sdk responds and throws appropriately"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f63dbbba391944bfaa160aba7bcf443f414abb90", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/f63dbbba391944bfaa160aba7bcf443f414abb90", "committedDate": "2020-03-30T17:52:38Z", "message": "squash"}, "afterCommit": {"oid": "0fc4c8be02428ed51a3d7efb71161c0cc994d8b3", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/0fc4c8be02428ed51a3d7efb71161c0cc994d8b3", "committedDate": "2020-03-30T17:53:13Z", "message": "refactor(prov-dev, deps): Add better logging to provisioning device client\n\nAlso fixing an issue where provisioning device client didn't propagate up the error code if an http exception was returned from service\n\nAlso fixing a bug where if the provisioning device client ignored amqp messages getting rejected from service. Now the sdk responds and throws appropriately"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39c8b993fb330a5c92a0d4994a73b1fdbeac8ae9", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/39c8b993fb330a5c92a0d4994a73b1fdbeac8ae9", "committedDate": "2020-03-30T18:03:25Z", "message": "squash"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1834, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}