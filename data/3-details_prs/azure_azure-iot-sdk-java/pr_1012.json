{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMTU5NDgz", "number": 1012, "title": "fix(iot-dev): Fix possible NPE in AMQP layer", "bodyText": "Sending a get twin request while the subscribe to desired properties request was in progress seemed to cause reliable NPE in transport clients that start twin for each of their devices. By waiting for the in progress subscriptions to finish before sending actual messages over these links, the NPE goes away. The NPE itself comes from within the AMQP library, so my best guess is that there is a race condition of some sort that we would hit previously\nAlso simplify some code in our executor service cleanup logic to match what we checked into preview earlier.", "createdAt": "2020-12-03T22:29:33Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1012", "merged": true, "mergeCommit": {"oid": "7deebc330426b42b09925900ed5772a754631e70"}, "closed": true, "closedAt": "2020-12-04T02:55:31Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiq5ZdAH2gAyNTMyMTU5NDgzOmRhYzdiMTI3OTJlNDE4NjczNTQ5ZjdmMWE0ZGJhN2RlMjcwMGFmODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdir1HuAFqTU0NDU0OTE4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dac7b12792e418673549f7f1a4dba7de2700af86", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/dac7b12792e418673549f7f1a4dba7de2700af86", "committedDate": "2020-12-03T22:29:22Z", "message": "fix(iot-dev): Fix possible NPE in AMQP layer\n\nSending a get twin request while the subscribe to desired properties request was in progress seemed to cause reliable NPE in transport clients that start twin for each of their devices. By waiting for the in progress subscriptions to finish before sending actual messages over these links, the NPE goes away."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7fadac092f09359b7aa9d005fbf69893aa3db6b", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/e7fadac092f09359b7aa9d005fbf69893aa3db6b", "committedDate": "2020-12-03T22:33:03Z", "message": "refactor(iot-dev): Simplify AMQP executor service cleanup, remove chance for InterruptedException\n\nThere is no reason for the AMQP layer to wait for the executor service to shutdown beyond calling shutdownNow(), so this commit removes all the superfluous logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTI2Nzg5", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1012#pullrequestreview-544526789", "createdAt": "2020-12-03T22:48:37Z", "commit": {"oid": "e7fadac092f09359b7aa9d005fbf69893aa3db6b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjo0ODozN1rOH-4ooA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjo0ODozN1rOH-4ooA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcwMTY2NA==", "bodyText": "it looks like we were trying really hard to make sure the executorService gets terminated before nulling it out.\nWhat are the consequences of not waiting for these anymore?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1012#discussion_r535701664", "createdAt": "2020-12-03T22:48:37Z", "author": {"login": "azabbasi"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -740,35 +740,13 @@ else if (this.connection.getLocalState() == EndpointState.CLOSED && this.connect\n         }\n     }\n \n-    private void executorServicesCleanup() throws TransportException\n+    private void executorServicesCleanup()\n     {\n         if (this.executorService != null)\n         {\n             log.trace(\"Shutdown of executor service has started\");\n-            this.executorService.shutdown();\n-            try\n-            {\n-                // Wait a while for existing tasks to terminate\n-                if (!this.executorService.awaitTermination(MAX_WAIT_TO_TERMINATE_EXECUTOR, TimeUnit.SECONDS))\n-                {\n-                    this.executorService.shutdownNow(); // Cancel currently executing tasks\n-                    // Wait a while for tasks to respond to being cancelled\n-                    if (!this.executorService.awaitTermination(MAX_WAIT_TO_TERMINATE_EXECUTOR, TimeUnit.SECONDS))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7fadac092f09359b7aa9d005fbf69893aa3db6b"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e27d70bfbe9aec90401237651b89367e5a3c9ac", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/0e27d70bfbe9aec90401237651b89367e5a3c9ac", "committedDate": "2020-12-03T22:57:46Z", "message": "fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTQwMDA4", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1012#pullrequestreview-544540008", "createdAt": "2020-12-03T23:14:00Z", "commit": {"oid": "0e27d70bfbe9aec90401237651b89367e5a3c9ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "500b68fdf18f5eef263c19fdc4e8f317a2ca10c1", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/500b68fdf18f5eef263c19fdc4e8f317a2ca10c1", "committedDate": "2020-12-03T23:18:20Z", "message": "fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTQ5MTIw", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1012#pullrequestreview-544549120", "createdAt": "2020-12-03T23:34:29Z", "commit": {"oid": "500b68fdf18f5eef263c19fdc4e8f317a2ca10c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzozNDoyOVrOH-6B_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzozNDoyOVrOH-6B_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNDU0MA==", "bodyText": "Q - from where will this message be retried?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1012#discussion_r535724540", "createdAt": "2020-12-03T23:34:29Z", "author": {"login": "abhipsaMisra"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionHandler.java", "diffHunk": "@@ -355,6 +355,26 @@ else if (subscriptionType == DEVICE_OPERATION_TWIN_SUBSCRIBE_DESIRED_PROPERTIES_\n                         || senderLinkHandler instanceof AmqpsTwinSenderLinkHandler && messageType == DEVICE_TWIN\n                         || senderLinkHandler instanceof AmqpsMethodsSenderLinkHandler && messageType == DEVICE_METHODS)\n                 {\n+                    if (messageType == DEVICE_TWIN)\n+                    {\n+                        if (explicitInProgressTwinSubscriptionMessage != null)\n+                        {\n+                            // Don't send any twin messages while a twin subscription is in progress. Wait until the subscription\n+                            // has been acknowledged by the service before sending it.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "500b68fdf18f5eef263c19fdc4e8f317a2ca10c1"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTQ5MTgz", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1012#pullrequestreview-544549183", "createdAt": "2020-12-03T23:34:36Z", "commit": {"oid": "500b68fdf18f5eef263c19fdc4e8f317a2ca10c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1517, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}