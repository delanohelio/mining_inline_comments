{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MzEyMTM1", "number": 1021, "title": "fix(iot-dev): fix issue where AMQP layer sometimes throws \"uncorrelated channel\" NPE", "bodyText": "Closing a session locally before the session was opened remotely causes a NPE to throw from proton with error message \"uncorrelated channel: X\", so this will fix our session handlers to not close locally before the session has been opened remotely\nThe relevant proton code can be seen here.\nNote that the proton function in question is a handler function for \"session begin\" frames sent by the service", "createdAt": "2020-12-09T16:42:16Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021", "merged": true, "mergeCommit": {"oid": "26ed3707f881fa381278b1c4abcfe46411681453"}, "closed": true, "closedAt": "2020-12-09T19:00:37Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkhguLgH2gAyNTM1MzEyMTM1OmZjMzE4YTNkNzc5NWViOTYwZjFkZmM0OGIwZjRhZTI3ZTFiNTRjOGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkiJKEgH2gAyNTM1MzEyMTM1OjlmYzFlY2YxMGE4ZGMzMjU0NDEzZWRjMmU1OGE5NGI5NDg2MDE1MTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc318a3d7795eb960f1dfc48b0f4ae27e1b54c8a", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/fc318a3d7795eb960f1dfc48b0f4ae27e1b54c8a", "committedDate": "2020-12-09T16:41:07Z", "message": "fix(iot-dev): fix issue where AMQP layer sometimes throws \"uncorrelated\nchannel\" NPE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4Mzg4NTc0", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#pullrequestreview-548388574", "createdAt": "2020-12-09T16:50:48Z", "commit": {"oid": "fc318a3d7795eb960f1dfc48b0f4ae27e1b54c8a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjo1MDo0OFrOICe1pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjo1MDo0OFrOICe1pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3MzMxOQ==", "bodyText": "Is this ever being set to true somewhere or is this for the future?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#discussion_r539473319", "createdAt": "2020-12-09T16:50:48Z", "author": {"login": "jamdavi"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionHandler.java", "diffHunk": "@@ -80,13 +80,35 @@ public void setSession(Session session)\n         this.twinReceiverLinkOpened = false;\n         this.methodsSenderLinkOpened = false;\n         this.methodsReceiverLinkOpened = false;\n+        this.sessionOpenedRemotely = false;\n+        this.sessionHandlerClosedBeforeRemoteSessionOpened = false;\n     }\n \n     public void closeSession()\n     {\n         if (this.session != null)\n         {\n-            this.session.close();\n+            if (this.sessionOpenedRemotely)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc318a3d7795eb960f1dfc48b0f4ae27e1b54c8a"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e75bcfeb0ca3b3dc608bab639627b560432c975f", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/e75bcfeb0ca3b3dc608bab639627b560432c975f", "committedDate": "2020-12-09T16:53:54Z", "message": "fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4Mzk5Njk5", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#pullrequestreview-548399699", "createdAt": "2020-12-09T17:02:02Z", "commit": {"oid": "e75bcfeb0ca3b3dc608bab639627b560432c975f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNzowMjowMlrOICfZiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNzowMjowMlrOICfZiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4MjUwNw==", "bodyText": "Since we're intentionally closing this session but not opening a new one in this method we should definitely log it as an error/warning.\nDo we want session.close() to throw here ?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#discussion_r539482507", "createdAt": "2020-12-09T17:02:02Z", "author": {"login": "jamdavi"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionHandler.java", "diffHunk": "@@ -105,7 +127,12 @@ public void onSessionFinal(Event e)\n     public void onSessionRemoteOpen(Event e)\n     {\n         log.trace(\"Device session opened remotely for device {}\", this.getDeviceId());\n-        if (this.deviceClientConfig.getAuthenticationType() == DeviceClientConfig.AuthType.X509_CERTIFICATE)\n+        this.sessionOpenedRemotely = true;\n+        if (this.sessionHandlerClosedBeforeRemoteSessionOpened)\n+        {\n+            this.session.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e75bcfeb0ca3b3dc608bab639627b560432c975f"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NDE1MTcz", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#pullrequestreview-548415173", "createdAt": "2020-12-09T17:18:48Z", "commit": {"oid": "e75bcfeb0ca3b3dc608bab639627b560432c975f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fc1ecf10a8dc3254413edc2e58a94b948601513", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/9fc1ecf10a8dc3254413edc2e58a94b948601513", "committedDate": "2020-12-09T17:25:17Z", "message": "fixup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1526, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}