{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0ODY2NzQx", "number": 888, "title": "fix(iot-dev): Fix issue where amqp layer ignored delivery state of sent messages", "bodyText": "fixes issue #887\nIf the delivery state was anything other than Accepted, the SDK needs to either retry sending the message or bubble up that exception to the user", "createdAt": "2020-08-07T22:59:06Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888", "merged": true, "mergeCommit": {"oid": "040d3cee982def4e67c37a4c9eeeaaafb761797e"}, "closed": true, "closedAt": "2020-08-13T18:16:59Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8slY6AH2gAyNDY0ODY2NzQxOjUzZmVjMTFhMDQ4MjAyNzY0YmQxNzQ3NzcwM2JhZmUwN2U4OTQ5MmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-kGaBAFqTQ2NzAxNTQ5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "53fec11a048202764bd17477703bafe07e89492b", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/53fec11a048202764bd17477703bafe07e89492b", "committedDate": "2020-08-07T22:58:12Z", "message": "fix(iot-dev): Fix issue where amqp layer ignored delivery state of sent messages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNjgwMTUx", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#pullrequestreview-463680151", "createdAt": "2020-08-07T23:00:49Z", "commit": {"oid": "53fec11a048202764bd17477703bafe07e89492b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMzowMDo0OVrOG9q-IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMzowMDo0OVrOG9q-IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMyMDM1Mw==", "bodyText": "The exception translator above does the hard work of figuring out if the message can be retried or not", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r467320353", "createdAt": "2020-08-07T23:00:49Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -468,9 +470,29 @@ public void onAuthenticationSessionOpened()\n     }\n \n     @Override\n-    public void onMessageAcknowledged(Message message)\n+    public void onMessageAcknowledged(Message message, DeliveryState deliveryState)\n     {\n-        this.listener.onMessageSent(message, null);\n+        if (deliveryState == Accepted.getInstance())\n+        {\n+            this.listener.onMessageSent(message, null);\n+        }\n+        else if (deliveryState instanceof Rejected)\n+        {\n+            // The message was not accepted by the server, and the reason why is found within the nested error\n+            TransportException ex = AmqpsExceptionTranslator.convertFromAmqpException(((Rejected) deliveryState).getError());\n+            this.listener.onMessageSent(message, ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53fec11a048202764bd17477703bafe07e89492b"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c49f24de70b07333a84e72c4291f5877d82157e0", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c49f24de70b07333a84e72c4291f5877d82157e0", "committedDate": "2020-08-13T16:01:43Z", "message": "Merge branch 'master' into timtay/amqpDeliveryState"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2OTYwMTE1", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#pullrequestreview-466960115", "createdAt": "2020-08-13T17:02:24Z", "commit": {"oid": "c49f24de70b07333a84e72c4291f5877d82157e0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNzowMjoyNVrOHAUZ4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNzowMjoyNVrOHAUZ4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA5NjM1Mg==", "bodyText": "Does the service ever send a delivery state of \"released\"? What do they expect the client to do, in this case?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r470096352", "createdAt": "2020-08-13T17:02:25Z", "author": {"login": "abhipsaMisra"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -468,9 +470,29 @@ public void onAuthenticationSessionOpened()\n     }\n \n     @Override\n-    public void onMessageAcknowledged(Message message)\n+    public void onMessageAcknowledged(Message message, DeliveryState deliveryState)\n     {\n-        this.listener.onMessageSent(message, null);\n+        if (deliveryState == Accepted.getInstance())\n+        {\n+            this.listener.onMessageSent(message, null);\n+        }\n+        else if (deliveryState instanceof Rejected)\n+        {\n+            // The message was not accepted by the server, and the reason why is found within the nested error\n+            TransportException ex = AmqpsExceptionTranslator.convertFromAmqpException(((Rejected) deliveryState).getError());\n+            this.listener.onMessageSent(message, ex);\n+        }\n+        else if (deliveryState == Released.getInstance())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c49f24de70b07333a84e72c4291f5877d82157e0"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDEzMzU0", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#pullrequestreview-467013354", "createdAt": "2020-08-13T18:09:56Z", "commit": {"oid": "c49f24de70b07333a84e72c4291f5877d82157e0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODowOTo1N1rOHAXuAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODowOTo1N1rOHAXuAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE1MDY1OQ==", "bodyText": "why is the check for rejected look different than the other delivery states?\nShouldn't it be\ndeliveryState == Rejected.getInstance() ?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r470150659", "createdAt": "2020-08-13T18:09:57Z", "author": {"login": "azabbasi"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -468,9 +470,29 @@ public void onAuthenticationSessionOpened()\n     }\n \n     @Override\n-    public void onMessageAcknowledged(Message message)\n+    public void onMessageAcknowledged(Message message, DeliveryState deliveryState)\n     {\n-        this.listener.onMessageSent(message, null);\n+        if (deliveryState == Accepted.getInstance())\n+        {\n+            this.listener.onMessageSent(message, null);\n+        }\n+        else if (deliveryState instanceof Rejected)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c49f24de70b07333a84e72c4291f5877d82157e0"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDE0OTUz", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#pullrequestreview-467014953", "createdAt": "2020-08-13T18:12:13Z", "commit": {"oid": "c49f24de70b07333a84e72c4291f5877d82157e0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODoxMjoxM1rOHAXzAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODoxMjoxM1rOHAXzAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE1MTkzOA==", "bodyText": "There are at least 4 more delivery state types that are defined in the transport layer that will fall into the else statement here, can you point me to the service documentation that indicates what delivery states they may return? I am just curious.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#discussion_r470151938", "createdAt": "2020-08-13T18:12:13Z", "author": {"login": "azabbasi"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -468,9 +470,29 @@ public void onAuthenticationSessionOpened()\n     }\n \n     @Override\n-    public void onMessageAcknowledged(Message message)\n+    public void onMessageAcknowledged(Message message, DeliveryState deliveryState)\n     {\n-        this.listener.onMessageSent(message, null);\n+        if (deliveryState == Accepted.getInstance())\n+        {\n+            this.listener.onMessageSent(message, null);\n+        }\n+        else if (deliveryState instanceof Rejected)\n+        {\n+            // The message was not accepted by the server, and the reason why is found within the nested error\n+            TransportException ex = AmqpsExceptionTranslator.convertFromAmqpException(((Rejected) deliveryState).getError());\n+            this.listener.onMessageSent(message, ex);\n+        }\n+        else if (deliveryState == Released.getInstance())\n+        {\n+            // As per AMQP spec, this state means the message should be re-delivered to the server at a later time\n+            ProtocolException protocolException = new ProtocolException(\"Message was released by the amqp server\");\n+            protocolException.setRetryable(true);\n+            this.listener.onMessageSent(message, protocolException);\n+        }\n+        else", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c49f24de70b07333a84e72c4291f5877d82157e0"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDE1NDk2", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/888#pullrequestreview-467015496", "createdAt": "2020-08-13T18:12:58Z", "commit": {"oid": "c49f24de70b07333a84e72c4291f5877d82157e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1536, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}