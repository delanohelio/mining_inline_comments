{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNzg2Mzg5", "number": 743, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTozODozMlrODraKnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTo0NDoxNFrODraRZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODQ0MDYxOnYy", "diffSide": "RIGHT", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttIotHubConnection.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTozODozMlrOF7vW_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTozODozMlrOF7vW_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4NjIzNw==", "bodyText": "URIUtil encodePath handles spaces correctly for our purposes, whereas URLEncoder did not, hence the switch", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398186237", "createdAt": "2020-03-25T21:38:32Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttIotHubConnection.java", "diffHunk": "@@ -138,10 +140,8 @@ else if (this.config.getAuthenticationType() == DeviceClientConfig.AuthType.X509\n                     this.iotHubUserPassword = null;\n                 }\n \n-                //URLEncoder follows HTML spec for encoding urls, which includes substituting space characters with '+'\n-                // We want \"%20\" for spaces, not '+', however, so replace them manually after utf-8 encoding\n                 String userAgentString = this.config.getProductInfo().getUserAgentString();\n-                String clientUserAgentIdentifier = \"DeviceClientType=\" + URLEncoder.encode(userAgentString, \"UTF-8\").replaceAll(\"\\\\+\", \"%20\");\n+                String clientUserAgentIdentifier = \"DeviceClientType=\" + URIUtil.encodePath(userAgentString, StandardCharsets.UTF_8.name());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODQ0MzUxOnYy", "diffSide": "RIGHT", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTozOToyM1rOF7vYsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTozOToyM1rOF7vYsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4NjY3NQ==", "bodyText": "We weren't encoding the application property keys, which could be an issue. If a customer gives us a key with odd characters in it, we need to encode in order to keep the mqtt topic string valid", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398186675", "createdAt": "2020-03-25T21:39:23Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "diffHunk": "@@ -152,18 +154,18 @@ private boolean appendPropertyIfPresent(StringBuilder stringBuilder, boolean sep\n                     stringBuilder.append(MESSAGE_PROPERTY_SEPARATOR);\n                 }\n \n-                stringBuilder.append(propertyKey);\n+                stringBuilder.append(URIUtil.encodePath(propertyKey, StandardCharsets.UTF_8.name()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODQ0Mzg1OnYy", "diffSide": "RIGHT", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/MessageProperty.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTozOTozMlrOF7vY7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMjoxMDozOVrOF7wR1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4NjczNA==", "bodyText": "Is this a final set of characters? where did you get them from? is it defined somewhere? can we have a link as a comment?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398186734", "createdAt": "2020-03-25T21:39:32Z", "author": {"login": "azabbasi"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/MessageProperty.java", "diffHunk": "@@ -31,6 +31,11 @@\n     public static final String IOTHUB_SECURITY_INTERFACE_ID = \"iothub-interface-id\";\n     public static final String IOTHUB_SECURITY_INTERFACE_ID_VALUE = \"urn:azureiot:Security:SecurityAgent:1\";\n \n+    //Note this list includes the characters for tab and space.\n+    private static final String BANNED_NON_ALPHANUMERIC_CHARACTERS = \"()<>@,;:\\\"/[]?={} \\t\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIwMTMwMQ==", "bodyText": "I got this requirement from our own documentation here: https://azure.github.io/azure-iot-sdk-java/device/com/microsoft/azure/iothub/MessageProperty.html", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398201301", "createdAt": "2020-03-25T22:10:39Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/MessageProperty.java", "diffHunk": "@@ -31,6 +31,11 @@\n     public static final String IOTHUB_SECURITY_INTERFACE_ID = \"iothub-interface-id\";\n     public static final String IOTHUB_SECURITY_INTERFACE_ID_VALUE = \"urn:azureiot:Security:SecurityAgent:1\";\n \n+    //Note this list includes the characters for tab and space.\n+    private static final String BANNED_NON_ALPHANUMERIC_CHARACTERS = \"()<>@,;:\\\"/[]?={} \\t\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4NjczNA=="}, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODQ0NTIzOnYy", "diffSide": "LEFT", "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/MessagePropertyTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTozOTo1OFrOF7vZzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTozOTo1OFrOF7vZzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4Njk1Nw==", "bodyText": "These tests were incorrect, as '/' characters are not allowed in application properties", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398186957", "createdAt": "2020-03-25T21:39:58Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/MessagePropertyTest.java", "diffHunk": "@@ -46,32 +46,6 @@ public void constructorSavesPropertyValue()\n \t\t\n     }\n \n-\t @Test\n-    public void constructorSavesPropertyValueSlash()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODQ0NjE2OnYy", "diffSide": "LEFT", "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/MessagePropertyTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTo0MDoyMFrOF7vacw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTo0MDoyMFrOF7vacw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4NzEyMw==", "bodyText": "Same here. Tab is an illegal character, so we shouldn't have had a test like this", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398187123", "createdAt": "2020-03-25T21:40:20Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/MessagePropertyTest.java", "diffHunk": "@@ -46,32 +46,6 @@ public void constructorSavesPropertyValue()\n \t\t\n     }\n \n-\t @Test\n-    public void constructorSavesPropertyValueSlash()\n-    {\n-        final String name = \"topic\";\n-        final String value = \"/news/sports\";\n-\n-        MessageProperty property = new MessageProperty(name, value);\n-        String testValue = property.getValue();\n-\n-        final String expectedValue = value;\n-        assertThat(testValue, is(expectedValue));\n-    }\n-    \n-    @Test\n-    public void constructorSavesPropertyValueTab()\n-    {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODQ0NzQzOnYy", "diffSide": "RIGHT", "path": "device/iot-device-client/pom.xml", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTo0MDo0OFrOF7vbQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMjowNzowN1rOF7wLyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4NzMyOA==", "bodyText": "How huge is this dependency>", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398187328", "createdAt": "2020-03-25T21:40:48Z", "author": {"login": "prmathur-microsoft"}, "path": "device/iot-device-client/pom.xml", "diffHunk": "@@ -107,6 +107,11 @@\n             <artifactId>slf4j-api</artifactId>\n             <version>1.7.25</version>\n         </dependency>\n+        <dependency>\n+            <groupId>commons-httpclient</groupId>\n+            <artifactId>commons-httpclient</artifactId>\n+            <version>3.1</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4NzU5Mw==", "bodyText": "Does it work on android?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398187593", "createdAt": "2020-03-25T21:41:15Z", "author": {"login": "prmathur-microsoft"}, "path": "device/iot-device-client/pom.xml", "diffHunk": "@@ -107,6 +107,11 @@\n             <artifactId>slf4j-api</artifactId>\n             <version>1.7.25</version>\n         </dependency>\n+        <dependency>\n+            <groupId>commons-httpclient</groupId>\n+            <artifactId>commons-httpclient</artifactId>\n+            <version>3.1</version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4NzMyOA=="}, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE5OTc1Mg==", "bodyText": "300kb, so it's not that bad. The gate will let us know if android will be an issue, but I don't expect it will be", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398199752", "createdAt": "2020-03-25T22:07:07Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/pom.xml", "diffHunk": "@@ -107,6 +107,11 @@\n             <artifactId>slf4j-api</artifactId>\n             <version>1.7.25</version>\n         </dependency>\n+        <dependency>\n+            <groupId>commons-httpclient</groupId>\n+            <artifactId>commons-httpclient</artifactId>\n+            <version>3.1</version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4NzMyOA=="}, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODQ0OTQ0OnYy", "diffSide": "RIGHT", "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsDeviceTelemetryTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTo0MToyN1rOF7vckw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTo0MToyN1rOF7vckw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4NzY2Nw==", "bodyText": "The userId wasn't being mocked properly, and it was hitting the codepath in MessageProperty.java that complains about the contents of the userId not being valid. Without this change, it was using a memory address with several illegal characters", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398187667", "createdAt": "2020-03-25T21:41:27Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsDeviceTelemetryTest.java", "diffHunk": "@@ -544,6 +549,15 @@ public void protonMessageToIoTHubMessageWithInputName(@Mocked final MessageImpl\n                 mockMessage.getMessageAnnotations();\n                 result = mockedAnnotations;\n \n+                mockMessage.getProperties();\n+                result = mockProperties;\n+\n+                mockProperties.getUserId();\n+                result = mockBinary;\n+\n+                mockBinary.toString();\n+                result = \"someUserId\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODQ1MjY1OnYy", "diffSide": "LEFT", "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTo0MjozMlrOF7vezQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTo0MjozMlrOF7vezQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4ODIzNw==", "bodyText": "This test was bad because these characters should never appear in an application property", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398188237", "createdAt": "2020-03-25T21:42:32Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttTest.java", "diffHunk": "@@ -1253,8 +1253,8 @@ public void receiveSuccessCustomPropertyHasUnusualCharacters() throws TransportE\n         assertEquals(\"$\", receivedMessage.getProperties()[0].getValue());\n         assertEquals(\"&\", receivedMessage.getProperties()[1].getValue());\n         assertEquals(\"%\", receivedMessage.getProperties()[2].getName());\n-        assertEquals(\"\\\"\", receivedMessage.getProperties()[2].getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2ODQ1Nzk5OnYy", "diffSide": "RIGHT", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttIotHubConnection.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTo0NDoxNFrOF7viOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMjoxMzoxM1rOF7wV-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4OTExMg==", "bodyText": "is this still needed?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398189112", "createdAt": "2020-03-25T21:44:14Z", "author": {"login": "barustum"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttIotHubConnection.java", "diffHunk": "@@ -7,10 +7,12 @@\n import com.microsoft.azure.sdk.iot.device.exceptions.TransportException;\n import com.microsoft.azure.sdk.iot.device.transport.*;\n import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.httpclient.util.URIUtil;\n \n import javax.net.ssl.SSLContext;\n import java.io.IOException;\n import java.net.URLEncoder;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIwMjM2Mg==", "bodyText": "Yes, we need to use the URIUtil to encode some strings in this class", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/743#discussion_r398202362", "createdAt": "2020-03-25T22:13:13Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttIotHubConnection.java", "diffHunk": "@@ -7,10 +7,12 @@\n import com.microsoft.azure.sdk.iot.device.exceptions.TransportException;\n import com.microsoft.azure.sdk.iot.device.transport.*;\n import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.httpclient.util.URIUtil;\n \n import javax.net.ssl.SSLContext;\n import java.io.IOException;\n import java.net.URLEncoder;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4OTExMg=="}, "originalCommit": {"oid": "7ed36c722104562cb9905d7e6e4c1981c84e0304"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2985, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}