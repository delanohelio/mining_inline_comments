{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMzE3MTEy", "number": 873, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1NToyOVrOEUs-2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxODowNzoyN1rOEUtNsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTQzOTYxOnYy", "diffSide": "LEFT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceEmulator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1NToyOVrOG7DQBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1NToyOVrOG7DQBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3MjQyMg==", "bodyText": "The client was never open at this point, so we can remove this", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464572422", "createdAt": "2020-08-03T17:55:29Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceEmulator.java", "diffHunk": "@@ -54,26 +57,9 @@\n         this.client = client;\n     }\n \n-    void setup() throws IOException\n+    void open() throws IOException\n     {\n-        try\n-        {\n-            if (this.client != null)\n-            {\n-                this.client.closeNow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "545207b7aef101b0117999bb8af44beeb4a24d4a"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTQ0MDc4OnYy", "diffSide": "LEFT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceEmulator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1NTo1M1rOG7DQyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1NTo1M1rOG7DQyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3MjYxNw==", "bodyText": "Each test instance has its own statistics, so there is no need to clear them between test runs", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464572617", "createdAt": "2020-08-03T17:55:53Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceEmulator.java", "diffHunk": "@@ -54,26 +57,9 @@\n         this.client = client;\n     }\n \n-    void setup() throws IOException\n+    void open() throws IOException\n     {\n-        try\n-        {\n-            if (this.client != null)\n-            {\n-                this.client.closeNow();\n-            }\n-        }\n-        catch (IOException e)\n-        {\n-            e.printStackTrace();\n-        }\n-\n-        clearStatistics();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "545207b7aef101b0117999bb8af44beeb4a24d4a"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTQ0MjY4OnYy", "diffSide": "RIGHT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceEmulator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1NjozMFrOG7DR7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1NjozMFrOG7DR7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3MjkxMA==", "bodyText": "Adding this step to ensure that the device methods subscription message gets acknowledged before continuing.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464572910", "createdAt": "2020-08-03T17:56:30Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceEmulator.java", "diffHunk": "@@ -149,6 +135,22 @@ else if (client instanceof ModuleClient)\n                     this.deviceMethodCallback, this.deviceMethodCallbackContext,\n                     this.deviceMethodStatusCallback, this.deviceMethodStatusCallbackContext);\n         }\n+\n+        long startTime = System.currentTimeMillis();\n+        while (deviceStatus.statusOk == 0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "545207b7aef101b0117999bb8af44beeb4a24d4a"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTQ0NDI0OnYy", "diffSide": "LEFT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceTestManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1Njo1N1rOG7DS3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1Njo1N1rOG7DS3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3MzE1MQ==", "bodyText": "Renaming to \"subscribe\" to be more descriptive", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464573151", "createdAt": "2020-08-03T17:56:57Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/DeviceTestManager.java", "diffHunk": "@@ -50,29 +50,27 @@ public void waitIotHub(int numberOfEvents, long timeoutInSeconds) throws Interru\n         }\n     }\n \n-    public void clearDevice()\n+    public void clearStatistics()\n     {\n         this.deviceEmulator.clearStatistics();\n     }\n \n-    public void setup(boolean enableMethod, boolean enableTwin) throws IOException, InterruptedException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "545207b7aef101b0117999bb8af44beeb4a24d4a"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTQ0OTg0OnYy", "diffSide": "LEFT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/methods/DeviceMethodTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1ODo0NFrOG7DWaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1ODo0NFrOG7DWaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3NDA1Ng==", "bodyText": "This creates a device/module client for this test and opens it. Not every test needs this though, so I moved this logic to the super.openDeviceClientAndSubscribeToMethods() call instead", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464574056", "createdAt": "2020-08-03T17:58:44Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/methods/DeviceMethodTests.java", "diffHunk": "@@ -47,16 +45,11 @@ public DeviceMethodTests(IotHubClientProtocol protocol, AuthenticationType authe\n         super(protocol, authenticationType, clientType, publicKeyCert, privateKey, x509Thumbprint);\n     }\n \n-    @Before\n-    public void cleanToStart() throws Exception\n-    {\n-        super.cleanToStart();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "545207b7aef101b0117999bb8af44beeb4a24d4a"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTQ1OTM0OnYy", "diffSide": "LEFT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceMethodCommon.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxODowMToyOVrOG7Db_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxODowMToyOVrOG7Db_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3NTQ4Ng==", "bodyText": "Having a static device method client is an issue since each client only allows one method invocation at a time (the method invocation method is synchronized)\nIn theory, if one test's method invocation takes 10 seconds, that adds a 10 second delay to all concurrently running tests, too.\nI removed this static client in favor of one client per test instance so that no test can interfere with a different test through this.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464575486", "createdAt": "2020-08-03T18:01:29Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceMethodCommon.java", "diffHunk": "@@ -59,7 +59,6 @@ public static Collection inputs() throws Exception\n \n     protected static String iotHubConnectionString = \"\";\n \n-    protected static DeviceMethod methodServiceClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "545207b7aef101b0117999bb8af44beeb4a24d4a"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTQ3NzYyOnYy", "diffSide": "LEFT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceMethodCommon.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxODowNzoyN1rOG7Dnbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxODoxMjoxOFrOG7DxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3ODQxNQ==", "bodyText": "All of the above logic isn't necessary since the test client starts off closed, are opened elsewhere, and we no longer have connection stability issues that require us to use this confirmOpenStabilized(...) anymore.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464578415", "createdAt": "2020-08-03T18:07:27Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceMethodCommon.java", "diffHunk": "@@ -255,36 +254,19 @@ public static void classSetup()\n         }\n     }\n \n-    public void cleanToStart() throws Exception\n+    public void openDeviceClientAndSubscribeToMethods() throws Exception\n     {\n         testInstance.setup();\n-        actualStatusUpdates = new ArrayList<Pair<IotHubConnectionStatus, Throwable>>();\n-        setConnectionStatusCallBack(actualStatusUpdates);\n+        testInstance.deviceTestManager.client.open();\n \n         try\n         {\n-            this.testInstance.deviceTestManager.tearDown();\n-        }\n-        catch (IOException e)\n-        {\n-            e.printStackTrace();\n-        }\n-        catch (InterruptedException e)\n-        {\n-            e.printStackTrace();\n-        }\n-\n-        this.testInstance.deviceTestManager.clearDevice();\n-\n-        try\n-        {\n-            this.testInstance.deviceTestManager.setup(true, false);\n-            IotHubServicesCommon.confirmOpenStabilized(actualStatusUpdates, 120000, this.testInstance.deviceTestManager.client);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "271753e27f4c7bd30ad44c97fde6fe23126e0ba8"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4MDkxNw==", "bodyText": "As a backstory for this confirmOpenStabilized(), our AMQP layer used to be unstable and our tests would have to wait a bit for the instability to go away before continuing. I fixed that instability a while back, so we really don't need this anymore", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/873#discussion_r464580917", "createdAt": "2020-08-03T18:12:18Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceMethodCommon.java", "diffHunk": "@@ -255,36 +254,19 @@ public static void classSetup()\n         }\n     }\n \n-    public void cleanToStart() throws Exception\n+    public void openDeviceClientAndSubscribeToMethods() throws Exception\n     {\n         testInstance.setup();\n-        actualStatusUpdates = new ArrayList<Pair<IotHubConnectionStatus, Throwable>>();\n-        setConnectionStatusCallBack(actualStatusUpdates);\n+        testInstance.deviceTestManager.client.open();\n \n         try\n         {\n-            this.testInstance.deviceTestManager.tearDown();\n-        }\n-        catch (IOException e)\n-        {\n-            e.printStackTrace();\n-        }\n-        catch (InterruptedException e)\n-        {\n-            e.printStackTrace();\n-        }\n-\n-        this.testInstance.deviceTestManager.clearDevice();\n-\n-        try\n-        {\n-            this.testInstance.deviceTestManager.setup(true, false);\n-            IotHubServicesCommon.confirmOpenStabilized(actualStatusUpdates, 120000, this.testInstance.deviceTestManager.client);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3ODQxNQ=="}, "originalCommit": {"oid": "271753e27f4c7bd30ad44c97fde6fe23126e0ba8"}, "originalPosition": 70}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2919, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}