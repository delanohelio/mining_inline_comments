{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NTU2NTM0", "number": 858, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzoyNzo1M1rOENWthg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzoyNzo1M1rOENWthg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDM5MDQ2OnYy", "diffSide": "RIGHT", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzoyNzo1M1rOGv_gsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDoxMDoxNVrOGwEUpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk3NjgxOQ==", "bodyText": "It's important to return here before the next call to messagesToSend.poll() as it keeps the next message to send at the front of the queue. Before this change, if exactly two messages are queued, and the first fails to send (if it is a get twin request and twin links aren't up yet, for instance), then the second message will never send. The second message would be polled and re-queued at the back, and the whole process would run again and fail again indefinitely", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/858#discussion_r452976819", "createdAt": "2020-07-10T17:27:53Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -530,18 +530,18 @@ private void addProxyLayer(Transport transport, String hostName)\n     private void sendQueuedMessages()\n     {\n         int messagesAttemptedToBeProcessed = 0;\n-        boolean lastSendSucceeded = true;\n         Message message = messagesToSend.poll();\n-        while (message != null && messagesAttemptedToBeProcessed < MAX_MESSAGES_TO_SEND_PER_CALLBACK && lastSendSucceeded)\n+        while (message != null && messagesAttemptedToBeProcessed < MAX_MESSAGES_TO_SEND_PER_CALLBACK)\n         {\n             messagesAttemptedToBeProcessed++;\n-            lastSendSucceeded = sendQueuedMessage(message);\n+            boolean lastSendSucceeded = sendQueuedMessage(message);\n \n             if (!lastSendSucceeded)\n             {\n                 //message failed to send, likely due to lack of link credit available. Re-queue and try again later\n                 log.trace(\"Amqp message failed to send, adding it back to messages to send queue ({})\", message);\n                 messagesToSend.add(message);\n+                return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b8b96d0cb2bc2a0766527dec7da0e51e9d3431"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAzMTE4NQ==", "bodyText": "Did you verify only with the e2e test not failing or something else?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/858#discussion_r453031185", "createdAt": "2020-07-10T19:11:37Z", "author": {"login": "bikamani"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -530,18 +530,18 @@ private void addProxyLayer(Transport transport, String hostName)\n     private void sendQueuedMessages()\n     {\n         int messagesAttemptedToBeProcessed = 0;\n-        boolean lastSendSucceeded = true;\n         Message message = messagesToSend.poll();\n-        while (message != null && messagesAttemptedToBeProcessed < MAX_MESSAGES_TO_SEND_PER_CALLBACK && lastSendSucceeded)\n+        while (message != null && messagesAttemptedToBeProcessed < MAX_MESSAGES_TO_SEND_PER_CALLBACK)\n         {\n             messagesAttemptedToBeProcessed++;\n-            lastSendSucceeded = sendQueuedMessage(message);\n+            boolean lastSendSucceeded = sendQueuedMessage(message);\n \n             if (!lastSendSucceeded)\n             {\n                 //message failed to send, likely due to lack of link credit available. Re-queue and try again later\n                 log.trace(\"Amqp message failed to send, adding it back to messages to send queue ({})\", message);\n                 messagesToSend.add(message);\n+                return;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk3NjgxOQ=="}, "originalCommit": {"oid": "54b8b96d0cb2bc2a0766527dec7da0e51e9d3431"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1NTY1NA==", "bodyText": "I verified by manually causing that 2 message scenario and verifying that the SDK eventually sends the subscription message. There isn't a way to test this reliably because we don't have control over when each message will be queued from the e2e tests level. There is some level of randomness", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/858#discussion_r453055654", "createdAt": "2020-07-10T20:10:15Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -530,18 +530,18 @@ private void addProxyLayer(Transport transport, String hostName)\n     private void sendQueuedMessages()\n     {\n         int messagesAttemptedToBeProcessed = 0;\n-        boolean lastSendSucceeded = true;\n         Message message = messagesToSend.poll();\n-        while (message != null && messagesAttemptedToBeProcessed < MAX_MESSAGES_TO_SEND_PER_CALLBACK && lastSendSucceeded)\n+        while (message != null && messagesAttemptedToBeProcessed < MAX_MESSAGES_TO_SEND_PER_CALLBACK)\n         {\n             messagesAttemptedToBeProcessed++;\n-            lastSendSucceeded = sendQueuedMessage(message);\n+            boolean lastSendSucceeded = sendQueuedMessage(message);\n \n             if (!lastSendSucceeded)\n             {\n                 //message failed to send, likely due to lack of link credit available. Re-queue and try again later\n                 log.trace(\"Amqp message failed to send, adding it back to messages to send queue ({})\", message);\n                 messagesToSend.add(message);\n+                return;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk3NjgxOQ=="}, "originalCommit": {"oid": "54b8b96d0cb2bc2a0766527dec7da0e51e9d3431"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2908, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}