{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NjcwMzg2", "number": 662, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzozODowMlrODWs42Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMDozMDo0OFrODWtZWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MTMwNzEzOnYy", "diffSide": "RIGHT", "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/ProtonJExceptionParser.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzozODowMlrOFbnJug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMDoyNjoyNlrOFbn49Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5NzMzOA==", "bodyText": "Why is this check required? It would be better to check that endpoints is not null.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364497338", "createdAt": "2020-01-08T23:38:02Z", "author": {"login": "abhipsaMisra"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/ProtonJExceptionParser.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ *  Copyright (c) Microsoft. All rights reserved.\n+ *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n+ */\n+\n+package com.microsoft.azure.sdk.iot.deps.transport.amqp;\n+\n+import lombok.Getter;\n+import org.apache.qpid.proton.amqp.transport.ErrorCondition;\n+import org.apache.qpid.proton.engine.Endpoint;\n+import org.apache.qpid.proton.engine.Event;\n+\n+@Getter\n+public class ProtonJExceptionParser\n+{\n+    private String error;\n+    private String errorDescription;\n+\n+    private static final String DEFAULT_ERROR_DESCRIPTION = \"NoErrorDescription\";\n+\n+    public ProtonJExceptionParser(Event event)\n+    {\n+        getTransportExceptionFromProtonEndpoints(event.getSender(), event.getReceiver(), event.getConnection(), event.getTransport(), event.getSession(), event.getLink());\n+    }\n+\n+    private ErrorCondition getErrorConditionFromEndpoint(Endpoint endpoint)\n+    {\n+        return endpoint.getCondition() != null && endpoint.getCondition().getCondition() != null ? endpoint.getCondition() : endpoint.getRemoteCondition();\n+    }\n+\n+    private void getTransportExceptionFromProtonEndpoints(Endpoint... endpoints)\n+    {\n+        for (Endpoint endpoint : endpoints)\n+        {\n+            if (endpoint == null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "220f8ee6355f9d96229f874f0a4f281d26c9aa6d"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUwNDY4Mw==", "bodyText": "This check is required because that collection of endpoints does contain some null endpoints", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364504683", "createdAt": "2020-01-09T00:06:57Z", "author": {"login": "timtay-microsoft"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/ProtonJExceptionParser.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ *  Copyright (c) Microsoft. All rights reserved.\n+ *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n+ */\n+\n+package com.microsoft.azure.sdk.iot.deps.transport.amqp;\n+\n+import lombok.Getter;\n+import org.apache.qpid.proton.amqp.transport.ErrorCondition;\n+import org.apache.qpid.proton.engine.Endpoint;\n+import org.apache.qpid.proton.engine.Event;\n+\n+@Getter\n+public class ProtonJExceptionParser\n+{\n+    private String error;\n+    private String errorDescription;\n+\n+    private static final String DEFAULT_ERROR_DESCRIPTION = \"NoErrorDescription\";\n+\n+    public ProtonJExceptionParser(Event event)\n+    {\n+        getTransportExceptionFromProtonEndpoints(event.getSender(), event.getReceiver(), event.getConnection(), event.getTransport(), event.getSession(), event.getLink());\n+    }\n+\n+    private ErrorCondition getErrorConditionFromEndpoint(Endpoint endpoint)\n+    {\n+        return endpoint.getCondition() != null && endpoint.getCondition().getCondition() != null ? endpoint.getCondition() : endpoint.getRemoteCondition();\n+    }\n+\n+    private void getTransportExceptionFromProtonEndpoints(Endpoint... endpoints)\n+    {\n+        for (Endpoint endpoint : endpoints)\n+        {\n+            if (endpoint == null)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5NzMzOA=="}, "originalCommit": {"oid": "220f8ee6355f9d96229f874f0a4f281d26c9aa6d"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUwNDg3NQ==", "bodyText": "The collection of endpoints is never null, though", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364504875", "createdAt": "2020-01-09T00:07:42Z", "author": {"login": "timtay-microsoft"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/ProtonJExceptionParser.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ *  Copyright (c) Microsoft. All rights reserved.\n+ *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n+ */\n+\n+package com.microsoft.azure.sdk.iot.deps.transport.amqp;\n+\n+import lombok.Getter;\n+import org.apache.qpid.proton.amqp.transport.ErrorCondition;\n+import org.apache.qpid.proton.engine.Endpoint;\n+import org.apache.qpid.proton.engine.Event;\n+\n+@Getter\n+public class ProtonJExceptionParser\n+{\n+    private String error;\n+    private String errorDescription;\n+\n+    private static final String DEFAULT_ERROR_DESCRIPTION = \"NoErrorDescription\";\n+\n+    public ProtonJExceptionParser(Event event)\n+    {\n+        getTransportExceptionFromProtonEndpoints(event.getSender(), event.getReceiver(), event.getConnection(), event.getTransport(), event.getSession(), event.getLink());\n+    }\n+\n+    private ErrorCondition getErrorConditionFromEndpoint(Endpoint endpoint)\n+    {\n+        return endpoint.getCondition() != null && endpoint.getCondition().getCondition() != null ? endpoint.getCondition() : endpoint.getRemoteCondition();\n+    }\n+\n+    private void getTransportExceptionFromProtonEndpoints(Endpoint... endpoints)\n+    {\n+        for (Endpoint endpoint : endpoints)\n+        {\n+            if (endpoint == null)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5NzMzOA=="}, "originalCommit": {"oid": "220f8ee6355f9d96229f874f0a4f281d26c9aa6d"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUwOTQyOQ==", "bodyText": "The Endpoint spread is over the inputs we get from the constructor; makes sense.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364509429", "createdAt": "2020-01-09T00:26:26Z", "author": {"login": "abhipsaMisra"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/ProtonJExceptionParser.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ *  Copyright (c) Microsoft. All rights reserved.\n+ *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n+ */\n+\n+package com.microsoft.azure.sdk.iot.deps.transport.amqp;\n+\n+import lombok.Getter;\n+import org.apache.qpid.proton.amqp.transport.ErrorCondition;\n+import org.apache.qpid.proton.engine.Endpoint;\n+import org.apache.qpid.proton.engine.Event;\n+\n+@Getter\n+public class ProtonJExceptionParser\n+{\n+    private String error;\n+    private String errorDescription;\n+\n+    private static final String DEFAULT_ERROR_DESCRIPTION = \"NoErrorDescription\";\n+\n+    public ProtonJExceptionParser(Event event)\n+    {\n+        getTransportExceptionFromProtonEndpoints(event.getSender(), event.getReceiver(), event.getConnection(), event.getTransport(), event.getSession(), event.getLink());\n+    }\n+\n+    private ErrorCondition getErrorConditionFromEndpoint(Endpoint endpoint)\n+    {\n+        return endpoint.getCondition() != null && endpoint.getCondition().getCondition() != null ? endpoint.getCondition() : endpoint.getRemoteCondition();\n+    }\n+\n+    private void getTransportExceptionFromProtonEndpoints(Endpoint... endpoints)\n+    {\n+        for (Endpoint endpoint : endpoints)\n+        {\n+            if (endpoint == null)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5NzMzOA=="}, "originalCommit": {"oid": "220f8ee6355f9d96229f874f0a4f281d26c9aa6d"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MTM5MDMyOnYy", "diffSide": "RIGHT", "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/ErrorLoggingBaseHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMDozMDo0OFrOFbn87g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwNToxMDoxNFrOFbrEiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMDQ0Ng==", "bodyText": "Do we allow multiple sessions over a single connection? If yes, then it'll be useful to log the session identifier here as well (similar to link).", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364510446", "createdAt": "2020-01-09T00:30:48Z", "author": {"login": "abhipsaMisra"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/ErrorLoggingBaseHandler.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ *  Copyright (c) Microsoft. All rights reserved.\n+ *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n+ */\n+\n+package com.microsoft.azure.sdk.iot.deps.transport.amqp;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.qpid.proton.engine.BaseHandler;\n+import org.apache.qpid.proton.engine.Event;\n+\n+@Slf4j\n+public class ErrorLoggingBaseHandler extends BaseHandler\n+{\n+    protected ProtonJExceptionParser protonJExceptionParser;\n+\n+    @Override\n+    public void onLinkRemoteClose(Event event)\n+    {\n+        protonJExceptionParser = new ProtonJExceptionParser(event);\n+        if (protonJExceptionParser.getError() == null)\n+        {\n+            log.debug(\"Amqp link {} was closed remotely\", event.getLink().getName());\n+        }\n+        else\n+        {\n+            if (event.getLink() != null && event.getLink().getName() != null)\n+            {\n+                log.warn(\"Amqp link {} was closed remotely with exception {} with description {}\", event.getLink().getName(), protonJExceptionParser.getError(), protonJExceptionParser.getErrorDescription());\n+            }\n+            else\n+            {\n+                log.warn(\"Unknown amqp link was closed remotely with exception {} with description {}\", protonJExceptionParser.getError(), protonJExceptionParser.getErrorDescription());\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void onSessionRemoteClose(Event event)\n+    {\n+        protonJExceptionParser = new ProtonJExceptionParser(event);\n+        if (protonJExceptionParser.getError() == null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22a15ff8164e4b94db004b3abc153f8f372fde0d"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU2MTU0Nw==", "bodyText": "We do open multiple sessions for multiplexed connections, I believe. However, the proton-j session object doesn't have any information in it here that we could use to correlate back to which session it was. Sessions being closed remotely are a bit of a rare case, from my understanding, so we can hold off on adding that kind of mapping for now", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364561547", "createdAt": "2020-01-09T05:10:14Z", "author": {"login": "timtay-microsoft"}, "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/ErrorLoggingBaseHandler.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ *  Copyright (c) Microsoft. All rights reserved.\n+ *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n+ */\n+\n+package com.microsoft.azure.sdk.iot.deps.transport.amqp;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.qpid.proton.engine.BaseHandler;\n+import org.apache.qpid.proton.engine.Event;\n+\n+@Slf4j\n+public class ErrorLoggingBaseHandler extends BaseHandler\n+{\n+    protected ProtonJExceptionParser protonJExceptionParser;\n+\n+    @Override\n+    public void onLinkRemoteClose(Event event)\n+    {\n+        protonJExceptionParser = new ProtonJExceptionParser(event);\n+        if (protonJExceptionParser.getError() == null)\n+        {\n+            log.debug(\"Amqp link {} was closed remotely\", event.getLink().getName());\n+        }\n+        else\n+        {\n+            if (event.getLink() != null && event.getLink().getName() != null)\n+            {\n+                log.warn(\"Amqp link {} was closed remotely with exception {} with description {}\", event.getLink().getName(), protonJExceptionParser.getError(), protonJExceptionParser.getErrorDescription());\n+            }\n+            else\n+            {\n+                log.warn(\"Unknown amqp link was closed remotely with exception {} with description {}\", protonJExceptionParser.getError(), protonJExceptionParser.getErrorDescription());\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void onSessionRemoteClose(Event event)\n+    {\n+        protonJExceptionParser = new ProtonJExceptionParser(event);\n+        if (protonJExceptionParser.getError() == null)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMDQ0Ng=="}, "originalCommit": {"oid": "22a15ff8164e4b94db004b3abc153f8f372fde0d"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2934, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}