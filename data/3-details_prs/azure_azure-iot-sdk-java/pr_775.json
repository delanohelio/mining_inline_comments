{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODk1MTc4", "number": 775, "title": "fix(iot-dev): Fix issue where MQTT didn't url encode application properties correctly", "bodyText": "URLEncoder.Encode encodes the space character ' ' as '+' instead of the expected '%20', so I've added a manual replace step for this character. This is most important for MQTT because that protocol doesn't allow topic strings with the '+' character\nAlso removing all character validation for application property keys and values now that this MQTT bug is fixed. There is no longer a device-side reason to validate these values as all protocols are encoding them correctly now such that the protocol doesn't throw an exception. Iot Hub will be the validator, not the client.\nHub does allow these previously banned characters, provided they are encoded correctly for each protocol.", "createdAt": "2020-05-12T18:26:59Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775", "merged": true, "mergeCommit": {"oid": "64111b97c822506813134d43c2cc5c62615038cf"}, "closed": true, "closedAt": "2020-05-12T22:19:40Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgogbggH2gAyNDE2ODk1MTc4OmE4NzA0MWIxZmE5OGQ2YWVjN2ZhZDY2ZTNlN2EwNWE2ZTQwZjgxZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgpQZ0gFqTQxMDM0Njg4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3", "committedDate": "2020-05-12T18:23:17Z", "message": "fix(iot-dev): Fix issue where MQTT didn't url encode application properties correctly\n\nURLEncoder.Encode fails to encode the character '+', so I've added a manual replace step for this character.\n\nAlso removing all character validation for application property keys and values now that this MQTT bug is fixed. There is no longer a device-side reason to validate these values as all protocols are encoding them correctly now such that the protocol doesn't throw an exception. Iot Hub will be the validator, not the client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzE0MzE4", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#pullrequestreview-410314318", "createdAt": "2020-05-12T18:30:54Z", "commit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODozMDo1NFrOGUTq7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODozMDo1NFrOGUTq7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk0Njk5MA==", "bodyText": "whoa, who added hindi in here!", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423946990", "createdAt": "2020-05-12T18:30:54Z", "author": {"login": "abhipsaMisra"}, "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/MessagePropertyTest.java", "diffHunk": "@@ -131,20 +111,6 @@ public void isValidAppPropertyReturnsTrueForValidAppProperty()\n         assertThat(testIsValidAppProperty, is(expectedIsValidAppProperty));\n     }\n \n-    // Tests_SRS_MESSAGEPROPERTY_11_007: [The function shall return true if and only if the name and value only use characters in: US-ASCII and the name is not a reserved property name.]\n-    @Test\n-    public void isValidAppPropertyReturnsFalseForInvalidAppProperty()\n-    {\n-        final String name = \"test-name\";\n-        final String illegalValue = \"\u092a\u0930\u0940\u0915\u094d\u0937\u0923\"; // Unicode is not supported in MessageProperty value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzI2MDkx", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#pullrequestreview-410326091", "createdAt": "2020-05-12T18:47:04Z", "commit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODo0NzowNFrOGUUPdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODo0NzowNFrOGUUPdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1NjM0Mg==", "bodyText": "Do we need to validate even this?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423956342", "createdAt": "2020-05-12T18:47:04Z", "author": {"login": "abhipsaMisra"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/MessageProperty.java", "diffHunk": "@@ -163,17 +144,9 @@ public boolean hasSameName(String name) {\n      *\n      * @return whether the property is a valid application property.\n      */\n-    public static boolean isValidAppProperty(String name, String value) {\n-        boolean propertyIsValid = false;\n-\n-        // Codes_SRS_MESSAGEPROPERTY_11_007: [The function shall return true if and only if the name and value only use characters in US-ASCII and the name is not a reserved property name.]\n-        if (!RESERVED_PROPERTY_NAMES.contains(name)\n-                && usesValidChars(name)\n-                && usesValidChars(value)) {\n-            propertyIsValid = true;\n-        }\n-\n-        return propertyIsValid;\n+    public static boolean isValidAppProperty(String name, String value)\n+    {\n+        return !RESERVED_PROPERTY_NAMES.contains(name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzMzMTIy", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#pullrequestreview-410333122", "createdAt": "2020-05-12T18:56:26Z", "commit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODo1NjoyNlrOGUUluw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODo1NjoyNlrOGUUluw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MjA0Mw==", "bodyText": "What's the limitation with URLEncoder being unable to encode +?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423962043", "createdAt": "2020-05-12T18:56:26Z", "author": {"login": "abhipsaMisra"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "diffHunk": "@@ -154,15 +154,15 @@ private boolean appendPropertyIfPresent(StringBuilder stringBuilder, boolean sep\n \n                 if (isApplicationProperty)\n                 {\n-                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()));\n+                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()).replaceAll(\"\\\\+\", \"%20\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44ceb855866d8977c131033a77b7484ceff98ef3", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/44ceb855866d8977c131033a77b7484ceff98ef3", "committedDate": "2020-05-12T19:14:10Z", "message": "cr comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzQ2ODgy", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#pullrequestreview-410346882", "createdAt": "2020-05-12T19:15:41Z", "commit": {"oid": "44ceb855866d8977c131033a77b7484ceff98ef3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1630, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}