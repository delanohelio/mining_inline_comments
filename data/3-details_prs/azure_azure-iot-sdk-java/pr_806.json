{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMzYzOTE1", "number": 806, "title": "fix(e2e): Fix multithreaded test not waiting for threads to finish correctly", "bodyText": "This test always waited a full 3 minutes because the countdown latch waiting didn't work right. No need for a countdown latch though since we can just wait for all the threads to finish before checking if each send succeeded.\nSpeeds up this test from 3 minutes to ~5 seconds", "createdAt": "2020-06-11T22:27:00Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/806", "merged": true, "mergeCommit": {"oid": "0ca0035e13bb99c6d0d4702e783945f398d8c171"}, "closed": true, "closedAt": "2020-06-12T02:37:55Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqV9aNgH2gAyNDMzMzYzOTE1OjIzNGQ4NDFhOGU2ZjFjMjkxNmVmZTVmOWMzNTdhNmEwZWM2YThlMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqXH14gH2gAyNDMzMzYzOTE1OmExYWI0MjExNWQyZDc1YjRkYzY4NDkyZDYzODBjNmZhYzhiZDBkYzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "234d841a8e6f1c2916efe5f9c357a6a0ec6a8e23", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/234d841a8e6f1c2916efe5f9c357a6a0ec6a8e23", "committedDate": "2020-06-11T22:25:59Z", "message": "fix(e2e): Fix multithreaded test not waiting for threads to finish correctly\n\nIt always waited the full 3 minutes becuase the countdown latch didn't work right. No need for a countdown latch though since we can just wait for all the threads to finish before checking if each send succeeded"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6ddb0eb0d1bfc68a2663124c6044994184c7d43", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/e6ddb0eb0d1bfc68a2663124c6044994184c7d43", "committedDate": "2020-06-11T22:34:21Z", "message": "Merge branch 'master' into timtay/transporClientTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzQzODI1", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/806#pullrequestreview-429343825", "createdAt": "2020-06-11T22:47:14Z", "commit": {"oid": "e6ddb0eb0d1bfc68a2663124c6044994184c7d43"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMjo0NzoxNVrOGixQwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMjo0NzoxNVrOGixQwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExMTg3Mg==", "bodyText": "Nothing like TimeSpan in Java?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/806#discussion_r439111872", "createdAt": "2020-06-11T22:47:15Z", "author": {"login": "drwill-ms"}, "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/tests/iothub/TransportClientTests.java", "diffHunk": "@@ -50,8 +47,8 @@\n     private static final int NUM_MESSAGES_PER_CONNECTION = 3;\n \n     private static final long RETRY_MILLISECONDS = 100; //.1 seconds\n-    private static final long SEND_TIMEOUT_MILLISECONDS = 5 * 60 * 1000; // 5 minutes\n-    private static final long RECEIVE_MESSAGE_TIMEOUT = 5 * 60 * 1000; // 5 minutes\n+    private static final long SEND_TIMEOUT_MILLISECONDS = 20 * 1000; // 20 seconds", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6ddb0eb0d1bfc68a2663124c6044994184c7d43"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzQ0MDMx", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/806#pullrequestreview-429344031", "createdAt": "2020-06-11T22:47:42Z", "commit": {"oid": "e6ddb0eb0d1bfc68a2663124c6044994184c7d43"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzQ4OTMx", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/806#pullrequestreview-429348931", "createdAt": "2020-06-11T22:59:21Z", "commit": {"oid": "234d841a8e6f1c2916efe5f9c357a6a0ec6a8e23"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMjo1OToyMVrOGixfrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMjo1OToyMVrOGixfrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNTY5NA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/806#discussion_r439115694", "createdAt": "2020-06-11T22:59:21Z", "author": {"login": "prmathur-microsoft"}, "path": "iot-e2e-tests/common/src/main/java/com/microsoft/azure/sdk/iot/common/tests/iothub/TransportClientTests.java", "diffHunk": "@@ -251,20 +248,21 @@ public void receiveMessagesIncludingProperties() throws Exception\n     }\n \n     @Test\n-    public void sendMessagesMultithreaded() throws InterruptedException, URISyntaxException, IOException\n+    public void sendMessagesMultithreaded() throws InterruptedException, IOException\n     {\n-        CountDownLatch cdl = new CountDownLatch(testInstance.clientArrayList.size());\n-\n         testInstance.transportClient.open();\n+        Thread[] threads = new Thread[testInstance.clientArrayList.size()];\n \n         for (int i = 0; i < testInstance.clientArrayList.size(); i++)\n         {\n-            new Thread(\n-                    new MultiplexRunnable(\n-                            testInstance.devicesList[i], testInstance.clientArrayList.get(i), NUM_MESSAGES_PER_CONNECTION, NUM_KEYS_PER_MESSAGE, SEND_TIMEOUT_MILLISECONDS, cdl, testInstance.succeed))\n-                    .start();\n+            threads[i] = new Thread(new MultiplexRunnable(testInstance.devicesList[i], testInstance.clientArrayList.get(i), testInstance.succeed));\n+            threads[i].start();\n+        }\n+\n+        for (int i = 0; i < testInstance.clientArrayList.size(); i++)\n+        {\n+            threads[i].join(SEND_TIMEOUT_MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "234d841a8e6f1c2916efe5f9c357a6a0ec6a8e23"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzQ5MDYy", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/806#pullrequestreview-429349062", "createdAt": "2020-06-11T22:59:36Z", "commit": {"oid": "234d841a8e6f1c2916efe5f9c357a6a0ec6a8e23"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1ab42115d2d75b4dc68492d6380c6fac8bd0dc3", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/a1ab42115d2d75b4dc68492d6380c6fac8bd0dc3", "committedDate": "2020-06-11T23:47:17Z", "message": "Merge branch 'master' into timtay/transporClientTest"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1659, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}