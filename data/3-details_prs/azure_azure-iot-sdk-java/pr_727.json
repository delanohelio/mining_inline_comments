{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2OTAxMDIz", "number": 727, "title": "feat(iot-dev): Add support for CA signed X509 over MQTT_WS, and HTTPS", "bodyText": "Previously, these changes were not sufficient, but something changed on the service side to make them work as expected. We no longer need the query string \"?iothub-no-client-cert=true\"\nHTTP required no code changes because it appears something changed from the service to make this flow work. We should draw attention to this for our customers though\nAMQP_WS in theory would work if we removed the query string, but from my testing, it only sometimes works. It needs further investigation. MQTT_WS and HTTPS work flawlessly though", "createdAt": "2020-03-11T20:18:34Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/727", "merged": true, "mergeCommit": {"oid": "7522dcbe5ca25a7facd18565e3e90d7fa26ec0fc"}, "closed": true, "closedAt": "2020-03-21T01:30:49Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMuEQFgH2gAyMzg2OTAxMDIzOjE1NTIyYTg5ZTRmYTgwYjBmZTRiYTA3OWMxM2E4MDVlZTgwODcwNWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPn9LaAFqTM3ODgzODE2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "15522a89e4fa80b0fe4ba079c13a805ee808705f", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/15522a89e4fa80b0fe4ba079c13a805ee808705f", "committedDate": "2020-03-11T21:33:27Z", "message": "feat(iot-dev): Add support for CA signed X509 over MQTT_WS, and HTTPS\n\nHTTP required no code changes because it already worked, strangely. Mqtt only needed to stop sending the query string \"?iothub-no-client-cert=true\" when connecting. This didn't use to work, but something from service side seems to have changed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb5bc32ccfdf2ce1b36549fbeef1d33ffe17342f", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/fb5bc32ccfdf2ce1b36549fbeef1d33ffe17342f", "committedDate": "2020-03-11T21:03:11Z", "message": "squash"}, "afterCommit": {"oid": "15522a89e4fa80b0fe4ba079c13a805ee808705f", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/15522a89e4fa80b0fe4ba079c13a805ee808705f", "committedDate": "2020-03-11T21:33:27Z", "message": "feat(iot-dev): Add support for CA signed X509 over MQTT_WS, and HTTPS\n\nHTTP required no code changes because it already worked, strangely. Mqtt only needed to stop sending the query string \"?iothub-no-client-cert=true\" when connecting. This didn't use to work, but something from service side seems to have changed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d36affdf07c0e68d8734995977f876cd49de7029", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/d36affdf07c0e68d8734995977f876cd49de7029", "committedDate": "2020-03-12T00:59:00Z", "message": "squash fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "163db4d6bccfe8579c7a622a200f40236413806b", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/163db4d6bccfe8579c7a622a200f40236413806b", "committedDate": "2020-03-16T17:50:37Z", "message": "Merge branch 'master' into timtay/x509CA"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d894232d6527bd60fa505fa34e7567581c0e4a7", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/0d894232d6527bd60fa505fa34e7567581c0e4a7", "committedDate": "2020-03-16T18:03:08Z", "message": "to squash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "763088b79b07015995f9764af6622f266ff34ea5", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/763088b79b07015995f9764af6622f266ff34ea5", "committedDate": "2020-03-20T17:24:36Z", "message": "Merge branch 'master' into timtay/x509CA"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13c6fd93ba9b9ff989d1736fe00e7019d322ee2e", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/13c6fd93ba9b9ff989d1736fe00e7019d322ee2e", "committedDate": "2020-03-20T21:12:32Z", "message": "Merge branch 'master' into timtay/x509CA"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODE5NDI2", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/727#pullrequestreview-378819426", "createdAt": "2020-03-20T21:22:06Z", "commit": {"oid": "13c6fd93ba9b9ff989d1736fe00e7019d322ee2e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMToyMjowNlrOF5jjmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMToyMjowNlrOF5jjmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5NTcwNg==", "bodyText": "isn't this \"else\" case basically or part of the if {} at line 129?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/727#discussion_r395895706", "createdAt": "2020-03-20T21:22:06Z", "author": {"login": "bikamani"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttIotHubConnection.java", "diffHunk": "@@ -132,17 +133,21 @@ public void open(Queue<DeviceClientConfig> deviceClientConfigs, ScheduledExecuto\n                 }\n                 else if (this.config.getAuthenticationType() == DeviceClientConfig.AuthType.X509_CERTIFICATE)\n                 {\n-                    if (this.config.isUseWebsocket())\n-                    {\n-                        //Codes_SRS_MQTTIOTHUBCONNECTION_34_027: [If this function is called while using websockets and x509 authentication, an UnsupportedOperationException shall be thrown.]\n-                        throw new UnsupportedOperationException(\"X509 authentication is not supported over MQTT_WS\");\n-                    }\n-\n                     this.log.trace(\"MQTT connection will use X509 certificate based auth\");\n \n                     this.iotHubUserPassword = null;\n                 }\n \n+                if (this.config.getAuthenticationType() != DeviceClientConfig.AuthType.X509_CERTIFICATE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c6fd93ba9b9ff989d1736fe00e7019d322ee2e"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba9e9728d30749391f9cd7e92d0c999b68d15a2c", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/ba9e9728d30749391f9cd7e92d0c999b68d15a2c", "committedDate": "2020-03-20T21:29:18Z", "message": "cr comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODIzMzM5", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/727#pullrequestreview-378823339", "createdAt": "2020-03-20T21:30:46Z", "commit": {"oid": "13c6fd93ba9b9ff989d1736fe00e7019d322ee2e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMTozMDo0NlrOF5jv8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMTozMDo0NlrOF5jv8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5ODg2NQ==", "bodyText": "Do we need \"this\" any more? I know it is there in legacy code but this going forward if we don't need it why use?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/727#discussion_r395898865", "createdAt": "2020-03-20T21:30:46Z", "author": {"login": "bikamani"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttIotHubConnection.java", "diffHunk": "@@ -132,17 +133,21 @@ public void open(Queue<DeviceClientConfig> deviceClientConfigs, ScheduledExecuto\n                 }\n                 else if (this.config.getAuthenticationType() == DeviceClientConfig.AuthType.X509_CERTIFICATE)\n                 {\n-                    if (this.config.isUseWebsocket())\n-                    {\n-                        //Codes_SRS_MQTTIOTHUBCONNECTION_34_027: [If this function is called while using websockets and x509 authentication, an UnsupportedOperationException shall be thrown.]\n-                        throw new UnsupportedOperationException(\"X509 authentication is not supported over MQTT_WS\");\n-                    }\n-\n                     this.log.trace(\"MQTT connection will use X509 certificate based auth\");\n \n                     this.iotHubUserPassword = null;\n                 }\n \n+                if (this.config.getAuthenticationType() != DeviceClientConfig.AuthType.X509_CERTIFICATE)\n+                {\n+                    //X509 auth websocket should not include the iothub-no-client-cert flag\n+                    this.webSocketQueryString = NO_CLIENT_CERT_QUERY_STRING;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c6fd93ba9b9ff989d1736fe00e7019d322ee2e"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODIzOTYz", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/727#pullrequestreview-378823963", "createdAt": "2020-03-20T21:32:09Z", "commit": {"oid": "ba9e9728d30749391f9cd7e92d0c999b68d15a2c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMTozMjowOVrOF5jx3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMTozMjowOVrOF5jx3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5OTM1OQ==", "bodyText": "So this needs to be set to empty string? Or should there be conditional check when appending this?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/727#discussion_r395899359", "createdAt": "2020-03-20T21:32:09Z", "author": {"login": "bikamani"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttIotHubConnection.java", "diffHunk": "@@ -129,17 +130,15 @@ public void open(Queue<DeviceClientConfig> deviceClientConfigs, ScheduledExecuto\n                 {\n                     this.log.trace(\"MQTT connection will use sas token based auth\");\n                     this.iotHubUserPassword = this.config.getSasTokenAuthentication().getRenewedSasToken(false, false);\n+                    this.webSocketQueryString = NO_CLIENT_CERT_QUERY_STRING;\n                 }\n                 else if (this.config.getAuthenticationType() == DeviceClientConfig.AuthType.X509_CERTIFICATE)\n                 {\n-                    if (this.config.isUseWebsocket())\n-                    {\n-                        //Codes_SRS_MQTTIOTHUBCONNECTION_34_027: [If this function is called while using websockets and x509 authentication, an UnsupportedOperationException shall be thrown.]\n-                        throw new UnsupportedOperationException(\"X509 authentication is not supported over MQTT_WS\");\n-                    }\n-\n                     this.log.trace(\"MQTT connection will use X509 certificate based auth\");\n \n+                    this.webSocketQueryString = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba9e9728d30749391f9cd7e92d0c999b68d15a2c"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODI0MTc5", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/727#pullrequestreview-378824179", "createdAt": "2020-03-20T21:32:42Z", "commit": {"oid": "ba9e9728d30749391f9cd7e92d0c999b68d15a2c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMTozMjo0MlrOF5jyqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMTozMjo0MlrOF5jyqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5OTU2MQ==", "bodyText": "Did you want to move this before line 139?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/727#discussion_r395899561", "createdAt": "2020-03-20T21:32:42Z", "author": {"login": "bikamani"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttIotHubConnection.java", "diffHunk": "@@ -129,17 +130,15 @@ public void open(Queue<DeviceClientConfig> deviceClientConfigs, ScheduledExecuto\n                 {\n                     this.log.trace(\"MQTT connection will use sas token based auth\");\n                     this.iotHubUserPassword = this.config.getSasTokenAuthentication().getRenewedSasToken(false, false);\n+                    this.webSocketQueryString = NO_CLIENT_CERT_QUERY_STRING;\n                 }\n                 else if (this.config.getAuthenticationType() == DeviceClientConfig.AuthType.X509_CERTIFICATE)\n                 {\n-                    if (this.config.isUseWebsocket())\n-                    {\n-                        //Codes_SRS_MQTTIOTHUBCONNECTION_34_027: [If this function is called while using websockets and x509 authentication, an UnsupportedOperationException shall be thrown.]\n-                        throw new UnsupportedOperationException(\"X509 authentication is not supported over MQTT_WS\");\n-                    }\n-\n                     this.log.trace(\"MQTT connection will use X509 certificate based auth\");\n \n+                    this.webSocketQueryString = \"\";\n+\n+                    //X509 auth over websocket should not include the iothub-no-client-cert flag", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba9e9728d30749391f9cd7e92d0c999b68d15a2c"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODI1MDE3", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/727#pullrequestreview-378825017", "createdAt": "2020-03-20T21:34:44Z", "commit": {"oid": "ba9e9728d30749391f9cd7e92d0c999b68d15a2c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3d05d62feaecd187187640b051b36b4f11ad518", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/f3d05d62feaecd187187640b051b36b4f11ad518", "committedDate": "2020-03-20T21:36:20Z", "message": "more comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c3b9001cbdcd8fdcd71b25ec4f11904c650ae27", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/0c3b9001cbdcd8fdcd71b25ec4f11904c650ae27", "committedDate": "2020-03-20T21:51:35Z", "message": "unit test for open flow with x509 auth and websocket"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b444ff9a9903c6a92002f391416d11b751ee6ff", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/9b444ff9a9903c6a92002f391416d11b751ee6ff", "committedDate": "2020-03-20T21:56:11Z", "message": "fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "897464b1cc700567228d1f2e3abbae103b44bab5", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/897464b1cc700567228d1f2e3abbae103b44bab5", "committedDate": "2020-03-20T22:01:57Z", "message": "fix unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODM4MTYy", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/727#pullrequestreview-378838162", "createdAt": "2020-03-20T22:08:04Z", "commit": {"oid": "897464b1cc700567228d1f2e3abbae103b44bab5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1822, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}