{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMzIxMzk2", "number": 825, "title": "Fix a few flakey tests, add more context when logging transport messages", "bodyText": "", "createdAt": "2020-06-26T00:30:59Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825", "merged": true, "mergeCommit": {"oid": "f2a8ff20be2885bd4838a21baa8bea2d0796136b"}, "closed": true, "closedAt": "2020-06-26T18:06:57Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcu4JckAFqTQzNzk0NDQzNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvHOWeAFqTQzODQ5NTMyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTQ0NDM3", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#pullrequestreview-437944437", "createdAt": "2020-06-26T00:31:36Z", "commit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDozMTozNlrOGpQG7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDozMTozNlrOGpQG7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwODcxOQ==", "bodyText": "This information has been useful to me when debugging these flakey tests, and I suspect customer's will appreciate this too", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#discussion_r445908719", "createdAt": "2020-06-26T00:31:36Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/IotHubTransportMessage.java", "diffHunk": "@@ -293,6 +293,11 @@ public String toString()\n             base.append(\"Request Id [\").append(this.requestId).append(\"] \");\n         }\n \n+        if (this.getDeviceOperationType() != null && this.getDeviceOperationType() != DeviceOperations.DEVICE_OPERATION_UNKNOWN)\n+        {\n+            base.append(\"Device Operation Type [\").append(this.getDeviceOperationType()).append(\"] \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTQ0Njc3", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#pullrequestreview-437944677", "createdAt": "2020-06-26T00:32:32Z", "commit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDozMjozMlrOGpQH4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDozMjozMlrOGpQH4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwODk2MQ==", "bodyText": "The commit message explains this further, but Android SDKs return -1 when inputStream.read(...) reads no bytes. JDKs return 0 though. For consistency between JDK and android SDK, we shouldn't use this return value", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#discussion_r445908961", "createdAt": "2020-06-26T00:32:32Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/FileUploadTests.java", "diffHunk": "@@ -304,7 +304,8 @@ private void verifyNotification(FileUploadNotification fileUploadNotification, F\n         try (InputStream inputStream = u.openStream())\n         {\n             byte[] testBuf = new byte[(int)fileUploadState.fileLength];\n-            int testLen = inputStream.read(testBuf,  0, (int)fileUploadState.fileLength);\n+            inputStream.read(testBuf,  0, (int)fileUploadState.fileLength);\n+            int testLen = (int)fileUploadState.fileLength;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTQ1Mjg1", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#pullrequestreview-437945285", "createdAt": "2020-06-26T00:34:40Z", "commit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDozNDo0MFrOGpQKCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDozNDo0MFrOGpQKCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwOTUxNQ==", "bodyText": "This status class was used to simplify twin callbacks, but it hid useful information for failure cases. Knowing why a callback fired back with an unsuccessful state is important to log when the test fails", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#discussion_r445909515", "createdAt": "2020-06-26T00:34:40Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceTwinCommon.java", "diffHunk": "@@ -159,25 +160,20 @@ public static Collection inputs() throws Exception\n     // How much to wait until a message makes it to the server, in milliseconds\n     protected static final Integer SEND_TIMEOUT_MILLISECONDS = 60000;\n \n-    public enum STATUS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTQ1NDM1", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#pullrequestreview-437945435", "createdAt": "2020-06-26T00:35:17Z", "commit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDozNToxN1rOGpQKmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDozNToxN1rOGpQKmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwOTY1OA==", "bodyText": "only return the newly created property", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#discussion_r445909658", "createdAt": "2020-06-26T00:35:17Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceTwinCommon.java", "diffHunk": "@@ -230,13 +226,18 @@ public void PropertyCall(String propertyKey, Object propertyValue, Object contex\n             }\n         }\n \n-        public synchronized void createNewReportedProperties(int maximumPropertiesToCreate)\n+        public synchronized Set<Property> createNewReportedProperties(int maximumPropertiesToCreate)\n         {\n+            Set<Property> newProperties = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTQ2ODMy", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#pullrequestreview-437946832", "createdAt": "2020-06-26T00:39:59Z", "commit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDozOTo1OVrOGpQPBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDozOTo1OVrOGpQPBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxMDc4OA==", "bodyText": "It's important to only send this thread's new reported property. If it sends the device's full reported property set, then iothub will receive two twin messages. one with:\n{\n  \"key1\":\"oldValue1\",\n  \"key2\":\"someUpdatedValue2\"\n}\n\nand another with\n{\n  \"key1\":\"someUpdatedValue1\",\n  \"key2\":\"someUpdatedValue2\"\n}\n\nbut iothub may process them out of order, and the resulting twin representation on the service side could be either\n{\n  \"key1\":\"someUpdatedValue1\",\n  \"key2\":\"someUpdatedValue2\"\n}\n\nor the incorrect representation\n{\n  \"key1\":\"oldValue1\",\n  \"key2\":\"someUpdatedValue2\"\n}", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#discussion_r445910788", "createdAt": "2020-06-26T00:39:59Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/twin/ReportedPropertiesTests.java", "diffHunk": "@@ -81,14 +85,14 @@ public void run()\n                 {\n                     try\n                     {\n-                        deviceUnderTest.dCDeviceForTwin.createNewReportedProperties(1);\n-                        internalClient.sendReportedProperties(deviceUnderTest.dCDeviceForTwin.getReportedProp());\n+                        Set<Property> newReportedProperties = deviceUnderTest.dCDeviceForTwin.createNewReportedProperties(1);\n+                        internalClient.sendReportedProperties(newReportedProperties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTQ3MTQ5", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#pullrequestreview-437947149", "createdAt": "2020-06-26T00:41:07Z", "commit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDo0MTowN1rOGpQQKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDo0MTowN1rOGpQQKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxMTA4MQ==", "bodyText": "Again, only send the reported properties that belong to this thread. See above for why", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#discussion_r445911081", "createdAt": "2020-06-26T00:41:07Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/twin/ReportedPropertiesTests.java", "diffHunk": "@@ -153,31 +157,31 @@ public void testUpdateReportedPropertiesMultiThreaded() throws IOException, Inte\n         // send max_prop RP all at once\n         deviceUnderTest.dCDeviceForTwin.createNewReportedProperties(MAX_PROPERTIES_TO_TEST);\n         internalClient.sendReportedProperties(deviceUnderTest.dCDeviceForTwin.getReportedProp());\n-        Thread.sleep(DELAY_BETWEEN_OPERATIONS);\n+        Thread.sleep(REPORTED_PROPERTIES_PROPAGATION_DELAY_MILLISECONDS);\n \n         // act\n         // Update RP\n         for (int i = 0; i < MAX_PROPERTIES_TO_TEST; i++)\n         {\n-        final int index = i;\n-        executor.submit(new Runnable()\n-        {\n-            @Override\n-            public void run()\n+            final int index = i;\n+            executor.submit(new Runnable()\n             {\n-                try\n-                {\n-                    deviceUnderTest.dCDeviceForTwin.updateExistingReportedProperty(index);\n-                    internalClient.sendReportedProperties(deviceUnderTest.dCDeviceForTwin.getReportedProp());\n-                    waitAndVerifyTwinStatusBecomesSuccess();\n-                }\n-                catch (IOException | InterruptedException e)\n+                @Override\n+                public void run()\n                 {\n-                    fail(CorrelationDetailsLoggingAssert.buildExceptionMessage(\"Unexpected exception occurred during sending reported properties: \" + Tools.getStackTraceFromThrowable(e), internalClient));\n+                    try\n+                    {\n+                        Set<Property> updatedProperties = deviceUnderTest.dCDeviceForTwin.updateExistingReportedProperty(index);\n+                        internalClient.sendReportedProperties(updatedProperties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f"}, "originalPosition": 117}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a90d926084ed5c1dae0846ac9c6924f5baa65c2", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/4a90d926084ed5c1dae0846ac9c6924f5baa65c2", "committedDate": "2020-06-26T00:46:31Z", "message": "fix(e2e): fix flakey reported properties tests\n\nMany reported property tests made the mistake of sending reported property updates with updated properties and properties that were not yet updated. As a result, the ordering that IoT Hub handled these messages determined if the test would pass or not. In effect, we would lose reported property updates because one update would accidentally overwrite another sometimes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41072126f2570219c56995a204bdbbd3e74b1b57", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/41072126f2570219c56995a204bdbbd3e74b1b57", "committedDate": "2020-06-26T00:46:31Z", "message": "refactor(iot-dev): Add additional logging context for transport messages\n\nLogs should include the type of transport message (subscribe to twin request, subscribe to twin response, etc.) since that makes logs easier to read"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d6294ffef2494ff287b7876dd1ef7ee9ce249d5", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/1d6294ffef2494ff287b7876dd1ef7ee9ce249d5", "committedDate": "2020-06-26T00:46:31Z", "message": "fix(e2e): Fix android file upload test failures\n\nandroid SDK returns -1 when inputStream.read(...) reads no bytes, but JDKs return 0. As a result, android would fail the file upload tests where the file had 0 bytes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/60d6a8d40bb6ad5df32a76b2e5666f92c6a87d1f", "committedDate": "2020-06-26T00:29:23Z", "message": "fix(e2e): Fix android file upload test failures\n\nandroid SDK returns -1 when inputStream.read(...) reads no bytes, but JDKs return 0. As a result, android would fail the file upload tests where the file had 0 bytes."}, "afterCommit": {"oid": "1d6294ffef2494ff287b7876dd1ef7ee9ce249d5", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/1d6294ffef2494ff287b7876dd1ef7ee9ce249d5", "committedDate": "2020-06-26T00:46:31Z", "message": "fix(e2e): Fix android file upload test failures\n\nandroid SDK returns -1 when inputStream.read(...) reads no bytes, but JDKs return 0. As a result, android would fail the file upload tests where the file had 0 bytes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDg2MTk5", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#pullrequestreview-438486199", "createdAt": "2020-06-26T17:50:45Z", "commit": {"oid": "1d6294ffef2494ff287b7876dd1ef7ee9ce249d5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzo1MDo0NVrOGppohw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzo1MjozMlrOGppryQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNjkxOQ==", "bodyText": "how is this going to affect the callback? is this considered a breaking change?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#discussion_r446326919", "createdAt": "2020-06-26T17:50:45Z", "author": {"login": "azabbasi"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceTwinCommon.java", "diffHunk": "@@ -159,25 +160,20 @@ public static Collection inputs() throws Exception\n     // How much to wait until a message makes it to the server, in milliseconds\n     protected static final Integer SEND_TIMEOUT_MILLISECONDS = 60000;\n \n-    public enum STATUS\n-    {\n-        SUCCESS, FAILURE, UNKNOWN\n-    }\n-\n     public class DeviceTwinStatusCallBack implements IotHubEventCallback\n     {\n         public void execute(IotHubStatusCode status, Object context)\n         {\n             DeviceState state = (DeviceState) context;\n \n-            //On failure, Don't update status any further", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d6294ffef2494ff287b7876dd1ef7ee9ce249d5"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNzc1Mw==", "bodyText": "this method is no longer doing what its name implies does it? it's creating and returning a new set", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#discussion_r446327753", "createdAt": "2020-06-26T17:52:32Z", "author": {"login": "azabbasi"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceTwinCommon.java", "diffHunk": "@@ -259,8 +260,9 @@ public synchronized void updateAllExistingReportedProperties()\n             }\n         }\n \n-        public synchronized void updateExistingReportedProperty(int index)\n+        public synchronized Set<Property> updateExistingReportedProperty(int index)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d6294ffef2494ff287b7876dd1ef7ee9ce249d5"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDk1MzIx", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#pullrequestreview-438495321", "createdAt": "2020-06-26T18:05:29Z", "commit": {"oid": "1d6294ffef2494ff287b7876dd1ef7ee9ce249d5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODowNToyOVrOGpqDYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODowNToyOVrOGpqDYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzc5NQ==", "bodyText": "I see, so it updates the existing and also returns a new set as a return value. fair.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/825#discussion_r446333795", "createdAt": "2020-06-26T18:05:29Z", "author": {"login": "azabbasi"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/setup/DeviceTwinCommon.java", "diffHunk": "@@ -259,8 +260,9 @@ public synchronized void updateAllExistingReportedProperties()\n             }\n         }\n \n-        public synchronized void updateExistingReportedProperty(int index)\n+        public synchronized Set<Property> updateExistingReportedProperty(int index)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNzc1Mw=="}, "originalCommit": {"oid": "1d6294ffef2494ff287b7876dd1ef7ee9ce249d5"}, "originalPosition": 73}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1697, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}