{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1NjczOTY2", "number": 987, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzoyOToyNlrOE1b0Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMDowODowN1rOE1cWLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDY1NzU0OnYy", "diffSide": "RIGHT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzoyOToyNlrOHttZfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzoyOToyNlrOHttZfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY5MTc3NQ==", "bodyText": "return gson.toJson(exportImportDevices) in a single line ?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517691775", "createdAt": "2020-11-04T23:29:26Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "diffHunk": "@@ -0,0 +1,68 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package tests.integration.com.microsoft.azure.sdk.iot.helpers;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonSyntaxException;\n+import com.google.gson.annotations.SerializedName;\n+import com.microsoft.azure.sdk.iot.deps.serializer.ExportImportDeviceParser;\n+\n+import java.util.ArrayList;\n+\n+public class ExportImportDevicesParser {\n+    private static final String DEVICES = \"devices\";\n+    @SerializedName(DEVICES)\n+    Iterable<ExportImportDeviceParser> exportImportDevices;\n+    private transient static Gson gson = new Gson();\n+\n+    /**\n+     * Converts this into json and returns it\n+     * @return the json representation of this\n+     */\n+    public String toJson()\n+    {\n+        String json = gson.toJson(exportImportDevices);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cd5f5e470f7a2bff37b61a502f3a266098313cc"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDY2MDAzOnYy", "diffSide": "RIGHT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzozMDozMVrOHtta8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzozMDozMVrOHtta8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY5MjE0Ng==", "bodyText": "minor: \"the json string used to build the ExportImportDevicesParser\" might sound better.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517692146", "createdAt": "2020-11-04T23:30:31Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "diffHunk": "@@ -0,0 +1,68 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package tests.integration.com.microsoft.azure.sdk.iot.helpers;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonSyntaxException;\n+import com.google.gson.annotations.SerializedName;\n+import com.microsoft.azure.sdk.iot.deps.serializer.ExportImportDeviceParser;\n+\n+import java.util.ArrayList;\n+\n+public class ExportImportDevicesParser {\n+    private static final String DEVICES = \"devices\";\n+    @SerializedName(DEVICES)\n+    Iterable<ExportImportDeviceParser> exportImportDevices;\n+    private transient static Gson gson = new Gson();\n+\n+    /**\n+     * Converts this into json and returns it\n+     * @return the json representation of this\n+     */\n+    public String toJson()\n+    {\n+        String json = gson.toJson(exportImportDevices);\n+        return json;\n+    }\n+\n+    /**\n+     * Empty constructor: Used only to keep GSON happy.\n+     */\n+    public ExportImportDevicesParser()\n+    {\n+        exportImportDevices = new ArrayList<>();\n+    }\n+\n+    /**\n+     * Constructor for an ExportImportDevicesParser that is built using the provided json\n+     * @param json the json string to build the ExportImportDevicesParser out of", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cd5f5e470f7a2bff37b61a502f3a266098313cc"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDY2NDE2OnYy", "diffSide": "RIGHT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzozMjoxN1rOHttdXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzozMjoxN1rOHttdXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY5Mjc2NA==", "bodyText": "minor: This could be moved below line 51", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517692764", "createdAt": "2020-11-04T23:32:17Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "diffHunk": "@@ -0,0 +1,68 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package tests.integration.com.microsoft.azure.sdk.iot.helpers;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonSyntaxException;\n+import com.google.gson.annotations.SerializedName;\n+import com.microsoft.azure.sdk.iot.deps.serializer.ExportImportDeviceParser;\n+\n+import java.util.ArrayList;\n+\n+public class ExportImportDevicesParser {\n+    private static final String DEVICES = \"devices\";\n+    @SerializedName(DEVICES)\n+    Iterable<ExportImportDeviceParser> exportImportDevices;\n+    private transient static Gson gson = new Gson();\n+\n+    /**\n+     * Converts this into json and returns it\n+     * @return the json representation of this\n+     */\n+    public String toJson()\n+    {\n+        String json = gson.toJson(exportImportDevices);\n+        return json;\n+    }\n+\n+    /**\n+     * Empty constructor: Used only to keep GSON happy.\n+     */\n+    public ExportImportDevicesParser()\n+    {\n+        exportImportDevices = new ArrayList<>();\n+    }\n+\n+    /**\n+     * Constructor for an ExportImportDevicesParser that is built using the provided json\n+     * @param json the json string to build the ExportImportDevicesParser out of\n+     */\n+    public ExportImportDevicesParser(String json)\n+    {\n+        if (json == null || json.isEmpty())\n+        {\n+            throw new IllegalArgumentException(\"The provided json cannot be null or empty\");\n+        }\n+\n+        ExportImportDevicesParser exportImportDevicesParser = null;\n+        try\n+        {\n+            exportImportDevicesParser = gson.fromJson(json, ExportImportDevicesParser.class);\n+        }\n+        catch (JsonSyntaxException e)\n+        {\n+            throw new IllegalArgumentException(\"The provided json could not be parsed\");\n+        }\n+\n+        this.exportImportDevices = exportImportDevicesParser.getExportImportDevices();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cd5f5e470f7a2bff37b61a502f3a266098313cc"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDY2NzQ0OnYy", "diffSide": "RIGHT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzozMzo1MVrOHttfTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzozNjo0MlrOHttjOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY5MzI2MA==", "bodyText": "Does final mean we can only set this value once in the constructor? Trying to understand how java works.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517693260", "createdAt": "2020-11-04T23:33:51Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "diffHunk": "@@ -0,0 +1,68 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package tests.integration.com.microsoft.azure.sdk.iot.helpers;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonSyntaxException;\n+import com.google.gson.annotations.SerializedName;\n+import com.microsoft.azure.sdk.iot.deps.serializer.ExportImportDeviceParser;\n+\n+import java.util.ArrayList;\n+\n+public class ExportImportDevicesParser {\n+    private static final String DEVICES = \"devices\";\n+    @SerializedName(DEVICES)\n+    Iterable<ExportImportDeviceParser> exportImportDevices;\n+    private transient static Gson gson = new Gson();\n+\n+    /**\n+     * Converts this into json and returns it\n+     * @return the json representation of this\n+     */\n+    public String toJson()\n+    {\n+        String json = gson.toJson(exportImportDevices);\n+        return json;\n+    }\n+\n+    /**\n+     * Empty constructor: Used only to keep GSON happy.\n+     */\n+    public ExportImportDevicesParser()\n+    {\n+        exportImportDevices = new ArrayList<>();\n+    }\n+\n+    /**\n+     * Constructor for an ExportImportDevicesParser that is built using the provided json\n+     * @param json the json string to build the ExportImportDevicesParser out of\n+     */\n+    public ExportImportDevicesParser(String json)\n+    {\n+        if (json == null || json.isEmpty())\n+        {\n+            throw new IllegalArgumentException(\"The provided json cannot be null or empty\");\n+        }\n+\n+        ExportImportDevicesParser exportImportDevicesParser = null;\n+        try\n+        {\n+            exportImportDevicesParser = gson.fromJson(json, ExportImportDevicesParser.class);\n+        }\n+        catch (JsonSyntaxException e)\n+        {\n+            throw new IllegalArgumentException(\"The provided json could not be parsed\");\n+        }\n+\n+        this.exportImportDevices = exportImportDevicesParser.getExportImportDevices();\n+    }\n+\n+    public final Iterable<ExportImportDeviceParser> getExportImportDevices() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cd5f5e470f7a2bff37b61a502f3a266098313cc"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY5NDI2NA==", "bodyText": "The final modifier simply means that the method cannot be overriden by any class that extends this class. You can set/get this value as many times as you'd like, and whenever you'd like", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517694264", "createdAt": "2020-11-04T23:36:42Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "diffHunk": "@@ -0,0 +1,68 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package tests.integration.com.microsoft.azure.sdk.iot.helpers;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonSyntaxException;\n+import com.google.gson.annotations.SerializedName;\n+import com.microsoft.azure.sdk.iot.deps.serializer.ExportImportDeviceParser;\n+\n+import java.util.ArrayList;\n+\n+public class ExportImportDevicesParser {\n+    private static final String DEVICES = \"devices\";\n+    @SerializedName(DEVICES)\n+    Iterable<ExportImportDeviceParser> exportImportDevices;\n+    private transient static Gson gson = new Gson();\n+\n+    /**\n+     * Converts this into json and returns it\n+     * @return the json representation of this\n+     */\n+    public String toJson()\n+    {\n+        String json = gson.toJson(exportImportDevices);\n+        return json;\n+    }\n+\n+    /**\n+     * Empty constructor: Used only to keep GSON happy.\n+     */\n+    public ExportImportDevicesParser()\n+    {\n+        exportImportDevices = new ArrayList<>();\n+    }\n+\n+    /**\n+     * Constructor for an ExportImportDevicesParser that is built using the provided json\n+     * @param json the json string to build the ExportImportDevicesParser out of\n+     */\n+    public ExportImportDevicesParser(String json)\n+    {\n+        if (json == null || json.isEmpty())\n+        {\n+            throw new IllegalArgumentException(\"The provided json cannot be null or empty\");\n+        }\n+\n+        ExportImportDevicesParser exportImportDevicesParser = null;\n+        try\n+        {\n+            exportImportDevicesParser = gson.fromJson(json, ExportImportDevicesParser.class);\n+        }\n+        catch (JsonSyntaxException e)\n+        {\n+            throw new IllegalArgumentException(\"The provided json could not be parsed\");\n+        }\n+\n+        this.exportImportDevices = exportImportDevicesParser.getExportImportDevices();\n+    }\n+\n+    public final Iterable<ExportImportDeviceParser> getExportImportDevices() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY5MzI2MA=="}, "originalCommit": {"oid": "4cd5f5e470f7a2bff37b61a502f3a266098313cc"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDY5MTAyOnYy", "diffSide": "RIGHT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzo0MzowOFrOHttsRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzo0MzowOFrOHttsRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY5NjU4MQ==", "bodyText": "nit: create constant for this", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517696581", "createdAt": "2020-11-04T23:43:08Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "diffHunk": "@@ -139,6 +153,98 @@ public static Device addDeviceWithRetry(RegistryManager registryManager, Device\n         return ret;\n     }\n \n+    public static void addDevicesWithRetry(List<Device> devices, String connectionString) throws IotHubException, IOException, InterruptedException\n+    {\n+        // IoT hub only allows for bulk adding of devices at up to 100 per request, so take the provided devices iterable\n+        // and break it into 100 devices or smaller chunks\n+        List<Device> subIterable = new ArrayList<>();\n+        List<Device> devicesClone = new ArrayList<>(); //create a clone of the source list so elements can be removed from it instead\n+        devicesClone.addAll(devices);\n+        while (devicesClone.size() > 0)\n+        {\n+            Device device = devicesClone.remove(0);\n+            subIterable.add(device);\n+\n+            // wait until sub list has the Iot Hub limit of 100 devices to add, or until there will be no more devices to add\n+            if (subIterable.size() > 99 || devicesClone.size() <= 0)\n+            {\n+                long startTime = System.currentTimeMillis();\n+                while (System.currentTimeMillis() - startTime < RETRY_TIMEOUT_ON_NETWORK_FAILURE_MILLISECONDS)\n+                {\n+                    try\n+                    {\n+                        addDevices(subIterable, connectionString);\n+                        break;\n+                    }\n+                    catch (UnknownHostException | SocketException | SocketTimeoutException e)\n+                    {\n+                        log.warn(\"Failed to add devices\");\n+                        e.printStackTrace();\n+                        Thread.sleep(WAIT_FOR_RETRY);\n+                        if (System.currentTimeMillis() - startTime >= RETRY_TIMEOUT_ON_NETWORK_FAILURE_MILLISECONDS)\n+                        {\n+                            throw e;\n+                        }\n+                    }\n+\n+                }\n+\n+                // clear the sub list so it can be filled back up again with the next devices to add\n+                subIterable.clear();\n+            }\n+        }\n+    }\n+\n+    // This call mimics what should be a registry manager API for adding devices in bulk. Can be removed once we add support in our\n+    // registry manager for this\n+    public static void addDevices(Iterable<Device> devices, String connectionString) throws IOException, IotHubException {\n+        if (devices == null)\n+        {\n+            throw new IllegalArgumentException(\"devices cannot be null\");\n+        }\n+\n+        IotHubConnectionString iotHubConnectionString = IotHubConnectionString.createConnectionString(connectionString);\n+        URL url = getBulkDeviceAddUrl(iotHubConnectionString);\n+\n+        List<ExportImportDeviceParser> parsers = new ArrayList<>();\n+        for (Device device : devices)\n+        {\n+            ExportImportDeviceParser exportImportDevice = new ExportImportDeviceParser();\n+            exportImportDevice.setId(device.getDeviceId());\n+            AuthenticationParser authenticationParser = new AuthenticationParser();\n+            authenticationParser.setSymmetricKey(new SymmetricKeyParser(device.getSymmetricKey().getPrimaryKey(), device.getSymmetricKey().getSecondaryKey()));\n+            exportImportDevice.setAuthentication(authenticationParser);\n+            exportImportDevice.setImportMode(\"create\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cd5f5e470f7a2bff37b61a502f3a266098313cc"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDcwNDkyOnYy", "diffSide": "RIGHT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzo0OToxMFrOHtt0Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzo1OTo1OVrOHtuB6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY5ODU5OA==", "bodyText": "Should this be if or while? Are we not adding only one to the list or am I missing something?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517698598", "createdAt": "2020-11-04T23:49:10Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "diffHunk": "@@ -139,6 +153,98 @@ public static Device addDeviceWithRetry(RegistryManager registryManager, Device\n         return ret;\n     }\n \n+    public static void addDevicesWithRetry(List<Device> devices, String connectionString) throws IotHubException, IOException, InterruptedException\n+    {\n+        // IoT hub only allows for bulk adding of devices at up to 100 per request, so take the provided devices iterable\n+        // and break it into 100 devices or smaller chunks\n+        List<Device> subIterable = new ArrayList<>();\n+        List<Device> devicesClone = new ArrayList<>(); //create a clone of the source list so elements can be removed from it instead\n+        devicesClone.addAll(devices);\n+        while (devicesClone.size() > 0)\n+        {\n+            Device device = devicesClone.remove(0);\n+            subIterable.add(device);\n+\n+            // wait until sub list has the Iot Hub limit of 100 devices to add, or until there will be no more devices to add\n+            if (subIterable.size() > 99 || devicesClone.size() <= 0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cd5f5e470f7a2bff37b61a502f3a266098313cc"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMTgxNA==", "bodyText": "This if block represents what should happen once a list of 100 devices is ready to be added, or if a list of under 100 devices is ready to add and there are no more devices to add after this list", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517701814", "createdAt": "2020-11-04T23:59:12Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "diffHunk": "@@ -139,6 +153,98 @@ public static Device addDeviceWithRetry(RegistryManager registryManager, Device\n         return ret;\n     }\n \n+    public static void addDevicesWithRetry(List<Device> devices, String connectionString) throws IotHubException, IOException, InterruptedException\n+    {\n+        // IoT hub only allows for bulk adding of devices at up to 100 per request, so take the provided devices iterable\n+        // and break it into 100 devices or smaller chunks\n+        List<Device> subIterable = new ArrayList<>();\n+        List<Device> devicesClone = new ArrayList<>(); //create a clone of the source list so elements can be removed from it instead\n+        devicesClone.addAll(devices);\n+        while (devicesClone.size() > 0)\n+        {\n+            Device device = devicesClone.remove(0);\n+            subIterable.add(device);\n+\n+            // wait until sub list has the Iot Hub limit of 100 devices to add, or until there will be no more devices to add\n+            if (subIterable.size() > 99 || devicesClone.size() <= 0)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY5ODU5OA=="}, "originalCommit": {"oid": "4cd5f5e470f7a2bff37b61a502f3a266098313cc"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMjEyMg==", "bodyText": "The purpose here is so that this method can take a list of arbitrary length, and chunk that list into smaller lists of 100 devices or fewer so that we can use the bulk add service API which has a limit of 100 devices per request", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517702122", "createdAt": "2020-11-04T23:59:59Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "diffHunk": "@@ -139,6 +153,98 @@ public static Device addDeviceWithRetry(RegistryManager registryManager, Device\n         return ret;\n     }\n \n+    public static void addDevicesWithRetry(List<Device> devices, String connectionString) throws IotHubException, IOException, InterruptedException\n+    {\n+        // IoT hub only allows for bulk adding of devices at up to 100 per request, so take the provided devices iterable\n+        // and break it into 100 devices or smaller chunks\n+        List<Device> subIterable = new ArrayList<>();\n+        List<Device> devicesClone = new ArrayList<>(); //create a clone of the source list so elements can be removed from it instead\n+        devicesClone.addAll(devices);\n+        while (devicesClone.size() > 0)\n+        {\n+            Device device = devicesClone.remove(0);\n+            subIterable.add(device);\n+\n+            // wait until sub list has the Iot Hub limit of 100 devices to add, or until there will be no more devices to add\n+            if (subIterable.size() > 99 || devicesClone.size() <= 0)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY5ODU5OA=="}, "originalCommit": {"oid": "4cd5f5e470f7a2bff37b61a502f3a266098313cc"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDczNTk4OnYy", "diffSide": "RIGHT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMDowNDowM1rOHtuGqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMDowNTowOVrOHtuIKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMzMzOA==", "bodyText": "Why is this declared outside of the try/catch?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517703338", "createdAt": "2020-11-05T00:04:03Z", "author": {"login": "drwill-ms"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "diffHunk": "@@ -0,0 +1,66 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package tests.integration.com.microsoft.azure.sdk.iot.helpers;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonSyntaxException;\n+import com.google.gson.annotations.SerializedName;\n+import com.microsoft.azure.sdk.iot.deps.serializer.ExportImportDeviceParser;\n+\n+import java.util.ArrayList;\n+\n+public class ExportImportDevicesParser {\n+    private static final String DEVICES = \"devices\";\n+    @SerializedName(DEVICES)\n+    Iterable<ExportImportDeviceParser> exportImportDevices;\n+    private transient static Gson gson = new Gson();\n+\n+    /**\n+     * Converts this into json and returns it\n+     * @return the json representation of this\n+     */\n+    public String toJson()\n+    {\n+        return gson.toJson(exportImportDevices);\n+    }\n+\n+    /**\n+     * Empty constructor: Used only to keep GSON happy.\n+     */\n+    public ExportImportDevicesParser()\n+    {\n+        exportImportDevices = new ArrayList<>();\n+    }\n+\n+    /**\n+     * Constructor for an ExportImportDevicesParser that is built using the provided json\n+     * @param json the json string used to build the ExportImportDevicesParser\n+     */\n+    public ExportImportDevicesParser(String json)\n+    {\n+        if (json == null || json.isEmpty())\n+        {\n+            throw new IllegalArgumentException(\"The provided json cannot be null or empty\");\n+        }\n+\n+        ExportImportDevicesParser exportImportDevicesParser;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1ea40c4035f3fe5db1388b119914e446be0dc7"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMzcyMQ==", "bodyText": "This can be simplified, sure", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517703721", "createdAt": "2020-11-05T00:05:09Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ExportImportDevicesParser.java", "diffHunk": "@@ -0,0 +1,66 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package tests.integration.com.microsoft.azure.sdk.iot.helpers;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonSyntaxException;\n+import com.google.gson.annotations.SerializedName;\n+import com.microsoft.azure.sdk.iot.deps.serializer.ExportImportDeviceParser;\n+\n+import java.util.ArrayList;\n+\n+public class ExportImportDevicesParser {\n+    private static final String DEVICES = \"devices\";\n+    @SerializedName(DEVICES)\n+    Iterable<ExportImportDeviceParser> exportImportDevices;\n+    private transient static Gson gson = new Gson();\n+\n+    /**\n+     * Converts this into json and returns it\n+     * @return the json representation of this\n+     */\n+    public String toJson()\n+    {\n+        return gson.toJson(exportImportDevices);\n+    }\n+\n+    /**\n+     * Empty constructor: Used only to keep GSON happy.\n+     */\n+    public ExportImportDevicesParser()\n+    {\n+        exportImportDevices = new ArrayList<>();\n+    }\n+\n+    /**\n+     * Constructor for an ExportImportDevicesParser that is built using the provided json\n+     * @param json the json string used to build the ExportImportDevicesParser\n+     */\n+    public ExportImportDevicesParser(String json)\n+    {\n+        if (json == null || json.isEmpty())\n+        {\n+            throw new IllegalArgumentException(\"The provided json cannot be null or empty\");\n+        }\n+\n+        ExportImportDevicesParser exportImportDevicesParser;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMzMzOA=="}, "originalCommit": {"oid": "bb1ea40c4035f3fe5db1388b119914e446be0dc7"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDc0MDcyOnYy", "diffSide": "RIGHT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMDowNjowOFrOHtuJPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMDoxMDowMVrOHtuNfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMzk5Ng==", "bodyText": "comparison seems numerically backwards (checking the large number before the small number), but maybe that's just me", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517703996", "createdAt": "2020-11-05T00:06:08Z", "author": {"login": "drwill-ms"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "diffHunk": "@@ -139,6 +153,99 @@ public static Device addDeviceWithRetry(RegistryManager registryManager, Device\n         return ret;\n     }\n \n+    public static void addDevicesWithRetry(List<Device> devices, String connectionString) throws IotHubException, IOException, InterruptedException\n+    {\n+        // IoT hub only allows for bulk adding of devices at up to 100 per request, so take the provided devices iterable\n+        // and break it into 100 devices or smaller chunks\n+        List<Device> subIterable = new ArrayList<>();\n+        List<Device> devicesClone = new ArrayList<>(); //create a clone of the source list so elements can be removed from it instead\n+        devicesClone.addAll(devices);\n+        while (devicesClone.size() > 0)\n+        {\n+            Device device = devicesClone.remove(0);\n+            subIterable.add(device);\n+\n+            // wait until sub list has the Iot Hub limit of 100 devices to add, or until there will be no more devices to add\n+            if (subIterable.size() > 99 || devicesClone.size() <= 0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1ea40c4035f3fe5db1388b119914e446be0dc7"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwNTA4NQ==", "bodyText": "I'm not sure I follow which half of the if statement you mean here", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517705085", "createdAt": "2020-11-05T00:10:01Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "diffHunk": "@@ -139,6 +153,99 @@ public static Device addDeviceWithRetry(RegistryManager registryManager, Device\n         return ret;\n     }\n \n+    public static void addDevicesWithRetry(List<Device> devices, String connectionString) throws IotHubException, IOException, InterruptedException\n+    {\n+        // IoT hub only allows for bulk adding of devices at up to 100 per request, so take the provided devices iterable\n+        // and break it into 100 devices or smaller chunks\n+        List<Device> subIterable = new ArrayList<>();\n+        List<Device> devicesClone = new ArrayList<>(); //create a clone of the source list so elements can be removed from it instead\n+        devicesClone.addAll(devices);\n+        while (devicesClone.size() > 0)\n+        {\n+            Device device = devicesClone.remove(0);\n+            subIterable.add(device);\n+\n+            // wait until sub list has the Iot Hub limit of 100 devices to add, or until there will be no more devices to add\n+            if (subIterable.size() > 99 || devicesClone.size() <= 0)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMzk5Ng=="}, "originalCommit": {"oid": "bb1ea40c4035f3fe5db1388b119914e446be0dc7"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDc0MjE2OnYy", "diffSide": "RIGHT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMDowNjo1N1rOHtuKCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMDowOToyOVrOHtuM3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwNDIwMQ==", "bodyText": "Well that is something interesting that Java can do", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517704201", "createdAt": "2020-11-05T00:06:57Z", "author": {"login": "drwill-ms"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "diffHunk": "@@ -139,6 +153,99 @@ public static Device addDeviceWithRetry(RegistryManager registryManager, Device\n         return ret;\n     }\n \n+    public static void addDevicesWithRetry(List<Device> devices, String connectionString) throws IotHubException, IOException, InterruptedException\n+    {\n+        // IoT hub only allows for bulk adding of devices at up to 100 per request, so take the provided devices iterable\n+        // and break it into 100 devices or smaller chunks\n+        List<Device> subIterable = new ArrayList<>();\n+        List<Device> devicesClone = new ArrayList<>(); //create a clone of the source list so elements can be removed from it instead\n+        devicesClone.addAll(devices);\n+        while (devicesClone.size() > 0)\n+        {\n+            Device device = devicesClone.remove(0);\n+            subIterable.add(device);\n+\n+            // wait until sub list has the Iot Hub limit of 100 devices to add, or until there will be no more devices to add\n+            if (subIterable.size() > 99 || devicesClone.size() <= 0)\n+            {\n+                long startTime = System.currentTimeMillis();\n+                while (System.currentTimeMillis() - startTime < RETRY_TIMEOUT_ON_NETWORK_FAILURE_MILLISECONDS)\n+                {\n+                    try\n+                    {\n+                        addDevices(subIterable, connectionString);\n+                        break;\n+                    }\n+                    catch (UnknownHostException | SocketException | SocketTimeoutException e)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1ea40c4035f3fe5db1388b119914e446be0dc7"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwNDkyNw==", "bodyText": "I like it, personally", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517704927", "createdAt": "2020-11-05T00:09:29Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/Tools.java", "diffHunk": "@@ -139,6 +153,99 @@ public static Device addDeviceWithRetry(RegistryManager registryManager, Device\n         return ret;\n     }\n \n+    public static void addDevicesWithRetry(List<Device> devices, String connectionString) throws IotHubException, IOException, InterruptedException\n+    {\n+        // IoT hub only allows for bulk adding of devices at up to 100 per request, so take the provided devices iterable\n+        // and break it into 100 devices or smaller chunks\n+        List<Device> subIterable = new ArrayList<>();\n+        List<Device> devicesClone = new ArrayList<>(); //create a clone of the source list so elements can be removed from it instead\n+        devicesClone.addAll(devices);\n+        while (devicesClone.size() > 0)\n+        {\n+            Device device = devicesClone.remove(0);\n+            subIterable.add(device);\n+\n+            // wait until sub list has the Iot Hub limit of 100 devices to add, or until there will be no more devices to add\n+            if (subIterable.size() > 99 || devicesClone.size() <= 0)\n+            {\n+                long startTime = System.currentTimeMillis();\n+                while (System.currentTimeMillis() - startTime < RETRY_TIMEOUT_ON_NETWORK_FAILURE_MILLISECONDS)\n+                {\n+                    try\n+                    {\n+                        addDevices(subIterable, connectionString);\n+                        break;\n+                    }\n+                    catch (UnknownHostException | SocketException | SocketTimeoutException e)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwNDIwMQ=="}, "originalCommit": {"oid": "bb1ea40c4035f3fe5db1388b119914e446be0dc7"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDc0NDE1OnYy", "diffSide": "RIGHT", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/rules/ThrottleResistantTestRule.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMDowODowN1rOHtuLOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMDowOToxMlrOHtuMcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwNDUwNA==", "bodyText": "I only see 2 instances of {}, but 3 parameters. Is the exception parameter a special one?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517704504", "createdAt": "2020-11-05T00:08:07Z", "author": {"login": "drwill-ms"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/rules/ThrottleResistantTestRule.java", "diffHunk": "@@ -49,6 +50,19 @@ public void evaluate() throws Throwable {\n                     log.warn(\"Thottling detected in test {}, waiting for {} milliseconds and then re-running the test\", description.getMethodName(), THROTTLING_RETRY_DELAY_MILLISECONDS, e);\n                     Thread.sleep(THROTTLING_RETRY_DELAY_MILLISECONDS);\n                 }\n+                catch (Exception e)\n+                {\n+                    if (e.getMessage() != null && e.getMessage().toLowerCase().contains(CONNECTION_REFUSED))\n+                    {\n+                        log.warn(\"Thottling detected in test {}, waiting for {} milliseconds and then re-running the test\", description.getMethodName(), THROTTLING_RETRY_DELAY_MILLISECONDS, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1ea40c4035f3fe5db1388b119914e446be0dc7"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwNDgxOQ==", "bodyText": "The exception parameter is indeed special here. The log.warn (and log.error) will handle this exception without needing a {}", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/987#discussion_r517704819", "createdAt": "2020-11-05T00:09:12Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/rules/ThrottleResistantTestRule.java", "diffHunk": "@@ -49,6 +50,19 @@ public void evaluate() throws Throwable {\n                     log.warn(\"Thottling detected in test {}, waiting for {} milliseconds and then re-running the test\", description.getMethodName(), THROTTLING_RETRY_DELAY_MILLISECONDS, e);\n                     Thread.sleep(THROTTLING_RETRY_DELAY_MILLISECONDS);\n                 }\n+                catch (Exception e)\n+                {\n+                    if (e.getMessage() != null && e.getMessage().toLowerCase().contains(CONNECTION_REFUSED))\n+                    {\n+                        log.warn(\"Thottling detected in test {}, waiting for {} milliseconds and then re-running the test\", description.getMethodName(), THROTTLING_RETRY_DELAY_MILLISECONDS, e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwNDUwNA=="}, "originalCommit": {"oid": "bb1ea40c4035f3fe5db1388b119914e446be0dc7"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2765, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}