{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NTc1NTk5", "number": 778, "title": "fix(iot-dev): Fix issue where amqp layer didn't recognize an ack to a subscription message that it sent", "bodyText": "The recent twin array support changes introduced sending a desired properties subscription message each time the twin sender link opened. However, once the service acknowledges that message, our SDK logged an exception as it didn't correlate the ack back to the subscription message it sent. This PR adds a callback so that the top AMQP layer can be notified each time a lower level sends a subscription message", "createdAt": "2020-05-13T19:48:27Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778", "merged": true, "mergeCommit": {"oid": "942cf437e1dadeb3ab43d72c552666678c25aff6"}, "closed": true, "closedAt": "2020-05-14T05:13:24Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg-SZYAH2gAyNDE3NTc1NTk5OjJiYzY2NmEyZWM2MTBhMGFlMmY4MzJjMDdhNDVjMzllZGRkYzMwMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchCXVkgFqTQxMTM4ODIxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/2bc666a2ec610a0ae2f832c07a45c39edddc3008", "committedDate": "2020-05-13T19:45:52Z", "message": "fix(iot-dev): Fix issue where amqp layer didn't recognize a subscription message that it sent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjQ3NjAy", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#pullrequestreview-411247602", "createdAt": "2020-05-13T19:49:05Z", "commit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTo0OTowNVrOGVBDyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTo0OTowNVrOGVBDyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5MDYzMw==", "bodyText": "Without the above changes, this ack handling logic would fall to the else block and log an error", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424690633", "createdAt": "2020-05-13T19:49:05Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -688,6 +689,11 @@ else if (remoteState instanceof Modified || remoteState instanceof Released || r\n                             this.listener.onMessageSent(inProgressMessages.remove(deliveryTag), transportException);\n                         }\n                     }\n+                    else if (this.inProgressSubscriptionMessages.containsKey(deliveryTag))\n+                    {\n+                        SubscriptionType subscriptionType = this.inProgressSubscriptionMessages.remove(deliveryTag);\n+                        log.debug(\"Successfully re-sent amqp subscription message of type {}\", subscriptionType);\n+                    }\n                     else", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjQ4OTA1", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#pullrequestreview-411248905", "createdAt": "2020-05-13T19:50:51Z", "commit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTo1MDo1MVrOGVBHvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTo1MDo1MVrOGVBHvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5MTY0NQ==", "bodyText": "This new map will track outstanding subscription messages. I couldn't re-use the inProgressMessages map because there is no transport agnostic message to add to that map since we are creating the amqp message directly. Plus, messages in that map are expected to have a matching message in the IotHubTransport layer, which isn't the case for this special amqp-specific subscription message", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424691645", "createdAt": "2020-05-13T19:50:51Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -66,6 +66,7 @@\n     private final static int MAX_MESSAGE_PAYLOAD_SIZE = 256*1024; //max IoT Hub message size is 256 kb, so amqp websocket layer should buffer at least that much space\n     private final Boolean useWebSockets;\n     private final Map<Integer, com.microsoft.azure.sdk.iot.device.Message> inProgressMessages = new ConcurrentHashMap<>();\n+    private final Map<Integer, SubscriptionType> inProgressSubscriptionMessages = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjQ5MzEw", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#pullrequestreview-411249310", "createdAt": "2020-05-13T19:51:27Z", "commit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTo1MToyOFrOGVBI-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTo1MToyOFrOGVBI-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5MTk2Mw==", "bodyText": "This is orthogonal to the actual PR, but this log message had one too many spots for parameters, so I got rid of it", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424691963", "createdAt": "2020-05-13T19:51:28Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsDeviceOperations.java", "diffHunk": "@@ -394,7 +394,7 @@ protected boolean onLinkRemoteOpen(String linkName)\n         if (linkName.equals(this.getSenderLinkTag()))\n         {\n             this.amqpsSendLinkState = AmqpsDeviceOperationLinkState.OPENED;\n-            this.log.debug(\"{} sender link with link correlation id {} was successfully opened {}\", getLinkInstanceType(), this.linkCorrelationId);\n+            this.log.debug(\"{} sender link with link correlation id {} was successfully opened\", getLinkInstanceType(), this.linkCorrelationId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjY5Mzgz", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#pullrequestreview-411269383", "createdAt": "2020-05-13T20:20:18Z", "commit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDoyMDoxOFrOGVCFkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDoyMDoxOFrOGVCFkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwNzQ3Mg==", "bodyText": "Update constructor comments to reflect new parameter.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424707472", "createdAt": "2020-05-13T20:20:18Z", "author": {"login": "barustum"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionDeviceOperation.java", "diffHunk": "@@ -29,14 +29,16 @@\n \n     private List<UUID> cbsCorrelationIdList = Collections.synchronizedList(new ArrayList<UUID>());\n \n+    private SubscriptionMessageRequestSentCallback subscriptionMessageRequestSentCallback;\n+\n     /**\n      * Create logical device entity to handle all operation.\n      *\n      * @param deviceClientConfig the configuration of teh device.\n      * @param amqpsDeviceAuthentication the authentication object associated with the device.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjY5NDQ3", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#pullrequestreview-411269447", "createdAt": "2020-05-13T20:20:23Z", "commit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDoyMDoyM1rOGVCFxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDoyMDoyM1rOGVCFxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwNzUyNQ==", "bodyText": "subscriptionType instead of deviceOperationType?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424707525", "createdAt": "2020-05-13T20:20:23Z", "author": {"login": "azabbasi"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/SubscriptionMessageRequestSentCallback.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package com.microsoft.azure.sdk.iot.device.transport.amqps;\n+\n+import com.microsoft.azure.sdk.iot.device.DeviceTwin.DeviceOperations;\n+\n+public interface SubscriptionMessageRequestSentCallback\n+{\n+    void onSubscriptionMessageSent(int deliveryTag, SubscriptionType deviceOperationType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjcwNjcy", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#pullrequestreview-411270672", "createdAt": "2020-05-13T20:22:18Z", "commit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDoyMjoxOFrOGVCJlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDoyMjoxOFrOGVCJlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwODUwMQ==", "bodyText": "Update comment header to include new parameter", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#discussion_r424708501", "createdAt": "2020-05-13T20:22:18Z", "author": {"login": "barustum"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionManager.java", "diffHunk": "@@ -24,14 +24,15 @@\n \n     private AmqpsDeviceAuthentication amqpsDeviceAuthentication;\n     private ArrayList<AmqpsSessionDeviceOperation> amqpsDeviceSessionList = new ArrayList<>();\n+    private SubscriptionMessageRequestSentCallback subscriptionMessageRequestSentCallback;\n \n     /**\n      * Constructor that takes a device configuration.\n      *\n      * @param deviceClientConfig the device configuration to use for \n      *                           session management.\n      */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjcwNzI4", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#pullrequestreview-411270728", "createdAt": "2020-05-13T20:22:23Z", "commit": {"oid": "2bc666a2ec610a0ae2f832c07a45c39edddc3008"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c70e7f7ab97f6bb11aae59522ad4b9dee7ea653", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/5c70e7f7ab97f6bb11aae59522ad4b9dee7ea653", "committedDate": "2020-05-13T20:25:46Z", "message": "cr comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjczNjg0", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#pullrequestreview-411273684", "createdAt": "2020-05-13T20:26:52Z", "commit": {"oid": "5c70e7f7ab97f6bb11aae59522ad4b9dee7ea653"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "152bbe2c168a51800f49dc967329769ef9876ac9", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/152bbe2c168a51800f49dc967329769ef9876ac9", "committedDate": "2020-05-13T23:36:38Z", "message": "squash"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzg4MjEy", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/778#pullrequestreview-411388212", "createdAt": "2020-05-14T00:30:53Z", "commit": {"oid": "152bbe2c168a51800f49dc967329769ef9876ac9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1637, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}