{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NTU2NTM0", "number": 858, "title": "fix(iot-dev): Fix issue with ordering of queue within amqp layer", "bodyText": "If two messages are queued, one for subscribing to twin, and one for getting a twin, and the latter is queued first, then the SDK gets stuck trying to send the get twin request repeatedly without trying to send the subscribe message first.\nThis change ensures that any message that fails to send is placed at the back of the queue and that the next message stays at the front of the queue. This helps to protect the SDK from states where some messages need to be sent before others, but never are\nOne of our edge e2e tests was occasionally failing due to this bug.", "createdAt": "2020-07-10T17:26:40Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/858", "merged": true, "mergeCommit": {"oid": "fc2ed8189b341e4df47d49a07269067a88a123ab"}, "closed": true, "closedAt": "2020-07-11T15:32:52Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcznDYwgH2gAyNDQ3NTU2NTM0OjU0YjhiOTZkMGNiMmJjMmEwNzY2NTI3ZGVjN2RhMGU1MWU5ZDM0MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczrz97AFqTQ0Njc0MTE5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "54b8b96d0cb2bc2a0766527dec7da0e51e9d3431", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/54b8b96d0cb2bc2a0766527dec7da0e51e9d3431", "committedDate": "2020-07-10T17:26:13Z", "message": "fix(iot-dev): Fix issue with ordering of queue within amqp layer\n\nIf two messages are queued, one for subscribing to twin, and one for getting a twin, and the latter is queued first, then the SDK gets stuck trying to send the get twin request repeatedly without trying to send the subscribe message first.\n\nThis change ensures that any message that is failed to send is placed at the back of the queue and that the next message stays at the front of the queue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NTc0MjMy", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/858#pullrequestreview-446574232", "createdAt": "2020-07-10T17:27:53Z", "commit": {"oid": "54b8b96d0cb2bc2a0766527dec7da0e51e9d3431"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzoyNzo1M1rOGv_gsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzoyNzo1M1rOGv_gsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk3NjgxOQ==", "bodyText": "It's important to return here before the next call to messagesToSend.poll() as it keeps the next message to send at the front of the queue. Before this change, if exactly two messages are queued, and the first fails to send (if it is a get twin request and twin links aren't up yet, for instance), then the second message will never send. The second message would be polled and re-queued at the back, and the whole process would run again and fail again indefinitely", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/858#discussion_r452976819", "createdAt": "2020-07-10T17:27:53Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -530,18 +530,18 @@ private void addProxyLayer(Transport transport, String hostName)\n     private void sendQueuedMessages()\n     {\n         int messagesAttemptedToBeProcessed = 0;\n-        boolean lastSendSucceeded = true;\n         Message message = messagesToSend.poll();\n-        while (message != null && messagesAttemptedToBeProcessed < MAX_MESSAGES_TO_SEND_PER_CALLBACK && lastSendSucceeded)\n+        while (message != null && messagesAttemptedToBeProcessed < MAX_MESSAGES_TO_SEND_PER_CALLBACK)\n         {\n             messagesAttemptedToBeProcessed++;\n-            lastSendSucceeded = sendQueuedMessage(message);\n+            boolean lastSendSucceeded = sendQueuedMessage(message);\n \n             if (!lastSendSucceeded)\n             {\n                 //message failed to send, likely due to lack of link credit available. Re-queue and try again later\n                 log.trace(\"Amqp message failed to send, adding it back to messages to send queue ({})\", message);\n                 messagesToSend.add(message);\n+                return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b8b96d0cb2bc2a0766527dec7da0e51e9d3431"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15e995bd2f64fd807c514465d1204a0e609276f5", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/15e995bd2f64fd807c514465d1204a0e609276f5", "committedDate": "2020-07-10T20:10:24Z", "message": "Merge branch 'master' into timtay/Ordering"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzQxMTk1", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/858#pullrequestreview-446741195", "createdAt": "2020-07-10T22:58:55Z", "commit": {"oid": "15e995bd2f64fd807c514465d1204a0e609276f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1751, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}