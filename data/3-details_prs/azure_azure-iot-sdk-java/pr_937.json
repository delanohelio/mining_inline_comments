{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNjM5MjE1", "number": 937, "title": "e2e(digitaltwin): add get digital twin tests", "bodyText": "Adding e2e test for get digital twin", "createdAt": "2020-09-26T22:42:54Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937", "merged": true, "mergeCommit": {"oid": "e40675eea553f1819bb92c45ce5eef04edff0b89"}, "closed": true, "closedAt": "2020-09-28T20:03:04Z", "author": {"login": "bikamani"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMyORTAH2gAyNDkzNjM5MjE1OjVjMWRkNzg2MTEyYTI3YTY3MDRmYjk5MDY1NGIxOTMyMzA5NjkzMWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNZPN_AH2gAyNDkzNjM5MjE1OmUxZTI2YTJmYzhmMTM1MDNiMjhhZDYyZWRlZmU1YThkNTFjZDM0ZjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c", "author": {"user": {"login": "bikamani", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/5c1dd786112a27a6704fb990654b19323096931c", "committedDate": "2020-09-26T22:35:10Z", "message": "add get e2e test:"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MjYzNDcw", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#pullrequestreview-497263470", "createdAt": "2020-09-28T07:48:04Z", "commit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwNzo0ODowNFrOHYyIsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwNzo0ODowNFrOHYyIsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc0OTI5Ng==", "bodyText": "nit: change prefix to DigitalTwinClientE2ETests, or DigitalTwinServiceClientTests_ to match file name", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#discussion_r495749296", "createdAt": "2020-09-28T07:48:04Z", "author": {"login": "barustum"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/digitaltwin/DigitalTwinServiceClientTests.java", "diffHunk": "@@ -1,38 +1,90 @@\n package tests.integration.com.microsoft.azure.sdk.iot.digitaltwin;\n \n-import com.microsoft.azure.sdk.iot.device.exceptions.TransportException;\n+import com.microsoft.azure.sdk.iot.device.IotHubClientProtocol;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.DigitalTwinAsyncClient;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.DigitalTwinClient;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.models.BasicDigitalTwin;\n+import com.microsoft.azure.sdk.iot.service.exceptions.IotHubException;\n+import lombok.extern.slf4j.Slf4j;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n import org.junit.Test;\n+import org.junit.rules.Timeout;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.helpers.E2ETestConstants;\n+import tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.simulator.TestDigitalTwinDevice;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.Tools;\n import tests.integration.com.microsoft.azure.sdk.iot.helpers.annotations.DigitalTwinTest;\n \n import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.util.Collection;\n+import java.util.UUID;\n+\n+import static com.microsoft.azure.sdk.iot.device.IotHubClientProtocol.MQTT;\n+import static com.microsoft.azure.sdk.iot.device.IotHubClientProtocol.MQTT_WS;\n+import static java.util.Arrays.asList;\n+import static org.junit.Assert.assertEquals;\n \n @DigitalTwinTest\n+@Slf4j\n+@RunWith(Parameterized.class)\n public class DigitalTwinServiceClientTests {\n \n+    protected static String iotHubConnectionString = \"\";\n+    private TestDigitalTwinDevice testDevice;\n+    private DigitalTwinClient digitalTwinClient = null;\n+    private static final String DEVICE_ID_PREFIX = \"DigitalTwinE2ETests_\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NjgyMjY2", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#pullrequestreview-497682266", "createdAt": "2020-09-28T16:06:35Z", "commit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjowNjozNVrOHZFgxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjowNjozNVrOHZFgxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2Njc1OQ==", "bodyText": "Would suggest renaming to DigitalTwinTestDevice", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#discussion_r496066759", "createdAt": "2020-09-28T16:06:35Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/digitaltwin/simulator/TestDigitalTwinDevice.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.simulator;\n+\n+import com.microsoft.azure.sdk.iot.device.ClientOptions;\n+import com.microsoft.azure.sdk.iot.device.DeviceClient;\n+import com.microsoft.azure.sdk.iot.device.IotHubClientProtocol;\n+import com.microsoft.azure.sdk.iot.service.Device;\n+import com.microsoft.azure.sdk.iot.service.RegistryManager;\n+import com.microsoft.azure.sdk.iot.service.auth.AuthenticationType;\n+import com.microsoft.azure.sdk.iot.service.exceptions.IotHubException;\n+import lombok.Getter;\n+import lombok.NonNull;\n+import lombok.extern.slf4j.Slf4j;\n+import tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.helpers.E2ETestConstants;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.Tools;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+\n+@Slf4j\n+@Getter\n+public class TestDigitalTwinDevice {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NjgzMDM3", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#pullrequestreview-497683037", "createdAt": "2020-09-28T16:07:25Z", "commit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjowNzoyNlrOHZFi8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjowNzoyNlrOHZFi8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2NzMxMg==", "bodyText": "nit - Everywhere else (samples) we are using this - IOTHUB_CONNECTON_STRING so we can follow that convention.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#discussion_r496067312", "createdAt": "2020-09-28T16:07:26Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/digitaltwin/simulator/TestDigitalTwinDevice.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.simulator;\n+\n+import com.microsoft.azure.sdk.iot.device.ClientOptions;\n+import com.microsoft.azure.sdk.iot.device.DeviceClient;\n+import com.microsoft.azure.sdk.iot.device.IotHubClientProtocol;\n+import com.microsoft.azure.sdk.iot.service.Device;\n+import com.microsoft.azure.sdk.iot.service.RegistryManager;\n+import com.microsoft.azure.sdk.iot.service.auth.AuthenticationType;\n+import com.microsoft.azure.sdk.iot.service.exceptions.IotHubException;\n+import lombok.Getter;\n+import lombok.NonNull;\n+import lombok.extern.slf4j.Slf4j;\n+import tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.helpers.E2ETestConstants;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.Tools;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+\n+@Slf4j\n+@Getter\n+public class TestDigitalTwinDevice {\n+    private static final String IOT_HUB_CONNECTION_STRING = Tools.retrieveEnvironmentVariableValue(E2ETestConstants.IOT_HUB_CONNECTION_STRING_ENV_VAR_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3Njg0MjI5", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#pullrequestreview-497684229", "createdAt": "2020-09-28T16:08:55Z", "commit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjowODo1NVrOHZFmRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjowODo1NVrOHZFmRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2ODE2Nw==", "bodyText": "Do we need to register a callback at all for change of status? We will mostly need something for commands though.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#discussion_r496068167", "createdAt": "2020-09-28T16:08:55Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/digitaltwin/simulator/TestDigitalTwinDevice.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.simulator;\n+\n+import com.microsoft.azure.sdk.iot.device.ClientOptions;\n+import com.microsoft.azure.sdk.iot.device.DeviceClient;\n+import com.microsoft.azure.sdk.iot.device.IotHubClientProtocol;\n+import com.microsoft.azure.sdk.iot.service.Device;\n+import com.microsoft.azure.sdk.iot.service.RegistryManager;\n+import com.microsoft.azure.sdk.iot.service.auth.AuthenticationType;\n+import com.microsoft.azure.sdk.iot.service.exceptions.IotHubException;\n+import lombok.Getter;\n+import lombok.NonNull;\n+import lombok.extern.slf4j.Slf4j;\n+import tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.helpers.E2ETestConstants;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.Tools;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+\n+@Slf4j\n+@Getter\n+public class TestDigitalTwinDevice {\n+    private static final String IOT_HUB_CONNECTION_STRING = Tools.retrieveEnvironmentVariableValue(E2ETestConstants.IOT_HUB_CONNECTION_STRING_ENV_VAR_NAME);\n+\n+    private String deviceId;\n+    private DeviceClient deviceClient;\n+\n+    public TestDigitalTwinDevice(@NonNull String deviceId, @NonNull IotHubClientProtocol protocol) throws IotHubException, IOException, URISyntaxException {\n+        if (!protocol.equals(IotHubClientProtocol.MQTT) && !protocol.equals(IotHubClientProtocol.MQTT_WS)) {\n+            throw new IllegalArgumentException(\"Supported protocols for DigitalTwin are MQTT, MQTT_WS\");\n+        }\n+            this.deviceId = deviceId;\n+            this.deviceClient = createDeviceClient(protocol);\n+            this.deviceClient.registerConnectionStatusChangeCallback((iotHubConnectionStatus, iotHubConnectionStatusChangeReason, throwable, o) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3Njg5MzE1", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#pullrequestreview-497689315", "createdAt": "2020-09-28T16:15:08Z", "commit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjoxNTowOFrOHZF2Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjoxNTowOFrOHZF2Bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MjE5OQ==", "bodyText": "We won't need to add @Afte in this file if we reuse TwinPnPTestInstance  but we should try to use things like - @after and @before for setup and cleanup", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#discussion_r496072199", "createdAt": "2020-09-28T16:15:08Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/digitaltwin/simulator/TestDigitalTwinDevice.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.simulator;\n+\n+import com.microsoft.azure.sdk.iot.device.ClientOptions;\n+import com.microsoft.azure.sdk.iot.device.DeviceClient;\n+import com.microsoft.azure.sdk.iot.device.IotHubClientProtocol;\n+import com.microsoft.azure.sdk.iot.service.Device;\n+import com.microsoft.azure.sdk.iot.service.RegistryManager;\n+import com.microsoft.azure.sdk.iot.service.auth.AuthenticationType;\n+import com.microsoft.azure.sdk.iot.service.exceptions.IotHubException;\n+import lombok.Getter;\n+import lombok.NonNull;\n+import lombok.extern.slf4j.Slf4j;\n+import tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.helpers.E2ETestConstants;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.Tools;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+\n+@Slf4j\n+@Getter\n+public class TestDigitalTwinDevice {\n+    private static final String IOT_HUB_CONNECTION_STRING = Tools.retrieveEnvironmentVariableValue(E2ETestConstants.IOT_HUB_CONNECTION_STRING_ENV_VAR_NAME);\n+\n+    private String deviceId;\n+    private DeviceClient deviceClient;\n+\n+    public TestDigitalTwinDevice(@NonNull String deviceId, @NonNull IotHubClientProtocol protocol) throws IotHubException, IOException, URISyntaxException {\n+        if (!protocol.equals(IotHubClientProtocol.MQTT) && !protocol.equals(IotHubClientProtocol.MQTT_WS)) {\n+            throw new IllegalArgumentException(\"Supported protocols for DigitalTwin are MQTT, MQTT_WS\");\n+        }\n+            this.deviceId = deviceId;\n+            this.deviceClient = createDeviceClient(protocol);\n+            this.deviceClient.registerConnectionStatusChangeCallback((iotHubConnectionStatus, iotHubConnectionStatusChangeReason, throwable, o) -> {\n+                TestDigitalTwinDevice testDigitalTwinDevice = (TestDigitalTwinDevice) o;\n+                log.debug(\"DeviceID={}; status={}, reason={}\", testDigitalTwinDevice.getDeviceId(), iotHubConnectionStatus, iotHubConnectionStatusChangeReason);\n+            }, this);\n+            log.debug(\"Created device: {}\", deviceId);\n+        }\n+\n+    private DeviceClient createDeviceClient(IotHubClientProtocol protocol) throws IOException, IotHubException, URISyntaxException {\n+        RegistryManager registryManager = RegistryManager.createFromConnectionString(IOT_HUB_CONNECTION_STRING);\n+        ClientOptions options = new ClientOptions();\n+        options.setModelId(E2ETestConstants.MODEL_ID);\n+        Device device = Device.createDevice(deviceId, AuthenticationType.SAS);\n+        Device registeredDevice = registryManager.addDevice(device);\n+        String deviceConnectionString = registryManager.getDeviceConnectionString(registeredDevice);\n+        registryManager.close();\n+\n+        return new DeviceClient(deviceConnectionString, protocol, options);\n+    }\n+\n+    public void closeAndDeleteDevice() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NjkxNzUw", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#pullrequestreview-497691750", "createdAt": "2020-09-28T16:17:55Z", "commit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjoxNzo1NVrOHZF9aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjoxNzo1NVrOHZF9aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NDA4OQ==", "bodyText": "We should create just one static instance of registryManager and use that.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#discussion_r496074089", "createdAt": "2020-09-28T16:17:55Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/digitaltwin/simulator/TestDigitalTwinDevice.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.simulator;\n+\n+import com.microsoft.azure.sdk.iot.device.ClientOptions;\n+import com.microsoft.azure.sdk.iot.device.DeviceClient;\n+import com.microsoft.azure.sdk.iot.device.IotHubClientProtocol;\n+import com.microsoft.azure.sdk.iot.service.Device;\n+import com.microsoft.azure.sdk.iot.service.RegistryManager;\n+import com.microsoft.azure.sdk.iot.service.auth.AuthenticationType;\n+import com.microsoft.azure.sdk.iot.service.exceptions.IotHubException;\n+import lombok.Getter;\n+import lombok.NonNull;\n+import lombok.extern.slf4j.Slf4j;\n+import tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.helpers.E2ETestConstants;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.Tools;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+\n+@Slf4j\n+@Getter\n+public class TestDigitalTwinDevice {\n+    private static final String IOT_HUB_CONNECTION_STRING = Tools.retrieveEnvironmentVariableValue(E2ETestConstants.IOT_HUB_CONNECTION_STRING_ENV_VAR_NAME);\n+\n+    private String deviceId;\n+    private DeviceClient deviceClient;\n+\n+    public TestDigitalTwinDevice(@NonNull String deviceId, @NonNull IotHubClientProtocol protocol) throws IotHubException, IOException, URISyntaxException {\n+        if (!protocol.equals(IotHubClientProtocol.MQTT) && !protocol.equals(IotHubClientProtocol.MQTT_WS)) {\n+            throw new IllegalArgumentException(\"Supported protocols for DigitalTwin are MQTT, MQTT_WS\");\n+        }\n+            this.deviceId = deviceId;\n+            this.deviceClient = createDeviceClient(protocol);\n+            this.deviceClient.registerConnectionStatusChangeCallback((iotHubConnectionStatus, iotHubConnectionStatusChangeReason, throwable, o) -> {\n+                TestDigitalTwinDevice testDigitalTwinDevice = (TestDigitalTwinDevice) o;\n+                log.debug(\"DeviceID={}; status={}, reason={}\", testDigitalTwinDevice.getDeviceId(), iotHubConnectionStatus, iotHubConnectionStatusChangeReason);\n+            }, this);\n+            log.debug(\"Created device: {}\", deviceId);\n+        }\n+\n+    private DeviceClient createDeviceClient(IotHubClientProtocol protocol) throws IOException, IotHubException, URISyntaxException {\n+        RegistryManager registryManager = RegistryManager.createFromConnectionString(IOT_HUB_CONNECTION_STRING);\n+        ClientOptions options = new ClientOptions();\n+        options.setModelId(E2ETestConstants.MODEL_ID);\n+        Device device = Device.createDevice(deviceId, AuthenticationType.SAS);\n+        Device registeredDevice = registryManager.addDevice(device);\n+        String deviceConnectionString = registryManager.getDeviceConnectionString(registeredDevice);\n+        registryManager.close();\n+\n+        return new DeviceClient(deviceConnectionString, protocol, options);\n+    }\n+\n+    public void closeAndDeleteDevice() {\n+        try {\n+            deviceClient.closeNow();\n+\n+            RegistryManager registryManager = RegistryManager.createFromConnectionString(IOT_HUB_CONNECTION_STRING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NjkyMjAw", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#pullrequestreview-497692200", "createdAt": "2020-09-28T16:18:30Z", "commit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjoxODozMFrOHZF-5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjoxODozMFrOHZF-5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NDQ3MA==", "bodyText": "We should also add an assert that this test failed.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#discussion_r496074470", "createdAt": "2020-09-28T16:18:30Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/digitaltwin/simulator/TestDigitalTwinDevice.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.simulator;\n+\n+import com.microsoft.azure.sdk.iot.device.ClientOptions;\n+import com.microsoft.azure.sdk.iot.device.DeviceClient;\n+import com.microsoft.azure.sdk.iot.device.IotHubClientProtocol;\n+import com.microsoft.azure.sdk.iot.service.Device;\n+import com.microsoft.azure.sdk.iot.service.RegistryManager;\n+import com.microsoft.azure.sdk.iot.service.auth.AuthenticationType;\n+import com.microsoft.azure.sdk.iot.service.exceptions.IotHubException;\n+import lombok.Getter;\n+import lombok.NonNull;\n+import lombok.extern.slf4j.Slf4j;\n+import tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.helpers.E2ETestConstants;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.Tools;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+\n+@Slf4j\n+@Getter\n+public class TestDigitalTwinDevice {\n+    private static final String IOT_HUB_CONNECTION_STRING = Tools.retrieveEnvironmentVariableValue(E2ETestConstants.IOT_HUB_CONNECTION_STRING_ENV_VAR_NAME);\n+\n+    private String deviceId;\n+    private DeviceClient deviceClient;\n+\n+    public TestDigitalTwinDevice(@NonNull String deviceId, @NonNull IotHubClientProtocol protocol) throws IotHubException, IOException, URISyntaxException {\n+        if (!protocol.equals(IotHubClientProtocol.MQTT) && !protocol.equals(IotHubClientProtocol.MQTT_WS)) {\n+            throw new IllegalArgumentException(\"Supported protocols for DigitalTwin are MQTT, MQTT_WS\");\n+        }\n+            this.deviceId = deviceId;\n+            this.deviceClient = createDeviceClient(protocol);\n+            this.deviceClient.registerConnectionStatusChangeCallback((iotHubConnectionStatus, iotHubConnectionStatusChangeReason, throwable, o) -> {\n+                TestDigitalTwinDevice testDigitalTwinDevice = (TestDigitalTwinDevice) o;\n+                log.debug(\"DeviceID={}; status={}, reason={}\", testDigitalTwinDevice.getDeviceId(), iotHubConnectionStatus, iotHubConnectionStatusChangeReason);\n+            }, this);\n+            log.debug(\"Created device: {}\", deviceId);\n+        }\n+\n+    private DeviceClient createDeviceClient(IotHubClientProtocol protocol) throws IOException, IotHubException, URISyntaxException {\n+        RegistryManager registryManager = RegistryManager.createFromConnectionString(IOT_HUB_CONNECTION_STRING);\n+        ClientOptions options = new ClientOptions();\n+        options.setModelId(E2ETestConstants.MODEL_ID);\n+        Device device = Device.createDevice(deviceId, AuthenticationType.SAS);\n+        Device registeredDevice = registryManager.addDevice(device);\n+        String deviceConnectionString = registryManager.getDeviceConnectionString(registeredDevice);\n+        registryManager.close();\n+\n+        return new DeviceClient(deviceConnectionString, protocol, options);\n+    }\n+\n+    public void closeAndDeleteDevice() {\n+        try {\n+            deviceClient.closeNow();\n+\n+            RegistryManager registryManager = RegistryManager.createFromConnectionString(IOT_HUB_CONNECTION_STRING);\n+            registryManager.removeDevice(deviceId);\n+            registryManager.close();\n+        } catch (Exception ex) {\n+            log.error(\"An exception occurred while closing/ deleting the device {}: {}\", deviceId, ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c1dd786112a27a6704fb990654b19323096931c"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56c716781be7482b1008e85118ae083ba495068e", "author": {"user": {"login": "bikamani", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/56c716781be7482b1008e85118ae083ba495068e", "committedDate": "2020-09-28T17:43:55Z", "message": "adding digital twin test rules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16adbeaa63d65f73dd100e0afde7b8f44ea3d666", "author": {"user": {"login": "bikamani", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/16adbeaa63d65f73dd100e0afde7b8f44ea3d666", "committedDate": "2020-09-28T19:34:12Z", "message": "refactor some code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODM5MDU4", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#pullrequestreview-497839058", "createdAt": "2020-09-28T19:39:54Z", "commit": {"oid": "16adbeaa63d65f73dd100e0afde7b8f44ea3d666"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxOTozOTo1NFrOHZM7kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxOTozOTo1NFrOHZM7kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4ODMwNQ==", "bodyText": "Do we need this?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#discussion_r496188305", "createdAt": "2020-09-28T19:39:54Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/digitaltwin/DigitalTwinServiceClientTests.java", "diffHunk": "@@ -1,38 +1,126 @@\n package tests.integration.com.microsoft.azure.sdk.iot.digitaltwin;\n \n-import com.microsoft.azure.sdk.iot.device.exceptions.TransportException;\n-import org.junit.Test;\n+import com.microsoft.azure.sdk.iot.device.ClientOptions;\n+import com.microsoft.azure.sdk.iot.device.DeviceClient;\n+import com.microsoft.azure.sdk.iot.device.IotHubClientProtocol;\n+import com.microsoft.azure.sdk.iot.service.Device;\n+import com.microsoft.azure.sdk.iot.service.RegistryManager;\n+import com.microsoft.azure.sdk.iot.service.auth.AuthenticationType;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.DigitalTwinAsyncClient;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.DigitalTwinClient;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.models.BasicDigitalTwin;\n+import com.microsoft.azure.sdk.iot.service.exceptions.IotHubException;\n+import lombok.extern.slf4j.Slf4j;\n+import org.junit.*;\n+import org.junit.rules.Timeout;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.helpers.E2ETestConstants;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.IntegrationTest;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.Tools;\n import tests.integration.com.microsoft.azure.sdk.iot.helpers.annotations.DigitalTwinTest;\n+import tests.integration.com.microsoft.azure.sdk.iot.iothub.twin.TwinPnPTests;\n \n import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.util.Collection;\n+import java.util.UUID;\n+\n+import static com.microsoft.azure.sdk.iot.device.IotHubClientProtocol.MQTT;\n+import static com.microsoft.azure.sdk.iot.device.IotHubClientProtocol.MQTT_WS;\n+import static java.util.Arrays.asList;\n+import static org.junit.Assert.assertEquals;\n \n @DigitalTwinTest\n-public class DigitalTwinServiceClientTests {\n+@Slf4j\n+@RunWith(Parameterized.class)\n+public class DigitalTwinServiceClientTests extends IntegrationTest\n+{\n+\n+    private static final String IOTHUB_CONNECTION_STRING = Tools.retrieveEnvironmentVariableValue(E2ETestConstants.IOTHUB_CONNECTION_STRING_ENV_VAR_NAME);\n+    private static RegistryManager registryManager;\n+    private String deviceId;\n+    private DeviceClient deviceClient;\n+    private DigitalTwinClient digitalTwinClient = null;\n+    private static final String DEVICE_ID_PREFIX = \"DigitalTwinServiceClientTests_\";\n+    public TwinPnPTests.TwinPnPTestInstance testInstance;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16adbeaa63d65f73dd100e0afde7b8f44ea3d666"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODQwOTM0", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#pullrequestreview-497840934", "createdAt": "2020-09-28T19:42:41Z", "commit": {"oid": "16adbeaa63d65f73dd100e0afde7b8f44ea3d666"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxOTo0Mjo0MVrOHZNBLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxOTo0Mjo0MVrOHZNBLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4OTc0Mg==", "bodyText": "Remove registryManager.close(); - This should only be done in @afterclass - line 99", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#discussion_r496189742", "createdAt": "2020-09-28T19:42:41Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/digitaltwin/DigitalTwinServiceClientTests.java", "diffHunk": "@@ -1,38 +1,126 @@\n package tests.integration.com.microsoft.azure.sdk.iot.digitaltwin;\n \n-import com.microsoft.azure.sdk.iot.device.exceptions.TransportException;\n-import org.junit.Test;\n+import com.microsoft.azure.sdk.iot.device.ClientOptions;\n+import com.microsoft.azure.sdk.iot.device.DeviceClient;\n+import com.microsoft.azure.sdk.iot.device.IotHubClientProtocol;\n+import com.microsoft.azure.sdk.iot.service.Device;\n+import com.microsoft.azure.sdk.iot.service.RegistryManager;\n+import com.microsoft.azure.sdk.iot.service.auth.AuthenticationType;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.DigitalTwinAsyncClient;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.DigitalTwinClient;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.models.BasicDigitalTwin;\n+import com.microsoft.azure.sdk.iot.service.exceptions.IotHubException;\n+import lombok.extern.slf4j.Slf4j;\n+import org.junit.*;\n+import org.junit.rules.Timeout;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.helpers.E2ETestConstants;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.IntegrationTest;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.Tools;\n import tests.integration.com.microsoft.azure.sdk.iot.helpers.annotations.DigitalTwinTest;\n+import tests.integration.com.microsoft.azure.sdk.iot.iothub.twin.TwinPnPTests;\n \n import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.util.Collection;\n+import java.util.UUID;\n+\n+import static com.microsoft.azure.sdk.iot.device.IotHubClientProtocol.MQTT;\n+import static com.microsoft.azure.sdk.iot.device.IotHubClientProtocol.MQTT_WS;\n+import static java.util.Arrays.asList;\n+import static org.junit.Assert.assertEquals;\n \n @DigitalTwinTest\n-public class DigitalTwinServiceClientTests {\n+@Slf4j\n+@RunWith(Parameterized.class)\n+public class DigitalTwinServiceClientTests extends IntegrationTest\n+{\n+\n+    private static final String IOTHUB_CONNECTION_STRING = Tools.retrieveEnvironmentVariableValue(E2ETestConstants.IOTHUB_CONNECTION_STRING_ENV_VAR_NAME);\n+    private static RegistryManager registryManager;\n+    private String deviceId;\n+    private DeviceClient deviceClient;\n+    private DigitalTwinClient digitalTwinClient = null;\n+    private static final String DEVICE_ID_PREFIX = \"DigitalTwinServiceClientTests_\";\n+    public TwinPnPTests.TwinPnPTestInstance testInstance;\n+\n+    @Rule\n+    public Timeout globalTimeout = Timeout.seconds(5 * 60); // 5 minutes max per method tested\n+\n+    @Parameterized.Parameter(0)\n+    public IotHubClientProtocol protocol;\n+\n+    @Parameterized.Parameters(name = \"{index}: Digital Twin Test: protocol={0}\")\n+    public static Collection<Object[]> data() {\n+        return asList(new Object[][] {\n+                {MQTT},\n+                {MQTT_WS},\n+        });\n+    }\n+\n+    @BeforeClass\n+    public static void setUpBeforeClass() throws IOException {\n+        registryManager = RegistryManager.createFromConnectionString(IOTHUB_CONNECTION_STRING);\n+    }\n+\n+    @Before\n+    public void setUp() throws URISyntaxException, IOException, IotHubException {\n+\n+        this.deviceClient = createDeviceClient(protocol);\n+        deviceClient.open();\n+        DigitalTwinAsyncClient asyncClient = new DigitalTwinAsyncClient(IOTHUB_CONNECTION_STRING);\n+        digitalTwinClient = new DigitalTwinClient(asyncClient);\n+    }\n+\n+    @After\n+    public void cleanUp() {\n+        try {\n+            deviceClient.closeNow();\n+            registryManager.removeDevice(deviceId);\n+            registryManager.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16adbeaa63d65f73dd100e0afde7b8f44ea3d666"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODQxMzQw", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#pullrequestreview-497841340", "createdAt": "2020-09-28T19:43:18Z", "commit": {"oid": "16adbeaa63d65f73dd100e0afde7b8f44ea3d666"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxOTo0MzoxOVrOHZNChg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxOTo0MzoxOVrOHZNChg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE5MDA4Ng==", "bodyText": "We should add assert.False and fail the test.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#discussion_r496190086", "createdAt": "2020-09-28T19:43:19Z", "author": {"login": "vinagesh"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/digitaltwin/DigitalTwinServiceClientTests.java", "diffHunk": "@@ -1,38 +1,126 @@\n package tests.integration.com.microsoft.azure.sdk.iot.digitaltwin;\n \n-import com.microsoft.azure.sdk.iot.device.exceptions.TransportException;\n-import org.junit.Test;\n+import com.microsoft.azure.sdk.iot.device.ClientOptions;\n+import com.microsoft.azure.sdk.iot.device.DeviceClient;\n+import com.microsoft.azure.sdk.iot.device.IotHubClientProtocol;\n+import com.microsoft.azure.sdk.iot.service.Device;\n+import com.microsoft.azure.sdk.iot.service.RegistryManager;\n+import com.microsoft.azure.sdk.iot.service.auth.AuthenticationType;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.DigitalTwinAsyncClient;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.DigitalTwinClient;\n+import com.microsoft.azure.sdk.iot.service.digitaltwin.models.BasicDigitalTwin;\n+import com.microsoft.azure.sdk.iot.service.exceptions.IotHubException;\n+import lombok.extern.slf4j.Slf4j;\n+import org.junit.*;\n+import org.junit.rules.Timeout;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import tests.integration.com.microsoft.azure.sdk.iot.digitaltwin.helpers.E2ETestConstants;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.IntegrationTest;\n+import tests.integration.com.microsoft.azure.sdk.iot.helpers.Tools;\n import tests.integration.com.microsoft.azure.sdk.iot.helpers.annotations.DigitalTwinTest;\n+import tests.integration.com.microsoft.azure.sdk.iot.iothub.twin.TwinPnPTests;\n \n import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.util.Collection;\n+import java.util.UUID;\n+\n+import static com.microsoft.azure.sdk.iot.device.IotHubClientProtocol.MQTT;\n+import static com.microsoft.azure.sdk.iot.device.IotHubClientProtocol.MQTT_WS;\n+import static java.util.Arrays.asList;\n+import static org.junit.Assert.assertEquals;\n \n @DigitalTwinTest\n-public class DigitalTwinServiceClientTests {\n+@Slf4j\n+@RunWith(Parameterized.class)\n+public class DigitalTwinServiceClientTests extends IntegrationTest\n+{\n+\n+    private static final String IOTHUB_CONNECTION_STRING = Tools.retrieveEnvironmentVariableValue(E2ETestConstants.IOTHUB_CONNECTION_STRING_ENV_VAR_NAME);\n+    private static RegistryManager registryManager;\n+    private String deviceId;\n+    private DeviceClient deviceClient;\n+    private DigitalTwinClient digitalTwinClient = null;\n+    private static final String DEVICE_ID_PREFIX = \"DigitalTwinServiceClientTests_\";\n+    public TwinPnPTests.TwinPnPTestInstance testInstance;\n+\n+    @Rule\n+    public Timeout globalTimeout = Timeout.seconds(5 * 60); // 5 minutes max per method tested\n+\n+    @Parameterized.Parameter(0)\n+    public IotHubClientProtocol protocol;\n+\n+    @Parameterized.Parameters(name = \"{index}: Digital Twin Test: protocol={0}\")\n+    public static Collection<Object[]> data() {\n+        return asList(new Object[][] {\n+                {MQTT},\n+                {MQTT_WS},\n+        });\n+    }\n+\n+    @BeforeClass\n+    public static void setUpBeforeClass() throws IOException {\n+        registryManager = RegistryManager.createFromConnectionString(IOTHUB_CONNECTION_STRING);\n+    }\n+\n+    @Before\n+    public void setUp() throws URISyntaxException, IOException, IotHubException {\n+\n+        this.deviceClient = createDeviceClient(protocol);\n+        deviceClient.open();\n+        DigitalTwinAsyncClient asyncClient = new DigitalTwinAsyncClient(IOTHUB_CONNECTION_STRING);\n+        digitalTwinClient = new DigitalTwinClient(asyncClient);\n+    }\n+\n+    @After\n+    public void cleanUp() {\n+        try {\n+            deviceClient.closeNow();\n+            registryManager.removeDevice(deviceId);\n+            registryManager.close();\n+        } catch (Exception ex) {\n+            log.error(\"An exception occurred while closing/ deleting the device {}: {}\", deviceId, ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16adbeaa63d65f73dd100e0afde7b8f44ea3d666"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODQxNjA4", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/937#pullrequestreview-497841608", "createdAt": "2020-09-28T19:43:41Z", "commit": {"oid": "16adbeaa63d65f73dd100e0afde7b8f44ea3d666"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae7e63b4bf0baef68e8102acacf5de02de9ff12d", "author": {"user": {"login": "bikamani", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/ae7e63b4bf0baef68e8102acacf5de02de9ff12d", "committedDate": "2020-09-28T20:00:44Z", "message": "address code review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1e26a2fc8f13503b28ad62edefe5a8d51cd34f0", "author": {"user": {"login": "bikamani", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/e1e26a2fc8f13503b28ad62edefe5a8d51cd34f0", "committedDate": "2020-09-28T20:02:30Z", "message": "clean up"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1569, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}