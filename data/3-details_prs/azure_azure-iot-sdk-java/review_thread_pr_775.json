{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODk1MTc4", "number": 775, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODozMDo1NFrOD7xmpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODo1NjoyNlrOD7yJ-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MDA1Mjg0OnYy", "diffSide": "LEFT", "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/MessagePropertyTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODozMDo1NFrOGUTq7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODozNjoxNVrOGUT2xA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk0Njk5MA==", "bodyText": "whoa, who added hindi in here!", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423946990", "createdAt": "2020-05-12T18:30:54Z", "author": {"login": "abhipsaMisra"}, "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/MessagePropertyTest.java", "diffHunk": "@@ -131,20 +111,6 @@ public void isValidAppPropertyReturnsTrueForValidAppProperty()\n         assertThat(testIsValidAppProperty, is(expectedIsValidAppProperty));\n     }\n \n-    // Tests_SRS_MESSAGEPROPERTY_11_007: [The function shall return true if and only if the name and value only use characters in: US-ASCII and the name is not a reserved property name.]\n-    @Test\n-    public void isValidAppPropertyReturnsFalseForInvalidAppProperty()\n-    {\n-        final String name = \"test-name\";\n-        final String illegalValue = \"\u092a\u0930\u0940\u0915\u094d\u0937\u0923\"; // Unicode is not supported in MessageProperty value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1MDAyMA==", "bodyText": "Haha, I'm not sure! @prmathur-microsoft perhaps?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423950020", "createdAt": "2020-05-12T18:36:15Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/device/MessagePropertyTest.java", "diffHunk": "@@ -131,20 +111,6 @@ public void isValidAppPropertyReturnsTrueForValidAppProperty()\n         assertThat(testIsValidAppProperty, is(expectedIsValidAppProperty));\n     }\n \n-    // Tests_SRS_MESSAGEPROPERTY_11_007: [The function shall return true if and only if the name and value only use characters in: US-ASCII and the name is not a reserved property name.]\n-    @Test\n-    public void isValidAppPropertyReturnsFalseForInvalidAppProperty()\n-    {\n-        final String name = \"test-name\";\n-        final String illegalValue = \"\u092a\u0930\u0940\u0915\u094d\u0937\u0923\"; // Unicode is not supported in MessageProperty value", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk0Njk5MA=="}, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MDEwOTA2OnYy", "diffSide": "RIGHT", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/MessageProperty.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODo0NzowNFrOGUUPdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODo1MDozNlrOGUUXuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1NjM0Mg==", "bodyText": "Do we need to validate even this?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423956342", "createdAt": "2020-05-12T18:47:04Z", "author": {"login": "abhipsaMisra"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/MessageProperty.java", "diffHunk": "@@ -163,17 +144,9 @@ public boolean hasSameName(String name) {\n      *\n      * @return whether the property is a valid application property.\n      */\n-    public static boolean isValidAppProperty(String name, String value) {\n-        boolean propertyIsValid = false;\n-\n-        // Codes_SRS_MESSAGEPROPERTY_11_007: [The function shall return true if and only if the name and value only use characters in US-ASCII and the name is not a reserved property name.]\n-        if (!RESERVED_PROPERTY_NAMES.contains(name)\n-                && usesValidChars(name)\n-                && usesValidChars(value)) {\n-            propertyIsValid = true;\n-        }\n-\n-        return propertyIsValid;\n+    public static boolean isValidAppProperty(String name, String value)\n+    {\n+        return !RESERVED_PROPERTY_NAMES.contains(name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1ODQ1OQ==", "bodyText": "Maybe not, but that kind of change is a bit out of scope for the customer issue I'm working to solve. Maybe if a customer complains later, we can re-evaluate", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423958459", "createdAt": "2020-05-12T18:50:36Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/MessageProperty.java", "diffHunk": "@@ -163,17 +144,9 @@ public boolean hasSameName(String name) {\n      *\n      * @return whether the property is a valid application property.\n      */\n-    public static boolean isValidAppProperty(String name, String value) {\n-        boolean propertyIsValid = false;\n-\n-        // Codes_SRS_MESSAGEPROPERTY_11_007: [The function shall return true if and only if the name and value only use characters in US-ASCII and the name is not a reserved property name.]\n-        if (!RESERVED_PROPERTY_NAMES.contains(name)\n-                && usesValidChars(name)\n-                && usesValidChars(value)) {\n-            propertyIsValid = true;\n-        }\n-\n-        return propertyIsValid;\n+    public static boolean isValidAppProperty(String name, String value)\n+    {\n+        return !RESERVED_PROPERTY_NAMES.contains(name);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1NjM0Mg=="}, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MDE0MzMxOnYy", "diffSide": "RIGHT", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "isResolved": true, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODo1NjoyNlrOGUUluw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxOToxMjo1MlrOGUVKZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MjA0Mw==", "bodyText": "What's the limitation with URLEncoder being unable to encode +?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423962043", "createdAt": "2020-05-12T18:56:26Z", "author": {"login": "abhipsaMisra"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "diffHunk": "@@ -154,15 +154,15 @@ private boolean appendPropertyIfPresent(StringBuilder stringBuilder, boolean sep\n \n                 if (isApplicationProperty)\n                 {\n-                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()));\n+                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()).replaceAll(\"\\\\+\", \"%20\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MjgxNQ==", "bodyText": "https://www.urlencoder.io/java/", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423962815", "createdAt": "2020-05-12T18:57:46Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "diffHunk": "@@ -154,15 +154,15 @@ private boolean appendPropertyIfPresent(StringBuilder stringBuilder, boolean sep\n \n                 if (isApplicationProperty)\n                 {\n-                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()));\n+                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()).replaceAll(\"\\\\+\", \"%20\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MjA0Mw=="}, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MzA0MQ==", "bodyText": "\"Note that Java\u2019s URLEncoder class encodes space character(\" \") into a + sign. This is contrary to other languages like Javascript that encode space character into %20.\"", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423963041", "createdAt": "2020-05-12T18:58:08Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "diffHunk": "@@ -154,15 +154,15 @@ private boolean appendPropertyIfPresent(StringBuilder stringBuilder, boolean sep\n \n                 if (isApplicationProperty)\n                 {\n-                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()));\n+                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()).replaceAll(\"\\\\+\", \"%20\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MjA0Mw=="}, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2NDE2Mw==", "bodyText": "Just updated my explanation above, the problem is actually that URLEncoder.Encode(...) encodes spaces as '+' which is unusual for url encoding. For MQTT in particular, you can't have '+' characters in the topic string, but you can have '%20'", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423964163", "createdAt": "2020-05-12T19:00:07Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "diffHunk": "@@ -154,15 +154,15 @@ private boolean appendPropertyIfPresent(StringBuilder stringBuilder, boolean sep\n \n                 if (isApplicationProperty)\n                 {\n-                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()));\n+                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()).replaceAll(\"\\\\+\", \"%20\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MjA0Mw=="}, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2NDYwOA==", "bodyText": "So are we encoding space or \"+\"?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423964608", "createdAt": "2020-05-12T19:00:51Z", "author": {"login": "abhipsaMisra"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "diffHunk": "@@ -154,15 +154,15 @@ private boolean appendPropertyIfPresent(StringBuilder stringBuilder, boolean sep\n \n                 if (isApplicationProperty)\n                 {\n-                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()));\n+                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()).replaceAll(\"\\\\+\", \"%20\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MjA0Mw=="}, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2NzM4MQ==", "bodyText": "We are fixing how ' ' gets encoded by replacing the incorrect '+' with the correct '%20'\nFor example:\nString urlEncoded = URLEncoder.encode(\"This string has spaces\", StandardCharsets.UTF_8.displayName());\nString actuallyUrlEncoded = urlEncoded.replaceAll(\"\\\\+\", \"%20\");\n\nurlEncoded = \"This+string+has+spaces\"\nactuallyUrlEncoded = \"This%20string%20has%20spaces\"", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423967381", "createdAt": "2020-05-12T19:05:40Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "diffHunk": "@@ -154,15 +154,15 @@ private boolean appendPropertyIfPresent(StringBuilder stringBuilder, boolean sep\n \n                 if (isApplicationProperty)\n                 {\n-                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()));\n+                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()).replaceAll(\"\\\\+\", \"%20\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MjA0Mw=="}, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2Nzc4MA==", "bodyText": "C# does this correctly when using UrlPathEncode: https://docs.microsoft.com/en-us/dotnet/api/system.web.httputility.urlencode?view=netcore-3.1", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423967780", "createdAt": "2020-05-12T19:06:28Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "diffHunk": "@@ -154,15 +154,15 @@ private boolean appendPropertyIfPresent(StringBuilder stringBuilder, boolean sep\n \n                 if (isApplicationProperty)\n                 {\n-                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()));\n+                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()).replaceAll(\"\\\\+\", \"%20\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MjA0Mw=="}, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2OTYwOQ==", "bodyText": "yes, this is what I was looking for: We are fixing how ' ' gets encoded by replacing the incorrect '+' with the correct '%20'\nThe initial wording of the PR confused me.\nI would suggest adding this as a comment where the manual replace is done.", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423969609", "createdAt": "2020-05-12T19:09:31Z", "author": {"login": "abhipsaMisra"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "diffHunk": "@@ -154,15 +154,15 @@ private boolean appendPropertyIfPresent(StringBuilder stringBuilder, boolean sep\n \n                 if (isApplicationProperty)\n                 {\n-                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()));\n+                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()).replaceAll(\"\\\\+\", \"%20\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MjA0Mw=="}, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3MTQyOQ==", "bodyText": "Sure thing, I can add some comments to clarify this .replaceAll call", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/775#discussion_r423971429", "createdAt": "2020-05-12T19:12:52Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/mqtt/MqttMessaging.java", "diffHunk": "@@ -154,15 +154,15 @@ private boolean appendPropertyIfPresent(StringBuilder stringBuilder, boolean sep\n \n                 if (isApplicationProperty)\n                 {\n-                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()));\n+                    stringBuilder.append(URLEncoder.encode(propertyKey, StandardCharsets.UTF_8.name()).replaceAll(\"\\\\+\", \"%20\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk2MjA0Mw=="}, "originalCommit": {"oid": "a87041b1fa98d6aec7fad66e3e7a05a6e40f81e3"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2786, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}