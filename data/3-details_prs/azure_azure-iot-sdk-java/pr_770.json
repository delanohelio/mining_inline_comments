{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMjAzMTI0", "number": 770, "title": "feat(device;service): Support Twin Array properties", "bodyText": "", "createdAt": "2020-05-04T21:48:01Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770", "merged": true, "mergeCommit": {"oid": "e88dc8aa8ad902a8d7e48f2b2c7e63ddbeef8fa4"}, "closed": true, "closedAt": "2020-05-13T16:35:38Z", "author": {"login": "azabbasi"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgdmtNgBqjMzMjU4MzczMjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgte5WAH2gAyNDEzMjAzMTI0OjM5MTVmYTE4NWU0MzdkZjJjZTdhNDg0MTYzOTRhMGRkYzQ5ZDJmNzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e62e79060cb57c080892a5695c7608b27041a5c", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/1e62e79060cb57c080892a5695c7608b27041a5c", "committedDate": "2020-05-12T02:08:37Z", "message": "Fix test typeo"}, "afterCommit": {"oid": "29b99790a1faed843c1808f56218e0f9361bf1c1", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/29b99790a1faed843c1808f56218e0f9361bf1c1", "committedDate": "2020-05-12T05:40:46Z", "message": "Fix test typeo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMjQxNzI3", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#pullrequestreview-410241727", "createdAt": "2020-05-12T16:57:53Z", "commit": {"oid": "29b99790a1faed843c1808f56218e0f9361bf1c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNjo1Nzo1NFrOGUQLwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNjo1Nzo1NFrOGUQLwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg4OTg1OA==", "bodyText": "Does this resend the device method subscription as well?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#discussion_r423889858", "createdAt": "2020-05-12T16:57:54Z", "author": {"login": "abhipsaMisra"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -235,6 +237,10 @@ public void open(Queue<DeviceClientConfig> deviceClientConfigs, ScheduledExecuto\n                 {\n                     closeConnectionWithException(\"Timed out waiting for worker links to open\", true);\n                 }\n+\n+                // In case this is a recovery from a prematurely closed connection, we will re-queue subscribe messages that were sent within this connection.\n+                requeueSubscribeMessages();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29b99790a1faed843c1808f56218e0f9361bf1c1"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzI1NzM4", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#pullrequestreview-410325738", "createdAt": "2020-05-12T18:46:35Z", "commit": {"oid": "4eb536b77f2f8fb3aa0791821d457829e2a6703d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODo0NjozNVrOGUUOVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxODo0NjozNVrOGUUOVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1NjA1NQ==", "bodyText": "Is there any reason why we need to save the message, instead of just creating a new one each time? I'm worried about these two queues getting out of sync. I'd feel safer if we always added a new subscribe message to the messagesToSend queue instead of relying on subscribeMessages being in the right state", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#discussion_r423956055", "createdAt": "2020-05-12T18:46:35Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -251,6 +257,12 @@ public void open(Queue<DeviceClientConfig> deviceClientConfigs, ScheduledExecuto\n         this.log.debug(\"AMQP connection opened successfully\");\n     }\n \n+    private void requeueSubscribeMessages()\n+    {\n+        messagesToSend.addAll(subscribeMessages);\n+        subscribeMessages.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4eb536b77f2f8fb3aa0791821d457829e2a6703d"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDgwNTIz", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#pullrequestreview-410480523", "createdAt": "2020-05-12T22:59:17Z", "commit": {"oid": "288ab6ae0ab574abbcbbb5307f4c357f3d5f914d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMjo1OToxN1rOGUb2sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMjo1OToxN1rOGUb2sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4MTA3Mg==", "bodyText": "Since this is a twin only concept, you don't need an abstract method for this", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#discussion_r424081072", "createdAt": "2020-05-12T22:59:17Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsDeviceOperations.java", "diffHunk": "@@ -427,6 +427,11 @@ protected boolean onLinkRemoteOpen(String linkName)\n      */\n     abstract protected AmqpsConvertToProtonReturnValue convertToProton(Message message) throws TransportException;\n \n+    protected MessageImpl buildSubscribeToDesiredPropertiesProtonMessage()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "288ab6ae0ab574abbcbbb5307f4c357f3d5f914d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDgwODc2", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#pullrequestreview-410480876", "createdAt": "2020-05-12T23:00:03Z", "commit": {"oid": "288ab6ae0ab574abbcbbb5307f4c357f3d5f914d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzowMDowNFrOGUb32g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzowMDowNFrOGUb32g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4MTM3MA==", "bodyText": "Nice, I like this method. Can you reference this method in the iotHubMessageToProtonMessage method in the same class since it uses this logic, too?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#discussion_r424081370", "createdAt": "2020-05-12T23:00:04Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsDeviceTwin.java", "diffHunk": "@@ -191,6 +192,30 @@ protected AmqpsConvertToProtonReturnValue convertToProton(Message message) throw\n         }\n     }\n \n+    @Override\n+    protected MessageImpl buildSubscribeToDesiredPropertiesProtonMessage()\n+    {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "288ab6ae0ab574abbcbbb5307f4c357f3d5f914d"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDgxMDc5", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#pullrequestreview-410481079", "createdAt": "2020-05-12T23:00:36Z", "commit": {"oid": "288ab6ae0ab574abbcbbb5307f4c357f3d5f914d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzowMDozNlrOGUb4hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzowMDozNlrOGUb4hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4MTU0MA==", "bodyText": "\"ctrl + shift + o\"  can cleanup unused imports", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#discussion_r424081540", "createdAt": "2020-05-12T23:00:36Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsIotHubConnection.java", "diffHunk": "@@ -33,6 +33,7 @@\n import java.util.Queue;\n import java.util.UUID;\n import java.util.concurrent.*;\n+import java.util.ArrayList;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "288ab6ae0ab574abbcbbb5307f4c357f3d5f914d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDgxNDIw", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#pullrequestreview-410481420", "createdAt": "2020-05-12T23:01:30Z", "commit": {"oid": "288ab6ae0ab574abbcbbb5307f4c357f3d5f914d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzowMTozMFrOGUb5sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzowMTozMFrOGUb5sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4MTg0MA==", "bodyText": "If you make the '''buildSubscribeToDesiredPropertiesProtonMessage''' method concrete only on the twin class, you can safely cast entry.getValue() as a AmqpsDeviceTwin class to access it here", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#discussion_r424081840", "createdAt": "2020-05-12T23:01:30Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionDeviceOperation.java", "diffHunk": "@@ -337,6 +337,11 @@ boolean onLinkRemoteOpen(String linkName)\n             {\n                 if (entry.getValue().onLinkRemoteOpen(linkName))\n                 {\n+                    if (entry.getKey() == MessageType.DEVICE_TWIN)\n+                    {\n+                        sendMessage(entry.getValue().buildSubscribeToDesiredPropertiesProtonMessage(), entry.getKey(), deviceClientConfig.getDeviceId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "288ab6ae0ab574abbcbbb5307f4c357f3d5f914d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffadb35e42b2a08cdf88269378c94d2d703b981c", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/ffadb35e42b2a08cdf88269378c94d2d703b981c", "committedDate": "2020-05-12T23:35:41Z", "message": "Support Arrays"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef165eaaace0ab1d0930f69d84320d010354e47b", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/ef165eaaace0ab1d0930f69d84320d010354e47b", "committedDate": "2020-05-12T23:35:42Z", "message": "format file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f394d8b47b23735fb5ec2dd364e9b35f98012dcd", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/f394d8b47b23735fb5ec2dd364e9b35f98012dcd", "committedDate": "2020-05-12T23:35:42Z", "message": "Make sure we send the message after openning the amqps link"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d80311e74081e4f097ab5602b661d393068914d9", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/d80311e74081e4f097ab5602b661d393068914d9", "committedDate": "2020-05-12T23:35:42Z", "message": "Fix message requeu issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a59236ad0daaeda2eb0d1e870ae72e1992ff8d92", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/a59236ad0daaeda2eb0d1e870ae72e1992ff8d92", "committedDate": "2020-05-12T23:35:42Z", "message": "Update all tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55551bfbdbf76e41b4483a16793de404b64d749e", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/55551bfbdbf76e41b4483a16793de404b64d749e", "committedDate": "2020-05-12T23:35:42Z", "message": "Fix test typeo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bed247f94819aed94dd77d2261a3ed387eae522", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/6bed247f94819aed94dd77d2261a3ed387eae522", "committedDate": "2020-05-12T23:35:42Z", "message": "Add a single test to Testing reported properties with array support."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2babd31872ae1e16c9fee37c3acb8987e0b21a81", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/2babd31872ae1e16c9fee37c3acb8987e0b21a81", "committedDate": "2020-05-12T23:35:42Z", "message": "Send proton message upon subscription"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0ed4b2adcdf6ef593c5408cd5a5f33ec90b2d7c", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/b0ed4b2adcdf6ef593c5408cd5a5f33ec90b2d7c", "committedDate": "2020-05-12T23:35:42Z", "message": "Addreess comments and code cleanup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b0e836414da4d40a37f081ca8fbad1dd0f06d5f", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/5b0e836414da4d40a37f081ca8fbad1dd0f06d5f", "committedDate": "2020-05-12T23:33:10Z", "message": "Addreess comments and code cleanup"}, "afterCommit": {"oid": "b0ed4b2adcdf6ef593c5408cd5a5f33ec90b2d7c", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/b0ed4b2adcdf6ef593c5408cd5a5f33ec90b2d7c", "committedDate": "2020-05-12T23:35:42Z", "message": "Addreess comments and code cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDk1MTAx", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#pullrequestreview-410495101", "createdAt": "2020-05-12T23:38:20Z", "commit": {"oid": "5b0e836414da4d40a37f081ca8fbad1dd0f06d5f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzozODo1NlrOGUcoPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzozODo1NlrOGUcoPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5Mzc1OA==", "bodyText": "actually, you do need a check here that the opened link was a sender link. If you try to send this message when only the receiver link is open, an exception will get thrown. Plus you don't want to send this subscribe message once when the sender link opens, and again once the receiver link opens", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/770#discussion_r424093758", "createdAt": "2020-05-12T23:38:56Z", "author": {"login": "timtay-microsoft"}, "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionDeviceOperation.java", "diffHunk": "@@ -337,6 +337,13 @@ boolean onLinkRemoteOpen(String linkName)\n             {\n                 if (entry.getValue().onLinkRemoteOpen(linkName))\n                 {\n+                    if (entry.getKey() == MessageType.DEVICE_TWIN)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0ed4b2adcdf6ef593c5408cd5a5f33ec90b2d7c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d3be06eb226a88917ebd866dfa2fc24b881bb5d", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/3d3be06eb226a88917ebd866dfa2fc24b881bb5d", "committedDate": "2020-05-12T23:59:42Z", "message": "Make sure we only send the message when the sender link is being opened."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3915fa185e437df2ce7a48416394a0ddc49d2f76", "author": {"user": {"login": "azabbasi", "name": "Azad Abbasi"}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/3915fa185e437df2ce7a48416394a0ddc49d2f76", "committedDate": "2020-05-13T00:11:08Z", "message": "fix docs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1624, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}