{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyODg4ODU3", "number": 832, "title": "fix(e2e): Fix fault injection message tests", "bodyText": "Iot Hub responds to fault injection messages differently for AMQP and MQTT. For AMQP, the fault injection message will be ack'd before the fault takes effect, but this isn't the case for MQTT. To make it more reliable that the fault injection message gets sent, AMQP tests should wait for this FI message to be ack'd. MQTT tests still need to provide an expiry time, but that time has been bumped up from .1 or .2 seconds to 1 second to increase the chances that it gets delivered at least once", "createdAt": "2020-07-01T18:44:46Z", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/832", "merged": true, "mergeCommit": {"oid": "f2528d83bc6b36686276666e6f7506436b05e933"}, "closed": true, "closedAt": "2020-07-06T20:09:40Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwuaKBgH2gAyNDQyODg4ODU3OmViMjk2NmU3MGM2Mjk0MzBjNmMzMGY3ZWQ4ZDEyMjYzMjAyM2MyYTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyUtYfAFqTQ0MzI3NjAyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eb2966e70c629430c6c30f7ed8d122632023c2a8", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/eb2966e70c629430c6c30f7ed8d122632023c2a8", "committedDate": "2020-07-01T18:18:39Z", "message": "refactor(e2e): Add retry logic to sending fault injection messages\n\nFault injection messages are never guaranteed to be delivered since we attach a very short expiry time to each message. Often times, our fault injection tests will fail because a fault never occurs because the fault injection message is never delivered.\n\nNow, the fault injection logic has some retry logic to send the fault injection message again if the previous attempt never resulted in a fault on the connection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e9dedf779ddc6324d114857676b94345427ed3f", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/7e9dedf779ddc6324d114857676b94345427ed3f", "committedDate": "2020-07-01T18:54:23Z", "message": "Merge branch 'master' into timtay/faultInjection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTMzNTAz", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/832#pullrequestreview-441133503", "createdAt": "2020-07-01T19:16:06Z", "commit": {"oid": "7e9dedf779ddc6324d114857676b94345427ed3f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToxNjowNlrOGryUiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToxNjowNlrOGryUiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2NjQwOQ==", "bodyText": "We set a short expiry time on these fault injection messages because they often fail to be acknowledged by the service before the connection is lost. With this expiry time, our retry logic wont send this message more than a few times. At the same time though, we risk them never being sent. That's why I added some retry logic to prevent that", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/832#discussion_r448566409", "createdAt": "2020-07-01T19:16:06Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/IotHubServicesCommon.java", "diffHunk": "@@ -23,6 +23,11 @@\n  */\n public class IotHubServicesCommon\n {\n+    protected static final Integer RETRY_MILLISECONDS = 100;\n+    protected static final Integer SEND_TIMEOUT_MILLISECONDS = 60000;\n+\n+    public static final int ERROR_INJECTION_MESSAGE_TIMEOUT_MILLISECONDS = 200;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e9dedf779ddc6324d114857676b94345427ed3f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b571f966b2a348a4c176fc5fb17044b0090f4f1", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/5b571f966b2a348a4c176fc5fb17044b0090f4f1", "committedDate": "2020-07-01T22:36:20Z", "message": "Revert \"refactor(e2e): Add retry logic to sending fault injection messages\"\n\nThis reverts commit eb2966e70c629430c6c30f7ed8d122632023c2a8."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "867b4b78c4888f177dc50209647e24fc44d981f0", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/867b4b78c4888f177dc50209647e24fc44d981f0", "committedDate": "2020-07-01T22:49:18Z", "message": "fix(e2e): Fix issue where fault injection message wasn't always sent\n\nThis approach follows the model that the C# SDK does. Give the FI message a 1 second timeout so it doesn't get resent too many times for MQTT, and expect a normal ack from the service for AMQP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce386bb7a4121b358739e0e9da013378671f8cf2", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/ce386bb7a4121b358739e0e9da013378671f8cf2", "committedDate": "2020-07-01T22:50:12Z", "message": "Merge branch 'master' into timtay/faultInjection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "647f229f7b1ba8490331741202ecfe096f1b0285", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/647f229f7b1ba8490331741202ecfe096f1b0285", "committedDate": "2020-07-01T23:11:15Z", "message": "fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1cc3dbe8fe85b08e01c41ec42e22466718c6a46", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/d1cc3dbe8fe85b08e01c41ec42e22466718c6a46", "committedDate": "2020-07-01T23:11:43Z", "message": "Merge branch 'timtay/faultInjection' of https://github.com/Azure/azure-iot-sdk-java into timtay/faultInjection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxODkxMDQ3", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/832#pullrequestreview-441891047", "createdAt": "2020-07-02T17:24:21Z", "commit": {"oid": "d1cc3dbe8fe85b08e01c41ec42e22466718c6a46"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNzoyNDoyMVrOGsW6IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNzoyNDoyMVrOGsW6IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE2NTg1Ng==", "bodyText": "C# SDK uses 5 here, but the service doesn't appear to respect this value. Just in case though, I want to unify with the C# SDK", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/832#discussion_r449165856", "createdAt": "2020-07-02T17:24:21Z", "author": {"login": "timtay-microsoft"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/ErrorInjectionHelper.java", "diffHunk": "@@ -31,7 +31,7 @@\n     public static final String FaultCloseReason_Boom = \"Boom\";\n     public static final String FaultCloseReason_Bye = \"byebye\";\n \n-    public static final int DefaultDelayInSec = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1cc3dbe8fe85b08e01c41ec42e22466718c6a46"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bedb5a0f1dc4725aa7a6a83c2719b356d4c2a5a8", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-iot-sdk-java/commit/bedb5a0f1dc4725aa7a6a83c2719b356d4c2a5a8", "committedDate": "2020-07-06T17:13:07Z", "message": "Merge branch 'master' into timtay/faultInjection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjc1Mjc2", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/832#pullrequestreview-443275276", "createdAt": "2020-07-06T17:28:51Z", "commit": {"oid": "bedb5a0f1dc4725aa7a6a83c2719b356d4c2a5a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNzoyODo1MVrOGtgqLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNzoyODo1MVrOGtgqLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM3NDE5MQ==", "bodyText": "Q - why do we need these changes here, and in sendErrorInjectionMessageAndWaitForResponse both?", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/832#discussion_r450374191", "createdAt": "2020-07-06T17:28:51Z", "author": {"login": "abhipsaMisra"}, "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/helpers/IotHubServicesCommon.java", "diffHunk": "@@ -55,12 +55,16 @@ public static void sendMessages(InternalClient client,\n \n             for (int i = 0; i < messagesToSend.size(); ++i)\n             {\n-                if (isErrorInjectionMessage(messagesToSend.get(i)))\n+                if ((protocol == IotHubClientProtocol.MQTT || protocol == IotHubClientProtocol.MQTT_WS) && isErrorInjectionMessage(messagesToSend.get(i)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bedb5a0f1dc4725aa7a6a83c2719b356d4c2a5a8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjc2MDIx", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/832#pullrequestreview-443276021", "createdAt": "2020-07-06T17:29:58Z", "commit": {"oid": "bedb5a0f1dc4725aa7a6a83c2719b356d4c2a5a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1709, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}