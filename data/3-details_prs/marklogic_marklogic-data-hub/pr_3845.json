{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2Mjk0MDc5", "number": 3845, "title": "DHFPROD-4624: functional spec APIs for mastering in Hub Central", "bodyText": "Description\nInternal functional spec can be found here: https://wiki.marklogic.com/display/ENGINEERING/Hub+Central+Mastering+Design+Specification\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-04-20T20:47:34Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845", "merged": true, "mergeCommit": {"oid": "111ad558124d9412e77749cc4cdbcdcb257555b9"}, "closed": true, "closedAt": "2020-04-28T00:44:33Z", "author": {"login": "ryanjdew"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZmnlUgBqjMyNTM3Nzc0ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb47jRAFqTQwMTQyMjgyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7956e38d250f67e7d3a3afbf87936a36e604ef46", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/7956e38d250f67e7d3a3afbf87936a36e604ef46", "committedDate": "2020-04-20T20:46:10Z", "message": "WIP mastering APIs"}, "afterCommit": {"oid": "7432284c28d8a29859da2e65f2abe552a51c05bb", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/7432284c28d8a29859da2e65f2abe552a51c05bb", "committedDate": "2020-04-20T22:13:22Z", "message": "WIP mastering APIs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7432284c28d8a29859da2e65f2abe552a51c05bb", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/7432284c28d8a29859da2e65f2abe552a51c05bb", "committedDate": "2020-04-20T22:13:22Z", "message": "WIP mastering APIs"}, "afterCommit": {"oid": "6eaee90fd6c502cea543fec5f59ddb5e7dc20224", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6eaee90fd6c502cea543fec5f59ddb5e7dc20224", "committedDate": "2020-04-20T22:59:51Z", "message": "WIP mastering APIs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2ODk1MTcz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#pullrequestreview-396895173", "createdAt": "2020-04-20T23:47:46Z", "commit": {"oid": "6eaee90fd6c502cea543fec5f59ddb5e7dc20224"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMzo0Nzo0NlrOGIsUTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMzo0Nzo0NlrOGIsUTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc2Nzg4NA==", "bodyText": "I feel like we don't need \"additionalCollections\" and can just have \"collections\". We save default artifact settings with \"collections\" set when someone creates an artifact. When users update the settings from UI, \"collections\" gets reset (as collections is not part of the payload or UI property) .", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#discussion_r411767884", "createdAt": "2020-04-20T23:47:46Z", "author": {"login": "srinathgit"}, "path": "specs/models/ArtifactSettings.v1.json", "diffHunk": "@@ -0,0 +1,157 @@\n+{\n+  \"title\": \"ArtifactSettings.v1\",\n+  \"type\": \"object\",\n+  \"description\": \"Settings for an artifact\",\n+  \"properties\": {\n+    \"customHook\": {\n+      \"type\": \"object\",\n+      \"properties\": {\n+        \"module\": {\n+          \"type\": \"string\"\n+        },\n+        \"parameters\": {\n+          \"type\": \"string\"\n+        },\n+        \"user\": {\n+          \"type\": \"string\"\n+        },\n+        \"runBefore\": {\n+          \"type\": \"boolean\"\n+        }\n+      }\n+    },\n+    \"provenanceGranularityLevel\": {\n+      \"type\": \"string\",\n+      \"enum\": [\n+        \"off\",\n+        \"coarse\",\n+        \"fine\"\n+      ]\n+    },\n+    \"permissions\": {\n+      \"type\": \"string\"\n+    },\n+    \"targetFormat\": {\n+      \"type\": \"string\",\n+      \"enum\": [\n+        \"json\",\n+        \"xml\"\n+      ]\n+    },\n+    \"targetDatabase\": {\n+      \"type\": \"string\"\n+    },\n+    \"sourceDatabase\": {\n+      \"type\": \"string\"\n+    },\n+    \"additionalCollections\": {\n+      \"type\": \"array\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eaee90fd6c502cea543fec5f59ddb5e7dc20224"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MzUyNTUw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#pullrequestreview-397352550", "createdAt": "2020-04-21T13:53:27Z", "commit": {"oid": "6eaee90fd6c502cea543fec5f59ddb5e7dc20224"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMzo1MzoyN1rOGJG9dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMzo1NzoyM1rOGJHKsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIwNDQwNw==", "bodyText": "Can you fix my terrible spelling of \"of\" while you're at it? :)", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#discussion_r412204407", "createdAt": "2020-04-21T13:53:27Z", "author": {"login": "rjrudin"}, "path": "specs/models/Flow.schema.json", "diffHunk": "@@ -48,7 +51,7 @@\n             },\n             \"description\": {\n               \"type\": \"string\",\n-              \"description\": \"Optional description fo the step\",\n+              \"description\": \"Optional description fo the step\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eaee90fd6c502cea543fec5f59ddb5e7dc20224"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIwNTAwMA==", "bodyText": "I think the file and title should have the same name - \"MasteringCollections\" seems appropriate.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#discussion_r412205000", "createdAt": "2020-04-21T13:54:04Z", "author": {"login": "rjrudin"}, "path": "specs/models/MasterCollections.v1.json", "diffHunk": "@@ -0,0 +1,52 @@\n+{\n+  \"title\": \"MasteringCollections.v1\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eaee90fd6c502cea543fec5f59ddb5e7dc20224"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIwNzc5Mw==", "bodyText": "I think these properties make it clear that an \"Artifact\", as defined here, is really a \"Step\".\nOur existing (e.g. LoadHubArtifactsCommand and LoadUserArtifactsCommand) code also refers to flows and entity models as artifacts, but those concepts do not support properties like customHook and targetDatabase/sourceDatabase.\nOf course, if this is just capturing the as-is, that's fine, and this is correct. But I think it's critical that we rework the concept of the \"artifact service\" into a \"step service\", because we're really describing steps.\n\"Artifact\" will then continue to have its current meaning of \"Config files created by users\", which will consist of flows, entity models, steps, step definitions, and mappings (with mappings being separate from mapping steps because of the existing code that expects things to be that way).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#discussion_r412207793", "createdAt": "2020-04-21T13:57:23Z", "author": {"login": "rjrudin"}, "path": "specs/models/ArtifactSettings.v1.json", "diffHunk": "@@ -0,0 +1,157 @@\n+{\n+  \"title\": \"ArtifactSettings.v1\",\n+  \"type\": \"object\",\n+  \"description\": \"Settings for an artifact\",\n+  \"properties\": {\n+    \"customHook\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eaee90fd6c502cea543fec5f59ddb5e7dc20224"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6eaee90fd6c502cea543fec5f59ddb5e7dc20224", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6eaee90fd6c502cea543fec5f59ddb5e7dc20224", "committedDate": "2020-04-20T22:59:51Z", "message": "WIP mastering APIs"}, "afterCommit": {"oid": "4c69b5258666773328a2df7e200e1f0621d84b0c", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4c69b5258666773328a2df7e200e1f0621d84b0c", "committedDate": "2020-04-21T20:15:36Z", "message": "WIP mastering APIs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c69b5258666773328a2df7e200e1f0621d84b0c", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4c69b5258666773328a2df7e200e1f0621d84b0c", "committedDate": "2020-04-21T20:15:36Z", "message": "WIP mastering APIs"}, "afterCommit": {"oid": "dff9ef6b07e887eb288ba2cb8d89d0804a3b881f", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/dff9ef6b07e887eb288ba2cb8d89d0804a3b881f", "committedDate": "2020-04-21T22:37:05Z", "message": "WIP mastering APIs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dff9ef6b07e887eb288ba2cb8d89d0804a3b881f", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/dff9ef6b07e887eb288ba2cb8d89d0804a3b881f", "committedDate": "2020-04-21T22:37:05Z", "message": "WIP mastering APIs"}, "afterCommit": {"oid": "881163851fcd5d9e0131c54fd7e050196574fd4e", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/881163851fcd5d9e0131c54fd7e050196574fd4e", "committedDate": "2020-04-21T22:40:29Z", "message": "WIP mastering APIs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "881163851fcd5d9e0131c54fd7e050196574fd4e", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/881163851fcd5d9e0131c54fd7e050196574fd4e", "committedDate": "2020-04-21T22:40:29Z", "message": "WIP mastering APIs"}, "afterCommit": {"oid": "6f7eae916e14edc6b1d536de682b0abe392d9f46", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6f7eae916e14edc6b1d536de682b0abe392d9f46", "committedDate": "2020-04-21T22:54:03Z", "message": "DHFPROD-4624: functional spec APIs for mastering in Hub Central"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDY4ODI1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#pullrequestreview-398468825", "createdAt": "2020-04-22T18:34:18Z", "commit": {"oid": "6f7eae916e14edc6b1d536de682b0abe392d9f46"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxODozNDoxOFrOGKFIzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxODo0OTowMlrOGKFvQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIyMzExOQ==", "bodyText": "I included this at first to document it, but now I'm thinking we should remove it.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#discussion_r413223119", "createdAt": "2020-04-22T18:34:18Z", "author": {"login": "rjrudin"}, "path": "specs/models/Flow.schema.json", "diffHunk": "@@ -40,178 +43,195 @@\n       \"additionalProperties\": false,\n       \"patternProperties\": {\n         \"^[0-9]+$\": {\n-          \"type\": \"object\",\n-          \"properties\": {\n-            \"name\": {\n-              \"type\": \"string\",\n-              \"description\": \"Name of step, though the 'step number' is how a step is referred to when running a flow\"\n-            },\n-            \"description\": {\n-              \"type\": \"string\",\n-              \"description\": \"Optional description fo the step\",\n-            },\n-            \"stepDefinitionName\": {\n-              \"type\": \"string\"\n-            },\n-            \"stepDefinitionType\": {\n-              \"type\": \"string\"\n-            },\n-            \"batchSize\": {\n-              \"type\": \"number\",\n-              \"description\": \"If set, overrides the batchSize defined at the flow level and in the step definition\"\n-            },\n-            \"threadCount\": {\n-              \"type\": \"number\",\n-              \"description\": \"If set, overrides the threadCount defined at the flow level and in the step definition\"\n-            },\n-            \"retryLimit\": {\n-              \"type\": \"number\",\n-              \"description\": \"Unused, has no effect if set\"\n-            },\n-            \"customHook\": {\n-              \"type\": \"object\",\n+          \"oneOf\": [\n+            {\n               \"properties\": {\n-                \"module\": {\n-                  \"type\": \"string\"\n-                },\n-                \"parameters\": {\n-                  \"type\": \"object\"\n-                },\n-                \"user\": {\n-                  \"type\": \"string\"\n-                },\n-                \"runBefore\": {\n-                  \"type\": \"boolean\"\n-                }\n-              }\n-            },\n-            \"processors\": {\n-              \"type\": \"array\",\n-              \"items\": {\n-                \"type\": \"object\",\n-                \"properties\": {\n-                  \"path\": {\n-                    \"type\": \"string\",\n-                    \"description\": \"Path to a module in the modules database that will be invoked via xdmp.invoke\"\n-                  },\n-                  \"when\": {\n-                    \"type\": \"string\",\n-                    \"description\": \"When the processor should be invoked. Only 'beforeContentPersisted' is supported.\"\n-                  },\n-                  \"vars\": {\n-                    \"type\": \"object\",\n-                    \"description\": \"Any properties defined in this object are passed to the invoked module\"\n-                  }\n-                }\n-              }\n-            },\n-            \"options\": {\n-              \"type\": \"object\",\n-              \"properties\": {\n-                \"sourceQuery\": {\n+                \"name\": {\n                   \"type\": \"string\",\n-                  \"description\": \"Defines the items to be processed by the step; must be a cts.query or cts.uris statement if sourceQueryIsScript is false\"\n-                },\n-                \"sourceQueryIsScript\": {\n-                  \"type\": \"boolean\",\n-                  \"description\": \"Added in 5.3.0; if true, then sourceQuery can be any JavaScript statement that can be passed into xdmp.eval\"\n-                },\n-                \"constrainSourceQueryToJob\": {\n-                  \"type\": \"boolean\",\n-                  \"description\": \"If true, the query is applied to the documents that were created or modified in the same job that executes the step\"\n-                },\n-                \"provenanceGranularityLevel\": {\n-                  \"type\": \"string\",\n-                  \"description\": \"The granularity of the provenance tracking information: coarse (default) to store document-level provenance information only, fine to store document-level and property-level provenance information, or off to disable provenance tracking in future job runs. Applies only to mapping, matching, merging, mastering, and custom steps.\"\n-                },\n-                \"stepUpdate\": {\n-                  \"type\": \"boolean\",\n-                  \"description\": \"If true, custom modules can make changes directly to records in the database\"\n-                },\n-                \"acceptsBatch\": {\n-                  \"type\": \"boolean\",\n-                  \"description\": \"If true, the step module is invoked once with all records in the batch passed to it\"\n+                  \"description\": \"Name of step, though the 'step number' is how a step is referred to when running a flow\"\n                 },\n-                \"collections\": {\n-                  \"type\": \"array\",\n-                  \"items\" : {\n-                    \"type\": \"string\"\n-                  }\n-                },\n-                \"additionalCollections\": {\n-                  \"type\": \"array\",\n-                  \"items\" : {\n-                    \"type\": \"string\"\n-                  }\n-                },\n-                \"permissions\": {\n+                \"description\": {\n                   \"type\": \"string\",\n-                  \"description\": \"Comma-delimited string of role,capability,role,capability,etc\"\n+                  \"description\": \"Optional description of the step\"\n                 },\n-                \"outputFormat\": {\n+                \"stepDefinitionName\": {\n                   \"type\": \"string\"\n                 },\n-                \"sourceDatabase\": {\n+                \"stepDefinitionType\": {\n                   \"type\": \"string\"\n                 },\n-                \"targetDatabase\": {\n-                  \"type\": \"string\"\n+                \"batchSize\": {\n+                  \"type\": \"number\",\n+                  \"description\": \"If set, overrides the batchSize defined at the flow level and in the step definition\"\n                 },\n-                \"targetEntity\": {\n-                  \"type\": \"string\",\n-                  \"description\": \"Name of the entity type associated with the output of the step\"\n+                \"threadCount\": {\n+                  \"type\": \"number\",\n+                  \"description\": \"If set, overrides the threadCount defined at the flow level and in the step definition\"\n                 },\n-                \"validateEntity\": {\n-                  \"type\": \"boolean\",\n-                  \"description\": \"Applicable to mapping steps only\"\n+                \"retryLimit\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f7eae916e14edc6b1d536de682b0abe392d9f46"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIyNTk5Mw==", "bodyText": "If the intent is to define a new Step schema that uses \"options\" strictly for things that make sense to override at runtime... you know, I'm wondering if \"options\" should be purely a runtime thing in the first place? i.e. put sourceQuery directly under Step, and a Step has no understanding of \"options\" in the first place. Then, some chunk of code can look at the options defined at runtime when a flow is run, and it'll use e.g. Object.assign to overwrite what's in the step definition. So e.g.:\noptions = {}; // provided by user at runtime\nflow = getFlow();\nstepId = flow.steps[\"1\"].stepId;\nstep = getStep(stepId); // loads a step document from the database\nstep = applyOptionsToStep(step);\nflow.steps[\"1\"] = step;\n\nThat makes the data model much easier to design and understand, because now we don't need to think about \"Which of these things would a user want to override at runtime?\" If needed, the \"applyOptionsToStep\" function could prohibit certain things from being overridden.\nThoughts on dumping \"options\" completely from a Step?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#discussion_r413225993", "createdAt": "2020-04-22T18:38:35Z", "author": {"login": "rjrudin"}, "path": "specs/models/Step.v1.json", "diffHunk": "@@ -0,0 +1,181 @@\n+{\n+  \"title\": \"Step.v1\",\n+  \"type\": \"object\",\n+  \"properties\": {\n+    \"options\": {\n+      \"type\": \"object\",\n+      \"properties\": {\n+        \"sourceQuery\": {\n+          \"type\": \"string\",\n+          \"description\": \"Defines the items to be processed by the step; must be a cts.query or cts.uris statement if sourceQueryIsScript is false\"\n+        },\n+        \"sourceQueryIsScript\": {\n+          \"type\": \"boolean\",\n+          \"description\": \"Added in 5.3.0; if true, then sourceQuery can be any JavaScript statement that can be passed into xdmp.eval\"\n+        },\n+        \"constrainSourceQueryToJob\": {\n+          \"type\": \"boolean\",\n+          \"description\": \"If true, the query is applied to the documents that were created or modified in the same job that executes the step\"\n+        },\n+        \"provenanceGranularityLevel\": {\n+          \"type\": \"string\",\n+          \"description\": \"The granularity of the provenance tracking information: coarse (default) to store document-level provenance information only, fine to store document-level and property-level provenance information, or off to disable provenance tracking in future job runs. Applies only to mapping, matching, merging, mastering, and custom steps.\",\n+          \"enum\": [\n+            \"off\",\n+            \"coarse\",\n+            \"fine\"\n+          ]\n+        },\n+        \"stepUpdate\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f7eae916e14edc6b1d536de682b0abe392d9f46"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIyNzIyNw==", "bodyText": "Taking a page out of mlcp's book here - how about \"outputCollections\" to make it clear that these are applied to documents outputted by the step? Likewise for \"outputPermissions\", and I'd do \"outputAdditionalCollections\" as well. I remember being confused at first about what the scope of \"collections\" is - does that affect the query for documents to process, or are they applied to documents that will be written, or is it something else? \"outputCollections\" works well for mlcp, I think we should copy it here.\n(Note that the function that adapts the new Step schema to what the existing Flow schema expects would then rename this to \"collections\").", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#discussion_r413227227", "createdAt": "2020-04-22T18:40:29Z", "author": {"login": "rjrudin"}, "path": "specs/models/Step.v1.json", "diffHunk": "@@ -0,0 +1,181 @@\n+{\n+  \"title\": \"Step.v1\",\n+  \"type\": \"object\",\n+  \"properties\": {\n+    \"options\": {\n+      \"type\": \"object\",\n+      \"properties\": {\n+        \"sourceQuery\": {\n+          \"type\": \"string\",\n+          \"description\": \"Defines the items to be processed by the step; must be a cts.query or cts.uris statement if sourceQueryIsScript is false\"\n+        },\n+        \"sourceQueryIsScript\": {\n+          \"type\": \"boolean\",\n+          \"description\": \"Added in 5.3.0; if true, then sourceQuery can be any JavaScript statement that can be passed into xdmp.eval\"\n+        },\n+        \"constrainSourceQueryToJob\": {\n+          \"type\": \"boolean\",\n+          \"description\": \"If true, the query is applied to the documents that were created or modified in the same job that executes the step\"\n+        },\n+        \"provenanceGranularityLevel\": {\n+          \"type\": \"string\",\n+          \"description\": \"The granularity of the provenance tracking information: coarse (default) to store document-level provenance information only, fine to store document-level and property-level provenance information, or off to disable provenance tracking in future job runs. Applies only to mapping, matching, merging, mastering, and custom steps.\",\n+          \"enum\": [\n+            \"off\",\n+            \"coarse\",\n+            \"fine\"\n+          ]\n+        },\n+        \"stepUpdate\": {\n+          \"type\": \"boolean\",\n+          \"description\": \"If true, custom modules can make changes directly to records in the database\"\n+        },\n+        \"acceptsBatch\": {\n+          \"type\": \"boolean\",\n+          \"description\": \"If true, the step module is invoked once with all records in the batch passed to it\"\n+        },\n+        \"collections\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f7eae916e14edc6b1d536de682b0abe392d9f46"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIzMjk2MQ==", "bodyText": "I think we should at a minimum say \"targetEntityTypeId\" here, as \"entityTypeId\" is our agreed-upon name for a unique identifier for an entity type. We can have code that accepts a name in here as well.\nAlso, I'm proposing \"inputDatabase\" and \"outputDatabase\" to be consistent not just with mlcp, but also with the evolving concepts of a Step having an Input and an Output. Gorbet pointed out how the word \"source\" is a bit loaded because it has been typically used to refer to a source of data outside of ML, like some external system. So we want to move away from \"sourceQuery\" - though I wouldn't rename that yet. I don't know, if this is just a draft, I think we can stay with sourceDatabase/targetDatabase, but I think we'll need to get Gorbet and likely PAT involved because we're really defining critical concepts here.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#discussion_r413232961", "createdAt": "2020-04-22T18:49:02Z", "author": {"login": "rjrudin"}, "path": "specs/models/Step.v1.json", "diffHunk": "@@ -0,0 +1,181 @@\n+{\n+  \"title\": \"Step.v1\",\n+  \"type\": \"object\",\n+  \"properties\": {\n+    \"options\": {\n+      \"type\": \"object\",\n+      \"properties\": {\n+        \"sourceQuery\": {\n+          \"type\": \"string\",\n+          \"description\": \"Defines the items to be processed by the step; must be a cts.query or cts.uris statement if sourceQueryIsScript is false\"\n+        },\n+        \"sourceQueryIsScript\": {\n+          \"type\": \"boolean\",\n+          \"description\": \"Added in 5.3.0; if true, then sourceQuery can be any JavaScript statement that can be passed into xdmp.eval\"\n+        },\n+        \"constrainSourceQueryToJob\": {\n+          \"type\": \"boolean\",\n+          \"description\": \"If true, the query is applied to the documents that were created or modified in the same job that executes the step\"\n+        },\n+        \"provenanceGranularityLevel\": {\n+          \"type\": \"string\",\n+          \"description\": \"The granularity of the provenance tracking information: coarse (default) to store document-level provenance information only, fine to store document-level and property-level provenance information, or off to disable provenance tracking in future job runs. Applies only to mapping, matching, merging, mastering, and custom steps.\",\n+          \"enum\": [\n+            \"off\",\n+            \"coarse\",\n+            \"fine\"\n+          ]\n+        },\n+        \"stepUpdate\": {\n+          \"type\": \"boolean\",\n+          \"description\": \"If true, custom modules can make changes directly to records in the database\"\n+        },\n+        \"acceptsBatch\": {\n+          \"type\": \"boolean\",\n+          \"description\": \"If true, the step module is invoked once with all records in the batch passed to it\"\n+        },\n+        \"collections\": {\n+          \"type\": \"array\",\n+          \"items\": {\n+            \"type\": \"string\"\n+          }\n+        },\n+        \"additionalCollections\": {\n+          \"type\": \"array\",\n+          \"items\": {\n+            \"type\": \"string\"\n+          }\n+        },\n+        \"permissions\": {\n+          \"type\": \"string\",\n+          \"description\": \"Comma-delimited string of role,capability,role,capability,etc\"\n+        },\n+        \"outputFormat\": {\n+          \"type\": \"string\",\n+          \"enum\": [\n+            \"json\",\n+            \"xml\"\n+          ]\n+        },\n+        \"sourceDatabase\": {\n+          \"type\": \"string\"\n+        },\n+        \"targetDatabase\": {\n+          \"type\": \"string\"\n+        },\n+        \"targetEntity\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f7eae916e14edc6b1d536de682b0abe392d9f46"}, "originalPosition": 66}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f7eae916e14edc6b1d536de682b0abe392d9f46", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6f7eae916e14edc6b1d536de682b0abe392d9f46", "committedDate": "2020-04-21T22:54:03Z", "message": "DHFPROD-4624: functional spec APIs for mastering in Hub Central"}, "afterCommit": {"oid": "02a7ffea8cfaa66a0373962f1b554b70abc589c2", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/02a7ffea8cfaa66a0373962f1b554b70abc589c2", "committedDate": "2020-04-22T23:02:53Z", "message": "DHFPROD-4624: functional spec APIs for mastering in Hub Central"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02a7ffea8cfaa66a0373962f1b554b70abc589c2", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/02a7ffea8cfaa66a0373962f1b554b70abc589c2", "committedDate": "2020-04-22T23:02:53Z", "message": "DHFPROD-4624: functional spec APIs for mastering in Hub Central"}, "afterCommit": {"oid": "5e53da59133f1c149ea7385768e5096e029c3f27", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5e53da59133f1c149ea7385768e5096e029c3f27", "committedDate": "2020-04-23T17:53:24Z", "message": "DHFPROD-4624: functional spec APIs for mastering in Hub Central"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e53da59133f1c149ea7385768e5096e029c3f27", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5e53da59133f1c149ea7385768e5096e029c3f27", "committedDate": "2020-04-23T17:53:24Z", "message": "DHFPROD-4624: functional spec APIs for mastering in Hub Central"}, "afterCommit": {"oid": "0fcb9e56a7fccee23c6ee714bfb5814280b0d820", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/0fcb9e56a7fccee23c6ee714bfb5814280b0d820", "committedDate": "2020-04-23T18:19:06Z", "message": "DHFPROD-4624: functional spec APIs for mastering in Hub Central"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NDI1NTU3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#pullrequestreview-399425557", "createdAt": "2020-04-23T19:50:45Z", "commit": {"oid": "0fcb9e56a7fccee23c6ee714bfb5814280b0d820"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOTo1MDo0NlrOGK5YUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOTo1MTo1M1rOGK5bCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA3OTA1OA==", "bodyText": "Little tweak - I think \"outputPermissions\" here, for consistency with mlcp and to make it explicit how these will be applied.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#discussion_r414079058", "createdAt": "2020-04-23T19:50:46Z", "author": {"login": "rjrudin"}, "path": "specs/models/Step.v1.json", "diffHunk": "@@ -0,0 +1,142 @@\n+{\n+  \"title\": \"Step.v1\",\n+  \"type\": \"object\",\n+  \"properties\": {\n+    \"processors\": {\n+      \"type\": \"array\",\n+      \"items\": {\n+        \"type\": \"object\",\n+        \"properties\": {\n+          \"path\": {\n+            \"type\": \"string\",\n+            \"description\": \"Path to a module in the modules database that will be invoked via xdmp.invoke\"\n+          },\n+          \"when\": {\n+            \"type\": \"string\",\n+            \"description\": \"When the processor should be invoked. Only 'beforeContentPersisted' is supported.\"\n+          },\n+          \"vars\": {\n+            \"type\": \"object\",\n+            \"description\": \"Any properties defined in this object are passed to the invoked module\"\n+          }\n+        }\n+      }\n+    },\n+    \"customHook\": {\n+      \"type\": \"object\",\n+      \"properties\": {\n+        \"module\": {\n+          \"type\": \"string\"\n+        },\n+        \"parameters\": {\n+          \"type\": \"object\"\n+        },\n+        \"user\": {\n+          \"type\": \"string\"\n+        },\n+        \"runBefore\": {\n+          \"type\": \"boolean\"\n+        }\n+      }\n+    },\n+    \"threadCount\": {\n+      \"type\": \"number\",\n+      \"description\": \"If set, overrides the threadCount defined at the flow level and in the step definition\"\n+    },\n+    \"batchSize\": {\n+      \"type\": \"number\",\n+      \"description\": \"If set, overrides the batchSize defined at the flow level and in the step definition\"\n+    },\n+    \"stepDefinitionType\": {\n+      \"type\": \"string\"\n+    },\n+    \"stepDefinitionName\": {\n+      \"type\": \"string\"\n+    },\n+    \"description\": {\n+      \"type\": \"string\",\n+      \"description\": \"Optional description fo the step\"\n+    },\n+    \"stepId\": {\n+      \"type\": \"string\",\n+      \"description\": \"This is generated on the server-side\"\n+    },\n+    \"headers\": {\n+      \"type\": \"object\",\n+      \"description\": \"Any properties in this object will be copied into the headers of each document processed by the step\"\n+    },\n+    \"validateEntity\": {\n+      \"type\": \"boolean\",\n+      \"description\": \"Applicable to mapping steps only\"\n+    },\n+    \"outputDatabase\": {\n+      \"type\": \"string\"\n+    },\n+    \"inputDatabase\": {\n+      \"type\": \"string\"\n+    },\n+    \"outputFormat\": {\n+      \"type\": \"string\",\n+      \"enum\": [\n+        \"json\",\n+        \"xml\"\n+      ]\n+    },\n+    \"permissions\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fcb9e56a7fccee23c6ee714bfb5814280b0d820"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA3OTc1NA==", "bodyText": "I think since the UI is under development, we should use the same terms here. It's fine that we have to translate the new terms to the existing Flow schema, but for the UI, it'll never be easier than now to change it to use these new terms.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#discussion_r414079754", "createdAt": "2020-04-23T19:51:53Z", "author": {"login": "rjrudin"}, "path": "specs/models/StepSettings.v1.json", "diffHunk": "@@ -0,0 +1,157 @@\n+{\n+  \"title\": \"StepSettings.v1\",\n+  \"type\": \"object\",\n+  \"description\": \"Settings for a step. This is a logical structure to simplify front-end/middle-tier APIs\",\n+  \"properties\": {\n+    \"customHook\": {\n+      \"type\": \"object\",\n+      \"properties\": {\n+        \"module\": {\n+          \"type\": \"string\"\n+        },\n+        \"parameters\": {\n+          \"type\": \"string\"\n+        },\n+        \"user\": {\n+          \"type\": \"string\"\n+        },\n+        \"runBefore\": {\n+          \"type\": \"boolean\"\n+        }\n+      }\n+    },\n+    \"provenanceGranularityLevel\": {\n+      \"type\": \"string\",\n+      \"enum\": [\n+        \"off\",\n+        \"coarse\",\n+        \"fine\"\n+      ]\n+    },\n+    \"permissions\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fcb9e56a7fccee23c6ee714bfb5814280b0d820"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b921f8d8e809e45c3d03b4c1fe6d7ec4c9acc20f", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b921f8d8e809e45c3d03b4c1fe6d7ec4c9acc20f", "committedDate": "2020-04-23T23:11:13Z", "message": "DHFPROD-4624: functional spec APIs for mastering in Hub Central"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0fcb9e56a7fccee23c6ee714bfb5814280b0d820", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/0fcb9e56a7fccee23c6ee714bfb5814280b0d820", "committedDate": "2020-04-23T18:19:06Z", "message": "DHFPROD-4624: functional spec APIs for mastering in Hub Central"}, "afterCommit": {"oid": "b921f8d8e809e45c3d03b4c1fe6d7ec4c9acc20f", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b921f8d8e809e45c3d03b4c1fe6d7ec4c9acc20f", "committedDate": "2020-04-23T23:11:13Z", "message": "DHFPROD-4624: functional spec APIs for mastering in Hub Central"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTQ5NjI0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#pullrequestreview-401149624", "createdAt": "2020-04-27T17:01:55Z", "commit": {"oid": "b921f8d8e809e45c3d03b4c1fe6d7ec4c9acc20f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNzowMTo1NVrOGMt6dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNzowMTo1NVrOGMt6dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk4ODM0MQ==", "bodyText": "I'm realizing now that we really have a lot of interchangeability between input/source and output/target/destination in DH today. I think this should likely be \"outputEntityTypeId\", and \"sourceQuery\" should be \"inputQuery\", but I think we can hold off on those changes for now because I'm expecting there to be new abstractions we add soon. So I think these are fine for now, even though we still have consistency with input vs source and output vs target/destination.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#discussion_r415988341", "createdAt": "2020-04-27T17:01:55Z", "author": {"login": "rjrudin"}, "path": "specs/models/Step.v1.json", "diffHunk": "@@ -0,0 +1,142 @@\n+{\n+  \"title\": \"Step.v1\",\n+  \"type\": \"object\",\n+  \"properties\": {\n+    \"processors\": {\n+      \"type\": \"array\",\n+      \"items\": {\n+        \"type\": \"object\",\n+        \"properties\": {\n+          \"path\": {\n+            \"type\": \"string\",\n+            \"description\": \"Path to a module in the modules database that will be invoked via xdmp.invoke\"\n+          },\n+          \"when\": {\n+            \"type\": \"string\",\n+            \"description\": \"When the processor should be invoked. Only 'beforeContentPersisted' is supported.\"\n+          },\n+          \"vars\": {\n+            \"type\": \"object\",\n+            \"description\": \"Any properties defined in this object are passed to the invoked module\"\n+          }\n+        }\n+      }\n+    },\n+    \"customHook\": {\n+      \"type\": \"object\",\n+      \"properties\": {\n+        \"module\": {\n+          \"type\": \"string\"\n+        },\n+        \"parameters\": {\n+          \"type\": \"object\"\n+        },\n+        \"user\": {\n+          \"type\": \"string\"\n+        },\n+        \"runBefore\": {\n+          \"type\": \"boolean\"\n+        }\n+      }\n+    },\n+    \"threadCount\": {\n+      \"type\": \"number\",\n+      \"description\": \"If set, overrides the threadCount defined at the flow level and in the step definition\"\n+    },\n+    \"batchSize\": {\n+      \"type\": \"number\",\n+      \"description\": \"If set, overrides the batchSize defined at the flow level and in the step definition\"\n+    },\n+    \"stepDefinitionType\": {\n+      \"type\": \"string\"\n+    },\n+    \"stepDefinitionName\": {\n+      \"type\": \"string\"\n+    },\n+    \"description\": {\n+      \"type\": \"string\",\n+      \"description\": \"Optional description fo the step\"\n+    },\n+    \"stepId\": {\n+      \"type\": \"string\",\n+      \"description\": \"This is generated on the server-side\"\n+    },\n+    \"headers\": {\n+      \"type\": \"object\",\n+      \"description\": \"Any properties in this object will be copied into the headers of each document processed by the step\"\n+    },\n+    \"validateEntity\": {\n+      \"type\": \"boolean\",\n+      \"description\": \"Applicable to mapping steps only\"\n+    },\n+    \"outputDatabase\": {\n+      \"type\": \"string\"\n+    },\n+    \"inputDatabase\": {\n+      \"type\": \"string\"\n+    },\n+    \"outputFormat\": {\n+      \"type\": \"string\",\n+      \"enum\": [\n+        \"json\",\n+        \"xml\"\n+      ]\n+    },\n+    \"outputPermissions\": {\n+      \"type\": \"string\",\n+      \"description\": \"Comma-delimited string of role,capability,role,capability,etc\"\n+    },\n+    \"outputCollections\": {\n+      \"type\": \"array\",\n+      \"description\": \"additional collections provided by the user that get applied to the step output\",\n+      \"items\": {\n+        \"type\": \"string\"\n+      }\n+    },\n+    \"defaultOutputCollections\": {\n+      \"type\": \"array\",\n+      \"description\": \"default collections associated with a step that are applied to the step output\",\n+      \"items\": {\n+        \"type\": \"string\"\n+      }\n+    },\n+    \"acceptsBatch\": {\n+      \"type\": \"boolean\",\n+      \"default\": \"false\",\n+      \"description\": \"If true, the step module is invoked once with all records in the batch passed to it\"\n+    },\n+    \"stepUpdate\": {\n+      \"type\": \"boolean\",\n+      \"default\": \"false\",\n+      \"description\": \"If true, custom modules can make changes directly to records in the database\"\n+    },\n+    \"provenanceGranularityLevel\": {\n+      \"type\": \"string\",\n+      \"description\": \"The granularity of the provenance tracking information: coarse (default) to store document-level provenance information only, fine to store document-level and property-level provenance information, or off to disable provenance tracking in future job runs. Applies only to mapping, matching, merging, mastering, and custom steps.\",\n+      \"enum\": [\n+        \"off\",\n+        \"coarse\",\n+        \"fine\"\n+      ]\n+    },\n+    \"constrainSourceQueryToJob\": {\n+      \"type\": \"boolean\",\n+      \"description\": \"If true, the query is applied to the documents that were created or modified in the same job that executes the step\"\n+    },\n+    \"sourceQueryIsScript\": {\n+      \"type\": \"boolean\",\n+      \"description\": \"Added in 5.3.0; if true, then sourceQuery can be any JavaScript statement that can be passed into xdmp.eval\"\n+    },\n+    \"sourceQuery\": {\n+      \"type\": \"string\",\n+      \"description\": \"Defines the items to be processed by the step; must be a cts.query or cts.uris statement if sourceQueryIsScript is false\"\n+    },\n+    \"targetEntityTypeId\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b921f8d8e809e45c3d03b4c1fe6d7ec4c9acc20f"}, "originalPosition": 134}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNDIyODI2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3845#pullrequestreview-401422826", "createdAt": "2020-04-28T00:41:46Z", "commit": {"oid": "b921f8d8e809e45c3d03b4c1fe6d7ec4c9acc20f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3060, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}