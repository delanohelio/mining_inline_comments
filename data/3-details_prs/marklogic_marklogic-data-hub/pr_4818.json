{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0ODMyODIz", "number": 4818, "title": "DHFPROD-5997: Fixing logic for determining step success", "bodyText": "Description\nThe problem was that CollectorImpl was not throwing an exception when the collector failed. It instead returned a single item - the error message (the serialized JSON object from the REST API). That was then processed by the step, which resulted in zero successful items - but also zero failed items.\nNow that the collector properly throws an error, QueryStepRunner can say that if there are no failed items, then the step completed successfully.\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-11-03T15:58:48Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4818", "merged": true, "mergeCommit": {"oid": "614a915ea0d49527575335919ca10e0681bda1b0"}, "closed": true, "closedAt": "2020-11-03T23:49:57Z", "author": {"login": "rjrudin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY7WSxAFqTUyMjY0MzkyOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZBuPKgFqTUyMjk0NjI5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNjQzOTI4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4818#pullrequestreview-522643928", "createdAt": "2020-11-03T16:00:09Z", "commit": {"oid": "949ea176b904b691be3303b0d6fb1013c467d811"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjowMDoxMFrOHs1kHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjowMDoxMFrOHs1kHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc3Njk5MA==", "bodyText": "Noticed this rogue log statement while testing, removed it.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4818#discussion_r516776990", "createdAt": "2020-11-03T16:00:10Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/bulk/fixCreatedByStep.sjs", "diffHunk": "@@ -90,7 +90,6 @@ if (uris.length == 0) {\n             {database: xdmp.database(config.JOBDATABASE)}\n           ));\n           if (influencedByTriple) {\n-            console.log(\"Using influencedBy!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "949ea176b904b691be3303b0d6fb1013c467d811"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNjQ4OTY1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4818#pullrequestreview-522648965", "createdAt": "2020-11-03T16:05:29Z", "commit": {"oid": "949ea176b904b691be3303b0d6fb1013c467d811"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjowNToyOVrOHs1ywA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjowNToyOVrOHs1ywA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc4MDczNg==", "bodyText": "I'm mostly wondering how safe this change is. When I first made it, the only test that failed was the one for an invalid sourceQuery. So I made the fix to CollectorImpl so that it throws an exception - its previous behavior for handling an error seemed incorrect.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4818#discussion_r516780736", "createdAt": "2020-11-03T16:05:29Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/QueryStepRunner.java", "diffHunk": "@@ -524,4 +513,23 @@ private RunStepResponse runHarmonizer(RunStepResponse runStepResponse, Collectio\n         runningThread.start();\n         return runStepResponse;\n     }\n+\n+    private String determineStepStatus(StepMetrics stepMetrics) {\n+        if (stepMetrics.getFailedEventsCount() > 0 && stopOnFailure) {\n+            return JobStatus.STOP_ON_ERROR_PREFIX + step;\n+        } else if( isStopped.get()){\n+            return JobStatus.CANCELED_PREFIX + step;\n+        } else if (stepMetrics.getFailedEventsCount() > 0 && stepMetrics.getSuccessfulEventsCount() > 0) {\n+            return JobStatus.COMPLETED_WITH_ERRORS_PREFIX + step;\n+        } else if (stepMetrics.getFailedEventsCount() == 0)  {\n+            // Based on DHFPROD-5997, it is possible for a step to complete successfully but not process anything.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "949ea176b904b691be3303b0d6fb1013c467d811"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNjc0NDYz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4818#pullrequestreview-522674463", "createdAt": "2020-11-03T16:31:36Z", "commit": {"oid": "949ea176b904b691be3303b0d6fb1013c467d811"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNjk2NjY4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4818#pullrequestreview-522696668", "createdAt": "2020-11-03T16:55:06Z", "commit": {"oid": "949ea176b904b691be3303b0d6fb1013c467d811"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e36ffda201c79793b11dfc3a32c2bea3bad90bf9", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/e36ffda201c79793b11dfc3a32c2bea3bad90bf9", "committedDate": "2020-11-03T23:06:42Z", "message": "DHFPROD-5997: Fixing logic for determining step success\n\nThe problem was that CollectorImpl was not throwing an exception when the collector failed. It instead returned a single item - the error message (the serialized JSON object from the REST API). That was then processed by the step, which resulted in zero successful items - but also zero failed items. \n\nNow that the collector properly throws an error, QueryStepRunner can say that if there are no failed items, then the step completed successfully."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "949ea176b904b691be3303b0d6fb1013c467d811", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/949ea176b904b691be3303b0d6fb1013c467d811", "committedDate": "2020-11-03T15:55:25Z", "message": "DHFPROD-5997: Fixing logic for determining step success\n\nThe problem was that CollectorImpl was not throwing an exception when the collector failed. It instead returned a single item - the error message (the serialized JSON object from the REST API). That was then processed by the step, which resulted in zero successful items - but also zero failed items. \n\nNow that the collector properly throws an error, QueryStepRunner can say that if there are no failed items, then the step completed successfully."}, "afterCommit": {"oid": "e36ffda201c79793b11dfc3a32c2bea3bad90bf9", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/e36ffda201c79793b11dfc3a32c2bea3bad90bf9", "committedDate": "2020-11-03T23:06:42Z", "message": "DHFPROD-5997: Fixing logic for determining step success\n\nThe problem was that CollectorImpl was not throwing an exception when the collector failed. It instead returned a single item - the error message (the serialized JSON object from the REST API). That was then processed by the step, which resulted in zero successful items - but also zero failed items. \n\nNow that the collector properly throws an error, QueryStepRunner can say that if there are no failed items, then the step completed successfully."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTQxMDU3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4818#pullrequestreview-522941057", "createdAt": "2020-11-03T23:12:26Z", "commit": {"oid": "e36ffda201c79793b11dfc3a32c2bea3bad90bf9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTQ2Mjkz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4818#pullrequestreview-522946293", "createdAt": "2020-11-03T23:25:45Z", "commit": {"oid": "e36ffda201c79793b11dfc3a32c2bea3bad90bf9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1601, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}