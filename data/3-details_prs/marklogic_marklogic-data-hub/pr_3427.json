{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NjcyNzYz", "number": 3427, "title": "DHFPROD-2691:Prohibit DHS users from updating DHF modules", "bodyText": "Prohibit DHS users from updating DHF modules", "createdAt": "2020-01-06T19:12:13Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3427", "merged": true, "mergeCommit": {"oid": "c03cc06a5205d385c471a571d2c924f036adc979"}, "closed": true, "closedAt": "2020-01-07T17:51:59Z", "author": {"login": "srinathgit"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3xtH-AFqTMzODg0ODI3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4EDFwgFqTMzOTM4MjQ5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4ODQ4Mjc1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3427#pullrequestreview-338848275", "createdAt": "2020-01-06T19:34:22Z", "commit": {"oid": "20f340706d34667a0cb2835c6c56ff6073522b68"}, "state": "DISMISSED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxOTo0MDoxNVrOFanPWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxOTo1NToxMlrOFannUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ1MDIwMg==", "bodyText": "This should be SortOrderConstants.LOAD_MODULES + 1 to ensure that the modules have all been loaded already.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3427#discussion_r363450202", "createdAt": "2020-01-06T19:40:15Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/UpdateDhsModulesPermissionsCommand.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2012-2019 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub.deploy.commands;\n+\n+import com.marklogic.appdeployer.command.AbstractCommand;\n+import com.marklogic.appdeployer.command.CommandContext;\n+import com.marklogic.appdeployer.command.SortOrderConstants;\n+import com.marklogic.client.ext.modulesloader.Modules;\n+import com.marklogic.client.ext.modulesloader.impl.DefaultModulesFinder;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.dataservices.UpdateDhsResourcePermissions;\n+import org.apache.commons.io.FilenameUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.io.Resource;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.List;\n+\n+@Component\n+public class UpdateDhsModulesPermissionsCommand extends AbstractCommand {\n+\n+    @Autowired\n+    private HubConfig hubConfig;\n+    private UpdateDhsResourcePermissions service;\n+\n+    //This command has to be run after LoadHubModulesCommand is run.\n+    public UpdateDhsModulesPermissionsCommand() {\n+        setExecuteSortOrder(SortOrderConstants.LOAD_MODULES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f340706d34667a0cb2835c6c56ff6073522b68"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ1MDc5MQ==", "bodyText": "Can you remove this so there's one less modification to FlowRunnerImpl? Keeps the version history cleaner.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3427#discussion_r363450791", "createdAt": "2020-01-06T19:41:39Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/flow/impl/FlowRunnerImpl.java", "diffHunk": "@@ -5,6 +5,7 @@\n import com.marklogic.client.io.JacksonHandle;\n import com.marklogic.hub.FlowManager;\n import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.Flow;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f340706d34667a0cb2835c6c56ff6073522b68"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ1NTQ4Nw==", "bodyText": "This command is specific to installing DHF into DHS, so a few notes on it:\n\nIt should be in the com.marklogic.hub.cli.deploy package along with the other 2 commands specific to installing DHF into DHS\nIt shouldn't be a Spring component - InstallIntoDhsCommand should just pass a HubConfig into its constructor (similar to CopyQueryOptionsCommand)\n\nAnd then regarding the use of data services - I don't think we should do that for a deployment concern. CopyQueryOptionsCommand is using the /v1/eval endpoint to mess around with query options as part of installing DHF into DHS. For consistency and simplicity, I think this command should follow the same approach - i.e. build a script and send it to /v1/eval. Building a script inside of Java code isn't the cleanest thing ever, but I think it's suitable for a deployment concern - whereas Data Services is absolutely the best approach for any interface that we want a customer to be able to invoke (but we definitely don't want a customer invoking this endpoint).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3427#discussion_r363455487", "createdAt": "2020-01-06T19:53:13Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/UpdateDhsModulesPermissionsCommand.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2012-2019 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub.deploy.commands;\n+\n+import com.marklogic.appdeployer.command.AbstractCommand;\n+import com.marklogic.appdeployer.command.CommandContext;\n+import com.marklogic.appdeployer.command.SortOrderConstants;\n+import com.marklogic.client.ext.modulesloader.Modules;\n+import com.marklogic.client.ext.modulesloader.impl.DefaultModulesFinder;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.dataservices.UpdateDhsResourcePermissions;\n+import org.apache.commons.io.FilenameUtils;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.io.Resource;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.List;\n+\n+@Component\n+public class UpdateDhsModulesPermissionsCommand extends AbstractCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f340706d34667a0cb2835c6c56ff6073522b68"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ1NjMzNg==", "bodyText": "This code can all be reused in the Java command - though I don't think you need an xdmp.eval here. Just do what CopyQueryOptionsCommand is doing - call hubConfig.newModulesDbClient().", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3427#discussion_r363456336", "createdAt": "2020-01-06T19:55:12Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/dhs/updateResourcePermissions.sjs", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+  Copyright 2012-2019 MarkLogic Corporation\n+\n+  Licensed under the Apache License, Version 2.0 (the \"License\");\n+  you may not use this file except in compliance with the License.\n+  You may obtain a copy of the License at\n+\n+     http://www.apache.org/licenses/LICENSE-2.0\n+\n+  Unless required by applicable law or agreed to in writing, software\n+  distributed under the License is distributed on an \"AS IS\" BASIS,\n+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  See the License for the specific language governing permissions and\n+  limitations under the License.\n+*/\n+'use strict';\n+\n+var extensionType;\n+var fileName;\n+\n+\n+xdmp.eval('let partUri = \"/marklogic.rest.'+ extensionType + '/' + fileName + '/assets/\"; '+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20f340706d34667a0cb2835c6c56ff6073522b68"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20f340706d34667a0cb2835c6c56ff6073522b68", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/20f340706d34667a0cb2835c6c56ff6073522b68", "committedDate": "2020-01-06T19:09:24Z", "message": "DHFPROD-2691:Prohibit DHS users from updating DHF modules"}, "afterCommit": {"oid": "68d0bd909de3550e5ef07faa830e46d755170308", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/68d0bd909de3550e5ef07faa830e46d755170308", "committedDate": "2020-01-06T21:43:46Z", "message": "DHFPROD-2691:Prohibit DHS users from updating DHF modules"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTUxMjYz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3427#pullrequestreview-338951263", "createdAt": "2020-01-06T23:11:24Z", "commit": {"oid": "68d0bd909de3550e5ef07faa830e46d755170308"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTY1NDg5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3427#pullrequestreview-338965489", "createdAt": "2020-01-06T23:57:31Z", "commit": {"oid": "68d0bd909de3550e5ef07faa830e46d755170308"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzo1NzozMVrOFasnLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMzo1NzozMVrOFasnLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUzODIyMw==", "bodyText": "One small tweak here - this new command is specific to InstallIntoDhsCommand, there's no need for DataHubImpl to know about it. Just add it to the list of commands in InstallIntoDhsCommand, just like CopyQueryOptionsCommand.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3427#discussion_r363538223", "createdAt": "2020-01-06T23:57:31Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/DataHubImpl.java", "diffHunk": "@@ -830,6 +796,9 @@ private void updateModuleCommandList(Map<String, List<Command>> commandsMap) {\n         commands.add(loadUserArtifactsCommand);\n         commands.add(loadHubArtifactsCommand);\n         commands.add(generateFunctionMetadataCommand);\n+        if(hubConfig.getIsProvisionedEnvironment()){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68d0bd909de3550e5ef07faa830e46d755170308"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "517f138b33274a6a27e5a2dddf273c8898cf18ca", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/517f138b33274a6a27e5a2dddf273c8898cf18ca", "committedDate": "2020-01-07T00:21:40Z", "message": "DHFPROD-2691:Prohibit DHS users from updating DHF modules"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68d0bd909de3550e5ef07faa830e46d755170308", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/68d0bd909de3550e5ef07faa830e46d755170308", "committedDate": "2020-01-06T21:43:46Z", "message": "DHFPROD-2691:Prohibit DHS users from updating DHF modules"}, "afterCommit": {"oid": "517f138b33274a6a27e5a2dddf273c8898cf18ca", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/517f138b33274a6a27e5a2dddf273c8898cf18ca", "committedDate": "2020-01-07T00:21:40Z", "message": "DHFPROD-2691:Prohibit DHS users from updating DHF modules"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTczMDUx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3427#pullrequestreview-338973051", "createdAt": "2020-01-07T00:25:35Z", "commit": {"oid": "517f138b33274a6a27e5a2dddf273c8898cf18ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MzgyNDk0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3427#pullrequestreview-339382494", "createdAt": "2020-01-07T17:17:41Z", "commit": {"oid": "517f138b33274a6a27e5a2dddf273c8898cf18ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2312, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}