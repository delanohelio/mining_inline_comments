{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2Nzg0OTEx", "number": 3936, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNjo1NDozMVrOD77q8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNjo1NDozMVrOD77q8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MTcwMjI3OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/step/saveStep.sjs", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNjo1NDozMVrOGUjw-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzowOTozOFrOGUwv3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIxMDY4Mw==", "bodyText": "The default collections for ingestion step should be the step name (current behavior) and for mapping step, it's the step name and the entity name(explorer requires that ).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3936#discussion_r424210683", "createdAt": "2020-05-13T06:54:31Z", "author": {"login": "srinathgit"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/step/saveStep.sjs", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const Artifacts = require('/data-hub/5/artifacts/core.sjs');\n+const Step = require(\"/data-hub/5/impl/step.sjs\");\n+const consts = require(\"/data-hub/5/impl/consts.sjs\");\n+\n+var stepDefinitionType;\n+var stepProperties;\n+\n+stepProperties = stepProperties.toObject();\n+const stepName = stepProperties.name;\n+\n+xdmp.trace(consts.TRACE_STEP, `Saving step with name ${stepName} and type ${stepDefinitionType}`);\n+\n+let existingStep = fn.head(cts.search(cts.andQuery([\n+  cts.collectionQuery(\"http://marklogic.com/data-hub/steps\"),\n+  cts.jsonPropertyValueQuery(\"stepDefinitionType\", stepDefinitionType, \"case-insensitive\"),\n+  cts.jsonPropertyValueQuery(\"name\", stepName)\n+])));\n+\n+if (existingStep) {\n+  xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType} already exists, so will update`);\n+  let updatedStep = Object.assign(existingStep.toObject(), stepProperties);\n+  Artifacts.setArtifact(stepDefinitionType, stepName, updatedStep);\n+} else {\n+  xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType}  does not exist, so will create`);\n+\n+  // For now, can assume the stepDefinitionName based on the type. Can add stepDefinitionType as a parameter once we need\n+  // more flexibility.\n+  const stepDefinitionName = \"mapping\" === stepDefinitionType.toLowerCase() ? \"entity-services-mapping\" : \"default-ingestion\";\n+\n+  stepProperties.stepDefinitionName = stepDefinitionName;\n+  stepProperties.stepDefinitionType = stepDefinitionType;\n+  stepProperties.stepId = stepName + \"-\" + stepDefinitionType;\n+\n+  const stepDef = new Step().getStepByNameAndType(stepDefinitionName, stepDefinitionType);\n+  const stepDefOptions = stepDef.options;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c5944c4d1fcb559050118c0eace9d9b98b27479"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM5MTEzNw==", "bodyText": "That logic still exists in the loadData/mapping artifact libraries.\nShould we not copy the default collections from the step definition? In which case - shouldn't we remove the default collections from the step definition? Do they serve any other purpose?\nPinging @ryanjdew  and @bsrikan  for insight.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3936#discussion_r424391137", "createdAt": "2020-05-13T12:18:41Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/step/saveStep.sjs", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const Artifacts = require('/data-hub/5/artifacts/core.sjs');\n+const Step = require(\"/data-hub/5/impl/step.sjs\");\n+const consts = require(\"/data-hub/5/impl/consts.sjs\");\n+\n+var stepDefinitionType;\n+var stepProperties;\n+\n+stepProperties = stepProperties.toObject();\n+const stepName = stepProperties.name;\n+\n+xdmp.trace(consts.TRACE_STEP, `Saving step with name ${stepName} and type ${stepDefinitionType}`);\n+\n+let existingStep = fn.head(cts.search(cts.andQuery([\n+  cts.collectionQuery(\"http://marklogic.com/data-hub/steps\"),\n+  cts.jsonPropertyValueQuery(\"stepDefinitionType\", stepDefinitionType, \"case-insensitive\"),\n+  cts.jsonPropertyValueQuery(\"name\", stepName)\n+])));\n+\n+if (existingStep) {\n+  xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType} already exists, so will update`);\n+  let updatedStep = Object.assign(existingStep.toObject(), stepProperties);\n+  Artifacts.setArtifact(stepDefinitionType, stepName, updatedStep);\n+} else {\n+  xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType}  does not exist, so will create`);\n+\n+  // For now, can assume the stepDefinitionName based on the type. Can add stepDefinitionType as a parameter once we need\n+  // more flexibility.\n+  const stepDefinitionName = \"mapping\" === stepDefinitionType.toLowerCase() ? \"entity-services-mapping\" : \"default-ingestion\";\n+\n+  stepProperties.stepDefinitionName = stepDefinitionName;\n+  stepProperties.stepDefinitionType = stepDefinitionType;\n+  stepProperties.stepId = stepName + \"-\" + stepDefinitionType;\n+\n+  const stepDef = new Step().getStepByNameAndType(stepDefinitionName, stepDefinitionType);\n+  const stepDefOptions = stepDef.options;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIxMDY4Mw=="}, "originalCommit": {"oid": "1c5944c4d1fcb559050118c0eace9d9b98b27479"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQxNDkwOQ==", "bodyText": "I think I see what to do - the default collections are currently applied in defaultArtifactSettings, which isn't called for step creation. I'll copy/paste that logic into defaultArtifact for mapping.sjs, and then I'll modify this to not pull the default collections from the step definition.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3936#discussion_r424414909", "createdAt": "2020-05-13T12:57:01Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/step/saveStep.sjs", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const Artifacts = require('/data-hub/5/artifacts/core.sjs');\n+const Step = require(\"/data-hub/5/impl/step.sjs\");\n+const consts = require(\"/data-hub/5/impl/consts.sjs\");\n+\n+var stepDefinitionType;\n+var stepProperties;\n+\n+stepProperties = stepProperties.toObject();\n+const stepName = stepProperties.name;\n+\n+xdmp.trace(consts.TRACE_STEP, `Saving step with name ${stepName} and type ${stepDefinitionType}`);\n+\n+let existingStep = fn.head(cts.search(cts.andQuery([\n+  cts.collectionQuery(\"http://marklogic.com/data-hub/steps\"),\n+  cts.jsonPropertyValueQuery(\"stepDefinitionType\", stepDefinitionType, \"case-insensitive\"),\n+  cts.jsonPropertyValueQuery(\"name\", stepName)\n+])));\n+\n+if (existingStep) {\n+  xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType} already exists, so will update`);\n+  let updatedStep = Object.assign(existingStep.toObject(), stepProperties);\n+  Artifacts.setArtifact(stepDefinitionType, stepName, updatedStep);\n+} else {\n+  xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType}  does not exist, so will create`);\n+\n+  // For now, can assume the stepDefinitionName based on the type. Can add stepDefinitionType as a parameter once we need\n+  // more flexibility.\n+  const stepDefinitionName = \"mapping\" === stepDefinitionType.toLowerCase() ? \"entity-services-mapping\" : \"default-ingestion\";\n+\n+  stepProperties.stepDefinitionName = stepDefinitionName;\n+  stepProperties.stepDefinitionType = stepDefinitionType;\n+  stepProperties.stepId = stepName + \"-\" + stepDefinitionType;\n+\n+  const stepDef = new Step().getStepByNameAndType(stepDefinitionName, stepDefinitionType);\n+  const stepDefOptions = stepDef.options;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIxMDY4Mw=="}, "originalCommit": {"oid": "1c5944c4d1fcb559050118c0eace9d9b98b27479"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQyMzM5MQ==", "bodyText": "Thanks @srinathgit - I updated the tests (and added manageIngestionStep.sjs) so the assertions are on the step name and also the entity type for mapping steps.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3936#discussion_r424423391", "createdAt": "2020-05-13T13:09:38Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/step/saveStep.sjs", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const Artifacts = require('/data-hub/5/artifacts/core.sjs');\n+const Step = require(\"/data-hub/5/impl/step.sjs\");\n+const consts = require(\"/data-hub/5/impl/consts.sjs\");\n+\n+var stepDefinitionType;\n+var stepProperties;\n+\n+stepProperties = stepProperties.toObject();\n+const stepName = stepProperties.name;\n+\n+xdmp.trace(consts.TRACE_STEP, `Saving step with name ${stepName} and type ${stepDefinitionType}`);\n+\n+let existingStep = fn.head(cts.search(cts.andQuery([\n+  cts.collectionQuery(\"http://marklogic.com/data-hub/steps\"),\n+  cts.jsonPropertyValueQuery(\"stepDefinitionType\", stepDefinitionType, \"case-insensitive\"),\n+  cts.jsonPropertyValueQuery(\"name\", stepName)\n+])));\n+\n+if (existingStep) {\n+  xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType} already exists, so will update`);\n+  let updatedStep = Object.assign(existingStep.toObject(), stepProperties);\n+  Artifacts.setArtifact(stepDefinitionType, stepName, updatedStep);\n+} else {\n+  xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType}  does not exist, so will create`);\n+\n+  // For now, can assume the stepDefinitionName based on the type. Can add stepDefinitionType as a parameter once we need\n+  // more flexibility.\n+  const stepDefinitionName = \"mapping\" === stepDefinitionType.toLowerCase() ? \"entity-services-mapping\" : \"default-ingestion\";\n+\n+  stepProperties.stepDefinitionName = stepDefinitionName;\n+  stepProperties.stepDefinitionType = stepDefinitionType;\n+  stepProperties.stepId = stepName + \"-\" + stepDefinitionType;\n+\n+  const stepDef = new Step().getStepByNameAndType(stepDefinitionName, stepDefinitionType);\n+  const stepDefOptions = stepDef.options;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIxMDY4Mw=="}, "originalCommit": {"oid": "1c5944c4d1fcb559050118c0eace9d9b98b27479"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4120, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}