{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MzI1NTIx", "number": 4102, "title": "DHFPROD-5177: Changes to EntitySearch API to accept propertiesToDisplay for tabular view", "bodyText": "Description\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-06-16T16:16:38Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102", "merged": true, "mergeCommit": {"oid": "a109c5a1e38eec842dcddbe2df12aaa2724e0443"}, "closed": true, "closedAt": "2020-06-19T22:39:50Z", "author": {"login": "rahulvudutala"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcr4Z0xgFqTQzMTcxMjY3Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcs6mu4gFqTQzNDM2MzcwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzEyNjc2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#pullrequestreview-431712676", "createdAt": "2020-06-16T17:00:06Z", "commit": {"oid": "58e6bbeb72e57f9e8c00e688d8ffc77b240d7ac2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzowMDowNlrOGkky_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzowNzozN1rOGklD9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwNDc5Nw==", "bodyText": "It'll help a lot to define method comments here that define currentProperty as an object along with the expected keys in that object, which I believe are propertyPath and datatype. Otherwise, I think a reader would not know if \"currentProperty\" is simply a property name/path or a complex object.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#discussion_r441004797", "createdAt": "2020-06-16T17:00:06Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -98,13 +104,19 @@ function buildPropertyMetadata(parentPropertyName, entityModel, entityName) {\n       propertyMetadata[\"properties\"] = buildPropertyMetadata(propertyMetadata[\"propertyPath\"], entityModel, entityName);\n     }\n     allPropertyMetadata.push(propertyMetadata);\n+\n+    if(selectedProperties && selectedProperties.includes(propertyMetadata.propertyPath)) {\n+      selectedPropertyMetadata.push(propertyMetadata);\n+    }\n   }\n   return allPropertyMetadata;\n }\n \n-function getPropertyValues(currentProperty, entityInstance) {\n+// Helper function used by getPropertyValuesFromInstance to fetch property values from a propertyPath\n+function getPropertyPathValues(currentProperty, entityInstance) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58e6bbeb72e57f9e8c00e688d8ffc77b240d7ac2"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwNjg4NQ==", "bodyText": "Let's make these parameters that are passed to functions instead of them being library-level variables. That makes the scope of functions easier to understand, as they won't be depending on library-level variables where it's not clear when the state of those variables is modified.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#discussion_r441006885", "createdAt": "2020-06-16T17:03:49Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -19,24 +19,28 @@ const ds = require(\"/data-hub/5/data-services/ds-utils.sjs\");\n // TODO Will move this to /data-hub/5/entities soon\n const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n \n+let selectedPropertyMetadata = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58e6bbeb72e57f9e8c00e688d8ffc77b240d7ac2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwNzU4MQ==", "bodyText": "This naming is confusing - the only time we say \"instance\" is when referring to an \"entity instance\". Is this really a \"value instance\", or simply \"property value\"?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#discussion_r441007581", "createdAt": "2020-06-16T17:05:00Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -141,6 +153,81 @@ function getPropertyValues(currentProperty, entityInstance) {\n   return resultObject;\n }\n \n+// This function fetches the appropriate instance property values for first level simple, structured property paths and\n+// other levels of structured entity properties from the propertyPath.\n+function getPropertyValuesFromInstance(currentProperty, entityInstance) {\n+  let resultObject = {};\n+  resultObject.propertyPath = currentProperty.propertyPath;\n+\n+  if(Array.isArray(entityInstance)) {\n+    let propertyValuesArray = [];\n+    entityInstance.forEach((instance) => {\n+      let propertyValue = getPropertyPathValues(currentProperty, instance).propertyValue;\n+      if(Array.isArray(propertyValue)) {\n+        propertyValue.forEach((propertyValue) => {\n+          propertyValuesArray.push(propertyValue);\n+        });\n+      } else {\n+        propertyValuesArray.push(propertyValue);\n+      }\n+    });\n+    resultObject.propertyValue = propertyValuesArray;\n+  } else {\n+    resultObject.propertyValue =  getPropertyPathValues(currentProperty, entityInstance).propertyValue;\n+  }\n+  return resultObject;\n+}\n+\n+// This function fetches the appropriate instance for first level simple, structured property paths and other levels of\n+// structured entity properties from the propertyPath.\n+function getInstanceFromPropertyPath(currentProperty, entityInstance) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58e6bbeb72e57f9e8c00e688d8ffc77b240d7ac2"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwOTE0Mg==", "bodyText": "This raises the same question above - an entity instance is always an object, it'll never be an array. So what is this variable actually referring to?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#discussion_r441009142", "createdAt": "2020-06-16T17:07:37Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -141,6 +153,81 @@ function getPropertyValues(currentProperty, entityInstance) {\n   return resultObject;\n }\n \n+// This function fetches the appropriate instance property values for first level simple, structured property paths and\n+// other levels of structured entity properties from the propertyPath.\n+function getPropertyValuesFromInstance(currentProperty, entityInstance) {\n+  let resultObject = {};\n+  resultObject.propertyPath = currentProperty.propertyPath;\n+\n+  if(Array.isArray(entityInstance)) {\n+    let propertyValuesArray = [];\n+    entityInstance.forEach((instance) => {\n+      let propertyValue = getPropertyPathValues(currentProperty, instance).propertyValue;\n+      if(Array.isArray(propertyValue)) {\n+        propertyValue.forEach((propertyValue) => {\n+          propertyValuesArray.push(propertyValue);\n+        });\n+      } else {\n+        propertyValuesArray.push(propertyValue);\n+      }\n+    });\n+    resultObject.propertyValue = propertyValuesArray;\n+  } else {\n+    resultObject.propertyValue =  getPropertyPathValues(currentProperty, entityInstance).propertyValue;\n+  }\n+  return resultObject;\n+}\n+\n+// This function fetches the appropriate instance for first level simple, structured property paths and other levels of\n+// structured entity properties from the propertyPath.\n+function getInstanceFromPropertyPath(currentProperty, entityInstance) {\n+  let splitPropertyNames = currentProperty.propertyPath.split(\".\");\n+  splitPropertyNames.pop();\n+\n+  if(splitPropertyNames.length > 0) {\n+    splitPropertyNames.forEach((propertyName) => {\n+      let propertyInstanceArray = [];\n+      if(Array.isArray(entityInstance)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58e6bbeb72e57f9e8c00e688d8ffc77b240d7ac2"}, "originalPosition": 128}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzkzODE0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#pullrequestreview-431793814", "createdAt": "2020-06-16T18:41:57Z", "commit": {"oid": "58e6bbeb72e57f9e8c00e688d8ffc77b240d7ac2"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58e6bbeb72e57f9e8c00e688d8ffc77b240d7ac2", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/58e6bbeb72e57f9e8c00e688d8ffc77b240d7ac2", "committedDate": "2020-06-16T15:17:02Z", "message": "DHFPROD-5177: Changes to EntitySearch API to accept propertiesToDisplay for tabular view"}, "afterCommit": {"oid": "2215dd494840e9b808bf6ea68149f77aec4ceb97", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/2215dd494840e9b808bf6ea68149f77aec4ceb97", "committedDate": "2020-06-19T14:54:02Z", "message": "DHFPROD-5177: Changes to EntitySearch API to accept propertiesToDisplay for tabular view"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2215dd494840e9b808bf6ea68149f77aec4ceb97", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/2215dd494840e9b808bf6ea68149f77aec4ceb97", "committedDate": "2020-06-19T14:54:02Z", "message": "DHFPROD-5177: Changes to EntitySearch API to accept propertiesToDisplay for tabular view"}, "afterCommit": {"oid": "6915e63bb518f55aa604debca6ef708c37e1d85c", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6915e63bb518f55aa604debca6ef708c37e1d85c", "committedDate": "2020-06-19T14:58:36Z", "message": "DHFPROD-5177: Changes to EntitySearch API to accept propertiesToDisplay for tabular view"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjIyODk4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#pullrequestreview-434222898", "createdAt": "2020-06-19T16:59:33Z", "commit": {"oid": "6915e63bb518f55aa604debca6ef708c37e1d85c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNjo1OTozM1rOGmblDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzowMDoxOFrOGmbmTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk1MDkyNg==", "bodyText": "This line can be deleted, right?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#discussion_r442950926", "createdAt": "2020-06-19T16:59:33Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -60,19 +66,21 @@ function addPropertiesToSearchResponse(entityName, searchResponse) {\n       }\n     }\n   });\n-\n   // Make it easy for the client to know which property names were used, and which ones exist\n+  // searchResponse.selectedPropertyDefinitions = selectedPropertyMetadata;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6915e63bb518f55aa604debca6ef708c37e1d85c"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk1MTI0Nw==", "bodyText": "What does \"granular\" mean in this context? Is it really \"selectedPropertyMetadata\"?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#discussion_r442951247", "createdAt": "2020-06-19T17:00:18Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -60,19 +66,21 @@ function addPropertiesToSearchResponse(entityName, searchResponse) {\n       }\n     }\n   });\n-\n   // Make it easy for the client to know which property names were used, and which ones exist\n+  // searchResponse.selectedPropertyDefinitions = selectedPropertyMetadata;\n   searchResponse.selectedPropertyDefinitions = selectedPropertyMetadata;\n   searchResponse.entityPropertyDefinitions = propertyMetadata;\n }\n \n-function buildPropertyMetadata(parentPropertyName, entityModel, entityName) {\n+// This function builds the logical entityType property metadata for all entityType properties from an entityModel.\n+function buildAllMetadata(parentPropertyName, entityModel, entityName) {\n   const entityType = entityModel.definitions[entityName];\n   if (!entityType) {\n     ds.throwServerError(\"Could not build property metadata; could not find entity type with name: \" + entityName);\n   }\n \n-  const allPropertyMetadata = [];\n+  const allPropertiesMetadata = [];\n+  let granularPropertyMetadata = {};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6915e63bb518f55aa604debca6ef708c37e1d85c"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjI2Mjgz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#pullrequestreview-434226283", "createdAt": "2020-06-19T17:05:36Z", "commit": {"oid": "6915e63bb518f55aa604debca6ef708c37e1d85c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d73b762ebc78d1c6c4679afe15f311496d78f107", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d73b762ebc78d1c6c4679afe15f311496d78f107", "committedDate": "2020-06-19T17:42:25Z", "message": "DHFPROD-5177: Changes to EntitySearch API to accept propertiesToDisplay for tabular view"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6915e63bb518f55aa604debca6ef708c37e1d85c", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6915e63bb518f55aa604debca6ef708c37e1d85c", "committedDate": "2020-06-19T14:58:36Z", "message": "DHFPROD-5177: Changes to EntitySearch API to accept propertiesToDisplay for tabular view"}, "afterCommit": {"oid": "d73b762ebc78d1c6c4679afe15f311496d78f107", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d73b762ebc78d1c6c4679afe15f311496d78f107", "committedDate": "2020-06-19T17:42:25Z", "message": "DHFPROD-5177: Changes to EntitySearch API to accept propertiesToDisplay for tabular view"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MzEwOTM1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#pullrequestreview-434310935", "createdAt": "2020-06-19T19:54:48Z", "commit": {"oid": "d73b762ebc78d1c6c4679afe15f311496d78f107"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MzQ3NDE1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#pullrequestreview-434347415", "createdAt": "2020-06-19T21:22:22Z", "commit": {"oid": "d73b762ebc78d1c6c4679afe15f311496d78f107"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MzYzNzA0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4102#pullrequestreview-434363704", "createdAt": "2020-06-19T22:15:33Z", "commit": {"oid": "d73b762ebc78d1c6c4679afe15f311496d78f107"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2796, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}