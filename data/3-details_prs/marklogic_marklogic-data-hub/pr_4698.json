{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwODQxMDE2", "number": 4698, "title": "DHFPROD-5988: Adding temporal collections", "bodyText": "If the list of collections specified by the user has a temporal collection then the documents are ingested vi temporal.documentInsert().\nDescription\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-10-09T22:05:45Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698", "merged": true, "mergeCommit": {"oid": "97a951dddd5b5d3730105fdad47d2955d754139f"}, "closed": true, "closedAt": "2020-10-13T04:12:49Z", "author": {"login": "SameeraPriyathamTadikonda"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ9pK0ABqjM4NjE5Mjg4OTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR-KFygFqTUwNzAwNzY1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba751c3bf45741b097e866b43440708ea8350c7e", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/ba751c3bf45741b097e866b43440708ea8350c7e", "committedDate": "2020-10-07T16:46:14Z", "message": "DHFPROD-6097: Disabling the Parallel Run"}, "afterCommit": {"oid": "bd0b077c2d11221c834ef81a72b4fce32ba580d2", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/bd0b077c2d11221c834ef81a72b4fce32ba580d2", "committedDate": "2020-10-09T22:02:20Z", "message": "DHFPROD-5988: Adding temporal collections\n\nAdding ingest temporal test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjM1MjQ4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698#pullrequestreview-506235248", "createdAt": "2020-10-12T00:32:40Z", "commit": {"oid": "bd0b077c2d11221c834ef81a72b4fce32ba580d2"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMDozMjo0MFrOHfr90g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMDozNDo0MlrOHfr-tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk4ODI0Mg==", "bodyText": "Pinging @srinathgit  about this - there's some duplication between this and invoke-queue-write.sjs. I think what both clients are asking is - are any of these temporal collections, and if so, can you please give me back the array of collections that I should use for inserting the document?\nIf the function returns null, then that means none of the collections are temporal, and the client should do an xdmp.documentInsert using whatever collections were provided.\nIf the functions returns an array of length 1 or greater, then that means at least one of the collections was temporal, and the client should do a temporal.documentInsert. And the client doesn't have to worry about filtering out \"latest\" and \"uri\" either, the function will handle it. Which means the function should take \"uri\" as an argument too.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698#discussion_r502988242", "createdAt": "2020-10-12T00:32:40Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/ingestion/bulkIngester.sjs", "diffHunk": "@@ -29,11 +29,21 @@ const consts = require(\"/data-hub/5/impl/consts.sjs\");\n const HubUtils = require(\"/data-hub/5/impl/hub-utils.sjs\");\n const state = fn.head(xdmp.fromJSON(endpointState));\n \n+const temporal = require(\"/MarkLogic/temporal.xqy\");\n+const temporalLib = require(\"/data-hub/5/temporal/hub-temporal.sjs\");\n+\n const work = fn.head(xdmp.fromJSON(workUnit));\n \n const uriPrefix = work.uriprefix != null ? work.uriprefix : \"\";\n \n const collections = work.collections != null ? work.collections.split(',') : [];\n+const temporalCollections = temporalLib.getTemporalCollections().toArray().reduce((acc, col) => {\n+    acc[col] = true;\n+    return acc;\n+}, {});\n+\n+let temporalCollection = collections.concat(collections).find((col) => temporalCollections[col]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0b077c2d11221c834ef81a72b4fce32ba580d2"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk4ODM0NA==", "bodyText": "Let's not change what was here - as the comments noted, data-hub-developer should work here. But the test was failing intermittently. Since the purpose of this test isn't to verify that a data-hub-developer can deploy temporal resources, it's fine to run it as admin.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698#discussion_r502988344", "createdAt": "2020-10-12T00:33:42Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/TemporalWriteTest.java", "diffHunk": "@@ -17,18 +19,21 @@\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n \n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.util.stream.Stream;\n+\n import static com.marklogic.client.io.DocumentMetadataHandle.Capability.*;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n \n public class TemporalWriteTest extends AbstractHubCoreTest {\n \n+    private InputEndpoint.BulkInputCaller bulkInputCaller;\n+\n     @BeforeEach\n     void setUp() {\n-        // In theory, a data-hub-developer should be able to deploy these temporal resources. But when run in the\n-        // full suite, this test sometimes fails, presumably due to changes made by a previous test to the databases.\n-        // Since the purpose of this test is to verify that temporal documents can be written as an operator and not\n-        // to verify that a developer can deploy these things (we have other tests for that), admin is used here\n-        runAsAdmin();\n+        runAsDataHubDeveloper();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0b077c2d11221c834ef81a72b4fce32ba580d2"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk4ODQ2OQ==", "bodyText": "Pinging @anu3990 - let's get this PR merged before your PR is merged that moves this module, that will avoid merge conflicts.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698#discussion_r502988469", "createdAt": "2020-10-12T00:34:42Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/TemporalWriteTest.java", "diffHunk": "@@ -75,15 +79,45 @@ void writeTemporalFile() {\n             \"declareUpdate();\\n\" +\n             \"temporal.documentDelete('temporal/test', '/temporal/ingestion/test.json');\";\n \n-        try{\n+        try {\n             runAsDataHubOperator().newStagingClient().newServerEval().javascript(deleteTemporalDoc).eval();\n-        }\n-        catch (Exception e){\n+        } catch (Exception e) {\n             logger.error(\"Document deletion failed: \", e);\n             Assertions.fail(\"dh-operator should be able to delete the document\");\n         }\n     }\n \n+    @Test\n+    void ingestDocWithTemporalCollecion() {\n+        String collections = \"fruits,stuff,temporal/test\";\n+        ObjectNode workUnit = objectMapper.createObjectNode();\n+        workUnit.put(\"uriprefix\", \"/bulkJavaTest/\");\n+        workUnit.put(\"collections\", collections);\n+        runAsDataHubOperator();\n+        InputEndpoint endpoint = InputEndpoint.on(\n+            getHubClient().getStagingClient(),\n+            getHubClient().getModulesClient().newTextDocumentManager().read(\"/data-hub/5/data-services/ingestion/bulkIngester.api\", new StringHandle())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0b077c2d11221c834ef81a72b4fce32ba580d2"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjM1NTU1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698#pullrequestreview-506235555", "createdAt": "2020-10-12T00:35:13Z", "commit": {"oid": "bd0b077c2d11221c834ef81a72b4fce32ba580d2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd0b077c2d11221c834ef81a72b4fce32ba580d2", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/bd0b077c2d11221c834ef81a72b4fce32ba580d2", "committedDate": "2020-10-09T22:02:20Z", "message": "DHFPROD-5988: Adding temporal collections\n\nAdding ingest temporal test"}, "afterCommit": {"oid": "4e5a8dd4f4b85fa1b0bfd675724f6e79bced80a3", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4e5a8dd4f4b85fa1b0bfd675724f6e79bced80a3", "committedDate": "2020-10-12T20:48:55Z", "message": "DHFPROD-5988: Adding temporal collections\n\nAdding ingest temporal test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e5a8dd4f4b85fa1b0bfd675724f6e79bced80a3", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4e5a8dd4f4b85fa1b0bfd675724f6e79bced80a3", "committedDate": "2020-10-12T20:48:55Z", "message": "DHFPROD-5988: Adding temporal collections\n\nAdding ingest temporal test"}, "afterCommit": {"oid": "7ba15b982670f87366bfd1b323563a23eb499184", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/7ba15b982670f87366bfd1b323563a23eb499184", "committedDate": "2020-10-12T20:50:31Z", "message": "DHFPROD-5988: Adding temporal collections\n\nAdding ingest temporal test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTE4NTAw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698#pullrequestreview-506918500", "createdAt": "2020-10-12T21:09:32Z", "commit": {"oid": "7ba15b982670f87366bfd1b323563a23eb499184"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMTowOTozMlrOHgNPeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMToxMTowNVrOHgNR9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzMzQzMw==", "bodyText": "We don't want this as a field, as it's only used by one test as a local variable.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698#discussion_r503533433", "createdAt": "2020-10-12T21:09:32Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/TemporalWriteTest.java", "diffHunk": "@@ -17,11 +19,18 @@\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n \n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.util.stream.Stream;\n+\n import static com.marklogic.client.io.DocumentMetadataHandle.Capability.*;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n \n public class TemporalWriteTest extends AbstractHubCoreTest {\n \n+    private InputEndpoint.BulkInputCaller bulkInputCaller;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ba15b982670f87366bfd1b323563a23eb499184"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzMzczMQ==", "bodyText": "This is only used once, and it's one line of code, so it's indirection that doesn't buy us anything - just put that one line of code in the one place where this method is invoked.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698#discussion_r503533731", "createdAt": "2020-10-12T21:10:19Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/TemporalWriteTest.java", "diffHunk": "@@ -134,4 +172,21 @@ private void addFieldAndIndexes() {\n         systemEndIndex.put(\"range-value-positions\", false);\n         new DatabaseManager(getHubConfig().getManageClient()).save(newNode.toString());\n     }\n+\n+    private InputStream asInputStream(String value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ba15b982670f87366bfd1b323563a23eb499184"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzNDA3MA==", "bodyText": "Same thing, this is only used once - just move the one line of code here to getDocumentMetadata.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698#discussion_r503534070", "createdAt": "2020-10-12T21:11:05Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/TemporalWriteTest.java", "diffHunk": "@@ -134,4 +172,21 @@ private void addFieldAndIndexes() {\n         systemEndIndex.put(\"range-value-positions\", false);\n         new DatabaseManager(getHubConfig().getManageClient()).save(newNode.toString());\n     }\n+\n+    private InputStream asInputStream(String value) {\n+        return new ByteArrayInputStream(value.getBytes());\n+    }\n+\n+    private DocumentMetadataHandle getDocumentMetadata() {\n+        String[] uris = getDocUris();\n+        assertTrue(uris.length > 0, \"Expected at least one fruit URI, found zero\");\n+        return getHubClient().getStagingClient().newDocumentManager().readMetadata(uris[0], new DocumentMetadataHandle());\n+    }\n+\n+    private String[] getDocUris() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ba15b982670f87366bfd1b323563a23eb499184"}, "originalPosition": 116}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ba15b982670f87366bfd1b323563a23eb499184", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/7ba15b982670f87366bfd1b323563a23eb499184", "committedDate": "2020-10-12T20:50:31Z", "message": "DHFPROD-5988: Adding temporal collections\n\nAdding ingest temporal test"}, "afterCommit": {"oid": "c8dd6917561bc76fef7a740d260818d93475d331", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c8dd6917561bc76fef7a740d260818d93475d331", "committedDate": "2020-10-12T21:47:34Z", "message": "DHFPROD-5988: Adding temporal collections\n\nAdding ingest temporal test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09bd64bb0f7c56c89fd12df93f01cf4770f7effc", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/09bd64bb0f7c56c89fd12df93f01cf4770f7effc", "committedDate": "2020-10-12T22:18:28Z", "message": "DHFPROD-5988: Adding temporal collections\n\nAdding ingest temporal test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c8dd6917561bc76fef7a740d260818d93475d331", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c8dd6917561bc76fef7a740d260818d93475d331", "committedDate": "2020-10-12T21:47:34Z", "message": "DHFPROD-5988: Adding temporal collections\n\nAdding ingest temporal test"}, "afterCommit": {"oid": "09bd64bb0f7c56c89fd12df93f01cf4770f7effc", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/09bd64bb0f7c56c89fd12df93f01cf4770f7effc", "committedDate": "2020-10-12T22:18:28Z", "message": "DHFPROD-5988: Adding temporal collections\n\nAdding ingest temporal test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDA1MTEx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698#pullrequestreview-507005111", "createdAt": "2020-10-13T01:09:33Z", "commit": {"oid": "09bd64bb0f7c56c89fd12df93f01cf4770f7effc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDA3NjU1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4698#pullrequestreview-507007655", "createdAt": "2020-10-13T01:19:05Z", "commit": {"oid": "09bd64bb0f7c56c89fd12df93f01cf4770f7effc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1985, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}