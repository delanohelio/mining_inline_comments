{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNzE2NDcy", "number": 3556, "title": "DHFPROD-4350: Ensure config directories in AppConfig get changed prop\u2026", "bodyText": "\u2026erly on install", "createdAt": "2020-02-06T05:30:12Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556", "merged": true, "mergeCommit": {"oid": "8ee5a3ea391fca3c3fa4b2fdf50e182367b48f7c"}, "closed": true, "closedAt": "2020-02-06T23:56:20Z", "author": {"login": "ryanjdew"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBlNZyAFqTM1NDIzMzU1NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBzkXQgFqTM1NDg1MDg3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjMzNTU1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#pullrequestreview-354233555", "createdAt": "2020-02-06T07:01:08Z", "commit": {"oid": "1ce33defe9da1ba6d3e7c2b83662bf7939d7258d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzowMTowOFrOFmQ6fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzowMTowOFrOFmQ6fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY2NzMyNA==", "bodyText": "String directory = payload.get(\"directory\");\nIf (StringUtils.isEmpty(directory)) { // input validation should be checked in UI side, and here just in case\n    //maybe logger.error(...)\n    return payload;\n}\nhubConfig.createProject(directory);\n...\n\nwe had better put the line  \"environmentService.setProjectDirectory(directory)\" to the end when dhf has been succcessfully installed.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#discussion_r375667324", "createdAt": "2020-02-06T07:01:08Z", "author": {"login": "hao1st"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java", "diffHunk": "@@ -106,23 +108,23 @@ public void onError(String commandName, Exception exception) {\n                 template.convertAndSend(\"/topic/install-status\", new StatusMessage(lastPercentageComplete, message));\n                 logger.error(message, exception);\n                 dataHubConfigurationException[0] = exception;\n-                environmentService.setProjectDirectory(originalDirectory);\n             }\n         };\n         // setting the project directory will resolve any relative paths\n         try {\n             environmentService.setProjectDirectory(payload.get(\"directory\").asText(\"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce33defe9da1ba6d3e7c2b83662bf7939d7258d"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjQ1MTAy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#pullrequestreview-354245102", "createdAt": "2020-02-06T07:34:16Z", "commit": {"oid": "1ce33defe9da1ba6d3e7c2b83662bf7939d7258d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzozNDoxN1rOFmReOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzozNDoxN1rOFmReOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3NjQ3NQ==", "bodyText": "After checking the HubConfigImpl, I think we can simplify unnecessary calls here. We even do not need to check if the hubConfigImpl.getAppConfig() is null because it is null for sure.\nHubConfigImpl.java\nprotected void hydrateAppConfigs(Properties properties) {\n    com.marklogic.mgmt.util.PropertySource propertySource = properties::getProperty;\n\n    if (appConfig != null) {\n        // Still need to call this since the setter also \"updates\" appConfig with DHF-specific values\n        setAppConfig(appConfig);\n    } else {\n        DefaultAppConfigFactory appConfigFactory = new DefaultAppConfigFactory(propertySource);\n        if (hubProject != null && !StringUtils.isEmpty(hubProject.getProjectDirString())) {\n            appConfigFactory.setProjectDir(hubProject.getProjectDir().toFile());\n        }\n        setAppConfig(appConfigFactory.newAppConfig());\n    }\n\n}\n...\nafter changing the HubConfigImpl class as above, we can only have the following three lines' codes\nhubConfigImpl.createProject(projectDirectory);\nhubConfigImpl.refreshProject();\nthis.dataHub = new DataHubImpl(this);\nIdeally,  we also should make the similar modification for initHubProject in HubConfigImpl.java\n@Override \n public void initHubProject() {\n        if (appConfig == null) {\n            DefaultAppConfigFactory appConfigFactory = new DefaultAppConfigFactory();\n            if (hubProject != null && !StringUtils.isEmpty(hubProject.getProjectDirString())) {\n                appConfigFactory.setProjectDir(hubProject.getProjectDir().toFile());\n            }\n            appConfig = appConfigFactory.newAppConfig();\n        }\n        addDhfPropertiesToCustomTokens(appConfig);\n        this.requireHubProject().init(appConfig.getCustomTokens());\n   }", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#discussion_r375676475", "createdAt": "2020-02-06T07:34:17Z", "author": {"login": "hao1st"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java", "diffHunk": "@@ -1000,14 +1002,14 @@ public void afterPropertiesSet() throws Exception {\n         if (hubConfigImpl.getAdminManager() == null) {\n             hubConfigImpl.setAdminManager(new AdminManager());\n         }\n+        String projectDirectory = environmentService.getProjectDirectory();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce33defe9da1ba6d3e7c2b83662bf7939d7258d"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NTI0NDYx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#pullrequestreview-354524461", "createdAt": "2020-02-06T15:10:12Z", "commit": {"oid": "1ce33defe9da1ba6d3e7c2b83662bf7939d7258d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNToxMDoxMlrOFmejHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNToxMzowNVrOFmeqKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg5MDcxNg==", "bodyText": "@hao1st Are you saying to change hydrateAppConfigs? I know for certain that AppConfig is not always null in the context of that method.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#discussion_r375890716", "createdAt": "2020-02-06T15:10:12Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java", "diffHunk": "@@ -1000,14 +1002,14 @@ public void afterPropertiesSet() throws Exception {\n         if (hubConfigImpl.getAdminManager() == null) {\n             hubConfigImpl.setAdminManager(new AdminManager());\n         }\n+        String projectDirectory = environmentService.getProjectDirectory();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3NjQ3NQ=="}, "originalCommit": {"oid": "1ce33defe9da1ba6d3e7c2b83662bf7939d7258d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg5MjUyMA==", "bodyText": "I think we really need unit tests for the changes in here. My experience over the past couple months with trying to make changes to HubConfigImpl is that it's very difficult to know what any change might break, due to the class doing too many things. You can likely pull some of these changes into protected methods so that it's easier to test what they're doing.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#discussion_r375892520", "createdAt": "2020-02-06T15:13:05Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java", "diffHunk": "@@ -1000,14 +1002,14 @@ public void afterPropertiesSet() throws Exception {\n         if (hubConfigImpl.getAdminManager() == null) {\n             hubConfigImpl.setAdminManager(new AdminManager());\n         }\n+        String projectDirectory = environmentService.getProjectDirectory();\n         if (hubConfigImpl.getAppConfig() == null) {\n-            hubConfigImpl.setAppConfig(new AppConfig(), true);\n+            hubConfigImpl.setAppConfig(new AppConfig(Paths.get(projectDirectory).toFile()), true);\n         }\n-        hubConfigImpl.createProject(environmentService.getProjectDirectory());\n+        hubConfigImpl.createProject(projectDirectory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce33defe9da1ba6d3e7c2b83662bf7939d7258d"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ce33defe9da1ba6d3e7c2b83662bf7939d7258d", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/1ce33defe9da1ba6d3e7c2b83662bf7939d7258d", "committedDate": "2020-02-06T05:27:39Z", "message": "DHFPROD-4350: Ensure config directories in AppConfig get changed properly on install"}, "afterCommit": {"oid": "c791aa83f614f2dfc88e1dcfea4caf4e417f8215", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c791aa83f614f2dfc88e1dcfea4caf4e417f8215", "committedDate": "2020-02-06T21:43:02Z", "message": "DHFPROD-4350: Ensure config directories in AppConfig get changed properly on install"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c791aa83f614f2dfc88e1dcfea4caf4e417f8215", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c791aa83f614f2dfc88e1dcfea4caf4e417f8215", "committedDate": "2020-02-06T21:43:02Z", "message": "DHFPROD-4350: Ensure config directories in AppConfig get changed properly on install"}, "afterCommit": {"oid": "5d96d9e5f81358584d53fff576c8b8ecb4372d2f", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5d96d9e5f81358584d53fff576c8b8ecb4372d2f", "committedDate": "2020-02-06T21:44:35Z", "message": "DHFPROD-4350: Ensure config directories in AppConfig get changed properly on install"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0Nzk0NzAx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#pullrequestreview-354794701", "createdAt": "2020-02-06T21:46:06Z", "commit": {"oid": "c791aa83f614f2dfc88e1dcfea4caf4e417f8215"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da889fb21c171343182e4a9ec07592429ec277d8", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/da889fb21c171343182e4a9ec07592429ec277d8", "committedDate": "2020-02-06T21:55:09Z", "message": "DHFPROD-4350: Ensure config directories in AppConfig get changed properly on install"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d96d9e5f81358584d53fff576c8b8ecb4372d2f", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5d96d9e5f81358584d53fff576c8b8ecb4372d2f", "committedDate": "2020-02-06T21:44:35Z", "message": "DHFPROD-4350: Ensure config directories in AppConfig get changed properly on install"}, "afterCommit": {"oid": "da889fb21c171343182e4a9ec07592429ec277d8", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/da889fb21c171343182e4a9ec07592429ec277d8", "committedDate": "2020-02-06T21:55:09Z", "message": "DHFPROD-4350: Ensure config directories in AppConfig get changed properly on install"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODAxNzY0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#pullrequestreview-354801764", "createdAt": "2020-02-06T21:58:23Z", "commit": {"oid": "da889fb21c171343182e4a9ec07592429ec277d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODAzNDYx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#pullrequestreview-354803461", "createdAt": "2020-02-06T22:01:13Z", "commit": {"oid": "da889fb21c171343182e4a9ec07592429ec277d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODUwODc2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3556#pullrequestreview-354850876", "createdAt": "2020-02-06T23:44:53Z", "commit": {"oid": "da889fb21c171343182e4a9ec07592429ec277d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3251, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}