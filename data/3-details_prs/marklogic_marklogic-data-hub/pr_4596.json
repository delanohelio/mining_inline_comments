{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NTY3MTE5", "number": 4596, "title": "DHFPROD-5974: Ingest documents with user-defined prefix and guaranteed unique URI", "bodyText": "Description\nThis pull request focuses on the changes needed for - https://project.marklogic.com/jira/browse/DHFPROD-5974\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-09-18T22:25:50Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596", "merged": true, "mergeCommit": {"oid": "0c72752b29c8fdabc9ca6fdd7977e8d981495273"}, "closed": true, "closedAt": "2020-09-23T21:34:15Z", "author": {"login": "anu3990"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKPJztAFqTQ5MTg0MTM0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLxvLggFqTQ5NDk4MTA0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxODQxMzQ5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#pullrequestreview-491841349", "createdAt": "2020-09-19T00:35:46Z", "commit": {"oid": "84d155065ce1b672ed5fc3bb4534848caea3bef8"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxOTk4OTcz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#pullrequestreview-491998973", "createdAt": "2020-09-19T13:31:41Z", "commit": {"oid": "84d155065ce1b672ed5fc3bb4534848caea3bef8"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84d155065ce1b672ed5fc3bb4534848caea3bef8", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/84d155065ce1b672ed5fc3bb4534848caea3bef8", "committedDate": "2020-09-18T22:21:01Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}, "afterCommit": {"oid": "93bc57a6b4b8635ed418e29640fa0293829ca45e", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/93bc57a6b4b8635ed418e29640fa0293829ca45e", "committedDate": "2020-09-21T19:32:13Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTg1NzQ3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#pullrequestreview-492985747", "createdAt": "2020-09-21T21:15:37Z", "commit": {"oid": "93bc57a6b4b8635ed418e29640fa0293829ca45e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMToxNTozN1rOHVir_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMToxNTozN1rOHVir_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1MDQ2MA==", "bodyText": "This test is a little brittle in that if the structure of the document doesn't match, we'll get a null-pointer exception.\nInstead of doing a cts.uriMatch, I recommend doing a cts.uris query like this:\ncts.uris(null, [limit='1'], cts.andQuery([\n  cts.directoryQuery(\"/testFruit/\"),\n  cts.jsonPropertyValueQuery(\"fruitName\", someVariable)\n]))\n\nYou can use newServerEval to execute that and then verify that you get 1 result back and that it starts with \"/testFruit/\".\nThat results in a much simpler test and also much less chance of a null-pointer occurring.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#discussion_r492350460", "createdAt": "2020-09-21T21:15:37Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/WriteDataTest.java", "diffHunk": "@@ -91,10 +94,24 @@ private void verifyFruitCount(int expectedCount, String message) {\n         assertEquals(expectedCount, Integer.parseInt(count), message);\n \n         if (expectedCount > 0) {\n-            String expectedUri = \"/testFruit/2/1.json\";\n-            JsonNode doc = getHubClient().getStagingClient().newJSONDocumentManager().read(expectedUri, new JacksonHandle()).get();\n-            assertEquals(\"apple\", doc.get(\"envelope\").get(\"instance\").get(\"fruitName\").asText());\n-            assertEquals(\"red\", doc.get(\"envelope\").get(\"instance\").get(\"fruitColor\").asText());\n+        String uriQuery = \"cts.uriMatch('/testFruit/**')\";\n+        EvalResultIterator uriQueryResult = getHubClient().getStagingClient().newServerEval().javascript(uriQuery).eval();\n+        AtomicBoolean foundRedApple = new AtomicBoolean(false);\n+        AtomicBoolean foundYellowBanana = new AtomicBoolean(false);\n+        uriQueryResult.iterator().forEachRemaining(item -> {\n+            final String expectUri = item.getString();\n+            JsonNode doc = getHubClient().getStagingClient().newJSONDocumentManager().read(expectUri, new JacksonHandle()).get();\n+            if((doc.get(\"envelope\").get(\"instance\").get(\"fruitName\").asText().equals(\"apple\")) &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93bc57a6b4b8635ed418e29640fa0293829ca45e"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93bc57a6b4b8635ed418e29640fa0293829ca45e", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/93bc57a6b4b8635ed418e29640fa0293829ca45e", "committedDate": "2020-09-21T19:32:13Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}, "afterCommit": {"oid": "4b8b72e4d115d083d4280c1e345093bcc4321295", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4b8b72e4d115d083d4280c1e345093bcc4321295", "committedDate": "2020-09-22T05:17:46Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMzY2MDUz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#pullrequestreview-493366053", "createdAt": "2020-09-22T11:33:39Z", "commit": {"oid": "4b8b72e4d115d083d4280c1e345093bcc4321295"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMTozMzozOVrOHV1vVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMTozMzozOVrOHV1vVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY2MjYxMg==", "bodyText": "Just realized that we should leave out \"/\". That allows Ernie to have URIs of the form \"(uuid).json\" if he wants. That's consistent with how MLCP works as well - i.e. no \"/\" is added unless the user configures one.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#discussion_r492662612", "createdAt": "2020-09-22T11:33:39Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/ingestion/bulkIngester.sjs", "diffHunk": "@@ -36,7 +36,7 @@ const inputs =\n       [{UNKNOWN: input}];\n inputs.forEach(record => {\n   state.next = state.next + 1;\n-  const uri = (state.prefix) + '/' + (work.taskId) + '/' + (state.next) + '.json';\n+  const uri = (state.uriprefix) + '/' + sem.uuidString() + '.json';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b8b72e4d115d083d4280c1e345093bcc4321295"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b8b72e4d115d083d4280c1e345093bcc4321295", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4b8b72e4d115d083d4280c1e345093bcc4321295", "committedDate": "2020-09-22T05:17:46Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}, "afterCommit": {"oid": "d150d85a54d1189db5f6ff873d07785038f430f7", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d150d85a54d1189db5f6ff873d07785038f430f7", "committedDate": "2020-09-22T17:55:01Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzEzNjAy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#pullrequestreview-493713602", "createdAt": "2020-09-22T17:58:00Z", "commit": {"oid": "d150d85a54d1189db5f6ff873d07785038f430f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzY0NDgy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#pullrequestreview-493764482", "createdAt": "2020-09-22T19:06:13Z", "commit": {"oid": "d150d85a54d1189db5f6ff873d07785038f430f7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d150d85a54d1189db5f6ff873d07785038f430f7", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d150d85a54d1189db5f6ff873d07785038f430f7", "committedDate": "2020-09-22T17:55:01Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}, "afterCommit": {"oid": "f7e48441014a4bde28f5b552c6c40a279387eec3", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/f7e48441014a4bde28f5b552c6c40a279387eec3", "committedDate": "2020-09-22T23:28:30Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTIzNzE1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#pullrequestreview-493923715", "createdAt": "2020-09-23T00:00:29Z", "commit": {"oid": "f7e48441014a4bde28f5b552c6c40a279387eec3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7e48441014a4bde28f5b552c6c40a279387eec3", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/f7e48441014a4bde28f5b552c6c40a279387eec3", "committedDate": "2020-09-22T23:28:30Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}, "afterCommit": {"oid": "9ec12f11d1891a5f2ca5bd2125cd577ad99a7812", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9ec12f11d1891a5f2ca5bd2125cd577ad99a7812", "committedDate": "2020-09-23T18:11:12Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTIzNDM4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#pullrequestreview-494923438", "createdAt": "2020-09-23T18:14:49Z", "commit": {"oid": "9ec12f11d1891a5f2ca5bd2125cd577ad99a7812"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTMxMjcz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#pullrequestreview-494931273", "createdAt": "2020-09-23T18:25:29Z", "commit": {"oid": "9ec12f11d1891a5f2ca5bd2125cd577ad99a7812"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODoyNToyOVrOHW7Jiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODoyOToyOFrOHW7Syg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5OTgxOQ==", "bodyText": "No need to change here, but most of the time, it's sufficient to just do this:\nString uri = getHubClient().getStagingClient().newServerEval().javascript(query).evalAs(String.class);\n\nIf that fails because there's not a URI, that's totally fine. And we don't need to worry about verifying that there's not another URI - we know the database was cleaned before the test ran, so it's safe to assume there's one or zero URIs.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#discussion_r493799819", "createdAt": "2020-09-23T18:25:29Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/WriteDataTest.java", "diffHunk": "@@ -48,6 +47,25 @@ void ingestThreeFruitsWithBatchSizeOfTwo() throws IOException {\n         verifyFruitCount(3, \"The commit call should result in the 3rd fruit being ingested\");\n     }\n \n+\n+    @Test\n+    public void testBulkIngestWithoutUriPrefix() throws IOException {\n+        DataWriter<InternalRow> dataWriter = buildDataWriter(\"1\", \"\");\n+        dataWriter.write(buildRow(\"pineapple\", \"green\"));\n+\n+        String uriQuery = \"cts.uris('', null, cts.andQuery([\\n\" +\n+            \"  cts.jsonPropertyValueQuery('fruitName', 'pineapple')\\n\" +\n+            \"]))\";\n+\n+        EvalResultIterator uriQueryResult = getHubClient().getStagingClient().newServerEval().javascript(uriQuery).eval();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec12f11d1891a5f2ca5bd2125cd577ad99a7812"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgwMjE4Ng==", "bodyText": "Assertion calls are often the best place to document why something should be the way it is. In this case, there's a question of - well why doesn't it start with \"/\"? So I'd do:\nassertFalse(uri.startsWith(\"/\"), \"If the user wants the URI to start with a forward slash, the user must provide one. If the user doesn't, then it's assumed that the user doesn't want a forward slash at the start of the URI, so the endpoint will not add one automatically.\");\n\nThat makes it very clear why it's expected. This isn't needed for every assertion, but this is a good one to document in the above manner.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#discussion_r493802186", "createdAt": "2020-09-23T18:29:28Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/WriteDataTest.java", "diffHunk": "@@ -48,6 +47,25 @@ void ingestThreeFruitsWithBatchSizeOfTwo() throws IOException {\n         verifyFruitCount(3, \"The commit call should result in the 3rd fruit being ingested\");\n     }\n \n+\n+    @Test\n+    public void testBulkIngestWithoutUriPrefix() throws IOException {\n+        DataWriter<InternalRow> dataWriter = buildDataWriter(\"1\", \"\");\n+        dataWriter.write(buildRow(\"pineapple\", \"green\"));\n+\n+        String uriQuery = \"cts.uris('', null, cts.andQuery([\\n\" +\n+            \"  cts.jsonPropertyValueQuery('fruitName', 'pineapple')\\n\" +\n+            \"]))\";\n+\n+        EvalResultIterator uriQueryResult = getHubClient().getStagingClient().newServerEval().javascript(uriQuery).eval();\n+        assertTrue(uriQueryResult.hasNext());\n+        String uri = uriQueryResult.next().getString();\n+\n+        assertTrue(uri.endsWith(\".json\"));\n+        assertFalse(uri.startsWith(\"/\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec12f11d1891a5f2ca5bd2125cd577ad99a7812"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a1609b03384217e608bf89ac0d07e1a73bd11fe", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4a1609b03384217e608bf89ac0d07e1a73bd11fe", "committedDate": "2020-09-23T18:41:55Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ec12f11d1891a5f2ca5bd2125cd577ad99a7812", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9ec12f11d1891a5f2ca5bd2125cd577ad99a7812", "committedDate": "2020-09-23T18:11:12Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}, "afterCommit": {"oid": "4a1609b03384217e608bf89ac0d07e1a73bd11fe", "author": {"user": {"login": "anu3990", "name": "Anushree Sinha"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4a1609b03384217e608bf89ac0d07e1a73bd11fe", "committedDate": "2020-09-23T18:41:55Z", "message": "DHFPROD-5974 : Ingest documents with user-defined prefix and guaranteed unique URI (https://project.marklogic.com/jira/browse/DHFPROD-5974)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTUwNjUw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#pullrequestreview-494950650", "createdAt": "2020-09-23T18:44:47Z", "commit": {"oid": "4a1609b03384217e608bf89ac0d07e1a73bd11fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTgxMDQy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4596#pullrequestreview-494981042", "createdAt": "2020-09-23T19:27:17Z", "commit": {"oid": "4a1609b03384217e608bf89ac0d07e1a73bd11fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2111, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}