{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NDQyMDI0", "number": 4654, "title": "DHFPROD-5865: Generate explorer search options w/o conflicting with entity-type name", "bodyText": "Also removed exp-default.xml staging and final options that aren't used anymore\nDescription\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-10-01T17:50:01Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4654", "merged": true, "mergeCommit": {"oid": "a505edba8b4bb44468a41b62c494d8fcd96d725a"}, "closed": true, "closedAt": "2020-10-05T21:32:57Z", "author": {"login": "akshaysonvane"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOVjglAFqTUwMDYwMjk2NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPp1XnAFqTUwMjM5NzQxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjAyOTY0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4654#pullrequestreview-500602964", "createdAt": "2020-10-01T18:15:30Z", "commit": {"oid": "e76307605abb2e57777706b04c37859c0c785e0e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoxNTozMFrOHbV1EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoxODoxNVrOHbV61g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzMTI0OA==", "bodyText": "Pinging @fsnow  to confirm, as I'm forgetting xquery each day, but I'm pretty certain that since you have a node or an empty sequence here, you can just do this:\nif ($search-container-node)\n\nThough the more elegant approach would be this:\nlet $container := $n/search:container\nwhere fn:not($container)\nreturn ...\n\nI like let/where/return as a replacement for an if/else where either condition has empty sequence as a return value", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4654#discussion_r498431248", "createdAt": "2020-10-01T18:15:30Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/hub-entities.xqy", "diffHunk": "@@ -201,25 +201,30 @@ declare %private function hent:fix-options-for-explorer(\n           hent:fix-options-for-explorer($n/node(), $sortable-properties, $entity-namespace-map)\n         }\n       case element(search:constraint) return\n-        element { fn:node-name($n) } {\n-          $n/@*,\n-          let $path-expression := fix-path-expression(fn:string($n/search:range/search:path-index))\n-          let $search-range-node := $n/search:range\n-          let $is-sortable-only :=\n-            let $sort-info := map:get($sortable-properties, $path-expression)\n-            return\n-              if (fn:exists($sort-info)) then map:get($sort-info, \"is-sortable-only\") = fn:true()\n-              else fn:false()\n-          return\n-            if (fn:empty($search-range-node) or fn:not($is-sortable-only)) then\n-              hent:fix-options-for-explorer($n/node(), $sortable-properties, $entity-namespace-map)\n-            else\n-              element {fn:node-name($search-range-node)} {\n-                $search-range-node/attribute()[not(name()='facet')],\n-                attribute facet {\"false\"},\n-                hent:fix-options-for-explorer($search-range-node, $sortable-properties, $entity-namespace-map)/node()\n-              }\n-        }\n+        let $search-container-node := $n/search:container\n+        return\n+          if (fn:not(fn:empty($search-container-node))) then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76307605abb2e57777706b04c37859c0c785e0e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzMTYxNw==", "bodyText": "And to make it more self-documenting, you could do this:\nlet $container-for-entity-property-generated-by-es := $n/search:container", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4654#discussion_r498431617", "createdAt": "2020-10-01T18:16:07Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/hub-entities.xqy", "diffHunk": "@@ -201,25 +201,30 @@ declare %private function hent:fix-options-for-explorer(\n           hent:fix-options-for-explorer($n/node(), $sortable-properties, $entity-namespace-map)\n         }\n       case element(search:constraint) return\n-        element { fn:node-name($n) } {\n-          $n/@*,\n-          let $path-expression := fix-path-expression(fn:string($n/search:range/search:path-index))\n-          let $search-range-node := $n/search:range\n-          let $is-sortable-only :=\n-            let $sort-info := map:get($sortable-properties, $path-expression)\n-            return\n-              if (fn:exists($sort-info)) then map:get($sort-info, \"is-sortable-only\") = fn:true()\n-              else fn:false()\n-          return\n-            if (fn:empty($search-range-node) or fn:not($is-sortable-only)) then\n-              hent:fix-options-for-explorer($n/node(), $sortable-properties, $entity-namespace-map)\n-            else\n-              element {fn:node-name($search-range-node)} {\n-                $search-range-node/attribute()[not(name()='facet')],\n-                attribute facet {\"false\"},\n-                hent:fix-options-for-explorer($search-range-node, $sortable-properties, $entity-namespace-map)/node()\n-              }\n-        }\n+        let $search-container-node := $n/search:container\n+        return\n+          if (fn:not(fn:empty($search-container-node))) then", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzMTI0OA=="}, "originalCommit": {"oid": "e76307605abb2e57777706b04c37859c0c785e0e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzMjcyNg==", "bodyText": "These assertions should have a message explaining why we don't want these here - i.e. touch on the Collection constraint and the fact that Explorer doesn't need these container constraints.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4654#discussion_r498432726", "createdAt": "2020-10-01T18:18:15Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/impl/hub-entities/generateSearchOptions.sjs", "diffHunk": "@@ -359,6 +359,31 @@ function testHubCentralSupportedDatatypeMappingsForSort() {\n   return assertions;\n }\n \n+function generateExplorerOptionsWithoutContainerConstraint() {\n+  const input =\n+    [{\n+      \"info\": {\n+        \"title\": \"Book\"\n+      },\n+      \"definitions\": {\n+        \"Book\": {\n+          \"properties\": {\n+            \"publishedAtAddress\": {\"$ref\": \"#/definitions/Address\"}\n+          }\n+        },\n+        \"Address\": {\n+          \"properties\": {}\n+        }\n+      }\n+    }];\n+  const options = hent.dumpSearchOptions(input, true);\n+\n+  return [\n+    test.assertNotExists(options.xpath(\"/*:constraint[@name = 'Book']/*:container\")),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76307605abb2e57777706b04c37859c0c785e0e"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e76307605abb2e57777706b04c37859c0c785e0e", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/e76307605abb2e57777706b04c37859c0c785e0e", "committedDate": "2020-10-01T17:47:32Z", "message": "DHFPROD-5865: Generate explorer search options w/o conflicting with entity-type name\nAlso removed exp-default.xml staging and final options that arent used anymore"}, "afterCommit": {"oid": "d5ad9b99446cd5fad5f1b80d883e115a50a69f66", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d5ad9b99446cd5fad5f1b80d883e115a50a69f66", "committedDate": "2020-10-05T18:11:58Z", "message": "DHFPROD-5865: Generate explorer search options w/o conflicting with entity-type name\nAlso removed exp-default.xml staging and final options that arent used anymore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzExODY0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4654#pullrequestreview-502311864", "createdAt": "2020-10-05T18:26:05Z", "commit": {"oid": "d5ad9b99446cd5fad5f1b80d883e115a50a69f66"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODoyNjowNVrOHcou4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODoyNjowNVrOHcou4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc4OTUzOA==", "bodyText": "This is good, but the test needs to assert two more things - that the \"default\" options were written to src/main/entity-config in the project directory, and that they are not in the modules database because of the conflict between Collection constraints.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4654#discussion_r499789538", "createdAt": "2020-10-05T18:26:05Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/entity/EntityManagerTest.java", "diffHunk": "@@ -191,6 +194,33 @@ public void overrideExistingExplorerOptions() {\n         assertTrue(newStagingOptionsTimeStamp > oldStagingOptionsTimeStamp);\n     }\n \n+    @Test\n+    public void deployExplorerOptionsWithoutContainerConstraint() {\n+        Path entitiesDir = getHubProject().getHubEntitiesDir();\n+        if (!entitiesDir.toFile().exists()) {\n+            entitiesDir.toFile().mkdirs();\n+        }\n+        FileUtil.copy(getResourceStream(\"scaffolding-test/Collection.entity.json\"),\n+                entitiesDir.resolve(\"Collection.entity.json\").toFile());\n+\n+        runAsDataHubDeveloper();\n+        entityManager.deployQueryOptions();\n+\n+        runAsAdmin();\n+        Stream.of(HubConfig.DEFAULT_STAGING_NAME, HubConfig.DEFAULT_FINAL_NAME)\n+                .forEach(dbName -> assertNull(getModulesFile(\"/Default/\" + dbName + \"/rest-api/options/exp-default.xml\"), \"Did not expect exp-default.xml options file in \" + dbName + \"since we dont use it anymore.\"));\n+\n+        String stagingExplorerOptions = getModulesFile(\"/Default/\" + HubConfig.DEFAULT_STAGING_NAME + \"/rest-api/options/\" + HubConfig.EXP_STAGING_ENTITY_QUERY_OPTIONS_FILE);\n+        String finalExplorerOptions = getModulesFile(\"/Default/\" + HubConfig.DEFAULT_FINAL_NAME + \"/rest-api/options/\" + HubConfig.EXP_FINAL_ENTITY_QUERY_OPTIONS_FILE);\n+\n+        Stream.of(stagingExplorerOptions, finalExplorerOptions).forEach(option -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ad9b99446cd5fad5f1b80d883e115a50a69f66"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7b5309be26f457770a2b2f168cce55363911a07", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/a7b5309be26f457770a2b2f168cce55363911a07", "committedDate": "2020-10-05T19:20:02Z", "message": "DHFPROD-5865: Generate explorer search options w/o conflicting with entity-type name\nAlso removed exp-default.xml staging and final options that arent used anymore"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5ad9b99446cd5fad5f1b80d883e115a50a69f66", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d5ad9b99446cd5fad5f1b80d883e115a50a69f66", "committedDate": "2020-10-05T18:11:58Z", "message": "DHFPROD-5865: Generate explorer search options w/o conflicting with entity-type name\nAlso removed exp-default.xml staging and final options that arent used anymore"}, "afterCommit": {"oid": "a7b5309be26f457770a2b2f168cce55363911a07", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/a7b5309be26f457770a2b2f168cce55363911a07", "committedDate": "2020-10-05T19:20:02Z", "message": "DHFPROD-5865: Generate explorer search options w/o conflicting with entity-type name\nAlso removed exp-default.xml staging and final options that arent used anymore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzU5ODQ2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4654#pullrequestreview-502359846", "createdAt": "2020-10-05T19:35:15Z", "commit": {"oid": "a7b5309be26f457770a2b2f168cce55363911a07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzk3NDE5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4654#pullrequestreview-502397419", "createdAt": "2020-10-05T20:30:30Z", "commit": {"oid": "a7b5309be26f457770a2b2f168cce55363911a07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1921, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}