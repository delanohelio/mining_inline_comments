{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyMTE4NTg2", "number": 4535, "title": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle", "bodyText": "Description\n\nUpdates to README with example of curationEndpoint requested by cloud services team and steps to run e2e test against DHS.\nUpdated setup script and build.gradle to include task to verify flow was run successfully by checking record count in staging and final database\n\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n[ NA ] Added Tests\n\n\nReviewer:\n\n\n[ NA ] Reviewed Tests", "createdAt": "2020-09-08T15:15:11Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535", "merged": true, "mergeCommit": {"oid": "78570a8f632353fc3c2f8eedc115ea33b3724568"}, "closed": true, "closedAt": "2020-09-08T21:14:19Z", "author": {"login": "bsrikan"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdG5LvyAFqTQ4NDI0Nzg5NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdG7ijJgFqTQ4NDM3NTM2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MjQ3ODk0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#pullrequestreview-484247894", "createdAt": "2020-09-08T15:18:12Z", "commit": {"oid": "c1d6a266605caf65d22603105c038d119a754c1a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNToxODoxMlrOHOiNxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNToxODoxMlrOHOiNxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAwMjY5NQ==", "bodyText": "@SameeraPriyathamTadikonda can you pls verify the steps noted here for DHS is what we follow in  Jenkins as well for e2e tests running against DHS.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485002695", "createdAt": "2020-09-08T15:18:12Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub-central/ui/e2e/README.md", "diffHunk": "@@ -4,28 +4,39 @@ This hc-qa-project is intended to run HC e2e test.\n \n Run the setup script first from under `marklogic-data-hub-central/ui/e2e` directory, to initialize, deploy and run flows:\n \n-    ./setup.sh dhs=<true/false> mlHost=<curatoinEndpoint/localhost>\n- \n+    For DHS -", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1d6a266605caf65d22603105c038d119a754c1a"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0Mjc0MDg4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#pullrequestreview-484274088", "createdAt": "2020-09-08T15:47:33Z", "commit": {"oid": "c1d6a266605caf65d22603105c038d119a754c1a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0NzozNFrOHOjc3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0OTozOFrOHOjiVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMjk0MQ==", "bodyText": "Does \"curation endpoint\" mean \"a host with one or more app servers assigned to the Curation group in ML\"? I ask because I don't believe that group is guaranteed to exist in DHS. I think what matters is that the host has all the app servers that setup.sh depends on.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485022941", "createdAt": "2020-09-08T15:47:34Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/ui/e2e/README.md", "diffHunk": "@@ -4,28 +4,39 @@ This hc-qa-project is intended to run HC e2e test.\n \n Run the setup script first from under `marklogic-data-hub-central/ui/e2e` directory, to initialize, deploy and run flows:\n \n-    ./setup.sh dhs=<true/false> mlHost=<curatoinEndpoint/localhost>\n- \n+    For DHS -\n+        * Create users as admin using the payload in cypress/fixtures/users for the tests\n+        * ./setup.sh dhs=true mlHost=<curationEndpoint>\n+            * example of curation endpoint is dwgz7dnkj.ec2dentifier10.a.marklogicsvc.com", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1d6a266605caf65d22603105c038d119a754c1a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyNDM0Mw==", "bodyText": "Instead of requiring a property to be specified, I recommend making two concrete tasks - e.g. verifyStagingCounts and verifyFinalCounts. Those are easier for a user to invoke and they have self-documenting task names.\n\"script\" then becomes a property of your custom task class. CallResourceTask in https://github.com/marklogic-community/ml-gradle/wiki/Writing-your-own-task is an example of that.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485024343", "createdAt": "2020-09-08T15:49:38Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/ui/e2e/hc-qa-project/build.gradle", "diffHunk": "@@ -49,3 +51,32 @@ task loadThesaurus(type: com.marklogic.gradle.task.MlcpTask) {\n }\n \n hubDeployAsDeveloper.finalizedBy(\"loadThesaurus\")\n+\n+class DocCount extends HubTask {\n+    @TaskAction\n+    def getDocCount() {\n+        int result\n+        String script\n+        def client\n+        def propName = \"database\"\n+        def database = project.hasProperty(propName) ? project.property(propName).toString() : null\n+        if (database == null) {\n+            throw new GradleException(\"Please specify a database via -Pdatabase=(name of staging or final database)\")\n+        } else if(database == \"staging\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1d6a266605caf65d22603105c038d119a754c1a"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1d6a266605caf65d22603105c038d119a754c1a", "author": {"user": {"login": "bsrikan", "name": "Srikanth Balasubramanian"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c1d6a266605caf65d22603105c038d119a754c1a", "committedDate": "2020-09-08T15:11:34Z", "message": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle to include task to verify flow"}, "afterCommit": {"oid": "c79ab636ffd2d9c30bcb393dc80830c13c2bfdd3", "author": {"user": {"login": "bsrikan", "name": "Srikanth Balasubramanian"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c79ab636ffd2d9c30bcb393dc80830c13c2bfdd3", "committedDate": "2020-09-08T16:36:55Z", "message": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle to include task to verify flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c79ab636ffd2d9c30bcb393dc80830c13c2bfdd3", "author": {"user": {"login": "bsrikan", "name": "Srikanth Balasubramanian"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c79ab636ffd2d9c30bcb393dc80830c13c2bfdd3", "committedDate": "2020-09-08T16:36:55Z", "message": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle to include task to verify flow"}, "afterCommit": {"oid": "d71cb4db0867636c89c3d6d5c415b8dc087239d5", "author": {"user": {"login": "bsrikan", "name": "Srikanth Balasubramanian"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d71cb4db0867636c89c3d6d5c415b8dc087239d5", "committedDate": "2020-09-08T16:37:52Z", "message": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle to include task to verify flow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MzMzNDc2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#pullrequestreview-484333476", "createdAt": "2020-09-08T17:03:29Z", "commit": {"oid": "d71cb4db0867636c89c3d6d5c415b8dc087239d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNzowMzozMFrOHOmTQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNzowMzozMFrOHOmTQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA2OTYzNA==", "bodyText": "Will fix the typo here.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485069634", "createdAt": "2020-09-08T17:03:30Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub-central/ui/e2e/hc-qa-project/build.gradle", "diffHunk": "@@ -49,3 +52,27 @@ task loadThesaurus(type: com.marklogic.gradle.task.MlcpTask) {\n }\n \n hubDeployAsDeveloper.finalizedBy(\"loadThesaurus\")\n+\n+class DocCount extends HubTask {\n+    DatabaseClient client\n+    String script\n+    @TaskAction\n+    def getDocCount() {\n+        int result = Integer.parseInt(client.newServerEval().javascript(script).evalAs(String.class));\n+        if(result != 34) {\n+            throw new GradleException(\"Record count did not match. Expected 34 in ${client.getDatabase()} database, got \"+ result)\n+        } else {\n+            println(\"Flow/steps were run successfully and got expected number of records in ${client.getDatabase()} database\")\n+        }\n+    }\n+}\n+\n+task verifyStagingCounts(type: DocCount) {\n+    client = hubConfig.newStagingClient()\n+    script = \"fn.count(fn.collection(['loadCustomersJSON', 'loadCustomersXML', 'order-input', 'loadPersonJSON']))\"\n+}\n+\n+task verifyFinalCounts(type: DocCount) {\n+    client = hubConfig.newFinalClient()\n+    script = \"fn.count(fn.cverifyFinalCountsollection(['mapCustomersJSON', 'mapCustomersXML', 'map-orders', 'mapPersonJSON']))\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d71cb4db0867636c89c3d6d5c415b8dc087239d5"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96", "author": {"user": {"login": "bsrikan", "name": "Srikanth Balasubramanian"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b127fd1e03d83bd82bcf9be30f0ed81353b59e96", "committedDate": "2020-09-08T17:11:47Z", "message": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle to include task to verify flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d71cb4db0867636c89c3d6d5c415b8dc087239d5", "author": {"user": {"login": "bsrikan", "name": "Srikanth Balasubramanian"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d71cb4db0867636c89c3d6d5c415b8dc087239d5", "committedDate": "2020-09-08T16:37:52Z", "message": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle to include task to verify flow"}, "afterCommit": {"oid": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96", "author": {"user": {"login": "bsrikan", "name": "Srikanth Balasubramanian"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b127fd1e03d83bd82bcf9be30f0ed81353b59e96", "committedDate": "2020-09-08T17:11:47Z", "message": "DHFPROD-5786: Updates to e2e readme, setup script and build.gradle to include task to verify flow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MzQxNDEw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#pullrequestreview-484341410", "createdAt": "2020-09-08T17:14:28Z", "commit": {"oid": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNzoxNDoyOFrOHOmq_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNzoxNDoyOFrOHOmq_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA3NTcxMQ==", "bodyText": "The task with typo was still passing. Added finally and now both the tasks fail when expected. to", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485075711", "createdAt": "2020-09-08T17:14:28Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub-central/ui/e2e/hc-qa-project/build.gradle", "diffHunk": "@@ -49,3 +52,31 @@ task loadThesaurus(type: com.marklogic.gradle.task.MlcpTask) {\n }\n \n hubDeployAsDeveloper.finalizedBy(\"loadThesaurus\")\n+\n+class DocCount extends HubTask {\n+    DatabaseClient client\n+    String script\n+    @TaskAction\n+    def getDocCount() {\n+        try {\n+            int result = Integer.parseInt(client.newServerEval().javascript(script).evalAs(String.class));\n+            if(result != 34) {\n+                throw new GradleException(\"Record count did not match. Expected 34 in ${client.getDatabase()} database, got \"+ result)\n+            } else {\n+                println(\"Flow/steps were run successfully and got expected number of records in ${client.getDatabase()} database\")\n+            }\n+        } finally {\n+            client.release()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MzY5OTE2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#pullrequestreview-484369916", "createdAt": "2020-09-08T17:55:11Z", "commit": {"oid": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0Mzc1MjUx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#pullrequestreview-484375251", "createdAt": "2020-09-08T18:02:46Z", "commit": {"oid": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxODowMjo0NlrOHOoR2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxODowMjo0NlrOHOoR2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEwMjA0Mw==", "bodyText": "Quick note - fn.count on fn.collection works fine if the counts are in the thousands or less, maybe tens of thousands. But it forces every document to be read in.\nThe faster approach is cts.estimate(cts.collectionQuery(['...'])) . That will return a subsecond response for any number of results.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#discussion_r485102043", "createdAt": "2020-09-08T18:02:46Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/ui/e2e/hc-qa-project/build.gradle", "diffHunk": "@@ -49,3 +52,31 @@ task loadThesaurus(type: com.marklogic.gradle.task.MlcpTask) {\n }\n \n hubDeployAsDeveloper.finalizedBy(\"loadThesaurus\")\n+\n+class DocCount extends HubTask {\n+    DatabaseClient client\n+    String script\n+    @TaskAction\n+    def getDocCount() {\n+        try {\n+            int result = Integer.parseInt(client.newServerEval().javascript(script).evalAs(String.class));\n+            if(result != 34) {\n+                throw new GradleException(\"Record count did not match. Expected 34 in ${client.getDatabase()} database, got \"+ result)\n+            } else {\n+                println(\"Flow/steps were run successfully and got expected number of records in ${client.getDatabase()} database\")\n+            }\n+        } finally {\n+            client.release()\n+        }\n+    }\n+}\n+\n+task verifyStagingCounts(type: DocCount) {\n+    client = hubConfig.newStagingClient()\n+    script = \"fn.count(fn.collection(['loadCustomersJSON', 'loadCustomersXML', 'order-input', 'loadPersonJSON']))\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0Mzc1MzY1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4535#pullrequestreview-484375365", "createdAt": "2020-09-08T18:02:55Z", "commit": {"oid": "b127fd1e03d83bd82bcf9be30f0ed81353b59e96"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1999, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}