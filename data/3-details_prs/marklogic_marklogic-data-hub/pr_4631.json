{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0MzE1MDcz", "number": 4631, "title": "DHFPROD-4809: Substitute tokens when loading user artifacts", "bodyText": "Description\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-09-28T18:07:09Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4631", "merged": true, "mergeCommit": {"oid": "29e83720009c7499b6ce6c0e2de6b6d31d86517a"}, "closed": true, "closedAt": "2020-09-28T21:11:51Z", "author": {"login": "akshaysonvane"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNYKlaAFqTQ5NzgwMjY2NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNZ2V5AFqTQ5Nzg4MjMzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODAyNjY1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4631#pullrequestreview-497802665", "createdAt": "2020-09-28T18:45:53Z", "commit": {"oid": "919f3f1e111c40f03aefe15dda61a601bdb456c0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxODo0NTo1M1rOHZLNXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxODo0NTo1M1rOHZLNXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MDA5Mw==", "bodyText": "We've got 5 instances of code all wanting to do the same thing - convert a File or Resource into a JsonNode, and now they all want to replace tokens at the same time.\nIt's best to do this via a new private method - particularly as when we add a 6th instance of the code, we can just reuse that method and not worry about forgetting to replace tokens.\nSince we know that everything is a File here, the 2 places that use a Resource should just do \"resource.getFile()\". The reusable method can then have a signature of:\nprivate JsonNode readArtifact(File file);\n\nAnd it should catch any exception that occurs and throwing a generic error message of:\nthrow new RuntimeException(\"Unless to read file \" + f.getFilename() \" + as JSON; cause: \" + e.getMessage(), e);", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4631#discussion_r496160093", "createdAt": "2020-09-28T18:45:53Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -155,9 +159,10 @@ private void loadModels(HubClient hubClient) throws IOException {\n                 public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs)  {\n                     logger.info(\"Loading models from directory \" + dir);\n                     modulesFinder.findModules(dir.toString()).getAssets().forEach(r -> {\n-                        try {\n+                        try (InputStream inputStream = r.getInputStream()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "919f3f1e111c40f03aefe15dda61a601bdb456c0"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "919f3f1e111c40f03aefe15dda61a601bdb456c0", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/919f3f1e111c40f03aefe15dda61a601bdb456c0", "committedDate": "2020-09-28T18:04:31Z", "message": "DHFPROD-4809: Substitute tokens when loading user artifacts"}, "afterCommit": {"oid": "9ac8134812e0ba9f27a9d1af03eec0dea5485b1c", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9ac8134812e0ba9f27a9d1af03eec0dea5485b1c", "committedDate": "2020-09-28T20:17:04Z", "message": "DHFPROD-4809: Substitute tokens when loading user artifacts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2c852bf9516fa6c963c0a7ef37e47f79b59c552", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/a2c852bf9516fa6c963c0a7ef37e47f79b59c552", "committedDate": "2020-09-28T20:18:59Z", "message": "DHFPROD-4809: Substitute tokens when loading user artifacts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ac8134812e0ba9f27a9d1af03eec0dea5485b1c", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9ac8134812e0ba9f27a9d1af03eec0dea5485b1c", "committedDate": "2020-09-28T20:17:04Z", "message": "DHFPROD-4809: Substitute tokens when loading user artifacts"}, "afterCommit": {"oid": "a2c852bf9516fa6c963c0a7ef37e47f79b59c552", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/a2c852bf9516fa6c963c0a7ef37e47f79b59c552", "committedDate": "2020-09-28T20:18:59Z", "message": "DHFPROD-4809: Substitute tokens when loading user artifacts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODY2MTg0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4631#pullrequestreview-497866184", "createdAt": "2020-09-28T20:21:01Z", "commit": {"oid": "a2c852bf9516fa6c963c0a7ef37e47f79b59c552"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMDoyMTowMVrOHZONDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMDoyMTowMVrOHZONDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwOTE2Nw==", "bodyText": "This is fine to keep, but generally I think it's simpler to just do \"return objectMapper.readTree\" as opposed to declaring this variable here. Shortens the method too.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4631#discussion_r496209167", "createdAt": "2020-09-28T20:21:01Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -382,6 +378,25 @@ protected ObjectNode replaceLanguageWithLang(ObjectNode object) {\n         return newObject;\n     }\n \n+    /**\n+     * Reads the artifact file, replaces tokens and then returns the content as a JsonNode.\n+     *\n+     * @param file\n+     * @return\n+     */\n+    private JsonNode readArtifact(File file) {\n+        JsonNode jsonNode;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2c852bf9516fa6c963c0a7ef37e47f79b59c552"}, "originalPosition": 122}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODgyMzM3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4631#pullrequestreview-497882337", "createdAt": "2020-09-28T20:45:14Z", "commit": {"oid": "a2c852bf9516fa6c963c0a7ef37e47f79b59c552"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1888, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}