{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMTE4ODM3", "number": 3746, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxODoxNDowOVrODq6d6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNzo1Nzo1MVrODrxDYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MzI0NzE0OnYy", "diffSide": "RIGHT", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/util/SearchHelper.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxODoxNDowOVrOF69Ldg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjoyNTo0OFrOF8PUsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NDA4Ng==", "bodyText": "This seems like something we can check on before trying to do the search, right?\nAlso, I'd say we should add a test - but it doesn't look like SearchHelper is actually being tested at all??? I see in SearchManagerTest that it's being mocked.\nWhy is SearchHelper separate from SearchManager? SearchManager isn't doing anything other than delegating to SearchHelper.\nI recommend trying to write a real test here. This one is easy, because you don't need any data - just pass in a SearchQuery with no entity names, and verify you get back an empty StringHandle.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r397364086", "createdAt": "2020-03-24T18:14:09Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/util/SearchHelper.java", "diffHunk": "@@ -96,6 +99,12 @@ public StringHandle search(SearchQuery searchQuery) {\n \n         }\n         catch (MarkLogicServerException e) {\n+            // If there are no entityTypes to search, return empty result set", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "940a592494cfe84c0688bcbdbd28f994532482f1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2NzcwNQ==", "bodyText": "The reason for adding this check in the catch block is we have to make a getModels call for every search request. This is handled by adding empty list to the collection query if the searchQuery.getQuery().getEntityNames() is empty which results in no results.\nIf there are no entityTypes, then there are no search options and we get 400 error with a missing options file. So I added this check in case of exception.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r397467705", "createdAt": "2020-03-24T21:19:37Z", "author": {"login": "rahulvudutala"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/util/SearchHelper.java", "diffHunk": "@@ -96,6 +99,12 @@ public StringHandle search(SearchQuery searchQuery) {\n \n         }\n         catch (MarkLogicServerException e) {\n+            // If there are no entityTypes to search, return empty result set", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NDA4Ng=="}, "originalCommit": {"oid": "940a592494cfe84c0688bcbdbd28f994532482f1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2Nzk5Mw==", "bodyText": "I will add a comment as you suggested\n\"if there are no entity models, then we expect an error because no search options will exist\"", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r397467993", "createdAt": "2020-03-24T21:20:08Z", "author": {"login": "rahulvudutala"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/util/SearchHelper.java", "diffHunk": "@@ -96,6 +99,12 @@ public StringHandle search(SearchQuery searchQuery) {\n \n         }\n         catch (MarkLogicServerException e) {\n+            // If there are no entityTypes to search, return empty result set", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NDA4Ng=="}, "originalCommit": {"oid": "940a592494cfe84c0688bcbdbd28f994532482f1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgyNDk0OA==", "bodyText": "What about a test for this? Can you submit a SearchQuery with no entity names and get this expected exception, and then verify that you get an empty StringHandle back?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r397824948", "createdAt": "2020-03-25T12:45:30Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/util/SearchHelper.java", "diffHunk": "@@ -96,6 +99,12 @@ public StringHandle search(SearchQuery searchQuery) {\n \n         }\n         catch (MarkLogicServerException e) {\n+            // If there are no entityTypes to search, return empty result set", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NDA4Ng=="}, "originalCommit": {"oid": "940a592494cfe84c0688bcbdbd28f994532482f1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcwOTkzNw==", "bodyText": "Addressed in new commits", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r398709937", "createdAt": "2020-03-26T16:25:48Z", "author": {"login": "rahulvudutala"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/util/SearchHelper.java", "diffHunk": "@@ -96,6 +99,12 @@ public StringHandle search(SearchQuery searchQuery) {\n \n         }\n         catch (MarkLogicServerException e) {\n+            // If there are no entityTypes to search, return empty result set", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NDA4Ng=="}, "originalCommit": {"oid": "940a592494cfe84c0688bcbdbd28f994532482f1"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MjE4NTc0OnYy", "diffSide": "RIGHT", "path": "one-ui/src/test/java/com/marklogic/hub/oneui/TestHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNzo1Njo0MVrOF8TbKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNzo1Njo0MVrOF8TbKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc3NzEyOA==", "bodyText": "This is a lot of redundant logging for an exception. If the point is to make it clear what query failed, just rethrow the exception:\nthrow new RuntimeException(\"Failed to run query:  \" + query,e);", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r398777128", "createdAt": "2020-03-26T17:56:41Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/test/java/com/marklogic/hub/oneui/TestHelper.java", "diffHunk": "@@ -188,11 +190,35 @@ private void assignRoleToUser(String username, String role) {\n         user.save();\n     }\n \n-    protected GenericDocumentManager getFinalGenericDocumentManager(DatabaseKind databaseKind) {\n-        return getFinalClient(databaseKind).newDocumentManager();\n+    protected EvalResultIterator runJsInDatabase(String query, String databaseName) {\n+        try {\n+            return getServerEval(databaseName).javascript(query).eval();\n+        }\n+        catch(FailedRequestException e) {\n+            logger.error(\"Failed run code: \" + query, e);\n+            e.printStackTrace();\n+            throw e;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d275aec2d5d2a1189b088b8db6a922f039521e74"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MjE5MDQwOnYy", "diffSide": "RIGHT", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/util/SearchOptionBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNzo1Nzo1MVrOF8TeGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNzo1Nzo1MVrOF8TeGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc3Nzg4Mw==", "bodyText": "This is worth adding a unit test for - why escapeXml10 and not escapeXml? What scenario is this handling, such that it would break if we didn't call escapeXml10?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3746#discussion_r398777883", "createdAt": "2020-03-26T17:57:51Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/util/SearchOptionBuilder.java", "diffHunk": "@@ -51,7 +51,7 @@ public String buildSearchOptions(String query, SearchQuery searchQuery) throws I\n         // Setting search string if provided by user\n         if (StringUtils.isNotEmpty(searchQuery.getQuery().getSearchStr())) {\n             sb.append(\"<qtext>\")\n-                .append(StringEscapeUtils.escapeXml(searchQuery.getQuery().getSearchStr()))\n+                .append(StringEscapeUtils.escapeXml10(searchQuery.getQuery().getSearchStr()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d275aec2d5d2a1189b088b8db6a922f039521e74"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3510, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}