{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MjgwNjMx", "number": 4736, "title": "DHFPROD-6121: Set the right target database in mapping step navigation", "bodyText": "Description\n\nAdded \"targetDatabase\" key with the value being the name of the database to RunStepResponse.\nThe JobsController then replaces the targetDatabase name with the Database kind (staging/final) so the FE can set the correct database for data exploration.\nAlso added the functionality to \"explore curated data\" by clicking on the status icon for the step.\n\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-10-19T21:12:08Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736", "merged": true, "mergeCommit": {"oid": "053d495d8eae88b2dfd24e4635ed52b9b8c5d5c4"}, "closed": true, "closedAt": "2020-10-22T19:13:19Z", "author": {"login": "akshaysonvane"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUbRcwgBqjM4OTk2NTUxMDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUzwBgAFqTUxNDE3Njk2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f942496de2ec85f3711bfc0d605e981a81b57cd", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9f942496de2ec85f3711bfc0d605e981a81b57cd", "committedDate": "2020-10-19T20:58:06Z", "message": "DHFPROD-6121: Set the right target database in mapping step navigation"}, "afterCommit": {"oid": "c07f83554e55e71b038382c4a233f3c05a0f961f", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c07f83554e55e71b038382c4a233f3c05a0f961f", "committedDate": "2020-10-20T16:21:33Z", "message": "DHFPROD-6121: Set the right target database in mapping step navigation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDM1Mzg5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#pullrequestreview-513035389", "createdAt": "2020-10-20T18:48:32Z", "commit": {"oid": "c07f83554e55e71b038382c4a233f3c05a0f961f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDYyOTg5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#pullrequestreview-513062989", "createdAt": "2020-10-20T19:27:07Z", "commit": {"oid": "c07f83554e55e71b038382c4a233f3c05a0f961f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxOToyNzowN1rOHlNsVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxOTozMjo1NFrOHlN4RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4MzcwMA==", "bodyText": "Is this always true? Or is it only true if targetDatabase is configured in the step options?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r508783700", "createdAt": "2020-10-20T19:27:07Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/FlowControllerTest.java", "diffHunk": "@@ -126,6 +126,7 @@ void test() throws Exception {\n                 .andDo(result -> {\n                     JsonNode response = parseJsonResponse(result);\n                 assertEquals(mappingInfo.targetEntityType, response.path(\"stepResponses\").path(\"1\").path(\"targetEntityType\").asText(), \"Info for the step should specify the Target Entity Type; response: \" + response);\n+                assertEquals(\"final\", response.path(\"stepResponses\").path(\"1\").path(\"targetDatabase\").asText(), \"Info for the step should specify the target database; response: \" + response);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c07f83554e55e71b038382c4a233f3c05a0f961f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4NDU0Nw==", "bodyText": "It's a bit difficult to look at this and be sure there's no error. I think some unit tests are needed for the withStep method - none exist yet. Those tests would verify that targetDatabase is set if it exists in the options for the given step, but not set if targetDatabase doesn't exist in the given step's options but does exist in another step's options.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r508784547", "createdAt": "2020-10-20T19:28:46Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/RunStepResponse.java", "diffHunk": "@@ -90,6 +92,7 @@ public RunStepResponse withStep(String stepNum) {\n         if (targetEntityTextNode != null) {\n             this.targetEntityType = targetEntityTextNode.asText();\n         }\n+        Optional.of(step.getOptions()).map(optionMap -> (TextNode) optionMap.get(\"targetDatabase\")).ifPresent(node -> this.targetDatabase = node.asText());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c07f83554e55e71b038382c4a233f3c05a0f961f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4Njc1Ng==", "bodyText": "I don't see any test coverage for this. I think it would be reasonable to do unit tests against this method with a fake jobNode - i.e. no need to run a job first.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r508786756", "createdAt": "2020-10-20T19:32:54Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/JobsController.java", "diffHunk": "@@ -62,12 +65,38 @@ private JsonNode flattenJobsJson(JsonNode jobJSON) {\n             });\n             return array;\n         } else if (jobJSON.has(\"job\")) {\n-            return jobJSON.get(\"job\");\n+            return processTargetDatabase(jobJSON.get(\"job\"));\n         } else {\n             return jobJSON;\n         }\n     }\n \n+    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c07f83554e55e71b038382c4a233f3c05a0f961f"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c07f83554e55e71b038382c4a233f3c05a0f961f", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c07f83554e55e71b038382c4a233f3c05a0f961f", "committedDate": "2020-10-20T16:21:33Z", "message": "DHFPROD-6121: Set the right target database in mapping step navigation"}, "afterCommit": {"oid": "6f48eb32f299b1b36bc1a882e5f6e40fa8878f9b", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6f48eb32f299b1b36bc1a882e5f6e40fa8878f9b", "committedDate": "2020-10-21T17:24:10Z", "message": "DHFPROD-6121: Set the right target database in mapping step navigation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MDA1Mjgz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#pullrequestreview-514005283", "createdAt": "2020-10-21T17:33:00Z", "commit": {"oid": "6f48eb32f299b1b36bc1a882e5f6e40fa8878f9b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MDM0MjY0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#pullrequestreview-514034264", "createdAt": "2020-10-21T17:57:20Z", "commit": {"oid": "6f48eb32f299b1b36bc1a882e5f6e40fa8878f9b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzo1NzoyMFrOHl6pWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzo1ODowNlrOHl6wNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUyMDIxNw==", "bodyText": "Can you add that to the assertion message? The current assertion message is restating what the assertEquals is communicating - that we expect the stepResponse to have the targetDatabase. The assertion message needs to explain why that is - in this case, the reason is that if the step options contain targetDatabase, then it's expected to be added to the stepResponse.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r509520217", "createdAt": "2020-10-21T17:57:20Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/FlowControllerTest.java", "diffHunk": "@@ -126,6 +126,7 @@ void test() throws Exception {\n                 .andDo(result -> {\n                     JsonNode response = parseJsonResponse(result);\n                 assertEquals(mappingInfo.targetEntityType, response.path(\"stepResponses\").path(\"1\").path(\"targetEntityType\").asText(), \"Info for the step should specify the Target Entity Type; response: \" + response);\n+                assertEquals(\"final\", response.path(\"stepResponses\").path(\"1\").path(\"targetDatabase\").asText(), \"Info for the step should specify the target database; response: \" + response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4MzcwMA=="}, "originalCommit": {"oid": "c07f83554e55e71b038382c4a233f3c05a0f961f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUyMTk3NA==", "bodyText": "Because this test has no dependency on ML or Spring, don't extend this base class. Just instantiate a new JobsController. That makes it clear that the method being tested has no dependencies too (and the test runs a bit faster too).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r509521974", "createdAt": "2020-10-21T17:58:06Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/JobsControllerTest.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright (c) 2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub.central.controllers;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.central.AbstractHubCentralTest;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class JobsControllerTest extends AbstractHubCentralTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f48eb32f299b1b36bc1a882e5f6e40fa8878f9b"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f97041eb493bf5f84b91bd7761df33749db2238", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/7f97041eb493bf5f84b91bd7761df33749db2238", "committedDate": "2020-10-21T18:06:59Z", "message": "DHFPROD-6121: Set the right target database in mapping step navigation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f48eb32f299b1b36bc1a882e5f6e40fa8878f9b", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6f48eb32f299b1b36bc1a882e5f6e40fa8878f9b", "committedDate": "2020-10-21T17:24:10Z", "message": "DHFPROD-6121: Set the right target database in mapping step navigation"}, "afterCommit": {"oid": "7f97041eb493bf5f84b91bd7761df33749db2238", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/7f97041eb493bf5f84b91bd7761df33749db2238", "committedDate": "2020-10-21T18:06:59Z", "message": "DHFPROD-6121: Set the right target database in mapping step navigation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MDY2MjE0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#pullrequestreview-514066214", "createdAt": "2020-10-21T18:34:22Z", "commit": {"oid": "7f97041eb493bf5f84b91bd7761df33749db2238"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTc2OTY1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#pullrequestreview-514176965", "createdAt": "2020-10-21T20:53:20Z", "commit": {"oid": "7f97041eb493bf5f84b91bd7761df33749db2238"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1756, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}