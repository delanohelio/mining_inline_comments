{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxOTA1OTI5", "number": 4465, "title": "DHFPROD-5793: Find entity type references in referenced steps", "bodyText": "Description\n\nAssigned data-hub-match-merge-reader and data-hub-custom-reader roles to hub-central-entity-model-writer role so that we can check for entity type references in matching/merging/mastering/custom steps.\nChanged JSON model key from stepAndMappingNames to stepNames.\n\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-08-22T00:27:59Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465", "merged": true, "mergeCommit": {"oid": "ed0daf47dad2e51083c79f41b2d5f6ad4abc0383"}, "closed": true, "closedAt": "2020-08-24T16:29:54Z", "author": {"login": "akshaysonvane"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBOSwXgFqTQ3Mjg3NzAzOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCEhmKAFqTQ3MzYyMzc4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyODc3MDM4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465#pullrequestreview-472877038", "createdAt": "2020-08-22T00:30:19Z", "commit": {"oid": "298e428febb4c55f4a40ace2daa5191ed6733761"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDozMDoxOVrOHFA-ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwMDozMDoxOVrOHFA-ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAyMDk5NQ==", "bodyText": "This will be added back in via @bsrikan's PR #4437", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465#discussion_r475020995", "createdAt": "2020-08-22T00:30:19Z", "author": {"login": "akshaysonvane"}, "path": "marklogic-data-hub-central/ui/e2e/cypress/integration/modeling/writer.spec.tsx", "diffHunk": "@@ -125,8 +125,6 @@ describe('Entity Modeling: Writer Role', () => {\n     propertyTable.editProperty('fname');\n     cy.waitUntil(() => propertyModal.getToggleStepsButton().should('exist')).click();\n     cy.contains('mapPersonJSON').should('be.visible');\n-    cy.contains('match-person').should('be.visible');\n-    cy.contains('merge-person').should('be.visible');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "298e428febb4c55f4a40ace2daa5191ed6733761"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a38b3a2a63247b903651a89666545e7a553b2ea3", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/a38b3a2a63247b903651a89666545e7a553b2ea3", "committedDate": "2020-08-22T07:10:03Z", "message": "DHFPROD-5793: Find entity type references in referenced steps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bdba164b20bea707e7d18c88f56a37e69405594c", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/bdba164b20bea707e7d18c88f56a37e69405594c", "committedDate": "2020-08-22T06:21:34Z", "message": "DHFPROD-5793: Find entity type references in referenced steps"}, "afterCommit": {"oid": "a38b3a2a63247b903651a89666545e7a553b2ea3", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/a38b3a2a63247b903651a89666545e7a553b2ea3", "committedDate": "2020-08-22T07:10:03Z", "message": "DHFPROD-5793: Find entity type references in referenced steps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTMyMTQz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465#pullrequestreview-472932143", "createdAt": "2020-08-22T15:03:26Z", "commit": {"oid": "a38b3a2a63247b903651a89666545e7a553b2ea3"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNTowMzoyN1rOHFFwzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNTowNjozNFrOHFFx1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA5OTM0Mg==", "bodyText": "Nice, thanks for taking the time to rename this!", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465#discussion_r475099342", "createdAt": "2020-08-22T15:03:27Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -259,7 +259,7 @@ private ModelsService newService() {\n     }\n \n     public static class ModelReferencesInfo {\n-        public List<String> stepAndMappingNames;\n+        public List<String> stepNames;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a38b3a2a63247b903651a89666545e7a553b2ea3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA5OTYwNA==", "bodyText": "Pinging @fsnow and @ryanjdew about this - one thing I'd like for us to do when possible is use more verbose property names in DHF documents. For example, if we had \"stepName\" instead of \"name\", we could consider a range index on \"stepName\", and thus have this be more efficient by not having to grab documents. We may not be able to do much of this in the 5.x timeframe - but perhaps for matching and merging, we'll have opportunities to use more verbose (and often self-describing) names that are then good candidates for range indexes which allow for better DHF performance.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465#discussion_r475099604", "createdAt": "2020-08-22T15:06:34Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/entity-lib.sjs", "diffHunk": "@@ -218,31 +218,12 @@ function deleteModel(entityName) {\n  * @returns {[]}\n  */\n function findModelReferencesInSteps(entityName, entityTypeId) {\n-  let steps = [];\n-\n-  const mappingQuery = cts.andQuery([\n-    cts.collectionQuery('http://marklogic.com/data-hub/mappings'),\n-    cts.jsonPropertyValueQuery(\"targetEntityType\", [entityName, entityTypeId])\n+  const stepQuery = cts.andQuery([\n+    cts.collectionQuery('http://marklogic.com/data-hub/steps'),\n+    cts.jsonPropertyValueQuery([\"targetEntityType\", \"targetEntity\"], [entityName, entityTypeId])\n   ]);\n-  steps = cts.search(mappingQuery).toArray().map(mapping => mapping.toObject().name);\n-\n-\n-  const flowQuery = cts.andQuery([\n-    cts.collectionQuery('http://marklogic.com/data-hub/flow'),\n-    cts.notQuery(cts.collectionQuery(consts.HUB_ARTIFACT_COLLECTION)),\n-    cts.jsonPropertyValueQuery(\"targetEntity\", entityName)\n-  ]);\n-  cts.search(flowQuery).toArray()\n-    .map(flow => flow.toObject())\n-    .filter(flow => flow.steps)\n-    .forEach(flow => {\n-      const flowSteps = flow.steps;\n-      Object.keys(flowSteps)\n-        .filter(stepNumber => flowSteps[stepNumber].options && flowSteps[stepNumber].options.targetEntity === entityName)\n-        .forEach(stepNumber => steps.push(flowSteps[stepNumber].name));\n-    });\n \n-  return steps;\n+  return cts.search(stepQuery).toArray().map(step => step.toObject().name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a38b3a2a63247b903651a89666545e7a553b2ea3"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTM4MTUw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465#pullrequestreview-472938150", "createdAt": "2020-08-22T16:54:54Z", "commit": {"oid": "a38b3a2a63247b903651a89666545e7a553b2ea3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNjo1NDo1NFrOHFGW7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNjo1NDo1NFrOHFGW7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwOTEwMg==", "bodyText": "@SameeraPriyathamTadikonda, @bsrikan can we publish and use mavenLocal to grab the ml-data-hub:5.3-SNAPSHOT dependency?\nUsing maven-snapshots brings in an older version of data-hub which does not have the changes made here and so the tests are failing.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465#discussion_r475109102", "createdAt": "2020-08-22T16:54:54Z", "author": {"login": "akshaysonvane"}, "path": "marklogic-data-hub-central/ui/e2e/hc-qa-project/build.gradle", "diffHunk": "@@ -1,6 +1,5 @@\n buildscript {\n     repositories {\n-        maven {url 'http://distro.marklogic.com/nexus/repository/maven-snapshots/'}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a38b3a2a63247b903651a89666545e7a553b2ea3"}, "originalPosition": 3}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f3763deeccfdfd3174872be5e3173f94f21be90", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5f3763deeccfdfd3174872be5e3173f94f21be90", "committedDate": "2020-08-22T17:22:57Z", "message": "DHFPROD-5793: Publish to maven local"}, "afterCommit": {"oid": "fb0a399c2633c2ce9d49f099a6f552f15b8a0c67", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/fb0a399c2633c2ce9d49f099a6f552f15b8a0c67", "committedDate": "2020-08-22T18:06:12Z", "message": "DHFPROD-5793: Publish to maven local"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb0a399c2633c2ce9d49f099a6f552f15b8a0c67", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/fb0a399c2633c2ce9d49f099a6f552f15b8a0c67", "committedDate": "2020-08-22T18:06:12Z", "message": "DHFPROD-5793: Publish to maven local"}, "afterCommit": {"oid": "eb0fd1eaa6cc195e5fa51951d996e16d98bc7568", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/eb0fd1eaa6cc195e5fa51951d996e16d98bc7568", "committedDate": "2020-08-22T19:55:49Z", "message": "Adding local maven repo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb0fd1eaa6cc195e5fa51951d996e16d98bc7568", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/eb0fd1eaa6cc195e5fa51951d996e16d98bc7568", "committedDate": "2020-08-22T19:55:49Z", "message": "Adding local maven repo"}, "afterCommit": {"oid": "8701ec03c170eb4a6f3480232ee46b4e2565404d", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/8701ec03c170eb4a6f3480232ee46b4e2565404d", "committedDate": "2020-08-22T20:24:02Z", "message": "DHFPROD-5722:Adding local maven repo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e84a6db1d7fec28d4a60a3fda784355fa48968f", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/8e84a6db1d7fec28d4a60a3fda784355fa48968f", "committedDate": "2020-08-22T20:43:23Z", "message": "DHFPROD-5722:Adding local maven repo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8701ec03c170eb4a6f3480232ee46b4e2565404d", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/8701ec03c170eb4a6f3480232ee46b4e2565404d", "committedDate": "2020-08-22T20:24:02Z", "message": "DHFPROD-5722:Adding local maven repo"}, "afterCommit": {"oid": "8e84a6db1d7fec28d4a60a3fda784355fa48968f", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/8e84a6db1d7fec28d4a60a3fda784355fa48968f", "committedDate": "2020-08-22T20:43:23Z", "message": "DHFPROD-5722:Adding local maven repo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTY2Mzk5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465#pullrequestreview-472966399", "createdAt": "2020-08-22T22:35:49Z", "commit": {"oid": "8e84a6db1d7fec28d4a60a3fda784355fa48968f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjE4NDEx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465#pullrequestreview-473618411", "createdAt": "2020-08-24T15:34:52Z", "commit": {"oid": "8e84a6db1d7fec28d4a60a3fda784355fa48968f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjIzNzg3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465#pullrequestreview-473623787", "createdAt": "2020-08-24T15:41:24Z", "commit": {"oid": "8e84a6db1d7fec28d4a60a3fda784355fa48968f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNTo0MToyNFrOHFq-4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNTo0MToyNFrOHFq-4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwOTE1Mg==", "bodyText": "I think this fixes another bug which is that the original query was querying on the mappings collection, but that will pick up existing legacy mappings that have not yet been deleted. And we don't care about those.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4465#discussion_r475709152", "createdAt": "2020-08-24T15:41:24Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/entity-lib.sjs", "diffHunk": "@@ -218,31 +218,12 @@ function deleteModel(entityName) {\n  * @returns {[]}\n  */\n function findModelReferencesInSteps(entityName, entityTypeId) {\n-  let steps = [];\n-\n-  const mappingQuery = cts.andQuery([\n-    cts.collectionQuery('http://marklogic.com/data-hub/mappings'),\n-    cts.jsonPropertyValueQuery(\"targetEntityType\", [entityName, entityTypeId])\n+  const stepQuery = cts.andQuery([\n+    cts.collectionQuery('http://marklogic.com/data-hub/steps'),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e84a6db1d7fec28d4a60a3fda784355fa48968f"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2155, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}