{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4ODUwNjQ3", "number": 4416, "title": "DHFPROD-5746: Migrating flows should be repeatable", "bodyText": "Description\nIn 5.3, FlowManagerImpl.getLocalFlow() does not know how to read referenced flows into Step objects. When you attempted to run migration twice, FlowMigrator would crash because of the mostly-empty Step object. (Specifically, trying to use the null result of step.getName().)\nThis PR is my attempt to make the smallest changes that will allow FlowMigrator.migrateFlows() to run twice.\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-08-17T13:58:49Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416", "merged": true, "mergeCommit": {"oid": "7ca81a24598a579dc1726b3cbe5e7f54c1e1221b"}, "closed": true, "closedAt": "2020-08-18T02:23:49Z", "author": {"login": "fsnow"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_zDHEAFqTQ2ODQ5ODczOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_6V1LgFqTQ2ODg3ODk2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NDk4NzM5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#pullrequestreview-468498739", "createdAt": "2020-08-17T14:11:42Z", "commit": {"oid": "73e8c6ec9278a4339e978a6f5c77c1b277882236"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDoxMTo0MlrOHBqdJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDoxMTo0MlrOHBqdJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUwNjIxMg==", "bodyText": "While I'd normally say it's good to add methods like this to Step, I want to get away from classes like Step, which are incomplete representations of JSON objects. For the purpose of FlowMigrator, just check the original ObjectNode to see if it only has one key, and if the name of that key is stepId.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#discussion_r471506212", "createdAt": "2020-08-17T14:11:42Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java", "diffHunk": "@@ -149,6 +149,10 @@ public void migrateFlows() {\n             ObjectNode newSteps = nodeFactory.objectNode();\n             for (Map.Entry<String, Step> entry : steps.entrySet()) {\n                 Step step = entry.getValue();\n+                if (step.getIsOnlyStepId()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73e8c6ec9278a4339e978a6f5c77c1b277882236"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NTg3NDkx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#pullrequestreview-468587491", "createdAt": "2020-08-17T15:52:21Z", "commit": {"oid": "b19a5419ee8be30bc07a72c933340d04aa5ec285"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTo1MjoyMVrOHBunsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTo1MjoyMVrOHBunsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3NDQ1MQ==", "bodyText": "Argh, sorry, I didn't realize the ObjectNode wasn't available. I think it's fine then to add stepId to the Step class. FlowMigrator can just say - if stepId is populated, then I don't need to migrate it. Then you don't need the stepJson JsonNode in Step.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#discussion_r471574451", "createdAt": "2020-08-17T15:52:21Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java", "diffHunk": "@@ -149,6 +149,11 @@ public void migrateFlows() {\n             ObjectNode newSteps = nodeFactory.objectNode();\n             for (Map.Entry<String, Step> entry : steps.entrySet()) {\n                 Step step = entry.getValue();\n+                JsonNode stepJson = step.getStepJson();\n+                if (stepJson.has(\"stepId\") && stepJson.size() == 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19a5419ee8be30bc07a72c933340d04aa5ec285"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NjAxNzA1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#pullrequestreview-468601705", "createdAt": "2020-08-17T16:09:43Z", "commit": {"oid": "53762be987e768df3b1d88d16b24c1a6f83592b0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NjY2MTUw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#pullrequestreview-468666150", "createdAt": "2020-08-17T17:12:49Z", "commit": {"oid": "53762be987e768df3b1d88d16b24c1a6f83592b0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NjY3MzQz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#pullrequestreview-468667343", "createdAt": "2020-08-17T17:14:26Z", "commit": {"oid": "53762be987e768df3b1d88d16b24c1a6f83592b0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNzoxNDoyNlrOHBx-6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNzoxNDoyNlrOHBx-6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyOTU0NA==", "bodyText": "The flow document is migrated and hence steps will already have  \"stepId\" . So, do we have to set \"stepId\" again in the flow ?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#discussion_r471629544", "createdAt": "2020-08-17T17:14:26Z", "author": {"login": "srinathgit"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java", "diffHunk": "@@ -149,6 +149,10 @@ public void migrateFlows() {\n             ObjectNode newSteps = nodeFactory.objectNode();\n             for (Map.Entry<String, Step> entry : steps.entrySet()) {\n                 Step step = entry.getValue();\n+                if (step.getStepId() != null) {\n+                    newSteps.set(entry.getKey(), nodeFactory.objectNode().put(\"stepId\", step.getStepId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53762be987e768df3b1d88d16b24c1a6f83592b0"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4Njg1ODUy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#pullrequestreview-468685852", "createdAt": "2020-08-17T17:40:49Z", "commit": {"oid": "53762be987e768df3b1d88d16b24c1a6f83592b0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc1e08e2548023e07bf2a34af65d6e1b9b3bba1c", "author": {"user": {"login": "fsnow", "name": "Frank Snow"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/bc1e08e2548023e07bf2a34af65d6e1b9b3bba1c", "committedDate": "2020-08-17T19:56:52Z", "message": "DHFPROD-5746: Migrating flows should be repeatable\n\n\n\n\nmore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4ODc2MzUx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#pullrequestreview-468876351", "createdAt": "2020-08-17T22:35:06Z", "commit": {"oid": "bc1e08e2548023e07bf2a34af65d6e1b9b3bba1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4ODc4OTYy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#pullrequestreview-468878962", "createdAt": "2020-08-17T22:41:39Z", "commit": {"oid": "bc1e08e2548023e07bf2a34af65d6e1b9b3bba1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2337, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}