{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3MTYzNDg2", "number": 4743, "title": "DHFPROD-6038:Ensure HC mapping tool works when step reads from final db", "bodyText": "Description\nEnsure HC mapping tool works when step reads from final db\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-10-21T00:04:06Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743", "merged": true, "mergeCommit": {"oid": "e8239073117dda8f23362af59e36e41b614f124a"}, "closed": true, "closedAt": "2020-10-23T16:46:30Z", "author": {"login": "srinathgit"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUuyyxAFqTUxMzIyMjE2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVZUJwgFqTUxNTgzMzIyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMjIyMTYw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#pullrequestreview-513222160", "createdAt": "2020-10-21T00:14:57Z", "commit": {"oid": "bb5e415c9464e484cf6b6a35e28e7ec55f5c0daa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwMDoxNDo1N1rOHlVtuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTowNjo0N1rOHlxZgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkxNTEyOQ==", "bodyText": "Can you add a \"desc\" to this? I think \"Gets the document based on the given URI and the source database associated with the given step name\"", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#discussion_r508915129", "createdAt": "2020-10-21T00:14:57Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mapping/getDocument.api", "diffHunk": "@@ -0,0 +1,17 @@\n+{\n+    \"functionName\": \"getDocument\",\n+    \"params\": [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb5e415c9464e484cf6b6a35e28e7ec55f5c0daa"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkxNTI0Mg==", "bodyText": "I think you can just do \"string\" here", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#discussion_r508915242", "createdAt": "2020-10-21T00:15:12Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mapping/getDocument.api", "diffHunk": "@@ -0,0 +1,17 @@\n+{\n+    \"functionName\": \"getDocument\",\n+    \"params\": [\n+        {\n+           \"name\": \"stepName\",\n+           \"datatype\": \"string\"\n+        },\n+        {\n+           \"name\": \"uri\",\n+           \"datatype\": \"string\"\n+        }\n+    ],\n+    \"return\": {\n+        \"datatype\": \"textDocument\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb5e415c9464e484cf6b6a35e28e7ec55f5c0daa"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkxNTg4Ng==", "bodyText": "Pinging @ehennum  on this - for a DS endpoint that can return a JSON or XML document, what's the preferred datatype?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#discussion_r508915886", "createdAt": "2020-10-21T00:17:32Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mapping/getDocument.api", "diffHunk": "@@ -0,0 +1,17 @@\n+{\n+    \"functionName\": \"getDocument\",\n+    \"params\": [\n+        {\n+           \"name\": \"stepName\",\n+           \"datatype\": \"string\"\n+        },\n+        {\n+           \"name\": \"uri\",\n+           \"datatype\": \"string\"\n+        }\n+    ],\n+    \"return\": {\n+        \"datatype\": \"textDocument\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb5e415c9464e484cf6b6a35e28e7ec55f5c0daa"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM2NjI3Ng==", "bodyText": "Same thing, add a \"desc\" here to explain what this is doing", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#discussion_r509366276", "createdAt": "2020-10-21T15:03:43Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mapping/getUris.api", "diffHunk": "@@ -0,0 +1,17 @@\n+{\n+    \"functionName\": \"getUris\",\n+    \"params\": [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb5e415c9464e484cf6b6a35e28e7ec55f5c0daa"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM2NjUwOA==", "bodyText": "I think this would benefit from a \"desc\" stating what the limit is if no value is provided", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#discussion_r509366508", "createdAt": "2020-10-21T15:04:00Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mapping/getUris.api", "diffHunk": "@@ -0,0 +1,17 @@\n+{\n+    \"functionName\": \"getUris\",\n+    \"params\": [\n+        {\n+           \"name\": \"stepName\",\n+           \"datatype\": \"string\"\n+        },\n+        {\n+           \"name\": \"limit\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb5e415c9464e484cf6b6a35e28e7ec55f5c0daa"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM2Njg1MA==", "bodyText": "Is \"limit\" required then? I think to make this safe, it should default to something like 10 if no value is provided.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#discussion_r509366850", "createdAt": "2020-10-21T15:04:24Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mapping/getUris.sjs", "diffHunk": "@@ -0,0 +1,21 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+ http://www.apache.org/licenses/LICENSE-2.0\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+const core = require('/data-hub/5/artifacts/core.sjs')\n+\n+xdmp.securityAssert(\"http://marklogic.com/data-hub/privileges/read-mapping\", \"execute\");\n+\n+var stepName, limit;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb5e415c9464e484cf6b6a35e28e7ec55f5c0daa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM2ODcwNQ==", "bodyText": "I think you can reuse the test-data/content concept here - the docs are written to \"raw-content\" by default, so you can use that as your collection to query on instead of \"finalCollection\".", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#discussion_r509368705", "createdAt": "2020-10-21T15:06:47Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/mapping/getUrisAndDoc/suiteSetup.sjs", "diffHunk": "@@ -0,0 +1,32 @@\n+declareUpdate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb5e415c9464e484cf6b6a35e28e7ec55f5c0daa"}, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb5e415c9464e484cf6b6a35e28e7ec55f5c0daa", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/bb5e415c9464e484cf6b6a35e28e7ec55f5c0daa", "committedDate": "2020-10-21T00:02:43Z", "message": "DHFPROD-6038:Ensure HC mapping tool works when step reads from final db"}, "afterCommit": {"oid": "f33117f3e514942a6aac5aa08afafed2189d4cfb", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/f33117f3e514942a6aac5aa08afafed2189d4cfb", "committedDate": "2020-10-21T21:28:09Z", "message": "DHFPROD-6038:Ensure HC mapping tool works when step reads from final db"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0Mjg1OTI5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#pullrequestreview-514285929", "createdAt": "2020-10-22T00:46:22Z", "commit": {"oid": "f33117f3e514942a6aac5aa08afafed2189d4cfb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMDo0NjoyMlrOHmMp3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMDo0ODowOFrOHmMrrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTI2Mg==", "bodyText": "Is it guaranteed that sourceDatabase will exist? I feel this needs to be a little more defensive - if sourceDatabase doesn't exist, I think it should just do a cts.doc(uri) on the current database (no eval).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#discussion_r509815262", "createdAt": "2020-10-22T00:46:22Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mapping/getDocument.sjs", "diffHunk": "@@ -0,0 +1,21 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+ http://www.apache.org/licenses/LICENSE-2.0\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+const core = require('/data-hub/5/artifacts/core.sjs')\n+\n+xdmp.securityAssert(\"http://marklogic.com/data-hub/privileges/read-mapping\", \"execute\");\n+\n+var stepName, uri;\n+let mappingStep = core.getArtifact(\"mapping\", stepName);\n+fn.head(xdmp.eval(\"String(cts.doc('\" + uri + \"'))\", null, {database: xdmp.database(mappingStep.sourceDatabase)}));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f33117f3e514942a6aac5aa08afafed2189d4cfb"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTQ0MQ==", "bodyText": "Also, if the mappingStep is not found, I think this should throw an error via ds-util - probably throwBadRequest.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#discussion_r509815441", "createdAt": "2020-10-22T00:47:07Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mapping/getDocument.sjs", "diffHunk": "@@ -0,0 +1,21 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+ http://www.apache.org/licenses/LICENSE-2.0\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+const core = require('/data-hub/5/artifacts/core.sjs')\n+\n+xdmp.securityAssert(\"http://marklogic.com/data-hub/privileges/read-mapping\", \"execute\");\n+\n+var stepName, uri;\n+let mappingStep = core.getArtifact(\"mapping\", stepName);\n+fn.head(xdmp.eval(\"String(cts.doc('\" + uri + \"'))\", null, {database: xdmp.database(mappingStep.sourceDatabase)}));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTI2Mg=="}, "originalCommit": {"oid": "f33117f3e514942a6aac5aa08afafed2189d4cfb"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTU5OQ==", "bodyText": "Typo?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#discussion_r509815599", "createdAt": "2020-10-22T00:47:43Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mapping/getUris.sjs", "diffHunk": "@@ -0,0 +1,22 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+ http://www.apache.org/licenses/LICENSE-2.0\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+const core = require('/data-hub/5/artifacts/core.sjs')\n+\n+xdmp.securityAssert(\"http://marklogic.com/data-hub/privileges/read-mapping\", \"execute\");\n+\n+var stepName, limit;\n+let mappingStep = core.getArtifact(\"mapping\", stepName);\n+xdmp.eval(\"cts.uris(null, ['limit=\" + limit + \"'], \" + mappingStep.sourceQuery + \")\", null, {database: xdmp.database(mappingStep.sourceDatabase)}).toArray();\n+\n+pm", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f33117f3e514942a6aac5aa08afafed2189d4cfb"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgxNTcyNA==", "bodyText": "Same thing here, I think this needs to be more defensive. If sourceQuery doesn't exist, return an empty array. If the step doesn't exist, throw an error. If the sourceDatabase doesn't exist, don't do an eval.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#discussion_r509815724", "createdAt": "2020-10-22T00:48:08Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/mapping/getUris.sjs", "diffHunk": "@@ -0,0 +1,22 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+ http://www.apache.org/licenses/LICENSE-2.0\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+const core = require('/data-hub/5/artifacts/core.sjs')\n+\n+xdmp.securityAssert(\"http://marklogic.com/data-hub/privileges/read-mapping\", \"execute\");\n+\n+var stepName, limit;\n+let mappingStep = core.getArtifact(\"mapping\", stepName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f33117f3e514942a6aac5aa08afafed2189d4cfb"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06b31676f0647595b5ea304f1ae0751bf87103d7", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/06b31676f0647595b5ea304f1ae0751bf87103d7", "committedDate": "2020-10-22T08:57:04Z", "message": "DHFPROD-6038:Ensure HC mapping tool works when step reads from final db"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f33117f3e514942a6aac5aa08afafed2189d4cfb", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/f33117f3e514942a6aac5aa08afafed2189d4cfb", "committedDate": "2020-10-21T21:28:09Z", "message": "DHFPROD-6038:Ensure HC mapping tool works when step reads from final db"}, "afterCommit": {"oid": "06b31676f0647595b5ea304f1ae0751bf87103d7", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/06b31676f0647595b5ea304f1ae0751bf87103d7", "committedDate": "2020-10-22T08:57:04Z", "message": "DHFPROD-6038:Ensure HC mapping tool works when step reads from final db"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NjAzMDM3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#pullrequestreview-514603037", "createdAt": "2020-10-22T10:58:02Z", "commit": {"oid": "06b31676f0647595b5ea304f1ae0751bf87103d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1ODMzMjIz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4743#pullrequestreview-515833223", "createdAt": "2020-10-23T16:39:17Z", "commit": {"oid": "06b31676f0647595b5ea304f1ae0751bf87103d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1770, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}