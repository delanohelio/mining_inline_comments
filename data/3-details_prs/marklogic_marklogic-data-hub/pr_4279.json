{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2OTE3MTUx", "number": 4279, "title": "DHFPROD-3577: Support sorting on export", "bodyText": "Description\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-07-27T05:53:49Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279", "merged": true, "mergeCommit": {"oid": "4f7d571ccf018bbcf9c14f4a17e9e8a777963096"}, "closed": true, "closedAt": "2020-08-03T15:57:57Z", "author": {"login": "ryanjdew"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5AWASAFqTQ1NTcwNTcxMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7S6zYAFqTQ2MDA3NTIyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NzA1NzEy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#pullrequestreview-455705712", "createdAt": "2020-07-27T11:43:48Z", "commit": {"oid": "821e3d3875ebc09ad413a6e717773d1341512029"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2ODc3MDM4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#pullrequestreview-456877038", "createdAt": "2020-07-28T17:58:24Z", "commit": {"oid": "821e3d3875ebc09ad413a6e717773d1341512029"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "821e3d3875ebc09ad413a6e717773d1341512029", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/821e3d3875ebc09ad413a6e717773d1341512029", "committedDate": "2020-07-27T05:51:12Z", "message": "DHFPROD-3577: Support sorting on export"}, "afterCommit": {"oid": "0cbcc698186ccd79f648aaad69da17cba48fb10a", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/0cbcc698186ccd79f648aaad69da17cba48fb10a", "committedDate": "2020-07-30T20:56:14Z", "message": "DHFPROD-3577: Support sorting on export"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MTIyOTM5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#pullrequestreview-459122939", "createdAt": "2020-07-31T12:05:43Z", "commit": {"oid": "0cbcc698186ccd79f648aaad69da17cba48fb10a"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0cbcc698186ccd79f648aaad69da17cba48fb10a", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/0cbcc698186ccd79f648aaad69da17cba48fb10a", "committedDate": "2020-07-30T20:56:14Z", "message": "DHFPROD-3577: Support sorting on export"}, "afterCommit": {"oid": "b28e2fc1e7e779842607892b73b7cf725dcf83c7", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b28e2fc1e7e779842607892b73b7cf725dcf83c7", "committedDate": "2020-07-31T21:12:12Z", "message": "DHFPROD-3577: Support sorting on export"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/a8143032d6544dd76a3380f57df25fecdb129ae3", "committedDate": "2020-07-31T22:31:42Z", "message": "DHFPROD-3577: Support sorting on export"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b28e2fc1e7e779842607892b73b7cf725dcf83c7", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b28e2fc1e7e779842607892b73b7cf725dcf83c7", "committedDate": "2020-07-31T21:12:12Z", "message": "DHFPROD-3577: Support sorting on export"}, "afterCommit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/a8143032d6544dd76a3380f57df25fecdb129ae3", "committedDate": "2020-07-31T22:31:42Z", "message": "DHFPROD-3577: Support sorting on export"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTUyMjI5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#pullrequestreview-459552229", "createdAt": "2020-08-01T04:39:42Z", "commit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NjgyMjgw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#pullrequestreview-459682280", "createdAt": "2020-08-02T22:03:20Z", "commit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowMzoyMFrOG6oK1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowMzoyMFrOG6oK1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyODcyNg==", "bodyText": "@ryanjdew  @rahulvudutala  Are the names here based on property names in the entity model, or constraint names in search options?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#discussion_r464128726", "createdAt": "2020-08-02T22:03:20Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/entitySearch/getOpticPlanTest.sjs", "diffHunk": "@@ -0,0 +1,104 @@\n+const search = require('/MarkLogic/appservices/search/search');\n+const test = require(\"/test/test-helper.xqy\");\n+const hubTest = require(\"/test/data-hub-test-helper.sjs\");\n+const op = require('/MarkLogic/optic');\n+\n+const queryOptions = '<options xmlns=\"http://marklogic.com/appservices/search\"/>';\n+\n+function invokeOpticPlanService(schemaName, viewName, limit, structuredQuery, searchText, sortOrder, columns, retries=0) {\n+    try {\n+        // Need to clear the modules cache or unrelated error could be thrown. Investigating to file a bugtrack.\n+        if (retries === 0) {\n+            xdmp.moduleCacheClear();\n+        }\n+        return fn.head(xdmp.invoke(\n+            \"/data-hub/5/data-services/entitySearch/getOpticPlan.sjs\",\n+            {\n+                schemaName,\n+                viewName,\n+                limit,\n+                structuredQuery,\n+                searchText,\n+                queryOptions,\n+                sortOrder: xdmp.toJSON(sortOrder).root,\n+                columns: Sequence.from(columns)\n+            }\n+        ));\n+    } catch (e) {\n+        if (e.code === 'SQL-TABLEREINDEXING' || e.name === 'SQL-TABLEREINDEXING' && retries < 20) {\n+            if (retries === 0) {\n+                xdmp.sleep(1000);\n+            } else {\n+                xdmp.sleep(500);\n+            }\n+            xdmp.log(`Optic retry: ${retries}`);\n+            return invokeOpticPlanService(schemaName, viewName, limit, structuredQuery, searchText, sortOrder, columns, ++retries);\n+        } else {\n+            throw e;\n+        }\n+    }\n+}\n+\n+function testValidAscendingPlan() {\n+    const structuredQuery = xdmp.quote(search.parse(''));\n+    const plan = invokeOpticPlanService(\n+        'EntitySearchEntity',\n+        'EntitySearchEntity', 10,\n+        structuredQuery, '',\n+        [{'name':'searchEntityProp1', 'ascending':true}],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NjgyNDM2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#pullrequestreview-459682436", "createdAt": "2020-08-02T22:05:59Z", "commit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowNjowMFrOG6oL8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowNzowMlrOG6oMRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyOTAwOA==", "bodyText": "Nice, this is a lot simpler, having these in separate files.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#discussion_r464129008", "createdAt": "2020-08-02T22:06:00Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/entitySearch/suiteSetup.sjs", "diffHunk": "@@ -125,238 +131,17 @@ xdmp.documentInsert(\"/exp/doc2\",\n               }\n             ],\n             \"searchEntityProp2\": \"doc2SrchEntyProp2\",\n-            \"searchEntityProp1\": \"doc2SrchEntyProp1\"\n+            \"searchEntityProp1\": \"doc2SrchEntyProp1\",\n+            \"hyphenated-property\": \"doc2HyphenatedProp\"\n           }\n         }\n       }\n     },\n     {\n-      permissions: xdmp.defaultPermissions(),\n+      permissions: defaultPermissions,\n       collections: \"doc2\",\n       metadata: {\n         \"datahubCreatedInFlow\": \"my-flow-2\",\n         \"datahubCreatedByStep\": \"my-step-2\"\n       }\n-    });\n-\n-// Inserting entity model documents into final database\n-xdmp.documentInsert(\"/entities/NumericEntity.entity.json\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyOTA5NQ==", "bodyText": "@ryanjdew  @rahulvudutala Is the reason these documents are defined inline instead of in the \"./test-data/content\" folder because of the need to define metadata and collections for the documents? If so, I'll think about a way to define those in the test documents. I'm thinking we could do a custom JSON structure with properties of \"document\", \"metadata\", and \"collections.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#discussion_r464129095", "createdAt": "2020-08-02T22:07:02Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/entitySearch/suiteSetup.sjs", "diffHunk": "@@ -56,13 +61,14 @@ xdmp.documentInsert(\"/exp/doc1\",\n               }\n             ],\n             \"searchEntityProp2\": \"doc1SrchEntyProp2\",\n-            \"searchEntityProp1\": \"doc1SrchEntyProp1\"\n+            \"searchEntityProp1\": \"doc1SrchEntyProp1\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMDc1MjIx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#pullrequestreview-460075221", "createdAt": "2020-08-03T14:30:09Z", "commit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2456, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}