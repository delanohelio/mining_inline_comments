{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5NjM4MzA4", "number": 4143, "title": "DHFPROD-5126: Support XML instances in search transform", "bodyText": "DHFPROD-5126: Support XML instances in search results transform\nDHFPROD-5276: Change manageSavedQuery privilege to savedQueryUser\nDescription\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-06-25T03:41:47Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4143", "merged": true, "mergeCommit": {"oid": "f5f34217385a32f9e0315f83c24272c69fd2489c"}, "closed": true, "closedAt": "2020-06-26T00:02:46Z", "author": {"login": "rahulvudutala"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuu4_kgFqTQzNzUwMzY0Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcu3uIhAFqTQzNzkzNTY3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTAzNjQ2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4143#pullrequestreview-437503646", "createdAt": "2020-06-25T13:40:00Z", "commit": {"oid": "b3c8d3d43e2f69e9b7d784521a3163d0f4ba50e7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzo0MDowMFrOGo7Lmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzo0Mzo1OVrOGo7WwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU2NTg1MA==", "bodyText": "How is this returning an array? http://docs.marklogic.com/es.instanceJsonFromDocument says it should return an objectNode. The name \"getEntityInstance\" also implies that a single thing is being returned, not an array.\nPerhaps you just need to call fn.head on the result of es.instanceJsonFromDocument, as shown in the docs page for that function?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4143#discussion_r445565850", "createdAt": "2020-06-25T13:40:00Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -241,6 +247,10 @@ function buildAndCacheSelectedPropertyMetadata(selectedPropertyName, selectedPro\n   return finalMetadataProperty;\n }\n \n+function getEntityInstance(docUri) {\n+  return es.instanceJsonFromDocument(cts.doc(docUri)).toArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c8d3d43e2f69e9b7d784521a3163d0f4ba50e7"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU2Njg5Mg==", "bodyText": "I'm hoping this code won't be necessary if you call fn.head on the result from es.instanceJsonFromDocument.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4143#discussion_r445566892", "createdAt": "2020-06-25T13:41:31Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -51,7 +54,11 @@ function addPropertiesToSearchResponse(entityName, searchResponse, propertiesToD\n \n     let instance = null;\n     try {\n-      instance = cts.doc(result.uri).toObject().envelope.instance;\n+      const instanceArray = getEntityInstance(result.uri);\n+      instance = instanceArray.find(instance => Object.keys(instance)[0] === entityName &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c8d3d43e2f69e9b7d784521a3163d0f4ba50e7"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU2ODcwNQ==", "bodyText": "These looks like good tests, but hoping that getEntityInstance can be adjusted above to either return a single object or nothing, not an array.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4143#discussion_r445568705", "createdAt": "2020-06-25T13:43:59Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/entities/search/getEntityInstance.sjs", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const entitySearchLib = require(\"/data-hub/5/entities/entity-search-lib.sjs\");\n+const test = require(\"/test/test-helper.xqy\");\n+\n+const shippingResults = [\n+  {\n+    \"Address\": {\n+      \"street\": \"Whitwell Place\",\n+      \"city\": \"Ellerslie\",\n+      \"state\": \"Georgia\",\n+      \"zip\": {\n+        \"Zip\": {\n+          \"fiveDigit\": \"52239\",\n+          \"plusFour\": \"1718\"\n+        }\n+      }\n+    }\n+  },\n+  {\n+    \"Address\": {\n+      \"street\": \"Skyway road\",\n+      \"city\": \"San carlos\",\n+      \"state\": \"California\",\n+      \"zip\": {\n+        \"Zip\": {\n+          \"fiveDigit\": \"94070\",\n+          \"plusFour\": \"1234\"\n+        }\n+      }\n+    }\n+  }\n+];\n+\n+const billingResults = {\n+  \"Address\": {\n+    \"street\": \"Anna Court\",\n+    \"city\": \"Stewart\",\n+    \"state\": \"Kansas\",\n+    \"zip\": {\n+      \"Zip\": {\n+        \"fiveDigit\": \"62601\",\n+        \"plusFour\": \"6783\"\n+      }\n+    }\n+  }\n+};\n+\n+function getInstanceWithoutESInfo() {\n+  let docUri = \"/content/sally.json\";\n+  const instanceArray = entitySearchLib.getEntityInstance(docUri);\n+  const results = instanceArray[0][\"Customer\"].toObject();\n+  return [\n+    test.assertEqual(101, results[\"customerId\"]),\n+    test.assertEqual(\"Sally Hardin\", results[\"name\"]),\n+    test.assertEqual(shippingResults, results[\"shipping\"]),\n+    test.assertEqual([\"Sal\", \"din\", \"shh\"], results[\"nicknames\"]),\n+    test.assertEqual(JSON.stringify(billingResults), JSON.stringify(results[\"billing\"]))\n+  ];\n+}\n+\n+function getInstanceWithESInfo() {\n+  let docUri = \"/content/jane.json\";\n+  const instanceArray = entitySearchLib.getEntityInstance(docUri);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c8d3d43e2f69e9b7d784521a3163d0f4ba50e7"}, "originalPosition": 79}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3c8d3d43e2f69e9b7d784521a3163d0f4ba50e7", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b3c8d3d43e2f69e9b7d784521a3163d0f4ba50e7", "committedDate": "2020-06-25T01:39:40Z", "message": "DHFPROD-5126: Support XML instances in search transform\n\nDHFPROD-5276: Change manageSavedQuery privilege to savedQueryUser"}, "afterCommit": {"oid": "4e0128d317c5d0bb86387c34f1ed301f5a9559bd", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4e0128d317c5d0bb86387c34f1ed301f5a9559bd", "committedDate": "2020-06-25T21:37:50Z", "message": "DHFPROD-5126: Support XML instances in search results transform\nDHFPROD-5276: Change manageSavedQuery privilege to savedQueryUser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69a4c47d5f3c9ede3f1daffb9e71af08c1c0a7b5", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/69a4c47d5f3c9ede3f1daffb9e71af08c1c0a7b5", "committedDate": "2020-06-25T21:40:55Z", "message": "DHFPROD-5126: Support XML instances in search results transform\nDHFPROD-5276: Change manageSavedQuery privilege to savedQueryUser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e0128d317c5d0bb86387c34f1ed301f5a9559bd", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4e0128d317c5d0bb86387c34f1ed301f5a9559bd", "committedDate": "2020-06-25T21:37:50Z", "message": "DHFPROD-5126: Support XML instances in search results transform\nDHFPROD-5276: Change manageSavedQuery privilege to savedQueryUser"}, "afterCommit": {"oid": "69a4c47d5f3c9ede3f1daffb9e71af08c1c0a7b5", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/69a4c47d5f3c9ede3f1daffb9e71af08c1c0a7b5", "committedDate": "2020-06-25T21:40:55Z", "message": "DHFPROD-5126: Support XML instances in search results transform\nDHFPROD-5276: Change manageSavedQuery privilege to savedQueryUser"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3ODk1NDY5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4143#pullrequestreview-437895469", "createdAt": "2020-06-25T22:13:19Z", "commit": {"oid": "69a4c47d5f3c9ede3f1daffb9e71af08c1c0a7b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTM1Njc0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4143#pullrequestreview-437935674", "createdAt": "2020-06-26T00:01:46Z", "commit": {"oid": "69a4c47d5f3c9ede3f1daffb9e71af08c1c0a7b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2563, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}