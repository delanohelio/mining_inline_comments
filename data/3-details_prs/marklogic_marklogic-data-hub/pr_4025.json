{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1MzA3NjI3", "number": 4025, "title": "DHFPROD-4967: Grant role to allow users to save queries", "bodyText": "Description\n\nAdding hub-central roles for saved query documents\nUI Changes\nAdding tests\n\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-05-29T20:18:57Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025", "merged": true, "mergeCommit": {"oid": "0f603590406098ddd9a17144c03fe52ad8c6ca72"}, "closed": true, "closedAt": "2020-06-02T21:50:04Z", "author": {"login": "rahulvudutala"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmJcAAAFqTQyMTI5OTc3MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnbb9JAFqTQyMzA1ODAyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMjk5Nzcx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#pullrequestreview-421299771", "createdAt": "2020-05-29T21:31:58Z", "commit": {"oid": "7e0c4648e4a3e659d731f52317375e3b0d74d2ee"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQyMTozMTo1OFrOGcspzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQyMTozNDo1M1rOGcstpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NDkwOQ==", "bodyText": "It's fine to do this, but I think soon, we should remove all of these assertions. If the roles/privileges weren't correctly written out, that \"bootstrap\" would fail and none of the tests would run. So these assertions are redundant and not adding any value. Fine to keep them for now, I'll look into removing all of them soon.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r432744909", "createdAt": "2020-05-29T21:31:58Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/core/HubProjectTest.java", "diffHunk": "@@ -92,8 +92,8 @@ public void testInit() throws IOException {\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-step-definition-writer.json\").exists());\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-entity-model-reader.json\").exists());\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-entity-model-writer.json\").exists());\n-        assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-saved-query-reader.json\").exists());\n-        assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-saved-query-writer.json\").exists());\n+        assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/hub-central-saved-query-reader.json\").exists());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e0c4648e4a3e659d731f52317375e3b0d74d2ee"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NTM0MQ==", "bodyText": "Shouldn't you be able to do this without the \"data-hub-developer\" role, since this is an HC-specific capability?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r432745341", "createdAt": "2020-05-29T21:33:07Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/lib/entitySearchService.sjs", "diffHunk": "@@ -1,5 +1,11 @@\n+const hubTest = require(\"/test/data-hub-test-helper.sjs\");\n+\n function invokeSavedQuery(module, args) {\n-  return fn.head(xdmp.invoke(\"/data-hub/5/data-services/entitySearch/\" + module, args));\n+  return fn.head(hubTest.runWithRolesAndPrivileges(\n+      ['data-hub-developer', 'hub-central-saved-query-reader', 'hub-central-saved-query-writer'], [],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e0c4648e4a3e659d731f52317375e3b0d74d2ee"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NTg5Mw==", "bodyText": "I don't think we want these assertions here. Instead, what we care about is that the EntitySearchController endpoints are secured correctly. Those should have @secure(\"ROLE_manageSavedQuery\") on them. You can then more effectively test the logic below by trying to hit the endpoints in a subclass of AbstractMvcTest as a user with that the saved-query roles, and without them.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r432745893", "createdAt": "2020-05-29T21:34:53Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/impl/security/getAuthoritiesTest.sjs", "diffHunk": "@@ -62,4 +49,13 @@ hubTest.runWithRolesAndPrivileges(['hub-central-mapping-writer'], [], function()\n     assertions.push(test.assertTrue(authorities.includes('readMapping'), 'hub-central-mapping-writer should have \"readMapping\"'));\n     assertions.push(test.assertTrue(authorities.includes('writeMapping'), 'hub-central-mapping-writer should not have \"writeMapping\"'));\n });\n+\n+// Test hub-central-saved-query-writer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e0c4648e4a3e659d731f52317375e3b0d74d2ee"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e0c4648e4a3e659d731f52317375e3b0d74d2ee", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/7e0c4648e4a3e659d731f52317375e3b0d74d2ee", "committedDate": "2020-05-29T19:41:28Z", "message": "DHFPROD-4967: Adding hub-central roles for saved query documents\n\nDHFPROD-4967: UI Changes\n\nDHFPROD-4967: Adding tests"}, "afterCommit": {"oid": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "committedDate": "2020-05-31T01:29:53Z", "message": "DHFPROD-4967: Adding hub-central roles for saved query documents\n\nDHFPROD-4967: UI Changes\n\nDHFPROD-4967: Running tests using hub-central-saved-query-writer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxODQzMDI3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#pullrequestreview-421843027", "createdAt": "2020-06-01T13:30:04Z", "commit": {"oid": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxMzozMDowNFrOGdKg6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxMzozMzoxOFrOGdKnmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIzNDE1Mg==", "bodyText": "No need to change, but you can do this in one method - loginAsTestUserWithRoles.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r433234152", "createdAt": "2020-06-01T13:30:04Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java", "diffHunk": "@@ -45,6 +45,9 @@ void testCRUDOnSavedQuery() throws Exception {\n             \"  }\\n\" +\n             \"}\";\n \n+        setTestUserRoles(\"hub-central-saved-query-writer\", \"hub-central-saved-query-reader\");\n+        loginAsTestUser();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIzNTg2NQ==", "bodyText": "There's a helper method in AbstractMvcTest to make this a little easier, and it guarantees that the user's authenticated HttpSession is used - verifyRequestIsForbidden. Please use this instead.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r433235865", "createdAt": "2020-06-01T13:33:18Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java", "diffHunk": "@@ -94,6 +97,14 @@ void testCRUDOnSavedQuery() throws Exception {\n                 ObjectNode response = readJsonObject(result.getResponse().getContentAsString());\n                 assertTrue(response.isEmpty());\n             });\n+\n+        // Try save/update/delete without the required role \"hub-central-saved-query-writer\"\n+        setTestUserRoles(\"hub-central-saved-query-reader\");\n+        loginAsTestUser();\n+\n+        postJson(SAVED_QUERIES_PATH, json).andExpect(status().isForbidden());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMTM1NjYy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#pullrequestreview-422135662", "createdAt": "2020-06-01T19:53:53Z", "commit": {"oid": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "committedDate": "2020-05-31T01:29:53Z", "message": "DHFPROD-4967: Adding hub-central roles for saved query documents\n\nDHFPROD-4967: UI Changes\n\nDHFPROD-4967: Running tests using hub-central-saved-query-writer"}, "afterCommit": {"oid": "b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90", "committedDate": "2020-06-02T17:55:37Z", "message": "DHFPROD-4967: Grant role to allow users to save queries backend changes\n\nDHFPROD-4967: UI Changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTY4MTM2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#pullrequestreview-422968136", "createdAt": "2020-06-02T18:54:08Z", "commit": {"oid": "b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDE3MTU5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#pullrequestreview-423017159", "createdAt": "2020-06-02T20:04:25Z", "commit": {"oid": "b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84eb181494d44b24f077eb8f7206bad9a4d046aa", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/84eb181494d44b24f077eb8f7206bad9a4d046aa", "committedDate": "2020-06-02T20:08:45Z", "message": "DHFPROD-4967: Grant role to allow users to save queries backend changes\n\nDHFPROD-4967: UI Changes\n\nDHFPROD-4967: Removing data-hub-common-writer role and adding required privileges to data-hub-saved-query-user role"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90", "committedDate": "2020-06-02T17:55:37Z", "message": "DHFPROD-4967: Grant role to allow users to save queries backend changes\n\nDHFPROD-4967: UI Changes"}, "afterCommit": {"oid": "84eb181494d44b24f077eb8f7206bad9a4d046aa", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/84eb181494d44b24f077eb8f7206bad9a4d046aa", "committedDate": "2020-06-02T20:08:45Z", "message": "DHFPROD-4967: Grant role to allow users to save queries backend changes\n\nDHFPROD-4967: UI Changes\n\nDHFPROD-4967: Removing data-hub-common-writer role and adding required privileges to data-hub-saved-query-user role"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDQ1Mjc3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#pullrequestreview-423045277", "createdAt": "2020-06-02T20:47:11Z", "commit": {"oid": "84eb181494d44b24f077eb8f7206bad9a4d046aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDQ5NzA2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#pullrequestreview-423049706", "createdAt": "2020-06-02T20:54:03Z", "commit": {"oid": "84eb181494d44b24f077eb8f7206bad9a4d046aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDU4MDI5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#pullrequestreview-423058029", "createdAt": "2020-06-02T21:07:02Z", "commit": {"oid": "84eb181494d44b24f077eb8f7206bad9a4d046aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTowNzowM1rOGeD_RQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMTowNzowM1rOGeD_RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3NTgxMw==", "bodyText": "Why is rest-writer needed here? Saved queries are written via Data Services. I don't think this is needed.\nAny I missed why data-hub-common-writer didn't work?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r434175813", "createdAt": "2020-06-02T21:07:03Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/hub-internal-config/security/roles/data-hub-saved-query-user.json", "diffHunk": "@@ -0,0 +1,31 @@\n+{\n+  \"role-name\": \"data-hub-saved-query-user\",\n+  \"description\": \"Permits read, update and delete saved query documents\",\n+  \"privilege\": [\n+    {\n+      \"privilege-name\": \"xdmp:document-load\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/xdmp-document-load\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"unprotected-collections\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/unprotected-collections\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"unprotected-uri\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/unprotected-uri\",\n+      \"kind\": \"execute\"\n+    },\n+    {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84eb181494d44b24f077eb8f7206bad9a4d046aa"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2673, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}