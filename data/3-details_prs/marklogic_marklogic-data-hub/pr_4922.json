{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5ODYzNzYy", "number": 4922, "title": "DHFPROD-5278: Improve SMT merging step, so it is easier to track prog\u2026", "bodyText": "\u2026ress and to restart it\nDHFPROD-5278: Patch unit tests\nDescription\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-11-30T23:07:27Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922", "merged": true, "mergeCommit": {"oid": "2358eab7a687971a7cf3e28f40a240817acb7854"}, "closed": true, "closedAt": "2020-12-03T15:23:36Z", "author": {"login": "ryanjdew"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhtwZ0AFqTU0MTM3MDM5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiRxq7AFqTU0MzA1ODgzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzcwMzk1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922#pullrequestreview-541370395", "createdAt": "2020-11-30T23:15:20Z", "commit": {"oid": "32125368e3e618f182276752a9a1e1f80c115683"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzcxMTI1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922#pullrequestreview-541371125", "createdAt": "2020-11-30T23:16:54Z", "commit": {"oid": "32125368e3e618f182276752a9a1e1f80c115683"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32125368e3e618f182276752a9a1e1f80c115683", "author": {"user": {"login": "fsnow", "name": "Frank Snow"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/32125368e3e618f182276752a9a1e1f80c115683", "committedDate": "2020-11-30T22:56:29Z", "message": "DHFPROD-5278: Improve SMT merging step, so it is easier to track progress and to restart it\n\nDHFPROD-5278: Patch unit tests"}, "afterCommit": {"oid": "ed90733818ba0fa182b0286c8f7464e5a97cf16c", "author": {"user": {"login": "fsnow", "name": "Frank Snow"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/ed90733818ba0fa182b0286c8f7464e5a97cf16c", "committedDate": "2020-11-30T23:23:10Z", "message": "DHFPROD-5278: Improve SMT merging step, so it is easier to track progress and to restart it\n\nDHFPROD-5278: Patch unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzgzOTE4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922#pullrequestreview-541383918", "createdAt": "2020-11-30T23:46:11Z", "commit": {"oid": "ed90733818ba0fa182b0286c8f7464e5a97cf16c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzo0NjoxMVrOH8SXrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzo1MjoyMlrOH8ShKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk3NzU4MQ==", "bodyText": "If the code is no longer valid in collectorLib, let's just delete this and not comment it out", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922#discussion_r532977581", "createdAt": "2020-11-30T23:46:11Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/endpoints/collectorLib/prepareSourceQuery.sjs", "diffHunk": "@@ -16,6 +16,8 @@ let sourceQuery = lib.prepareSourceQuery(\n     type: \"merging\"\n   }\n );\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed90733818ba0fa182b0286c8f7464e5a97cf16c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk3ODA2NA==", "bodyText": "This seems really good that we're removing this, as ideally the flow framework has no knowledge of concrete step types. I'm missing what changes in merging.sjs make this possible though?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922#discussion_r532978064", "createdAt": "2020-11-30T23:47:26Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -159,15 +159,11 @@ class Flow {\n       query = sourceQuery ? xdmp.eval(sourceQuery) : null;\n     }\n \n-    if (stepDefinition.name === 'default-merging' && stepDefinition.type === 'merging' && uris) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed90733818ba0fa182b0286c8f7464e5a97cf16c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk4MDAwOQ==", "bodyText": "I kind of follow the logic, but I'm not clear on the goal - it sounds expected that there may be summaries with multiple possible merges for the same URI, and we want to favor the  match summary that recommends merging the most URIs with the current URI we're processing?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922#discussion_r532980009", "createdAt": "2020-11-30T23:52:22Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/builtins/steps/mastering/default/merging.sjs", "diffHunk": "@@ -38,87 +37,87 @@ function main(content, options) {\n       httpUtils.throwBadRequestWithArray([`Could not find step with stepId ${options.stepId}`]);\n     }\n   }\n-  const jobID = datahub.flow.globalContext.jobId;\n-  const urisPathReference = cts.pathReference('/matchSummary/URIsToProcess', ['type=string','collation=http://marklogic.com/collation/']);\n+  //const jobID = datahub.flow.globalContext.jobId;\n+  const urisPathReference = cts.pathReference('/matchSummary/URIsToProcess', ['type=string', 'collation=http://marklogic.com/collation/']);\n   const datahubCreatedOnRef = cts.fieldReference('datahubCreatedOn', ['type=dateTime']);\n-  const uriToTakeActionOn = content.uri;\n+  const thisMatchSummaryURI = content.uri;\n   masteringStepLib.checkOptions(null, options, null, requiredOptionProperties);\n-  const matchSummaryCollection = `datahubMasteringMatchSummary${options.targetEntityType ? `-${options.targetEntityType}`:''}`;\n+  const matchSummaryCollection = `datahubMasteringMatchSummary${options.targetEntityType ? `-${options.targetEntityType}` : ''}`;\n   const collectionQuery = cts.collectionQuery(matchSummaryCollection);\n-  const uriRangeQuery = cts.rangeQuery(urisPathReference, '=', uriToTakeActionOn);\n-  let relatedMatchSummaries = cts.search(\n-    cts.andQuery([\n-      uriRangeQuery,\n-      collectionQuery\n-    ]),\n-    ['unfiltered',cts.indexOrder(datahubCreatedOnRef, 'descending')]\n-  );\n-  let mostRecentMatchSummary = fn.head(relatedMatchSummaries);\n-  let matchSummaryJson = mostRecentMatchSummary.toObject();\n-  let uriActionDetails = matchSummaryJson.matchSummary.actionDetails[uriToTakeActionOn];\n-  // If the action is merge, ensure we create the merge with the most URIs\n-  if (uriActionDetails && uriActionDetails.action === 'merge') {\n-    const urisQuery = cts.pathRangeQuery('//actionDetails/*/uris', '=', uriActionDetails.uris)\n-    const postiveQuery = [\n-      cts.jsonPropertyValueQuery('action', 'merge'),\n-      urisQuery,\n-      collectionQuery\n-    ];\n-    const otherMergesForURI = cts.search(\n-      cts.andNotQuery(\n-        cts.andQuery(postiveQuery),\n-        uriRangeQuery\n-      ),\n-      ['unfiltered',cts.indexOrder(datahubCreatedOnRef, 'descending')]\n-    ).toArray()\n-        // get the actionNode for the URI\n-        .map(\n-          (result) => result.xpath(`/matchSummary/actionDetails/*[action = 'merge']`).toArray()\n-            .filter((actionNode) => cts.contains(actionNode, urisQuery))[0]\n-        )\n-        // filter out false positives that don't have merge actions for the given URI\n-        .filter((actionNode) => !!actionNode)\n-        // convert node to JSON object\n-        .map((actionNode) => actionNode.toObject());\n-    if (otherMergesForURI.some((otherMerge) => otherMerge.uris.length > uriActionDetails.uris.length)) {\n-      return Sequence.from([]);\n+\n+  let returnArray = [];\n+\n+  let thisMatchSummary = (content.value ? content.value : cts.doc(thisMatchSummaryURI));\n+  if (!thisMatchSummary) {\n+    return Sequence.from([]);\n+  }\n+  thisMatchSummary = thisMatchSummary.toObject();\n+  let theseURIsToProcess = thisMatchSummary.matchSummary.URIsToProcess;\n+\n+  for (uriToProcess of theseURIsToProcess) {\n+\n+    // don't process this \"URIsToProcess\" URI unless we are processing the last matchSummary document\n+    // (in URI order) that contains it\n+    let lastSummaryWithURI = cts.uris(null, [\"descending\", \"limit=1\"],\n+      cts.pathRangeQuery(\"/matchSummary/URIsToProcess\", \"=\" , uriToProcess));\n+    if (lastSummaryWithURI != thisMatchSummaryURI) {\n+      continue;\n     }\n-    otherMergesForURI.forEach((actionDetails) => actionDetails.uris.forEach(\n-      (uri) => {\n-        if (!uriActionDetails.uris.includes(uri)) {\n-          uriActionDetails.uris.push(uri);\n-        }\n+\n+    let uriActionDetails = thisMatchSummary.matchSummary.actionDetails[uriToProcess];\n+    // If the action is merge, ensure we create the merge with the most URIs\n+    if (uriActionDetails && uriActionDetails.action === 'merge') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed90733818ba0fa182b0286c8f7464e5a97cf16c"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMDYxNjgy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922#pullrequestreview-542061682", "createdAt": "2020-12-01T16:12:04Z", "commit": {"oid": "ed90733818ba0fa182b0286c8f7464e5a97cf16c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed90733818ba0fa182b0286c8f7464e5a97cf16c", "author": {"user": {"login": "fsnow", "name": "Frank Snow"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/ed90733818ba0fa182b0286c8f7464e5a97cf16c", "committedDate": "2020-11-30T23:23:10Z", "message": "DHFPROD-5278: Improve SMT merging step, so it is easier to track progress and to restart it\n\nDHFPROD-5278: Patch unit tests"}, "afterCommit": {"oid": "4ce8cd0c10a41e6e24ad3e5ad9d6da85fa38e891", "author": {"user": {"login": "fsnow", "name": "Frank Snow"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4ce8cd0c10a41e6e24ad3e5ad9d6da85fa38e891", "committedDate": "2020-12-01T20:16:03Z", "message": "DHFPROD-5278: Improve SMT merging step, so it is easier to track progress and to restart it\n\nDHFPROD-5278: Patch unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMjYzNjI5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922#pullrequestreview-542263629", "createdAt": "2020-12-01T20:19:53Z", "commit": {"oid": "4ce8cd0c10a41e6e24ad3e5ad9d6da85fa38e891"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzEwNjU0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922#pullrequestreview-542310654", "createdAt": "2020-12-01T21:28:23Z", "commit": {"oid": "4ce8cd0c10a41e6e24ad3e5ad9d6da85fa38e891"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0b6d1b10f4a64bf5c695402b04aadbd05371fe6", "author": {"user": {"login": "fsnow", "name": "Frank Snow"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c0b6d1b10f4a64bf5c695402b04aadbd05371fe6", "committedDate": "2020-12-01T21:55:42Z", "message": "DHFPROD-5278: Improve SMT merging step, so it is easier to track progress and to restart it\n\nDHFPROD-5278: Patch unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ce8cd0c10a41e6e24ad3e5ad9d6da85fa38e891", "author": {"user": {"login": "fsnow", "name": "Frank Snow"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4ce8cd0c10a41e6e24ad3e5ad9d6da85fa38e891", "committedDate": "2020-12-01T20:16:03Z", "message": "DHFPROD-5278: Improve SMT merging step, so it is easier to track progress and to restart it\n\nDHFPROD-5278: Patch unit tests"}, "afterCommit": {"oid": "c0b6d1b10f4a64bf5c695402b04aadbd05371fe6", "author": {"user": {"login": "fsnow", "name": "Frank Snow"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c0b6d1b10f4a64bf5c695402b04aadbd05371fe6", "committedDate": "2020-12-01T21:55:42Z", "message": "DHFPROD-5278: Improve SMT merging step, so it is easier to track progress and to restart it\n\nDHFPROD-5278: Patch unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzMwODIx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922#pullrequestreview-542330821", "createdAt": "2020-12-01T21:58:50Z", "commit": {"oid": "c0b6d1b10f4a64bf5c695402b04aadbd05371fe6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDU4ODMz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4922#pullrequestreview-543058833", "createdAt": "2020-12-02T17:13:18Z", "commit": {"oid": "c0b6d1b10f4a64bf5c695402b04aadbd05371fe6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1491, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}