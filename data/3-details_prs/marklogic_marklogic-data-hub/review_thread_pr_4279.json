{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2OTE3MTUx", "number": 4279, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowMzoyMFrOEUbC4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowNzowMlrOEUbEGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5ODUwMDgxOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/entitySearch/getOpticPlanTest.sjs", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowMzoyMFrOG6oK1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowMzoyMFrOG6oK1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyODcyNg==", "bodyText": "@ryanjdew  @rahulvudutala  Are the names here based on property names in the entity model, or constraint names in search options?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#discussion_r464128726", "createdAt": "2020-08-02T22:03:20Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/entitySearch/getOpticPlanTest.sjs", "diffHunk": "@@ -0,0 +1,104 @@\n+const search = require('/MarkLogic/appservices/search/search');\n+const test = require(\"/test/test-helper.xqy\");\n+const hubTest = require(\"/test/data-hub-test-helper.sjs\");\n+const op = require('/MarkLogic/optic');\n+\n+const queryOptions = '<options xmlns=\"http://marklogic.com/appservices/search\"/>';\n+\n+function invokeOpticPlanService(schemaName, viewName, limit, structuredQuery, searchText, sortOrder, columns, retries=0) {\n+    try {\n+        // Need to clear the modules cache or unrelated error could be thrown. Investigating to file a bugtrack.\n+        if (retries === 0) {\n+            xdmp.moduleCacheClear();\n+        }\n+        return fn.head(xdmp.invoke(\n+            \"/data-hub/5/data-services/entitySearch/getOpticPlan.sjs\",\n+            {\n+                schemaName,\n+                viewName,\n+                limit,\n+                structuredQuery,\n+                searchText,\n+                queryOptions,\n+                sortOrder: xdmp.toJSON(sortOrder).root,\n+                columns: Sequence.from(columns)\n+            }\n+        ));\n+    } catch (e) {\n+        if (e.code === 'SQL-TABLEREINDEXING' || e.name === 'SQL-TABLEREINDEXING' && retries < 20) {\n+            if (retries === 0) {\n+                xdmp.sleep(1000);\n+            } else {\n+                xdmp.sleep(500);\n+            }\n+            xdmp.log(`Optic retry: ${retries}`);\n+            return invokeOpticPlanService(schemaName, viewName, limit, structuredQuery, searchText, sortOrder, columns, ++retries);\n+        } else {\n+            throw e;\n+        }\n+    }\n+}\n+\n+function testValidAscendingPlan() {\n+    const structuredQuery = xdmp.quote(search.parse(''));\n+    const plan = invokeOpticPlanService(\n+        'EntitySearchEntity',\n+        'EntitySearchEntity', 10,\n+        structuredQuery, '',\n+        [{'name':'searchEntityProp1', 'ascending':true}],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5ODUwMzI0OnYy", "diffSide": "LEFT", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/entitySearch/suiteSetup.sjs", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowNjowMFrOG6oL8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowNjowMFrOG6oL8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyOTAwOA==", "bodyText": "Nice, this is a lot simpler, having these in separate files.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#discussion_r464129008", "createdAt": "2020-08-02T22:06:00Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/entitySearch/suiteSetup.sjs", "diffHunk": "@@ -125,238 +131,17 @@ xdmp.documentInsert(\"/exp/doc2\",\n               }\n             ],\n             \"searchEntityProp2\": \"doc2SrchEntyProp2\",\n-            \"searchEntityProp1\": \"doc2SrchEntyProp1\"\n+            \"searchEntityProp1\": \"doc2SrchEntyProp1\",\n+            \"hyphenated-property\": \"doc2HyphenatedProp\"\n           }\n         }\n       }\n     },\n     {\n-      permissions: xdmp.defaultPermissions(),\n+      permissions: defaultPermissions,\n       collections: \"doc2\",\n       metadata: {\n         \"datahubCreatedInFlow\": \"my-flow-2\",\n         \"datahubCreatedByStep\": \"my-step-2\"\n       }\n-    });\n-\n-// Inserting entity model documents into final database\n-xdmp.documentInsert(\"/entities/NumericEntity.entity.json\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5ODUwMzk1OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/entitySearch/suiteSetup.sjs", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowNzowMlrOG6oMRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMjowNzowMlrOG6oMRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyOTA5NQ==", "bodyText": "@ryanjdew  @rahulvudutala Is the reason these documents are defined inline instead of in the \"./test-data/content\" folder because of the need to define metadata and collections for the documents? If so, I'll think about a way to define those in the test documents. I'm thinking we could do a custom JSON structure with properties of \"document\", \"metadata\", and \"collections.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4279#discussion_r464129095", "createdAt": "2020-08-02T22:07:02Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/entitySearch/suiteSetup.sjs", "diffHunk": "@@ -56,13 +61,14 @@ xdmp.documentInsert(\"/exp/doc1\",\n               }\n             ],\n             \"searchEntityProp2\": \"doc1SrchEntyProp2\",\n-            \"searchEntityProp1\": \"doc1SrchEntyProp1\"\n+            \"searchEntityProp1\": \"doc1SrchEntyProp1\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8143032d6544dd76a3380f57df25fecdb129ae3"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3870, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}