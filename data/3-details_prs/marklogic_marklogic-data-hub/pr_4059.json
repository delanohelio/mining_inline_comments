{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4ODEwODI1", "number": 4059, "title": "DHFPROD-5078: Display default properties for entity search results", "bodyText": "DHFPROD-5078: EntitySearch Transform Modules\nDHFPROD-5078: Reference entity model changes\nDHFPROD-5078: Tests\nDescription\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-06-05T22:20:57Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059", "merged": true, "mergeCommit": {"oid": "d1b532ab547a2a5fdf8d31180aa0d4ea2e2a1557"}, "closed": true, "closedAt": "2020-06-09T00:23:37Z", "author": {"login": "rahulvudutala"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcobVaugBqjM0MTM3MDYxNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpZLgHAFqTQyNjY5MTg0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a0b7cd4f5d6f7dd75cd88ef38f62b9a26512c91", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9a0b7cd4f5d6f7dd75cd88ef38f62b9a26512c91", "committedDate": "2020-06-05T21:59:07Z", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests"}, "afterCommit": {"oid": "d5d8acb8cfc26c60942b76372643817bec449100", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d5d8acb8cfc26c60942b76372643817bec449100", "committedDate": "2020-06-05T23:24:03Z", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MjI4MjE3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#pullrequestreview-426228217", "createdAt": "2020-06-08T13:23:27Z", "commit": {"oid": "d5d8acb8cfc26c60942b76372643817bec449100"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzoyMzoyN1rOGgd1Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzozMjoxM1rOGgeQkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5NjM2Nw==", "bodyText": "Is this supposed to differ from the first shipping address?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436696367", "createdAt": "2020-06-08T13:23:27Z", "author": {"login": "rjrudin"}, "path": "examples/reference-entity-model/input/json/Cust2.json", "diffHunk": "@@ -4,21 +4,37 @@\n     \"FirstName\": \"Adams\",\n     \"LastName\": \"Cole\"\n   },\n+  \"nicknames\": [\n+    \"ad\",\n+    \"coley\"\n+  ],\n   \"Email\": \"adamscole@nutralab.com\",\n-  \"Address\": {\n-    \"Shipping\": {\n-      \"Street\": \"Lefferts Place\",\n-      \"City\": \"Marenisco\",\n-      \"State\": \"Maryland\",\n-      \"Postal\": \"44582-8427\"\n+  \"Address\": [\n+    {\n+      \"Shipping\": {\n+        \"Street\": \"Lefferts Place\",\n+        \"City\": \"Marenisco\",\n+        \"State\": \"Maryland\",\n+        \"Postal\": \"44582-8427\"\n+      }\n     },\n-    \"Billing\": {\n-      \"Street\": \"Varick Avenue\",\n-      \"City\": \"Mooresburg\",\n-      \"State\": \"Delaware\",\n-      \"Postal\": \"17654-1292\"\n+    {\n+      \"Shipping\": {\n+        \"Street\": \"Lefferts Place\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5d8acb8cfc26c60942b76372643817bec449100"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY5NzI4Nw==", "bodyText": "Is it possible to select more than one entity type? If not, can we change this to a string instead of a List? We don't want the code to imply that something is possible when it's not.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436697287", "createdAt": "2020-06-08T13:24:27Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/entities/search/EntitySearchManager.java", "diffHunk": "@@ -96,6 +97,14 @@ public StringHandle search(SearchQuery searchQuery) {\n             String query = queryDef.serialize();\n             StructureWriteHandle handle = new StringHandle(buildSearchOptions(query, searchQuery)).withMimetype(\"application/xml\");\n             RawCombinedQueryDefinition rcQueryDef = queryMgr.newRawCombinedQueryDefinition(handle, queryDef.getOptionsName());\n+\n+            // If an entity has been selected, then apply this transform\n+            List<String> entityTypeIds = searchQuery.getQuery().getEntityTypeIds();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5d8acb8cfc26c60942b76372643817bec449100"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzM3Ng==", "bodyText": "Need a nice error here - I think you can use the \"throw\"* functions in ds-util.sjs to get it done easily - e.g. throwBadRequest(\"entityName is required to generate search results containing entity properties\");", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436703376", "createdAt": "2020-06-08T13:32:13Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/transforms/hubEntitySearchTransform.sjs", "diffHunk": "@@ -0,0 +1,30 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const entitySearchLib = require(\"/data-hub/5/entities/entity-search-lib.sjs\");\n+\n+// Expects JSON content\n+function transform(context, params, content) {\n+  // TODO If entityName isn't defined, throw a nice error", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5d8acb8cfc26c60942b76372643817bec449100"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5d8acb8cfc26c60942b76372643817bec449100", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d5d8acb8cfc26c60942b76372643817bec449100", "committedDate": "2020-06-05T23:24:03Z", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests"}, "afterCommit": {"oid": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332", "committedDate": "2020-06-08T14:23:06Z", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests\n\nDHFPROD-5078: Error handling for search transform and updating Customer input docs in reference-entity-model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MzUwNjg4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#pullrequestreview-426350688", "createdAt": "2020-06-08T15:21:05Z", "commit": {"oid": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNToyMTowNlrOGgjlPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjowNDozOVrOGglcSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc5MDU5MA==", "bodyText": "Is this here in case \"envelope.instance\" does not exist? If so, we shouldn't return - this might be one of 10 results, and the other 9 are fine. I also don't think it's an error - it simply means we can't add entity properties to that result. I think it's worth xdmp.tracing this - you can add a \"TRACE_ENTITY_SEARCH\" constant to consts.sjs to use as a trace event, with a value of \"data-hub-entity-search\". But just log that an instance could not be found and thus entity properties will not be added.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436790590", "createdAt": "2020-06-08T15:21:06Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+// TODO Will move this to /data-hub/5/entities soon\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const DataHub = require(\"/data-hub/5/datahub.sjs\");\n+const datahub = new DataHub();\n+\n+\n+function addPropertiesToSearchResponse(entityName, searchResponse) {\n+  const maxDefaultProperties = 5;\n+  const allProperties = generateEntityProperties(\"\", entityName, entityName);\n+  const defaultProperties = allProperties.slice(0, maxDefaultProperties);\n+\n+  // Add entityProperties to each search result\n+  searchResponse.results.forEach(result => {\n+    let instance = {};\n+    try {\n+      instance = cts.doc(result.uri).toObject().envelope.instance;\n+    } catch (error) {\n+      datahub.debug.log({message: error, type: 'error'});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwMDgyMQ==", "bodyText": "When would \"#\" not be the first token?\nI think it'd be good to move all of the logic in this for loop into a separate function that can be easily unit-tested - i.e. you want to make sure that the propertyMetadata returned for a given property definition is correct.\nThat also provides a good way of documenting all the different property definitions we support, which in theory would provide an example too of a \"$ref\" that does not start with \"#\".", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436800821", "createdAt": "2020-06-08T15:35:44Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+// TODO Will move this to /data-hub/5/entities soon\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const DataHub = require(\"/data-hub/5/datahub.sjs\");\n+const datahub = new DataHub();\n+\n+\n+function addPropertiesToSearchResponse(entityName, searchResponse) {\n+  const maxDefaultProperties = 5;\n+  const allProperties = generateEntityProperties(\"\", entityName, entityName);\n+  const defaultProperties = allProperties.slice(0, maxDefaultProperties);\n+\n+  // Add entityProperties to each search result\n+  searchResponse.results.forEach(result => {\n+    let instance = {};\n+    try {\n+      instance = cts.doc(result.uri).toObject().envelope.instance;\n+    } catch (error) {\n+      datahub.debug.log({message: error, type: 'error'});\n+      return;\n+    }\n+\n+    const entityInstance = instance[entityName];\n+    result.entityProperties = [];\n+    defaultProperties.forEach(parentProperty => {\n+      result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n+    });\n+  });\n+\n+  // Make it easy for the client to know which property names were used, and which ones exist\n+  searchResponse.selectedPropertyDefinitions = defaultProperties;\n+  searchResponse.entityPropertyDefinitions = allProperties;\n+}\n+\n+function generateEntityProperties(parentPropertyName, entityName, entityTypeName) {\n+  const allProperties = [];\n+  const entityType = entityLib.findEntityTypeFromModelByEntityName(entityName, entityTypeName);\n+  if(!entityType) {\n+    return allProperties;\n+  }\n+\n+  for (var propertyName of Object.keys(entityType.properties)) {\n+    const property = entityType.properties[propertyName];\n+\n+    const isSimpleProperty = property.datatype != \"array\" && !property[\"$ref\"];\n+    const isSimpleArrayProperty = property.datatype == \"array\" && (property[\"items\"] && !property[\"items\"][\"$ref\"]);\n+    const isStructuredProperty = property.datatype != \"array\" && property[\"$ref\"];\n+    const isStructuredArrayProperty = property.datatype == \"array\" && (property[\"items\"] && property[\"items\"][\"$ref\"]);\n+\n+    const propertyMetadata = {};\n+    propertyMetadata[\"propertyPath\"] = parentPropertyName ? parentPropertyName + \".\" + propertyName : propertyName;\n+    propertyMetadata[\"propertyLabel\"] = propertyName;\n+    propertyMetadata[\"datatype\"] = (isSimpleProperty || isSimpleArrayProperty) ? (isSimpleProperty ? property.datatype : property[\"items\"][\"datatype\"]) : \"object\";\n+    propertyMetadata[\"multiple\"] = (isSimpleArrayProperty || isStructuredArrayProperty) ? true : false;\n+\n+    if(isStructuredProperty || isStructuredArrayProperty) {\n+      let referenceInfo = isStructuredProperty ? property[\"$ref\"].split(\"/\") : property[\"items\"][\"$ref\"].split(\"/\");\n+      entityTypeName =  referenceInfo.pop();\n+      entityName = referenceInfo[0] === \"#\" ? entityName : referenceInfo.pop().toString().split(\"-\")[0];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwNTIwMA==", "bodyText": "We want to be careful about when we're dealing with \"properties\" and \"property definitions\" - the distinction between the two is critical, and we want the code to make it easy to know when we're dealing with one vs the other.\nAnd really, I think calling this \"property metadata\" - as you're doing below - is better, as a \"property definition\" should exclusively refer to how a property is defined within an entity type.\nTo that end, let's standardize on \"property metadata\" here:\n\nselectedPropertyMetadata\nentityPropertyMetadata\nAnd then call this function buildPropertyMetadata (I prefer \"build\" for when in-memory data is built and not persisted)", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436805200", "createdAt": "2020-06-08T15:42:17Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+// TODO Will move this to /data-hub/5/entities soon\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const DataHub = require(\"/data-hub/5/datahub.sjs\");\n+const datahub = new DataHub();\n+\n+\n+function addPropertiesToSearchResponse(entityName, searchResponse) {\n+  const maxDefaultProperties = 5;\n+  const allProperties = generateEntityProperties(\"\", entityName, entityName);\n+  const defaultProperties = allProperties.slice(0, maxDefaultProperties);\n+\n+  // Add entityProperties to each search result\n+  searchResponse.results.forEach(result => {\n+    let instance = {};\n+    try {\n+      instance = cts.doc(result.uri).toObject().envelope.instance;\n+    } catch (error) {\n+      datahub.debug.log({message: error, type: 'error'});\n+      return;\n+    }\n+\n+    const entityInstance = instance[entityName];\n+    result.entityProperties = [];\n+    defaultProperties.forEach(parentProperty => {\n+      result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n+    });\n+  });\n+\n+  // Make it easy for the client to know which property names were used, and which ones exist\n+  searchResponse.selectedPropertyDefinitions = defaultProperties;\n+  searchResponse.entityPropertyDefinitions = allProperties;\n+}\n+\n+function generateEntityProperties(parentPropertyName, entityName, entityTypeName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwNTgxNg==", "bodyText": "I think we need to throw an error here, as something is very wrong if we cannot find the model. Should do a ds.throwServerError with a message indicating what entity cannot be found.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436805816", "createdAt": "2020-06-08T15:43:06Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+// TODO Will move this to /data-hub/5/entities soon\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const DataHub = require(\"/data-hub/5/datahub.sjs\");\n+const datahub = new DataHub();\n+\n+\n+function addPropertiesToSearchResponse(entityName, searchResponse) {\n+  const maxDefaultProperties = 5;\n+  const allProperties = generateEntityProperties(\"\", entityName, entityName);\n+  const defaultProperties = allProperties.slice(0, maxDefaultProperties);\n+\n+  // Add entityProperties to each search result\n+  searchResponse.results.forEach(result => {\n+    let instance = {};\n+    try {\n+      instance = cts.doc(result.uri).toObject().envelope.instance;\n+    } catch (error) {\n+      datahub.debug.log({message: error, type: 'error'});\n+      return;\n+    }\n+\n+    const entityInstance = instance[entityName];\n+    result.entityProperties = [];\n+    defaultProperties.forEach(parentProperty => {\n+      result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n+    });\n+  });\n+\n+  // Make it easy for the client to know which property names were used, and which ones exist\n+  searchResponse.selectedPropertyDefinitions = defaultProperties;\n+  searchResponse.entityPropertyDefinitions = allProperties;\n+}\n+\n+function generateEntityProperties(parentPropertyName, entityName, entityTypeName) {\n+  const allProperties = [];\n+  const entityType = entityLib.findEntityTypeFromModelByEntityName(entityName, entityTypeName);\n+  if(!entityType) {\n+    return allProperties;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgxNzU5Ng==", "bodyText": "What's an example that requires the second part of this conditional to be present? I think the first part of the conditional would suffice?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436817596", "createdAt": "2020-06-08T15:59:38Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+// TODO Will move this to /data-hub/5/entities soon\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const DataHub = require(\"/data-hub/5/datahub.sjs\");\n+const datahub = new DataHub();\n+\n+\n+function addPropertiesToSearchResponse(entityName, searchResponse) {\n+  const maxDefaultProperties = 5;\n+  const allProperties = generateEntityProperties(\"\", entityName, entityName);\n+  const defaultProperties = allProperties.slice(0, maxDefaultProperties);\n+\n+  // Add entityProperties to each search result\n+  searchResponse.results.forEach(result => {\n+    let instance = {};\n+    try {\n+      instance = cts.doc(result.uri).toObject().envelope.instance;\n+    } catch (error) {\n+      datahub.debug.log({message: error, type: 'error'});\n+      return;\n+    }\n+\n+    const entityInstance = instance[entityName];\n+    result.entityProperties = [];\n+    defaultProperties.forEach(parentProperty => {\n+      result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n+    });\n+  });\n+\n+  // Make it easy for the client to know which property names were used, and which ones exist\n+  searchResponse.selectedPropertyDefinitions = defaultProperties;\n+  searchResponse.entityPropertyDefinitions = allProperties;\n+}\n+\n+function generateEntityProperties(parentPropertyName, entityName, entityTypeName) {\n+  const allProperties = [];\n+  const entityType = entityLib.findEntityTypeFromModelByEntityName(entityName, entityTypeName);\n+  if(!entityType) {\n+    return allProperties;\n+  }\n+\n+  for (var propertyName of Object.keys(entityType.properties)) {\n+    const property = entityType.properties[propertyName];\n+\n+    const isSimpleProperty = property.datatype != \"array\" && !property[\"$ref\"];\n+    const isSimpleArrayProperty = property.datatype == \"array\" && (property[\"items\"] && !property[\"items\"][\"$ref\"]);\n+    const isStructuredProperty = property.datatype != \"array\" && property[\"$ref\"];\n+    const isStructuredArrayProperty = property.datatype == \"array\" && (property[\"items\"] && property[\"items\"][\"$ref\"]);\n+\n+    const propertyMetadata = {};\n+    propertyMetadata[\"propertyPath\"] = parentPropertyName ? parentPropertyName + \".\" + propertyName : propertyName;\n+    propertyMetadata[\"propertyLabel\"] = propertyName;\n+    propertyMetadata[\"datatype\"] = (isSimpleProperty || isSimpleArrayProperty) ? (isSimpleProperty ? property.datatype : property[\"items\"][\"datatype\"]) : \"object\";\n+    propertyMetadata[\"multiple\"] = (isSimpleArrayProperty || isStructuredArrayProperty) ? true : false;\n+\n+    if(isStructuredProperty || isStructuredArrayProperty) {\n+      let referenceInfo = isStructuredProperty ? property[\"$ref\"].split(\"/\") : property[\"items\"][\"$ref\"].split(\"/\");\n+      entityTypeName =  referenceInfo.pop();\n+      entityName = referenceInfo[0] === \"#\" ? entityName : referenceInfo.pop().toString().split(\"-\")[0];\n+      propertyMetadata[\"properties\"] = generateEntityProperties(propertyMetadata[\"propertyPath\"], entityName, entityTypeName);\n+    }\n+    allProperties.push(propertyMetadata);\n+  }\n+  return allProperties;\n+}\n+\n+function getPropertyValues(currentProperty, entityInstance) {\n+  let resultObject = {};\n+  resultObject.propertyPath = currentProperty.propertyPath;\n+  if(currentProperty.datatype === \"object\") {\n+    resultObject.propertyValue = [];\n+\n+    let propertyName = currentProperty.propertyPath.split(\".\").pop();\n+    if(!entityInstance[propertyName] || Object.keys(entityInstance[propertyName]).length == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgyMTA2NQ==", "bodyText": "Hold off on this - I'm going to try writing these tests myself, just to get familiar with the code. I'll submit a PR into your PR.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#discussion_r436821065", "createdAt": "2020-06-08T16:04:39Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/entities/entity-search-lib.sjs", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+// TODO Will move this to /data-hub/5/entities soon\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const DataHub = require(\"/data-hub/5/datahub.sjs\");\n+const datahub = new DataHub();\n+\n+\n+function addPropertiesToSearchResponse(entityName, searchResponse) {\n+  const maxDefaultProperties = 5;\n+  const allProperties = generateEntityProperties(\"\", entityName, entityName);\n+  const defaultProperties = allProperties.slice(0, maxDefaultProperties);\n+\n+  // Add entityProperties to each search result\n+  searchResponse.results.forEach(result => {\n+    let instance = {};\n+    try {\n+      instance = cts.doc(result.uri).toObject().envelope.instance;\n+    } catch (error) {\n+      datahub.debug.log({message: error, type: 'error'});\n+      return;\n+    }\n+\n+    const entityInstance = instance[entityName];\n+    result.entityProperties = [];\n+    defaultProperties.forEach(parentProperty => {\n+      result.entityProperties.push(getPropertyValues(parentProperty, entityInstance));\n+    });\n+  });\n+\n+  // Make it easy for the client to know which property names were used, and which ones exist\n+  searchResponse.selectedPropertyDefinitions = defaultProperties;\n+  searchResponse.entityPropertyDefinitions = allProperties;\n+}\n+\n+function generateEntityProperties(parentPropertyName, entityName, entityTypeName) {\n+  const allProperties = [];\n+  const entityType = entityLib.findEntityTypeFromModelByEntityName(entityName, entityTypeName);\n+  if(!entityType) {\n+    return allProperties;\n+  }\n+\n+  for (var propertyName of Object.keys(entityType.properties)) {\n+    const property = entityType.properties[propertyName];\n+\n+    const isSimpleProperty = property.datatype != \"array\" && !property[\"$ref\"];\n+    const isSimpleArrayProperty = property.datatype == \"array\" && (property[\"items\"] && !property[\"items\"][\"$ref\"]);\n+    const isStructuredProperty = property.datatype != \"array\" && property[\"$ref\"];\n+    const isStructuredArrayProperty = property.datatype == \"array\" && (property[\"items\"] && property[\"items\"][\"$ref\"]);\n+\n+    const propertyMetadata = {};\n+    propertyMetadata[\"propertyPath\"] = parentPropertyName ? parentPropertyName + \".\" + propertyName : propertyName;\n+    propertyMetadata[\"propertyLabel\"] = propertyName;\n+    propertyMetadata[\"datatype\"] = (isSimpleProperty || isSimpleArrayProperty) ? (isSimpleProperty ? property.datatype : property[\"items\"][\"datatype\"]) : \"object\";\n+    propertyMetadata[\"multiple\"] = (isSimpleArrayProperty || isStructuredArrayProperty) ? true : false;\n+\n+    if(isStructuredProperty || isStructuredArrayProperty) {\n+      let referenceInfo = isStructuredProperty ? property[\"$ref\"].split(\"/\") : property[\"items\"][\"$ref\"].split(\"/\");\n+      entityTypeName =  referenceInfo.pop();\n+      entityName = referenceInfo[0] === \"#\" ? entityName : referenceInfo.pop().toString().split(\"-\")[0];", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwMDgyMQ=="}, "originalCommit": {"oid": "7d720d52b1b73dd88e41b6dc248d7ffd5a3e7332"}, "originalPosition": 75}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f767baddb850676818f2969f2bbc9247a673a632", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/f767baddb850676818f2969f2bbc9247a673a632", "committedDate": "2020-06-08T17:56:20Z", "message": "Merge pull request #1 from rjrudin/feature/5078-rjrudin-tests\n\nDHFPROD-5078: Adding tests for buildPropertyMetadata"}, "afterCommit": {"oid": "d1a3a3eb6414095bda8fcaa11fafa67ba493a160", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d1a3a3eb6414095bda8fcaa11fafa67ba493a160", "committedDate": "2020-06-08T17:58:31Z", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests\n\nDHFPROD-5078: Error handling for search transform and updating Customer input docs in reference-entity-model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDk2MDg2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#pullrequestreview-426496086", "createdAt": "2020-06-08T18:16:34Z", "commit": {"oid": "d1a3a3eb6414095bda8fcaa11fafa67ba493a160"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NTA3NTA2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#pullrequestreview-426507506", "createdAt": "2020-06-08T18:33:01Z", "commit": {"oid": "d1a3a3eb6414095bda8fcaa11fafa67ba493a160"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1a3a3eb6414095bda8fcaa11fafa67ba493a160", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/d1a3a3eb6414095bda8fcaa11fafa67ba493a160", "committedDate": "2020-06-08T17:58:31Z", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests\n\nDHFPROD-5078: Error handling for search transform and updating Customer input docs in reference-entity-model"}, "afterCommit": {"oid": "6935e16909f6d80c7981538318c3b32987ad2ed1", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6935e16909f6d80c7981538318c3b32987ad2ed1", "committedDate": "2020-06-08T21:28:31Z", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests\n\nDHFPROD-5078: Error handling for search transform and updating Customer input docs in reference-entity-model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjM3Njk1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#pullrequestreview-426637695", "createdAt": "2020-06-08T21:33:28Z", "commit": {"oid": "6935e16909f6d80c7981538318c3b32987ad2ed1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjM5MTc3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#pullrequestreview-426639177", "createdAt": "2020-06-08T21:35:59Z", "commit": {"oid": "6935e16909f6d80c7981538318c3b32987ad2ed1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjQzNDgz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#pullrequestreview-426643483", "createdAt": "2020-06-08T21:43:46Z", "commit": {"oid": "6935e16909f6d80c7981538318c3b32987ad2ed1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8743574e387161ee93519165a7da36fd92390764", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/8743574e387161ee93519165a7da36fd92390764", "committedDate": "2020-06-08T22:30:57Z", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests\n\nDHFPROD-5078: Error handling for search transform and updating Customer input docs in reference-entity-model\n\nMaking Address/Street into an array"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c22c59b9cec210036c78145087a95f74dc2d75b8", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c22c59b9cec210036c78145087a95f74dc2d75b8", "committedDate": "2020-06-08T22:29:43Z", "message": "Making Address/Street into an array"}, "afterCommit": {"oid": "8743574e387161ee93519165a7da36fd92390764", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/8743574e387161ee93519165a7da36fd92390764", "committedDate": "2020-06-08T22:30:57Z", "message": "DHFPROD-5078: Adding search transform for returning entity properties\n\nDHFPROD-5078: EntitySearch Transform Modules\n\nDHFPROD-5078: reference entity model changes\n\nDHFPROD-5078: Adding tests\n\nDHFPROD-5078: Error handling for search transform and updating Customer input docs in reference-entity-model\n\nMaking Address/Street into an array"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2Njc4MzIx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#pullrequestreview-426678321", "createdAt": "2020-06-08T23:00:24Z", "commit": {"oid": "8743574e387161ee93519165a7da36fd92390764"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2Njc4NzI2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#pullrequestreview-426678726", "createdAt": "2020-06-08T23:01:30Z", "commit": {"oid": "8743574e387161ee93519165a7da36fd92390764"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjkxODQ1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4059#pullrequestreview-426691845", "createdAt": "2020-06-08T23:37:11Z", "commit": {"oid": "8743574e387161ee93519165a7da36fd92390764"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2737, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}