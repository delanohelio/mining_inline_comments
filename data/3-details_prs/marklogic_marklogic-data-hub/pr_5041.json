{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzNzc4NjQ5", "number": 5041, "title": "DHFPROD-6149:Disable generation of TDE for entity models", "bodyText": "Description\nDisable generation of TDE for entity models\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Code passes ESLint tests\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-12-21T23:29:43Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041", "merged": true, "mergeCommit": {"oid": "309ef8b09d3fcb14b745a0a312b894d729431dfe"}, "closed": true, "closedAt": "2020-12-23T18:43:23Z", "author": {"login": "srinathgit"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdoq5NBAFqTU1NzA5MDgzOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdpDl3IAFqTU1ODE2ODA0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MDkwODM4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#pullrequestreview-557090838", "createdAt": "2020-12-22T13:48:34Z", "commit": {"oid": "382204eb5383f2aba0d7887b488228aa3f49a564"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMzo0ODozNFrOIJ7wzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMzo1MjozOVrOIJ74YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI4NzI0Ng==", "bodyText": "For readability, let's toss this into a function in the module - e.g. local:is-tde-generation-enabled($definitions, $entity-title) .\nBetter yet - let's put that function into hub-entities.xqy. You can write in-memory unit tests against that function, which makes it easier to test the scenario where there's not an entity definition whose name matches that of info/title (I don't think that's covered below?).\nIt's good to have a test against the trigger too, but I'd opt for one trivial test there, and then exhaustive tests against this function, as the latter will be faster and easier to understand.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#discussion_r547287246", "createdAt": "2020-12-22T13:48:34Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/4/triggers/entity-model-trigger.xqy", "diffHunk": "@@ -132,8 +132,15 @@ return (\n       }, map:entry(\"database\", xdmp:schema-database())\n     ),\n \n+  (: Check if TDE generation is disabled. Any value other than false or \"false\" disables TDE generation. :)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "382204eb5383f2aba0d7887b488228aa3f49a564"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI4NzYwNQ==", "bodyText": "An XQuery trick that I think works here is:\nlet $primary-type-def := ($definitions => map:get($entity-title), $definitions => map:get(map:keys($definitions)[1]))[1]\n\ni.e. return the first non-empty thing", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#discussion_r547287605", "createdAt": "2020-12-22T13:49:18Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/4/triggers/entity-model-trigger.xqy", "diffHunk": "@@ -132,8 +132,15 @@ return (\n       }, map:entry(\"database\", xdmp:schema-database())\n     ),\n \n+  (: Check if TDE generation is disabled. Any value other than false or \"false\" disables TDE generation. :)\n+  let $primary-type-def := $definitions => map:get($entity-title)\n+  let $primary-type-def := if (fn:exists($primary-type-def)) then $primary-type-def", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "382204eb5383f2aba0d7887b488228aa3f49a564"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI4OTE4NQ==", "bodyText": "Really need assertion messages here to explain why it's true or false for each one.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#discussion_r547289185", "createdAt": "2020-12-22T13:52:39Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/entities/testTdeGenerationDisabled.sjs", "diffHunk": "@@ -0,0 +1,35 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const test = require(\"/test/test-helper.xqy\");\n+\n+function checkForTde(uri){\n+  return fn.head(xdmp.eval(\n+    `fn.docAvailable('${uri}') `,\n+    {uri:uri}, {database: xdmp.schemaDatabase()}\n+  ));\n+}\n+\n+function verifyTdeGeneration() {\n+  return [\n+    test.assertTrue(checkForTde(\"/tde/Customer-0.0.1.tdex\")),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "382204eb5383f2aba0d7887b488228aa3f49a564"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "382204eb5383f2aba0d7887b488228aa3f49a564", "author": {"user": {"login": "crism", "name": "Chris Maden"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/382204eb5383f2aba0d7887b488228aa3f49a564", "committedDate": "2020-12-21T23:26:32Z", "message": "DHFPROD-6149:Disable generation of TDE for entity models"}, "afterCommit": {"oid": "48c12205c1a057cb27e61dc37efcd3df9c977053", "author": {"user": {"login": "crism", "name": "Chris Maden"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/48c12205c1a057cb27e61dc37efcd3df9c977053", "committedDate": "2020-12-22T18:34:52Z", "message": "DHFPROD-6149:Disable generation of TDE for entity models"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3Mjg4NjAy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#pullrequestreview-557288602", "createdAt": "2020-12-22T18:40:21Z", "commit": {"oid": "48c12205c1a057cb27e61dc37efcd3df9c977053"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MzAyNzYx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#pullrequestreview-557302761", "createdAt": "2020-12-22T19:06:22Z", "commit": {"oid": "48c12205c1a057cb27e61dc37efcd3df9c977053"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxOTowNjoyM1rOIKF7AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxOTowNjoyM1rOIKF7AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ1MzY5Nw==", "bodyText": "Hmm - if the code is simpler in XQuery to just support \"true\" and true, let's do that (I don't think I've ever used xdmp:type before, so this seems more complex than it should be).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#discussion_r547453697", "createdAt": "2020-12-22T19:06:23Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/hub-entities.xqy", "diffHunk": "@@ -83,6 +83,21 @@ declare function hent:uber-model($models as object-node()*) as map:map\n     $uber-model\n };\n \n+declare function hent:is-tde-generation-enabled($entity-def as object-node()) as xs:boolean\n+{\n+  let $entity-def-map as map:map := $entity-def\n+  let $definitions := $entity-def-map => map:get(\"definitions\")\n+  let $entity-title := $entity-def/info/title\n+  (: Check if TDE generation is enabled. Any value other than true enables TDE generation. :)\n+  let $primary-type-def := ($definitions => map:get($entity-title), $definitions => map:get(map:keys($definitions)[1]))[1]\n+  let $is-property-set := map:contains($primary-type-def, \"tdeGenerationDisabled\")\n+  let $property-val := map:get($primary-type-def, \"tdeGenerationDisabled\")\n+  let $is-property-type-boolean := $is-property-set and string(xdmp:type($property-val)) = \"boolean\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48c12205c1a057cb27e61dc37efcd3df9c977053"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48c12205c1a057cb27e61dc37efcd3df9c977053", "author": {"user": {"login": "crism", "name": "Chris Maden"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/48c12205c1a057cb27e61dc37efcd3df9c977053", "committedDate": "2020-12-22T18:34:52Z", "message": "DHFPROD-6149:Disable generation of TDE for entity models"}, "afterCommit": {"oid": "9d87825341850d698d94d91c22dd4ee876b3d109", "author": {"user": {"login": "crism", "name": "Chris Maden"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9d87825341850d698d94d91c22dd4ee876b3d109", "committedDate": "2020-12-22T19:48:37Z", "message": "DHFPROD-6149:Disable generation of TDE for entity models"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d87825341850d698d94d91c22dd4ee876b3d109", "author": {"user": {"login": "crism", "name": "Chris Maden"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9d87825341850d698d94d91c22dd4ee876b3d109", "committedDate": "2020-12-22T19:48:37Z", "message": "DHFPROD-6149:Disable generation of TDE for entity models"}, "afterCommit": {"oid": "ee4d1ec592e2540cfcb3b8a91c711f6131d14cd3", "author": {"user": {"login": "crism", "name": "Chris Maden"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/ee4d1ec592e2540cfcb3b8a91c711f6131d14cd3", "committedDate": "2020-12-22T19:52:19Z", "message": "DHFPROD-6149:Disable generation of TDE for entity models"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MzQwMzQ5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#pullrequestreview-557340349", "createdAt": "2020-12-22T20:12:05Z", "commit": {"oid": "ee4d1ec592e2540cfcb3b8a91c711f6131d14cd3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MzU2NjI5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#pullrequestreview-557356629", "createdAt": "2020-12-22T20:45:25Z", "commit": {"oid": "ee4d1ec592e2540cfcb3b8a91c711f6131d14cd3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee4d1ec592e2540cfcb3b8a91c711f6131d14cd3", "author": {"user": {"login": "crism", "name": "Chris Maden"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/ee4d1ec592e2540cfcb3b8a91c711f6131d14cd3", "committedDate": "2020-12-22T19:52:19Z", "message": "DHFPROD-6149:Disable generation of TDE for entity models"}, "afterCommit": {"oid": "e04ac6f14904915b897c77004d68bea6d2e4fbdf", "author": {"user": {"login": "crism", "name": "Chris Maden"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/e04ac6f14904915b897c77004d68bea6d2e4fbdf", "committedDate": "2020-12-22T22:41:59Z", "message": "DHFPROD-6149:Disable generation of TDE for entity models"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3NDc0Nzcz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#pullrequestreview-557474773", "createdAt": "2020-12-23T02:32:05Z", "commit": {"oid": "e04ac6f14904915b897c77004d68bea6d2e4fbdf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwMjozMjowNVrOIKPNlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwMjozMjowNVrOIKPNlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYwNTkwOQ==", "bodyText": "Sorry to be picky here, but until we need all these properties, let's make these entity defs as minimal as possible. We always want to do that in tests, as it makes the focus of test that much more clear.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#discussion_r547605909", "createdAt": "2020-12-23T02:32:05Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/entities/test-data/entities/Customer.entity.json", "diffHunk": "@@ -0,0 +1,86 @@\n+{\n+  \"info\": {\n+    \"title\": \"Customer\",\n+    \"version\": \"0.0.1\",\n+    \"baseUri\": \"http://example.org/\"\n+  },\n+  \"definitions\": {\n+    \"Customer\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e04ac6f14904915b897c77004d68bea6d2e4fbdf"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f52e6e22952864a192fd38e4f265c301e6cfefd8", "author": {"user": {"login": "crism", "name": "Chris Maden"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/f52e6e22952864a192fd38e4f265c301e6cfefd8", "committedDate": "2020-12-23T08:39:24Z", "message": "DHFPROD-6149:Disable generation of TDE for entity models"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e04ac6f14904915b897c77004d68bea6d2e4fbdf", "author": {"user": {"login": "crism", "name": "Chris Maden"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/e04ac6f14904915b897c77004d68bea6d2e4fbdf", "committedDate": "2020-12-22T22:41:59Z", "message": "DHFPROD-6149:Disable generation of TDE for entity models"}, "afterCommit": {"oid": "f52e6e22952864a192fd38e4f265c301e6cfefd8", "author": {"user": {"login": "crism", "name": "Chris Maden"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/f52e6e22952864a192fd38e4f265c301e6cfefd8", "committedDate": "2020-12-23T08:39:24Z", "message": "DHFPROD-6149:Disable generation of TDE for entity models"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3ODE0MTIz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#pullrequestreview-557814123", "createdAt": "2020-12-23T11:34:42Z", "commit": {"oid": "f52e6e22952864a192fd38e4f265c301e6cfefd8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MTY4MDQw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/5041#pullrequestreview-558168040", "createdAt": "2020-12-23T18:39:12Z", "commit": {"oid": "f52e6e22952864a192fd38e4f265c301e6cfefd8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1448, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}