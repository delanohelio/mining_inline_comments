{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2Nzg0OTEx", "number": 3936, "title": "DHFPROD-4945: New endpoints for flows and ingestion/mapping steps", "bodyText": "For reviewing/testing this locally - best thing to do is examine the new tests, both for HC and for the new DS endpoints. Running the HC tests verifies that we have nearly 100% coverage on the new controllers (the only thing not covered is a catch block for a JSON processing exception).\nLots of changes in here - these are the categories of changes:\n\nNew api/sjs files for the new flow/step DS endpoints\n3 new HC controllers for flows, ingestion steps, and mapping steps\nUpdates to our schemas and the classes generated from them\nLots of tests, including several new improvements to the test frameworks\n\nThe one thing I purposefully did not write a test for was running a referenced ingestion step, as we know that functionality is going to change soon so that it requires files to be uploaded when the step is run.\nDescription\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-05-12T15:02:46Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3936", "merged": true, "mergeCommit": {"oid": "2d12bf31de8ff7aede6dc657e73dc5e6a0b9e1e4"}, "closed": true, "closedAt": "2020-05-14T21:29:09Z", "author": {"login": "rjrudin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgofNYgFqTQxMDMwNzQ3Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABchULJ0AFqTQxMjE5MDUxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzA3NDc2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3936#pullrequestreview-410307476", "createdAt": "2020-05-12T18:21:57Z", "commit": {"oid": "381e873530c3e559143a1e5fc0bf938235501ef2"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "381e873530c3e559143a1e5fc0bf938235501ef2", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/381e873530c3e559143a1e5fc0bf938235501ef2", "committedDate": "2020-05-12T14:59:54Z", "message": "DHFPROD-4945: New endpoints for flows and ingestion/mapping steps\n\nLots of changes in here - these are the categories of changes:\n\n- New api/sjs files for the new flow/step DS endpoints\n- 3 new HC controllers for flows, ingestion steps, and mapping steps\n- Updates to our schemas and the classes generated from them\n- Lots of tests, including several new improvements to the test frameworks\n\nThe one thing I purposefully did not write a test for was running a referenced ingestion step, as we know that functionality is going to change soon so that it requires files to be uploaded when the step is run."}, "afterCommit": {"oid": "1c5944c4d1fcb559050118c0eace9d9b98b27479", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/1c5944c4d1fcb559050118c0eace9d9b98b27479", "committedDate": "2020-05-12T23:56:01Z", "message": "DHFPROD-4945: New endpoints for flows and ingestion/mapping steps\n\nLots of changes in here - these are the categories of changes:\n\n- New api/sjs files for the new flow/step DS endpoints\n- 3 new HC controllers for flows, ingestion steps, and mapping steps\n- Updates to our schemas and the classes generated from them\n- Lots of tests, including several new improvements to the test frameworks\n\nThe one thing I purposefully did not write a test for was running a referenced ingestion step, as we know that functionality is going to change soon so that it requires files to be uploaded when the step is run."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNjM0NzA1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3936#pullrequestreview-410634705", "createdAt": "2020-05-13T06:54:31Z", "commit": {"oid": "1c5944c4d1fcb559050118c0eace9d9b98b27479"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNjo1NDozMVrOGUjw-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNjo1NDozMVrOGUjw-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIxMDY4Mw==", "bodyText": "The default collections for ingestion step should be the step name (current behavior) and for mapping step, it's the step name and the entity name(explorer requires that ).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3936#discussion_r424210683", "createdAt": "2020-05-13T06:54:31Z", "author": {"login": "srinathgit"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/step/saveStep.sjs", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ Copyright (c) 2020 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const Artifacts = require('/data-hub/5/artifacts/core.sjs');\n+const Step = require(\"/data-hub/5/impl/step.sjs\");\n+const consts = require(\"/data-hub/5/impl/consts.sjs\");\n+\n+var stepDefinitionType;\n+var stepProperties;\n+\n+stepProperties = stepProperties.toObject();\n+const stepName = stepProperties.name;\n+\n+xdmp.trace(consts.TRACE_STEP, `Saving step with name ${stepName} and type ${stepDefinitionType}`);\n+\n+let existingStep = fn.head(cts.search(cts.andQuery([\n+  cts.collectionQuery(\"http://marklogic.com/data-hub/steps\"),\n+  cts.jsonPropertyValueQuery(\"stepDefinitionType\", stepDefinitionType, \"case-insensitive\"),\n+  cts.jsonPropertyValueQuery(\"name\", stepName)\n+])));\n+\n+if (existingStep) {\n+  xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType} already exists, so will update`);\n+  let updatedStep = Object.assign(existingStep.toObject(), stepProperties);\n+  Artifacts.setArtifact(stepDefinitionType, stepName, updatedStep);\n+} else {\n+  xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType}  does not exist, so will create`);\n+\n+  // For now, can assume the stepDefinitionName based on the type. Can add stepDefinitionType as a parameter once we need\n+  // more flexibility.\n+  const stepDefinitionName = \"mapping\" === stepDefinitionType.toLowerCase() ? \"entity-services-mapping\" : \"default-ingestion\";\n+\n+  stepProperties.stepDefinitionName = stepDefinitionName;\n+  stepProperties.stepDefinitionType = stepDefinitionType;\n+  stepProperties.stepId = stepName + \"-\" + stepDefinitionType;\n+\n+  const stepDef = new Step().getStepByNameAndType(stepDefinitionName, stepDefinitionType);\n+  const stepDefOptions = stepDef.options;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c5944c4d1fcb559050118c0eace9d9b98b27479"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c5944c4d1fcb559050118c0eace9d9b98b27479", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/1c5944c4d1fcb559050118c0eace9d9b98b27479", "committedDate": "2020-05-12T23:56:01Z", "message": "DHFPROD-4945: New endpoints for flows and ingestion/mapping steps\n\nLots of changes in here - these are the categories of changes:\n\n- New api/sjs files for the new flow/step DS endpoints\n- 3 new HC controllers for flows, ingestion steps, and mapping steps\n- Updates to our schemas and the classes generated from them\n- Lots of tests, including several new improvements to the test frameworks\n\nThe one thing I purposefully did not write a test for was running a referenced ingestion step, as we know that functionality is going to change soon so that it requires files to be uploaded when the step is run."}, "afterCommit": {"oid": "dce219ee89c670769219aab21ee3b7e7bf680880", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/dce219ee89c670769219aab21ee3b7e7bf680880", "committedDate": "2020-05-13T13:08:31Z", "message": "DHFPROD-4945: New endpoints for flows and ingestion/mapping steps\n\nLots of changes in here - these are the categories of changes:\n\n- New api/sjs files for the new flow/step DS endpoints\n- 3 new HC controllers for flows, ingestion steps, and mapping steps\n- Updates to our schemas and the classes generated from them\n- Lots of tests, including several new improvements to the test frameworks\n\nThe one thing I purposefully did not write a test for was running a referenced ingestion step, as we know that functionality is going to change soon so that it requires files to be uploaded when the step is run."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ac47d282ad15276074a028d9ff088c245606d66", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/0ac47d282ad15276074a028d9ff088c245606d66", "committedDate": "2020-05-13T13:16:38Z", "message": "DHFPROD-4945: New endpoints for flows and ingestion/mapping steps\n\nLots of changes in here - these are the categories of changes:\n\n- New api/sjs files for the new flow/step DS endpoints\n- 3 new HC controllers for flows, ingestion steps, and mapping steps\n- Updates to our schemas and the classes generated from them\n- Lots of tests, including several new improvements to the test frameworks\n\nThe one thing I purposefully did not write a test for was running a referenced ingestion step, as we know that functionality is going to change soon so that it requires files to be uploaded when the step is run."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dce219ee89c670769219aab21ee3b7e7bf680880", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/dce219ee89c670769219aab21ee3b7e7bf680880", "committedDate": "2020-05-13T13:08:31Z", "message": "DHFPROD-4945: New endpoints for flows and ingestion/mapping steps\n\nLots of changes in here - these are the categories of changes:\n\n- New api/sjs files for the new flow/step DS endpoints\n- 3 new HC controllers for flows, ingestion steps, and mapping steps\n- Updates to our schemas and the classes generated from them\n- Lots of tests, including several new improvements to the test frameworks\n\nThe one thing I purposefully did not write a test for was running a referenced ingestion step, as we know that functionality is going to change soon so that it requires files to be uploaded when the step is run."}, "afterCommit": {"oid": "0ac47d282ad15276074a028d9ff088c245606d66", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/0ac47d282ad15276074a028d9ff088c245606d66", "committedDate": "2020-05-13T13:16:38Z", "message": "DHFPROD-4945: New endpoints for flows and ingestion/mapping steps\n\nLots of changes in here - these are the categories of changes:\n\n- New api/sjs files for the new flow/step DS endpoints\n- 3 new HC controllers for flows, ingestion steps, and mapping steps\n- Updates to our schemas and the classes generated from them\n- Lots of tests, including several new improvements to the test frameworks\n\nThe one thing I purposefully did not write a test for was running a referenced ingestion step, as we know that functionality is going to change soon so that it requires files to be uploaded when the step is run."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTAwOTg2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3936#pullrequestreview-411100986", "createdAt": "2020-05-13T16:32:21Z", "commit": {"oid": "0ac47d282ad15276074a028d9ff088c245606d66"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTkwNTE1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3936#pullrequestreview-412190515", "createdAt": "2020-05-14T21:15:52Z", "commit": {"oid": "0ac47d282ad15276074a028d9ff088c245606d66"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2886, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}