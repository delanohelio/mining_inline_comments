{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyMjA4Mzcx", "number": 4537, "title": "DHFPROD-5811: Hopefully fixing how schemas dbs are cleared in tests", "bodyText": "Description\nThe use of newAppServicesDatabaseClient is failing intermittently. Since we don't need to retain any documents, we can use the Manage API to clear the database.\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-09-08T17:59:46Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537", "merged": true, "mergeCommit": {"oid": "8c0db68b43cc05a2b882b175b7d73113a36648f6"}, "closed": true, "closedAt": "2020-09-09T22:17:25Z", "author": {"login": "rjrudin"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdG-vfXAFqTQ4NDUxNDcxNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHS0WzgFqTQ4NTQwNjAzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTE0NzE1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537#pullrequestreview-484514715", "createdAt": "2020-09-08T21:46:46Z", "commit": {"oid": "01a719f2095ea4bb613df72e496927b8f0dc1932"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NjU4Mzk4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537#pullrequestreview-484658398", "createdAt": "2020-09-09T04:49:54Z", "commit": {"oid": "01a719f2095ea4bb613df72e496927b8f0dc1932"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01a719f2095ea4bb613df72e496927b8f0dc1932", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/01a719f2095ea4bb613df72e496927b8f0dc1932", "committedDate": "2020-09-08T17:46:42Z", "message": "DHFPROD-5811: Hopefully fixing how schemas dbs are cleared in tests\n\nThe use of newAppServicesDatabaseClient is failing intermittently. Since we don't need to retain any documents, we can use the Manage API to clear the database."}, "afterCommit": {"oid": "12725ced42f6b3c87a781f6900990d6c4c46dbbc", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/12725ced42f6b3c87a781f6900990d6c4c46dbbc", "committedDate": "2020-09-09T12:29:45Z", "message": "DHFPROD-5811: Fixing failing tests\n\nThe use of newAppServicesDatabaseClient is failing intermittently. Since we don't need to retain any documents, we can use the Manage API to clear the database. \n\nModified DeployUserAmpsTest to only run if nightly build has major version of 10. Also added a little unit test to verify that \"major\" is set if it's a nightly build."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MTA2MjYy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537#pullrequestreview-485106262", "createdAt": "2020-09-09T15:03:53Z", "commit": {"oid": "12725ced42f6b3c87a781f6900990d6c4c46dbbc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MTMzMjM3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537#pullrequestreview-485133237", "createdAt": "2020-09-09T15:31:36Z", "commit": {"oid": "12725ced42f6b3c87a781f6900990d6c4c46dbbc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711", "committedDate": "2020-09-09T19:37:17Z", "message": "DHFPROD-5811: Fixing failing tests\n\nThe use of newAppServicesDatabaseClient is failing intermittently. Since we don't need to retain any documents, we can use the Manage API to clear the database. \n\nAlso added some primitive retry support for resetDatabases. \n\nModified DeployUserAmpsTest to only run if nightly build has major version of 10. Also added a little unit test to verify that \"major\" is set if it's a nightly build."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12725ced42f6b3c87a781f6900990d6c4c46dbbc", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/12725ced42f6b3c87a781f6900990d6c4c46dbbc", "committedDate": "2020-09-09T12:29:45Z", "message": "DHFPROD-5811: Fixing failing tests\n\nThe use of newAppServicesDatabaseClient is failing intermittently. Since we don't need to retain any documents, we can use the Manage API to clear the database. \n\nModified DeployUserAmpsTest to only run if nightly build has major version of 10. Also added a little unit test to verify that \"major\" is set if it's a nightly build."}, "afterCommit": {"oid": "7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711", "committedDate": "2020-09-09T19:37:17Z", "message": "DHFPROD-5811: Fixing failing tests\n\nThe use of newAppServicesDatabaseClient is failing intermittently. Since we don't need to retain any documents, we can use the Manage API to clear the database. \n\nAlso added some primitive retry support for resetDatabases. \n\nModified DeployUserAmpsTest to only run if nightly build has major version of 10. Also added a little unit test to verify that \"major\" is set if it's a nightly build."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MzgxOTc2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537#pullrequestreview-485381976", "createdAt": "2020-09-09T20:32:46Z", "commit": {"oid": "7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MzgzNzc4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537#pullrequestreview-485383778", "createdAt": "2020-09-09T20:35:24Z", "commit": {"oid": "7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDozNToyNFrOHPZX3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDozNToyNFrOHPZX3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNjM5Ng==", "bodyText": "Should we create our own no-arg/no-return functional interface to avoid confusion related to Runnable being related to threads?\nhttps://stackoverflow.com/a/23958916/4460877", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537#discussion_r485906396", "createdAt": "2020-09-09T20:35:24Z", "author": {"login": "akshaysonvane"}, "path": "marklogic-data-hub/src/testFixtures/java/com/marklogic/hub/test/AbstractHubTest.java", "diffHunk": "@@ -100,15 +104,41 @@ protected void resetDatabases() {\n         runAsAdmin();\n         String xquery = \"cts:uris((), (), cts:not-query(cts:collection-query('hub-core-artifact'))) ! xdmp:document-delete(.)\";\n         HubClient hubClient = getHubClient();\n-        hubClient.getStagingClient().newServerEval().xquery(xquery).evalAs(String.class);\n-        hubClient.getFinalClient().newServerEval().xquery(xquery).evalAs(String.class);\n-        hubClient.getJobsClient().newServerEval().xquery(xquery).evalAs(String.class);\n-\n-        HubConfig hubConfig = getHubConfig();\n-        hubConfig.getAppConfig().newAppServicesDatabaseClient(hubConfig.getDbName(DatabaseKind.STAGING_SCHEMAS))\n-            .newServerEval().xquery(xquery).evalAs(String.class);\n-        hubConfig.getAppConfig().newAppServicesDatabaseClient(hubConfig.getDbName(DatabaseKind.FINAL_SCHEMAS))\n-            .newServerEval().xquery(xquery).evalAs(String.class);\n+        // Running these with primitive retry support, as if a connection cannot be made to ML, this is typically the\n+        // first thing that will fail\n+        retryIfNecessary(() -> hubClient.getStagingClient().newServerEval().xquery(xquery).evalAs(String.class));\n+        retryIfNecessary(() -> hubClient.getFinalClient().newServerEval().xquery(xquery).evalAs(String.class));\n+        retryIfNecessary(() -> hubClient.getJobsClient().newServerEval().xquery(xquery).evalAs(String.class));\n+\n+        DatabaseManager databaseManager = new DatabaseManager(hubClient.getManageClient());\n+        databaseManager.clearDatabase(hubClient.getDbName(DatabaseKind.STAGING_SCHEMAS));\n+        databaseManager.clearDatabase(hubClient.getDbName(DatabaseKind.FINAL_SCHEMAS));\n+    }\n+\n+    /**\n+     * Adding this to handle some intermittent connection failures that occur when Jenkins runs the tests.\n+     * @param r\n+     */\n+    protected void retryIfNecessary(Runnable r) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDA2MDM2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537#pullrequestreview-485406036", "createdAt": "2020-09-09T21:10:11Z", "commit": {"oid": "7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2008, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}