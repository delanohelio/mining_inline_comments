{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0Mjk2NDMx", "number": 4810, "title": "DHFPROD-6168:Ensure we can get latest job details if a step is added more than once to a flow", "bodyText": "Description\nEnsure we can get latest job details if a step is added more than once to a flow\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-11-02T20:23:47Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810", "merged": true, "mergeCommit": {"oid": "e593f94340dca4076e52205951cc93dbb0af9f78"}, "closed": true, "closedAt": "2020-11-04T00:32:26Z", "author": {"login": "srinathgit"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYsTfoAFqTUyMjA2NjU4Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY__ABgFqTUyMjg4NDcxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMDY2NTg3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#pullrequestreview-522066587", "createdAt": "2020-11-02T22:27:24Z", "commit": {"oid": "b5eaeb1d92ce83d4b04cb6443da0f19248e918ed"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMjoyNzoyNFrOHsYBKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMjoyODoxOVrOHsYCsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5MjkwNw==", "bodyText": "Oof this is brittle - a word search on an unstructured string. Also, the step number can change over time - e.g. a user can move steps around in the flow. I'm really reluctant to base anything on step number for this reason.\nIn fact, this seems like it could break for steps that aren't in a flow twice. For example, let's say my ABC mapping step is step 2, and I run it. Then I change my flow and make it step 3. Then I run this query - I no longer get anything back for my ABC step. Right?\nBecause of the rarity of a step being in a flow twice (we shouldn't prohibit it, because we have no reason to do that, and there may be a valid reason to do it), I think we should just take the latest document and then say - see if there's a stepRunResponse with the same stepNumber and stepName as the given step. If so, use it. If not, then check for a stepRunResponse with the same stepName. If there's 1 or more, use the latest one.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#discussion_r516292907", "createdAt": "2020-11-02T22:27:24Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/flow/getFlowWithLatestJobInfo.sjs", "diffHunk": "@@ -30,13 +30,19 @@ fn.head(datahub.hubUtils.queryLatest(function() {\n     jobQueries.push(cts.collectionQuery('Job'));\n     jobQueries.push(cts.jsonPropertyValueQuery(\"flow\",flowWithStepDetails.name));\n     jobQueries.push(cts.jsonPropertyValueQuery(\"stepName\",step.stepName));\n+    //A flow may contain same step more then once. 'status' in step response always contains step number", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5eaeb1d92ce83d4b04cb6443da0f19248e918ed"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5MzI5OA==", "bodyText": "For testing, don't you need a job document that has at least two step responses - one for each occurrence of the step in the flow?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#discussion_r516293298", "createdAt": "2020-11-02T22:28:19Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/flow/test-data/jobs/job3.json", "diffHunk": "@@ -0,0 +1,32 @@\n+{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5eaeb1d92ce83d4b04cb6443da0f19248e918ed"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2acd21a41ca6f8a84088bda07476af27e8c716fb", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/2acd21a41ca6f8a84088bda07476af27e8c716fb", "committedDate": "2020-11-03T19:43:29Z", "message": "DHFPROD-6168:Ensure we can get latest job details if a step is added more than once to a flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5eaeb1d92ce83d4b04cb6443da0f19248e918ed", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b5eaeb1d92ce83d4b04cb6443da0f19248e918ed", "committedDate": "2020-11-02T20:21:53Z", "message": "DHFPROD-6168:Ensure we can get latest job details if a step is added more than once to a flow"}, "afterCommit": {"oid": "2acd21a41ca6f8a84088bda07476af27e8c716fb", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/2acd21a41ca6f8a84088bda07476af27e8c716fb", "committedDate": "2020-11-03T19:43:29Z", "message": "DHFPROD-6168:Ensure we can get latest job details if a step is added more than once to a flow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyODQ0NjUz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#pullrequestreview-522844653", "createdAt": "2020-11-03T20:18:36Z", "commit": {"oid": "2acd21a41ca6f8a84088bda07476af27e8c716fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyODg0NzE4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4810#pullrequestreview-522884718", "createdAt": "2020-11-03T21:24:15Z", "commit": {"oid": "2acd21a41ca6f8a84088bda07476af27e8c716fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1590, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}