{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5MzAzNTY1", "number": 4916, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDozODoyM1rOE-rsSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjoxMzoyMlrOFAVa9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MTYzMDE3OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDozODoyM1rOH79_IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDozODoyM1rOH79_IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0MzYxNw==", "bodyText": "I don't think most of these should be class fields, which complicates the class. See next note below.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r532643617", "createdAt": "2020-11-30T14:38:23Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "diffHunk": "@@ -29,6 +33,11 @@\n     private final Map<String, String> options;\n     private final JsonNode initializationResponse;\n     private final StructType sparkSchema;\n+    private final HubClient hubClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2af72bf64782998315b17456152959b3272b7f0"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MTYzODY5OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo0MDowMFrOH7-EAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo0MDowMFrOH7-EAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0NDg2NQ==", "bodyText": "I think this is all work to be done in initializeRead, which is already instantiating a HubClient. That can become a local variable in initializeRead, which can then say - if you've specified an initializereadapipath option, then I'll read that using the HubClient and pass it in as the second arg to the SparkService.on call.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r532644865", "createdAt": "2020-11-30T14:40:00Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "diffHunk": "@@ -41,7 +50,12 @@ public HubDataSourceReader(DataSourceOptions dataSourceOptions) {\n \n         this.options = dataSourceOptions.asMap();\n         validateOptions(this.options);\n+        this.hubClientConfig = Util.buildHubClientConfig(options);\n+        this.hubClient = HubClient.withHubClientConfig(hubClientConfig);\n+        this.objectMapper = new ObjectMapper();\n+        this.customReadApiDefinitions = readCustomJobApiDefinitions(options);\n \n+        this.endpointParams = determineReadRecordsEndpointParams(options);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2af72bf64782998315b17456152959b3272b7f0"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MTY1NjMxOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo0Mzo0MlrOH7-O8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo0Mzo0MlrOH7-O8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0NzY2Ng==", "bodyText": "Because there's only one API endpoint, there's no need for a CustomReadApiDefinition class. CustomWriteApiDefinitions was created as a holder for two API definitions. We don't have that need here, so this method should just return a single InputStreamHandle.\nAlso, should name this method \"readCustomInitializeApiDefinition\" - \"Job\" is not an appropriate name here.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r532647666", "createdAt": "2020-11-30T14:43:42Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "diffHunk": "@@ -126,6 +145,20 @@ private int determineNumPartitions(Map<String, String> options) {\n         return numPartitions;\n     }\n \n+    private CustomReadApiDefinitions readCustomJobApiDefinitions(Map<String, String> options) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2af72bf64782998315b17456152959b3272b7f0"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MTY1Nzg4OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo0NDowMlrOH7-P8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo0NDowMlrOH7-P8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0NzkyMA==", "bodyText": "Should name this \"ReadRows\" instead of \"ReadRecords\" for consistency.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r532647920", "createdAt": "2020-11-30T14:44:02Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "diffHunk": "@@ -141,5 +174,49 @@ private int determineNumPartitions(Map<String, String> options) {\n     public StructType readSchema() {\n         return sparkSchema;\n     }\n+\n+    private JsonNode determineReadRecordsEndpointParams(Map<String, String> options) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2af72bf64782998315b17456152959b3272b7f0"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MTY3MjI4OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo0Njo1N1rOH7-YpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo0Njo1N1rOH7-YpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1MDE0OQ==", "bodyText": "Let's give the same context as the error message above this, and I think some guidance is useful here - e.g. \"Cannot set endpointConstants in readrowsendpointparams option; can only set apiPath and endpointState\".", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r532650149", "createdAt": "2020-11-30T14:46:57Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "diffHunk": "@@ -141,5 +174,49 @@ private int determineNumPartitions(Map<String, String> options) {\n     public StructType readSchema() {\n         return sparkSchema;\n     }\n+\n+    private JsonNode determineReadRecordsEndpointParams(Map<String, String> options) {\n+        ObjectNode endpointParams;\n+        if (options.containsKey(\"readrowsendpointparams\")) {\n+            try {\n+                endpointParams = (ObjectNode) objectMapper.readTree(options.get(\"readrowsendpointparams\"));\n+            } catch (IOException e) {\n+                throw new IllegalArgumentException(\"Unable to parse readrowsendpointparams, cause: \" + e.getMessage(), e);\n+            }\n+        } else {\n+            endpointParams = objectMapper.createObjectNode();\n+        }\n+\n+        boolean doesNotHaveApiPath = (!endpointParams.hasNonNull(\"apiPath\") || StringUtils.isEmpty(endpointParams.get(\"apiPath\").asText()));\n+        boolean hasEndpointConstants = endpointParams.hasNonNull(\"endpointConstants\") && !StringUtils.isEmpty(endpointParams.get(\"endpointConstants\").asText());\n+        boolean hasEndpointState = endpointParams.hasNonNull(\"endpointState\") && !StringUtils.isEmpty(endpointParams.get(\"endpointState\").asText());\n+        if (doesNotHaveApiPath && hasEndpointState) {\n+            throw new IllegalArgumentException(\"Cannot set endpointState in readrowsendpointparams unless apiPath is defined as well.\");\n+        }\n+        if(hasEndpointConstants)\n+            throw new IllegalArgumentException(\"Cannot override endpointConstants.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2af72bf64782998315b17456152959b3272b7f0"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MTY3NzM5OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo0Nzo1NlrOH7-brA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo0Nzo1NlrOH7-brA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1MDkyNA==", "bodyText": "Good error here, but add \"option\" after \"readrowsendpointparams\" to give it a little more context", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r532650924", "createdAt": "2020-11-30T14:47:56Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "diffHunk": "@@ -141,5 +174,49 @@ private int determineNumPartitions(Map<String, String> options) {\n     public StructType readSchema() {\n         return sparkSchema;\n     }\n+\n+    private JsonNode determineReadRecordsEndpointParams(Map<String, String> options) {\n+        ObjectNode endpointParams;\n+        if (options.containsKey(\"readrowsendpointparams\")) {\n+            try {\n+                endpointParams = (ObjectNode) objectMapper.readTree(options.get(\"readrowsendpointparams\"));\n+            } catch (IOException e) {\n+                throw new IllegalArgumentException(\"Unable to parse readrowsendpointparams, cause: \" + e.getMessage(), e);\n+            }\n+        } else {\n+            endpointParams = objectMapper.createObjectNode();\n+        }\n+\n+        boolean doesNotHaveApiPath = (!endpointParams.hasNonNull(\"apiPath\") || StringUtils.isEmpty(endpointParams.get(\"apiPath\").asText()));\n+        boolean hasEndpointConstants = endpointParams.hasNonNull(\"endpointConstants\") && !StringUtils.isEmpty(endpointParams.get(\"endpointConstants\").asText());\n+        boolean hasEndpointState = endpointParams.hasNonNull(\"endpointState\") && !StringUtils.isEmpty(endpointParams.get(\"endpointState\").asText());\n+        if (doesNotHaveApiPath && hasEndpointState) {\n+            throw new IllegalArgumentException(\"Cannot set endpointState in readrowsendpointparams unless apiPath is defined as well.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2af72bf64782998315b17456152959b3272b7f0"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MTY5NjA5OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/Options.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo1MTo0OFrOH7-nRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo1MTo0OFrOH7-nRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1Mzg5Mw==", "bodyText": "\"readRowsEndpointParams\" should be here as well, and it needs to be tested too. A good way to test that, along with the custom initialize endpoint, is the following:\n\nDon't load any customers, nor the TDE\nHave the initialize endpoint return a single static partition, regardless of what the other inputs are\nHave the initialize endpoint return a static Spark schema as well, regardless of what the other inputs are\nFor readrowsendpointparams/endpointState, define a single JSON row that can be returned by the readRows endpoint\nThen have the readRows endpoint return whatever value is in endpointState (it'll also need to use something in the endpointState object to know whether it's been called, since you only want to call it once)\n\nThat will allow you to verify that both your custom initialize and read endpoints are being used.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r532653893", "createdAt": "2020-11-30T14:51:48Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/Options.java", "diffHunk": "@@ -27,6 +27,7 @@\n     private String initializeWriteApiPath;\n     private String finalizeWriteApiPath;\n     private JsonNode additionalExternalMetadata;\n+    private String initializeReadApiPath;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2af72bf64782998315b17456152959b3272b7f0"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MTY5NzgzOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/reader/ReadDataWithCustomEndpointsTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo1MjoxM1rOH7-ocA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo1MjoxM1rOH7-ocA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1NDE5Mg==", "bodyText": "Replace \"Job\" with \"Read\"", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r532654192", "createdAt": "2020-11-30T14:52:13Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/reader/ReadDataWithCustomEndpointsTest.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.marklogic.hub.spark.sql.sources.v2.reader;\n+\n+import com.marklogic.client.document.GenericDocumentManager;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.Format;\n+import com.marklogic.client.io.InputStreamHandle;\n+import com.marklogic.hub.spark.sql.sources.v2.Options;\n+import org.apache.spark.sql.types.StructType;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+\n+public class ReadDataWithCustomEndpointsTest extends AbstractSparkReadTest {\n+\n+    @BeforeEach\n+    void installCustomJobEndpoints() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2af72bf64782998315b17456152959b3272b7f0"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MTY5OTY0OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/reader/ReadDataWithCustomEndpointsTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo1MjozM1rOH7-pjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo1MjozM1rOH7-pjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1NDQ3OQ==", "bodyText": "Let's put these in a folder called \"/custom-read-endpoints\" so it's clear that they're for testing the read endpoint.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r532654479", "createdAt": "2020-11-30T14:52:33Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/reader/ReadDataWithCustomEndpointsTest.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.marklogic.hub.spark.sql.sources.v2.reader;\n+\n+import com.marklogic.client.document.GenericDocumentManager;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.Format;\n+import com.marklogic.client.io.InputStreamHandle;\n+import com.marklogic.hub.spark.sql.sources.v2.Options;\n+import org.apache.spark.sql.types.StructType;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+\n+public class ReadDataWithCustomEndpointsTest extends AbstractSparkReadTest {\n+\n+    @BeforeEach\n+    void installCustomJobEndpoints() {\n+        GenericDocumentManager mgr = getHubClient().getModulesClient().newDocumentManager();\n+        DocumentMetadataHandle metadata = new DocumentMetadataHandle()\n+            .withPermission(\"data-hub-operator\", DocumentMetadataHandle.Capability.READ, DocumentMetadataHandle.Capability.UPDATE, DocumentMetadataHandle.Capability.EXECUTE);\n+\n+        String apiPath = \"/custom-job-endpoints/initializeRead.api\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2af72bf64782998315b17456152959b3272b7f0"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MTcwNDAwOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/test/resources/custom-job-endpoints/initializeRead.sjs", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo1MzozMFrOH7-sZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo1MzozMFrOH7-sZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1NTIwNQ==", "bodyText": "See my note above for testing - this should return a static schema and partition object. I believe parameterizedPlan can be \"{}\" because your custom read endpoint won't use it.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r532655205", "createdAt": "2020-11-30T14:53:30Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/resources/custom-job-endpoints/initializeRead.sjs", "diffHunk": "@@ -0,0 +1,121 @@\n+/**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2af72bf64782998315b17456152959b3272b7f0"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0ODMxNzcyOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/reader/ReadDataWithCustomEndpointsTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDowOToyOVrOH893fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDowOToyOVrOH893fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MDIzNw==", "bodyText": "This test isn't verifying that the customReadRows.api endpoint is being used, because it's asserting that rows is empty. Rows is empty because no customers have been loaded.\nThe test class I added - ReadWithCustomEndpointsTest - is failing because HubInputPartitionReader needs to look at the options to determine if it should use a custom API path or not. That test should suffice too for the happy path (you'll still want test methods for when endpointState is provided by not apiPath, and also for when endpointConstants is erroneously provided; I recommend moving both of those into ReadWithCustomEndpointsTest).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r533690237", "createdAt": "2020-12-01T20:09:29Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/reader/ReadDataWithCustomEndpointsTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.marklogic.hub.spark.sql.sources.v2.reader;\n+\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.spark.sql.sources.v2.Options;\n+import org.apache.spark.sql.catalyst.InternalRow;\n+import org.apache.spark.sql.types.StructType;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class ReadDataWithCustomEndpointsTest extends AbstractSparkReadTest {\n+\n+    @BeforeEach\n+    void setUp() {\n+        installCustomEndpoint(\"custom-read-endpoints/initializeRead.api\", \"custom-read-endpoints/initializeRead.sjs\");\n+        installCustomEndpoint(\"custom-read-endpoints/customReadRows.api\", \"custom-read-endpoints/customReadRows.sjs\");\n+    }\n+\n+    @Test\n+    public void testCustomSchema() {\n+        setupCustomers();\n+        Options options = newOptions().withView(\"Customer\")\n+            .withInitializeReadApiPath(\"/custom-read-endpoints/initializeRead.api\");\n+        HubDataSourceReader dataSourceReader = new HubDataSourceReader(options.toDataSourceOptions());\n+        StructType testStructType = dataSourceReader.readSchema();\n+\n+        assertTrue(testStructType.toList().length() == 2, \"Custom schema not as expected.\");\n+        for(int i=0; i<testStructType.toList().length(); i++) {\n+            String name = testStructType.toList().apply(0).name();\n+            assertTrue(name.equals(\"myName\") || name.equals(\"myId\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testHasEndpointStateWithoutApiPath() {\n+        setupCustomers();\n+        ObjectNode readrowsendpointparams = objectMapper.createObjectNode();\n+        readrowsendpointparams.put(\"endpointState\", \"testValue\");\n+        Options options = newOptions().withView(\"Customer\").withReadRowsEndpointparams(readrowsendpointparams);\n+        IllegalArgumentException ex = assertThrows(IllegalArgumentException.class,\n+            () -> new HubDataSourceReader(options.toDataSourceOptions()));\n+        assertEquals(\"Cannot set endpointState in readrowsendpointparams option unless apiPath is defined as well.\",\n+            ex.getMessage());\n+    }\n+\n+    @Test\n+    public void testHasEndpointConstants() {\n+        setupCustomers();\n+        ObjectNode readrowsendpointparams = objectMapper.createObjectNode();\n+        readrowsendpointparams.put(\"endpointConstants\", \"testValue\");\n+        Options options = newOptions().withView(\"Customer\").withReadRowsEndpointparams(readrowsendpointparams);\n+        IllegalArgumentException ex = assertThrows(IllegalArgumentException.class,\n+            () -> new HubDataSourceReader(options.toDataSourceOptions()));\n+        assertEquals(\"Cannot set endpointConstants in readrowsendpointparams option; can only set apiPath and endpointState.\",\n+            ex.getMessage());\n+    }\n+\n+    @Test\n+    public void testReadRowsEndpointparams() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3abd77b345a84efab105e403c0c2eb21c4165c96"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0ODMxOTQ1OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/reader/ReadWithCustomEndpointsTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDowOTo1MVrOH894eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDowOTo1MVrOH894eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MDQ4OA==", "bodyText": "Once HubInputPartitionReader is updated to use the custom endpoint, this test should pass.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r533690488", "createdAt": "2020-12-01T20:09:51Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/reader/ReadWithCustomEndpointsTest.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.marklogic.hub.spark.sql.sources.v2.reader;\n+\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.spark.sql.sources.v2.Options;\n+import org.apache.spark.sql.catalyst.InternalRow;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class ReadWithCustomEndpointsTest extends AbstractSparkReadTest {\n+\n+    @BeforeEach\n+    void setup() {\n+        installCustomEndpoint(\"custom-read-endpoints/initializeRead.api\", \"custom-read-endpoints/initializeRead.sjs\");\n+        installCustomEndpoint(\"custom-read-endpoints/customReadRows.api\", \"custom-read-endpoints/customReadRows.sjs\");\n+    }\n+\n+    @Test\n+    void test() {\n+        ObjectNode endpointState = objectMapper.createObjectNode();\n+        ObjectNode testRow = endpointState.putObject(\"testRow\");\n+        testRow.put(\"myId\", \"12345\");\n+        testRow.put(\"myName\", \"This is a test row\");\n+\n+        Options options = newOptions().withView(\"doesnt-matter\")\n+            .withInitializeReadApiPath(\"/custom-read-endpoints/initializeRead.api\")\n+            .withReadRowsApiPath(\"/custom-read-endpoints/customReadRows.api\")\n+            .withReadRowsEndpointState(endpointState);\n+\n+        List<InternalRow> rows = readRows(new HubDataSourceReader(options.toDataSourceOptions()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3abd77b345a84efab105e403c0c2eb21c4165c96"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0ODMyMDg5OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/marklogic-data-hub-spark-connector/readRows.sjs", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDoxMDoxNFrOH895VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDoxMDoxNFrOH895VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MDcwOQ==", "bodyText": "Can you remove this line of logging? I may have accidentally included it in the PR I submitted.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r533690709", "createdAt": "2020-12-01T20:10:14Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/marklogic-data-hub-spark-connector/readRows.sjs", "diffHunk": "@@ -27,4 +42,6 @@ if (endpointState.batchNumber <= partition.batchCount) {\n   endpointState.batchNumber = endpointState.batchNumber + 1;\n }\n \n+console.log(\"results\", xdmp.toJsonString(results));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3abd77b345a84efab105e403c0c2eb21c4165c96"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0ODMyMjI3OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/marklogic-data-hub-spark-connector/initializeRead.sjs", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDoxMDozNlrOH896Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDoxMDozNlrOH896Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MDkxNA==", "bodyText": "Undo this change just to avoid making any changes to this file (which complicates the version history of the file).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r533690914", "createdAt": "2020-12-01T20:10:36Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/marklogic-data-hub-spark-connector/initializeRead.sjs", "diffHunk": "@@ -20,7 +20,7 @@ const readLib = require(\"readLib.sjs\");\n \n /**\n  * Build an Optic plan based on the user's inputs.\n- * \n+ *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3abd77b345a84efab105e403c0c2eb21c4165c96"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODk1MDUzOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjoxMjo1NVrOH-kltQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjoxMjo1NVrOH-kltQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM3MzIzNw==", "bodyText": "I like to minimize the number of class fields as much as possible to simplify a class; this one can be a local variable in the initializeRead method, it doesn't need to be a class field.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r535373237", "createdAt": "2020-12-03T16:12:55Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubDataSourceReader.java", "diffHunk": "@@ -29,6 +33,9 @@\n     private final Map<String, String> options;\n     private final JsonNode initializationResponse;\n     private final StructType sparkSchema;\n+    private InputStreamHandle initializeDefinition;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d62c66cb746c126345a5e401668fdb8d0181d372"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1ODk1Mjg0OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubInputPartition.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjoxMzoyMlrOH-knHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjoxMzoyMlrOH-knHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM3MzU5OA==", "bodyText": "Let's make this consistent with the HubInputPartitionReader constructor, where endpointParams is the last argument out of 4.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4916#discussion_r535373598", "createdAt": "2020-12-03T16:13:22Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/reader/HubInputPartition.java", "diffHunk": "@@ -16,15 +16,17 @@\n     private Map<String, String> options;\n     private JsonNode initializeResponse;\n     private int partitionNumber;\n+    private JsonNode endpointParams;\n \n-    public HubInputPartition(Map<String, String> options, JsonNode initializeResponse, int partitionNumber) {\n+    public HubInputPartition(JsonNode endpointParams, Map<String, String> options, JsonNode initializeResponse, int partitionNumber) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d62c66cb746c126345a5e401668fdb8d0181d372"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2986, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}