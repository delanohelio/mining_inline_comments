{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NTI4ODg3", "number": 3603, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNDoyNzo0OVrODiNY2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNDo0MTowMlrODjsZ-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MTk3NTMwOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNDoyNzo0OVrOFtVenw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNjo1ODoxNlrOFuNhmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4MjE0Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        List<String> roles = new LinkedList<>();\n          \n          \n            \n                        Set<String> roles = new HashSet<>();", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r383082143", "createdAt": "2020-02-24T04:27:49Z", "author": {"login": "hao1st"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -188,44 +201,45 @@ public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) th\n                     }\n                 });\n             }\n-\n-            // let's do step-definitions\n-            if (stepDefPath.toFile().exists()) {\n-                Files.walkFileTree(stepDefPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            stepDefModulesFinder,\n-                            propertiesModuleManager,\n-                            stepResourceToURI,\n-                            buildMetadata(hubConfig.getStepDefinitionPermissions(), \"http://marklogic.com/data-hub/step-definition\"),\n-                            stagingStepDefDocumentWriteSet,\n-                            finalStepDefDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n-            }\n-\n-\n-            // let's do flows\n-            if (flowPath.toFile().exists()) {\n-                Files.walkFileTree(flowPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            flowDefModulesFinder,\n-                            propertiesModuleManager,\n-                            flowResourceToURI,\n-                            buildMetadata(hubConfig.getFlowPermissions(), \"http://marklogic.com/data-hub/flow\"),\n-                            stagingFlowDocumentWriteSet,\n-                            finalFlowDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n+            ArtifactManager artifactManager = new ArtifactManagerImpl(hubConfig);\n+            List<String> roles = new LinkedList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk5OTk1MQ==", "bodyText": "Refactored to add a canUserUpdate property artifactType info, so checking the roles is no longer necessary.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r383999951", "createdAt": "2020-02-25T16:57:36Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -188,44 +201,45 @@ public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) th\n                     }\n                 });\n             }\n-\n-            // let's do step-definitions\n-            if (stepDefPath.toFile().exists()) {\n-                Files.walkFileTree(stepDefPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            stepDefModulesFinder,\n-                            propertiesModuleManager,\n-                            stepResourceToURI,\n-                            buildMetadata(hubConfig.getStepDefinitionPermissions(), \"http://marklogic.com/data-hub/step-definition\"),\n-                            stagingStepDefDocumentWriteSet,\n-                            finalStepDefDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n-            }\n-\n-\n-            // let's do flows\n-            if (flowPath.toFile().exists()) {\n-                Files.walkFileTree(flowPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            flowDefModulesFinder,\n-                            propertiesModuleManager,\n-                            flowResourceToURI,\n-                            buildMetadata(hubConfig.getFlowPermissions(), \"http://marklogic.com/data-hub/flow\"),\n-                            stagingFlowDocumentWriteSet,\n-                            finalFlowDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n+            ArtifactManager artifactManager = new ArtifactManagerImpl(hubConfig);\n+            List<String> roles = new LinkedList<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4MjE0Mw=="}, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAwMDQwOQ==", "bodyText": "Refactored to add a canUserUpdate property artifactTypeInfo class, so checking the roles is no longer necessary.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r384000409", "createdAt": "2020-02-25T16:58:16Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -188,44 +201,45 @@ public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) th\n                     }\n                 });\n             }\n-\n-            // let's do step-definitions\n-            if (stepDefPath.toFile().exists()) {\n-                Files.walkFileTree(stepDefPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            stepDefModulesFinder,\n-                            propertiesModuleManager,\n-                            stepResourceToURI,\n-                            buildMetadata(hubConfig.getStepDefinitionPermissions(), \"http://marklogic.com/data-hub/step-definition\"),\n-                            stagingStepDefDocumentWriteSet,\n-                            finalStepDefDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n-            }\n-\n-\n-            // let's do flows\n-            if (flowPath.toFile().exists()) {\n-                Files.walkFileTree(flowPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            flowDefModulesFinder,\n-                            propertiesModuleManager,\n-                            flowResourceToURI,\n-                            buildMetadata(hubConfig.getFlowPermissions(), \"http://marklogic.com/data-hub/flow\"),\n-                            stagingFlowDocumentWriteSet,\n-                            finalFlowDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n+            ArtifactManager artifactManager = new ArtifactManagerImpl(hubConfig);\n+            List<String> roles = new LinkedList<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4MjE0Mw=="}, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MTk3ODIyOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNDozMDoxN1rOFtVgGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNjo1OToyNVrOFuNklg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4MjUyMg==", "bodyText": "put the following right after for loop\nif (roles.contains(typeInfo.getUpdateRole()) { continue; }", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r383082522", "createdAt": "2020-02-24T04:30:17Z", "author": {"login": "hao1st"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -188,44 +201,45 @@ public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) th\n                     }\n                 });\n             }\n-\n-            // let's do step-definitions\n-            if (stepDefPath.toFile().exists()) {\n-                Files.walkFileTree(stepDefPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            stepDefModulesFinder,\n-                            propertiesModuleManager,\n-                            stepResourceToURI,\n-                            buildMetadata(hubConfig.getStepDefinitionPermissions(), \"http://marklogic.com/data-hub/step-definition\"),\n-                            stagingStepDefDocumentWriteSet,\n-                            finalStepDefDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n-            }\n-\n-\n-            // let's do flows\n-            if (flowPath.toFile().exists()) {\n-                Files.walkFileTree(flowPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            flowDefModulesFinder,\n-                            propertiesModuleManager,\n-                            flowResourceToURI,\n-                            buildMetadata(hubConfig.getFlowPermissions(), \"http://marklogic.com/data-hub/flow\"),\n-                            stagingFlowDocumentWriteSet,\n-                            finalFlowDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n+            ArtifactManager artifactManager = new ArtifactManagerImpl(hubConfig);\n+            List<String> roles = new LinkedList<>();\n+            RolesService.on(stagingClient).getRoles().elements().forEachRemaining(\n+                (roleNode) -> roles.add(roleNode.asText())\n+            );\n+            ArtifactService artifactService = ArtifactService.on(stagingClient);\n+            ObjectMapper mapper = new ObjectMapper();\n+            // New way to deploy Artifacts via Data Services\n+            for (ArtifactTypeInfo typeInfo: artifactManager.getArtifactTypeInfoList()) {\n+                final String artifactType = typeInfo.getType();\n+                final Path artifactPath = hubConfig.getHubProject().getProjectDir().toAbsolutePath().resolve(typeInfo.getDirectory().replaceAll(\"^/\",\"\")).toAbsolutePath();\n+                logger.info(\"Deploying artifacts of type '\" + artifactType + \"' located at '\"+ artifactPath.toString() +\"'\" );\n+                if (roles.contains(typeInfo.getUpdateRole()) && artifactPath.toFile().exists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1MTcxOQ==", "bodyText": "I was thinking - first check to see if the artifactPath doesn't exist, and if not, log an info message of \"Artifact directory (directory) does not exist, so will not load any artifacts from it\". Then check to see if the user has the update role, and if so, load the artifacts; if not, log an info message stating \"User is not permitted to update artifacts of type (type), so will not load any artifacts of that type\".", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r383251719", "createdAt": "2020-02-24T13:03:16Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -188,44 +201,45 @@ public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) th\n                     }\n                 });\n             }\n-\n-            // let's do step-definitions\n-            if (stepDefPath.toFile().exists()) {\n-                Files.walkFileTree(stepDefPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            stepDefModulesFinder,\n-                            propertiesModuleManager,\n-                            stepResourceToURI,\n-                            buildMetadata(hubConfig.getStepDefinitionPermissions(), \"http://marklogic.com/data-hub/step-definition\"),\n-                            stagingStepDefDocumentWriteSet,\n-                            finalStepDefDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n-            }\n-\n-\n-            // let's do flows\n-            if (flowPath.toFile().exists()) {\n-                Files.walkFileTree(flowPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            flowDefModulesFinder,\n-                            propertiesModuleManager,\n-                            flowResourceToURI,\n-                            buildMetadata(hubConfig.getFlowPermissions(), \"http://marklogic.com/data-hub/flow\"),\n-                            stagingFlowDocumentWriteSet,\n-                            finalFlowDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n+            ArtifactManager artifactManager = new ArtifactManagerImpl(hubConfig);\n+            List<String> roles = new LinkedList<>();\n+            RolesService.on(stagingClient).getRoles().elements().forEachRemaining(\n+                (roleNode) -> roles.add(roleNode.asText())\n+            );\n+            ArtifactService artifactService = ArtifactService.on(stagingClient);\n+            ObjectMapper mapper = new ObjectMapper();\n+            // New way to deploy Artifacts via Data Services\n+            for (ArtifactTypeInfo typeInfo: artifactManager.getArtifactTypeInfoList()) {\n+                final String artifactType = typeInfo.getType();\n+                final Path artifactPath = hubConfig.getHubProject().getProjectDir().toAbsolutePath().resolve(typeInfo.getDirectory().replaceAll(\"^/\",\"\")).toAbsolutePath();\n+                logger.info(\"Deploying artifacts of type '\" + artifactType + \"' located at '\"+ artifactPath.toString() +\"'\" );\n+                if (roles.contains(typeInfo.getUpdateRole()) && artifactPath.toFile().exists()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4MjUyMg=="}, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAwMTE3NA==", "bodyText": "Changed to use continue calls and added more specific logging as to why an artifact type may not be loaded.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r384001174", "createdAt": "2020-02-25T16:59:25Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -188,44 +201,45 @@ public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) th\n                     }\n                 });\n             }\n-\n-            // let's do step-definitions\n-            if (stepDefPath.toFile().exists()) {\n-                Files.walkFileTree(stepDefPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            stepDefModulesFinder,\n-                            propertiesModuleManager,\n-                            stepResourceToURI,\n-                            buildMetadata(hubConfig.getStepDefinitionPermissions(), \"http://marklogic.com/data-hub/step-definition\"),\n-                            stagingStepDefDocumentWriteSet,\n-                            finalStepDefDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n-            }\n-\n-\n-            // let's do flows\n-            if (flowPath.toFile().exists()) {\n-                Files.walkFileTree(flowPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            flowDefModulesFinder,\n-                            propertiesModuleManager,\n-                            flowResourceToURI,\n-                            buildMetadata(hubConfig.getFlowPermissions(), \"http://marklogic.com/data-hub/flow\"),\n-                            stagingFlowDocumentWriteSet,\n-                            finalFlowDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n+            ArtifactManager artifactManager = new ArtifactManagerImpl(hubConfig);\n+            List<String> roles = new LinkedList<>();\n+            RolesService.on(stagingClient).getRoles().elements().forEachRemaining(\n+                (roleNode) -> roles.add(roleNode.asText())\n+            );\n+            ArtifactService artifactService = ArtifactService.on(stagingClient);\n+            ObjectMapper mapper = new ObjectMapper();\n+            // New way to deploy Artifacts via Data Services\n+            for (ArtifactTypeInfo typeInfo: artifactManager.getArtifactTypeInfoList()) {\n+                final String artifactType = typeInfo.getType();\n+                final Path artifactPath = hubConfig.getHubProject().getProjectDir().toAbsolutePath().resolve(typeInfo.getDirectory().replaceAll(\"^/\",\"\")).toAbsolutePath();\n+                logger.info(\"Deploying artifacts of type '\" + artifactType + \"' located at '\"+ artifactPath.toString() +\"'\" );\n+                if (roles.contains(typeInfo.getUpdateRole()) && artifactPath.toFile().exists()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4MjUyMg=="}, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzA3NzgwOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/artifact/ArtifactTypeInfo.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMjo0OTo0NVrOFtfeHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNzowMDo1N1rOFuNocA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI0NTg1NA==", "bodyText": "We shouldn't need this code - Jackson will automatically convert an ObjectNode into a POJO based on naming conventions. You can do objectMapper.readerFor(Class).readValue(jsonObject).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r383245854", "createdAt": "2020-02-24T12:49:45Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/artifact/ArtifactTypeInfo.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub.artifact;\n+\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+/**\n+ * Provides metadata about an artifact type\n+ */\n+public class ArtifactTypeInfo {\n+    private String type = null;\n+    private String directory = null;\n+    private String fileExtension = null;\n+    private String versionProperty = null;\n+    private String nameProperty = null;\n+    private String updateRole = null;\n+\n+    public String getType() {\n+        return type;\n+    }\n+\n+    public void setType(String type) {\n+        this.type = type;\n+    }\n+\n+    public String getDirectory() {\n+        return directory;\n+    }\n+\n+    public void setDirectory(String directory) {\n+        this.directory = directory;\n+    }\n+\n+    public String getFileExtension() {\n+        return fileExtension;\n+    }\n+\n+    public void setFileExtension(String fileExtension) {\n+        this.fileExtension = fileExtension;\n+    }\n+\n+    public String getVersionProperty() {\n+        return versionProperty;\n+    }\n+\n+    public void setVersionProperty(String versionProperty) {\n+        this.versionProperty = versionProperty;\n+    }\n+\n+    public String getNameProperty() {\n+        return nameProperty;\n+    }\n+\n+    public void setNameProperty(String nameProperty) {\n+        this.nameProperty = nameProperty;\n+    }\n+\n+    public String getUpdateRole() {\n+        return updateRole;\n+    }\n+\n+    public void setUpdateRole(String updateRole) {\n+        this.updateRole = updateRole;\n+    }\n+\n+    public static ArtifactTypeInfo deserialize(ObjectNode jsonObject) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAwMjE2MA==", "bodyText": "Refactored to use an ObjectMapper", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r384002160", "createdAt": "2020-02-25T17:00:57Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/artifact/ArtifactTypeInfo.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub.artifact;\n+\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+/**\n+ * Provides metadata about an artifact type\n+ */\n+public class ArtifactTypeInfo {\n+    private String type = null;\n+    private String directory = null;\n+    private String fileExtension = null;\n+    private String versionProperty = null;\n+    private String nameProperty = null;\n+    private String updateRole = null;\n+\n+    public String getType() {\n+        return type;\n+    }\n+\n+    public void setType(String type) {\n+        this.type = type;\n+    }\n+\n+    public String getDirectory() {\n+        return directory;\n+    }\n+\n+    public void setDirectory(String directory) {\n+        this.directory = directory;\n+    }\n+\n+    public String getFileExtension() {\n+        return fileExtension;\n+    }\n+\n+    public void setFileExtension(String fileExtension) {\n+        this.fileExtension = fileExtension;\n+    }\n+\n+    public String getVersionProperty() {\n+        return versionProperty;\n+    }\n+\n+    public void setVersionProperty(String versionProperty) {\n+        this.versionProperty = versionProperty;\n+    }\n+\n+    public String getNameProperty() {\n+        return nameProperty;\n+    }\n+\n+    public void setNameProperty(String nameProperty) {\n+        this.nameProperty = nameProperty;\n+    }\n+\n+    public String getUpdateRole() {\n+        return updateRole;\n+    }\n+\n+    public void setUpdateRole(String updateRole) {\n+        this.updateRole = updateRole;\n+    }\n+\n+    public static ArtifactTypeInfo deserialize(ObjectNode jsonObject) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI0NTg1NA=="}, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzEwOTY4OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzowMToyNVrOFtfxvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNzowMjowMVrOFuNrIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1MDg3Nw==", "bodyText": "I think this is a good method to add to HubProject. I think HubProject should be aware of an ArtifactTypeInfo, and thus have a method of:\nPath getArtifactTypePath(ArtifactTypeInfo)", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r383250877", "createdAt": "2020-02-24T13:01:25Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -188,44 +201,45 @@ public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) th\n                     }\n                 });\n             }\n-\n-            // let's do step-definitions\n-            if (stepDefPath.toFile().exists()) {\n-                Files.walkFileTree(stepDefPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            stepDefModulesFinder,\n-                            propertiesModuleManager,\n-                            stepResourceToURI,\n-                            buildMetadata(hubConfig.getStepDefinitionPermissions(), \"http://marklogic.com/data-hub/step-definition\"),\n-                            stagingStepDefDocumentWriteSet,\n-                            finalStepDefDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n-            }\n-\n-\n-            // let's do flows\n-            if (flowPath.toFile().exists()) {\n-                Files.walkFileTree(flowPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            flowDefModulesFinder,\n-                            propertiesModuleManager,\n-                            flowResourceToURI,\n-                            buildMetadata(hubConfig.getFlowPermissions(), \"http://marklogic.com/data-hub/flow\"),\n-                            stagingFlowDocumentWriteSet,\n-                            finalFlowDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n+            ArtifactManager artifactManager = new ArtifactManagerImpl(hubConfig);\n+            List<String> roles = new LinkedList<>();\n+            RolesService.on(stagingClient).getRoles().elements().forEachRemaining(\n+                (roleNode) -> roles.add(roleNode.asText())\n+            );\n+            ArtifactService artifactService = ArtifactService.on(stagingClient);\n+            ObjectMapper mapper = new ObjectMapper();\n+            // New way to deploy Artifacts via Data Services\n+            for (ArtifactTypeInfo typeInfo: artifactManager.getArtifactTypeInfoList()) {\n+                final String artifactType = typeInfo.getType();\n+                final Path artifactPath = hubConfig.getHubProject().getProjectDir().toAbsolutePath().resolve(typeInfo.getDirectory().replaceAll(\"^/\",\"\")).toAbsolutePath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAwMjAwMw==", "bodyText": "Moved the logic for the path into the HubProject", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r384002003", "createdAt": "2020-02-25T17:00:42Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -188,44 +201,45 @@ public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) th\n                     }\n                 });\n             }\n-\n-            // let's do step-definitions\n-            if (stepDefPath.toFile().exists()) {\n-                Files.walkFileTree(stepDefPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            stepDefModulesFinder,\n-                            propertiesModuleManager,\n-                            stepResourceToURI,\n-                            buildMetadata(hubConfig.getStepDefinitionPermissions(), \"http://marklogic.com/data-hub/step-definition\"),\n-                            stagingStepDefDocumentWriteSet,\n-                            finalStepDefDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n-            }\n-\n-\n-            // let's do flows\n-            if (flowPath.toFile().exists()) {\n-                Files.walkFileTree(flowPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            flowDefModulesFinder,\n-                            propertiesModuleManager,\n-                            flowResourceToURI,\n-                            buildMetadata(hubConfig.getFlowPermissions(), \"http://marklogic.com/data-hub/flow\"),\n-                            stagingFlowDocumentWriteSet,\n-                            finalFlowDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n+            ArtifactManager artifactManager = new ArtifactManagerImpl(hubConfig);\n+            List<String> roles = new LinkedList<>();\n+            RolesService.on(stagingClient).getRoles().elements().forEachRemaining(\n+                (roleNode) -> roles.add(roleNode.asText())\n+            );\n+            ArtifactService artifactService = ArtifactService.on(stagingClient);\n+            ObjectMapper mapper = new ObjectMapper();\n+            // New way to deploy Artifacts via Data Services\n+            for (ArtifactTypeInfo typeInfo: artifactManager.getArtifactTypeInfoList()) {\n+                final String artifactType = typeInfo.getType();\n+                final Path artifactPath = hubConfig.getHubProject().getProjectDir().toAbsolutePath().resolve(typeInfo.getDirectory().replaceAll(\"^/\",\"\")).toAbsolutePath();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1MDg3Nw=="}, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAwMjIxNw==", "bodyText": "Moved the logic for the path into the HubProject", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r384002217", "createdAt": "2020-02-25T17:01:02Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -188,44 +201,45 @@ public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) th\n                     }\n                 });\n             }\n-\n-            // let's do step-definitions\n-            if (stepDefPath.toFile().exists()) {\n-                Files.walkFileTree(stepDefPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            stepDefModulesFinder,\n-                            propertiesModuleManager,\n-                            stepResourceToURI,\n-                            buildMetadata(hubConfig.getStepDefinitionPermissions(), \"http://marklogic.com/data-hub/step-definition\"),\n-                            stagingStepDefDocumentWriteSet,\n-                            finalStepDefDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n-            }\n-\n-\n-            // let's do flows\n-            if (flowPath.toFile().exists()) {\n-                Files.walkFileTree(flowPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            flowDefModulesFinder,\n-                            propertiesModuleManager,\n-                            flowResourceToURI,\n-                            buildMetadata(hubConfig.getFlowPermissions(), \"http://marklogic.com/data-hub/flow\"),\n-                            stagingFlowDocumentWriteSet,\n-                            finalFlowDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n+            ArtifactManager artifactManager = new ArtifactManagerImpl(hubConfig);\n+            List<String> roles = new LinkedList<>();\n+            RolesService.on(stagingClient).getRoles().elements().forEachRemaining(\n+                (roleNode) -> roles.add(roleNode.asText())\n+            );\n+            ArtifactService artifactService = ArtifactService.on(stagingClient);\n+            ObjectMapper mapper = new ObjectMapper();\n+            // New way to deploy Artifacts via Data Services\n+            for (ArtifactTypeInfo typeInfo: artifactManager.getArtifactTypeInfoList()) {\n+                final String artifactType = typeInfo.getType();\n+                final Path artifactPath = hubConfig.getHubProject().getProjectDir().toAbsolutePath().resolve(typeInfo.getDirectory().replaceAll(\"^/\",\"\")).toAbsolutePath();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1MDg3Nw=="}, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAwMjg1MQ==", "bodyText": "Moved the logic for the path into the HubProject", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r384002851", "createdAt": "2020-02-25T17:02:01Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -188,44 +201,45 @@ public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) th\n                     }\n                 });\n             }\n-\n-            // let's do step-definitions\n-            if (stepDefPath.toFile().exists()) {\n-                Files.walkFileTree(stepDefPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            stepDefModulesFinder,\n-                            propertiesModuleManager,\n-                            stepResourceToURI,\n-                            buildMetadata(hubConfig.getStepDefinitionPermissions(), \"http://marklogic.com/data-hub/step-definition\"),\n-                            stagingStepDefDocumentWriteSet,\n-                            finalStepDefDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n-            }\n-\n-\n-            // let's do flows\n-            if (flowPath.toFile().exists()) {\n-                Files.walkFileTree(flowPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            flowDefModulesFinder,\n-                            propertiesModuleManager,\n-                            flowResourceToURI,\n-                            buildMetadata(hubConfig.getFlowPermissions(), \"http://marklogic.com/data-hub/flow\"),\n-                            stagingFlowDocumentWriteSet,\n-                            finalFlowDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n+            ArtifactManager artifactManager = new ArtifactManagerImpl(hubConfig);\n+            List<String> roles = new LinkedList<>();\n+            RolesService.on(stagingClient).getRoles().elements().forEachRemaining(\n+                (roleNode) -> roles.add(roleNode.asText())\n+            );\n+            ArtifactService artifactService = ArtifactService.on(stagingClient);\n+            ObjectMapper mapper = new ObjectMapper();\n+            // New way to deploy Artifacts via Data Services\n+            for (ArtifactTypeInfo typeInfo: artifactManager.getArtifactTypeInfoList()) {\n+                final String artifactType = typeInfo.getType();\n+                final Path artifactPath = hubConfig.getHubProject().getProjectDir().toAbsolutePath().resolve(typeInfo.getDirectory().replaceAll(\"^/\",\"\")).toAbsolutePath();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1MDg3Nw=="}, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzEyMzMyOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzowNTo1MFrOFtf5nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzowNTo1MFrOFtf5nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1Mjg5Mg==", "bodyText": "This looks like it should be a debug message or removed.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r383252892", "createdAt": "2020-02-24T13:05:50Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/LoadUserArtifactsCommand.java", "diffHunk": "@@ -188,44 +201,45 @@ public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) th\n                     }\n                 });\n             }\n-\n-            // let's do step-definitions\n-            if (stepDefPath.toFile().exists()) {\n-                Files.walkFileTree(stepDefPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            stepDefModulesFinder,\n-                            propertiesModuleManager,\n-                            stepResourceToURI,\n-                            buildMetadata(hubConfig.getStepDefinitionPermissions(), \"http://marklogic.com/data-hub/step-definition\"),\n-                            stagingStepDefDocumentWriteSet,\n-                            finalStepDefDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n-            }\n-\n-\n-            // let's do flows\n-            if (flowPath.toFile().exists()) {\n-                Files.walkFileTree(flowPath, new SimpleFileVisitor<Path>() {\n-                    @Override\n-                    public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {\n-                        executeWalk(\n-                            dir,\n-                            flowDefModulesFinder,\n-                            propertiesModuleManager,\n-                            flowResourceToURI,\n-                            buildMetadata(hubConfig.getFlowPermissions(), \"http://marklogic.com/data-hub/flow\"),\n-                            stagingFlowDocumentWriteSet,\n-                            finalFlowDocumentWriteSet\n-                        );\n-                        return FileVisitResult.CONTINUE;\n-                    }\n-                });\n+            ArtifactManager artifactManager = new ArtifactManagerImpl(hubConfig);\n+            List<String> roles = new LinkedList<>();\n+            RolesService.on(stagingClient).getRoles().elements().forEachRemaining(\n+                (roleNode) -> roles.add(roleNode.asText())\n+            );\n+            ArtifactService artifactService = ArtifactService.on(stagingClient);\n+            ObjectMapper mapper = new ObjectMapper();\n+            // New way to deploy Artifacts via Data Services\n+            for (ArtifactTypeInfo typeInfo: artifactManager.getArtifactTypeInfoList()) {\n+                final String artifactType = typeInfo.getType();\n+                final Path artifactPath = hubConfig.getHubProject().getProjectDir().toAbsolutePath().resolve(typeInfo.getDirectory().replaceAll(\"^/\",\"\")).toAbsolutePath();\n+                logger.info(\"Deploying artifacts of type '\" + artifactType + \"' located at '\"+ artifactPath.toString() +\"'\" );\n+                if (roles.contains(typeInfo.getUpdateRole()) && artifactPath.toFile().exists()) {\n+                    final String fileExtension = \"*\" + typeInfo.getFileExtension();\n+                    BaseModulesFinder modulesFinder = new BaseModulesFinder(){\n+                        @Override\n+                        protected Modules findModulesWithResolvedBaseDir(String resolvedBaseDir) {\n+                            Modules modules = new Modules();\n+                            logger.info(\"resolvedBaseDir: \" + resolvedBaseDir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzE5NTA3OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzoyODowNFrOFtgjLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzoyODowNFrOFtgjLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2MzUzNA==", "bodyText": "Similar to #3605, I'm wondering if it'd be better for the \"roles\" service to instead include true/false properties for e.g. \"canLoadMappings\", \"canLoadFlows\", etc. That prevents the Java tier from having knowledge of any roles.\nMore importantly, ML knows the answer to the question of whether a user can load a mapping, so it should be the one to determine a true/false value for that, not the Java code.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r383263534", "createdAt": "2020-02-24T13:28:04Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -43,7 +43,8 @@ function getTypesInfo() {\n                 fileExtension: getArtifactFileExtension(artifactType),\n                 directory: getArtifactDirectory(artifactType),\n                 nameProperty: artifactLibrary.getNameProperty(),\n-                versionProperty: artifactLibrary.getVersionProperty()\n+                versionProperty: artifactLibrary.getVersionProperty(),\n+                updateRole: artifactLibrary.getPermissions().filter((perm) => perm.capability === 'update').map((perm) => xdmp.roleName(perm.roleId))[0]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzIwMjYxOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ArtifactManagerImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzozMDowOFrOFtgnkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNzowNDoyMlrOFuNwxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2NDY1OQ==", "bodyText": "What's the benefit of saving this state in the class? Are there use cases where we may invoke multiple methods on an instance of this class for the same user?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r383264659", "createdAt": "2020-02-24T13:30:08Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ArtifactManagerImpl.java", "diffHunk": "@@ -29,18 +30,20 @@\n import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n \n @Component\n public class ArtifactManagerImpl implements ArtifactManager {\n     HubConfig hubConfig;\n+    protected List<ArtifactTypeInfo> allArtifactTypeInfo = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAwNDI5Mg==", "bodyText": "No longer keeping the state. With the change to deliberately state whether the current user can update an artifact type, we want to ensure that information is current anyway.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r384004292", "createdAt": "2020-02-25T17:04:22Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ArtifactManagerImpl.java", "diffHunk": "@@ -29,18 +30,20 @@\n import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n \n @Component\n public class ArtifactManagerImpl implements ArtifactManager {\n     HubConfig hubConfig;\n+    protected List<ArtifactTypeInfo> allArtifactTypeInfo = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2NDY1OQ=="}, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzIwMzg0OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ArtifactManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzozMDozMlrOFtgoSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzozMDozMlrOFtgoSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2NDg0Mg==", "bodyText": "I think \"Component\" can be removed, right? I'd rather see the tests that are autowiring this in just instantiate an instance when it needs it (there are only 3 of them).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r383264842", "createdAt": "2020-02-24T13:30:32Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ArtifactManagerImpl.java", "diffHunk": "@@ -29,18 +30,20 @@\n import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n \n @Component", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzIwNzA1OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/flow/impl/FlowRunnerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzozMToyOFrOFtgqJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzozMToyOFrOFtgqJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2NTMxOQ==", "bodyText": "How about making this a protected method? Then you can easily unit test the various branches in this method without having to connect to ML or setup a test flow.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r383265319", "createdAt": "2020-02-24T13:31:28Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/flow/impl/FlowRunnerImpl.java", "diffHunk": "@@ -592,4 +606,66 @@ public void setFlowManager(FlowManager flowManager) {\n     public HubConfig getHubConfig() {\n         return hubConfig;\n     }\n+\n+    // Brings in artifact settings for running a step\n+    private void applyArtifactSettings(Step step, Map<String, Object> stepConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "203448f1fcadfb4cebadf9a6344246d4a6d837c0"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MjE1MzUxOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/artifact/ArtifactTypeInfo.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNzo1ODowM1rOFu2DGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxOTowMzo1NlrOFu4PDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY2NDM0NQ==", "bodyText": "We do not need to initialize these member variable. They shoud be default.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r384664345", "createdAt": "2020-02-26T17:58:03Z", "author": {"login": "hao1st"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/artifact/ArtifactTypeInfo.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub.artifact;\n+\n+/**\n+ * Provides metadata about an artifact type\n+ */\n+public class ArtifactTypeInfo {\n+    private String type = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f60b0d57fd9e0afe78804258270316c4a72176"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcwMDE3NQ==", "bodyText": "Removed unnecessary initializations and setters.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r384700175", "createdAt": "2020-02-26T19:03:56Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/artifact/ArtifactTypeInfo.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub.artifact;\n+\n+/**\n+ * Provides metadata about an artifact type\n+ */\n+public class ArtifactTypeInfo {\n+    private String type = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY2NDM0NQ=="}, "originalCommit": {"oid": "41f60b0d57fd9e0afe78804258270316c4a72176"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTE0OTc0OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/flow/impl/FlowRunnerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMzozNjo1OVrOFvSbpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMzozNjo1OVrOFvSbpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEyOTM4MA==", "bodyText": "I think we should have unit tests for this, but I'd actually like to write them. I created a subtask for the work.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r385129380", "createdAt": "2020-02-27T13:36:59Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/flow/impl/FlowRunnerImpl.java", "diffHunk": "@@ -599,4 +613,66 @@ public void setFlowManager(FlowManager flowManager) {\n     public HubConfig getHubConfig() {\n         return hubConfig;\n     }\n+\n+    // Brings in artifact settings for running a step\n+    protected void applyArtifactSettings(Step step, Map<String, Object> stepConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c09a88f8f9f9204ba41c0bb7f457d5c73df18125"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NzUzOTM2OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNDozODowMVrOFvpUBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNDoxNDowMFrOFv2SaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwNDI2MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        const updateRoles = artifactLibrary.getPermissions().filter((perm) => perm.capability === 'update').map((perm) => perm.roleId);\n          \n          \n            \n                        const currentRoles = xdmp.getCurrentRoles().toArray();\n          \n          \n            \n                        const updateRoles = artifactLibrary.getPermissions().filter((perm) => perm.capability === 'update').map((perm) => String(perm.roleId));\n          \n          \n            \n                        const currentRoles = xdmp.getCurrentRoles().toArray().map(String);", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r385504261", "createdAt": "2020-02-28T04:38:01Z", "author": {"login": "hao1st"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -36,14 +36,16 @@ function getTypesInfo() {\n     for (const artifactType of Object.keys(registeredArtifactTypes)) {\n         if (registeredArtifactTypes.hasOwnProperty(artifactType)) {\n             const artifactLibrary = registeredArtifactTypes[artifactType];\n+            const updateRoles = artifactLibrary.getPermissions().filter((perm) => perm.capability === 'update').map((perm) => perm.roleId);\n+            const currentRoles = xdmp.getCurrentRoles().toArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dc6263728c1ff649cb7edac241fab91f1b051de"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcxNjg0MQ==", "bodyText": "Updated to map to strings so they're accurately compared.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r385716841", "createdAt": "2020-02-28T14:14:00Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -36,14 +36,16 @@ function getTypesInfo() {\n     for (const artifactType of Object.keys(registeredArtifactTypes)) {\n         if (registeredArtifactTypes.hasOwnProperty(artifactType)) {\n             const artifactLibrary = registeredArtifactTypes[artifactType];\n+            const updateRoles = artifactLibrary.getPermissions().filter((perm) => perm.capability === 'update').map((perm) => perm.roleId);\n+            const currentRoles = xdmp.getCurrentRoles().toArray();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwNDI2MQ=="}, "originalCommit": {"oid": "9dc6263728c1ff649cb7edac241fab91f1b051de"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NzU0Mjk4OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNDo0MTowMlrOFvpWPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNDoxNDoyMVrOFv2TNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwNDgyOQ==", "bodyText": "@ryanjdew I just tested it, userCanUpdate is always false. After I did the above changes as suggestion, it works.\nAlso can we add \"userCanRead\" as part of artifact type info?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r385504829", "createdAt": "2020-02-28T04:41:02Z", "author": {"login": "hao1st"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -36,14 +36,16 @@ function getTypesInfo() {\n     for (const artifactType of Object.keys(registeredArtifactTypes)) {\n         if (registeredArtifactTypes.hasOwnProperty(artifactType)) {\n             const artifactLibrary = registeredArtifactTypes[artifactType];\n+            const updateRoles = artifactLibrary.getPermissions().filter((perm) => perm.capability === 'update').map((perm) => perm.roleId);\n+            const currentRoles = xdmp.getCurrentRoles().toArray();\n+            const userCanUpdate = updateRoles.some((roleId) => currentRoles.includes(roleId));\n             typesInfo.push({\n                 type: artifactType,\n-                storageDatabases: artifactLibrary.getStorageDatabases(),\n-                collections: artifactLibrary.getCollections(),\n                 fileExtension: getArtifactFileExtension(artifactType),\n                 directory: getArtifactDirectory(artifactType),\n                 nameProperty: artifactLibrary.getNameProperty(),\n-                versionProperty: artifactLibrary.getVersionProperty()\n+                versionProperty: artifactLibrary.getVersionProperty(),\n+                userCanUpdate: userCanUpdate", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dc6263728c1ff649cb7edac241fab91f1b051de"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcxNzA0NQ==", "bodyText": "Added the logic for userCanRead", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3603#discussion_r385717045", "createdAt": "2020-02-28T14:14:21Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -36,14 +36,16 @@ function getTypesInfo() {\n     for (const artifactType of Object.keys(registeredArtifactTypes)) {\n         if (registeredArtifactTypes.hasOwnProperty(artifactType)) {\n             const artifactLibrary = registeredArtifactTypes[artifactType];\n+            const updateRoles = artifactLibrary.getPermissions().filter((perm) => perm.capability === 'update').map((perm) => perm.roleId);\n+            const currentRoles = xdmp.getCurrentRoles().toArray();\n+            const userCanUpdate = updateRoles.some((roleId) => currentRoles.includes(roleId));\n             typesInfo.push({\n                 type: artifactType,\n-                storageDatabases: artifactLibrary.getStorageDatabases(),\n-                collections: artifactLibrary.getCollections(),\n                 fileExtension: getArtifactFileExtension(artifactType),\n                 directory: getArtifactDirectory(artifactType),\n                 nameProperty: artifactLibrary.getNameProperty(),\n-                versionProperty: artifactLibrary.getVersionProperty()\n+                versionProperty: artifactLibrary.getVersionProperty(),\n+                userCanUpdate: userCanUpdate", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwNDgyOQ=="}, "originalCommit": {"oid": "9dc6263728c1ff649cb7edac241fab91f1b051de"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3562, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}