{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMjA1NTgx", "number": 3914, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwMDowODoyNVrOD5NX9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMTowODozNFrOD6eYew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzE0NTQ4OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/AuthenticationFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwMDowODoyNVrOGQWe0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwMDowODoyNVrOGQWe0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc5ODczNg==", "bodyText": "Little typo - have, not has", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r419798736", "createdAt": "2020-05-05T00:08:25Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/AuthenticationFilter.java", "diffHunk": "@@ -99,13 +99,16 @@ protected AuthenticationToken authenticateUser(String username, String password)\n             }\n             throw e;\n         }\n-\n         List<GrantedAuthority> authorities = new ArrayList<>();\n+        final boolean[] hasLoginAuthority = {false};\n         response.get(\"authorities\").iterator().forEachRemaining(node -> {\n             String authority = node.asText();\n+            hasLoginAuthority[0] = (\"loginToHubCentral\".equals(authority)) || hasLoginAuthority[0];\n             authorities.add(new SimpleGrantedAuthority(\"ROLE_\" + authority));\n         });\n-\n+        if (!hasLoginAuthority[0]) {\n+            throw new InsufficientAuthenticationException(\"User doesn't has necessary privileges to access Hub Central\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "074d80d76f676a1b9b7b6f24c732a8a7598aeead"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzE1MDI5OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/resources/hub-internal-config/security/roles/hub-central-clear-user-data.json", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwMDoxMDozN1rOGQWhfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwMDoxMDozN1rOGQWhfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc5OTQyMQ==", "bodyText": "I don't think the writer roles are actually needed, as they don't confer any privileges. And technically, we don't want this role to be able to overwrite any of these things - the role only needs to be able to clear the database and then do an initial insert of them.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r419799421", "createdAt": "2020-05-05T00:10:37Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/hub-internal-config/security/roles/hub-central-clear-user-data.json", "diffHunk": "@@ -2,13 +2,20 @@\n   \"role-name\": \"hub-central-clear-user-data\",\n   \"description\": \"This temporarily inherits data-hub-developer so it has the necessary privileges to use Data Hub and to insert artifacts. Will rework this once the new 5.3.0 roles are available.\",\n   \"role\": [\n+    \"hub-central-user\",\n     \"data-hub-developer\",\n     \"data-hub-entity-model-reader\",\n     \"data-hub-flow-reader\",\n     \"data-hub-load-data-reader\",\n     \"data-hub-mapping-reader\",\n     \"data-hub-match-merge-reader\",\n-    \"data-hub-step-definition-reader\"\n+    \"data-hub-step-definition-reader\",\n+    \"data-hub-entity-model-writer\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "074d80d76f676a1b9b7b6f24c732a8a7598aeead"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNzMzNDA2OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/test/ml-config/security/roles/data-hub-test-internal.json", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMjo1MToxNFrOGQ-chA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMzowOTo1MlrOGQ-3qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ1MzUwOA==", "bodyText": "will this and other *-user privileges impact running of tests in DHS?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r420453508", "createdAt": "2020-05-05T22:51:14Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub/src/test/ml-config/security/roles/data-hub-test-internal.json", "diffHunk": "@@ -0,0 +1,56 @@\n+{\n+  \"role-name\": \"data-hub-test-internal\",\n+  \"description\": \"Used to test different roles/privileges at the server level\",\n+  \"privilege\": [\n+    {\n+      \"privilege-name\": \"privilege-add-roles\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/privilege-add-roles\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"grant-my-roles\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/grant-my-roles\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"grant-all-roles\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/grant-all-roles\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"get-role\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/get-role\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"create-role\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/create-role\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"remove-role\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/remove-role\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"get-user\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/get-user\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"create-user\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "099ead27d090c093b5d6ff721978f8326d19449b"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MDQ1OA==", "bodyText": "It is only used as part of an amp on a testing library function. I'm not aware of any negative impact of using this in DHS.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r420460458", "createdAt": "2020-05-05T23:09:52Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub/src/test/ml-config/security/roles/data-hub-test-internal.json", "diffHunk": "@@ -0,0 +1,56 @@\n+{\n+  \"role-name\": \"data-hub-test-internal\",\n+  \"description\": \"Used to test different roles/privileges at the server level\",\n+  \"privilege\": [\n+    {\n+      \"privilege-name\": \"privilege-add-roles\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/privilege-add-roles\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"grant-my-roles\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/grant-my-roles\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"grant-all-roles\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/grant-all-roles\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"get-role\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/get-role\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"create-role\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/create-role\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"remove-role\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/remove-role\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"get-user\",\n+      \"action\": \"http://marklogic.com/xdmp/privileges/get-user\",\n+      \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"create-user\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ1MzUwOA=="}, "originalCommit": {"oid": "099ead27d090c093b5d6ff721978f8326d19449b"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNjQxNzg3OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/LoginFailureHandler.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMTowODozNFrOGSVg1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwMzo0NzoxMVrOGSYABA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg4MDAyMQ==", "bodyText": "was this exception causing the clearUserData test to fail?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r421880021", "createdAt": "2020-05-08T01:08:34Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/LoginFailureHandler.java", "diffHunk": "@@ -37,7 +38,11 @@ public void onAuthenticationFailure(HttpServletRequest request, HttpServletRespo\n         String json = node.toString();\n         response.setContentType(\"application/json\");\n         response.setCharacterEncoding(\"UTF-8\");\n-        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);\n+        if (exception instanceof InsufficientAuthenticationException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "372de2f0de719c18933def822ffa65f51ffbdcee"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg5MzA4OQ==", "bodyText": "I don't think so - that test was failing on 9.0-12 because it was depending on granular privileges that are in 10.0-3.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r421893089", "createdAt": "2020-05-08T01:56:35Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/LoginFailureHandler.java", "diffHunk": "@@ -37,7 +38,11 @@ public void onAuthenticationFailure(HttpServletRequest request, HttpServletRespo\n         String json = node.toString();\n         response.setContentType(\"application/json\");\n         response.setCharacterEncoding(\"UTF-8\");\n-        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);\n+        if (exception instanceof InsufficientAuthenticationException) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg4MDAyMQ=="}, "originalCommit": {"oid": "372de2f0de719c18933def822ffa65f51ffbdcee"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkwMDE5MQ==", "bodyText": "I was referring to the unit test failure for the PR which I think runs on ML 10.0-4:\nhttps://jenkins.marklogic.com/blue/organizations/jenkins/Datahub_CI/detail/PR-3914/16/tests", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r421900191", "createdAt": "2020-05-08T02:24:38Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/LoginFailureHandler.java", "diffHunk": "@@ -37,7 +38,11 @@ public void onAuthenticationFailure(HttpServletRequest request, HttpServletRespo\n         String json = node.toString();\n         response.setContentType(\"application/json\");\n         response.setCharacterEncoding(\"UTF-8\");\n-        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);\n+        if (exception instanceof InsufficientAuthenticationException) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg4MDAyMQ=="}, "originalCommit": {"oid": "372de2f0de719c18933def822ffa65f51ffbdcee"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkyMDc3Mg==", "bodyText": "It turned out that I was wiping out the granular privileges when attempting to deploy the amp/role for testing in ml-unit-tests here: https://github.com/marklogic/marklogic-data-hub/pull/3914/files#diff-1ec8825c599ca5cc7abf57c14482d7e5R79\nAdding the GranularPrivilegeCommand here addressed the problem.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r421920772", "createdAt": "2020-05-08T03:47:11Z", "author": {"login": "ryanjdew"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/LoginFailureHandler.java", "diffHunk": "@@ -37,7 +38,11 @@ public void onAuthenticationFailure(HttpServletRequest request, HttpServletRespo\n         String json = node.toString();\n         response.setContentType(\"application/json\");\n         response.setCharacterEncoding(\"UTF-8\");\n-        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);\n+        if (exception instanceof InsufficientAuthenticationException) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg4MDAyMQ=="}, "originalCommit": {"oid": "372de2f0de719c18933def822ffa65f51ffbdcee"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4098, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}