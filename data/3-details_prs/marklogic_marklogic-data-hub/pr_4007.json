{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MDk0NTEw", "number": 4007, "title": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"OutputURI Replacement\" from HC", "bodyText": "Description\nAdd 'outputURIPrefix' in ingestion step, replace \"OutputURI Replacement\" from HC\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-05-27T20:22:38Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007", "merged": true, "mergeCommit": {"oid": "15e5156491cd7f445b99510f3871677bae8114d6"}, "closed": true, "closedAt": "2020-05-28T17:52:29Z", "author": {"login": "srinathgit"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclfcxlAFqTQxOTU4MzI1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABclxfzdAFqTQyMDM0NjA3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NTgzMjUz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#pullrequestreview-419583253", "createdAt": "2020-05-27T20:28:51Z", "commit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDoyODo1MVrOGbb8KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDozOToxMlrOGbcRJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyMjUwNA==", "bodyText": "Generally, I wouldn't bother with these assertions that verify that things were removed. Someone will wonder 6 months later - why is it important that we assert this? I think it's sufficient to just remove the feature.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431422504", "createdAt": "2020-05-27T20:28:51Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/ui/src/components/load-data/new-data-load-dialog/new-data-load-dialog.test.tsx", "diffHunk": "@@ -33,7 +33,16 @@ describe('New/edit load data configuration', () => {\n     expect(baseElement.querySelector('#otherSeparator')).not.toBeInTheDocument();\n     expect(baseElement.querySelector('#fileUpload')).toBeInTheDocument();\n     expect(baseElement.querySelector('#targetFormat')).toBeInTheDocument();\n-    expect(baseElement.querySelector('#outputUriReplacement')).toBeInTheDocument();\n+    expect(baseElement.querySelector('#outputUriReplacement')).not.toBeInTheDocument();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyMzY2OQ==", "bodyText": "Can this be setOutputUriPrefix instead of setOutUriPrefix? I am generally against any sort of abbreviations like this - same goes for \"src\" and \"tgt\" instead of \"source\" and \"target\". If this were a local variable in a function that's just a few lines long, I think extremely short abbreviations can work. But otherwise, we should use regular words, no need for abbreviations that can potentially confuse.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431423669", "createdAt": "2020-05-27T20:31:08Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/ui/src/components/load-data/new-data-load-dialog/new-data-load-dialog.tsx", "diffHunk": "@@ -14,20 +14,17 @@ const NewDataLoadDialog = (props) => {\n   const [inputFilePath, setInputFilePath] = useState(props.stepData && props.stepData.inputFilePath ? props.stepData.inputFilePath : '');\n   const [srcFormat, setSrcFormat] = useState(props.stepData && props.stepData != {} ? props.stepData.sourceFormat : 'json');\n   const [tgtFormat, setTgtFormat] = useState(props.stepData && props.stepData != {} ? props.stepData.targetFormat : 'json');\n-  const [outUriReplacement, setOutUriReplacement] = useState(props.stepData && props.stepData != {} ? props.stepData.outputURIReplacement : '');\n+  const [outUriPrefix, setOutUriPrefix] = useState(props.stepData && props.stepData != {} ? props.stepData.outputURIPrefix : '');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyNjUzMg==", "bodyText": "Can we do this in the loadData.sjs module instead? This endpoint should be as generic as possible; ideally, the step-type-specific logic is all in modules specific to a step type.\nLooks like validateArtifact would be a simple way to do it.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431426532", "createdAt": "2020-05-27T20:36:41Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/step/saveStep.sjs", "diffHunk": "@@ -35,7 +35,15 @@ let existingStep = fn.head(cts.search(cts.andQuery([\n \n if (existingStep) {\n   xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType} already exists, so will update`);\n-  let updatedStep = Object.assign(existingStep.toObject(), stepProperties);\n+  const isIngestionStep = \"ingestion\" === stepDefinitionType.toLowerCase() ? true : false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyNzA5MA==", "bodyText": "Won't WriteStepRunner throw this error? I think it's fine to just handle it in one place.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431427090", "createdAt": "2020-05-27T20:37:42Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/cli/client/CommandLineFlowInputs.java", "diffHunk": "@@ -111,10 +114,20 @@\n                 runFlowString.append(\"\\n\\t\\tInput File Path: \" + inputFilePath);\n                 fileLocations.put(\"inputFilePath\", inputFilePath);\n             }\n+\n+            if (outputURIPrefix != null) {\n+                if(outputURIReplacement != null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyNzg3OQ==", "bodyText": "Shouldn't outputURIReplacement be dropped here since both exist?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431427879", "createdAt": "2020-05-27T20:39:12Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/step/convertIngestionStep.sjs", "diffHunk": "@@ -70,6 +71,7 @@ assertions.push(\n   test.assertEqual(\"xml\", flowStep.fileLocations.inputFileType),\n   test.assertEqual(\"data-sets/CustomerLoadJSON\", flowStep.fileLocations.inputFilePath),\n   test.assertEqual(\".*CustomerLoadJSON,'/customer'\", flowStep.fileLocations.outputURIReplacement),\n+  test.assertEqual(\"/customer/\", flowStep.fileLocations.outputURIPrefix),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/e36705c2be4bb4ffa2f29036b4c69dc74eec84eb", "committedDate": "2020-05-27T20:21:49Z", "message": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"Output URI Replacement\" from HC"}, "afterCommit": {"oid": "5392094621773bbf2fb6b7f326295682c17528d4", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5392094621773bbf2fb6b7f326295682c17528d4", "committedDate": "2020-05-27T23:27:14Z", "message": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"Output URI Replacement\" from HC"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NzA1NTM5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#pullrequestreview-419705539", "createdAt": "2020-05-28T00:48:28Z", "commit": {"oid": "5392094621773bbf2fb6b7f326295682c17528d4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5392094621773bbf2fb6b7f326295682c17528d4", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5392094621773bbf2fb6b7f326295682c17528d4", "committedDate": "2020-05-27T23:27:14Z", "message": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"Output URI Replacement\" from HC"}, "afterCommit": {"oid": "5d0823de615442f93563e8cbb4f01f23a518e474", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5d0823de615442f93563e8cbb4f01f23a518e474", "committedDate": "2020-05-28T00:54:35Z", "message": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"Output URI Replacement\" from HC"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMDc1NTcw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#pullrequestreview-420075570", "createdAt": "2020-05-28T12:53:31Z", "commit": {"oid": "5d0823de615442f93563e8cbb4f01f23a518e474"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjo1MzozMlrOGbzrzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjo1NTozN1rOGbzw-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxMTUzMw==", "bodyText": "I think it'd be good to change these checks to use a StringUtils method - e.g. hasText, isNotEmpty - because if one has a value and the other just has \"\", we're fine with that.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431811533", "createdAt": "2020-05-28T12:53:32Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java", "diffHunk": "@@ -398,6 +400,10 @@ protected void loadStepRunnerParameters(){\n             this.withStopOnFailure(Boolean.parseBoolean(stepConfig.get(\"stopOnFailure\").toString()));\n         }\n \n+        if(outputURIPrefix != null && outputURIReplacement != null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0823de615442f93563e8cbb4f01f23a518e474"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxMjg1Nw==", "bodyText": "I frequently like to put logic like this into a protected method so that it can easily unit-tested. You can even pass in the \"osName\" so you can verify the windows-specific code while not on windows. I didn't check the test coverage of all the conditions in here, but it'd be really easy to get 100% coverage of it with unit tests that will of course run very quickly too (i.e. put them in a class that doesn't extend anything, as you don't need any of the HubTestBase plumbing).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431812857", "createdAt": "2020-05-28T12:55:37Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java", "diffHunk": "@@ -652,14 +658,24 @@ private RunStepResponse runIngester(RunStepResponse runStepResponse, Collection<\n     }\n \n     private void processCsv(JacksonHandle jacksonHandle, File file) {\n-        String uri = file.getParent();\n-        if(SystemUtils.OS_NAME.toLowerCase().contains(\"windows\")){\n-            uri = \"/\" + FilenameUtils.separatorsToUnix(StringUtils.replaceOnce(uri, \":\", \"\"));\n+        String uri;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0823de615442f93563e8cbb4f01f23a518e474"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4509ef903c799d0fb291254215151147fc149da6", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4509ef903c799d0fb291254215151147fc149da6", "committedDate": "2020-05-28T16:31:50Z", "message": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"Output URI Replacement\" from HC"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d0823de615442f93563e8cbb4f01f23a518e474", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5d0823de615442f93563e8cbb4f01f23a518e474", "committedDate": "2020-05-28T00:54:35Z", "message": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"Output URI Replacement\" from HC"}, "afterCommit": {"oid": "4509ef903c799d0fb291254215151147fc149da6", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4509ef903c799d0fb291254215151147fc149da6", "committedDate": "2020-05-28T16:31:50Z", "message": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"Output URI Replacement\" from HC"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMjk5Njcw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#pullrequestreview-420299670", "createdAt": "2020-05-28T16:42:12Z", "commit": {"oid": "4509ef903c799d0fb291254215151147fc149da6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMzQ2MDcw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#pullrequestreview-420346070", "createdAt": "2020-05-28T17:41:22Z", "commit": {"oid": "4509ef903c799d0fb291254215151147fc149da6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2961, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}