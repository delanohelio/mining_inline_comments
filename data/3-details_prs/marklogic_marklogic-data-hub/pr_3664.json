{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NDExNTc2", "number": 3664, "title": "DHFPROD-4337: Middle-tier support upload with various zip types & add\u2026", "bodyText": "\u2026 test cases\nBecause a project zip file can be archived with a top-level folder in which DHF project foldes/files reside. It seems not trivial to deal with the situation. Previous implementation did not consider the situation and assumed all the DHF project folder/files are zipped as top-level.\nhttps://project.marklogic.com/jira/browse/DHFPROD-4337", "createdAt": "2020-03-09T06:40:10Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664", "merged": true, "mergeCommit": {"oid": "594282454ae0c5ca1f9af319590545f58a943b73"}, "closed": true, "closedAt": "2020-03-10T20:07:02Z", "author": {"login": "hao1st"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcL4E4iAH2gAyMzg1NDExNTc2OjczMWVkNjViYzlhYTBkMGZmY2Q5YWQzODFlMzZkZjhhNjMwNmE2MzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMXPxYgFqTM3MjIzNzI0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "731ed65bc9aa0d0ffcd9ad381e36df8a6306a632", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/731ed65bc9aa0d0ffcd9ad381e36df8a6306a632", "committedDate": "2020-03-09T06:39:16Z", "message": "DHFPROD-4337: Middle-tier support upload with various zip types & add test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMTE2ODQz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#pullrequestreview-371116843", "createdAt": "2020-03-09T12:21:13Z", "commit": {"oid": "731ed65bc9aa0d0ffcd9ad381e36df8a6306a632"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMjoyMToxNFrOFzk1rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMjozNDoyNFrOFzlONA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYyNTI2Mw==", "bodyText": "Just use FileCopyUtils here instead:\nByteArraOutputStream out = new ByteArrayOutputStream();\nFileCopyUtils.copy(in, out);\nreturn new ByteArrayInputStream(out.toByteArray());", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r389625263", "createdAt": "2020-03-09T12:21:14Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/services/DataHubProjectUtils.java", "diffHunk": "@@ -140,4 +167,62 @@ public static void extractZipProject(HubProject project, InputStream in, UIDeplo\n         }\n         listener.onStatusChange(0, String.format(\"Completed extracting the uploaded zip project into (%s)\", currProjectDir.toFile().getAbsolutePath()));\n     }\n+\n+    private static InputStream toByteArrayInputStream(InputStream in) {\n+        if (in instanceof ByteArrayInputStream) {\n+            return in;\n+        }\n+        byte[] buff = new byte[8000];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "731ed65bc9aa0d0ffcd9ad381e36df8a6306a632"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYyNzc2Mw==", "bodyText": "It looks like TestHelper already has properties for test.adminUsername and test.adminPassword, so there's no need to do this - the line doesn't really make sense either, as we can safely assume there's an admin user with the admin role.\nAlso, to mirror similar methods in HubTestBase, call this \"runAsAdminUser\".", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r389627763", "createdAt": "2020-03-09T12:26:28Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/test/java/com/marklogic/hub/oneui/TestHelper.java", "diffHunk": "@@ -79,6 +79,12 @@ public void authenticateSession() {\n        hubConfig.setCredentials(environmentInfo, dataHubDeveloperUsername, dataHubDeveloperPassword);\n     }\n \n+    public void authenticateSessionAsAdmin() {\n+        createUser(\"admin\", \"admin\",\"admin\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "731ed65bc9aa0d0ffcd9ad381e36df8a6306a632"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzMTU0MA==", "bodyText": "I highly recommend unit tests to verify this functionality. There's a lot of code being added here, and the new test in EnvironmentControllerTest verifies it at an integration level. But if something goes wrong, it'll be difficult to debug because we don't have any unit tests verifying any of the new logic.\nLooking at what this method outputs, it's not clear to me what this method is doing. The name implies an \"archive folder\" is being returned, so I'm first wondering why a Path or File isn't returned. I also see \"return null\" at the bottom - what does that mean if that happens? Unit tests would both verify that this functionality works correctly and document the purposes of the method as well.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r389631540", "createdAt": "2020-03-09T12:34:24Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/main/java/com/marklogic/hub/oneui/services/DataHubProjectUtils.java", "diffHunk": "@@ -140,4 +167,62 @@ public static void extractZipProject(HubProject project, InputStream in, UIDeplo\n         }\n         listener.onStatusChange(0, String.format(\"Completed extracting the uploaded zip project into (%s)\", currProjectDir.toFile().getAbsolutePath()));\n     }\n+\n+    private static InputStream toByteArrayInputStream(InputStream in) {\n+        if (in instanceof ByteArrayInputStream) {\n+            return in;\n+        }\n+        byte[] buff = new byte[8000];\n+        int bytesRead = 0;\n+        ByteArrayOutputStream bao = new ByteArrayOutputStream();\n+        try {\n+            while ((bytesRead = in.read(buff)) != -1) {\n+                bao.write(buff, 0, bytesRead);\n+            }\n+        } catch (IOException e) {\n+            throw new RuntimeException(String.format(\"Failed to convert to ByteArrayInputStream due to (%s)\", e.getMessage()));\n+        }\n+        byte[] data = bao.toByteArray();\n+        ByteArrayInputStream bin = new ByteArrayInputStream(data);\n+        return bin;\n+    }\n+\n+    private static String getArchiveFolderOfZipFile(Path currProjectDir, InputStream in) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "731ed65bc9aa0d0ffcd9ad381e36df8a6306a632"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72ae01e46c47adf2e17aa08f3a0a315896b42e6c", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/72ae01e46c47adf2e17aa08f3a0a315896b42e6c", "committedDate": "2020-03-09T18:10:14Z", "message": "DHFPROD-4337: refactor & add unit test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTE1MTQ2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#pullrequestreview-372115146", "createdAt": "2020-03-10T16:24:12Z", "commit": {"oid": "72ae01e46c47adf2e17aa08f3a0a315896b42e6c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjAzMzMx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#pullrequestreview-372203331", "createdAt": "2020-03-10T18:11:35Z", "commit": {"oid": "72ae01e46c47adf2e17aa08f3a0a315896b42e6c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxODoxMTozNlrOF0bGlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxODoxMTozNlrOF0bGlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxNDMyNQ==", "bodyText": "Just make these methods protected - that's common for unit-testing purposes.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r390514325", "createdAt": "2020-03-10T18:11:36Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/test/java/com/marklogic/hub/oneui/services/DataHubProjectUtilsTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.marklogic.hub.oneui.services;\n+\n+import com.marklogic.hub.curation.controllers.EnvironmentControllerTest;\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.InputStream;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+public class DataHubProjectUtilsTest {\n+\n+    @Test\n+    public void testExtractZipFileWithoutArchiveFolder() throws Exception {\n+        File file = new File(EnvironmentControllerTest.class.getClassLoader().getResource(\"dhfWithoutArchiveFolder.zip\").getFile());\n+        FileInputStream input = new FileInputStream(file);\n+\n+        Method method = DataHubProjectUtils.class.getDeclaredMethod(\"toByteArrayInputStream\", InputStream.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72ae01e46c47adf2e17aa08f3a0a315896b42e6c"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "259e26dac7596e23b7eb5a53ed28ed87a3dc796f", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/259e26dac7596e23b7eb5a53ed28ed87a3dc796f", "committedDate": "2020-03-10T18:28:03Z", "message": "DHFPROD-4337: changed based on comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc1edf5c4a15db20706d04d9a12ae6dd03e900d", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/fdc1edf5c4a15db20706d04d9a12ae6dd03e900d", "committedDate": "2020-03-10T18:35:01Z", "message": "DHFPROD-4337: fix one test error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjMwMzYz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#pullrequestreview-372230363", "createdAt": "2020-03-10T18:48:45Z", "commit": {"oid": "fdc1edf5c4a15db20706d04d9a12ae6dd03e900d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjM3MjQw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#pullrequestreview-372237240", "createdAt": "2020-03-10T18:58:13Z", "commit": {"oid": "fdc1edf5c4a15db20706d04d9a12ae6dd03e900d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3139, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}