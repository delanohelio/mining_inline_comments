{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyOTAyNjAx", "number": 3567, "title": "DHFPROD-3865: Can now run a step via a Data Services endpoint", "bodyText": "Upgraded to Java Client 5.1.0 to use the Bulk IO API for testing. This required upgrading to ml-gradle 4.0, which supports Java Client 5.1 (3.x does not).\nExtracted reusable code from mlRunFlow.sjs into flow.sjs/findMatchingContent. This helps minimize the code in mlRunFlow.sjs (REST) and runSteps.sjs (DS).", "createdAt": "2020-02-10T01:27:11Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567", "merged": true, "mergeCommit": {"oid": "f5fdd0ab566aeb6404408e3173c0021afaec3949"}, "closed": true, "closedAt": "2020-02-12T19:41:56Z", "author": {"login": "rjrudin"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCy16KAFqTM1NTY1NTQ0Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDqK0UgFqTM1NzY2NDI2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NjU1NDQz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#pullrequestreview-355655443", "createdAt": "2020-02-10T01:28:04Z", "commit": {"oid": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMToyODowNFrOFnYWaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMToyODowNFrOFnYWaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzczNg==", "bodyText": "setSchemasPath was deprecated in ml-app-deployer 3.x and removed in 4.0 - this line of code was essentially having no impact, as the \"user schemas dir\" is src/main/ml-schemas, which is the default for ml-app-deployer (though it's better to use ml-config/databases/(db name)/schemas).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r376837736", "createdAt": "2020-02-10T01:28:04Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubConfigImpl.java", "diffHunk": "@@ -1947,8 +1947,6 @@ private void updateAppConfig(AppConfig config) {\n \n         initializeModulePaths(config);\n \n-        config.setSchemasPath(getUserSchemasDir().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NjU1NTA3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#pullrequestreview-355655507", "createdAt": "2020-02-10T01:28:35Z", "commit": {"oid": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMToyODozNlrOFnYWpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMToyODozNlrOFnYWpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzc5OQ==", "bodyText": "I deleted this because a) it wasn't being used anywhere, and b) it didn't work - \"this.hubUtils\" did not resolve.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r376837799", "createdAt": "2020-02-10T01:28:36Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -96,16 +96,6 @@ class Flow {\n     return docs;\n   }\n \n-  deleteFlow(flowName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0a85e43691c3c7be51315eef93e995f7dfecc50", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/e0a85e43691c3c7be51315eef93e995f7dfecc50", "committedDate": "2020-02-10T01:29:33Z", "message": "DHFPROD-3865: Can now run a step via a Data Services endpoint\n\nUpgraded to Java Client 5.1.0 to use the Bulk IO API for testing. This required upgrading to ml-gradle 4.0, which supports Java Client 5.1 (3.x does not). \n\nExtracted reusable code from mlRunFlow.sjs into flow.sjs/findMatchingContent. This helps minimize the code in mlRunFlow.sjs (REST) and runSteps.sjs (DS)."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de", "committedDate": "2020-02-10T01:26:15Z", "message": "DHFPROD-3865: Can now run a step via a Data Services endpoint\n\nUpgraded to Java Client 5.1.0 to use the Bulk IO API for testing. This required upgrading to ml-gradle 4.0, which supports Java Client 5.1 (3.x does not). \n\nExtracted reusable code from mlRunFlow.sjs into flow.sjs/findMatchingContent. This helps minimize the code in mlRunFlow.sjs (REST) and runSteps.sjs (DS)."}, "afterCommit": {"oid": "e0a85e43691c3c7be51315eef93e995f7dfecc50", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/e0a85e43691c3c7be51315eef93e995f7dfecc50", "committedDate": "2020-02-10T01:29:33Z", "message": "DHFPROD-3865: Can now run a step via a Data Services endpoint\n\nUpgraded to Java Client 5.1.0 to use the Bulk IO API for testing. This required upgrading to ml-gradle 4.0, which supports Java Client 5.1 (3.x does not). \n\nExtracted reusable code from mlRunFlow.sjs into flow.sjs/findMatchingContent. This helps minimize the code in mlRunFlow.sjs (REST) and runSteps.sjs (DS)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTEyNzAz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#pullrequestreview-356112703", "createdAt": "2020-02-10T17:11:11Z", "commit": {"oid": "e0a85e43691c3c7be51315eef93e995f7dfecc50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTczMzU1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#pullrequestreview-356173355", "createdAt": "2020-02-10T18:44:43Z", "commit": {"oid": "e0a85e43691c3c7be51315eef93e995f7dfecc50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxODo0NDo0M1rOFnxTFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxODo0NDo0M1rOFnxTFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0NjQ4NQ==", "bodyText": "query can be null at this point? If query and filterQuery are null, what will it happen? I guess we do not want to continue calling queryToContentDescriptorArray. Do we need to add some logs for debugging purpose?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r377246485", "createdAt": "2020-02-10T18:44:43Z", "author": {"login": "hao1st"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -140,6 +130,53 @@ class Flow {\n     }\n   }\n \n+  /**\n+   * Find records that match a query based on the given inputs. Each matching record is wrapped in a\n+   * \"content descriptor\" object that is guaranteed to have at least a \"uri\" property.\n+   *\n+   * @param flowName\n+   * @param stepNumber\n+   * @param options\n+   * @param filterQuery\n+   * @return {*}\n+   */\n+  findMatchingContent(flowName, stepNumber, options, filterQuery) {\n+    const flow = this.getFlow(flowName);\n+    const flowStep = flow.steps[stepNumber];\n+    const stepDetails = this.step.getStepByNameAndType(flowStep.stepDefinitionName, flowStep.stepDefinitionType);\n+    const combinedOptions = Object.assign({}, stepDetails.options || {}, flow.options || {}, flowStep.options || {}, options);\n+\n+    let query;\n+    let uris = null;\n+    if (options.uris) {\n+      uris = this.datahub.hubUtils.normalizeToArray(options.uris);\n+      query = cts.documentQuery(uris);\n+    } else {\n+      let sourceQuery = combinedOptions.sourceQuery || flow.sourceQuery;\n+      query = sourceQuery ? xdmp.eval(sourceQuery) : null;\n+    }\n+\n+    if (stepDetails.name === 'default-merging' && stepDetails.type === 'merging' && uris) {\n+      return uris.map((uri) => { return { uri }; });\n+    } else {\n+      let sourceDatabase = combinedOptions.sourceDatabase || this.globalContext.sourceDatabase;\n+      if (filterQuery) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0a85e43691c3c7be51315eef93e995f7dfecc50"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NjY0MjYw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#pullrequestreview-357664260", "createdAt": "2020-02-12T17:55:41Z", "commit": {"oid": "e0a85e43691c3c7be51315eef93e995f7dfecc50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3267, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}