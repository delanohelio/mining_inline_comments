{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNDg4NDcx", "number": 3622, "title": "DHFPROD-4285: Can now map multiple properties of the same entity type", "bodyText": "\"m:entity\" now refers to a unique property path instead of an entity type title.", "createdAt": "2020-02-28T16:56:13Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622", "merged": true, "mergeCommit": {"oid": "13448f4ecff21e2edb06fe7e47cb725a14079964"}, "closed": true, "closedAt": "2020-03-02T18:32:37Z", "author": {"login": "rjrudin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcI2HQ2gFqTM2NjY3MjAxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJxh_2gFqTM2NzQwMjcxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjcyMDEx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#pullrequestreview-366672011", "createdAt": "2020-02-28T20:40:17Z", "commit": {"oid": "9fe0bdb53fda0da1659c00e940c7255b3b704952"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2Nzc3OTE2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#pullrequestreview-366777916", "createdAt": "2020-02-29T05:05:01Z", "commit": {"oid": "9fe0bdb53fda0da1659c00e940c7255b3b704952"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NzgzMzY1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#pullrequestreview-366783365", "createdAt": "2020-02-29T07:26:53Z", "commit": {"oid": "9fe0bdb53fda0da1659c00e940c7255b3b704952"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQwNzoyNjo1NFrOFwIIkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQwNzoyNjo1NFrOFwIIkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAwOTIzNA==", "bodyText": "We have a failing test. null check required here.\ncom.marklogic.client.FailedRequestException: Local message: failed to apply resource at documents: Internal Server Error. Server Message: JS-JAVASCRIPT: Object.keys(mapping.properties).forEach(propertyTitle => { -- Error running JavaScript request: TypeError: Cannot convert undefined or null to object . See the MarkLogic server error log for further detail.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#discussion_r386009234", "createdAt": "2020-02-29T07:26:54Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/builtins/steps/mapping/entity-services/lib.sjs", "diffHunk": "@@ -141,16 +167,34 @@ function buildMapProperties(mapping, entityModel) {\n   return propertyLines.join('\\n');\n }\n \n-function getRelatedMappings(mapping, related = [mapping]) {\n-  // get references to sub mappings\n+/**\n+ * Recursive function that returns a mapping for each property with a targetEntityType, which signifies that it is\n+ * mapping to an object property. Each of these will need to be converted into an m:entity XML template. The name of\n+ * each template is guaranteed to be unique by being based on the propertyPath and the title of each object property\n+ * being mapped. This ensures that we have uniquely-named templates in the XSLT transform that's generated from the\n+ * XML mapping template.\n+ *\n+ * @param mapping\n+ * @param propertyPath\n+ * @param objectPropertyMappings\n+ * @return {*[]}\n+ */\n+function getObjectPropertyMappings(mapping, propertyPath, objectPropertyMappings = []) {\n   if (dhMappingTraceIsEnabled) {\n     xdmp.trace(dhMappingTrace, `Getting related mappings for '${xdmp.describe(mapping)}'`);\n   }\n-  let internalMappings = mapping.xpath('/properties//object-node()[exists(targetEntityType) and exists(properties)]');\n-  for (let internalMapping of internalMappings) {\n-    related.push(internalMapping);\n-  }\n-  return related;\n+  Object.keys(mapping.properties).forEach(propertyTitle => {\n+    const property = mapping.properties[propertyTitle];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fe0bdb53fda0da1659c00e940c7255b3b704952"}, "originalPosition": 165}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fe0bdb53fda0da1659c00e940c7255b3b704952", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9fe0bdb53fda0da1659c00e940c7255b3b704952", "committedDate": "2020-02-28T16:51:10Z", "message": "DHFPROD-4285: Can now map multiple properties of the same entity type\n\n\"m:entity\" now refers to a unique property path instead of an entity type title."}, "afterCommit": {"oid": "75c3d69524b98f78b12be35c8e824799e11f6f9b", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/75c3d69524b98f78b12be35c8e824799e11f6f9b", "committedDate": "2020-03-02T03:06:17Z", "message": "DHFPROD-4285: Can now map multiple properties of the same entity type\n\n\"m:entity\" now refers to a unique property path instead of an entity type title."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75c3d69524b98f78b12be35c8e824799e11f6f9b", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/75c3d69524b98f78b12be35c8e824799e11f6f9b", "committedDate": "2020-03-02T03:06:17Z", "message": "DHFPROD-4285: Can now map multiple properties of the same entity type\n\n\"m:entity\" now refers to a unique property path instead of an entity type title."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2OTY5MDc1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#pullrequestreview-366969075", "createdAt": "2020-03-02T06:17:29Z", "commit": {"oid": "75c3d69524b98f78b12be35c8e824799e11f6f9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NDAwNjI2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#pullrequestreview-367400626", "createdAt": "2020-03-02T17:50:54Z", "commit": {"oid": "75c3d69524b98f78b12be35c8e824799e11f6f9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NDAyNzE3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#pullrequestreview-367402717", "createdAt": "2020-03-02T17:53:53Z", "commit": {"oid": "75c3d69524b98f78b12be35c8e824799e11f6f9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2262, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}