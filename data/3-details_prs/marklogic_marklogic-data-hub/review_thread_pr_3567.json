{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyOTAyNjAx", "number": 3567, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMToyODowNFrODeUBAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxODo0NDo0M1rODekH0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTExODEwOnYy", "diffSide": "LEFT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubConfigImpl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMToyODowNFrOFnYWaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMTo1OToxN1rOFn3HhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzczNg==", "bodyText": "setSchemasPath was deprecated in ml-app-deployer 3.x and removed in 4.0 - this line of code was essentially having no impact, as the \"user schemas dir\" is src/main/ml-schemas, which is the default for ml-app-deployer (though it's better to use ml-config/databases/(db name)/schemas).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r376837736", "createdAt": "2020-02-10T01:28:04Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubConfigImpl.java", "diffHunk": "@@ -1947,8 +1947,6 @@ private void updateAppConfig(AppConfig config) {\n \n         initializeModulePaths(config);\n \n-        config.setSchemasPath(getUserSchemasDir().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2NTk4Ng==", "bodyText": "We might want to make sure we note the backwards dependency, as folks who were using the user schemas directory under older versions, will suddenly find their configs will not work when they upgrade.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r377265986", "createdAt": "2020-02-10T19:22:23Z", "author": {"login": "aebadirad"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubConfigImpl.java", "diffHunk": "@@ -1947,8 +1947,6 @@ private void updateAppConfig(AppConfig config) {\n \n         initializeModulePaths(config);\n \n-        config.setSchemasPath(getUserSchemasDir().toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzczNg=="}, "originalCommit": {"oid": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0MTgyOA==", "bodyText": "Looking at HubProjectImpl, getUserSchemasDir is set to src/main/ml-modules, and a user can't override that. That's also the default in ml-app-deployer. So that's why I say that line of code was having no impact.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r377341828", "createdAt": "2020-02-10T21:59:17Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubConfigImpl.java", "diffHunk": "@@ -1947,8 +1947,6 @@ private void updateAppConfig(AppConfig config) {\n \n         initializeModulePaths(config);\n \n-        config.setSchemasPath(getUserSchemasDir().toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzczNg=="}, "originalCommit": {"oid": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTExODU3OnYy", "diffSide": "LEFT", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMToyODozNlrOFnYWpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMjowMDoxN1rOFn3JbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzc5OQ==", "bodyText": "I deleted this because a) it wasn't being used anywhere, and b) it didn't work - \"this.hubUtils\" did not resolve.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r376837799", "createdAt": "2020-02-10T01:28:36Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -96,16 +96,6 @@ class Flow {\n     return docs;\n   }\n \n-  deleteFlow(flowName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI3MzA4MA==", "bodyText": "Should probably fix this or, comment it out/leave it and bug log it not remove it, as the new app is going to be atomicly changing things on the server instead of doing full reloads.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r377273080", "createdAt": "2020-02-10T19:36:19Z", "author": {"login": "aebadirad"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -96,16 +96,6 @@ class Flow {\n     return docs;\n   }\n \n-  deleteFlow(flowName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzc5OQ=="}, "originalCommit": {"oid": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0MjMxNw==", "bodyText": "I believe this is being handled now by artifacts/core.sjs", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r377342317", "createdAt": "2020-02-10T22:00:17Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -96,16 +96,6 @@ class Flow {\n     return docs;\n   }\n \n-  deleteFlow(flowName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzNzc5OQ=="}, "originalCommit": {"oid": "ae4788c1e5b57ddc4f4f77b5ca51cc0cfc4c81de"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMzc1Njk4OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxODo0NDo0M1rOFnxTFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxODo0NDo0M1rOFnxTFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI0NjQ4NQ==", "bodyText": "query can be null at this point? If query and filterQuery are null, what will it happen? I guess we do not want to continue calling queryToContentDescriptorArray. Do we need to add some logs for debugging purpose?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3567#discussion_r377246485", "createdAt": "2020-02-10T18:44:43Z", "author": {"login": "hao1st"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/flow.sjs", "diffHunk": "@@ -140,6 +130,53 @@ class Flow {\n     }\n   }\n \n+  /**\n+   * Find records that match a query based on the given inputs. Each matching record is wrapped in a\n+   * \"content descriptor\" object that is guaranteed to have at least a \"uri\" property.\n+   *\n+   * @param flowName\n+   * @param stepNumber\n+   * @param options\n+   * @param filterQuery\n+   * @return {*}\n+   */\n+  findMatchingContent(flowName, stepNumber, options, filterQuery) {\n+    const flow = this.getFlow(flowName);\n+    const flowStep = flow.steps[stepNumber];\n+    const stepDetails = this.step.getStepByNameAndType(flowStep.stepDefinitionName, flowStep.stepDefinitionType);\n+    const combinedOptions = Object.assign({}, stepDetails.options || {}, flow.options || {}, flowStep.options || {}, options);\n+\n+    let query;\n+    let uris = null;\n+    if (options.uris) {\n+      uris = this.datahub.hubUtils.normalizeToArray(options.uris);\n+      query = cts.documentQuery(uris);\n+    } else {\n+      let sourceQuery = combinedOptions.sourceQuery || flow.sourceQuery;\n+      query = sourceQuery ? xdmp.eval(sourceQuery) : null;\n+    }\n+\n+    if (stepDetails.name === 'default-merging' && stepDetails.type === 'merging' && uris) {\n+      return uris.map((uri) => { return { uri }; });\n+    } else {\n+      let sourceDatabase = combinedOptions.sourceDatabase || this.globalContext.sourceDatabase;\n+      if (filterQuery) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0a85e43691c3c7be51315eef93e995f7dfecc50"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3535, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}