{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzOTAxMDgy", "number": 4947, "title": "DHFPROD-6297: Add redaction privilege to roles", "bodyText": "Description\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-12-07T19:35:24Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947", "merged": true, "mergeCommit": {"oid": "2f566ffa6cf1e0df54fa05f4b7c378b4abba73f8"}, "closed": true, "closedAt": "2020-12-08T19:16:42Z", "author": {"login": "akshaysonvane"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj7W7xAFqTU0NjQ5MTk3NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkOy3GAFqTU0NzUzMDg3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NDkxOTc0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#pullrequestreview-546491974", "createdAt": "2020-12-07T20:02:48Z", "commit": {"oid": "5630b54965fad09c8cd830356f514e5d64e03122"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDowMjo0OVrOIA4V-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDoxMzo1N1rOIA4wWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5NDA0Mw==", "bodyText": "Let's put this in hub.security and call it RedactionUserTest for consistency with the other role test classes", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r537794043", "createdAt": "2020-12-07T20:02:49Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/RedactionTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.marklogic.hub.flow;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5630b54965fad09c8cd830356f514e5d64e03122"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwMDc5NA==", "bodyText": "Updated the message to reflect this JIRA story and 5.4.0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r537800794", "createdAt": "2020-12-07T20:13:57Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/security/DataHubSecurityAdminTest.java", "diffHunk": "@@ -97,7 +97,7 @@ void createCustomRoleInheritingCertainDataHubRoles() {\n         Role customRole = new Role(userWithRoleBeingTestedApi, roleName);\n         customRole.setRole(CreateGranularPrivilegesCommand.ROLES_THAT_CAN_BE_INHERITED);\n \n-        assertEquals(42, customRole.getRole().size(), \"As of DHFPROD-5753 in 5.3.0, 42 roles are expected to be \" +\n+        assertEquals(43, customRole.getRole().size(), \"As of DHFPROD-5753 in 5.3.0, 43 roles are expected to be \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5630b54965fad09c8cd830356f514e5d64e03122"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5630b54965fad09c8cd830356f514e5d64e03122", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5630b54965fad09c8cd830356f514e5d64e03122", "committedDate": "2020-12-07T19:32:44Z", "message": "DHFPROD-6297: Add redaction privilege to roles"}, "afterCommit": {"oid": "f6c99dbe147cb6f379cc6e8289b00dad669723ef", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/f6c99dbe147cb6f379cc6e8289b00dad669723ef", "committedDate": "2020-12-07T20:45:00Z", "message": "DHFPROD-6297: Add redaction privilege to roles"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6c99dbe147cb6f379cc6e8289b00dad669723ef", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/f6c99dbe147cb6f379cc6e8289b00dad669723ef", "committedDate": "2020-12-07T20:45:00Z", "message": "DHFPROD-6297: Add redaction privilege to roles"}, "afterCommit": {"oid": "431e2c88a5cca962f4cef9cda3a93d611c61da8f", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/431e2c88a5cca962f4cef9cda3a93d611c61da8f", "committedDate": "2020-12-07T22:32:44Z", "message": "DHFPROD-6297: Add redaction privilege to roles"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NjAzMzc4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#pullrequestreview-546603378", "createdAt": "2020-12-07T22:47:56Z", "commit": {"oid": "431e2c88a5cca962f4cef9cda3a93d611c61da8f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NjE0Nzg3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#pullrequestreview-546614787", "createdAt": "2020-12-07T23:09:46Z", "commit": {"oid": "431e2c88a5cca962f4cef9cda3a93d611c61da8f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzowOTo0NlrOIA--OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzoxMToxOVrOIA_A1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMjY0OA==", "bodyText": "You can remove this, the parent class defaults to this", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r537902648", "createdAt": "2020-12-07T23:09:46Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/security/RedactionUserTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.marklogic.hub.security;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.appdeployer.command.schemas.LoadSchemasCommand;\n+import com.marklogic.client.ResourceNotFoundException;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.JacksonHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.impl.FlowRunnerImpl;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.READ;\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.UPDATE;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class RedactionUserTest extends AbstractHubCoreTest {\n+\n+    @BeforeEach\n+    void setUp() {\n+        runAsDataHubDeveloper();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "431e2c88a5cca962f4cef9cda3a93d611c61da8f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMzMxNw==", "bodyText": "I think we still need to verify that the RunFlowResponse contains an error in stepOutput for the step that failed. It's good to verify that the doc wasn't written too, but the most important thing to verify is that the step failed, and the way to do that is via the RunFlowResponse.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r537903317", "createdAt": "2020-12-07T23:11:19Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/security/RedactionUserTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.marklogic.hub.security;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.appdeployer.command.schemas.LoadSchemasCommand;\n+import com.marklogic.client.ResourceNotFoundException;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.JacksonHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.impl.FlowRunnerImpl;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.READ;\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.UPDATE;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class RedactionUserTest extends AbstractHubCoreTest {\n+\n+    @BeforeEach\n+    void setUp() {\n+        runAsDataHubDeveloper();\n+        installProjectInFolder(\"test-projects/redaction-test\");\n+        new LoadSchemasCommand().execute(newCommandContext());\n+\n+        ingestDocument();\n+    }\n+\n+    @AfterEach\n+    void tearDown() {\n+        runAsAdmin();\n+        new DatabaseManager(getHubConfig().getManageClient()).clearDatabase(HubConfig.DEFAULT_STAGING_SCHEMAS_DB_NAME);\n+    }\n+\n+    @Test\n+    void testRedactionAsDataHubOperator() {\n+        runFlowAsUser(this::runAsDataHubOperator);\n+        verifyRedactedDoc();\n+    }\n+\n+    @Test\n+    void testRedactionAsHubCentralOperator() {\n+        runFlowAsUser(() -> runAsTestUserWithRoles(\"hub-central-operator\"));\n+        verifyRedactedDoc();\n+    }\n+\n+    @Test\n+    void testRedactionAsAForbiddenUser() {\n+        runFlowAsUser(() -> runAsTestUserWithRoles(\"hub-central-step-runner\"));\n+        verifyRedactedDocNotPresent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "431e2c88a5cca962f4cef9cda3a93d611c61da8f"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a405e23976563b66772f5ba978e943953b440802", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/a405e23976563b66772f5ba978e943953b440802", "committedDate": "2020-12-08T08:44:18Z", "message": "DHFPROD-6297: Add redaction privilege to roles"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "431e2c88a5cca962f4cef9cda3a93d611c61da8f", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/431e2c88a5cca962f4cef9cda3a93d611c61da8f", "committedDate": "2020-12-07T22:32:44Z", "message": "DHFPROD-6297: Add redaction privilege to roles"}, "afterCommit": {"oid": "a405e23976563b66772f5ba978e943953b440802", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/a405e23976563b66772f5ba978e943953b440802", "committedDate": "2020-12-08T08:44:18Z", "message": "DHFPROD-6297: Add redaction privilege to roles"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDUyMzA5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#pullrequestreview-547452309", "createdAt": "2020-12-08T17:16:13Z", "commit": {"oid": "a405e23976563b66772f5ba978e943953b440802"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDU1NDk1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#pullrequestreview-547455495", "createdAt": "2020-12-08T17:19:48Z", "commit": {"oid": "a405e23976563b66772f5ba978e943953b440802"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTE3ODMx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#pullrequestreview-547517831", "createdAt": "2020-12-08T18:36:36Z", "commit": {"oid": "a405e23976563b66772f5ba978e943953b440802"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODozNjozNlrOIBwAWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODozNjozNlrOIBwAWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODcwNjAxMQ==", "bodyText": "Per DHFPROD-6297, \"redaction-user\" should be assigned to \u201chub-central-entity-exporter\u201d which is inherited by hub-central-developer,  hub-central-operator & hub-central-explorer)", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r538706011", "createdAt": "2020-12-08T18:36:36Z", "author": {"login": "srinathgit"}, "path": "marklogic-data-hub/src/main/resources/hub-internal-config/security/roles/hub-central-operator.json", "diffHunk": "@@ -10,7 +10,8 @@\n     \"hub-central-custom-reader\",\n     \"hub-central-step-runner\",\n     \"hub-central-saved-query-user\",\n-    \"hub-central-entity-exporter\"\n+    \"hub-central-entity-exporter\",\n+    \"redaction-user\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a405e23976563b66772f5ba978e943953b440802"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTMwODc5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#pullrequestreview-547530879", "createdAt": "2020-12-08T18:52:44Z", "commit": {"oid": "a405e23976563b66772f5ba978e943953b440802"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1523, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}