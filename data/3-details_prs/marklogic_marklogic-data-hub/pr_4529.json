{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5MzQ1MjUz", "number": 4529, "title": "DHFPROD-5338: Bookmark redirect", "bodyText": "NOTE: This update addresses the behavior when running on port 8080. (A port 3000 dev setup already worked.)\nWhen a user is unauthorized and executes an internal browser bookmark or enters an internal URL in the browser bar:\nRedirect user to login page.\nInclude route as URL param to enable redirection.\nRedirect to that URL after login.\nIf the initial route is bad (e.g., /notavalidroute), the user sees a 404 page after login (as would be expected when redirecting to a bad route).\n@bsrikan I need to discuss relevant tests for this since this is reliant on server redirection (i.e., not React UI behavior).\nDescription\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-09-04T06:33:45Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529", "merged": true, "mergeCommit": {"oid": "56dc2ca60a23f1cd8190b01ad68aea610c02c8a7"}, "closed": true, "closedAt": "2020-09-09T22:17:19Z", "author": {"login": "wooldridge"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGlJw6AFqTQ4MzY0NjYzNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHTMUAgFqTQ4NTQyMDY2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjQ2NjM2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#pullrequestreview-483646636", "createdAt": "2020-09-07T15:57:56Z", "commit": {"oid": "5899c981dac988aba90cd95521388b57047124a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNTo1Nzo1NlrOHOD1Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNTo1Nzo1NlrOHOD1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNDg4Ng==", "bodyText": "noticed a lot of redirect requests for /websocket when running e2e. Filtering /websocket alongwith /api gets rid of the issue. Will probably push the changes after running some more e2e tests", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484504886", "createdAt": "2020-09-07T15:57:56Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/WebSecurityConfiguration.java", "diffHunk": "@@ -55,7 +59,13 @@ protected void configure(HttpSecurity http) throws Exception {\n             .addFilterAfter(new AuthenticationFilter(hubCentral, hubClientProvider), LogoutFilter.class)\n             .csrf().disable()\n             // Need to setStatus, sendError causes issues. see https://stackoverflow.com/a/34911131\n-            .exceptionHandling().authenticationEntryPoint(((request, response, authException) -> response.setStatus(HttpServletResponse.SC_UNAUTHORIZED)))\n+            .exceptionHandling().authenticationEntryPoint(((request, response, authException) -> {\n+                if (request.getRequestURI().startsWith(\"/api/\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5899c981dac988aba90cd95521388b57047124a3"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjQ2OTky", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#pullrequestreview-483646992", "createdAt": "2020-09-07T15:58:44Z", "commit": {"oid": "5899c981dac988aba90cd95521388b57047124a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNTo1ODo0NFrOHOD2Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNTo1ODo0NFrOHOD2Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNTE2Mw==", "bodyText": "location should probably be loc @wooldridge ?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484505163", "createdAt": "2020-09-07T15:58:44Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub-central/ui/src/App.tsx", "diffHunk": "@@ -41,6 +41,16 @@ const App: React.FC<Props> = ({history, location}) => {\n     )}/>\n   );\n \n+  const getPageRoute = (loc) => {\n+    if (loc.search && loc.search.startsWith(\"?from=\")) {\n+      return decodeURIComponent(loc.search.substring(6));\n+    } else if (location.pathname !== '/' && location.pathname !== '/noresponse') {\n+      return location.pathname", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5899c981dac988aba90cd95521388b57047124a3"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjU5NDQ4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#pullrequestreview-483659448", "createdAt": "2020-09-07T16:32:05Z", "commit": {"oid": "5899c981dac988aba90cd95521388b57047124a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjozMjowNVrOHOEgEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjozMjowNVrOHOEgEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNTg1OA==", "bodyText": "If bookmark url contains /tiles/explore/detail, authentication leads to 500 Internal Server Error, since docUri seems to be undefined: http://localhost:3000/api/entitySearch?docUri=undefined\nDetail component gets the uri from either location.state or from user preferences in LocalStorage. If the LocalStorage for the user doesnt include uri, we will get 500 Internal Server Error. Pinging @rahulvudutala  and @Sanjeevani19 for awarerness.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484515858", "createdAt": "2020-09-07T16:32:05Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub-central/ui/src/App.tsx", "diffHunk": "@@ -53,9 +63,8 @@ const App: React.FC<Props> = ({history, location}) => {\n     } else {\n       if (user.error.type !== '') {\n         history.push('/error');\n-      } else if (location.pathname !== '/' && location.pathname !== '/noresponse') {\n-        user.pageRoute = location.pathname;\n       }\n+      user.pageRoute = getPageRoute(location);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5899c981dac988aba90cd95521388b57047124a3"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5899c981dac988aba90cd95521388b57047124a3", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5899c981dac988aba90cd95521388b57047124a3", "committedDate": "2020-09-04T06:10:05Z", "message": "DHFPROD-5338: Handle internal bookmarks when unauthorized\n1. Redirect user to login\n2. Include route as URL param for redirection"}, "afterCommit": {"oid": "c513445113b7487884e5d5a1078653c220482084", "author": {"user": {"login": "bsrikan", "name": "Srikanth Balasubramanian"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c513445113b7487884e5d5a1078653c220482084", "committedDate": "2020-09-07T20:39:23Z", "message": "DHFPROD-5338: e2e test and minor redirect fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNzE3NjAy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#pullrequestreview-483717602", "createdAt": "2020-09-07T22:15:43Z", "commit": {"oid": "c513445113b7487884e5d5a1078653c220482084"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QyMjoxNTo0NFrOHOIMpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QyMjoxNTo0NFrOHOIMpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU3NjQyMg==", "bodyText": "Fixed this redirect on 404 to /tiles from /home for \"Back Home\" button", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r484576422", "createdAt": "2020-09-07T22:15:44Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub-central/ui/src/pages/noMatchRedirect.tsx", "diffHunk": "@@ -14,16 +14,16 @@ const NoMatchRedirect = ({history}) => {\n   }, []);\n \n   const backToHomePage = () => {\n-    return user.authenticated ? history.push('/home') : history.push('/');\n+    return user.authenticated ? history.push('/tiles') : history.push('/');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c513445113b7487884e5d5a1078653c220482084"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d1096b27c398a43533dfa7ff95003f7ee19edfa", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/1d1096b27c398a43533dfa7ff95003f7ee19edfa", "committedDate": "2020-09-09T21:06:14Z", "message": "DHFPROD-5338: Handle internal bookmarks when unauthorized\n1. Redirect user to login\n2. Include route as URL param for redirection\n\nDHFPROD-5338: e2e test and minor redirect fixes\n\nDHFPROD-5338: When Detail URI is undefined, redirect to Explore\n\nDHFPROD-5338: add unit test, updated e2e for login"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d39f7dad62424492d1fcdf2dac55da767b19b68", "author": {"user": {"login": "bsrikan", "name": "Srikanth Balasubramanian"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9d39f7dad62424492d1fcdf2dac55da767b19b68", "committedDate": "2020-09-09T21:03:02Z", "message": "DHFPROD-5338: add unit test, updated e2e for login"}, "afterCommit": {"oid": "1d1096b27c398a43533dfa7ff95003f7ee19edfa", "author": {"user": {"login": "ryanjdew", "name": "Ryan Dew"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/1d1096b27c398a43533dfa7ff95003f7ee19edfa", "committedDate": "2020-09-09T21:06:14Z", "message": "DHFPROD-5338: Handle internal bookmarks when unauthorized\n1. Redirect user to login\n2. Include route as URL param for redirection\n\nDHFPROD-5338: e2e test and minor redirect fixes\n\nDHFPROD-5338: When Detail URI is undefined, redirect to Explore\n\nDHFPROD-5338: add unit test, updated e2e for login"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDA1NDk1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#pullrequestreview-485405495", "createdAt": "2020-09-09T21:09:18Z", "commit": {"oid": "1d1096b27c398a43533dfa7ff95003f7ee19edfa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMTowOToxOFrOHPaZ9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMTowOToxOFrOHPaZ9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyMzMxOQ==", "bodyText": "@ryanjdew @brucean52 @wooldridge I made this change to mock user context, since an authenticated user will have /tiles as landing page route.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#discussion_r485923319", "createdAt": "2020-09-09T21:09:18Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub-central/ui/src/assets/mock-data/user-context-mock.ts", "diffHunk": "@@ -34,7 +34,7 @@ export const userAuthenticated: IUserContextInterface = Object.assign(defaultUse\n     error : {\n       type: ''\n     },\n-    pageRoute: '/',\n+    pageRoute: '/tiles',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d1096b27c398a43533dfa7ff95003f7ee19edfa"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDA5MTE3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#pullrequestreview-485409117", "createdAt": "2020-09-09T21:15:30Z", "commit": {"oid": "1d1096b27c398a43533dfa7ff95003f7ee19edfa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDE5NzU2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#pullrequestreview-485419756", "createdAt": "2020-09-09T21:34:45Z", "commit": {"oid": "1d1096b27c398a43533dfa7ff95003f7ee19edfa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDIwNjY5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4529#pullrequestreview-485420669", "createdAt": "2020-09-09T21:36:21Z", "commit": {"oid": "1d1096b27c398a43533dfa7ff95003f7ee19edfa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2220, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}