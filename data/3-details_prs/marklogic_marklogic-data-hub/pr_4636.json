{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0OTU5Mzk0", "number": 4636, "title": "DHFPROD-5950: Exploring curated entities from staging and final databases", "bodyText": "Description\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-09-29T16:31:26Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636", "merged": true, "mergeCommit": {"oid": "174bd322f1d7bdcb2da9bfa1910b7966dd672d8a"}, "closed": true, "closedAt": "2020-09-29T20:01:00Z", "author": {"login": "rahulvudutala"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNq6J3gFqTQ5ODY3OTI5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNtgoKgFqTQ5ODgyMDA4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4Njc5Mjk1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#pullrequestreview-498679295", "createdAt": "2020-09-29T16:37:47Z", "commit": {"oid": "6b7b4f06abc344053a8b987fd3ff812f5ece9a56"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NjgxMDQ4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#pullrequestreview-498681048", "createdAt": "2020-09-29T16:39:53Z", "commit": {"oid": "6b7b4f06abc344053a8b987fd3ff812f5ece9a56"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NjkzNjQ4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#pullrequestreview-498693648", "createdAt": "2020-09-29T16:55:31Z", "commit": {"oid": "6b7b4f06abc344053a8b987fd3ff812f5ece9a56"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNjo1NTozMVrOHZ4Dcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNjo1Nzo1NlrOHZ4JSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg5NDgzNQ==", "bodyText": "To ensure an NPE is never possible here, do \"staging\".equalsIgnoreCase(database)", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#discussion_r496894835", "createdAt": "2020-09-29T16:55:31Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/EntitySearchController.java", "diffHunk": "@@ -138,31 +138,40 @@ public JsonNode getFacetValuesRange(@RequestBody @ApiParam(hidden = true) JsonNo\n     @ResponseBody\n     @Secured(\"ROLE_exportEntityInstances\")\n     @ApiOperation(\"Returns CSV data\")\n-    public ResponseEntity<StreamingResponseBody> export(@RequestParam String queryDocument, @RequestParam String fileType, @RequestParam(required = false) Long limit, final HttpServletResponse response) {\n-        StreamingResponseBody stream = out -> {\n-            newEntitySearchManager().exportByQuery(new ObjectMapper().readTree(queryDocument), fileType, limit, out, response);\n-        };\n-\n+    public ResponseEntity<StreamingResponseBody> export(@RequestParam String queryDocument,\n+                                                        @RequestParam String fileType,\n+                                                        @RequestParam(required = false) Long limit,\n+                                                        final HttpServletResponse response,\n+                                                        @RequestParam(defaultValue = \"final\") String database) {\n+        StreamingResponseBody stream = out -> newEntitySearchManager(database).exportByQuery(new ObjectMapper().readTree(queryDocument), fileType, limit, out, response);\n         return ResponseEntity.ok(stream);\n     }\n \n     @RequestMapping(method = RequestMethod.GET, value = \"/export/query/{queryId}\")\n     @ResponseBody\n     @Secured(\"ROLE_exportEntityInstances\")\n     @ApiOperation(\"Returns CSV data\")\n-    public ResponseEntity<StreamingResponseBody> exportSavedQuery(@PathVariable String queryId, @RequestParam String fileType, @RequestParam(required = false) Long limit, final HttpServletResponse response) {\n-        StreamingResponseBody stream = out -> {\n-            newEntitySearchManager().exportById(queryId, fileType, limit, out, response);\n-        };\n-\n+    public ResponseEntity<StreamingResponseBody> exportSavedQuery(@PathVariable String queryId,\n+                                                                  @RequestParam String fileType,\n+                                                                  @RequestParam(required = false) Long limit,\n+                                                                  final HttpServletResponse response,\n+                                                                  @RequestParam(defaultValue = \"final\") String database) {\n+        StreamingResponseBody stream = out -> newEntitySearchManager(database).exportById(queryId, fileType, limit, out, response);\n         return ResponseEntity.ok(stream);\n     }\n \n-    private EntitySearchManager newEntitySearchManager() {\n-        return new EntitySearchManager(getHubClient());\n+    private EntitySearchManager newEntitySearchManager(String database) {\n+        return new EntitySearchManager(getHubClient(), database);\n     }\n \n     private EntitySearchService getEntitySearchService() {\n+        return getEntitySearchService(\"final\");\n+    }\n+\n+    private EntitySearchService getEntitySearchService(String database) {\n+        if(database.equalsIgnoreCase(\"staging\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7b4f06abc344053a8b987fd3ff812f5ece9a56"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg5NTIzNw==", "bodyText": "Same thing, \"staging\".equals", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#discussion_r496895237", "createdAt": "2020-09-29T16:56:09Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/entities/search/EntitySearchManager.java", "diffHunk": "@@ -79,17 +76,31 @@\n \n     public static String QUERY_OPTIONS = \"exp-final-entity-options\";\n     private static Map<String, FacetHandler> facetHandlerMap;\n-    private DatabaseClient finalDatabaseClient;\n+    private DatabaseClient databaseClient;\n+    private DatabaseClient savedQueryDatabaseClient;\n     private ModelManager modelManager;\n \n     public EntitySearchManager(HubClient hubClient) {\n-        this.finalDatabaseClient = hubClient.getFinalClient();\n+        this.databaseClient = hubClient.getFinalClient();\n+        this.modelManager = new ModelManager(hubClient);\n+        initializeFacetHandlerMap();\n+    }\n+\n+    public EntitySearchManager(HubClient hubClient, String database) {\n+        if(database.equalsIgnoreCase(\"staging\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7b4f06abc344053a8b987fd3ff812f5ece9a56"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg5NjMyOQ==", "bodyText": "The below variable has a really nice name, which raises the question of - what's this client used for? I think it'd be good to name this \"searchDatabaseClient\" or something similar to convey what this one is used for.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#discussion_r496896329", "createdAt": "2020-09-29T16:57:56Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/entities/search/EntitySearchManager.java", "diffHunk": "@@ -79,17 +76,31 @@\n \n     public static String QUERY_OPTIONS = \"exp-final-entity-options\";\n     private static Map<String, FacetHandler> facetHandlerMap;\n-    private DatabaseClient finalDatabaseClient;\n+    private DatabaseClient databaseClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7b4f06abc344053a8b987fd3ff812f5ece9a56"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89b7f7a9f132dcc7176ba08996699ccea9227957", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/89b7f7a9f132dcc7176ba08996699ccea9227957", "committedDate": "2020-09-29T17:20:33Z", "message": "DHFPROD-5950: Exploring curated entities from staging and final databases"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b7b4f06abc344053a8b987fd3ff812f5ece9a56", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6b7b4f06abc344053a8b987fd3ff812f5ece9a56", "committedDate": "2020-09-29T15:20:43Z", "message": "DHFPROD-5950: Exploring curated entities from staging and final databases"}, "afterCommit": {"oid": "89b7f7a9f132dcc7176ba08996699ccea9227957", "author": {"user": {"login": "rahulvudutala", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/89b7f7a9f132dcc7176ba08996699ccea9227957", "committedDate": "2020-09-29T17:20:33Z", "message": "DHFPROD-5950: Exploring curated entities from staging and final databases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NzY1ODU1", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#pullrequestreview-498765855", "createdAt": "2020-09-29T18:28:34Z", "commit": {"oid": "89b7f7a9f132dcc7176ba08996699ccea9227957"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NzcwNDgz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#pullrequestreview-498770483", "createdAt": "2020-09-29T18:35:03Z", "commit": {"oid": "89b7f7a9f132dcc7176ba08996699ccea9227957"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NzcxMTEz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#pullrequestreview-498771113", "createdAt": "2020-09-29T18:35:56Z", "commit": {"oid": "89b7f7a9f132dcc7176ba08996699ccea9227957"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4ODIwMDgz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#pullrequestreview-498820083", "createdAt": "2020-09-29T19:39:37Z", "commit": {"oid": "89b7f7a9f132dcc7176ba08996699ccea9227957"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1900, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}