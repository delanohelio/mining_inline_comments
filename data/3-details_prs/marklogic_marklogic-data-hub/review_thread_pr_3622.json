{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNDg4NDcx", "number": 3622, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQwNzoyNjo1NFrODkAhuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQwNzoyNjo1NFrODkAhuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5MDgzOTYzOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/builtins/steps/mapping/entity-services/lib.sjs", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQwNzoyNjo1NFrOFwIIkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwNjoxNTowMVrOFwUiKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAwOTIzNA==", "bodyText": "We have a failing test. null check required here.\ncom.marklogic.client.FailedRequestException: Local message: failed to apply resource at documents: Internal Server Error. Server Message: JS-JAVASCRIPT: Object.keys(mapping.properties).forEach(propertyTitle => { -- Error running JavaScript request: TypeError: Cannot convert undefined or null to object . See the MarkLogic server error log for further detail.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#discussion_r386009234", "createdAt": "2020-02-29T07:26:54Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/builtins/steps/mapping/entity-services/lib.sjs", "diffHunk": "@@ -141,16 +167,34 @@ function buildMapProperties(mapping, entityModel) {\n   return propertyLines.join('\\n');\n }\n \n-function getRelatedMappings(mapping, related = [mapping]) {\n-  // get references to sub mappings\n+/**\n+ * Recursive function that returns a mapping for each property with a targetEntityType, which signifies that it is\n+ * mapping to an object property. Each of these will need to be converted into an m:entity XML template. The name of\n+ * each template is guaranteed to be unique by being based on the propertyPath and the title of each object property\n+ * being mapped. This ensures that we have uniquely-named templates in the XSLT transform that's generated from the\n+ * XML mapping template.\n+ *\n+ * @param mapping\n+ * @param propertyPath\n+ * @param objectPropertyMappings\n+ * @return {*[]}\n+ */\n+function getObjectPropertyMappings(mapping, propertyPath, objectPropertyMappings = []) {\n   if (dhMappingTraceIsEnabled) {\n     xdmp.trace(dhMappingTrace, `Getting related mappings for '${xdmp.describe(mapping)}'`);\n   }\n-  let internalMappings = mapping.xpath('/properties//object-node()[exists(targetEntityType) and exists(properties)]');\n-  for (let internalMapping of internalMappings) {\n-    related.push(internalMapping);\n-  }\n-  return related;\n+  Object.keys(mapping.properties).forEach(propertyTitle => {\n+    const property = mapping.properties[propertyTitle];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fe0bdb53fda0da1659c00e940c7255b3b704952"}, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE3ODM4OQ==", "bodyText": "I'll fix it, but it's really due to an invalid test file - that test is generating a mapping file with \"null\" as the value of \"properties\", which doesn't make any sense.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#discussion_r386178389", "createdAt": "2020-03-02T02:59:31Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/builtins/steps/mapping/entity-services/lib.sjs", "diffHunk": "@@ -141,16 +167,34 @@ function buildMapProperties(mapping, entityModel) {\n   return propertyLines.join('\\n');\n }\n \n-function getRelatedMappings(mapping, related = [mapping]) {\n-  // get references to sub mappings\n+/**\n+ * Recursive function that returns a mapping for each property with a targetEntityType, which signifies that it is\n+ * mapping to an object property. Each of these will need to be converted into an m:entity XML template. The name of\n+ * each template is guaranteed to be unique by being based on the propertyPath and the title of each object property\n+ * being mapped. This ensures that we have uniquely-named templates in the XSLT transform that's generated from the\n+ * XML mapping template.\n+ *\n+ * @param mapping\n+ * @param propertyPath\n+ * @param objectPropertyMappings\n+ * @return {*[]}\n+ */\n+function getObjectPropertyMappings(mapping, propertyPath, objectPropertyMappings = []) {\n   if (dhMappingTraceIsEnabled) {\n     xdmp.trace(dhMappingTrace, `Getting related mappings for '${xdmp.describe(mapping)}'`);\n   }\n-  let internalMappings = mapping.xpath('/properties//object-node()[exists(targetEntityType) and exists(properties)]');\n-  for (let internalMapping of internalMappings) {\n-    related.push(internalMapping);\n-  }\n-  return related;\n+  Object.keys(mapping.properties).forEach(propertyTitle => {\n+    const property = mapping.properties[propertyTitle];", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAwOTIzNA=="}, "originalCommit": {"oid": "9fe0bdb53fda0da1659c00e940c7255b3b704952"}, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIxMjM5NA==", "bodyText": "True that about the mapping file in the test. When a mapping step is created a version 0 file has similar structure ie no properties.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3622#discussion_r386212394", "createdAt": "2020-03-02T06:15:01Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/builtins/steps/mapping/entity-services/lib.sjs", "diffHunk": "@@ -141,16 +167,34 @@ function buildMapProperties(mapping, entityModel) {\n   return propertyLines.join('\\n');\n }\n \n-function getRelatedMappings(mapping, related = [mapping]) {\n-  // get references to sub mappings\n+/**\n+ * Recursive function that returns a mapping for each property with a targetEntityType, which signifies that it is\n+ * mapping to an object property. Each of these will need to be converted into an m:entity XML template. The name of\n+ * each template is guaranteed to be unique by being based on the propertyPath and the title of each object property\n+ * being mapped. This ensures that we have uniquely-named templates in the XSLT transform that's generated from the\n+ * XML mapping template.\n+ *\n+ * @param mapping\n+ * @param propertyPath\n+ * @param objectPropertyMappings\n+ * @return {*[]}\n+ */\n+function getObjectPropertyMappings(mapping, propertyPath, objectPropertyMappings = []) {\n   if (dhMappingTraceIsEnabled) {\n     xdmp.trace(dhMappingTrace, `Getting related mappings for '${xdmp.describe(mapping)}'`);\n   }\n-  let internalMappings = mapping.xpath('/properties//object-node()[exists(targetEntityType) and exists(properties)]');\n-  for (let internalMapping of internalMappings) {\n-    related.push(internalMapping);\n-  }\n-  return related;\n+  Object.keys(mapping.properties).forEach(propertyTitle => {\n+    const property = mapping.properties[propertyTitle];", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAwOTIzNA=="}, "originalCommit": {"oid": "9fe0bdb53fda0da1659c00e940c7255b3b704952"}, "originalPosition": 165}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3573, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}