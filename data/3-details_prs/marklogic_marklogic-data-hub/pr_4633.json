{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0Mzc0NTIy", "number": 4633, "title": "DHFPROD-5944: Configure Document Ingestion via connector", "bodyText": "Description\nConfigure Document Ingestion, sets the permissions, collections and sources of the document configured through options from Spark\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-09-28T20:10:33Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633", "merged": true, "mergeCommit": {"oid": "aabcd7e355847e4be3556604ef176065bbc64363"}, "closed": true, "closedAt": "2020-10-05T21:32:14Z", "author": {"login": "SameeraPriyathamTadikonda"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNZeuLAFqTQ5Nzg2MTk3OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPp08RAFqTUwMjM5NzEyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODYxOTc4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#pullrequestreview-497861978", "createdAt": "2020-09-28T20:14:12Z", "commit": {"oid": "1ab74fa3d1727d1de9bc63bb967cb483d696e959"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMDoxNDoxMlrOHZOAKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMDoxODo0MVrOHZOIcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwNTg2NQ==", "bodyText": "I don't think it's safe to write all of the params as a JSON object, as that could contain the user password and other sensitive information.\nWe should be much more precise about what goes into workUnit. So we should have a method of e.g. \"ObjectNode buildWorkUnitFromParams(Map)\" that builds an ObjectNode based on the params we know may exist in the Map, and nothing more than that.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r496205865", "createdAt": "2020-09-28T20:14:12Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/writer/HubDataWriter.java", "diffHunk": "@@ -61,7 +62,15 @@ public HubDataWriter(HubClient hubClient, long taskId, StructType schema, Map<St\n             hubClient.getModulesClient().newTextDocumentManager().read(apiModulePath, new StringHandle())\n         ).bulkCaller();\n \n-        loader.setWorkUnit(new ByteArrayInputStream((\"{\\\"taskId\\\":\" + taskId + \"}\").getBytes()));\n+        String workUnit = \"{\\\"taskId\\\":\" + taskId + \"}\";\n+        ObjectMapper objectMapper = new ObjectMapper();\n+        try {\n+            workUnit = workUnit.concat(objectMapper.writeValueAsString(params));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ab74fa3d1727d1de9bc63bb967cb483d696e959"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwNjM3OA==", "bodyText": "See my comment to @anu3990  about an Options class that will simplify writing tests, as opposed to building a Map. We will likely have many tests that populate different sets of options. The Options class will handle that for us.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r496206378", "createdAt": "2020-09-28T20:15:14Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/WriteDataTest.java", "diffHunk": "@@ -86,9 +86,13 @@ public void testBulkIngestWithoutUriPrefix() throws IOException {\n         Map<String, String> params = getHubPropertiesAsMap();\n         params.put(\"batchsize\", batchSize);\n \n-        if(uriPrefix!=null && uriPrefix.length()!=0) {\n+        if (uriPrefix != null && uriPrefix.length() != 0) {\n             params.put(\"uriprefix\", uriPrefix);\n         }\n+        params.put(\"collections\", \"fruits,gluefruits\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ab74fa3d1727d1de9bc63bb967cb483d696e959"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwNjY2Mw==", "bodyText": "No need for xdmp.log here, the stacktrace from the fn.error will be visible in the logs", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r496206663", "createdAt": "2020-09-28T20:15:48Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/ingestion/bulkIngester.sjs", "diffHunk": "@@ -29,6 +29,29 @@ const consts = require('/data-hub/5/impl/consts.sjs');\n const state = fn.head(xdmp.fromJSON(endpointState));\n \n const work = fn.head(xdmp.fromJSON(workUnit));\n+let collections=[];\n+if(work.collections !=null){\n+  collections=work.collections.split(',');\n+}\n+\n+const permissionsArray = []\n+\n+if(!work.permissions){\n+  work.permissions='data-hub-common,read,data-hub-common,update'\n+}\n+\n+const permissions = work.permissions.split(',');\n+\n+if((permissions.length%2)!= 0){\n+  xdmp.log(\"Error: Unable to parse Permissions\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ab74fa3d1727d1de9bc63bb967cb483d696e959"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwNjg5Ng==", "bodyText": "Use ds-utils.sjs - that has helper functions in it to simplify this - e.g. throwBadRequest would be appropriate here.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r496206896", "createdAt": "2020-09-28T20:16:21Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/ingestion/bulkIngester.sjs", "diffHunk": "@@ -29,6 +29,29 @@ const consts = require('/data-hub/5/impl/consts.sjs');\n const state = fn.head(xdmp.fromJSON(endpointState));\n \n const work = fn.head(xdmp.fromJSON(workUnit));\n+let collections=[];\n+if(work.collections !=null){\n+  collections=work.collections.split(',');\n+}\n+\n+const permissionsArray = []\n+\n+if(!work.permissions){\n+  work.permissions='data-hub-common,read,data-hub-common,update'\n+}\n+\n+const permissions = work.permissions.split(',');\n+\n+if((permissions.length%2)!= 0){\n+  xdmp.log(\"Error: Unable to parse Permissions\")\n+  fn.error(null, \"RESTAPI-SRVEXERR\", Sequence.from([400, \"Illegal Argument Exception\", \"Unable to parse permissions string, which must be a comma-separated list of role names and capabilities - i.e. role1,read,role2,update,role3,execute; string:\" + permissions]));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ab74fa3d1727d1de9bc63bb967cb483d696e959"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwNzE0NQ==", "bodyText": "Use hub-utils.parsePermissions", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r496207145", "createdAt": "2020-09-28T20:16:54Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/ingestion/bulkIngester.sjs", "diffHunk": "@@ -29,6 +29,29 @@ const consts = require('/data-hub/5/impl/consts.sjs');\n const state = fn.head(xdmp.fromJSON(endpointState));\n \n const work = fn.head(xdmp.fromJSON(workUnit));\n+let collections=[];\n+if(work.collections !=null){\n+  collections=work.collections.split(',');\n+}\n+\n+const permissionsArray = []\n+\n+if(!work.permissions){\n+  work.permissions='data-hub-common,read,data-hub-common,update'\n+}\n+\n+const permissions = work.permissions.split(',');\n+\n+if((permissions.length%2)!= 0){\n+  xdmp.log(\"Error: Unable to parse Permissions\")\n+  fn.error(null, \"RESTAPI-SRVEXERR\", Sequence.from([400, \"Illegal Argument Exception\", \"Unable to parse permissions string, which must be a comma-separated list of role names and capabilities - i.e. role1,read,role2,update,role3,execute; string:\" + permissions]));\n+}\n+\n+for(let i=0;i<permissions.length;i+=2){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ab74fa3d1727d1de9bc63bb967cb483d696e959"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwNzQ3Mw==", "bodyText": "We only want to add a source object if at least one of these is set. So you should add a test that verifies that when neither sourcename nor sourcetype is provided, then the sources array does not exist.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r496207473", "createdAt": "2020-09-28T20:17:35Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/ingestion/bulkIngester.sjs", "diffHunk": "@@ -38,16 +61,23 @@ inputs.forEach(record => {\n   state.next = state.next + 1;\n   const uri = (state.uriprefix) +  sem.uuidString() + '.json';\n   record = ingest.main({uri: uri, value: record}, {\n-    outputFormat: consts.JSON, headers: {createdOn: consts.CURRENT_DATE_TIME, createdBy: consts.CURRENT_USER}\n+    outputFormat: consts.JSON,\n+                  headers: {\n+                      createdOn: consts.CURRENT_DATE_TIME,\n+                      createdBy: consts.CURRENT_USER,\n+                      sources: [\n+                        { name: work.sourcename,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ab74fa3d1727d1de9bc63bb967cb483d696e959"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIwNzk4NA==", "bodyText": "We need a test verifying that it's okay if permissions is not, then the documents will be added with no permissions. You'll need to use \"runAsAdmin\" after ingesting the data to verify that the documents exist.\nWe can't force Ernie to specify permissions, he's free to insert documents without any permissions.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r496207984", "createdAt": "2020-09-28T20:18:41Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/ingestion/bulkIngester.sjs", "diffHunk": "@@ -29,6 +29,29 @@ const consts = require('/data-hub/5/impl/consts.sjs');\n const state = fn.head(xdmp.fromJSON(endpointState));\n \n const work = fn.head(xdmp.fromJSON(workUnit));\n+let collections=[];\n+if(work.collections !=null){\n+  collections=work.collections.split(',');\n+}\n+\n+const permissionsArray = []\n+\n+if(!work.permissions){\n+  work.permissions='data-hub-common,read,data-hub-common,update'\n+}\n+\n+const permissions = work.permissions.split(',');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ab74fa3d1727d1de9bc63bb967cb483d696e959"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ab74fa3d1727d1de9bc63bb967cb483d696e959", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/1ab74fa3d1727d1de9bc63bb967cb483d696e959", "committedDate": "2020-09-28T20:01:59Z", "message": "DHFPROD-5944: Configure Document Ingestion via connector"}, "afterCommit": {"oid": "6374bde59eb128b8dbdd80aa70068b0c0d6f98bf", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6374bde59eb128b8dbdd80aa70068b0c0d6f98bf", "committedDate": "2020-10-02T18:50:28Z", "message": "DHFPROD-5944: Configure Document Ingestion via connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNDAxMzEy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#pullrequestreview-501401312", "createdAt": "2020-10-02T19:40:58Z", "commit": {"oid": "6374bde59eb128b8dbdd80aa70068b0c0d6f98bf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxOTo0MDo1OFrOHb5iXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxOTo0NTozMVrOHb5pjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxNjI4NA==", "bodyText": "uriprefix should go into buildWorkUnitFromParams. Also, I'd just call that \"buildDefaultWorkUnit\" - it's clear that it's built from params because that's the sole argument.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r499016284", "createdAt": "2020-10-02T19:40:58Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/writer/HubDataWriter.java", "diffHunk": "@@ -151,11 +151,28 @@ protected JsonNode determineIngestionEndpointParams(Map<String, String> params)\n         }\n \n         if (!endpointParams.hasNonNull(\"workUnit\")) {\n-            ObjectNode defaultWorkUnit = objectMapper.createObjectNode();\n-            defaultWorkUnit.put(\"uriprefix\", params.get(\"uriprefix\")!=null ? params.get(\"uriprefix\"):\"\");\n+            defaultWorkUnit = objectMapper.createObjectNode();\n+            defaultWorkUnit.put(\"uriprefix\", params.get(\"uriprefix\") != null ? params.get(\"uriprefix\") : \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6374bde59eb128b8dbdd80aa70068b0c0d6f98bf"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxNjk3Mw==", "bodyText": "A more succinct approach with Jackson is to use \"has\":\nif (params.has(\"collections\"))\n\nAlso, all 4 conditionals are the same, so you could simplify this like so:\nStream.of(\"collections\", \"permissions\", \"sourcename\", \"sourcetype\", \"uriprefix\").forEach(key -> {\n  if (params.containsKey(key)) {\n    defaultWorkUnit.put(key, params.get(key));\n  }\n}\n\nThe one downside is we have to use the lower-casing that Spark requires. I think we can live with that for now though.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r499016973", "createdAt": "2020-10-02T19:42:41Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/writer/HubDataWriter.java", "diffHunk": "@@ -151,11 +151,28 @@ protected JsonNode determineIngestionEndpointParams(Map<String, String> params)\n         }\n \n         if (!endpointParams.hasNonNull(\"workUnit\")) {\n-            ObjectNode defaultWorkUnit = objectMapper.createObjectNode();\n-            defaultWorkUnit.put(\"uriprefix\", params.get(\"uriprefix\")!=null ? params.get(\"uriprefix\"):\"\");\n+            defaultWorkUnit = objectMapper.createObjectNode();\n+            defaultWorkUnit.put(\"uriprefix\", params.get(\"uriprefix\") != null ? params.get(\"uriprefix\") : \"\");\n+            buildWorkUnitFromParams(params);\n             endpointParams.set(\"workUnit\", defaultWorkUnit);\n         }\n \n         return endpointParams;\n     }\n+\n+    protected void buildWorkUnitFromParams(Map<String, String> params) {\n+        if (params.get(\"collections\") != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6374bde59eb128b8dbdd80aa70068b0c0d6f98bf"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAxODEyNg==", "bodyText": "Put \"Test\" as a suffix on this class name, that's our convention for every test class.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r499018126", "createdAt": "2020-10-02T19:45:31Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/WriteDataWithOptions.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.marklogic.hub.spark.sql.sources.v2;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.client.ext.util.DefaultDocumentPermissionsParser;\n+import com.marklogic.client.ext.util.DocumentPermissionsParser;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.JacksonHandle;\n+import org.apache.spark.sql.catalyst.InternalRow;\n+import org.apache.spark.sql.sources.v2.writer.DataWriter;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.IOException;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class WriteDataWithOptions extends AbstractSparkConnectorTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6374bde59eb128b8dbdd80aa70068b0c0d6f98bf"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6374bde59eb128b8dbdd80aa70068b0c0d6f98bf", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6374bde59eb128b8dbdd80aa70068b0c0d6f98bf", "committedDate": "2020-10-02T18:50:28Z", "message": "DHFPROD-5944: Configure Document Ingestion via connector"}, "afterCommit": {"oid": "410088ee47dbd98710c389893448d1f1b40e33bb", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/410088ee47dbd98710c389893448d1f1b40e33bb", "committedDate": "2020-10-02T20:19:01Z", "message": "DHFPROD-5944: Configure Document Ingestion via connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMTA5NjIw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#pullrequestreview-502109620", "createdAt": "2020-10-05T14:24:00Z", "commit": {"oid": "410088ee47dbd98710c389893448d1f1b40e33bb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDoyNDowMFrOHcfcqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDo1MjozNlrOHcgx6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzNzQxNw==", "bodyText": "The endpoint should do this, not the connector. The endpoint should say - if uriprefix is in the workUnit, then I'll use that, even if it's null. It's up to the client to pass in the correct value for uriprefix - if the client passes in \"uriprefix\": null, then the endpoint says - Well I guess you want null as the prefix, so I'll use that.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r499637417", "createdAt": "2020-10-05T14:24:00Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/writer/HubDataWriter.java", "diffHunk": "@@ -151,11 +151,22 @@ protected JsonNode determineIngestionEndpointParams(Map<String, String> params)\n         }\n \n         if (!endpointParams.hasNonNull(\"workUnit\")) {\n-            ObjectNode defaultWorkUnit = objectMapper.createObjectNode();\n-            defaultWorkUnit.put(\"uriprefix\", params.get(\"uriprefix\")!=null ? params.get(\"uriprefix\"):\"\");\n+            defaultWorkUnit = objectMapper.createObjectNode();\n+            if (params.get(\"uriprefix\") == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "410088ee47dbd98710c389893448d1f1b40e33bb"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzNzgzNQ==", "bodyText": "This test should verify that two collections work, so e.g. \"fruits,stuff\".", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r499637835", "createdAt": "2020-10-05T14:24:32Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/WriteDataWithOptionsTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.marklogic.hub.spark.sql.sources.v2;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.client.ext.util.DefaultDocumentPermissionsParser;\n+import com.marklogic.client.ext.util.DocumentPermissionsParser;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.JacksonHandle;\n+import org.apache.spark.sql.catalyst.InternalRow;\n+import org.apache.spark.sql.sources.v2.writer.DataWriter;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.IOException;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class WriteDataWithOptionsTest extends AbstractSparkConnectorTest {\n+\n+    @Test\n+    void ingestDocsWithCollection() throws IOException {\n+        String collections = \"fruits\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "410088ee47dbd98710c389893448d1f1b40e33bb"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0MzcxNg==", "bodyText": "Let's not specify a uriprefix here, as the scope of this test is to verify the collections.\nSo instead of doing a uriMatch query, do a cts.uris(null, null, cts.collectionQuery('fruits')). And I recommend getting the value back as a string, and then splitting that into an array based on the newline symbol:\nString[] uris = getHubClient().getStagingClient().newServerEval().javascript(\"cts.uris(null, null, cts.collectionQuery('fruits'))\").evalAs(String.class).split(\"\\n\");\n        assertEquals(1, uris.length);\n        DocumentMetadataHandle metadata = getHubClient().getStagingClient().newDocumentManager().readMetadata(uris[0], new DocumentMetadataHandle());\n        assertEquals(2, metadata.getCollections().size());\n        assertTrue(metadata.getCollections().contains(\"fruits\"));\n        assertTrue(metadata.getCollections().contains(\"stuff\"));", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r499643716", "createdAt": "2020-10-05T14:32:12Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/WriteDataWithOptionsTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.marklogic.hub.spark.sql.sources.v2;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.client.ext.util.DefaultDocumentPermissionsParser;\n+import com.marklogic.client.ext.util.DocumentPermissionsParser;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.JacksonHandle;\n+import org.apache.spark.sql.catalyst.InternalRow;\n+import org.apache.spark.sql.sources.v2.writer.DataWriter;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.IOException;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class WriteDataWithOptionsTest extends AbstractSparkConnectorTest {\n+\n+    @Test\n+    void ingestDocsWithCollection() throws IOException {\n+        String collections = \"fruits\";\n+        DataWriter<InternalRow> dataWriter = buildDataWriter(new Options(getHubPropertiesAsMap()).withBatchSize(1).withUriPrefix(\"/testFruit\").withCollections(collections));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "410088ee47dbd98710c389893448d1f1b40e33bb"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY1NDc0MA==", "bodyText": "There's a lot of duplication across these 4 tests - I'm going to submit a PR to yours to resolve that.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r499654740", "createdAt": "2020-10-05T14:46:45Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/WriteDataWithOptionsTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.marklogic.hub.spark.sql.sources.v2;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.client.ext.util.DefaultDocumentPermissionsParser;\n+import com.marklogic.client.ext.util.DocumentPermissionsParser;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.JacksonHandle;\n+import org.apache.spark.sql.catalyst.InternalRow;\n+import org.apache.spark.sql.sources.v2.writer.DataWriter;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.IOException;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class WriteDataWithOptionsTest extends AbstractSparkConnectorTest {\n+\n+    @Test\n+    void ingestDocsWithCollection() throws IOException {\n+        String collections = \"fruits\";\n+        DataWriter<InternalRow> dataWriter = buildDataWriter(new Options(getHubPropertiesAsMap()).withBatchSize(1).withUriPrefix(\"/testFruit\").withCollections(collections));\n+        dataWriter.write(buildRow(\"pineapple\", \"green\"));\n+        String uriQuery = \"cts.uriMatch('/testFruit**')\";\n+\n+        EvalResultIterator uriQueryResult = getHubClient().getStagingClient().newServerEval().javascript(uriQuery).eval();\n+        String uri = uriQueryResult.next().getString();\n+\n+        JSONDocumentManager jd = getHubClient().getStagingClient().newJSONDocumentManager();\n+        DocumentMetadataHandle docMetaData = jd.readMetadata(uri, new DocumentMetadataHandle());\n+\n+        assertEquals(collections, docMetaData.getCollections().toArray()[0].toString());\n+    }\n+\n+    @Test\n+    void ingestDocsWithSourceName() throws IOException {\n+        String sourceName = \"spark\";\n+        DataWriter<InternalRow> dataWriter = buildDataWriter(new Options(getHubPropertiesAsMap()).withBatchSize(1).withUriPrefix(\"/testFruit\").withSourceName(sourceName));\n+        dataWriter.write(buildRow(\"pineapple\", \"green\"));\n+        String uriQuery = \"cts.uriMatch('/testFruit**')\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "410088ee47dbd98710c389893448d1f1b40e33bb"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY1NzEwNg==", "bodyText": "\"const\" is preferable to \"let\", as it makes it clear that the value will not be changing. So do this instead:\nconst collections = work.collections != null ? work.collections.split(',') : [];", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r499657106", "createdAt": "2020-10-05T14:49:48Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/ingestion/bulkIngester.sjs", "diffHunk": "@@ -25,11 +25,38 @@ var input;         // jsonDocument*\n declareUpdate();\n \n const ingest = require(\"/data-hub/5/builtins/steps/ingestion/default/main.sjs\");\n-const consts = require('/data-hub/5/impl/consts.sjs');\n+const consts = require(\"/data-hub/5/impl/consts.sjs\");\n+const HubUtils = require(\"/data-hub/5/impl/hub-utils.sjs\");\n const state = fn.head(xdmp.fromJSON(endpointState));\n \n const work = fn.head(xdmp.fromJSON(workUnit));\n \n+let collections = [];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "410088ee47dbd98710c389893448d1f1b40e33bb"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY1NzMxOA==", "bodyText": "Same thing here - can adapt this to use \"const\" instead of \"let\".", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r499657318", "createdAt": "2020-10-05T14:50:05Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/ingestion/bulkIngester.sjs", "diffHunk": "@@ -25,11 +25,38 @@ var input;         // jsonDocument*\n declareUpdate();\n \n const ingest = require(\"/data-hub/5/builtins/steps/ingestion/default/main.sjs\");\n-const consts = require('/data-hub/5/impl/consts.sjs');\n+const consts = require(\"/data-hub/5/impl/consts.sjs\");\n+const HubUtils = require(\"/data-hub/5/impl/hub-utils.sjs\");\n const state = fn.head(xdmp.fromJSON(endpointState));\n \n const work = fn.head(xdmp.fromJSON(workUnit));\n \n+let collections = [];\n+if(work.collections != null){\n+  collections = work.collections.split(',');\n+}\n+\n+let permissionsArray = []", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "410088ee47dbd98710c389893448d1f1b40e33bb"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY1ODAwOQ==", "bodyText": "Pinging @rahulvudutala  and @fsnow  and @ryanjdew  about this - this is the property name we're proposing for capturing the source type. Note that this is going on the develop branch. Nothing in DHF will care about it yet though.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r499658009", "createdAt": "2020-10-05T14:50:59Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/ingestion/bulkIngester.sjs", "diffHunk": "@@ -25,11 +25,38 @@ var input;         // jsonDocument*\n declareUpdate();\n \n const ingest = require(\"/data-hub/5/builtins/steps/ingestion/default/main.sjs\");\n-const consts = require('/data-hub/5/impl/consts.sjs');\n+const consts = require(\"/data-hub/5/impl/consts.sjs\");\n+const HubUtils = require(\"/data-hub/5/impl/hub-utils.sjs\");\n const state = fn.head(xdmp.fromJSON(endpointState));\n \n const work = fn.head(xdmp.fromJSON(workUnit));\n \n+let collections = [];\n+if(work.collections != null){\n+  collections = work.collections.split(',');\n+}\n+\n+let permissionsArray = []\n+\n+if(work.permissions == null){\n+  work.permissions = 'data-hub-common,read,data-hub-common,update'\n+}\n+\n+permissionsArray = new HubUtils().parsePermissions(work.permissions);\n+\n+const headers = {};\n+headers.createdOn = consts.CURRENT_DATE_TIME\n+headers.createdBy = consts.CURRENT_USER\n+\n+if(work.sourcename != null || work.sourcetype != null){\n+  const sources = [];\n+  const source = {};\n+  source.name = work.sourcename\n+  source.datahubSourceType = work.sourcetype", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "410088ee47dbd98710c389893448d1f1b40e33bb"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY1OTI0Mg==", "bodyText": "See https://github.com/SameeraPriyathamTadikonda/marklogic-data-hub/pull/25/files", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#discussion_r499659242", "createdAt": "2020-10-05T14:52:36Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/WriteDataWithOptionsTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.marklogic.hub.spark.sql.sources.v2;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.client.ext.util.DefaultDocumentPermissionsParser;\n+import com.marklogic.client.ext.util.DocumentPermissionsParser;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.JacksonHandle;\n+import org.apache.spark.sql.catalyst.InternalRow;\n+import org.apache.spark.sql.sources.v2.writer.DataWriter;\n+import org.junit.Assert;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.IOException;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class WriteDataWithOptionsTest extends AbstractSparkConnectorTest {\n+\n+    @Test\n+    void ingestDocsWithCollection() throws IOException {\n+        String collections = \"fruits\";\n+        DataWriter<InternalRow> dataWriter = buildDataWriter(new Options(getHubPropertiesAsMap()).withBatchSize(1).withUriPrefix(\"/testFruit\").withCollections(collections));\n+        dataWriter.write(buildRow(\"pineapple\", \"green\"));\n+        String uriQuery = \"cts.uriMatch('/testFruit**')\";\n+\n+        EvalResultIterator uriQueryResult = getHubClient().getStagingClient().newServerEval().javascript(uriQuery).eval();\n+        String uri = uriQueryResult.next().getString();\n+\n+        JSONDocumentManager jd = getHubClient().getStagingClient().newJSONDocumentManager();\n+        DocumentMetadataHandle docMetaData = jd.readMetadata(uri, new DocumentMetadataHandle());\n+\n+        assertEquals(collections, docMetaData.getCollections().toArray()[0].toString());\n+    }\n+\n+    @Test\n+    void ingestDocsWithSourceName() throws IOException {\n+        String sourceName = \"spark\";\n+        DataWriter<InternalRow> dataWriter = buildDataWriter(new Options(getHubPropertiesAsMap()).withBatchSize(1).withUriPrefix(\"/testFruit\").withSourceName(sourceName));\n+        dataWriter.write(buildRow(\"pineapple\", \"green\"));\n+        String uriQuery = \"cts.uriMatch('/testFruit**')\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY1NDc0MA=="}, "originalCommit": {"oid": "410088ee47dbd98710c389893448d1f1b40e33bb"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b72cb309d0c8138f8669d70f3328b8775453a26", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/8b72cb309d0c8138f8669d70f3328b8775453a26", "committedDate": "2020-10-05T18:43:08Z", "message": "DHFPROD-5944: Configure Document Ingestion via connector\n\nDHFPROD-5944: Adding helper methods for test\n\nuriprefix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da106e8cdd3af4d60ff1e402e5749a22ba63b77d", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/da106e8cdd3af4d60ff1e402e5749a22ba63b77d", "committedDate": "2020-10-05T16:29:05Z", "message": "DHFPROD-5944: Adding helper methods for test"}, "afterCommit": {"oid": "8b72cb309d0c8138f8669d70f3328b8775453a26", "author": {"user": {"login": "SameeraPriyathamTadikonda", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/8b72cb309d0c8138f8669d70f3328b8775453a26", "committedDate": "2020-10-05T18:43:08Z", "message": "DHFPROD-5944: Configure Document Ingestion via connector\n\nDHFPROD-5944: Adding helper methods for test\n\nuriprefix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzQ4MjUz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#pullrequestreview-502348253", "createdAt": "2020-10-05T19:17:55Z", "commit": {"oid": "8b72cb309d0c8138f8669d70f3328b8775453a26"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzk3MTIx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4633#pullrequestreview-502397121", "createdAt": "2020-10-05T20:30:02Z", "commit": {"oid": "8b72cb309d0c8138f8669d70f3328b8775453a26"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1893, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}