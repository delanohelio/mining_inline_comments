{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MDk0NTEw", "number": 4007, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDoyODo1MVrOEAQ37w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjo1NTozN1rOEAfqiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzExOTE5OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-central/ui/src/components/load-data/new-data-load-dialog/new-data-load-dialog.test.tsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDoyODo1MVrOGbb8KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDoyODo1MVrOGbb8KA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyMjUwNA==", "bodyText": "Generally, I wouldn't bother with these assertions that verify that things were removed. Someone will wonder 6 months later - why is it important that we assert this? I think it's sufficient to just remove the feature.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431422504", "createdAt": "2020-05-27T20:28:51Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/ui/src/components/load-data/new-data-load-dialog/new-data-load-dialog.test.tsx", "diffHunk": "@@ -33,7 +33,16 @@ describe('New/edit load data configuration', () => {\n     expect(baseElement.querySelector('#otherSeparator')).not.toBeInTheDocument();\n     expect(baseElement.querySelector('#fileUpload')).toBeInTheDocument();\n     expect(baseElement.querySelector('#targetFormat')).toBeInTheDocument();\n-    expect(baseElement.querySelector('#outputUriReplacement')).toBeInTheDocument();\n+    expect(baseElement.querySelector('#outputUriReplacement')).not.toBeInTheDocument();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzEyNjMwOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub-central/ui/src/components/load-data/new-data-load-dialog/new-data-load-dialog.tsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDozMTowOFrOGbcAtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDozMTowOFrOGbcAtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyMzY2OQ==", "bodyText": "Can this be setOutputUriPrefix instead of setOutUriPrefix? I am generally against any sort of abbreviations like this - same goes for \"src\" and \"tgt\" instead of \"source\" and \"target\". If this were a local variable in a function that's just a few lines long, I think extremely short abbreviations can work. But otherwise, we should use regular words, no need for abbreviations that can potentially confuse.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431423669", "createdAt": "2020-05-27T20:31:08Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/ui/src/components/load-data/new-data-load-dialog/new-data-load-dialog.tsx", "diffHunk": "@@ -14,20 +14,17 @@ const NewDataLoadDialog = (props) => {\n   const [inputFilePath, setInputFilePath] = useState(props.stepData && props.stepData.inputFilePath ? props.stepData.inputFilePath : '');\n   const [srcFormat, setSrcFormat] = useState(props.stepData && props.stepData != {} ? props.stepData.sourceFormat : 'json');\n   const [tgtFormat, setTgtFormat] = useState(props.stepData && props.stepData != {} ? props.stepData.targetFormat : 'json');\n-  const [outUriReplacement, setOutUriReplacement] = useState(props.stepData && props.stepData != {} ? props.stepData.outputURIReplacement : '');\n+  const [outUriPrefix, setOutUriPrefix] = useState(props.stepData && props.stepData != {} ? props.stepData.outputURIPrefix : '');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzE0Mzc3OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/step/saveStep.sjs", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDozNjo0MVrOGbcL5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDozNjo0MVrOGbcL5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyNjUzMg==", "bodyText": "Can we do this in the loadData.sjs module instead? This endpoint should be as generic as possible; ideally, the step-type-specific logic is all in modules specific to a step type.\nLooks like validateArtifact would be a simple way to do it.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431426532", "createdAt": "2020-05-27T20:36:41Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/step/saveStep.sjs", "diffHunk": "@@ -35,7 +35,15 @@ let existingStep = fn.head(cts.search(cts.andQuery([\n \n if (existingStep) {\n   xdmp.trace(consts.TRACE_STEP, `Step with name ${stepName} and type ${stepDefinitionType} already exists, so will update`);\n-  let updatedStep = Object.assign(existingStep.toObject(), stepProperties);\n+  const isIngestionStep = \"ingestion\" === stepDefinitionType.toLowerCase() ? true : false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzE0NzQ0OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/cli/client/CommandLineFlowInputs.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDozNzo0MlrOGbcOEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDozNzo0MlrOGbcOEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyNzA5MA==", "bodyText": "Won't WriteStepRunner throw this error? I think it's fine to just handle it in one place.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431427090", "createdAt": "2020-05-27T20:37:42Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/cli/client/CommandLineFlowInputs.java", "diffHunk": "@@ -111,10 +114,20 @@\n                 runFlowString.append(\"\\n\\t\\tInput File Path: \" + inputFilePath);\n                 fileLocations.put(\"inputFilePath\", inputFilePath);\n             }\n+\n+            if (outputURIPrefix != null) {\n+                if(outputURIReplacement != null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzE1MjA4OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/step/convertIngestionStep.sjs", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDozOToxMlrOGbcRJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDozOToxMlrOGbcRJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyNzg3OQ==", "bodyText": "Shouldn't outputURIReplacement be dropped here since both exist?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431427879", "createdAt": "2020-05-27T20:39:12Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/ml-modules/root/test/suites/data-hub/5/data-services/step/convertIngestionStep.sjs", "diffHunk": "@@ -70,6 +71,7 @@ assertions.push(\n   test.assertEqual(\"xml\", flowStep.fileLocations.inputFileType),\n   test.assertEqual(\"data-sets/CustomerLoadJSON\", flowStep.fileLocations.inputFilePath),\n   test.assertEqual(\".*CustomerLoadJSON,'/customer'\", flowStep.fileLocations.outputURIReplacement),\n+  test.assertEqual(\"/customer/\", flowStep.fileLocations.outputURIPrefix),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4OTUzNDQyOnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjo1MzozMlrOGbzrzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjo1MzozMlrOGbzrzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxMTUzMw==", "bodyText": "I think it'd be good to change these checks to use a StringUtils method - e.g. hasText, isNotEmpty - because if one has a value and the other just has \"\", we're fine with that.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431811533", "createdAt": "2020-05-28T12:53:32Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java", "diffHunk": "@@ -398,6 +400,10 @@ protected void loadStepRunnerParameters(){\n             this.withStopOnFailure(Boolean.parseBoolean(stepConfig.get(\"stopOnFailure\").toString()));\n         }\n \n+        if(outputURIPrefix != null && outputURIReplacement != null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0823de615442f93563e8cbb4f01f23a518e474"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4OTU0MjQ5OnYy", "diffSide": "RIGHT", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjo1NTozN1rOGbzw-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNjozMzoxNFrOGb9arw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxMjg1Nw==", "bodyText": "I frequently like to put logic like this into a protected method so that it can easily unit-tested. You can even pass in the \"osName\" so you can verify the windows-specific code while not on windows. I didn't check the test coverage of all the conditions in here, but it'd be really easy to get 100% coverage of it with unit tests that will of course run very quickly too (i.e. put them in a class that doesn't extend anything, as you don't need any of the HubTestBase plumbing).", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431812857", "createdAt": "2020-05-28T12:55:37Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java", "diffHunk": "@@ -652,14 +658,24 @@ private RunStepResponse runIngester(RunStepResponse runStepResponse, Collection<\n     }\n \n     private void processCsv(JacksonHandle jacksonHandle, File file) {\n-        String uri = file.getParent();\n-        if(SystemUtils.OS_NAME.toLowerCase().contains(\"windows\")){\n-            uri = \"/\" + FilenameUtils.separatorsToUnix(StringUtils.replaceOnce(uri, \":\", \"\"));\n+        String uri;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0823de615442f93563e8cbb4f01f23a518e474"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3MDk5MQ==", "bodyText": "Moved uri generation for csv to a protected method and added test in WriteTestBatcherTest class", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431970991", "createdAt": "2020-05-28T16:33:14Z", "author": {"login": "srinathgit"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java", "diffHunk": "@@ -652,14 +658,24 @@ private RunStepResponse runIngester(RunStepResponse runStepResponse, Collection<\n     }\n \n     private void processCsv(JacksonHandle jacksonHandle, File file) {\n-        String uri = file.getParent();\n-        if(SystemUtils.OS_NAME.toLowerCase().contains(\"windows\")){\n-            uri = \"/\" + FilenameUtils.separatorsToUnix(StringUtils.replaceOnce(uri, \":\", \"\"));\n+        String uri;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxMjg1Nw=="}, "originalCommit": {"oid": "5d0823de615442f93563e8cbb4f01f23a518e474"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4158, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}