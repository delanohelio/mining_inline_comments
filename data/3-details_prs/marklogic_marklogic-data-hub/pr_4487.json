{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0MDgzNjk2", "number": 4487, "title": "DHFPROD-5571:Allow DHS users to define and deploy Amps", "bodyText": "Description\nPR to allow DHS users to define and deploy Amps.\n@kkanthet , @SameeraPriyathamTadikonda\nThis PR requires 10.0-4.4 for the tests to run. I believe PR jobs run on 10.0-4.2. Can the version be bumped up to 10.0-4.4 ?\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-08-26T18:39:01Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487", "merged": true, "mergeCommit": {"oid": "4015af828249cc06d8b5c7c92f51abd0c2e108be"}, "closed": true, "closedAt": "2020-09-02T17:06:50Z", "author": {"login": "srinathgit"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCwmRmAFqTQ3NTc2ODQ2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE-d3WAFqTQ4MDk4ODEzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NzY4NDYx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-475768461", "createdAt": "2020-08-26T18:55:40Z", "commit": {"oid": "0d44924a2784da09cdbe640a9a52d90e2958d8dd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODo1NTo0MFrOHHZWrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOTowMjoxN1rOHHZnBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxNzQ4Nw==", "bodyText": "ML 11 doesn't exist yet, but I think we should say \">= 10\" instead of \"== 10\".", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r477517487", "createdAt": "2020-08-26T18:55:40Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dhs/DeployUserAmpsTest.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.marklogic.hub.dhs;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.appdeployer.command.security.DeployAmpsCommand;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.rest.util.ResourcesFragment;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+\n+public class DeployUserAmpsTest extends AbstractHubCoreTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @BeforeEach\n+    void checkIfTestsCanBeRun(){\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        Assertions.assertTrue(mlVersion.isNightly() || (mlVersion.getMajor() == 10 && mlVersion.getMinor() >= 440));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d44924a2784da09cdbe640a9a52d90e2958d8dd"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUyMTI0NA==", "bodyText": "What error do you get for this?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r477521244", "createdAt": "2020-08-26T19:01:56Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dhs/DeployUserAmpsTest.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.marklogic.hub.dhs;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.appdeployer.command.security.DeployAmpsCommand;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.rest.util.ResourcesFragment;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+\n+public class DeployUserAmpsTest extends AbstractHubCoreTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @BeforeEach\n+    void checkIfTestsCanBeRun(){\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        Assertions.assertTrue(mlVersion.isNightly() || (mlVersion.getMajor() == 10 && mlVersion.getMinor() >= 440));\n+    }\n+\n+    @Test\n+    void createAmpWithInheritableRole() {\n+        //POST request\n+        writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME, \"data-hub-developer\");\n+        ResourcesFragment amps = new AmpManager(runAsDataHubSecurityAdmin().getManageClient()).getAsXml();\n+        Assertions.assertTrue(amps.resourceExists(\"testAmp\"));\n+\n+        //PUT request(doesn't work)\n+        writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME,\"data-hub-developer\", \"data-hub-operator\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d44924a2784da09cdbe640a9a52d90e2958d8dd"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUyMTY3MQ==", "bodyText": "Try doing a delete request with a ManageClient - I recall that the URL is a bit funky to build", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r477521671", "createdAt": "2020-08-26T19:02:17Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dhs/DeployUserAmpsTest.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.marklogic.hub.dhs;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.appdeployer.command.security.DeployAmpsCommand;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.rest.util.ResourcesFragment;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+\n+public class DeployUserAmpsTest extends AbstractHubCoreTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @BeforeEach\n+    void checkIfTestsCanBeRun(){\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        Assertions.assertTrue(mlVersion.isNightly() || (mlVersion.getMajor() == 10 && mlVersion.getMinor() >= 440));\n+    }\n+\n+    @Test\n+    void createAmpWithInheritableRole() {\n+        //POST request\n+        writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME, \"data-hub-developer\");\n+        ResourcesFragment amps = new AmpManager(runAsDataHubSecurityAdmin().getManageClient()).getAsXml();\n+        Assertions.assertTrue(amps.resourceExists(\"testAmp\"));\n+\n+        //PUT request(doesn't work)\n+        writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME,\"data-hub-developer\", \"data-hub-operator\");\n+\n+        //DELETE request(doesn't work)\n+        new DeployAmpsCommand().undo(newCommandContext(runAsDataHubSecurityAdmin()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d44924a2784da09cdbe640a9a52d90e2958d8dd"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d44924a2784da09cdbe640a9a52d90e2958d8dd", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/0d44924a2784da09cdbe640a9a52d90e2958d8dd", "committedDate": "2020-08-26T18:34:09Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}, "afterCommit": {"oid": "fd36bd734c27b02702852d8c75b03077c1c610ba", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/fd36bd734c27b02702852d8c75b03077c1c610ba", "committedDate": "2020-08-26T19:47:27Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODEwOTg2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-475810986", "createdAt": "2020-08-26T19:52:57Z", "commit": {"oid": "fd36bd734c27b02702852d8c75b03077c1c610ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOTo1Mjo1N1rOHHbbJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOTo1Mjo1N1rOHHbbJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1MTM5Nw==", "bodyText": "This is fine - a user can only do an undeploy locally, and that will likely be as an admin user.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r477551397", "createdAt": "2020-08-26T19:52:57Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dhs/DeployUserAmpsTest.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.marklogic.hub.dhs;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.rest.util.ResourcesFragment;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+\n+public class DeployUserAmpsTest extends AbstractHubCoreTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @BeforeEach\n+    void checkIfTestsCanBeRun(){\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        Assertions.assertTrue(mlVersion.isNightly() || (mlVersion.getMajor() > 10) ||(mlVersion.getMajor() == 10 && mlVersion.getMinor() >= 440));\n+    }\n+\n+    @Test\n+    void createAmpWithInheritableRole() {\n+        //POST request\n+        writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME, \"data-hub-developer\");\n+        ResourcesFragment amps = new AmpManager(runAsDataHubSecurityAdmin().getManageClient()).getAsXml();\n+        Assertions.assertTrue(amps.resourceExists(\"testAmp\"));\n+\n+        //PUT request(doesn't work)\n+        writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME,\"data-hub-developer\", \"data-hub-operator\");\n+\n+        runAsDataHubSecurityAdmin().getManageClient().delete(\"/manage/v2/amps/testAmp?namespace=&document-uri=/data-hub/5/impl/jobs.sjs&modules-database=data-hub-MODULES\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd36bd734c27b02702852d8c75b03077c1c610ba"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd36bd734c27b02702852d8c75b03077c1c610ba", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/fd36bd734c27b02702852d8c75b03077c1c610ba", "committedDate": "2020-08-26T19:47:27Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}, "afterCommit": {"oid": "fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2", "committedDate": "2020-08-28T04:18:35Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MjMwNzM5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-477230739", "createdAt": "2020-08-28T04:21:03Z", "commit": {"oid": "fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNDoyMTowM1rOHIo_6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNDoyMTowM1rOHIo_6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgyMjM3Ng==", "bodyText": "This test is failing. I create a custom role based of \"data-hub-manage-amps\", assign it to a user and use that user to deploy amps. It fails with 403 Forbidden error. Not sure if I made a mistake somewhere", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r478822376", "createdAt": "2020-08-28T04:21:03Z", "author": {"login": "srinathgit"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dhs/DeployUserAmpsTest.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package com.marklogic.hub.dhs;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.impl.HubConfigImpl;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.mgmt.ManageClient;\n+import com.marklogic.mgmt.ManageConfig;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.mgmt.resource.security.RoleManager;\n+import com.marklogic.mgmt.resource.security.UserManager;\n+import com.marklogic.rest.util.ResourcesFragment;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+\n+public class DeployUserAmpsTest extends AbstractHubCoreTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @BeforeEach\n+    void checkIfTestsCanBeRun(){\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        Assertions.assertTrue(mlVersion.isNightly() || (mlVersion.getMajor() > 10) ||(mlVersion.getMajor() == 10 && mlVersion.getMinor() >= 440));\n+    }\n+\n+    @Test\n+    void createAmpWithInheritableRole() {\n+        //POST request\n+        writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME, \"data-hub-developer\");\n+        ResourcesFragment amps = new AmpManager(runAsDataHubSecurityAdmin().getManageClient()).getAsXml();\n+        Assertions.assertTrue(amps.resourceExists(\"testAmp\"));\n+\n+        //PUT request\n+        writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME,\"data-hub-developer\", \"data-hub-operator\");\n+\n+        runAsDataHubSecurityAdmin().getManageClient().delete(\"/manage/v2/amps/testAmp?namespace=&document-uri=/data-hub/5/impl/jobs.sjs&modules-database=data-hub-MODULES\");\n+        amps = new AmpManager(runAsDataHubSecurityAdmin().getManageClient()).getAsXml();\n+        Assertions.assertFalse(amps.resourceExists(\"testAmp\"));\n+    }\n+\n+    @Test\n+    void createAmpWithDelegatedUser(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NzY2NDgz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-477766483", "createdAt": "2020-08-28T14:17:25Z", "commit": {"oid": "fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNDoxNzoyNVrOHJITjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNDoyMjo0OFrOHJIg1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMzNTMwOA==", "bodyText": "\"data-hub-manage-amps\" should be a new role in the project. That way, a dhsa can create a custom role that inherits it. Also, this role will need to inherit the \"manage\" role so that it has read access to the Manage API.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r479335308", "createdAt": "2020-08-28T14:17:25Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dhs/DeployUserAmpsTest.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package com.marklogic.hub.dhs;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.impl.HubConfigImpl;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.mgmt.ManageClient;\n+import com.marklogic.mgmt.ManageConfig;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.mgmt.resource.security.RoleManager;\n+import com.marklogic.mgmt.resource.security.UserManager;\n+import com.marklogic.rest.util.ResourcesFragment;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+\n+public class DeployUserAmpsTest extends AbstractHubCoreTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @BeforeEach\n+    void checkIfTestsCanBeRun(){\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        Assertions.assertTrue(mlVersion.isNightly() || (mlVersion.getMajor() > 10) ||(mlVersion.getMajor() == 10 && mlVersion.getMinor() >= 440));\n+    }\n+\n+    @Test\n+    void createAmpWithInheritableRole() {\n+        //POST request\n+        writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME, \"data-hub-developer\");\n+        ResourcesFragment amps = new AmpManager(runAsDataHubSecurityAdmin().getManageClient()).getAsXml();\n+        Assertions.assertTrue(amps.resourceExists(\"testAmp\"));\n+\n+        //PUT request\n+        writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME,\"data-hub-developer\", \"data-hub-operator\");\n+\n+        runAsDataHubSecurityAdmin().getManageClient().delete(\"/manage/v2/amps/testAmp?namespace=&document-uri=/data-hub/5/impl/jobs.sjs&modules-database=data-hub-MODULES\");\n+        amps = new AmpManager(runAsDataHubSecurityAdmin().getManageClient()).getAsXml();\n+        Assertions.assertFalse(amps.resourceExists(\"testAmp\"));\n+    }\n+\n+    @Test\n+    void createAmpWithDelegatedUser(){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgyMjM3Ng=="}, "originalCommit": {"oid": "fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMzNTkxOA==", "bodyText": "You should just be able to check the status on \"ex\" to see if it's 403 - e.g. HttpStatus.FORBIDDEN.equals(ex.getStatusCode()) .", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r479335918", "createdAt": "2020-08-28T14:18:12Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/deploy/DeployHubAmpsCommand.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.marklogic.hub.dhs.installer.deploy;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.appdeployer.command.CommandContext;\n+import com.marklogic.appdeployer.command.security.DeployAmpsCommand;\n+import com.marklogic.mgmt.ManageClient;\n+import com.marklogic.mgmt.SaveReceipt;\n+import com.marklogic.mgmt.resource.ResourceManager;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.mgmt.util.ObjectMapperFactory;\n+import org.springframework.web.client.HttpClientErrorException;\n+\n+/**\n+ * This command is used instead of DeployAmpsCommand when a data-hub-security-admin user is deploying\n+ * amps. It's because PUT request fail due to https://bugtrack.marklogic.com/55309.\n+ */\n+public class DeployHubAmpsCommand extends DeployAmpsCommand {\n+\n+    @Override\n+    public boolean cmaShouldBeUsed(CommandContext context) {\n+        return false;\n+    }\n+\n+    @Override\n+    protected SaveReceipt saveResource(ResourceManager mgr, CommandContext context, String payload) {\n+        SaveReceipt receipt = null;\n+        ManageClient manageClient = context.getManageClient();\n+        try {\n+            receipt = super.saveResource(mgr, context, payload);\n+        }\n+        catch (HttpClientErrorException ex) {\n+            try{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMzODcxMQ==", "bodyText": "There's a chance that a user will run this as an admin, so the message should be more informative here - e.g. \"An error occurred while trying to update an amp: \" + ex.getMessage() + \". Updates to amps as a user with the data-hub-security-admin role are not allowed in this version of MarkLogic, so this error is being logged and not thrown. If you need to modify the amp, you must delete it first via the Manage API.\"", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r479338711", "createdAt": "2020-08-28T14:22:48Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/deploy/DeployHubAmpsCommand.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.marklogic.hub.dhs.installer.deploy;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.appdeployer.command.CommandContext;\n+import com.marklogic.appdeployer.command.security.DeployAmpsCommand;\n+import com.marklogic.mgmt.ManageClient;\n+import com.marklogic.mgmt.SaveReceipt;\n+import com.marklogic.mgmt.resource.ResourceManager;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.mgmt.util.ObjectMapperFactory;\n+import org.springframework.web.client.HttpClientErrorException;\n+\n+/**\n+ * This command is used instead of DeployAmpsCommand when a data-hub-security-admin user is deploying\n+ * amps. It's because PUT request fail due to https://bugtrack.marklogic.com/55309.\n+ */\n+public class DeployHubAmpsCommand extends DeployAmpsCommand {\n+\n+    @Override\n+    public boolean cmaShouldBeUsed(CommandContext context) {\n+        return false;\n+    }\n+\n+    @Override\n+    protected SaveReceipt saveResource(ResourceManager mgr, CommandContext context, String payload) {\n+        SaveReceipt receipt = null;\n+        ManageClient manageClient = context.getManageClient();\n+        try {\n+            receipt = super.saveResource(mgr, context, payload);\n+        }\n+        catch (HttpClientErrorException ex) {\n+            try{\n+                JsonNode error = ObjectMapperFactory.getObjectMapper().readTree(ex.getResponseBodyAsString());\n+                if (error.has(\"errorResponse\")) {\n+                    JsonNode errorResponse = error.get(\"errorResponse\");\n+                    if (errorResponse.has(\"messageCode\")) {\n+                        final String statusCode = errorResponse.get(\"statusCode\").asText();\n+                        final String status = errorResponse.get(\"status\").asText();\n+                        if (\"Forbidden\".equalsIgnoreCase(status) && \"403\".equals(statusCode)) {\n+                            boolean ampExists;\n+                            try{\n+                                ampExists  = new AmpManager(manageClient).ampExists(payload);\n+                            }\n+                            catch (Exception e){\n+                                throw ex;\n+                            }\n+                            if(ampExists){\n+                                logger.error(\"Updates to amps are not allowed in this version of MarkLogic server.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NzczMzg3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-477773387", "createdAt": "2020-08-28T14:25:40Z", "commit": {"oid": "fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNDoyNTo0MFrOHJIn5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNDoyNTo0MFrOHJIn5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MDUxNg==", "bodyText": "For this test, we want to make sure that the amp works too. To do that, create a new \"user-amps\" test project and put a single XQuery library in there (since those are easier to amp). Something like this:\ndeclare function get-doc($uri as xs:string) { fn:doc($uri) }\n\nThen insert a document that e.g. has pii-reader for read/update permissions. The amp will grant pii-reader.\nAs a data-hub-operator, first make sure that the user gets back null when calling that function on the test document. Then deploy the amp as a dhsa. Then as a dho, call the function again and verify that you get the test document back.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r479340516", "createdAt": "2020-08-28T14:25:40Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dhs/DeployUserAmpsTest.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package com.marklogic.hub.dhs;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.impl.HubConfigImpl;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.mgmt.ManageClient;\n+import com.marklogic.mgmt.ManageConfig;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.mgmt.resource.security.RoleManager;\n+import com.marklogic.mgmt.resource.security.UserManager;\n+import com.marklogic.rest.util.ResourcesFragment;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+\n+public class DeployUserAmpsTest extends AbstractHubCoreTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @BeforeEach\n+    void checkIfTestsCanBeRun(){\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        Assertions.assertTrue(mlVersion.isNightly() || (mlVersion.getMajor() > 10) ||(mlVersion.getMajor() == 10 && mlVersion.getMinor() >= 440));\n+    }\n+\n+    @Test\n+    void createAmpWithInheritableRole() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/fd9b975b1c1fc6ecdc37f4f6377e5e6a697756d2", "committedDate": "2020-08-28T04:18:35Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}, "afterCommit": {"oid": "507d44e6cfb62e9217e06a09675a0e3cf513c36d", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/507d44e6cfb62e9217e06a09675a0e3cf513c36d", "committedDate": "2020-08-31T07:40:58Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NjYxOTYz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-478661963", "createdAt": "2020-08-31T14:24:20Z", "commit": {"oid": "507d44e6cfb62e9217e06a09675a0e3cf513c36d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNDoyNDoyMVrOHJ6_0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNDoyOTo1NlrOHJ7NzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE2NTg0Mw==", "bodyText": "I don't think this needs to be done - i.e. this privilege can go to the role-inheritor role. Only a dhsa can create custom roles. But a dh-amp-manager should be able to create an amp that inherits dh-amp-manager.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r480165843", "createdAt": "2020-08-31T14:24:21Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/CreateGranularPrivilegesCommand.java", "diffHunk": "@@ -228,11 +234,17 @@ public void undo(CommandContext context) {\n         ROLES_THAT_CAN_BE_INHERITED.forEach(roleName -> {\n             // We expect each role to translate to a role; otherwise, an error should be thrown\n             String roleId = existingRoles.getIdForNameOrId(roleName);\n-            Privilege priv = newPrivilege(\"data-role-inherit-\" + roleId, \"data-hub-security-admin\");\n+            Privilege priv = newPrivilege(\"data-role-inherit-\" + roleId, \"data-hub-role-inheritor\");\n             priv.setAction(\"http://marklogic.com/xdmp/privileges/role/inherit/\" + roleId);\n             granularPrivilegeMap.put(priv.getAction(), priv);\n         });\n \n+        //This privilege should be assigned to \"dh-security-admin\" only so that it can create custom roles that have \"dh-amp-manager\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "507d44e6cfb62e9217e06a09675a0e3cf513c36d"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE2Njg0Nw==", "bodyText": "Shouldn't this be Assumptions.assumeTrue? We don't want an error thrown if we can't test this.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r480166847", "createdAt": "2020-08-31T14:25:52Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dhs/DeployUserAmpsTest.java", "diffHunk": "@@ -0,0 +1,185 @@\n+package com.marklogic.hub.dhs;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.document.DocumentManager;\n+import com.marklogic.client.document.DocumentWriteSet;\n+import com.marklogic.client.eval.ServerEvaluationCall;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.Format;\n+import com.marklogic.client.io.JacksonHandle;\n+import com.marklogic.client.io.StringHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubClient;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.mgmt.ManageClient;\n+import com.marklogic.mgmt.ManageConfig;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.mgmt.resource.security.RoleManager;\n+import com.marklogic.mgmt.resource.security.UserManager;\n+import com.marklogic.rest.util.ResourcesFragment;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.READ;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+\n+public class DeployUserAmpsTest extends AbstractHubCoreTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @BeforeEach\n+    void checkIfTestsCanBeRun(){\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        assertTrue(mlVersion.isNightly() || (mlVersion.getMajor() > 10) ||(mlVersion.getMajor() == 10 && mlVersion.getMinor() >= 440));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "507d44e6cfb62e9217e06a09675a0e3cf513c36d"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE2Nzk1OA==", "bodyText": "Pinging @fsnow @ryanjdew  @rahulvudutala  @akshaysonvane as an FYI - I really like this - I think this is the pattern we eventually want for our tests, which is that we obtain upfront the necessary HubClients and give them descriptive names (I think they can be shortened to operatorClient and adminClient too, but that's beside the point). This avoids wondering - what is the current state of adminHubConfig in this test? Essentially, we want to stop using adminHubConfig except to a) get instances of HubClient, and b) to access HubProject.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r480167958", "createdAt": "2020-08-31T14:27:39Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dhs/DeployUserAmpsTest.java", "diffHunk": "@@ -0,0 +1,185 @@\n+package com.marklogic.hub.dhs;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.document.DocumentManager;\n+import com.marklogic.client.document.DocumentWriteSet;\n+import com.marklogic.client.eval.ServerEvaluationCall;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.Format;\n+import com.marklogic.client.io.JacksonHandle;\n+import com.marklogic.client.io.StringHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubClient;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.mgmt.ManageClient;\n+import com.marklogic.mgmt.ManageConfig;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.mgmt.resource.security.RoleManager;\n+import com.marklogic.mgmt.resource.security.UserManager;\n+import com.marklogic.rest.util.ResourcesFragment;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.READ;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+\n+public class DeployUserAmpsTest extends AbstractHubCoreTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @BeforeEach\n+    void checkIfTestsCanBeRun(){\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        assertTrue(mlVersion.isNightly() || (mlVersion.getMajor() > 10) ||(mlVersion.getMajor() == 10 && mlVersion.getMinor() >= 440));\n+    }\n+\n+    @Test\n+    void createAmpWithInheritableRole() {\n+        HubClient operatorHubClient = runAsDataHubOperator().newHubClient();\n+        HubClient adminHubClient = runAsAdmin().newHubClient();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "507d44e6cfb62e9217e06a09675a0e3cf513c36d"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE2ODg3Ng==", "bodyText": "Can you start this role-name with \"test-\" - i.e. \"test-delegated-amp-manager\"? Just makes life easy in case it's left behind by a test - makes it obvious that it's a test role.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r480168876", "createdAt": "2020-08-31T14:29:10Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dhs/DeployUserAmpsTest.java", "diffHunk": "@@ -0,0 +1,185 @@\n+package com.marklogic.hub.dhs;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.document.DocumentManager;\n+import com.marklogic.client.document.DocumentWriteSet;\n+import com.marklogic.client.eval.ServerEvaluationCall;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.Format;\n+import com.marklogic.client.io.JacksonHandle;\n+import com.marklogic.client.io.StringHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubClient;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.mgmt.ManageClient;\n+import com.marklogic.mgmt.ManageConfig;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.mgmt.resource.security.RoleManager;\n+import com.marklogic.mgmt.resource.security.UserManager;\n+import com.marklogic.rest.util.ResourcesFragment;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.READ;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+\n+public class DeployUserAmpsTest extends AbstractHubCoreTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @BeforeEach\n+    void checkIfTestsCanBeRun(){\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        assertTrue(mlVersion.isNightly() || (mlVersion.getMajor() > 10) ||(mlVersion.getMajor() == 10 && mlVersion.getMinor() >= 440));\n+    }\n+\n+    @Test\n+    void createAmpWithInheritableRole() {\n+        HubClient operatorHubClient = runAsDataHubOperator().newHubClient();\n+        HubClient adminHubClient = runAsAdmin().newHubClient();\n+\n+        DocumentManager moduleDocManager = adminHubClient.getModulesClient().newDocumentManager();\n+        DocumentWriteSet writeSet = moduleDocManager.newWriteSet();\n+        StringHandle handle =  new StringHandle(\"'use strict';\\n\" +\n+            \"module.exports.getPiiData = module.amp(\\n\" +\n+            \"  function getPiiData() {\\n\" +\n+            \"    return cts.doc('/pii/test.json');\\n\" +\n+            \"  }\\n\" +\n+            \");\");\n+        handle.setFormat(Format.TEXT);\n+        writeSet.add(\"/ampTest/testModule.sjs\", getPermissionsMetaDataHandle(), handle);\n+        moduleDocManager.write(writeSet);\n+\n+        handle = new StringHandle(\"{\\\"ssn\\\": \\\"123-456-7890\\\"}\");\n+        handle.setFormat(Format.JSON);\n+        DocumentMetadataHandle permissions = new DocumentMetadataHandle()\n+            .withPermission(\"pii-reader\", DocumentMetadataHandle.Capability.UPDATE,READ);\n+        DocumentManager adminDocManager = adminHubClient.getStagingClient().newDocumentManager();\n+        writeSet = adminDocManager.newWriteSet();\n+        writeSet.add(\"/pii/test.json\", permissions, handle);\n+        adminDocManager.write(writeSet);\n+\n+        ServerEvaluationCall piiData = operatorHubClient.getStagingClient().newServerEval().javascript(\"const ampMod = require('/ampTest/testModule.sjs');\\n\" +\n+            \"ampMod.getPiiData();\");\n+\n+        //query returns null in the absence of the amp\n+        assertFalse(piiData.eval().hasNext());\n+\n+        ResourcesFragment amps;\n+        try{\n+            //POST request\n+            writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME, \"pii-reader\");\n+            amps = new AmpManager(runAsDataHubSecurityAdmin().getManageClient()).getAsXml();\n+\n+            assertTrue(amps.resourceExists(\"getPiiData\"));\n+            JacksonHandle jacksonHandle = new JacksonHandle();\n+            piiData.eval().next().get(jacksonHandle);\n+            assertEquals(\"123-456-7890\", jacksonHandle.get().get(\"ssn\").asText(), \"data-hub-operator should be \" +\n+                \"able to read the document since the amp has been created\");\n+\n+            //PUT request - shouldn't fail\n+            writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME,\"data-hub-developer\", \"pii-reader\");\n+        }\n+        finally {\n+            runAsDataHubSecurityAdmin().getManageClient().delete(\"/manage/v2/amps/getPiiData?namespace=&document-uri=/ampTest/testModule.sjs&modules-database=data-hub-MODULES\");\n+            amps = new AmpManager(runAsDataHubSecurityAdmin().getManageClient()).getAsXml();\n+            assertFalse(amps.resourceExists(\"getPiiData\"));\n+        }\n+    }\n+\n+    @Test\n+    void createAmpWithDelegatedUser(){\n+        //create custom role having \"data-hub-amp-manager\" as \"data-hub-security-admin\"\n+        ObjectNode roleNode = mapper.createObjectNode();\n+        roleNode.put(\"role-name\", \"delegated-amp-manager\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "507d44e6cfb62e9217e06a09675a0e3cf513c36d"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE2OTQyMQ==", "bodyText": "We want to make sure that this amp works too, so refactor the code in the test above for verifying that the amp works into a separate private method, and then call that method in both of these tests.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r480169421", "createdAt": "2020-08-31T14:29:56Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/dhs/DeployUserAmpsTest.java", "diffHunk": "@@ -0,0 +1,185 @@\n+package com.marklogic.hub.dhs;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.document.DocumentManager;\n+import com.marklogic.client.document.DocumentWriteSet;\n+import com.marklogic.client.eval.ServerEvaluationCall;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.Format;\n+import com.marklogic.client.io.JacksonHandle;\n+import com.marklogic.client.io.StringHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubClient;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.mgmt.ManageClient;\n+import com.marklogic.mgmt.ManageConfig;\n+import com.marklogic.mgmt.resource.security.AmpManager;\n+import com.marklogic.mgmt.resource.security.RoleManager;\n+import com.marklogic.mgmt.resource.security.UserManager;\n+import com.marklogic.rest.util.ResourcesFragment;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.READ;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+\n+public class DeployUserAmpsTest extends AbstractHubCoreTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @BeforeEach\n+    void checkIfTestsCanBeRun(){\n+        Versions.MarkLogicVersion mlVersion = versions.getMLVersion();\n+        assertTrue(mlVersion.isNightly() || (mlVersion.getMajor() > 10) ||(mlVersion.getMajor() == 10 && mlVersion.getMinor() >= 440));\n+    }\n+\n+    @Test\n+    void createAmpWithInheritableRole() {\n+        HubClient operatorHubClient = runAsDataHubOperator().newHubClient();\n+        HubClient adminHubClient = runAsAdmin().newHubClient();\n+\n+        DocumentManager moduleDocManager = adminHubClient.getModulesClient().newDocumentManager();\n+        DocumentWriteSet writeSet = moduleDocManager.newWriteSet();\n+        StringHandle handle =  new StringHandle(\"'use strict';\\n\" +\n+            \"module.exports.getPiiData = module.amp(\\n\" +\n+            \"  function getPiiData() {\\n\" +\n+            \"    return cts.doc('/pii/test.json');\\n\" +\n+            \"  }\\n\" +\n+            \");\");\n+        handle.setFormat(Format.TEXT);\n+        writeSet.add(\"/ampTest/testModule.sjs\", getPermissionsMetaDataHandle(), handle);\n+        moduleDocManager.write(writeSet);\n+\n+        handle = new StringHandle(\"{\\\"ssn\\\": \\\"123-456-7890\\\"}\");\n+        handle.setFormat(Format.JSON);\n+        DocumentMetadataHandle permissions = new DocumentMetadataHandle()\n+            .withPermission(\"pii-reader\", DocumentMetadataHandle.Capability.UPDATE,READ);\n+        DocumentManager adminDocManager = adminHubClient.getStagingClient().newDocumentManager();\n+        writeSet = adminDocManager.newWriteSet();\n+        writeSet.add(\"/pii/test.json\", permissions, handle);\n+        adminDocManager.write(writeSet);\n+\n+        ServerEvaluationCall piiData = operatorHubClient.getStagingClient().newServerEval().javascript(\"const ampMod = require('/ampTest/testModule.sjs');\\n\" +\n+            \"ampMod.getPiiData();\");\n+\n+        //query returns null in the absence of the amp\n+        assertFalse(piiData.eval().hasNext());\n+\n+        ResourcesFragment amps;\n+        try{\n+            //POST request\n+            writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME, \"pii-reader\");\n+            amps = new AmpManager(runAsDataHubSecurityAdmin().getManageClient()).getAsXml();\n+\n+            assertTrue(amps.resourceExists(\"getPiiData\"));\n+            JacksonHandle jacksonHandle = new JacksonHandle();\n+            piiData.eval().next().get(jacksonHandle);\n+            assertEquals(\"123-456-7890\", jacksonHandle.get().get(\"ssn\").asText(), \"data-hub-operator should be \" +\n+                \"able to read the document since the amp has been created\");\n+\n+            //PUT request - shouldn't fail\n+            writeAmpFileToProjectAndDeploy(HubConfig.DEFAULT_MODULES_DB_NAME,\"data-hub-developer\", \"pii-reader\");\n+        }\n+        finally {\n+            runAsDataHubSecurityAdmin().getManageClient().delete(\"/manage/v2/amps/getPiiData?namespace=&document-uri=/ampTest/testModule.sjs&modules-database=data-hub-MODULES\");\n+            amps = new AmpManager(runAsDataHubSecurityAdmin().getManageClient()).getAsXml();\n+            assertFalse(amps.resourceExists(\"getPiiData\"));\n+        }\n+    }\n+\n+    @Test\n+    void createAmpWithDelegatedUser(){\n+        //create custom role having \"data-hub-amp-manager\" as \"data-hub-security-admin\"\n+        ObjectNode roleNode = mapper.createObjectNode();\n+        roleNode.put(\"role-name\", \"delegated-amp-manager\");\n+        roleNode.set(\"role\", mapper.createArrayNode().add(\"data-hub-amp-manager\"));\n+        writePayLoadToFileAndDeploy(getHubConfig().getUserSecurityDir().resolve(\"roles\"), \"delegatedRole.json\", roleNode);\n+\n+        //create user from that role\n+        ObjectNode userNode = mapper.createObjectNode();\n+        userNode.put(\"user-name\", \"test-delegated-amp-manager\");\n+        userNode.put(\"password\", \"password\");\n+        userNode.set(\"role\", mapper.createArrayNode().add(\"delegated-amp-manager\"));\n+        new UserManager(runAsAdmin().getManageClient()).save(userNode.toString());\n+\n+        //deploy amps using that user\n+        ManageClient delegatedManageClient = new ManageClient();\n+        delegatedManageClient.setManageConfig(new ManageConfig(host, 8002, \"test-delegated-amp-manager\", \"password\"));\n+        try{\n+            delegatedManageClient.postJson(\"/manage/v2/amps\", getAmpNode(\"data-hub-MODULES\", \"data-hub-operator\").toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "507d44e6cfb62e9217e06a09675a0e3cf513c36d"}, "originalPosition": 115}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "507d44e6cfb62e9217e06a09675a0e3cf513c36d", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/507d44e6cfb62e9217e06a09675a0e3cf513c36d", "committedDate": "2020-08-31T07:40:58Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}, "afterCommit": {"oid": "b2d3c6cee6b0ea8c6d3d37996c0da199284f3cd4", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b2d3c6cee6b0ea8c6d3d37996c0da199284f3cd4", "committedDate": "2020-08-31T18:37:06Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4ODY2MzMw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-478866330", "createdAt": "2020-08-31T19:02:05Z", "commit": {"oid": "b2d3c6cee6b0ea8c6d3d37996c0da199284f3cd4"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxOTowMjowNlrOHKE51w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxOTowMjowNlrOHKE51w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMyODE1MQ==", "bodyText": "Nice, this should be a useful addition for a number of tests.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#discussion_r480328151", "createdAt": "2020-08-31T19:02:06Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/bootstrap/Installer.java", "diffHunk": "@@ -73,6 +73,11 @@ public void bootstrapHub() {\n         dataHubOperator.addRole(\"hub-central-operator\");\n         dataHubOperator.save();\n \n+        User dataHubSecurityAdmin = new User(api, \"test-data-hub-security-admin\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d3c6cee6b0ea8c6d3d37996c0da199284f3cd4"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2d3c6cee6b0ea8c6d3d37996c0da199284f3cd4", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b2d3c6cee6b0ea8c6d3d37996c0da199284f3cd4", "committedDate": "2020-08-31T18:37:06Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}, "afterCommit": {"oid": "34a3aa2cb145820eb612c5cad84722d3658ff8ab", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/34a3aa2cb145820eb612c5cad84722d3658ff8ab", "committedDate": "2020-09-01T19:25:06Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMDY4ODQ2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-480068846", "createdAt": "2020-09-01T19:54:15Z", "commit": {"oid": "34a3aa2cb145820eb612c5cad84722d3658ff8ab"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTc5MDk0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-480179094", "createdAt": "2020-09-01T23:16:35Z", "commit": {"oid": "34a3aa2cb145820eb612c5cad84722d3658ff8ab"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bc1685056ab4e172087b7bc47f1515eca6127a6", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/8bc1685056ab4e172087b7bc47f1515eca6127a6", "committedDate": "2020-09-02T04:46:53Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34a3aa2cb145820eb612c5cad84722d3658ff8ab", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/34a3aa2cb145820eb612c5cad84722d3658ff8ab", "committedDate": "2020-09-01T19:25:06Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}, "afterCommit": {"oid": "8bc1685056ab4e172087b7bc47f1515eca6127a6", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/8bc1685056ab4e172087b7bc47f1515eca6127a6", "committedDate": "2020-09-02T04:46:53Z", "message": "DHFPROD-5571:Allow DHS users to define and deploy Amps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNDkzMTM2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-480493136", "createdAt": "2020-09-02T05:28:17Z", "commit": {"oid": "8bc1685056ab4e172087b7bc47f1515eca6127a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzEzNDMx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-480713431", "createdAt": "2020-09-02T11:08:26Z", "commit": {"oid": "8bc1685056ab4e172087b7bc47f1515eca6127a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwOTg4MTM3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4487#pullrequestreview-480988137", "createdAt": "2020-09-02T16:19:40Z", "commit": {"oid": "8bc1685056ab4e172087b7bc47f1515eca6127a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2174, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}