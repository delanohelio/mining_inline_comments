{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2NzQyODE0", "number": 4114, "title": "DHFPROD-4180: Delete entity model", "bodyText": "Description\n\nAdded two new endpoints\n\nGET /api/models/{modelName}/references - Returns the usage of the model in steps and other models\nDELETE /api/models/{modelName} - Deletes the model\n\n\nUpdated hub-central-entity-model-writer role to make it work with deletion.\nAdded update permission for data-hub-entity-model-writer role on schema and TDE docs.\nFixed the baseUri to include the closing /\n\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-06-18T20:21:19Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114", "merged": true, "mergeCommit": {"oid": "d0996a2ad471151b1a51136fd074924797920453"}, "closed": true, "closedAt": "2020-06-22T18:27:38Z", "author": {"login": "akshaysonvane"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcskZXHAFqTQzMzYxOTc2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABct1E39AFqTQzNTE3MDE1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNjE5NzY3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#pullrequestreview-433619767", "createdAt": "2020-06-18T20:23:02Z", "commit": {"oid": "499bdabdf6b331062396150dae900a0dc871fc47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMDoyMzowMlrOGl-78A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMDoyMzowMlrOGl-78A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4MTY0OA==", "bodyText": "We need this for deploying search options.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r442481648", "createdAt": "2020-06-18T20:23:02Z", "author": {"login": "akshaysonvane"}, "path": "marklogic-data-hub/src/main/resources/hub-internal-config/security/roles/data-hub-entity-model-writer.json", "diffHunk": "@@ -2,13 +2,19 @@\n   \"role-name\": \"data-hub-entity-model-writer\",\n   \"description\": \"Permits updating entity model documents\",\n   \"role\": [\n-    \"data-hub-common-writer\"\n+    \"data-hub-common-writer\",\n+    \"tde-admin\"\n   ],\n   \"privilege\": [\n     {\n       \"privilege-name\": \"any-uri\",\n       \"action\": \"http://marklogic.com/xdmp/privileges/any-uri\",\n       \"kind\": \"execute\"\n+    },\n+    {\n+      \"privilege-name\": \"rest-admin\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499bdabdf6b331062396150dae900a0dc871fc47"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNjIwMzM5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#pullrequestreview-433620339", "createdAt": "2020-06-18T20:23:57Z", "commit": {"oid": "499bdabdf6b331062396150dae900a0dc871fc47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMDoyMzo1N1rOGl-9og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMDoyMzo1N1rOGl-9og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4MjA4Mg==", "bodyText": "We need this so the TDE's can be updated once we delete the entity model.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r442482082", "createdAt": "2020-06-18T20:23:57Z", "author": {"login": "akshaysonvane"}, "path": "marklogic-data-hub/src/main/resources/hub-internal-config/security/roles/data-hub-entity-model-writer.json", "diffHunk": "@@ -2,13 +2,19 @@\n   \"role-name\": \"data-hub-entity-model-writer\",\n   \"description\": \"Permits updating entity model documents\",\n   \"role\": [\n-    \"data-hub-common-writer\"\n+    \"data-hub-common-writer\",\n+    \"tde-admin\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499bdabdf6b331062396150dae900a0dc871fc47"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNjI3OTE3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#pullrequestreview-433627917", "createdAt": "2020-06-18T20:35:59Z", "commit": {"oid": "499bdabdf6b331062396150dae900a0dc871fc47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMDozNTo1OVrOGl_T9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMDozNTo1OVrOGl_T9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4Nzc5Ng==", "bodyText": "Moved TDE deletion from the trigger to this data service.\nThe previous TDE deletion code in the trigger module wasn't working as the URL for trigger document needs the model version which can only be obtained from the entity model that was originally deleted.\nIn order to make that work, we would have needed to perform a point in time query to fetch the entity model using something like this: xdmp:request-timestamp()-1.\nAs this is a post-commit trigger the task would be queued in the task server and run sometime after the original transaction commits. Since request timestamp value refers to when the task server executes the task and not the original deletion request, there wouldn\u2019t be a reliable way to fetch the file in time.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r442487796", "createdAt": "2020-06-18T20:35:59Z", "author": {"login": "akshaysonvane"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/models/deleteModel.sjs", "diffHunk": "@@ -19,8 +19,23 @@ const ds = require(\"/data-hub/5/data-services/ds-utils.sjs\");\n const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n \n var entityName;\n-if (entityName === undefined || entityName === null) {\n+if (!entityName) {\n   ds.throwBadRequest(\"Must specify a name in order to delete an entity model\");\n }\n \n+const entityModel = entityLib.findModelByEntityName(entityName);\n+if (!entityModel) {\n+  ds.throwServerError(`Could not find entity model with name: ${entityName}`);\n+}\n+\n+const entityTypeId = entityLib.getEntityTypeId(entityModel, entityName);\n+const entityModelUri = entityLib.getModelUri(entityName);\n+\n+const steps = entityLib.findModelReferencesInSteps(entityName, entityTypeId);\n+if (steps.length) {\n+  ds.throwServerError(`Cannot delete the entity type '${entityName}' because it is referenced by the following step names: ${steps}`);\n+}\n+\n entityLib.deleteModel(entityName);\n+entityLib.deleteModelReferencesInOtherModels(entityModelUri, entityTypeId);\n+entityLib.deleteModelRelatedTDE(entityName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499bdabdf6b331062396150dae900a0dc871fc47"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNjcyNTQx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#pullrequestreview-433672541", "createdAt": "2020-06-18T21:51:41Z", "commit": {"oid": "499bdabdf6b331062396150dae900a0dc871fc47"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMTo1MTo0MVrOGmBbJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMTo1MzowM1rOGmBdRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMjQwNg==", "bodyText": "There are a few other tests that depend on this folder - let's hold off on renaming this, as it's adding to the number of files modified in this PR.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r442522406", "createdAt": "2020-06-18T21:51:41Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/ApplyDownloadedZipToProjectTest.java", "diffHunk": "@@ -36,7 +36,7 @@\n      */\n     @Test\n     void deleteOneEntityThenDownloadAndApply() {\n-        installProjectInFolder(\"test-projects/all-artifacts\");\n+        installProjectInFolder(\"test-projects/download-artifacts\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499bdabdf6b331062396150dae900a0dc871fc47"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMjk0OQ==", "bodyText": "While this is a good change, let's hold off on in and use a separate JIRA/PR to clean up the copyright years. I did a quick search, and there are a lot more issues to fix than just these. It'll shrink the size of this PR which is good too, since it has some complex stuff in it.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r442522949", "createdAt": "2020-06-18T21:53:03Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/models/getPrimaryEntityTypes.sjs", "diffHunk": "@@ -1,5 +1,5 @@\n /*\n-  Copyright 2012-2019 MarkLogic Corporation\n+  Copyright (c) 2020 MarkLogic Corporation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499bdabdf6b331062396150dae900a0dc871fc47"}, "originalPosition": 3}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "499bdabdf6b331062396150dae900a0dc871fc47", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/499bdabdf6b331062396150dae900a0dc871fc47", "committedDate": "2020-06-18T20:19:28Z", "message": "DHFPROD-4180: Delete entity model"}, "afterCommit": {"oid": "586bcb28b49b7af71c033acd179c002c0f218e07", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/586bcb28b49b7af71c033acd179c002c0f218e07", "committedDate": "2020-06-18T22:29:41Z", "message": "DHFPROD-4180: Delete entity model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MzQ2MTgy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#pullrequestreview-434346182", "createdAt": "2020-06-19T21:18:38Z", "commit": {"oid": "c4a124c1120fa1ebad0b26f2ba5c94c5ed41c913"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4a124c1120fa1ebad0b26f2ba5c94c5ed41c913", "author": {"user": {"login": "rjrudin", "name": null}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c4a124c1120fa1ebad0b26f2ba5c94c5ed41c913", "committedDate": "2020-06-19T17:02:56Z", "message": "DHFPROD-4180: Fixing entity-model-delete-trigger\n\nThis simplifies 4180, as we don't need any additional code now to delete the TDE. \n\nMade one permissions fix in entity-model-trigger, but I am thinking that once the test is running as only hub-central-entity-model-writer, we'll need to fix the permissions on the trigger resource files so that they use data-hub-common instead of data-hub-operator."}, "afterCommit": {"oid": "c99842fef1e71a10c8064f9d60a7b8db08856f92", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/c99842fef1e71a10c8064f9d60a7b8db08856f92", "committedDate": "2020-06-19T23:18:38Z", "message": "DHFPROD-4180: Delete entity model"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95e057bcbeeb46dc58f3588241776d7f3ba09260", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/95e057bcbeeb46dc58f3588241776d7f3ba09260", "committedDate": "2020-06-20T01:46:00Z", "message": "DHFPROD-4180: Delete entity model"}, "afterCommit": {"oid": "bf30fb133ca9217098757fe619c18aa56bb17ac9", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/bf30fb133ca9217098757fe619c18aa56bb17ac9", "committedDate": "2020-06-20T01:49:13Z", "message": "DHFPROD-4180: Delete entity model"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf30fb133ca9217098757fe619c18aa56bb17ac9", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/bf30fb133ca9217098757fe619c18aa56bb17ac9", "committedDate": "2020-06-20T01:49:13Z", "message": "DHFPROD-4180: Delete entity model"}, "afterCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/3cb193feff072b96ea7d2a06318fc27d66f6775c", "committedDate": "2020-06-20T20:15:10Z", "message": "DHFPROD-4180: Delete entity model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0OTg0OTUw", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#pullrequestreview-434984950", "createdAt": "2020-06-22T14:34:52Z", "commit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNDozNDo1MlrOGnDe9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNDo1MjoyNFrOGnETOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwNDcyNg==", "bodyText": "I think it's important to document why we're not doing anything with indexes or protected paths here because we don't have a reliable way to identify the ones to delete and we only expect entity types to be deleted in a development environment where it's usually fine if some old indexes / protected paths hang around. I say this because when I looked at this, I immediately thought - what about indexes? - before remembering that we're taking the approach above. 6 months from now, we'll be glad we have a comment here explaining why.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r443604726", "createdAt": "2020-06-22T14:34:52Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -90,6 +90,21 @@\n         return new ResponseEntity<>(HttpStatus.OK);\n     }\n \n+    @RequestMapping(value = \"/{modelName}\", method = RequestMethod.DELETE)\n+    @Secured(\"ROLE_writeEntityModel\")\n+    public ResponseEntity<Void> deleteModel(@PathVariable String modelName) {\n+        newService().deleteModel(modelName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwOTEyNw==", "bodyText": "I appreciate the intent here, but I don't think it's easy for a reader to understand what's going on here. I think a more descriptive method name would be \"doAsDeveloperAndThenLoginAs\" but that's pretty wordy.\nI actually prefer how it reads before. I think the only thing being avoided by the new approach is the call to \"loginAsTestUserWithRoles\", and I think it's beneficial for a reader to see that so the reader knows that the user is being switched. I'm good with shortening that to loginAsTestUser(String... roles), I think the \"WithRoles\" is probably unnecessary.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r443609127", "createdAt": "2020-06-22T14:40:22Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MappingControllerTest.java", "diffHunk": "@@ -31,11 +31,10 @@\n \n     @Test\n     void testValidateMappings() throws Exception {\n-        runAsDataHubDeveloper();\n-        ReferenceModelProject project = installOnlyReferenceModelEntities();\n-        project.createRawCustomer(1, \"Jane\");\n-\n-        loginAsTestUserWithRoles(\"hub-central-mapping-reader\");\n+        elevateToDeveloperRole(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwOTc0Nw==", "bodyText": "WithMockUser shouldn't be needed anymore, right?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r443609747", "createdAt": "2020-06-22T14:41:11Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/DeleteModelTest.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.marklogic.hub.central.controllers.model;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.DatabaseClient;\n+import com.marklogic.client.FailedRequestException;\n+import com.marklogic.client.document.GenericDocumentManager;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.central.controllers.ModelController;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.util.function.Consumer;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class DeleteModelTest extends AbstractModelTest {\n+\n+    @Autowired\n+    ModelController controller;\n+\n+    @Test\n+    @WithMockUser(roles = {\"writeEntityModel\"})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxMDUyMA==", "bodyText": "Since the \"models\" list contains entity names, this should really be called \"entityNames\", not \"models\". My assumption is that if something is called \"models\", it's a list of JSON entity models.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r443610520", "createdAt": "2020-06-22T14:42:10Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -253,4 +268,9 @@ private ModelsService newService() {\n     public static class UpdateModelInfoInput {\n         public String description;\n     }\n+\n+    public static class ModelReferencesInfo {\n+        public List<String> steps;\n+        public List<String> models;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxMTY1OA==", "bodyText": "Pinging @ryanjdew  on this - why the change here? I believe \"/\" was included to ensure that the base URI ends with a \"/\" which I think is a requirement of ES. Perhaps the \"/\" should only be included if info.getBaseUri() doesn't end with \"/\"?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r443611658", "createdAt": "2020-06-22T14:43:40Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/mapping/MappingImpl.java", "diffHunk": "@@ -61,7 +61,7 @@ public MappingImpl(String name, HubEntity entity) {\n         if (entity != null) {\n             InfoType info = entity.getInfo();\n             if (info != null) {\n-                String prefix = info.getBaseUri() != null ? info.getBaseUri() + \"/\" : \"\";\n+                String prefix = info.getBaseUri() != null ? info.getBaseUri() : \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxMzgyMQ==", "bodyText": "Note that when you do need a no-arg no-return-value interface in the future, you can just use Runnable instead.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r443613821", "createdAt": "2020-06-22T14:46:35Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/testFixtures/java/com/marklogic/hub/test/Action.java", "diffHunk": "@@ -0,0 +1,11 @@\n+package com.marklogic.hub.test;\n+\n+/**\n+ * Represents an operation that accepts no input arguments and returns no\n+ * result.\n+ */\n+@FunctionalInterface\n+public interface Action {\n+    \n+    void execute();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxNjA5NQ==", "bodyText": "I think you just need mapping.toObject() here? Could get fancy and do this (I think this works - I also often like to declare a query in a separate variable so it's easy to understand outside of the context where it's used, and the variable name can describe the intent of the query):\nconst mappingQuery = ...\nconst steps = cts.search(mappingQuery).toArray().map(mapping => mapping.toObject().name);", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r443616095", "createdAt": "2020-06-22T14:49:40Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/impl/entity-lib.sjs", "diffHunk": "@@ -208,6 +209,97 @@ function deleteModel(entityName) {\n   }\n }\n \n+/**\n+ * Returns the step names that contain a reference to the supplied entity.\n+ * The targetEntityType for mapping artifacts is checked against both an entityName or an entityTypeId.\n+ *\n+ * @param entityName\n+ * @param entityTypeId\n+ * @returns {[]}\n+ */\n+function findModelReferencesInSteps(entityName, entityTypeId) {\n+  const steps = [];\n+  const mappingArtifacts = cts.search(cts.andQuery([\n+    cts.collectionQuery('http://marklogic.com/data-hub/mappings'),\n+    cts.jsonPropertyValueQuery(\"targetEntityType\", [entityName, entityTypeId])\n+  ]));\n+  mappingArtifacts.toObject()\n+    .forEach(mapping => {\n+      mapping = JSON.parse(mapping);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxNzAxMg==", "bodyText": "I think this should say \"Must specify a name in order to get model references\"", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r443617012", "createdAt": "2020-06-22T14:50:53Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/models/getModelReferences.sjs", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+  Copyright (c) 2020 MarkLogic Corporation\n+\n+  Licensed under the Apache License, Version 2.0 (the \"License\");\n+  you may not use this file except in compliance with the License.\n+  You may obtain a copy of the License at\n+\n+     http://www.apache.org/licenses/LICENSE-2.0\n+\n+  Unless required by applicable law or agreed to in writing, software\n+  distributed under the License is distributed on an \"AS IS\" BASIS,\n+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  See the License for the specific language governing permissions and\n+  limitations under the License.\n+*/\n+'use strict';\n+\n+const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n+const ds = require(\"/data-hub/5/data-services/ds-utils.sjs\");\n+\n+\n+var entityName;\n+if (!entityName) {\n+  ds.throwBadRequest(\"Must specify a name in order to delete an entity model\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxNzU4NQ==", "bodyText": "I think we have to say \"step and/or mapping names\", since the list may contain legacy mapping names, which can be different from the names of the steps that reference them.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r443617585", "createdAt": "2020-06-22T14:51:43Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/data-services/models/deleteModel.sjs", "diffHunk": "@@ -19,8 +19,22 @@ const ds = require(\"/data-hub/5/data-services/ds-utils.sjs\");\n const entityLib = require(\"/data-hub/5/impl/entity-lib.sjs\");\n \n var entityName;\n-if (entityName === undefined || entityName === null) {\n+if (!entityName) {\n   ds.throwBadRequest(\"Must specify a name in order to delete an entity model\");\n }\n \n+const entityModel = entityLib.findModelByEntityName(entityName);\n+if (!entityModel) {\n+  ds.throwServerError(`Could not find entity model with name: ${entityName}`);\n+}\n+\n+const entityTypeId = entityLib.getEntityTypeId(entityModel, entityName);\n+const entityModelUri = entityLib.getModelUri(entityName);\n+\n+const steps = entityLib.findModelReferencesInSteps(entityName, entityTypeId);\n+if (steps.length) {\n+  ds.throwServerError(`Cannot delete the entity type '${entityName}' because it is referenced by the following step names: ${steps}`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxODEwNg==", "bodyText": "A \"step\" is a JSON object. Looking at the impl below, it looks like these are step names, with one exception - mapping names can be in here as well (sigh). To account for this, I think it's best to be verbose here and call this \"stepAndMappingNames\", because the list can contain a combination of step and mapping names. That's not pretty, but it captures the reality.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#discussion_r443618106", "createdAt": "2020-06-22T14:52:24Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -253,4 +268,9 @@ private ModelsService newService() {\n     public static class UpdateModelInfoInput {\n         public String description;\n     }\n+\n+    public static class ModelReferencesInfo {\n+        public List<String> steps;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDk0MDYx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#pullrequestreview-435094061", "createdAt": "2020-06-22T16:35:07Z", "commit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3cb193feff072b96ea7d2a06318fc27d66f6775c", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/3cb193feff072b96ea7d2a06318fc27d66f6775c", "committedDate": "2020-06-20T20:15:10Z", "message": "DHFPROD-4180: Delete entity model"}, "afterCommit": {"oid": "9bed829cf79edf69981f6c846114c78936faef13", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9bed829cf79edf69981f6c846114c78936faef13", "committedDate": "2020-06-22T16:42:46Z", "message": "DHFPROD-4180: Delete entity model"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9bed829cf79edf69981f6c846114c78936faef13", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/9bed829cf79edf69981f6c846114c78936faef13", "committedDate": "2020-06-22T16:42:46Z", "message": "DHFPROD-4180: Delete entity model"}, "afterCommit": {"oid": "b981c75ad1a80a87b47ef4a165d22155a235919d", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b981c75ad1a80a87b47ef4a165d22155a235919d", "committedDate": "2020-06-22T17:05:39Z", "message": "DHFPROD-4180: Delete entity model"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32d5f3bbd0781ec0301d78fab870751af060fa25", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/32d5f3bbd0781ec0301d78fab870751af060fa25", "committedDate": "2020-06-22T17:07:00Z", "message": "DHFPROD-4180: Delete entity model"}, "afterCommit": {"oid": "4095330c63e7de5046861e83d87d81c80af384a9", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4095330c63e7de5046861e83d87d81c80af384a9", "committedDate": "2020-06-22T17:07:23Z", "message": "DHFPROD-4180: Delete entity model"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6ecf6f0f3e31c5bcac0130d467701d143cebf31", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/f6ecf6f0f3e31c5bcac0130d467701d143cebf31", "committedDate": "2020-06-22T17:10:06Z", "message": "DHFPROD-4180: Delete entity model"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4095330c63e7de5046861e83d87d81c80af384a9", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/4095330c63e7de5046861e83d87d81c80af384a9", "committedDate": "2020-06-22T17:07:23Z", "message": "DHFPROD-4180: Delete entity model"}, "afterCommit": {"oid": "f6ecf6f0f3e31c5bcac0130d467701d143cebf31", "author": {"user": {"login": "akshaysonvane", "name": "Akshay Sonvane"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/f6ecf6f0f3e31c5bcac0130d467701d143cebf31", "committedDate": "2020-06-22T17:10:06Z", "message": "DHFPROD-4180: Delete entity model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MTU0ODE2", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#pullrequestreview-435154816", "createdAt": "2020-06-22T17:59:50Z", "commit": {"oid": "f6ecf6f0f3e31c5bcac0130d467701d143cebf31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MTcwMTUy", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4114#pullrequestreview-435170152", "createdAt": "2020-06-22T18:22:58Z", "commit": {"oid": "f6ecf6f0f3e31c5bcac0130d467701d143cebf31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2824, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}