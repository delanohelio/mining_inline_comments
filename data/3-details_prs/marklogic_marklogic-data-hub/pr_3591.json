{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3MzIzNDg0", "number": 3591, "title": "DHFPROD-4308: Middle-Tier: Create extension to existing mapping artif\u2026", "bodyText": "https://project.marklogic.com/jira/browse/DHFPROD-4308", "createdAt": "2020-02-19T18:32:11Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591", "merged": true, "mergeCommit": {"oid": "75e1e7361610b526ab2649eb8b8cbd61b7de6fe7"}, "closed": true, "closedAt": "2020-02-21T18:05:24Z", "author": {"login": "hao1st"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcF63CngH2gAyMzc3MzIzNDg0OjQ0NDEzMjQ0NmM4YjU3YzI4OGM0YmNkMGRiZjUxOTk1ZDVkZjIwZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGjRTIAFqTM2Mjc5NzgxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "444132446c8b57c288c4bcd0dbf51995d5df20e5", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/444132446c8b57c288c4bcd0dbf51995d5df20e5", "committedDate": "2020-02-19T18:30:19Z", "message": "DHFPROD-4308: Middle-Tier: Create extension to existing mapping artifact API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35af2da18b5b64fabe60abf9cfda9f32755627c7", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/35af2da18b5b64fabe60abf9cfda9f32755627c7", "committedDate": "2020-02-19T19:42:28Z", "message": "DHFPROD-4308: moved the collection api endpoint to one-ui"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNDMwODg0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#pullrequestreview-361430884", "createdAt": "2020-02-19T20:57:22Z", "commit": {"oid": "35af2da18b5b64fabe60abf9cfda9f32755627c7"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMDo1NzoyM1rOFr3VpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMToxMToxMFrOFr3wIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUzOTc0OQ==", "bodyText": "You don't need this loop here, just do:\nreturn cts.search(...).toArray();", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381539749", "createdAt": "2020-02-19T20:57:23Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -56,11 +58,42 @@ function getArtifacts(artifactType) {\n         queriesForAnd.push(cts.collectionQuery(coll));\n     }\n     if (queriesForAnd.length) {\n-        const results = cts.search(queriesForAnd.length > 1 ? cts.andQuery(queriesForAnd) : queriesForAnd[0]);\n-        for (const result of results) {\n-            artifacts.push(result.toObject());\n+        if (artifactType == \"loadData\") {\n+            const results = cts.search(queriesForAnd.length > 1 ? cts.andQuery(queriesForAnd) : queriesForAnd[0]);\n+            for (const result of results) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35af2da18b5b64fabe60abf9cfda9f32755627c7"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU0MTgwMg==", "bodyText": "This is doing N queries, where N = entityNames.length. It's faster/better to do a single query - just pass entityNames into the cts.jsonPropertyValueQuery. Then iterate over the results with a map function. Can get it all done this simply (I often refer to https://www.w3schools.com/jsref/jsref_obj_array.asp for things like this):\nfunction getArtifactsGroupByEntity(artifactType, queriesForAnd) {\n  cts.search(cts.andQuery(queriesForAnd.concat(cts.jsonPropertyValueQuery(\"entityName\", getEntityNames())).map(config => {\n    const configByEntity = {\n      name: config.path.to.entityName (I don't know the path)\n    };\n    switch(artifactType) {\n    ....\n    }\n    return configByEntity;\n  });\n}\n\nNote the use of \"concat\" to avoid modifying the queriesForAnd array that's passed in.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381541802", "createdAt": "2020-02-19T21:01:22Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -56,11 +58,42 @@ function getArtifacts(artifactType) {\n         queriesForAnd.push(cts.collectionQuery(coll));\n     }\n     if (queriesForAnd.length) {\n-        const results = cts.search(queriesForAnd.length > 1 ? cts.andQuery(queriesForAnd) : queriesForAnd[0]);\n-        for (const result of results) {\n-            artifacts.push(result.toObject());\n+        if (artifactType == \"loadData\") {\n+            const results = cts.search(queriesForAnd.length > 1 ? cts.andQuery(queriesForAnd) : queriesForAnd[0]);\n+            for (const result of results) {\n+                artifacts.push(result.toObject());\n+            }\n+            return artifacts;\n+        } else {\n+            return getArtifactsGroupbyEntity(artifactType, queriesForAnd)\n         }\n     }\n+    return [];\n+}\n+\n+function getArtifactsGroupbyEntity(artifactType, queriesForAnd) {\n+    const artifacts = [];\n+    const entityNames = getEntityNames();\n+    for (const ename of entityNames) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35af2da18b5b64fabe60abf9cfda9f32755627c7"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU0Mjk1Ng==", "bodyText": "Ideally, this service wouldn't have much knowledge of the concrete artifact types. Is it necessary to store the \"configs\" under different key names? Couldn't it just be \"config\" or \"settings\", regardless of the artifact type?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381542956", "createdAt": "2020-02-19T21:03:47Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -56,11 +58,42 @@ function getArtifacts(artifactType) {\n         queriesForAnd.push(cts.collectionQuery(coll));\n     }\n     if (queriesForAnd.length) {\n-        const results = cts.search(queriesForAnd.length > 1 ? cts.andQuery(queriesForAnd) : queriesForAnd[0]);\n-        for (const result of results) {\n-            artifacts.push(result.toObject());\n+        if (artifactType == \"loadData\") {\n+            const results = cts.search(queriesForAnd.length > 1 ? cts.andQuery(queriesForAnd) : queriesForAnd[0]);\n+            for (const result of results) {\n+                artifacts.push(result.toObject());\n+            }\n+            return artifacts;\n+        } else {\n+            return getArtifactsGroupbyEntity(artifactType, queriesForAnd)\n         }\n     }\n+    return [];\n+}\n+\n+function getArtifactsGroupbyEntity(artifactType, queriesForAnd) {\n+    const artifacts = [];\n+    const entityNames = getEntityNames();\n+    for (const ename of entityNames) {\n+        let configByEntity = {};\n+        configByEntity.name = ename;\n+        queriesForAnd.push(cts.jsonPropertyValueQuery(\"entityName\", ename));\n+        let configs = cts.search(cts.andQuery(queriesForAnd));\n+        // artifactType can be mapping, mastering, merging\n+        switch (artifactType) {\n+            case \"mapping\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35af2da18b5b64fabe60abf9cfda9f32755627c7"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU0NTIxMQ==", "bodyText": "You can use \"map\" here to cut out a good chunk of code:\ncts.search(...).toArray().map(e => e.xpath(\"//info//title\");", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381545211", "createdAt": "2020-02-19T21:08:30Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -225,6 +258,16 @@ function deleteArtifactSettings(artifactType, artifactName, artifactVersion = 'l\n     return { success: true };\n }\n \n+function getEntityNames() {\n+    let entities = cts.search(cts.collectionQuery(\"http://marklogic.com/entity-services/models\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35af2da18b5b64fabe60abf9cfda9f32755627c7"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU0NTQ1NQ==", "bodyText": "This seems like it can be deleted?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381545455", "createdAt": "2020-02-19T21:08:57Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/main/java/com/marklogic/hub/curation/controllers/CollectionsController.java", "diffHunk": "@@ -0,0 +1,4 @@\n+package com.marklogic.hub.curation.controllers;\n+\n+public class CollectionsController {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35af2da18b5b64fabe60abf9cfda9f32755627c7"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU0NjUyOA==", "bodyText": "This doesn't appear to be used anywhere, so it should be deleted.\nIf there is a need for it, I'd like to talk about it. There is nothing preventing a database from having millions of collections or more. And collections are implementation details - it's very rare that we ever want to expose them to users. So I'd want to think carefully about the requirement of \"Get me all the collections except 'internal' ones\".", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381546528", "createdAt": "2020-02-19T21:11:10Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/main/java/com/marklogic/hub/curation/services/CollectionsService.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2012-2019 MarkLogic Corporation\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+package com.marklogic.hub.web.service;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.DatabaseClient;\n+import com.marklogic.client.extensions.ResourceManager;\n+import com.marklogic.client.extensions.ResourceServices;\n+import com.marklogic.client.io.JacksonHandle;\n+import com.marklogic.client.util.RequestParameters;\n+import com.marklogic.hub.HubConfig;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+@Service\n+public class CollectionsService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35af2da18b5b64fabe60abf9cfda9f32755627c7"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6326a9db7939d1a13605d5827a16ffa51d3d9273", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/6326a9db7939d1a13605d5827a16ffa51d3d9273", "committedDate": "2020-02-19T21:59:02Z", "message": "DHFPROD-4308: Fixed wrong commit/push"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93f88c8007e0dd01242e91c38a11ea4295216dd3", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/93f88c8007e0dd01242e91c38a11ea4295216dd3", "committedDate": "2020-02-20T03:37:39Z", "message": "DHFPROD-4308: changed entityName to targetEntity & simplify javascript query func"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNjM0MTMx", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#pullrequestreview-361634131", "createdAt": "2020-02-20T05:01:02Z", "commit": {"oid": "93f88c8007e0dd01242e91c38a11ea4295216dd3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNTowMTowM1rOFsEhAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNTowMTowM1rOFsEhAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTc1NTY1MQ==", "bodyText": "@hao1st can we please add a test for validateArtifact?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381755651", "createdAt": "2020-02-20T05:01:03Z", "author": {"login": "bsrikan"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/mapping.sjs", "diffHunk": "@@ -0,0 +1,78 @@\n+/**\n+ Copyright 2012-2019 MarkLogic Corporation\n+\n+ Licensed under the Apache License, Version 2.0 (the \"License\");\n+ you may not use this file except in compliance with the License.\n+ You may obtain a copy of the License at\n+\n+ http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+ */\n+'use strict';\n+\n+const DataHubSingleton = require('/data-hub/5/datahub-singleton.sjs');\n+\n+// define constants for caching expensive operations\n+const dataHub = DataHubSingleton.instance();\n+\n+const collections = ['http://marklogic.com/data-hub/mapping-artifact'];\n+const databases = [dataHub.config.STAGINGDATABASE, dataHub.config.FINALDATABASE];\n+const permissions = [xdmp.permission(dataHub.consts.DATA_HUB_MAPPING_WRITE_ROLE, 'update'), xdmp.permission(dataHub.consts.DATA_HUB_MAPPING_READ_ROLE, 'read')];\n+const requiredProperties = ['name', 'targetEntity', 'selectedSource'];\n+\n+function getNameProperty() {\n+    return 'name';\n+}\n+\n+function getEntityNameProperty() {\n+    return 'targetEntity';\n+}\n+\n+function getSelectedSourceProperty() {\n+    return 'selectedSource';\n+}\n+\n+function getVersionProperty() {\n+    return null;\n+}\n+\n+function getCollections() {\n+    return collections;\n+}\n+\n+function getStorageDatabases() {\n+    return databases;\n+}\n+\n+function getPermissions() {\n+    return permissions;\n+}\n+\n+function getArtifactNode(artifactName, artifactVersion) {\n+    // Currently there is no versioning for loadData artifacts\n+    const results = cts.search(cts.andQuery([cts.collectionQuery(collections[0]), cts.jsonPropertyValueQuery('name', artifactName)]));\n+    return fn.head(results);\n+}\n+\n+function validateArtifact(artifact) {\n+    const missingProperties = requiredProperties.filter((propName) => !artifact[propName]);\n+    if (missingProperties.length) {\n+        return new Error(`Missing the following required properties: ${JSON.stringify(missingProperties)}`);\n+    }\n+    return artifact;\n+}\n+\n+module.exports = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93f88c8007e0dd01242e91c38a11ea4295216dd3"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNjM0NDM0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#pullrequestreview-361634434", "createdAt": "2020-02-20T05:02:26Z", "commit": {"oid": "93f88c8007e0dd01242e91c38a11ea4295216dd3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNTowMjoyNlrOFsEjpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNTowMjoyNlrOFsEjpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTc1NjMyNQ==", "bodyText": "Does this go with the discussion we had today. Should this be @service or @component.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381756325", "createdAt": "2020-02-20T05:02:26Z", "author": {"login": "bsrikan"}, "path": "one-ui/src/main/java/com/marklogic/hub/curation/services/CollectionsManager.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2012-2019 MarkLogic Corporation\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+package com.marklogic.hub.curation.services;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.DatabaseClient;\n+import com.marklogic.client.extensions.ResourceManager;\n+import com.marklogic.client.extensions.ResourceServices;\n+import com.marklogic.client.io.JacksonHandle;\n+import com.marklogic.client.util.RequestParameters;\n+import com.marklogic.hub.oneui.models.HubConfigSession;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class CollectionsManager {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93f88c8007e0dd01242e91c38a11ea4295216dd3"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91c8cc4f9ff194cf371ef657160fc4e217b64a84", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/91c8cc4f9ff194cf371ef657160fc4e217b64a84", "committedDate": "2020-02-20T06:09:14Z", "message": "DHFPROD-4308: Optimize query to get configs grouped by entity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc5368ed4abad2fd4f6f8f907be46e49b26c9a81", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/fc5368ed4abad2fd4f6f8f907be46e49b26c9a81", "committedDate": "2020-02-20T06:30:25Z", "message": "DHFPROD-4308: changed annotation from service to component"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxODg3OTc0", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#pullrequestreview-361887974", "createdAt": "2020-02-20T13:12:34Z", "commit": {"oid": "fc5368ed4abad2fd4f6f8f907be46e49b26c9a81"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzoxMjozNFrOFsSv0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzoxNzoxOVrOFsS5Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4ODgxNw==", "bodyText": "For consistency, shouldn't this be \"mappings\" and \"Mappings\"?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381988817", "createdAt": "2020-02-20T13:12:34Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -26,7 +27,8 @@ const cachedArtifacts = {};\n const registeredArtifactTypes = {\n     loadData: LoadData,\n     flows: Flows,\n-    stepDefinitions: StepDefs\n+    stepDefinitions: StepDefs,\n+    mapping: Mapping", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc5368ed4abad2fd4f6f8f907be46e49b26c9a81"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk5MDAyMw==", "bodyText": "Is this returning artifacts, or configs, or settings? Are \"configs\" the same as \"settings\"? I don't think this is returning artifacts, which are the actual flows/stepDefinitions/mappings/etc. The variables indicate that these are \"configs\", so I'm wondering if those are the same as \"settings\".", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381990023", "createdAt": "2020-02-20T13:15:05Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -49,19 +51,31 @@ function getTypesInfo() {\n }\n \n function getArtifacts(artifactType) {\n-    const artifacts = [];\n     const queriesForAnd = [];\n     const artifactLibrary =  getArtifactTypeLibrary(artifactType);\n     for (const coll of artifactLibrary.getCollections()) {\n         queriesForAnd.push(cts.collectionQuery(coll));\n     }\n     if (queriesForAnd.length) {\n-        const results = cts.search(queriesForAnd.length > 1 ? cts.andQuery(queriesForAnd) : queriesForAnd[0]);\n-        for (const result of results) {\n-            artifacts.push(result.toObject());\n+        if (artifactType == \"loadData\") {\n+            return cts.search(queriesForAnd.length > 1 ? cts.andQuery(queriesForAnd) : queriesForAnd[0]).toArray();\n+        } else {\n+            return getArtifactsGroupByEntity(queriesForAnd)\n         }\n     }\n-    return artifacts;\n+    return [];\n+}\n+\n+function getArtifactsGroupByEntity(queriesForAnd) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc5368ed4abad2fd4f6f8f907be46e49b26c9a81"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk5MDg5Nw==", "bodyText": "This is still in the PR, it should be removed, right?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381990897", "createdAt": "2020-02-20T13:16:43Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/main/java/com/marklogic/hub/curation/controllers/CollectionsController.java", "diffHunk": "@@ -0,0 +1,4 @@\n+package com.marklogic.hub.curation.controllers;\n+\n+public class CollectionsController {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU0NTQ1NQ=="}, "originalCommit": {"oid": "35af2da18b5b64fabe60abf9cfda9f32755627c7"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk5MTE5MQ==", "bodyText": "I don't think this class is supposed to be in here, right? It's only used by CollectionsCOntroller, which isn't used - nor seems relevant to DHFPROD-4308.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r381991191", "createdAt": "2020-02-20T13:17:19Z", "author": {"login": "rjrudin"}, "path": "one-ui/src/main/java/com/marklogic/hub/curation/services/CollectionsManager.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2012-2019 MarkLogic Corporation\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+package com.marklogic.hub.curation.services;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.client.DatabaseClient;\n+import com.marklogic.client.extensions.ResourceManager;\n+import com.marklogic.client.extensions.ResourceServices;\n+import com.marklogic.client.io.JacksonHandle;\n+import com.marklogic.client.util.RequestParameters;\n+import com.marklogic.hub.oneui.models.HubConfigSession;\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class CollectionsManager {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTc1NjMyNQ=="}, "originalCommit": {"oid": "93f88c8007e0dd01242e91c38a11ea4295216dd3"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8096d7050cece99405ee0892eed71dcbd23ebf7", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/a8096d7050cece99405ee0892eed71dcbd23ebf7", "committedDate": "2020-02-20T17:31:28Z", "message": "DHFPROD-4308: rename mapping and artifact"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1862b59a03cf8013bee16acb9bcb8c1b5ad5d870", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/1862b59a03cf8013bee16acb9bcb8c1b5ad5d870", "committedDate": "2020-02-20T18:30:21Z", "message": "DHFPROD-4308: add validateArtifact test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTY1ODI3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#pullrequestreview-362165827", "createdAt": "2020-02-20T19:17:57Z", "commit": {"oid": "1862b59a03cf8013bee16acb9bcb8c1b5ad5d870"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxNzo1N1rOFsf7-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxNzo1N1rOFsf7-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNDkyMQ==", "bodyText": "One nit - I would just call this \"queries\" (the plural implying that it's an array). And then it doesn't matter if there's one or more - you can just do:\ncts.search(cts.andQuery(queries)).toArray()", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#discussion_r382204921", "createdAt": "2020-02-20T19:17:57Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub/src/main/resources/ml-modules/root/data-hub/5/artifacts/core.sjs", "diffHunk": "@@ -49,19 +51,31 @@ function getTypesInfo() {\n }\n \n function getArtifacts(artifactType) {\n-    const artifacts = [];\n     const queriesForAnd = [];\n     const artifactLibrary =  getArtifactTypeLibrary(artifactType);\n     for (const coll of artifactLibrary.getCollections()) {\n         queriesForAnd.push(cts.collectionQuery(coll));\n     }\n     if (queriesForAnd.length) {\n-        const results = cts.search(queriesForAnd.length > 1 ? cts.andQuery(queriesForAnd) : queriesForAnd[0]);\n-        for (const result of results) {\n-            artifacts.push(result.toObject());\n+        if (artifactType == \"loadData\") {\n+            return cts.search(queriesForAnd.length > 1 ? cts.andQuery(queriesForAnd) : queriesForAnd[0]).toArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1862b59a03cf8013bee16acb9bcb8c1b5ad5d870"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1694b237c4ba1ab2d7c7bf477cf29ab77699772", "author": {"user": {"login": "hao1st", "name": "Hao Liu"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/b1694b237c4ba1ab2d7c7bf477cf29ab77699772", "committedDate": "2020-02-20T19:48:59Z", "message": "DHFPROD-4308: rename a better variable and query simplification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNTg1NDA5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#pullrequestreview-362585409", "createdAt": "2020-02-21T12:06:44Z", "commit": {"oid": "b1694b237c4ba1ab2d7c7bf477cf29ab77699772"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNTg1Njg3", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#pullrequestreview-362585687", "createdAt": "2020-02-21T12:07:16Z", "commit": {"oid": "b1694b237c4ba1ab2d7c7bf477cf29ab77699772"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNzk3ODEz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3591#pullrequestreview-362797813", "createdAt": "2020-02-21T17:35:12Z", "commit": {"oid": "b1694b237c4ba1ab2d7c7bf477cf29ab77699772"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2203, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}