{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NDUwMTQw", "number": 4830, "title": "DHFPROD-6217:Catch and log error if updating job doc fails", "bodyText": "Description\nCatch and log error if updating job doc fails\nChecklist:\n- Note: do not change the below\n\n\nOwner:\n\n\n JIRA_ID included in all the commit messages\n\n\n PR title is in the format JIRA_ID:Title\n\n\n Rebase the branch with upstream\n\n\n Squashed all commits into a single commit\n\n\n Added Tests\n\n\nReviewer:\n\n\n Reviewed Tests", "createdAt": "2020-11-06T02:18:11Z", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4830", "merged": true, "mergeCommit": {"oid": "1e7af4a3368f73dd9d5a917cd5a0b6c99624075a"}, "closed": true, "closedAt": "2020-11-09T22:04:40Z", "author": {"login": "srinathgit"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ1-x8gFqTUyNTEwMTAyMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABda7RIxgFqTUyNjY1MTQ5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MTAxMDIz", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4830#pullrequestreview-525101023", "createdAt": "2020-11-06T12:18:10Z", "commit": {"oid": "226a58faae3b89683686ab692f923c2ef47938e9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMjoxODoxMFrOHur4QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMjoxODoxMFrOHur4QA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcxNTQ1Ng==", "bodyText": "Is the \"or\" check here only because it will be \"started\" on ML 9? If so, this should first do a check of the ML version to see if it's ML 9, and use that to determine what the expected status should be. Same goes for the other \"or\" checks below.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4830#discussion_r518715456", "createdAt": "2020-11-06T12:18:10Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/HandleAbortedWriterTest.java", "diffHunk": "@@ -31,8 +32,10 @@ void dataSourceWriterIsAborted() {\n         assertEquals(2, getFruitCount(), \"Just verifying the two fruits were written\");\n \n         dataSourceWriter.abort(null);\n-        assertEquals(\"canceled\", getJobDocumentStatus(), \"If the DataSourceWriter is aborted for any reason, the job \" +\n+        assertTrue(getJobDocumentStatus().equals(\"canceled\") ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "226a58faae3b89683686ab692f923c2ef47938e9"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "226a58faae3b89683686ab692f923c2ef47938e9", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/226a58faae3b89683686ab692f923c2ef47938e9", "committedDate": "2020-11-06T02:16:56Z", "message": "DHFPROD-6217:Catch and log error if updating job doc fails"}, "afterCommit": {"oid": "1db7ce1868d43097fcf1aa744d37e1a34b202001", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/1db7ce1868d43097fcf1aa744d37e1a34b202001", "committedDate": "2020-11-09T18:14:36Z", "message": "DHFPROD-6217:Catch and log error if updating job doc fails"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NTUwOTM4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4830#pullrequestreview-526550938", "createdAt": "2020-11-09T18:49:16Z", "commit": {"oid": "1db7ce1868d43097fcf1aa744d37e1a34b202001"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODo0OToxNlrOHv8pQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODo1NzozMVrOHv89Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzODcyMw==", "bodyText": "Do we know why this is not working on 9.0-x? Is it something about amps and SJS functions? Whatever the reason is, it should be part of the assertion message.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4830#discussion_r520038723", "createdAt": "2020-11-09T18:49:16Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/HandleAbortedWriterTest.java", "diffHunk": "@@ -31,8 +31,14 @@ void dataSourceWriterIsAborted() {\n         assertEquals(2, getFruitCount(), \"Just verifying the two fruits were written\");\n \n         dataSourceWriter.abort(null);\n-        assertEquals(\"canceled\", getJobDocumentStatus(), \"If the DataSourceWriter is aborted for any reason, the job \" +\n-            \"document should have a status of 'canceled'. Note that this does not imply whether any writes failed. \" +\n-            \"But that is a limitation of the JobStatus class in DHF.\");\n+        if(canUpdateJobDoc()){\n+            assertEquals(\"canceled\", getJobDocumentStatus(), \"If the DataSourceWriter is aborted for any reason, the job \" +\n+                \"document should have a status of 'canceled'. Note that this does not imply whether any writes failed. \" +\n+                \"But that is a limitation of the JobStatus class in DHF.\");\n+        }\n+        else{\n+            assertEquals(\"started\", getJobDocumentStatus(), \"In case of 9.0-x server, status will remain 'started'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1db7ce1868d43097fcf1aa744d37e1a34b202001"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MjkxMg==", "bodyText": "Just to avoid duplication, toss this into a new private method - e.g verifyStatusIsStopOnError.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4830#discussion_r520042912", "createdAt": "2020-11-09T18:56:03Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteJobWithCustomEndpointsTest.java", "diffHunk": "@@ -38,7 +38,10 @@ void bothEndpointsAreCustom() {\n \n         verifyCustomInitializeEndpointIsUsed();\n         dataSourceWriter.commit(null);\n-        verifyCustomFinalizeEndpointIsUsed();\n+        assertEquals(\"stop-on-error\", getJobDocumentStatus(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1db7ce1868d43097fcf1aa744d37e1a34b202001"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MzU0MA==", "bodyText": "Actually, this can become a new protected method in AbstractSparkConnectorTest - verifyJobDocumentWasNotUpdated(). Then you can reuse it across tests.", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4830#discussion_r520043540", "createdAt": "2020-11-09T18:57:04Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/HandleAbortedWriterTest.java", "diffHunk": "@@ -31,8 +31,14 @@ void dataSourceWriterIsAborted() {\n         assertEquals(2, getFruitCount(), \"Just verifying the two fruits were written\");\n \n         dataSourceWriter.abort(null);\n-        assertEquals(\"canceled\", getJobDocumentStatus(), \"If the DataSourceWriter is aborted for any reason, the job \" +\n-            \"document should have a status of 'canceled'. Note that this does not imply whether any writes failed. \" +\n-            \"But that is a limitation of the JobStatus class in DHF.\");\n+        if(canUpdateJobDoc()){\n+            assertEquals(\"canceled\", getJobDocumentStatus(), \"If the DataSourceWriter is aborted for any reason, the job \" +\n+                \"document should have a status of 'canceled'. Note that this does not imply whether any writes failed. \" +\n+                \"But that is a limitation of the JobStatus class in DHF.\");\n+        }\n+        else{\n+            assertEquals(\"started\", getJobDocumentStatus(), \"In case of 9.0-x server, status will remain 'started'\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzODcyMw=="}, "originalCommit": {"oid": "1db7ce1868d43097fcf1aa744d37e1a34b202001"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA0MzgzMQ==", "bodyText": "Just to confirm - the try/catch is needed for the scenario where the custom finalize endpoint is used, but not the custom init endpoint?", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4830#discussion_r520043831", "createdAt": "2020-11-09T18:57:31Z", "author": {"login": "rjrudin"}, "path": "marklogic-data-hub-spark-connector/src/test/resources/custom-job-endpoints/finalizeWrite.sjs", "diffHunk": "@@ -26,4 +26,11 @@ const Jobs = require(\"/data-hub/5/impl/jobs.sjs\");\n \n const alwaysUseThisStatus = \"stop-on-error\";\n \n-Jobs.updateJob(datahub, jobId, alwaysUseThisStatus, null, null, null, null);\n+try{\n+  Jobs.updateJob(datahub, jobId, alwaysUseThisStatus, null, null, null, null);\n+}\n+catch(ex){\n+  console.log(\"Failed to update job document; cause: \" + ex);\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1db7ce1868d43097fcf1aa744d37e1a34b202001"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a61d7d4c64b313d2d8a379d1b560d4c8fe0ad79", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5a61d7d4c64b313d2d8a379d1b560d4c8fe0ad79", "committedDate": "2020-11-09T20:07:59Z", "message": "DHFPROD-6217:Catch and log error if updating job doc fails"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1db7ce1868d43097fcf1aa744d37e1a34b202001", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/1db7ce1868d43097fcf1aa744d37e1a34b202001", "committedDate": "2020-11-09T18:14:36Z", "message": "DHFPROD-6217:Catch and log error if updating job doc fails"}, "afterCommit": {"oid": "5a61d7d4c64b313d2d8a379d1b560d4c8fe0ad79", "author": {"user": {"login": "srinathgit", "name": "Srinath S"}}, "url": "https://github.com/marklogic/marklogic-data-hub/commit/5a61d7d4c64b313d2d8a379d1b560d4c8fe0ad79", "committedDate": "2020-11-09T20:07:59Z", "message": "DHFPROD-6217:Catch and log error if updating job doc fails"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjM2OTc5", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4830#pullrequestreview-526636979", "createdAt": "2020-11-09T20:41:21Z", "commit": {"oid": "5a61d7d4c64b313d2d8a379d1b560d4c8fe0ad79"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjUxNDk4", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4830#pullrequestreview-526651498", "createdAt": "2020-11-09T21:02:23Z", "commit": {"oid": "5a61d7d4c64b313d2d8a379d1b560d4c8fe0ad79"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1623, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}