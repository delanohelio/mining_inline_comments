{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5Mjk5Mjcw", "number": 2237, "title": "Adds Mapbox based Case list view and Area Mapper", "bodyText": "Integrates with https://github.com/onaio/kujaku to provide below features  -\n\nCase list \"View on Map\" with support of defining geo-overlays\n\n\nRequires cc-use-mapbox-map to be turned on in custom app properties\n\n\nBoundary Callout to walk/draw a boundary\n\nUX\nCallout Definition: org.commcare.dalvik.action.DrawBoundary\nInput Extras:\n\nmanual : If true, user can draw boundary by clicking on map. Otherwise, user needs to walk the boundary to be able to record it.\naccuracy : Minimum accuracy required to record a location coordinate as a boundary point. Only applicable if manual is not set.\ninterval_meters: Minimum distance required between two auto recorded location when manual is not set.\ninterval_millis: Minimum time required between two auto recorded location when manual is not set.\ntitle : Static headline display on top of the screen as user draws the boundary\ndetail: Static detail display on top of the screen as user draws the boundary\nimage: whether to include a map snapshot in the result\ncoordinates: Coordinates for a boundary that can be displayed on a map\n\nResponse Extras:\n\ncoordinates: Corrdinates for individual points in the boundary\nperimeter: Perimeter of the boundary\nimage: final snapshot of the map, only included when image is set to true in input extras\nodk_intent_data: Area of the boundary\n\nSample App\nSupported Kujaku PRs: https://github.com/onaio/kujaku/pulls/shubham1g5\nProduct Note:\n\nIntegrates with Mapbox based library Kujaku to provide better GIS capabilities like viewing cases on Map and mapping a boundary in an Xform.\nDeprecates support for Android 4.0\n\ncross-request: dimagi/commcare-core#895", "createdAt": "2020-05-18T07:00:51Z", "url": "https://github.com/dimagi/commcare-android/pull/2237", "merged": true, "mergeCommit": {"oid": "52030b719610f81b160d84b67ac9e6b979446423"}, "closed": true, "closedAt": "2020-05-29T05:47:17Z", "author": {"login": "shubham1g5"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABawJ5LAAH2gAyNDE5Mjk5MjcwOmM2MjIwZDk0YmI1NjNmOTdiYjM4OTYwZGNhYTZiY2Q1NTlkNzk0YzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl2ve2gFqTQyMDU2NTc0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c6220d94bb563f97bb38960dcaa6bcd559d794c2", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/c6220d94bb563f97bb38960dcaa6bcd559d794c2", "committedDate": "2019-05-29T07:23:44Z", "message": "Adds Kajaku Dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11dbc676cfcbe3a18212bde207b834f45fc9d264", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/11dbc676cfcbe3a18212bde207b834f45fc9d264", "committedDate": "2020-04-09T07:24:26Z", "message": "Merge branch 'master' into kujaku"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a15a8a60e54a54b2e8a617c2fe279e15d9cb5c9", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/5a15a8a60e54a54b2e8a617c2fe279e15d9cb5c9", "committedDate": "2020-04-09T07:33:29Z", "message": "lib update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a5a659e034698f083e50e264bb96ff865e4de4b", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/2a5a659e034698f083e50e264bb96ff865e4de4b", "committedDate": "2020-04-09T08:29:44Z", "message": "init kujaku"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac15c0b2726ad3555c9292130320e4ed6cda39e1", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/ac15c0b2726ad3555c9292130320e4ed6cda39e1", "committedDate": "2020-04-09T08:56:58Z", "message": "Skips Kujaku for test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "961854a652c2df8e901db27c3af5b2457fbf1be5", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/961854a652c2df8e901db27c3af5b2457fbf1be5", "committedDate": "2020-04-21T11:39:16Z", "message": "Merge branch 'formSubmissionsScheduling' into kujaku"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5289063a1c7a8fb008157444717c26938a0d8c89", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/5289063a1c7a8fb008157444717c26938a0d8c89", "committedDate": "2020-04-21T11:52:17Z", "message": "Merge branch 'master' into kujaku"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06cf3026b43502032b496b5e5221f70baf83bf9e", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/06cf3026b43502032b496b5e5221f70baf83bf9e", "committedDate": "2020-04-21T11:54:20Z", "message": "Remove init from Application"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "514dd4b8824bff7f67f4526275dbac9169f8d6c4", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/514dd4b8824bff7f67f4526275dbac9169f8d6c4", "committedDate": "2020-04-26T09:10:51Z", "message": "Adds property to swtich to Kujaku MapView"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec2e8fe3037a097911f878e30ff2add03c594e1b", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/ec2e8fe3037a097911f878e30ff2add03c594e1b", "committedDate": "2020-04-26T09:12:50Z", "message": "Adds Kujaku Map View and shows cases over it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db2981a72e4a54d6b8306072bbc12b90b7c0ccaf", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/db2981a72e4a54d6b8306072bbc12b90b7c0ccaf", "committedDate": "2020-04-26T12:11:34Z", "message": "Shows case info on symbol click"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6aaa934403386ce822c0b81977a6f3390da21d5", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/a6aaa934403386ce822c0b81977a6f3390da21d5", "committedDate": "2020-04-26T12:16:58Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "229d87eabade84243c804a7aa79358ab27092865", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/229d87eabade84243c804a7aa79358ab27092865", "committedDate": "2020-04-26T13:22:58Z", "message": "Focus camera on user location"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d231c3ff2d01d36ac81ec078ea9f67f9a1fcf28", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/0d231c3ff2d01d36ac81ec078ea9f67f9a1fcf28", "committedDate": "2020-04-27T06:10:31Z", "message": "Adds Boundary activity structure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30f3ebceea341e0a8046b30dd8c50ee4caf33483", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/30f3ebceea341e0a8046b30dd8c50ee4caf33483", "committedDate": "2020-05-11T21:33:22Z", "message": "Implements Boundary drawing activity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4e3caaa73d67232511561a43a04872ea8924c5b", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/d4e3caaa73d67232511561a43a04872ea8924c5b", "committedDate": "2020-05-13T14:45:15Z", "message": "Redraws polygon from extra coordinates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22d9f09d655aeff6f246f9caa55e425309fd7c89", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/22d9f09d655aeff6f246f9caa55e425309fd7c89", "committedDate": "2020-05-13T19:05:27Z", "message": "Adds redo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "202d8ceb15e7274d1b5cb1e0f805fca801b3379e", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/202d8ceb15e7274d1b5cb1e0f805fca801b3379e", "committedDate": "2020-05-14T14:00:52Z", "message": "fixes in redo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b1d3d75962f4f9e4c9aaaf93e22192a444218a7", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/2b1d3d75962f4f9e4c9aaaf93e22192a444218a7", "committedDate": "2020-05-14T14:02:02Z", "message": "Show detail geoverlays on Kujaku Map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeff2a3b71884fee59865d24022d6f7466229fa4", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/aeff2a3b71884fee59865d24022d6f7466229fa4", "committedDate": "2020-05-14T14:39:59Z", "message": "Rename function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df89ac5d8893a3486b8649c127ca3a054fdf57c4", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/df89ac5d8893a3486b8649c127ca3a054fdf57c4", "committedDate": "2020-05-14T14:47:46Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42f22dd5c7db8c47d819cfdcbe4e723d18bb00d5", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/42f22dd5c7db8c47d819cfdcbe4e723d18bb00d5", "committedDate": "2020-05-14T19:39:00Z", "message": "escape \\n"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "263392ecddbb0e22bc78da4f4618c0f413dc156f", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/263392ecddbb0e22bc78da4f4618c0f413dc156f", "committedDate": "2020-05-15T18:37:34Z", "message": "Adds Map snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "799cdd5c374b57816a55a4f1ce45ad450f4a53f6", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/799cdd5c374b57816a55a4f1ce45ad450f4a53f6", "committedDate": "2020-05-17T19:06:29Z", "message": "more robust parsing of coordinates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5208f3e9ce58f505387676bbf98da13db66a56e", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/e5208f3e9ce58f505387676bbf98da13db66a56e", "committedDate": "2020-05-17T20:18:11Z", "message": "Merge branch 'master' into kujaku"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "419235305a3017c391f2e78431fd5cbff5e0b4cc", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/419235305a3017c391f2e78431fd5cbff5e0b4cc", "committedDate": "2020-05-18T06:33:32Z", "message": "mapbox -> kujaku"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a143c015f5521416ca888a145f5fc0c86d65097", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/5a143c015f5521416ca888a145f5fc0c86d65097", "committedDate": "2020-05-18T07:34:46Z", "message": "Corrects package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4feccfa9c4f7bf648e814e9f5b4a147e831e5710", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/4feccfa9c4f7bf648e814e9f5b4a147e831e5710", "committedDate": "2020-05-18T08:10:07Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "354c5fc9f10cafffb3574c93605403a015916c04", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/354c5fc9f10cafffb3574c93605403a015916c04", "committedDate": "2020-05-22T16:43:11Z", "message": "Depends on latest kujaku release"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc598d9b5d07c4483394ab04254f21595ba92a4e", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/dc598d9b5d07c4483394ab04254f21595ba92a4e", "committedDate": "2020-05-22T16:54:04Z", "message": "test fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNDk3NTc2", "url": "https://github.com/dimagi/commcare-android/pull/2237#pullrequestreview-413497576", "createdAt": "2020-05-18T11:16:21Z", "commit": {"oid": "4feccfa9c4f7bf648e814e9f5b4a147e831e5710"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNToxNDozNlrOGXlacg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxMzo1Mzo0N1rOGZvF7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM4MzQxMA==", "bodyText": "Are we expecting that NoSuchElementException can occur and ignoring that?", "url": "https://github.com/dimagi/commcare-android/pull/2237#discussion_r427383410", "createdAt": "2020-05-19T15:14:36Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/gis/AreaCalculator.kt", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.commcare.gis\n+\n+import com.google.android.gms.maps.model.LatLng\n+import com.google.maps.android.SphericalUtil\n+import com.mapbox.geojson.Polygon\n+\n+/**\n+ * Utility class to calculate polygon sphrical properties like area and perimeter\n+ */\n+class AreaCalculator(val polygon: Polygon) {\n+\n+    private var latLngs = ArrayList<LatLng>()\n+\n+    init {\n+        kotlin.runCatching {\n+            polygon.coordinates().first().map { point ->\n+                LatLng(point.latitude(), point.longitude())\n+            }.toCollection(latLngs)\n+        }.onFailure { e ->\n+            if (e !is NoSuchElementException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4feccfa9c4f7bf648e814e9f5b4a147e831e5710"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYzNjU3Mw==", "bodyText": "Should we be worried about locationClient being null here? perhaps ? will be a better operator to use.", "url": "https://github.com/dimagi/commcare-android/pull/2237#discussion_r429636573", "createdAt": "2020-05-24T13:26:25Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/gis/DrawingBoundaryActivity.kt", "diffHunk": "@@ -0,0 +1,239 @@\n+package org.commcare.gis\n+\n+import android.app.Activity\n+import android.content.Intent\n+import android.content.pm.ActivityInfo\n+import android.content.res.Configuration\n+import android.graphics.Bitmap\n+import android.location.Location\n+import android.location.LocationListener\n+import android.os.Build\n+import android.os.Bundle\n+import android.widget.Toast\n+import com.mapbox.geojson.Polygon\n+import com.mapbox.mapboxsdk.geometry.LatLng\n+import com.mapbox.mapboxsdk.maps.MapboxMap\n+import com.mapbox.mapboxsdk.maps.Style\n+import io.ona.kujaku.manager.DrawingManager\n+import kotlinx.android.synthetic.main.activity_entity_mapbox.*\n+import org.commcare.activities.components.FormEntryInstanceState\n+import org.commcare.android.javarosa.IntentCallout\n+import org.commcare.dalvik.R\n+import org.commcare.gis.EntityMapUtils.parseBoundaryCoords\n+import org.commcare.interfaces.CommCareActivityUIController\n+import org.commcare.interfaces.WithUIController\n+import org.commcare.utils.FileUtil\n+import org.commcare.utils.ImageType\n+import org.javarosa.core.services.Logger\n+import java.io.File\n+\n+/**\n+ * Used to draw or walk a boundary on mapbox based map\n+ */\n+class DrawingBoundaryActivity : BaseMapboxActivity(), WithUIController, LocationListener, MapboxMap.SnapshotReadyCallback {\n+\n+    companion object {\n+        // Incoming Intent Extras\n+        private const val EXTRA_KEY_ACCURACY = \"accuracy\"\n+        private const val EXTRA_KEY_IMAGE = \"image\"\n+        private const val EXTRA_KEY_INTERVAL_METERS = \"interval_meters\"\n+        private const val EXTRA_KEY_INTERVAL_MILLIS = \"interval_millis\"\n+        private const val EXTRA_KEY_TITLE = \"title\"\n+        private const val EXTRA_KEY_DETAIL = \"detail\"\n+        private const val EXTRA_KEY_MANUAL = \"manual\"\n+\n+        // Result Intent Extras\n+        private const val EXTRA_KEY_COORDINATES = \"coordinates\"\n+        private const val EXTRA_KEY_PERIMETER = \"perimeter\"\n+\n+        private const val LOCATION_MIN_MAX_ACCURACY = 50\n+        private const val LOCATION_MIN_MIN_ACCURACY = 10\n+\n+    }\n+\n+    private var mapSnapshotPath: String? = null\n+    private lateinit var loadedStyle: Style\n+    private lateinit var boundaryCoords: String\n+    private var polygon: Polygon? = null\n+    private var isManual: Boolean = false\n+    private lateinit var drawingManager: DrawingManager\n+    private var isRecording: Boolean = false\n+    private var previousLocation: Location? = null\n+    private var recordingIntervalMeters = 0\n+    private var recordingIntervalMillis = 0\n+    private var isImageReturnRequired = false\n+    private var title: String? = null\n+    private var detail: String? = null\n+    private var locationMinAccuracy = 35\n+\n+    private lateinit var uiController: DrawingBoundaryActivityUIController\n+\n+    override fun onCreate(savedInstanceState: Bundle?) {\n+        super.onCreate(savedInstanceState)\n+        freezeOrientation()\n+        initExtras()\n+    }\n+\n+    private fun initExtras() {\n+        val params = intent.extras\n+        if (params != null) {\n+\n+            locationMinAccuracy = LOCATION_MIN_MIN_ACCURACY.coerceAtLeast(\n+                    LOCATION_MIN_MAX_ACCURACY.coerceAtMost(\n+                            Integer.valueOf(params.getString(EXTRA_KEY_ACCURACY, LOCATION_MIN_MIN_ACCURACY.toString()))))\n+\n+\n+            recordingIntervalMeters = Integer.valueOf(params.getString(EXTRA_KEY_INTERVAL_METERS, \"0\"))\n+            recordingIntervalMillis = Integer.valueOf(params.getString(EXTRA_KEY_INTERVAL_MILLIS, \"0\"))\n+            isImageReturnRequired = params.getString(EXTRA_KEY_IMAGE, \"false\")!!.toBoolean()\n+            title = params.getString(EXTRA_KEY_TITLE, \"\")\n+            detail = params.getString(EXTRA_KEY_DETAIL, \"\")\n+            isManual = params.getString(EXTRA_KEY_MANUAL, \"false\")!!.toBoolean()\n+            boundaryCoords = params.getString(EXTRA_KEY_COORDINATES, \"\")\n+        }\n+    }\n+\n+    private fun freezeOrientation() {\n+        val orientation = resources.configuration.orientation\n+        requestedOrientation = if (Build.VERSION.SDK_INT < Build.VERSION_CODES.JELLY_BEAN_MR2) {\n+            when (orientation) {\n+                Configuration.ORIENTATION_PORTRAIT -> ActivityInfo.SCREEN_ORIENTATION_SENSOR_PORTRAIT\n+                else -> ActivityInfo.SCREEN_ORIENTATION_SENSOR_LANDSCAPE\n+            }\n+        } else {\n+            when (orientation) {\n+                Configuration.ORIENTATION_PORTRAIT -> ActivityInfo.SCREEN_ORIENTATION_USER_PORTRAIT\n+                else -> ActivityInfo.SCREEN_ORIENTATION_USER_LANDSCAPE\n+            }\n+        }\n+    }\n+\n+    override fun onMapLoaded() {\n+        map.setStyle(Style.MAPBOX_STREETS) { loadedStyle ->\n+            this.loadedStyle = loadedStyle\n+            onStyleLoaded()\n+        }\n+    }\n+\n+    private fun onStyleLoaded() {\n+        mapView.isWarmGps = true\n+        drawingManager = DrawingManager(mapView, map, loadedStyle)\n+        map.addOnMapClickListener {\n+            polygon = drawingManager.currentPolygon\n+            uiController.refreshView()\n+            false\n+        }\n+        setUiFromBoundaryCoords()\n+    }\n+\n+    private fun setUiFromBoundaryCoords() {\n+        kotlin.runCatching {\n+            parseBoundaryCoords(boundaryCoords)\n+        }.onFailure {\n+            showToast(R.string.parse_coordinates_failure)\n+            setResult(Activity.RESULT_CANCELED)\n+            Logger.exception(\"Exception while loading boundary coordinates \", Exception(it))\n+            finish()\n+        }.onSuccess { latlngs ->\n+            latlngs.map { latlng -> drawingManager.drawCircle(latlng) }\n+        }\n+    }\n+\n+\n+    fun startTracking() {\n+        isRecording = true\n+        if (!isManual) {\n+            if (mapView.locationClient != null) {\n+                mapView.locationClient!!.addLocationListener(this)\n+            }\n+        } else {\n+            drawingManager.startDrawing(null)\n+        }\n+    }\n+\n+    fun stopTracking() {\n+        isRecording = false\n+        mapView.locationClient!!.removeLocationListener(this)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc598d9b5d07c4483394ab04254f21595ba92a4e"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYzOTE1MQ==", "bodyText": "Confirming, it crashes here, if we deny the location permission and then press Start followed by Stop.\nPerhaps we should finish the activity if the permissions are not granted?", "url": "https://github.com/dimagi/commcare-android/pull/2237#discussion_r429639151", "createdAt": "2020-05-24T13:53:47Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/gis/DrawingBoundaryActivity.kt", "diffHunk": "@@ -0,0 +1,239 @@\n+package org.commcare.gis\n+\n+import android.app.Activity\n+import android.content.Intent\n+import android.content.pm.ActivityInfo\n+import android.content.res.Configuration\n+import android.graphics.Bitmap\n+import android.location.Location\n+import android.location.LocationListener\n+import android.os.Build\n+import android.os.Bundle\n+import android.widget.Toast\n+import com.mapbox.geojson.Polygon\n+import com.mapbox.mapboxsdk.geometry.LatLng\n+import com.mapbox.mapboxsdk.maps.MapboxMap\n+import com.mapbox.mapboxsdk.maps.Style\n+import io.ona.kujaku.manager.DrawingManager\n+import kotlinx.android.synthetic.main.activity_entity_mapbox.*\n+import org.commcare.activities.components.FormEntryInstanceState\n+import org.commcare.android.javarosa.IntentCallout\n+import org.commcare.dalvik.R\n+import org.commcare.gis.EntityMapUtils.parseBoundaryCoords\n+import org.commcare.interfaces.CommCareActivityUIController\n+import org.commcare.interfaces.WithUIController\n+import org.commcare.utils.FileUtil\n+import org.commcare.utils.ImageType\n+import org.javarosa.core.services.Logger\n+import java.io.File\n+\n+/**\n+ * Used to draw or walk a boundary on mapbox based map\n+ */\n+class DrawingBoundaryActivity : BaseMapboxActivity(), WithUIController, LocationListener, MapboxMap.SnapshotReadyCallback {\n+\n+    companion object {\n+        // Incoming Intent Extras\n+        private const val EXTRA_KEY_ACCURACY = \"accuracy\"\n+        private const val EXTRA_KEY_IMAGE = \"image\"\n+        private const val EXTRA_KEY_INTERVAL_METERS = \"interval_meters\"\n+        private const val EXTRA_KEY_INTERVAL_MILLIS = \"interval_millis\"\n+        private const val EXTRA_KEY_TITLE = \"title\"\n+        private const val EXTRA_KEY_DETAIL = \"detail\"\n+        private const val EXTRA_KEY_MANUAL = \"manual\"\n+\n+        // Result Intent Extras\n+        private const val EXTRA_KEY_COORDINATES = \"coordinates\"\n+        private const val EXTRA_KEY_PERIMETER = \"perimeter\"\n+\n+        private const val LOCATION_MIN_MAX_ACCURACY = 50\n+        private const val LOCATION_MIN_MIN_ACCURACY = 10\n+\n+    }\n+\n+    private var mapSnapshotPath: String? = null\n+    private lateinit var loadedStyle: Style\n+    private lateinit var boundaryCoords: String\n+    private var polygon: Polygon? = null\n+    private var isManual: Boolean = false\n+    private lateinit var drawingManager: DrawingManager\n+    private var isRecording: Boolean = false\n+    private var previousLocation: Location? = null\n+    private var recordingIntervalMeters = 0\n+    private var recordingIntervalMillis = 0\n+    private var isImageReturnRequired = false\n+    private var title: String? = null\n+    private var detail: String? = null\n+    private var locationMinAccuracy = 35\n+\n+    private lateinit var uiController: DrawingBoundaryActivityUIController\n+\n+    override fun onCreate(savedInstanceState: Bundle?) {\n+        super.onCreate(savedInstanceState)\n+        freezeOrientation()\n+        initExtras()\n+    }\n+\n+    private fun initExtras() {\n+        val params = intent.extras\n+        if (params != null) {\n+\n+            locationMinAccuracy = LOCATION_MIN_MIN_ACCURACY.coerceAtLeast(\n+                    LOCATION_MIN_MAX_ACCURACY.coerceAtMost(\n+                            Integer.valueOf(params.getString(EXTRA_KEY_ACCURACY, LOCATION_MIN_MIN_ACCURACY.toString()))))\n+\n+\n+            recordingIntervalMeters = Integer.valueOf(params.getString(EXTRA_KEY_INTERVAL_METERS, \"0\"))\n+            recordingIntervalMillis = Integer.valueOf(params.getString(EXTRA_KEY_INTERVAL_MILLIS, \"0\"))\n+            isImageReturnRequired = params.getString(EXTRA_KEY_IMAGE, \"false\")!!.toBoolean()\n+            title = params.getString(EXTRA_KEY_TITLE, \"\")\n+            detail = params.getString(EXTRA_KEY_DETAIL, \"\")\n+            isManual = params.getString(EXTRA_KEY_MANUAL, \"false\")!!.toBoolean()\n+            boundaryCoords = params.getString(EXTRA_KEY_COORDINATES, \"\")\n+        }\n+    }\n+\n+    private fun freezeOrientation() {\n+        val orientation = resources.configuration.orientation\n+        requestedOrientation = if (Build.VERSION.SDK_INT < Build.VERSION_CODES.JELLY_BEAN_MR2) {\n+            when (orientation) {\n+                Configuration.ORIENTATION_PORTRAIT -> ActivityInfo.SCREEN_ORIENTATION_SENSOR_PORTRAIT\n+                else -> ActivityInfo.SCREEN_ORIENTATION_SENSOR_LANDSCAPE\n+            }\n+        } else {\n+            when (orientation) {\n+                Configuration.ORIENTATION_PORTRAIT -> ActivityInfo.SCREEN_ORIENTATION_USER_PORTRAIT\n+                else -> ActivityInfo.SCREEN_ORIENTATION_USER_LANDSCAPE\n+            }\n+        }\n+    }\n+\n+    override fun onMapLoaded() {\n+        map.setStyle(Style.MAPBOX_STREETS) { loadedStyle ->\n+            this.loadedStyle = loadedStyle\n+            onStyleLoaded()\n+        }\n+    }\n+\n+    private fun onStyleLoaded() {\n+        mapView.isWarmGps = true\n+        drawingManager = DrawingManager(mapView, map, loadedStyle)\n+        map.addOnMapClickListener {\n+            polygon = drawingManager.currentPolygon\n+            uiController.refreshView()\n+            false\n+        }\n+        setUiFromBoundaryCoords()\n+    }\n+\n+    private fun setUiFromBoundaryCoords() {\n+        kotlin.runCatching {\n+            parseBoundaryCoords(boundaryCoords)\n+        }.onFailure {\n+            showToast(R.string.parse_coordinates_failure)\n+            setResult(Activity.RESULT_CANCELED)\n+            Logger.exception(\"Exception while loading boundary coordinates \", Exception(it))\n+            finish()\n+        }.onSuccess { latlngs ->\n+            latlngs.map { latlng -> drawingManager.drawCircle(latlng) }\n+        }\n+    }\n+\n+\n+    fun startTracking() {\n+        isRecording = true\n+        if (!isManual) {\n+            if (mapView.locationClient != null) {\n+                mapView.locationClient!!.addLocationListener(this)\n+            }\n+        } else {\n+            drawingManager.startDrawing(null)\n+        }\n+    }\n+\n+    fun stopTracking() {\n+        isRecording = false\n+        mapView.locationClient!!.removeLocationListener(this)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYzNjU3Mw=="}, "originalCommit": {"oid": "dc598d9b5d07c4483394ab04254f21595ba92a4e"}, "originalPosition": 156}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "616d084e40c33f3a74fcad9436680062e3d136a0", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/616d084e40c33f3a74fcad9436680062e3d136a0", "committedDate": "2020-05-25T18:17:50Z", "message": "depends on SphericalUtil from Kujaku"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbf9a7e469587fc551901115618b1ca309e6b1a9", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/cbf9a7e469587fc551901115618b1ca309e6b1a9", "committedDate": "2020-05-25T19:38:43Z", "message": "Changes startTracking to ask for location services if disabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3ODc0MjI5", "url": "https://github.com/dimagi/commcare-android/pull/2237#pullrequestreview-417874229", "createdAt": "2020-05-25T20:59:25Z", "commit": {"oid": "cbf9a7e469587fc551901115618b1ca309e6b1a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDo1OToyNlrOGaJlPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMDo1OToyNlrOGaJlPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3MzE1MQ==", "bodyText": "Does this mean we'll get the ability to restyle the Kujaku views on our side? That would be cool", "url": "https://github.com/dimagi/commcare-android/pull/2237#discussion_r430073151", "createdAt": "2020-05-25T20:59:26Z", "author": {"login": "ctsims"}, "path": "app/res/values/colors.xml", "diffHunk": "@@ -130,4 +130,22 @@\n     <color name=\"cc_error_bg_color\">#EE5555</color>\n     <color name=\"cc_error_text_color\">#FFFFFF</color>\n     <color name=\"map_layer_button_color\">#D3D3D3</color>\n+\n+    <!--    Map  Buttons-->\n+    <color name=\"gray_300\">#E0E0E0</color>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf9a7e469587fc551901115618b1ca309e6b1a9"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3ODc0NzE4", "url": "https://github.com/dimagi/commcare-android/pull/2237#pullrequestreview-417874718", "createdAt": "2020-05-25T21:01:34Z", "commit": {"oid": "cbf9a7e469587fc551901115618b1ca309e6b1a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMTowMTozNFrOGaJm5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQyMTowMTozNFrOGaJm5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3MzU3NQ==", "bodyText": "It's awesome that decorators still work the same way across the kotlin files", "url": "https://github.com/dimagi/commcare-android/pull/2237#discussion_r430073575", "createdAt": "2020-05-25T21:01:34Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/gis/DrawingBoundaryActivityUIController.kt", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.commcare.gis\n+\n+import android.view.View\n+import android.widget.Button\n+import android.widget.TextView\n+import org.commcare.dalvik.R\n+import org.commcare.interfaces.CommCareActivityUIController\n+import org.commcare.utils.StringUtils\n+import org.commcare.views.ManagedUi\n+import org.commcare.views.UiElement\n+import org.javarosa.core.services.locale.Localization\n+\n+@ManagedUi(R.layout.activity_drawing_boundary)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf9a7e469587fc551901115618b1ca309e6b1a9"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3ODc1MDUy", "url": "https://github.com/dimagi/commcare-android/pull/2237#pullrequestreview-417875052", "createdAt": "2020-05-25T21:03:08Z", "commit": {"oid": "cbf9a7e469587fc551901115618b1ca309e6b1a9"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c895695a59b1096ae38666e11e1d5ce5616c4687", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/c895695a59b1096ae38666e11e1d5ce5616c4687", "committedDate": "2020-05-26T09:16:03Z", "message": "Removes unused colors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5d6ca967d843a32b9f342c51689f62c644fe91d", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/e5d6ca967d843a32b9f342c51689f62c644fe91d", "committedDate": "2020-05-28T16:24:49Z", "message": "Merge branch 'master' into kujaku"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNTY1NzQw", "url": "https://github.com/dimagi/commcare-android/pull/2237#pullrequestreview-420565740", "createdAt": "2020-05-28T23:48:01Z", "commit": {"oid": "e5d6ca967d843a32b9f342c51689f62c644fe91d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2043, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}