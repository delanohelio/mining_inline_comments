{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzOTE1MDU1", "number": 2409, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMzo1Mzo1NFrOE7EHtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoxMzowM1rOE7ehHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMzY4OTUxOnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/CommCareApplication.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMzo1Mzo1NFrOH2fpRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMzo1NjowMVrOH2fvaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkwMzYyMA==", "bodyText": "One question: Should we be adding this only below Android 7.1?", "url": "https://github.com/dimagi/commcare-android/pull/2409#discussion_r526903620", "createdAt": "2020-11-19T13:53:54Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/CommCareApplication.java", "diffHunk": "@@ -244,6 +246,10 @@ public void onCreate() {\n         LocalePreferences.saveDeviceLocale(Locale.getDefault());\r\n     }\r\n \r\n+    private void attachISRGCert() {\r\n+        CommCareNetworkServiceGenerator.customizeRetrofitSetup(new ISRGCertConfig());\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29964b0d7ef67a6f8cb50a38d048d3c24ea9a661"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkwNTE5Mg==", "bodyText": "Ohh nvm, just saw the check here https://github.com/dimagi/commcare-android/pull/2409/files#diff-accec8e023ea67a6abb17d85e70b38eb6f6a80aa1ead1bb96c638f81b3c2f0eaR31", "url": "https://github.com/dimagi/commcare-android/pull/2409#discussion_r526905192", "createdAt": "2020-11-19T13:56:01Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/CommCareApplication.java", "diffHunk": "@@ -244,6 +246,10 @@ public void onCreate() {\n         LocalePreferences.saveDeviceLocale(Locale.getDefault());\r\n     }\r\n \r\n+    private void attachISRGCert() {\r\n+        CommCareNetworkServiceGenerator.customizeRetrofitSetup(new ISRGCertConfig());\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkwMzYyMA=="}, "originalCommit": {"oid": "29964b0d7ef67a6f8cb50a38d048d3c24ea9a661"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODAxNDM3OnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/network/ISRGCertConfig.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoxMzowM1rOH3JbCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzozNjowN1rOH3P5eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4ODEwNA==", "bodyText": "Do you need to support other platform certificates as well? Or just an LE root?\nCan you confirm this already works for existing LE certificates?", "url": "https://github.com/dimagi/commcare-android/pull/2409#discussion_r527588104", "createdAt": "2020-11-20T10:13:03Z", "author": {"login": "yschimke"}, "path": "app/src/org/commcare/network/ISRGCertConfig.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.commcare.network;\n+\n+import android.os.Build;\n+\n+import org.commcare.core.network.HttpBuilderConfig;\n+import org.javarosa.core.services.Logger;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.UnsupportedEncodingException;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+\n+import okhttp3.OkHttpClient;\n+import okhttp3.tls.HandshakeCertificates;\n+\n+/**\n+ * Pins Lets Encrypt new root CA - ISRG Root X1\n+ *\n+ * Read https://community.letsencrypt.org/t/mobile-client-workarounds-for-isrg-issue/137807 and\n+ * https://stackoverflow.com/questions/64844311/certpathvalidatorexception-connecting-to-a-lets-encrypt-host-on-android-m-or-ea\n+ * for background.\n+ */\n+public class ISRGCertConfig implements HttpBuilderConfig {\n+\n+    @Override\n+    public OkHttpClient.Builder performCustomConfig(OkHttpClient.Builder okHttpBuilder) {\n+        boolean androidNorEarlier = Build.VERSION.SDK_INT <= 25;\n+\n+        if (androidNorEarlier) {\n+            String isgCert =\n+                    \"-----BEGIN CERTIFICATE-----\\n\" +\n+                            \"MIIFazCCA1OgAwIBAgIRAIIQz7DSQONZRGPgu2OCiwAwDQYJKoZIhvcNAQELBQAw\\n\" +\n+                            \"TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh\\n\" +\n+                            \"cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMTUwNjA0MTEwNDM4\\n\" +\n+                            \"WhcNMzUwNjA0MTEwNDM4WjBPMQswCQYDVQQGEwJVUzEpMCcGA1UEChMgSW50ZXJu\\n\" +\n+                            \"ZXQgU2VjdXJpdHkgUmVzZWFyY2ggR3JvdXAxFTATBgNVBAMTDElTUkcgUm9vdCBY\\n\" +\n+                            \"MTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAK3oJHP0FDfzm54rVygc\\n\" +\n+                            \"h77ct984kIxuPOZXoHj3dcKi/vVqbvYATyjb3miGbESTtrFj/RQSa78f0uoxmyF+\\n\" +\n+                            \"0TM8ukj13Xnfs7j/EvEhmkvBioZxaUpmZmyPfjxwv60pIgbz5MDmgK7iS4+3mX6U\\n\" +\n+                            \"A5/TR5d8mUgjU+g4rk8Kb4Mu0UlXjIB0ttov0DiNewNwIRt18jA8+o+u3dpjq+sW\\n\" +\n+                            \"T8KOEUt+zwvo/7V3LvSye0rgTBIlDHCNAymg4VMk7BPZ7hm/ELNKjD+Jo2FR3qyH\\n\" +\n+                            \"B5T0Y3HsLuJvW5iB4YlcNHlsdu87kGJ55tukmi8mxdAQ4Q7e2RCOFvu396j3x+UC\\n\" +\n+                            \"B5iPNgiV5+I3lg02dZ77DnKxHZu8A/lJBdiB3QW0KtZB6awBdpUKD9jf1b0SHzUv\\n\" +\n+                            \"KBds0pjBqAlkd25HN7rOrFleaJ1/ctaJxQZBKT5ZPt0m9STJEadao0xAH0ahmbWn\\n\" +\n+                            \"OlFuhjuefXKnEgV4We0+UXgVCwOPjdAvBbI+e0ocS3MFEvzG6uBQE3xDk3SzynTn\\n\" +\n+                            \"jh8BCNAw1FtxNrQHusEwMFxIt4I7mKZ9YIqioymCzLq9gwQbooMDQaHWBfEbwrbw\\n\" +\n+                            \"qHyGO0aoSCqI3Haadr8faqU9GY/rOPNk3sgrDQoo//fb4hVC1CLQJ13hef4Y53CI\\n\" +\n+                            \"rU7m2Ys6xt0nUW7/vGT1M0NPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNV\\n\" +\n+                            \"HRMBAf8EBTADAQH/MB0GA1UdDgQWBBR5tFnme7bl5AFzgAiIyBpY9umbbjANBgkq\\n\" +\n+                            \"hkiG9w0BAQsFAAOCAgEAVR9YqbyyqFDQDLHYGmkgJykIrGF1XIpu+ILlaS/V9lZL\\n\" +\n+                            \"ubhzEFnTIZd+50xx+7LSYK05qAvqFyFWhfFQDlnrzuBZ6brJFe+GnY+EgPbk6ZGQ\\n\" +\n+                            \"3BebYhtF8GaV0nxvwuo77x/Py9auJ/GpsMiu/X1+mvoiBOv/2X/qkSsisRcOj/KK\\n\" +\n+                            \"NFtY2PwByVS5uCbMiogziUwthDyC3+6WVwW6LLv3xLfHTjuCvjHIInNzktHCgKQ5\\n\" +\n+                            \"ORAzI4JMPJ+GslWYHb4phowim57iaztXOoJwTdwJx4nLCgdNbOhdjsnvzqvHu7Ur\\n\" +\n+                            \"TkXWStAmzOVyyghqpZXjFaH3pO3JLF+l+/+sKAIuvtd7u+Nxe5AW0wdeRlN8NwdC\\n\" +\n+                            \"jNPElpzVmbUq4JUagEiuTDkHzsxHpFKVK7q4+63SM1N95R1NbdWhscdCb+ZAJzVc\\n\" +\n+                            \"oyi3B43njTOQ5yOf+1CceWxG1bQVs5ZufpsMljq4Ui0/1lvh+wjChP4kqKOJ2qxq\\n\" +\n+                            \"4RgqsahDYVvTH9w7jXbyLeiNdd8XM2w9U/t7y0Ff/9yi0GE44Za4rF2LN9d11TPA\\n\" +\n+                            \"mRGunUHBcnWEvgJBQl9nJEiU0Zsnvgc/ubhPgXRR4Xq37Z0j4r7g1SgEEzwxA57d\\n\" +\n+                            \"emyPxgcYxn/eR44/KJ4EBs+lVDR3veyJm+kXQ99b21/+jh5Xos1AnX5iItreGCc=\\n\" +\n+                            \"-----END CERTIFICATE-----\";\n+\n+            try {\n+                CertificateFactory cf = CertificateFactory.getInstance(\"X.509\");\n+                Certificate isgCertificate = cf.generateCertificate(new ByteArrayInputStream(isgCert.getBytes(\"UTF-8\")));\n+\n+                HandshakeCertificates certificates = new HandshakeCertificates.Builder()\n+                        .addTrustedCertificate((X509Certificate)isgCertificate)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29964b0d7ef67a6f8cb50a38d048d3c24ea9a661"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY5NDIwMg==", "bodyText": "Do you need to support other platform certificates as well?\n\nUh yes, It's failing for other non LE certs. so seems like we need to add addPlatformTrustedCertificates() to allow for other certificates. Appreciate the catch.\n\nCan you confirm this already works for existing LE certificates?\n\nYeah this somehow works without adding the call to addPlatformTrustedCertificates(). Not sure how though!", "url": "https://github.com/dimagi/commcare-android/pull/2409#discussion_r527694202", "createdAt": "2020-11-20T13:36:07Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/network/ISRGCertConfig.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.commcare.network;\n+\n+import android.os.Build;\n+\n+import org.commcare.core.network.HttpBuilderConfig;\n+import org.javarosa.core.services.Logger;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.UnsupportedEncodingException;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+\n+import okhttp3.OkHttpClient;\n+import okhttp3.tls.HandshakeCertificates;\n+\n+/**\n+ * Pins Lets Encrypt new root CA - ISRG Root X1\n+ *\n+ * Read https://community.letsencrypt.org/t/mobile-client-workarounds-for-isrg-issue/137807 and\n+ * https://stackoverflow.com/questions/64844311/certpathvalidatorexception-connecting-to-a-lets-encrypt-host-on-android-m-or-ea\n+ * for background.\n+ */\n+public class ISRGCertConfig implements HttpBuilderConfig {\n+\n+    @Override\n+    public OkHttpClient.Builder performCustomConfig(OkHttpClient.Builder okHttpBuilder) {\n+        boolean androidNorEarlier = Build.VERSION.SDK_INT <= 25;\n+\n+        if (androidNorEarlier) {\n+            String isgCert =\n+                    \"-----BEGIN CERTIFICATE-----\\n\" +\n+                            \"MIIFazCCA1OgAwIBAgIRAIIQz7DSQONZRGPgu2OCiwAwDQYJKoZIhvcNAQELBQAw\\n\" +\n+                            \"TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh\\n\" +\n+                            \"cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMTUwNjA0MTEwNDM4\\n\" +\n+                            \"WhcNMzUwNjA0MTEwNDM4WjBPMQswCQYDVQQGEwJVUzEpMCcGA1UEChMgSW50ZXJu\\n\" +\n+                            \"ZXQgU2VjdXJpdHkgUmVzZWFyY2ggR3JvdXAxFTATBgNVBAMTDElTUkcgUm9vdCBY\\n\" +\n+                            \"MTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAK3oJHP0FDfzm54rVygc\\n\" +\n+                            \"h77ct984kIxuPOZXoHj3dcKi/vVqbvYATyjb3miGbESTtrFj/RQSa78f0uoxmyF+\\n\" +\n+                            \"0TM8ukj13Xnfs7j/EvEhmkvBioZxaUpmZmyPfjxwv60pIgbz5MDmgK7iS4+3mX6U\\n\" +\n+                            \"A5/TR5d8mUgjU+g4rk8Kb4Mu0UlXjIB0ttov0DiNewNwIRt18jA8+o+u3dpjq+sW\\n\" +\n+                            \"T8KOEUt+zwvo/7V3LvSye0rgTBIlDHCNAymg4VMk7BPZ7hm/ELNKjD+Jo2FR3qyH\\n\" +\n+                            \"B5T0Y3HsLuJvW5iB4YlcNHlsdu87kGJ55tukmi8mxdAQ4Q7e2RCOFvu396j3x+UC\\n\" +\n+                            \"B5iPNgiV5+I3lg02dZ77DnKxHZu8A/lJBdiB3QW0KtZB6awBdpUKD9jf1b0SHzUv\\n\" +\n+                            \"KBds0pjBqAlkd25HN7rOrFleaJ1/ctaJxQZBKT5ZPt0m9STJEadao0xAH0ahmbWn\\n\" +\n+                            \"OlFuhjuefXKnEgV4We0+UXgVCwOPjdAvBbI+e0ocS3MFEvzG6uBQE3xDk3SzynTn\\n\" +\n+                            \"jh8BCNAw1FtxNrQHusEwMFxIt4I7mKZ9YIqioymCzLq9gwQbooMDQaHWBfEbwrbw\\n\" +\n+                            \"qHyGO0aoSCqI3Haadr8faqU9GY/rOPNk3sgrDQoo//fb4hVC1CLQJ13hef4Y53CI\\n\" +\n+                            \"rU7m2Ys6xt0nUW7/vGT1M0NPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNV\\n\" +\n+                            \"HRMBAf8EBTADAQH/MB0GA1UdDgQWBBR5tFnme7bl5AFzgAiIyBpY9umbbjANBgkq\\n\" +\n+                            \"hkiG9w0BAQsFAAOCAgEAVR9YqbyyqFDQDLHYGmkgJykIrGF1XIpu+ILlaS/V9lZL\\n\" +\n+                            \"ubhzEFnTIZd+50xx+7LSYK05qAvqFyFWhfFQDlnrzuBZ6brJFe+GnY+EgPbk6ZGQ\\n\" +\n+                            \"3BebYhtF8GaV0nxvwuo77x/Py9auJ/GpsMiu/X1+mvoiBOv/2X/qkSsisRcOj/KK\\n\" +\n+                            \"NFtY2PwByVS5uCbMiogziUwthDyC3+6WVwW6LLv3xLfHTjuCvjHIInNzktHCgKQ5\\n\" +\n+                            \"ORAzI4JMPJ+GslWYHb4phowim57iaztXOoJwTdwJx4nLCgdNbOhdjsnvzqvHu7Ur\\n\" +\n+                            \"TkXWStAmzOVyyghqpZXjFaH3pO3JLF+l+/+sKAIuvtd7u+Nxe5AW0wdeRlN8NwdC\\n\" +\n+                            \"jNPElpzVmbUq4JUagEiuTDkHzsxHpFKVK7q4+63SM1N95R1NbdWhscdCb+ZAJzVc\\n\" +\n+                            \"oyi3B43njTOQ5yOf+1CceWxG1bQVs5ZufpsMljq4Ui0/1lvh+wjChP4kqKOJ2qxq\\n\" +\n+                            \"4RgqsahDYVvTH9w7jXbyLeiNdd8XM2w9U/t7y0Ff/9yi0GE44Za4rF2LN9d11TPA\\n\" +\n+                            \"mRGunUHBcnWEvgJBQl9nJEiU0Zsnvgc/ubhPgXRR4Xq37Z0j4r7g1SgEEzwxA57d\\n\" +\n+                            \"emyPxgcYxn/eR44/KJ4EBs+lVDR3veyJm+kXQ99b21/+jh5Xos1AnX5iItreGCc=\\n\" +\n+                            \"-----END CERTIFICATE-----\";\n+\n+            try {\n+                CertificateFactory cf = CertificateFactory.getInstance(\"X.509\");\n+                Certificate isgCertificate = cf.generateCertificate(new ByteArrayInputStream(isgCert.getBytes(\"UTF-8\")));\n+\n+                HandshakeCertificates certificates = new HandshakeCertificates.Builder()\n+                        .addTrustedCertificate((X509Certificate)isgCertificate)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4ODEwNA=="}, "originalCommit": {"oid": "29964b0d7ef67a6f8cb50a38d048d3c24ea9a661"}, "originalPosition": 70}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3227, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}