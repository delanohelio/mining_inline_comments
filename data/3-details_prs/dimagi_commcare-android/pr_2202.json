{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NTc3MDEw", "number": 2202, "title": "Rate limit error message improvement", "bodyText": "Will merge after this #2195. Since the rate limit message assumes that commcare will automatically retry the form submission.\nJira: https://dimagi-dev.atlassian.net/browse/SAAS-10719\nIncludes 429 response code for rate-limiting error.", "createdAt": "2020-03-27T06:33:02Z", "url": "https://github.com/dimagi/commcare-android/pull/2202", "merged": true, "mergeCommit": {"oid": "8f52b00d4873b0a035adf30b7e256f963af39dad"}, "closed": true, "closedAt": "2020-05-04T06:10:40Z", "author": {"login": "ShivamPokhriyal"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSpKx2ABqjMxNzcyMDM4ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcd5IjYgFqTQwNDcyMzc4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fbff2548e8a3a9c2d9d01b1c2a5a664985cc7ff8", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/fbff2548e8a3a9c2d9d01b1c2a5a664985cc7ff8", "committedDate": "2020-03-27T07:29:29Z", "message": "Show detailed error popup for rate limit errors"}, "afterCommit": {"oid": "e25391df8dc905c2ded6e9fa7bd92caa336527e7", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/e25391df8dc905c2ded6e9fa7bd92caa336527e7", "committedDate": "2020-03-30T07:14:08Z", "message": "Show detailed error popup for rate limit errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNzE1NjQ0", "url": "https://github.com/dimagi/commcare-android/pull/2202#pullrequestreview-383715644", "createdAt": "2020-03-30T10:18:09Z", "commit": {"oid": "e25391df8dc905c2ded6e9fa7bd92caa336527e7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMDoxODowOVrOF9i9sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMDoyMjozM1rOF9jICQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4MDMwNQ==", "bodyText": "This should depend on a custom property from the application settings on HQ so that we can disable it selectively for preojects like ICDS.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r400080305", "createdAt": "2020-03-30T10:18:09Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "diffHunk": "@@ -45,6 +46,7 @@\n     private SyncIconState syncStateForIcon;\n     private SyncIconTrigger lastIconTrigger;\n     private MenuItem currentSyncMenuItem;\n+    private boolean showRateLimitDialog = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e25391df8dc905c2ded6e9fa7bd92caa336527e7"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4Mjk1Mw==", "bodyText": "This will mean even if user said he don't wanna see the dialog again, it will appear again in the next session. I think a better behaviour will be to save it in app preferences and then expose a setting that allows user to toggel this behaviour.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r400082953", "createdAt": "2020-03-30T10:22:33Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "diffHunk": "@@ -213,6 +215,24 @@ public void handleFormSendResult(String message, boolean success) {\n         }\n     }\n \n+    public void showRateLimitError() {\n+        if (!showRateLimitDialog) {\n+            handleFormSendResult(Localization.get(\"sync.fail.rate.limited.server.error\"), false);\n+            return;\n+        }\n+        String title = Localization.get(\"form.send.rate.limit.error.title\");\n+        String message = Localization.get(\"form.send.rate.limit.error.message\");\n+        StandardAlertDialog dialog = StandardAlertDialog.getBasicAlertDialog(this, title,\n+                message, null);\n+\n+        dialog.setNegativeButton(Localization.get(\"dialog.do.not.show.again\"), (dialog1, which) -> {\n+            showRateLimitDialog = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e25391df8dc905c2ded6e9fa7bd92caa336527e7"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e0a4144929e5761aa74268b00b6335f6f37dc9b8", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/e0a4144929e5761aa74268b00b6335f6f37dc9b8", "committedDate": "2020-04-02T07:19:18Z", "message": "Add option for users to enable rate-limit popup"}, "afterCommit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/db31de40b2420cc9cafb695d722b5a8fcf0ea9a6", "committedDate": "2020-04-07T07:22:53Z", "message": "Update popup text according to spec"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4OTc4MDc1", "url": "https://github.com/dimagi/commcare-android/pull/2202#pullrequestreview-388978075", "createdAt": "2020-04-07T10:16:39Z", "commit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoxNjozOVrOGB8wdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDozNDoyNVrOGB9Xpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NzIwNw==", "bodyText": "This string get used by data pull not form submission, so if user is coming here that means form submission has been successful already.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404697207", "createdAt": "2020-04-07T10:16:39Z", "author": {"login": "shubham1g5"}, "path": "app/assets/locales/android_translatable_strings.txt", "diffHunk": "@@ -116,11 +117,16 @@ sync.fail.bad.data=Server provided improperly formatted data, please try again o\n sync.fail.bad.local=Your information was fetched, but a problem occurred with the log in. Please try again.\r\n sync.fail.bad.network=Couldn't contact server. Please make sure an internet connection is available or try again later.\r\n sync.fail.server.error=The server encountered an error processing your data. Please try again later. If the problem persists, contact CommCare Support.\r\n-sync.fail.rate.limited.server.error=Our servers are unavailable at this time. Please try again later.\r\n+sync.fail.rate.limited.server.error=Form submission rate limit reached. Your forms are being saved locally and will be submitted to the server later.\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5OTAxMw==", "bodyText": "can we prefix they keys like rate.limit.error.diaglog..... just to make them more specific.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404699013", "createdAt": "2020-04-07T10:19:46Z", "author": {"login": "shubham1g5"}, "path": "app/assets/locales/android_translatable_strings.txt", "diffHunk": "@@ -116,11 +117,16 @@ sync.fail.bad.data=Server provided improperly formatted data, please try again o\n sync.fail.bad.local=Your information was fetched, but a problem occurred with the log in. Please try again.\r\n sync.fail.bad.network=Couldn't contact server. Please make sure an internet connection is available or try again later.\r\n sync.fail.server.error=The server encountered an error processing your data. Please try again later. If the problem persists, contact CommCare Support.\r\n-sync.fail.rate.limited.server.error=Our servers are unavailable at this time. Please try again later.\r\n+sync.fail.rate.limited.server.error=Form submission rate limit reached. Your forms are being saved locally and will be submitted to the server later.\r\n sync.fail.unknown=An unexpected issue occurred during sync. Please try to sync again.\r\n sync.fail.unsent=Having issues communicating with the server to send forms. Will try again later.\r\n sync.fail.individual=1 or more forms failed to send due to individual problems. See quarantined forms for details.\r\n \r\n+form.send.rate.limit.error.title=You've reached your form submission rate limit\r\n+form.send.rate.limit.error.message=Form submissions will be saved locally on your phone until rate limiting expires. Not to worry, all forms will be auto-synced to the server later. Contact your CommCare admin for more information.\r\n+dialog.button.do.not.show.again=Don\u2019t show again\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcwMTQ4NQ==", "bodyText": "use form submission specific error message rather than sync", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404701485", "createdAt": "2020-04-07T10:24:03Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/RecoveryActivity.java", "diffHunk": "@@ -96,28 +96,37 @@ protected void deliverResult(RecoveryActivity receiver, FormUploadResult result)\n \r\n                         int successfulSends = this.getSuccessfulSends();\r\n \r\n-                        if (result == FormUploadResult.FULL_SUCCESS) {\r\n-                            receiver.updateStatus(StringUtils.getStringRobust(\r\n-                                    RecoveryActivity.this,\r\n-                                    R.string.recovery_forms_send_successful,\r\n-                                    String.valueOf(successfulSends)));\r\n-                            receiver.attemptRecovery();\r\n-                        } else if (result == FormUploadResult.FAILURE) {\r\n-                            String failureMessage = successfulSends > 0 ?\r\n-                                    StringUtils.getStringRobust(\r\n-                                            RecoveryActivity.this,\r\n-                                            R.string.recovery_forms_send_failure) :\r\n-                                    StringUtils.getStringRobust(\r\n-                                            RecoveryActivity.this,\r\n-                                            R.string.recovery_forms_send_parital_success,\r\n-                                            String.valueOf(successfulSends));\r\n-                            receiver.updateStatus(failureMessage);\r\n-                        } else if (result == FormUploadResult.TRANSPORT_FAILURE) {\r\n-                            receiver.updateStatus(R.string.recovery_forms_send_network_error);\r\n-                        } else if (result == FormUploadResult.RECORD_FAILURE) {\r\n-                            receiver.updateStatus(Localization.get(\"sync.fail.individual\"));\r\n-                        } else if (result == FormUploadResult.AUTH_OVER_HTTP) {\r\n-                            receiver.updateStatus(Localization.get(\"auth.over.http\"));\r\n+                        switch (result) {\r\n+                            case FULL_SUCCESS:\r\n+                                receiver.updateStatus(StringUtils.getStringRobust(\r\n+                                        RecoveryActivity.this,\r\n+                                        R.string.recovery_forms_send_successful,\r\n+                                        String.valueOf(successfulSends)));\r\n+                                receiver.attemptRecovery();\r\n+                                break;\r\n+                            case FAILURE:\r\n+                                String failureMessage = successfulSends > 0 ?\r\n+                                        StringUtils.getStringRobust(\r\n+                                                RecoveryActivity.this,\r\n+                                                R.string.recovery_forms_send_failure) :\r\n+                                        StringUtils.getStringRobust(\r\n+                                                RecoveryActivity.this,\r\n+                                                R.string.recovery_forms_send_parital_success,\r\n+                                                String.valueOf(successfulSends));\r\n+                                receiver.updateStatus(failureMessage);\r\n+                                break;\r\n+                            case TRANSPORT_FAILURE:\r\n+                                receiver.updateStatus(R.string.recovery_forms_send_network_error);\r\n+                                break;\r\n+                            case RECORD_FAILURE:\r\n+                                receiver.updateStatus(Localization.get(\"sync.fail.individual\"));\r\n+                                break;\r\n+                            case AUTH_OVER_HTTP:\r\n+                                receiver.updateStatus(Localization.get(\"auth.over.http\"));\r\n+                                break;\r\n+                            case RATE_LIMITED:\r\n+                                receiver.updateStatus(Localization.get(\"sync.fail.rate.limited.server.error\"));\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcwNzIzOA==", "bodyText": "should show the form submission specific message.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404707238", "createdAt": "2020-04-07T10:34:25Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "diffHunk": "@@ -213,6 +215,28 @@ public void handleFormSendResult(String message, boolean success) {\n         }\n     }\n \n+    public void showRateLimitError(boolean userTriggered) {\n+\n+        if (HiddenPreferences.isRateLimitPopupDisabled() || !userTriggered) {\n+            handleFormSendResult(Localization.get(\"sync.fail.rate.limited.server.error\"), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDM0NTA3", "url": "https://github.com/dimagi/commcare-android/pull/2202#pullrequestreview-389034507", "createdAt": "2020-04-07T11:43:22Z", "commit": {"oid": "e1c3146c0c2bab1ac8f8bec6619223ef298313ed"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd460738bb8befb4031f8e2d2c33474dbdb0dcc9", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/fd460738bb8befb4031f8e2d2c33474dbdb0dcc9", "committedDate": "2020-05-03T02:11:59Z", "message": "Show detailed toast for rate limit error on form submissions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bbd0fb3e4a3ca4ce53ce799155af377b01783d1", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/7bbd0fb3e4a3ca4ce53ce799155af377b01783d1", "committedDate": "2020-05-03T02:11:59Z", "message": "Add 429 error check in restore request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4d4e22f7a07f759f57a5d5729457b736a8bc6b1", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/a4d4e22f7a07f759f57a5d5729457b736a8bc6b1", "committedDate": "2020-05-03T02:12:43Z", "message": "Show detailed error popup for rate limit errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3aa671d83c12feeb4e16a4ce60f13186b06948a", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/d3aa671d83c12feeb4e16a4ce60f13186b06948a", "committedDate": "2020-05-03T02:12:43Z", "message": "Show rate-limit popup only for user-triggered syncs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcc980f8a4d64b5d3ddcfcffa9638511c3c715e7", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/fcc980f8a4d64b5d3ddcfcffa9638511c3c715e7", "committedDate": "2020-05-03T02:13:44Z", "message": "Use preferences to decide whether or not to show rate-limit-popup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e53fc07d779b608cde56665c833459e19421e7c3", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/e53fc07d779b608cde56665c833459e19421e7c3", "committedDate": "2020-05-03T02:13:44Z", "message": "Add option for users to enable rate-limit popup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e13836fe864df6af7f04da4c5cb0c87422b10206", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/e13836fe864df6af7f04da4c5cb0c87422b10206", "committedDate": "2020-05-03T02:13:44Z", "message": "Update popup text according to spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca54f521a16af7fc2f4ecd28b5c978ef73642992", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/ca54f521a16af7fc2f4ecd28b5c978ef73642992", "committedDate": "2020-05-03T02:13:44Z", "message": "Improve translatable strings for rate limit message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1c3146c0c2bab1ac8f8bec6619223ef298313ed", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/e1c3146c0c2bab1ac8f8bec6619223ef298313ed", "committedDate": "2020-04-07T11:34:58Z", "message": "Improve translatable strings for rate limit message"}, "afterCommit": {"oid": "ca54f521a16af7fc2f4ecd28b5c978ef73642992", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/ca54f521a16af7fc2f4ecd28b5c978ef73642992", "committedDate": "2020-05-03T02:13:44Z", "message": "Improve translatable strings for rate limit message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NzIzNzg0", "url": "https://github.com/dimagi/commcare-android/pull/2202#pullrequestreview-404723784", "createdAt": "2020-05-04T06:03:49Z", "commit": {"oid": "ca54f521a16af7fc2f4ecd28b5c978ef73642992"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2164, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}