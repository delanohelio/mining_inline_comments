{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NTc3MDEw", "number": 2202, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMDoxODowOVrODsmwwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDozNDoyNVrODvf_8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MDk5MDEwOnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMDoxODowOVrOF9i9sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMzowOToyNVrOF9o4Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4MDMwNQ==", "bodyText": "This should depend on a custom property from the application settings on HQ so that we can disable it selectively for preojects like ICDS.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r400080305", "createdAt": "2020-03-30T10:18:09Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "diffHunk": "@@ -45,6 +46,7 @@\n     private SyncIconState syncStateForIcon;\n     private SyncIconTrigger lastIconTrigger;\n     private MenuItem currentSyncMenuItem;\n+    private boolean showRateLimitDialog = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e25391df8dc905c2ded6e9fa7bd92caa336527e7"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE3NzIyMg==", "bodyText": "Got it! Sounds good.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r400177222", "createdAt": "2020-03-30T13:09:25Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "diffHunk": "@@ -45,6 +46,7 @@\n     private SyncIconState syncStateForIcon;\n     private SyncIconTrigger lastIconTrigger;\n     private MenuItem currentSyncMenuItem;\n+    private boolean showRateLimitDialog = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4MDMwNQ=="}, "originalCommit": {"oid": "e25391df8dc905c2ded6e9fa7bd92caa336527e7"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MTAwNjc3OnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMDoyMjozM1rOF9jICQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMzoxMTo1OFrOF9o-dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4Mjk1Mw==", "bodyText": "This will mean even if user said he don't wanna see the dialog again, it will appear again in the next session. I think a better behaviour will be to save it in app preferences and then expose a setting that allows user to toggel this behaviour.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r400082953", "createdAt": "2020-03-30T10:22:33Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "diffHunk": "@@ -213,6 +215,24 @@ public void handleFormSendResult(String message, boolean success) {\n         }\n     }\n \n+    public void showRateLimitError() {\n+        if (!showRateLimitDialog) {\n+            handleFormSendResult(Localization.get(\"sync.fail.rate.limited.server.error\"), false);\n+            return;\n+        }\n+        String title = Localization.get(\"form.send.rate.limit.error.title\");\n+        String message = Localization.get(\"form.send.rate.limit.error.message\");\n+        StandardAlertDialog dialog = StandardAlertDialog.getBasicAlertDialog(this, title,\n+                message, null);\n+\n+        dialog.setNegativeButton(Localization.get(\"dialog.do.not.show.again\"), (dialog1, which) -> {\n+            showRateLimitDialog = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e25391df8dc905c2ded6e9fa7bd92caa336527e7"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE3ODgwNQ==", "bodyText": "Makes sense. My initial thought was to make sure user gets a detailed popup in every session.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r400178805", "createdAt": "2020-03-30T13:11:58Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "diffHunk": "@@ -213,6 +215,24 @@ public void handleFormSendResult(String message, boolean success) {\n         }\n     }\n \n+    public void showRateLimitError() {\n+        if (!showRateLimitDialog) {\n+            handleFormSendResult(Localization.get(\"sync.fail.rate.limited.server.error\"), false);\n+            return;\n+        }\n+        String title = Localization.get(\"form.send.rate.limit.error.title\");\n+        String message = Localization.get(\"form.send.rate.limit.error.message\");\n+        StandardAlertDialog dialog = StandardAlertDialog.getBasicAlertDialog(this, title,\n+                message, null);\n+\n+        dialog.setNegativeButton(Localization.get(\"dialog.do.not.show.again\"), (dialog1, which) -> {\n+            showRateLimitDialog = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4Mjk1Mw=="}, "originalCommit": {"oid": "e25391df8dc905c2ded6e9fa7bd92caa336527e7"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTI3Njk2OnYy", "diffSide": "RIGHT", "path": "app/assets/locales/android_translatable_strings.txt", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoxNjozOVrOGB8wdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMTo1MDowNVrOGB_1jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NzIwNw==", "bodyText": "This string get used by data pull not form submission, so if user is coming here that means form submission has been successful already.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404697207", "createdAt": "2020-04-07T10:16:39Z", "author": {"login": "shubham1g5"}, "path": "app/assets/locales/android_translatable_strings.txt", "diffHunk": "@@ -116,11 +117,16 @@ sync.fail.bad.data=Server provided improperly formatted data, please try again o\n sync.fail.bad.local=Your information was fetched, but a problem occurred with the log in. Please try again.\r\n sync.fail.bad.network=Couldn't contact server. Please make sure an internet connection is available or try again later.\r\n sync.fail.server.error=The server encountered an error processing your data. Please try again later. If the problem persists, contact CommCare Support.\r\n-sync.fail.rate.limited.server.error=Our servers are unavailable at this time. Please try again later.\r\n+sync.fail.rate.limited.server.error=Form submission rate limit reached. Your forms are being saved locally and will be submitted to the server later.\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDczNjQxMw==", "bodyText": "Ohh, I missed that. The same string is also used to show rate limit error in form upload. It's better to separate the two strings.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404736413", "createdAt": "2020-04-07T11:28:29Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/assets/locales/android_translatable_strings.txt", "diffHunk": "@@ -116,11 +117,16 @@ sync.fail.bad.data=Server provided improperly formatted data, please try again o\n sync.fail.bad.local=Your information was fetched, but a problem occurred with the log in. Please try again.\r\n sync.fail.bad.network=Couldn't contact server. Please make sure an internet connection is available or try again later.\r\n sync.fail.server.error=The server encountered an error processing your data. Please try again later. If the problem persists, contact CommCare Support.\r\n-sync.fail.rate.limited.server.error=Our servers are unavailable at this time. Please try again later.\r\n+sync.fail.rate.limited.server.error=Form submission rate limit reached. Your forms are being saved locally and will be submitted to the server later.\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NzIwNw=="}, "originalCommit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc0NzY2MA==", "bodyText": "Ahh, I misused this key in the first place.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404747660", "createdAt": "2020-04-07T11:50:05Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/assets/locales/android_translatable_strings.txt", "diffHunk": "@@ -116,11 +117,16 @@ sync.fail.bad.data=Server provided improperly formatted data, please try again o\n sync.fail.bad.local=Your information was fetched, but a problem occurred with the log in. Please try again.\r\n sync.fail.bad.network=Couldn't contact server. Please make sure an internet connection is available or try again later.\r\n sync.fail.server.error=The server encountered an error processing your data. Please try again later. If the problem persists, contact CommCare Support.\r\n-sync.fail.rate.limited.server.error=Our servers are unavailable at this time. Please try again later.\r\n+sync.fail.rate.limited.server.error=Form submission rate limit reached. Your forms are being saved locally and will be submitted to the server later.\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NzIwNw=="}, "originalCommit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTI4ODUzOnYy", "diffSide": "RIGHT", "path": "app/assets/locales/android_translatable_strings.txt", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoxOTo0NlrOGB83hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoxOTo0NlrOGB83hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5OTAxMw==", "bodyText": "can we prefix they keys like rate.limit.error.diaglog..... just to make them more specific.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404699013", "createdAt": "2020-04-07T10:19:46Z", "author": {"login": "shubham1g5"}, "path": "app/assets/locales/android_translatable_strings.txt", "diffHunk": "@@ -116,11 +117,16 @@ sync.fail.bad.data=Server provided improperly formatted data, please try again o\n sync.fail.bad.local=Your information was fetched, but a problem occurred with the log in. Please try again.\r\n sync.fail.bad.network=Couldn't contact server. Please make sure an internet connection is available or try again later.\r\n sync.fail.server.error=The server encountered an error processing your data. Please try again later. If the problem persists, contact CommCare Support.\r\n-sync.fail.rate.limited.server.error=Our servers are unavailable at this time. Please try again later.\r\n+sync.fail.rate.limited.server.error=Form submission rate limit reached. Your forms are being saved locally and will be submitted to the server later.\r\n sync.fail.unknown=An unexpected issue occurred during sync. Please try to sync again.\r\n sync.fail.unsent=Having issues communicating with the server to send forms. Will try again later.\r\n sync.fail.individual=1 or more forms failed to send due to individual problems. See quarantined forms for details.\r\n \r\n+form.send.rate.limit.error.title=You've reached your form submission rate limit\r\n+form.send.rate.limit.error.message=Form submissions will be saved locally on your phone until rate limiting expires. Not to worry, all forms will be auto-synced to the server later. Contact your CommCare admin for more information.\r\n+dialog.button.do.not.show.again=Don\u2019t show again\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTMwMzc0OnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/activities/RecoveryActivity.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoyNDowM1rOGB9BLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoyNDowM1rOGB9BLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcwMTQ4NQ==", "bodyText": "use form submission specific error message rather than sync", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404701485", "createdAt": "2020-04-07T10:24:03Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/RecoveryActivity.java", "diffHunk": "@@ -96,28 +96,37 @@ protected void deliverResult(RecoveryActivity receiver, FormUploadResult result)\n \r\n                         int successfulSends = this.getSuccessfulSends();\r\n \r\n-                        if (result == FormUploadResult.FULL_SUCCESS) {\r\n-                            receiver.updateStatus(StringUtils.getStringRobust(\r\n-                                    RecoveryActivity.this,\r\n-                                    R.string.recovery_forms_send_successful,\r\n-                                    String.valueOf(successfulSends)));\r\n-                            receiver.attemptRecovery();\r\n-                        } else if (result == FormUploadResult.FAILURE) {\r\n-                            String failureMessage = successfulSends > 0 ?\r\n-                                    StringUtils.getStringRobust(\r\n-                                            RecoveryActivity.this,\r\n-                                            R.string.recovery_forms_send_failure) :\r\n-                                    StringUtils.getStringRobust(\r\n-                                            RecoveryActivity.this,\r\n-                                            R.string.recovery_forms_send_parital_success,\r\n-                                            String.valueOf(successfulSends));\r\n-                            receiver.updateStatus(failureMessage);\r\n-                        } else if (result == FormUploadResult.TRANSPORT_FAILURE) {\r\n-                            receiver.updateStatus(R.string.recovery_forms_send_network_error);\r\n-                        } else if (result == FormUploadResult.RECORD_FAILURE) {\r\n-                            receiver.updateStatus(Localization.get(\"sync.fail.individual\"));\r\n-                        } else if (result == FormUploadResult.AUTH_OVER_HTTP) {\r\n-                            receiver.updateStatus(Localization.get(\"auth.over.http\"));\r\n+                        switch (result) {\r\n+                            case FULL_SUCCESS:\r\n+                                receiver.updateStatus(StringUtils.getStringRobust(\r\n+                                        RecoveryActivity.this,\r\n+                                        R.string.recovery_forms_send_successful,\r\n+                                        String.valueOf(successfulSends)));\r\n+                                receiver.attemptRecovery();\r\n+                                break;\r\n+                            case FAILURE:\r\n+                                String failureMessage = successfulSends > 0 ?\r\n+                                        StringUtils.getStringRobust(\r\n+                                                RecoveryActivity.this,\r\n+                                                R.string.recovery_forms_send_failure) :\r\n+                                        StringUtils.getStringRobust(\r\n+                                                RecoveryActivity.this,\r\n+                                                R.string.recovery_forms_send_parital_success,\r\n+                                                String.valueOf(successfulSends));\r\n+                                receiver.updateStatus(failureMessage);\r\n+                                break;\r\n+                            case TRANSPORT_FAILURE:\r\n+                                receiver.updateStatus(R.string.recovery_forms_send_network_error);\r\n+                                break;\r\n+                            case RECORD_FAILURE:\r\n+                                receiver.updateStatus(Localization.get(\"sync.fail.individual\"));\r\n+                                break;\r\n+                            case AUTH_OVER_HTTP:\r\n+                                receiver.updateStatus(Localization.get(\"auth.over.http\"));\r\n+                                break;\r\n+                            case RATE_LIMITED:\r\n+                                receiver.updateStatus(Localization.get(\"sync.fail.rate.limited.server.error\"));\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTMzOTM3OnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDozNDoyNVrOGB9Xpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDozNDoyNVrOGB9Xpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcwNzIzOA==", "bodyText": "should show the form submission specific message.", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404707238", "createdAt": "2020-04-07T10:34:25Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "diffHunk": "@@ -213,6 +215,28 @@ public void handleFormSendResult(String message, boolean success) {\n         }\n     }\n \n+    public void showRateLimitError(boolean userTriggered) {\n+\n+        if (HiddenPreferences.isRateLimitPopupDisabled() || !userTriggered) {\n+            handleFormSendResult(Localization.get(\"sync.fail.rate.limited.server.error\"), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3350, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}