{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMzM5Mjcx", "number": 2243, "title": "Adds lazy donwnload for multimedia for App Updates", "bodyText": "Spec: https://docs.google.com/document/d/1WWhgG6cyKm7nN2pUn8lty72F3ZN6D1xWqTZsIlHX4z8/edit#heading=h.xlb7kbytn7rw\n\nParses a new 'lazy' atrribute for resource definition\nSkips downloading the lazy media resource during install\nInitiate a Work manager task MissingMediaDownloadWorker on login to initiate lazy media download. This task today takes help of our existing multimedia verification to find out the lazy resources and installs them one by one in background\nChanges Media Layouts to support requesting for missing media on user click\n\ncross-request: dimagi/commcare-core#899", "createdAt": "2020-05-21T13:00:43Z", "url": "https://github.com/dimagi/commcare-android/pull/2243", "merged": true, "mergeCommit": {"oid": "01d69c573992861f2649bdebf3607849d3337260"}, "closed": true, "closedAt": "2020-06-11T17:55:18Z", "author": {"login": "shubham1g5"}, "timelineItems": {"totalCount": 55, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUqUlkAH2gAyNDIxMzM5MjcxOmM1YmI2ODI4MGFkMjZkZTdmNzc1ZjdiY2E2MjNkYTk0OWU1Y2Q1Yzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqRwJygFqTQyOTEzMzQzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c5bb68280ad26de7f775f7bca623da949e5cd5c7", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/c5bb68280ad26de7f775f7bca623da949e5cd5c7", "committedDate": "2020-04-05T13:43:04Z", "message": "Adds setting to turn on mm less updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e002dfde13fa458d8bb2b611d25f710ea9f9c93", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/1e002dfde13fa458d8bb2b611d25f710ea9f9c93", "committedDate": "2020-04-06T17:37:11Z", "message": "Adds lazy atrribute to resource and update the tables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8540e700f11399f9ed0dd1dbc991551dda0d3d8", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/b8540e700f11399f9ed0dd1dbc991551dda0d3d8", "committedDate": "2020-04-08T13:53:46Z", "message": "Skip installation of lazy media at update time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f722684e29e3394fec26e066aed2dce230ebae9", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/7f722684e29e3394fec26e066aed2dce230ebae9", "committedDate": "2020-04-09T07:19:11Z", "message": "Skips install for lazy resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d300f2049f7715f4d34becd72cf90f7dd1b7dc8a", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/d300f2049f7715f4d34becd72cf90f7dd1b7dc8a", "committedDate": "2020-04-12T18:05:22Z", "message": "Imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "457e56c4908a2ca6aa8b862cee4305714dfc367b", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/457e56c4908a2ca6aa8b862cee4305714dfc367b", "committedDate": "2020-04-12T18:11:51Z", "message": "Merge branch 'formSubmissionsScheduling' into multimediaChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0521498d41f6a2ac6901f58b8a803f01bdda01b8", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/0521498d41f6a2ac6901f58b8a803f01bdda01b8", "committedDate": "2020-04-13T07:56:50Z", "message": "Merge branch 'master' into multimediaChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "076b0aa0d3b5b1b184adefcdebb71e05c839bdcf", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/076b0aa0d3b5b1b184adefcdebb71e05c839bdcf", "committedDate": "2020-04-13T13:18:13Z", "message": "better classify missing media exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12b64a874f189b73e5f01fa44d0bb798f53318d8", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/12b64a874f189b73e5f01fa44d0bb798f53318d8", "committedDate": "2020-04-15T07:08:39Z", "message": "Schedules download for missing media"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09c6a6b653dfc98f125cd1f792a709a71cfe9a25", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/09c6a6b653dfc98f125cd1f792a709a71cfe9a25", "committedDate": "2020-04-17T11:22:46Z", "message": "Modularize File Install"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4edcccb32db3a977b3334b036db6c85e7f213b1", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/b4edcccb32db3a977b3334b036db6c85e7f213b1", "committedDate": "2020-04-17T11:23:14Z", "message": "initialize localreference even when it's a lazy resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f93d0c9d8f1fa272d6916a618d1d5ddeba6736ca", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/f93d0c9d8f1fa272d6916a618d1d5ddeba6736ca", "committedDate": "2020-04-17T11:25:01Z", "message": "Changes mm verfication to skip lazy resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84479cfac4c5fb4aba9f20207ef00baebf07a31e", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/84479cfac4c5fb4aba9f20207ef00baebf07a31e", "committedDate": "2020-04-17T11:25:46Z", "message": "going a bit more functional"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2511e7e1f00f4b302e6ecffdc763e368a10adf1f", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/2511e7e1f00f4b302e6ecffdc763e368a10adf1f", "committedDate": "2020-04-28T15:22:32Z", "message": "Indexes lazy property for resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f37a72fd0e9769adf15de0cf65f4e2859090bba9", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/f37a72fd0e9769adf15de0cf65f4e2859090bba9", "committedDate": "2020-04-30T09:41:17Z", "message": "changes verification task to account for missing media from lazy resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9ea1115bb6789a2a5ee9497a36acfbe13ba9b6b", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/a9ea1115bb6789a2a5ee9497a36acfbe13ba9b6b", "committedDate": "2020-04-30T18:41:51Z", "message": "Merge branch 'formSubmissionsScheduling' into multimediaChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35101bc2ebdeeb75123d2e69795be32c283dad5c", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/35101bc2ebdeeb75123d2e69795be32c283dad5c", "committedDate": "2020-04-30T18:43:57Z", "message": "Merge branch 'master' into multimediaChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45e786c09aa563e5d7cb59c9afdc3581d6013f1b", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/45e786c09aa563e5d7cb59c9afdc3581d6013f1b", "committedDate": "2020-05-01T14:02:42Z", "message": "Update kotlin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3528b6e2093ba209873e772463035d91488af79b", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/3528b6e2093ba209873e772463035d91488af79b", "committedDate": "2020-05-01T14:03:16Z", "message": "Adds structure to request individual media"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11b5010d86e234502514aa6e191190814ab2811e", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/11b5010d86e234502514aa6e191190814ab2811e", "committedDate": "2020-05-01T21:11:20Z", "message": "Merge branch 'master' into multimediaChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b165701cc63342af238dc73f0112237c2a503422", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/b165701cc63342af238dc73f0112237c2a503422", "committedDate": "2020-05-02T06:56:40Z", "message": "Corrects Missing media download"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b59062399434711ef80cb26a634aedd2166ef800", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/b59062399434711ef80cb26a634aedd2166ef800", "committedDate": "2020-05-02T18:19:59Z", "message": "Media Download Hooks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "093f8b0cab0ea8e436b42d9db4812f5c28ed969e", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/093f8b0cab0ea8e436b42d9db4812f5c28ed969e", "committedDate": "2020-05-02T20:00:45Z", "message": "remove repeatition for missing media view"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c0f8ae32222534cf1734ce60d06ab674f2a30bc", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/2c0f8ae32222534cf1734ce60d06ab674f2a30bc", "committedDate": "2020-05-03T21:34:24Z", "message": "Adds missing media pane view"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd8e74ef612bfc5f75a93ab2a50eabc9f09c00c1", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/dd8e74ef612bfc5f75a93ab2a50eabc9f09c00c1", "committedDate": "2020-05-04T22:31:33Z", "message": "Refreshes media pane on download complete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f3b44f9a2ad142f433772e0fec072b355abffb2", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/6f3b44f9a2ad142f433772e0fec072b355abffb2", "committedDate": "2020-05-05T19:39:34Z", "message": "Log errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8f7ec820868b3ec26ed6a7fab79a1042e6f0f2", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/ae8f7ec820868b3ec26ed6a7fab79a1042e6f0f2", "committedDate": "2020-05-19T07:52:41Z", "message": "Sets up missing views for audio button and image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa814633d9fb61b17f43e591e66d3437f5995c00", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/fa814633d9fb61b17f43e591e66d3437f5995c00", "committedDate": "2020-05-19T11:25:46Z", "message": "rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "630647502a4fd3326742059335e015db374d1b4b", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/630647502a4fd3326742059335e015db374d1b4b", "committedDate": "2020-05-20T13:30:12Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df6c4ebc736a465c210f31b563d2206c4326e570", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/df6c4ebc736a465c210f31b563d2206c4326e570", "committedDate": "2020-05-21T13:18:40Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/ce9309c52a3a09d3b3df872e33364c06e9e6f3d5", "committedDate": "2020-05-21T19:47:34Z", "message": "Exception handelling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNjE5MDcx", "url": "https://github.com/dimagi/commcare-android/pull/2243#pullrequestreview-420619071", "createdAt": "2020-05-29T02:49:36Z", "commit": {"oid": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwMjo0OTozNlrOGcNGRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwMjo1NToyOFrOGcNLrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyNzkwOQ==", "bodyText": "Not sure where this list is populated from, but heads up that iterating over resources is a really expensive operation on really large apps like CAS. This might need to get cached into a table which is indexed by the file URI", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432227909", "createdAt": "2020-05-29T02:49:36Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/engine/resource/AndroidResourceUtils.kt", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.commcare.engine.resource\n+\n+import org.commcare.android.resource.installers.MediaFileAndroidInstaller\n+import org.commcare.resources.model.MissingMediaException\n+import org.commcare.resources.model.Resource\n+import org.javarosa.core.reference.InvalidReferenceException\n+import org.javarosa.core.reference.ReferenceManager\n+import java.io.File\n+import java.io.IOException\n+import java.util.*\n+\n+object AndroidResourceUtils {\n+\n+    // loops over all lazy resources and checks if one of them has the same local path as {@param problem} URI\n+    @JvmStatic\n+    fun ifUriBelongsToALazyResource(problem: MissingMediaException, lazyResources: Vector<Resource>): Boolean {\n+        for (lazyResource in lazyResources) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyODI0NA==", "bodyText": "I think it's really risky to swallow these. IRE's are almost always the result of a bug, and the IOException is absorbing a pretty large surface area", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432228244", "createdAt": "2020-05-29T02:50:57Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/engine/resource/AndroidResourceUtils.kt", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.commcare.engine.resource\n+\n+import org.commcare.android.resource.installers.MediaFileAndroidInstaller\n+import org.commcare.resources.model.MissingMediaException\n+import org.commcare.resources.model.Resource\n+import org.javarosa.core.reference.InvalidReferenceException\n+import org.javarosa.core.reference.ReferenceManager\n+import java.io.File\n+import java.io.IOException\n+import java.util.*\n+\n+object AndroidResourceUtils {\n+\n+    // loops over all lazy resources and checks if one of them has the same local path as {@param problem} URI\n+    @JvmStatic\n+    fun ifUriBelongsToALazyResource(problem: MissingMediaException, lazyResources: Vector<Resource>): Boolean {\n+        for (lazyResource in lazyResources) {\n+            if (matchFileUriToResource(lazyResource, problem.uri)) {\n+                return true\n+            }\n+        }\n+        return false\n+    }\n+\n+    // checks if {@param resource} has same location as that represented by {@param uri}\n+    @JvmStatic\n+    fun matchFileUriToResource(resource: Resource, uri: String?): Boolean {\n+        if (resource.installer is MediaFileAndroidInstaller) {\n+            try {\n+                val resourceUri = (resource.installer as MediaFileAndroidInstaller).localLocation\n+                val resourcePath = ReferenceManager.instance().DeriveReference(resourceUri).localURI\n+                val problemPath = ReferenceManager.instance().DeriveReference(uri).localURI\n+                if (File(resourcePath).canonicalPath.contentEquals(File(problemPath).canonicalPath)) {\n+                    return true\n+                }\n+            } catch (e: InvalidReferenceException) {\n+                e.printStackTrace()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyODcxNA==", "bodyText": "Have you timed this operation with CAS, out of curiosity?", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432228714", "createdAt": "2020-05-29T02:52:55Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/mediadownload/MissingMediaDownloadHelper.kt", "diffHunk": "@@ -0,0 +1,196 @@\n+package org.commcare.mediadownload\n+\n+import android.content.Context\n+import android.widget.ImageButton\n+import android.widget.Toast\n+import androidx.work.*\n+import kotlinx.coroutines.*\n+import org.commcare.CommCareApplication\n+import org.commcare.dalvik.R\n+import org.commcare.engine.resource.AndroidResourceUtils\n+import org.commcare.engine.resource.ResourceInstallUtils\n+import org.commcare.preferences.HiddenPreferences\n+import org.commcare.resources.model.*\n+import org.commcare.utils.AndroidCommCarePlatform\n+import org.commcare.utils.AndroidUtil\n+import org.commcare.utils.FileUtil\n+import org.commcare.views.dialogs.PinnedNotificationWithProgress\n+import org.javarosa.core.services.Logger\n+import org.javarosa.core.util.SizeBoundUniqueVector\n+import java.util.*\n+import java.util.concurrent.TimeUnit\n+import kotlin.collections.ArrayList\n+\n+// Contains helper functions to download lazy or missing media resources\n+object MissingMediaDownloadHelper : TableStateListener, InstallCancelled {\n+\n+    var resourceInProgress: Resource? = null\n+        private set\n+\n+    private val jobs = ArrayList<Job>()\n+    private lateinit var mPinnedNotificationProgress: PinnedNotificationWithProgress\n+\n+\n+    private const val BACK_OFF_DELAY = 5 * 60 * 1000L // 5 mins\n+    private const val REQUEST_NAME = \"missing_media_download_request\"\n+\n+    var installCancelled: InstallCancelled? = null\n+\n+    // Schedules MissingMediaDownloadWorker\n+    @JvmStatic\n+    fun scheduleMissingMediaDownload() {\n+        if (HiddenPreferences.shouldDownloadLazyMediaInBackground()) {\n+            val constraints = Constraints.Builder()\n+                    .setRequiredNetworkType(NetworkType.CONNECTED)\n+                    .setRequiresBatteryNotLow(true)\n+                    .build()\n+\n+            val downloadMissingMediaRequest = OneTimeWorkRequest.Builder(MissingMediaDownloadWorker::class.java)\n+                    .addTag(CommCareApplication.instance().currentApp.appRecord.applicationId)\n+                    .setConstraints(constraints)\n+                    .setBackoffCriteria(\n+                            BackoffPolicy.EXPONENTIAL,\n+                            BACK_OFF_DELAY,\n+                            TimeUnit.MILLISECONDS)\n+                    .build()\n+\n+            WorkManager.getInstance(CommCareApplication.instance())\n+                    .enqueueUniqueWork(\n+                            getMissingMediaDownloadRequestName(),\n+                            ExistingWorkPolicy.KEEP,\n+                            downloadMissingMediaRequest)\n+        }\n+    }\n+\n+    // Returns Unique request name for the UpdateWorker Request\n+    private fun getMissingMediaDownloadRequestName(): String {\n+        val appId = CommCareApplication.instance().currentApp.uniqueId\n+        return REQUEST_NAME + \"_\" + appId\n+    }\n+\n+\n+    // Verifies all application media and re-downloads any missing lazy resources\n+    fun downloadAllMissingMedia() {\n+        val platform = CommCareApplication.instance().commCarePlatform\n+        val global = platform.globalResourceTable\n+\n+        global.setInstallCancellationChecker(this)\n+\n+        val problems = Vector<MissingMediaException>()\n+        global.verifyInstallation(problems, platform)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyOTA5Mg==", "bodyText": "Same comment as above that I think this is likely to be too expensive to be practical if this list is as big as CAS's", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432229092", "createdAt": "2020-05-29T02:54:39Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/mediadownload/MissingMediaDownloadHelper.kt", "diffHunk": "@@ -0,0 +1,196 @@\n+package org.commcare.mediadownload\n+\n+import android.content.Context\n+import android.widget.ImageButton\n+import android.widget.Toast\n+import androidx.work.*\n+import kotlinx.coroutines.*\n+import org.commcare.CommCareApplication\n+import org.commcare.dalvik.R\n+import org.commcare.engine.resource.AndroidResourceUtils\n+import org.commcare.engine.resource.ResourceInstallUtils\n+import org.commcare.preferences.HiddenPreferences\n+import org.commcare.resources.model.*\n+import org.commcare.utils.AndroidCommCarePlatform\n+import org.commcare.utils.AndroidUtil\n+import org.commcare.utils.FileUtil\n+import org.commcare.views.dialogs.PinnedNotificationWithProgress\n+import org.javarosa.core.services.Logger\n+import org.javarosa.core.util.SizeBoundUniqueVector\n+import java.util.*\n+import java.util.concurrent.TimeUnit\n+import kotlin.collections.ArrayList\n+\n+// Contains helper functions to download lazy or missing media resources\n+object MissingMediaDownloadHelper : TableStateListener, InstallCancelled {\n+\n+    var resourceInProgress: Resource? = null\n+        private set\n+\n+    private val jobs = ArrayList<Job>()\n+    private lateinit var mPinnedNotificationProgress: PinnedNotificationWithProgress\n+\n+\n+    private const val BACK_OFF_DELAY = 5 * 60 * 1000L // 5 mins\n+    private const val REQUEST_NAME = \"missing_media_download_request\"\n+\n+    var installCancelled: InstallCancelled? = null\n+\n+    // Schedules MissingMediaDownloadWorker\n+    @JvmStatic\n+    fun scheduleMissingMediaDownload() {\n+        if (HiddenPreferences.shouldDownloadLazyMediaInBackground()) {\n+            val constraints = Constraints.Builder()\n+                    .setRequiredNetworkType(NetworkType.CONNECTED)\n+                    .setRequiresBatteryNotLow(true)\n+                    .build()\n+\n+            val downloadMissingMediaRequest = OneTimeWorkRequest.Builder(MissingMediaDownloadWorker::class.java)\n+                    .addTag(CommCareApplication.instance().currentApp.appRecord.applicationId)\n+                    .setConstraints(constraints)\n+                    .setBackoffCriteria(\n+                            BackoffPolicy.EXPONENTIAL,\n+                            BACK_OFF_DELAY,\n+                            TimeUnit.MILLISECONDS)\n+                    .build()\n+\n+            WorkManager.getInstance(CommCareApplication.instance())\n+                    .enqueueUniqueWork(\n+                            getMissingMediaDownloadRequestName(),\n+                            ExistingWorkPolicy.KEEP,\n+                            downloadMissingMediaRequest)\n+        }\n+    }\n+\n+    // Returns Unique request name for the UpdateWorker Request\n+    private fun getMissingMediaDownloadRequestName(): String {\n+        val appId = CommCareApplication.instance().currentApp.uniqueId\n+        return REQUEST_NAME + \"_\" + appId\n+    }\n+\n+\n+    // Verifies all application media and re-downloads any missing lazy resources\n+    fun downloadAllMissingMedia() {\n+        val platform = CommCareApplication.instance().commCarePlatform\n+        val global = platform.globalResourceTable\n+\n+        global.setInstallCancellationChecker(this)\n+\n+        val problems = Vector<MissingMediaException>()\n+        global.verifyInstallation(problems, platform)\n+\n+        val missingMediaResources = SizeBoundUniqueVector<Resource>(problems.size)\n+        val lazyResources = global.lazyResources\n+\n+        problems.filter { problem -> problem.type == MissingMediaException.MissingMediaExceptionType.FILE_NOT_FOUND }\n+                .map { problem ->\n+                    runCatching {\n+                        missingMediaResources.add(getLazyResourceFromMediaUri(lazyResources, problem.uri))\n+                    }.onFailure {\n+                        Logger.exception(\n+                                \"Could not map to a lazy resource while downloading missing media for uri ${problem.uri}\",\n+                                java.lang.Exception(it))\n+                    }\n+                }\n+\n+        startPinnedNotification()\n+\n+        missingMediaResources.mapIndexed { index, resource ->\n+            if (!wasInstallCancelled()) {\n+                recoverResource(platform, resource)\n+                incrementProgress(index + 1, missingMediaResources.size)\n+            }\n+        }\n+\n+        cancelNotification()\n+        global.setInstallCancellationChecker(null)\n+    }\n+\n+    /**\n+     * Downloads a resource with it's location represented by {@param mediaUri}\n+     */\n+    @JvmStatic\n+    fun requestMediaDownload(mediaUri: String, missingMediaDownloadListener: MissingMediaDownloadListener) {\n+        jobs.add(\n+                CoroutineScope(Dispatchers.Default).launch {\n+                    var result: MissingMediaDownloadResult = MissingMediaDownloadResult.Error(\"Unknown Error\")\n+                    try {\n+                        result = downloadMissingMediaResource(mediaUri)\n+                    } catch (e: Exception) {\n+                        Logger.exception(\" An error occured while recovering a missing resource\", e);\n+                        withContext(Dispatchers.Main) {\n+                            missingMediaDownloadListener.onComplete(MissingMediaDownloadResult.Exception(e))\n+                        }\n+                    }\n+\n+                    withContext(Dispatchers.Main) {\n+                        missingMediaDownloadListener.onComplete(result)\n+                    }\n+                }\n+        )\n+    }\n+\n+    private fun downloadMissingMediaResource(uri: String): MissingMediaDownloadResult {\n+        val platform = CommCareApplication.instance().commCarePlatform\n+        val global = platform.globalResourceTable\n+        val lazyResources: Vector<Resource> = global.lazyResources!!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyOTI5NQ==", "bodyText": "Shouldn't there be a lock of some sort around each one of these jobs, or is that inherent to the job class?", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432229295", "createdAt": "2020-05-29T02:55:28Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/mediadownload/MissingMediaDownloadHelper.kt", "diffHunk": "@@ -0,0 +1,196 @@\n+package org.commcare.mediadownload\n+\n+import android.content.Context\n+import android.widget.ImageButton\n+import android.widget.Toast\n+import androidx.work.*\n+import kotlinx.coroutines.*\n+import org.commcare.CommCareApplication\n+import org.commcare.dalvik.R\n+import org.commcare.engine.resource.AndroidResourceUtils\n+import org.commcare.engine.resource.ResourceInstallUtils\n+import org.commcare.preferences.HiddenPreferences\n+import org.commcare.resources.model.*\n+import org.commcare.utils.AndroidCommCarePlatform\n+import org.commcare.utils.AndroidUtil\n+import org.commcare.utils.FileUtil\n+import org.commcare.views.dialogs.PinnedNotificationWithProgress\n+import org.javarosa.core.services.Logger\n+import org.javarosa.core.util.SizeBoundUniqueVector\n+import java.util.*\n+import java.util.concurrent.TimeUnit\n+import kotlin.collections.ArrayList\n+\n+// Contains helper functions to download lazy or missing media resources\n+object MissingMediaDownloadHelper : TableStateListener, InstallCancelled {\n+\n+    var resourceInProgress: Resource? = null\n+        private set\n+\n+    private val jobs = ArrayList<Job>()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20e352c4ab5ef47ec6ae3f5346e9ce9540932a48", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/20e352c4ab5ef47ec6ae3f5346e9ce9540932a48", "committedDate": "2020-05-29T07:50:49Z", "message": "Removes exception catches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bed4a6f7a6e795d5eebbc7688179775663027670", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/bed4a6f7a6e795d5eebbc7688179775663027670", "committedDate": "2020-05-29T09:05:05Z", "message": "Merge branch 'master' into multimediaChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9865305a623cea4a4aa9125c70e960d46dbf16ce", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/9865305a623cea4a4aa9125c70e960d46dbf16ce", "committedDate": "2020-05-29T09:11:47Z", "message": "Merge branch 'master' into multimediaChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a398369a989ae8ac04eef1b9a930b8dee68b302a", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/a398369a989ae8ac04eef1b9a930b8dee68b302a", "committedDate": "2020-05-29T09:33:07Z", "message": "Cancellation on unseat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "717d492cb069c74f4f1f5d215e62c4c2b1bb450e", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/717d492cb069c74f4f1f5d215e62c4c2b1bb450e", "committedDate": "2020-06-01T13:22:50Z", "message": "Merge branch 'master' into multimediaChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a20d0ca8f965b9ee6aaac5c29f9a9ee56f3eb62", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/3a20d0ca8f965b9ee6aaac5c29f9a9ee56f3eb62", "committedDate": "2020-06-06T12:34:53Z", "message": "Loops over lazy resources to install missing media"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5fb86158cb77cb120d00ae8a1e34026b9987108", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/a5fb86158cb77cb120d00ae8a1e34026b9987108", "committedDate": "2020-06-07T11:31:35Z", "message": "Error Handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f44d2dcc3edb7d6f0c12ec00f7771e0e5bed9f60", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/f44d2dcc3edb7d6f0c12ec00f7771e0e5bed9f60", "committedDate": "2020-06-07T12:17:00Z", "message": "Merge branch 'master' into multimediaChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7700747791ec0fb354bcf9c5cb2b9cc056adf1f5", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/7700747791ec0fb354bcf9c5cb2b9cc056adf1f5", "committedDate": "2020-06-07T15:44:54Z", "message": "Only run lazy media task once per app version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "602ae83c83e49a4159694dd6d5958543ad600763", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/602ae83c83e49a4159694dd6d5958543ad600763", "committedDate": "2020-06-07T17:59:09Z", "message": "Removes the property behind lazy media download as there is not much overhead of the download task now"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MzA4NjM1", "url": "https://github.com/dimagi/commcare-android/pull/2243#pullrequestreview-426308635", "createdAt": "2020-06-08T14:38:11Z", "commit": {"oid": "7700747791ec0fb354bcf9c5cb2b9cc056adf1f5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNDo0MDoxMFrOGghv1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNDo0Mzo1N1rOGgh6VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2MDUzNQ==", "bodyText": "I'm not sure why we'd ever been running lazy media installers for multiple app versions. Are we lazy installing the upgrade table as well as the installed version? or is this due to some behavior that happens after handing over between updates being applied??", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r436760535", "createdAt": "2020-06-08T14:40:10Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/mediadownload/MissingMediaDownloadHelper.kt", "diffHunk": "@@ -72,29 +72,32 @@ object MissingMediaDownloadHelper : TableStateListener, InstallCancelled {\n      * Downloads any missing lazy resources, make sure to call this on background thread\n      */\n     fun downloadAllLazyMedia(): AppInstallStatus {\n-        val platform = CommCareApplication.instance().commCarePlatform\n-        val global = platform.globalResourceTable\n-\n-        global.setInstallCancellationChecker(this)\n-        startPinnedNotification()\n-\n-        val lazyResourceIds = global.lazyResourceIds\n-        lazyResourceIds.asSequence()\n-                .runCatching {\n-                    withIndex()\n-                            .onEach { incrementProgress(it.index + 1, lazyResourceIds.size) }\n-                            .takeWhile { !wasInstallCancelled() }\n-                            .map { global.getResource(it.value) }\n-                            .filter { isResourceMissing(it) }\n-                            .takeWhile { !wasInstallCancelled() }\n-                            .onEach { recoverResource(platform, it) }.toList()\n-                }.onFailure {\n-                    Logger.log(LogTypes.TYPE_MAINTENANCE, \"An error occured while lazy downloading a media resource : \" + it.message)\n-                    return handleRecoverResourceFailure(it).data\n-                }\n+        if (!HiddenPreferences.hasLazyMediaDownloaded()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7700747791ec0fb354bcf9c5cb2b9cc056adf1f5"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2MzIyMA==", "bodyText": "Don't we only want to retry automatically on specific errors?\nIn the handling list above, 3 of the 4 errors wouldn't be good for us to run a retry on", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r436763220", "createdAt": "2020-06-08T14:43:57Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/mediadownload/MissingMediaDownloadWorker.kt", "diffHunk": "@@ -3,21 +3,16 @@ package org.commcare.mediadownload\n import android.content.Context\n import androidx.work.CoroutineWorker\n import androidx.work.WorkerParameters\n+import org.commcare.engine.resource.AppInstallStatus\n import org.commcare.resources.model.InstallCancelled\n \n class MissingMediaDownloadWorker(appContext: Context, workerParams: WorkerParameters)\n     : CoroutineWorker(appContext, workerParams), InstallCancelled {\n \n     override suspend fun doWork(): Result {\n         MissingMediaDownloadHelper.installCancelled = this\n-        kotlin.runCatching {\n-            MissingMediaDownloadHelper.downloadAllLazyMedia()\n-        }.onSuccess {\n-            return Result.success()\n-        }.onFailure {\n-            return Result.failure()\n-        }\n-        return Result.failure()\n+        val result = MissingMediaDownloadHelper.downloadAllLazyMedia()\n+        return if (result == AppInstallStatus.Installed) Result.success() else Result.retry()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5fb86158cb77cb120d00ae8a1e34026b9987108"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1013ffb4cf7a2150fcf970fd632549d81de38202", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/1013ffb4cf7a2150fcf970fd632549d81de38202", "committedDate": "2020-06-08T20:56:05Z", "message": "Use single lazyMediaComplete pref and reset it after update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebce1e916a855ed074535f8b7bb3f4466dcbb06c", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/ebce1e916a855ed074535f8b7bb3f4466dcbb06c", "committedDate": "2020-06-08T21:52:41Z", "message": "only retry in case of non persistent failures"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjYzMTY5", "url": "https://github.com/dimagi/commcare-android/pull/2243#pullrequestreview-426663169", "createdAt": "2020-06-08T22:24:10Z", "commit": {"oid": "ebce1e916a855ed074535f8b7bb3f4466dcbb06c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a035bf136492a1d95ca046585d4e8c8f150971a", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/6a035bf136492a1d95ca046585d4e8c8f150971a", "committedDate": "2020-06-09T07:08:47Z", "message": "Merge branch 'master' into multimediaChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "971a3ffd42082ee87195a78631267d2d35c1e92b", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/971a3ffd42082ee87195a78631267d2d35c1e92b", "committedDate": "2020-06-09T09:30:22Z", "message": "Removed the file missing toast for audio button"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c20179865485ea96c6c9dd65c8c7b66fb4cf9fb8", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/c20179865485ea96c6c9dd65c8c7b66fb4cf9fb8", "committedDate": "2020-06-09T09:35:41Z", "message": "Localized error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "993cd3a53767bc0f1db7267b579193a372f22745", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/993cd3a53767bc0f1db7267b579193a372f22745", "committedDate": "2020-06-09T09:53:28Z", "message": "Reverts earlier change on disabling the audio toast and instead only show the toast when the button is visible"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NjYyMTU0", "url": "https://github.com/dimagi/commcare-android/pull/2243#pullrequestreview-427662154", "createdAt": "2020-06-10T02:06:28Z", "commit": {"oid": "993cd3a53767bc0f1db7267b579193a372f22745"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04418570caf7da2bbf9ec13b70efaf34b22693ae", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/04418570caf7da2bbf9ec13b70efaf34b22693ae", "committedDate": "2020-06-10T15:15:55Z", "message": "bool -> string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55893cbd336b7b1574854de43a4266835368d6d2", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/55893cbd336b7b1574854de43a4266835368d6d2", "committedDate": "2020-06-10T17:20:13Z", "message": "use static values for lazy values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81afda4ef402a7fdbc5162b9b769c00b1e3a009c", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/81afda4ef402a7fdbc5162b9b769c00b1e3a009c", "committedDate": "2020-06-10T17:21:32Z", "message": "Merge branch 'master' into multimediaChanges"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MTMzNDMz", "url": "https://github.com/dimagi/commcare-android/pull/2243#pullrequestreview-429133433", "createdAt": "2020-06-11T17:31:53Z", "commit": {"oid": "81afda4ef402a7fdbc5162b9b769c00b1e3a009c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2050, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}