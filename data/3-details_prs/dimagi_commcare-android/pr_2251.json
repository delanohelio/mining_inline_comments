{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MjU3ODI2", "number": 2251, "title": "Prevent resource leak in datapull response", "bodyText": "A fix for below error:\nE/StrictMode: A resource was acquired at attached stack trace but never released. See java.io.Closeable for information on avoiding resource leaks.\n    java.lang.Throwable: Explicit termination method 'end' not called\n        at dalvik.system.CloseGuard.open(CloseGuard.java:180)\n        at java.util.zip.Inflater.<init>(Inflater.java:104)\n        at okio.GzipSource.<init>(GzipSource.java:62)\n        at okhttp3.internal.http.BridgeInterceptor.intercept(BridgeInterceptor.java:103)\n        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:147)\n        at okhttp3.internal.http.RetryAndFollowUpInterceptor.intercept(RetryAndFollowUpInterceptor.java:127)\n        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:147)\n        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:121)\n        at org.commcare.core.network.CommCareNetworkServiceGenerator.lambda$static$1(CommCareNetworkServiceGenerator.java:54)\n        at org.commcare.core.network.-$$Lambda$CommCareNetworkServiceGenerator$fX7m-R1dXT50fs5DH6Cqp3nWWyI.intercept(lambda)\n        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:147)\n        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:121)\n        at org.commcare.core.network.AuthenticationInterceptor.intercept(AuthenticationInterceptor.java:35)\n        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:147)\n        at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.java:121)\n        at okhttp3.RealCall.getResponseWithInterceptorChain(RealCall.java:257)\n        at okhttp3.RealCall.execute(RealCall.java:93)\n        at retrofit2.OkHttpCall.execute(OkHttpCall.java:180)\n        at retrofit2.ExecutorCallAdapterFactory$ExecutorCallbackCall.execute(ExecutorCallAdapterFactory.java:91)\n        at org.commcare.core.network.ModernHttpRequester.executeAndCheckCaptivePortals(ModernHttpRequester.java:125)\n        at org.commcare.core.network.ModernHttpRequester.makeRequest(ModernHttpRequester.java:120)\n        at org.commcare.network.CommcareRequestGenerator.makeCaseFetchRequest(CommcareRequestGenerator.java:137)\n        at org.commcare.network.DataPullResponseFactory.makeDataPullRequest(DataPullResponseFactory.java:24)\n        at org.commcare.tasks.DataPullTask.makeRequestAndHandleResponse(DataPullTask.java:294)\n        at org.commcare.tasks.DataPullTask.getRequestResultOrRetry(DataPullTask.java:250)\n        at org.commcare.tasks.DataPullTask.doTaskBackgroundHelper(DataPullTask.java:169)\n        at org.commcare.tasks.DataPullTask.doTaskBackground(DataPullTask.java:139)\n        at org.commcare.tasks.DataPullTask.doTaskBackground(DataPullTask.java:64)\n        at org.commcare.tasks.templates.CommCareTask.doInBackground(CommCareTask.java:40)\n        at android.os.AsyncTask$2.call(AsyncTask.java:304)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:237)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1133)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:607)\n        at java.lang.Thread.run(Thread.java:760)\n\nAlso, Okhttp ResponseBody docs has a very nice explanation about this.\nCopying it here as well:\nEach response body is backed by a limited resource like a socket (live network responses) or\nan open file (for cached responses). Failing to close the response body will leak resources and\nmay ultimately cause the application to slow down or crash.", "createdAt": "2020-05-28T05:28:32Z", "url": "https://github.com/dimagi/commcare-android/pull/2251", "merged": true, "mergeCommit": {"oid": "efd17068ab440c95dae0f67b981bcf02334683ba"}, "closed": true, "closedAt": "2020-05-29T06:05:18Z", "author": {"login": "ShivamPokhriyal"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclm9nBAH2gAyNDI0MjU3ODI2OjU2ODJmMmY3MGU0YmM0Y2E0YWU1Y2FiZjk5ZWJhYTU2MzNjNjRiMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcltGlaAFqTQyMDA2MDU4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5682f2f70e4bc4ca4ae5cabf99ebaa5633c64b23", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/5682f2f70e4bc4ca4ae5cabf99ebaa5633c64b23", "committedDate": "2020-05-28T05:24:58Z", "message": "Prevent resource leak in datapull response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODA2NjAy", "url": "https://github.com/dimagi/commcare-android/pull/2251#pullrequestreview-419806602", "createdAt": "2020-05-28T06:20:11Z", "commit": {"oid": "5682f2f70e4bc4ca4ae5cabf99ebaa5633c64b23"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "070fb29f7587ba4a93bd0f37eb6c0b1311b1c07b", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/070fb29f7587ba4a93bd0f37eb6c0b1311b1c07b", "committedDate": "2020-05-28T07:08:50Z", "message": "Close response error body"}, "afterCommit": {"oid": "5682f2f70e4bc4ca4ae5cabf99ebaa5633c64b23", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/5682f2f70e4bc4ca4ae5cabf99ebaa5633c64b23", "committedDate": "2020-05-28T05:24:58Z", "message": "Prevent resource leak in datapull response"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae184582f4984e7eeb6767eff8927dee4dcdd2b7", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/ae184582f4984e7eeb6767eff8927dee4dcdd2b7", "committedDate": "2020-05-28T07:14:08Z", "message": "Avoid using raw type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODQwNjg3", "url": "https://github.com/dimagi/commcare-android/pull/2251#pullrequestreview-419840687", "createdAt": "2020-05-28T07:22:41Z", "commit": {"oid": "ae184582f4984e7eeb6767eff8927dee4dcdd2b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoyMjo0MVrOGboueg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoyMjo0MVrOGboueg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzMTk5NA==", "bodyText": "This line should be enough to resolve the issue, so let me know if the other changes doesn't make much sense.", "url": "https://github.com/dimagi/commcare-android/pull/2251#discussion_r431631994", "createdAt": "2020-05-28T07:22:41Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/network/RemoteDataPullResponse.java", "diffHunk": "@@ -51,15 +61,12 @@ protected RemoteDataPullResponse(DataPullTask task,\n      */\n     public BitCache writeResponseToCache(Context c) throws IOException {\n         BitCache cache = null;\n-        try {\n-            final long dataSizeGuess = ModernHttpRequester.getContentLength(response);\n-\n+        try (InputStream input = getInputStream()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae184582f4984e7eeb6767eff8927dee4dcdd2b7"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d852e1ba021c8db56cd33e3c3f9eceb9226cbf4b", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/d852e1ba021c8db56cd33e3c3f9eceb9226cbf4b", "committedDate": "2020-05-28T11:07:53Z", "message": "Revert changes to data pull response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMDM2OTE2", "url": "https://github.com/dimagi/commcare-android/pull/2251#pullrequestreview-420036916", "createdAt": "2020-05-28T12:00:31Z", "commit": {"oid": "d852e1ba021c8db56cd33e3c3f9eceb9226cbf4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjowMDozMVrOGbx6NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjowMDozMVrOGbx6NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc4MjQ1Mg==", "bodyText": "is this still relevant ?", "url": "https://github.com/dimagi/commcare-android/pull/2251#discussion_r431782452", "createdAt": "2020-05-28T12:00:31Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/network/DataPullResponseFactory.java", "diffHunk": "@@ -21,7 +22,7 @@ public RemoteDataPullResponse makeDataPullRequest(DataPullTask task,\n                                                       CommcareRequestEndpoints requestor,\n                                                       String server,\n                                                       boolean includeSyncToken) throws IOException {\n-        Response response = requestor.makeCaseFetchRequest(server, includeSyncToken);\n+        Response<ResponseBody> response = requestor.makeCaseFetchRequest(server, includeSyncToken);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d852e1ba021c8db56cd33e3c3f9eceb9226cbf4b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMDYwNTg0", "url": "https://github.com/dimagi/commcare-android/pull/2251#pullrequestreview-420060584", "createdAt": "2020-05-28T12:34:12Z", "commit": {"oid": "d852e1ba021c8db56cd33e3c3f9eceb9226cbf4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2057, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}