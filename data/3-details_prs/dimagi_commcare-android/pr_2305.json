{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMjI2MTMw", "number": 2305, "title": "Add idling resource to avoid AppNotIdleExceptions", "bodyText": "The tests are sometimes failing with AppNotIdleException. This PR will add an idling resource to make tests more robust.", "createdAt": "2020-08-03T14:54:58Z", "url": "https://github.com/dimagi/commcare-android/pull/2305", "merged": true, "mergeCommit": {"oid": "372d67b2dfc93501292cc57f69dceb64b0b804cf"}, "closed": true, "closedAt": "2020-08-04T09:24:35Z", "author": {"login": "ShivamPokhriyal"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7TQAzAH2gAyNDYyMjI2MTMwOmNjYjhhNGUyNTRjMjM1ZDAyZTk1ODMxMGM2Nzg3M2ZlNDkzNWU0MmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7ilp_gFqTQ2MDYxNjQ5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ccb8a4e254c235d02e958310c67873fe4935e42a", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/ccb8a4e254c235d02e958310c67873fe4935e42a", "committedDate": "2020-08-03T14:53:18Z", "message": "Add idling resource to avoid AppNotIdleExceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTg2Nzg3", "url": "https://github.com/dimagi/commcare-android/pull/2305#pullrequestreview-460586787", "createdAt": "2020-08-04T08:05:14Z", "commit": {"oid": "ccb8a4e254c235d02e958310c67873fe4935e42a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwODowNToxNFrOG7VopQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwODowOToxN1rOG7VxSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg3MzYzNw==", "bodyText": "nit: CommCareIdlingResource  -> ProgressIdlingResource", "url": "https://github.com/dimagi/commcare-android/pull/2305#discussion_r464873637", "createdAt": "2020-08-04T08:05:14Z", "author": {"login": "shubham1g5"}, "path": "app/instrumentation-tests/src/org/commcare/utils/CommCareIdlingResource.kt", "diffHunk": "@@ -0,0 +1,55 @@\n+package org.commcare.utils\n+\n+import android.os.Handler\n+import android.os.Looper\n+import androidx.test.espresso.IdlingResource\n+import androidx.test.platform.app.InstrumentationRegistry\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.activities.CommCareActivity\n+\n+/**\n+ * An implementation of idling resource useful for monitoring idleness of progress dialogs.\n+ *\n+ * It has an additional idleness constraint that the progress dialog must not be shown for a set\n+ * period of time before we declare the resource idle.\n+ *\n+ * Useful for cases where we make multiple network calls in succession where each response triggers\n+ * another request until loading is complete.\n+ * So the app will be like Not-Idle(Progress bar showing) -> Idle(Progress bar closed) -> Not-Idle -> Idle...\n+ * And we don't want to report idle when this happens.\n+ */\n+class CommCareIdlingResource: IdlingResource {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccb8a4e254c235d02e958310c67873fe4935e42a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg3NTg1MA==", "bodyText": "so effectlvely what we are trying to do is we are marking the resource as Idle a sec after the progress dialog has been removed. What's the behaviour if we don't add this at all ? The app never goes to Idle or takes more time to do so ?", "url": "https://github.com/dimagi/commcare-android/pull/2305#discussion_r464875850", "createdAt": "2020-08-04T08:09:17Z", "author": {"login": "shubham1g5"}, "path": "app/instrumentation-tests/src/org/commcare/utils/CommCareIdlingResource.kt", "diffHunk": "@@ -0,0 +1,55 @@\n+package org.commcare.utils\n+\n+import android.os.Handler\n+import android.os.Looper\n+import androidx.test.espresso.IdlingResource\n+import androidx.test.platform.app.InstrumentationRegistry\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.activities.CommCareActivity\n+\n+/**\n+ * An implementation of idling resource useful for monitoring idleness of progress dialogs.\n+ *\n+ * It has an additional idleness constraint that the progress dialog must not be shown for a set\n+ * period of time before we declare the resource idle.\n+ *\n+ * Useful for cases where we make multiple network calls in succession where each response triggers\n+ * another request until loading is complete.\n+ * So the app will be like Not-Idle(Progress bar showing) -> Idle(Progress bar closed) -> Not-Idle -> Idle...\n+ * And we don't want to report idle when this happens.\n+ */\n+class CommCareIdlingResource: IdlingResource {\n+\n+    companion object {\n+        const val timeoutMs = 1000L\n+    }\n+\n+    lateinit var resourceCallback: IdlingResource.ResourceCallback\n+    var isIdle = false\n+    val handler = Handler(Looper.getMainLooper())\n+\n+    override fun getName(): String {\n+        return CommCareIdlingResource::class.java.name\n+    }\n+\n+    override fun isIdleNow(): Boolean {\n+        val activity = getCommCareActivity() ?: return true\n+        if (!(activity.currentProgressDialog != null && activity.currentProgressDialog.isAdded)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccb8a4e254c235d02e958310c67873fe4935e42a"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82de442768d0352be170f6ae902cbdb9ac70b585", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/82de442768d0352be170f6ae902cbdb9ac70b585", "committedDate": "2020-08-04T08:28:06Z", "message": "PR suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjE2NDk2", "url": "https://github.com/dimagi/commcare-android/pull/2305#pullrequestreview-460616496", "createdAt": "2020-08-04T08:45:31Z", "commit": {"oid": "82de442768d0352be170f6ae902cbdb9ac70b585"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2097, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}