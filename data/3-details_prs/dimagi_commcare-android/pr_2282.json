{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3NzI3MTEx", "number": 2282, "title": "Use FusedLocation client for capturing location", "bodyText": "Jira: https://dimagi-dev.atlassian.net/browse/SAAS-10937", "createdAt": "2020-06-22T06:57:02Z", "url": "https://github.com/dimagi/commcare-android/pull/2282", "merged": true, "mergeCommit": {"oid": "cf6ad2942c4095904ebdcf068f7c7af358591579"}, "closed": true, "closedAt": "2020-07-31T08:11:57Z", "author": {"login": "ShivamPokhriyal"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctrOs5gH2gAyNDM3NzI3MTExOmY5ZDI4YTk0MGYzMjhiOGY5ZDM2YTM5YmM4NTdkYmY2MzhmZWU3MWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6PNy4AFqTQ1ODk3NDE4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f9d28a940f328b8f9d36a39bc857dbf638fee71e", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/f9d28a940f328b8f9d36a39bc857dbf638fee71e", "committedDate": "2020-06-22T06:54:39Z", "message": "Use FusedLocation client for capturing location"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/820f167f3e358de42212fc5df23c56f9792a24bb", "committedDate": "2020-06-23T06:55:46Z", "message": "Use the new fused provider client in auto-gps-capture"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNjc3NDAz", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-441677403", "createdAt": "2020-07-02T13:27:52Z", "commit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMzoyNzo1MlrOGsM2rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMzoyNzo1MlrOGsM2rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAwMTEzMg==", "bodyText": "so earlier the gps error will only show up if the receiver was fired before the form load completes ?", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449001132", "createdAt": "2020-07-02T13:27:52Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/FormEntryActivity.java", "diffHunk": "@@ -984,9 +1000,7 @@ protected void deliverError(FormEntryActivity receiver, Exception e) {\n     }\n \n     private void handleFormLoadCompletion(AndroidFormController fc) {\n-        if (GeoUtils.ACTION_CHECK_GPS_ENABLED.equals(locationRecieverErrorAction)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxOTc1NjMx", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-441975631", "createdAt": "2020-07-02T19:45:08Z", "commit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxOTo0NTowOFrOGsa-Dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxOTo0NTowOFrOGsa-Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIzMjM5OQ==", "bodyText": "unused", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449232399", "createdAt": "2020-07-02T19:45:08Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/GeoPointActivity.java", "diffHunk": "@@ -1,42 +1,66 @@\n package org.commcare.activities;\n \n import android.Manifest;\n+import android.annotation.SuppressLint;\n import android.app.Activity;\n import android.content.Context;\n import android.content.DialogInterface;\n import android.content.Intent;\n+import android.content.IntentSender;\n import android.content.pm.PackageManager;\n import android.location.Location;\n import android.location.LocationListener;\n import android.location.LocationManager;\n import android.location.LocationProvider;\n+import android.os.Build;\n import android.os.Bundle;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.RequiresApi;\n+import androidx.core.app.ActivityCompat;\n import androidx.core.content.ContextCompat;\n \n import android.view.View.OnClickListener;\n+import android.widget.Toast;\n+\n+import com.google.android.gms.common.api.ResolvableApiException;\n \n import org.commcare.activities.components.FormEntryConstants;\n import org.commcare.dalvik.R;\n+import org.commcare.interfaces.RuntimePermissionRequester;\n import org.commcare.interfaces.TimerListener;\n+import org.commcare.location.CommCareFusedLocationController;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzI2NzM0", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-442326734", "createdAt": "2020-07-03T10:46:01Z", "commit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMDo0NjowMVrOGssW_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMDo0NjowMVrOGssW_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUxNzMxMQ==", "bodyText": "should we not communicate this to mListener so that it can take actions in case the provider disabled ?", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449517311", "createdAt": "2020-07-03T10:46:01Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/location/CommCareProviderLocationController.kt", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.commcare.location\n+\n+import android.content.Context\n+import android.location.Location\n+import android.location.LocationListener\n+import android.location.LocationManager\n+import android.os.Bundle\n+import org.commcare.utils.GeoUtils\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+class CommCareProviderLocationController(private val mContext: Context,\n+                                         private val mListener: CommCareLocationListener): CommCareLocationController {\n+\n+    private val mLocationManager = mContext.getSystemService(Context.LOCATION_SERVICE) as LocationManager\n+    private var mCurrentLocation: Location? = null\n+    private val mProviders = GeoUtils.evaluateProviders(mLocationManager)\n+    private val mLocationListener = object: LocationListener {\n+        override fun onLocationChanged(location: Location?) {\n+            location ?: return\n+            mCurrentLocation = location\n+            mListener.onLocationResult(mCurrentLocation!!)\n+        }\n+\n+        override fun onStatusChanged(provider: String?, status: Int, extras: Bundle?) {\n+            //This callback will never be invoked.\n+        }\n+\n+        override fun onProviderEnabled(provider: String?) {\n+            TODO(\"Not yet implemented\")\n+        }\n+\n+        override fun onProviderDisabled(provider: String?) {\n+            TODO(\"Not yet implemented\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzMwODQ1", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-442330845", "createdAt": "2020-07-03T10:53:36Z", "commit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMDo1MzozNlrOGssjug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMDo1MzozNlrOGssjug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyMDU3MA==", "bodyText": "Wohoo! Kotlin \\m/", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449520570", "createdAt": "2020-07-03T10:53:36Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/location/CommCareFusedLocationController.kt", "diffHunk": "@@ -0,0 +1,58 @@\n+package org.commcare.location\n+\n+import android.content.Context\n+import android.location.Location\n+import com.google.android.gms.location.*\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+class CommCareFusedLocationController(private val mContext: Context,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzMxMjc4", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-442331278", "createdAt": "2020-07-03T10:54:25Z", "commit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMDo1NDoyNVrOGssk-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMDo1NDoyNVrOGssk-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyMDg5MQ==", "bodyText": "should use a constant for ``5000`", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449520891", "createdAt": "2020-07-03T10:54:25Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/location/CommCareFusedLocationController.kt", "diffHunk": "@@ -0,0 +1,58 @@\n+package org.commcare.location\n+\n+import android.content.Context\n+import android.location.Location\n+import com.google.android.gms.location.*\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+class CommCareFusedLocationController(private val mContext: Context,\n+                                      private val mListener: CommCareLocationListener): CommCareLocationController {\n+\n+    private val mFusedLocationClient = LocationServices.getFusedLocationProviderClient(mContext)\n+    private val mLocationRequest = LocationRequest.create().apply {\n+        priority = LocationRequest.PRIORITY_HIGH_ACCURACY\n+        interval = 5000", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzQwNDEw", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-442340410", "createdAt": "2020-07-03T11:12:16Z", "commit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMToxMjoxNlrOGss_8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMToxMjoxNlrOGss_8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyNzc5Mg==", "bodyText": "you can provide a @JvmStatic annotation for getLocationController to avoid using Companion in references.", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449527792", "createdAt": "2020-07-03T11:12:16Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/GeoPointActivity.java", "diffHunk": "@@ -47,9 +71,7 @@ protected void onCreate(Bundle savedInstanceState) {\n         setTitle(StringUtils.getStringRobust(this, R.string.application_name) +\n                 \" > \" + StringUtils.getStringRobust(this, R.string.get_location));\n \n-        locationManager = (LocationManager)getSystemService(Context.LOCATION_SERVICE);\n-\n-        providers = GeoUtils.evaluateProviders(locationManager);\n+        locationController = CommCareLocationControllerFactory.Companion.getLocationController(this, this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzQyMjQx", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-442342241", "createdAt": "2020-07-03T11:15:38Z", "commit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMToxNTozOFrOGstE-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMToxNTozOFrOGstE-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUyOTA4Mg==", "bodyText": "shouldn't we still dismiss the dialog ?", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449529082", "createdAt": "2020-07-03T11:15:38Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/GeoPointActivity.java", "diffHunk": "@@ -67,36 +89,48 @@ protected void onCreate(Bundle savedInstanceState) {\n     @Override\n     protected void onPause() {\n         super.onPause();\n-\n-        // stops the GPS. Note that this will turn off the GPS if the screen goes to sleep.\n-        if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED ||\n-                ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_COARSE_LOCATION) == PackageManager.PERMISSION_GRANTED) {\n-            locationManager.removeUpdates(this);\n-        }\n-\n-        // We're not using managed dialogs, so we have to dismiss the dialog to prevent it from\n-        // leaking memory.\n-        if (locationDialog != null && locationDialog.isShowing()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzU4Nzk5", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-442358799", "createdAt": "2020-07-03T11:48:38Z", "commit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo0ODozOFrOGst3Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo0ODozOFrOGst3Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MTkzMA==", "bodyText": "where does this receiver get fired from, the Location Manager itself ?", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449541930", "createdAt": "2020-07-03T11:48:38Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/android/javarosa/PollSensorController.java", "diffHunk": "@@ -112,27 +111,43 @@ public void onLocationChanged(Location location) {\n         }\n     }\n \n-    @Override\n-    public void onProviderDisabled(String provider) {\n+    private void sendBroadcast(Context context) {\n+        Intent noGPSIntent = new Intent(GeoUtils.ACTION_CHECK_GPS_ENABLED);\n+        context.sendStickyBroadcast(noGPSIntent);\n     }\n \n     @Override\n-    public void onProviderEnabled(String provider) {\n+    public void missingPermissions() {\n+        missingPermissions = true;\n+        Context context = CommCareApplication.instance();\n+        sendBroadcast(context);\n     }\n \n     @Override\n-    public void onStatusChanged(String provider, int status, Bundle extras) {\n+    public void onLocationRequestFailure(@NotNull CommCareLocationListener.Failure failure) {\n+        Context context = CommCareApplication.instance();\n+        if (failure instanceof CommCareLocationListener.Failure.ApiException) {\n+            Exception exception = ((CommCareLocationListener.Failure.ApiException) failure).getException();\n+            if (exception instanceof ResolvableApiException) {\n+                apiException = (ResolvableApiException) exception;\n+                sendBroadcast(context);\n+            } else {\n+                // ignore and return, we can't do anything.\n+            }\n+        } else {\n+            noProviders = true;\n+            context.registerReceiver(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "originalPosition": 165}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzYwNDQx", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-442360441", "createdAt": "2020-07-03T11:51:48Z", "commit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MTo0OVrOGst8Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMTo1MTo0OVrOGst8Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MzIwNw==", "bodyText": "it seems like this broadcast is getting used to convey any kind of location errors, I would suggest 2 naming changes based on that -\nsendBroadcast -> broadcastLocationError\nACTION_CHECK_GPS_ENABLED -> ACTION_LOCATION_ERROR", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r449543207", "createdAt": "2020-07-03T11:51:49Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/android/javarosa/PollSensorController.java", "diffHunk": "@@ -112,27 +111,43 @@ public void onLocationChanged(Location location) {\n         }\n     }\n \n-    @Override\n-    public void onProviderDisabled(String provider) {\n+    private void sendBroadcast(Context context) {\n+        Intent noGPSIntent = new Intent(GeoUtils.ACTION_CHECK_GPS_ENABLED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "originalPosition": 139}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b6ea31c95a170b0c9fcacac78bd2d22357ae2a6", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/4b6ea31c95a170b0c9fcacac78bd2d22357ae2a6", "committedDate": "2020-07-06T09:11:43Z", "message": "PR suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNjA2ODEx", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-443606811", "createdAt": "2020-07-07T06:51:25Z", "commit": {"oid": "4b6ea31c95a170b0c9fcacac78bd2d22357ae2a6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNjo1MToyNVrOGtxRkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNjo1NjowMFrOGtxZGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY0NjQxOQ==", "bodyText": "nit: should be defined at the top of the class", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r450646419", "createdAt": "2020-07-07T06:51:25Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/location/CommCareFusedLocationController.kt", "diffHunk": "@@ -24,6 +24,10 @@ class CommCareFusedLocationController(private val mContext: Context,\n         }\n     }\n \n+    companion object {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b6ea31c95a170b0c9fcacac78bd2d22357ae2a6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY0ODM0Ng==", "bodyText": "yeah we should check for this since the purpose of this work is to make this feature more robust.", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r450648346", "createdAt": "2020-07-07T06:56:00Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/location/CommCareProviderLocationController.kt", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.commcare.location\n+\n+import android.content.Context\n+import android.location.Location\n+import android.location.LocationListener\n+import android.location.LocationManager\n+import android.os.Bundle\n+import org.commcare.utils.GeoUtils\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+class CommCareProviderLocationController(private val mContext: Context,\n+                                         private val mListener: CommCareLocationListener): CommCareLocationController {\n+\n+    private val mLocationManager = mContext.getSystemService(Context.LOCATION_SERVICE) as LocationManager\n+    private var mCurrentLocation: Location? = null\n+    private val mProviders = GeoUtils.evaluateProviders(mLocationManager)\n+    private val mLocationListener = object: LocationListener {\n+        override fun onLocationChanged(location: Location?) {\n+            location ?: return\n+            mCurrentLocation = location\n+            mListener.onLocationResult(mCurrentLocation!!)\n+        }\n+\n+        override fun onStatusChanged(provider: String?, status: Int, extras: Bundle?) {\n+            //This callback will never be invoked.\n+        }\n+\n+        override fun onProviderEnabled(provider: String?) {\n+            TODO(\"Not yet implemented\")\n+        }\n+\n+        override fun onProviderDisabled(provider: String?) {\n+            TODO(\"Not yet implemented\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUxNzMxMQ=="}, "originalCommit": {"oid": "820f167f3e358de42212fc5df23c56f9792a24bb"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6edffd572bc9f490e6e459a94d86c5af58b12d4b", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/6edffd572bc9f490e6e459a94d86c5af58b12d4b", "committedDate": "2020-07-17T07:19:01Z", "message": "Merge branch 'master' into location-provider-update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c50a9a5a66d8dc70888c29aeeefd57ee90b693a", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/0c50a9a5a66d8dc70888c29aeeefd57ee90b693a", "committedDate": "2020-07-19T13:19:01Z", "message": "Use broadcast receiver to check location providers change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NTM4MjYw", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-455538260", "createdAt": "2020-07-27T07:32:50Z", "commit": {"oid": "0c50a9a5a66d8dc70888c29aeeefd57ee90b693a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNzozMjo1MFrOG3WzGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNzo0MjowNVrOG3XFcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY5ODM5Mw==", "bodyText": "nit: would be good to delegate it to requestLocationUpdates", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r460698393", "createdAt": "2020-07-27T07:32:50Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/android/javarosa/PollSensorController.java", "diffHunk": "@@ -47,22 +62,8 @@ void startLocationPolling(PollSensorAction action) {\n         new Handler(Looper.getMainLooper()).post(() -> {\n             // Start requesting GPS updates\n             Context context = CommCareApplication.instance();\n-            mLocationManager = (LocationManager)context.getSystemService(Context.LOCATION_SERVICE);\n-\n-            Set<String> providers = GeoUtils.evaluateProviders(mLocationManager);\n-            if (providers.isEmpty()) {\n-                context.registerReceiver(\n-                        new ProvidersChangedHandler(),\n-                        new IntentFilter(LocationManager.PROVIDERS_CHANGED_ACTION)\n-                );\n-\n-                // This thread can't take action on the UI, so instead send\n-                // a message that actual activities notice and then display\n-                // a dialog asking user to enable location access\n-                Intent noGPSIntent = new Intent(GeoUtils.ACTION_CHECK_GPS_ENABLED);\n-                context.sendStickyBroadcast(noGPSIntent);\n-            }\n-            requestLocationUpdates(providers);\n+            mLocationController = CommCareLocationControllerFactory.getLocationController(context, this);\n+            mLocationController.start();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c50a9a5a66d8dc70888c29aeeefd57ee90b693a"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcwMzA5MA==", "bodyText": "shoudn't this get reset to false in stop() ?", "url": "https://github.com/dimagi/commcare-android/pull/2282#discussion_r460703090", "createdAt": "2020-07-27T07:42:05Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/location/CommCareProviderLocationController.kt", "diffHunk": "@@ -0,0 +1,95 @@\n+package org.commcare.location\n+\n+import android.content.BroadcastReceiver\n+import android.content.Context\n+import android.content.Intent\n+import android.content.IntentFilter\n+import android.location.Location\n+import android.location.LocationListener\n+import android.location.LocationManager\n+import android.os.Bundle\n+import org.commcare.utils.GeoUtils\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+class CommCareProviderLocationController(private val mContext: Context,\n+                                         private val mListener: CommCareLocationListener): CommCareLocationController {\n+\n+    private val mLocationManager = mContext.getSystemService(Context.LOCATION_SERVICE) as LocationManager\n+    private var mCurrentLocation: Location? = null\n+    private var mProviders = GeoUtils.evaluateProviders(mLocationManager)\n+    private val mReceiver = ProviderChangedReceiver()\n+    private var mLocationRequestStarted = false\n+    private val mLocationListener = object: LocationListener {\n+        override fun onLocationChanged(location: Location?) {\n+            location ?: return\n+            mCurrentLocation = location\n+            mListener.onLocationResult(mCurrentLocation!!)\n+        }\n+\n+        override fun onStatusChanged(provider: String?, status: Int, extras: Bundle?) {\n+            //This callback will never be invoked.\n+        }\n+\n+        override fun onProviderEnabled(provider: String?) {\n+\n+        }\n+\n+        override fun onProviderDisabled(provider: String?) {\n+\n+        }\n+\n+    }\n+\n+    override fun start() {\n+        if (!isLocationPermissionGranted(mContext)) {\n+            mListener.missingPermissions()\n+            return\n+        }\n+        mContext.registerReceiver(mReceiver, IntentFilter(LocationManager.PROVIDERS_CHANGED_ACTION))\n+        checkProviderAndRequestLocation()\n+    }\n+\n+    override fun stop() {\n+        mLocationManager.removeUpdates(mLocationListener)\n+        try {\n+            mContext.unregisterReceiver(mReceiver)\n+        } catch (e: IllegalArgumentException) {\n+            // This can happen if stop is called multiple times.\n+            e.printStackTrace()\n+        }\n+    }\n+\n+    override fun getLocation(): Location? {\n+        return mCurrentLocation\n+    }\n+\n+    private fun checkProviderAndRequestLocation() {\n+        mProviders = GeoUtils.evaluateProviders(mLocationManager)\n+        if (mProviders.isEmpty()) {\n+            mListener.onLocationRequestFailure(CommCareLocationListener.Failure.NoProvider)\n+            return\n+        }\n+        startLocationRequest()\n+    }\n+\n+    private fun startLocationRequest() {\n+        if (mLocationRequestStarted) {\n+            // We've already started location request so no need to request again!\n+            return\n+        }\n+        mLocationRequestStarted = true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c50a9a5a66d8dc70888c29aeeefd57ee90b693a"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16e21db34d53e5e101593064477ca4d82e798d3d", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/16e21db34d53e5e101593064477ca4d82e798d3d", "committedDate": "2020-07-28T11:10:30Z", "message": "PR suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "433b6aa4c099fded19052ed06866594e0972b051", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/433b6aa4c099fded19052ed06866594e0972b051", "committedDate": "2020-07-28T11:23:05Z", "message": "Merge branch 'master' into location-provider-update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NTUxMzE3", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-456551317", "createdAt": "2020-07-28T11:45:06Z", "commit": {"oid": "433b6aa4c099fded19052ed06866594e0972b051"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e7672d0934ce4aa9833860043d1d1aa7967b2df", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/9e7672d0934ce4aa9833860043d1d1aa7967b2df", "committedDate": "2020-07-28T12:38:34Z", "message": "Fix tests failures\n\nstopLocationPolling always gets called by formentryactivity onpause even if we never started polling location which was causing NPEs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0783453180f6d198960ca1e9ebf228b064b2eaf5", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/0783453180f6d198960ca1e9ebf228b064b2eaf5", "committedDate": "2020-07-28T12:29:45Z", "message": "Fix tests failures\n\nstopLocationPolling always gets called by formentryactivity onpause even if we never started polling location which was causing NPEs"}, "afterCommit": {"oid": "9e7672d0934ce4aa9833860043d1d1aa7967b2df", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/9e7672d0934ce4aa9833860043d1d1aa7967b2df", "committedDate": "2020-07-28T12:38:34Z", "message": "Fix tests failures\n\nstopLocationPolling always gets called by formentryactivity onpause even if we never started polling location which was causing NPEs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4982345fddad11aa4bfb3216f1abf3443763580f", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/4982345fddad11aa4bfb3216f1abf3443763580f", "committedDate": "2020-07-30T10:57:36Z", "message": "Merge branch 'master' into location-provider-update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTc0MTg1", "url": "https://github.com/dimagi/commcare-android/pull/2282#pullrequestreview-458974185", "createdAt": "2020-07-31T07:37:20Z", "commit": {"oid": "4982345fddad11aa4bfb3216f1abf3443763580f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2080, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}