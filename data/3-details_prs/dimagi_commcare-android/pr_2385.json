{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2Nzg0MzI5", "number": 2385, "title": "[2.48.11] Delete raw images from Saved Forms ", "bodyText": "Deletes raw folder for saved forms to conserve space for LTS users\nReport free disk available as a user property to Analytics events", "createdAt": "2020-10-20T13:08:15Z", "url": "https://github.com/dimagi/commcare-android/pull/2385", "merged": true, "mergeCommit": {"oid": "d3112364bdaec27192c4f09be65bd18021d961ae"}, "closed": true, "closedAt": "2020-10-21T05:51:29Z", "author": {"login": "shubham1g5"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUB_8QAH2gAyNTA2Nzg0MzI5OjBhYjViMTdmYmQxNWIwYzRmNDM4MzU2Mjg2NmFiZmU4NzBlYWE3MTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUdoqfgFqTUxMzA0NzY3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ab5b17fbd15b0c4f4383562866abfe870eaa717", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/0ab5b17fbd15b0c4f4383562866abfe870eaa717", "committedDate": "2020-10-19T10:55:28Z", "message": "Adds task to delete raw media"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c501905c66a24c3ffad1df51d0eda7467f45a2e", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/7c501905c66a24c3ffad1df51d0eda7467f45a2e", "committedDate": "2020-10-19T17:57:34Z", "message": "Adds free disk space as an user property"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNzg4NDI1", "url": "https://github.com/dimagi/commcare-android/pull/2385#pullrequestreview-512788425", "createdAt": "2020-10-20T14:34:51Z", "commit": {"oid": "7c501905c66a24c3ffad1df51d0eda7467f45a2e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDozNDo1MVrOHlAOCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDozNzowMlrOHlAVFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU2Mjk1NA==", "bodyText": "I think we should only be doing this for Forms in a specific state, right? It doesn't seem correct to me for this to delete the raw storage for, say, a form that's currently in progress. I wonder if it's safest to, say, only do this for forms that were saved more than a few days ago, too, but that's probably overly conservative", "url": "https://github.com/dimagi/commcare-android/pull/2385#discussion_r508562954", "createdAt": "2020-10-20T14:34:51Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/tasks/CleanRawMedia.kt", "diffHunk": "@@ -0,0 +1,30 @@\n+package org.commcare.tasks\n+\n+import android.content.Context\n+import androidx.work.Worker\n+import androidx.work.WorkerParameters\n+import org.commcare.CommCareApplication\n+import org.commcare.android.database.user.models.FormRecord\n+import org.commcare.utils.CrashUtil\n+import java.io.File\n+import java.lang.Exception\n+\n+class CleanRawMedia(appContext: Context, workerParams: WorkerParameters)\n+    : Worker(appContext, workerParams) {\n+\n+    override fun doWork(): Result {\n+        try {\n+            val storage = CommCareApplication.instance().getUserStorage(FormRecord::class.java)\n+            for (formRecord in storage) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c501905c66a24c3ffad1df51d0eda7467f45a2e"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU2NDc1Ng==", "bodyText": "Do we want to fail the loop for one failed record? Given what this task is doing I'd guess we should report each exception (And return failure for the task), but proceed with the next record. Otherwise one bad record will prevent cleaning up the remaining ones", "url": "https://github.com/dimagi/commcare-android/pull/2385#discussion_r508564756", "createdAt": "2020-10-20T14:37:02Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/tasks/CleanRawMedia.kt", "diffHunk": "@@ -0,0 +1,30 @@\n+package org.commcare.tasks\n+\n+import android.content.Context\n+import androidx.work.Worker\n+import androidx.work.WorkerParameters\n+import org.commcare.CommCareApplication\n+import org.commcare.android.database.user.models.FormRecord\n+import org.commcare.utils.CrashUtil\n+import java.io.File\n+import java.lang.Exception\n+\n+class CleanRawMedia(appContext: Context, workerParams: WorkerParameters)\n+    : Worker(appContext, workerParams) {\n+\n+    override fun doWork(): Result {\n+        try {\n+            val storage = CommCareApplication.instance().getUserStorage(FormRecord::class.java)\n+            for (formRecord in storage) {\n+                File(formRecord.filePath).parent?.let {\n+                    val rawDirPath = \"$it/raw\"\n+                    File(rawDirPath).deleteRecursively()\n+                }\n+            }\n+        } catch (e: Exception) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c501905c66a24c3ffad1df51d0eda7467f45a2e"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7982372753aaeead13a4e0d10de1658c32d20fdb", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/7982372753aaeead13a4e0d10de1658c32d20fdb", "committedDate": "2020-10-20T17:07:59Z", "message": "only deletes raw images for saved, unsent and completed forms"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDQ3Njc5", "url": "https://github.com/dimagi/commcare-android/pull/2385#pullrequestreview-513047679", "createdAt": "2020-10-20T19:05:18Z", "commit": {"oid": "7982372753aaeead13a4e0d10de1658c32d20fdb"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxOTowNToxOFrOHlM9yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxOTowNzoxM1rOHlNCKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc3MTc4Ng==", "bodyText": "NIT: Missing endline", "url": "https://github.com/dimagi/commcare-android/pull/2385#discussion_r508771786", "createdAt": "2020-10-20T19:05:18Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/tasks/CleanRawMedia.kt", "diffHunk": "@@ -0,0 +1,31 @@\n+package org.commcare.tasks\n+\n+import android.content.Context\n+import androidx.work.Worker\n+import androidx.work.WorkerParameters\n+import org.commcare.CommCareApplication\n+import org.commcare.android.database.user.models.FormRecord\n+import org.commcare.utils.CrashUtil\n+import org.commcare.utils.StorageUtils.getUnsentCompleteOrSavedFormIdsForCurrentApp\n+import java.io.File\n+\n+class CleanRawMedia(appContext: Context, workerParams: WorkerParameters)\n+    : Worker(appContext, workerParams) {\n+\n+    override fun doWork(): Result {\n+        val storage = CommCareApplication.instance().getUserStorage(FormRecord::class.java)\n+        val recordsToRemove = getUnsentCompleteOrSavedFormIdsForCurrentApp(storage)\n+        for (formId in recordsToRemove) {\n+            try {\n+                val filePath = storage.getMetaDataFieldForRecord(formId, FormRecord.META_FILE_PATH)\n+                File(filePath).parent?.let {\n+                    val rawDirPath = \"$it/raw\"\n+                    File(rawDirPath).deleteRecursively()\n+                }\n+            } catch (e: Exception) {\n+                CrashUtil.reportException(e)\n+            }\n+        }\n+        return Result.success()\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7982372753aaeead13a4e0d10de1658c32d20fdb"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc3MjI0OA==", "bodyText": "I think we should fail at the bottom of the loop still if one iteration didn't process right? That will let it retry later, although if we are launching at-most-one of these per startup maybe it's not worth worrying about the distinciton.", "url": "https://github.com/dimagi/commcare-android/pull/2385#discussion_r508772248", "createdAt": "2020-10-20T19:06:04Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/tasks/CleanRawMedia.kt", "diffHunk": "@@ -0,0 +1,31 @@\n+package org.commcare.tasks\n+\n+import android.content.Context\n+import androidx.work.Worker\n+import androidx.work.WorkerParameters\n+import org.commcare.CommCareApplication\n+import org.commcare.android.database.user.models.FormRecord\n+import org.commcare.utils.CrashUtil\n+import org.commcare.utils.StorageUtils.getUnsentCompleteOrSavedFormIdsForCurrentApp\n+import java.io.File\n+\n+class CleanRawMedia(appContext: Context, workerParams: WorkerParameters)\n+    : Worker(appContext, workerParams) {\n+\n+    override fun doWork(): Result {\n+        val storage = CommCareApplication.instance().getUserStorage(FormRecord::class.java)\n+        val recordsToRemove = getUnsentCompleteOrSavedFormIdsForCurrentApp(storage)\n+        for (formId in recordsToRemove) {\n+            try {\n+                val filePath = storage.getMetaDataFieldForRecord(formId, FormRecord.META_FILE_PATH)\n+                File(filePath).parent?.let {\n+                    val rawDirPath = \"$it/raw\"\n+                    File(rawDirPath).deleteRecursively()\n+                }\n+            } catch (e: Exception) {\n+                CrashUtil.reportException(e)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7982372753aaeead13a4e0d10de1658c32d20fdb"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc3MjkwNg==", "bodyText": "Probably best for us to encode this in a static with the other part of the code, to make sure if a change is made that someone knows it affects this cleanup as well.", "url": "https://github.com/dimagi/commcare-android/pull/2385#discussion_r508772906", "createdAt": "2020-10-20T19:07:13Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/tasks/CleanRawMedia.kt", "diffHunk": "@@ -0,0 +1,31 @@\n+package org.commcare.tasks\n+\n+import android.content.Context\n+import androidx.work.Worker\n+import androidx.work.WorkerParameters\n+import org.commcare.CommCareApplication\n+import org.commcare.android.database.user.models.FormRecord\n+import org.commcare.utils.CrashUtil\n+import org.commcare.utils.StorageUtils.getUnsentCompleteOrSavedFormIdsForCurrentApp\n+import java.io.File\n+\n+class CleanRawMedia(appContext: Context, workerParams: WorkerParameters)\n+    : Worker(appContext, workerParams) {\n+\n+    override fun doWork(): Result {\n+        val storage = CommCareApplication.instance().getUserStorage(FormRecord::class.java)\n+        val recordsToRemove = getUnsentCompleteOrSavedFormIdsForCurrentApp(storage)\n+        for (formId in recordsToRemove) {\n+            try {\n+                val filePath = storage.getMetaDataFieldForRecord(formId, FormRecord.META_FILE_PATH)\n+                File(filePath).parent?.let {\n+                    val rawDirPath = \"$it/raw\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7982372753aaeead13a4e0d10de1658c32d20fdb"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1976, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}