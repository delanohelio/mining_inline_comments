{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMDQxNTU5", "number": 2412, "title": "Launch Session endpoints from Intent", "bodyText": "Spec\ncross-request: dimagi/commcare-core#954", "createdAt": "2020-12-02T14:07:56Z", "url": "https://github.com/dimagi/commcare-android/pull/2412", "merged": true, "mergeCommit": {"oid": "422f287e0e665586b6bbadb8187e86083b436bfb"}, "closed": true, "closedAt": "2020-12-21T13:18:47Z", "author": {"login": "shubham1g5"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXWfG7gH2gAyNTMxMDQxNTU5OjllODE2YjcxNzM4ODljMTc4YWUzZWZkZGNmNDIyMDVmNDhkY2RjMjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnfdF_gFqTU1NTgzODY5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9e816b7173889c178ae3efddcf42205f48dcdc24", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/9e816b7173889c178ae3efddcf42205f48dcdc24", "committedDate": "2020-10-29T18:29:23Z", "message": "WIP: Session endpoints handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05c8f9483d71d794075602a690212f0528429e22", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/05c8f9483d71d794075602a690212f0528429e22", "committedDate": "2020-11-30T09:26:03Z", "message": "Handle session endpoint launch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53bf31b5a31cb63807a3c1074fdf7b9b0aa13608", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/53bf31b5a31cb63807a3c1074fdf7b9b0aa13608", "committedDate": "2020-12-02T13:03:56Z", "message": "Perform substitue on a copy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99e10e29fac3383cec5cf6a736deef55175845a5", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/99e10e29fac3383cec5cf6a736deef55175845a5", "committedDate": "2020-12-02T13:04:05Z", "message": "Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ed866ec909bbb84d16d31d92519ae1354f37fcf", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/8ed866ec909bbb84d16d31d92519ae1354f37fcf", "committedDate": "2020-12-02T13:50:59Z", "message": "error handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNzAwMDg4", "url": "https://github.com/dimagi/commcare-android/pull/2412#pullrequestreview-543700088", "createdAt": "2020-12-03T08:18:04Z", "commit": {"oid": "8ed866ec909bbb84d16d31d92519ae1354f37fcf"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7287d568b83b39ef45ef0e2132bd0185d1786a66", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/7287d568b83b39ef45ef0e2132bd0185d1786a66", "committedDate": "2020-12-03T11:01:31Z", "message": "Prototype test fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MzgwNjQ4", "url": "https://github.com/dimagi/commcare-android/pull/2412#pullrequestreview-548380648", "createdAt": "2020-12-09T16:42:49Z", "commit": {"oid": "7287d568b83b39ef45ef0e2132bd0185d1786a66"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjo0Mjo0OVrOICeb8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjo0NTozNlrOICelHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ2NjczOA==", "bodyText": "Wouldn't these arguments need to be a Map (name to value) rather than a list?", "url": "https://github.com/dimagi/commcare-android/pull/2412#discussion_r539466738", "createdAt": "2020-12-09T16:42:49Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/activities/DispatchActivity.java", "diffHunk": "@@ -321,14 +330,24 @@ private void handleUnvalidatedApp() {\n     private void handleExternalLaunch() {\n         //First off, make sure the incoming session is clear\n         CommCareApplication.instance().getSession().proceedWithSavedSessionIfNeeded(() -> {\n-                    String sessionRequest = this.getIntent().getStringExtra(SESSION_REQUEST);\n-                    SessionStateDescriptor ssd = new SessionStateDescriptor();\n-                    ssd.fromBundle(sessionRequest);\n-                    CommCareApplication.instance().getCurrentSessionWrapper().loadFromStateDescription(ssd);\n-                    Intent i = new Intent(this, StandardHomeActivity.class);\n-                    i.putExtra(WAS_EXTERNAL, true);\n-                    startActivityForResult(i, HOME_SCREEN);\n-        }\n+                    if (getIntent().hasExtra(SESSION_REQUEST)) {\n+                        String sessionRequest = this.getIntent().getStringExtra(SESSION_REQUEST);\n+                        SessionStateDescriptor ssd = new SessionStateDescriptor();\n+                        ssd.fromBundle(sessionRequest);\n+                        CommCareApplication.instance().getCurrentSessionWrapper().loadFromStateDescription(ssd);\n+                        Intent i = new Intent(this, StandardHomeActivity.class);\n+                        i.putExtra(WAS_EXTERNAL, true);\n+                        startActivityForResult(i, HOME_SCREEN);\n+                    } else if (getIntent().hasExtra(SESSION_ENDPOINT_ID)) {\n+                        String sessionEndpointId = this.getIntent().getStringExtra(SESSION_ENDPOINT_ID);\n+                        ArrayList<String> args = this.getIntent().getStringArrayListExtra(SESSION_ENDPOINT_ARGUMENTS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7287d568b83b39ef45ef0e2132bd0185d1786a66"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ2NzE5Ng==", "bodyText": "^ If this were true, we might also want to consider having the args provided as a bundle map.", "url": "https://github.com/dimagi/commcare-android/pull/2412#discussion_r539467196", "createdAt": "2020-12-09T16:43:22Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/activities/DispatchActivity.java", "diffHunk": "@@ -321,14 +330,24 @@ private void handleUnvalidatedApp() {\n     private void handleExternalLaunch() {\n         //First off, make sure the incoming session is clear\n         CommCareApplication.instance().getSession().proceedWithSavedSessionIfNeeded(() -> {\n-                    String sessionRequest = this.getIntent().getStringExtra(SESSION_REQUEST);\n-                    SessionStateDescriptor ssd = new SessionStateDescriptor();\n-                    ssd.fromBundle(sessionRequest);\n-                    CommCareApplication.instance().getCurrentSessionWrapper().loadFromStateDescription(ssd);\n-                    Intent i = new Intent(this, StandardHomeActivity.class);\n-                    i.putExtra(WAS_EXTERNAL, true);\n-                    startActivityForResult(i, HOME_SCREEN);\n-        }\n+                    if (getIntent().hasExtra(SESSION_REQUEST)) {\n+                        String sessionRequest = this.getIntent().getStringExtra(SESSION_REQUEST);\n+                        SessionStateDescriptor ssd = new SessionStateDescriptor();\n+                        ssd.fromBundle(sessionRequest);\n+                        CommCareApplication.instance().getCurrentSessionWrapper().loadFromStateDescription(ssd);\n+                        Intent i = new Intent(this, StandardHomeActivity.class);\n+                        i.putExtra(WAS_EXTERNAL, true);\n+                        startActivityForResult(i, HOME_SCREEN);\n+                    } else if (getIntent().hasExtra(SESSION_ENDPOINT_ID)) {\n+                        String sessionEndpointId = this.getIntent().getStringExtra(SESSION_ENDPOINT_ID);\n+                        ArrayList<String> args = this.getIntent().getStringArrayListExtra(SESSION_ENDPOINT_ARGUMENTS);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ2NjczOA=="}, "originalCommit": {"oid": "7287d568b83b39ef45ef0e2132bd0185d1786a66"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ2ODg2Nw==", "bodyText": "I mentioned this in the commcare-core PR, but I think we should be setting the arguments by setting them as XPath variables on the evaluation context, since that will naturally and robustly substitute them in as needed as the stack ops are calculated.", "url": "https://github.com/dimagi/commcare-android/pull/2412#discussion_r539468867", "createdAt": "2020-12-09T16:45:20Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -194,10 +199,59 @@ private void loadInstanceState(Bundle savedInstanceState) {\n     private void processFromExternalLaunch(Bundle savedInstanceState) {\n         if (savedInstanceState == null && getIntent().hasExtra(DispatchActivity.WAS_EXTERNAL)) {\n             wasExternal = true;\n+            processSessionEndpoint();\n             sessionNavigator.startNextSessionStep();\n         }\n     }\n \n+    private void processSessionEndpoint() {\n+        if (getIntent().hasExtra(SESSION_ENDPOINT_ID)) {\n+            Endpoint endpoint = validateIntentForSessionEndpoint(getIntent());\n+            if (endpoint != null) {\n+                Vector<String> endpointArguments = endpoint.getArguments();\n+                ArrayList<String> intentArguments = getIntent().getStringArrayListExtra(SESSION_ENDPOINT_ARGUMENTS);\n+                HashMap<String, String> compositeArguments = new HashMap<>(endpointArguments.size());\n+                for (int i = 0; i < endpointArguments.size(); i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7287d568b83b39ef45ef0e2132bd0185d1786a66"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ2OTA4NQ==", "bodyText": "Should we be ensuring the stack is clean here before firing everything?", "url": "https://github.com/dimagi/commcare-android/pull/2412#discussion_r539469085", "createdAt": "2020-12-09T16:45:36Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -194,10 +199,59 @@ private void loadInstanceState(Bundle savedInstanceState) {\n     private void processFromExternalLaunch(Bundle savedInstanceState) {\n         if (savedInstanceState == null && getIntent().hasExtra(DispatchActivity.WAS_EXTERNAL)) {\n             wasExternal = true;\n+            processSessionEndpoint();\n             sessionNavigator.startNextSessionStep();\n         }\n     }\n \n+    private void processSessionEndpoint() {\n+        if (getIntent().hasExtra(SESSION_ENDPOINT_ID)) {\n+            Endpoint endpoint = validateIntentForSessionEndpoint(getIntent());\n+            if (endpoint != null) {\n+                Vector<String> endpointArguments = endpoint.getArguments();\n+                ArrayList<String> intentArguments = getIntent().getStringArrayListExtra(SESSION_ENDPOINT_ARGUMENTS);\n+                HashMap<String, String> compositeArguments = new HashMap<>(endpointArguments.size());\n+                for (int i = 0; i < endpointArguments.size(); i++) {\n+                    compositeArguments.put(endpointArguments.elementAt(i),\n+                            intentArguments.get(i));\n+                }\n+\n+                CommCareApplication.instance().getCurrentSessionWrapper()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7287d568b83b39ef45ef0e2132bd0185d1786a66"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64505f8a3287c8869304d038b58a0662ac9ffe57", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/64505f8a3287c8869304d038b58a0662ac9ffe57", "committedDate": "2020-12-14T07:02:29Z", "message": "reset session before launching endpoint, eval args by setting vars to evalcontext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c57523f7c3b9f901c61eb3dbc21d88479dfda098", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/c57523f7c3b9f901c61eb3dbc21d88479dfda098", "committedDate": "2020-12-14T08:27:28Z", "message": "load arguments from bundle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a991bc316e140d61dde641a446954267a0345266", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/a991bc316e140d61dde641a446954267a0345266", "committedDate": "2020-12-14T08:31:52Z", "message": "Merge branch 'master' into sessionEndpoints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMTM5MzYy", "url": "https://github.com/dimagi/commcare-android/pull/2412#pullrequestreview-551139362", "createdAt": "2020-12-14T08:32:48Z", "commit": {"oid": "a991bc316e140d61dde641a446954267a0345266"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwODozMjo0OFrOIFFGog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwODozMjo0OFrOIFFGog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE5NzQxMA==", "bodyText": "Should we be creating a copy of evaluationContext here ?", "url": "https://github.com/dimagi/commcare-android/pull/2412#discussion_r542197410", "createdAt": "2020-12-14T08:32:48Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -189,15 +194,75 @@ private void loadInstanceState(Bundle savedInstanceState) {\n     }\n \n     /**\n-     * Set state that signifies activity was launch from external app.\n+     * Set state that signifies activity was launch from external app\n      */\n     private void processFromExternalLaunch(Bundle savedInstanceState) {\n         if (savedInstanceState == null && getIntent().hasExtra(DispatchActivity.WAS_EXTERNAL)) {\n             wasExternal = true;\n+            processSessionEndpoint();\n             sessionNavigator.startNextSessionStep();\n         }\n     }\n \n+    private void processSessionEndpoint() {\n+        if (getIntent().hasExtra(SESSION_ENDPOINT_ID)) {\n+            Endpoint endpoint = validateIntentForSessionEndpoint(getIntent());\n+            if (endpoint != null) {\n+                Vector<String> endpointArguments = endpoint.getArguments();\n+                Bundle intentArguments = getIntent().getBundleExtra(SESSION_ENDPOINT_ARGUMENTS);\n+                EvaluationContext evaluationContext = CommCareApplication.instance().getCurrentSessionWrapper().getEvaluationContext();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a991bc316e140d61dde641a446954267a0345266"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d7c499f7a34a9266d46f0601e7027cab86eb0d0", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/9d7c499f7a34a9266d46f0601e7027cab86eb0d0", "committedDate": "2020-12-14T08:42:18Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5567d2a1151a224a61cd7d2909a27393e951a9ab", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/5567d2a1151a224a61cd7d2909a27393e951a9ab", "committedDate": "2020-12-15T12:17:52Z", "message": "Support both bundle and a list as arguments to session endpoint launch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzODc5MzMw", "url": "https://github.com/dimagi/commcare-android/pull/2412#pullrequestreview-553879330", "createdAt": "2020-12-16T16:44:23Z", "commit": {"oid": "5567d2a1151a224a61cd7d2909a27393e951a9ab"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNjo0NDoyNFrOIHOxsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNjo1Mjo1MVrOIHPMGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1MzA0Mw==", "bodyText": "Nit: It feels a bit error prone to me for the processing to not fork to being either Dictionary based or List Order based upfront and then in their own block, rather than inline under the same process, but just a style thing.", "url": "https://github.com/dimagi/commcare-android/pull/2412#discussion_r544453043", "createdAt": "2020-12-16T16:44:24Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -189,15 +194,86 @@ private void loadInstanceState(Bundle savedInstanceState) {\n     }\n \n     /**\n-     * Set state that signifies activity was launch from external app.\n+     * Set state that signifies activity was launch from external app\n      */\n     private void processFromExternalLaunch(Bundle savedInstanceState) {\n         if (savedInstanceState == null && getIntent().hasExtra(DispatchActivity.WAS_EXTERNAL)) {\n             wasExternal = true;\n+            processSessionEndpoint();\n             sessionNavigator.startNextSessionStep();\n         }\n     }\n \n+    private void processSessionEndpoint() {\n+        if (getIntent().hasExtra(SESSION_ENDPOINT_ID)) {\n+            Endpoint endpoint = validateIntentForSessionEndpoint(getIntent());\n+            if (endpoint != null) {\n+                Vector<String> endpointArguments = endpoint.getArguments();\n+                EvaluationContext evaluationContext = CommCareApplication.instance().getCurrentSessionWrapper().getEvaluationContext();\n+\n+                Bundle intentArgumentsAsBundle = getIntent().getBundleExtra(SESSION_ENDPOINT_ARGUMENTS_BUNDLE);\n+                ArrayList<String> intentArgumentsAsList = getIntent().getStringArrayListExtra(SESSION_ENDPOINT_ARGUMENTS_LIST);\n+\n+                for (int i = 0; i < endpointArguments.size(); i++) {\n+                    String argumentName = endpointArguments.elementAt(i);\n+                    if (intentArgumentsAsBundle != null && !intentArgumentsAsBundle.containsKey(argumentName)) {\n+                        String noArgumentWithNameError = org.commcare.utils.StringUtils.getStringRobust(\n+                                this,\n+                                R.string.session_endpoint_no_argument_with_name,\n+                                new String[]{argumentName, endpoint.getId()});\n+                        UserfacingErrorHandling.createErrorDialog(this, noArgumentWithNameError, true);\n+                        return;\n+                    }\n+\n+                    // Bundle Arguments take precdence over list arguments", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5567d2a1151a224a61cd7d2909a27393e951a9ab"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1NjExNA==", "bodyText": "Just realized: We should be doing the session stack reset here, rather than below, since the EC here depends on the current session state, and this could introduce unpredictable behavior for the stack ops depending on the session state when the callout was received.", "url": "https://github.com/dimagi/commcare-android/pull/2412#discussion_r544456114", "createdAt": "2020-12-16T16:48:08Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -189,15 +194,86 @@ private void loadInstanceState(Bundle savedInstanceState) {\n     }\n \n     /**\n-     * Set state that signifies activity was launch from external app.\n+     * Set state that signifies activity was launch from external app\n      */\n     private void processFromExternalLaunch(Bundle savedInstanceState) {\n         if (savedInstanceState == null && getIntent().hasExtra(DispatchActivity.WAS_EXTERNAL)) {\n             wasExternal = true;\n+            processSessionEndpoint();\n             sessionNavigator.startNextSessionStep();\n         }\n     }\n \n+    private void processSessionEndpoint() {\n+        if (getIntent().hasExtra(SESSION_ENDPOINT_ID)) {\n+            Endpoint endpoint = validateIntentForSessionEndpoint(getIntent());\n+            if (endpoint != null) {\n+                Vector<String> endpointArguments = endpoint.getArguments();\n+                EvaluationContext evaluationContext = CommCareApplication.instance().getCurrentSessionWrapper().getEvaluationContext();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5567d2a1151a224a61cd7d2909a27393e951a9ab"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1NzM4Mw==", "bodyText": "Another consideration on that point: We may need the Endpoint definition to be able to provide its own <instance> connectors, since it won't necessarily be connected to any of the other components where connectors are defined. This can be \"future\" addition, since most of the inbound expressions now will just be Strings or whatnot, but I'd expect us to run into it at some point.", "url": "https://github.com/dimagi/commcare-android/pull/2412#discussion_r544457383", "createdAt": "2020-12-16T16:49:47Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -189,15 +194,86 @@ private void loadInstanceState(Bundle savedInstanceState) {\n     }\n \n     /**\n-     * Set state that signifies activity was launch from external app.\n+     * Set state that signifies activity was launch from external app\n      */\n     private void processFromExternalLaunch(Bundle savedInstanceState) {\n         if (savedInstanceState == null && getIntent().hasExtra(DispatchActivity.WAS_EXTERNAL)) {\n             wasExternal = true;\n+            processSessionEndpoint();\n             sessionNavigator.startNextSessionStep();\n         }\n     }\n \n+    private void processSessionEndpoint() {\n+        if (getIntent().hasExtra(SESSION_ENDPOINT_ID)) {\n+            Endpoint endpoint = validateIntentForSessionEndpoint(getIntent());\n+            if (endpoint != null) {\n+                Vector<String> endpointArguments = endpoint.getArguments();\n+                EvaluationContext evaluationContext = CommCareApplication.instance().getCurrentSessionWrapper().getEvaluationContext();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1NjExNA=="}, "originalCommit": {"oid": "5567d2a1151a224a61cd7d2909a27393e951a9ab"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1OTIxOA==", "bodyText": "Idea: The notion of supporting either a list or a dictionary to populate the list feels like it is in a funny place where it's part of the core app contract but implemented in Android.\nI wonder whether it would be helpful to put more of this code into commcare-core in a method that receives either a list or dict and populates (or even retrieves then populates, based on the line 212 comment) an EC, just so the behavior is clearly part of the core contract.", "url": "https://github.com/dimagi/commcare-android/pull/2412#discussion_r544459218", "createdAt": "2020-12-16T16:52:07Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -189,15 +194,86 @@ private void loadInstanceState(Bundle savedInstanceState) {\n     }\n \n     /**\n-     * Set state that signifies activity was launch from external app.\n+     * Set state that signifies activity was launch from external app\n      */\n     private void processFromExternalLaunch(Bundle savedInstanceState) {\n         if (savedInstanceState == null && getIntent().hasExtra(DispatchActivity.WAS_EXTERNAL)) {\n             wasExternal = true;\n+            processSessionEndpoint();\n             sessionNavigator.startNextSessionStep();\n         }\n     }\n \n+    private void processSessionEndpoint() {\n+        if (getIntent().hasExtra(SESSION_ENDPOINT_ID)) {\n+            Endpoint endpoint = validateIntentForSessionEndpoint(getIntent());\n+            if (endpoint != null) {\n+                Vector<String> endpointArguments = endpoint.getArguments();\n+                EvaluationContext evaluationContext = CommCareApplication.instance().getCurrentSessionWrapper().getEvaluationContext();\n+\n+                Bundle intentArgumentsAsBundle = getIntent().getBundleExtra(SESSION_ENDPOINT_ARGUMENTS_BUNDLE);\n+                ArrayList<String> intentArgumentsAsList = getIntent().getStringArrayListExtra(SESSION_ENDPOINT_ARGUMENTS_LIST);\n+\n+                for (int i = 0; i < endpointArguments.size(); i++) {\n+                    String argumentName = endpointArguments.elementAt(i);\n+                    if (intentArgumentsAsBundle != null && !intentArgumentsAsBundle.containsKey(argumentName)) {\n+                        String noArgumentWithNameError = org.commcare.utils.StringUtils.getStringRobust(\n+                                this,\n+                                R.string.session_endpoint_no_argument_with_name,\n+                                new String[]{argumentName, endpoint.getId()});\n+                        UserfacingErrorHandling.createErrorDialog(this, noArgumentWithNameError, true);\n+                        return;\n+                    }\n+\n+                    // Bundle Arguments take precdence over list arguments\n+                    String argValue = intentArgumentsAsBundle == null ? intentArgumentsAsList.get(i)\n+                            : intentArgumentsAsBundle.getString(argumentName);\n+\n+                    evaluationContext.setVariable(argumentName, argValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5567d2a1151a224a61cd7d2909a27393e951a9ab"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1OTgwMA==", "bodyText": "do we need the check block on line 219 if this validation code runs over things first?", "url": "https://github.com/dimagi/commcare-android/pull/2412#discussion_r544459800", "createdAt": "2020-12-16T16:52:51Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -189,15 +194,86 @@ private void loadInstanceState(Bundle savedInstanceState) {\n     }\n \n     /**\n-     * Set state that signifies activity was launch from external app.\n+     * Set state that signifies activity was launch from external app\n      */\n     private void processFromExternalLaunch(Bundle savedInstanceState) {\n         if (savedInstanceState == null && getIntent().hasExtra(DispatchActivity.WAS_EXTERNAL)) {\n             wasExternal = true;\n+            processSessionEndpoint();\n             sessionNavigator.startNextSessionStep();\n         }\n     }\n \n+    private void processSessionEndpoint() {\n+        if (getIntent().hasExtra(SESSION_ENDPOINT_ID)) {\n+            Endpoint endpoint = validateIntentForSessionEndpoint(getIntent());\n+            if (endpoint != null) {\n+                Vector<String> endpointArguments = endpoint.getArguments();\n+                EvaluationContext evaluationContext = CommCareApplication.instance().getCurrentSessionWrapper().getEvaluationContext();\n+\n+                Bundle intentArgumentsAsBundle = getIntent().getBundleExtra(SESSION_ENDPOINT_ARGUMENTS_BUNDLE);\n+                ArrayList<String> intentArgumentsAsList = getIntent().getStringArrayListExtra(SESSION_ENDPOINT_ARGUMENTS_LIST);\n+\n+                for (int i = 0; i < endpointArguments.size(); i++) {\n+                    String argumentName = endpointArguments.elementAt(i);\n+                    if (intentArgumentsAsBundle != null && !intentArgumentsAsBundle.containsKey(argumentName)) {\n+                        String noArgumentWithNameError = org.commcare.utils.StringUtils.getStringRobust(\n+                                this,\n+                                R.string.session_endpoint_no_argument_with_name,\n+                                new String[]{argumentName, endpoint.getId()});\n+                        UserfacingErrorHandling.createErrorDialog(this, noArgumentWithNameError, true);\n+                        return;\n+                    }\n+\n+                    // Bundle Arguments take precdence over list arguments\n+                    String argValue = intentArgumentsAsBundle == null ? intentArgumentsAsList.get(i)\n+                            : intentArgumentsAsBundle.getString(argumentName);\n+\n+                    evaluationContext.setVariable(argumentName, argValue);\n+                }\n+\n+                CommCareApplication.instance().getCurrentSessionWrapper().reset();\n+                CommCareApplication.instance().getCurrentSessionWrapper()\n+                        .executeStackActions(endpoint.getStackOperations(), evaluationContext);\n+            }\n+        }\n+    }\n+\n+    private Endpoint validateIntentForSessionEndpoint(Intent intent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5567d2a1151a224a61cd7d2909a27393e951a9ab"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a19d4dc832f0412a3cfed0b9039b730ff55211c0", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/a19d4dc832f0412a3cfed0b9039b730ff55211c0", "committedDate": "2020-12-18T09:55:59Z", "message": "Moves code to core, pr feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1ODM4Njk4", "url": "https://github.com/dimagi/commcare-android/pull/2412#pullrequestreview-555838698", "createdAt": "2020-12-18T21:59:07Z", "commit": {"oid": "a19d4dc832f0412a3cfed0b9039b730ff55211c0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2020, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}