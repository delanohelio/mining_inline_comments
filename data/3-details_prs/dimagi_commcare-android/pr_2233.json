{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MDQ1NDMy", "number": 2233, "title": "Show form-save-toast before finishing activity", "bodyText": "An attempt to fix these crashes:\nFatal Exception: android.view.WindowManager$BadTokenException: Unable to add window -- token android.os.BinderProxy@ec645b0 is not valid; is your activity running?\n       at android.view.ViewRootImpl.setView(ViewRootImpl.java:679)\n       at android.view.WindowManagerGlobal.addView(WindowManagerGlobal.java:342)\n       at android.view.WindowManagerImpl.addView(WindowManagerImpl.java:94)\n       at android.widget.Toast$TN.handleShow(Toast.java:459)\n       at android.widget.Toast$TN$2.handleMessage(Toast.java:342)\n       at android.os.Handler.dispatchMessage(Handler.java:102)\n       at android.os.Looper.loop(Looper.java:154)\n       at android.app.ActivityThread.main(ActivityThread.java:6291)\n       at java.lang.reflect.Method.invoke(Method.java)\n       at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:889)\n       at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:779)\n\nIt appears that in API 25, android's Toast had a bug which causes these BadTokenException and there is a 3rd party library that has the detailed explanation with the proper fix.\nIt appears to me that showing the toast after finishing the activity is the main culprit here, so fixing that behaviour.\nPS: Though I tried running the app on Android 7.1 emulator but couldn't reproduce the error, even by showing the toast with a 5s delay after finishing activity.", "createdAt": "2020-05-11T11:31:04Z", "url": "https://github.com/dimagi/commcare-android/pull/2233", "merged": true, "mergeCommit": {"oid": "1584e5a6909e175c377654ad24ce46a9d9b4a608"}, "closed": true, "closedAt": "2020-05-18T05:18:28Z", "author": {"login": "ShivamPokhriyal"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgN6gqAH2gAyNDE2MDQ1NDMyOmY1NDA2OWUyNzY3NmFjODljZDEyMDkyNDY5NTI2MmY4YzhiNDdkZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABciQtmqAFqTQxMzE5Mjg5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f54069e27676ac89cd120924695262f8c8b47df4", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/f54069e27676ac89cd120924695262f8c8b47df4", "committedDate": "2020-05-11T11:24:20Z", "message": "Show form-save-toast before finishing activity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDg5NjQ2", "url": "https://github.com/dimagi/commcare-android/pull/2233#pullrequestreview-409089646", "createdAt": "2020-05-11T11:32:56Z", "commit": {"oid": "f54069e27676ac89cd120924695262f8c8b47df4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMTozMjo1NlrOGTYYGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMTozMjo1NlrOGTYYGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk3NTUxNA==", "bodyText": "It appears to me that uiController.refreshView(); is not required here.", "url": "https://github.com/dimagi/commcare-android/pull/2233#discussion_r422975514", "createdAt": "2020-05-11T11:32:56Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/activities/FormEntryActivity.java", "diffHunk": "@@ -1143,10 +1143,12 @@ public void savingComplete(SaveToDiskTask.SaveStatus saveStatus, String errorMes\n                     hasSaved = true;\n                     break;\n                 case SAVED_AND_EXIT:\n-                    toastMessage = Localization.get(\"form.entry.complete.save.success\");\n                     hasSaved = true;\n+                    if (!CommCareApplication.instance().isConsumerApp()) {\n+                        Toast.makeText(this, Localization.get(\"form.entry.complete.save.success\"), Toast.LENGTH_SHORT).show();\n+                    }\n                     finishReturnInstance();\n-                    break;\n+                    return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f54069e27676ac89cd120924695262f8c8b47df4"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTkyODk5", "url": "https://github.com/dimagi/commcare-android/pull/2233#pullrequestreview-413192899", "createdAt": "2020-05-17T19:47:48Z", "commit": {"oid": "f54069e27676ac89cd120924695262f8c8b47df4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2040, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}