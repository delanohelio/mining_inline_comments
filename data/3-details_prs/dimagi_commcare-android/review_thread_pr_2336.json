{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NDE5NTgw", "number": 2336, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwODowMjozOFrOEf31_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNzo0Mzo1NlrOEjAGwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxODU2MjUyOnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/views/media/MediaLayout.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwODowMjozOFrOHMa5Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNDoxNzoxM1rOHQgvLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc4NTU1OQ==", "bodyText": "Wondering if we need to do something here if the media isn't present?", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r482785559", "createdAt": "2020-09-03T08:02:38Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -114,69 +104,57 @@ public static MediaLayout buildComprehensiveLayout(Context context,\n         return mediaLayout;\n     }\n \n+//    public void build(Context context,\n+//                                                       TextView text, String audioURI, String imageURI,\n+//                                                       final String videoURI, final String bigImageURI,\n+//                                                       final String qrCodeContent, String inlineVideoURI,\n+//                                                       int questionIndex) {\n+//        setAVT(text, audioURI, imageURI, videoURI, bigImageURI, qrCodeContent, inlineVideoURI, false, questionIndex);\n+//    }\n+\n+\n+\n+    public void addDivider() {\n+        divider.setVisibility(VISIBLE);\n+    }\n+\n+    //region private helpers\n+\n     private void setAVT(TextView text, String audioURI, String imageURI,\n                         final String videoURI, final String bigImageURI,\n                         final String qrCodeContent, String inlineVideoURI,\n                         boolean showImageAboveText,\n                         int questionIndex) {\n-        viewText = text;\n-        mInlineVideoUri = inlineVideoURI;\n-        mImageURI = imageURI;\n-        mBigImageURI = bigImageURI;\n-        mQrCodeContent = qrCodeContent;\n-\n-        RelativeLayout questionTextPane = new RelativeLayout(this.getContext());\n-        questionTextPane.setId(QUESTION_TEXT_PANE_ID);\n-\n         setupStandardAudio(audioURI, questionIndex);\n         setupVideoButton(videoURI);\n-\n-        // Now set up the center view -- it is either an image, a QR Code, an inline video, or\n-        // expanded audio\n-        mediaPane = new RelativeLayout(getContext());\n-\n-        LayoutParams mediaPaneParams = refreshMediaView();\n-\n-        addAudioVideoButtonsToView(questionTextPane);\n-\n-        showImageAboveText = showImageAboveText || DeveloperPreferences.imageAboveTextEnabled();\n-        addElementsToView(mediaPane, mediaPaneParams, questionTextPane, showImageAboveText);\n+        setupQRView(qrCodeContent);\n+        setupInlineVideoView(inlineVideoURI);\n+        setupImage(imageURI, bigImageURI);\n+        addTextView(text);\n+        //TODO Need to use showImageAboveText\n     }\n \n-    private LayoutParams refreshMediaView() {\n-        RelativeLayout.LayoutParams mediaPaneParams =\n-                new RelativeLayout.LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.WRAP_CONTENT);\n-\n-        View mediaView = null;\n-        if (mInlineVideoUri != null) {\n-            mediaView = getInlineVideoView(mInlineVideoUri, mediaPaneParams);\n-        } else if (mQrCodeContent != null) {\n-            mediaView = setupQRView(mQrCodeContent);\n-        } else if (mImageURI != null) {\n-            mediaView = setupImage(mImageURI, mBigImageURI);\n-        }\n+    private void addTextView(TextView text) {\n+        textViewContainer.addView(text);\n+    }\n \n-        if (mediaView != null) {\n-            RelativeLayout.LayoutParams mediaViewParams =\n-                    new RelativeLayout.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT);\n-            mediaViewParams.addRule(CENTER_IN_PARENT, mediaView.getId());\n-            mediaPane.addView(mediaView, mediaViewParams);\n+    private void setupStandardAudio(String audioURI, int questionIndex) {\n+        if (audioURI != null) {\n+            boolean mediaPresent = FileUtil.referenceFileExists(audioURI);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fff6e26ea2da0b8e05edc0f66d20b2c87fd5e2e"}, "originalPosition": 194}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ1ODM1Nw==", "bodyText": "the audio button should be handling the missing media state by itself, providing an option to download the file in case it's missing.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r484458357", "createdAt": "2020-09-07T14:15:34Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -114,69 +104,57 @@ public static MediaLayout buildComprehensiveLayout(Context context,\n         return mediaLayout;\n     }\n \n+//    public void build(Context context,\n+//                                                       TextView text, String audioURI, String imageURI,\n+//                                                       final String videoURI, final String bigImageURI,\n+//                                                       final String qrCodeContent, String inlineVideoURI,\n+//                                                       int questionIndex) {\n+//        setAVT(text, audioURI, imageURI, videoURI, bigImageURI, qrCodeContent, inlineVideoURI, false, questionIndex);\n+//    }\n+\n+\n+\n+    public void addDivider() {\n+        divider.setVisibility(VISIBLE);\n+    }\n+\n+    //region private helpers\n+\n     private void setAVT(TextView text, String audioURI, String imageURI,\n                         final String videoURI, final String bigImageURI,\n                         final String qrCodeContent, String inlineVideoURI,\n                         boolean showImageAboveText,\n                         int questionIndex) {\n-        viewText = text;\n-        mInlineVideoUri = inlineVideoURI;\n-        mImageURI = imageURI;\n-        mBigImageURI = bigImageURI;\n-        mQrCodeContent = qrCodeContent;\n-\n-        RelativeLayout questionTextPane = new RelativeLayout(this.getContext());\n-        questionTextPane.setId(QUESTION_TEXT_PANE_ID);\n-\n         setupStandardAudio(audioURI, questionIndex);\n         setupVideoButton(videoURI);\n-\n-        // Now set up the center view -- it is either an image, a QR Code, an inline video, or\n-        // expanded audio\n-        mediaPane = new RelativeLayout(getContext());\n-\n-        LayoutParams mediaPaneParams = refreshMediaView();\n-\n-        addAudioVideoButtonsToView(questionTextPane);\n-\n-        showImageAboveText = showImageAboveText || DeveloperPreferences.imageAboveTextEnabled();\n-        addElementsToView(mediaPane, mediaPaneParams, questionTextPane, showImageAboveText);\n+        setupQRView(qrCodeContent);\n+        setupInlineVideoView(inlineVideoURI);\n+        setupImage(imageURI, bigImageURI);\n+        addTextView(text);\n+        //TODO Need to use showImageAboveText\n     }\n \n-    private LayoutParams refreshMediaView() {\n-        RelativeLayout.LayoutParams mediaPaneParams =\n-                new RelativeLayout.LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.WRAP_CONTENT);\n-\n-        View mediaView = null;\n-        if (mInlineVideoUri != null) {\n-            mediaView = getInlineVideoView(mInlineVideoUri, mediaPaneParams);\n-        } else if (mQrCodeContent != null) {\n-            mediaView = setupQRView(mQrCodeContent);\n-        } else if (mImageURI != null) {\n-            mediaView = setupImage(mImageURI, mBigImageURI);\n-        }\n+    private void addTextView(TextView text) {\n+        textViewContainer.addView(text);\n+    }\n \n-        if (mediaView != null) {\n-            RelativeLayout.LayoutParams mediaViewParams =\n-                    new RelativeLayout.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT);\n-            mediaViewParams.addRule(CENTER_IN_PARENT, mediaView.getId());\n-            mediaPane.addView(mediaView, mediaViewParams);\n+    private void setupStandardAudio(String audioURI, int questionIndex) {\n+        if (audioURI != null) {\n+            boolean mediaPresent = FileUtil.referenceFileExists(audioURI);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc4NTU1OQ=="}, "originalCommit": {"oid": "1fff6e26ea2da0b8e05edc0f66d20b2c87fd5e2e"}, "originalPosition": 194}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ2MjE4NA==", "bodyText": "awesome. Thanks!", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r484462184", "createdAt": "2020-09-07T14:22:52Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -114,69 +104,57 @@ public static MediaLayout buildComprehensiveLayout(Context context,\n         return mediaLayout;\n     }\n \n+//    public void build(Context context,\n+//                                                       TextView text, String audioURI, String imageURI,\n+//                                                       final String videoURI, final String bigImageURI,\n+//                                                       final String qrCodeContent, String inlineVideoURI,\n+//                                                       int questionIndex) {\n+//        setAVT(text, audioURI, imageURI, videoURI, bigImageURI, qrCodeContent, inlineVideoURI, false, questionIndex);\n+//    }\n+\n+\n+\n+    public void addDivider() {\n+        divider.setVisibility(VISIBLE);\n+    }\n+\n+    //region private helpers\n+\n     private void setAVT(TextView text, String audioURI, String imageURI,\n                         final String videoURI, final String bigImageURI,\n                         final String qrCodeContent, String inlineVideoURI,\n                         boolean showImageAboveText,\n                         int questionIndex) {\n-        viewText = text;\n-        mInlineVideoUri = inlineVideoURI;\n-        mImageURI = imageURI;\n-        mBigImageURI = bigImageURI;\n-        mQrCodeContent = qrCodeContent;\n-\n-        RelativeLayout questionTextPane = new RelativeLayout(this.getContext());\n-        questionTextPane.setId(QUESTION_TEXT_PANE_ID);\n-\n         setupStandardAudio(audioURI, questionIndex);\n         setupVideoButton(videoURI);\n-\n-        // Now set up the center view -- it is either an image, a QR Code, an inline video, or\n-        // expanded audio\n-        mediaPane = new RelativeLayout(getContext());\n-\n-        LayoutParams mediaPaneParams = refreshMediaView();\n-\n-        addAudioVideoButtonsToView(questionTextPane);\n-\n-        showImageAboveText = showImageAboveText || DeveloperPreferences.imageAboveTextEnabled();\n-        addElementsToView(mediaPane, mediaPaneParams, questionTextPane, showImageAboveText);\n+        setupQRView(qrCodeContent);\n+        setupInlineVideoView(inlineVideoURI);\n+        setupImage(imageURI, bigImageURI);\n+        addTextView(text);\n+        //TODO Need to use showImageAboveText\n     }\n \n-    private LayoutParams refreshMediaView() {\n-        RelativeLayout.LayoutParams mediaPaneParams =\n-                new RelativeLayout.LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.WRAP_CONTENT);\n-\n-        View mediaView = null;\n-        if (mInlineVideoUri != null) {\n-            mediaView = getInlineVideoView(mInlineVideoUri, mediaPaneParams);\n-        } else if (mQrCodeContent != null) {\n-            mediaView = setupQRView(mQrCodeContent);\n-        } else if (mImageURI != null) {\n-            mediaView = setupImage(mImageURI, mBigImageURI);\n-        }\n+    private void addTextView(TextView text) {\n+        textViewContainer.addView(text);\n+    }\n \n-        if (mediaView != null) {\n-            RelativeLayout.LayoutParams mediaViewParams =\n-                    new RelativeLayout.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT);\n-            mediaViewParams.addRule(CENTER_IN_PARENT, mediaView.getId());\n-            mediaPane.addView(mediaView, mediaViewParams);\n+    private void setupStandardAudio(String audioURI, int questionIndex) {\n+        if (audioURI != null) {\n+            boolean mediaPresent = FileUtil.referenceFileExists(audioURI);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc4NTU1OQ=="}, "originalCommit": {"oid": "1fff6e26ea2da0b8e05edc0f66d20b2c87fd5e2e"}, "originalPosition": 194}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA3NTYyOQ==", "bodyText": "FYI, I'll remove this unused variable then.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487075629", "createdAt": "2020-09-11T14:17:13Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -114,69 +104,57 @@ public static MediaLayout buildComprehensiveLayout(Context context,\n         return mediaLayout;\n     }\n \n+//    public void build(Context context,\n+//                                                       TextView text, String audioURI, String imageURI,\n+//                                                       final String videoURI, final String bigImageURI,\n+//                                                       final String qrCodeContent, String inlineVideoURI,\n+//                                                       int questionIndex) {\n+//        setAVT(text, audioURI, imageURI, videoURI, bigImageURI, qrCodeContent, inlineVideoURI, false, questionIndex);\n+//    }\n+\n+\n+\n+    public void addDivider() {\n+        divider.setVisibility(VISIBLE);\n+    }\n+\n+    //region private helpers\n+\n     private void setAVT(TextView text, String audioURI, String imageURI,\n                         final String videoURI, final String bigImageURI,\n                         final String qrCodeContent, String inlineVideoURI,\n                         boolean showImageAboveText,\n                         int questionIndex) {\n-        viewText = text;\n-        mInlineVideoUri = inlineVideoURI;\n-        mImageURI = imageURI;\n-        mBigImageURI = bigImageURI;\n-        mQrCodeContent = qrCodeContent;\n-\n-        RelativeLayout questionTextPane = new RelativeLayout(this.getContext());\n-        questionTextPane.setId(QUESTION_TEXT_PANE_ID);\n-\n         setupStandardAudio(audioURI, questionIndex);\n         setupVideoButton(videoURI);\n-\n-        // Now set up the center view -- it is either an image, a QR Code, an inline video, or\n-        // expanded audio\n-        mediaPane = new RelativeLayout(getContext());\n-\n-        LayoutParams mediaPaneParams = refreshMediaView();\n-\n-        addAudioVideoButtonsToView(questionTextPane);\n-\n-        showImageAboveText = showImageAboveText || DeveloperPreferences.imageAboveTextEnabled();\n-        addElementsToView(mediaPane, mediaPaneParams, questionTextPane, showImageAboveText);\n+        setupQRView(qrCodeContent);\n+        setupInlineVideoView(inlineVideoURI);\n+        setupImage(imageURI, bigImageURI);\n+        addTextView(text);\n+        //TODO Need to use showImageAboveText\n     }\n \n-    private LayoutParams refreshMediaView() {\n-        RelativeLayout.LayoutParams mediaPaneParams =\n-                new RelativeLayout.LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.WRAP_CONTENT);\n-\n-        View mediaView = null;\n-        if (mInlineVideoUri != null) {\n-            mediaView = getInlineVideoView(mInlineVideoUri, mediaPaneParams);\n-        } else if (mQrCodeContent != null) {\n-            mediaView = setupQRView(mQrCodeContent);\n-        } else if (mImageURI != null) {\n-            mediaView = setupImage(mImageURI, mBigImageURI);\n-        }\n+    private void addTextView(TextView text) {\n+        textViewContainer.addView(text);\n+    }\n \n-        if (mediaView != null) {\n-            RelativeLayout.LayoutParams mediaViewParams =\n-                    new RelativeLayout.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT);\n-            mediaViewParams.addRule(CENTER_IN_PARENT, mediaView.getId());\n-            mediaPane.addView(mediaView, mediaViewParams);\n+    private void setupStandardAudio(String audioURI, int questionIndex) {\n+        if (audioURI != null) {\n+            boolean mediaPresent = FileUtil.referenceFileExists(audioURI);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc4NTU1OQ=="}, "originalCommit": {"oid": "1fff6e26ea2da0b8e05edc0f66d20b2c87fd5e2e"}, "originalPosition": 194}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMDIzMDk0OnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/views/media/MediaLayout.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNDo1OToyOVrOHMqwlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNDoyNTo0OVrOHOBUKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0NTUyNQ==", "bodyText": "Same, do we need to show something here as well just like we do for videoView?", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r483045525", "createdAt": "2020-09-03T14:59:29Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -342,129 +232,66 @@ private View setupImage(String imageURI, String bigImageURI) {\n                     } else {\n                         mImageView.setImageBitmap(b);\n                     }\n-                    mImageView.setId(IMAGE_VIEW_ID);\n-                    mediaPane = mImageView;\n+                    mImageView.setVisibility(VISIBLE);\n                 }\n             } else {\n                 // An error hasn't been logged. We should have an image, but the file doesn't\n                 // exist.\n-                mediaPane = getMissingMediaView(imageURI,\n-                        StringUtils.getStringRobust(getContext(), R.string.video_download_prompt),\n-                        true);\n+                showMissingMediaView(imageURI,\n+                        StringUtils.getStringRobust(getContext(), R.string.image_download_prompt),\n+                        true,\n+                        () -> {\n+                            hideMissingMediaView();\n+                            setupImage(imageURI, bigImageURI);\n+                        });\n             }\n         } catch (InvalidReferenceException e) {\n             Log.e(TAG, \"image invalid reference exception\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "931b63e126daf07eae19f08dc18881ee64af2e36"}, "originalPosition": 380}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ2MzY1Ng==", "bodyText": "we can follow the same pattern as videoView.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r484463656", "createdAt": "2020-09-07T14:25:49Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -342,129 +232,66 @@ private View setupImage(String imageURI, String bigImageURI) {\n                     } else {\n                         mImageView.setImageBitmap(b);\n                     }\n-                    mImageView.setId(IMAGE_VIEW_ID);\n-                    mediaPane = mImageView;\n+                    mImageView.setVisibility(VISIBLE);\n                 }\n             } else {\n                 // An error hasn't been logged. We should have an image, but the file doesn't\n                 // exist.\n-                mediaPane = getMissingMediaView(imageURI,\n-                        StringUtils.getStringRobust(getContext(), R.string.video_download_prompt),\n-                        true);\n+                showMissingMediaView(imageURI,\n+                        StringUtils.getStringRobust(getContext(), R.string.image_download_prompt),\n+                        true,\n+                        () -> {\n+                            hideMissingMediaView();\n+                            setupImage(imageURI, bigImageURI);\n+                        });\n             }\n         } catch (InvalidReferenceException e) {\n             Log.e(TAG, \"image invalid reference exception\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0NTUyNQ=="}, "originalCommit": {"oid": "931b63e126daf07eae19f08dc18881ee64af2e36"}, "originalPosition": 380}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NjYzODYwOnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/views/media/MediaLayout.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo0NjowNlrOHQfhLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxOTo0Nzo0N1rOHQ-5BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1NTY2Mw==", "bodyText": "the reason why videoView doesn't appear after download completion was this maxBounds[1]. In my case, the textView had a really long text and I had to scroll down to see the videoView.\nThe getMaxCenterViewBounds method subtracts the text height from the total height\nmaxHeight = maxHeight - textViewContainer.getChildAt(0).getHeight(); making this maxBounds[1] to be 0.\nSince, videoView will automatically configure itself with the min height possible, we're good to give it max height here.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487055663", "createdAt": "2020-09-11T13:46:06Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -350,13 +351,13 @@ private void setupInlineVideoView(String inlineVideoURI) {\n      * It's height is always 0(from LayoutInspector) even if you set it to match_parent.\n      */\n     private void makeVideoViewVisible() {\n-        int[] maxBounds = getMaxCenterViewBounds();\n         //These surprisingly get re-jiggered as soon as the video is loaded, so we\n         //just want to give it the _max_ bounds, it'll pick the limiter and shrink\n         //itself when it's ready.\n+        DisplayMetrics metrics = this.getContext().getResources().getDisplayMetrics();\n         ViewGroup.LayoutParams params = videoView.getLayoutParams();\n-        params.width = maxBounds[0];\n-        params.height = maxBounds[1];\n+        params.width = metrics.widthPixels;\n+        params.height = metrics.heightPixels;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53f6ac61535ebd43249ec2dff8c56708dd02c729"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2OTY2OQ==", "bodyText": "nice find.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487569669", "createdAt": "2020-09-13T19:47:47Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -350,13 +351,13 @@ private void setupInlineVideoView(String inlineVideoURI) {\n      * It's height is always 0(from LayoutInspector) even if you set it to match_parent.\n      */\n     private void makeVideoViewVisible() {\n-        int[] maxBounds = getMaxCenterViewBounds();\n         //These surprisingly get re-jiggered as soon as the video is loaded, so we\n         //just want to give it the _max_ bounds, it'll pick the limiter and shrink\n         //itself when it's ready.\n+        DisplayMetrics metrics = this.getContext().getResources().getDisplayMetrics();\n         ViewGroup.LayoutParams params = videoView.getLayoutParams();\n-        params.width = maxBounds[0];\n-        params.height = maxBounds[1];\n+        params.width = metrics.widthPixels;\n+        params.height = metrics.heightPixels;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1NTY2Mw=="}, "originalCommit": {"oid": "53f6ac61535ebd43249ec2dff8c56708dd02c729"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0Njc5NzMzOnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/views/media/MediaLayout.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNDoyNToyMlrOHQhDzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxOTo0NTozN1rOHQ-4Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4MDkxMQ==", "bodyText": "@shubham1g5 Do we need to localize this text?", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487080911", "createdAt": "2020-09-11T14:25:22Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -473,64 +337,75 @@ private View getInlineVideoView(String inlineVideoURI, RelativeLayout.LayoutPara\n                     }\n                     FirebaseAnalyticsUtil.reportInlineVideoPlayEvent(videoFilename, FileUtil.getDuration(videoFile), duration);\n                 });\n-\n                 videoView.setOnClickListener(v -> ViewUtil.hideVirtualKeyboard((Activity)getContext()));\n-\n-                //These surprisingly get re-jiggered as soon as the video is loaded, so we\n-                //just want to give it the _max_ bounds, it'll pick the limiter and shrink\n-                //itself when it's ready.\n-                viewLayoutParams.width = maxBounds[0];\n-                viewLayoutParams.height = maxBounds[1];\n-\n-                videoView.setId(INLINE_VIDEO_PANE_ID);\n-                return videoView;\n+                videoView.setVisibility(VISIBLE);\n             }\n         } catch (InvalidReferenceException ire) {\n             Log.e(TAG, \"invalid video reference exception\");\n             ire.printStackTrace();\n-            return getMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false);\n+            showMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf"}, "originalPosition": 570}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4MjA5Mg==", "bodyText": "Also the information here isn't really informative imo. Would it be better if we say: Can't show media due to: ?", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487082092", "createdAt": "2020-09-11T14:27:20Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -473,64 +337,75 @@ private View getInlineVideoView(String inlineVideoURI, RelativeLayout.LayoutPara\n                     }\n                     FirebaseAnalyticsUtil.reportInlineVideoPlayEvent(videoFilename, FileUtil.getDuration(videoFile), duration);\n                 });\n-\n                 videoView.setOnClickListener(v -> ViewUtil.hideVirtualKeyboard((Activity)getContext()));\n-\n-                //These surprisingly get re-jiggered as soon as the video is loaded, so we\n-                //just want to give it the _max_ bounds, it'll pick the limiter and shrink\n-                //itself when it's ready.\n-                viewLayoutParams.width = maxBounds[0];\n-                viewLayoutParams.height = maxBounds[1];\n-\n-                videoView.setId(INLINE_VIDEO_PANE_ID);\n-                return videoView;\n+                videoView.setVisibility(VISIBLE);\n             }\n         } catch (InvalidReferenceException ire) {\n             Log.e(TAG, \"invalid video reference exception\");\n             ire.printStackTrace();\n-            return getMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false);\n+            showMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false, null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4MDkxMQ=="}, "originalCommit": {"oid": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf"}, "originalPosition": 570}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2OTQ3NA==", "bodyText": "yes, we should localize anything we display on UI. I think the prefix you mentioned is redundant in Invalid ... but would not really mind us adding that.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487569474", "createdAt": "2020-09-13T19:45:37Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -473,64 +337,75 @@ private View getInlineVideoView(String inlineVideoURI, RelativeLayout.LayoutPara\n                     }\n                     FirebaseAnalyticsUtil.reportInlineVideoPlayEvent(videoFilename, FileUtil.getDuration(videoFile), duration);\n                 });\n-\n                 videoView.setOnClickListener(v -> ViewUtil.hideVirtualKeyboard((Activity)getContext()));\n-\n-                //These surprisingly get re-jiggered as soon as the video is loaded, so we\n-                //just want to give it the _max_ bounds, it'll pick the limiter and shrink\n-                //itself when it's ready.\n-                viewLayoutParams.width = maxBounds[0];\n-                viewLayoutParams.height = maxBounds[1];\n-\n-                videoView.setId(INLINE_VIDEO_PANE_ID);\n-                return videoView;\n+                videoView.setVisibility(VISIBLE);\n             }\n         } catch (InvalidReferenceException ire) {\n             Log.e(TAG, \"invalid video reference exception\");\n             ire.printStackTrace();\n-            return getMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false);\n+            showMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false, null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4MDkxMQ=="}, "originalCommit": {"oid": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf"}, "originalPosition": 570}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MDI0MTQwOnYy", "diffSide": "RIGHT", "path": "app/res/layout/media_layout.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxNzoyNjo0NVrOHQ-AJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxNzoyNjo0NVrOHQ-AJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1NTExMA==", "bodyText": "nit: comments formatting seems off, should be single lined", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487555110", "createdAt": "2020-09-13T17:26:45Z", "author": {"login": "shubham1g5"}, "path": "app/res/layout/media_layout.xml", "diffHunk": "@@ -0,0 +1,178 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<merge xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    xmlns:app=\"http://schemas.android.com/apk/res-auto\">\n+\n+    <org.commcare.views.media.AudioPlaybackButton\n+        android:id=\"@+id/audio_button\"\n+        android:layout_width=\"wrap_content\"\n+        android:layout_height=\"wrap_content\"\n+        app:layout_constraintEnd_toEndOf=\"parent\"\n+        app:layout_constraintRight_toRightOf=\"parent\"\n+        app:layout_constraintTop_toTopOf=\"parent\" />\n+\n+    <ImageButton\n+        android:id=\"@+id/video_button\"\n+        android:layout_width=\"wrap_content\"\n+        android:layout_height=\"wrap_content\"\n+        android:src=\"@android:drawable/ic_media_play\"\n+        app:layout_constraintEnd_toEndOf=\"parent\"\n+        app:layout_constraintRight_toRightOf=\"parent\"\n+        app:layout_constraintTop_toBottomOf=\"@id/audio_button\" />\n+\n+    <androidx.constraintlayout.widget.Barrier\n+        android:id=\"@+id/buttons_barrier\"\n+        android:layout_width=\"wrap_content\"\n+        android:layout_height=\"wrap_content\"\n+        app:barrierDirection=\"left\"\n+        app:constraint_referenced_ids=\"audio_button, video_button\" />\n+\n+    <FrameLayout\n+        android:id=\"@+id/question_text_container\"\n+        android:layout_width=\"0dp\"\n+        android:layout_height=\"wrap_content\"\n+        app:layout_constraintEnd_toStartOf=\"@id/buttons_barrier\"\n+        app:layout_constraintLeft_toLeftOf=\"parent\"\n+        app:layout_constraintRight_toLeftOf=\"@id/buttons_barrier\"\n+        app:layout_constraintStart_toStartOf=\"parent\"\n+        app:layout_constraintTop_toTopOf=\"parent\" />\n+\n+    <androidx.constraintlayout.widget.Barrier\n+        android:id=\"@+id/question_barrier\"\n+        android:layout_width=\"wrap_content\"\n+        android:layout_height=\"wrap_content\"\n+        app:barrierDirection=\"bottom\"\n+        app:constraint_referenced_ids=\"audio_button, video_button, question_text_container\" />\n+\n+    <org.commcare.views.media.CommCareVideoView\n+        android:id=\"@+id/inline_video_view\"\n+        android:layout_width=\"0dp\"\n+        android:layout_height=\"wrap_content\"\n+        app:layout_constraintEnd_toEndOf=\"parent\"\n+        app:layout_constraintLeft_toLeftOf=\"parent\"\n+        app:layout_constraintRight_toRightOf=\"parent\"\n+        app:layout_constraintStart_toStartOf=\"parent\"\n+        app:layout_constraintTop_toBottomOf=\"@id/question_barrier\" />\n+\n+    <ImageView\n+        android:id=\"@+id/qr_view\"\n+        android:layout_width=\"0dp\"\n+        android:layout_height=\"wrap_content\"\n+        android:adjustViewBounds=\"true\"\n+        android:padding=\"@dimen/standard_spacer\"\n+        android:scaleType=\"centerCrop\"\n+        app:layout_constraintEnd_toEndOf=\"parent\"\n+        app:layout_constraintLeft_toLeftOf=\"parent\"\n+        app:layout_constraintRight_toRightOf=\"parent\"\n+        app:layout_constraintStart_toStartOf=\"parent\"\n+        app:layout_constraintTop_toBottomOf=\"@id/question_barrier\" />\n+\n+    <ImageView\n+        android:id=\"@+id/image\"\n+        android:layout_width=\"0dp\"\n+        android:layout_height=\"wrap_content\"\n+        android:padding=\"@dimen/standard_spacer\"\n+        android:scaleType=\"center\"\n+        app:layout_constraintEnd_toEndOf=\"parent\"\n+        app:layout_constraintLeft_toLeftOf=\"parent\"\n+        app:layout_constraintRight_toRightOf=\"parent\"\n+        app:layout_constraintStart_toStartOf=\"parent\"\n+        app:layout_constraintTop_toBottomOf=\"@id/question_barrier\" />\n+\n+    <org.commcare.views.ResizingImageView\n+        android:id=\"@+id/resizing_image\"\n+        android:layout_width=\"0dp\"\n+        android:layout_height=\"wrap_content\"\n+        android:adjustViewBounds=\"true\"\n+        android:padding=\"@dimen/standard_spacer\"\n+        app:layout_constraintEnd_toEndOf=\"parent\"\n+        app:layout_constraintLeft_toLeftOf=\"parent\"\n+        app:layout_constraintRight_toRightOf=\"parent\"\n+        app:layout_constraintStart_toStartOf=\"parent\"\n+        app:layout_constraintTop_toBottomOf=\"@id/question_barrier\" />\n+\n+    <!--\n+    Missing media view", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MDI2NTgwOnYy", "diffSide": "RIGHT", "path": "app/res/layout/media_layout.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxNzo1NjowNVrOHQ-Lsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxNzo1NjowNVrOHQ-Lsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1ODA2Nw==", "bodyText": "Good use of merge to avoid layout hierarchy.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487558067", "createdAt": "2020-09-13T17:56:05Z", "author": {"login": "shubham1g5"}, "path": "app/res/layout/media_layout.xml", "diffHunk": "@@ -0,0 +1,178 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<merge xmlns:android=\"http://schemas.android.com/apk/res/android\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MDMxMjYxOnYy", "diffSide": "RIGHT", "path": "app/res/layout/media_layout.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxODo1MzoyOVrOHQ-iSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxODo1MzoyOVrOHQ-iSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2Mzg0OQ==", "bodyText": "Read about Barrier a bit and seems like a real useful addition to the set of Android views. Thanks for finding about these.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487563849", "createdAt": "2020-09-13T18:53:29Z", "author": {"login": "shubham1g5"}, "path": "app/res/layout/media_layout.xml", "diffHunk": "@@ -0,0 +1,178 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<merge xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    xmlns:app=\"http://schemas.android.com/apk/res-auto\">\n+\n+    <org.commcare.views.media.AudioPlaybackButton\n+        android:id=\"@+id/audio_button\"\n+        android:layout_width=\"wrap_content\"\n+        android:layout_height=\"wrap_content\"\n+        app:layout_constraintEnd_toEndOf=\"parent\"\n+        app:layout_constraintRight_toRightOf=\"parent\"\n+        app:layout_constraintTop_toTopOf=\"parent\" />\n+\n+    <ImageButton\n+        android:id=\"@+id/video_button\"\n+        android:layout_width=\"wrap_content\"\n+        android:layout_height=\"wrap_content\"\n+        android:src=\"@android:drawable/ic_media_play\"\n+        app:layout_constraintEnd_toEndOf=\"parent\"\n+        app:layout_constraintRight_toRightOf=\"parent\"\n+        app:layout_constraintTop_toBottomOf=\"@id/audio_button\" />\n+\n+    <androidx.constraintlayout.widget.Barrier", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MDMxMzU1OnYy", "diffSide": "RIGHT", "path": "app/res/layout/media_layout.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxODo1NDoxM1rOHQ-ivA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxODo1NDoxM1rOHQ-ivA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2Mzk2NA==", "bodyText": "should be start to not break RTL languages.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487563964", "createdAt": "2020-09-13T18:54:13Z", "author": {"login": "shubham1g5"}, "path": "app/res/layout/media_layout.xml", "diffHunk": "@@ -0,0 +1,178 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<merge xmlns:android=\"http://schemas.android.com/apk/res/android\"\n+    xmlns:app=\"http://schemas.android.com/apk/res-auto\">\n+\n+    <org.commcare.views.media.AudioPlaybackButton\n+        android:id=\"@+id/audio_button\"\n+        android:layout_width=\"wrap_content\"\n+        android:layout_height=\"wrap_content\"\n+        app:layout_constraintEnd_toEndOf=\"parent\"\n+        app:layout_constraintRight_toRightOf=\"parent\"\n+        app:layout_constraintTop_toTopOf=\"parent\" />\n+\n+    <ImageButton\n+        android:id=\"@+id/video_button\"\n+        android:layout_width=\"wrap_content\"\n+        android:layout_height=\"wrap_content\"\n+        android:src=\"@android:drawable/ic_media_play\"\n+        app:layout_constraintEnd_toEndOf=\"parent\"\n+        app:layout_constraintRight_toRightOf=\"parent\"\n+        app:layout_constraintTop_toBottomOf=\"@id/audio_button\" />\n+\n+    <androidx.constraintlayout.widget.Barrier\n+        android:id=\"@+id/buttons_barrier\"\n+        android:layout_width=\"wrap_content\"\n+        android:layout_height=\"wrap_content\"\n+        app:barrierDirection=\"left\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MDM2OTAzOnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/views/media/MediaLayout.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxOTo1ODoxNVrOHQ-9JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxOTo1ODoxNVrOHQ-9JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MDcyNQ==", "bodyText": "nit: missingMediaText -> missingMediaStatus", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487570725", "createdAt": "2020-09-13T19:58:15Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -473,64 +337,75 @@ private View getInlineVideoView(String inlineVideoURI, RelativeLayout.LayoutPara\n                     }\n                     FirebaseAnalyticsUtil.reportInlineVideoPlayEvent(videoFilename, FileUtil.getDuration(videoFile), duration);\n                 });\n-\n                 videoView.setOnClickListener(v -> ViewUtil.hideVirtualKeyboard((Activity)getContext()));\n-\n-                //These surprisingly get re-jiggered as soon as the video is loaded, so we\n-                //just want to give it the _max_ bounds, it'll pick the limiter and shrink\n-                //itself when it's ready.\n-                viewLayoutParams.width = maxBounds[0];\n-                viewLayoutParams.height = maxBounds[1];\n-\n-                videoView.setId(INLINE_VIDEO_PANE_ID);\n-                return videoView;\n+                videoView.setVisibility(VISIBLE);\n             }\n         } catch (InvalidReferenceException ire) {\n             Log.e(TAG, \"invalid video reference exception\");\n             ire.printStackTrace();\n-            return getMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false);\n+            showMissingMediaView(inlineVideoURI, \"Invalid reference: \" + ire.getReferenceString(), false, null);\n         }\n     }\n \n-    private View getMissingMediaView(String mediaUri, String errorMessage, boolean allowDownload) {\n-        missingMediaView = LayoutInflater.from(getContext()).inflate(R.layout.missing_media_view, this, false);\n-\n-        TextView status = missingMediaView.findViewById(R.id.missing_media_tv);\n-        status.setText(errorMessage);\n+    /**\n+     * Without this code VideoView doesn't appear on the screen.\n+     * It's height is always 0(from LayoutInspector) even if you set it to match_parent.\n+     */\n+    private void makeVideoViewVisible() {\n+        //These surprisingly get re-jiggered as soon as the video is loaded, so we\n+        //just want to give it the _max_ bounds, it'll pick the limiter and shrink\n+        //itself when it's ready.\n+        DisplayMetrics metrics = this.getContext().getResources().getDisplayMetrics();\n+        ViewGroup.LayoutParams params = videoView.getLayoutParams();\n+        params.width = metrics.widthPixels;\n+        params.height = metrics.heightPixels;\n+        videoView.setLayoutParams(params);\n+    }\n \n-        View progressView = missingMediaView.findViewById(R.id.progress_bar);\n-        View downloadIcon = missingMediaView.findViewById(R.id.download_media_icon);\n+    private void showMissingMediaView(String mediaUri, String errorMessage, boolean allowDownload, @Nullable Runnable completion) {\n+        missingMediaBackground.setVisibility(VISIBLE);\n+        missingMediaText.setText(errorMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf"}, "originalPosition": 598}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MDM3NDkxOnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/views/media/MediaLayout.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QyMDowNTowN1rOHQ-_1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QyMDowNTowN1rOHQ-_1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MTQxNQ==", "bodyText": "stylistic point that you can ignore: hideMissingMediaView can be called from showMissingMediaView to DRY the completion logic further.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487571415", "createdAt": "2020-09-13T20:05:07Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -342,129 +271,64 @@ private View setupImage(String imageURI, String bigImageURI) {\n                     } else {\n                         mImageView.setImageBitmap(b);\n                     }\n-                    mImageView.setId(IMAGE_VIEW_ID);\n-                    mediaPane = mImageView;\n+                    mImageView.setVisibility(VISIBLE);\n                 }\n             } else {\n                 // An error hasn't been logged. We should have an image, but the file doesn't\n                 // exist.\n-                mediaPane = getMissingMediaView(imageURI,\n-                        StringUtils.getStringRobust(getContext(), R.string.video_download_prompt),\n-                        true);\n+                showMissingMediaView(imageURI,\n+                        StringUtils.getStringRobust(getContext(), R.string.image_download_prompt),\n+                        true,\n+                        () -> {\n+                            hideMissingMediaView();\n+                            setupImage(imageURI, bigImageURI);\n+                        });\n             }\n         } catch (InvalidReferenceException e) {\n             Log.e(TAG, \"image invalid reference exception\");\n             e.printStackTrace();\n-        }\n-        return mediaPane;\n-    }\n-\n-    private void addElementsToView(View mediaPane,\n-                                   RelativeLayout.LayoutParams mediaPaneParams,\n-                                   RelativeLayout questionTextPane, boolean showImageAboveText) {\n-        RelativeLayout.LayoutParams questionTextPaneParams =\n-                new RelativeLayout.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT);\n-        if (mediaPane != null) {\n-            if (viewText.getVisibility() == GONE) {\n-                this.addView(questionTextPane, questionTextPaneParams);\n-                if (audioButton != null) {\n-                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR1) {\n-                        mediaPaneParams.addRule(RelativeLayout.START_OF, audioButton.getId());\n-                    } else {\n-                        mediaPaneParams.addRule(RelativeLayout.LEFT_OF, audioButton.getId());\n-                    }\n-                    questionTextPane.addView(mediaPane, mediaPaneParams);\n-                }\n-                if (videoButton != null) {\n-                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR1) {\n-                        mediaPaneParams.addRule(RelativeLayout.START_OF, videoButton.getId());\n-                    } else {\n-                        mediaPaneParams.addRule(RelativeLayout.LEFT_OF, videoButton.getId());\n-                    }\n-                    questionTextPane.addView(mediaPane, mediaPaneParams);\n-                }\n-            } else {\n-                if (showImageAboveText) {\n-                    mediaPaneParams.addRule(CENTER_HORIZONTAL);\n-                    this.addView(mediaPane, mediaPaneParams);\n-                    questionTextPaneParams.addRule(RelativeLayout.BELOW, mediaPane.getId());\n-                    this.addView(questionTextPane, questionTextPaneParams);\n-                } else {\n-                    this.addView(questionTextPane, questionTextPaneParams);\n-                    mediaPaneParams.addRule(RelativeLayout.BELOW, questionTextPane.getId());\n-                    mediaPaneParams.addRule(CENTER_HORIZONTAL);\n-                    this.addView(mediaPane, mediaPaneParams);\n-                }\n-            }\n-        } else {\n-            this.addView(questionTextPane, questionTextPaneParams);\n+            showMissingMediaView(imageURI, \"Invalid reference: \" + e.getReferenceString(), false, null);\n         }\n     }\n \n-    @SuppressWarnings(\"deprecation\")\n-    private int getScreenMinimumDimension() {\n-        Display display =\n-                ((WindowManager)getContext().getSystemService(Context.WINDOW_SERVICE))\n-                        .getDefaultDisplay();\n-\n-        int width, height;\n-        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.HONEYCOMB_MR2) {\n-            width = display.getWidth();\n-            height = display.getHeight();\n-        } else {\n-            Point screenDims = new Point();\n-            display.getSize(screenDims);\n-            width = screenDims.x;\n-            height = screenDims.y;\n-        }\n-\n-        return Math.min(width, height);\n-    }\n-\n-    /**\n-     * Creates a video view for the provided URI or an error view elaborating why the video\n-     * couldn't be displayed.\n-     *\n-     * @param inlineVideoURI   JavaRosa Reference URI\n-     * @param viewLayoutParams the layout params that will be applied to the view. Expect to be\n-     *                         mutated by this method\n-     */\n-    private View getInlineVideoView(String inlineVideoURI, RelativeLayout.LayoutParams viewLayoutParams) {\n+    private void setupInlineVideoView(String inlineVideoURI) {\n         try {\n             final String videoFilename = ReferenceManager.instance().DeriveReference(inlineVideoURI).getLocalURI();\n-\n-            int[] maxBounds = getMaxCenterViewBounds();\n-\n             final File videoFile = new File(videoFilename);\n             if (!videoFile.exists()) {\n-                return getMissingMediaView(inlineVideoURI,\n+                showMissingMediaView(inlineVideoURI,\n                         StringUtils.getStringRobust(getContext(), R.string.video_download_prompt),\n-                        true);\n+                        true,\n+                        () -> {\n+                            hideMissingMediaView();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf"}, "originalPosition": 507}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MDM3NjEzOnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/views/media/MediaLayout.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QyMDowNjozM1rOHQ_Aag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QyMDowNjozM1rOHQ_Aag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MTU2Mg==", "bodyText": "this method can be avoided by setting the initial visibility of all views as gone in xml layout itself.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487571562", "createdAt": "2020-09-13T20:06:33Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -541,49 +416,39 @@ private boolean useResizingImageView() {\n                         || \"width\".equals(ResizingImageView.resizeMethod));\n     }\n \n-    /**\n-     * @return The appropriate max size of an image view pane in this widget. returned as an int\n-     * array of [width, height]\n-     */\n-    private int[] getMaxCenterViewBounds() {\n-        DisplayMetrics metrics = this.getContext().getResources().getDisplayMetrics();\n-        int maxWidth = metrics.widthPixels;\n-        int maxHeight = metrics.heightPixels;\n-\n-        // subtract height for textview and buttons, if present\n-        if (viewText != null) {\n-            maxHeight = maxHeight - viewText.getHeight();\n-        }\n-        if (videoButton != null) {\n-            maxHeight = maxHeight - videoButton.getHeight();\n-        } else if (audioButton != null) {\n-            maxHeight = maxHeight - audioButton.getHeight();\n-        }\n-\n-        // reduce by third for safety\n-        return new int[]{maxWidth, (2 * maxHeight) / 3};\n+    private void initView(Context context) {\n+        View view = LayoutInflater.from(context).inflate(R.layout.media_layout, this);\n+        audioButton = view.findViewById(R.id.audio_button);\n+        videoButton = view.findViewById(R.id.video_button);\n+        textViewContainer = view.findViewById(R.id.question_text_container);\n+        videoView = view.findViewById(R.id.inline_video_view);\n+        qrView = view.findViewById(R.id.qr_view);\n+        imageView = view.findViewById(R.id.image);\n+        resizingImageView = view.findViewById(R.id.resizing_image);\n+        downloadIcon = view.findViewById(R.id.download_media_icon);\n+        progressBar = view.findViewById(R.id.progress_bar);\n+        missingMediaText = view.findViewById(R.id.missing_media_tv);\n+        divider = view.findViewById(R.id.divider);\n+        mediaLayoutBottomBarrier = view.findViewById(R.id.media_barrier);\n+        missingMediaBackground = view.findViewById(R.id.missing_media_background);\n+\n+        resetView();\n     }\n \n-    /**\n-     * This adds a divider at the bottom of this layout. Used to separate\n-     * fields in lists.\n-     */\n-    public void addDivider(ImageView v) {\n-        RelativeLayout.LayoutParams dividerParams =\n-                new RelativeLayout.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT);\n-        if (missingMediaView != null) {\n-            dividerParams.addRule(RelativeLayout.BELOW, missingMediaView.getId());\n-        } else if (videoButton != null) {\n-            dividerParams.addRule(RelativeLayout.BELOW, videoButton.getId());\n-        } else if (audioButton != null) {\n-            dividerParams.addRule(RelativeLayout.BELOW, audioButton.getId());\n-        } else if (viewText != null) {\n-            // No picture\n-            dividerParams.addRule(RelativeLayout.BELOW, viewText.getId());\n-        } else {\n-            Log.e(TAG, \"Tried to add divider to uninitialized ATVWidget\");\n-            return;\n-        }\n-        addView(v, dividerParams);\n+    private void resetView() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6f0688d6004080e8a4de1c3bfe894eeaba43fdf"}, "originalPosition": 721}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MTExOTIxOnYy", "diffSide": "LEFT", "path": "app/src/org/commcare/views/media/MediaLayout.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNjoyMToyOFrOHRFUnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNjozMzo1M1rOHRFn1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NTAzNw==", "bodyText": "confused why did we remove videoButton from here", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487675037", "createdAt": "2020-09-14T06:21:28Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -144,12 +146,12 @@ private void showMediaAboveText() {\n         alignMediaAtTop(qrView);\n         alignMediaAtTop(imageView);\n         alignMediaAtTop(resizingImageView);\n+        alignMediaAtTop(missingMediaBackground);\n         alignMediaAtTop(downloadIcon);\n         alignMediaAtTop(progressBar);\n \n-        // Next align the text, audiobutton and videoButton below mediaView.\n+        // Next align the text, audiobutton below mediaView.\n         alignTextContainerBelowMediaView(audioButton);\n-        alignTextContainerBelowMediaView(videoButton);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a3b33cb329908e7e6cee127a78a7ad6e2c68039"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3OTk1OA==", "bodyText": "videoButton has a constraint which places it below audioButton. So we only need to align audioButton top constraint while shifting it below media view.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487679958", "createdAt": "2020-09-14T06:33:53Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -144,12 +146,12 @@ private void showMediaAboveText() {\n         alignMediaAtTop(qrView);\n         alignMediaAtTop(imageView);\n         alignMediaAtTop(resizingImageView);\n+        alignMediaAtTop(missingMediaBackground);\n         alignMediaAtTop(downloadIcon);\n         alignMediaAtTop(progressBar);\n \n-        // Next align the text, audiobutton and videoButton below mediaView.\n+        // Next align the text, audiobutton below mediaView.\n         alignTextContainerBelowMediaView(audioButton);\n-        alignTextContainerBelowMediaView(videoButton);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NTAzNw=="}, "originalCommit": {"oid": "6a3b33cb329908e7e6cee127a78a7ad6e2c68039"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MTEyMDQyOnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/views/media/MediaLayout.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNjoyMTo1NlrOHRFVUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNjo0NjoyMlrOHRF7Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NTIxNw==", "bodyText": "why is this required ?", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487675217", "createdAt": "2020-09-14T06:21:56Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -417,6 +426,7 @@ private boolean useResizingImageView() {\n     }\n \n     private void initView(Context context) {\n+        setId(AndroidUtil.generateViewId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a3b33cb329908e7e6cee127a78a7ad6e2c68039"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3OTYxNA==", "bodyText": "If not set, this.getId() call above returns -1 which is the same as LayoutParams.UNSET.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487679614", "createdAt": "2020-09-14T06:32:50Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -417,6 +426,7 @@ private boolean useResizingImageView() {\n     }\n \n     private void initView(Context context) {\n+        setId(AndroidUtil.generateViewId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NTIxNw=="}, "originalCommit": {"oid": "6a3b33cb329908e7e6cee127a78a7ad6e2c68039"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4NDk1OQ==", "bodyText": "Ahh Makes sense.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487684959", "createdAt": "2020-09-14T06:46:22Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -417,6 +426,7 @@ private boolean useResizingImageView() {\n     }\n \n     private void initView(Context context) {\n+        setId(AndroidUtil.generateViewId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3NTIxNw=="}, "originalCommit": {"oid": "6a3b33cb329908e7e6cee127a78a7ad6e2c68039"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MTMzMTMwOnYy", "diffSide": "RIGHT", "path": "app/res/layout/media_layout.xml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNzozMzoxM1rOHRHRkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNzozNjoxN1rOHRHXwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcwNzAyNg==", "bodyText": "tools:visibility should be visible while keeping the android:visibility as gone", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487707026", "createdAt": "2020-09-14T07:33:13Z", "author": {"login": "shubham1g5"}, "path": "app/res/layout/media_layout.xml", "diffHunk": "@@ -1,12 +1,21 @@\n <?xml version=\"1.0\" encoding=\"utf-8\"?>\n <merge xmlns:android=\"http://schemas.android.com/apk/res/android\"\n-    xmlns:app=\"http://schemas.android.com/apk/res-auto\">\n+    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n+    xmlns:tools=\"http://schemas.android.com/tools\">\n+\n+    <!-- Used to place media views to the top of the layout. -->\n+    <androidx.constraintlayout.widget.Guideline\n+        android:id=\"@+id/top_guideline\"\n+        android:layout_width=\"wrap_content\"\n+        android:layout_height=\"wrap_content\"\n+        android:orientation=\"horizontal\"\n+        app:layout_constraintGuide_begin=\"0dp\"/>\n \n     <org.commcare.views.media.AudioPlaybackButton\n         android:id=\"@+id/audio_button\"\n         android:layout_width=\"wrap_content\"\n         android:layout_height=\"wrap_content\"\n-        android:visibility=\"gone\"\n+        tools:visibility=\"gone\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdf4d3896e6310b2525523cf444f87177b387ae7"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcwODYwOA==", "bodyText": "Ahh Damn, silly me! I thought it behaves the same as android:visibility", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487708608", "createdAt": "2020-09-14T07:36:17Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/res/layout/media_layout.xml", "diffHunk": "@@ -1,12 +1,21 @@\n <?xml version=\"1.0\" encoding=\"utf-8\"?>\n <merge xmlns:android=\"http://schemas.android.com/apk/res/android\"\n-    xmlns:app=\"http://schemas.android.com/apk/res-auto\">\n+    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\n+    xmlns:tools=\"http://schemas.android.com/tools\">\n+\n+    <!-- Used to place media views to the top of the layout. -->\n+    <androidx.constraintlayout.widget.Guideline\n+        android:id=\"@+id/top_guideline\"\n+        android:layout_width=\"wrap_content\"\n+        android:layout_height=\"wrap_content\"\n+        android:orientation=\"horizontal\"\n+        app:layout_constraintGuide_begin=\"0dp\"/>\n \n     <org.commcare.views.media.AudioPlaybackButton\n         android:id=\"@+id/audio_button\"\n         android:layout_width=\"wrap_content\"\n         android:layout_height=\"wrap_content\"\n-        android:visibility=\"gone\"\n+        tools:visibility=\"gone\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcwNzAyNg=="}, "originalCommit": {"oid": "fdf4d3896e6310b2525523cf444f87177b387ae7"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MTM1MzYxOnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/views/media/MediaLayout.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNzozOToxMVrOHRHeuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNzozOToxMVrOHRHeuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcxMDM5NQ==", "bodyText": "this seems ununsed and can be removed.", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487710395", "createdAt": "2020-09-14T07:39:11Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -40,54 +44,46 @@\n import org.commcare.views.ViewUtil;\n import org.javarosa.core.reference.InvalidReferenceException;\n import org.javarosa.core.reference.ReferenceManager;\n+import org.javarosa.core.services.locale.Localization;\n \n import java.io.File;\n \n-import androidx.annotation.IdRes;\n-\n /**\n- * This layout is used anywhere we can have image/audio/video/text.\n- * TODO: Put this in a layout file!!!!\n- *\n- * @author carlhartung\n+ * @author $|-|!\u02c5@M\n  */\n-public class MediaLayout extends RelativeLayout {\n-    private static final String TAG = MediaLayout.class.getSimpleName();\n-\n-    @IdRes\n-    public static final int INLINE_VIDEO_PANE_ID = 99999;\n-\n-    @IdRes\n-    private static final int QUESTION_TEXT_PANE_ID = 2342134;\n-\n-    @IdRes\n-    private static final int AUDIO_BUTTON_ID = 3245345;\n-\n-    @IdRes\n-    private static final int VIDEO_BUTTON_ID = 234982340;\n-\n-    @IdRes\n-    private static final int IMAGE_VIEW_ID = 23423534;\n+public class MediaLayout extends ConstraintLayout {\n \n+    private static final String TAG = MediaLayout.class.getSimpleName();\n     private static final String IMAGE_GIF_EXTENSION = \".gif\";\n \n-    private TextView viewText;\n     private AudioPlaybackButton audioButton;\n     private ImageButton videoButton;\n-    private View missingMediaView;\n-    private String mInlineVideoUri;\n-    private String mImageURI;\n-    private String mBigImageURI;\n-    private String mQrCodeContent;\n-    private RelativeLayout mediaPane;\n-\n-    private MediaLayout(Context c) {\n-        super(c);\n-\n-        viewText = null;\n-        audioButton = null;\n-        missingMediaView = null;\n-        videoButton = null;\n+    private FrameLayout textViewContainer;\n+    private CommCareVideoView videoView;\n+    private ImageView qrView;\n+    private ImageView imageView;\n+    private ResizingImageView resizingImageView;\n+    private ImageView downloadIcon;\n+    private ProgressBar progressBar;\n+    private TextView missingMediaStatus;\n+    private ImageView divider;\n+    private Barrier mediaLayoutBottomBarrier;\n+    private View missingMediaBackground;\n+    private Barrier questionBottomBarrier;\n+\n+    public MediaLayout(@NonNull Context context) {\n+        super(context);\n+        initView(context);\n+    }\n+\n+    public MediaLayout(@NonNull Context context, @Nullable AttributeSet attrs) {\n+        super(context, attrs);\n+        initView(context);\n+    }\n+\n+    public MediaLayout(@NonNull Context context, @Nullable AttributeSet attrs, int defStyleAttr) {\n+        super(context, attrs, defStyleAttr);\n+        initView(context);\n     }\n \n     public static MediaLayout buildAudioImageLayout(Context context, TextView text, String audioURI, String imageURI) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdf4d3896e6310b2525523cf444f87177b387ae7"}, "originalPosition": 112}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MTM3MzQ1OnYy", "diffSide": "RIGHT", "path": "app/src/org/commcare/views/media/MediaLayout.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNzo0Mzo1NlrOHRHqbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNzo0Mzo1NlrOHRHqbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcxMzM5MQ==", "bodyText": "Wondering if it's possible to avoid multiple calls of alignTextContainerBelowMediaView as well and instead use barrier/guideline mechanism to shift these views ?", "url": "https://github.com/dimagi/commcare-android/pull/2336#discussion_r487713391", "createdAt": "2020-09-14T07:43:56Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -114,69 +110,75 @@ public static MediaLayout buildComprehensiveLayout(Context context,\n         return mediaLayout;\n     }\n \n+    public void addDivider() {\n+        divider.setVisibility(VISIBLE);\n+    }\n+\n+    //region private helpers\n+\n     private void setAVT(TextView text, String audioURI, String imageURI,\n                         final String videoURI, final String bigImageURI,\n                         final String qrCodeContent, String inlineVideoURI,\n                         boolean showImageAboveText,\n                         int questionIndex) {\n-        viewText = text;\n-        mInlineVideoUri = inlineVideoURI;\n-        mImageURI = imageURI;\n-        mBigImageURI = bigImageURI;\n-        mQrCodeContent = qrCodeContent;\n-\n-        RelativeLayout questionTextPane = new RelativeLayout(this.getContext());\n-        questionTextPane.setId(QUESTION_TEXT_PANE_ID);\n-\n         setupStandardAudio(audioURI, questionIndex);\n         setupVideoButton(videoURI);\n \n-        // Now set up the center view -- it is either an image, a QR Code, an inline video, or\n-        // expanded audio\n-        mediaPane = new RelativeLayout(getContext());\n+        // We only show one of the inline-video-view / qrview / image\n+        if (inlineVideoURI != null) {\n+            setupInlineVideoView(inlineVideoURI);\n+        } else if (qrCodeContent != null) {\n+            setupQRView(qrCodeContent);\n+        } else if (imageURI != null) {\n+            setupImage(imageURI, bigImageURI);\n+        }\n+\n+        addTextView(text);\n+        if (showImageAboveText || DeveloperPreferences.imageAboveTextEnabled()) {\n+            showMediaAboveText();\n+        }\n+    }\n+\n+    private void showMediaAboveText() {\n+        // This step will change the layout constraints of the views in xml to shift\n+        // media(video, image qr ) above text.\n \n-        LayoutParams mediaPaneParams = refreshMediaView();\n+        // Change the questionBottomBarrier to align at the top of parent which would automatically\n+        // align the mediaViews(including missing media view) to the top.\n+        questionBottomBarrier.setReferencedIds(new int[]{ R.id.top_guideline });\n \n-        addAudioVideoButtonsToView(questionTextPane);\n+        // Next align the text, audiobutton below mediaView.\n+        alignTextContainerBelowMediaView(audioButton);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e25e598d5559f1080d536eb556cbabdb0bffcbf4"}, "originalPosition": 169}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3144, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}