{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMjQzMDMx", "number": 2353, "title": "Lazy Media fixes", "bodyText": "https://dimagi-dev.atlassian.net/browse/QA-1906 - was happening because of a NPE on mResourceInProgressListener which was getting set to null on a background thread and later on accessed on UI thread without null check.\n\n\nhttps://dimagi-dev.atlassian.net/browse/QA-1915 - Error message correction\n\n\nEarlier the recoverResource which gets fired by both background worker and the foreground download was invoking the UI thread to notify the listener. This logic is now moved to the downloadResource which is invoked by foreground download process only to avoid the background worker suspending because of unavailablity of the main thread.", "createdAt": "2020-09-21T11:58:41Z", "url": "https://github.com/dimagi/commcare-android/pull/2353", "merged": true, "mergeCommit": {"oid": "3015ea1b40243d0df3aeae61adb49caeaa395c62"}, "closed": true, "closedAt": "2020-09-21T21:17:49Z", "author": {"login": "shubham1g5"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdK2IYDAH2gAyNDkwMjQzMDMxOjEwMDM4MmYxMTY1OThiZTFlYWI2Y2ZjYThmNzc2NGMzZjBmZjIwNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLJZZIgH2gAyNDkwMjQzMDMxOjA2N2M0YTIzOTdiM2IyN2IxNzM3OTc1OGU1MTJiZWFlYWJmZTg4MDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "100382f116598be1eab6cfca8f7764c3f0ff2040", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/100382f116598be1eab6cfca8f7764c3f0ff2040", "committedDate": "2020-09-20T22:00:30Z", "message": "Removes saving state for listeners as it can be overwritten by future media requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d305e0d0521be27727aa5bb4685f9f2c186f8c2c", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/d305e0d0521be27727aa5bb4685f9f2c186f8c2c", "committedDate": "2020-09-20T22:26:07Z", "message": "Adds back media listener and corrects listener reset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ab21c97d16275f0ac8646af66338393267d52dd", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/8ab21c97d16275f0ac8646af66338393267d52dd", "committedDate": "2020-09-20T22:34:58Z", "message": "Displays contextual error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a6f8dbe1b326637c60c431127d35419abe51561", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/4a6f8dbe1b326637c60c431127d35419abe51561", "committedDate": "2020-09-20T22:36:01Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d4fea3903facc5b689d90b6c1033f272e634bc3", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/9d4fea3903facc5b689d90b6c1033f272e634bc3", "committedDate": "2020-09-20T23:15:07Z", "message": "cancels background work on scheduling foreground download"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ab5a0c74db4d05b8b66146ff8b7f7afe2e0564d", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/1ab5a0c74db4d05b8b66146ff8b7f7afe2e0564d", "committedDate": "2020-09-21T11:30:23Z", "message": "Revert \"cancels background work on scheduling foreground download\"\n\nThis reverts commit 9d4fea3903facc5b689d90b6c1033f272e634bc3."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efd6f2caf776cf43e306787eae9d8b71d4672958", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/efd6f2caf776cf43e306787eae9d8b71d4672958", "committedDate": "2020-09-21T11:31:06Z", "message": "Moves the listener notify to download Resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74ea61074765f5454abd5973436f51196aa8266b", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/74ea61074765f5454abd5973436f51196aa8266b", "committedDate": "2020-09-21T11:58:41Z", "message": "reverts invalidate call as it's not required"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNTI1NTI5", "url": "https://github.com/dimagi/commcare-android/pull/2353#pullrequestreview-492525529", "createdAt": "2020-09-21T12:00:37Z", "commit": {"oid": "74ea61074765f5454abd5973436f51196aa8266b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjowMDozOFrOHVMmzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjowMDozOFrOHVMmzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4ODY4Nw==", "bodyText": "any vars which are shared between thread should be marked as volatile to ensure that the writes to these are published to all threads immediately", "url": "https://github.com/dimagi/commcare-android/pull/2353#discussion_r491988687", "createdAt": "2020-09-21T12:00:38Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/mediadownload/MissingMediaDownloadHelper.kt", "diffHunk": "@@ -10,27 +10,29 @@ import org.commcare.engine.resource.AndroidResourceUtils\n import org.commcare.engine.resource.AppInstallStatus\n import org.commcare.engine.resource.ResourceInstallUtils\n import org.commcare.engine.resource.installers.LocalStorageUnavailableException\n-import org.commcare.preferences.HiddenPreferences\n-import org.commcare.resources.model.*\n import org.commcare.network.RequestStats\n+import org.commcare.preferences.HiddenPreferences\n import org.commcare.resources.ResourceInstallContext\n+import org.commcare.resources.model.*\n import org.commcare.tasks.ResultAndError\n-import org.commcare.util.LogTypes\n import org.commcare.utils.AndroidCommCarePlatform\n import org.commcare.utils.FileUtil\n import org.commcare.utils.StringUtils\n import org.commcare.views.dialogs.PinnedNotificationWithProgress\n import org.commcare.views.notifications.NotificationMessage\n import org.commcare.views.notifications.NotificationMessageFactory\n import org.javarosa.core.services.Logger\n-import java.lang.Exception\n import java.util.concurrent.TimeUnit\n \n // Contains helper functions to download lazy or missing media resources\n object MissingMediaDownloadHelper : TableStateListener {\n \n+    @Volatile\n     private var mResourceInProgressListener: MissingMediaDownloadListener? = null\n+\n+    @Volatile\n     private var resourceInProgress: Resource? = null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ea61074765f5454abd5973436f51196aa8266b"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNTYxMDA0", "url": "https://github.com/dimagi/commcare-android/pull/2353#pullrequestreview-492561004", "createdAt": "2020-09-21T12:43:07Z", "commit": {"oid": "74ea61074765f5454abd5973436f51196aa8266b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjo0MzowN1rOHVOHiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjo0MzowN1rOHVOHiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAxMzQ1MQ==", "bodyText": "https://dimagi-dev.atlassian.net/browse/QA-1915", "url": "https://github.com/dimagi/commcare-android/pull/2353#discussion_r492013451", "createdAt": "2020-09-21T12:43:07Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/views/media/MediaLayout.java", "diffHunk": "@@ -378,7 +378,7 @@ private void showMissingMediaView(String mediaUri, String errorMessage, boolean\n                     progressBar.setVisibility(GONE);\n                     downloadIcon.setVisibility(VISIBLE);\n                     downloadIcon.setEnabled(true);\n-                    missingMediaStatus.setText(StringUtils.getStringRobust(getContext(), R.string.media_download_failed));\n+                    missingMediaStatus.setText(result.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ea61074765f5454abd5973436f51196aa8266b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNTc0NjU1", "url": "https://github.com/dimagi/commcare-android/pull/2353#pullrequestreview-492574655", "createdAt": "2020-09-21T12:59:37Z", "commit": {"oid": "74ea61074765f5454abd5973436f51196aa8266b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "067c4a2397b3b27b17379758e512beaeabfe8806", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/067c4a2397b3b27b17379758e512beaeabfe8806", "committedDate": "2020-09-21T20:27:17Z", "message": "Run coroutine tests on test dispatcher"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1940, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}