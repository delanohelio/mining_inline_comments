{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMTUzNTE4", "number": 2216, "title": "Add support for in-app updates", "bodyText": "cross-request: dimagi/commcare-core#890\nJira: https://dimagi-dev.atlassian.net/browse/SAAS-10750\nHere is the google doc explaining the exact steps you need to follow to test it out.\nProduct Note: Adds supprt for updating CommCare from inside CommCare [Wiki]", "createdAt": "2020-04-11T07:29:04Z", "url": "https://github.com/dimagi/commcare-android/pull/2216", "merged": true, "mergeCommit": {"oid": "dcbe09ad4bfe42fef8448dabc03941c3156d4a64"}, "closed": true, "closedAt": "2020-04-24T05:44:56Z", "author": {"login": "ShivamPokhriyal"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWgjKTgH2gAyNDAyMTUzNTE4OmQzYmY4Y2M3MTI3ZThhMTM1MmY1NzQyYzRlMWZiNGIyMmFjMmMzODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcagSKlgFqTM5OTMxODE4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d3bf8cc7127e8a1352f5742c4e1fb4b22ac2c384", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/d3bf8cc7127e8a1352f5742c4e1fb4b22ac2c384", "committedDate": "2020-04-11T07:27:47Z", "message": "Add initial code for in-app updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e5b997c7794e8425ada0d3544706a4258f28301", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/6e5b997c7794e8425ada0d3544706a4258f28301", "committedDate": "2020-04-12T05:23:21Z", "message": "Check for updates in home activity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxOTY2NTQ3", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-391966547", "createdAt": "2020-04-13T05:38:40Z", "commit": {"oid": "6e5b997c7794e8425ada0d3544706a4258f28301"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwNTozODo0MFrOGEdRSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwNTozODo0MFrOGEdRSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzMyNzA0OA==", "bodyText": "Only using flexbile update type here cuz as per this issue it's upto developer to choose the type of update.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r407327048", "createdAt": "2020-04-13T05:38:40Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/appupdate/AppUpdateControllerFactory.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package org.commcare.appupdate;\n+\n+import android.content.Context;\n+import com.google.android.play.core.appupdate.AppUpdateManagerFactory;\n+\n+/**\n+ * A factory that creates {@link AppUpdateController} instance.\n+ * @author $|-|!\u02c5@M\n+ */\n+public class AppUpdateControllerFactory {\n+\n+    /**\n+     * @param callback {@link Runnable} to notify when there is a change in update state.\n+     * @param context Application context of app.\n+     * @return A new {@link FlexibleAppUpdateController} to use for in-app updates\n+     */\n+    public static FlexibleAppUpdateController create(Runnable callback, Context context) {\n+        // TODO: Should we check in-app update is enabled and return a demo or full operational controller?\n+        return new CommcareFlexibleAppUpdateManager(callback, AppUpdateManagerFactory.create(context));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e5b997c7794e8425ada0d3544706a4258f28301"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e99511d2514da7335925ced1410657b576c71e0", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/6e99511d2514da7335925ced1410657b576c71e0", "committedDate": "2020-04-13T10:48:28Z", "message": "Update docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c95951fd1022749428761204c0f151af6260bc2", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/4c95951fd1022749428761204c0f151af6260bc2", "committedDate": "2020-04-17T10:14:06Z", "message": "Use dummy app updator for pre android 5 devices"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzMzMzkz", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395333393", "createdAt": "2020-04-17T10:16:13Z", "commit": {"oid": "4c95951fd1022749428761204c0f151af6260bc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDoxNjoxM1rOGHIV_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDoxNjoxM1rOGHIV_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEyOTkxNw==", "bodyText": "I think it's a good idea to avoid asking users to update CommCare to a specific version if they deny installing the update", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410129917", "createdAt": "2020-04-17T10:16:13Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/activities/StandardHomeActivity.java", "diffHunk": "@@ -246,5 +263,60 @@ public boolean usesSubmissionProgressBar() {\n     public void refreshUI() {\n         uiController.refreshView();\n     }\n-    \n+\n+    @Override\n+    protected void onDestroy() {\n+        appUpdateController.unregister();\n+        super.onDestroy();\n+    }\n+\n+    private void handleAppUpdate() {\n+        AppUpdateState state = appUpdateController.getStatus();\n+        switch (state) {\n+            case UNAVAILABLE:\n+                break;\n+            case AVAILABLE:\n+                StandardAlertDialog alertDialog = StandardAlertDialog.getBasicAlertDialog(this,\n+                        Localization.get(\"in.app.update.available.title\"),\n+                        Localization.get(\"in.app.update.available.detail\"),\n+                        null);\n+                alertDialog.setPositiveButton(Localization.get(\"in.app.update.dialog.update\"), (dialog, which) -> {\n+                    appUpdateController.startUpdate(StandardHomeActivity.this);\n+                    dismissAlertDialog();\n+                });\n+                alertDialog.setNegativeButton(Localization.get(\"in.app.update.dialog.no.thanks\"), (dialog, which) -> {\n+                    appUpdateController.skipVersion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c95951fd1022749428761204c0f151af6260bc2"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzM0NzAw", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395334700", "createdAt": "2020-04-17T10:18:21Z", "commit": {"oid": "4c95951fd1022749428761204c0f151af6260bc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDoxODoyMVrOGHIZ5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDoxODoyMVrOGHIZ5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzMDkxOA==", "bodyText": "This comment seems to suggest that it's up to the developer to start an Immediate or Flexible update.\nSo only using the Flexible update controller here.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410130918", "createdAt": "2020-04-17T10:18:21Z", "author": {"login": "ShivamPokhriyal"}, "path": "app/src/org/commcare/appupdate/FlexibleAppUpdateController.java", "diffHunk": "@@ -0,0 +1,19 @@\n+package org.commcare.appupdate;\n+\n+import com.google.android.play.core.install.InstallStateUpdatedListener;\n+\n+/**\n+ * Helper for monitoring flexible app updates using playstore AppUpdateManager.\n+ * @author $|-|!\u02c5@M\n+ */\n+public interface FlexibleAppUpdateController extends AppUpdateController, InstallStateUpdatedListener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c95951fd1022749428761204c0f151af6260bc2"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93e70a0a7c43d3a036fbb80f2a0a75125aa30bee", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/93e70a0a7c43d3a036fbb80f2a0a75125aa30bee", "committedDate": "2020-04-17T10:48:29Z", "message": "Restrict repeated checking of in-app update in a day"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/63e850ba4d705e09975657d59ff5a8d209322f81", "committedDate": "2020-04-17T13:59:57Z", "message": "Fix failing tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTM4NTM2", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395938536", "createdAt": "2020-04-18T18:22:33Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxODoyMjozM1rOGHtHJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxODoyMjozM1rOGHtHJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczMjMyNw==", "bodyText": "the word \"app\" can be mistaken for the CommCare app that the user has installed on top of CommCare and therefore saying \"app update\" can confuse users in terms of what kind of update it is. We should strictly use word \"CommCare\" instead of saying \"app\" in all the user facing translations here.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410732327", "createdAt": "2020-04-18T18:22:33Z", "author": {"login": "shubham1g5"}, "path": "app/assets/locales/android_translatable_strings.txt", "diffHunk": "@@ -857,4 +857,17 @@ quarantine.reason.server.processing=The server failed to process the form\n quarantine.reason.record.error=There was an issue with the form record that prevented submission\r\n quarantine.reason.manual=The form was manually quarantined by a user\r\n quarantine.reason.fnf=The file backing the form submission could not be found\r\n-quarantine.reason.unknown=Reason for quarantine unknown\n\\ No newline at end of file\n+quarantine.reason.unknown=Reason for quarantine unknown\r\n+\r\n+in.app.update.available.title=Update CommCare?\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTM4NTcy", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395938572", "createdAt": "2020-04-18T18:22:57Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxODoyMjo1N1rOGHtHUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxODoyMjo1N1rOGHtHUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczMjM2OA==", "bodyText": "Downloading CommCare Update", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410732368", "createdAt": "2020-04-18T18:22:57Z", "author": {"login": "shubham1g5"}, "path": "app/assets/locales/android_translatable_strings.txt", "diffHunk": "@@ -857,4 +857,17 @@ quarantine.reason.server.processing=The server failed to process the form\n quarantine.reason.record.error=There was an issue with the form record that prevented submission\r\n quarantine.reason.manual=The form was manually quarantined by a user\r\n quarantine.reason.fnf=The file backing the form submission could not be found\r\n-quarantine.reason.unknown=Reason for quarantine unknown\n\\ No newline at end of file\n+quarantine.reason.unknown=Reason for quarantine unknown\r\n+\r\n+in.app.update.available.title=Update CommCare?\r\n+in.app.update.available.detail=CommCare recommends that you update to the latest version. You can continue using your app while downloading the update.\r\n+in.app.update.dialog.no.thanks=No thanks!\r\n+in.app.update.dialog.update=Update\r\n+in.app.update.installed.title=Finish Update\r\n+in.app.update.installed.detail=CommCare just downloaded an update. You need to restart your app to finish the installation.\r\n+in.app.update.dialog.cancel=Cancel\r\n+in.app.update.dialog.restart=Restart\r\n+in.app.update.downloading.title=Updating CommCare\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQwOTc0", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395940974", "createdAt": "2020-04-18T18:51:43Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxODo1MTo0NFrOGHtVZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxODo1MTo0NFrOGHtVZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczNTk3NQ==", "bodyText": "Confirming Pending doesn't mean that an app update is available but not downloading ?", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410735975", "createdAt": "2020-04-18T18:51:44Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;\n+    private static final String TAG = CommcareFlexibleAppUpdateManager.class.getName();\n+\n+    private final AppUpdateManager mAppUpdateManager;\n+    private @Nullable AppUpdateInfo mAppUpdateInfo;\n+    private final Runnable mCallback;\n+    private boolean mEnabled;\n+\n+    private @UpdateAvailability int mUpdateAvailability;\n+    private @InstallStatus int mInstallStatus;\n+    private AppUpdateState mAppUpdateState;\n+\n+    private int percentageDownloaded;\n+    private @InstallErrorCode int mInstallErrorCode = InstallErrorCode.NO_ERROR;\n+\n+    /**\n+     * callback {@link Runnable} to notify when update state changes.\n+     */\n+    CommcareFlexibleAppUpdateManager(Runnable callback, AppUpdateManager appUpdateManager) {\n+        this.mCallback = callback;\n+        this.mAppUpdateManager = appUpdateManager;\n+        mAppUpdateState = null;\n+    }\n+\n+    //region AppUpdateController implementation\n+    @Override\n+    public void register() {\n+        mEnabled = true;\n+        mAppUpdateManager.registerListener(this);\n+        fetchAppUpdateInfo();\n+    }\n+\n+    @Override\n+    public void unregister() {\n+        mEnabled = false;\n+        mAppUpdateManager.unregisterListener(this);\n+    }\n+\n+    @Override\n+    public void startUpdate(Activity activity) {\n+        try {\n+            boolean success = mAppUpdateManager.startUpdateFlowForResult(\n+                    mAppUpdateInfo, AppUpdateType.FLEXIBLE, activity, IN_APP_UPDATE_REQUEST_CODE);\n+            if (!success) {\n+                Logger.log(TAG, \"startUpdate|requested update cannot be started\");\n+            }\n+        } catch (IntentSender.SendIntentException exception) {\n+            mInstallStatus = InstallStatus.FAILED;\n+            Logger.log(TAG, \"startUpdate|failed with : \" + exception.getMessage());\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public AppUpdateState getStatus() {\n+        return mAppUpdateState;\n+    }\n+\n+    @Override\n+    public void completeUpdate() {\n+        mAppUpdateManager.completeUpdate()\n+                .addOnSuccessListener(result -> {\n+                    Logger.log(TAG, \"completeUpdate|was successful\");\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    Logger.log(TAG, \"completeUpdate|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Integer getProgress() {\n+        if (mInstallStatus != InstallStatus.DOWNLOADING) {\n+            return null;\n+        }\n+        return percentageDownloaded;\n+    }\n+\n+    @Override\n+    public int getErrorCode() {\n+        return mInstallErrorCode;\n+    }\n+\n+    @Override\n+    public void skipVersion() {\n+        if (mAppUpdateInfo == null) {\n+            return;\n+        }\n+        int currentAvailableVersion = mAppUpdateInfo.availableVersionCode();\n+        HiddenPreferences.skipCommCareVersionForUpdate(currentAvailableVersion);\n+    }\n+\n+    //endregion\n+\n+    @Override\n+    public void onStateUpdate(InstallState state) {\n+        Logger.log(TAG, \"Install state updated with install status: \" + state.installStatus()\n+                + \", and error code: \" + state.installErrorCode());\n+        mInstallErrorCode = state.installErrorCode();\n+        if (state.installStatus() == InstallStatus.DOWNLOADING) {\n+            // TODO: Should be keep on publishing status for showing download percentage.\n+            // From https://stackoverflow.com/a/10415638/6671572\n+            percentageDownloaded = (int) (state.bytesDownloaded() * 100.0 / state.totalBytesToDownload() + 0.5) ;\n+        }\n+        if (mInstallStatus != state.installStatus()) {\n+            mInstallStatus = state.installStatus();\n+            publishStatus();\n+        }\n+    }\n+\n+    //region Private helpers\n+    private void fetchAppUpdateInfo() {\n+        mAppUpdateManager.getAppUpdateInfo()\n+                .addOnSuccessListener(info -> {\n+                    mAppUpdateInfo = info;\n+                    mUpdateAvailability = info.updateAvailability();\n+                    mInstallStatus = info.installStatus();\n+                    Logger.log(TAG, \"fetchAppUpdateInfo|success with UpdateAvailability : \"\n+                            + mUpdateAvailability + \", and InstallStatus : \" + mInstallStatus);\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    mAppUpdateInfo = null;\n+                    mUpdateAvailability = UpdateAvailability.UNKNOWN;\n+                    mInstallStatus = InstallStatus.UNKNOWN;\n+                    Logger.log(TAG, \"fetchAppUpdateInfo|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    /**\n+     * Pings the listener using {@link #mCallback} when there is an update regarding installation state.\n+     */\n+    private void publishStatus() {\n+        if (!mEnabled) {\n+            return;\n+        }\n+        AppUpdateState newState = getAppUpdateState();\n+        if (mAppUpdateState == newState) {\n+            return;\n+        }\n+        Logger.log(TAG, \"Publishing status update to : \" + newState.name() + \", from : \"\n+                + (mAppUpdateState != null ? mAppUpdateState.name() : \"null\"));\n+        mAppUpdateState = newState;\n+        mCallback.run();\n+    }\n+\n+    /**\n+     * Gets {@link AppUpdateState} using {@link #mUpdateAvailability} and {@link #mInstallStatus}\n+     */\n+    private AppUpdateState getAppUpdateState() {\n+        if (mAppUpdateInfo != null && mAppUpdateInfo.availableVersionCode() == HiddenPreferences.getSkippedCommCareUpdateVersion()) {\n+            return AppUpdateState.UNAVAILABLE;\n+        }\n+        AppUpdateState state = AppUpdateState.UNAVAILABLE;\n+        switch (mInstallStatus) {\n+            case InstallStatus.PENDING:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 185}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQzMjgz", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395943283", "createdAt": "2020-04-18T19:18:28Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToxODoyOFrOGHtimw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToxODoyOFrOGHtimw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczOTM1NQ==", "bodyText": "ununsed", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410739355", "createdAt": "2020-04-18T19:18:28Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQzMjkz", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395943293", "createdAt": "2020-04-18T19:18:40Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToxODo0MFrOGHtitw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToxODo0MFrOGHtitw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczOTM4Mw==", "bodyText": "private", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410739383", "createdAt": "2020-04-18T19:18:40Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQzNjM5", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395943639", "createdAt": "2020-04-18T19:23:21Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToyMzoyMVrOGHtkzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToyMzoyMVrOGHtkzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczOTkxOA==", "bodyText": "since this would get repeatedly called in middle of an update download, we should avoid the general log statement here in order to reduce noise.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410739918", "createdAt": "2020-04-18T19:23:21Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;\n+    private static final String TAG = CommcareFlexibleAppUpdateManager.class.getName();\n+\n+    private final AppUpdateManager mAppUpdateManager;\n+    private @Nullable AppUpdateInfo mAppUpdateInfo;\n+    private final Runnable mCallback;\n+    private boolean mEnabled;\n+\n+    private @UpdateAvailability int mUpdateAvailability;\n+    private @InstallStatus int mInstallStatus;\n+    private AppUpdateState mAppUpdateState;\n+\n+    private int percentageDownloaded;\n+    private @InstallErrorCode int mInstallErrorCode = InstallErrorCode.NO_ERROR;\n+\n+    /**\n+     * callback {@link Runnable} to notify when update state changes.\n+     */\n+    CommcareFlexibleAppUpdateManager(Runnable callback, AppUpdateManager appUpdateManager) {\n+        this.mCallback = callback;\n+        this.mAppUpdateManager = appUpdateManager;\n+        mAppUpdateState = null;\n+    }\n+\n+    //region AppUpdateController implementation\n+    @Override\n+    public void register() {\n+        mEnabled = true;\n+        mAppUpdateManager.registerListener(this);\n+        fetchAppUpdateInfo();\n+    }\n+\n+    @Override\n+    public void unregister() {\n+        mEnabled = false;\n+        mAppUpdateManager.unregisterListener(this);\n+    }\n+\n+    @Override\n+    public void startUpdate(Activity activity) {\n+        try {\n+            boolean success = mAppUpdateManager.startUpdateFlowForResult(\n+                    mAppUpdateInfo, AppUpdateType.FLEXIBLE, activity, IN_APP_UPDATE_REQUEST_CODE);\n+            if (!success) {\n+                Logger.log(TAG, \"startUpdate|requested update cannot be started\");\n+            }\n+        } catch (IntentSender.SendIntentException exception) {\n+            mInstallStatus = InstallStatus.FAILED;\n+            Logger.log(TAG, \"startUpdate|failed with : \" + exception.getMessage());\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public AppUpdateState getStatus() {\n+        return mAppUpdateState;\n+    }\n+\n+    @Override\n+    public void completeUpdate() {\n+        mAppUpdateManager.completeUpdate()\n+                .addOnSuccessListener(result -> {\n+                    Logger.log(TAG, \"completeUpdate|was successful\");\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    Logger.log(TAG, \"completeUpdate|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Integer getProgress() {\n+        if (mInstallStatus != InstallStatus.DOWNLOADING) {\n+            return null;\n+        }\n+        return percentageDownloaded;\n+    }\n+\n+    @Override\n+    public int getErrorCode() {\n+        return mInstallErrorCode;\n+    }\n+\n+    @Override\n+    public void skipVersion() {\n+        if (mAppUpdateInfo == null) {\n+            return;\n+        }\n+        int currentAvailableVersion = mAppUpdateInfo.availableVersionCode();\n+        HiddenPreferences.skipCommCareVersionForUpdate(currentAvailableVersion);\n+    }\n+\n+    //endregion\n+\n+    @Override\n+    public void onStateUpdate(InstallState state) {\n+        Logger.log(TAG, \"Install state updated with install status: \" + state.installStatus()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 125}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQzNjkx", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395943691", "createdAt": "2020-04-18T19:24:09Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToyNDowOVrOGHtlPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToyNDowOVrOGHtlPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MDAyOA==", "bodyText": "not sure if todo is still required ?", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410740028", "createdAt": "2020-04-18T19:24:09Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;\n+    private static final String TAG = CommcareFlexibleAppUpdateManager.class.getName();\n+\n+    private final AppUpdateManager mAppUpdateManager;\n+    private @Nullable AppUpdateInfo mAppUpdateInfo;\n+    private final Runnable mCallback;\n+    private boolean mEnabled;\n+\n+    private @UpdateAvailability int mUpdateAvailability;\n+    private @InstallStatus int mInstallStatus;\n+    private AppUpdateState mAppUpdateState;\n+\n+    private int percentageDownloaded;\n+    private @InstallErrorCode int mInstallErrorCode = InstallErrorCode.NO_ERROR;\n+\n+    /**\n+     * callback {@link Runnable} to notify when update state changes.\n+     */\n+    CommcareFlexibleAppUpdateManager(Runnable callback, AppUpdateManager appUpdateManager) {\n+        this.mCallback = callback;\n+        this.mAppUpdateManager = appUpdateManager;\n+        mAppUpdateState = null;\n+    }\n+\n+    //region AppUpdateController implementation\n+    @Override\n+    public void register() {\n+        mEnabled = true;\n+        mAppUpdateManager.registerListener(this);\n+        fetchAppUpdateInfo();\n+    }\n+\n+    @Override\n+    public void unregister() {\n+        mEnabled = false;\n+        mAppUpdateManager.unregisterListener(this);\n+    }\n+\n+    @Override\n+    public void startUpdate(Activity activity) {\n+        try {\n+            boolean success = mAppUpdateManager.startUpdateFlowForResult(\n+                    mAppUpdateInfo, AppUpdateType.FLEXIBLE, activity, IN_APP_UPDATE_REQUEST_CODE);\n+            if (!success) {\n+                Logger.log(TAG, \"startUpdate|requested update cannot be started\");\n+            }\n+        } catch (IntentSender.SendIntentException exception) {\n+            mInstallStatus = InstallStatus.FAILED;\n+            Logger.log(TAG, \"startUpdate|failed with : \" + exception.getMessage());\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public AppUpdateState getStatus() {\n+        return mAppUpdateState;\n+    }\n+\n+    @Override\n+    public void completeUpdate() {\n+        mAppUpdateManager.completeUpdate()\n+                .addOnSuccessListener(result -> {\n+                    Logger.log(TAG, \"completeUpdate|was successful\");\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    Logger.log(TAG, \"completeUpdate|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Integer getProgress() {\n+        if (mInstallStatus != InstallStatus.DOWNLOADING) {\n+            return null;\n+        }\n+        return percentageDownloaded;\n+    }\n+\n+    @Override\n+    public int getErrorCode() {\n+        return mInstallErrorCode;\n+    }\n+\n+    @Override\n+    public void skipVersion() {\n+        if (mAppUpdateInfo == null) {\n+            return;\n+        }\n+        int currentAvailableVersion = mAppUpdateInfo.availableVersionCode();\n+        HiddenPreferences.skipCommCareVersionForUpdate(currentAvailableVersion);\n+    }\n+\n+    //endregion\n+\n+    @Override\n+    public void onStateUpdate(InstallState state) {\n+        Logger.log(TAG, \"Install state updated with install status: \" + state.installStatus()\n+                + \", and error code: \" + state.installErrorCode());\n+        mInstallErrorCode = state.installErrorCode();\n+        if (state.installStatus() == InstallStatus.DOWNLOADING) {\n+            // TODO: Should be keep on publishing status for showing download percentage.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 129}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQ0MDU0", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395944054", "createdAt": "2020-04-18T19:28:56Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToyODo1NlrOGHtnUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToyODo1NlrOGHtnUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MDU2MQ==", "bodyText": "guessing todo can be removed.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410740561", "createdAt": "2020-04-18T19:28:56Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/StandardHomeActivity.java", "diffHunk": "@@ -246,5 +264,63 @@ public boolean usesSubmissionProgressBar() {\n     public void refreshUI() {\n         uiController.refreshView();\n     }\n-    \n+\n+    @Override\n+    protected void onDestroy() {\n+        appUpdateController.unregister();\n+        super.onDestroy();\n+    }\n+\n+    private void handleAppUpdate() {\n+        AppUpdateState state = appUpdateController.getStatus();\n+        switch (state) {\n+            case UNAVAILABLE:\n+                if (ConnectivityStatus.isNetworkAvailable(this)) {\n+                    HiddenPreferences.setLastInAppUpdateCheckTime(System.currentTimeMillis());\n+                }\n+                break;\n+            case AVAILABLE:\n+                StandardAlertDialog alertDialog = StandardAlertDialog.getBasicAlertDialog(this,\n+                        Localization.get(\"in.app.update.available.title\"),\n+                        Localization.get(\"in.app.update.available.detail\"),\n+                        null);\n+                alertDialog.setPositiveButton(Localization.get(\"in.app.update.dialog.update\"), (dialog, which) -> {\n+                    appUpdateController.startUpdate(StandardHomeActivity.this);\n+                    dismissAlertDialog();\n+                });\n+                alertDialog.setNegativeButton(Localization.get(\"in.app.update.dialog.no.thanks\"), (dialog, which) -> {\n+                    appUpdateController.skipVersion();\n+                    dismissAlertDialog();\n+                });\n+                showAlertDialog(alertDialog);\n+                break;\n+            case DOWNLOADING:\n+                // TODO: Should we use appUpdateController's getProgress to show something here?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQ0NDEz", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395944413", "createdAt": "2020-04-18T19:33:49Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTozMzo0OVrOGHtpXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTozMzo0OVrOGHtpXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MTA4NQ==", "bodyText": "Guessing this call to publishStatus() would not do anything as app gets restarted on success and thus listeners won't be active.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410741085", "createdAt": "2020-04-18T19:33:49Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;\n+    private static final String TAG = CommcareFlexibleAppUpdateManager.class.getName();\n+\n+    private final AppUpdateManager mAppUpdateManager;\n+    private @Nullable AppUpdateInfo mAppUpdateInfo;\n+    private final Runnable mCallback;\n+    private boolean mEnabled;\n+\n+    private @UpdateAvailability int mUpdateAvailability;\n+    private @InstallStatus int mInstallStatus;\n+    private AppUpdateState mAppUpdateState;\n+\n+    private int percentageDownloaded;\n+    private @InstallErrorCode int mInstallErrorCode = InstallErrorCode.NO_ERROR;\n+\n+    /**\n+     * callback {@link Runnable} to notify when update state changes.\n+     */\n+    CommcareFlexibleAppUpdateManager(Runnable callback, AppUpdateManager appUpdateManager) {\n+        this.mCallback = callback;\n+        this.mAppUpdateManager = appUpdateManager;\n+        mAppUpdateState = null;\n+    }\n+\n+    //region AppUpdateController implementation\n+    @Override\n+    public void register() {\n+        mEnabled = true;\n+        mAppUpdateManager.registerListener(this);\n+        fetchAppUpdateInfo();\n+    }\n+\n+    @Override\n+    public void unregister() {\n+        mEnabled = false;\n+        mAppUpdateManager.unregisterListener(this);\n+    }\n+\n+    @Override\n+    public void startUpdate(Activity activity) {\n+        try {\n+            boolean success = mAppUpdateManager.startUpdateFlowForResult(\n+                    mAppUpdateInfo, AppUpdateType.FLEXIBLE, activity, IN_APP_UPDATE_REQUEST_CODE);\n+            if (!success) {\n+                Logger.log(TAG, \"startUpdate|requested update cannot be started\");\n+            }\n+        } catch (IntentSender.SendIntentException exception) {\n+            mInstallStatus = InstallStatus.FAILED;\n+            Logger.log(TAG, \"startUpdate|failed with : \" + exception.getMessage());\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public AppUpdateState getStatus() {\n+        return mAppUpdateState;\n+    }\n+\n+    @Override\n+    public void completeUpdate() {\n+        mAppUpdateManager.completeUpdate()\n+                .addOnSuccessListener(result -> {\n+                    Logger.log(TAG, \"completeUpdate|was successful\");\n+                    publishStatus();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQ0NjA5", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395944609", "createdAt": "2020-04-18T19:36:44Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTozNjo0NFrOGHtqdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTozNjo0NFrOGHtqdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MTM2Nw==", "bodyText": "we should move all the in app update code here to the HomeScreenBaseActivity in order to support all different versions of the home activity.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410741367", "createdAt": "2020-04-18T19:36:44Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/StandardHomeActivity.java", "diffHunk": "@@ -44,10 +57,15 @@\n \n     private StandardHomeActivityUIController uiController;\n \n+    private FlexibleAppUpdateController appUpdateController;\n+    private static final String APP_UPDATE_NOTIFICATION = \"app_update_notification\";\n+\n     @Override\n     public void onCreateSessionSafe(Bundle savedInstanceState) {\n         super.onCreateSessionSafe(savedInstanceState);\n         uiController.setupUI();\n+        appUpdateController = AppUpdateControllerFactory.create(this::handleAppUpdate, getApplicationContext());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQ0NjQz", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395944643", "createdAt": "2020-04-18T19:37:12Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTozNzoxM1rOGHtqpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTozNzoxM1rOGHtqpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MTQxNQ==", "bodyText": "it would be great to show error code specific messages to the user and also log it to the sumo if it's not getting logged earlier in the process.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410741415", "createdAt": "2020-04-18T19:37:13Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/StandardHomeActivity.java", "diffHunk": "@@ -246,5 +264,63 @@ public boolean usesSubmissionProgressBar() {\n     public void refreshUI() {\n         uiController.refreshView();\n     }\n-    \n+\n+    @Override\n+    protected void onDestroy() {\n+        appUpdateController.unregister();\n+        super.onDestroy();\n+    }\n+\n+    private void handleAppUpdate() {\n+        AppUpdateState state = appUpdateController.getStatus();\n+        switch (state) {\n+            case UNAVAILABLE:\n+                if (ConnectivityStatus.isNetworkAvailable(this)) {\n+                    HiddenPreferences.setLastInAppUpdateCheckTime(System.currentTimeMillis());\n+                }\n+                break;\n+            case AVAILABLE:\n+                StandardAlertDialog alertDialog = StandardAlertDialog.getBasicAlertDialog(this,\n+                        Localization.get(\"in.app.update.available.title\"),\n+                        Localization.get(\"in.app.update.available.detail\"),\n+                        null);\n+                alertDialog.setPositiveButton(Localization.get(\"in.app.update.dialog.update\"), (dialog, which) -> {\n+                    appUpdateController.startUpdate(StandardHomeActivity.this);\n+                    dismissAlertDialog();\n+                });\n+                alertDialog.setNegativeButton(Localization.get(\"in.app.update.dialog.no.thanks\"), (dialog, which) -> {\n+                    appUpdateController.skipVersion();\n+                    dismissAlertDialog();\n+                });\n+                showAlertDialog(alertDialog);\n+                break;\n+            case DOWNLOADING:\n+                // TODO: Should we use appUpdateController's getProgress to show something here?\n+                // Though native downloads app gives a notification regarding the current download in progress.\n+                NotificationMessage message = NotificationMessageFactory.message(\n+                        NotificationMessageFactory.StockMessages.InApp_Update, APP_UPDATE_NOTIFICATION);\n+                CommCareApplication.notificationManager().reportNotificationMessage(message);\n+                break;\n+            case DOWNLOADED:\n+                CommCareApplication.notificationManager().clearNotifications(APP_UPDATE_NOTIFICATION);\n+                StandardAlertDialog dialog = StandardAlertDialog.getBasicAlertDialog(this,\n+                        Localization.get(\"in.app.update.installed.title\"),\n+                        Localization.get(\"in.app.update.installed.detail\"),\n+                        null);\n+                dialog.setPositiveButton(Localization.get(\"in.app.update.dialog.restart\"), (dialog1, which) -> {\n+                    appUpdateController.completeUpdate();\n+                    dismissAlertDialog();\n+                });\n+                dialog.setNegativeButton(Localization.get(\"in.app.update.dialog.cancel\"), (dialog1, which) -> {\n+                    dismissAlertDialog();\n+                });\n+                showAlertDialog(dialog);\n+                break;\n+            case FAILED:\n+                // TODO: We might wanna use appUpdateController's getErrorCode here.\n+                CommCareApplication.notificationManager().clearNotifications(APP_UPDATE_NOTIFICATION);\n+                Toast.makeText(this, Localization.get(\"in.app.update.failed\"), Toast.LENGTH_LONG).show();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 111}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQ0OTAx", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395944901", "createdAt": "2020-04-18T19:40:41Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTo0MDo0MVrOGHtsLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTo0MDo0MVrOGHtsLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MTgwNA==", "bodyText": "We can omit the success logs here as this will be triggered every time user comes on Home screen.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410741804", "createdAt": "2020-04-18T19:40:41Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;\n+    private static final String TAG = CommcareFlexibleAppUpdateManager.class.getName();\n+\n+    private final AppUpdateManager mAppUpdateManager;\n+    private @Nullable AppUpdateInfo mAppUpdateInfo;\n+    private final Runnable mCallback;\n+    private boolean mEnabled;\n+\n+    private @UpdateAvailability int mUpdateAvailability;\n+    private @InstallStatus int mInstallStatus;\n+    private AppUpdateState mAppUpdateState;\n+\n+    private int percentageDownloaded;\n+    private @InstallErrorCode int mInstallErrorCode = InstallErrorCode.NO_ERROR;\n+\n+    /**\n+     * callback {@link Runnable} to notify when update state changes.\n+     */\n+    CommcareFlexibleAppUpdateManager(Runnable callback, AppUpdateManager appUpdateManager) {\n+        this.mCallback = callback;\n+        this.mAppUpdateManager = appUpdateManager;\n+        mAppUpdateState = null;\n+    }\n+\n+    //region AppUpdateController implementation\n+    @Override\n+    public void register() {\n+        mEnabled = true;\n+        mAppUpdateManager.registerListener(this);\n+        fetchAppUpdateInfo();\n+    }\n+\n+    @Override\n+    public void unregister() {\n+        mEnabled = false;\n+        mAppUpdateManager.unregisterListener(this);\n+    }\n+\n+    @Override\n+    public void startUpdate(Activity activity) {\n+        try {\n+            boolean success = mAppUpdateManager.startUpdateFlowForResult(\n+                    mAppUpdateInfo, AppUpdateType.FLEXIBLE, activity, IN_APP_UPDATE_REQUEST_CODE);\n+            if (!success) {\n+                Logger.log(TAG, \"startUpdate|requested update cannot be started\");\n+            }\n+        } catch (IntentSender.SendIntentException exception) {\n+            mInstallStatus = InstallStatus.FAILED;\n+            Logger.log(TAG, \"startUpdate|failed with : \" + exception.getMessage());\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public AppUpdateState getStatus() {\n+        return mAppUpdateState;\n+    }\n+\n+    @Override\n+    public void completeUpdate() {\n+        mAppUpdateManager.completeUpdate()\n+                .addOnSuccessListener(result -> {\n+                    Logger.log(TAG, \"completeUpdate|was successful\");\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    Logger.log(TAG, \"completeUpdate|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Integer getProgress() {\n+        if (mInstallStatus != InstallStatus.DOWNLOADING) {\n+            return null;\n+        }\n+        return percentageDownloaded;\n+    }\n+\n+    @Override\n+    public int getErrorCode() {\n+        return mInstallErrorCode;\n+    }\n+\n+    @Override\n+    public void skipVersion() {\n+        if (mAppUpdateInfo == null) {\n+            return;\n+        }\n+        int currentAvailableVersion = mAppUpdateInfo.availableVersionCode();\n+        HiddenPreferences.skipCommCareVersionForUpdate(currentAvailableVersion);\n+    }\n+\n+    //endregion\n+\n+    @Override\n+    public void onStateUpdate(InstallState state) {\n+        Logger.log(TAG, \"Install state updated with install status: \" + state.installStatus()\n+                + \", and error code: \" + state.installErrorCode());\n+        mInstallErrorCode = state.installErrorCode();\n+        if (state.installStatus() == InstallStatus.DOWNLOADING) {\n+            // TODO: Should be keep on publishing status for showing download percentage.\n+            // From https://stackoverflow.com/a/10415638/6671572\n+            percentageDownloaded = (int) (state.bytesDownloaded() * 100.0 / state.totalBytesToDownload() + 0.5) ;\n+        }\n+        if (mInstallStatus != state.installStatus()) {\n+            mInstallStatus = state.installStatus();\n+            publishStatus();\n+        }\n+    }\n+\n+    //region Private helpers\n+    private void fetchAppUpdateInfo() {\n+        mAppUpdateManager.getAppUpdateInfo()\n+                .addOnSuccessListener(info -> {\n+                    mAppUpdateInfo = info;\n+                    mUpdateAvailability = info.updateAvailability();\n+                    mInstallStatus = info.installStatus();\n+                    Logger.log(TAG, \"fetchAppUpdateInfo|success with UpdateAvailability : \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 146}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQ1MDQ4", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395945048", "createdAt": "2020-04-18T19:42:55Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTo0Mjo1NVrOGHttBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTo0Mjo1NVrOGHttBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MjAyMQ==", "bodyText": "this should be saved in Global prefs rather than app prefs as it's going to be same across all CommCare apps installed on CommCare.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410742021", "createdAt": "2020-04-18T19:42:55Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/preferences/HiddenPreferences.java", "diffHunk": "@@ -446,4 +448,26 @@ public static void enableBypassPreUpdateSync(boolean enable) {\n     public static boolean shouldBypassPreUpdateSync() {\n         return CommCareApplication.instance().getCurrentApp().getAppPreferences().getBoolean(BYPASS_PRE_UPDATE_SYNC, false);\n     }\n+\n+    public static void skipCommCareVersionForUpdate(int version) {\n+        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n+                .edit()\n+                .putInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, version)\n+                .apply();\n+    }\n+\n+    public static int getSkippedCommCareUpdateVersion() {\n+        return CommCareApplication.instance().getCurrentApp().getAppPreferences().getInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, -1);\n+    }\n+\n+    public static void setLastInAppUpdateCheckTime(long millis) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQ1MDk4", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395945098", "createdAt": "2020-04-18T19:43:35Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTo0MzozNVrOGHttgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOTo0MzozNVrOGHttgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDc0MjE0Nw==", "bodyText": "should be saved in Global prefs instead of app prefs.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r410742147", "createdAt": "2020-04-18T19:43:35Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/preferences/HiddenPreferences.java", "diffHunk": "@@ -446,4 +448,26 @@ public static void enableBypassPreUpdateSync(boolean enable) {\n     public static boolean shouldBypassPreUpdateSync() {\n         return CommCareApplication.instance().getCurrentApp().getAppPreferences().getBoolean(BYPASS_PRE_UPDATE_SYNC, false);\n     }\n+\n+    public static void skipCommCareVersionForUpdate(int version) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQ1NzYw", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-395945760", "createdAt": "2020-04-18T19:53:15Z", "commit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5993933d851894e29c336ac8dfa1e266f14f2dfd", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/5993933d851894e29c336ac8dfa1e266f14f2dfd", "committedDate": "2020-04-20T07:16:11Z", "message": "PR suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9048df5063a6fc9196c6c006586e8bb63daddb4c", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/9048df5063a6fc9196c6c006586e8bb63daddb4c", "committedDate": "2020-04-20T14:59:47Z", "message": "Remove buggy null check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MDE5OTY2", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-397019966", "createdAt": "2020-04-21T06:25:09Z", "commit": {"oid": "9048df5063a6fc9196c6c006586e8bb63daddb4c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwNjoyNTowOVrOGI0mXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwNzowMTo1MFrOGI10HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkwMzU4MA==", "bodyText": "We should make sure that we specifically use \"CommCare update\" instead of \"update\" to avoid confusion with App updates.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411903580", "createdAt": "2020-04-21T06:25:09Z", "author": {"login": "shubham1g5"}, "path": "app/assets/locales/android_translatable_strings.txt", "diffHunk": "@@ -859,15 +860,17 @@ quarantine.reason.manual=The form was manually quarantined by a user\n quarantine.reason.fnf=The file backing the form submission could not be found\r\n quarantine.reason.unknown=Reason for quarantine unknown\r\n \r\n-in.app.update.available.title=Update CommCare?\r\n-in.app.update.available.detail=CommCare recommends that you update to the latest version. You can continue using your app while downloading the update.\r\n-in.app.update.dialog.no.thanks=No thanks!\r\n-in.app.update.dialog.update=Update\r\n in.app.update.installed.title=Finish Update\r\n-in.app.update.installed.detail=CommCare just downloaded an update. You need to restart your app to finish the installation.\r\n+in.app.update.installed.detail=CommCare just downloaded an update. You need to restart CommCare to finish the installation.\r\n in.app.update.dialog.cancel=Cancel\r\n in.app.update.dialog.restart=Restart\r\n-in.app.update.downloading.title=Updating CommCare\r\n-in.app.update.downloading.detail=App update in progress\r\n-in.app.update.downloading.action=CommCare is updating in the background. You can continue using your app while the download completes.\r\n-in.app.update.failed=Couldn't download the update.\n\\ No newline at end of file\n+in.app.update.downloading.title=Downloading CommCare Update\r\n+in.app.update.downloading.detail=CommCare update in progress\r\n+in.app.update.downloading.action=CommCare is updating in the background. You can continue using CommCare while the download completes.\r\n+in.app.update.failed=Couldn't download the update.\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9048df5063a6fc9196c6c006586e8bb63daddb4c"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxNTA4Nw==", "bodyText": "Instead of AppUpdate we should use already available LogTypes as tag. If none of them satsify the particular log, we shoud add to the existing log types and refer it here. Also we should add a prefix like \"Commcare In App Update failed because\" to the log message, this helps us in quickly lookup the log source in code.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411915087", "createdAt": "2020-04-21T06:46:59Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -1280,4 +1303,81 @@ public void setFormAndDataSyncer(FormAndDataSyncer formAndDataSyncer) {\n \n     abstract void refreshUI();\n \n+    abstract void refreshCCUpdateOption();\n+\n+    @Override\n+    protected void onDestroy() {\n+        appUpdateController.unregister();\n+        super.onDestroy();\n+    }\n+\n+    protected void startCommCareUpdate() {\n+        appUpdateController.startUpdate(this);\n+    }\n+\n+    private void handleAppUpdate() {\n+        AppUpdateState state = appUpdateController.getStatus();\n+        switch (state) {\n+            case UNAVAILABLE:\n+                if (ConnectivityStatus.isNetworkAvailable(this)) {\n+                    HiddenPreferences.setLastInAppUpdateCheckTime(System.currentTimeMillis());\n+                }\n+                break;\n+            case AVAILABLE:\n+                if (HiddenPreferences.isCommCareUpdateCancelled(String.valueOf(appUpdateController.availableVersionCode())) > 3) {\n+                    showCommCareUpdateMenu = true;\n+                    refreshCCUpdateOption();\n+                    return;\n+                }\n+                startCommCareUpdate();\n+                break;\n+            case DOWNLOADING:\n+                // Native downloads app gives a notification regarding the current download in progress.\n+                NotificationMessage message = NotificationMessageFactory.message(\n+                        NotificationMessageFactory.StockMessages.InApp_Update, APP_UPDATE_NOTIFICATION);\n+                CommCareApplication.notificationManager().reportNotificationMessage(message);\n+                break;\n+            case DOWNLOADED:\n+                CommCareApplication.notificationManager().clearNotifications(APP_UPDATE_NOTIFICATION);\n+                StandardAlertDialog dialog = StandardAlertDialog.getBasicAlertDialog(this,\n+                        Localization.get(\"in.app.update.installed.title\"),\n+                        Localization.get(\"in.app.update.installed.detail\"),\n+                        null);\n+                dialog.setPositiveButton(Localization.get(\"in.app.update.dialog.restart\"), (dialog1, which) -> {\n+                    appUpdateController.completeUpdate();\n+                    dismissAlertDialog();\n+                });\n+                dialog.setNegativeButton(Localization.get(\"in.app.update.dialog.cancel\"), (dialog1, which) -> {\n+                    dismissAlertDialog();\n+                });\n+                showAlertDialog(dialog);\n+                break;\n+            case FAILED:\n+                String errorReason = \"in.app.update.error.unknown\";\n+                switch (appUpdateController.getErrorCode()) {\n+                    case InstallErrorCode.ERROR_INSTALL_NOT_ALLOWED:\n+                        errorReason = \"in.app.update.error.not.allowed\";\n+                        break;\n+                    case InstallErrorCode.NO_ERROR_PARTIALLY_ALLOWED:\n+                        errorReason = \"in.app.update.error.partially.allowed\";\n+                        break;\n+                    case InstallErrorCode.ERROR_UNKNOWN:\n+                        errorReason = \"in.app.update.error.unknown\";\n+                        break;\n+                    case InstallErrorCode.ERROR_PLAY_STORE_NOT_FOUND:\n+                        errorReason = \"in.app.update.error.playstore\";\n+                        break;\n+                    case InstallErrorCode.ERROR_INVALID_REQUEST:\n+                        errorReason = \"in.app.update.error.invalid.request\";\n+                        break;\n+                    case InstallErrorCode.ERROR_INTERNAL_ERROR:\n+                        errorReason = \"in.app.update.error.internal.error\";\n+                        break;\n+                }\n+                Logger.log(\"AppUpdate\", errorReason);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9048df5063a6fc9196c6c006586e8bb63daddb4c"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxNjEwMw==", "bodyText": "Nit: Should use a constant declaration instead of hardcoding 3", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411916103", "createdAt": "2020-04-21T06:48:52Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/HomeScreenBaseActivity.java", "diffHunk": "@@ -1280,4 +1303,81 @@ public void setFormAndDataSyncer(FormAndDataSyncer formAndDataSyncer) {\n \n     abstract void refreshUI();\n \n+    abstract void refreshCCUpdateOption();\n+\n+    @Override\n+    protected void onDestroy() {\n+        appUpdateController.unregister();\n+        super.onDestroy();\n+    }\n+\n+    protected void startCommCareUpdate() {\n+        appUpdateController.startUpdate(this);\n+    }\n+\n+    private void handleAppUpdate() {\n+        AppUpdateState state = appUpdateController.getStatus();\n+        switch (state) {\n+            case UNAVAILABLE:\n+                if (ConnectivityStatus.isNetworkAvailable(this)) {\n+                    HiddenPreferences.setLastInAppUpdateCheckTime(System.currentTimeMillis());\n+                }\n+                break;\n+            case AVAILABLE:\n+                if (HiddenPreferences.isCommCareUpdateCancelled(String.valueOf(appUpdateController.availableVersionCode())) > 3) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9048df5063a6fc9196c6c006586e8bb63daddb4c"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkyMTE5NA==", "bodyText": "@ShivamPokhriyal  bumping the query.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411921194", "createdAt": "2020-04-21T06:57:43Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/appupdate/CommcareFlexibleAppUpdateManager.java", "diffHunk": "@@ -0,0 +1,206 @@\n+package org.commcare.appupdate;\n+\n+import android.app.Activity;\n+import android.content.IntentSender;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.google.android.play.core.appupdate.AppUpdateInfo;\n+import com.google.android.play.core.appupdate.AppUpdateManager;\n+import com.google.android.play.core.install.InstallState;\n+import com.google.android.play.core.install.model.AppUpdateType;\n+import com.google.android.play.core.install.model.InstallErrorCode;\n+import com.google.android.play.core.install.model.InstallStatus;\n+import com.google.android.play.core.install.model.UpdateAvailability;\n+\n+import org.commcare.CommCareApplication;\n+import org.commcare.preferences.HiddenPreferences;\n+import org.javarosa.core.services.Logger;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * @author $|-|!\u02c5@M\n+ */\n+public class CommcareFlexibleAppUpdateManager implements FlexibleAppUpdateController {\n+\n+    public static final int IN_APP_UPDATE_REQUEST_CODE = 1212;\n+    private static final String TAG = CommcareFlexibleAppUpdateManager.class.getName();\n+\n+    private final AppUpdateManager mAppUpdateManager;\n+    private @Nullable AppUpdateInfo mAppUpdateInfo;\n+    private final Runnable mCallback;\n+    private boolean mEnabled;\n+\n+    private @UpdateAvailability int mUpdateAvailability;\n+    private @InstallStatus int mInstallStatus;\n+    private AppUpdateState mAppUpdateState;\n+\n+    private int percentageDownloaded;\n+    private @InstallErrorCode int mInstallErrorCode = InstallErrorCode.NO_ERROR;\n+\n+    /**\n+     * callback {@link Runnable} to notify when update state changes.\n+     */\n+    CommcareFlexibleAppUpdateManager(Runnable callback, AppUpdateManager appUpdateManager) {\n+        this.mCallback = callback;\n+        this.mAppUpdateManager = appUpdateManager;\n+        mAppUpdateState = null;\n+    }\n+\n+    //region AppUpdateController implementation\n+    @Override\n+    public void register() {\n+        mEnabled = true;\n+        mAppUpdateManager.registerListener(this);\n+        fetchAppUpdateInfo();\n+    }\n+\n+    @Override\n+    public void unregister() {\n+        mEnabled = false;\n+        mAppUpdateManager.unregisterListener(this);\n+    }\n+\n+    @Override\n+    public void startUpdate(Activity activity) {\n+        try {\n+            boolean success = mAppUpdateManager.startUpdateFlowForResult(\n+                    mAppUpdateInfo, AppUpdateType.FLEXIBLE, activity, IN_APP_UPDATE_REQUEST_CODE);\n+            if (!success) {\n+                Logger.log(TAG, \"startUpdate|requested update cannot be started\");\n+            }\n+        } catch (IntentSender.SendIntentException exception) {\n+            mInstallStatus = InstallStatus.FAILED;\n+            Logger.log(TAG, \"startUpdate|failed with : \" + exception.getMessage());\n+        }\n+    }\n+\n+    @NonNull\n+    @Override\n+    public AppUpdateState getStatus() {\n+        return mAppUpdateState;\n+    }\n+\n+    @Override\n+    public void completeUpdate() {\n+        mAppUpdateManager.completeUpdate()\n+                .addOnSuccessListener(result -> {\n+                    Logger.log(TAG, \"completeUpdate|was successful\");\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    Logger.log(TAG, \"completeUpdate|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Integer getProgress() {\n+        if (mInstallStatus != InstallStatus.DOWNLOADING) {\n+            return null;\n+        }\n+        return percentageDownloaded;\n+    }\n+\n+    @Override\n+    public int getErrorCode() {\n+        return mInstallErrorCode;\n+    }\n+\n+    @Override\n+    public void skipVersion() {\n+        if (mAppUpdateInfo == null) {\n+            return;\n+        }\n+        int currentAvailableVersion = mAppUpdateInfo.availableVersionCode();\n+        HiddenPreferences.skipCommCareVersionForUpdate(currentAvailableVersion);\n+    }\n+\n+    //endregion\n+\n+    @Override\n+    public void onStateUpdate(InstallState state) {\n+        Logger.log(TAG, \"Install state updated with install status: \" + state.installStatus()\n+                + \", and error code: \" + state.installErrorCode());\n+        mInstallErrorCode = state.installErrorCode();\n+        if (state.installStatus() == InstallStatus.DOWNLOADING) {\n+            // TODO: Should be keep on publishing status for showing download percentage.\n+            // From https://stackoverflow.com/a/10415638/6671572\n+            percentageDownloaded = (int) (state.bytesDownloaded() * 100.0 / state.totalBytesToDownload() + 0.5) ;\n+        }\n+        if (mInstallStatus != state.installStatus()) {\n+            mInstallStatus = state.installStatus();\n+            publishStatus();\n+        }\n+    }\n+\n+    //region Private helpers\n+    private void fetchAppUpdateInfo() {\n+        mAppUpdateManager.getAppUpdateInfo()\n+                .addOnSuccessListener(info -> {\n+                    mAppUpdateInfo = info;\n+                    mUpdateAvailability = info.updateAvailability();\n+                    mInstallStatus = info.installStatus();\n+                    Logger.log(TAG, \"fetchAppUpdateInfo|success with UpdateAvailability : \"\n+                            + mUpdateAvailability + \", and InstallStatus : \" + mInstallStatus);\n+                    publishStatus();\n+                })\n+                .addOnFailureListener(exception -> {\n+                    mAppUpdateInfo = null;\n+                    mUpdateAvailability = UpdateAvailability.UNKNOWN;\n+                    mInstallStatus = InstallStatus.UNKNOWN;\n+                    Logger.log(TAG, \"fetchAppUpdateInfo|failed with : \" + exception.getMessage());\n+                    publishStatus();\n+                });\n+    }\n+\n+    /**\n+     * Pings the listener using {@link #mCallback} when there is an update regarding installation state.\n+     */\n+    private void publishStatus() {\n+        if (!mEnabled) {\n+            return;\n+        }\n+        AppUpdateState newState = getAppUpdateState();\n+        if (mAppUpdateState == newState) {\n+            return;\n+        }\n+        Logger.log(TAG, \"Publishing status update to : \" + newState.name() + \", from : \"\n+                + (mAppUpdateState != null ? mAppUpdateState.name() : \"null\"));\n+        mAppUpdateState = newState;\n+        mCallback.run();\n+    }\n+\n+    /**\n+     * Gets {@link AppUpdateState} using {@link #mUpdateAvailability} and {@link #mInstallStatus}\n+     */\n+    private AppUpdateState getAppUpdateState() {\n+        if (mAppUpdateInfo != null && mAppUpdateInfo.availableVersionCode() == HiddenPreferences.getSkippedCommCareUpdateVersion()) {\n+            return AppUpdateState.UNAVAILABLE;\n+        }\n+        AppUpdateState state = AppUpdateState.UNAVAILABLE;\n+        switch (mInstallStatus) {\n+            case InstallStatus.PENDING:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczNTk3NQ=="}, "originalCommit": {"oid": "63e850ba4d705e09975657d59ff5a8d209322f81"}, "originalPosition": 185}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkyMjMzNQ==", "bodyText": "Nit: A better function name would be incrementCommCareUpdateCancellationCounter", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411922335", "createdAt": "2020-04-21T06:59:48Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/preferences/HiddenPreferences.java", "diffHunk": "@@ -449,25 +448,25 @@ public static boolean shouldBypassPreUpdateSync() {\n         return CommCareApplication.instance().getCurrentApp().getAppPreferences().getBoolean(BYPASS_PRE_UPDATE_SYNC, false);\n     }\n \n-    public static void skipCommCareVersionForUpdate(int version) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n+    public static void setLastInAppUpdateCheckTime(long millis) {\n+        PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n                 .edit()\n-                .putInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, version)\n+                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n                 .apply();\n     }\n \n-    public static int getSkippedCommCareUpdateVersion() {\n-        return CommCareApplication.instance().getCurrentApp().getAppPreferences().getInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, -1);\n+    public static long getLastInAppUpdateCheckTime() {\n+        return PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n+                .getLong(LAST_IN_APP_UPDATE_CHECK_TIME, -1);\n     }\n \n-    public static void setLastInAppUpdateCheckTime(long millis) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n-                .edit()\n-                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n-                .apply();\n+    public static void cancelCommCareUpdate(String version) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9048df5063a6fc9196c6c006586e8bb63daddb4c"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkyMjc0Mg==", "bodyText": "Nit: function name suggestion: getCommCareUpdateCancellationConter", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411922742", "createdAt": "2020-04-21T07:00:34Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/preferences/HiddenPreferences.java", "diffHunk": "@@ -449,25 +448,25 @@ public static boolean shouldBypassPreUpdateSync() {\n         return CommCareApplication.instance().getCurrentApp().getAppPreferences().getBoolean(BYPASS_PRE_UPDATE_SYNC, false);\n     }\n \n-    public static void skipCommCareVersionForUpdate(int version) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n+    public static void setLastInAppUpdateCheckTime(long millis) {\n+        PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n                 .edit()\n-                .putInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, version)\n+                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n                 .apply();\n     }\n \n-    public static int getSkippedCommCareUpdateVersion() {\n-        return CommCareApplication.instance().getCurrentApp().getAppPreferences().getInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, -1);\n+    public static long getLastInAppUpdateCheckTime() {\n+        return PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n+                .getLong(LAST_IN_APP_UPDATE_CHECK_TIME, -1);\n     }\n \n-    public static void setLastInAppUpdateCheckTime(long millis) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n-                .edit()\n-                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n-                .apply();\n+    public static void cancelCommCareUpdate(String version) {\n+        SharedPreferences sharedPreferences = PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance());\n+        int count = sharedPreferences.getInt(version, 0);\n+        sharedPreferences.edit().putInt(version, count + 1).apply();\n     }\n \n-    public static long getLastInAppUpdateCheckTime() {\n-        return CommCareApplication.instance().getCurrentApp().getAppPreferences().getLong(LAST_IN_APP_UPDATE_CHECK_TIME, -1);\n+    public static int isCommCareUpdateCancelled(String version) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9048df5063a6fc9196c6c006586e8bb63daddb4c"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkyMzQ4NQ==", "bodyText": "we should prefix the key with a constant to make it more explicit for eg - COMMCARE_UPDATE_CANCELLATION_COUNTER + \"_\" + version", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r411923485", "createdAt": "2020-04-21T07:01:50Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/preferences/HiddenPreferences.java", "diffHunk": "@@ -449,25 +448,25 @@ public static boolean shouldBypassPreUpdateSync() {\n         return CommCareApplication.instance().getCurrentApp().getAppPreferences().getBoolean(BYPASS_PRE_UPDATE_SYNC, false);\n     }\n \n-    public static void skipCommCareVersionForUpdate(int version) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n+    public static void setLastInAppUpdateCheckTime(long millis) {\n+        PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n                 .edit()\n-                .putInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, version)\n+                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n                 .apply();\n     }\n \n-    public static int getSkippedCommCareUpdateVersion() {\n-        return CommCareApplication.instance().getCurrentApp().getAppPreferences().getInt(SKIP_COMMCARE_VERSION_FOR_UPDATE, -1);\n+    public static long getLastInAppUpdateCheckTime() {\n+        return PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance())\n+                .getLong(LAST_IN_APP_UPDATE_CHECK_TIME, -1);\n     }\n \n-    public static void setLastInAppUpdateCheckTime(long millis) {\n-        CommCareApplication.instance().getCurrentApp().getAppPreferences()\n-                .edit()\n-                .putLong(LAST_IN_APP_UPDATE_CHECK_TIME, millis)\n-                .apply();\n+    public static void cancelCommCareUpdate(String version) {\n+        SharedPreferences sharedPreferences = PreferenceManager.getDefaultSharedPreferences(CommCareApplication.instance());\n+        int count = sharedPreferences.getInt(version, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9048df5063a6fc9196c6c006586e8bb63daddb4c"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8075c789b0c32cf1c08e3b5c4024157a50ad9a6f", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/8075c789b0c32cf1c08e3b5c4024157a50ad9a6f", "committedDate": "2020-04-21T09:45:06Z", "message": "Add minor suggested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef45b6f08dee6bdf53d5d6bfcb3f02578127a799", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/ef45b6f08dee6bdf53d5d6bfcb3f02578127a799", "committedDate": "2020-04-22T08:41:47Z", "message": "Use new app update flow with prompted updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4Nzg3NTcx", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-398787571", "createdAt": "2020-04-23T06:17:07Z", "commit": {"oid": "ef45b6f08dee6bdf53d5d6bfcb3f02578127a799"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNjoxNzowOFrOGKYXZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNjoxNzowOFrOGKYXZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUzODE1MA==", "bodyText": "If the update is not available from play core APIs (For sideloaded apps), does the old behaviour of prompts remains the same. Asking because ICDS uses this prompt functionality with CommCare mostly sideloaded on their phones and these changes should not affect those users.", "url": "https://github.com/dimagi/commcare-android/pull/2216#discussion_r413538150", "createdAt": "2020-04-23T06:17:08Z", "author": {"login": "shubham1g5"}, "path": "app/src/org/commcare/activities/PromptApkUpdateActivity.java", "diffHunk": "@@ -26,6 +45,93 @@ protected void onCreate(Bundle savedInstanceState) {\n         } catch (SessionUnavailableException e) {\n             // we are showing the prompt before user login, so nothing to mark\n         }\n+        if (toPrompt.isForced()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef45b6f08dee6bdf53d5d6bfcb3f02578127a799"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51fad1ca016e646ca1c38eea786a59cbb7eaf97d", "author": {"user": {"login": "ShivamPokhriyal", "name": "Shivam Pokhriyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/51fad1ca016e646ca1c38eea786a59cbb7eaf97d", "committedDate": "2020-04-23T14:09:10Z", "message": "Show in-app update only once per session"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MzE4MTgz", "url": "https://github.com/dimagi/commcare-android/pull/2216#pullrequestreview-399318183", "createdAt": "2020-04-23T17:24:55Z", "commit": {"oid": "51fad1ca016e646ca1c38eea786a59cbb7eaf97d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2177, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}