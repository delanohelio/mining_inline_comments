{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5Njk3Mjg2", "number": 2186, "title": "Fixes form load crash in case of an pending update", "bodyText": "Jira: https://dimagi-dev.atlassian.net/browse/ICDS-1264\nIssue Repro:\n\nInstall an App and login\nInitiate an update , though don't install it\nKill CC (to force app re-initialization)\nOpen CC again\nGo to a form that's part of the update\nCC Crashes\n\nExplaination: The crash happens when there is an update in progress or there is an update downloaded that\u2019s not been installed and user tries to open a form that\u2019s been updated in the pending update. When a form is installed as part of update, it creates formDefRecords into user storage. When an app which has a pending update gets initialized, we loop through forms to find the latestFormId for the particular namespace. This code was also looping through the forms that were part of the update causing getLatestFormDefId to return the formId of the updated form which in turn caused the right xform to not be mapped to namespace ever because of the check here. When user opens a form that's part of a pending update, this causes a lookup for formId -1 into sql causing a crash. It's worth to note that this issue fixes itself once the pending update has been installed.\nSolution:  Instead of looking throgh the formDefRecords to decide whether to register a namespace or not this PR always registers a namespace if it doesn't exist and only overwrites in case the resource version of the new form is greater than the existing form.", "createdAt": "2020-02-25T16:59:40Z", "url": "https://github.com/dimagi/commcare-android/pull/2186", "merged": true, "mergeCommit": {"oid": "758fcd73e630f48595e639f7a04d6d9ab81cb171"}, "closed": true, "closedAt": "2020-02-25T18:20:40Z", "author": {"login": "shubham1g5"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcH1EsjgH2gAyMzc5Njk3Mjg2OmZlZjVlZjQ4NzZmOGY1N2UzMjMyMzc5ZmUyMzkwODA1MDhlM2MwZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcH2RrUAFqTM2NDMzOTE3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fef5ef4876f8f57e3232379fe239080508e3c0d5", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/fef5ef4876f8f57e3232379fe239080508e3c0d5", "committedDate": "2020-02-25T16:53:39Z", "message": "Fixes form load crash in case of an pending update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5d9c001fcc0624778c6e257f95bb18e707c6ddf", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/f5d9c001fcc0624778c6e257f95bb18e707c6ddf", "committedDate": "2020-02-25T16:59:03Z", "message": "comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MzMxMjAw", "url": "https://github.com/dimagi/commcare-android/pull/2186#pullrequestreview-364331200", "createdAt": "2020-02-25T18:01:57Z", "commit": {"oid": "f5d9c001fcc0624778c6e257f95bb18e707c6ddf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxODowMTo1N1rOFuPeGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxODowMTo1N1rOFuPeGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAzMjI4MA==", "bodyText": "Small point that I think this should be >=.\nThere could be a situation where the old resource and new resource have the same version and the old resource is on the way out. In that case the signal that this current resource is installed (because it is being initialized, which only happens to installed resources) should imply that this resource is valid, so with no other information about the installed resource we should presume that it may not be.", "url": "https://github.com/dimagi/commcare-android/pull/2186#discussion_r384032280", "createdAt": "2020-02-25T18:01:57Z", "author": {"login": "ctsims"}, "path": "app/src/org/commcare/android/resource/installers/XFormAndroidInstaller.java", "diffHunk": "@@ -74,19 +74,21 @@ public boolean initialize(AndroidCommCarePlatform platform, boolean isUpgrade) t\n             IOException, InvalidReferenceException, InvalidStructureException,\r\n             XmlPullParserException, UnfullfilledRequirementsException {\r\n         super.initialize(platform, isUpgrade);\r\n-        if (isLatestFormRecord(platform)) {\r\n+\r\n+        if (platform.getFormDefId(namespace) == -1) {\r\n             platform.registerXmlns(namespace, formDefId);\r\n+        } else {\r\n+            // Only overwrites the existing form if the resourceVersion of the new form is higher than the existing one\r\n+            FormDefRecord existingForm = FormDefRecord.getFormDef(platform.getFormDefStorage(), platform.getFormDefId(namespace));\r\n+            FormDefRecord newForm = FormDefRecord.getFormDef(platform.getFormDefStorage(), formDefId);\r\n+            if (newForm.getResourceVersion() > existingForm.getResourceVersion()) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5d9c001fcc0624778c6e257f95bb18e707c6ddf"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b12315931c2b6426e6dd8b45e6577caf61e126e", "author": {"user": {"login": "shubham1g5", "name": "Shubham Goyal"}}, "url": "https://github.com/dimagi/commcare-android/commit/2b12315931c2b6426e6dd8b45e6577caf61e126e", "committedDate": "2020-02-25T18:14:47Z", "message": "Allow the form to overwrite in case the resource versions are equal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MzM5MTc5", "url": "https://github.com/dimagi/commcare-android/pull/2186#pullrequestreview-364339179", "createdAt": "2020-02-25T18:17:44Z", "commit": {"oid": "2b12315931c2b6426e6dd8b45e6577caf61e126e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2138, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}