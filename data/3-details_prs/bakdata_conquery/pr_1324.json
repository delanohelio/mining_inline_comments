{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNDA5NzMz", "number": 1324, "title": "Rework of ConceptCondition to also work without Trees.", "bodyText": "", "createdAt": "2020-08-24T10:08:23Z", "url": "https://github.com/bakdata/conquery/pull/1324", "merged": true, "mergeCommit": {"oid": "e87b0e6b9699a0f0cf0635987f198bc109241aa0"}, "closed": true, "closedAt": "2020-09-23T11:41:16Z", "author": {"login": "awildturtok"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_w-JTAH2gAyNDcyNDA5NzMzOmQ0MGU5NjgzNTU4YjM1ZjQ0ZDA2ZDZlNzhkNDNhM2MyODU5OGE2NGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLrDbiAFqTQ5NDU2NjkwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d40e9683558b35f44d06d6e78d43a3c28598a64f", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/d40e9683558b35f44d06d6e78d43a3c28598a64f", "committedDate": "2020-08-17T11:46:38Z", "message": "rework of TreeConcept node to have optional table field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4426174fb9225f93586c70c76723c17114da957f", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/4426174fb9225f93586c70c76723c17114da957f", "committedDate": "2020-08-17T15:26:22Z", "message": "Split up CalculateCBlocksJob::calculateCBlock into CalculateCBlocksJob::calculateCBlockForCondition:\n- Special case for when the TreeConcept has no children. The Condition then excludes elements instead.\n- Also rework ConceptTreeChild::getDepth to be 0 based, so that the root has a depth and hence id of zero, allowing easier selection for Conditions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddc1d2aa24ea2af9e4fe76c8793b57fa4d29ac24", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/ddc1d2aa24ea2af9e4fe76c8793b57fa4d29ac24", "committedDate": "2020-08-26T10:30:08Z", "message": "Cleanup CalculateCBlocksJob::calculateCBlock and fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a7bf022ce16bb971f9e117a62bec909d8c6760e", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/4a7bf022ce16bb971f9e117a62bec909d8c6760e", "committedDate": "2020-08-26T10:37:28Z", "message": "add test for Condition and Tree Child"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef3a28b4886f27041e8e84d511546e8471a4f6ea", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/ef3a28b4886f27041e8e84d511546e8471a4f6ea", "committedDate": "2020-08-27T09:13:44Z", "message": "Merge remote-tracking branch 'origin/develop' into feature/fix-concept-condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2778e9899a5268ccf5b8993273e1f9da0001cedf", "author": {"user": {"login": "bakdata-bot", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/2778e9899a5268ccf5b8993273e1f9da0001cedf", "committedDate": "2020-08-27T09:16:13Z", "message": "automatic update to docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NjczMDAx", "url": "https://github.com/bakdata/conquery/pull/1324#pullrequestreview-478673001", "createdAt": "2020-08-31T14:37:25Z", "commit": {"oid": "2778e9899a5268ccf5b8993273e1f9da0001cedf"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNDozNzoyNVrOHJ7hbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNToxNToyM1rOHJ9Agg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE3NDQ0NQ==", "bodyText": "Das sieht komisch aus. Kannst du es standard m\u00e4\u00dfig mit etwas Validem initialisieren?", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r480174445", "createdAt": "2020-08-31T14:37:25Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/CBlock.java", "diffHunk": "@@ -50,8 +51,8 @@\n \t * Represents the path in a {@link TreeConcept} to optimize lookup.\n \t * Nodes in the tree are simply enumerated.\n \t */\n-\t@Valid\n-\tprivate List<int[]> mostSpecificChildren;\n+\t@Valid @NonNull\n+\tprivate List<int[]> mostSpecificChildren = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2778e9899a5268ccf5b8993273e1f9da0001cedf"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE3NDk4MA==", "bodyText": "Und ich frage mich ob @Valid etwas bewirkt.", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r480174980", "createdAt": "2020-08-31T14:38:21Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/CBlock.java", "diffHunk": "@@ -50,8 +51,8 @@\n \t * Represents the path in a {@link TreeConcept} to optimize lookup.\n \t * Nodes in the tree are simply enumerated.\n \t */\n-\t@Valid\n-\tprivate List<int[]> mostSpecificChildren;\n+\t@Valid @NonNull\n+\tprivate List<int[]> mostSpecificChildren = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE3NDQ0NQ=="}, "originalCommit": {"oid": "2778e9899a5268ccf5b8993273e1f9da0001cedf"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4MDkyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\tif (connector.getConcept() instanceof TreeConcept) {\n          \n          \n            \n            \t\t\t\t\tfinal ConceptTreeConnector treeConnector = (ConceptTreeConnector) connector;\n          \n          \n            \n            \t\t\t\t\tcalculateCBlock(cBlock, treeConnector, info);\n          \n          \n            \n            \t\t\t\tif (connector instanceof ConceptTreeConnector) {\n          \n          \n            \n            \t\t\t\t\tcalculateCBlock(cBlock, (ConceptTreeConnector) connector, info);\n          \n      \n    \n    \n  \n\neine Indirektion weniger", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r480180924", "createdAt": "2020-08-31T14:47:32Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/jobs/CalculateCBlocksJob.java", "diffHunk": "@@ -63,12 +70,14 @@ public void execute() throws Exception {\n \n \t\t\t\tCBlock cBlock = createCBlock(connector, info);\n \t\t\t\tcBlock.initIndizes(info.getBucket().getBucketSize());\n-\t\t\t\tif (treeConcept) {\n-\t\t\t\t\tcalculateCBlock(cBlock, (ConceptTreeConnector) connector, info);\n+\t\t\t\tif (connector.getConcept() instanceof TreeConcept) {\n+\t\t\t\t\tfinal ConceptTreeConnector treeConnector = (ConceptTreeConnector) connector;\n+\t\t\t\t\tcalculateCBlock(cBlock, treeConnector, info);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2778e9899a5268ccf5b8993273e1f9da0001cedf"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4MTkwNQ==", "bodyText": "Wir haben zwar nur zwei Concept Typen, aber das ist ein potentieller ClassCastError", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r480181905", "createdAt": "2020-08-31T14:49:01Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/jobs/CalculateCBlocksJob.java", "diffHunk": "@@ -63,12 +70,14 @@ public void execute() throws Exception {\n \n \t\t\t\tCBlock cBlock = createCBlock(connector, info);\n \t\t\t\tcBlock.initIndizes(info.getBucket().getBucketSize());\n-\t\t\t\tif (treeConcept) {\n-\t\t\t\t\tcalculateCBlock(cBlock, (ConceptTreeConnector) connector, info);\n+\t\t\t\tif (connector.getConcept() instanceof TreeConcept) {\n+\t\t\t\t\tfinal ConceptTreeConnector treeConnector = (ConceptTreeConnector) connector;\n+\t\t\t\t\tcalculateCBlock(cBlock, treeConnector, info);\n \t\t\t\t}\n \t\t\t\telse {\n \t\t\t\t\tcalculateCBlock(cBlock, (VirtualConceptConnector) connector, info);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2778e9899a5268ccf5b8993273e1f9da0001cedf"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE4NTM3NQ==", "bodyText": "Die Funktion berechnet einfach nur die min und max aller Dates einer Entity die in dem Bucket sind, oder?\nDer Funktionsname ist f\u00fcr mich irgendwie nichts sagend.", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r480185375", "createdAt": "2020-08-31T14:54:19Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/jobs/CalculateCBlocksJob.java", "diffHunk": "@@ -95,16 +104,20 @@ private void setDateRangeIndex(CBlock cBlock, CalculationInformation info) {\n \t\tBucket bucket = info.getBucket();\n \t\tTable table = storage.getDataset().getTables().get(bucket.getImp().getTable());\n \t\tfor (Column column : table.getColumns()) {\n-\t\t\tif (column.getType().isDateCompatible()) {\n-\t\t\t\tfor (BucketEntry entry : bucket.entries()) {\n-\t\t\t\t\tif (bucket.has(entry.getEvent(), column)) {\n-\t\t\t\t\t\tCDateRange range = bucket.getAsDateRange(entry.getEvent(), column);\n-\t\t\t\t\t\tcBlock.getMinDate()[entry.getLocalEntity()] = Math\n-\t\t\t\t\t\t\t.min(cBlock.getMinDate()[entry.getLocalEntity()], range.getMinValue());\n-\t\t\t\t\t\tcBlock.getMaxDate()[entry.getLocalEntity()] = Math\n-\t\t\t\t\t\t\t.max(cBlock.getMaxDate()[entry.getLocalEntity()], range.getMaxValue());\n-\t\t\t\t\t}\n+\t\t\tif (!column.getType().isDateCompatible()) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tfor (BucketEntry entry : bucket.entries()) {\n+\t\t\t\tif (!bucket.has(entry.getEvent(), column)) {\n+\t\t\t\t\tcontinue;\n \t\t\t\t}\n+\n+\t\t\t\tCDateRange range = bucket.getAsDateRange(entry.getEvent(), column);\n+\n+\t\t\t\tcBlock.getMinDate()[entry.getLocalEntity()] = Math.min(cBlock.getMinDate()[entry.getLocalEntity()], range.getMinValue());\n+\n+\t\t\t\tcBlock.getMaxDate()[entry.getLocalEntity()] = Math.max(cBlock.getMaxDate()[entry.getLocalEntity()], range.getMaxValue());\n \t\t\t}\n \t\t}\n \t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2778e9899a5268ccf5b8993273e1f9da0001cedf"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5NzIyNA==", "bodyText": "Da gabs doch schon eine andere L\u00f6sung f\u00fcr oder?", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r480197224", "createdAt": "2020-08-31T15:13:00Z", "author": {"login": "thoniTUB"}, "path": "frontend/src/index.ts", "diffHunk": "@@ -16,7 +16,7 @@ import { theme } from \"./app-theme\";\n import \"./app-styles.sass\";\n \n const isProduction = process.env.NODE_ENV === \"production\";\n-const disableLogin = !!process.env.REACT_APP_DISABLE_LOGIN;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2778e9899a5268ccf5b8993273e1f9da0001cedf"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5ODc4Ng==", "bodyText": "Ich verstehe nicht, wie das ohne die Column Information klappt. \ud83e\udd14", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r480198786", "createdAt": "2020-08-31T15:15:23Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/concepts/tree/ConceptTreeConnector.java", "diffHunk": "@@ -14,25 +14,39 @@\n import com.bakdata.conquery.models.datasets.Table;\n import com.fasterxml.jackson.annotation.JsonIgnore;\n import com.fasterxml.jackson.annotation.JsonManagedReference;\n+import io.dropwizard.validation.ValidationMethod;\n import lombok.Getter;\n import lombok.Setter;\n \n @Getter @Setter\n public class ConceptTreeConnector extends Connector {\n \n \tprivate static final long serialVersionUID = 1L;\n-\t\n-\t@NotNull @NsIdRef\n-\tprivate Column column;\n \n-\tprivate CTCondition condition;\n+\t@NsIdRef @CheckForNull\n+\tprivate Table table;\n+\n+\t@NsIdRef @CheckForNull\n+\tprivate Column column = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2778e9899a5268ccf5b8993273e1f9da0001cedf"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c670ee7dd1abedcd08876c1579a9ae17ba15b0ae", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/c670ee7dd1abedcd08876c1579a9ae17ba15b0ae", "committedDate": "2020-09-02T14:28:17Z", "message": "Review fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67c1d711cb4b182c4b789897f1082b05b277b608", "author": {"user": {"login": "bakdata-bot", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/67c1d711cb4b182c4b789897f1082b05b277b608", "committedDate": "2020-09-02T14:30:23Z", "message": "automatic update to docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "711c9ecbac7eed607081e8dc24008054ca9ffe6b", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/711c9ecbac7eed607081e8dc24008054ca9ffe6b", "committedDate": "2020-09-07T11:05:36Z", "message": "Merge branch 'develop' into feature/fix-concept-condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a33c05b62ccf592a0a9b040f39c57aef3a52130", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/4a33c05b62ccf592a0a9b040f39c57aef3a52130", "committedDate": "2020-09-17T08:17:07Z", "message": "Merge branch 'develop' into feature/fix-concept-condition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMjE2ODAz", "url": "https://github.com/bakdata/conquery/pull/1324#pullrequestreview-491216803", "createdAt": "2020-09-18T07:31:12Z", "commit": {"oid": "4a33c05b62ccf592a0a9b040f39c57aef3a52130"}, "state": "DISMISSED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNzozMToxMlrOHUBZKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMToyNDozMFrOHUJAtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc1NjM5NA==", "bodyText": "Bitte noch kurz dazuschreiben was die Vor-/Nachteile das bringen k\u00f6nnte.", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r490756394", "createdAt": "2020-09-18T07:31:12Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/CBlock.java", "diffHunk": "@@ -38,7 +39,8 @@\n \t * Bloom filter per entity for the first 64 {@link ConceptTreeChild}.\n \t */\n \tprivate long[] includedConcepts;\n-\t\n+\n+\t// TODO: 02.09.2020 FK: Make chop this onto a per-column basis", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a33c05b62ccf592a0a9b040f39c57aef3a52130"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3MDM1Ng==", "bodyText": "Some doku sugar\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * If a Bucket x Connector has a CBlock, the ConceptNode will rely on that to iterate events. If not, it will fall back onto equality checks.\n          \n          \n            \n             * If a {@link Bucket} x {@link Connector} has a {@link CBlock}, the {@link ConceptNode} will rely on that to iterate events. If not, it will fall back onto equality checks.", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r490870356", "createdAt": "2020-09-18T11:02:19Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/jobs/CalculateCBlocksJob.java", "diffHunk": "@@ -32,9 +32,17 @@\n import lombok.Setter;\n import lombok.extern.slf4j.Slf4j;\n \n-@RequiredArgsConstructor @Slf4j\n+/**\n+ * Calculate CBlocks, ie the Connection between a Concept and a Bucket.\n+ * <p>\n+ * If a Bucket x Connector has a CBlock, the ConceptNode will rely on that to iterate events. If not, it will fall back onto equality checks.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a33c05b62ccf592a0a9b040f39c57aef3a52130"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3Mjc0Ng==", "bodyText": "Kann man dann gegebenenfalls resourcen freigeben, wenn f\u00fcr ein konzept ein CBlock generiert werden konnte. Also resourcen die sonst f\u00fcr ein fall back onto equality checks gebracuht w\u00fcrden?\nVielleicht wird das auch schon gemacht, aber ich hab es nicht gesehen.", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r490872746", "createdAt": "2020-09-18T11:07:03Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/jobs/CalculateCBlocksJob.java", "diffHunk": "@@ -32,9 +32,17 @@\n import lombok.Setter;\n import lombok.extern.slf4j.Slf4j;\n \n-@RequiredArgsConstructor @Slf4j\n+/**\n+ * Calculate CBlocks, ie the Connection between a Concept and a Bucket.\n+ * <p>\n+ * If a Bucket x Connector has a CBlock, the ConceptNode will rely on that to iterate events. If not, it will fall back onto equality checks.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3MDM1Ng=="}, "originalCommit": {"oid": "4a33c05b62ccf592a0a9b040f39c57aef3a52130"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3NDYyMg==", "bodyText": "Vielleicht ist hier doch ein refactor angebracht in dem man die calculateCBlock funktionalit\u00e4t in den Connector packt. Das entspr\u00e4che mehr dem OO schema und man w\u00fcrde offen f\u00fcr andere Connectoren-Typen sein", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r490874622", "createdAt": "2020-09-18T11:10:58Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/jobs/CalculateCBlocksJob.java", "diffHunk": "@@ -63,13 +70,18 @@ public void execute() throws Exception {\n \n \t\t\t\tCBlock cBlock = createCBlock(connector, info);\n \t\t\t\tcBlock.initIndizes(info.getBucket().getBucketSize());\n-\t\t\t\tif (treeConcept) {\n-\t\t\t\t\tcalculateCBlock(cBlock, (ConceptTreeConnector) connector, info);\n+\t\t\t\tif (connector instanceof ConceptTreeConnector) {\n+\t\t\t\t\tfinal ConceptTreeConnector treeConnector = (ConceptTreeConnector) connector;\n+\t\t\t\t\tcalculateCBlock(cBlock, treeConnector, info);\n \t\t\t\t}\n-\t\t\t\telse {\n+\t\t\t\telse if (connector instanceof VirtualConceptConnector) {\n \t\t\t\t\tcalculateCBlock(cBlock, (VirtualConceptConnector) connector, info);\n \t\t\t\t}\n-\t\t\t\tsetDateRangeIndex(cBlock, info);\n+\t\t\t\telse {\n+\t\t\t\t\tthrow new IllegalArgumentException(String.format(\"Don't know how to handle connectors of type %s\", connector.getClass()));\n+\t\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a33c05b62ccf592a0a9b040f39c57aef3a52130"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4MDgzMw==", "bodyText": "Das ist hier etwas verworren finde ich. Ich verstehe nicht ganz was dieser Fall hier bedeutet, aber sorgt stringType = null;  nicht daf\u00fcr zwangsl\u00e4ufig daf\u00fcr, dass stringValue = \"\";\nUnd dass ist dann ein problematischer Wert?", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r490880833", "createdAt": "2020-09-18T11:23:46Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/jobs/CalculateCBlocksJob.java", "diffHunk": "@@ -91,111 +103,150 @@ public void execute() throws Exception {\n \t\tprogressReporter.done();\n \t}\n \n-\tprivate void setDateRangeIndex(CBlock cBlock, CalculationInformation info) {\n-\t\tBucket bucket = info.getBucket();\n+\t/**\n+\t * For every included entity, calculate min and max and store them as statistics in the CBlock.\n+\t */\n+\tprivate void calculateEntityDateIndices(CBlock cBlock, Bucket bucket) {\n \t\tTable table = storage.getDataset().getTables().get(bucket.getImp().getTable());\n \t\tfor (Column column : table.getColumns()) {\n-\t\t\tif (column.getType().isDateCompatible()) {\n-\t\t\t\tfor (BucketEntry entry : bucket.entries()) {\n-\t\t\t\t\tif (bucket.has(entry.getEvent(), column)) {\n-\t\t\t\t\t\tCDateRange range = bucket.getAsDateRange(entry.getEvent(), column);\n-\t\t\t\t\t\tcBlock.getMinDate()[entry.getLocalEntity()] = Math\n-\t\t\t\t\t\t\t.min(cBlock.getMinDate()[entry.getLocalEntity()], range.getMinValue());\n-\t\t\t\t\t\tcBlock.getMaxDate()[entry.getLocalEntity()] = Math\n-\t\t\t\t\t\t\t.max(cBlock.getMaxDate()[entry.getLocalEntity()], range.getMaxValue());\n-\t\t\t\t\t}\n+\t\t\tif (!column.getType().isDateCompatible()) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tfor (BucketEntry entry : bucket.entries()) {\n+\t\t\t\tif (!bucket.has(entry.getEvent(), column)) {\n+\t\t\t\t\tcontinue;\n \t\t\t\t}\n+\n+\t\t\t\tCDateRange range = bucket.getAsDateRange(entry.getEvent(), column);\n+\n+\t\t\t\tcBlock.getMinDate()[entry.getLocalEntity()] = Math.min(cBlock.getMinDate()[entry.getLocalEntity()], range.getMinValue());\n+\n+\t\t\t\tcBlock.getMaxDate()[entry.getLocalEntity()] = Math.max(cBlock.getMaxDate()[entry.getLocalEntity()], range.getMaxValue());\n \t\t\t}\n \t\t}\n \t}\n \n-\tprivate CBlock createCBlock(Connector connector, CalculationInformation info) {\n+\tprivate static CBlock createCBlock(Connector connector, CalculationInformation info) {\n \t\treturn new CBlock(info.getBucket().getId(), connector.getId());\n \t}\n \n \t/**\n \t * No CBlocks for VirtualConcepts\n \t */\n-\tprivate void calculateCBlock(CBlock cBlock, VirtualConceptConnector connector, CalculationInformation info) {}\n+\tprivate void calculateCBlock(CBlock cBlock, VirtualConceptConnector connector, CalculationInformation info) {\n+\t}\n+\n \n \tprivate void calculateCBlock(CBlock cBlock, ConceptTreeConnector connector, CalculationInformation info) {\n \n \t\tBucket bucket = info.getBucket();\n \n-\t\tCType<?, ?> cType = info.getImp().getColumns()[connector.getColumn().getPosition()].getType();\n+\t\tfinal Column column = connector.getColumn();\n \n-\t\tif (!(cType instanceof AStringType)) {\n-\t\t\treturn;\n-\t\t}\n-\t\tAStringType<?> stringType = (AStringType<?>) cType;\n \n \t\tfinal TreeConcept treeConcept = connector.getConcept();\n \n \t\tfinal ImportId importId = info.getImp().getId();\n \n-\t\t// Create index and insert into Tree.\n-\t\tTreeChildPrefixIndex.putIndexInto(treeConcept);\n+\t\tfinal AStringType<?> stringType;\n+\n \n-\t\ttreeConcept.initializeIdCache(stringType, importId);\n+\t\tif (column != null) {\n \n-\t\tcBlock.setMostSpecificChildren(new ArrayList<>(bucket.getNumberOfEvents()));\n+\t\t\tCType<?, ?> cType = info.getImp().getColumns()[column.getPosition()].getType();\n+\n+\t\t\tif (!(cType instanceof AStringType)) {\n+\t\t\t\tlog.warn(\"Column[{}] is not of String type, but `{}`\", column.getId(), cType);\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t\tstringType = (AStringType<?>) cType;\n+\n+\t\t\t// Create index and insert into Tree.\n+\t\t\tTreeChildPrefixIndex.putIndexInto(treeConcept);\n+\n+\t\t\ttreeConcept.initializeIdCache(stringType, importId);\n+\t\t}\n+\t\telse {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a33c05b62ccf592a0a9b040f39c57aef3a52130"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4MTIwNw==", "bodyText": "Also gibt es hier eine Abk\u00fcrzung oder muss dieser Fall weiter verfolgt werden?", "url": "https://github.com/bakdata/conquery/pull/1324#discussion_r490881207", "createdAt": "2020-09-18T11:24:30Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/jobs/CalculateCBlocksJob.java", "diffHunk": "@@ -91,111 +103,150 @@ public void execute() throws Exception {\n \t\tprogressReporter.done();\n \t}\n \n-\tprivate void setDateRangeIndex(CBlock cBlock, CalculationInformation info) {\n-\t\tBucket bucket = info.getBucket();\n+\t/**\n+\t * For every included entity, calculate min and max and store them as statistics in the CBlock.\n+\t */\n+\tprivate void calculateEntityDateIndices(CBlock cBlock, Bucket bucket) {\n \t\tTable table = storage.getDataset().getTables().get(bucket.getImp().getTable());\n \t\tfor (Column column : table.getColumns()) {\n-\t\t\tif (column.getType().isDateCompatible()) {\n-\t\t\t\tfor (BucketEntry entry : bucket.entries()) {\n-\t\t\t\t\tif (bucket.has(entry.getEvent(), column)) {\n-\t\t\t\t\t\tCDateRange range = bucket.getAsDateRange(entry.getEvent(), column);\n-\t\t\t\t\t\tcBlock.getMinDate()[entry.getLocalEntity()] = Math\n-\t\t\t\t\t\t\t.min(cBlock.getMinDate()[entry.getLocalEntity()], range.getMinValue());\n-\t\t\t\t\t\tcBlock.getMaxDate()[entry.getLocalEntity()] = Math\n-\t\t\t\t\t\t\t.max(cBlock.getMaxDate()[entry.getLocalEntity()], range.getMaxValue());\n-\t\t\t\t\t}\n+\t\t\tif (!column.getType().isDateCompatible()) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tfor (BucketEntry entry : bucket.entries()) {\n+\t\t\t\tif (!bucket.has(entry.getEvent(), column)) {\n+\t\t\t\t\tcontinue;\n \t\t\t\t}\n+\n+\t\t\t\tCDateRange range = bucket.getAsDateRange(entry.getEvent(), column);\n+\n+\t\t\t\tcBlock.getMinDate()[entry.getLocalEntity()] = Math.min(cBlock.getMinDate()[entry.getLocalEntity()], range.getMinValue());\n+\n+\t\t\t\tcBlock.getMaxDate()[entry.getLocalEntity()] = Math.max(cBlock.getMaxDate()[entry.getLocalEntity()], range.getMaxValue());\n \t\t\t}\n \t\t}\n \t}\n \n-\tprivate CBlock createCBlock(Connector connector, CalculationInformation info) {\n+\tprivate static CBlock createCBlock(Connector connector, CalculationInformation info) {\n \t\treturn new CBlock(info.getBucket().getId(), connector.getId());\n \t}\n \n \t/**\n \t * No CBlocks for VirtualConcepts\n \t */\n-\tprivate void calculateCBlock(CBlock cBlock, VirtualConceptConnector connector, CalculationInformation info) {}\n+\tprivate void calculateCBlock(CBlock cBlock, VirtualConceptConnector connector, CalculationInformation info) {\n+\t}\n+\n \n \tprivate void calculateCBlock(CBlock cBlock, ConceptTreeConnector connector, CalculationInformation info) {\n \n \t\tBucket bucket = info.getBucket();\n \n-\t\tCType<?, ?> cType = info.getImp().getColumns()[connector.getColumn().getPosition()].getType();\n+\t\tfinal Column column = connector.getColumn();\n \n-\t\tif (!(cType instanceof AStringType)) {\n-\t\t\treturn;\n-\t\t}\n-\t\tAStringType<?> stringType = (AStringType<?>) cType;\n \n \t\tfinal TreeConcept treeConcept = connector.getConcept();\n \n \t\tfinal ImportId importId = info.getImp().getId();\n \n-\t\t// Create index and insert into Tree.\n-\t\tTreeChildPrefixIndex.putIndexInto(treeConcept);\n+\t\tfinal AStringType<?> stringType;\n+\n \n-\t\ttreeConcept.initializeIdCache(stringType, importId);\n+\t\tif (column != null) {\n \n-\t\tcBlock.setMostSpecificChildren(new ArrayList<>(bucket.getNumberOfEvents()));\n+\t\t\tCType<?, ?> cType = info.getImp().getColumns()[column.getPosition()].getType();\n+\n+\t\t\tif (!(cType instanceof AStringType)) {\n+\t\t\t\tlog.warn(\"Column[{}] is not of String type, but `{}`\", column.getId(), cType);\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t\tstringType = (AStringType<?>) cType;\n+\n+\t\t\t// Create index and insert into Tree.\n+\t\t\tTreeChildPrefixIndex.putIndexInto(treeConcept);\n+\n+\t\t\ttreeConcept.initializeIdCache(stringType, importId);\n+\t\t}\n+\t\telse {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg4MDgzMw=="}, "originalCommit": {"oid": "4a33c05b62ccf592a0a9b040f39c57aef3a52130"}, "originalPosition": 146}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59f3099f8efdc6366b3a6a64875e826a90742851", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/59f3099f8efdc6366b3a6a64875e826a90742851", "committedDate": "2020-09-23T09:23:14Z", "message": "Move calculateCBlock to Connector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0778b7ec765cc867b9b0b777bbe2635717e4fff", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/c0778b7ec765cc867b9b0b777bbe2635717e4fff", "committedDate": "2020-09-23T09:23:14Z", "message": "mostSpecificChildren towards array instead of list of always the same length"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ae4a569b87e01cc47a2a2ce4d2176f46f739321", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/3ae4a569b87e01cc47a2a2ce4d2176f46f739321", "committedDate": "2020-09-23T09:28:46Z", "message": "Merge branch 'develop' into feature/fix-concept-condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "594a2adfc148f4f7b43f9e5bfd4d82367ca6ea41", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/594a2adfc148f4f7b43f9e5bfd4d82367ca6ea41", "committedDate": "2020-09-23T09:39:58Z", "message": "fix syntax error after migration to array"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a312a7b012920a64829e859d95e280e788cf9e5b", "author": {"user": {"login": "bakdata-bot", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/a312a7b012920a64829e859d95e280e788cf9e5b", "committedDate": "2020-09-23T09:42:16Z", "message": "automatic update to docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9c16e09317e5ff661cc63bf2103c70adfb74368", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/d9c16e09317e5ff661cc63bf2103c70adfb74368", "committedDate": "2020-09-23T10:04:38Z", "message": "fix typo for root Prefix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "065ea68d975f4fad8122f88e03c2ff21f8cea665", "author": {"user": {"login": "bakdata-bot", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/065ea68d975f4fad8122f88e03c2ff21f8cea665", "committedDate": "2020-09-23T10:06:41Z", "message": "automatic update to docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NTY2OTAz", "url": "https://github.com/bakdata/conquery/pull/1324#pullrequestreview-494566903", "createdAt": "2020-09-23T11:40:04Z", "commit": {"oid": "065ea68d975f4fad8122f88e03c2ff21f8cea665"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4560, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}