{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MjIwNTkx", "number": 1394, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMTo0NDoyM1rOEvRg8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwODozNDo1NVrOEwIqbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MDA1NDg5OnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMTo0NDoyM1rOHkKW_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMTo1MzowM1rOHkKo_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4MDUwOQ==", "bodyText": "Map Map List. HolyMoly.\nIch w\u00fcrde es eher tableToBuckets nennen, damit es klarer ist, was hier gemappt wird", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r507680509", "createdAt": "2020-10-19T11:44:23Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -58,11 +59,19 @@\n \t * Connector -> Bucket -> [CBlock]\n \t */\n \tprivate final Map<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks;\n-\t\n+\n+\t/**\n+\t * Table -> BucketN -> [Buckets]\n+\t */\n+\tprivate final Map<TableId, Int2ObjectMap<List<Bucket>>> bucketTables;\n+\n \tpublic static BucketManager create(Worker worker, WorkerStorage storage) {\n \t\tInt2ObjectMap<Entity> entities = new Int2ObjectAVLTreeMap<>();\n \t\tMap<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks = new HashMap<>(150);\n-\t\t\n+\t\tMap<TableId, Int2ObjectMap<List<Bucket>>> bucketTables = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18107137267836c118d66692c6e34c88b1d76f9f"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4NTExNw==", "bodyText": "connectorCBlocks auch im Namen angleichen", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r507685117", "createdAt": "2020-10-19T11:53:03Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -58,11 +59,19 @@\n \t * Connector -> Bucket -> [CBlock]\n \t */\n \tprivate final Map<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks;\n-\t\n+\n+\t/**\n+\t * Table -> BucketN -> [Buckets]\n+\t */\n+\tprivate final Map<TableId, Int2ObjectMap<List<Bucket>>> bucketTables;\n+\n \tpublic static BucketManager create(Worker worker, WorkerStorage storage) {\n \t\tInt2ObjectMap<Entity> entities = new Int2ObjectAVLTreeMap<>();\n \t\tMap<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks = new HashMap<>(150);\n-\t\t\n+\t\tMap<TableId, Int2ObjectMap<List<Bucket>>> bucketTables = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4MDUwOQ=="}, "originalCommit": {"oid": "18107137267836c118d66692c6e34c88b1d76f9f"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MzcwNzMwOnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNjo0NToxOFrOHks7Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNzozNzo0N1rOHleOkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NjgyNw==", "bodyText": "Musst du hier nicht auch getOrDefault nehmen?", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r508246827", "createdAt": "2020-10-20T06:45:18Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -236,13 +245,23 @@ private void deregisterBucket(Bucket bucket) {\n \t\t\t\tentities.remove(entityId);\n \t\t\t}\n \t\t}\n+\n+\t\ttableToBuckets.getOrDefault(bucket.getImp().getTable(), Int2ObjectMaps.emptyMap())\n+\t\t\t\t\t  .get(bucket.getBucket())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bb76ece00ae1f4d42e9622f8d75526270cc518c"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAzNzc3Nw==", "bodyText": "@awildturtok No comment? \ud83e\udd14", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r509037777", "createdAt": "2020-10-21T07:08:18Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -236,13 +245,23 @@ private void deregisterBucket(Bucket bucket) {\n \t\t\t\tentities.remove(entityId);\n \t\t\t}\n \t\t}\n+\n+\t\ttableToBuckets.getOrDefault(bucket.getImp().getTable(), Int2ObjectMaps.emptyMap())\n+\t\t\t\t\t  .get(bucket.getBucket())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NjgyNw=="}, "originalCommit": {"oid": "7bb76ece00ae1f4d42e9622f8d75526270cc518c"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA1NDYxMQ==", "bodyText": "hab ich das nicht behoben? strange sorry", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r509054611", "createdAt": "2020-10-21T07:37:47Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -236,13 +245,23 @@ private void deregisterBucket(Bucket bucket) {\n \t\t\t\tentities.remove(entityId);\n \t\t\t}\n \t\t}\n+\n+\t\ttableToBuckets.getOrDefault(bucket.getImp().getTable(), Int2ObjectMaps.emptyMap())\n+\t\t\t\t\t  .get(bucket.getBucket())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NjgyNw=="}, "originalCommit": {"oid": "7bb76ece00ae1f4d42e9622f8d75526270cc518c"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MzcwODkyOnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNjo0NTo1M1rOHks8NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNjo0NTo1M1rOHks8NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NzA5Mw==", "bodyText": "genauso wie hier getOrDefault?", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r508247093", "createdAt": "2020-10-20T06:45:53Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -236,13 +245,23 @@ private void deregisterBucket(Bucket bucket) {\n \t\t\t\tentities.remove(entityId);\n \t\t\t}\n \t\t}\n+\n+\t\ttableToBuckets.getOrDefault(bucket.getImp().getTable(), Int2ObjectMaps.emptyMap())\n+\t\t\t\t\t  .get(bucket.getBucket())\n+\t\t\t\t\t  .removeIf(bkt -> bkt.getId().equals(bucket.getId()));\n+\n \t}\n \n \tprivate void deregisterCBlock(CBlockId cBlockId) {\n \t\tBucket bucket = storage.getBucket(cBlockId.getBucket());\n \t\tif (bucket == null) {\n \t\t\tthrow new NoSuchElementException(\"Could not find an element called '\"+cBlockId.getBucket()+\"'\");\n \t\t}\n+\n+\t\tconnectorToCblocks.getOrDefault(cBlockId.getConnector(), Int2ObjectMaps.emptyMap())\n+\t\t\t\t\t\t  .get(cBlockId.getBucket().getBucket())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bb76ece00ae1f4d42e9622f8d75526270cc518c"}, "originalPosition": 141}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MzczMDkzOnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/models/worker/Worker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNjo1MzowNlrOHktJXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNjo1MzowNlrOHktJXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI1MDQ2MA==", "bodyText": "Ouh, hatte ich das vergessen? Das sollte dann nochin den KW41 rein.\nIch wurde das L\u00f6schen aus dem Storage in dem Bucketmanager machen. Und da erst die Buckets und Concepts auf r\u00e4umen und dann erst aus dem Storage l\u00f6schen.", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r508250460", "createdAt": "2020-10-20T06:53:06Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/worker/Worker.java", "diffHunk": "@@ -164,6 +164,7 @@ public void addImport(Import imp) {\n \t}\n \n \tpublic void removeImport(ImportId importId) {\n+\t\tstorage.removeImport(importId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bb76ece00ae1f4d42e9622f8d75526270cc518c"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4OTA5MDM5OnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwODozNDo1NVrOHlghqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwODozNDo1NVrOHlghqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA5MjI2Nw==", "bodyText": "Hier ist irgendwie ein merge kaputt gegangen und das sollte eigentlich nicht kompilieren, oder wo nimmt er requiredBuckets her?", "url": "https://github.com/bakdata/conquery/pull/1394#discussion_r509092267", "createdAt": "2020-10-21T08:34:55Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -53,30 +52,84 @@\n \tprivate final Worker worker;\n \t@Getter\n \tprivate final Int2ObjectMap<Entity> entities;\n-\t\n+\n+\t/**\n+\t * Connector -> Bucket -> [BucketId -> CBlock]\n+\t */\n+\tprivate final Map<ConnectorId, Int2ObjectMap<Map<BucketId, CBlock>>> connectorToCblocks;\n+\n \t/**\n-\t * Connector -> Bucket -> [CBlock]\n+\t * Table -> BucketN -> [Buckets]\n \t */\n-\tprivate final Map<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks;\n-\t\n+\tprivate final Map<TableId, Int2ObjectMap<List<Bucket>>> tableToBuckets;\n+\n \tpublic static BucketManager create(Worker worker, WorkerStorage storage) {\n \t\tInt2ObjectMap<Entity> entities = new Int2ObjectAVLTreeMap<>();\n-\t\tMap<ConnectorId, Int2ObjectMap<List<CBlock>>> connectorCBlocks = new HashMap<>(150);\n+\t\tMap<ConnectorId, Int2ObjectMap<Map<BucketId, CBlock>>> connectorCBlocks = new HashMap<>();\n+\t\tMap<TableId, Int2ObjectMap<List<Bucket>>> tableBuckets = new HashMap<>();\n+\n+\n \t\t\n+\t\tlog.trace(\"Trying to load these buckets: {}\", requiredBuckets);\n \t\tIntArraySet assignedBucketNumbers = worker.getInfo().getIncludedBuckets();\n \t\tlog.trace(\"Trying to load these buckets that map to: {}\", assignedBucketNumbers);\n \t\tfor (Bucket bucket : storage.getAllBuckets()) {\n \t\t\tif(!assignedBucketNumbers.contains(bucket.getBucket())) {\n \t\t\t\tlog.warn(\"Found Bucket[{}] in Storage that does not belong to this Worker according to the Worker information.\", bucket.getId());\n \t\t\t}\n-\t\t\tregisterBucket(bucket, entities, storage);\n+\t\t\tregisterBucket(bucket, entities, storage, tableBuckets);\n+\t\t}\n+\t\tif (!requiredBuckets.isEmpty()) {\n+\t\t\tlog.warn(\"Not all required Buckets were loaded from the storage. Missing Buckets: {}\", requiredBuckets);\n \t\t}\n \n+\n \t\tfor (CBlock cBlock : storage.getAllCBlocks()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08c453357c88d094c14d0338101843a55923ee17"}, "originalPosition": 59}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1608, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}