{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NDcxODY0", "number": 1382, "title": "Feature/clean up bucket manager", "bodyText": "", "createdAt": "2020-10-06T11:37:09Z", "url": "https://github.com/bakdata/conquery/pull/1382", "merged": true, "mergeCommit": {"oid": "8cdc3d20510c461eed1a8bd7c81d09d4b5ca85ea"}, "closed": true, "closedAt": "2020-10-08T13:56:41Z", "author": {"login": "thoniTUB"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP5dXnABqjM4NDU4NDQ2MDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQh_qxABqjM4NTU1OTI4ODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f718594397271648de9e93c24fb5b4fa546e56b4", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/f718594397271648de9e93c24fb5b4fa546e56b4", "committedDate": "2020-10-06T11:34:49Z", "message": "adds consistency test"}, "afterCommit": {"oid": "0912ee9d89c62d4070d3ad17ac16548aa7138991", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/0912ee9d89c62d4070d3ad17ac16548aa7138991", "committedDate": "2020-10-06T14:42:23Z", "message": "revert of some change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyODY5MDcy", "url": "https://github.com/bakdata/conquery/pull/1382#pullrequestreview-502869072", "createdAt": "2020-10-06T12:08:34Z", "commit": {"oid": "f718594397271648de9e93c24fb5b4fa546e56b4"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMjowODozNFrOHdDKXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDo0OToyNlrOHd3N9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIyMjU1Ng==", "bodyText": "W\u00fcrde ich nicht im Konstruktor machen", "url": "https://github.com/bakdata/conquery/pull/1382#discussion_r500222556", "createdAt": "2020-10-06T12:08:34Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -40,37 +39,50 @@\n \tprivate final IdMutex<ConnectorId> cBlockLocks = new IdMutex<>();\n \tprivate final JobManager jobManager;\n \tprivate final WorkerStorage storage;\n-\tprivate final IdMap<ConceptId, Concept<?>> concepts = new IdMap<>();\n-\tprivate final IdMap<BucketId, Bucket> buckets = new IdMap<>();\n-\tprivate final IdMap<CBlockId, CBlock> cBlocks = new IdMap<>();\n \t@Getter\n \tprivate final Int2ObjectMap<Entity> entities = new Int2ObjectAVLTreeMap<>();\n-\tprivate final WorkerInformation workerInformation;\n+\tprivate final Worker worker;\n \n-\tpublic BucketManager(JobManager jobManager, WorkerStorage storage, WorkerInformation workerInformation) {\n+\tpublic BucketManager(JobManager jobManager, WorkerStorage storage, Worker worker) {\n \t\tthis.jobManager = jobManager;\n \t\tthis.storage = storage;\n-\t\tthis.concepts.addAll(storage.getAllConcepts());\n-\t\tthis.buckets.addAll(storage.getAllBuckets());\n-\t\tthis.cBlocks.addAll(storage.getAllCBlocks());\n-\t\tthis.workerInformation = workerInformation;\n+\t\tthis.worker = worker;\n+\t\t\n+\t\tIntArrayList requiredBuckets = worker.getInfo().getIncludedBuckets().clone();\n+\t\tlog.trace(\"Trying to load these buckets: {}\", requiredBuckets);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f718594397271648de9e93c24fb5b4fa546e56b4"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA3NTQ0NQ==", "bodyText": "Doku", "url": "https://github.com/bakdata/conquery/pull/1382#discussion_r501075445", "createdAt": "2020-10-07T14:49:26Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/io/xodus/WorkerStorageRetrivalDelegate.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.bakdata.conquery.io.xodus;\n+\n+import java.io.File;\n+import java.util.Collection;\n+\n+import javax.validation.Validator;\n+\n+import com.bakdata.conquery.models.concepts.Concept;\n+import com.bakdata.conquery.models.datasets.Dataset;\n+import com.bakdata.conquery.models.datasets.Import;\n+import com.bakdata.conquery.models.dictionary.Dictionary;\n+import com.bakdata.conquery.models.dictionary.DirectDictionary;\n+import com.bakdata.conquery.models.events.Bucket;\n+import com.bakdata.conquery.models.events.CBlock;\n+import com.bakdata.conquery.models.identifiable.CentralRegistry;\n+import com.bakdata.conquery.models.identifiable.ids.specific.BucketId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.CBlockId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.ConceptId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.DictionaryId;\n+import com.bakdata.conquery.models.identifiable.ids.specific.ImportId;\n+import com.bakdata.conquery.models.worker.WorkerInformation;\n+import jetbrains.exodus.env.Environment;\n+import lombok.RequiredArgsConstructor;\n+\n+@RequiredArgsConstructor\n+public class WorkerStorageRetrivalDelegate {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115cabce043bc0896625ce70ff6d152fad5a07f2"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21a4f24878a5ca4ea8d0ba215f71f8addde80ee3", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/21a4f24878a5ca4ea8d0ba215f71f8addde80ee3", "committedDate": "2020-10-07T15:43:45Z", "message": "puts annotation on the right line"}, "afterCommit": {"oid": "3fca89ad85896815dcb239746c683599f1a4a178", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/3fca89ad85896815dcb239746c683599f1a4a178", "committedDate": "2020-10-07T15:56:28Z", "message": "puts annotation on the right line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzI0MDA5", "url": "https://github.com/bakdata/conquery/pull/1382#pullrequestreview-504724009", "createdAt": "2020-10-08T12:23:06Z", "commit": {"oid": "7828b2e5c043f06412edbaafe9c7d2cd8c47e8c9"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMjoyMzowNlrOHeb8jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMjoyNTowOVrOHecBMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY3NzE5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @implNote These numbers are estimates, we could make them configurable, though they aren't very important.", "url": "https://github.com/bakdata/conquery/pull/1382#discussion_r501677196", "createdAt": "2020-10-08T12:23:06Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java", "diffHunk": "@@ -43,36 +43,52 @@\n  * @implNote This class is only used per {@link Worker}. And NOT in the ManagerNode.\n  */\n @Slf4j\n+@RequiredArgsConstructor\n public class BucketManager {\n \n-\t@Getter\n-\tprivate final int bucketSize;\n-\n \tprivate final IdMutex<ConnectorId> cBlockLocks = new IdMutex<>();\n \tprivate final JobManager jobManager;\n \tprivate final WorkerStorage storage;\n-\tprivate final IdMap<ConceptId, Concept<?>> concepts = new IdMap<>();\n-\tprivate final IdMap<BucketId, Bucket> buckets = new IdMap<>();\n-\tprivate final IdMap<CBlockId, CBlock> cBlocks = new IdMap<>();\n-\t@Getter\n-\tprivate final Int2ObjectMap<Entity> entities = new Int2ObjectAVLTreeMap<>();\n-\n \t//Backreference\n \tprivate final Worker worker;\n+\t@Getter\n+\tprivate final Int2ObjectMap<Entity> entities;\n+\t\n+\t/**\n+\t * Connector -> Bucket -> [CBlock]\n+\t * @implNote These numbers are estimates, we could make them configurable, though they aren't very important.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7828b2e5c043f06412edbaafe9c7d2cd8c47e8c9"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY3ODM4NA==", "bodyText": "mlady -- \ud83c\udfa9", "url": "https://github.com/bakdata/conquery/pull/1382#discussion_r501678384", "createdAt": "2020-10-08T12:25:09Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/QueryPlanContext.java", "diffHunk": "@@ -1,6 +1,6 @@\n package com.bakdata.conquery.models.query;\n \n-import com.bakdata.conquery.io.xodus.WorkerStorage;\n+import com.bakdata.conquery.io.xodus.ModificationShieldedWorkerStorage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7828b2e5c043f06412edbaafe9c7d2cd8c47e8c9"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba129af140740b82cad13a6292bf2a0049fddff4", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/ba129af140740b82cad13a6292bf2a0049fddff4", "committedDate": "2020-10-08T13:55:59Z", "message": "remove IdMaps from BucketManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fb84b35110dffc892adfd4c8e2fbc7e493d4629", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/3fb84b35110dffc892adfd4c8e2fbc7e493d4629", "committedDate": "2020-10-08T13:56:00Z", "message": "fix wrong comparison in test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a81ee089db508d910a72199fb6056e6344c07f6b", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/a81ee089db508d910a72199fb6056e6344c07f6b", "committedDate": "2020-10-08T13:56:00Z", "message": "don't throw in storage if concept was not found"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09d5599e1660fb76b02066e5cca4cfb896fe1337", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/09d5599e1660fb76b02066e5cca4cfb896fe1337", "committedDate": "2020-10-08T13:56:00Z", "message": "adds missing remove of storage when namespace is removed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "321e3e2376b2ebf40114957756511dfecf203ef7", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/321e3e2376b2ebf40114957756511dfecf203ef7", "committedDate": "2020-10-08T13:56:00Z", "message": "fixes direct deletion of import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f5726ad42153db74e1a33738e7c244976082ebd", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/7f5726ad42153db74e1a33738e7c244976082ebd", "committedDate": "2020-10-08T13:56:00Z", "message": "adds consistency test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "818ae113126caa78ea8f7806d1ad491f375e5439", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/818ae113126caa78ea8f7806d1ad491f375e5439", "committedDate": "2020-10-08T13:56:00Z", "message": "fixes of rebase conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62e4c10a68579b91524fdb9cbac949d9e0658684", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/62e4c10a68579b91524fdb9cbac949d9e0658684", "committedDate": "2020-10-08T13:56:01Z", "message": "revert of some change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "614dda6682999cde6f781c80aaa9d047389dd6d4", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/614dda6682999cde6f781c80aaa9d047389dd6d4", "committedDate": "2020-10-08T13:56:01Z", "message": "remove commented function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56d77bfa93b1a96f4420836057b28510872942fc", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/56d77bfa93b1a96f4420836057b28510872942fc", "committedDate": "2020-10-08T13:56:01Z", "message": "review changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c63af029cf26a7ecb1fc723dc9c8679c2d5ca8e", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/0c63af029cf26a7ecb1fc723dc9c8679c2d5ca8e", "committedDate": "2020-10-08T13:56:01Z", "message": "puts annotation on the right line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f67c026cfe28f3c701dd9ef06645c06d5b977f1a", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/f67c026cfe28f3c701dd9ef06645c06d5b977f1a", "committedDate": "2020-10-08T13:56:01Z", "message": "fix rebase issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dea7d8453d057376bc87dd8c735ddbf193993a3c", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/dea7d8453d057376bc87dd8c735ddbf193993a3c", "committedDate": "2020-10-08T13:56:02Z", "message": "fixes compile errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f851e88747e10e8a366a8ebf4e1a81bad9305166", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/f851e88747e10e8a366a8ebf4e1a81bad9305166", "committedDate": "2020-10-08T13:56:02Z", "message": "Update backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n\nCo-authored-by: awildturtok <1553491+awildturtok@users.noreply.github.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ccbb416fb1547c85477dd63d089cda59cfbef9c", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/8ccbb416fb1547c85477dd63d089cda59cfbef9c", "committedDate": "2020-10-08T13:49:39Z", "message": "Update backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n\nCo-authored-by: awildturtok <1553491+awildturtok@users.noreply.github.com>"}, "afterCommit": {"oid": "f851e88747e10e8a366a8ebf4e1a81bad9305166", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/f851e88747e10e8a366a8ebf4e1a81bad9305166", "committedDate": "2020-10-08T13:56:02Z", "message": "Update backend/src/main/java/com/bakdata/conquery/models/events/BucketManager.java\n\nCo-authored-by: awildturtok <1553491+awildturtok@users.noreply.github.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4814, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}