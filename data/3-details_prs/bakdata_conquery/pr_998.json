{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1MjE4MTg1", "number": 998, "title": "Feature/restrict entity upload", "bodyText": "Restrict entity upload based on a permission check that scans incomming queries for parts that required an resolving of external Ids", "createdAt": "2020-01-21T10:08:11Z", "url": "https://github.com/bakdata/conquery/pull/998", "merged": true, "mergeCommit": {"oid": "1a148486656dbafa07c86788f19e1a05169cdd84"}, "closed": true, "closedAt": "2020-01-21T15:28:15Z", "author": {"login": "thoniTUB"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8LpFcgH2gAyMzY1MjE4MTg1OmJkYTgxZTAwMmNlOWY2YTQzMDljMDJlZjhlODA5ZTdlYzhlYzE4NGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8iw7aAH2gAyMzY1MjE4MTg1OjhjYjBkOTM2Mjc2OWM5MWVjYjIzYzFiYzQ1NWMxZDIzZTYxOWY1NWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bda81e002ce9f6a4309c02ef8e809e7ec8ec184a", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/bda81e002ce9f6a4309c02ef8e809e7ec8ec184a", "committedDate": "2020-01-20T12:24:13Z", "message": "fixes endpoint tree"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "828d595a3ca04fa45688b4865267cefba931906f", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/828d595a3ca04fa45688b4865267cefba931906f", "committedDate": "2020-01-20T12:41:11Z", "message": "clean up stored queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc1a952e86a039859b19301a8656267fde084ee0", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/dc1a952e86a039859b19301a8656267fde084ee0", "committedDate": "2020-01-21T08:46:56Z", "message": "checks queries and form for id resolving"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2341eab41b0804b5c35168373be961993ae9eaf", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/a2341eab41b0804b5c35168373be961993ae9eaf", "committedDate": "2020-01-21T10:04:46Z", "message": "provided implementation for easing the restrictions on entity upload headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/faceae4d9a59c3331745441d9a80ad6202acabff", "committedDate": "2020-01-21T10:21:50Z", "message": "code factor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1ODAyNTEw", "url": "https://github.com/bakdata/conquery/pull/998#pullrequestreview-345802510", "createdAt": "2020-01-21T11:17:22Z", "commit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMToxNzoyMlrOFf2hLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjoxNDozM1rOFf37Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk0MzQwNA==", "bodyText": "kannst du das dahin auslagern wo es benutzt wird?", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368943404", "createdAt": "2020-01-21T11:17:22Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/Visitable.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com.bakdata.conquery.models.query;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import com.bakdata.conquery.models.query.concept.CQElement;\n+import com.bakdata.conquery.models.query.concept.specific.CQExternal;\n+import com.bakdata.conquery.models.query.visitor.QueryVisitor;\n+\n+public interface Visitable {\n+\n+\tvoid visit(QueryVisitor visitor);\n+\t\n+\t\n+\t/**\n+\t * Checks if the query requires to resolve external ids.\n+\t * @return True if a {@link CQExternal} is found.\n+\t */\n+\tstatic boolean usesExternalIds(Visitable query) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk0NDQxMA==", "bodyText": "Und dann f\u00fcr Reused bitte auch machen?", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368944410", "createdAt": "2020-01-21T11:19:54Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/Visitable.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com.bakdata.conquery.models.query;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import com.bakdata.conquery.models.query.concept.CQElement;\n+import com.bakdata.conquery.models.query.concept.specific.CQExternal;\n+import com.bakdata.conquery.models.query.visitor.QueryVisitor;\n+\n+public interface Visitable {\n+\n+\tvoid visit(QueryVisitor visitor);\n+\t\n+\t\n+\t/**\n+\t * Checks if the query requires to resolve external ids.\n+\t * @return True if a {@link CQExternal} is found.\n+\t */\n+\tstatic boolean usesExternalIds(Visitable query) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk0MzQwNA=="}, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2NTg4OA==", "bodyText": "warum CQElement.super und nicht nur super?", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368965888", "createdAt": "2020-01-21T12:13:17Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/concept/specific/CQDateRestriction.java", "diffHunk": "@@ -84,6 +85,7 @@ public void collectNamespacedIds(Set<NamespacedId> namespacedIds) {\n \t\n \t@Override\n \tpublic void visit(QueryVisitor visitor) {\n-\t\tchild.visit(visitor);\t\t\n+\t\tCQElement.super.visit(visitor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2NTk4OQ==", "bodyText": "warum?", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368965989", "createdAt": "2020-01-21T12:13:32Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/concept/specific/CQExternal.java", "diffHunk": "@@ -181,7 +176,7 @@ public CDateSet readDates(int[] dateIndices, String[] row) throws ParsingExcepti\n \n \t@RequiredArgsConstructor\n \t@Getter\n-\tpublic static enum FormatColumn {\n+\tpublic enum FormatColumn {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2NjQzNA==", "bodyText": "@FunctionalInterface", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368966434", "createdAt": "2020-01-21T12:14:33Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/visitor/QueryVisitor.java", "diffHunk": "@@ -1,8 +1,11 @@\n package com.bakdata.conquery.models.query.visitor;\n \n-import com.bakdata.conquery.models.query.concept.specific.CQConcept;\n+import com.bakdata.conquery.models.query.concept.CQElement;\n \n+/**\n+ * Visits the elements of which a query consist.\n+ */\n public interface QueryVisitor {\n-\n-\tpublic default void visitConcept(CQConcept concept) {}\n+\t", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9858e9e95bb56c6d300b36d8d318370e3a5394a0", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/9858e9e95bb56c6d300b36d8d318370e3a5394a0", "committedDate": "2020-01-21T14:52:11Z", "message": "review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1OTQyMzAz", "url": "https://github.com/bakdata/conquery/pull/998#pullrequestreview-345942303", "createdAt": "2020-01-21T14:59:23Z", "commit": {"oid": "9858e9e95bb56c6d300b36d8d318370e3a5394a0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDo1OToyM1rOFf9FNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNTowMjowMlrOFf9Lxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MDkzMw==", "bodyText": "Doku bitte", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r369050933", "createdAt": "2020-01-21T14:59:23Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/apiv1/QueryProcessor.java", "diffHunk": "@@ -17,67 +14,37 @@\n import com.bakdata.conquery.models.query.IQuery;\n import com.bakdata.conquery.models.query.ManagedQuery;\n import com.bakdata.conquery.models.query.QueryTranslator;\n-import com.bakdata.conquery.models.query.concept.CQElement;\n-import com.bakdata.conquery.models.query.concept.ConceptQuery;\n-import com.bakdata.conquery.models.query.concept.specific.CQAnd;\n-import com.bakdata.conquery.models.query.concept.specific.CQOr;\n-import com.bakdata.conquery.models.query.concept.specific.CQReusedQuery;\n import com.bakdata.conquery.models.worker.Namespace;\n import com.bakdata.conquery.models.worker.Namespaces;\n+import com.bakdata.conquery.util.QueryUtils;\n+import com.bakdata.conquery.util.QueryUtils.ExternalIdChecker;\n+import com.bakdata.conquery.util.QueryUtils.SingleReusedChecker;\n+import lombok.Getter;\n import lombok.RequiredArgsConstructor;\n import lombok.extern.slf4j.Slf4j;\n-\n @Slf4j\n @RequiredArgsConstructor\n public class QueryProcessor {\n \n+\t@Getter\n \tprivate final Namespaces namespaces;\n \tprivate final MasterMetaStorage storage;\n \n-\t/**\n-\t * Find first and only directly ReusedQuery in the queries tree, and return its Id. ie.: arbirtary CQAnd/CQOr with only them or then a ReusedQuery.\n-\t *\n-\t * @return Null if not only a single {@link CQReusedQuery} was found beside {@link CQAnd} / {@link CQOr}.\n-\t */\n-\tprivate static ManagedExecutionId getOnlyReused(IQuery query) {\n-\n-\t\tif(!(query instanceof ConceptQuery))\n-\t\t\treturn null;\n-\n-\t\tfinal ArrayList<CQReusedQuery> queries = new ArrayList<>();\n-\n-\t\tfinal ArrayDeque<CQElement> search = new ArrayDeque<>();\n-\n-\t\tsearch.add(((ConceptQuery) query).getRoot());\n-\t\tCQElement element;\n-\n-\t\twhile((element = search.poll()) != null) {\n-\t\t\tif(element instanceof CQReusedQuery)\n-\t\t\t\tqueries.add(((CQReusedQuery) element));\n-\t\t\telse if (element instanceof CQAnd) {\n-\t\t\t\tsearch.addAll(((CQAnd) element).getChildren());\n-\t\t\t}\n-\t\t\telse if (element instanceof CQOr) {\n-\t\t\t\tsearch.addAll(((CQOr) element).getChildren());\n-\t\t\t}\n-\t\t\telse {\n-\t\t\t\treturn null;\n-\t\t\t}\n-\t\t}\n-\n-\t\treturn queries.size() == 1 ? queries.get(0).getQuery() : null;\n-\t}\n \n \t/**\n \t * Creates a query for all datasets, then submits it for execution on the\n \t * intended dataset.\n \t */\n \tpublic ExecutionStatus postQuery(Dataset dataset, IQuery query, URLBuilder urlb, User user) throws JSONException {\n \t\tNamespace namespace = namespaces.get(dataset.getId());\n+\t\t\n+\t\tExternalIdChecker externalIdChecker = new QueryUtils.ExternalIdChecker();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9858e9e95bb56c6d300b36d8d318370e3a5394a0"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MjAxOA==", "bodyText": "\"For example used in QueryProcessor to ...\"", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r369052018", "createdAt": "2020-01-21T15:01:05Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/visitor/QueryVisitor.java", "diffHunk": "@@ -1,8 +1,12 @@\n package com.bakdata.conquery.models.query.visitor;\n \n-import com.bakdata.conquery.models.query.concept.specific.CQConcept;\n+import java.util.function.Consumer;\n \n-public interface QueryVisitor {\n+import com.bakdata.conquery.models.query.concept.CQElement;\n \n-\tpublic default void visitConcept(CQConcept concept) {}\n+/**\n+ * Visits the elements of which a query consist.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9858e9e95bb56c6d300b36d8d318370e3a5394a0"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MjI3MQ==", "bodyText": "For reference implementations see ...", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r369052271", "createdAt": "2020-01-21T15:01:31Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/visitor/QueryVisitor.java", "diffHunk": "@@ -1,8 +1,12 @@\n package com.bakdata.conquery.models.query.visitor;\n \n-import com.bakdata.conquery.models.query.concept.specific.CQConcept;\n+import java.util.function.Consumer;\n \n-public interface QueryVisitor {\n+import com.bakdata.conquery.models.query.concept.CQElement;\n \n-\tpublic default void visitConcept(CQConcept concept) {}\n+/**\n+ * Visits the elements of which a query consist.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MjAxOA=="}, "originalCommit": {"oid": "9858e9e95bb56c6d300b36d8d318370e3a5394a0"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MjYxNQ==", "bodyText": "\ud83d\udcaf", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r369052615", "createdAt": "2020-01-21T15:02:02Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/util/QueryUtils.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.bakdata.conquery.util;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import com.bakdata.conquery.models.identifiable.ids.specific.ManagedExecutionId;\n+import com.bakdata.conquery.models.query.concept.CQElement;\n+import com.bakdata.conquery.models.query.concept.specific.CQAnd;\n+import com.bakdata.conquery.models.query.concept.specific.CQExternal;\n+import com.bakdata.conquery.models.query.concept.specific.CQOr;\n+import com.bakdata.conquery.models.query.concept.specific.CQReusedQuery;\n+import com.bakdata.conquery.models.query.visitor.QueryVisitor;\n+import lombok.experimental.UtilityClass;\n+\n+@UtilityClass\n+public class QueryUtils {\n+\t\n+\t/**\n+\t * Checks if the query requires to resolve external ids.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9858e9e95bb56c6d300b36d8d318370e3a5394a0"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88808ed7a19ea39c96f8fffc3d4edef657933606", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/88808ed7a19ea39c96f8fffc3d4edef657933606", "committedDate": "2020-01-21T15:08:11Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cb0d9362769c91ecb23c1bc455c1d23e619f55a", "author": {"user": {"login": "thoniTUB", "name": "MT"}}, "url": "https://github.com/bakdata/conquery/commit/8cb0d9362769c91ecb23c1bc455c1d23e619f55a", "committedDate": "2020-01-21T15:20:36Z", "message": "Merge branch 'develop' into feature/restrict-entity-upload"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4691, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}