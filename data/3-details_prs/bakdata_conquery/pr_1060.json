{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNDk1NDY3", "number": 1060, "title": "Task deleting old queries", "bodyText": "", "createdAt": "2020-02-28T17:10:09Z", "url": "https://github.com/bakdata/conquery/pull/1060", "merged": true, "mergeCommit": {"oid": "8b04cb8fdff85f088b9e4309dea2e60509324973"}, "closed": true, "closedAt": "2020-03-16T15:58:09Z", "author": {"login": "awildturtok"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIdGKJgH2gAyMzgxNDk1NDY3OjgwNDg5NTE3MGM4NzIxYmRlMmFhMWYxZTVmZjU4YzU5OTJjNDgyMWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOQQ44gH2gAyMzgxNDk1NDY3OjQ1Y2NlNWE3OTVmNzNmMjJmMTE0YzFkYzRmNGQ3YmNkMDNiZmVlNmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "804895170c8721bde2aa1f1e5ff58c5992c4821b", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/804895170c8721bde2aa1f1e5ff58c5992c4821b", "committedDate": "2020-02-27T15:31:27Z", "message": "Initial impl of QueryCleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0aabaf7fb3377e7a00c1fb4f01ad151a961336e", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/c0aabaf7fb3377e7a00c1fb4f01ad151a961336e", "committedDate": "2020-02-28T16:26:18Z", "message": "Test and fixes for QueryCleanupTask"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MTYwMjcw", "url": "https://github.com/bakdata/conquery/pull/1060#pullrequestreview-367160270", "createdAt": "2020-03-02T12:26:55Z", "commit": {"oid": "c0aabaf7fb3377e7a00c1fb4f01ad151a961336e"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMjoyNjo1NVrOFwduuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMjoyNjo1NVrOFwduuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM2MzA2NA==", "bodyText": "Gut gel\u00f6st :)", "url": "https://github.com/bakdata/conquery/pull/1060#discussion_r386363064", "createdAt": "2020-03-02T12:26:55Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/tasks/QueryCleanupTask.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package com.bakdata.conquery.tasks;\n+\n+import java.io.PrintWriter;\n+import java.time.LocalDate;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import com.bakdata.conquery.io.xodus.MasterMetaStorage;\n+import com.bakdata.conquery.models.execution.ManagedExecution;\n+import com.bakdata.conquery.models.identifiable.ids.specific.ManagedExecutionId;\n+import com.bakdata.conquery.models.query.ManagedQuery;\n+import com.bakdata.conquery.models.query.concept.specific.CQReusedQuery;\n+import com.bakdata.conquery.util.QueryUtils;\n+import com.google.common.collect.ImmutableMultimap;\n+import io.dropwizard.servlets.tasks.Task;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang3.ArrayUtils;\n+\n+/**\n+ * Dropwizard Task deleting queries that are not used anymore. Defined as:\n+ * \t- not named\n+ * \t- older than 30 days\n+ * \t- is not shared\n+ * \t- no tags\n+ * \t- not referenced by other queries\n+ */\n+@Slf4j\n+public class QueryCleanupTask extends Task {\n+\n+\tMasterMetaStorage storage;\n+\n+\tpublic QueryCleanupTask(MasterMetaStorage storage) {\n+\t\tsuper(\"query-cleanup\");\n+\t\tthis.storage = storage;\n+\t}\n+\n+\t@Override\n+\tpublic void execute(ImmutableMultimap<String, String> parameters, PrintWriter output) throws Exception {\n+\n+\t\t// Iterate for as long as no changes are needed (this is because queries can be referenced by other queries)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0aabaf7fb3377e7a00c1fb4f01ad151a961336e"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed1b0979489557c1d77770bf0274ed27749bff0", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/1ed1b0979489557c1d77770bf0274ed27749bff0", "committedDate": "2020-03-16T14:15:47Z", "message": "Merge remote-tracking branch 'origin/develop' into feature/delete-old-queries\n\n# Conflicts:\n#\tbackend/src/main/java/com/bakdata/conquery/models/execution/ManagedExecution.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91ebced799092470d29fd9eb1cc5d6d65913de2b", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/91ebced799092470d29fd9eb1cc5d6d65913de2b", "committedDate": "2020-03-16T14:39:44Z", "message": "Merge remote-tracking branch 'origin/develop' into feature/delete-old-queries\n\n# Conflicts:\n#\tbackend/src/main/java/com/bakdata/conquery/models/execution/ManagedExecution.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ef8eb48d786d31fb346d8a3de350271700d2653", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/8ef8eb48d786d31fb346d8a3de350271700d2653", "committedDate": "2020-03-16T15:03:38Z", "message": "Fixed failing QueryCleanupTaskTest: LocalDateTime::until expects LocalDateTime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45cce5a795f73f22f114c1dc4f4d7bcd03bfee6b", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/45cce5a795f73f22f114c1dc4f4d7bcd03bfee6b", "committedDate": "2020-03-16T15:57:57Z", "message": "Merge branch 'develop' into feature/delete-old-queries"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4634, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}