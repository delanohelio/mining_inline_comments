{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1MjE4MTg1", "number": 998, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMToxNzoyMlrODZdNlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNTowMjowMlrODZhf4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDE5NjA1OnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/models/query/Visitable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMToxNzoyMlrOFf2hLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMToxOTo1NFrOFf2lGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk0MzQwNA==", "bodyText": "kannst du das dahin auslagern wo es benutzt wird?", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368943404", "createdAt": "2020-01-21T11:17:22Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/Visitable.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com.bakdata.conquery.models.query;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import com.bakdata.conquery.models.query.concept.CQElement;\n+import com.bakdata.conquery.models.query.concept.specific.CQExternal;\n+import com.bakdata.conquery.models.query.visitor.QueryVisitor;\n+\n+public interface Visitable {\n+\n+\tvoid visit(QueryVisitor visitor);\n+\t\n+\t\n+\t/**\n+\t * Checks if the query requires to resolve external ids.\n+\t * @return True if a {@link CQExternal} is found.\n+\t */\n+\tstatic boolean usesExternalIds(Visitable query) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk0NDQxMA==", "bodyText": "Und dann f\u00fcr Reused bitte auch machen?", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368944410", "createdAt": "2020-01-21T11:19:54Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/Visitable.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com.bakdata.conquery.models.query;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import com.bakdata.conquery.models.query.concept.CQElement;\n+import com.bakdata.conquery.models.query.concept.specific.CQExternal;\n+import com.bakdata.conquery.models.query.visitor.QueryVisitor;\n+\n+public interface Visitable {\n+\n+\tvoid visit(QueryVisitor visitor);\n+\t\n+\t\n+\t/**\n+\t * Checks if the query requires to resolve external ids.\n+\t * @return True if a {@link CQExternal} is found.\n+\t */\n+\tstatic boolean usesExternalIds(Visitable query) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk0MzQwNA=="}, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDM0MDQyOnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/models/query/concept/specific/CQDateRestriction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjoxMzoxN1rOFf35AA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjo1NToyN1rOFf49gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2NTg4OA==", "bodyText": "warum CQElement.super und nicht nur super?", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368965888", "createdAt": "2020-01-21T12:13:17Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/concept/specific/CQDateRestriction.java", "diffHunk": "@@ -84,6 +85,7 @@ public void collectNamespacedIds(Set<NamespacedId> namespacedIds) {\n \t\n \t@Override\n \tpublic void visit(QueryVisitor visitor) {\n-\t\tchild.visit(visitor);\t\t\n+\t\tCQElement.super.visit(visitor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk4MzQyNA==", "bodyText": "Das wurde mir so vorgeschlagen. ich denke so greift man auf die default implementierung zur\u00fcck", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368983424", "createdAt": "2020-01-21T12:55:27Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/concept/specific/CQDateRestriction.java", "diffHunk": "@@ -84,6 +85,7 @@ public void collectNamespacedIds(Set<NamespacedId> namespacedIds) {\n \t\n \t@Override\n \tpublic void visit(QueryVisitor visitor) {\n-\t\tchild.visit(visitor);\t\t\n+\t\tCQElement.super.visit(visitor);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2NTg4OA=="}, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDM0MTA0OnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/models/query/concept/specific/CQExternal.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjoxMzozMlrOFf35ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjo1NTo1OVrOFf4-TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2NTk4OQ==", "bodyText": "warum?", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368965989", "createdAt": "2020-01-21T12:13:32Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/concept/specific/CQExternal.java", "diffHunk": "@@ -181,7 +176,7 @@ public CDateSet readDates(int[] dateIndices, String[] row) throws ParsingExcepti\n \n \t@RequiredArgsConstructor\n \t@Getter\n-\tpublic static enum FormatColumn {\n+\tpublic enum FormatColumn {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk4MzYyOA==", "bodyText": "Code factor meinte das sei hier redundant", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368983628", "createdAt": "2020-01-21T12:55:59Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/concept/specific/CQExternal.java", "diffHunk": "@@ -181,7 +176,7 @@ public CDateSet readDates(int[] dateIndices, String[] row) throws ParsingExcepti\n \n \t@RequiredArgsConstructor\n \t@Getter\n-\tpublic static enum FormatColumn {\n+\tpublic enum FormatColumn {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2NTk4OQ=="}, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDM0Mzc1OnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/models/query/visitor/QueryVisitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjoxNDozM1rOFf37Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjo1NzowOFrOFf5Acw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2NjQzNA==", "bodyText": "@FunctionalInterface", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368966434", "createdAt": "2020-01-21T12:14:33Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/visitor/QueryVisitor.java", "diffHunk": "@@ -1,8 +1,11 @@\n package com.bakdata.conquery.models.query.visitor;\n \n-import com.bakdata.conquery.models.query.concept.specific.CQConcept;\n+import com.bakdata.conquery.models.query.concept.CQElement;\n \n+/**\n+ * Visits the elements of which a query consist.\n+ */\n public interface QueryVisitor {\n-\n-\tpublic default void visitConcept(CQConcept concept) {}\n+\t", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk4NDE3OQ==", "bodyText": "oki", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r368984179", "createdAt": "2020-01-21T12:57:08Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/visitor/QueryVisitor.java", "diffHunk": "@@ -1,8 +1,11 @@\n package com.bakdata.conquery.models.query.visitor;\n \n-import com.bakdata.conquery.models.query.concept.specific.CQConcept;\n+import com.bakdata.conquery.models.query.concept.CQElement;\n \n+/**\n+ * Visits the elements of which a query consist.\n+ */\n public interface QueryVisitor {\n-\n-\tpublic default void visitConcept(CQConcept concept) {}\n+\t", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2NjQzNA=="}, "originalCommit": {"oid": "faceae4d9a59c3331745441d9a80ad6202acabff"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDg4NzU5OnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/apiv1/QueryProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDo1OToyM1rOFf9FNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDo1OToyM1rOFf9FNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MDkzMw==", "bodyText": "Doku bitte", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r369050933", "createdAt": "2020-01-21T14:59:23Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/apiv1/QueryProcessor.java", "diffHunk": "@@ -17,67 +14,37 @@\n import com.bakdata.conquery.models.query.IQuery;\n import com.bakdata.conquery.models.query.ManagedQuery;\n import com.bakdata.conquery.models.query.QueryTranslator;\n-import com.bakdata.conquery.models.query.concept.CQElement;\n-import com.bakdata.conquery.models.query.concept.ConceptQuery;\n-import com.bakdata.conquery.models.query.concept.specific.CQAnd;\n-import com.bakdata.conquery.models.query.concept.specific.CQOr;\n-import com.bakdata.conquery.models.query.concept.specific.CQReusedQuery;\n import com.bakdata.conquery.models.worker.Namespace;\n import com.bakdata.conquery.models.worker.Namespaces;\n+import com.bakdata.conquery.util.QueryUtils;\n+import com.bakdata.conquery.util.QueryUtils.ExternalIdChecker;\n+import com.bakdata.conquery.util.QueryUtils.SingleReusedChecker;\n+import lombok.Getter;\n import lombok.RequiredArgsConstructor;\n import lombok.extern.slf4j.Slf4j;\n-\n @Slf4j\n @RequiredArgsConstructor\n public class QueryProcessor {\n \n+\t@Getter\n \tprivate final Namespaces namespaces;\n \tprivate final MasterMetaStorage storage;\n \n-\t/**\n-\t * Find first and only directly ReusedQuery in the queries tree, and return its Id. ie.: arbirtary CQAnd/CQOr with only them or then a ReusedQuery.\n-\t *\n-\t * @return Null if not only a single {@link CQReusedQuery} was found beside {@link CQAnd} / {@link CQOr}.\n-\t */\n-\tprivate static ManagedExecutionId getOnlyReused(IQuery query) {\n-\n-\t\tif(!(query instanceof ConceptQuery))\n-\t\t\treturn null;\n-\n-\t\tfinal ArrayList<CQReusedQuery> queries = new ArrayList<>();\n-\n-\t\tfinal ArrayDeque<CQElement> search = new ArrayDeque<>();\n-\n-\t\tsearch.add(((ConceptQuery) query).getRoot());\n-\t\tCQElement element;\n-\n-\t\twhile((element = search.poll()) != null) {\n-\t\t\tif(element instanceof CQReusedQuery)\n-\t\t\t\tqueries.add(((CQReusedQuery) element));\n-\t\t\telse if (element instanceof CQAnd) {\n-\t\t\t\tsearch.addAll(((CQAnd) element).getChildren());\n-\t\t\t}\n-\t\t\telse if (element instanceof CQOr) {\n-\t\t\t\tsearch.addAll(((CQOr) element).getChildren());\n-\t\t\t}\n-\t\t\telse {\n-\t\t\t\treturn null;\n-\t\t\t}\n-\t\t}\n-\n-\t\treturn queries.size() == 1 ? queries.get(0).getQuery() : null;\n-\t}\n \n \t/**\n \t * Creates a query for all datasets, then submits it for execution on the\n \t * intended dataset.\n \t */\n \tpublic ExecutionStatus postQuery(Dataset dataset, IQuery query, URLBuilder urlb, User user) throws JSONException {\n \t\tNamespace namespace = namespaces.get(dataset.getId());\n+\t\t\n+\t\tExternalIdChecker externalIdChecker = new QueryUtils.ExternalIdChecker();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9858e9e95bb56c6d300b36d8d318370e3a5394a0"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDg5NDQ3OnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/models/query/visitor/QueryVisitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNTowMTowNVrOFf9Jcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNTowMTozMVrOFf9Kbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MjAxOA==", "bodyText": "\"For example used in QueryProcessor to ...\"", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r369052018", "createdAt": "2020-01-21T15:01:05Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/visitor/QueryVisitor.java", "diffHunk": "@@ -1,8 +1,12 @@\n package com.bakdata.conquery.models.query.visitor;\n \n-import com.bakdata.conquery.models.query.concept.specific.CQConcept;\n+import java.util.function.Consumer;\n \n-public interface QueryVisitor {\n+import com.bakdata.conquery.models.query.concept.CQElement;\n \n-\tpublic default void visitConcept(CQConcept concept) {}\n+/**\n+ * Visits the elements of which a query consist.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9858e9e95bb56c6d300b36d8d318370e3a5394a0"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MjI3MQ==", "bodyText": "For reference implementations see ...", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r369052271", "createdAt": "2020-01-21T15:01:31Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/visitor/QueryVisitor.java", "diffHunk": "@@ -1,8 +1,12 @@\n package com.bakdata.conquery.models.query.visitor;\n \n-import com.bakdata.conquery.models.query.concept.specific.CQConcept;\n+import java.util.function.Consumer;\n \n-public interface QueryVisitor {\n+import com.bakdata.conquery.models.query.concept.CQElement;\n \n-\tpublic default void visitConcept(CQConcept concept) {}\n+/**\n+ * Visits the elements of which a query consist.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MjAxOA=="}, "originalCommit": {"oid": "9858e9e95bb56c6d300b36d8d318370e3a5394a0"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDg5ODI2OnYy", "diffSide": "RIGHT", "path": "backend/src/main/java/com/bakdata/conquery/util/QueryUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNTowMjowMlrOFf9Lxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNTowMjowMlrOFf9Lxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA1MjYxNQ==", "bodyText": "\ud83d\udcaf", "url": "https://github.com/bakdata/conquery/pull/998#discussion_r369052615", "createdAt": "2020-01-21T15:02:02Z", "author": {"login": "awildturtok"}, "path": "backend/src/main/java/com/bakdata/conquery/util/QueryUtils.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.bakdata.conquery.util;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import com.bakdata.conquery.models.identifiable.ids.specific.ManagedExecutionId;\n+import com.bakdata.conquery.models.query.concept.CQElement;\n+import com.bakdata.conquery.models.query.concept.specific.CQAnd;\n+import com.bakdata.conquery.models.query.concept.specific.CQExternal;\n+import com.bakdata.conquery.models.query.concept.specific.CQOr;\n+import com.bakdata.conquery.models.query.concept.specific.CQReusedQuery;\n+import com.bakdata.conquery.models.query.visitor.QueryVisitor;\n+import lombok.experimental.UtilityClass;\n+\n+@UtilityClass\n+public class QueryUtils {\n+\t\n+\t/**\n+\t * Checks if the query requires to resolve external ids.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9858e9e95bb56c6d300b36d8d318370e3a5394a0"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1483, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}