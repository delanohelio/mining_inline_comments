{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNDk1NTMw", "number": 1393, "title": "Feature/cdate cache?", "bodyText": "", "createdAt": "2020-10-14T16:27:48Z", "url": "https://github.com/bakdata/conquery/pull/1393", "merged": true, "mergeCommit": {"oid": "61dbc28158a80dce1b2af3eb66868e7c0a82535d"}, "closed": true, "closedAt": "2020-10-20T14:10:07Z", "author": {"login": "awildturtok"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSfG6ogH2gAyNTAzNDk1NTMwOmMwZjNiNTU5MDIwNzNmY2QxNTFhYTE0OGI4ZjIwN2ViODgzOTM3MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUZYDOgFqTUxMjc1OTM4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c0f3b55902073fcd151aa148b8f207eb88393731", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/c0f3b55902073fcd151aa148b8f207eb88393731", "committedDate": "2020-10-14T15:42:29Z", "message": "Reuse CDateSets by Proxy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39bf4be8f07f86e847cc404f7d97151d0c5df1df", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/39bf4be8f07f86e847cc404f7d97151d0c5df1df", "committedDate": "2020-10-14T16:22:46Z", "message": "fix proxy not working with methods expecting other CDateSet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3147db1401f65a74d18063b1ea897486f4fcfe70", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/3147db1401f65a74d18063b1ea897486f4fcfe70", "committedDate": "2020-10-14T16:42:00Z", "message": "make BitMapCDateSet.java compatible with Proxy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87cc02539e815301248f99c0825cad92a8e8b5d0", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/87cc02539e815301248f99c0825cad92a8e8b5d0", "committedDate": "2020-10-15T08:47:10Z", "message": "reuse BitSets instead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04697b3081e87d9ff246838d59160988cfb09de5", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/04697b3081e87d9ff246838d59160988cfb09de5", "committedDate": "2020-10-15T08:53:37Z", "message": "add ref"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9462df93a5b8235876cb6b1424646e6e8a3bd008", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/9462df93a5b8235876cb6b1424646e6e8a3bd008", "committedDate": "2020-10-15T09:24:42Z", "message": "fix usage of WeakReference"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97dbe9bfcf315a2fb02730d529c942e00d5ef830", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/97dbe9bfcf315a2fb02730d529c942e00d5ef830", "committedDate": "2020-10-15T09:57:07Z", "message": "Add documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df6b8adeab9903e430ad41ff2e834d8ce32d0b02", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/df6b8adeab9903e430ad41ff2e834d8ce32d0b02", "committedDate": "2020-10-15T10:46:14Z", "message": "Apply usage of CDateSetCache where it makes sense"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d60c20bc2c1c7f06f849e9788ab9bcf8e0b798d4", "author": {"user": {"login": "bakdata-bot", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/d60c20bc2c1c7f06f849e9788ab9bcf8e0b798d4", "committedDate": "2020-10-15T10:48:33Z", "message": "automatic update to docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "328e746dc6a4b7f51c5eecc11c9c11d5628f54bb", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/328e746dc6a4b7f51c5eecc11c9c11d5628f54bb", "committedDate": "2020-10-15T13:02:50Z", "message": "dont query size if we are not interested"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ea56feb18f1d86db1049d9f13dd928b0e3496a4", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/6ea56feb18f1d86db1049d9f13dd928b0e3496a4", "committedDate": "2020-10-15T14:20:50Z", "message": "remove logging as that was causing slowdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMzg1OTIx", "url": "https://github.com/bakdata/conquery/pull/1393#pullrequestreview-512385921", "createdAt": "2020-10-20T07:01:12Z", "commit": {"oid": "6ea56feb18f1d86db1049d9f13dd928b0e3496a4"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNzowMToxM1rOHktY-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNzowNzo0N1rOHktleg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI1NDQ1OA==", "bodyText": "container kann in die While-Schleife um den Scope zu verkleinern.", "url": "https://github.com/bakdata/conquery/pull/1393#discussion_r508254458", "createdAt": "2020-10-20T07:01:13Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/common/CDateSetCache.java", "diffHunk": "@@ -0,0 +1,90 @@\n+package com.bakdata.conquery.models.common;\n+\n+import java.lang.ref.Cleaner;\n+import java.lang.ref.Reference;\n+import java.lang.ref.SoftReference;\n+import java.util.BitSet;\n+import java.util.Queue;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Data;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * Cache to avoid constant reallocation of huge CDateSets, instead cache/reuse their BitSets by way of a {@link Cleaner} that hooks into the GC and will give us those objects back.\n+ * <p>\n+ * The underlying data-structures are also maintained as {@link SoftReference} such that they are also subject to GC when memory is demanded.\n+ */\n+@Slf4j\n+public class CDateSetCache {\n+\n+\tprivate static final CDateSetCache dateSetCache = new CDateSetCache();\n+\tprotected final Queue<Reference<Container>> pool;\n+\tprivate final Cleaner cleaner = Cleaner.create();\n+\n+\tprivate CDateSetCache() {\n+\t\tpool = new ConcurrentLinkedQueue<>();\n+\t}\n+\n+\t/**\n+\t * Preallocate the DateSet, such that typical queries don't have to grow them while executing.\n+\t * The numbers are just best guesses and can be fine tuned if desired but configuration is probably not important.\n+\t */\n+\tpublic static BitMapCDateSet createPreAllocatedDateSet() {\n+\t\treturn dateSetCache.acquire();\n+\t}\n+\n+\tpublic BitMapCDateSet acquire() {\n+\t\tfinal BitMapCDateSet out = doAcquire();\n+\n+\t\t// create and maintain hardref on the bitsets\n+\t\tfinal Container container = new Container(out.getNegativeBits(), out.getPositiveBits());\n+\n+\t\tcleaner.register(out, () -> {\n+\t\t\t// Reset the bitsets\n+\t\t\tcontainer.getLeft().clear();\n+\t\t\tcontainer.getRight().clear();\n+\n+\t\t\t// Add reference of container to the bitset, so that they can be freed if memory is demanded.\n+\t\t\tpool.add(new SoftReference<>(container));\n+\t\t});\n+\n+\t\treturn out;\n+\t}\n+\n+\t/**\n+\t * Try to reuse old BitSets if available. Else create a new one.\n+\t */\n+\tprivate BitMapCDateSet doAcquire() {\n+\t\tReference<Container> reference;\n+\t\tContainer container;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ea56feb18f1d86db1049d9f13dd928b0e3496a4"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI1NzY1OA==", "bodyText": "Du kannst hier return BitMapCDateSet.create(CDateRange.of(start, end)); machen. Das of kann mit null umgehen, so wie ich das sehe.", "url": "https://github.com/bakdata/conquery/pull/1393#discussion_r508257658", "createdAt": "2020-10-20T07:07:47Z", "author": {"login": "thoniTUB"}, "path": "backend/src/main/java/com/bakdata/conquery/models/query/concept/specific/CQExternal.java", "diffHunk": "@@ -133,38 +132,32 @@ public void collectResultInfos(ResultInfoCollector collector) {\n \t\tEVENT_DATE {\n \t\t\t@Override\n \t\t\tpublic BitMapCDateSet readDates(int[] dateIndices, String[] row) throws ParsingException {\n-\t\t\t\treturn BitMapCDateSet.create(Collections.singleton(CDateRange.exactly(DateFormats.parseToLocalDate(row[dateIndices[0]]))));\n+\t\t\t\treturn BitMapCDateSet.create(CDateRange.exactly(DateFormats.parseToLocalDate(row[dateIndices[0]])));\n \t\t\t}\n \t\t},\n \t\tSTART_END_DATE {\n \t\t\t@Override\n \t\t\tpublic BitMapCDateSet readDates(int[] dateIndices, String[] row) throws ParsingException {\n \t\t\t\tLocalDate start = row[dateIndices[0]] == null ? null : DateFormats.parseToLocalDate(row[dateIndices[0]]);\n \t\t\t\tLocalDate end = (dateIndices.length < 2 || row[dateIndices[1]] == null) ?\n-\t\t\t\t\tnull :\n-\t\t\t\t\t\t\t\t DateFormats.parseToLocalDate(row[dateIndices[1]]);\n+\t\t\t\t\t\t\t\tnull :\n+\t\t\t\t\t\t\t\tDateFormats.parseToLocalDate(row[dateIndices[1]]);\n \n \t\t\t\tCDateRange range;\n-\t\t\t\tif (start != null && end != null) {\n-\t\t\t\t\trange = CDateRange.of(start, end);\n-\t\t\t\t}\n-\t\t\t\telse if (start != null) {\n-\t\t\t\t\trange = CDateRange.atLeast(start);\n-\t\t\t\t}\n-\t\t\t\telse if (end != null) {\n-\t\t\t\t\trange = CDateRange.atMost(end);\n+\t\t\t\tif (start == null && end == null) {\n+\t\t\t\t\treturn null;\n \t\t\t\t}\n \t\t\t\telse {\n-\t\t\t\t\treturn null;\n+\t\t\t\t\trange = CDateRange.of(start, end);\n \t\t\t\t}\n \n-\t\t\t\treturn BitMapCDateSet.create(Collections.singleton(range));\n+\t\t\t\treturn BitMapCDateSet.create(range);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ea56feb18f1d86db1049d9f13dd928b0e3496a4"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c10916da9dedd5ac2e6ffc151bd76ac9272bb23", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/0c10916da9dedd5ac2e6ffc151bd76ac9272bb23", "committedDate": "2020-10-20T09:33:15Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f78216f7ecfab5a362a0204548482edfbb4d4f26", "author": {"user": {"login": "awildturtok", "name": null}}, "url": "https://github.com/bakdata/conquery/commit/f78216f7ecfab5a362a0204548482edfbb4d4f26", "committedDate": "2020-10-20T12:57:46Z", "message": "add logging for CollectQueryResult ShardResult"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNzU5Mzgz", "url": "https://github.com/bakdata/conquery/pull/1393#pullrequestreview-512759383", "createdAt": "2020-10-20T14:09:37Z", "commit": {"oid": "f78216f7ecfab5a362a0204548482edfbb4d4f26"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4828, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}