{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwODU0MTAx", "number": 2865, "title": "Core - filterMembers method optimization", "bodyText": "The method filterMembersByMembershipTypeInGroup needed to be\noptimized, it was running very slowly. The old implementation was slow\nbecause of use of iterators with removal. Each removal caused the whole\narray to be moved in memory and this was really slow.\nFrom my measurements, the new implementation should be atleast 10x\nfaster (depending on the ratio of DIRECT and INDIRECT relationships for\ngiven members).", "createdAt": "2020-08-20T11:46:36Z", "url": "https://github.com/CESNET/perun/pull/2865", "merged": true, "mergeCommit": {"oid": "cfd6bb0a1c8fe6257a9dedd8ace40b32794b126a"}, "closed": true, "closedAt": "2020-09-02T09:18:02Z", "author": {"login": "Vojtech-Sassmann"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAv_p1AH2gAyNDcwODU0MTAxOmEwODU0NzE4NWM0MDBlMjk5OTNhZmNiYzQ3NzMyMGNmOTIyOWRmYzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE4bNQAFqTQ4MDYzNTM1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a08547185c400e29993afcbc477320cf9229dfc5", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/a08547185c400e29993afcbc477320cf9229dfc5", "committedDate": "2020-08-20T13:12:18Z", "message": "Core - filterMembers method optimization\n\n* The method filterMembersByMembershipTypeInGroup needed to be\noptimized, it was running very slowly. The old implementation was slow\nbecause of use of iterators with removal. Each removal caused the whole\narray to be moved in memory and this was really slow.\n* From my measurements, the new implementation should be atleast 10x\nfaster (depending on the retaio of DIRECT and INDIRECT relationships for\ngiven members)."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7bdc08319c4e60ee1afd68b3087c714459bf19c", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/e7bdc08319c4e60ee1afd68b3087c714459bf19c", "committedDate": "2020-08-20T11:44:40Z", "message": "Core - filterMembers method optimization\n\n* The method filterMembersByMembershipTypeInGroup needed to be\noptimized, it was running very slowly. The old implementation was slow\nbecause of use of iterators with removal. Each removal caused the whole\narray to be moved in memory and this was really slow.\n* From my measurements, the new implementation should be atleast 5x\nfaster (depending on the retaio of DIRECT and INDIRECT relationships for\ngiven members)."}, "afterCommit": {"oid": "a08547185c400e29993afcbc477320cf9229dfc5", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/a08547185c400e29993afcbc477320cf9229dfc5", "committedDate": "2020-08-20T13:12:18Z", "message": "Core - filterMembers method optimization\n\n* The method filterMembersByMembershipTypeInGroup needed to be\noptimized, it was running very slowly. The old implementation was slow\nbecause of use of iterators with removal. Each removal caused the whole\narray to be moved in memory and this was really slow.\n* From my measurements, the new implementation should be atleast 10x\nfaster (depending on the retaio of DIRECT and INDIRECT relationships for\ngiven members)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNjQyOTIw", "url": "https://github.com/CESNET/perun/pull/2865#pullrequestreview-471642920", "createdAt": "2020-08-20T13:59:03Z", "commit": {"oid": "a08547185c400e29993afcbc477320cf9229dfc5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MTc0ODMz", "url": "https://github.com/CESNET/perun/pull/2865#pullrequestreview-474174833", "createdAt": "2020-08-25T06:38:15Z", "commit": {"oid": "a08547185c400e29993afcbc477320cf9229dfc5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwNjozODoxNVrOHGJlEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwNjozODoxNVrOHGJlEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIxMDQ0OA==", "bodyText": "I am just curious. Is this distinct necessary?", "url": "https://github.com/CESNET/perun/pull/2865#discussion_r476210448", "createdAt": "2020-08-25T06:38:15Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -2401,36 +2402,61 @@ public void checkGroupExists(PerunSession sess, Group group) throws GroupNotExis\n \n \t@Override\n \tpublic List<Member> filterMembersByMembershipTypeInGroup(List<Member> members) {\n-\t\tSet<Member> filteredMembers = new HashSet<>();\n-\t\tIterator<Member> membersIterator = members.iterator();\n+\t\tMap<Integer, List<Member>> indirectMembersById = members.stream()\n+\t\t\t\t.filter(m -> m.getMembershipType().equals(MembershipType.INDIRECT))\n+\t\t\t\t.collect(groupingBy(Member::getId, toList()));\n \n-\t\t//Add members with direct membership type\n-\t\twhile(membersIterator.hasNext()) {\n-\t\t\tMember m = membersIterator.next();\n-\t\t\tif(m.getMembershipType().equals(MembershipType.DIRECT)) {\n-\t\t\t\tfilteredMembers.add(m);\n-\t\t\t\tmembersIterator.remove();\n-\t\t\t}\n-\t\t}\n+\t\tList<Member> directMembers = members.stream()\n+\t\t\t\t.filter(m -> m.getMembershipType().equals(MembershipType.DIRECT))\n+\t\t\t\t.distinct()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a08547185c400e29993afcbc477320cf9229dfc5"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjM1MzU4", "url": "https://github.com/CESNET/perun/pull/2865#pullrequestreview-480635358", "createdAt": "2020-09-02T09:17:20Z", "commit": {"oid": "a08547185c400e29993afcbc477320cf9229dfc5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1176, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}