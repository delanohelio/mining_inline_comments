{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NjQwMTYz", "number": 2648, "title": "Fix wrong exception when updating group with existing name", "bodyText": "when we are trying to update a group's name with name which is\nalready occupied in the same VO, we need to throw GroupExistsException\ninstead of SQL constraint exception", "createdAt": "2020-03-30T13:11:17Z", "url": "https://github.com/CESNET/perun/pull/2648", "merged": true, "mergeCommit": {"oid": "95b8e8a087b6d6356dde2b58a63a652fc88be91c"}, "closed": true, "closedAt": "2020-03-31T17:02:21Z", "author": {"login": "stavamichal"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS9bk9gFqTM4NDQ0NDA0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTDdE1gBqjMxODM0MTQ0Nzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDQ0MDQw", "url": "https://github.com/CESNET/perun/pull/2648#pullrequestreview-384444040", "createdAt": "2020-03-31T06:49:54Z", "commit": {"oid": "17d92fdc5226cbed1242f29c91f91ecd63d54200"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjo0OTo1NFrOF-Hiag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjo0OTo1NFrOF-Hiag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3OTUzMA==", "bodyText": "We can check this using SQL constraint itself in impl/dao layer, since we update name and description separately. We can catch DataIntegrityViolationException when updating name and then throw GroupExistsException rather than current InternalErrorException. See example in FacilitiesManagerImpl method updateFacility().", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400679530", "createdAt": "2020-03-31T06:49:54Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -200,7 +200,7 @@ public void deleteGroups(PerunSession perunSession, List<Group> groups, boolean\n \t}\n \n \t@Override\n-\tpublic Group updateGroup(PerunSession sess, Group group) throws GroupNotExistsException, InternalErrorException, PrivilegeException {\n+\tpublic Group updateGroup(PerunSession sess, Group group) throws GroupNotExistsException, GroupExistsException, InternalErrorException, PrivilegeException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17d92fdc5226cbed1242f29c91f91ecd63d54200"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17d92fdc5226cbed1242f29c91f91ecd63d54200", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/17d92fdc5226cbed1242f29c91f91ecd63d54200", "committedDate": "2020-03-30T13:08:22Z", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception"}, "afterCommit": {"oid": "fe893d467d0654cf9999e6fa6a35be1763fd53e7", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/fe893d467d0654cf9999e6fa6a35be1763fd53e7", "committedDate": "2020-03-31T08:24:41Z", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe893d467d0654cf9999e6fa6a35be1763fd53e7", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/fe893d467d0654cf9999e6fa6a35be1763fd53e7", "committedDate": "2020-03-31T08:24:41Z", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception"}, "afterCommit": {"oid": "1de1e1a33d2868df720efab3a347a8201112be79", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/1de1e1a33d2868df720efab3a347a8201112be79", "committedDate": "2020-03-31T08:26:07Z", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1de1e1a33d2868df720efab3a347a8201112be79", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/1de1e1a33d2868df720efab3a347a8201112be79", "committedDate": "2020-03-31T08:26:07Z", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception"}, "afterCommit": {"oid": "3086980616fc552c3eebda89dea4039921486f07", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/3086980616fc552c3eebda89dea4039921486f07", "committedDate": "2020-03-31T08:27:03Z", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NTE5Nzk1", "url": "https://github.com/CESNET/perun/pull/2648#pullrequestreview-384519795", "createdAt": "2020-03-31T08:41:47Z", "commit": {"oid": "3086980616fc552c3eebda89dea4039921486f07"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwODo0MTo0N1rOF-LQlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwODo0MTo0N1rOF-LQlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0MDUwMA==", "bodyText": "Maybe we should include used name in the exception text.", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400740500", "createdAt": "2020-03-31T08:41:47Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -212,6 +214,8 @@ public Group updateGroup(PerunSession sess, Group group) throws InternalErrorExc\n \t\t\ttry {\n \t\t\t\tjdbc.update(\"update groups set name=?,modified_by=?, modified_by_uid=?, modified_at=\" + Compatibility.getSysdate() + \" where id=?\", dbGroup.getName(),\n \t\t\t\t\t\tsess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getUserId(), dbGroup.getId());\n+\t\t\t} catch (DataIntegrityViolationException e) {\n+\t\t\t\tthrow new GroupExistsException(\"The name must be unique and it's already occupied.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3086980616fc552c3eebda89dea4039921486f07"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3086980616fc552c3eebda89dea4039921486f07", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/3086980616fc552c3eebda89dea4039921486f07", "committedDate": "2020-03-31T08:27:03Z", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception"}, "afterCommit": {"oid": "2c2879d205d581556ff94e441e022fe2c99b5280", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/2c2879d205d581556ff94e441e022fe2c99b5280", "committedDate": "2020-03-31T12:59:13Z", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NzA4MDU2", "url": "https://github.com/CESNET/perun/pull/2648#pullrequestreview-384708056", "createdAt": "2020-03-31T13:02:01Z", "commit": {"oid": "2c2879d205d581556ff94e441e022fe2c99b5280"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NzE4MTcx", "url": "https://github.com/CESNET/perun/pull/2648#pullrequestreview-384718171", "createdAt": "2020-03-31T13:13:34Z", "commit": {"oid": "2c2879d205d581556ff94e441e022fe2c99b5280"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMzoxMzozNVrOF-VIPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMzoxMzozNVrOF-VIPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkwMjIwNQ==", "bodyText": "Unused import.", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400902205", "createdAt": "2020-03-31T13:13:35Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -18,6 +18,7 @@\n import cz.metacentrum.perun.core.api.Vo;\n import cz.metacentrum.perun.core.api.exceptions.AlreadyMemberException;\n import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.FacilityExistsException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c2879d205d581556ff94e441e022fe2c99b5280"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8d617a8dac497a738048c5f097dc99d793b5b74", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/f8d617a8dac497a738048c5f097dc99d793b5b74", "committedDate": "2020-03-31T13:51:53Z", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c2879d205d581556ff94e441e022fe2c99b5280", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/2c2879d205d581556ff94e441e022fe2c99b5280", "committedDate": "2020-03-31T12:59:13Z", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception"}, "afterCommit": {"oid": "f8d617a8dac497a738048c5f097dc99d793b5b74", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/f8d617a8dac497a738048c5f097dc99d793b5b74", "committedDate": "2020-03-31T13:51:53Z", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1316, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}