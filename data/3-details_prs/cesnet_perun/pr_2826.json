{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MDY0MTI1", "number": 2826, "title": "Change of lightweightSynchronization to not add members not in Perun", "bodyText": "now if synchronization is lightweight, it does not add new members unless they are already in Perun, instead it just skips them and logs them\nchange also reflected in javadoc", "createdAt": "2020-07-30T10:43:07Z", "url": "https://github.com/CESNET/perun/pull/2826", "merged": true, "mergeCommit": {"oid": "89efdb5ea66e4e40c7d7adbb7646b27a7bc2e3c6"}, "closed": true, "closedAt": "2020-08-07T11:55:36Z", "author": {"login": "metodej"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc59QXZgH2gAyNDU5MDY0MTI1OmQxZGVmNGFlNDc4OGU4YWE2YWEwMjU1YTc4MWUxYjBhZDNmZWFhMWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8glFCAFqTQ2MzE0OTk5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d1def4ae4788e8aa6aa0255a781e1b0ad3feaa1a", "author": {"user": {"login": "metodej", "name": null}}, "url": "https://github.com/CESNET/perun/commit/d1def4ae4788e8aa6aa0255a781e1b0ad3feaa1a", "committedDate": "2020-07-30T10:41:51Z", "message": "Change of lightweightSynchronization to not add members not in Perun\n\n- now if synchronization is lightweight, it does not add new members unless they are already in Perun, instead it just skips them and logs them\n- change also reflected in javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzA0MTg1", "url": "https://github.com/CESNET/perun/pull/2826#pullrequestreview-458304185", "createdAt": "2020-07-30T11:11:55Z", "commit": {"oid": "d1def4ae4788e8aa6aa0255a781e1b0ad3feaa1a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMToxMTo1NVrOG5enIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzoyOTo1OVrOG5jEjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMzU1NA==", "bodyText": "Add also information about group (for which synchronization was running).", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r462923554", "createdAt": "2020-07-30T11:11:55Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -2926,19 +2926,14 @@ private void categorizeMembersForLightweightSynchronization(PerunSession sess, G\n \t\t\t\t}\n \t\t\t}\n \n+\t\t\t// If user not found in perun, skip him and log it\n \t\t\tif (user == null) {\n-\t\t\t\t//If not find, get more information about him from member extSource\n-\t\t\t\tList<Map<String, String>> subjectToConvert = Collections.singletonList(subjectFromLoginSource);\n-\t\t\t\tList<Candidate> convertedCandidatesList = convertSubjectsToCandidates(sess, subjectToConvert, memberSource, loginSource, groupMembers, skippedMembers);\n-\t\t\t\t//Empty means not found (skipped)\n-\t\t\t\tif(!convertedCandidatesList.isEmpty()) {\n-\t\t\t\t\t//We add one subject so we take the one converted candidate\n-\t\t\t\t\tcandidate = convertedCandidatesList.get(0);\n-\t\t\t\t}\n+\t\t\t\tlog.debug(\"Subject {} with login {} was skipped during lightweight synchronization because he is not in perun yet.\", subjectFromLoginSource, login);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1def4ae4788e8aa6aa0255a781e1b0ad3feaa1a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5NjYyMg==", "bodyText": "This is now much harder to read so we probably need to change the code a little.\nI would suggest defining all possible situations we can reach:\n\nThe user was found by extSource or additional user extSource => user is not null, need to process more\nThe user wasn't found => user is null, the situation will be logged and skipped\n\nAnd you can say that there are only 2 possible ways how to process the situation 1:\n\nthe user is already a member of the group =>just revalidate him if possible and remove him from the list idsOfUsersInGroup\nthe user is not yet a member of the group => create a candidate, add him to candidatesToAdd\n\nWhat do you think? In my opinion, this way it will be much easier for reading.", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r462996622", "createdAt": "2020-07-30T13:29:59Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -2951,11 +2946,8 @@ private void categorizeMembersForLightweightSynchronization(PerunSession sess, G\n \t\t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tidsOfUsersInGroup.remove(user.getId());\n-\t\t\t} else if (candidate != null) {\n-\t\t\t\tcandidatesToAdd.add(candidate);\n \t\t\t} else {\n-\t\t\t\t//Both null means that we can't find subject by login in extSource at all (will be in skipped members)\n-\t\t\t\tlog.debug(\"Subject with login {} was skipped because can't be found in extSource {}.\", login, memberSource);\n+\t\t\t\tcandidatesToAdd.add(candidate);\n \t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1def4ae4788e8aa6aa0255a781e1b0ad3feaa1a"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NDMyODUz", "url": "https://github.com/CESNET/perun/pull/2826#pullrequestreview-458432853", "createdAt": "2020-07-30T14:04:26Z", "commit": {"oid": "d1def4ae4788e8aa6aa0255a781e1b0ad3feaa1a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNDowNDoyNlrOG5khxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNDowNDoyNlrOG5khxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAyMDQ4NA==", "bodyText": "I agree that the current state is difficult to understand, the suggested change looks good.", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r463020484", "createdAt": "2020-07-30T14:04:26Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -2951,11 +2946,8 @@ private void categorizeMembersForLightweightSynchronization(PerunSession sess, G\n \t\t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tidsOfUsersInGroup.remove(user.getId());\n-\t\t\t} else if (candidate != null) {\n-\t\t\t\tcandidatesToAdd.add(candidate);\n \t\t\t} else {\n-\t\t\t\t//Both null means that we can't find subject by login in extSource at all (will be in skipped members)\n-\t\t\t\tlog.debug(\"Subject with login {} was skipped because can't be found in extSource {}.\", login, memberSource);\n+\t\t\t\tcandidatesToAdd.add(candidate);\n \t\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk5NjYyMg=="}, "originalCommit": {"oid": "d1def4ae4788e8aa6aa0255a781e1b0ad3feaa1a"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02b9fd117b17f3d870e566a2f4221a4fa1c259a9", "author": {"user": {"login": "metodej", "name": null}}, "url": "https://github.com/CESNET/perun/commit/02b9fd117b17f3d870e566a2f4221a4fa1c259a9", "committedDate": "2020-08-04T10:05:00Z", "message": "Fixes based of review\n\n- categorizeMembersForLightweightSynchronization was restructured for better readibility\n- lightweight synchronization adds new members only if they are already in vo of the group, otherwise skips and logs them\n- also updated javadoc of the method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNDI2NzQ5", "url": "https://github.com/CESNET/perun/pull/2826#pullrequestreview-461426749", "createdAt": "2020-08-05T07:57:19Z", "commit": {"oid": "02b9fd117b17f3d870e566a2f4221a4fa1c259a9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNzo1NzoxOVrOG7-hLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNzo1Nzo1M1rOG7-iXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU0MzQ3MA==", "bodyText": "Call users manager in Bl instead in Entry. This will prevent throwing a privilege exception.", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r465543470", "createdAt": "2020-08-05T07:57:19Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -2910,52 +2909,45 @@ private void categorizeMembersForLightweightSynchronization(PerunSession sess, G\n \t\t\t} catch (UserExtSourceNotExistsException e) {\n \t\t\t\t//skipping, this extSource does not exist and thus won't be in the list\n \t\t\t}\n+\t\t\tVo groupVo = getVo(sess, group);\n \t\t\tList<UserExtSource> additionalUserExtSources = Utils.extractAdditionalUserExtSources(sess, subjectFromLoginSource);\n \t\t\tuserExtSources.addAll(additionalUserExtSources);\n \t\t\tfor (UserExtSource source : userExtSources) {\n \t\t\t\ttry {\n \t\t\t\t\tuser = getPerunBl().getUsersManagerBl().getUserByUserExtSource(sess, source);\n-\t\t\t\t\tif(!idsOfUsersInGroup.containsKey(user.getId())) {\n-\t\t\t\t\t\tcandidate = new Candidate(user, source);\n-\t\t\t\t\t\t//for lightweight synchronization we want to skip all update of attributes\n-\t\t\t\t\t\tcandidate.setAttributes(new HashMap<>());\n+\t\t\t\t\t// check if user is already member of group's vo\n+\t\t\t\t\tif (sess.getPerun().getUsersManager().getVosWhereUserIsMember(sess, user).contains(groupVo)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02b9fd117b17f3d870e566a2f4221a4fa1c259a9"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU0Mzc3NA==", "bodyText": "This is definitely not needed, privilege exception is wrong in Bl layer.", "url": "https://github.com/CESNET/perun/pull/2826#discussion_r465543774", "createdAt": "2020-08-05T07:57:53Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -2910,52 +2909,45 @@ private void categorizeMembersForLightweightSynchronization(PerunSession sess, G\n \t\t\t} catch (UserExtSourceNotExistsException e) {\n \t\t\t\t//skipping, this extSource does not exist and thus won't be in the list\n \t\t\t}\n+\t\t\tVo groupVo = getVo(sess, group);\n \t\t\tList<UserExtSource> additionalUserExtSources = Utils.extractAdditionalUserExtSources(sess, subjectFromLoginSource);\n \t\t\tuserExtSources.addAll(additionalUserExtSources);\n \t\t\tfor (UserExtSource source : userExtSources) {\n \t\t\t\ttry {\n \t\t\t\t\tuser = getPerunBl().getUsersManagerBl().getUserByUserExtSource(sess, source);\n-\t\t\t\t\tif(!idsOfUsersInGroup.containsKey(user.getId())) {\n-\t\t\t\t\t\tcandidate = new Candidate(user, source);\n-\t\t\t\t\t\t//for lightweight synchronization we want to skip all update of attributes\n-\t\t\t\t\t\tcandidate.setAttributes(new HashMap<>());\n+\t\t\t\t\t// check if user is already member of group's vo\n+\t\t\t\t\tif (sess.getPerun().getUsersManager().getVosWhereUserIsMember(sess, user).contains(groupVo)) {\n+\t\t\t\t\t\tif (idsOfUsersInGroup.containsKey(user.getId())) {\n+\t\t\t\t\t\t\t//we can skip this one, because he is already in group, and remove him from the map\n+\t\t\t\t\t\t\t//but first we need to also validate him if he was disabled before (invalidate and then validate)\n+\t\t\t\t\t\t\tRichMember richMember = idsOfUsersInGroup.get(user.getId());\n+\t\t\t\t\t\t\tif (richMember != null && Status.DISABLED.equals(richMember.getStatus())) {\n+\t\t\t\t\t\t\t\tgetPerunBl().getMembersManagerBl().invalidateMember(sess, richMember);\n+\t\t\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\t\t\tgetPerunBl().getMembersManagerBl().validateMember(sess, richMember);\n+\t\t\t\t\t\t\t\t} catch (WrongAttributeValueException | WrongReferenceAttributeValueException e) {\n+\t\t\t\t\t\t\t\t\tlog.info(\"Switching member id {} into INVALID state from DISABLED, because there was problem with attributes {}.\", richMember.getId(), e);\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tidsOfUsersInGroup.remove(user.getId());\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t//he is not yet in group, so we need to create a candidate\n+\t\t\t\t\t\t\tCandidate candidate = new Candidate(user, source);\n+\t\t\t\t\t\t\t//for lightweight synchronization we want to skip all update of attributes\n+\t\t\t\t\t\t\tcandidate.setAttributes(new HashMap<>());\n+\t\t\t\t\t\t\tcandidatesToAdd.add(candidate);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n-\t\t\t\t\tbreak;\n-\t\t\t\t} catch(UserNotExistsException e) {\n+\t\t\t\t} catch(UserNotExistsException | PrivilegeException e) {\n \t\t\t\t\t//skip because the user from this ExtSource does not exist so we can continue\n+\t\t\t\t\t//skip because we do not have privilege to get vos of this user", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02b9fd117b17f3d870e566a2f4221a4fa1c259a9"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8389f51cf70a522ef0a277016efd8e8fa9650610", "author": {"user": {"login": "metodej", "name": null}}, "url": "https://github.com/CESNET/perun/commit/8389f51cf70a522ef0a277016efd8e8fa9650610", "committedDate": "2020-08-05T09:28:52Z", "message": "Fixes based on review\n\n- fixed call of userManager in categorizeMembersForLightweightSynchronization to use Bl layer instead of entry"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxODA2OTM3", "url": "https://github.com/CESNET/perun/pull/2826#pullrequestreview-461806937", "createdAt": "2020-08-05T16:01:42Z", "commit": {"oid": "8389f51cf70a522ef0a277016efd8e8fa9650610"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMTQ5OTk4", "url": "https://github.com/CESNET/perun/pull/2826#pullrequestreview-463149998", "createdAt": "2020-08-07T08:59:00Z", "commit": {"oid": "8389f51cf70a522ef0a277016efd8e8fa9650610"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1137, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}