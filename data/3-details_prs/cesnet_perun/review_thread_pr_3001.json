{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3Mzk3NDcz", "number": 3001, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMjoxNToyN1rOE9M5_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTozNDowMVrOE9SB7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjEwMDQ1OnYy", "diffSide": "RIGHT", "path": "perun-utils/systemd/perun-auditlogger.service", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMjoxNToyN1rOH5wvVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMzozNjo1NlrOH5zwVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyOTQzMA==", "bodyText": "perun-engine -> perun-auditlogger", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530329430", "createdAt": "2020-11-25T12:15:27Z", "author": {"login": "zlamalp"}, "path": "perun-utils/systemd/perun-auditlogger.service", "diffHunk": "@@ -0,0 +1,18 @@\n+# Systemd unit file for perun-auditlogger\n+#\n+#\n+\n+[Unit]\n+Description=Perun-auditlogger\n+After=perun.service\n+\n+[Service]\n+Type=forking\n+ExecStart=/bin/bash /home/perun/perun-auditlogger/start_auditlogger.sh\n+ExecStop=/bin/bash /home/perun/perun-engine/stop_auditlogger.sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3ODgzOA==", "bodyText": "Fixed.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530378838", "createdAt": "2020-11-25T13:36:56Z", "author": {"login": "mvocu"}, "path": "perun-utils/systemd/perun-auditlogger.service", "diffHunk": "@@ -0,0 +1,18 @@\n+# Systemd unit file for perun-auditlogger\n+#\n+#\n+\n+[Unit]\n+Description=Perun-auditlogger\n+After=perun.service\n+\n+[Service]\n+Type=forking\n+ExecStart=/bin/bash /home/perun/perun-auditlogger/start_auditlogger.sh\n+ExecStop=/bin/bash /home/perun/perun-engine/stop_auditlogger.sh", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyOTQzMA=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjEwOTkzOnYy", "diffSide": "RIGHT", "path": "perun-utils/init.d-scripts/perun-auditlogger.debian", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMjoxODoxMVrOH5w1PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMzozNzozNVrOH5zx3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMzMDk0MQ==", "bodyText": "I wouldn't keep theses \"changes\" here, since it was related to the original script.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530330941", "createdAt": "2020-11-25T12:18:11Z", "author": {"login": "zlamalp"}, "path": "perun-utils/init.d-scripts/perun-auditlogger.debian", "diffHunk": "@@ -0,0 +1,165 @@\n+#! /bin/sh\n+### BEGIN INIT INFO\n+# Provides:             perun-auditlogger\n+# Required-Start:       $local_fs $remote_fs $network\n+# Required-Stop:        $local_fs $remote_fs\n+# Default-Start:        2 3 4 5\n+# Default-Stop:         0 1 6\n+# Short-Description:    Perun AuditLogger\n+# Description:          Starts Perun AuditLogger component.\n+### END INIT INFO\n+#\n+# Written by Michal Prochazka <michalp@ics.muni.cz>\n+# Modified by Pavel Zlamal <zlamal@cesnet.cz>\n+# Modified by Michal Vocu <michal.vocu@gmail.com>\n+#\n+# 22.06.2017 Use /etc/perun/logback-auditlogger.xml and /var/log/perun/\n+# 24.03.2016 Create /var/run/perun if not exists, will work when started on system boot", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3OTIyOA==", "bodyText": "Fixed.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530379228", "createdAt": "2020-11-25T13:37:35Z", "author": {"login": "mvocu"}, "path": "perun-utils/init.d-scripts/perun-auditlogger.debian", "diffHunk": "@@ -0,0 +1,165 @@\n+#! /bin/sh\n+### BEGIN INIT INFO\n+# Provides:             perun-auditlogger\n+# Required-Start:       $local_fs $remote_fs $network\n+# Required-Stop:        $local_fs $remote_fs\n+# Default-Start:        2 3 4 5\n+# Default-Stop:         0 1 6\n+# Short-Description:    Perun AuditLogger\n+# Description:          Starts Perun AuditLogger component.\n+### END INIT INFO\n+#\n+# Written by Michal Prochazka <michalp@ics.muni.cz>\n+# Modified by Pavel Zlamal <zlamal@cesnet.cz>\n+# Modified by Michal Vocu <michal.vocu@gmail.com>\n+#\n+# 22.06.2017 Use /etc/perun/logback-auditlogger.xml and /var/log/perun/\n+# 24.03.2016 Create /var/run/perun if not exists, will work when started on system boot", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMzMDk0MQ=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjMxMTQxOnYy", "diffSide": "RIGHT", "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/main/AuditLoggerStarter.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMzowOTozMFrOH5yuwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNDowNTozNlrOH505-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2MjA1MA==", "bodyText": "I would use own name instead of perunLdapc.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530362050", "createdAt": "2020-11-25T13:09:30Z", "author": {"login": "zlamalp"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/main/AuditLoggerStarter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package cz.metacentrum.perun.auditlogger.main;\n+\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.core.api.ExtSourcesManager;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunPrincipal;\n+import cz.metacentrum.perun.core.bl.PerunBl;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.support.AbstractApplicationContext;\n+import org.springframework.context.support.ClassPathXmlApplicationContext;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+public class AuditLoggerStarter {\n+\tprivate final static Logger log = LoggerFactory.getLogger(AuditLoggerStarter.class);\n+\n+\tprivate AuditLoggerManager auditLoggerManager;\n+\tprivate AbstractApplicationContext springCtx;\n+\tprivate PerunPrincipal perunPrincipal;\n+\tprivate Perun perunBl;\n+\n+\tpublic AuditLoggerStarter() {\n+\t\tthis.perunPrincipal = new PerunPrincipal(\"perunLdapc\", ExtSourcesManager.EXTSOURCE_NAME_INTERNAL, ExtSourcesManager.EXTSOURCE_INTERNAL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM4MDAzNA==", "bodyText": "Fixed. Requires change to the perun.properties.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530380034", "createdAt": "2020-11-25T13:38:57Z", "author": {"login": "mvocu"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/main/AuditLoggerStarter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package cz.metacentrum.perun.auditlogger.main;\n+\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.core.api.ExtSourcesManager;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunPrincipal;\n+import cz.metacentrum.perun.core.bl.PerunBl;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.support.AbstractApplicationContext;\n+import org.springframework.context.support.ClassPathXmlApplicationContext;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+public class AuditLoggerStarter {\n+\tprivate final static Logger log = LoggerFactory.getLogger(AuditLoggerStarter.class);\n+\n+\tprivate AuditLoggerManager auditLoggerManager;\n+\tprivate AbstractApplicationContext springCtx;\n+\tprivate PerunPrincipal perunPrincipal;\n+\tprivate Perun perunBl;\n+\n+\tpublic AuditLoggerStarter() {\n+\t\tthis.perunPrincipal = new PerunPrincipal(\"perunLdapc\", ExtSourcesManager.EXTSOURCE_NAME_INTERNAL, ExtSourcesManager.EXTSOURCE_INTERNAL);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2MjA1MA=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5MDYyNQ==", "bodyText": "Although, in light of the last change, probably not.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530390625", "createdAt": "2020-11-25T13:55:09Z", "author": {"login": "mvocu"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/main/AuditLoggerStarter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package cz.metacentrum.perun.auditlogger.main;\n+\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.core.api.ExtSourcesManager;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunPrincipal;\n+import cz.metacentrum.perun.core.bl.PerunBl;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.support.AbstractApplicationContext;\n+import org.springframework.context.support.ClassPathXmlApplicationContext;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+public class AuditLoggerStarter {\n+\tprivate final static Logger log = LoggerFactory.getLogger(AuditLoggerStarter.class);\n+\n+\tprivate AuditLoggerManager auditLoggerManager;\n+\tprivate AbstractApplicationContext springCtx;\n+\tprivate PerunPrincipal perunPrincipal;\n+\tprivate Perun perunBl;\n+\n+\tpublic AuditLoggerStarter() {\n+\t\tthis.perunPrincipal = new PerunPrincipal(\"perunLdapc\", ExtSourcesManager.EXTSOURCE_NAME_INTERNAL, ExtSourcesManager.EXTSOURCE_INTERNAL);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2MjA1MA=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5NzY4OA==", "bodyText": "As you changed usage of entry to bl, it shouldn't. If you wish, you can update defaultCoreProperties in perun-base.xml.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530397688", "createdAt": "2020-11-25T14:05:36Z", "author": {"login": "zlamalp"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/main/AuditLoggerStarter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package cz.metacentrum.perun.auditlogger.main;\n+\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.core.api.ExtSourcesManager;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunPrincipal;\n+import cz.metacentrum.perun.core.bl.PerunBl;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.support.AbstractApplicationContext;\n+import org.springframework.context.support.ClassPathXmlApplicationContext;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+public class AuditLoggerStarter {\n+\tprivate final static Logger log = LoggerFactory.getLogger(AuditLoggerStarter.class);\n+\n+\tprivate AuditLoggerManager auditLoggerManager;\n+\tprivate AbstractApplicationContext springCtx;\n+\tprivate PerunPrincipal perunPrincipal;\n+\tprivate Perun perunBl;\n+\n+\tpublic AuditLoggerStarter() {\n+\t\tthis.perunPrincipal = new PerunPrincipal(\"perunLdapc\", ExtSourcesManager.EXTSOURCE_NAME_INTERNAL, ExtSourcesManager.EXTSOURCE_INTERNAL);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2MjA1MA=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjM3ODY5OnYy", "diffSide": "RIGHT", "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/service/impl/AuditLoggerManagerImpl.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMzoyNjo1NlrOH5zXpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo0MjoyMlrOH55Lhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3MjUxNw==", "bodyText": "I think we want this to be persistent, not disposable on server restart. Yet I'm not sure, how is this handled in dockerized version of LDAPc @martin-kuba ? On instances without docker, we have this property set to ./[filename] which leads to the same folder as jar.\nSo there are two solutions. We can have default fallback value here and do not set property on each instance or we can explicitly set default in properties file and keep current default value (or any other required by the docker).", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530372517", "createdAt": "2020-11-25T13:26:56Z", "author": {"login": "zlamalp"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/service/impl/AuditLoggerManagerImpl.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package cz.metacentrum.perun.auditlogger.service.impl;\n+\n+import java.util.Properties;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import cz.metacentrum.perun.auditlogger.logger.EventLogger;\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunClient;\n+import cz.metacentrum.perun.core.api.PerunPrincipal;\n+import cz.metacentrum.perun.core.api.PerunSession;\n+\n+@org.springframework.stereotype.Service(value = \"auditLoggerManager\")\n+public class AuditLoggerManagerImpl implements AuditLoggerManager {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(AuditLoggerManagerImpl.class);\n+\n+\tprivate final static String DEFAULT_CONSUMER_NAME = \"auditlogger\";\n+\tprivate final static String DEFAULT_STATE_FILE = \"/tmp/auditlogger.state\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM4NTcyNg==", "bodyText": "I would argue that the default value should lead to somewhere guaranteed to exist. Anything else is placing constraint (or rather dependency) on the actual packaging and deployment. Sensible deployment should decide on the actual location of state file and there is a couple of ways to configure it; moreover in my opinion placing state file in the same directory as the binary installation is not a good practice.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530385726", "createdAt": "2020-11-25T13:47:44Z", "author": {"login": "mvocu"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/service/impl/AuditLoggerManagerImpl.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package cz.metacentrum.perun.auditlogger.service.impl;\n+\n+import java.util.Properties;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import cz.metacentrum.perun.auditlogger.logger.EventLogger;\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunClient;\n+import cz.metacentrum.perun.core.api.PerunPrincipal;\n+import cz.metacentrum.perun.core.api.PerunSession;\n+\n+@org.springframework.stereotype.Service(value = \"auditLoggerManager\")\n+public class AuditLoggerManagerImpl implements AuditLoggerManager {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(AuditLoggerManagerImpl.class);\n+\n+\tprivate final static String DEFAULT_CONSUMER_NAME = \"auditlogger\";\n+\tprivate final static String DEFAULT_STATE_FILE = \"/tmp/auditlogger.state\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3MjUxNw=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5NjgwOA==", "bodyText": "Ok, I'll leave it to @martin-kuba, since he knows deployment details.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530396808", "createdAt": "2020-11-25T14:04:25Z", "author": {"login": "zlamalp"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/service/impl/AuditLoggerManagerImpl.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package cz.metacentrum.perun.auditlogger.service.impl;\n+\n+import java.util.Properties;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import cz.metacentrum.perun.auditlogger.logger.EventLogger;\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunClient;\n+import cz.metacentrum.perun.core.api.PerunPrincipal;\n+import cz.metacentrum.perun.core.api.PerunSession;\n+\n+@org.springframework.stereotype.Service(value = \"auditLoggerManager\")\n+public class AuditLoggerManagerImpl implements AuditLoggerManager {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(AuditLoggerManagerImpl.class);\n+\n+\tprivate final static String DEFAULT_CONSUMER_NAME = \"auditlogger\";\n+\tprivate final static String DEFAULT_STATE_FILE = \"/tmp/auditlogger.state\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3MjUxNw=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ1OTU5MA==", "bodyText": "Docker containers keep their image between restarts, so the file /tmp/auditlogger.state would survive restart. But it will not survive deployment of a new version of the application. Is it a problem? We have the same situation with perun_ldapc, where the setting is ldap.stateFile=./perun-ldapc-last-state and the working directory is outside of the container. So if you want to keep the state between different versions of the application, set it to ./auditerlogger.state.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530459590", "createdAt": "2020-11-25T15:30:48Z", "author": {"login": "martin-kuba"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/service/impl/AuditLoggerManagerImpl.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package cz.metacentrum.perun.auditlogger.service.impl;\n+\n+import java.util.Properties;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import cz.metacentrum.perun.auditlogger.logger.EventLogger;\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunClient;\n+import cz.metacentrum.perun.core.api.PerunPrincipal;\n+import cz.metacentrum.perun.core.api.PerunSession;\n+\n+@org.springframework.stereotype.Service(value = \"auditLoggerManager\")\n+public class AuditLoggerManagerImpl implements AuditLoggerManager {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(AuditLoggerManagerImpl.class);\n+\n+\tprivate final static String DEFAULT_CONSUMER_NAME = \"auditlogger\";\n+\tprivate final static String DEFAULT_STATE_FILE = \"/tmp/auditlogger.state\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3MjUxNw=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ2NzcxOQ==", "bodyText": "OK, changed the default.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530467719", "createdAt": "2020-11-25T15:42:22Z", "author": {"login": "mvocu"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/service/impl/AuditLoggerManagerImpl.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package cz.metacentrum.perun.auditlogger.service.impl;\n+\n+import java.util.Properties;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import cz.metacentrum.perun.auditlogger.logger.EventLogger;\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunClient;\n+import cz.metacentrum.perun.core.api.PerunPrincipal;\n+import cz.metacentrum.perun.core.api.PerunSession;\n+\n+@org.springframework.stereotype.Service(value = \"auditLoggerManager\")\n+public class AuditLoggerManagerImpl implements AuditLoggerManager {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(AuditLoggerManagerImpl.class);\n+\n+\tprivate final static String DEFAULT_CONSUMER_NAME = \"auditlogger\";\n+\tprivate final static String DEFAULT_STATE_FILE = \"/tmp/auditlogger.state\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3MjUxNw=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjM4MTU2OnYy", "diffSide": "RIGHT", "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/main/AuditLoggerStarter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMzoyNzo0MFrOH5zZeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMzo0Nzo0OFrOH50LYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3Mjk4NQ==", "bodyText": "Please remove this line.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530372985", "createdAt": "2020-11-25T13:27:40Z", "author": {"login": "zlamalp"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/main/AuditLoggerStarter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package cz.metacentrum.perun.auditlogger.main;\n+\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.core.api.ExtSourcesManager;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunPrincipal;\n+import cz.metacentrum.perun.core.bl.PerunBl;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.support.AbstractApplicationContext;\n+import org.springframework.context.support.ClassPathXmlApplicationContext;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+public class AuditLoggerStarter {\n+\tprivate final static Logger log = LoggerFactory.getLogger(AuditLoggerStarter.class);\n+\n+\tprivate AuditLoggerManager auditLoggerManager;\n+\tprivate AbstractApplicationContext springCtx;\n+\tprivate PerunPrincipal perunPrincipal;\n+\tprivate Perun perunBl;\n+\n+\tpublic AuditLoggerStarter() {\n+\t\tthis.perunPrincipal = new PerunPrincipal(\"perunLdapc\", ExtSourcesManager.EXTSOURCE_NAME_INTERNAL, ExtSourcesManager.EXTSOURCE_INTERNAL);\n+\t\tspringCtx = new ClassPathXmlApplicationContext(\"/perun-auditlogger.xml\");\n+\t\tthis.auditLoggerManager = springCtx.getBean(\"auditLoggerManager\", AuditLoggerManager.class);\n+\t\tthis.perunBl = springCtx.getBean(\"perun\", PerunBl.class);\n+\t}\n+\n+\t/**\n+\t * Main method of auditLogger\n+\t *\n+\t * @param args (the only argument can be id of message to set Consumer on)\n+\t */\n+\tpublic static void main(String[] args) {\n+\t\tSystem.out.println(\"Starting Perun-AuditLogger...\");\n+\n+\t\tint lastProcessedIdToSet = 0;\n+\n+\t\tif (args.length == 0) {\n+\t\t\t//This is normal behavior, do nothing special, just start auditLogger\n+\t\t} else if (args.length == 1) {\n+\t\t\t//This behavior is special, set lastProcessedId\n+\t\t\tString argument = args[0];\n+\t\t\tlastProcessedIdToSet = Integer.valueOf(argument);\n+\t\t} else {\n+\t\t\tSystem.out.println(\"Too much arguments, can't understand what to do, exit starting!\");\n+\t\t\treturn;\n+\t\t}\n+\n+\n+\t\ttry {\n+\t\t\tAuditLoggerStarter auditLoggerStarter = new AuditLoggerStarter();\n+\n+\t\t\t// Just for the Spring IoC to exit gracefully...\n+\t\t\tauditLoggerStarter.springCtx.registerShutdownHook();\n+\n+\t\t\t// Sets RPC Caller and Perun\n+\t\t\t// ldapcStarter.ldapcManager.setRpcCaller(rpcCaller);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM4NTc2MA==", "bodyText": "Removed and fixed the comment below.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530385760", "createdAt": "2020-11-25T13:47:48Z", "author": {"login": "mvocu"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/main/AuditLoggerStarter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package cz.metacentrum.perun.auditlogger.main;\n+\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.core.api.ExtSourcesManager;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunPrincipal;\n+import cz.metacentrum.perun.core.bl.PerunBl;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.support.AbstractApplicationContext;\n+import org.springframework.context.support.ClassPathXmlApplicationContext;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+\n+public class AuditLoggerStarter {\n+\tprivate final static Logger log = LoggerFactory.getLogger(AuditLoggerStarter.class);\n+\n+\tprivate AuditLoggerManager auditLoggerManager;\n+\tprivate AbstractApplicationContext springCtx;\n+\tprivate PerunPrincipal perunPrincipal;\n+\tprivate Perun perunBl;\n+\n+\tpublic AuditLoggerStarter() {\n+\t\tthis.perunPrincipal = new PerunPrincipal(\"perunLdapc\", ExtSourcesManager.EXTSOURCE_NAME_INTERNAL, ExtSourcesManager.EXTSOURCE_INTERNAL);\n+\t\tspringCtx = new ClassPathXmlApplicationContext(\"/perun-auditlogger.xml\");\n+\t\tthis.auditLoggerManager = springCtx.getBean(\"auditLoggerManager\", AuditLoggerManager.class);\n+\t\tthis.perunBl = springCtx.getBean(\"perun\", PerunBl.class);\n+\t}\n+\n+\t/**\n+\t * Main method of auditLogger\n+\t *\n+\t * @param args (the only argument can be id of message to set Consumer on)\n+\t */\n+\tpublic static void main(String[] args) {\n+\t\tSystem.out.println(\"Starting Perun-AuditLogger...\");\n+\n+\t\tint lastProcessedIdToSet = 0;\n+\n+\t\tif (args.length == 0) {\n+\t\t\t//This is normal behavior, do nothing special, just start auditLogger\n+\t\t} else if (args.length == 1) {\n+\t\t\t//This behavior is special, set lastProcessedId\n+\t\t\tString argument = args[0];\n+\t\t\tlastProcessedIdToSet = Integer.valueOf(argument);\n+\t\t} else {\n+\t\t\tSystem.out.println(\"Too much arguments, can't understand what to do, exit starting!\");\n+\t\t\treturn;\n+\t\t}\n+\n+\n+\t\ttry {\n+\t\t\tAuditLoggerStarter auditLoggerStarter = new AuditLoggerStarter();\n+\n+\t\t\t// Just for the Spring IoC to exit gracefully...\n+\t\t\tauditLoggerStarter.springCtx.registerShutdownHook();\n+\n+\t\t\t// Sets RPC Caller and Perun\n+\t\t\t// ldapcStarter.ldapcManager.setRpcCaller(rpcCaller);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3Mjk4NQ=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjM5Nzg2OnYy", "diffSide": "RIGHT", "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/logger/impl/EventLoggerImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMzozMTo0M1rOH5zjow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNDowMzozN1rOH500jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3NTU4Nw==", "bodyText": "I think we can use BL instead of Entry layer to avoid authorization check, which might be the reason you used perunLdapc principal in the session, which is by default configured to be perun admin.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530375587", "createdAt": "2020-11-25T13:31:43Z", "author": {"login": "zlamalp"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/logger/impl/EventLoggerImpl.java", "diffHunk": "@@ -0,0 +1,197 @@\n+package cz.metacentrum.perun.auditlogger.logger.impl;\n+\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.auditlogger.logger.EventLogger;\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.auditparser.AuditParser;\n+import cz.metacentrum.perun.core.api.AuditMessage;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunSession;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+\n+@org.springframework.stereotype.Service(value = \"eventLogger\")\n+public class EventLoggerImpl implements EventLogger, Runnable {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(EventLoggerImpl.class);\n+\n+\tprivate static final DateFormat DATE_FORMAT = new SimpleDateFormat(\"yyyy/MM/dd HH:mm:ss\");\n+\n+\tprivate static final String SYSLOG_LOGGER_NAME = \"syslog-logger\";\n+\t\n+\tprivate static final Logger syslog = LoggerFactory.getLogger(SYSLOG_LOGGER_NAME);\n+\t\n+\tprivate static final Map<Class<?>,Class<?>> mixinMap = new HashMap<>();\n+\tprivate static final ObjectMapper mapper = new ObjectMapper();\n+\n+\tstatic {\n+\t\tmapper.enableDefaultTyping();\n+\t\t// TODO - skip any problematic properties using interfaces for mixins\n+\t\tmapper.setMixIns(mixinMap);\n+\t}\n+\n+\t@Autowired\n+\tprivate AuditLoggerManager auditLoggerManager;\n+\n+\tprivate PerunSession perunSession;\n+\tprivate Perun perun;\n+\tprivate int lastProcessedIdNumber;\n+\n+\tprivate boolean running = false;\n+\n+\t@Override\n+\tpublic void run() {\n+\n+\n+\t\trunning = true;\n+\t\tAuditMessage message = null;\n+\t\tList<AuditMessage> messages;\n+\n+\t\ttry {\n+\t\t\tperunSession = auditLoggerManager.getPerunSession();\n+\t\t\tperun = auditLoggerManager.getPerunBl();\n+\t\t\t\n+\t\t\tif (lastProcessedIdNumber == 0) {\n+\t\t\t\tloadLastProcessedId();\n+\t\t\t}\n+\n+\t\t\tmessages = null;\n+\n+\t\t\t//If running is true, then this process will be continuously\n+\t\t\twhile (running) {\n+\n+\t\t\t\tint sleepTime = 1000;\n+\t\t\t\t//Waiting for new messages. If consumer failed in some internal case, waiting until it will be repaired (waiting time is increases by each attempt)\n+\t\t\t\twhile(messages == null) {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\t//IMPORTANT STEP1: Get new bulk of messages\n+\t\t\t\t\t\tmessages = perun.getAuditMessagesManager().pollConsumerMessages(perunSession, auditLoggerManager.getConsumerName(), lastProcessedIdNumber);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5MDE4OA==", "bodyText": "Ok. Which makes the authorization checks rather superficial imho.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530390188", "createdAt": "2020-11-25T13:54:30Z", "author": {"login": "mvocu"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/logger/impl/EventLoggerImpl.java", "diffHunk": "@@ -0,0 +1,197 @@\n+package cz.metacentrum.perun.auditlogger.logger.impl;\n+\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.auditlogger.logger.EventLogger;\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.auditparser.AuditParser;\n+import cz.metacentrum.perun.core.api.AuditMessage;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunSession;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+\n+@org.springframework.stereotype.Service(value = \"eventLogger\")\n+public class EventLoggerImpl implements EventLogger, Runnable {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(EventLoggerImpl.class);\n+\n+\tprivate static final DateFormat DATE_FORMAT = new SimpleDateFormat(\"yyyy/MM/dd HH:mm:ss\");\n+\n+\tprivate static final String SYSLOG_LOGGER_NAME = \"syslog-logger\";\n+\t\n+\tprivate static final Logger syslog = LoggerFactory.getLogger(SYSLOG_LOGGER_NAME);\n+\t\n+\tprivate static final Map<Class<?>,Class<?>> mixinMap = new HashMap<>();\n+\tprivate static final ObjectMapper mapper = new ObjectMapper();\n+\n+\tstatic {\n+\t\tmapper.enableDefaultTyping();\n+\t\t// TODO - skip any problematic properties using interfaces for mixins\n+\t\tmapper.setMixIns(mixinMap);\n+\t}\n+\n+\t@Autowired\n+\tprivate AuditLoggerManager auditLoggerManager;\n+\n+\tprivate PerunSession perunSession;\n+\tprivate Perun perun;\n+\tprivate int lastProcessedIdNumber;\n+\n+\tprivate boolean running = false;\n+\n+\t@Override\n+\tpublic void run() {\n+\n+\n+\t\trunning = true;\n+\t\tAuditMessage message = null;\n+\t\tList<AuditMessage> messages;\n+\n+\t\ttry {\n+\t\t\tperunSession = auditLoggerManager.getPerunSession();\n+\t\t\tperun = auditLoggerManager.getPerunBl();\n+\t\t\t\n+\t\t\tif (lastProcessedIdNumber == 0) {\n+\t\t\t\tloadLastProcessedId();\n+\t\t\t}\n+\n+\t\t\tmessages = null;\n+\n+\t\t\t//If running is true, then this process will be continuously\n+\t\t\twhile (running) {\n+\n+\t\t\t\tint sleepTime = 1000;\n+\t\t\t\t//Waiting for new messages. If consumer failed in some internal case, waiting until it will be repaired (waiting time is increases by each attempt)\n+\t\t\t\twhile(messages == null) {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\t//IMPORTANT STEP1: Get new bulk of messages\n+\t\t\t\t\t\tmessages = perun.getAuditMessagesManager().pollConsumerMessages(perunSession, auditLoggerManager.getConsumerName(), lastProcessedIdNumber);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3NTU4Nw=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5NjMwMA==", "bodyText": "Well, I don't think, that internal component (calling single method) should be perun admin just because the called method requires it. We could probably create new role, but it should be then true also for other internal principals, etc. Also entry generally creates new transaction, which might not be desired in other components (overhead). So we probably should improve all this logic in the future, but it is outside of the scope of this pull-request.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530396300", "createdAt": "2020-11-25T14:03:37Z", "author": {"login": "zlamalp"}, "path": "perun-auditlogger/src/main/java/cz/metacentrum/perun/auditlogger/logger/impl/EventLoggerImpl.java", "diffHunk": "@@ -0,0 +1,197 @@\n+package cz.metacentrum.perun.auditlogger.logger.impl;\n+\n+import cz.metacentrum.perun.audit.events.AuditEvent;\n+import cz.metacentrum.perun.auditlogger.logger.EventLogger;\n+import cz.metacentrum.perun.auditlogger.service.AuditLoggerManager;\n+import cz.metacentrum.perun.auditparser.AuditParser;\n+import cz.metacentrum.perun.core.api.AuditMessage;\n+import cz.metacentrum.perun.core.api.Perun;\n+import cz.metacentrum.perun.core.api.PerunSession;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+\n+@org.springframework.stereotype.Service(value = \"eventLogger\")\n+public class EventLoggerImpl implements EventLogger, Runnable {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(EventLoggerImpl.class);\n+\n+\tprivate static final DateFormat DATE_FORMAT = new SimpleDateFormat(\"yyyy/MM/dd HH:mm:ss\");\n+\n+\tprivate static final String SYSLOG_LOGGER_NAME = \"syslog-logger\";\n+\t\n+\tprivate static final Logger syslog = LoggerFactory.getLogger(SYSLOG_LOGGER_NAME);\n+\t\n+\tprivate static final Map<Class<?>,Class<?>> mixinMap = new HashMap<>();\n+\tprivate static final ObjectMapper mapper = new ObjectMapper();\n+\n+\tstatic {\n+\t\tmapper.enableDefaultTyping();\n+\t\t// TODO - skip any problematic properties using interfaces for mixins\n+\t\tmapper.setMixIns(mixinMap);\n+\t}\n+\n+\t@Autowired\n+\tprivate AuditLoggerManager auditLoggerManager;\n+\n+\tprivate PerunSession perunSession;\n+\tprivate Perun perun;\n+\tprivate int lastProcessedIdNumber;\n+\n+\tprivate boolean running = false;\n+\n+\t@Override\n+\tpublic void run() {\n+\n+\n+\t\trunning = true;\n+\t\tAuditMessage message = null;\n+\t\tList<AuditMessage> messages;\n+\n+\t\ttry {\n+\t\t\tperunSession = auditLoggerManager.getPerunSession();\n+\t\t\tperun = auditLoggerManager.getPerunBl();\n+\t\t\t\n+\t\t\tif (lastProcessedIdNumber == 0) {\n+\t\t\t\tloadLastProcessedId();\n+\t\t\t}\n+\n+\t\t\tmessages = null;\n+\n+\t\t\t//If running is true, then this process will be continuously\n+\t\t\twhile (running) {\n+\n+\t\t\t\tint sleepTime = 1000;\n+\t\t\t\t//Waiting for new messages. If consumer failed in some internal case, waiting until it will be repaired (waiting time is increases by each attempt)\n+\t\t\t\twhile(messages == null) {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\t//IMPORTANT STEP1: Get new bulk of messages\n+\t\t\t\t\t\tmessages = perun.getAuditMessagesManager().pollConsumerMessages(perunSession, auditLoggerManager.getConsumerName(), lastProcessedIdNumber);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3NTU4Nw=="}, "originalCommit": {"oid": "2224d2dedbe40827a0d2891f05c934c0e0ca58e6"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjkzOTk2OnYy", "diffSide": "RIGHT", "path": "perun-auditlogger/src/main/resources/META-INF/spring.handlers", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTozNDowMVrOH540ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo0MDoyN1rOH55GRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ2MTc5Ng==", "bodyText": "Why do we need this file? There is no such file for perun-ldapc. It should be create automatically by maven-shade-plugin.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530461796", "createdAt": "2020-11-25T15:34:01Z", "author": {"login": "martin-kuba"}, "path": "perun-auditlogger/src/main/resources/META-INF/spring.handlers", "diffHunk": "@@ -0,0 +1,6 @@\n+http\\://www.springframework.org/schema/tx=org.springframework.transaction.config.TxNamespaceHandler", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16046a62764210b7f266fef961b7500fe75e498e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ2NjM3NQ==", "bodyText": "Removed from git.", "url": "https://github.com/CESNET/perun/pull/3001#discussion_r530466375", "createdAt": "2020-11-25T15:40:27Z", "author": {"login": "mvocu"}, "path": "perun-auditlogger/src/main/resources/META-INF/spring.handlers", "diffHunk": "@@ -0,0 +1,6 @@\n+http\\://www.springframework.org/schema/tx=org.springframework.transaction.config.TxNamespaceHandler", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ2MTc5Ng=="}, "originalCommit": {"oid": "16046a62764210b7f266fef961b7500fe75e498e"}, "originalPosition": 1}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2190, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}