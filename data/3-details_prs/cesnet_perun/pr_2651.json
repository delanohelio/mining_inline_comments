{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MDU0MDU3", "number": 2651, "title": "Module for attribute virt:resource:assignedGroups", "bodyText": "module will compute list of group names assigned to the resource\n(optionally also with all their subgroups)", "createdAt": "2020-04-03T09:08:50Z", "url": "https://github.com/CESNET/perun/pull/2651", "merged": true, "mergeCommit": {"oid": "77e6fa92e5e45c11a8aee0d4e5b1d9f6309f1fab"}, "closed": true, "closedAt": "2020-04-03T12:00:21Z", "author": {"login": "stavamichal"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT9estgFqTM4NzA5NTI3MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT_nFOgBqjMxOTYwODYwNTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDk1Mjcx", "url": "https://github.com/CESNET/perun/pull/2651#pullrequestreview-387095271", "createdAt": "2020-04-03T09:25:19Z", "commit": {"oid": "14b3c9345728b28da9c5b05170fcab812b6f8e8a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwOToyNToxOVrOGANk4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwOToyNzo1OVrOGANq5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg3NTYxNw==", "bodyText": "Why ? We retrieve value from the object Vo and do not call getAttribute() on such core attribute.", "url": "https://github.com/CESNET/perun/pull/2651#discussion_r402875617", "createdAt": "2020-04-03T09:25:19Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_resource_attribute_def_virt_assignedGroups.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.ResourceVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.ResourceVirtualAttributesModuleImplApi;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+/**\n+ * Compute value of all groups assigned to the Resource and return list of their names.\n+ * Name of group in the list is like '[VO_SHORT_NAME]:[PARENT_GROUP_NAME]:[GROUP_NAME]'\n+ *\n+ * If there is attribute 'resource:def:isAssignedWithSubgroups' set to true on the Resource, it will add all subgroups\n+ * of assigned groups too.\n+ *\n+ * @author Michal Stava &lt;stavamichal@gmail.com&gt;\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_resource_attribute_def_virt_assignedGroups extends ResourceVirtualAttributesModuleAbstract implements ResourceVirtualAttributesModuleImplApi {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_resource_attribute_def_virt_assignedGroups.class);\n+\tprivate static final String A_R_isAssignedWithSubgroups = AttributesManager.NS_RESOURCE_ATTR_DEF + \":isAssignedWithSubgroups\";\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, Resource resource, AttributeDefinition attributeDefinition) throws InternalErrorException {\n+\t\tAttribute attribute = new Attribute(attributeDefinition);\n+\t\tSet<String> allUniqueGroupNames = new HashSet<>();\n+\n+\t\tVo vo = sess.getPerunBl().getResourcesManagerBl().getVo(sess, resource);\n+\t\tList<Group> assignedGroups = sess.getPerunBl().getResourcesManagerBl().getAssignedGroups(sess, resource);\n+\n+\t\tboolean isAssignedWithSubgroups;\n+\t\ttry {\n+\t\t\tAttribute isAssignedWithSubgroupsAttribute = sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, resource, A_R_isAssignedWithSubgroups);\n+\t\t\tif(isAssignedWithSubgroupsAttribute.getValue() == null) {\n+\t\t\t\tisAssignedWithSubgroups = false;\n+\t\t\t} else {\n+\t\t\t\tisAssignedWithSubgroups = isAssignedWithSubgroupsAttribute.valueAsBoolean();\n+\t\t\t}\n+\t\t} catch (AttributeNotExistsException ex) {\n+\t\t\tlog.debug(\"There is missing definition of attribute {}\", A_R_isAssignedWithSubgroups);\n+\t\t\tisAssignedWithSubgroups = false;\n+\t\t} catch (WrongAttributeAssignmentException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\n+\t\tfor(Group assignedGroup: assignedGroups) {\n+\t\t\tallUniqueGroupNames.add(computeGroupName(vo, assignedGroup));\n+\t\t\tif(isAssignedWithSubgroups) {\n+\t\t\t\tfor(Group subgroup: sess.getPerunBl().getGroupsManagerBl().getAllSubGroups(sess, assignedGroup)) {\n+\t\t\t\t\tallUniqueGroupNames.add(computeGroupName(vo, subgroup));\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\n+\t\tattribute.setValue(new ArrayList(allUniqueGroupNames));\n+\n+\t\treturn attribute;\n+\t}\n+\n+\t/**\n+\t * Return group name like '[VO_SHORT_NAME]:[GROUP_NAME]'\n+\t *\n+\t * @param vo to get short name from\n+\t * @param group to get name from\n+\t * @return computed group name\n+\t */\n+\tprivate String computeGroupName(Vo vo, Group group) {\n+\t\treturn vo.getShortName() + \":\" + group.getName();\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getStrongDependencies() {\n+\t\tList<String> strongDependencies = new ArrayList<>();\n+\t\tstrongDependencies.add(AttributesManager.NS_VO_ATTR_CORE + \":shortName\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14b3c9345728b28da9c5b05170fcab812b6f8e8a"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg3NzE1Nw==", "bodyText": "Maybe we should sort list of group names to ensure consistent value is returned on each request. I think we can use SortedSet to do it on the fly.", "url": "https://github.com/CESNET/perun/pull/2651#discussion_r402877157", "createdAt": "2020-04-03T09:27:59Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_resource_attribute_def_virt_assignedGroups.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.ResourceVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.ResourceVirtualAttributesModuleImplApi;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+/**\n+ * Compute value of all groups assigned to the Resource and return list of their names.\n+ * Name of group in the list is like '[VO_SHORT_NAME]:[PARENT_GROUP_NAME]:[GROUP_NAME]'\n+ *\n+ * If there is attribute 'resource:def:isAssignedWithSubgroups' set to true on the Resource, it will add all subgroups\n+ * of assigned groups too.\n+ *\n+ * @author Michal Stava &lt;stavamichal@gmail.com&gt;\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_resource_attribute_def_virt_assignedGroups extends ResourceVirtualAttributesModuleAbstract implements ResourceVirtualAttributesModuleImplApi {\n+\n+\tprivate final static Logger log = LoggerFactory.getLogger(urn_perun_resource_attribute_def_virt_assignedGroups.class);\n+\tprivate static final String A_R_isAssignedWithSubgroups = AttributesManager.NS_RESOURCE_ATTR_DEF + \":isAssignedWithSubgroups\";\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, Resource resource, AttributeDefinition attributeDefinition) throws InternalErrorException {\n+\t\tAttribute attribute = new Attribute(attributeDefinition);\n+\t\tSet<String> allUniqueGroupNames = new HashSet<>();\n+\n+\t\tVo vo = sess.getPerunBl().getResourcesManagerBl().getVo(sess, resource);\n+\t\tList<Group> assignedGroups = sess.getPerunBl().getResourcesManagerBl().getAssignedGroups(sess, resource);\n+\n+\t\tboolean isAssignedWithSubgroups;\n+\t\ttry {\n+\t\t\tAttribute isAssignedWithSubgroupsAttribute = sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, resource, A_R_isAssignedWithSubgroups);\n+\t\t\tif(isAssignedWithSubgroupsAttribute.getValue() == null) {\n+\t\t\t\tisAssignedWithSubgroups = false;\n+\t\t\t} else {\n+\t\t\t\tisAssignedWithSubgroups = isAssignedWithSubgroupsAttribute.valueAsBoolean();\n+\t\t\t}\n+\t\t} catch (AttributeNotExistsException ex) {\n+\t\t\tlog.debug(\"There is missing definition of attribute {}\", A_R_isAssignedWithSubgroups);\n+\t\t\tisAssignedWithSubgroups = false;\n+\t\t} catch (WrongAttributeAssignmentException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\n+\t\tfor(Group assignedGroup: assignedGroups) {\n+\t\t\tallUniqueGroupNames.add(computeGroupName(vo, assignedGroup));\n+\t\t\tif(isAssignedWithSubgroups) {\n+\t\t\t\tfor(Group subgroup: sess.getPerunBl().getGroupsManagerBl().getAllSubGroups(sess, assignedGroup)) {\n+\t\t\t\t\tallUniqueGroupNames.add(computeGroupName(vo, subgroup));\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\n+\t\tattribute.setValue(new ArrayList(allUniqueGroupNames));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14b3c9345728b28da9c5b05170fcab812b6f8e8a"}, "originalPosition": 71}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14b3c9345728b28da9c5b05170fcab812b6f8e8a", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/14b3c9345728b28da9c5b05170fcab812b6f8e8a", "committedDate": "2020-04-03T09:06:46Z", "message": "Module for attribute def:resource:assignedGroups\n\n - module will compute list of group names assigned to the resource\n (optionally also with all their subgroups)"}, "afterCommit": {"oid": "fb730dffeac90b54e720e570efd793e371edea33", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/fb730dffeac90b54e720e570efd793e371edea33", "committedDate": "2020-04-03T09:41:33Z", "message": "Module for attribute def:resource:assignedGroups\n\n - module will compute list of group names assigned to the resource\n (optionally also with all their subgroups)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTEwNTQy", "url": "https://github.com/CESNET/perun/pull/2651#pullrequestreview-387110542", "createdAt": "2020-04-03T09:47:44Z", "commit": {"oid": "fb730dffeac90b54e720e570efd793e371edea33"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTU0MDQx", "url": "https://github.com/CESNET/perun/pull/2651#pullrequestreview-387154041", "createdAt": "2020-04-03T10:55:51Z", "commit": {"oid": "fb730dffeac90b54e720e570efd793e371edea33"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd20f2afa6642688a64fddaf92427af143e9a2db", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/fd20f2afa6642688a64fddaf92427af143e9a2db", "committedDate": "2020-04-03T11:57:01Z", "message": "Module for attribute virt:resource:assignedGroups\n\n - module will compute list of group names assigned to the resource\n (optionally also with all their subgroups)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb730dffeac90b54e720e570efd793e371edea33", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/fb730dffeac90b54e720e570efd793e371edea33", "committedDate": "2020-04-03T09:41:33Z", "message": "Module for attribute def:resource:assignedGroups\n\n - module will compute list of group names assigned to the resource\n (optionally also with all their subgroups)"}, "afterCommit": {"oid": "fd20f2afa6642688a64fddaf92427af143e9a2db", "author": {"user": {"login": "stavamichal", "name": "Michal Stava"}}, "url": "https://github.com/CESNET/perun/commit/fd20f2afa6642688a64fddaf92427af143e9a2db", "committedDate": "2020-04-03T11:57:01Z", "message": "Module for attribute virt:resource:assignedGroups\n\n - module will compute list of group names assigned to the resource\n (optionally also with all their subgroups)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1322, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}