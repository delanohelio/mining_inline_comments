{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NTI2NTQ1", "number": 2703, "title": "CORE: Optimized check on attribute dependencies", "bodyText": "We previously get and check dependencies of each attribute\nin the passed list of attributes.\nBut in case of any attribute to have exactly \"same\" dependency\nas another, we would get and check those dependant attributes\nmultiple times.\n\n\nSince this behaviour is dependant on actuall dependencies,\nI'm not sure it ever happened. But it is still better\nto prevent this possibility.\n\n\nNow we retrieve all dependant attributes for all source attributes\nat start, put them in the set (to make them unique if some have\nsame dependency) and then we check their semantics.\n\n\nAs we now perform check on the list of RichAttributes only,\nthere is no need to perform it for each namespace separately.\nThis also cover the case, when two attributes of \"different\nnamespace\" are dependent on the same attribute. Which we previously\ncould check twice and now will do once.\n\n\nRemoved unnecessary \"this.\" from all calls of checkAttribute...().\n\n\nSince we don't directly pass beans and attributes to the\ncheckAttributeDependencies() methods anymore, new private methods\nwere created in order to convert passed beans and list of attributes\nto the list of RichAttributes.\nPreviously this existed only for the checks working with multiple\nattribute namespaces. Now each namespace have one.\nCorrectness can be checked by the fact, that we no longer\npass \"null\" value as bean to those checkAttributeDependencies()\nand new private method calls generic check (once) with the list of\nall RichAttributes gathered together.", "createdAt": "2020-05-15T11:06:39Z", "url": "https://github.com/CESNET/perun/pull/2703", "merged": true, "mergeCommit": {"oid": "3b271081d58c3d77b7c27ab106e093ad8412fdef"}, "closed": true, "closedAt": "2020-05-27T08:24:06Z", "author": {"login": "zlamalp"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcja_3HgFqTQxMjU2NjI5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABclU0K_AFqTQxODk1ODg3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNTY2Mjk1", "url": "https://github.com/CESNET/perun/pull/2703#pullrequestreview-412566295", "createdAt": "2020-05-15T11:30:29Z", "commit": {"oid": "0d96cd12a55b2803eb832760a224c8c65fdeef34"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMTozOTo1N1rOGWBW4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMTozOTo1N1rOGWBW4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc0NDA5Nw==", "bodyText": "Why are you changing input parameter? It is always better to prevent this behavior and return list of rich attributes instead. You can then call  \"addAll\" outside instead. We should prevent this behavior as much as possible.", "url": "https://github.com/CESNET/perun/pull/2703#discussion_r425744097", "createdAt": "2020-05-15T11:39:57Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -5715,211 +5851,230 @@ private void checkAttributesDependencies(PerunSession sess, Member member, Group\n \t\t\t\t\tthrow new WrongAttributeAssignmentException(attr);\n \t\t\t\t}\n \t\t\t}\n-\t\t\tcheckAttributesDependencies(sess, member, null, memberAttributes);\n-\t\t\tcheckAttributesDependencies(sess, user, null, userAttributes);\n-\t\t\tcheckAttributesDependencies(sess, member, group, memberGroupAttributes);\n+\t\t\tconstructRichAttributes(richAttrs, member, null, memberAttributes);\n+\t\t\tconstructRichAttributes(richAttrs, user, null, userAttributes);\n+\t\t\tconstructRichAttributes(richAttrs, member, group, memberGroupAttributes);\n \t\t} else {\n-\t\t\tcheckAttributesDependencies(sess, member, group, attributes);\n+\t\t\tconstructRichAttributes(richAttrs, member, group, attributes);\n \t\t}\n+\t\tcheckAttributesDependencies(sess, richAttrs);\n \t}\n \n-\tprivate void checkAttributesDependencies(PerunSession sess, Object primaryHolder, Object secondaryHolder, List<Attribute> attributes) throws InternalErrorException, WrongAttributeValueException, WrongAttributeAssignmentException, WrongReferenceAttributeValueException {\n+\tprivate void constructRichAttributes(List<RichAttribute> richAttrs, Object primaryHolder, Object secondaryHolder, List<Attribute> attributes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d96cd12a55b2803eb832760a224c8c65fdeef34"}, "originalPosition": 970}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaac979b376a8d1f815c017d41386cb8d546409c", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/eaac979b376a8d1f815c017d41386cb8d546409c", "committedDate": "2020-05-22T09:48:33Z", "message": "CORE: Optimized check on attribute dependencies\n\n- We previously get and check dependencies of each attribute\n  in the passed list of attributes.\n  But in case of any attribute to have exactly \"same\" dependency\n  as another, we would get and check those dependant attributes\n  multiple times.\n- Since this behaviour is dependant on actuall dependencies,\n  I'm not sure it ever happened. But it is still better\n  to prevent this possibility.\n- Now we retrieve all dependant attributes for all source attributes\n  at start, put them in the set (to make them unique if some have\n  same dependency) and then we check their semantics."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f1d80408c358827d8480de906586b6a61668cee", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/1f1d80408c358827d8480de906586b6a61668cee", "committedDate": "2020-05-22T09:50:06Z", "message": "CORE: Iteration on optimization of checkAttributeDependencies\n\n- We can iterate on previous commit. As we perform check on\n  the list of RichAttributes, there is no need to perform it\n  for each namespace separately.\n\n- Now we also cover the case, when two attributes of \"different\n  namespace\" are dependant on the same attribute. Which we previously\n  could check twice and now will do once.\n\n- Removed unnecessary \"this.\" from all calls of checkAttribute...().\n\n- Since we don't directly pass beans and attributes to the\n  checkAttributeDependencies() methods anymore, new private methods\n  were created in order to convert passed beans and list of attributes\n  to the list of RichAttributes.\n  Previously this existed only for the checks working with multiple\n  attribute namespaces. Now each namespace have one.\n  Correctness can be checked by the fact, that we no longer\n  pass \"null\" value as bean to those checkAttributeDependencies()."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c35c7ad213feb5a665e3fdcbd2eebe721e86a00e", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/c35c7ad213feb5a665e3fdcbd2eebe721e86a00e", "committedDate": "2020-05-22T09:50:07Z", "message": "CORE: Aligned attribute holders order where possible\n\n- Whenever we pass attribute holders, we should conform\n  order of beans within attribute namespace.\n  Eg. for member_resource attributes we should pass\n  holders in the API in Member, Resource order.\n- Since original methods in API doesn't conform it, it\n  still might seem like we are switching orders randomly.\n  Fixing whole API now would probably break many pull-requests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d08e35d868bd7d6f566b8bcab33abe8ac6e463d", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/7d08e35d868bd7d6f566b8bcab33abe8ac6e463d", "committedDate": "2020-05-22T09:50:07Z", "message": "CORE: Reworked constructRichAttributes()\n\n- Renamed to more common convertToRichAttributes()\n- Now it returns list of RichAttributes and we do not\n  modify input list. It simplifies usage for cases\n  with single attribute namespace."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d935b35df717a9904c0d925b3eb2291282b7098", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/2d935b35df717a9904c0d925b3eb2291282b7098", "committedDate": "2020-05-21T18:07:26Z", "message": "CORE: Reworked constructRichAttributes()\n\n- Renamed to more common convertToRichAttributes()\n- Now it returns list of RichAttributes and we do not\n  modify input list. It simplifies usage for cases\n  with single attribute namespace."}, "afterCommit": {"oid": "7d08e35d868bd7d6f566b8bcab33abe8ac6e463d", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/7d08e35d868bd7d6f566b8bcab33abe8ac6e463d", "committedDate": "2020-05-22T09:50:07Z", "message": "CORE: Reworked constructRichAttributes()\n\n- Renamed to more common convertToRichAttributes()\n- Now it returns list of RichAttributes and we do not\n  modify input list. It simplifies usage for cases\n  with single attribute namespace."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MDczNTQ3", "url": "https://github.com/CESNET/perun/pull/2703#pullrequestreview-418073547", "createdAt": "2020-05-26T08:22:04Z", "commit": {"oid": "7d08e35d868bd7d6f566b8bcab33abe8ac6e463d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4OTU4ODcw", "url": "https://github.com/CESNET/perun/pull/2703#pullrequestreview-418958870", "createdAt": "2020-05-27T08:16:22Z", "commit": {"oid": "7d08e35d868bd7d6f566b8bcab33abe8ac6e463d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1371, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}