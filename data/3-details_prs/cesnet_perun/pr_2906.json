{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNDExODIw", "number": 2906, "title": "Core - auto extension of members", "bodyText": "The vo's memberExpirationRules attribute can now have two new values\nwhich can be used to automatically extend its members.\nThe value of autoExtensionLastLoginPeriod has format ^[0-9]+([dmy])$.\nIf any user has accessed the Perun at this period at the latest, he\nwill be extended by the vo's rules, if they have the period defined.\nThe value of autoExtensionExtSources has format of extSource ids\nsplit by commas - ^(\\d+)?(,\\d+)*$. If these ids are specified, they\nwill be used to limit the extSources used to check the last access.", "createdAt": "2020-09-21T16:14:05Z", "url": "https://github.com/CESNET/perun/pull/2906", "merged": true, "mergeCommit": {"oid": "ee32f994931651b3810b78b802089f383857cd4d"}, "closed": true, "closedAt": "2020-09-24T06:38:05Z", "author": {"login": "Vojtech-Sassmann"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLT87ggBqjM3OTIxMTc3NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdL7OPEgBqjM4MDE1ODg4ODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81f218383b7d19f71eeeb2811c1c801bba8d8424", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/81f218383b7d19f71eeeb2811c1c801bba8d8424", "committedDate": "2020-09-21T16:13:41Z", "message": "TODO"}, "afterCommit": {"oid": "4ea52a2095008bc8e3a091ccb022539ab39c6734", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/4ea52a2095008bc8e3a091ccb022539ab39c6734", "committedDate": "2020-09-22T08:44:57Z", "message": "Core - auto extension of members\n\n* The vo's memberExpirationRules attribute can now have two new values\nwhich can be used to automatically extend its members.\n* The value of `autoExtensionLastLoginPeriod` has format `^[0-9]+([dmy])$`.\nIf any user has accessed the Perun at this period at the latest, he\nwill be extended by the vo's rules, if they have the `period` defined.\n* The value of `autoExtensionExtSources` has format of extSource ids\nsplit by commas - `^(\\d+)?(,\\d+)*$`. If these ids are specified, they\nwill be used to limit the extSources used to check the last access."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ea52a2095008bc8e3a091ccb022539ab39c6734", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/4ea52a2095008bc8e3a091ccb022539ab39c6734", "committedDate": "2020-09-22T08:44:57Z", "message": "Core - auto extension of members\n\n* The vo's memberExpirationRules attribute can now have two new values\nwhich can be used to automatically extend its members.\n* The value of `autoExtensionLastLoginPeriod` has format `^[0-9]+([dmy])$`.\nIf any user has accessed the Perun at this period at the latest, he\nwill be extended by the vo's rules, if they have the `period` defined.\n* The value of `autoExtensionExtSources` has format of extSource ids\nsplit by commas - `^(\\d+)?(,\\d+)*$`. If these ids are specified, they\nwill be used to limit the extSources used to check the last access."}, "afterCommit": {"oid": "1ca3a9e664006d1d918efa9dc9de2ad07141061a", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/1ca3a9e664006d1d918efa9dc9de2ad07141061a", "committedDate": "2020-09-22T08:55:46Z", "message": "Core - auto extension of members\n\n* The vo's memberExpirationRules attribute can now have two new values\nwhich can be used to automatically extend its members.\n* The value of `autoExtensionLastLoginPeriod` has format `^[0-9]+([dmy])$`.\nIf any user has accessed the Perun at this period at the latest, he\nwill be extended by the vo's rules, if they have the `period` defined.\n* The value of `autoExtensionExtSources` has format of extSource ids\nsplit by commas - `^(\\d+)?(,\\d+)*$`. If these ids are specified, they\nwill be used to limit the extSources used to check the last access."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0Mzg2MTMw", "url": "https://github.com/CESNET/perun/pull/2906#pullrequestreview-494386130", "createdAt": "2020-09-23T07:49:29Z", "commit": {"oid": "1ca3a9e664006d1d918efa9dc9de2ad07141061a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo0OToyOVrOHWa09g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1NDozOVrOHWbEZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3MDI2Mg==", "bodyText": "I am afraid string like ',1234' will pass through this regular expression.", "url": "https://github.com/CESNET/perun/pull/2906#discussion_r493270262", "createdAt": "2020-09-23T07:49:29Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/implApi/modules/attributes/AbstractMembershipExpirationRulesModule.java", "diffHunk": "@@ -23,12 +26,15 @@\n \tprivate static final Pattern datePattern = Pattern.compile(\"^[0-9]+([dmy])$\");\n \tprivate static final Pattern loaPattern = Pattern.compile(\"^(([0-9]+,)|([0-9]+,[ ]))*[0-9]+$\");\n \tprivate static final Pattern periodLoaPattern = Pattern.compile(\"^[0-9]+[|](([0-9]+[.][0-9]+[.])|([+][0-9]+([dmy])))[.]?$\");\n+\tprivate static final Pattern extSourcesPatter = Pattern.compile(\"^(\\\\d+)?(,\\\\d+)*$\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ca3a9e664006d1d918efa9dc9de2ad07141061a"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3NDIxMg==", "bodyText": "Wrong character for splitting. Tests should found it.", "url": "https://github.com/CESNET/perun/pull/2906#discussion_r493274212", "createdAt": "2020-09-23T07:54:39Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/implApi/modules/attributes/AbstractMembershipExpirationRulesModule.java", "diffHunk": "@@ -109,10 +115,48 @@ public void checkAttributeSyntax(PerunSessionImpl sess, T entity, Attribute attr\n \t\t\t\t}\n \t\t\t}\n \t\t}\n+\n+\t\tparameter = autoExtensionLastLoginPeriod;\n+\t\tif (keys.contains(parameter)) {\n+\t\t\tMatcher dateMatcher = datePattern.matcher(attrValue.get(autoExtensionLastLoginPeriod));\n+\t\t\tif (!dateMatcher.find()) {\n+\t\t\t\tthrow new WrongAttributeValueException(attribute, \"There is not allowed value for parameter '\" +\n+\t\t\t\t\t\tparameter + \"': \" + attrValue.get(parameter));\n+\t\t\t}\n+\t\t}\n+\n+\t\tparameter = autoExtensionExtSources;\n+\t\tif (keys.contains(parameter)) {\n+\t\t\tMatcher extSourcesMatcher = extSourcesPatter.matcher(attrValue.get(autoExtensionExtSources));\n+\t\t\tif (!extSourcesMatcher.find()) {\n+\t\t\t\tthrow new WrongAttributeValueException(attribute, \"There is not allowed value for parameter '\" +\n+\t\t\t\t\t\tparameter + \"': \" + attrValue.get(parameter));\n+\t\t\t}\n+\t\t}\n \t}\n \n-\tpublic void checkAttributeSemantics(PerunSessionImpl perunSession, T entity, Attribute attribute) {\n+\tpublic void checkAttributeSemantics(PerunSessionImpl sess, T entity, Attribute attribute) throws WrongReferenceAttributeValueException {\n+\t\tMap<String, String> attrValue;\n+\n+\t\t//For no value is correct (it means no rules)\n+\t\tif(attribute.getValue() == null) return;\n+\n+\t\t//save value to map attrValue\n+\t\tattrValue = attribute.valueAsMap();\n+\n+\t\t//Same for empty HashList\n+\t\tif(attrValue.isEmpty()) return;\n \n+\t\tif (attrValue.containsKey(autoExtensionExtSources)) {\n+\t\t\tString[] extSourceIds = attrValue.get(autoExtensionExtSources).split(\"'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ca3a9e664006d1d918efa9dc9de2ad07141061a"}, "originalPosition": 65}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ca3a9e664006d1d918efa9dc9de2ad07141061a", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/1ca3a9e664006d1d918efa9dc9de2ad07141061a", "committedDate": "2020-09-22T08:55:46Z", "message": "Core - auto extension of members\n\n* The vo's memberExpirationRules attribute can now have two new values\nwhich can be used to automatically extend its members.\n* The value of `autoExtensionLastLoginPeriod` has format `^[0-9]+([dmy])$`.\nIf any user has accessed the Perun at this period at the latest, he\nwill be extended by the vo's rules, if they have the `period` defined.\n* The value of `autoExtensionExtSources` has format of extSource ids\nsplit by commas - `^(\\d+)?(,\\d+)*$`. If these ids are specified, they\nwill be used to limit the extSources used to check the last access."}, "afterCommit": {"oid": "1495d3018a630ba309034bdb85675f402cb8bab5", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/1495d3018a630ba309034bdb85675f402cb8bab5", "committedDate": "2020-09-23T08:40:05Z", "message": "Core - auto extension of members\n\n* The vo's memberExpirationRules attribute can now have two new values\nwhich can be used to automatically extend its members.\n* The value of `autoExtensionLastLoginPeriod` has format `^[0-9]+([dmy])$`.\nIf any user has accessed the Perun at this period at the latest, he\nwill be extended by the vo's rules, if they have the `period` defined.\n* The value of `autoExtensionExtSources` has format of extSource ids\nsplit by commas - `^(\\d+)?(,\\d+)*$`. If these ids are specified, they\nwill be used to limit the extSources used to check the last access."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1495d3018a630ba309034bdb85675f402cb8bab5", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/1495d3018a630ba309034bdb85675f402cb8bab5", "committedDate": "2020-09-23T08:40:05Z", "message": "Core - auto extension of members\n\n* The vo's memberExpirationRules attribute can now have two new values\nwhich can be used to automatically extend its members.\n* The value of `autoExtensionLastLoginPeriod` has format `^[0-9]+([dmy])$`.\nIf any user has accessed the Perun at this period at the latest, he\nwill be extended by the vo's rules, if they have the `period` defined.\n* The value of `autoExtensionExtSources` has format of extSource ids\nsplit by commas - `^(\\d+)?(,\\d+)*$`. If these ids are specified, they\nwill be used to limit the extSources used to check the last access."}, "afterCommit": {"oid": "c4a721c3370cadc5e4a30408c5d3df3f6aa2109c", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/c4a721c3370cadc5e4a30408c5d3df3f6aa2109c", "committedDate": "2020-09-23T08:41:21Z", "message": "Core - auto extension of members\n\n* The vo's memberExpirationRules attribute can now have two new values\nwhich can be used to automatically extend its members.\n* The value of `autoExtensionLastLoginPeriod` has format `^[0-9]+([dmy])$`.\nIf any user has accessed the Perun at this period at the latest, he\nwill be extended by the vo's rules, if they have the `period` defined.\n* The value of `autoExtensionExtSources` has format of extSource ids\nsplit by commas - `^(\\d+)?(,\\d+)*$`. If these ids are specified, they\nwill be used to limit the extSources used to check the last access."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NTg5MDY2", "url": "https://github.com/CESNET/perun/pull/2906#pullrequestreview-494589066", "createdAt": "2020-09-23T12:09:25Z", "commit": {"oid": "c4a721c3370cadc5e4a30408c5d3df3f6aa2109c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NTYxNDQ5", "url": "https://github.com/CESNET/perun/pull/2906#pullrequestreview-494561449", "createdAt": "2020-09-23T11:31:43Z", "commit": {"oid": "c4a721c3370cadc5e4a30408c5d3df3f6aa2109c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMTozMTo0M1rOHWnkWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMTozMTo0M1rOHWnkWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ3OTAwMQ==", "bodyText": "\"?\" quantifier seems to be unnecessary.", "url": "https://github.com/CESNET/perun/pull/2906#discussion_r493479001", "createdAt": "2020-09-23T11:31:43Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/Utils.java", "diffHunk": "@@ -1514,6 +1514,36 @@ public static LocalDate extendDateByPeriod(LocalDate localDate, String period) {\n \t\t}\n \t}\n \n+\t/**\n+\t * Shortens the given date by the given period.\n+\t *\n+\t * @param localDate date to be shortened\n+\t * @param period string of format ([0-9]+)([dmy]?)\n+\t * @return shortened date\n+\t */\n+\tpublic static LocalDate shortenDateByPeriod(LocalDate localDate, String period) {\n+\t\tPattern p = Pattern.compile(\"([0-9]+)([dmy]?)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4a721c3370cadc5e4a30408c5d3df3f6aa2109c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f34407317ae4aa6337e1e022cda1c25ea1e69d8", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/3f34407317ae4aa6337e1e022cda1c25ea1e69d8", "committedDate": "2020-09-24T06:29:56Z", "message": "Core - auto extension of members\n\n* The vo's memberExpirationRules attribute can now have two new values\nwhich can be used to automatically extend its members.\n* The value of `autoExtensionLastLoginPeriod` has format `^[0-9]+([dmy])$`.\nIf any user has accessed the Perun at this period at the latest, he\nwill be extended by the vo's rules, if they have the `period` defined.\n* The value of `autoExtensionExtSources` has format of extSource ids\nsplit by commas - `^(\\d+)?(,\\d+)*$`. If these ids are specified, they\nwill be used to limit the extSources used to check the last access."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4a721c3370cadc5e4a30408c5d3df3f6aa2109c", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/c4a721c3370cadc5e4a30408c5d3df3f6aa2109c", "committedDate": "2020-09-23T08:41:21Z", "message": "Core - auto extension of members\n\n* The vo's memberExpirationRules attribute can now have two new values\nwhich can be used to automatically extend its members.\n* The value of `autoExtensionLastLoginPeriod` has format `^[0-9]+([dmy])$`.\nIf any user has accessed the Perun at this period at the latest, he\nwill be extended by the vo's rules, if they have the `period` defined.\n* The value of `autoExtensionExtSources` has format of extSource ids\nsplit by commas - `^(\\d+)?(,\\d+)*$`. If these ids are specified, they\nwill be used to limit the extSources used to check the last access."}, "afterCommit": {"oid": "3f34407317ae4aa6337e1e022cda1c25ea1e69d8", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/3f34407317ae4aa6337e1e022cda1c25ea1e69d8", "committedDate": "2020-09-24T06:29:56Z", "message": "Core - auto extension of members\n\n* The vo's memberExpirationRules attribute can now have two new values\nwhich can be used to automatically extend its members.\n* The value of `autoExtensionLastLoginPeriod` has format `^[0-9]+([dmy])$`.\nIf any user has accessed the Perun at this period at the latest, he\nwill be extended by the vo's rules, if they have the `period` defined.\n* The value of `autoExtensionExtSources` has format of extSource ids\nsplit by commas - `^(\\d+)?(,\\d+)*$`. If these ids are specified, they\nwill be used to limit the extSources used to check the last access."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1060, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}