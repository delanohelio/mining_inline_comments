{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxOTU4NTMy", "number": 2716, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjoxMzozMFrOD_RYzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzowNzozNlrOD_9hbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjcxNzU5OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjoxMzozMFrOGZ1vfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNjoxODo1MlrOGaFnKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0ODA5NA==", "bodyText": "You should add @SkipValueCheckDuringDependencyCheck, otherwise attribute value will be retrieved during dependency checks and then no check will be preformed, since module doesn't have one.", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r429748094", "createdAt": "2020-05-25T06:13:30Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This attribute module is used to filter user certificates only to ten newest according to certificates expiration\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0813e8dd46e23073dd41418330f9560dadaec9e"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAwODEwNA==", "bodyText": "Added", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r430008104", "createdAt": "2020-05-25T16:18:52Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This attribute module is used to filter user certificates only to ten newest according to certificates expiration\n+ */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0ODA5NA=="}, "originalCommit": {"oid": "a0813e8dd46e23073dd41418330f9560dadaec9e"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjczMDg0OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjoyMToyN1rOGZ13lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNjoxOToxMFrOGaFneQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1MDE2NA==", "bodyText": "I know that this is clear and correct implementation, but we should minimize number of selects. Like retrieve both attributes at once. Also dependency on another virtual attributes is problematic. As a result, you twice retrieve value of user:def:userCertificates and then do some work with it. Maybe you should extract logic from getValue() of user:def:userCertificates and make it ModulesUtilsBlImpl method. Then you could use it directly in both modules to select user attributes only once and construct expiration mapping locally in this module (without dependency on virtual attribute).", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r429750164", "createdAt": "2020-05-25T06:21:27Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This attribute module is used to filter user certificates only to ten newest according to certificates expiration\n+ */\n+public class urn_perun_user_attribute_def_virt_userCertificates extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {\n+\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDefinition attributeDefinition) {\n+\t\tAttribute resultAttribute = new Attribute(attributeDefinition);\n+\n+\t\tAttribute userCertsAttribute = getUserCertsAttribute(sess, user);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0813e8dd46e23073dd41418330f9560dadaec9e"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDAwODE4NQ==", "bodyText": "Reworked", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r430008185", "createdAt": "2020-05-25T16:19:10Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This attribute module is used to filter user certificates only to ten newest according to certificates expiration\n+ */\n+public class urn_perun_user_attribute_def_virt_userCertificates extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {\n+\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDefinition attributeDefinition) {\n+\t\tAttribute resultAttribute = new Attribute(attributeDefinition);\n+\n+\t\tAttribute userCertsAttribute = getUserCertsAttribute(sess, user);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1MDE2NA=="}, "originalCommit": {"oid": "a0813e8dd46e23073dd41418330f9560dadaec9e"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3OTg0NDU3OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/ModulesUtilsBlImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwODoxNzoyN1rOGaTg3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDozMjozNFrOGahJFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzNTg3MA==", "bodyText": "You should test not-null on certificate variable.", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r430235870", "createdAt": "2020-05-26T08:17:27Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/ModulesUtilsBlImpl.java", "diffHunk": "@@ -1164,11 +1171,46 @@ public User getUserFromMessage(PerunSessionImpl sess, String message) throws Int\n \t\treturn new Pair<>(number, unit);\n \t}\n \n+\t/**\n+\t * Extracts expiration of the given certificates.\n+\t *\n+\t * @param certificates as a map where the key is a DN and the value is a certificate\n+\t * @return map where the key is certificate DN and the value is a certificate expiration\n+\t */\n+\tpublic static Map<String, String> retrieveCertificatesExpiration(Map<String, String> certificates) {\n+\t\tUtils.notNull(certificates, \"certificates\");\n+\t\tMap<String, String> resultMap = new LinkedHashMap<>();\n+\t\tcertificates.forEach((key, value) -> resultMap.put(key, getCertificateExpiration(value)));\n+\t\treturn resultMap;\n+\t}\n+\n \tpublic PerunBl getPerunBl() {\n \t\treturn this.perunBl;\n \t}\n \n \tpublic void setPerunBl(PerunBl perunBl) {\n \t\tthis.perunBl = perunBl;\n \t}\n+\n+\t/**\n+\t * Retrieve expiration of the given certificate\n+\t *\n+\t * @param certificate in PEM format from which the expiration will be retrieved\n+\t * @return Certificate expiration as String\n+\t */\n+\tprivate static String getCertificateExpiration(String certificate) {\n+\t\tString certWithoutBegin = certificate.replaceFirst(\"-----BEGIN CERTIFICATE-----\", \"\");\n+\t\tString rawCert = certWithoutBegin.replaceFirst(\"-----END CERTIFICATE-----\", \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eacc6e9a3c6a8bdc15074b905de1183dc0d99d2c"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ1OTE1Ng==", "bodyText": "Added", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r430459156", "createdAt": "2020-05-26T14:32:34Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/ModulesUtilsBlImpl.java", "diffHunk": "@@ -1164,11 +1171,46 @@ public User getUserFromMessage(PerunSessionImpl sess, String message) throws Int\n \t\treturn new Pair<>(number, unit);\n \t}\n \n+\t/**\n+\t * Extracts expiration of the given certificates.\n+\t *\n+\t * @param certificates as a map where the key is a DN and the value is a certificate\n+\t * @return map where the key is certificate DN and the value is a certificate expiration\n+\t */\n+\tpublic static Map<String, String> retrieveCertificatesExpiration(Map<String, String> certificates) {\n+\t\tUtils.notNull(certificates, \"certificates\");\n+\t\tMap<String, String> resultMap = new LinkedHashMap<>();\n+\t\tcertificates.forEach((key, value) -> resultMap.put(key, getCertificateExpiration(value)));\n+\t\treturn resultMap;\n+\t}\n+\n \tpublic PerunBl getPerunBl() {\n \t\treturn this.perunBl;\n \t}\n \n \tpublic void setPerunBl(PerunBl perunBl) {\n \t\tthis.perunBl = perunBl;\n \t}\n+\n+\t/**\n+\t * Retrieve expiration of the given certificate\n+\t *\n+\t * @param certificate in PEM format from which the expiration will be retrieved\n+\t * @return Certificate expiration as String\n+\t */\n+\tprivate static String getCertificateExpiration(String certificate) {\n+\t\tString certWithoutBegin = certificate.replaceFirst(\"-----BEGIN CERTIFICATE-----\", \"\");\n+\t\tString rawCert = certWithoutBegin.replaceFirst(\"-----END CERTIFICATE-----\", \"\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIzNTg3MA=="}, "originalCommit": {"oid": "eacc6e9a3c6a8bdc15074b905de1183dc0d99d2c"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3OTg5NTM0OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwODozMTo0M1rOGaUA_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDozMjo0MVrOGahJUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0NDA5NA==", "bodyText": "You can call this instead:\n.forEachOrdered(entry -> result.add(certs.get(entry.getKey())));", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r430244094", "createdAt": "2020-05-26T08:31:43Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.blImpl.ModulesUtilsBlImpl;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.impl.Utils;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This attribute module is used to filter user certificates only to ten newest according to certificates expiration\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_userCertificates extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {\n+\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDefinition attributeDefinition) {\n+\t\tAttribute resultAttribute = new Attribute(attributeDefinition);\n+\t\tList<String> result = new ArrayList<>();\n+\n+\t\tAttribute userCertsAttribute = getUserCertsAttribute(sess, user);\n+\t\tMap<String,String> certs = userCertsAttribute.valueAsMap();\n+\t\tif (certs != null) {\n+\t\t\tMap<String, String> certsExpiration = ModulesUtilsBlImpl.retrieveCertificatesExpiration(certs);\n+\n+\t\t\tDateFormat dateFormatInstance = DateFormat.getDateInstance();\n+\n+\t\t\tMap<String, Long> certsExpirationInMilliSeconds = new HashMap<>();\n+\t\t\tcertsExpiration.forEach((key, value) -> {\n+\t\t\t\ttry {\n+\t\t\t\t\tcertsExpirationInMilliSeconds.put(key, dateFormatInstance.parse(value).getTime());\n+\t\t\t\t} catch (ParseException ex) {\n+\t\t\t\t\tthrow new ConsistencyErrorException(ex);\n+\t\t\t\t}\n+\t\t\t});\n+\n+\t\t\tList<String> tenEarliestDNs = new ArrayList<>();\n+\n+\t\t\tcertsExpirationInMilliSeconds.entrySet().stream()\n+\t\t\t\t.sorted(Collections.reverseOrder(Map.Entry.comparingByValue()))\n+\t\t\t\t.limit(10)\n+\t\t\t\t.forEachOrdered(entry -> tenEarliestDNs.add(entry.getKey()));\n+\n+\t\t\tcerts.entrySet().removeIf(entry -> !tenEarliestDNs.contains(entry.getKey()));\n+\t\t\tresult = new ArrayList<>(certs.values());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eacc6e9a3c6a8bdc15074b905de1183dc0d99d2c"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ1OTIxNw==", "bodyText": "Reworked", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r430459217", "createdAt": "2020-05-26T14:32:41Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.blImpl.ModulesUtilsBlImpl;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.impl.Utils;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This attribute module is used to filter user certificates only to ten newest according to certificates expiration\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_userCertificates extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {\n+\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDefinition attributeDefinition) {\n+\t\tAttribute resultAttribute = new Attribute(attributeDefinition);\n+\t\tList<String> result = new ArrayList<>();\n+\n+\t\tAttribute userCertsAttribute = getUserCertsAttribute(sess, user);\n+\t\tMap<String,String> certs = userCertsAttribute.valueAsMap();\n+\t\tif (certs != null) {\n+\t\t\tMap<String, String> certsExpiration = ModulesUtilsBlImpl.retrieveCertificatesExpiration(certs);\n+\n+\t\t\tDateFormat dateFormatInstance = DateFormat.getDateInstance();\n+\n+\t\t\tMap<String, Long> certsExpirationInMilliSeconds = new HashMap<>();\n+\t\t\tcertsExpiration.forEach((key, value) -> {\n+\t\t\t\ttry {\n+\t\t\t\t\tcertsExpirationInMilliSeconds.put(key, dateFormatInstance.parse(value).getTime());\n+\t\t\t\t} catch (ParseException ex) {\n+\t\t\t\t\tthrow new ConsistencyErrorException(ex);\n+\t\t\t\t}\n+\t\t\t});\n+\n+\t\t\tList<String> tenEarliestDNs = new ArrayList<>();\n+\n+\t\t\tcertsExpirationInMilliSeconds.entrySet().stream()\n+\t\t\t\t.sorted(Collections.reverseOrder(Map.Entry.comparingByValue()))\n+\t\t\t\t.limit(10)\n+\t\t\t\t.forEachOrdered(entry -> tenEarliestDNs.add(entry.getKey()));\n+\n+\t\t\tcerts.entrySet().removeIf(entry -> !tenEarliestDNs.contains(entry.getKey()));\n+\t\t\tresult = new ArrayList<>(certs.values());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0NDA5NA=="}, "originalCommit": {"oid": "eacc6e9a3c6a8bdc15074b905de1183dc0d99d2c"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3OTkzMDEyOnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwODo0MDo1M1rOGaUWhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNTozNDowN1rOGa5_2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0OTYwNQ==", "bodyText": "We should think about the name. This is too simple and it will be hard to understand that this specific certificate attribute is limited by 10 last certificates. I would prefer something like userCertificatesLimited or something similar to that. In the future, the limit itself could be attribute of facility and '10' could be the default value.", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r430249605", "createdAt": "2020-05-26T08:40:53Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.blImpl.ModulesUtilsBlImpl;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.impl.Utils;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This attribute module is used to filter user certificates only to ten newest according to certificates expiration\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_userCertificates extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eacc6e9a3c6a8bdc15074b905de1183dc0d99d2c"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ1OTMyMA==", "bodyText": "Renamed", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r430459320", "createdAt": "2020-05-26T14:32:50Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.blImpl.ModulesUtilsBlImpl;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.impl.Utils;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This attribute module is used to filter user certificates only to ten newest according to certificates expiration\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_userCertificates extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0OTYwNQ=="}, "originalCommit": {"oid": "eacc6e9a3c6a8bdc15074b905de1183dc0d99d2c"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg2NjM5NA==", "bodyText": "Please fix attribute name also in commit message. Thank you.", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r430866394", "createdAt": "2020-05-27T05:34:07Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificates.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.blImpl.ModulesUtilsBlImpl;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.impl.Utils;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This attribute module is used to filter user certificates only to ten newest according to certificates expiration\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_userCertificates extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0OTYwNQ=="}, "originalCommit": {"oid": "eacc6e9a3c6a8bdc15074b905de1183dc0d99d2c"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4Mzk0ODYyOnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificatesLimited.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzowNzozNlrOGa8FJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzowNzozNlrOGa8FJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwMDUxNg==", "bodyText": "You need to change content of this method too (while changing the name).", "url": "https://github.com/CESNET/perun/pull/2716#discussion_r430900516", "createdAt": "2020-05-27T07:07:36Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_userCertificatesLimited.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.User;\n+import cz.metacentrum.perun.core.api.exceptions.AttributeNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.blImpl.ModulesUtilsBlImpl;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.impl.Utils;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.SkipValueCheckDuringDependencyCheck;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.UserVirtualAttributesModuleImplApi;\n+\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * This attribute module is used to filter user certificates only to ten newest according to certificates expiration\n+ */\n+@SkipValueCheckDuringDependencyCheck\n+public class urn_perun_user_attribute_def_virt_userCertificatesLimited extends UserVirtualAttributesModuleAbstract implements UserVirtualAttributesModuleImplApi {\n+\n+\n+\t@Override\n+\tpublic Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDefinition attributeDefinition) {\n+\t\tAttribute resultAttribute = new Attribute(attributeDefinition);\n+\t\tList<String> result = new ArrayList<>();\n+\n+\t\tAttribute userCertsAttribute = getUserCertsAttribute(sess, user);\n+\t\tMap<String,String> certs = userCertsAttribute.valueAsMap();\n+\t\tif (certs != null) {\n+\t\t\tMap<String, String> certsExpiration = ModulesUtilsBlImpl.retrieveCertificatesExpiration(certs);\n+\n+\t\t\tDateFormat dateFormatInstance = DateFormat.getDateInstance();\n+\n+\t\t\tMap<String, Long> certsExpirationInMilliSeconds = new HashMap<>();\n+\t\t\tcertsExpiration.forEach((key, value) -> {\n+\t\t\t\ttry {\n+\t\t\t\t\tcertsExpirationInMilliSeconds.put(key, dateFormatInstance.parse(value).getTime());\n+\t\t\t\t} catch (ParseException ex) {\n+\t\t\t\t\tthrow new ConsistencyErrorException(ex);\n+\t\t\t\t}\n+\t\t\t});\n+\n+\t\t\tcertsExpirationInMilliSeconds.entrySet().stream()\n+\t\t\t\t.sorted(Collections.reverseOrder(Map.Entry.comparingByValue()))\n+\t\t\t\t.limit(10)\n+\t\t\t\t.forEachOrdered(entry -> result.add(certs.get(entry.getKey())));\n+\n+\t\t\tUtils.copyAttributeToViAttributeWithoutValue(userCertsAttribute, resultAttribute);\n+\t\t}\n+\n+\t\tresultAttribute.setValue(result);\n+\n+\t\treturn resultAttribute;\n+\t}\n+\n+\tprivate Attribute getUserCertsAttribute(PerunSessionImpl sess, User user) {\n+\t\ttry {\n+\t\t\treturn sess.getPerunBl().getAttributesManagerBl().getAttribute(sess, user, AttributesManager.NS_USER_ATTR_DEF + \":userCertificates\");\n+\t\t} catch(WrongAttributeAssignmentException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t} catch (AttributeNotExistsException ex) {\n+\t\t\tthrow new ConsistencyErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<String> getStrongDependencies() {\n+\t\treturn Collections.singletonList(AttributesManager.NS_USER_ATTR_DEF + \":userCertificates\");\n+\t}\n+\n+\t@Override\n+\tpublic AttributeDefinition getAttributeDefinition() {\n+\t\tAttributeDefinition attr = new AttributeDefinition();\n+\t\tattr.setNamespace(AttributesManager.NS_USER_ATTR_VIRT);\n+\t\tattr.setFriendlyName(\"userCertificates\");\n+\t\tattr.setDisplayName(\"User certificates\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ae37ffa4a4c3327062535cb5d97d7ce0ba4e5ce"}, "originalPosition": 88}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2050, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}