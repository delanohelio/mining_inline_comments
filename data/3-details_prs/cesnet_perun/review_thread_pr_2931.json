{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyMzgxNzI4", "number": 2931, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwNzozMDoxOFrOEtWi2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxMjo1NTowMFrOEt-vCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1OTkwNzQ2OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AuthzResolverBlImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwNzozMDoxOFrOHhF0JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDo0NTozMlrOHhkaBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQ2MDMyNQ==", "bodyText": "I think this could be done without such a duplicate of the existing code. The only change is the role itself here.", "url": "https://github.com/CESNET/perun/pull/2931#discussion_r504460325", "createdAt": "2020-10-14T07:30:18Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AuthzResolverBlImpl.java", "diffHunk": "@@ -1859,6 +1859,26 @@ public static AuthzRoles addAllSubgroupsToAuthzRoles(PerunSession sess, AuthzRol\n \t\t\tgroupAdminRoles.put(\"Group\", newGroupsIds);\n \t\t\tauthzRoles.put(Role.GROUPADMIN, groupAdminRoles);\n \t\t}\n+\t\tif (authzRoles.hasRole(Role.GROUPOBSERVER)) {\n+\t\t\tMap<String, Set<Integer>> groupObserverRoles = authzRoles.get(Role.GROUPOBSERVER);\n+\t\t\tSet<Integer> groupsIdsForObserver = groupObserverRoles.get(\"Group\");\n+\t\t\tSet<Integer> newGroupsIdsForObserver = new HashSet<>(groupsIdsForObserver);\n+\t\t\tfor (Integer id : groupsIdsForObserver) {\n+\t\t\t\tGroup parentGroupForObserver;\n+\t\t\t\ttry {\n+\t\t\t\t\tparentGroupForObserver = getPerunBl().getGroupsManagerBl().getGroupById(sess, id);\n+\t\t\t\t} catch (GroupNotExistsException ex) {\n+\t\t\t\t\tlog.debug(\"Group with id=\" + id + \" not exists when initializing rights for user: \" + sess.getPerunPrincipal().getUser());\n+\t\t\t\t\tcontinue;\n+\t\t\t\t}\n+\t\t\t\tList<Group> subGroups = getPerunBl().getGroupsManagerBl().getAllSubGroups(sess, parentGroupForObserver);\n+\t\t\t\tfor (Group g : subGroups) {\n+\t\t\t\t\tnewGroupsIdsForObserver.add(g.getId());\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tgroupObserverRoles.put(\"Group\", newGroupsIdsForObserver);\n+\t\t\tauthzRoles.put(Role.GROUPOBSERVER, groupObserverRoles);\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a69112b89a9c350cedc36a2674fa1936e929e5c"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2MTU0MA==", "bodyText": "Changes - I did it without duplication.", "url": "https://github.com/CESNET/perun/pull/2931#discussion_r504961540", "createdAt": "2020-10-14T20:45:32Z", "author": {"login": "HejdaJakub"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AuthzResolverBlImpl.java", "diffHunk": "@@ -1859,6 +1859,26 @@ public static AuthzRoles addAllSubgroupsToAuthzRoles(PerunSession sess, AuthzRol\n \t\t\tgroupAdminRoles.put(\"Group\", newGroupsIds);\n \t\t\tauthzRoles.put(Role.GROUPADMIN, groupAdminRoles);\n \t\t}\n+\t\tif (authzRoles.hasRole(Role.GROUPOBSERVER)) {\n+\t\t\tMap<String, Set<Integer>> groupObserverRoles = authzRoles.get(Role.GROUPOBSERVER);\n+\t\t\tSet<Integer> groupsIdsForObserver = groupObserverRoles.get(\"Group\");\n+\t\t\tSet<Integer> newGroupsIdsForObserver = new HashSet<>(groupsIdsForObserver);\n+\t\t\tfor (Integer id : groupsIdsForObserver) {\n+\t\t\t\tGroup parentGroupForObserver;\n+\t\t\t\ttry {\n+\t\t\t\t\tparentGroupForObserver = getPerunBl().getGroupsManagerBl().getGroupById(sess, id);\n+\t\t\t\t} catch (GroupNotExistsException ex) {\n+\t\t\t\t\tlog.debug(\"Group with id=\" + id + \" not exists when initializing rights for user: \" + sess.getPerunPrincipal().getUser());\n+\t\t\t\t\tcontinue;\n+\t\t\t\t}\n+\t\t\t\tList<Group> subGroups = getPerunBl().getGroupsManagerBl().getAllSubGroups(sess, parentGroupForObserver);\n+\t\t\t\tfor (Group g : subGroups) {\n+\t\t\t\t\tnewGroupsIdsForObserver.add(g.getId());\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tgroupObserverRoles.put(\"Group\", newGroupsIdsForObserver);\n+\t\t\tauthzRoles.put(Role.GROUPOBSERVER, groupObserverRoles);\n+\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQ2MDMyNQ=="}, "originalCommit": {"oid": "6a69112b89a9c350cedc36a2674fa1936e929e5c"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MDQxMDk1OnYy", "diffSide": "RIGHT", "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/Role.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTozNjowMlrOHhKojg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDo0NTo1NlrOHhkatw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzOTI3OA==", "bodyText": "I know that it is not your change but can you add also the TRUSTEDFACILITYADMIN role to this class?", "url": "https://github.com/CESNET/perun/pull/2931#discussion_r504539278", "createdAt": "2020-10-14T09:36:02Z", "author": {"login": "balcirakpeter"}, "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/Role.java", "diffHunk": "@@ -10,9 +10,12 @@\n \tpublic static final String PERUNOBSERVER = \"PERUNOBSERVER\";\n \tpublic static final String VOADMIN = \"VOADMIN\";\n \tpublic static final String GROUPADMIN = \"GROUPADMIN\";\n+\tpublic static final String GROUPOBSERVER = \"GROUPOBSERER\";\n \tpublic static final String SELF = \"SELF\";\n \tpublic static final String FACILITYADMIN = \"FACILITYADMIN\";\n+\tpublic static final String FACILITYOBSERVER = \"FACILITYOBSERVER\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a69112b89a9c350cedc36a2674fa1936e929e5c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2MTcxOQ==", "bodyText": "Done.", "url": "https://github.com/CESNET/perun/pull/2931#discussion_r504961719", "createdAt": "2020-10-14T20:45:56Z", "author": {"login": "HejdaJakub"}, "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/Role.java", "diffHunk": "@@ -10,9 +10,12 @@\n \tpublic static final String PERUNOBSERVER = \"PERUNOBSERVER\";\n \tpublic static final String VOADMIN = \"VOADMIN\";\n \tpublic static final String GROUPADMIN = \"GROUPADMIN\";\n+\tpublic static final String GROUPOBSERVER = \"GROUPOBSERER\";\n \tpublic static final String SELF = \"SELF\";\n \tpublic static final String FACILITYADMIN = \"FACILITYADMIN\";\n+\tpublic static final String FACILITYOBSERVER = \"FACILITYOBSERVER\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzOTI3OA=="}, "originalCommit": {"oid": "6a69112b89a9c350cedc36a2674fa1936e929e5c"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2NTYzMjkyOnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AuthzResolverBlImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwOToxMDo1NFrOHh-C5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwOToxMDo1NFrOHh-C5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM4MTYwNg==", "bodyText": "This should be different by role.", "url": "https://github.com/CESNET/perun/pull/2931#discussion_r505381606", "createdAt": "2020-10-15T09:10:54Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AuthzResolverBlImpl.java", "diffHunk": "@@ -2114,6 +2097,44 @@ private static boolean resolveAuthorization(PerunSession sess, List<Map<String,\n \t\treturn mapOfBeans;\n \t}\n \n+\t/**\n+\t * For role GroupAdmin and GroupObserver with association to \"Group\" add also all subgroups to authzRoles.\n+\t *\n+\t * @param sess Perun session\n+\t * @param authzRoles for some user\n+\t * @return authzRoles also with subgroups of groups\n+\t */\n+\tprivate static AuthzRoles addAllSubgroupsForGroupAdminAndObserver (PerunSession sess, AuthzRoles authzRoles) {\n+\t\tList<String> roles = new ArrayList<>();\n+\t\tif (authzRoles.hasRole(Role.GROUPADMIN)) {\n+\t\t\troles.add(Role.GROUPADMIN);\n+\t\t}\n+\t\tif (authzRoles.hasRole(Role.GROUPOBSERVER)) {\n+\t\t\troles.add(Role.GROUPOBSERVER);\n+\t\t}\n+\t\tfor (String role : roles) {\n+\t\t\tMap<String, Set<Integer>> groupRoles = authzRoles.get(role);\n+\t\t\tSet<Integer> groupsIds = groupRoles.get(\"Group\");\n+\t\t\tSet<Integer> newGroupsIds = new HashSet<>(groupsIds);\n+\t\t\tfor (Integer id : groupsIds) {\n+\t\t\t\tGroup parentGroup;\n+\t\t\t\ttry {\n+\t\t\t\t\tparentGroup = getPerunBl().getGroupsManagerBl().getGroupById(sess, id);\n+\t\t\t\t} catch (GroupNotExistsException ex) {\n+\t\t\t\t\tlog.debug(\"Group with id=\" + id + \" not exists when initializing rights for user: \" + sess.getPerunPrincipal().getUser());\n+\t\t\t\t\tcontinue;\n+\t\t\t\t}\n+\t\t\t\tList<Group> subGroups = getPerunBl().getGroupsManagerBl().getAllSubGroups(sess, parentGroup);\n+\t\t\t\tfor (Group g : subGroups) {\n+\t\t\t\t\tnewGroupsIds.add(g.getId());\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tgroupRoles.put(\"Group\", newGroupsIds);\n+\t\t\tauthzRoles.put(Role.GROUPADMIN, groupRoles);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72ba712e343bee85da54ed4f404b0a4d7b87650d"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2NjQ5MjI0OnYy", "diffSide": "RIGHT", "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/Role.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxMjo1NTowMFrOHiGVgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0NTo0OVrOHiTHaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUxNzQ0Mw==", "bodyText": "Please add the TRUSTEDFACILITYADMIN also to this method.", "url": "https://github.com/CESNET/perun/pull/2931#discussion_r505517443", "createdAt": "2020-10-15T12:55:00Z", "author": {"login": "balcirakpeter"}, "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/Role.java", "diffHunk": "@@ -25,10 +29,10 @@\n \tpublic static final String SECURITYADMIN = \"SECURITYADMIN\";\n \tpublic static final String CABINETADMIN = \"CABINETADMIN\";\n \tpublic static final String UNKNOWNROLENAME = \"UNKNOWN\";\n-\t\n+\n \tpublic static List<String> rolesAsList() {\n-\t\treturn Arrays.asList(CABINETADMIN, ENGINE, FACILITYADMIN, GROUPADMIN,\n-\t\t\t NOTIFICATIONS, PERUNADMIN, PERUNOBSERVER, REGISTRAR, RESOURCEADMIN, RESOURCESELFSERVICE,\n+\t\treturn Arrays.asList(CABINETADMIN, ENGINE, FACILITYADMIN, FACILITYOBSERVER, GROUPADMIN, GROUPOBSERVER,\n+\t\t\t NOTIFICATIONS, PERUNADMIN, PERUNOBSERVER, REGISTRAR, RESOURCEADMIN, RESOURCEOBSERVER, RESOURCESELFSERVICE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adb912f6880c7d0960adbee43fe3de918b40fcfd"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNjgyNQ==", "bodyText": "Oh sorry, I forgot about it. Fixed!", "url": "https://github.com/CESNET/perun/pull/2931#discussion_r505726825", "createdAt": "2020-10-15T17:45:49Z", "author": {"login": "HejdaJakub"}, "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/Role.java", "diffHunk": "@@ -25,10 +29,10 @@\n \tpublic static final String SECURITYADMIN = \"SECURITYADMIN\";\n \tpublic static final String CABINETADMIN = \"CABINETADMIN\";\n \tpublic static final String UNKNOWNROLENAME = \"UNKNOWN\";\n-\t\n+\n \tpublic static List<String> rolesAsList() {\n-\t\treturn Arrays.asList(CABINETADMIN, ENGINE, FACILITYADMIN, GROUPADMIN,\n-\t\t\t NOTIFICATIONS, PERUNADMIN, PERUNOBSERVER, REGISTRAR, RESOURCEADMIN, RESOURCESELFSERVICE,\n+\t\treturn Arrays.asList(CABINETADMIN, ENGINE, FACILITYADMIN, FACILITYOBSERVER, GROUPADMIN, GROUPOBSERVER,\n+\t\t\t NOTIFICATIONS, PERUNADMIN, PERUNOBSERVER, REGISTRAR, RESOURCEADMIN, RESOURCEOBSERVER, RESOURCESELFSERVICE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUxNzQ0Mw=="}, "originalCommit": {"oid": "adb912f6880c7d0960adbee43fe3de918b40fcfd"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2334, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}