{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0OTE4MTQ0", "number": 2969, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMToxMTozMFrOE1LZiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTozMTo0N1rOE1L0yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MTk2NzQ0OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/VosManager.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMToxMTozMFrOHtTj9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMDowMToyM1rOHunkuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI2ODQ2OQ==", "bodyText": "You should add info that all original sponors will be processed somehow too.", "url": "https://github.com/CESNET/perun/pull/2969#discussion_r517268469", "createdAt": "2020-11-04T11:11:30Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/VosManager.java", "diffHunk": "@@ -549,4 +549,25 @@\n \t * @throws VoNotExistsException if there is no vo with given id\n \t */\n \tList<BanOnVo> getBansForVo(PerunSession sess, int voId) throws PrivilegeException, VoNotExistsException;\n+\n+\t/**\n+\t * For the given vo, creates sponsored members for each sponsored user who is a member\n+\t * of the given vo.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147ce28a7968615da1c8cb9061f1b6208451e50a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI2OTE3Nw==", "bodyText": "Same for other javadocs of this method in different layers.", "url": "https://github.com/CESNET/perun/pull/2969#discussion_r517269177", "createdAt": "2020-11-04T11:12:52Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/VosManager.java", "diffHunk": "@@ -549,4 +549,25 @@\n \t * @throws VoNotExistsException if there is no vo with given id\n \t */\n \tList<BanOnVo> getBansForVo(PerunSession sess, int voId) throws PrivilegeException, VoNotExistsException;\n+\n+\t/**\n+\t * For the given vo, creates sponsored members for each sponsored user who is a member\n+\t * of the given vo.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI2ODQ2OQ=="}, "originalCommit": {"oid": "147ce28a7968615da1c8cb9061f1b6208451e50a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0NDkyMA==", "bodyText": "Javadocs updated.", "url": "https://github.com/CESNET/perun/pull/2969#discussion_r518644920", "createdAt": "2020-11-06T10:01:23Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/VosManager.java", "diffHunk": "@@ -549,4 +549,25 @@\n \t * @throws VoNotExistsException if there is no vo with given id\n \t */\n \tList<BanOnVo> getBansForVo(PerunSession sess, int voId) throws PrivilegeException, VoNotExistsException;\n+\n+\t/**\n+\t * For the given vo, creates sponsored members for each sponsored user who is a member\n+\t * of the given vo.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI2ODQ2OQ=="}, "originalCommit": {"oid": "147ce28a7968615da1c8cb9061f1b6208451e50a"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjAyMDE1OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/VosManagerBlImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMToyNjozNlrOHtUEBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMDowMToyN1rOHunk3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3NjY3Nw==", "bodyText": "I would skip the order of these two lines. If user is not member of the VO, you don't need to have his owners at all.", "url": "https://github.com/CESNET/perun/pull/2969#discussion_r517276677", "createdAt": "2020-11-04T11:26:36Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/VosManagerBlImpl.java", "diffHunk": "@@ -821,6 +825,92 @@ public boolean isMemberBanned(PerunSession sess, int memberId) {\n \t\treturn vosManagerImpl.isMemberBanned(sess, memberId);\n \t}\n \n+\t@Override\n+\tpublic void convertSponsoredUsers(PerunSession sess, Vo vo) {\n+\t\tperunBl.getUsersManagerBl().getSpecificUsers(sess).stream()\n+\t\t\t\t.filter(User::isSponsoredUser)\n+\t\t\t\t.forEach(user -> convertToSponsoredMember(sess, user, vo));\n+\t}\n+\n+\t@Override\n+\tpublic void convertSponsoredUsersWithNewSponsor(PerunSession sess, Vo vo, User newSponsor) {\n+\t\tperunBl.getUsersManagerBl().getSpecificUsers(sess).stream()\n+\t\t\t\t.filter(User::isSponsoredUser)\n+\t\t\t\t.forEach(user -> convertToSponsoredMemberWithNewSponsor(sess, user, newSponsor, vo));\n+\t}\n+\n+\t/**\n+\t * Sponsor given user by the given newSponsor in the given vo. If the newSponsor doesn't have\n+\t * the SPONSOR role, it will be set to him.\n+\t *\n+\t * @param sess session\n+\t * @param user user to be sponsored\n+\t * @param newSponsor new sponsor\n+\t * @param vo vo where the given user will be sponsored\n+\t */\n+\tprivate void convertToSponsoredMemberWithNewSponsor(PerunSession sess, User user, User newSponsor, Vo vo) {\n+\t\ttry {\n+\t\t\tMember member = perunBl.getMembersManagerBl().getMemberByUser(sess, vo, user);\n+\n+\t\t\tsponsorMemberByUser(sess, member, newSponsor, vo);\n+\t\t} catch (MemberNotExistsException e) {\n+\t\t\t// if the sponsored user is not member of the given vo, skip it\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Converts sponsored user to sponsored member in the given vo.\n+\t * If the user is not member of the given vo, it is skipped.\n+\t *\n+\t * @param sess session\n+\t * @param user user\n+\t * @param vo vo where the given user will be sponsored\n+\t */\n+\tprivate void convertToSponsoredMember(PerunSession sess, User user, Vo vo) {\n+\t\ttry {\n+\t\t\tList<User> owners = perunBl.getUsersManagerBl().getUsersBySpecificUser(sess, user);\n+\t\t\tMember member = perunBl.getMembersManagerBl().getMemberByUser(sess, vo, user);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147ce28a7968615da1c8cb9061f1b6208451e50a"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0NDk1OA==", "bodyText": "Done.", "url": "https://github.com/CESNET/perun/pull/2969#discussion_r518644958", "createdAt": "2020-11-06T10:01:27Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/VosManagerBlImpl.java", "diffHunk": "@@ -821,6 +825,92 @@ public boolean isMemberBanned(PerunSession sess, int memberId) {\n \t\treturn vosManagerImpl.isMemberBanned(sess, memberId);\n \t}\n \n+\t@Override\n+\tpublic void convertSponsoredUsers(PerunSession sess, Vo vo) {\n+\t\tperunBl.getUsersManagerBl().getSpecificUsers(sess).stream()\n+\t\t\t\t.filter(User::isSponsoredUser)\n+\t\t\t\t.forEach(user -> convertToSponsoredMember(sess, user, vo));\n+\t}\n+\n+\t@Override\n+\tpublic void convertSponsoredUsersWithNewSponsor(PerunSession sess, Vo vo, User newSponsor) {\n+\t\tperunBl.getUsersManagerBl().getSpecificUsers(sess).stream()\n+\t\t\t\t.filter(User::isSponsoredUser)\n+\t\t\t\t.forEach(user -> convertToSponsoredMemberWithNewSponsor(sess, user, newSponsor, vo));\n+\t}\n+\n+\t/**\n+\t * Sponsor given user by the given newSponsor in the given vo. If the newSponsor doesn't have\n+\t * the SPONSOR role, it will be set to him.\n+\t *\n+\t * @param sess session\n+\t * @param user user to be sponsored\n+\t * @param newSponsor new sponsor\n+\t * @param vo vo where the given user will be sponsored\n+\t */\n+\tprivate void convertToSponsoredMemberWithNewSponsor(PerunSession sess, User user, User newSponsor, Vo vo) {\n+\t\ttry {\n+\t\t\tMember member = perunBl.getMembersManagerBl().getMemberByUser(sess, vo, user);\n+\n+\t\t\tsponsorMemberByUser(sess, member, newSponsor, vo);\n+\t\t} catch (MemberNotExistsException e) {\n+\t\t\t// if the sponsored user is not member of the given vo, skip it\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Converts sponsored user to sponsored member in the given vo.\n+\t * If the user is not member of the given vo, it is skipped.\n+\t *\n+\t * @param sess session\n+\t * @param user user\n+\t * @param vo vo where the given user will be sponsored\n+\t */\n+\tprivate void convertToSponsoredMember(PerunSession sess, User user, Vo vo) {\n+\t\ttry {\n+\t\t\tList<User> owners = perunBl.getUsersManagerBl().getUsersBySpecificUser(sess, user);\n+\t\t\tMember member = perunBl.getMembersManagerBl().getMemberByUser(sess, vo, user);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3NjY3Nw=="}, "originalCommit": {"oid": "147ce28a7968615da1c8cb9061f1b6208451e50a"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjAzNzIwOnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/VosManagerBlImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTozMTo0N1rOHtUOyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMDowMjowNlrOHunmQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3OTQzNA==", "bodyText": "Converting could be done more than once on the same VO. For this reason, you should allow to skip situation when sponsor is already sponsoring user's member. In such situation, it will add missing sponsors or fill new one (if needed).", "url": "https://github.com/CESNET/perun/pull/2969#discussion_r517279434", "createdAt": "2020-11-04T11:31:47Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/VosManagerBlImpl.java", "diffHunk": "@@ -821,6 +825,92 @@ public boolean isMemberBanned(PerunSession sess, int memberId) {\n \t\treturn vosManagerImpl.isMemberBanned(sess, memberId);\n \t}\n \n+\t@Override\n+\tpublic void convertSponsoredUsers(PerunSession sess, Vo vo) {\n+\t\tperunBl.getUsersManagerBl().getSpecificUsers(sess).stream()\n+\t\t\t\t.filter(User::isSponsoredUser)\n+\t\t\t\t.forEach(user -> convertToSponsoredMember(sess, user, vo));\n+\t}\n+\n+\t@Override\n+\tpublic void convertSponsoredUsersWithNewSponsor(PerunSession sess, Vo vo, User newSponsor) {\n+\t\tperunBl.getUsersManagerBl().getSpecificUsers(sess).stream()\n+\t\t\t\t.filter(User::isSponsoredUser)\n+\t\t\t\t.forEach(user -> convertToSponsoredMemberWithNewSponsor(sess, user, newSponsor, vo));\n+\t}\n+\n+\t/**\n+\t * Sponsor given user by the given newSponsor in the given vo. If the newSponsor doesn't have\n+\t * the SPONSOR role, it will be set to him.\n+\t *\n+\t * @param sess session\n+\t * @param user user to be sponsored\n+\t * @param newSponsor new sponsor\n+\t * @param vo vo where the given user will be sponsored\n+\t */\n+\tprivate void convertToSponsoredMemberWithNewSponsor(PerunSession sess, User user, User newSponsor, Vo vo) {\n+\t\ttry {\n+\t\t\tMember member = perunBl.getMembersManagerBl().getMemberByUser(sess, vo, user);\n+\n+\t\t\tsponsorMemberByUser(sess, member, newSponsor, vo);\n+\t\t} catch (MemberNotExistsException e) {\n+\t\t\t// if the sponsored user is not member of the given vo, skip it\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Converts sponsored user to sponsored member in the given vo.\n+\t * If the user is not member of the given vo, it is skipped.\n+\t *\n+\t * @param sess session\n+\t * @param user user\n+\t * @param vo vo where the given user will be sponsored\n+\t */\n+\tprivate void convertToSponsoredMember(PerunSession sess, User user, Vo vo) {\n+\t\ttry {\n+\t\t\tList<User> owners = perunBl.getUsersManagerBl().getUsersBySpecificUser(sess, user);\n+\t\t\tMember member = perunBl.getMembersManagerBl().getMemberByUser(sess, vo, user);\n+\n+\t\t\tfor (User owner : owners) {\n+\t\t\t\tsponsorMemberByUser(sess, member, owner, vo);\n+\t\t\t}\n+\t\t} catch (MemberNotExistsException e) {\n+\t\t\t// if the sponsored user is not member of the given vo, skip it\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Sponsor the given member by the given sponsor in the given vo. If the\n+\t * member is already sponsored, this method just adds the sponsor to the given member.\n+\t * If the member is not sponsored at all, it will transform it into a sponsored one\n+\t * with the given sponsor.\n+\t *\n+\t * @param sess session\n+\t * @param member member to be sponsored\n+\t * @param sponsor sponsor\n+\t * @param vo vo where the member is sponsored\n+\t */\n+\tprivate void sponsorMemberByUser(PerunSession sess, Member member, User sponsor, Vo vo) {\n+\t\ttry {\n+\t\t\tif (!getPerunBl().getVosManagerBl().isUserInRoleForVo(sess, sponsor, Role.SPONSOR, vo, true)) {\n+\t\t\t\tAuthzResolverBlImpl.setRole(sess, sponsor, vo, Role.SPONSOR);\n+\t\t\t}\n+\n+\t\t\t// we need to refresh information and check if the member is already sponsored\n+\t\t\tmember = perunBl.getMembersManagerBl().getMemberById(sess, member.getId());\n+\n+\t\t\tif (member.isSponsored()) {\n+\t\t\t\t// if the member is already sponsored, just add another sponsor\n+\t\t\t\tperunBl.getMembersManagerBl().sponsorMember(sess, member, sponsor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147ce28a7968615da1c8cb9061f1b6208451e50a"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY0NTMxNA==", "bodyText": "I have added a catch block that should solve this problem.", "url": "https://github.com/CESNET/perun/pull/2969#discussion_r518645314", "createdAt": "2020-11-06T10:02:06Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/VosManagerBlImpl.java", "diffHunk": "@@ -821,6 +825,92 @@ public boolean isMemberBanned(PerunSession sess, int memberId) {\n \t\treturn vosManagerImpl.isMemberBanned(sess, memberId);\n \t}\n \n+\t@Override\n+\tpublic void convertSponsoredUsers(PerunSession sess, Vo vo) {\n+\t\tperunBl.getUsersManagerBl().getSpecificUsers(sess).stream()\n+\t\t\t\t.filter(User::isSponsoredUser)\n+\t\t\t\t.forEach(user -> convertToSponsoredMember(sess, user, vo));\n+\t}\n+\n+\t@Override\n+\tpublic void convertSponsoredUsersWithNewSponsor(PerunSession sess, Vo vo, User newSponsor) {\n+\t\tperunBl.getUsersManagerBl().getSpecificUsers(sess).stream()\n+\t\t\t\t.filter(User::isSponsoredUser)\n+\t\t\t\t.forEach(user -> convertToSponsoredMemberWithNewSponsor(sess, user, newSponsor, vo));\n+\t}\n+\n+\t/**\n+\t * Sponsor given user by the given newSponsor in the given vo. If the newSponsor doesn't have\n+\t * the SPONSOR role, it will be set to him.\n+\t *\n+\t * @param sess session\n+\t * @param user user to be sponsored\n+\t * @param newSponsor new sponsor\n+\t * @param vo vo where the given user will be sponsored\n+\t */\n+\tprivate void convertToSponsoredMemberWithNewSponsor(PerunSession sess, User user, User newSponsor, Vo vo) {\n+\t\ttry {\n+\t\t\tMember member = perunBl.getMembersManagerBl().getMemberByUser(sess, vo, user);\n+\n+\t\t\tsponsorMemberByUser(sess, member, newSponsor, vo);\n+\t\t} catch (MemberNotExistsException e) {\n+\t\t\t// if the sponsored user is not member of the given vo, skip it\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Converts sponsored user to sponsored member in the given vo.\n+\t * If the user is not member of the given vo, it is skipped.\n+\t *\n+\t * @param sess session\n+\t * @param user user\n+\t * @param vo vo where the given user will be sponsored\n+\t */\n+\tprivate void convertToSponsoredMember(PerunSession sess, User user, Vo vo) {\n+\t\ttry {\n+\t\t\tList<User> owners = perunBl.getUsersManagerBl().getUsersBySpecificUser(sess, user);\n+\t\t\tMember member = perunBl.getMembersManagerBl().getMemberByUser(sess, vo, user);\n+\n+\t\t\tfor (User owner : owners) {\n+\t\t\t\tsponsorMemberByUser(sess, member, owner, vo);\n+\t\t\t}\n+\t\t} catch (MemberNotExistsException e) {\n+\t\t\t// if the sponsored user is not member of the given vo, skip it\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Sponsor the given member by the given sponsor in the given vo. If the\n+\t * member is already sponsored, this method just adds the sponsor to the given member.\n+\t * If the member is not sponsored at all, it will transform it into a sponsored one\n+\t * with the given sponsor.\n+\t *\n+\t * @param sess session\n+\t * @param member member to be sponsored\n+\t * @param sponsor sponsor\n+\t * @param vo vo where the member is sponsored\n+\t */\n+\tprivate void sponsorMemberByUser(PerunSession sess, Member member, User sponsor, Vo vo) {\n+\t\ttry {\n+\t\t\tif (!getPerunBl().getVosManagerBl().isUserInRoleForVo(sess, sponsor, Role.SPONSOR, vo, true)) {\n+\t\t\t\tAuthzResolverBlImpl.setRole(sess, sponsor, vo, Role.SPONSOR);\n+\t\t\t}\n+\n+\t\t\t// we need to refresh information and check if the member is already sponsored\n+\t\t\tmember = perunBl.getMembersManagerBl().getMemberById(sess, member.getId());\n+\n+\t\t\tif (member.isSponsored()) {\n+\t\t\t\t// if the member is already sponsored, just add another sponsor\n+\t\t\t\tperunBl.getMembersManagerBl().sponsorMember(sess, member, sponsor);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3OTQzNA=="}, "originalCommit": {"oid": "147ce28a7968615da1c8cb9061f1b6208451e50a"}, "originalPosition": 103}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2148, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}