{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5ODk0NzI0", "number": 2707, "title": "CORE: Check that Member and Group are from the same VO", "bodyText": "We could and probably should check, that Member and Group on the input\nare from the same VO. We already check group-resource and member-resource\nversions and this check was missing.\nAdded check to the expected methods working with member-group attributes.\nIt throws MemberGroupMismatchException. This exception should be catched\nby inner method logic, if there is no member/group in the method input and converted\nto either InternalErrorException or ConsistencyErrorException.\nThis check might be missing from methods, which already check member-resource\nand group-resource, since they transitively must come from the same VO.\nSome tests were fixed, since we used member from different VO than group.", "createdAt": "2020-05-19T05:55:23Z", "url": "https://github.com/CESNET/perun/pull/2707", "merged": true, "mergeCommit": {"oid": "8999edf702b41a9ee24151adf00162a0d3f9da0a"}, "closed": true, "closedAt": "2020-05-22T09:33:33Z", "author": {"login": "zlamalp"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcittk4gH2gAyNDE5ODk0NzI0OjdhZTNjMjUyZjJiYjA5OTdlMWFkOTMwOWE4NjM3MThlYTg3NjFmMWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcju5JWgFqTQxNjc3NTg0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7ae3c252f2bb0997e1ad9309a863718ea8761f1a", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/7ae3c252f2bb0997e1ad9309a863718ea8761f1a", "committedDate": "2020-05-19T05:35:01Z", "message": "CORE: Added check on same VO origin in member-group methods\n\n- As we have multiple checks on same VO origin when working\n  with group-resource or member-resource methods, we were missing\n  check on member-group methods. A few implemented own check.\n- New check method was added in AttributesManagerBl and is generally\n  used when working with member-group attributes, exception then\n  propagates into other managers, where its usually considered as\n  (converted to) InternalErrorException or ConsistencyErrorException.\n- Fixed test which were using members and groups from different vos."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ec3eb111cbc6b3c7b4cf8397b163af101a7d778", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/3ec3eb111cbc6b3c7b4cf8397b163af101a7d778", "committedDate": "2020-05-19T05:48:41Z", "message": "REGISTRAR: Fixed test for member vo matches group vo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MjExMTYx", "url": "https://github.com/CESNET/perun/pull/2707#pullrequestreview-414211161", "createdAt": "2020-05-19T08:22:00Z", "commit": {"oid": "3ec3eb111cbc6b3c7b4cf8397b163af101a7d778"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODoyMjowMFrOGXVLkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODoyNDoxN1rOGXVRkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExNzQ1Nw==", "bodyText": "You should remove this comment.", "url": "https://github.com/CESNET/perun/pull/2707#discussion_r427117457", "createdAt": "2020-05-19T08:22:00Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/test/java/cz/metacentrum/perun/core/entry/AttributesManagerEntryIntegrationTestAbstract.java", "diffHunk": "@@ -5607,7 +5607,8 @@ public void testUniqAttributes() throws Exception {\n \t\t\t\t\t\t\tbreak;\n \t\t\t\t\t\tcase \"member_group\":\n \t\t\t\t\t\t\tattributesManager.setAttribute(sess, member1OfUser1, group1InVo1, a);\n-\t\t\t\t\t\t\tattributesManager.setAttribute(sess, member2OfUser1, group1InVo1, b);\n+\t\t\t\t\t\t\tattributesManager.setAttribute(sess, member2OfUser2, group2InVo1, b);\n+\t\t\t\t\t\t\t//attributesManager.setAttribute(sess, member2OfUser1, group1InVo1, b);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ec3eb111cbc6b3c7b4cf8397b163af101a7d778"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExODk5Mg==", "bodyText": "Why are you adding exception MemberGroupMismatchException to the methods, where is no control of it?", "url": "https://github.com/CESNET/perun/pull/2707#discussion_r427118992", "createdAt": "2020-05-19T08:24:17Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -356,7 +362,7 @@ public AttributesManagerBlImpl(AttributesManagerImplApi attributesManagerImpl) {\n \t}\n \n \t@Override\n-\tpublic List<Attribute> getAttributes(PerunSession sess, Group group, Member member, Resource resource, List<String> attrNames, boolean workWithUserAttributes) throws InternalErrorException, MemberResourceMismatchException, GroupResourceMismatchException {\n+\tpublic List<Attribute> getAttributes(PerunSession sess, Group group, Member member, Resource resource, List<String> attrNames, boolean workWithUserAttributes) throws InternalErrorException, MemberResourceMismatchException, GroupResourceMismatchException, MemberGroupMismatchException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ec3eb111cbc6b3c7b4cf8397b163af101a7d778"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0df8491153f9b6a498df50a8104715cda9e02afc", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/0df8491153f9b6a498df50a8104715cda9e02afc", "committedDate": "2020-05-19T09:08:27Z", "message": "CORE: Added check on member-group mismatch to getAttributes()\n\n- getAttributes(group,member,resource,attrNames,workWithUserAttributes)\n  now explicitly checks on member-group mismatch. It previously\n  checked only in the case, that attrNames were empty (using\n  subsequent call to getAttributes(member,group).\n  Now we check it at the method start.\n- Removed forgotten comment from the tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MjYwNDA0", "url": "https://github.com/CESNET/perun/pull/2707#pullrequestreview-414260404", "createdAt": "2020-05-19T09:21:10Z", "commit": {"oid": "0df8491153f9b6a498df50a8104715cda9e02afc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97e78bcf8b6c96916534402f3229a92a35ac1a3e", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/97e78bcf8b6c96916534402f3229a92a35ac1a3e", "committedDate": "2020-05-19T10:26:57Z", "message": "CORE: Added more member-group checks and improved RPC javadoc\n\n- We now check member-group relation also for getAttributeById()\n- Added some necessary exceptions in the RPC javadoc of changed\n  methods. Overall whole RPC javadoc of AttributesManager should\n  be improved."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MzI5NzQ5", "url": "https://github.com/CESNET/perun/pull/2707#pullrequestreview-414329749", "createdAt": "2020-05-19T10:55:45Z", "commit": {"oid": "97e78bcf8b6c96916534402f3229a92a35ac1a3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MDM3Mjkw", "url": "https://github.com/CESNET/perun/pull/2707#pullrequestreview-416037290", "createdAt": "2020-05-21T10:24:10Z", "commit": {"oid": "97e78bcf8b6c96916534402f3229a92a35ac1a3e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMDoyNDoxMFrOGYt0ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMDoyNDoxMFrOGYt0ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU2OTc4Ng==", "bodyText": "I think you can move the check before the if.", "url": "https://github.com/CESNET/perun/pull/2707#discussion_r428569786", "createdAt": "2020-05-21T10:24:10Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -3499,28 +3515,31 @@ public void checkAttributesSemantics(PerunSession sess, Member member, Resource\n \t}\n \n \t@Override\n-\tpublic void checkAttributeSemantics(PerunSession sess, Member member, Group group, Attribute attribute) throws InternalErrorException, WrongAttributeAssignmentException {\n+\tpublic void checkAttributeSemantics(PerunSession sess, Member member, Group group, Attribute attribute) throws InternalErrorException, WrongAttributeAssignmentException, MemberGroupMismatchException {\n+\t\tthis.checkMemberIsFromTheSameVoLikeGroup(sess, member, group);\n \t\tgetAttributesManagerImpl().checkNamespace(sess, attribute, NS_MEMBER_GROUP_ATTR);\n \n \t\tif (attribute.getValue() == null && !isTrulyRequiredAttribute(sess, member, group, attribute)) return;\n \t\tgetAttributesManagerImpl().checkAttributeSemantics(sess, member, group, attribute);\n \t}\n \n \t@Override\n-\tpublic void checkAttributesSemantics(PerunSession sess, Member member, Group group, List<Attribute> attributes) throws InternalErrorException, WrongAttributeAssignmentException, WrongReferenceAttributeValueException {\n+\tpublic void checkAttributesSemantics(PerunSession sess, Member member, Group group, List<Attribute> attributes) throws InternalErrorException, WrongAttributeAssignmentException, WrongReferenceAttributeValueException, MemberGroupMismatchException {\n \t\tcheckAttributesSemantics(sess, member, group, attributes, false);\n \t}\n \n \t@Override\n-\tpublic void checkAttributesSemantics(PerunSession sess, Member member, Group group, List<Attribute> attributes, boolean workWithUserAttributes) throws InternalErrorException, WrongAttributeAssignmentException, WrongReferenceAttributeValueException {\n+\tpublic void checkAttributesSemantics(PerunSession sess, Member member, Group group, List<Attribute> attributes, boolean workWithUserAttributes) throws InternalErrorException, WrongAttributeAssignmentException, WrongReferenceAttributeValueException, MemberGroupMismatchException {\n \t\tif (!workWithUserAttributes) {\n \t\t\tgetAttributesManagerImpl().checkNamespace(sess, attributes, NS_MEMBER_GROUP_ATTR);\n+\t\t\tthis.checkMemberIsFromTheSameVoLikeGroup(sess, member, group);\n \n \t\t\tfor (Attribute attribute : attributes) {\n \t\t\t\tif (attribute.getValue() == null && !isTrulyRequiredAttribute(sess, member, group, attribute)) continue;\n \t\t\t\tgetAttributesManagerImpl().checkAttributeSemantics(sess, member, group, attribute);\n \t\t\t}\n \t\t} else {\n+\t\t\tthis.checkMemberIsFromTheSameVoLikeGroup(sess, member, group);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97e78bcf8b6c96916534402f3229a92a35ac1a3e"}, "originalPosition": 258}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86a2bae8f69fe31f11fb5533cd64b2d2638c600d", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/86a2bae8f69fe31f11fb5533cd64b2d2638c600d", "committedDate": "2020-05-21T17:00:54Z", "message": "CORE: Removed code duplicity in checkAttributeSemantics()\n\n- We can have check on same vo for member and group at the method\n  start and not twice inside both branches of IF later.\n- Lazy load user object to save up 1 query if we don't pass\n  user attributes to the method."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2Nzc1ODQ4", "url": "https://github.com/CESNET/perun/pull/2707#pullrequestreview-416775848", "createdAt": "2020-05-22T09:31:29Z", "commit": {"oid": "86a2bae8f69fe31f11fb5533cd64b2d2638c600d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1378, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}