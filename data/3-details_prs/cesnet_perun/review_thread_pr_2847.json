{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MDU5NTIw", "number": 2847, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNjo1NDoxMFrOEXfr_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNzoyNzo1MVrOEYXbkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMDcxODY4OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNjo1NDoxMFrOG_UIXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzo1Mjo0MVrOHAAG1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0MzI5NQ==", "bodyText": "If methods making a conversion to unique and back should work the same way, they both should do the same thing for attributes in the wrong state. I would suggest to create a new exception \"AttributeNotMarkedUniqueException\" and throw it here.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r469043295", "createdAt": "2020-08-12T06:54:10Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -8116,10 +8116,19 @@ public void convertAttributeToUnique(PerunSession session, int attrId) throws At\n \t\tlog.info(\"converting attribute {} to unique\",attrDef.getName());\n \t\tattrDef.setUnique(true);\n \t\tthis.updateAttributeDefinition(session, attrDef);\n-\t\tlong startTime = System.currentTimeMillis();\n+\n \t\tattributesManagerImpl.convertAttributeValuesToUnique(session, attrDef);\n-\t\tlong endTime = System.currentTimeMillis();\n-\t\tlog.debug(\"Attribute {} was converted to unique in {} ms\",attrDef.getName(),(endTime-startTime));\n+\t}\n+\n+\t@Override\n+\tpublic void convertAttributeToNonunique(PerunSession session, int attrId) throws AttributeNotExistsException {\n+\t\tAttributeDefinition attrDef = getAttributeDefinitionById(session, attrId);\n+\t\tif(!attrDef.isUnique()) return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de4e83dce0fb059756f73b387eb1266a36b415d"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc2Mzc5OQ==", "bodyText": "Ok, added.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r469763799", "createdAt": "2020-08-13T07:52:41Z", "author": {"login": "metodej"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -8116,10 +8116,19 @@ public void convertAttributeToUnique(PerunSession session, int attrId) throws At\n \t\tlog.info(\"converting attribute {} to unique\",attrDef.getName());\n \t\tattrDef.setUnique(true);\n \t\tthis.updateAttributeDefinition(session, attrDef);\n-\t\tlong startTime = System.currentTimeMillis();\n+\n \t\tattributesManagerImpl.convertAttributeValuesToUnique(session, attrDef);\n-\t\tlong endTime = System.currentTimeMillis();\n-\t\tlog.debug(\"Attribute {} was converted to unique in {} ms\",attrDef.getName(),(endTime-startTime));\n+\t}\n+\n+\t@Override\n+\tpublic void convertAttributeToNonunique(PerunSession session, int attrId) throws AttributeNotExistsException {\n+\t\tAttributeDefinition attrDef = getAttributeDefinitionById(session, attrId);\n+\t\tif(!attrDef.isUnique()) return;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0MzI5NQ=="}, "originalCommit": {"oid": "1de4e83dce0fb059756f73b387eb1266a36b415d"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMDc0MTI5OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/AttributesManagerEntry.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNzowMTo1MFrOG_UWKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzo1MzoyMlrOHAAIYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NjgyNg==", "bodyText": "For this exception, I would not use this kind of specific message, because you can't be sure what is really set in the policy and if anyone changes the policy, this text would be misleading. Use more generic message like:\nthrow new PrivilegeException(sess, \"convertAttributeToNonunique\");", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r469046826", "createdAt": "2020-08-12T07:01:50Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/AttributesManagerEntry.java", "diffHunk": "@@ -4522,6 +4522,18 @@ public void convertAttributeToUnique(PerunSession session, int attrId) throws Pr\n \t\tgetAttributesManagerBl().convertAttributeToUnique(session, attrId);\n \t}\n \n+\t@Override\n+\tpublic void convertAttributeToNonunique(PerunSession session, int attrId) throws PrivilegeException, AttributeNotExistsException {\n+\t\tUtils.checkPerunSession(session);\n+\n+\t\t// Authorization\n+\t\tif(!AuthzResolver.authorizedInternal(session, \"convertAttributeToNonunique_int_policy\")) {\n+\t\t\tthrow new PrivilegeException(\"This operation can do only PerunAdmin.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de4e83dce0fb059756f73b387eb1266a36b415d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc2NDE5NA==", "bodyText": "Ok, fixed (even in convertAttributeToUnique).", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r469764194", "createdAt": "2020-08-13T07:53:22Z", "author": {"login": "metodej"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/AttributesManagerEntry.java", "diffHunk": "@@ -4522,6 +4522,18 @@ public void convertAttributeToUnique(PerunSession session, int attrId) throws Pr\n \t\tgetAttributesManagerBl().convertAttributeToUnique(session, attrId);\n \t}\n \n+\t@Override\n+\tpublic void convertAttributeToNonunique(PerunSession session, int attrId) throws PrivilegeException, AttributeNotExistsException {\n+\t\tUtils.checkPerunSession(session);\n+\n+\t\t// Authorization\n+\t\tif(!AuthzResolver.authorizedInternal(session, \"convertAttributeToNonunique_int_policy\")) {\n+\t\t\tthrow new PrivilegeException(\"This operation can do only PerunAdmin.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NjgyNg=="}, "originalCommit": {"oid": "1de4e83dce0fb059756f73b387eb1266a36b415d"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMDc4NjI2OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/implApi/AttributesManagerImplApi.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNzoxNjozNFrOG_UxYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzo1NzozNVrOHAARrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1Mzc5NA==", "bodyText": "I am thinking about the way how to check that all expected values were removed. What about changing the behavior of both IMPL and BL methods for conversion to return a number of rows added or deleted? Then this could be at least tested in tests. What do you think?", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r469053794", "createdAt": "2020-08-12T07:16:34Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/implApi/AttributesManagerImplApi.java", "diffHunk": "@@ -2601,4 +2601,9 @@\n \t * Copies all values of the attribute to table _attr_u_values which has unique constraint.\n \t */\n \tvoid convertAttributeValuesToUnique(PerunSession session, AttributeDefinition attrDef);\n+\n+\t/**\n+\t * Deletes all values of the attribute from table _attr_u_values which has unique constraint.\n+\t */\n+\tvoid convertAttributeValuesToNonunique(PerunSession session, AttributeDefinition attrDef);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de4e83dce0fb059756f73b387eb1266a36b415d"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc2NjU3NQ==", "bodyText": "Yes, that sounds nice, I've already tested it manually, because the test already in use basically tests only the change of the attribute to unique/nonunique state... So I've added one more that checks exactly how many rows were changed.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r469766575", "createdAt": "2020-08-13T07:57:35Z", "author": {"login": "metodej"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/implApi/AttributesManagerImplApi.java", "diffHunk": "@@ -2601,4 +2601,9 @@\n \t * Copies all values of the attribute to table _attr_u_values which has unique constraint.\n \t */\n \tvoid convertAttributeValuesToUnique(PerunSession session, AttributeDefinition attrDef);\n+\n+\t/**\n+\t * Deletes all values of the attribute from table _attr_u_values which has unique constraint.\n+\t */\n+\tvoid convertAttributeValuesToNonunique(PerunSession session, AttributeDefinition attrDef);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1Mzc5NA=="}, "originalCommit": {"oid": "1de4e83dce0fb059756f73b387eb1266a36b415d"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzOTcwOTY0OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNjozMTowMVrOHApFyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNjo1NjowNVrOHApoGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQzNTI3Mg==", "bodyText": "@stavamichal Do we really want to delete all values when doing this conversion? Couldn't we just move those values to a different table? I understand that when you do the opposite conversion, you have to remove the old values because there could be duplicates. But in this direction, I think it is not necessary.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r470435272", "createdAt": "2020-08-14T06:31:01Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java", "diffHunk": "@@ -4519,6 +4515,16 @@ public void convertAttributeValuesToUnique(PerunSession session, AttributeDefini\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic int convertAttributeValuesToNonunique(PerunSession session, AttributeDefinition attrDef) {\n+\t\tString tablePrefix = attributeToTablePrefix(attrDef);\n+\t\ttry {\n+\t\t\treturn jdbc.update(\"DELETE FROM \" + tablePrefix + \"_attr_u_values WHERE attr_id=?\", attrDef.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ0Mjc2Mg==", "bodyText": "Unique attributes has values in both tables \"_attr_values\" and \"_attr_u_vaues\". So yes, you need to delete them. If you let them here, you can have a big problem when you want to convert attribute to unique again. There will be inconsistency in data.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r470442762", "createdAt": "2020-08-14T06:52:32Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java", "diffHunk": "@@ -4519,6 +4515,16 @@ public void convertAttributeValuesToUnique(PerunSession session, AttributeDefini\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic int convertAttributeValuesToNonunique(PerunSession session, AttributeDefinition attrDef) {\n+\t\tString tablePrefix = attributeToTablePrefix(attrDef);\n+\t\ttry {\n+\t\t\treturn jdbc.update(\"DELETE FROM \" + tablePrefix + \"_attr_u_values WHERE attr_id=?\", attrDef.getId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQzNTI3Mg=="}, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ0NDA1OQ==", "bodyText": "I see. I thought they are only in this table. Thanks for your explanation.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r470444059", "createdAt": "2020-08-14T06:56:05Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/AttributesManagerImpl.java", "diffHunk": "@@ -4519,6 +4515,16 @@ public void convertAttributeValuesToUnique(PerunSession session, AttributeDefini\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic int convertAttributeValuesToNonunique(PerunSession session, AttributeDefinition attrDef) {\n+\t\tString tablePrefix = attributeToTablePrefix(attrDef);\n+\t\ttry {\n+\t\t\treturn jdbc.update(\"DELETE FROM \" + tablePrefix + \"_attr_u_values WHERE attr_id=?\", attrDef.getId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQzNTI3Mg=="}, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzOTczODc0OnYy", "diffSide": "RIGHT", "path": "perun-core/src/test/java/cz/metacentrum/perun/core/entry/AttributesManagerEntryIntegrationTestAbstract.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNjo0MzozMlrOHApW4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwOToxNzoyNFrOHBg3ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQzOTY0OA==", "bodyText": "Hi @metodej, It is a good practice that each test is testing only one thing. For example, you would have one test to test the conversion of a string attribute, one for a list attribute etc. If you test multiple scenarios in one test, one has to debug what has actually gone wrong. If this test would fail, it isn't easy to understand why, because the test itself is long and with two for loops and two switches.\nTo write multiple tests, you wouldn't even have to duplicate the code. You could write a private test method that would contain the shared code, and you could pass some arguments to this method, which would differ for different scenarios.\nIf you would decide to rewrite this and had some trouble, just write to me and we will figure something out.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r470439648", "createdAt": "2020-08-14T06:43:32Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/test/java/cz/metacentrum/perun/core/entry/AttributesManagerEntryIntegrationTestAbstract.java", "diffHunk": "@@ -5499,6 +5499,158 @@ public void testConvertingToUniqAttribute() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testConvertingToNonuniqAttribute() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0OTExNQ==", "bodyText": "Ok, so I broke down the for cycle that iterated by types into several tests each testing one type and also moved duplicate code to private methods used by these parts.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r471349115", "createdAt": "2020-08-17T09:17:24Z", "author": {"login": "metodej"}, "path": "perun-core/src/test/java/cz/metacentrum/perun/core/entry/AttributesManagerEntryIntegrationTestAbstract.java", "diffHunk": "@@ -5499,6 +5499,158 @@ public void testConvertingToUniqAttribute() throws Exception {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testConvertingToNonuniqAttribute() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQzOTY0OA=="}, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzOTc0OTAwOnYy", "diffSide": "RIGHT", "path": "perun-openapi/openapi.yml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNjo0ODowM1rOHApcxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwOToxNzozMVrOHBg3sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ0MTE1OQ==", "bodyText": "This parameter has a name attribute and in the AttributesManagerMethod you are expecting a parameter named attrDefId. These two values have to be the same. I suggest changing the name in the OpenApi because the method convertAttributeToUnique could be already used by someone and if you would change it, it would stop working for them.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r470441159", "createdAt": "2020-08-14T06:48:03Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-openapi/openapi.yml", "diffHunk": "@@ -5938,7 +5938,35 @@ paths:\n           $ref: '#/components/responses/ExceptionResponse'\n \n \n-  #TODO convertAttributeToUnique\n+  /urlinjsonout/attributesManager/convertAttributeToUnique:\n+    post:\n+      tags:\n+        - AttributesManager\n+      operationId: convertAttributeToUnique\n+      summary: \"Converts attribute to unique - marks its definition as unique and ensures that all its values are unique.\n+      Entityless attributes cannot be converted to unique, only attributes attached to PerunBeans or pairs of PerunBeans.\"\n+      parameters:\n+        - $ref: '#/components/parameters/attributeInteger'\n+      responses:\n+        '200':\n+          $ref: '#/components/responses/VoidResponse'\n+        default:\n+          $ref: '#/components/responses/ExceptionResponse'\n+\n+  /urlinjsonout/attributesManager/convertAttributeToNonunique:\n+    post:\n+      tags:\n+        - AttributesManager\n+      operationId: convertAttributeToNonunique\n+      summary: \"Converts attribute to nonunique - unmarks unique flag from attribute definition, and deletes all values\n+      from a special table with unique constraint that ensures that all values remain unique.\"\n+      parameters:\n+        - $ref: '#/components/parameters/attributeInteger'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0OTE2OQ==", "bodyText": "Fixed.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r471349169", "createdAt": "2020-08-17T09:17:31Z", "author": {"login": "metodej"}, "path": "perun-openapi/openapi.yml", "diffHunk": "@@ -5938,7 +5938,35 @@ paths:\n           $ref: '#/components/responses/ExceptionResponse'\n \n \n-  #TODO convertAttributeToUnique\n+  /urlinjsonout/attributesManager/convertAttributeToUnique:\n+    post:\n+      tags:\n+        - AttributesManager\n+      operationId: convertAttributeToUnique\n+      summary: \"Converts attribute to unique - marks its definition as unique and ensures that all its values are unique.\n+      Entityless attributes cannot be converted to unique, only attributes attached to PerunBeans or pairs of PerunBeans.\"\n+      parameters:\n+        - $ref: '#/components/parameters/attributeInteger'\n+      responses:\n+        '200':\n+          $ref: '#/components/responses/VoidResponse'\n+        default:\n+          $ref: '#/components/responses/ExceptionResponse'\n+\n+  /urlinjsonout/attributesManager/convertAttributeToNonunique:\n+    post:\n+      tags:\n+        - AttributesManager\n+      operationId: convertAttributeToNonunique\n+      summary: \"Converts attribute to nonunique - unmarks unique flag from attribute definition, and deletes all values\n+      from a special table with unique constraint that ensures that all values remain unique.\"\n+      parameters:\n+        - $ref: '#/components/parameters/attributeInteger'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ0MTE1OQ=="}, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzOTgzNDUwOnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNzoyMTo0M1rOHAqO1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwOToxNzo0M1rOHBg4Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1Mzk3NA==", "bodyText": "Exception message should state non unique at the end.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r470453974", "createdAt": "2020-08-14T07:21:43Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -8116,10 +8117,19 @@ public void convertAttributeToUnique(PerunSession session, int attrId) throws At\n \t\tlog.info(\"converting attribute {} to unique\",attrDef.getName());\n \t\tattrDef.setUnique(true);\n \t\tthis.updateAttributeDefinition(session, attrDef);\n-\t\tlong startTime = System.currentTimeMillis();\n+\n \t\tattributesManagerImpl.convertAttributeValuesToUnique(session, attrDef);\n-\t\tlong endTime = System.currentTimeMillis();\n-\t\tlog.debug(\"Attribute {} was converted to unique in {} ms\",attrDef.getName(),(endTime-startTime));\n+\t}\n+\n+\t@Override\n+\tpublic int convertAttributeToNonunique(PerunSession session, int attrId) throws AttributeNotExistsException, AttributeNotMarkedUniqueException {\n+\t\tAttributeDefinition attrDef = getAttributeDefinitionById(session, attrId);\n+\t\tif(!attrDef.isUnique()) throw new AttributeNotMarkedUniqueException(\"Cannot convert attribute because it is already marked as unique\", attrDef);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0OTI4Mg==", "bodyText": "Fixed.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r471349282", "createdAt": "2020-08-17T09:17:43Z", "author": {"login": "metodej"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -8116,10 +8117,19 @@ public void convertAttributeToUnique(PerunSession session, int attrId) throws At\n \t\tlog.info(\"converting attribute {} to unique\",attrDef.getName());\n \t\tattrDef.setUnique(true);\n \t\tthis.updateAttributeDefinition(session, attrDef);\n-\t\tlong startTime = System.currentTimeMillis();\n+\n \t\tattributesManagerImpl.convertAttributeValuesToUnique(session, attrDef);\n-\t\tlong endTime = System.currentTimeMillis();\n-\t\tlog.debug(\"Attribute {} was converted to unique in {} ms\",attrDef.getName(),(endTime-startTime));\n+\t}\n+\n+\t@Override\n+\tpublic int convertAttributeToNonunique(PerunSession session, int attrId) throws AttributeNotExistsException, AttributeNotMarkedUniqueException {\n+\t\tAttributeDefinition attrDef = getAttributeDefinitionById(session, attrId);\n+\t\tif(!attrDef.isUnique()) throw new AttributeNotMarkedUniqueException(\"Cannot convert attribute because it is already marked as unique\", attrDef);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1Mzk3NA=="}, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzOTg0Njg5OnYy", "diffSide": "RIGHT", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AttributesManagerMethod.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNzoyNjowOVrOHAqWGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwOToxODowMlrOHBg4xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1NTgzMw==", "bodyText": "We do not mention PriviligeException in RPC docs, since its automatically added by docs parsing too.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r470455833", "createdAt": "2020-08-14T07:26:09Z", "author": {"login": "zlamalp"}, "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AttributesManagerMethod.java", "diffHunk": "@@ -3974,6 +3975,25 @@ public Void call(ApiCaller ac, Deserializer parms) throws AttributeAlreadyMarked\n \t\t}\n \t},\n \n+\t/*#\n+\t * Converts attribute to nonunique - unmarks unique flag from attribute definition, and deletes all values\n+\t * from a special table with unique constraint that ensures that all values remain unique.\n+\t * Already nonunique attribute is skipped.\n+\t *\n+\t * @param attrDefId int AttributeDefinition <code>id</code>\n+\t * @throw PrivilegeException Insufficient permissions.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0OTQ0Nw==", "bodyText": "Removed.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r471349447", "createdAt": "2020-08-17T09:18:02Z", "author": {"login": "metodej"}, "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AttributesManagerMethod.java", "diffHunk": "@@ -3974,6 +3975,25 @@ public Void call(ApiCaller ac, Deserializer parms) throws AttributeAlreadyMarked\n \t\t}\n \t},\n \n+\t/*#\n+\t * Converts attribute to nonunique - unmarks unique flag from attribute definition, and deletes all values\n+\t * from a special table with unique constraint that ensures that all values remain unique.\n+\t * Already nonunique attribute is skipped.\n+\t *\n+\t * @param attrDefId int AttributeDefinition <code>id</code>\n+\t * @throw PrivilegeException Insufficient permissions.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1NTgzMw=="}, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzOTg1MTcwOnYy", "diffSide": "RIGHT", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AttributesManagerMethod.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNzoyNzo1MVrOHAqZBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwOToxOToxOFrOHBg7dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1NjU4Mg==", "bodyText": "I don't think that Already nonunique attribute is skipped. sentence is true. I think, that exception is thrown instead.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r470456582", "createdAt": "2020-08-14T07:27:51Z", "author": {"login": "zlamalp"}, "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AttributesManagerMethod.java", "diffHunk": "@@ -3974,6 +3975,25 @@ public Void call(ApiCaller ac, Deserializer parms) throws AttributeAlreadyMarked\n \t\t}\n \t},\n \n+\t/*#\n+\t * Converts attribute to nonunique - unmarks unique flag from attribute definition, and deletes all values\n+\t * from a special table with unique constraint that ensures that all values remain unique.\n+\t * Already nonunique attribute is skipped.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1MDEzNQ==", "bodyText": "Removed.", "url": "https://github.com/CESNET/perun/pull/2847#discussion_r471350135", "createdAt": "2020-08-17T09:19:18Z", "author": {"login": "metodej"}, "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AttributesManagerMethod.java", "diffHunk": "@@ -3974,6 +3975,25 @@ public Void call(ApiCaller ac, Deserializer parms) throws AttributeAlreadyMarked\n \t\t}\n \t},\n \n+\t/*#\n+\t * Converts attribute to nonunique - unmarks unique flag from attribute definition, and deletes all values\n+\t * from a special table with unique constraint that ensures that all values remain unique.\n+\t * Already nonunique attribute is skipped.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1NjU4Mg=="}, "originalCommit": {"oid": "41ea24c00460ee0099016458a859bdf8787ee8c7"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2404, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}