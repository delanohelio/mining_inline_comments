{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1MzQ1MTA5", "number": 2671, "title": "CORE: Fixed audit message resolving for eduPersonScopedAffiliations", "bodyText": "Shorter code when resolving affiliations from users groups.\nAdded getMembersByUserWithStatus() into MembersManagerBl, it\nreturns only those members of users, which have specified status,\neg. VALID.\nModule for user:virt:eduPersonScopedAffiliations now reacts also\non necessary group membership and member status events.\nImplemented new message resolving within module for case of source\ngroup attribute changes, since we must iterate over current group\nusers.", "createdAt": "2020-04-17T21:19:11Z", "url": "https://github.com/CESNET/perun/pull/2671", "merged": true, "mergeCommit": {"oid": "ce706d1579bbea3be0b0ee782c01c0ef44324021"}, "closed": true, "closedAt": "2020-04-21T07:12:19Z", "author": {"login": "zlamalp"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYoAs5AH2gAyNDA1MzQ1MTA5Ojk4ODczZmIyOWJlMDE0NmExNGE1ZTA4MjdhZTRlYTE2OTQ0NmMwOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZuC5PgFqTM5NzAzMTE0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "98873fb29be0146a14a5e0827ae4ea169446c098", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/98873fb29be0146a14a5e0827ae4ea169446c098", "committedDate": "2020-04-17T21:17:14Z", "message": "CORE: Fixed audit message resolving for eduPersonScopedAffiliations\n\n- Shorter code when resolving affiliations from users groups.\n- Added getMembersByUserWithStatus() into MembersManagerBl, it\n  returns only those members of users, which have specified status,\n  eg. VALID.\n- Module for user:virt:eduPersonScopedAffiliations now reacts also\n  on necessary group membership and member status events.\n  Implemented new message resolving within module for case of source\n  group attribute changes, since we must iterate over current group\n  users."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68e70c107bf3d82b955b9744260c066272a31b6b", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/68e70c107bf3d82b955b9744260c066272a31b6b", "committedDate": "2020-04-20T10:51:46Z", "message": "CORE: Fixed tests of eduPersonScopedAffiliations\n\n- We must mock different methods, since implementation of module changed.\n- Also those methods return only VALID members, hence there is no reason\n  for expired member in mocks."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MzUwNDc3", "url": "https://github.com/CESNET/perun/pull/2671#pullrequestreview-396350477", "createdAt": "2020-04-20T11:00:48Z", "commit": {"oid": "68e70c107bf3d82b955b9744260c066272a31b6b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMTowMDo0OFrOGIO7KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMToyOToyM1rOGIP7Cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI4NjMxMg==", "bodyText": "Are you sure this is necessary?  I can't find casting to integer in any other method (using status) in this manager.", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411286312", "createdAt": "2020-04-20T11:00:48Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/MembersManagerImpl.java", "diffHunk": "@@ -147,6 +147,19 @@ public Member getMemberByUserId(PerunSession sess, Vo vo, int userId) throws Int\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic List<Member> getMembersByUserWithStatus(PerunSession sess, User user, Status status) throws InternalErrorException {\n+\t\ttry {\n+\t\t\treturn jdbc.query(\"SELECT \" + memberMappingSelectQuery + \" FROM\" +\n+\t\t\t\t\t\t\t\" members WHERE members.user_id=? and members.status \"+Compatibility.castToInteger()+\"=?\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68e70c107bf3d82b955b9744260c066272a31b6b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMTEyOA==", "bodyText": "Wrong indentation.", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411301128", "createdAt": "2020-04-20T11:26:46Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_eduPersonScopedAffiliations.java", "diffHunk": "@@ -210,28 +207,133 @@ public Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDe\n \n \t@Override\n \tpublic List<AttributeHandleIdentifier> getHandleIdentifiers() {\n+\n \t\tList<AttributeHandleIdentifier> handleIdentifiers = super.getHandleIdentifiers();\n+\n+\t\t// member related events\n \t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AllAttributesRemovedForUser) {\n-\t\t\t\treturn ((AllAttributesRemovedForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\t\tif (auditEvent instanceof DirectMemberAddedToGroup) {\n+\t\t\t\treturn ((DirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof IndirectMemberAddedToGroup) {\n+\t\t\t\treturn ((IndirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberRemovedFromGroupTotally) {\n+\t\t\t\treturn ((MemberRemovedFromGroupTotally) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpiredInGroup) {\n+\t\t\t\treturn ((MemberExpiredInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidatedInGroup) {\n+\t\t\t\treturn ((MemberValidatedInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidated) {\n+\t\t\t\treturn ((MemberValidated) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpired) {\n+\t\t\t\treturn ((MemberExpired) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberSuspended) {\n+\t\t\t\treturn ((MemberSuspended) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberDisabled) {\n+\t\t\t\treturn ((MemberDisabled) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberInvalidated) {\n+\t\t\t\treturn ((MemberInvalidated) auditEvent).getMember().getUserId();\n \t\t\t}\n+\n+\t\t\t// no match\n+\t\t\treturn null;\n+\n \t\t});\n-\t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AttributeSetForUser && ((AttributeSetForUser) auditEvent).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n-\t\t\t\treturn ((AttributeSetForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\treturn handleIdentifiers;\n+\t}\n+\n+\t@Override\n+\tpublic List<AuditEvent> resolveVirtualAttributeValueChange(PerunSessionImpl perunSession, AuditEvent message) throws InternalErrorException, WrongReferenceAttributeValueException, AttributeNotExistsException, WrongAttributeAssignmentException {\n+\n+\t\t// generic handling\n+\t\tList<AuditEvent> resolvingMessages = super.resolveVirtualAttributeValueChange(perunSession, message);\n+\n+\t\t// handle source user attribute changes\n+\n+\t\tif (message instanceof AttributeSetForUser &&\n+\t\t\t\t((AttributeSetForUser) message).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeSetForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AttributeRemovedForUser &&\n+\t\t\t\t((AttributeRemovedForUser) message).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeRemovedForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AllAttributesRemovedForUser) {\n+\n+\t\t\tboolean skip = false;\n+\t\t\ttry {\n+\t\t\t\tAttributeDefinition sourceExists = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getSecondarySourceAttributeName());\n+\t\t\t\tUser user = perunSession.getPerunBl().getUsersManagerBl().getUserById(perunSession, ((AllAttributesRemovedForUser) message).getUser().getId());\n+\t\t\t} catch (AttributeNotExistsException | UserNotExistsException ex) {\n+\t\t\t\t// silently skip this event, since source attribute couldn't be between deleted\n+\t\t\t\t// or user no longer exist\n+\t\t\t\tskip = true;\n \t\t\t}\n-\t\t});\n-\t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AttributeRemovedForUser && ((AttributeRemovedForUser) auditEvent).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n-\t\t\t\treturn ((AttributeRemovedForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\t\tif (!skip) {\n+\t\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AllAttributesRemovedForUser) message).getUser()));\n \t\t\t}\n-\t\t});\n-\t\treturn handleIdentifiers;\n+\n+\t\t}\n+\n+\t\t// handle group attr changes, exclude \"members\" group, since its not counted within attr value\n+\n+\t\tif (message instanceof AttributeSetForGroup &&\n+\t\t\t\t!VosManager.MEMBERS_GROUP.equals(((AttributeSetForGroup) message).getGroup().getName()) &&\n+\t\t\t\t((AttributeSetForGroup) message).getAttribute().getName().equals(getTertiarySourceAttributeName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\t// TODO - get only active group users, since expired are not affected by current group affiliations\n+\t\t\tList<User> users = perunSession.getPerunBl().getGroupsManagerBl().getGroupUsers(perunSession, ((AttributeSetForGroup) message).getGroup());\n+\t\t\tfor (User user : users) {\n+\t\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), user));\n+\t\t\t}\n+\n+\t\t} else if (message instanceof AttributeRemovedForGroup &&\n+\t\t\t\t!VosManager.MEMBERS_GROUP.equals(((AttributeRemovedForGroup) message).getGroup().getName()) &&\n+\t\t\t\t((AttributeRemovedForGroup) message).getAttribute().getName().equals(getTertiarySourceAttributeName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\t// TODO - get only active group users, since expired are not affected by current group affiliations\n+\t\t\tList<User> users = perunSession.getPerunBl().getGroupsManagerBl().getGroupUsers(perunSession, ((AttributeRemovedForGroup) message).getGroup());\n+\t\t\tfor (User user : users) {\n+\t\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), user));\n+\t\t\t}\n+\n+\t\t} else if (message instanceof AllAttributesRemovedForGroup &&\n+\t\t\t\t!VosManager.MEMBERS_GROUP.equals(((AllAttributesRemovedForGroup) message).getGroup().getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68e70c107bf3d82b955b9744260c066272a31b6b"}, "originalPosition": 209}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMjY2Nw==", "bodyText": "I am not sure if this will work when you are overriding method resolveVirtualAttributeValueChange.", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411302667", "createdAt": "2020-04-20T11:29:23Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_eduPersonScopedAffiliations.java", "diffHunk": "@@ -210,28 +207,133 @@ public Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDe\n \n \t@Override\n \tpublic List<AttributeHandleIdentifier> getHandleIdentifiers() {\n+\n \t\tList<AttributeHandleIdentifier> handleIdentifiers = super.getHandleIdentifiers();\n+\n+\t\t// member related events\n \t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AllAttributesRemovedForUser) {\n-\t\t\t\treturn ((AllAttributesRemovedForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\t\tif (auditEvent instanceof DirectMemberAddedToGroup) {\n+\t\t\t\treturn ((DirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof IndirectMemberAddedToGroup) {\n+\t\t\t\treturn ((IndirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberRemovedFromGroupTotally) {\n+\t\t\t\treturn ((MemberRemovedFromGroupTotally) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpiredInGroup) {\n+\t\t\t\treturn ((MemberExpiredInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidatedInGroup) {\n+\t\t\t\treturn ((MemberValidatedInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidated) {\n+\t\t\t\treturn ((MemberValidated) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpired) {\n+\t\t\t\treturn ((MemberExpired) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberSuspended) {\n+\t\t\t\treturn ((MemberSuspended) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberDisabled) {\n+\t\t\t\treturn ((MemberDisabled) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberInvalidated) {\n+\t\t\t\treturn ((MemberInvalidated) auditEvent).getMember().getUserId();\n \t\t\t}\n+\n+\t\t\t// no match\n+\t\t\treturn null;\n+\n \t\t});\n-\t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AttributeSetForUser && ((AttributeSetForUser) auditEvent).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n-\t\t\t\treturn ((AttributeSetForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\treturn handleIdentifiers;\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68e70c107bf3d82b955b9744260c066272a31b6b"}, "originalPosition": 135}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3d26a34bae4cdeb2aaea6c7afb8e97cfde6078e", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/f3d26a34bae4cdeb2aaea6c7afb8e97cfde6078e", "committedDate": "2020-04-20T17:05:05Z", "message": "CORE: Fixed SQL indent in getMembersByUserWithStatus()\n\n- Removed unnecessary whitespace in SQL of getMembersByUserWithStatus();\n- Fixed indent in user:virt:eduPersonScopedAffiliations module."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MDMxMTQ0", "url": "https://github.com/CESNET/perun/pull/2671#pullrequestreview-397031144", "createdAt": "2020-04-21T06:45:58Z", "commit": {"oid": "f3d26a34bae4cdeb2aaea6c7afb8e97cfde6078e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwNjo0NTo1OFrOGI1RHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwNjo0NzoyOVrOGI1UQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxNDUyNg==", "bodyText": "My bad, I missed that line.", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411914526", "createdAt": "2020-04-21T06:45:58Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_eduPersonScopedAffiliations.java", "diffHunk": "@@ -210,28 +207,133 @@ public Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDe\n \n \t@Override\n \tpublic List<AttributeHandleIdentifier> getHandleIdentifiers() {\n+\n \t\tList<AttributeHandleIdentifier> handleIdentifiers = super.getHandleIdentifiers();\n+\n+\t\t// member related events\n \t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AllAttributesRemovedForUser) {\n-\t\t\t\treturn ((AllAttributesRemovedForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\t\tif (auditEvent instanceof DirectMemberAddedToGroup) {\n+\t\t\t\treturn ((DirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof IndirectMemberAddedToGroup) {\n+\t\t\t\treturn ((IndirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberRemovedFromGroupTotally) {\n+\t\t\t\treturn ((MemberRemovedFromGroupTotally) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpiredInGroup) {\n+\t\t\t\treturn ((MemberExpiredInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidatedInGroup) {\n+\t\t\t\treturn ((MemberValidatedInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidated) {\n+\t\t\t\treturn ((MemberValidated) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpired) {\n+\t\t\t\treturn ((MemberExpired) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberSuspended) {\n+\t\t\t\treturn ((MemberSuspended) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberDisabled) {\n+\t\t\t\treturn ((MemberDisabled) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberInvalidated) {\n+\t\t\t\treturn ((MemberInvalidated) auditEvent).getMember().getUserId();\n \t\t\t}\n+\n+\t\t\t// no match\n+\t\t\treturn null;\n+\n \t\t});\n-\t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AttributeSetForUser && ((AttributeSetForUser) auditEvent).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n-\t\t\t\treturn ((AttributeSetForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\treturn handleIdentifiers;\n+\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMjY2Nw=="}, "originalCommit": {"oid": "68e70c107bf3d82b955b9744260c066272a31b6b"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxNTMzMA==", "bodyText": "I see it now. Missed that exclamation mark (now i see it is part of if clause).", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411915330", "createdAt": "2020-04-21T06:47:29Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_eduPersonScopedAffiliations.java", "diffHunk": "@@ -210,28 +207,133 @@ public Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDe\n \n \t@Override\n \tpublic List<AttributeHandleIdentifier> getHandleIdentifiers() {\n+\n \t\tList<AttributeHandleIdentifier> handleIdentifiers = super.getHandleIdentifiers();\n+\n+\t\t// member related events\n \t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AllAttributesRemovedForUser) {\n-\t\t\t\treturn ((AllAttributesRemovedForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\t\tif (auditEvent instanceof DirectMemberAddedToGroup) {\n+\t\t\t\treturn ((DirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof IndirectMemberAddedToGroup) {\n+\t\t\t\treturn ((IndirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberRemovedFromGroupTotally) {\n+\t\t\t\treturn ((MemberRemovedFromGroupTotally) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpiredInGroup) {\n+\t\t\t\treturn ((MemberExpiredInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidatedInGroup) {\n+\t\t\t\treturn ((MemberValidatedInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidated) {\n+\t\t\t\treturn ((MemberValidated) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpired) {\n+\t\t\t\treturn ((MemberExpired) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberSuspended) {\n+\t\t\t\treturn ((MemberSuspended) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberDisabled) {\n+\t\t\t\treturn ((MemberDisabled) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberInvalidated) {\n+\t\t\t\treturn ((MemberInvalidated) auditEvent).getMember().getUserId();\n \t\t\t}\n+\n+\t\t\t// no match\n+\t\t\treturn null;\n+\n \t\t});\n-\t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AttributeSetForUser && ((AttributeSetForUser) auditEvent).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n-\t\t\t\treturn ((AttributeSetForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\treturn handleIdentifiers;\n+\t}\n+\n+\t@Override\n+\tpublic List<AuditEvent> resolveVirtualAttributeValueChange(PerunSessionImpl perunSession, AuditEvent message) throws InternalErrorException, WrongReferenceAttributeValueException, AttributeNotExistsException, WrongAttributeAssignmentException {\n+\n+\t\t// generic handling\n+\t\tList<AuditEvent> resolvingMessages = super.resolveVirtualAttributeValueChange(perunSession, message);\n+\n+\t\t// handle source user attribute changes\n+\n+\t\tif (message instanceof AttributeSetForUser &&\n+\t\t\t\t((AttributeSetForUser) message).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeSetForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AttributeRemovedForUser &&\n+\t\t\t\t((AttributeRemovedForUser) message).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeRemovedForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AllAttributesRemovedForUser) {\n+\n+\t\t\tboolean skip = false;\n+\t\t\ttry {\n+\t\t\t\tAttributeDefinition sourceExists = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getSecondarySourceAttributeName());\n+\t\t\t\tUser user = perunSession.getPerunBl().getUsersManagerBl().getUserById(perunSession, ((AllAttributesRemovedForUser) message).getUser().getId());\n+\t\t\t} catch (AttributeNotExistsException | UserNotExistsException ex) {\n+\t\t\t\t// silently skip this event, since source attribute couldn't be between deleted\n+\t\t\t\t// or user no longer exist\n+\t\t\t\tskip = true;\n \t\t\t}\n-\t\t});\n-\t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AttributeRemovedForUser && ((AttributeRemovedForUser) auditEvent).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n-\t\t\t\treturn ((AttributeRemovedForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\t\tif (!skip) {\n+\t\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AllAttributesRemovedForUser) message).getUser()));\n \t\t\t}\n-\t\t});\n-\t\treturn handleIdentifiers;\n+\n+\t\t}\n+\n+\t\t// handle group attr changes, exclude \"members\" group, since its not counted within attr value\n+\n+\t\tif (message instanceof AttributeSetForGroup &&\n+\t\t\t\t!VosManager.MEMBERS_GROUP.equals(((AttributeSetForGroup) message).getGroup().getName()) &&\n+\t\t\t\t((AttributeSetForGroup) message).getAttribute().getName().equals(getTertiarySourceAttributeName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\t// TODO - get only active group users, since expired are not affected by current group affiliations\n+\t\t\tList<User> users = perunSession.getPerunBl().getGroupsManagerBl().getGroupUsers(perunSession, ((AttributeSetForGroup) message).getGroup());\n+\t\t\tfor (User user : users) {\n+\t\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), user));\n+\t\t\t}\n+\n+\t\t} else if (message instanceof AttributeRemovedForGroup &&\n+\t\t\t\t!VosManager.MEMBERS_GROUP.equals(((AttributeRemovedForGroup) message).getGroup().getName()) &&\n+\t\t\t\t((AttributeRemovedForGroup) message).getAttribute().getName().equals(getTertiarySourceAttributeName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\t// TODO - get only active group users, since expired are not affected by current group affiliations\n+\t\t\tList<User> users = perunSession.getPerunBl().getGroupsManagerBl().getGroupUsers(perunSession, ((AttributeRemovedForGroup) message).getGroup());\n+\t\t\tfor (User user : users) {\n+\t\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), user));\n+\t\t\t}\n+\n+\t\t} else if (message instanceof AllAttributesRemovedForGroup &&\n+\t\t\t\t!VosManager.MEMBERS_GROUP.equals(((AllAttributesRemovedForGroup) message).getGroup().getName())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMTEyOA=="}, "originalCommit": {"oid": "68e70c107bf3d82b955b9744260c066272a31b6b"}, "originalPosition": 209}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1341, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}