{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0NTIyNTE2", "number": 3028, "title": "Core - new method getAllSponsoredMembers", "bodyText": "added new method getAllSponsoredMembers which does not filter members by callers sponsorship\nnew method is used by the old one to prevent duplicating code", "createdAt": "2020-12-08T15:19:27Z", "url": "https://github.com/CESNET/perun/pull/3028", "merged": true, "mergeCommit": {"oid": "59732368cbd919426323efa1368cf53a86390ed5"}, "closed": true, "closedAt": "2020-12-14T11:33:31Z", "author": {"login": "metodej"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkLf0QgH2gAyNTM0NTIyNTE2Ojc4NTg4ZGUyMWUxNGU0OWYxOTg3MTBkMGE5MDI1M2ExMmMyM2RiMDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmEGFAgFqTU1MTI4MzA2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "78588de21e14e49f198710d0a90253a12c23db01", "author": {"user": {"login": "metodej", "name": null}}, "url": "https://github.com/CESNET/perun/commit/78588de21e14e49f198710d0a90253a12c23db01", "committedDate": "2020-12-08T15:02:13Z", "message": "Core - new method getAllSponsoredMembers\n\n- added new method getAllSponsoredMembers which does not filter members by callers sponsorship\n- new method is used by the old one to prevent duplicating code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3OTk2MDY3", "url": "https://github.com/CESNET/perun/pull/3028#pullrequestreview-547996067", "createdAt": "2020-12-09T09:35:37Z", "commit": {"oid": "78588de21e14e49f198710d0a90253a12c23db01"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwOTozNTozN1rOICLIOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwOTozNzowOFrOICLMiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE1MDM5NQ==", "bodyText": "Please, use here the original politic getSponsoredMembers_Vo_policy. The GUI needs it to resolve authorization.", "url": "https://github.com/CESNET/perun/pull/3028#discussion_r539150395", "createdAt": "2020-12-09T09:35:37Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/MembersManagerEntry.java", "diffHunk": "@@ -1434,20 +1434,25 @@ public RichMember sponsorMember(PerunSession session, Member sponsored, User spo\n \n \t@Override\n \tpublic List<RichMember> getSponsoredMembers(PerunSession sess, Vo vo) throws PrivilegeException, VoNotExistsException {\n+\t\t//Filter members based on authorization", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78588de21e14e49f198710d0a90253a12c23db01"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE1MTQ5OQ==", "bodyText": "The variable name filteredMembers doesn't make much sense anymore, since this method doesn't filter anything.", "url": "https://github.com/CESNET/perun/pull/3028#discussion_r539151499", "createdAt": "2020-12-09T09:37:08Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/MembersManagerEntry.java", "diffHunk": "@@ -1434,20 +1434,25 @@ public RichMember sponsorMember(PerunSession session, Member sponsored, User spo\n \n \t@Override\n \tpublic List<RichMember> getSponsoredMembers(PerunSession sess, Vo vo) throws PrivilegeException, VoNotExistsException {\n+\t\t//Filter members based on authorization\n+\t\treturn getAllSponsoredMembers(sess, vo).stream()\n+\t\t\t.filter(member -> AuthzResolver.authorizedInternal(sess, \"filter-getSponsoredMembers_Vo_policy\", member, vo))\n+\t\t\t.collect(Collectors.toList());\n+\t}\n+\n+\t@Override\n+\tpublic List<RichMember> getAllSponsoredMembers(PerunSession sess, Vo vo) throws PrivilegeException, VoNotExistsException {\n \t\tUtils.checkPerunSession(sess);\n \t\tUtils.notNull(vo, \"vo\");\n \n \t\tperunBl.getVosManagerBl().checkVoExists(sess, vo);\n \n \t\t//Authorization\n-\t\tif(!AuthzResolver.authorizedInternal(sess, \"getSponsoredMembers_Vo_policy\", vo)) {\n-\t\t\tthrow new PrivilegeException(sess, \"getSponsoredMembers\");\n+\t\tif(!AuthzResolver.authorizedInternal(sess, \"getAllSponsoredMembers_Vo_policy\", vo)) {\n+\t\t\tthrow new PrivilegeException(sess, \"getAllSponsoredMembers\");\n \t\t}\n \n-\t\t//Filter members based on authorization\n-\t\tList<Member> filteredMembers = membersManagerBl.getSponsoredMembers(sess, vo).stream()\n-\t\t\t.filter(member -> AuthzResolver.authorizedInternal(sess, \"filter-getSponsoredMembers_Vo_policy\", member, vo))\n-\t\t\t.collect(Collectors.toList());\n+\t\tList<Member> filteredMembers = membersManagerBl.getSponsoredMembers(sess, vo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78588de21e14e49f198710d0a90253a12c23db01"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTA0MDA0", "url": "https://github.com/CESNET/perun/pull/3028#pullrequestreview-548104004", "createdAt": "2020-12-09T11:49:10Z", "commit": {"oid": "78588de21e14e49f198710d0a90253a12c23db01"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c9f9edbfb02a8185746db5588a83f80702432e8", "author": {"user": {"login": "metodej", "name": null}}, "url": "https://github.com/CESNET/perun/commit/4c9f9edbfb02a8185746db5588a83f80702432e8", "committedDate": "2020-12-11T16:22:16Z", "message": "Changes based on review\n\n- fixed authorization policy and variable name\n- added test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMTE5MzE3", "url": "https://github.com/CESNET/perun/pull/3028#pullrequestreview-551119317", "createdAt": "2020-12-14T08:03:13Z", "commit": {"oid": "4c9f9edbfb02a8185746db5588a83f80702432e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMTMyNjI3", "url": "https://github.com/CESNET/perun/pull/3028#pullrequestreview-551132627", "createdAt": "2020-12-14T08:23:36Z", "commit": {"oid": "4c9f9edbfb02a8185746db5588a83f80702432e8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwODoyMzozNlrOIFEw2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwODoyNjoxOFrOIFE3Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE5MTgzNA==", "bodyText": "This is probably an incorrect description.", "url": "https://github.com/CESNET/perun/pull/3028#discussion_r542191834", "createdAt": "2020-12-14T08:23:36Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/MembersManager.java", "diffHunk": "@@ -1351,6 +1351,16 @@\n \t */\n \tList<RichMember> getSponsoredMembers(PerunSession sess, Vo vo) throws PrivilegeException, VoNotExistsException;\n \n+\t/**\n+\t * Gets list of all sponsored members of a VO.\n+\t *\n+\t * @param sess actor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c9f9edbfb02a8185746db5588a83f80702432e8"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE5MjAwNQ==", "bodyText": "I think the policy check is still missing.", "url": "https://github.com/CESNET/perun/pull/3028#discussion_r542192005", "createdAt": "2020-12-14T08:23:53Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/MembersManagerEntry.java", "diffHunk": "@@ -1434,20 +1434,25 @@ public RichMember sponsorMember(PerunSession session, Member sponsored, User spo\n \n \t@Override\n \tpublic List<RichMember> getSponsoredMembers(PerunSession sess, Vo vo) throws PrivilegeException, VoNotExistsException {\n+\t\t//Filter members based on authorization", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE1MDM5NQ=="}, "originalCommit": {"oid": "78588de21e14e49f198710d0a90253a12c23db01"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE5MzQ1NA==", "bodyText": "This policy should be used in the method getSponsoredMembers. For this method, you should create a new one.", "url": "https://github.com/CESNET/perun/pull/3028#discussion_r542193454", "createdAt": "2020-12-14T08:26:18Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/MembersManagerEntry.java", "diffHunk": "@@ -1434,22 +1434,27 @@ public RichMember sponsorMember(PerunSession session, Member sponsored, User spo\n \n \t@Override\n \tpublic List<RichMember> getSponsoredMembers(PerunSession sess, Vo vo) throws PrivilegeException, VoNotExistsException {\n+\t\t//Filter members based on authorization\n+\t\treturn getAllSponsoredMembers(sess, vo).stream()\n+\t\t\t.filter(member -> AuthzResolver.authorizedInternal(sess, \"filter-getSponsoredMembers_Vo_policy\", member, vo))\n+\t\t\t.collect(Collectors.toList());\n+\t}\n+\n+\t@Override\n+\tpublic List<RichMember> getAllSponsoredMembers(PerunSession sess, Vo vo) throws PrivilegeException, VoNotExistsException {\n \t\tUtils.checkPerunSession(sess);\n \t\tUtils.notNull(vo, \"vo\");\n \n \t\tperunBl.getVosManagerBl().checkVoExists(sess, vo);\n \n \t\t//Authorization\n \t\tif(!AuthzResolver.authorizedInternal(sess, \"getSponsoredMembers_Vo_policy\", vo)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c9f9edbfb02a8185746db5588a83f80702432e8"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "709d836f913ac9da3196b2b843ec9761bb5811f2", "author": {"user": {"login": "metodej", "name": null}}, "url": "https://github.com/CESNET/perun/commit/709d836f913ac9da3196b2b843ec9761bb5811f2", "committedDate": "2020-12-14T08:46:11Z", "message": "Changes based on review\n\n- fixed authorization policy\n- fixed incorrect javadoc description"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMjgzMDYx", "url": "https://github.com/CESNET/perun/pull/3028#pullrequestreview-551283061", "createdAt": "2020-12-14T11:32:37Z", "commit": {"oid": "709d836f913ac9da3196b2b843ec9761bb5811f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1740, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}