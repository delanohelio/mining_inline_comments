{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MTEyNzg1", "number": 2616, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoxMToxMFrODoWS4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwOTozNDo1N1rOD3G--g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjM0OTE1OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDoxMToxMFrOF212KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDowODo1OFrOF5N0qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0OTY0MA==", "bodyText": "There should be \"removeMember\".", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r393049640", "createdAt": "2020-03-16T14:11:10Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -454,6 +441,14 @@ public void removeMember(PerunSession sess, Member member, List<Group> groups) t\n \t\t\t}\n \t\t}\n \t\tgetPerunBl().getMembersManagerBl().checkMemberExists(sess, member);\n+\n+\t\t// Authorization\n+\t\tList<PerunBean> beans = new ArrayList<>(groups);\n+\t\tbeans.add(member);\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"removeMember_Member_List<Group>_policy\", beans)) {\n+\t\t\tthrow new PrivilegeException(sess, \"addMember\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d076c5bdac313f2989d10b13ce60fd5508d5ef87"}, "originalPosition": 232}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUzOTYyNw==", "bodyText": "Fixed", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r395539627", "createdAt": "2020-03-20T10:08:58Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -454,6 +441,14 @@ public void removeMember(PerunSession sess, Member member, List<Group> groups) t\n \t\t\t}\n \t\t}\n \t\tgetPerunBl().getMembersManagerBl().checkMemberExists(sess, member);\n+\n+\t\t// Authorization\n+\t\tList<PerunBean> beans = new ArrayList<>(groups);\n+\t\tbeans.add(member);\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"removeMember_Member_List<Group>_policy\", beans)) {\n+\t\t\tthrow new PrivilegeException(sess, \"addMember\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0OTY0MA=="}, "originalCommit": {"oid": "d076c5bdac313f2989d10b13ce60fd5508d5ef87"}, "originalPosition": 232}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjUxNjg0OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDo0MjoyNFrOF23gKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDowOTowNVrOF5N04Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA3Njc3Ng==", "bodyText": "There is something missing, right?", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r393076776", "createdAt": "2020-03-16T14:42:24Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -881,37 +823,16 @@ public void removeAdmin(PerunSession sess, Group group, Group authorizedGroup) t\n \n \t\tList<Group> groups = getGroupsManagerBl().getAllGroups(sess, vo);\n \n-\t\t// Return all groups for VOADMIN and PERUNADMIN\n-\t\tif (AuthzResolver.isAuthorized(sess, Role.VOADMIN, vo)\n-\t\t\t\t|| AuthzResolver.isAuthorized(sess, Role.VOOBSERVER, vo)\n-\t\t\t\t|| AuthzResolver.hasRole(sess.getPerunPrincipal(), Role.PERUNADMIN)) {\n-\t\t\treturn groups;\n-\t\t\t\t}\n-\n-\t\t// Check access rights for each group for GROUPADMIN\n-\t\tif (AuthzResolver.hasRole(sess.getPerunPrincipal(), Role.GROUPADMIN)) {\n-\t\t\tIterator<Group> eachGroup = groups.iterator();\n-\t\t\twhile (eachGroup.hasNext()) {\n-\t\t\t\tif (!AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, eachGroup.next())) {\n-\t\t\t\t\teachGroup.remove();\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\treturn groups;\n-\t\t}\n-\n-\t\t// This shouldn't happen\n-\t\tthrow new PrivilegeException(sess, \"getAllGroups\");\n+\t\tgroups.removeIf(group -> !AuthzResolver.authorizedInternal(sess, \"filter-getAllGroups_Vo_policy\", Collections.singletonList(group)));\n+\t\treturn groups;\n \t}\n \n \t@Override\n \tpublic Map<Group, Object> getAllGroupsWithHierarchy(PerunSession sess, Vo vo) throws InternalErrorException, PrivilegeException, VoNotExistsException {\n \t\tUtils.checkPerunSession(sess);\n \n \t\t// Authorization\n-\t\tif (!AuthzResolver.isAuthorized(sess, Role.VOADMIN, vo) &&\n-\t\t\t\t!AuthzResolver.isAuthorized(sess, Role.VOOBSERVER, vo) &&\n-\t\t\t\t!AuthzResolver.isAuthorized(sess, Role.GROUPADMIN) &&\n-\t\t\t\t!AuthzResolver.isAuthorized(sess, Role.PERUNOBSERVER)) {\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"\", Collections.singletonList(vo))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d076c5bdac313f2989d10b13ce60fd5508d5ef87"}, "originalPosition": 508}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUzOTY4MQ==", "bodyText": "Fixed", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r395539681", "createdAt": "2020-03-20T10:09:05Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -881,37 +823,16 @@ public void removeAdmin(PerunSession sess, Group group, Group authorizedGroup) t\n \n \t\tList<Group> groups = getGroupsManagerBl().getAllGroups(sess, vo);\n \n-\t\t// Return all groups for VOADMIN and PERUNADMIN\n-\t\tif (AuthzResolver.isAuthorized(sess, Role.VOADMIN, vo)\n-\t\t\t\t|| AuthzResolver.isAuthorized(sess, Role.VOOBSERVER, vo)\n-\t\t\t\t|| AuthzResolver.hasRole(sess.getPerunPrincipal(), Role.PERUNADMIN)) {\n-\t\t\treturn groups;\n-\t\t\t\t}\n-\n-\t\t// Check access rights for each group for GROUPADMIN\n-\t\tif (AuthzResolver.hasRole(sess.getPerunPrincipal(), Role.GROUPADMIN)) {\n-\t\t\tIterator<Group> eachGroup = groups.iterator();\n-\t\t\twhile (eachGroup.hasNext()) {\n-\t\t\t\tif (!AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, eachGroup.next())) {\n-\t\t\t\t\teachGroup.remove();\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\treturn groups;\n-\t\t}\n-\n-\t\t// This shouldn't happen\n-\t\tthrow new PrivilegeException(sess, \"getAllGroups\");\n+\t\tgroups.removeIf(group -> !AuthzResolver.authorizedInternal(sess, \"filter-getAllGroups_Vo_policy\", Collections.singletonList(group)));\n+\t\treturn groups;\n \t}\n \n \t@Override\n \tpublic Map<Group, Object> getAllGroupsWithHierarchy(PerunSession sess, Vo vo) throws InternalErrorException, PrivilegeException, VoNotExistsException {\n \t\tUtils.checkPerunSession(sess);\n \n \t\t// Authorization\n-\t\tif (!AuthzResolver.isAuthorized(sess, Role.VOADMIN, vo) &&\n-\t\t\t\t!AuthzResolver.isAuthorized(sess, Role.VOOBSERVER, vo) &&\n-\t\t\t\t!AuthzResolver.isAuthorized(sess, Role.GROUPADMIN) &&\n-\t\t\t\t!AuthzResolver.isAuthorized(sess, Role.PERUNOBSERVER)) {\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"\", Collections.singletonList(vo))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA3Njc3Ng=="}, "originalCommit": {"oid": "d076c5bdac313f2989d10b13ce60fd5508d5ef87"}, "originalPosition": 508}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjU3MDk2OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDo1NDoyNFrOF24CCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDowOToxNFrOF5N1Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4NTQ0OQ==", "bodyText": "Missing policy name.", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r393085449", "createdAt": "2020-03-16T14:54:24Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -1390,27 +1205,13 @@ public void synchronizeGroupsStructures(PerunSession sess) throws InternalErrorE\n \t\tVo vo = getPerunBl().getMembersManagerBl().getMemberVo(sess, member);\n \n \t\t// Authorization\n-\t\tif (!AuthzResolver.isAuthorized(sess, Role.VOADMIN, vo)\n-\t\t\t&& !AuthzResolver.isAuthorized(sess, Role.VOOBSERVER, vo)\n-\t\t\t&& !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, vo)\n-\t\t\t&& !AuthzResolver.isAuthorized(sess, Role.PERUNOBSERVER)) {\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"\", Collections.singletonList(member))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d076c5bdac313f2989d10b13ce60fd5508d5ef87"}, "originalPosition": 856}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUzOTc1OQ==", "bodyText": "Fixed", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r395539759", "createdAt": "2020-03-20T10:09:14Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -1390,27 +1205,13 @@ public void synchronizeGroupsStructures(PerunSession sess) throws InternalErrorE\n \t\tVo vo = getPerunBl().getMembersManagerBl().getMemberVo(sess, member);\n \n \t\t// Authorization\n-\t\tif (!AuthzResolver.isAuthorized(sess, Role.VOADMIN, vo)\n-\t\t\t&& !AuthzResolver.isAuthorized(sess, Role.VOOBSERVER, vo)\n-\t\t\t&& !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, vo)\n-\t\t\t&& !AuthzResolver.isAuthorized(sess, Role.PERUNOBSERVER)) {\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"\", Collections.singletonList(member))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4NTQ0OQ=="}, "originalCommit": {"oid": "d076c5bdac313f2989d10b13ce60fd5508d5ef87"}, "originalPosition": 856}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MTEyNTY2OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwOTozNDozOFrOGNLaDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMTozMjoxMlrOGwkomg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3MTU2Nw==", "bodyText": "It should be possible to merge these two calls into a single one.", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r416471567", "createdAt": "2020-04-28T09:34:38Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -1535,8 +1283,8 @@ public Group createGroupUnion(PerunSession sess, Group resultGroup, Group operan\n \t\t}\n \n \t\t// Authorization\n-\t\tif ((!AuthzResolver.isAuthorized(sess, Role.VOADMIN, resultGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, resultGroup)) ||\n-\t\t\t\t(!AuthzResolver.isAuthorized(sess, Role.VOADMIN, operandGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, operandGroup))) {\n+\t\tif ((!AuthzResolver.authorizedInternal(sess, \"createGroupUnion_Group_Group_policy\", Collections.singletonList(resultGroup))) ||\n+\t\t\t\t(!AuthzResolver.authorizedInternal(sess, \"createGroupUnion_Group_Group_policy\", Collections.singletonList(operandGroup)))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14a00280e42c73be1109dffd8ef59fe2dd44daf7"}, "originalPosition": 1062}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NTA1MA==", "bodyText": "Done", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r453585050", "createdAt": "2020-07-13T11:32:12Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -1535,8 +1283,8 @@ public Group createGroupUnion(PerunSession sess, Group resultGroup, Group operan\n \t\t}\n \n \t\t// Authorization\n-\t\tif ((!AuthzResolver.isAuthorized(sess, Role.VOADMIN, resultGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, resultGroup)) ||\n-\t\t\t\t(!AuthzResolver.isAuthorized(sess, Role.VOADMIN, operandGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, operandGroup))) {\n+\t\tif ((!AuthzResolver.authorizedInternal(sess, \"createGroupUnion_Group_Group_policy\", Collections.singletonList(resultGroup))) ||\n+\t\t\t\t(!AuthzResolver.authorizedInternal(sess, \"createGroupUnion_Group_Group_policy\", Collections.singletonList(operandGroup)))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3MTU2Nw=="}, "originalCommit": {"oid": "14a00280e42c73be1109dffd8ef59fe2dd44daf7"}, "originalPosition": 1062}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MTEyNjk4OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwOTozNDo1N1rOGNLayQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMTozMjoyMFrOGwko1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3MTc1Mw==", "bodyText": "Same here.", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r416471753", "createdAt": "2020-04-28T09:34:57Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -1554,8 +1302,8 @@ public void removeGroupUnion(PerunSession sess, Group resultGroup, Group operand\n \t\t}\n \n \t\t// Authorization\n-\t\tif ( (!AuthzResolver.isAuthorized(sess, Role.VOADMIN, resultGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, resultGroup)) ||\n-\t\t\t\t(!AuthzResolver.isAuthorized(sess, Role.VOADMIN, operandGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, operandGroup)) ) {\n+\t\tif ( (!AuthzResolver.authorizedInternal(sess, \"removeGroupUnion_Group_Group_policy\", Collections.singletonList(resultGroup))) ||\n+\t\t\t(!AuthzResolver.authorizedInternal(sess, \"removeGroupUnion_Group_Group_policy\", Collections.singletonList(operandGroup)))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14a00280e42c73be1109dffd8ef59fe2dd44daf7"}, "originalPosition": 1073}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NTExMQ==", "bodyText": "Done", "url": "https://github.com/CESNET/perun/pull/2616#discussion_r453585111", "createdAt": "2020-07-13T11:32:20Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -1554,8 +1302,8 @@ public void removeGroupUnion(PerunSession sess, Group resultGroup, Group operand\n \t\t}\n \n \t\t// Authorization\n-\t\tif ( (!AuthzResolver.isAuthorized(sess, Role.VOADMIN, resultGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, resultGroup)) ||\n-\t\t\t\t(!AuthzResolver.isAuthorized(sess, Role.VOADMIN, operandGroup) && !AuthzResolver.isAuthorized(sess, Role.GROUPADMIN, operandGroup)) ) {\n+\t\tif ( (!AuthzResolver.authorizedInternal(sess, \"removeGroupUnion_Group_Group_policy\", Collections.singletonList(resultGroup))) ||\n+\t\t\t(!AuthzResolver.authorizedInternal(sess, \"removeGroupUnion_Group_Group_policy\", Collections.singletonList(operandGroup)))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3MTc1Mw=="}, "originalCommit": {"oid": "14a00280e42c73be1109dffd8ef59fe2dd44daf7"}, "originalPosition": 1073}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2141, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}