{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MzE2OTcx", "number": 2816, "title": "Roles - default politics file", "bodyText": "With the old implementation, it was difficult to release new versions\nof perun with new policits. All configurations would have to be changed\nand there was a lot of places to do a manual error. Even right now, we\ndon't plan to have different politics on different instances.\nCreated a default politics cofiguration file\nperun-base/src/main/resources/perun-roles.yml which is packed into the\nwar archive and will be used in production and even in tests.\nCreated a test configuration file test-roles.yml which contains\npolitics specially created for tests.\nChanged behaviour of loading of the politics. On production, the\ndefault politics configuration is used and also, the configuration file\nat /etc/perun/perun-roles.yml can be used to override some politics.\nThis file is ignored during tests.", "createdAt": "2020-07-24T14:25:16Z", "url": "https://github.com/CESNET/perun/pull/2816", "merged": true, "mergeCommit": {"oid": "902cd51ad894900bfa078b0f7eeff904b5b4dfb4"}, "closed": true, "closedAt": "2020-07-27T12:39:17Z", "author": {"login": "Vojtech-Sassmann"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4FjvIABqjM1ODQzNjMwNTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5BGwZgFqTQ1NTczOTA1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dff994f84905e5b29abb6155ac5c6e8f83318df6", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/dff994f84905e5b29abb6155ac5c6e8f83318df6", "committedDate": "2020-07-24T14:24:43Z", "message": "Roles - default politics file\n\n* With the old implementation, it was difficult to release new versions\nof perun with new policits. All configurations would have to be changed\nand there was a lot of places to do a manual error. Even right now, we\ndon't plan to have different politics on different instances.\n* Created a default politics cofiguration file\n`perun-base/src/main/resources/perun-roles.yml` which is packed into the\nwar archive and will be used in production and even in tests.\n* Created a test configuration file `test-roles.yml` which contains\npolitics specially created for tests.\n* Changed behaviour of loading of the politics. On production, the\ndefault politics configuration is used and also, the configuration file\nat `/etc/perun/perun-roles.yml` can be used to override some politics.\nThis file is ignored during tests."}, "afterCommit": {"oid": "acad23ccf27e5d8296ac535e770680174916c21e", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/acad23ccf27e5d8296ac535e770680174916c21e", "committedDate": "2020-07-24T15:14:10Z", "message": "Roles - default politics file\n\n* With the old implementation, it was difficult to release new versions\nof perun with new policits. All configurations would have to be changed\nand there was a lot of places to do a manual error. Even right now, we\ndon't plan to have different politics on different instances.\n* Created a default politics cofiguration file\n`perun-base/src/main/resources/perun-roles.yml` which is packed into the\nwar archive and will be used in production and even in tests.\n* Created a test configuration file `test-roles.yml` which contains\npolitics specially created for tests.\n* Changed behaviour of loading of the politics. On production, the\ndefault politics configuration is used and also, the configuration file\nat `/etc/perun/perun-roles.yml` can be used to override some politics.\nThis file is ignored during tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0OTQzNTU0", "url": "https://github.com/CESNET/perun/pull/2816#pullrequestreview-454943554", "createdAt": "2020-07-24T14:41:18Z", "commit": {"oid": "dff994f84905e5b29abb6155ac5c6e8f83318df6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDo0MToxOVrOG2yCSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDo0MToxOVrOG2yCSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5NjA3Mg==", "bodyText": "Typo", "url": "https://github.com/CESNET/perun/pull/2816#discussion_r460096072", "createdAt": "2020-07-24T14:41:19Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/PerunRolesLoader.java", "diffHunk": "@@ -116,36 +107,52 @@ public void loadPerunRoles(JdbcPerunTemplate jdbc) {\n \t\tMap<String, RoleManagementRules> rolesManagementRules = new HashMap<>();\n \n \t\ttry {\n-\t\t\tJsonNode rootNode = loadConfigurationFile();\n-\t\t\t//Fetch all policies from the configuration file\n-\t\t\tJsonNode rolesNodes = rootNode.get(\"perun_roles_management\");\n-\n-\t\t\t// For each role node construct RoleManagementRules and add it to the map\n-\t\t\tIterator<String> roleNames = rolesNodes.fieldNames();\n-\t\t\twhile (roleNames.hasNext()) {\n-\t\t\t\tString roleName = roleNames.next();\n-\t\t\t\tJsonNode roleNode = rolesNodes.get(roleName);\n-\t\t\t\tList<Map<String, String>> privilegedRoles = new ArrayList<>();\n-\t\t\t\tJsonNode privilegedRolesNode = roleNode.get(\"privileged_roles\");\n-\n-\t\t\t\t//Field privileged_roles is saved as List of maps in the for loop\n-\t\t\t\tfor (JsonNode privilegedRoleNode : privilegedRolesNode) {\n-\t\t\t\t\tMap<String, String> innerRoleMap = createmapFromJsonNode(privilegedRoleNode);\n-\t\t\t\t\tprivilegedRoles.add(innerRoleMap);\n-\t\t\t\t}\n-\n-\t\t\t\tMap<String, String> entitiesToManage = createmapFromJsonNode(roleNode.get(\"entities_to_manage\"));\n-\t\t\t\tMap<String, String> objectsToAssign = createmapFromJsonNode(roleNode.get(\"assign_to_objects\"));\n-\n-\t\t\t\trolesManagementRules.put(roleName, new RoleManagementRules(roleName, privilegedRoles, entitiesToManage, objectsToAssign));\n+\t\t\tJsonNode rootNode = loadConfigurationFile(configurationPath);\n+\t\t\tloadPerunRolesManagementGromJsonNode(rootNode)\n+\t\t\t\t\t.forEach(rule -> rolesManagementRules.put(rule.getRoleName(), rule));\n+\n+\t\t\tif (secondaryConfigurationPath != null) {\n+\t\t\t\trootNode = loadConfigurationFile(secondaryConfigurationPath);\n+\t\t\t\tloadPerunRolesManagementGromJsonNode(rootNode)\n+\t\t\t\t\t\t.forEach(rule -> rolesManagementRules.put(rule.getRoleName(), rule));\n \t\t\t}\n \t\t} catch(RuntimeException e) {\n-\t\t\tthrow new InternalErrorException(\"The configuration file \" + configurationPath.getFilename() + \" has invalid syntax.\", e);\n+\t\t\tthrow new InternalErrorException(\"One of the roles configuration file has invalid syntax. Configuration files: \" +\n+\t\t\t\t\tconfigurationPath.getFilename() +\n+\t\t\t\t\t(secondaryConfigurationPath == null ? \"not defined\" : secondaryConfigurationPath.getFilename()), e);\n \t\t}\n \n \t\treturn rolesManagementRules;\n \t}\n \n+\tprivate Set<RoleManagementRules> loadPerunRolesManagementGromJsonNode(JsonNode rootNode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dff994f84905e5b29abb6155ac5c6e8f83318df6"}, "originalPosition": 151}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NDkwMTg2", "url": "https://github.com/CESNET/perun/pull/2816#pullrequestreview-455490186", "createdAt": "2020-07-27T05:58:38Z", "commit": {"oid": "acad23ccf27e5d8296ac535e770680174916c21e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNTo1ODozOFrOG3Umgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNTo1ODozOFrOG3Umgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY2MjQwMg==", "bodyText": "Shouldn't we first load normal configuration and then overwrite it with secondary config (as we do in loadPerunRolesManagement())?", "url": "https://github.com/CESNET/perun/pull/2816#discussion_r460662402", "createdAt": "2020-07-27T05:58:38Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/PerunRolesLoader.java", "diffHunk": "@@ -71,36 +77,22 @@ public void loadPerunRoles(JdbcPerunTemplate jdbc) {\n \t *\n \t * @return list of PerunPolicies\n \t */\n-\tpublic List<PerunPolicy> loadPerunPolicies() {\n-\t\tList<PerunPolicy> policies = new ArrayList<>();\n+\tpublic Set<PerunPolicy> loadPerunPolicies() {\n+\t\tSet<PerunPolicy> policies = new HashSet<>();\n \n \t\ttry {\n-\t\t\tJsonNode rootNode = loadConfigurationFile();\n-\t\t\t//Fetch all policies from the configuration file\n-\t\t\tJsonNode policiesNode = rootNode.get(\"perun_policies\");\n-\n-\t\t\t// For each policy node construct PerunPolicy and add it to the list\n-\t\t\tIterator<String> policyNames = policiesNode.fieldNames();\n-\t\t\twhile(policyNames.hasNext()) {\n-\t\t\t\tString policyName = policyNames.next();\n-\t\t\t\tJsonNode policyNode = policiesNode.get(policyName);\n-\t\t\t\tList<Map<String, String>> perunRoles = new ArrayList<>();\n-\t\t\t\tJsonNode perunRolesNode = policyNode.get(\"policy_roles\");\n-\n-\t\t\t\t//Field policy_roles is saved as List of maps in the for loop\n-\t\t\t\tfor (JsonNode perunRoleNode : perunRolesNode) {\n-\t\t\t\t\tMap<String, String> innerRoleMap = createmapFromJsonNode(perunRoleNode);\n-\t\t\t\t\tperunRoles.add(innerRoleMap);\n-\t\t\t\t}\n-\n-\t\t\t\t//Field include_policies is saved as List of Strings.\n-\t\t\t\tList<String> includePolicies = new ArrayList<>(objectMapper.convertValue(policyNode.get(\"include_policies\"), new TypeReference<List<String>>() {\n-\t\t\t\t}));\n-\n-\t\t\t\tpolicies.add(new PerunPolicy(policyName, perunRoles, includePolicies));\n+\t\t\tJsonNode rootNode;\n+\t\t\tif (secondaryConfigurationPath != null) {\n+\t\t\t\trootNode = loadConfigurationFile(secondaryConfigurationPath);\n+\t\t\t\tpolicies.addAll(loadPoliciesFromJsonNode(rootNode));\n \t\t\t}\n+\t\t\trootNode = loadConfigurationFile(configurationPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acad23ccf27e5d8296ac535e770680174916c21e"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NTMzNDc5", "url": "https://github.com/CESNET/perun/pull/2816#pullrequestreview-455533479", "createdAt": "2020-07-27T07:29:42Z", "commit": {"oid": "acad23ccf27e5d8296ac535e770680174916c21e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "162b66945b318d14cfcf15834dc9a51bfaddb8a1", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/162b66945b318d14cfcf15834dc9a51bfaddb8a1", "committedDate": "2020-07-27T09:38:42Z", "message": "Roles - default politics file\n\n* With the old implementation, it was difficult to release new versions\nof perun with new policits. All configurations would have to be changed\nand there was a lot of places to do a manual error. Even right now, we\ndon't plan to have different politics on different instances.\n* Created a default politics cofiguration file\n`perun-base/src/main/resources/perun-roles.yml` which is packed into the\nwar archive and will be used in production and even in tests.\n* Created a test configuration file `test-roles.yml` which contains\npolitics specially created for tests.\n* Changed behaviour of loading of the politics. On production, the\ndefault politics configuration is used and also, the configuration file\nat `/etc/perun/perun-roles.yml` can be used to override some politics.\nThis file is ignored during tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acad23ccf27e5d8296ac535e770680174916c21e", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/acad23ccf27e5d8296ac535e770680174916c21e", "committedDate": "2020-07-24T15:14:10Z", "message": "Roles - default politics file\n\n* With the old implementation, it was difficult to release new versions\nof perun with new policits. All configurations would have to be changed\nand there was a lot of places to do a manual error. Even right now, we\ndon't plan to have different politics on different instances.\n* Created a default politics cofiguration file\n`perun-base/src/main/resources/perun-roles.yml` which is packed into the\nwar archive and will be used in production and even in tests.\n* Created a test configuration file `test-roles.yml` which contains\npolitics specially created for tests.\n* Changed behaviour of loading of the politics. On production, the\ndefault politics configuration is used and also, the configuration file\nat `/etc/perun/perun-roles.yml` can be used to override some politics.\nThis file is ignored during tests."}, "afterCommit": {"oid": "162b66945b318d14cfcf15834dc9a51bfaddb8a1", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/162b66945b318d14cfcf15834dc9a51bfaddb8a1", "committedDate": "2020-07-27T09:38:42Z", "message": "Roles - default politics file\n\n* With the old implementation, it was difficult to release new versions\nof perun with new policits. All configurations would have to be changed\nand there was a lot of places to do a manual error. Even right now, we\ndon't plan to have different politics on different instances.\n* Created a default politics cofiguration file\n`perun-base/src/main/resources/perun-roles.yml` which is packed into the\nwar archive and will be used in production and even in tests.\n* Created a test configuration file `test-roles.yml` which contains\npolitics specially created for tests.\n* Changed behaviour of loading of the politics. On production, the\ndefault politics configuration is used and also, the configuration file\nat `/etc/perun/perun-roles.yml` can be used to override some politics.\nThis file is ignored during tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NzM5MDUx", "url": "https://github.com/CESNET/perun/pull/2816#pullrequestreview-455739051", "createdAt": "2020-07-27T12:37:03Z", "commit": {"oid": "162b66945b318d14cfcf15834dc9a51bfaddb8a1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1285, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}