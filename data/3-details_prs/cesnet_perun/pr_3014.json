{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5Nzk4NDkz", "number": 3014, "title": "REGISTRAR: Support editing submitted form by user", "bodyText": "Added updateFormItemsData() which will update form items\ndata with new values by its IDs. Only application submitter\ncan use this.\nUpdating form items sets application state to NEW\nand starts verification and auto-approval if possible.\nMethod updateFormItemData() used from old GUI is now\nmarked as deprecated.", "createdAt": "2020-11-30T20:40:04Z", "url": "https://github.com/CESNET/perun/pull/3014", "merged": true, "mergeCommit": {"oid": "6540f44e647f90f6fd9c774665d90c3854f411bd"}, "closed": true, "closedAt": "2020-12-01T15:14:15Z", "author": {"login": "zlamalp"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhrgd5gH2gAyNTI5Nzk4NDkzOmFmYTM0YWYxYzQ0MzJhMGQ5YmE0ZjRjZTc2YmNjNGIzZGU4ZTM4ZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh5N9FAFqTU0MTg1MjgxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "afa34af1c4432a0d9ba4f4ce76bcc4b3de8e38f1", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/afa34af1c4432a0d9ba4f4ce76bcc4b3de8e38f1", "committedDate": "2020-11-30T20:38:07Z", "message": "REGISTRAR: Support editing submitted form by user\n\n- Added updateFormItemsData() which will update form items\n  data with new values by its IDs. Only application submitter\n  can use this.\n- Updating form items sets application state to NEW\n  and starts verification and auto-approval if possible.\n- Method updateFormItemData() used from old GUI is now\n  marked as deprecated."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e2f76f2cfb93003948449af020ea3a56462639b", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/7e2f76f2cfb93003948449af020ea3a56462639b", "committedDate": "2020-12-01T07:56:58Z", "message": "Added OpenAPI specification for updateFormItemsData()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNzQxNTMz", "url": "https://github.com/CESNET/perun/pull/3014#pullrequestreview-541741533", "createdAt": "2020-12-01T10:07:23Z", "commit": {"oid": "7e2f76f2cfb93003948449af020ea3a56462639b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDowNzoyM1rOH8kBgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDowNzoyM1rOH8kBgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI2NjgxNw==", "bodyText": "Just a reminder that by calling only selfAuthorizedForApplication, PERUNADMIN will not be allowed to call this method. I suppose it is ok if the whole method will be used only for perun-wui, but it could be insufficient when for example NGUI would want to use it.", "url": "https://github.com/CESNET/perun/pull/3014#discussion_r533266817", "createdAt": "2020-12-01T10:07:23Z", "author": {"login": "balcirakpeter"}, "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -2552,16 +2552,71 @@ public void updateFormItemData(PerunSession sess, int appId, ApplicationFormItem\n \n \t\tif (notAllowed.contains(existingData.getFormItem().getType())) throw new RegistrarException(\"You are not allowed to modify \"+existingData.getFormItem().getType()+\" type of form items.\");\n \n+\t\tupdateFormItemData(sess, data);\n+\n+\t}\n+\n+\t@Transactional(rollbackFor = Exception.class)\n+\tpublic void updateFormItemsData(PerunSession sess, int appId, List<ApplicationFormItemData> data) throws PerunException {\n+\n+\t\tApplication app = getApplicationById(appId);\n+\n+\t\tif (app == null) throw new InternalErrorException(\"Application with ID=\"+appId+\" doesn't exist.\");\n+\n+\t\tif (!AuthzResolver.selfAuthorizedForApplication(sess, app)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e2f76f2cfb93003948449af020ea3a56462639b"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNzUyODUx", "url": "https://github.com/CESNET/perun/pull/3014#pullrequestreview-541752851", "createdAt": "2020-12-01T10:21:27Z", "commit": {"oid": "7e2f76f2cfb93003948449af020ea3a56462639b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDoyMToyN1rOH8lCPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDoyMToyN1rOH8lCPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI4MzM4OQ==", "bodyText": "I think you should check here that all of the given data is for the given application. This would allow some users to change someone else's data.", "url": "https://github.com/CESNET/perun/pull/3014#discussion_r533283389", "createdAt": "2020-12-01T10:21:27Z", "author": {"login": "Vojtech-Sassmann"}, "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -2552,16 +2552,71 @@ public void updateFormItemData(PerunSession sess, int appId, ApplicationFormItem\n \n \t\tif (notAllowed.contains(existingData.getFormItem().getType())) throw new RegistrarException(\"You are not allowed to modify \"+existingData.getFormItem().getType()+\" type of form items.\");\n \n+\t\tupdateFormItemData(sess, data);\n+\n+\t}\n+\n+\t@Transactional(rollbackFor = Exception.class)\n+\tpublic void updateFormItemsData(PerunSession sess, int appId, List<ApplicationFormItemData> data) throws PerunException {\n+\n+\t\tApplication app = getApplicationById(appId);\n+\n+\t\tif (app == null) throw new InternalErrorException(\"Application with ID=\"+appId+\" doesn't exist.\");\n+\n+\t\tif (!AuthzResolver.selfAuthorizedForApplication(sess, app)) {\n+\t\t\tthrow new PrivilegeException(sess, \"updateFormItemsData\");\n+\t\t}\n+\n+\t\tif (AppState.APPROVED.equals(app.getState()) || AppState.REJECTED.equals(app.getState())) throw new RegistrarException(\"Form items of once approved or rejected applications can't be modified.\");\n+\n+\t\t// no data to change\n+\t\tif (data == null || data.isEmpty()) return;\n+\n+\t\tfor (ApplicationFormItemData dataItem : data) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e2f76f2cfb93003948449af020ea3a56462639b"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68a80cc7e048c91d2da2748a485d62a260b4e818", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/68a80cc7e048c91d2da2748a485d62a260b4e818", "committedDate": "2020-12-01T12:17:42Z", "message": "Check that form item belong to the application\n\n- User could send faked form items data and update\n  items of others. Now we check, that item belongs\n  to the application, upon which we perform authorization."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxODUyODEx", "url": "https://github.com/CESNET/perun/pull/3014#pullrequestreview-541852811", "createdAt": "2020-12-01T12:36:34Z", "commit": {"oid": "68a80cc7e048c91d2da2748a485d62a260b4e818"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1718, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}