{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4NjQ2MjU4", "number": 2621, "title": "New authorization in FacilitiesManagerEntry", "bodyText": "In FacilitiesManagerEntry was completely replaced the old authorization.\nFor that purpose was updated also perun-roles.yml file with the\npolicies used in the FacilitiesManagerEntry.\nAll PerunBeans which are passed to the methods and already exist in\nPerun are passed also to the authorization, even when a policy does not\nneed them for now. It does not have any effect on the policy evaluation.\nIt erase the necessity to change these methods if the policy will change\nin the future.\nThe existence checks for entities were refactored, so they are called\nbefore authorization.", "createdAt": "2020-03-15T09:55:19Z", "url": "https://github.com/CESNET/perun/pull/2621", "merged": true, "mergeCommit": {"oid": "1b0e75daa55351201ba1377ed6bc6ffa4d8d7787"}, "closed": true, "closedAt": "2020-07-09T21:30:48Z", "author": {"login": "balcirakpeter"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOMKGhgFqTM3NDk5NTkxNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABczVxXmgBqjM1MzE0ODQ4MjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0OTk1OTE3", "url": "https://github.com/CESNET/perun/pull/2621#pullrequestreview-374995917", "createdAt": "2020-03-16T08:26:20Z", "commit": {"oid": "5ffdce0ab0a155513a0643984dc7d4494feb50b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwODoyNjoyMFrOF2prqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMToxMDozMFrOF2vWpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1MDM0Nw==", "bodyText": "Shouldn't be there a negation?", "url": "https://github.com/CESNET/perun/pull/2621#discussion_r392850347", "createdAt": "2020-03-16T08:26:20Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/FacilitiesManagerEntry.java", "diffHunk": "@@ -129,27 +125,14 @@ public Facility getFacilityByName(PerunSession sess, String name) throws Interna\n \tpublic List<RichFacility> getRichFacilities(PerunSession sess) throws InternalErrorException, PrivilegeException {\n \t\tUtils.checkPerunSession(sess);\n \n-\t\t// Perun admin can see everything\n-\t\tif (AuthzResolver.isAuthorized(sess, Role.PERUNADMIN) || AuthzResolver.isAuthorized(sess, Role.PERUNOBSERVER)) {\n-\t\t\treturn getFacilitiesManagerBl().getRichFacilities(sess);\n-\t\t} else if (AuthzResolver.isAuthorized(sess, Role.FACILITYADMIN)) {\n-\t\t\t/*\n-\t\t\t TODO: this optimization prevents loading facilities by ids, but its not optimal when we have thousands of facilities.\n-\t\t\t We should load facilities where user is manager directly from DB, but it would break contract, that authorization is taken only from session.\n-\t\t\t */\n-\t\t\tList<Facility> facilities = getFacilitiesManagerBl().getFacilities(sess);\n-\t\t\tfacilities.removeIf(facility -> {\n-\t\t\t\ttry {\n-\t\t\t\t\treturn !AuthzResolver.isAuthorized(sess, Role.FACILITYADMIN, facility);\n-\t\t\t\t} catch (InternalErrorException e) {\n-\t\t\t\t\t// if we can't determine authorization prevent returning it\n-\t\t\t\t\treturn true;\n-\t\t\t\t}\n-\t\t\t});\n-\t\t\treturn getFacilitiesManagerBl().getRichFacilities(sess, facilities);\n-\t\t} else {\n+\t\t// Authorization\n+\t\tif (!AuthzResolver.authorizedInternal(sess, \"getRichFacilities_policy\")) {\n \t\t\tthrow new PrivilegeException(sess, \"getRichFacilities\");\n \t\t}\n+\t\tList<Facility> facilities = getFacilitiesManagerBl().getFacilities(sess);\n+\t\tfacilities.removeIf(facility -> AuthzResolver.authorizedInternal(sess, \"filter-getRichFacilities_policy\", Collections.singletonList(facility)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ffdce0ab0a155513a0643984dc7d4494feb50b3"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1MjI1Mg==", "bodyText": "Shouldn't be this state switched with the rule 'getFacilitiesByDestination_String_policy'? I would expect object Facility here when filtering and without this object in first privilege testing rule of the method.", "url": "https://github.com/CESNET/perun/pull/2621#discussion_r392852252", "createdAt": "2020-03-16T08:30:21Z", "author": {"login": "stavamichal"}, "path": "perun-base/src/test/resources/perun-roles.yml", "diffHunk": "@@ -167,4 +167,555 @@ perun_policies:\n       - PERUNOBSERVER:\n     include_policies:\n       - test_resource_admin\n+\n+  #FacilitiesManagerEntry\n+  getFacilityById_int_policy:\n+    policy_roles:\n+      - RPC:\n+      - ENGINE:\n+      - FACILITYADMIN: Facility\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  getFacilityByName_String_policy:\n+    policy_roles:\n+      - RPC:\n+      - ENGINE:\n+      - FACILITYADMIN: Facility\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  getRichFacilities_policy:\n+    policy_roles:\n+      - FACILITYADMIN:\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  filter-getRichFacilities_policy:\n+    policy_roles:\n+      - FACILITYADMIN: Facility\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  getFacilitiesByDestination_String_policy:\n+    policy_roles:\n+      - RPC:\n+      - ENGINE:\n+      - FACILITYADMIN: Facility\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  filter-getFacilitiesByDestination_String_policy:\n+    policy_roles:\n+      - RPC:\n+      - ENGINE:\n+      - FACILITYADMIN:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ffdce0ab0a155513a0643984dc7d4494feb50b3"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1MzU1NQ==", "bodyText": "Should be there the object of Facility?", "url": "https://github.com/CESNET/perun/pull/2621#discussion_r392853555", "createdAt": "2020-03-16T08:33:12Z", "author": {"login": "stavamichal"}, "path": "perun-base/src/test/resources/perun-roles.yml", "diffHunk": "@@ -167,4 +167,555 @@ perun_policies:\n       - PERUNOBSERVER:\n     include_policies:\n       - test_resource_admin\n+\n+  #FacilitiesManagerEntry\n+  getFacilityById_int_policy:\n+    policy_roles:\n+      - RPC:\n+      - ENGINE:\n+      - FACILITYADMIN: Facility\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  getFacilityByName_String_policy:\n+    policy_roles:\n+      - RPC:\n+      - ENGINE:\n+      - FACILITYADMIN: Facility\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  getRichFacilities_policy:\n+    policy_roles:\n+      - FACILITYADMIN:\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  filter-getRichFacilities_policy:\n+    policy_roles:\n+      - FACILITYADMIN: Facility\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  getFacilitiesByDestination_String_policy:\n+    policy_roles:\n+      - RPC:\n+      - ENGINE:\n+      - FACILITYADMIN: Facility\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  filter-getFacilitiesByDestination_String_policy:\n+    policy_roles:\n+      - RPC:\n+      - ENGINE:\n+      - FACILITYADMIN:\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  getFacilitiesByAttribute_String_String_policy:\n+    policy_roles:\n+      - FACILITYADMIN:\n+      - PERUNOBSERVER:\n+    include_policies:\n+      - default_policy\n+\n+  getFacilities_policy:\n+    policy_roles:\n+      - ENGINE:\n+      - FACILITYADMIN: Facility", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ffdce0ab0a155513a0643984dc7d4494feb50b3"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkzMTA2MA==", "bodyText": "The name shoudl be 'host'.", "url": "https://github.com/CESNET/perun/pull/2621#discussion_r392931060", "createdAt": "2020-03-16T10:47:41Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/FacilitiesManagerEntry.java", "diffHunk": "@@ -1052,14 +939,14 @@ public PerunBl getPerunBl() {\n \tpublic Host addHost(PerunSession sess, Host host, Facility facility) throws InternalErrorException, FacilityNotExistsException, PrivilegeException {\n \t\tUtils.checkPerunSession(sess);\n \n+\t\tUtils.notNull(host, \"hosts\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ffdce0ab0a155513a0643984dc7d4494feb50b3"}, "originalPosition": 799}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0MzI2OQ==", "bodyText": "Missing definition of returned objects.", "url": "https://github.com/CESNET/perun/pull/2621#discussion_r392943269", "createdAt": "2020-03-16T11:10:30Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/FacilitiesManagerEntry.java", "diffHunk": "@@ -1606,4 +1439,32 @@ private void checkFacilityContactsEntitiesExist(PerunSession sess, List<ContactG\n \t\t\tthis.checkFacilityContactEntitiesExists(sess, contactGroup);\n \t\t}\n \t}\n+\n+\t/**\n+\t * Create a list of PerunBeans from facility, vo and service.\n+\t * If beans are not null it also checks if they exist. It will skip them otherwise.\n+\t *\n+\t * @param sess\n+\t * @param facility\n+\t * @param specificVo\n+\t * @param specificService\n+\t * @return", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ffdce0ab0a155513a0643984dc7d4494feb50b3"}, "originalPosition": 1218}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ffdce0ab0a155513a0643984dc7d4494feb50b3", "author": {"user": {"login": "balcirakpeter", "name": null}}, "url": "https://github.com/CESNET/perun/commit/5ffdce0ab0a155513a0643984dc7d4494feb50b3", "committedDate": "2020-03-15T09:54:08Z", "message": "New authorization in FacilitiesManagerEntry\n\n- In FacilitiesManagerEntry was completely replaced the old authorization.\n- For that purpose was updated also perun-roles.yml file with the\n  policies used in the FacilitiesManagerEntry.\n- All PerunBeans which are passed to the methods and already exist in\n  Perun are passed also to the authorization, even when a policy does not\n  need them for now. It does not have any effect on the policy evaluation.\n  It erase the necessity to change these methods if the policy will change\n  in the future.\n- The existence checks for entities were refactored, so they are called\n  before authorization."}, "afterCommit": {"oid": "7f21718b7c3ddeae99bf38cb2658cf42fa28c4ef", "author": {"user": {"login": "balcirakpeter", "name": null}}, "url": "https://github.com/CESNET/perun/commit/7f21718b7c3ddeae99bf38cb2658cf42fa28c4ef", "committedDate": "2020-03-17T14:47:10Z", "message": "New authorization in FacilitiesManagerEntry\n\n- In FacilitiesManagerEntry was completely replaced the old authorization.\n- For that purpose was updated also perun-roles.yml file with the\n  policies used in the FacilitiesManagerEntry.\n- All PerunBeans which are passed to the methods and already exist in\n  Perun are passed also to the authorization, even when a policy does not\n  need them for now. It does not have any effect on the policy evaluation.\n  It erase the necessity to change these methods if the policy will change\n  in the future.\n- The existence checks for entities were refactored, so they are called\n  before authorization."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NTgyMzE4", "url": "https://github.com/CESNET/perun/pull/2621#pullrequestreview-384582318", "createdAt": "2020-03-31T10:02:17Z", "commit": {"oid": "7f21718b7c3ddeae99bf38cb2658cf42fa28c4ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNzEwMDg3", "url": "https://github.com/CESNET/perun/pull/2621#pullrequestreview-401710087", "createdAt": "2020-04-28T10:38:27Z", "commit": {"oid": "7f21718b7c3ddeae99bf38cb2658cf42fa28c4ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dd3a663133cd57c0f058f9ccdd9d685ea4ab924", "author": {"user": {"login": "balcirakpeter", "name": null}}, "url": "https://github.com/CESNET/perun/commit/5dd3a663133cd57c0f058f9ccdd9d685ea4ab924", "committedDate": "2020-07-09T21:17:49Z", "message": "New authorization in FacilitiesManagerEntry\n\n- In FacilitiesManagerEntry was completely replaced the old authorization.\n- For that purpose was updated also perun-roles.yml file with the\n  policies used in the FacilitiesManagerEntry.\n- All PerunBeans which are passed to the methods and already exist in\n  Perun are passed also to the authorization, even when a policy does not\n  need them for now. It does not have any effect on the policy evaluation.\n  It erase the necessity to change these methods if the policy will change\n  in the future.\n- The existence checks for entities were refactored, so they are called\n  before authorization."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f21718b7c3ddeae99bf38cb2658cf42fa28c4ef", "author": {"user": {"login": "balcirakpeter", "name": null}}, "url": "https://github.com/CESNET/perun/commit/7f21718b7c3ddeae99bf38cb2658cf42fa28c4ef", "committedDate": "2020-03-17T14:47:10Z", "message": "New authorization in FacilitiesManagerEntry\n\n- In FacilitiesManagerEntry was completely replaced the old authorization.\n- For that purpose was updated also perun-roles.yml file with the\n  policies used in the FacilitiesManagerEntry.\n- All PerunBeans which are passed to the methods and already exist in\n  Perun are passed also to the authorization, even when a policy does not\n  need them for now. It does not have any effect on the policy evaluation.\n  It erase the necessity to change these methods if the policy will change\n  in the future.\n- The existence checks for entities were refactored, so they are called\n  before authorization."}, "afterCommit": {"oid": "5dd3a663133cd57c0f058f9ccdd9d685ea4ab924", "author": {"user": {"login": "balcirakpeter", "name": null}}, "url": "https://github.com/CESNET/perun/commit/5dd3a663133cd57c0f058f9ccdd9d685ea4ab924", "committedDate": "2020-07-09T21:17:49Z", "message": "New authorization in FacilitiesManagerEntry\n\n- In FacilitiesManagerEntry was completely replaced the old authorization.\n- For that purpose was updated also perun-roles.yml file with the\n  policies used in the FacilitiesManagerEntry.\n- All PerunBeans which are passed to the methods and already exist in\n  Perun are passed also to the authorization, even when a policy does not\n  need them for now. It does not have any effect on the policy evaluation.\n  It erase the necessity to change these methods if the policy will change\n  in the future.\n- The existence checks for entities were refactored, so they are called\n  before authorization."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1289, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}