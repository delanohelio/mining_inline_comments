{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzOTM1ODIx", "number": 2776, "title": "Group structure sync - resources", "bodyText": "Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\nCreated a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups.", "createdAt": "2020-07-03T08:48:47Z", "url": "https://github.com/CESNET/perun/pull/2776", "merged": true, "mergeCommit": {"oid": "cc63278e8784fc6da3dc24c728fcd37712b41e52"}, "closed": true, "closedAt": "2020-07-08T15:27:20Z", "author": {"login": "Vojtech-Sassmann"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxQdpVAFqTQ0MjI5OTQwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy4gQsgFqTQ0NDY0Mjc2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMjk5NDAz", "url": "https://github.com/CESNET/perun/pull/2776#pullrequestreview-442299403", "createdAt": "2020-07-03T09:59:03Z", "commit": {"oid": "05aa5a2eb37f02b4c17068c8c954224ed24f3eef"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwOTo1OTowM1rOGsrF5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwOTo1OTowM1rOGsrF5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ5NjU0OQ==", "bodyText": "I think you do not want to iterate over each login and then for each iteration call method syncResourceInStructure with all logins again.", "url": "https://github.com/CESNET/perun/pull/2776#discussion_r449496549", "createdAt": "2020-07-03T09:59:03Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -1734,11 +1737,140 @@ protected boolean hasCandidateExistingMember(Candidate candidate, RichMember ric\n \n \t\tsetUpSynchronizationAttributesForAllSubGroups(sess, baseGroup, source, loginAttributeDefinition);\n \n+\t\tsyncResourcesForSynchronization(sess, baseGroup, loginAttributeDefinition, skippedGroups);\n+\n \t\tlog.info(\"Group structure synchronization {}: ended.\", baseGroup);\n \n \t\treturn skippedGroups;\n \t}\n \n+\t/**\n+\t * Sync resources from groupStructureResources attribute to the group\n+\t * tree with the root in the given base group. If some resources are not found\n+\t * or the assignment failed, there is a new message added to the skippedMessages list.\n+\t *\n+\t * @param sess perun session\n+\t * @param baseGroup group structure sync base group\n+\t * @param skippedMessages list where are added messages about skipped operations\n+\t */\n+\tprivate void syncResourcesForSynchronization(PerunSession sess, Group baseGroup, AttributeDefinition loginAttr,\n+\t                                             List<String> skippedMessages) {\n+\t\tAttribute syncedResourcesAttr;\n+\n+\t\ttry {\n+\t\t\tsyncedResourcesAttr = perunBl.getAttributesManagerBl()\n+\t\t\t\t\t.getAttribute(sess, baseGroup, A_G_D_GROUP_STRUCTURE_RESOURCES);\n+\t\t} catch (WrongAttributeAssignmentException | AttributeNotExistsException e) {\n+\t\t\tthrow new InternalErrorException(\"Failed to obtain the groupStructureResources attribute for structure synchronization.\", e);\n+\t\t}\n+\n+\t\tif (syncedResourcesAttr.getValue() == null) {\n+\t\t\t// no resources should be synced\n+\t\t\treturn;\n+\t\t}\n+\n+\t\t// load all subgroups with logins once, so it can be reused in other methods\n+\t\tMap<String, Group> groupsByLogins = getAllSubGroupsWithLogins(sess, baseGroup, loginAttr);\n+\n+\t\tsyncedResourcesAttr.valueAsMap().forEach((resourceId, groupLogins) ->\n+\t\t\tsyncResourceInStructure(sess, resourceId, groupLogins, baseGroup, groupsByLogins, skippedMessages));\n+\t}\n+\n+\t/**\n+\t * Assign resource with given id to groups with logins defined in parameter 'rawGroupLogins'.\n+\t *\n+\t * If the rawGroupLogins value is empty, then the resource is assigned to the whole structure.\n+\t * The rawGroupLogins are in format: 'login1,login2,login3,'. If the login contains a '\\' or ','\n+\t * characters, they must be escaped by the '\\' character.\n+\t *\n+\t * @param sess perun session\n+\t * @param rawResourceId id of a resource which should be set\n+\t * @param rawGroupLogins group login separated with a comma ','\n+\t * @param baseGroup base group which is used if the rawGroupLogins is empty\n+\t * @param groupsByLogins map containing groups with by their logins\n+\t * @param skippedMessages a list with skipped messages, other messages are added to this list\n+\t */\n+\tprivate void syncResourceInStructure(PerunSession sess, String rawResourceId, String rawGroupLogins,\n+\t                                     Group baseGroup, Map<String, Group> groupsByLogins,\n+\t                                     List<String> skippedMessages) {\n+\t\tint resourceId = Integer.parseInt(rawResourceId);\n+\t\ttry {\n+\t\t\tResource resource = perunBl.getResourcesManagerBl().getResourceById(sess, resourceId);\n+\t\t\t// if no group logins are specified, assign resource to the whole tree\n+\t\t\tif (rawGroupLogins.isEmpty()) {\n+\t\t\t\tassignResourceToGroupAndSubGroups(sess, baseGroup, resource, skippedMessages);\n+\t\t\t} else {\n+\t\t\t\tList<String> groupLogins = BeansUtils.parseEscapedListValue(rawGroupLogins);\n+\t\t\t\tgroupLogins.forEach(login ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05aa5a2eb37f02b4c17068c8c954224ed24f3eef"}, "originalPosition": 92}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05aa5a2eb37f02b4c17068c8c954224ed24f3eef", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/05aa5a2eb37f02b4c17068c8c954224ed24f3eef", "committedDate": "2020-07-03T08:48:08Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}, "afterCommit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/cbf07f481e33b258a62f06f64d7fb8907fce57cc", "committedDate": "2020-07-03T10:11:56Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzM3NTY1", "url": "https://github.com/CESNET/perun/pull/2776#pullrequestreview-442337565", "createdAt": "2020-07-03T11:06:40Z", "commit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzQ1MDUx", "url": "https://github.com/CESNET/perun/pull/2776#pullrequestreview-442345051", "createdAt": "2020-07-03T11:20:55Z", "commit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMToyMDo1NlrOGstM7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwOTo0MzoxMVrOGt3AFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzMTExNw==", "bodyText": "Javadoc would be great.", "url": "https://github.com/CESNET/perun/pull/2776#discussion_r449531117", "createdAt": "2020-07-03T11:20:56Z", "author": {"login": "stavamichal"}, "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/BeansUtils.java", "diffHunk": "@@ -334,6 +334,31 @@ public static String attributeValueToString(Attribute attribute) {\n \t\treturn map;\n \t}\n \n+\tpublic static List<String> parseEscapedListValue(String value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzMjI0NA==", "bodyText": "I would add information about what is key and what is value.", "url": "https://github.com/CESNET/perun/pull/2776#discussion_r449532244", "createdAt": "2020-07-03T11:23:40Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -7476,6 +7476,21 @@ protected void initialize() {\n \t\trights.add(new AttributeRights(-1, Role.GROUPADMIN, Collections.singletonList(ActionType.READ)));\n \t\tattributes.put(attr, rights);\n \n+\t\t//urn:perun:group:attribute-def:def:groupStructureResources\n+\t\tattr = new AttributeDefinition();\n+\t\tattr.setNamespace(AttributesManager.NS_GROUP_ATTR_DEF);\n+\t\tattr.setType(LinkedHashMap.class.getName());\n+\t\tattr.setFriendlyName(\"groupStructureResources\");\n+\t\tattr.setDisplayName(\"Group structure synchronization resources\");\n+\t\tattr.setDescription(\"Defines, which resources should be auto assigned, and to which groups. Each group login \" +\n+\t\t\t\"should end with the `,` character (even the last one, eg: `login1,login2,`). If some of the group logins\" +\n+\t\t\t\" contains a comma ',' or backslash '\\\\', you have to escape it with the backslash '\\\\' character.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzODM2OQ==", "bodyText": "It should be something like 'Assigning groups to resource with id ...'", "url": "https://github.com/CESNET/perun/pull/2776#discussion_r449538369", "createdAt": "2020-07-03T11:39:28Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -1734,11 +1737,135 @@ protected boolean hasCandidateExistingMember(Candidate candidate, RichMember ric\n \n \t\tsetUpSynchronizationAttributesForAllSubGroups(sess, baseGroup, source, loginAttributeDefinition);\n \n+\t\tsyncResourcesForSynchronization(sess, baseGroup, loginAttributeDefinition, skippedGroups);\n+\n \t\tlog.info(\"Group structure synchronization {}: ended.\", baseGroup);\n \n \t\treturn skippedGroups;\n \t}\n \n+\t/**\n+\t * Sync resources from groupStructureResources attribute to the group\n+\t * tree with the root in the given base group. If some resources are not found\n+\t * or the assignment failed, there is a new message added to the skippedMessages list.\n+\t *\n+\t * @param sess perun session\n+\t * @param baseGroup group structure sync base group\n+\t * @param skippedMessages list where are added messages about skipped operations\n+\t */\n+\tprivate void syncResourcesForSynchronization(PerunSession sess, Group baseGroup, AttributeDefinition loginAttr,\n+\t                                             List<String> skippedMessages) {\n+\t\tAttribute syncedResourcesAttr;\n+\n+\t\ttry {\n+\t\t\tsyncedResourcesAttr = perunBl.getAttributesManagerBl()\n+\t\t\t\t\t.getAttribute(sess, baseGroup, A_G_D_GROUP_STRUCTURE_RESOURCES);\n+\t\t} catch (WrongAttributeAssignmentException | AttributeNotExistsException e) {\n+\t\t\tthrow new InternalErrorException(\"Failed to obtain the groupStructureResources attribute for structure synchronization.\", e);\n+\t\t}\n+\n+\t\tif (syncedResourcesAttr.getValue() == null) {\n+\t\t\t// no resources should be synced\n+\t\t\treturn;\n+\t\t}\n+\n+\t\t// load all subgroups with logins once, so it can be reused in other methods\n+\t\tMap<String, Group> groupsByLogins = getAllSubGroupsWithLogins(sess, baseGroup, loginAttr);\n+\n+\t\tsyncedResourcesAttr.valueAsMap().forEach((resourceId, groupLogins) ->\n+\t\t\tsyncResourceInStructure(sess, resourceId, groupLogins, baseGroup, groupsByLogins, skippedMessages));\n+\t}\n+\n+\t/**\n+\t * Assign resource with given id to groups with logins defined in parameter 'rawGroupLogins'.\n+\t *\n+\t * If the rawGroupLogins value is empty, then the resource is assigned to the whole structure.\n+\t * The rawGroupLogins are in format: 'login1,login2,login3,'. If the login contains a '\\' or ','\n+\t * characters, they must be escaped by the '\\' character.\n+\t *\n+\t * @param sess perun session\n+\t * @param rawResourceId id of a resource which should be set\n+\t * @param rawGroupLogins group login separated with a comma ','\n+\t * @param baseGroup base group which is used if the rawGroupLogins is empty\n+\t * @param groupsByLogins map containing groups with by their logins\n+\t * @param skippedMessages a list with skipped messages, other messages are added to this list\n+\t */\n+\tprivate void syncResourceInStructure(PerunSession sess, String rawResourceId, String rawGroupLogins,\n+\t                                     Group baseGroup, Map<String, Group> groupsByLogins,\n+\t                                     List<String> skippedMessages) {\n+\t\tint resourceId = Integer.parseInt(rawResourceId);\n+\t\ttry {\n+\t\t\tResource resource = perunBl.getResourcesManagerBl().getResourceById(sess, resourceId);\n+\t\t\t// if no group logins are specified, assign resource to the whole tree\n+\t\t\tif (rawGroupLogins.isEmpty()) {\n+\t\t\t\tassignResourceToGroupAndSubGroups(sess, baseGroup, resource, skippedMessages);\n+\t\t\t} else {\n+\t\t\t\tList<String> groupLogins = BeansUtils.parseEscapedListValue(rawGroupLogins);\n+\t\t\t\tgroupLogins.forEach(login ->\n+\t\t\t\t\tsyncResourceInStructure(sess, resource, baseGroup, login, groupsByLogins, skippedMessages));\n+\t\t\t}\n+\t\t} catch (ResourceNotExistsException e) {\n+\t\t\tlog.error(\"Skipped resource during group structure synchronization, because it was not found.\", e);\n+\t\t\tskippedMessages.add(\"Resource with id '\" + resourceId + \"' skipped because it was not found.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwNzE3MA==", "bodyText": "Base-group should be somehow excluded from this assigning. You definitely want to add the whole tree there, but the base-group itself should be an exception here (cause it does not have relevant attributes).", "url": "https://github.com/CESNET/perun/pull/2776#discussion_r450707170", "createdAt": "2020-07-07T08:47:44Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -1734,11 +1737,135 @@ protected boolean hasCandidateExistingMember(Candidate candidate, RichMember ric\n \n \t\tsetUpSynchronizationAttributesForAllSubGroups(sess, baseGroup, source, loginAttributeDefinition);\n \n+\t\tsyncResourcesForSynchronization(sess, baseGroup, loginAttributeDefinition, skippedGroups);\n+\n \t\tlog.info(\"Group structure synchronization {}: ended.\", baseGroup);\n \n \t\treturn skippedGroups;\n \t}\n \n+\t/**\n+\t * Sync resources from groupStructureResources attribute to the group\n+\t * tree with the root in the given base group. If some resources are not found\n+\t * or the assignment failed, there is a new message added to the skippedMessages list.\n+\t *\n+\t * @param sess perun session\n+\t * @param baseGroup group structure sync base group\n+\t * @param skippedMessages list where are added messages about skipped operations\n+\t */\n+\tprivate void syncResourcesForSynchronization(PerunSession sess, Group baseGroup, AttributeDefinition loginAttr,\n+\t                                             List<String> skippedMessages) {\n+\t\tAttribute syncedResourcesAttr;\n+\n+\t\ttry {\n+\t\t\tsyncedResourcesAttr = perunBl.getAttributesManagerBl()\n+\t\t\t\t\t.getAttribute(sess, baseGroup, A_G_D_GROUP_STRUCTURE_RESOURCES);\n+\t\t} catch (WrongAttributeAssignmentException | AttributeNotExistsException e) {\n+\t\t\tthrow new InternalErrorException(\"Failed to obtain the groupStructureResources attribute for structure synchronization.\", e);\n+\t\t}\n+\n+\t\tif (syncedResourcesAttr.getValue() == null) {\n+\t\t\t// no resources should be synced\n+\t\t\treturn;\n+\t\t}\n+\n+\t\t// load all subgroups with logins once, so it can be reused in other methods\n+\t\tMap<String, Group> groupsByLogins = getAllSubGroupsWithLogins(sess, baseGroup, loginAttr);\n+\n+\t\tsyncedResourcesAttr.valueAsMap().forEach((resourceId, groupLogins) ->\n+\t\t\tsyncResourceInStructure(sess, resourceId, groupLogins, baseGroup, groupsByLogins, skippedMessages));\n+\t}\n+\n+\t/**\n+\t * Assign resource with given id to groups with logins defined in parameter 'rawGroupLogins'.\n+\t *\n+\t * If the rawGroupLogins value is empty, then the resource is assigned to the whole structure.\n+\t * The rawGroupLogins are in format: 'login1,login2,login3,'. If the login contains a '\\' or ','\n+\t * characters, they must be escaped by the '\\' character.\n+\t *\n+\t * @param sess perun session\n+\t * @param rawResourceId id of a resource which should be set\n+\t * @param rawGroupLogins group login separated with a comma ','\n+\t * @param baseGroup base group which is used if the rawGroupLogins is empty\n+\t * @param groupsByLogins map containing groups with by their logins\n+\t * @param skippedMessages a list with skipped messages, other messages are added to this list\n+\t */\n+\tprivate void syncResourceInStructure(PerunSession sess, String rawResourceId, String rawGroupLogins,\n+\t                                     Group baseGroup, Map<String, Group> groupsByLogins,\n+\t                                     List<String> skippedMessages) {\n+\t\tint resourceId = Integer.parseInt(rawResourceId);\n+\t\ttry {\n+\t\t\tResource resource = perunBl.getResourcesManagerBl().getResourceById(sess, resourceId);\n+\t\t\t// if no group logins are specified, assign resource to the whole tree\n+\t\t\tif (rawGroupLogins.isEmpty()) {\n+\t\t\t\tassignResourceToGroupAndSubGroups(sess, baseGroup, resource, skippedMessages);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxMzMwMg==", "bodyText": "In the context of the method, this Group doesn't need to be a base-group. I would change the name of variable to just 'group'.", "url": "https://github.com/CESNET/perun/pull/2776#discussion_r450713302", "createdAt": "2020-07-07T08:57:49Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -1734,11 +1737,135 @@ protected boolean hasCandidateExistingMember(Candidate candidate, RichMember ric\n \n \t\tsetUpSynchronizationAttributesForAllSubGroups(sess, baseGroup, source, loginAttributeDefinition);\n \n+\t\tsyncResourcesForSynchronization(sess, baseGroup, loginAttributeDefinition, skippedGroups);\n+\n \t\tlog.info(\"Group structure synchronization {}: ended.\", baseGroup);\n \n \t\treturn skippedGroups;\n \t}\n \n+\t/**\n+\t * Sync resources from groupStructureResources attribute to the group\n+\t * tree with the root in the given base group. If some resources are not found\n+\t * or the assignment failed, there is a new message added to the skippedMessages list.\n+\t *\n+\t * @param sess perun session\n+\t * @param baseGroup group structure sync base group\n+\t * @param skippedMessages list where are added messages about skipped operations\n+\t */\n+\tprivate void syncResourcesForSynchronization(PerunSession sess, Group baseGroup, AttributeDefinition loginAttr,\n+\t                                             List<String> skippedMessages) {\n+\t\tAttribute syncedResourcesAttr;\n+\n+\t\ttry {\n+\t\t\tsyncedResourcesAttr = perunBl.getAttributesManagerBl()\n+\t\t\t\t\t.getAttribute(sess, baseGroup, A_G_D_GROUP_STRUCTURE_RESOURCES);\n+\t\t} catch (WrongAttributeAssignmentException | AttributeNotExistsException e) {\n+\t\t\tthrow new InternalErrorException(\"Failed to obtain the groupStructureResources attribute for structure synchronization.\", e);\n+\t\t}\n+\n+\t\tif (syncedResourcesAttr.getValue() == null) {\n+\t\t\t// no resources should be synced\n+\t\t\treturn;\n+\t\t}\n+\n+\t\t// load all subgroups with logins once, so it can be reused in other methods\n+\t\tMap<String, Group> groupsByLogins = getAllSubGroupsWithLogins(sess, baseGroup, loginAttr);\n+\n+\t\tsyncedResourcesAttr.valueAsMap().forEach((resourceId, groupLogins) ->\n+\t\t\tsyncResourceInStructure(sess, resourceId, groupLogins, baseGroup, groupsByLogins, skippedMessages));\n+\t}\n+\n+\t/**\n+\t * Assign resource with given id to groups with logins defined in parameter 'rawGroupLogins'.\n+\t *\n+\t * If the rawGroupLogins value is empty, then the resource is assigned to the whole structure.\n+\t * The rawGroupLogins are in format: 'login1,login2,login3,'. If the login contains a '\\' or ','\n+\t * characters, they must be escaped by the '\\' character.\n+\t *\n+\t * @param sess perun session\n+\t * @param rawResourceId id of a resource which should be set\n+\t * @param rawGroupLogins group login separated with a comma ','\n+\t * @param baseGroup base group which is used if the rawGroupLogins is empty\n+\t * @param groupsByLogins map containing groups with by their logins\n+\t * @param skippedMessages a list with skipped messages, other messages are added to this list\n+\t */\n+\tprivate void syncResourceInStructure(PerunSession sess, String rawResourceId, String rawGroupLogins,\n+\t                                     Group baseGroup, Map<String, Group> groupsByLogins,\n+\t                                     List<String> skippedMessages) {\n+\t\tint resourceId = Integer.parseInt(rawResourceId);\n+\t\ttry {\n+\t\t\tResource resource = perunBl.getResourcesManagerBl().getResourceById(sess, resourceId);\n+\t\t\t// if no group logins are specified, assign resource to the whole tree\n+\t\t\tif (rawGroupLogins.isEmpty()) {\n+\t\t\t\tassignResourceToGroupAndSubGroups(sess, baseGroup, resource, skippedMessages);\n+\t\t\t} else {\n+\t\t\t\tList<String> groupLogins = BeansUtils.parseEscapedListValue(rawGroupLogins);\n+\t\t\t\tgroupLogins.forEach(login ->\n+\t\t\t\t\tsyncResourceInStructure(sess, resource, baseGroup, login, groupsByLogins, skippedMessages));\n+\t\t\t}\n+\t\t} catch (ResourceNotExistsException e) {\n+\t\t\tlog.error(\"Skipped resource during group structure synchronization, because it was not found.\", e);\n+\t\t\tskippedMessages.add(\"Resource with id '\" + resourceId + \"' skipped because it was not found.\");\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Assign given resource to a group with given login.\n+\t *\n+\t * If the rawGroupLogins value is empty, then the resource is assigned to the whole structure.\n+\t *\n+\t * @param sess perun session\n+\t * @param resource a resource which should be set\n+\t * @param login group login\n+\t * @param baseGroup base group which is used if the rawGroupLogins is empty\n+\t * @param groupsByLogins map containing groups with by their logins\n+\t * @param skippedMessages a list with skipped messages, other messages are added to this list\n+\t */\n+\tprivate void syncResourceInStructure(PerunSession sess, Resource resource, Group baseGroup, String login,\n+\t                                Map<String, Group> groupsByLogins, List<String> skippedMessages) {\n+\t\tGroup group;\n+\t\tif (login.isEmpty()) {\n+\t\t\tgroup = baseGroup;\n+\t\t} else {\n+\t\t\tgroup = groupsByLogins.get(login);\n+\t\t}\n+\t\tif (group == null) {\n+\t\t\tskippedMessages.add(\"Resource with id '\" + resource.getId() + \"' was skipped for group with login '\" +\n+\t\t\t\tlogin + \"' no group with this login was found.\");\n+\t\t} else {\n+\t\t\tassignResourceToGroupAndSubGroups(sess, group, resource, skippedMessages);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Assign resource to the given baseGroup and to all of its subgroups. If\n+\t * any of the assignments fails, information is added to the given skippedMessages.\n+\t *\n+\t * @param sess perun session\n+\t * @param baseGroup base group\n+\t * @param resource resource\n+\t * @param skippedMessages list where are added messages about skipped operations\n+\t */\n+\tprivate void assignResourceToGroupAndSubGroups(PerunSession sess, Group baseGroup, Resource resource,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDczNDY0OA==", "bodyText": "Command \"return\" will end whole method. \"continue\" is what you need here.", "url": "https://github.com/CESNET/perun/pull/2776#discussion_r450734648", "createdAt": "2020-07-07T09:34:02Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_group_attribute_def_def_groupStructureResources.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.GroupAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.GroupAttributesModuleImplApi;\n+\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class urn_perun_group_attribute_def_def_groupStructureResources extends GroupAttributesModuleAbstract implements GroupAttributesModuleImplApi {\n+\n+\tprivate static final Pattern resourceIdPattern = Pattern.compile(\"^[1-9][0-9]*$\");\n+    private static final Pattern invalidEscapePattern =\n+      Pattern.compile(\"(\" + \"([^\\\\\\\\]|^)(\\\\\\\\\\\\\\\\)*)\\\\\\\\([^,\\\\\\\\]|$)\");\n+\n+\t@Override\n+\tpublic void checkAttributeSyntax(PerunSessionImpl sess, Group group, Attribute attribute) throws WrongAttributeValueException {\n+\t\t//Null value is ok, means no settings for group\n+\t\tif(attribute.getValue() == null) return;\n+\n+\t\tLinkedHashMap<String, String> attrValues = attribute.valueAsMap();\n+\n+\t\tboolean hasInvalidResourceName = attrValues.keySet().stream()\n+\t\t\t\t.anyMatch(this::invalidResourceName);\n+\n+\t\tif (hasInvalidResourceName) {\n+\t\t\tthrow new WrongAttributeValueException(attribute, group, \"Some of the specified resource ids has an invalid format.\");\n+\t\t}\n+\t\tfor (String rawGroupLogins : attrValues.values()) {\n+\t\t\t// empty value means the whole group tree\n+\t\t\tif (rawGroupLogins.isEmpty()) {\n+\t\t\t\treturn;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDczNjMyOQ==", "bodyText": "What does mean \" comma 'c' \"?\nAnd to be precise here, this comma shouldn't be escaped otherwise it's part of the last group name.", "url": "https://github.com/CESNET/perun/pull/2776#discussion_r450736329", "createdAt": "2020-07-07T09:36:54Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_group_attribute_def_def_groupStructureResources.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package cz.metacentrum.perun.core.impl.modules.attributes;\n+\n+import cz.metacentrum.perun.core.api.Attribute;\n+import cz.metacentrum.perun.core.api.AttributeDefinition;\n+import cz.metacentrum.perun.core.api.AttributesManager;\n+import cz.metacentrum.perun.core.api.Group;\n+import cz.metacentrum.perun.core.api.Resource;\n+import cz.metacentrum.perun.core.api.Vo;\n+import cz.metacentrum.perun.core.api.exceptions.InternalErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.VoNotExistsException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeAssignmentException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongAttributeValueException;\n+import cz.metacentrum.perun.core.api.exceptions.WrongReferenceAttributeValueException;\n+import cz.metacentrum.perun.core.impl.PerunSessionImpl;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.GroupAttributesModuleAbstract;\n+import cz.metacentrum.perun.core.implApi.modules.attributes.GroupAttributesModuleImplApi;\n+\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * @author Vojtech Sassmann <vojtech.sassmann@gmail.com>\n+ */\n+public class urn_perun_group_attribute_def_def_groupStructureResources extends GroupAttributesModuleAbstract implements GroupAttributesModuleImplApi {\n+\n+\tprivate static final Pattern resourceIdPattern = Pattern.compile(\"^[1-9][0-9]*$\");\n+    private static final Pattern invalidEscapePattern =\n+      Pattern.compile(\"(\" + \"([^\\\\\\\\]|^)(\\\\\\\\\\\\\\\\)*)\\\\\\\\([^,\\\\\\\\]|$)\");\n+\n+\t@Override\n+\tpublic void checkAttributeSyntax(PerunSessionImpl sess, Group group, Attribute attribute) throws WrongAttributeValueException {\n+\t\t//Null value is ok, means no settings for group\n+\t\tif(attribute.getValue() == null) return;\n+\n+\t\tLinkedHashMap<String, String> attrValues = attribute.valueAsMap();\n+\n+\t\tboolean hasInvalidResourceName = attrValues.keySet().stream()\n+\t\t\t\t.anyMatch(this::invalidResourceName);\n+\n+\t\tif (hasInvalidResourceName) {\n+\t\t\tthrow new WrongAttributeValueException(attribute, group, \"Some of the specified resource ids has an invalid format.\");\n+\t\t}\n+\t\tfor (String rawGroupLogins : attrValues.values()) {\n+\t\t\t// empty value means the whole group tree\n+\t\t\tif (rawGroupLogins.isEmpty()) {\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t\tMatcher m = invalidEscapePattern.matcher(rawGroupLogins);\n+\t\t\tif (m.find()) {\n+\t\t\t\tthrow new WrongAttributeValueException(attribute, group, \"Group logins format contains invalid escape sequence.\");\n+\t\t\t}\n+\t\t\tif (!rawGroupLogins.endsWith(\",\")) {\n+\t\t\t\tthrow new WrongAttributeValueException(attribute, group, \"Each group login has to end with a comma 'c'.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc0MDI0Nw==", "bodyText": "Maybe we should start to call this part of the code from the module (if exists) to prevent duplicities.", "url": "https://github.com/CESNET/perun/pull/2776#discussion_r450740247", "createdAt": "2020-07-07T09:43:11Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AttributesManagerBlImpl.java", "diffHunk": "@@ -7476,6 +7476,21 @@ protected void initialize() {\n \t\trights.add(new AttributeRights(-1, Role.GROUPADMIN, Collections.singletonList(ActionType.READ)));\n \t\tattributes.put(attr, rights);\n \n+\t\t//urn:perun:group:attribute-def:def:groupStructureResources\n+\t\tattr = new AttributeDefinition();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbf07f481e33b258a62f06f64d7fb8907fce57cc", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/cbf07f481e33b258a62f06f64d7fb8907fce57cc", "committedDate": "2020-07-03T10:11:56Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}, "afterCommit": {"oid": "5e89f0ab9c5fdd94b872e1414ba21b71e8b759ab", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/5e89f0ab9c5fdd94b872e1414ba21b71e8b759ab", "committedDate": "2020-07-07T16:07:59Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e89f0ab9c5fdd94b872e1414ba21b71e8b759ab", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/5e89f0ab9c5fdd94b872e1414ba21b71e8b759ab", "committedDate": "2020-07-07T16:07:59Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}, "afterCommit": {"oid": "1155281399977d8a8e6bbad2e2c933c877cf8944", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/1155281399977d8a8e6bbad2e2c933c877cf8944", "committedDate": "2020-07-07T16:35:21Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1155281399977d8a8e6bbad2e2c933c877cf8944", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/1155281399977d8a8e6bbad2e2c933c877cf8944", "committedDate": "2020-07-07T16:35:21Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}, "afterCommit": {"oid": "ee38f9142693d2b5fcd7e63b38c903a87633e75c", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/ee38f9142693d2b5fcd7e63b38c903a87633e75c", "committedDate": "2020-07-07T16:44:15Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee38f9142693d2b5fcd7e63b38c903a87633e75c", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/ee38f9142693d2b5fcd7e63b38c903a87633e75c", "committedDate": "2020-07-07T16:44:15Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}, "afterCommit": {"oid": "ba00d8d6277620aa9a2d951f23edefd49353e652", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/ba00d8d6277620aa9a2d951f23edefd49353e652", "committedDate": "2020-07-08T07:05:13Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba00d8d6277620aa9a2d951f23edefd49353e652", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/ba00d8d6277620aa9a2d951f23edefd49353e652", "committedDate": "2020-07-08T07:05:13Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}, "afterCommit": {"oid": "80f35f4dbfb987f70cfb91bc7bb22a1ff527f219", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/80f35f4dbfb987f70cfb91bc7bb22a1ff527f219", "committedDate": "2020-07-08T07:42:16Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80f35f4dbfb987f70cfb91bc7bb22a1ff527f219", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/80f35f4dbfb987f70cfb91bc7bb22a1ff527f219", "committedDate": "2020-07-08T07:42:16Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}, "afterCommit": {"oid": "53f091e6b36a6463c065fec59b98b130562a64c3", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/53f091e6b36a6463c065fec59b98b130562a64c3", "committedDate": "2020-07-08T08:24:49Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTAzMDEx", "url": "https://github.com/CESNET/perun/pull/2776#pullrequestreview-444503011", "createdAt": "2020-07-08T08:02:03Z", "commit": {"oid": "80f35f4dbfb987f70cfb91bc7bb22a1ff527f219"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODowMjowM1rOGucpIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODowMjowM1rOGucpIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM1Njk2Mw==", "bodyText": "This Javadoc is not complete. You are assigning group \"and all its subgroups\" to the given resource and the only exception is base-group.", "url": "https://github.com/CESNET/perun/pull/2776#discussion_r451356963", "createdAt": "2020-07-08T08:02:03Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/GroupsManagerBlImpl.java", "diffHunk": "@@ -1742,11 +1746,143 @@ protected boolean hasCandidateExistingMember(Candidate candidate, RichMember ric\n \n \t\tsetUpSynchronizationAttributesForAllSubGroups(sess, baseGroup, source, loginAttributeDefinition, loginPrefix);\n \n+\t\tsyncResourcesForSynchronization(sess, baseGroup, loginAttributeDefinition, skippedGroups);\n+\n \t\tlog.info(\"Group structure synchronization {}: ended.\", baseGroup);\n \n \t\treturn skippedGroups;\n \t}\n \n+\t/**\n+\t * Sync resources from groupStructureResources attribute to the group\n+\t * tree with the root in the given base group. If some resources are not found\n+\t * or the assignment failed, there is a new message added to the skippedMessages list.\n+\t *\n+\t * @param sess perun session\n+\t * @param baseGroup group structure sync base group\n+\t * @param skippedMessages list where are added messages about skipped operations\n+\t */\n+\tprivate void syncResourcesForSynchronization(PerunSession sess, Group baseGroup, AttributeDefinition loginAttr,\n+\t                                             List<String> skippedMessages) {\n+\t\tAttribute syncedResourcesAttr;\n+\n+\t\ttry {\n+\t\t\tsyncedResourcesAttr = perunBl.getAttributesManagerBl()\n+\t\t\t\t\t.getAttribute(sess, baseGroup, A_G_D_GROUP_STRUCTURE_RESOURCES);\n+\t\t} catch (WrongAttributeAssignmentException | AttributeNotExistsException e) {\n+\t\t\tthrow new InternalErrorException(\"Failed to obtain the groupStructureResources attribute for structure synchronization.\", e);\n+\t\t}\n+\n+\t\tif (syncedResourcesAttr.getValue() == null) {\n+\t\t\t// no resources should be synced\n+\t\t\treturn;\n+\t\t}\n+\n+\t\t// load all subgroups with logins once, so it can be reused in other methods\n+\t\tMap<String, Group> groupsByLogins = getAllSubGroupsWithLogins(sess, baseGroup, loginAttr);\n+\n+\t\tsyncedResourcesAttr.valueAsMap().forEach((resourceId, groupLogins) ->\n+\t\t\tsyncResourceInStructure(sess, resourceId, groupLogins, baseGroup, groupsByLogins, skippedMessages));\n+\t}\n+\n+\t/**\n+\t * Assign resource with given id to groups with logins defined in parameter 'rawGroupLogins'.\n+\t *\n+\t * If the rawGroupLogins value is empty, then the resource is assigned to the whole structure.\n+\t * The rawGroupLogins are in format: 'login1,login2,login3,'. If the login contains a '\\' or ','\n+\t * characters, they must be escaped by the '\\' character.\n+\t *\n+\t * @param sess perun session\n+\t * @param rawResourceId id of a resource which should be set\n+\t * @param rawGroupLogins group login separated with a comma ','\n+\t * @param baseGroup base group which is used if the rawGroupLogins is empty\n+\t * @param groupsByLogins map containing groups with by their logins\n+\t * @param skippedMessages a list with skipped messages, other messages are added to this list\n+\t */\n+\tprivate void syncResourceInStructure(PerunSession sess, String rawResourceId, String rawGroupLogins,\n+\t                                     Group baseGroup, Map<String, Group> groupsByLogins,\n+\t                                     List<String> skippedMessages) {\n+\t\tint resourceId = Integer.parseInt(rawResourceId);\n+\t\ttry {\n+\t\t\tResource resource = perunBl.getResourcesManagerBl().getResourceById(sess, resourceId);\n+\t\t\tList<String> groupLogins;\n+\t\t\tif (rawGroupLogins.isEmpty()) {\n+\t\t\t\t// if no group logins are specified, assign the resource to the whole tree\n+\t\t\t\tgroupLogins = Collections.singletonList(rawGroupLogins);\n+\t\t\t} else {\n+\t\t\t\tgroupLogins = BeansUtils.parseEscapedListValue(rawGroupLogins);\n+\t\t\t}\n+\t\t\tgroupLogins.forEach(login ->\n+\t\t\t\t\tsyncResourceInStructure(sess, resource, baseGroup, login, groupsByLogins, skippedMessages));\n+\t\t} catch (ResourceNotExistsException e) {\n+\t\t\tlog.error(\"Assigning groups to a resource was skipped during group structure synchronization, because the resource wasn't found.\", e);\n+\t\t\tskippedMessages.add(\"Assigning groups to resource with id'\" + resourceId + \"' skipped because it was not found.\");\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Assign given resource to a group with given login.\n+\t *\n+\t * If the login value is empty, then the resource is assigned to\n+\t * the whole structure, except for the base group.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80f35f4dbfb987f70cfb91bc7bb22a1ff527f219"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NjMzNjAy", "url": "https://github.com/CESNET/perun/pull/2776#pullrequestreview-444633602", "createdAt": "2020-07-08T10:58:00Z", "commit": {"oid": "53f091e6b36a6463c065fec59b98b130562a64c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a848d78b7a1b1ca7580243251e7ea23ffaf17f60", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/a848d78b7a1b1ca7580243251e7ea23ffaf17f60", "committedDate": "2020-07-08T11:07:03Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53f091e6b36a6463c065fec59b98b130562a64c3", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/53f091e6b36a6463c065fec59b98b130562a64c3", "committedDate": "2020-07-08T08:24:49Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}, "afterCommit": {"oid": "a848d78b7a1b1ca7580243251e7ea23ffaf17f60", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/a848d78b7a1b1ca7580243251e7ea23ffaf17f60", "committedDate": "2020-07-08T11:07:03Z", "message": "Group structure sync - resources\n\n* Implemented login responsible for automatic assignment of resources\nfor certain group trees in the group structure synchronization.\n* Created a new attribute for group structure synchronization named\ngroupStructureResources. This attribute is of the map type and keys\nrepresents id of a resource which should be assigned, and values are\ngroup logins, seperated with commas. The resource is assigned to group\nwith the login and also to all of its subgroups."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NjQyNzY2", "url": "https://github.com/CESNET/perun/pull/2776#pullrequestreview-444642766", "createdAt": "2020-07-08T11:12:13Z", "commit": {"oid": "a848d78b7a1b1ca7580243251e7ea23ffaf17f60"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1244, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}