{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NjQwMTYz", "number": 2648, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjo0OTo1NFrODs-Afw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMzoxMzozNVrODtGlNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NDc5ODcxOnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjo0OTo1NFrOF-Hiag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwODoyNzozN1rOF-KuVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3OTUzMA==", "bodyText": "We can check this using SQL constraint itself in impl/dao layer, since we update name and description separately. We can catch DataIntegrityViolationException when updating name and then throw GroupExistsException rather than current InternalErrorException. See example in FacilitiesManagerImpl method updateFacility().", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400679530", "createdAt": "2020-03-31T06:49:54Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -200,7 +200,7 @@ public void deleteGroups(PerunSession perunSession, List<Group> groups, boolean\n \t}\n \n \t@Override\n-\tpublic Group updateGroup(PerunSession sess, Group group) throws GroupNotExistsException, InternalErrorException, PrivilegeException {\n+\tpublic Group updateGroup(PerunSession sess, Group group) throws GroupNotExistsException, GroupExistsException, InternalErrorException, PrivilegeException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17d92fdc5226cbed1242f29c91f91ecd63d54200"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczMTczMw==", "bodyText": "Yes, you are right. I changed that logic to be same as for Facility.", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400731733", "createdAt": "2020-03-31T08:27:37Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -200,7 +200,7 @@ public void deleteGroups(PerunSession perunSession, List<Group> groups, boolean\n \t}\n \n \t@Override\n-\tpublic Group updateGroup(PerunSession sess, Group group) throws GroupNotExistsException, InternalErrorException, PrivilegeException {\n+\tpublic Group updateGroup(PerunSession sess, Group group) throws GroupNotExistsException, GroupExistsException, InternalErrorException, PrivilegeException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3OTUzMA=="}, "originalCommit": {"oid": "17d92fdc5226cbed1242f29c91f91ecd63d54200"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NTE4MDQyOnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwODo0MTo0N1rOF-LQlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMzowMDowNlrOF-UkMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0MDUwMA==", "bodyText": "Maybe we should include used name in the exception text.", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400740500", "createdAt": "2020-03-31T08:41:47Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -212,6 +214,8 @@ public Group updateGroup(PerunSession sess, Group group) throws InternalErrorExc\n \t\t\ttry {\n \t\t\t\tjdbc.update(\"update groups set name=?,modified_by=?, modified_by_uid=?, modified_at=\" + Compatibility.getSysdate() + \" where id=?\", dbGroup.getName(),\n \t\t\t\t\t\tsess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getUserId(), dbGroup.getId());\n+\t\t\t} catch (DataIntegrityViolationException e) {\n+\t\t\t\tthrow new GroupExistsException(\"The name must be unique and it's already occupied.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3086980616fc552c3eebda89dea4039921486f07"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0Mzc3Mw==", "bodyText": "I don't really think we need to know that. And it is exactly the same copy of the logic like in facilityManager.", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400743773", "createdAt": "2020-03-31T08:47:18Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -212,6 +214,8 @@ public Group updateGroup(PerunSession sess, Group group) throws InternalErrorExc\n \t\t\ttry {\n \t\t\t\tjdbc.update(\"update groups set name=?,modified_by=?, modified_by_uid=?, modified_at=\" + Compatibility.getSysdate() + \" where id=?\", dbGroup.getName(),\n \t\t\t\t\t\tsess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getUserId(), dbGroup.getId());\n+\t\t\t} catch (DataIntegrityViolationException e) {\n+\t\t\t\tthrow new GroupExistsException(\"The name must be unique and it's already occupied.\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0MDUwMA=="}, "originalCommit": {"oid": "3086980616fc552c3eebda89dea4039921486f07"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc3NjgxMQ==", "bodyText": "Do you insist? Of course I can add it, but I don't think it is important except the situation when database constraint works improperly.", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400776811", "createdAt": "2020-03-31T09:40:11Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -212,6 +214,8 @@ public Group updateGroup(PerunSession sess, Group group) throws InternalErrorExc\n \t\t\ttry {\n \t\t\t\tjdbc.update(\"update groups set name=?,modified_by=?, modified_by_uid=?, modified_at=\" + Compatibility.getSysdate() + \" where id=?\", dbGroup.getName(),\n \t\t\t\t\t\tsess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getUserId(), dbGroup.getId());\n+\t\t\t} catch (DataIntegrityViolationException e) {\n+\t\t\t\tthrow new GroupExistsException(\"The name must be unique and it's already occupied.\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0MDUwMA=="}, "originalCommit": {"oid": "3086980616fc552c3eebda89dea4039921486f07"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg2MDU4NQ==", "bodyText": "Not really, but since its in DAO layer, it might fail also some inner logic (move group?, group structure sync?). I'm not sure. Right now it won't be possible to know, which group caused the problem, unless it is logged anywhere else, since even passed SQL exception doesn't contain input data.", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400860585", "createdAt": "2020-03-31T12:09:23Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -212,6 +214,8 @@ public Group updateGroup(PerunSession sess, Group group) throws InternalErrorExc\n \t\t\ttry {\n \t\t\t\tjdbc.update(\"update groups set name=?,modified_by=?, modified_by_uid=?, modified_at=\" + Compatibility.getSysdate() + \" where id=?\", dbGroup.getName(),\n \t\t\t\t\t\tsess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getUserId(), dbGroup.getId());\n+\t\t\t} catch (DataIntegrityViolationException e) {\n+\t\t\t\tthrow new GroupExistsException(\"The name must be unique and it's already occupied.\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0MDUwMA=="}, "originalCommit": {"oid": "3086980616fc552c3eebda89dea4039921486f07"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5Mjk3Nw==", "bodyText": "Ok - added.", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400892977", "createdAt": "2020-03-31T13:00:06Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -212,6 +214,8 @@ public Group updateGroup(PerunSession sess, Group group) throws InternalErrorExc\n \t\t\ttry {\n \t\t\t\tjdbc.update(\"update groups set name=?,modified_by=?, modified_by_uid=?, modified_at=\" + Compatibility.getSysdate() + \" where id=?\", dbGroup.getName(),\n \t\t\t\t\t\tsess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getUserId(), dbGroup.getId());\n+\t\t\t} catch (DataIntegrityViolationException e) {\n+\t\t\t\tthrow new GroupExistsException(\"The name must be unique and it's already occupied.\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0MDUwMA=="}, "originalCommit": {"oid": "3086980616fc552c3eebda89dea4039921486f07"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NjIwMzQyOnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMzoxMzozNVrOF-VIPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMzoxMzozNVrOF-VIPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkwMjIwNQ==", "bodyText": "Unused import.", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400902205", "createdAt": "2020-03-31T13:13:35Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -18,6 +18,7 @@\n import cz.metacentrum.perun.core.api.Vo;\n import cz.metacentrum.perun.core.api.exceptions.AlreadyMemberException;\n import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.FacilityExistsException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c2879d205d581556ff94e441e022fe2c99b5280"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1996, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}