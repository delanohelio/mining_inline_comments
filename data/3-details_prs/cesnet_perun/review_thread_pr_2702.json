{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NDg5MDI1", "number": 2702, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODowMzowMFrOD9rrHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODoxMzoyN1rOD9r6OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MDA1Mjc3OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/FacilitiesManagerBlImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODowMzowMFrOGXUerw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODoyOToyNFrOGXVewg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEwNTk2Nw==", "bodyText": "You do not have to throw InternalErrorException.", "url": "https://github.com/CESNET/perun/pull/2702#discussion_r427105967", "createdAt": "2020-05-19T08:03:00Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/FacilitiesManagerBlImpl.java", "diffHunk": "@@ -467,16 +467,12 @@ public PerunBl getPerunBl() {\n \n \t@Override\n \tpublic List<Facility> getAllowedFacilities(PerunSession sess, User user) throws InternalErrorException {\n-\t\tList<Member> members = perunBl.getMembersManagerBl().getMembersByUser(sess, user);\n-\n-\t\tSet<Facility> assignedFacilities = new HashSet<>();\n-\t\tfor(Member member : members) {\n-\t\t\tif(!getPerunBl().getMembersManagerBl().haveStatus(sess, member, Status.INVALID)) {\n-\t\t\t\tassignedFacilities.addAll(this.getAssignedFacilities(sess, member));\n-\t\t\t}\n-\t\t}\n+\t\treturn getFacilitiesManagerImpl().getAllowedFacilities(sess, user);\n+\t}\n \n-\t\treturn new ArrayList<>(assignedFacilities);\n+\t@Override\n+\tpublic List<Facility> getAllowedFacilities(PerunSession sess, Member member) throws InternalErrorException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e612b4bc61e0e404d8d8af45554ecdf4316703c7"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyMjM3MA==", "bodyText": "You are right, fixed.", "url": "https://github.com/CESNET/perun/pull/2702#discussion_r427122370", "createdAt": "2020-05-19T08:29:24Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/FacilitiesManagerBlImpl.java", "diffHunk": "@@ -467,16 +467,12 @@ public PerunBl getPerunBl() {\n \n \t@Override\n \tpublic List<Facility> getAllowedFacilities(PerunSession sess, User user) throws InternalErrorException {\n-\t\tList<Member> members = perunBl.getMembersManagerBl().getMembersByUser(sess, user);\n-\n-\t\tSet<Facility> assignedFacilities = new HashSet<>();\n-\t\tfor(Member member : members) {\n-\t\t\tif(!getPerunBl().getMembersManagerBl().haveStatus(sess, member, Status.INVALID)) {\n-\t\t\t\tassignedFacilities.addAll(this.getAssignedFacilities(sess, member));\n-\t\t\t}\n-\t\t}\n+\t\treturn getFacilitiesManagerImpl().getAllowedFacilities(sess, user);\n+\t}\n \n-\t\treturn new ArrayList<>(assignedFacilities);\n+\t@Override\n+\tpublic List<Facility> getAllowedFacilities(PerunSession sess, Member member) throws InternalErrorException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEwNTk2Nw=="}, "originalCommit": {"oid": "e612b4bc61e0e404d8d8af45554ecdf4316703c7"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MDA5MTQ0OnYy", "diffSide": "RIGHT", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/FacilitiesManagerImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODoxMzoyN1rOGXU29Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODoyOTo1M1rOGXVgCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExMjE4MQ==", "bodyText": "This exception is probably not thrown for method jdbc.query.", "url": "https://github.com/CESNET/perun/pull/2702#discussion_r427112181", "createdAt": "2020-05-19T08:13:27Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/FacilitiesManagerImpl.java", "diffHunk": "@@ -449,6 +449,44 @@ public void removeOwner(PerunSession sess, Facility facility, Owner owner) throw\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic List<Facility> getAllowedFacilities(PerunSession sess, User user) throws InternalErrorException {\n+\t\ttry  {\n+\t\t\treturn jdbc.query(\"select distinct \" + facilityMappingSelectQuery + \" from groups_resources\" +\n+\t\t\t\t\t\t\t\" join groups on groups_resources.group_id=groups.id\" +\n+\t\t\t\t\t\t\t\" join groups_members on groups.id=groups_members.group_id\" +\n+\t\t\t\t\t\t\t\" join members on groups_members.member_id=members.id \" +\n+\t\t\t\t\t\t\t\" join resources on groups_resources.resource_id=resources.id \" +\n+\t\t\t\t\t\t\t\" join facilities on resources.facility_id=facilities.id \" +\n+\t\t\t\t\t\t\t\" where members.user_id=? and members.status!=? and members.status!=?\",\n+\t\t\t\t\tFACILITY_MAPPER, user.getId(),\n+\t\t\t\t\tString.valueOf(Status.INVALID.getCode()), String.valueOf(Status.DISABLED.getCode()));\n+\t\t} catch (EmptyResultDataAccessException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e612b4bc61e0e404d8d8af45554ecdf4316703c7"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyMjY5Ng==", "bodyText": "Again you are right, we should clean up the code everywhere. Here fixed.", "url": "https://github.com/CESNET/perun/pull/2702#discussion_r427122696", "createdAt": "2020-05-19T08:29:53Z", "author": {"login": "zlamalp"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/FacilitiesManagerImpl.java", "diffHunk": "@@ -449,6 +449,44 @@ public void removeOwner(PerunSession sess, Facility facility, Owner owner) throw\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic List<Facility> getAllowedFacilities(PerunSession sess, User user) throws InternalErrorException {\n+\t\ttry  {\n+\t\t\treturn jdbc.query(\"select distinct \" + facilityMappingSelectQuery + \" from groups_resources\" +\n+\t\t\t\t\t\t\t\" join groups on groups_resources.group_id=groups.id\" +\n+\t\t\t\t\t\t\t\" join groups_members on groups.id=groups_members.group_id\" +\n+\t\t\t\t\t\t\t\" join members on groups_members.member_id=members.id \" +\n+\t\t\t\t\t\t\t\" join resources on groups_resources.resource_id=resources.id \" +\n+\t\t\t\t\t\t\t\" join facilities on resources.facility_id=facilities.id \" +\n+\t\t\t\t\t\t\t\" where members.user_id=? and members.status!=? and members.status!=?\",\n+\t\t\t\t\tFACILITY_MAPPER, user.getId(),\n+\t\t\t\t\tString.valueOf(Status.INVALID.getCode()), String.valueOf(Status.DISABLED.getCode()));\n+\t\t} catch (EmptyResultDataAccessException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExMjE4MQ=="}, "originalCommit": {"oid": "e612b4bc61e0e404d8d8af45554ecdf4316703c7"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2037, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}