{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NDg5MDI1", "number": 2702, "title": "CORE: Fixed condition in getAllowedFacilities(user)", "bodyText": "This method previously returned also facilities, where user\nwas not allowed (was in disabled state) since it checked\nonly invalid status of processed users members.\nIt also iterated over those members.\n\n\nNew implementation performs direct DB query to get all\nfacilities, where user is assigned with allowed members.\n\n\nAdded getAllowedFacilities(member), which can be later used\n(eg. when getting all dependant user-facility attrs for\nmember attribute on input).\nWe generally perform too many selects on resolving allowed\nstate from entities and perform their intersection later.", "createdAt": "2020-05-15T09:47:03Z", "url": "https://github.com/CESNET/perun/pull/2702", "merged": true, "mergeCommit": {"oid": "846051c21d515f8bae7b0895f8035f87a8bed061"}, "closed": true, "closedAt": "2020-05-19T08:57:39Z", "author": {"login": "zlamalp"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABche398AH2gAyNDE4NDg5MDI1OmViY2QyNTIyYWZiYWQxYTI2YTkwYTVkNmYxZTk3ZjEyMGJkMjViODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABciwL8oAH2gAyNDE4NDg5MDI1OjQyMDM4MzY3MjZhMGUyYWE1NDM1ZjE4Y2QwYjhjMjZhYmU1Mzk2YWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ebcd2522afbad1a26a90a5d6f1e97f120bd25b84", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/ebcd2522afbad1a26a90a5d6f1e97f120bd25b84", "committedDate": "2020-05-15T09:43:52Z", "message": "CORE: Fixed condition in getAllowedFacilities(user)\n\n- This method previously returned also facilities, where user\n  was not allowed (was in disabled state) since it checked\n  only invalid status of processed users members.\n  It also iterated over those members.\n- New implementation performs direct DB query to get all\n  facilities, where user is assigned with allowed members.\n\n- Added getAllowedFacilities(member), which can be later used\n  (eg. when getting all dependant user-facility attrs for\n  member attribute on input).\n  We generally perform too many selects on resolving allowed\n  state from entities and perform their intersection later."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNTA3NDU0", "url": "https://github.com/CESNET/perun/pull/2702#pullrequestreview-412507454", "createdAt": "2020-05-15T09:53:45Z", "commit": {"oid": "ebcd2522afbad1a26a90a5d6f1e97f120bd25b84"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e612b4bc61e0e404d8d8af45554ecdf4316703c7", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/e612b4bc61e0e404d8d8af45554ecdf4316703c7", "committedDate": "2020-05-18T12:27:59Z", "message": "CORE: Added tests for getAllowedFacilities(user/member)\n\n- We should verify, that new implementation matches old implementation,\n  where iteration was replaced by sql query."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MTYyMTE3", "url": "https://github.com/CESNET/perun/pull/2702#pullrequestreview-414162117", "createdAt": "2020-05-19T07:15:12Z", "commit": {"oid": "e612b4bc61e0e404d8d8af45554ecdf4316703c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MTk2NTU3", "url": "https://github.com/CESNET/perun/pull/2702#pullrequestreview-414196557", "createdAt": "2020-05-19T08:02:59Z", "commit": {"oid": "e612b4bc61e0e404d8d8af45554ecdf4316703c7"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODowMzowMFrOGXUerw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODoxMzoyN1rOGXU29Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEwNTk2Nw==", "bodyText": "You do not have to throw InternalErrorException.", "url": "https://github.com/CESNET/perun/pull/2702#discussion_r427105967", "createdAt": "2020-05-19T08:03:00Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/FacilitiesManagerBlImpl.java", "diffHunk": "@@ -467,16 +467,12 @@ public PerunBl getPerunBl() {\n \n \t@Override\n \tpublic List<Facility> getAllowedFacilities(PerunSession sess, User user) throws InternalErrorException {\n-\t\tList<Member> members = perunBl.getMembersManagerBl().getMembersByUser(sess, user);\n-\n-\t\tSet<Facility> assignedFacilities = new HashSet<>();\n-\t\tfor(Member member : members) {\n-\t\t\tif(!getPerunBl().getMembersManagerBl().haveStatus(sess, member, Status.INVALID)) {\n-\t\t\t\tassignedFacilities.addAll(this.getAssignedFacilities(sess, member));\n-\t\t\t}\n-\t\t}\n+\t\treturn getFacilitiesManagerImpl().getAllowedFacilities(sess, user);\n+\t}\n \n-\t\treturn new ArrayList<>(assignedFacilities);\n+\t@Override\n+\tpublic List<Facility> getAllowedFacilities(PerunSession sess, Member member) throws InternalErrorException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e612b4bc61e0e404d8d8af45554ecdf4316703c7"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExMjE4MQ==", "bodyText": "This exception is probably not thrown for method jdbc.query.", "url": "https://github.com/CESNET/perun/pull/2702#discussion_r427112181", "createdAt": "2020-05-19T08:13:27Z", "author": {"login": "balcirakpeter"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/FacilitiesManagerImpl.java", "diffHunk": "@@ -449,6 +449,44 @@ public void removeOwner(PerunSession sess, Facility facility, Owner owner) throw\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic List<Facility> getAllowedFacilities(PerunSession sess, User user) throws InternalErrorException {\n+\t\ttry  {\n+\t\t\treturn jdbc.query(\"select distinct \" + facilityMappingSelectQuery + \" from groups_resources\" +\n+\t\t\t\t\t\t\t\" join groups on groups_resources.group_id=groups.id\" +\n+\t\t\t\t\t\t\t\" join groups_members on groups.id=groups_members.group_id\" +\n+\t\t\t\t\t\t\t\" join members on groups_members.member_id=members.id \" +\n+\t\t\t\t\t\t\t\" join resources on groups_resources.resource_id=resources.id \" +\n+\t\t\t\t\t\t\t\" join facilities on resources.facility_id=facilities.id \" +\n+\t\t\t\t\t\t\t\" where members.user_id=? and members.status!=? and members.status!=?\",\n+\t\t\t\t\tFACILITY_MAPPER, user.getId(),\n+\t\t\t\t\tString.valueOf(Status.INVALID.getCode()), String.valueOf(Status.DISABLED.getCode()));\n+\t\t} catch (EmptyResultDataAccessException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e612b4bc61e0e404d8d8af45554ecdf4316703c7"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4203836726a0e2aa5435f18cd0b8c26abe5396ab", "author": {"user": {"login": "zlamalp", "name": "Pavel Zl\u00e1mal"}}, "url": "https://github.com/CESNET/perun/commit/4203836726a0e2aa5435f18cd0b8c26abe5396ab", "committedDate": "2020-05-19T08:28:00Z", "message": "CORE: Removed throws InternalErrorException declaration\n\n- Since InternalErrorException is RuntimeException, we don't\n  have to declare it in the API of getAllowedFacilities().\n- Removed catch clause on the EmptyResultDataAccessException,\n  since jdbc.query() doesn't throw it. Its thrown only\n  for jdbc.queryForObject() or when result set is expected\n  to have exact size."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1369, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}