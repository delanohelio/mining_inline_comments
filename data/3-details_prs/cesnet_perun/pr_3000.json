{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3Mzk2MjY5", "number": 3000, "title": "Core - createSponsoredMembersFromCSV", "bodyText": "Users using the method used for creation of multiple users are used to\nprovide the data in a csv format. Because of that, we have decided to\ncreate a new method which can work with such input.\nCreated method createSponsoredMembersFromCSV which takes data\nparameter, representing the content of the csv file; and header\nparameter, representing the header of the csv file.\nWe use the ; semicolon as a delimiter for both, the body and the\nheader.\nRequired values for now are - firstname, lastname,\nurn:perun:user:attribute-def:def:preferredMail.\nOptional values are - urn:perun:user:attribute-def:def:note.\nCreated new user:def:note attribute. This attribute can be used to\nshow some note for users in the users overview in GUI.", "createdAt": "2020-11-25T12:02:43Z", "url": "https://github.com/CESNET/perun/pull/3000", "merged": true, "mergeCommit": {"oid": "3d8b8b77b6b69adae238a16662158397fcc3bc8a"}, "closed": true, "closedAt": "2020-11-26T15:17:30Z", "author": {"login": "Vojtech-Sassmann"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf9JT6ABqjQwMzc3NDgyODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgUR3xAFqTUzOTM4NjY2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6e69e17bb70db68babc50991dd0293d4d5ddfdb", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/a6e69e17bb70db68babc50991dd0293d4d5ddfdb", "committedDate": "2020-11-25T11:53:24Z", "message": "Core - createSponsoredMembersFromCSV\n\n* Users using the method used for creation of multiple users are used to\nprovide the data in a csv format. Because of that, we have decided to\ncreate a new method which can work with such input.\n* Created method createSponsoredMembersFromCSV which takes data\nparameter, representing the content of the csv file; and header\nparameter, representing the header of the csv file.\n* We use the `;` semicolon as a delimiter for both, the body and the\nheader.\n* Required values for now are - `firstname`, `lastname`,\n`urn:perun:user:attribute-def:def:preferredMail`.\n* Optional values are - `urn:perun:user:attribute-def:def:note`.\n* Created new user:def:note attribute. This attribute can be used to\nshow some note for users in the users overview in GUI."}, "afterCommit": {"oid": "8ea63ee1b3f50c6668e07cd482d75cd895507880", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/8ea63ee1b3f50c6668e07cd482d75cd895507880", "committedDate": "2020-11-25T12:03:09Z", "message": "Core - createSponsoredMembersFromCSV\n\n* Users using the method used for creation of multiple users are used to\nprovide the data in a csv format. Because of that, we have decided to\ncreate a new method which can work with such input.\n* Created method createSponsoredMembersFromCSV which takes data\nparameter, representing the content of the csv file; and header\nparameter, representing the header of the csv file.\n* We use the `;` semicolon as a delimiter for both, the body and the\nheader.\n* Required values for now are - `firstname`, `lastname`,\n`urn:perun:user:attribute-def:def:preferredMail`.\n* Optional values are - `urn:perun:user:attribute-def:def:note`.\n* Created new user:def:note attribute. This attribute can be used to\nshow some note for users in the users overview in GUI."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODU1MDYx", "url": "https://github.com/CESNET/perun/pull/3000#pullrequestreview-538855061", "createdAt": "2020-11-25T21:25:39Z", "commit": {"oid": "8ea63ee1b3f50c6668e07cd482d75cd895507880"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMToyNTozOVrOH6EUQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMToyODo0MFrOH6EYrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY1MDE3Nw==", "bodyText": "Shouldn't here be also REGISTRAR role since it is mentioned in rpc javadoc?", "url": "https://github.com/CESNET/perun/pull/3000#discussion_r530650177", "createdAt": "2020-11-25T21:25:39Z", "author": {"login": "metodej"}, "path": "perun-base/src/main/resources/perun-roles.yml", "diffHunk": "@@ -2454,6 +2454,13 @@ perun_policies:\n     include_policies:\n       - default_policy\n \n+  createSponsoredMembersFromCSV_Vo_String_List<String>_User_policy:\n+    policy_roles:\n+      - SPONSOR: Vo\n+        SELF: User", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ea63ee1b3f50c6668e07cd482d75cd895507880"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY1MTMwOQ==", "bodyText": "Is there any reason to declare user here and not later?", "url": "https://github.com/CESNET/perun/pull/3000#discussion_r530651309", "createdAt": "2020-11-25T21:28:40Z", "author": {"login": "metodej"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/MembersManagerBlImpl.java", "diffHunk": "@@ -2673,4 +2725,116 @@ private void processMemberAfterRemovingLastSponsor(PerunSession sess, Member spo\n \t\t\tthrow new InternalErrorException(e);\n \t\t}\n \t}\n+\n+\t/**\n+\t * Creates a new user from given data and sponsors him in the given vo.\n+\t *\n+\t * @param sess session\n+\t * @param vo vo, where the new user will be sponsored\n+\t * @param namespace namespace used to define an external system where\n+\t *                  the user will have a new login generated (currently, only 'mu' namespace is supported)\n+\t * @param data values used to create the new user.\n+\t *             Required values are - firstname, lastname, urn:perun:user:attribute-def:def:preferredMail\n+\t *             Optional values are - urn:perun:user:attribute-def:def:note\n+\t * @param sponsor user, who will be set as a sponsor to the newly created user\n+\t * @param validityTo validity of the sponsorship. If null, the sponsorship will not be automatically canceled.\n+\t * @param asyncValidation switch for easier testing\n+\t * @return result of the procedure\n+\t */\n+\tprivate Map<String, String> createSingleSponsoredMemberFromCSV(PerunSession sess, Vo vo, String namespace,\n+\t                                                               Map<String, String> data, User sponsor,\n+\t                                                               LocalDate validityTo, boolean asyncValidation) {\n+\t\tfor (String requiredField : SPONSORED_MEMBER_REQUIRED_FIELDS) {\n+\t\t\tif (!data.containsKey(requiredField)) {\n+\t\t\t\tlog.error(\"Invalid data passed, missing required value: {}\", requiredField);\n+\t\t\t\tthrow new InternalErrorException(\"Invalid data passed, missing required value: \" + requiredField);\n+\t\t\t}\n+\t\t}\n+\n+\t\tSet<String> additionalValues = new HashSet<>(data.keySet());\n+\t\tadditionalValues.removeAll(SPONSORED_MEMBER_REQUIRED_FIELDS);\n+\n+\t\tfor (String valueName : additionalValues) {\n+\t\t\tif (!SPONSORED_MEMBER_ADDITIONAL_FIELDS.contains(valueName)) {\n+\t\t\t\tlog.error(\"Not allowed additional value passed, value: {}\", valueName);\n+\t\t\t\tthrow new InternalErrorException(\"Not allowed additional value passed, value: \" + valueName);\n+\t\t\t}\n+\t\t}\n+\n+\t\tMap<String, String> mapName = new HashMap<>();\n+\t\tmapName.put(\"firstName\", data.get(\"firstname\"));\n+\t\tmapName.put(\"lastName\", data.get(\"lastname\"));\n+\n+\t\tString email = data.get(A_U_PREF_MAIL);\n+\n+\t\tPasswordManagerModule module = getPerunBl().getUsersManagerBl().getPasswordManagerModule(sess, namespace);\n+\t\tString password = module.generateRandomPassword(sess, null);\n+\n+\t\t// create sponsored member\n+\t\tUser user;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ea63ee1b3f50c6668e07cd482d75cd895507880"}, "originalPosition": 143}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MDgzNTYy", "url": "https://github.com/CESNET/perun/pull/3000#pullrequestreview-539083562", "createdAt": "2020-11-26T08:24:14Z", "commit": {"oid": "8ea63ee1b3f50c6668e07cd482d75cd895507880"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwODoyNDoxNFrOH6QUFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwODoyNDoxNFrOH6QUFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg0Njc0MA==", "bodyText": "I would add something like \"... using input from CSV file.\"", "url": "https://github.com/CESNET/perun/pull/3000#discussion_r530846740", "createdAt": "2020-11-26T08:24:14Z", "author": {"login": "stavamichal"}, "path": "perun-core/src/main/java/cz/metacentrum/perun/core/api/MembersManager.java", "diffHunk": "@@ -1172,6 +1172,34 @@\n \t */\n \tRichMember setSponsoredMember(PerunSession session, Vo vo, User userToBeSponsored, String namespace, String password, User sponsor, LocalDate validityTo) throws PrivilegeException, AlreadyMemberException, LoginNotExistsException, PasswordCreationFailedException, ExtendMembershipException, WrongAttributeValueException, ExtSourceNotExistsException, WrongReferenceAttributeValueException, UserNotInRoleException, PasswordStrengthException, InvalidLoginException, AlreadySponsorException;\n \n+\t/**\n+\t * Creates new sponsored members.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ea63ee1b3f50c6668e07cd482d75cd895507880"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ea04cd457852d2b866b1d998ea2bf7bbe893aba", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/9ea04cd457852d2b866b1d998ea2bf7bbe893aba", "committedDate": "2020-11-26T14:51:06Z", "message": "Core - createSponsoredMembersFromCSV\n\n* Users using the method used for creation of multiple users are used to\nprovide the data in a csv format. Because of that, we have decided to\ncreate a new method which can work with such input.\n* Created method createSponsoredMembersFromCSV which takes data\nparameter, representing the content of the csv file; and header\nparameter, representing the header of the csv file.\n* We use the `;` semicolon as a delimiter for both, the body and the\nheader.\n* Required values for now are - `firstname`, `lastname`,\n`urn:perun:user:attribute-def:def:preferredMail`.\n* Optional values are - `urn:perun:user:attribute-def:def:note`.\n* Created new user:def:note attribute. This attribute can be used to\nshow some note for users in the users overview in GUI."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ea63ee1b3f50c6668e07cd482d75cd895507880", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/8ea63ee1b3f50c6668e07cd482d75cd895507880", "committedDate": "2020-11-25T12:03:09Z", "message": "Core - createSponsoredMembersFromCSV\n\n* Users using the method used for creation of multiple users are used to\nprovide the data in a csv format. Because of that, we have decided to\ncreate a new method which can work with such input.\n* Created method createSponsoredMembersFromCSV which takes data\nparameter, representing the content of the csv file; and header\nparameter, representing the header of the csv file.\n* We use the `;` semicolon as a delimiter for both, the body and the\nheader.\n* Required values for now are - `firstname`, `lastname`,\n`urn:perun:user:attribute-def:def:preferredMail`.\n* Optional values are - `urn:perun:user:attribute-def:def:note`.\n* Created new user:def:note attribute. This attribute can be used to\nshow some note for users in the users overview in GUI."}, "afterCommit": {"oid": "9ea04cd457852d2b866b1d998ea2bf7bbe893aba", "author": {"user": {"login": "Vojtech-Sassmann", "name": "Vojt\u011bch Sassmann"}}, "url": "https://github.com/CESNET/perun/commit/9ea04cd457852d2b866b1d998ea2bf7bbe893aba", "committedDate": "2020-11-26T14:51:06Z", "message": "Core - createSponsoredMembersFromCSV\n\n* Users using the method used for creation of multiple users are used to\nprovide the data in a csv format. Because of that, we have decided to\ncreate a new method which can work with such input.\n* Created method createSponsoredMembersFromCSV which takes data\nparameter, representing the content of the csv file; and header\nparameter, representing the header of the csv file.\n* We use the `;` semicolon as a delimiter for both, the body and the\nheader.\n* Required values for now are - `firstname`, `lastname`,\n`urn:perun:user:attribute-def:def:preferredMail`.\n* Optional values are - `urn:perun:user:attribute-def:def:note`.\n* Created new user:def:note attribute. This attribute can be used to\nshow some note for users in the users overview in GUI."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5Mzg2NjYx", "url": "https://github.com/CESNET/perun/pull/3000#pullrequestreview-539386661", "createdAt": "2020-11-26T15:00:26Z", "commit": {"oid": "9ea04cd457852d2b866b1d998ea2bf7bbe893aba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1702, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}