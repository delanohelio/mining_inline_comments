{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMTAzNjAz", "number": 893, "title": "Refactor HttpClient typed Decorators to Tracers", "bodyText": "Fix #828\nThis is the 1st PR and the rest will be in the follow-up PR.  Try to divide changes into smaller PRs.", "createdAt": "2020-08-05T02:18:45Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893", "merged": true, "mergeCommit": {"oid": "1fcb807590ff8b1b2130aa9e27d131ffd65a64ec"}, "closed": true, "closedAt": "2020-08-07T00:14:20Z", "author": {"login": "heyams"}, "timelineItems": {"totalCount": 44, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5cycGAH2gAyNDYzMTAzNjAzOjhhZTcyYTk1MDZiMmE3NDU4ODUxMjI4NDJlN2IxZTc3YzgzMzIxZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8YlSJgFqTQ2Mjk0Njc0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8ae72a9506b2a745885122842e7b1e77c83321e5", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8ae72a9506b2a745885122842e7b1e77c83321e5", "committedDate": "2020-07-28T20:52:12Z", "message": "Fix build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a6431c28007d73bcc958b4272dbd00385626600", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5a6431c28007d73bcc958b4272dbd00385626600", "committedDate": "2020-07-28T21:45:48Z", "message": "initial work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2733a270e54f5b02a2c430b1a2f803ff9f6c8df0", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2733a270e54f5b02a2c430b1a2f803ff9f6c8df0", "committedDate": "2020-07-31T21:43:34Z", "message": "Merge remote-tracking branch 'upstream/master' into heya/http-client-tracers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64d94a0bce5aed36e26b4bee278b0592976ad0b7", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/64d94a0bce5aed36e26b4bee278b0592976ad0b7", "committedDate": "2020-08-04T02:31:24Z", "message": "Change OkHttp decorators to tracers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ebff02d041c727c368ae42a25607c57103c096b", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0ebff02d041c727c368ae42a25607c57103c096b", "committedDate": "2020-08-04T15:33:25Z", "message": "Change AkkaHttpClient decorator to tracer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be1bdd3f7d80e579d75bae5fad0361fcc70a4c46", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/be1bdd3f7d80e579d75bae5fad0361fcc70a4c46", "committedDate": "2020-08-04T15:48:09Z", "message": "Change ClientDecorator to GrizzlyClientTracer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "256388685243e805ddcbce9027bd4e2f2d9f1f6f", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/256388685243e805ddcbce9027bd4e2f2d9f1f6f", "committedDate": "2020-08-04T17:08:56Z", "message": "Change NettyClientDecorator to Tracer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "996c00bbe9c32ca37dbba5aab1b49d9ccd6750e3", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/996c00bbe9c32ca37dbba5aab1b49d9ccd6750e3", "committedDate": "2020-08-04T19:26:51Z", "message": "Change netty3.8 client decorator to tracer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec93f437a5f185181137001f04a093563de3bf84", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ec93f437a5f185181137001f04a093563de3bf84", "committedDate": "2020-08-04T19:52:34Z", "message": "Update netty4.1 client decorator to tracer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e7ee630db859eb540b5e2fb4bea6dc26a428396", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9e7ee630db859eb540b5e2fb4bea6dc26a428396", "committedDate": "2020-08-04T22:58:04Z", "message": "Override startScope in child tracers when applicable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e95b26e2fa7217fd5e4dcf67fe4dc8503a212ad9", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e95b26e2fa7217fd5e4dcf67fe4dc8503a212ad9", "committedDate": "2020-08-05T01:54:00Z", "message": "Change KHttpDecorator to tracer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f401d6c079d0837a113c3ccddc371412552f4343", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f401d6c079d0837a113c3ccddc371412552f4343", "committedDate": "2020-08-05T02:12:34Z", "message": "Change HttpUrlConnectionDecorator to tracer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f0596beff28b80428ee4eb264dce79e0c6bc11b", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2f0596beff28b80428ee4eb264dce79e0c6bc11b", "committedDate": "2020-08-05T03:00:08Z", "message": "Merge remote-tracking branch 'upstream/master' into heya/http-client-tracers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzE5MDkz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-461319093", "createdAt": "2020-08-05T03:45:25Z", "commit": {"oid": "2f0596beff28b80428ee4eb264dce79e0c6bc11b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwMzo0NToyNVrOG75FOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwMzo0NToyNVrOG75FOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1NDM5NQ==", "bodyText": "this should fix the muzzle failure \ud83d\udc4d\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return new String[] {packageName + \".GrizzlyClientTracer\"};\n          \n          \n            \n                return new String[] {\n          \n          \n            \n                  packageName + \".GrizzlyClientTracer\", packageName + \".GrizzlyInjectAdapter\"\n          \n          \n            \n                };", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r465454395", "createdAt": "2020-08-05T03:45:25Z", "author": {"login": "trask"}, "path": "instrumentation/grizzly-client-1.9/src/main/java/io/opentelemetry/auto/instrumentation/grizzly/client/GrizzlyClientResponseInstrumentation.java", "diffHunk": "@@ -60,7 +60,7 @@ protected boolean defaultEnabled() {\n \n   @Override\n   public String[] helperClassNames() {\n-    return new String[] {packageName + \".ClientDecorator\"};\n+    return new String[] {packageName + \".GrizzlyClientTracer\"};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f0596beff28b80428ee4eb264dce79e0c6bc11b"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "833bf7a2edc8a569014bffdeaeba4e550fde5861", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/833bf7a2edc8a569014bffdeaeba4e550fde5861", "committedDate": "2020-08-05T15:31:45Z", "message": "Fix muzzle validation failure for grizzly client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c358ef7a119f951df69eb5062f3c13ee2b7a5507", "committedDate": "2020-08-05T18:37:15Z", "message": "Fix a ratpack client test failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxOTI4MzQw", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-461928340", "createdAt": "2020-08-05T18:42:12Z", "commit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxODo0MjoxMlrOG8WCcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxOTozMzowMFrOG8Xrtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkyODgxNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void onPeerConnection(final Span span, final CONNECTION connection) {\n          \n          \n            \n              protected void onPeerConnection(final Span span, final CONNECTION connection) {", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r465928816", "createdAt": "2020-08-05T18:42:12Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/DatabaseClientTracer.java", "diffHunk": "@@ -120,23 +119,10 @@ protected void onError(final Span span, final Throwable throwable) {\n     }\n   }\n \n-  protected void onPeerConnection(Span span, final CONNECTION connection) {\n+  public void onPeerConnection(final Span span, final CONNECTION connection) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkzNDU2OA==", "bodyText": "use callDepth = TRACER.getCallDepth(); pattern here", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r465934568", "createdAt": "2020-08-05T18:52:48Z", "author": {"login": "trask"}, "path": "instrumentation/akka-http-10.0/src/main/java/io/opentelemetry/auto/instrumentation/akkahttp/AkkaHttpClientInstrumentation.java", "diffHunk": "@@ -83,57 +81,51 @@ public AkkaHttpClientInstrumentation() {\n \n   public static class SingleRequestAdvice {\n     @Advice.OnMethodEnter(suppress = Throwable.class)\n-    public static SpanWithScope methodEnter(\n-        @Advice.Argument(value = 0, readOnly = false) HttpRequest request) {\n+    public static void methodEnter(\n+        @Advice.Argument(value = 0, readOnly = false) HttpRequest request,\n+        @Advice.Local(\"otelSpan\") Span span,\n+        @Advice.Local(\"otelScope\") Scope scope) {\n       /*\n       Versions 10.0 and 10.1 have slightly different structure that is hard to distinguish so here\n       we cast 'wider net' and avoid instrumenting twice.\n       In the future we may want to separate these, but since lots of code is reused we would need to come up\n       with way of continuing to reusing it.\n        */\n       int callDepth = CallDepthThreadLocalMap.incrementCallDepth(HttpExt.class);\n-      if (callDepth > 0) {\n-        return null;\n+      if (callDepth == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkzODI3NA==", "bodyText": "we can get rid of this extra scope\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  try (Scope scope = currentContextWith(errorSpan)) {\n          \n          \n            \n                    NettyHttpClientTracer.TRACER.endExceptionally(errorSpan, cause);\n          \n          \n            \n                  }\n          \n          \n            \n                  NettyHttpClientTracer.TRACER.endExceptionally(errorSpan, cause);", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r465938274", "createdAt": "2020-08-05T18:59:20Z", "author": {"login": "trask"}, "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/auto/instrumentation/netty/v3_8/ChannelFutureListenerInstrumentation.java", "diffHunk": "@@ -111,14 +111,11 @@ public static Scope activateScope(@Advice.Argument(0) final ChannelFuture future\n       if (continuation == null) {\n         return null;\n       }\n-      Scope parentScope = NettyHttpClientDecorator.TRACER.withSpan(continuation);\n-\n-      Span errorSpan =\n-          NettyHttpClientDecorator.TRACER.spanBuilder(\"CONNECT\").setSpanKind(CLIENT).startSpan();\n-      try (Scope scope = NettyHttpClientDecorator.TRACER.withSpan(errorSpan)) {\n-        NettyHttpClientDecorator.DECORATE.onError(errorSpan, cause);\n-        NettyHttpClientDecorator.DECORATE.beforeFinish(errorSpan);\n-        errorSpan.end();\n+      Scope parentScope = currentContextWith(continuation);\n+\n+      Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\");\n+      try (Scope scope = currentContextWith(errorSpan)) {\n+        NettyHttpClientTracer.TRACER.endExceptionally(errorSpan, cause);\n       }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkzOTkwNQ==", "bodyText": "we can get rid of this extra scope too\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  try (Scope scope = TracingContextUtils.currentContextWith(span)) {\n          \n          \n            \n                    TRACER.end(span, (HttpResponse) msg.getMessage());\n          \n          \n            \n                  }\n          \n          \n            \n                  TRACER.end(span, (HttpResponse) msg.getMessage());", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r465939905", "createdAt": "2020-08-05T19:02:17Z", "author": {"login": "trask"}, "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/auto/instrumentation/netty/v3_8/client/HttpClientResponseTracingHandler.java", "diffHunk": "@@ -54,15 +54,13 @@ public void messageReceived(final ChannelHandlerContext ctx, final MessageEvent\n     boolean finishSpan = msg.getMessage() instanceof HttpResponse;\n \n     if (span != null && finishSpan) {\n-      try (Scope scope = TRACER.withSpan(span)) {\n-        DECORATE.onResponse(span, (HttpResponse) msg.getMessage());\n-        DECORATE.beforeFinish(span);\n-        span.end();\n+      try (Scope scope = TracingContextUtils.currentContextWith(span)) {\n+        TRACER.end(span, (HttpResponse) msg.getMessage());\n       }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0MjgzNQ==", "bodyText": "we can get rid of this surrounding scope too \ud83d\udc4d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r465942835", "createdAt": "2020-08-05T19:07:59Z", "author": {"login": "trask"}, "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/auto/instrumentation/netty/v4_1/ChannelFutureListenerInstrumentation.java", "diffHunk": "@@ -105,12 +104,9 @@ public static Scope activateScope(@Advice.Argument(0) final ChannelFuture future\n       }\n       Scope parentScope = currentContextWith(parentSpan);\n \n-      Span errorSpan =\n-          NettyHttpClientDecorator.TRACER.spanBuilder(\"CONNECT\").setSpanKind(CLIENT).startSpan();\n+      Span errorSpan = NettyHttpClientTracer.TRACER.startSpan(\"CONNECT\");\n       try (Scope ignored = currentContextWith(errorSpan)) {\n-        NettyHttpClientDecorator.DECORATE.onError(errorSpan, cause);\n-        NettyHttpClientDecorator.DECORATE.beforeFinish(errorSpan);\n-        errorSpan.end();\n+        NettyHttpClientTracer.TRACER.endExceptionally(errorSpan, cause);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0NTE2OQ==", "bodyText": "ah, this is another place where we can't do TRACER.startScope() because we need two return values Scope and, in this case, requestBuilder", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r465945169", "createdAt": "2020-08-05T19:12:26Z", "author": {"login": "trask"}, "path": "instrumentation/okhttp/okhttp-2.2/src/main/java/io/opentelemetry/auto/instrumentation/okhttp/v2_2/TracingInterceptor.java", "diffHunk": "@@ -54,13 +43,10 @@ public Response intercept(final Chain chain) throws IOException {\n     try (Scope scope = withScopedContext(context)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0NTU3MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @Override\n          \n          \n            \n              protected Setter<Request> getSetter() {\n          \n          \n            \n                return null;\n          \n          \n            \n              }", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r465945570", "createdAt": "2020-08-05T19:13:12Z", "author": {"login": "trask"}, "path": "instrumentation/okhttp/okhttp-3.0/src/main/java/io/opentelemetry/auto/instrumentation/okhttp/v3_0/OkHttpClientTracer.java", "diffHunk": "@@ -53,4 +49,14 @@ protected String requestHeader(Request request, String name) {\n   protected String responseHeader(Response response, String name) {\n     return response.header(name);\n   }\n+\n+  @Override\n+  protected Setter<Request> getSetter() {\n+    return null;\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0NjAzNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Response response = null;\n          \n          \n            \n                Response response;", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r465946035", "createdAt": "2020-08-05T19:14:07Z", "author": {"login": "trask"}, "path": "instrumentation/okhttp/okhttp-3.0/src/main/java/io/opentelemetry/auto/instrumentation/okhttp/v3_0/TracingInterceptor.java", "diffHunk": "@@ -35,33 +33,22 @@\n \n   @Override\n   public Response intercept(final Chain chain) throws IOException {\n-    Span span =\n-        TRACER\n-            .spanBuilder(DECORATE.spanNameForRequest(chain.request()))\n-            .setSpanKind(CLIENT)\n-            .startSpan();\n-\n-    DECORATE.afterStart(span);\n-    DECORATE.onRequest(span, chain.request());\n-\n+    Span span = TRACER.startSpan(chain.request());\n     Context context = withSpan(span, Context.current());\n \n     Request.Builder requestBuilder = chain.request().newBuilder();\n     OpenTelemetry.getPropagators()\n         .getHttpTextFormat()\n         .inject(context, requestBuilder, RequestBuilderInjectAdapter.SETTER);\n \n-    Response response;\n+    Response response = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1NTA3MA==", "bodyText": "scope is already started with this span above, i think don't use startScope here", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r465955070", "createdAt": "2020-08-05T19:31:29Z", "author": {"login": "trask"}, "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/auto/instrumentation/netty/v4_1/client/HttpClientRequestTracingHandler.java", "diffHunk": "@@ -59,29 +53,21 @@ public void write(final ChannelHandlerContext ctx, final Object msg, final Chann\n       ctx.channel().attr(AttributeKeys.CLIENT_PARENT_ATTRIBUTE_KEY).set(null);\n     }\n \n-    Span span =\n-        TRACER.spanBuilder(DECORATE.spanNameForRequest(request)).setSpanKind(CLIENT).startSpan();\n-    try (Scope scope = TRACER.withSpan(span)) {\n-      DECORATE.afterStart(span);\n-      DECORATE.onRequest(span, request);\n-      DECORATE.onPeerConnection(span, (InetSocketAddress) ctx.channel().remoteAddress());\n-\n+    Span span = TRACER.startSpan(request);\n+    TRACER.onPeerConnection(span, (InetSocketAddress) ctx.channel().remoteAddress());\n+    Scope currentScope = null;\n+    try (Scope scope = currentContextWith(span)) {\n       // AWS calls are often signed, so we can't add headers without breaking the signature.\n       if (!request.headers().contains(\"amz-sdk-invocation-id\")) {\n-        Context context = withSpan(span, Context.current());\n-        OpenTelemetry.getPropagators()\n-            .getHttpTextFormat()\n-            .inject(context, request.headers(), SETTER);\n+        currentScope = TRACER.startScope(span, request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1NTc2Ng==", "bodyText": "can this be more consistent with the corresponding v4_1 instrumentation?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r465955766", "createdAt": "2020-08-05T19:33:00Z", "author": {"login": "trask"}, "path": "instrumentation/netty/netty-4.0/src/main/java/io/opentelemetry/auto/instrumentation/netty/v4_0/client/HttpClientRequestTracingHandler.java", "diffHunk": "@@ -59,35 +53,32 @@ public void write(final ChannelHandlerContext ctx, final Object msg, final Chann\n       ctx.channel().attr(AttributeKeys.CLIENT_PARENT_ATTRIBUTE_KEY).set(null);\n     }\n \n-    Span span =\n-        TRACER.spanBuilder(DECORATE.spanNameForRequest(request)).setSpanKind(CLIENT).startSpan();\n-    try (Scope scope = TRACER.withSpan(span)) {\n-      DECORATE.afterStart(span);\n-      DECORATE.onRequest(span, request);\n-      DECORATE.onPeerConnection(span, (InetSocketAddress) ctx.channel().remoteAddress());\n+    Scope scope = null;\n+    try {\n+      Span span = TRACER.startSpan(request);\n+      TRACER.onPeerConnection(span, (InetSocketAddress) ctx.channel().remoteAddress());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c358ef7a119f951df69eb5062f3c13ee2b7a5507"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dff8a140fb943606ba191549cb763fbb249a785f", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/dff8a140fb943606ba191549cb763fbb249a785f", "committedDate": "2020-08-05T21:04:24Z", "message": "Address feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDI2OTE1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462026915", "createdAt": "2020-08-05T21:11:21Z", "commit": {"oid": "dff8a140fb943606ba191549cb763fbb249a785f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMToxMToyMVrOG8axmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMToxMToyMVrOG8axmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAwNjQyNQ==", "bodyText": "i think u can remove this nested try, e.g.\n    Span span = TRACER.startSpan(request);\n    TRACER.onPeerConnection(span, (InetSocketAddress) ctx.getChannel().getRemoteAddress());\n    Context context = withSpan(span, Context.current());\n    OpenTelemetry.getPropagators().getHttpTextFormat().inject(context, request.headers(), SETTER);\n\n    channelTraceContext.setClientSpan(span);\n\n    try (Scope scope = currentContextWith(span)) {\n      ctx.sendDownstream(msg);\n    } catch (final Throwable throwable) {\n      TRACER.endExceptionally(span, throwable);\n      throw throwable;\n    } finally {\n      if (parentScope != null) {\n        parentScope.close();\n      }\n    }", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466006425", "createdAt": "2020-08-05T21:11:21Z", "author": {"login": "trask"}, "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/auto/instrumentation/netty/v3_8/client/HttpClientRequestTracingHandler.java", "diffHunk": "@@ -58,15 +62,20 @@ public void writeRequested(final ChannelHandlerContext ctx, final MessageEvent m\n     channelTraceContext.setClientParentSpan(TRACER.getCurrentSpan());\n \n     HttpRequest request = (HttpRequest) msg.getMessage();\n+\n     Span span = TRACER.startSpan(request);\n-    TRACER.onPeerConnection(span, (InetSocketAddress) ctx.getChannel().getRemoteAddress());\n+    try (Scope scope = currentContextWith(span)) {\n+      TRACER.onPeerConnection(span, (InetSocketAddress) ctx.getChannel().getRemoteAddress());\n+      Context context = withSpan(span, Context.current());\n+      OpenTelemetry.getPropagators().getHttpTextFormat().inject(context, request.headers(), SETTER);\n \n-    try (Scope scope = TRACER.startScope(span, request)) {\n       channelTraceContext.setClientSpan(span);\n-      ctx.sendDownstream(msg);\n-    } catch (final Throwable throwable) {\n-      TRACER.endExceptionally(span, throwable);\n-      throw throwable;\n+      try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dff8a140fb943606ba191549cb763fbb249a785f"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDM2Njkz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462036693", "createdAt": "2020-08-05T21:27:49Z", "commit": {"oid": "dff8a140fb943606ba191549cb763fbb249a785f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMToyNzo0OVrOG8bQww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMToyNzo0OVrOG8bQww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAxNDQwMw==", "bodyText": "can you update the corresponding methods in BaseDecorator to delegate to these methods?\nand the same with the methods copied from HttpClientDecorator to HttpClientTracer where possible?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466014403", "createdAt": "2020-08-05T21:27:49Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseTracer.java", "diffHunk": "@@ -127,7 +131,47 @@ public void addThrowable(final Span span, final Throwable throwable) {\n     span.recordException(throwable);\n   }\n \n-  public static void setPeer(final Span span, String peerName, String peerIp) {\n-    BaseDecorator.setPeer(span, peerName, peerIp);\n+  public void onPeerConnection(final Span span, final InetSocketAddress remoteConnection) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dff8a140fb943606ba191549cb763fbb249a785f"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f03ad35bd6278559015b6e833cab17af6e802ed0", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f03ad35bd6278559015b6e833cab17af6e802ed0", "committedDate": "2020-08-05T21:49:30Z", "message": "Update delegate for setPeer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c7e74381ac6ed73055dbe22bf725725a332d012", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2c7e74381ac6ed73055dbe22bf725725a332d012", "committedDate": "2020-08-05T21:52:05Z", "message": "Remove nested try"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDYyNzU3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462062757", "createdAt": "2020-08-05T22:19:05Z", "commit": {"oid": "593f9e1d40337812a1cddddf87d9dfd904f6c61b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMjoxOTowNVrOG8ckAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMjoxOTowNVrOG8ckAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAzNTcxMg==", "bodyText": "can you keep static import for all the BaseTracer.extract calls?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466035712", "createdAt": "2020-08-05T22:19:05Z", "author": {"login": "trask"}, "path": "instrumentation/rabbitmq-2.7/src/main/java/io/opentelemetry/auto/instrumentation/rabbitmq/amqp/RabbitChannelInstrumentation.java", "diffHunk": "@@ -253,7 +253,7 @@ public static void extractAndStartSpan(\n         Map<String, Object> headers = response.getProps().getHeaders();\n \n         if (headers != null) {\n-          SpanContext extractedContext = extract(headers, GETTER);\n+          SpanContext extractedContext = BaseTracer.extract(headers, GETTER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "593f9e1d40337812a1cddddf87d9dfd904f6c61b"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDkxOTkz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462091993", "createdAt": "2020-08-05T23:33:43Z", "commit": {"oid": "5d0fc1a614699d3f8c161d28f7456f18df478f14"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMzozMzo0M1rOG8eGeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMzozMzo0M1rOG8eGeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2MDkyMA==", "bodyText": "throwable != null already checked above\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      if (throwable != null) {\n          \n          \n            \n                        TRACER.endExceptionally(span, throwable);\n          \n          \n            \n                      }\n          \n          \n            \n                      TRACER.endExceptionally(span, throwable);", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466060920", "createdAt": "2020-08-05T23:33:43Z", "author": {"login": "trask"}, "path": "instrumentation/http-url-connection/src/main/java/io/opentelemetry/auto/instrumentation/httpurlconnection/UrlInstrumentation.java", "diffHunk": "@@ -96,8 +93,9 @@ public static void errorSpan(\n             setPeer(span, host, null);\n           }\n \n-          DECORATE.onError(span, throwable);\n-          span.end();\n+          if (throwable != null) {\n+            TRACER.endExceptionally(span, throwable);\n+          }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0fc1a614699d3f8c161d28f7456f18df478f14"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTE0OTA2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462114906", "createdAt": "2020-08-06T00:47:24Z", "commit": {"oid": "d24c82b2d2cbba64f57021262eed69347ed83ad5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMDo0NzoyNFrOG8fXOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMDo0NzoyNFrOG8fXOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA4MTU5Mg==", "bodyText": "extract is related to SERVER and CONSUMER spans, while inject is related to CLIENT and PRODUCER spans, so not sure having extract method in ClientTracer makes sense", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466081592", "createdAt": "2020-08-06T00:47:24Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/ClientTracer.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import static io.opentelemetry.OpenTelemetry.getPropagators;\n+import static io.opentelemetry.trace.TracingContextUtils.getSpan;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.SpanContext;\n+\n+public abstract class ClientTracer extends BaseTracer {\n+\n+  public static <C> SpanContext extract(final C carrier, final HttpTextFormat.Getter<C> getter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d24c82b2d2cbba64f57021262eed69347ed83ad5"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8366c3b35c5be3fac336d49a090c9831c22f2272", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8366c3b35c5be3fac336d49a090c9831c22f2272", "committedDate": "2020-08-06T01:24:23Z", "message": "Merge remote-tracking branch 'upstream/master' into heya/http-client-tracers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d24c82b2d2cbba64f57021262eed69347ed83ad5", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d24c82b2d2cbba64f57021262eed69347ed83ad5", "committedDate": "2020-08-06T00:42:20Z", "message": "Keep HttpServerTracer.extract private"}, "afterCommit": {"oid": "8366c3b35c5be3fac336d49a090c9831c22f2272", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8366c3b35c5be3fac336d49a090c9831c22f2272", "committedDate": "2020-08-06T01:24:23Z", "message": "Merge remote-tracking branch 'upstream/master' into heya/http-client-tracers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d19b1b617b9d0a2f628678865ace725fc239cc75", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d19b1b617b9d0a2f628678865ace725fc239cc75", "committedDate": "2020-08-06T01:30:06Z", "message": "Remove unnecessary null check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTU2NzM4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462156738", "createdAt": "2020-08-06T03:09:07Z", "commit": {"oid": "d19b1b617b9d0a2f628678865ace725fc239cc75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMzowOTowN1rOG8hpEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMzowOTowN1rOG8hpEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjExODkyOQ==", "bodyText": "this should fix the muzzle failure, i will go ahead and commit this suggestion to validate\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  packageName + \".client.NettyHttpClientTracer\",\n          \n          \n            \n                  packageName + \".client.NettyHttpClientTracer\",\n          \n          \n            \n                  packageName + \".client.NettyResponseInjectAdapter\",", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466118929", "createdAt": "2020-08-06T03:09:07Z", "author": {"login": "trask"}, "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/auto/instrumentation/netty/v3_8/ChannelFutureListenerInstrumentation.java", "diffHunk": "@@ -66,7 +66,7 @@ public ChannelFutureListenerInstrumentation() {\n       packageName + \".AbstractNettyAdvice\",\n       packageName + \".ChannelTraceContext\",\n       packageName + \".ChannelTraceContext$Factory\",\n-      packageName + \".client.NettyHttpClientDecorator\",\n+      packageName + \".client.NettyHttpClientTracer\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19b1b617b9d0a2f628678865ace725fc239cc75"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/e2ca42e19f153e1e217ec16ad1de59a879a14800", "committedDate": "2020-08-06T03:09:12Z", "message": "Update instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/auto/instrumentation/netty/v3_8/ChannelFutureListenerInstrumentation.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTY3MDEx", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462167011", "createdAt": "2020-08-06T03:45:49Z", "commit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTcwNzU0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462170754", "createdAt": "2020-08-06T03:59:15Z", "commit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMzo1OToxNVrOG8iaQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNDoxMjoyOFrOG8inPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzMTUyMQ==", "bodyText": "How about leaving this abstract? If it's because some libraries don't provide an easy way to abstract a Setter, it's probably still better to have them explicitly do this than having it as a default.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466131521", "createdAt": "2020-08-06T03:59:15Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import static io.opentelemetry.context.ContextUtils.withScopedContext;\n+import static io.opentelemetry.trace.TracingContextUtils.withSpan;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.auto.config.Config;\n+import io.opentelemetry.auto.instrumentation.api.MoreAttributes;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class HttpClientTracer<REQUEST, RESPONSE> extends BaseTracer {\n+\n+  private static final Logger log = LoggerFactory.getLogger(HttpClientTracer.class);\n+\n+  public static final String DEFAULT_SPAN_NAME = \"HTTP request\";\n+\n+  protected static final String USER_AGENT = \"User-Agent\";\n+\n+  protected abstract String method(REQUEST request);\n+\n+  protected abstract URI url(REQUEST request) throws URISyntaxException;\n+\n+  protected abstract Integer status(RESPONSE response);\n+\n+  protected abstract String requestHeader(REQUEST request, String name);\n+\n+  protected abstract String responseHeader(RESPONSE response, String name);\n+\n+  protected HttpTextFormat.Setter<REQUEST> getSetter() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzMTc4Ng==", "bodyText": "Also, returning null may be better, see below comment.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466131786", "createdAt": "2020-08-06T04:00:12Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import static io.opentelemetry.context.ContextUtils.withScopedContext;\n+import static io.opentelemetry.trace.TracingContextUtils.withSpan;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.auto.config.Config;\n+import io.opentelemetry.auto.instrumentation.api.MoreAttributes;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class HttpClientTracer<REQUEST, RESPONSE> extends BaseTracer {\n+\n+  private static final Logger log = LoggerFactory.getLogger(HttpClientTracer.class);\n+\n+  public static final String DEFAULT_SPAN_NAME = \"HTTP request\";\n+\n+  protected static final String USER_AGENT = \"User-Agent\";\n+\n+  protected abstract String method(REQUEST request);\n+\n+  protected abstract URI url(REQUEST request) throws URISyntaxException;\n+\n+  protected abstract Integer status(RESPONSE response);\n+\n+  protected abstract String requestHeader(REQUEST request, String name);\n+\n+  protected abstract String responseHeader(RESPONSE response, String name);\n+\n+  protected HttpTextFormat.Setter<REQUEST> getSetter() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzMTUyMQ=="}, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzMjE1Mg==", "bodyText": "If getSetter() returned null, we could probably provide a better error message\nSetter setter = getSetter();\nif (setter == null) {\n  throw new IllegalStateException(\"getSetter() not defined but calling startScope(), either getSetter must be implemented or the scope should be setup manually\");\n}", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466132152", "createdAt": "2020-08-06T04:01:33Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import static io.opentelemetry.context.ContextUtils.withScopedContext;\n+import static io.opentelemetry.trace.TracingContextUtils.withSpan;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.auto.config.Config;\n+import io.opentelemetry.auto.instrumentation.api.MoreAttributes;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class HttpClientTracer<REQUEST, RESPONSE> extends BaseTracer {\n+\n+  private static final Logger log = LoggerFactory.getLogger(HttpClientTracer.class);\n+\n+  public static final String DEFAULT_SPAN_NAME = \"HTTP request\";\n+\n+  protected static final String USER_AGENT = \"User-Agent\";\n+\n+  protected abstract String method(REQUEST request);\n+\n+  protected abstract URI url(REQUEST request) throws URISyntaxException;\n+\n+  protected abstract Integer status(RESPONSE response);\n+\n+  protected abstract String requestHeader(REQUEST request, String name);\n+\n+  protected abstract String responseHeader(RESPONSE response, String name);\n+\n+  protected HttpTextFormat.Setter<REQUEST> getSetter() {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  public Span startSpan(REQUEST request) {\n+    return startSpan(request, spanNameForRequest(request));\n+  }\n+\n+  public Scope startScope(Span span, REQUEST request) {\n+    Context context = withSpan(span, Context.current());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzMjY1MA==", "bodyText": "Should this be protected? How would we instrument an HTTP library with RPC semantics, e.g., Retrofit?\nProbably don't have to decide in this PR though.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466132650", "createdAt": "2020-08-06T04:03:33Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import static io.opentelemetry.context.ContextUtils.withScopedContext;\n+import static io.opentelemetry.trace.TracingContextUtils.withSpan;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.auto.config.Config;\n+import io.opentelemetry.auto.instrumentation.api.MoreAttributes;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class HttpClientTracer<REQUEST, RESPONSE> extends BaseTracer {\n+\n+  private static final Logger log = LoggerFactory.getLogger(HttpClientTracer.class);\n+\n+  public static final String DEFAULT_SPAN_NAME = \"HTTP request\";\n+\n+  protected static final String USER_AGENT = \"User-Agent\";\n+\n+  protected abstract String method(REQUEST request);\n+\n+  protected abstract URI url(REQUEST request) throws URISyntaxException;\n+\n+  protected abstract Integer status(RESPONSE response);\n+\n+  protected abstract String requestHeader(REQUEST request, String name);\n+\n+  protected abstract String responseHeader(RESPONSE response, String name);\n+\n+  protected HttpTextFormat.Setter<REQUEST> getSetter() {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  public Span startSpan(REQUEST request) {\n+    return startSpan(request, spanNameForRequest(request));\n+  }\n+\n+  public Scope startScope(Span span, REQUEST request) {\n+    Context context = withSpan(span, Context.current());\n+    OpenTelemetry.getPropagators().getHttpTextFormat().inject(context, request, getSetter());\n+    return withScopedContext(context);\n+  }\n+\n+  // TODO should end methods remove SPAN attribute from request as well?\n+  public void end(Span span, RESPONSE response) {\n+    onResponse(span, response);\n+    super.end(span);\n+  }\n+\n+  public void endExceptionally(Span span, RESPONSE response, Throwable throwable) {\n+    onResponse(span, response);\n+    super.endExceptionally(span, throwable);\n+  }\n+\n+  /**\n+   * Returns a new client {@link Span} if there is no client {@link Span} in the current {@link\n+   * Context}, or an invalid {@link Span} otherwise.\n+   */\n+  private Span startSpan(REQUEST request, String name) {\n+    Context context = Context.current();\n+    Span clientSpan = ClientDecorator.CONTEXT_CLIENT_SPAN_KEY.get(context);\n+\n+    if (clientSpan != null) {\n+      // We don't want to create two client spans for a given client call, suppress inner spans.\n+      return DefaultSpan.getInvalid();\n+    }\n+\n+    Span current = TracingContextUtils.getSpan(context);\n+    Span span = tracer.spanBuilder(name).setSpanKind(Kind.CLIENT).setParent(current).startSpan();\n+    onRequest(span, request);\n+    return span;\n+  }\n+\n+  private Span onRequest(final Span span, final REQUEST request) {\n+    assert span != null;\n+    if (request != null) {\n+      span.setAttribute(SemanticAttributes.HTTP_METHOD.key(), method(request));\n+\n+      String userAgent = requestHeader(request, USER_AGENT);\n+      if (userAgent != null) {\n+        SemanticAttributes.HTTP_USER_AGENT.set(span, userAgent);\n+      }\n+\n+      // Copy of HttpServerDecorator url handling\n+      try {\n+        URI url = url(request);\n+        if (url != null) {\n+          StringBuilder urlBuilder = new StringBuilder();\n+          if (url.getScheme() != null) {\n+            urlBuilder.append(url.getScheme());\n+            urlBuilder.append(\"://\");\n+          }\n+          if (url.getHost() != null) {\n+            urlBuilder.append(url.getHost());\n+            setPeer(span, url.getHost(), null);\n+            if (url.getPort() > 0) {\n+              span.setAttribute(SemanticAttributes.NET_PEER_PORT.key(), url.getPort());\n+              if (url.getPort() != 80 && url.getPort() != 443) {\n+                urlBuilder.append(\":\");\n+                urlBuilder.append(url.getPort());\n+              }\n+            }\n+          }\n+          String path = url.getPath();\n+          if (path.isEmpty()) {\n+            urlBuilder.append(\"/\");\n+          } else {\n+            urlBuilder.append(path);\n+          }\n+          String query = url.getQuery();\n+          if (query != null) {\n+            urlBuilder.append(\"?\").append(query);\n+          }\n+          String fragment = url.getFragment();\n+          if (fragment != null) {\n+            urlBuilder.append(\"#\").append(fragment);\n+          }\n+\n+          span.setAttribute(SemanticAttributes.HTTP_URL.key(), urlBuilder.toString());\n+\n+          if (Config.get().isHttpClientTagQueryString()) {\n+            span.setAttribute(MoreAttributes.HTTP_QUERY, query);\n+            span.setAttribute(MoreAttributes.HTTP_FRAGMENT, fragment);\n+          }\n+        }\n+      } catch (final Exception e) {\n+        log.debug(\"Error tagging url\", e);\n+      }\n+    }\n+    return span;\n+  }\n+\n+  private Span onResponse(final Span span, final RESPONSE response) {\n+    assert span != null;\n+    if (response != null) {\n+      Integer status = status(response);\n+      System.out.println(\"status: \" + status);\n+      if (status != null) {\n+        span.setAttribute(SemanticAttributes.HTTP_STATUS_CODE.key(), status);\n+        span.setStatus(HttpStatusConverter.statusFromHttpStatus(status));\n+      }\n+    }\n+    return span;\n+  }\n+\n+  private String spanNameForRequest(final REQUEST request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 172}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzMzg3NA==", "bodyText": "@trask Do we need this on client side even though we don't create duplicate client spans? Not something to fix in this PR though", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466133874", "createdAt": "2020-08-06T04:08:36Z", "author": {"login": "anuraaga"}, "path": "instrumentation/akka-http-10.0/src/main/java/io/opentelemetry/auto/instrumentation/akkahttp/AkkaHttpClientInstrumentation.java", "diffHunk": "@@ -83,57 +81,49 @@ public AkkaHttpClientInstrumentation() {\n \n   public static class SingleRequestAdvice {\n     @Advice.OnMethodEnter(suppress = Throwable.class)\n-    public static SpanWithScope methodEnter(\n-        @Advice.Argument(value = 0, readOnly = false) HttpRequest request) {\n+    public static void methodEnter(\n+        @Advice.Argument(value = 0, readOnly = false) HttpRequest request,\n+        @Advice.Local(\"otelSpan\") Span span,\n+        @Advice.Local(\"otelScope\") Scope scope,\n+        @Advice.Local(\"otelCallDepth\") Depth callDepth) {\n       /*\n       Versions 10.0 and 10.1 have slightly different structure that is hard to distinguish so here\n       we cast 'wider net' and avoid instrumenting twice.\n       In the future we may want to separate these, but since lots of code is reused we would need to come up\n       with way of continuing to reusing it.\n        */\n-      int callDepth = CallDepthThreadLocalMap.incrementCallDepth(HttpExt.class);\n-      if (callDepth > 0) {\n-        return null;\n+      callDepth = TRACER.getCallDepth();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzNDg0NQ==", "bodyText": "Can we extract a helper?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466134845", "createdAt": "2020-08-06T04:12:28Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import static io.opentelemetry.context.ContextUtils.withScopedContext;\n+import static io.opentelemetry.trace.TracingContextUtils.withSpan;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.auto.config.Config;\n+import io.opentelemetry.auto.instrumentation.api.MoreAttributes;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class HttpClientTracer<REQUEST, RESPONSE> extends BaseTracer {\n+\n+  private static final Logger log = LoggerFactory.getLogger(HttpClientTracer.class);\n+\n+  public static final String DEFAULT_SPAN_NAME = \"HTTP request\";\n+\n+  protected static final String USER_AGENT = \"User-Agent\";\n+\n+  protected abstract String method(REQUEST request);\n+\n+  protected abstract URI url(REQUEST request) throws URISyntaxException;\n+\n+  protected abstract Integer status(RESPONSE response);\n+\n+  protected abstract String requestHeader(REQUEST request, String name);\n+\n+  protected abstract String responseHeader(RESPONSE response, String name);\n+\n+  protected HttpTextFormat.Setter<REQUEST> getSetter() {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  public Span startSpan(REQUEST request) {\n+    return startSpan(request, spanNameForRequest(request));\n+  }\n+\n+  public Scope startScope(Span span, REQUEST request) {\n+    Context context = withSpan(span, Context.current());\n+    OpenTelemetry.getPropagators().getHttpTextFormat().inject(context, request, getSetter());\n+    return withScopedContext(context);\n+  }\n+\n+  // TODO should end methods remove SPAN attribute from request as well?\n+  public void end(Span span, RESPONSE response) {\n+    onResponse(span, response);\n+    super.end(span);\n+  }\n+\n+  public void endExceptionally(Span span, RESPONSE response, Throwable throwable) {\n+    onResponse(span, response);\n+    super.endExceptionally(span, throwable);\n+  }\n+\n+  /**\n+   * Returns a new client {@link Span} if there is no client {@link Span} in the current {@link\n+   * Context}, or an invalid {@link Span} otherwise.\n+   */\n+  private Span startSpan(REQUEST request, String name) {\n+    Context context = Context.current();\n+    Span clientSpan = ClientDecorator.CONTEXT_CLIENT_SPAN_KEY.get(context);\n+\n+    if (clientSpan != null) {\n+      // We don't want to create two client spans for a given client call, suppress inner spans.\n+      return DefaultSpan.getInvalid();\n+    }\n+\n+    Span current = TracingContextUtils.getSpan(context);\n+    Span span = tracer.spanBuilder(name).setSpanKind(Kind.CLIENT).setParent(current).startSpan();\n+    onRequest(span, request);\n+    return span;\n+  }\n+\n+  private Span onRequest(final Span span, final REQUEST request) {\n+    assert span != null;\n+    if (request != null) {\n+      span.setAttribute(SemanticAttributes.HTTP_METHOD.key(), method(request));\n+\n+      String userAgent = requestHeader(request, USER_AGENT);\n+      if (userAgent != null) {\n+        SemanticAttributes.HTTP_USER_AGENT.set(span, userAgent);\n+      }\n+\n+      // Copy of HttpServerDecorator url handling", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 110}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMzUyNzY2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462352766", "createdAt": "2020-08-06T09:21:53Z", "commit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwOToyMTo1M1rOG8q4YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwOTo1OTo0OVrOG8s5Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI3MDMwNA==", "bodyText": "Unless other maintainers object, I propose to remove all these asserts", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466270304", "createdAt": "2020-08-06T09:21:53Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseTracer.java", "diffHunk": "@@ -127,7 +131,47 @@ public void addThrowable(final Span span, final Throwable throwable) {\n     span.recordException(throwable);\n   }\n \n+  public void onPeerConnection(final Span span, final InetSocketAddress remoteConnection) {\n+    assert span != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI5Mzg5NA==", "bodyText": "HttpServerTracer and its subclasses tried to reduce public API as much as possible. This includes hiding all attribute setting behind startSpan method. So that end-users would need to call as few methods as possible. Ideally just startSpan and startScope. Please do the same here.\nPass an object, that represent a connection for a given library, into startSpan method and call onPeerConnection method (which should become protected) from startSpan. Also take a look, if HttpServerTracer.onConnection method should be pulled up into BaseTracer", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466293894", "createdAt": "2020-08-06T09:42:33Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseTracer.java", "diffHunk": "@@ -127,7 +131,47 @@ public void addThrowable(final Span span, final Throwable throwable) {\n     span.recordException(throwable);\n   }\n \n+  public void onPeerConnection(final Span span, final InetSocketAddress remoteConnection) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI5NjU1Mg==", "bodyText": "What do you mean \"some libraries don't provide an easy way to abstract a Setter\"? Are there libraries that cannot propagate trace context?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466296552", "createdAt": "2020-08-06T09:47:21Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import static io.opentelemetry.context.ContextUtils.withScopedContext;\n+import static io.opentelemetry.trace.TracingContextUtils.withSpan;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.auto.config.Config;\n+import io.opentelemetry.auto.instrumentation.api.MoreAttributes;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class HttpClientTracer<REQUEST, RESPONSE> extends BaseTracer {\n+\n+  private static final Logger log = LoggerFactory.getLogger(HttpClientTracer.class);\n+\n+  public static final String DEFAULT_SPAN_NAME = \"HTTP request\";\n+\n+  protected static final String USER_AGENT = \"User-Agent\";\n+\n+  protected abstract String method(REQUEST request);\n+\n+  protected abstract URI url(REQUEST request) throws URISyntaxException;\n+\n+  protected abstract Integer status(RESPONSE response);\n+\n+  protected abstract String requestHeader(REQUEST request, String name);\n+\n+  protected abstract String responseHeader(RESPONSE response, String name);\n+\n+  protected HttpTextFormat.Setter<REQUEST> getSetter() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzMTUyMQ=="}, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI5NzA0Ng==", "bodyText": "This comment is not relevant here. You don't attach span to requests.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466297046", "createdAt": "2020-08-06T09:48:17Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import static io.opentelemetry.context.ContextUtils.withScopedContext;\n+import static io.opentelemetry.trace.TracingContextUtils.withSpan;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.auto.config.Config;\n+import io.opentelemetry.auto.instrumentation.api.MoreAttributes;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class HttpClientTracer<REQUEST, RESPONSE> extends BaseTracer {\n+\n+  private static final Logger log = LoggerFactory.getLogger(HttpClientTracer.class);\n+\n+  public static final String DEFAULT_SPAN_NAME = \"HTTP request\";\n+\n+  protected static final String USER_AGENT = \"User-Agent\";\n+\n+  protected abstract String method(REQUEST request);\n+\n+  protected abstract URI url(REQUEST request) throws URISyntaxException;\n+\n+  protected abstract Integer status(RESPONSE response);\n+\n+  protected abstract String requestHeader(REQUEST request, String name);\n+\n+  protected abstract String responseHeader(RESPONSE response, String name);\n+\n+  protected HttpTextFormat.Setter<REQUEST> getSetter() {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  public Span startSpan(REQUEST request) {\n+    return startSpan(request, spanNameForRequest(request));\n+  }\n+\n+  public Scope startScope(Span span, REQUEST request) {\n+    Context context = withSpan(span, Context.current());\n+    OpenTelemetry.getPropagators().getHttpTextFormat().inject(context, request, getSetter());\n+    return withScopedContext(context);\n+  }\n+\n+  // TODO should end methods remove SPAN attribute from request as well?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI5OTQ4Ng==", "bodyText": "@trask In case of SERVER spans you wanted to let instrumentations to check for a presence of SERVER span and for them to decide to skip the call to startSpan. Here it is left for the Tracer to decide. We have to choose one consistent pattern.\nI prefer to encapsulate this decision, as it is made here.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466299486", "createdAt": "2020-08-06T09:52:53Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import static io.opentelemetry.context.ContextUtils.withScopedContext;\n+import static io.opentelemetry.trace.TracingContextUtils.withSpan;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.auto.config.Config;\n+import io.opentelemetry.auto.instrumentation.api.MoreAttributes;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class HttpClientTracer<REQUEST, RESPONSE> extends BaseTracer {\n+\n+  private static final Logger log = LoggerFactory.getLogger(HttpClientTracer.class);\n+\n+  public static final String DEFAULT_SPAN_NAME = \"HTTP request\";\n+\n+  protected static final String USER_AGENT = \"User-Agent\";\n+\n+  protected abstract String method(REQUEST request);\n+\n+  protected abstract URI url(REQUEST request) throws URISyntaxException;\n+\n+  protected abstract Integer status(RESPONSE response);\n+\n+  protected abstract String requestHeader(REQUEST request, String name);\n+\n+  protected abstract String responseHeader(RESPONSE response, String name);\n+\n+  protected HttpTextFormat.Setter<REQUEST> getSetter() {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  public Span startSpan(REQUEST request) {\n+    return startSpan(request, spanNameForRequest(request));\n+  }\n+\n+  public Scope startScope(Span span, REQUEST request) {\n+    Context context = withSpan(span, Context.current());\n+    OpenTelemetry.getPropagators().getHttpTextFormat().inject(context, request, getSetter());\n+    return withScopedContext(context);\n+  }\n+\n+  // TODO should end methods remove SPAN attribute from request as well?\n+  public void end(Span span, RESPONSE response) {\n+    onResponse(span, response);\n+    super.end(span);\n+  }\n+\n+  public void endExceptionally(Span span, RESPONSE response, Throwable throwable) {\n+    onResponse(span, response);\n+    super.endExceptionally(span, throwable);\n+  }\n+\n+  /**\n+   * Returns a new client {@link Span} if there is no client {@link Span} in the current {@link\n+   * Context}, or an invalid {@link Span} otherwise.\n+   */\n+  private Span startSpan(REQUEST request, String name) {\n+    Context context = Context.current();\n+    Span clientSpan = ClientDecorator.CONTEXT_CLIENT_SPAN_KEY.get(context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI5OTk5MQ==", "bodyText": "And this is duplicated with HttpServerTracer. Certainly have to de-duplicate.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466299991", "createdAt": "2020-08-06T09:53:59Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import static io.opentelemetry.context.ContextUtils.withScopedContext;\n+import static io.opentelemetry.trace.TracingContextUtils.withSpan;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.auto.config.Config;\n+import io.opentelemetry.auto.instrumentation.api.MoreAttributes;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class HttpClientTracer<REQUEST, RESPONSE> extends BaseTracer {\n+\n+  private static final Logger log = LoggerFactory.getLogger(HttpClientTracer.class);\n+\n+  public static final String DEFAULT_SPAN_NAME = \"HTTP request\";\n+\n+  protected static final String USER_AGENT = \"User-Agent\";\n+\n+  protected abstract String method(REQUEST request);\n+\n+  protected abstract URI url(REQUEST request) throws URISyntaxException;\n+\n+  protected abstract Integer status(RESPONSE response);\n+\n+  protected abstract String requestHeader(REQUEST request, String name);\n+\n+  protected abstract String responseHeader(RESPONSE response, String name);\n+\n+  protected HttpTextFormat.Setter<REQUEST> getSetter() {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  public Span startSpan(REQUEST request) {\n+    return startSpan(request, spanNameForRequest(request));\n+  }\n+\n+  public Scope startScope(Span span, REQUEST request) {\n+    Context context = withSpan(span, Context.current());\n+    OpenTelemetry.getPropagators().getHttpTextFormat().inject(context, request, getSetter());\n+    return withScopedContext(context);\n+  }\n+\n+  // TODO should end methods remove SPAN attribute from request as well?\n+  public void end(Span span, RESPONSE response) {\n+    onResponse(span, response);\n+    super.end(span);\n+  }\n+\n+  public void endExceptionally(Span span, RESPONSE response, Throwable throwable) {\n+    onResponse(span, response);\n+    super.endExceptionally(span, throwable);\n+  }\n+\n+  /**\n+   * Returns a new client {@link Span} if there is no client {@link Span} in the current {@link\n+   * Context}, or an invalid {@link Span} otherwise.\n+   */\n+  private Span startSpan(REQUEST request, String name) {\n+    Context context = Context.current();\n+    Span clientSpan = ClientDecorator.CONTEXT_CLIENT_SPAN_KEY.get(context);\n+\n+    if (clientSpan != null) {\n+      // We don't want to create two client spans for a given client call, suppress inner spans.\n+      return DefaultSpan.getInvalid();\n+    }\n+\n+    Span current = TracingContextUtils.getSpan(context);\n+    Span span = tracer.spanBuilder(name).setSpanKind(Kind.CLIENT).setParent(current).startSpan();\n+    onRequest(span, request);\n+    return span;\n+  }\n+\n+  private Span onRequest(final Span span, final REQUEST request) {\n+    assert span != null;\n+    if (request != null) {\n+      span.setAttribute(SemanticAttributes.HTTP_METHOD.key(), method(request));\n+\n+      String userAgent = requestHeader(request, USER_AGENT);\n+      if (userAgent != null) {\n+        SemanticAttributes.HTTP_USER_AGENT.set(span, userAgent);\n+      }\n+\n+      // Copy of HttpServerDecorator url handling", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEzNDg0NQ=="}, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMwMDgwMA==", "bodyText": "Ok, probably actual call to this method should happen in HttpServerTracer.startSpan and HttpClientTracer.startSpan", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466300800", "createdAt": "2020-08-06T09:55:21Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseTracer.java", "diffHunk": "@@ -127,7 +131,47 @@ public void addThrowable(final Span span, final Throwable throwable) {\n     span.recordException(throwable);\n   }\n \n+  public void onPeerConnection(final Span span, final InetSocketAddress remoteConnection) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI5Mzg5NA=="}, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMwMzMxNQ==", "bodyText": "This already happens inside Tracer, right?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466303315", "createdAt": "2020-08-06T09:59:49Z", "author": {"login": "iNikem"}, "path": "instrumentation/http-url-connection/src/main/java/io/opentelemetry/auto/instrumentation/httpurlconnection/UrlInstrumentation.java", "diffHunk": "@@ -85,19 +83,17 @@ public static void errorSpan(\n         String protocol = url.getProtocol();\n         protocol = protocol != null ? protocol : \"url\";\n \n-        Span span = TRACER.spanBuilder(protocol + \".request\").setSpanKind(CLIENT).startSpan();\n-\n+        Span span = TRACER.startSpan(protocol + \".request\");\n         try (Scope scope = currentContextWith(span)) {\n           span.setAttribute(SemanticAttributes.HTTP_URL.key(), url.toString());\n           span.setAttribute(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNTk3MjAz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462597203", "createdAt": "2020-08-06T14:52:58Z", "commit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNDo1Mjo1OFrOG83J5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNTowNjoyMFrOG83vOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ3MTM5OQ==", "bodyText": "Should these be in a different package?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466471399", "createdAt": "2020-08-06T14:52:58Z", "author": {"login": "tylerbenson"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ3NDYwNg==", "bodyText": "This doesn't seem like something that should be on the Tracer since it only really applies to automatic instrumentation, right?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466474606", "createdAt": "2020-08-06T14:57:25Z", "author": {"login": "tylerbenson"}, "path": "instrumentation/akka-http-10.0/src/main/java/io/opentelemetry/auto/instrumentation/akkahttp/AkkaHttpClientTracer.java", "diffHunk": "@@ -17,19 +17,21 @@\n package io.opentelemetry.auto.instrumentation.akkahttp;\n \n import akka.http.javadsl.model.HttpHeader;\n+import akka.http.scaladsl.HttpExt;\n import akka.http.scaladsl.model.HttpRequest;\n import akka.http.scaladsl.model.HttpResponse;\n-import io.opentelemetry.OpenTelemetry;\n-import io.opentelemetry.auto.bootstrap.instrumentation.decorator.HttpClientDecorator;\n-import io.opentelemetry.trace.Tracer;\n+import io.opentelemetry.auto.bootstrap.CallDepthThreadLocalMap;\n+import io.opentelemetry.auto.bootstrap.CallDepthThreadLocalMap.Depth;\n+import io.opentelemetry.auto.bootstrap.instrumentation.decorator.HttpClientTracer;\n import java.net.URI;\n import java.net.URISyntaxException;\n \n-public class AkkaHttpClientDecorator extends HttpClientDecorator<HttpRequest, HttpResponse> {\n-  public static final AkkaHttpClientDecorator DECORATE = new AkkaHttpClientDecorator();\n+public class AkkaHttpClientTracer extends HttpClientTracer<HttpRequest, HttpResponse> {\n+  public static final AkkaHttpClientTracer TRACER = new AkkaHttpClientTracer();\n \n-  public static final Tracer TRACER =\n-      OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto.akka-http-10.0\");\n+  public Depth getCallDepth() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ4MDk1NQ==", "bodyText": "Consider adding a comment when this should be used vs the one from the parent.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466480955", "createdAt": "2020-08-06T15:06:20Z", "author": {"login": "tylerbenson"}, "path": "instrumentation/http-url-connection/src/main/java/io/opentelemetry/auto/instrumentation/httpurlconnection/HttpUrlConnectionTracer.java", "diffHunk": "@@ -53,4 +51,14 @@ protected String requestHeader(HttpURLConnection httpURLConnection, String name)\n   protected String responseHeader(Integer integer, String name) {\n     return null;\n   }\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.http-url-connection\";\n+  }\n+\n+  @Override\n+  public Span startSpan(String spanName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ca42e19f153e1e217ec16ad1de59a879a14800"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ef5249f9015dd06009364286917171f00179f89", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9ef5249f9015dd06009364286917171f00179f89", "committedDate": "2020-08-06T18:33:47Z", "message": "Remove asserts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a95cc31332223c70f60730f706c51fc103095e23", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a95cc31332223c70f60730f706c51fc103095e23", "committedDate": "2020-08-06T18:53:51Z", "message": "Add a comment for overriding startSpan(String spanName)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8810fe64419671a0788940bffab3cd3904479a08", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8810fe64419671a0788940bffab3cd3904479a08", "committedDate": "2020-08-06T18:57:50Z", "message": "Merge branch 'heya/http-client-tracers' of https://github.com/heyams/opentelemetry-java-instrumentation into heya/http-client-tracers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19faa2dc4a32e112fa8eae185744ec76c16dcaaf", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/19faa2dc4a32e112fa8eae185744ec76c16dcaaf", "committedDate": "2020-08-06T19:05:01Z", "message": "Remove an irrelevant comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fb48a7772203a1b5ba563e96057c27fa31741db", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9fb48a7772203a1b5ba563e96057c27fa31741db", "committedDate": "2020-08-06T19:16:48Z", "message": "Throw an exception when getSetter is null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "286328f2fcde74cf22827e06aee4ca69ac19e12c", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/286328f2fcde74cf22827e06aee4ca69ac19e12c", "committedDate": "2020-08-06T20:11:30Z", "message": "Change onPeerConnection to static"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f3bb12b8a244d7f98b4234d637a71efdf548dbe", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5f3bb12b8a244d7f98b4234d637a71efdf548dbe", "committedDate": "2020-08-06T21:03:29Z", "message": "Merge remote-tracking branch 'upstream/master' into heya/http-client-tracers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyOTI4MDIx", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462928021", "createdAt": "2020-08-06T22:54:12Z", "commit": {"oid": "5f3bb12b8a244d7f98b4234d637a71efdf548dbe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMjo1NDoxMlrOG9G0MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMjo1NDoxMlrOG9G0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyNzk4NQ==", "bodyText": "I still think abstract is better than providing a default implementation here - it's easier to forget to implement this method for the common case where we do have setter right? Subclasses explicitly say they're not providing a setter.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#discussion_r466727985", "createdAt": "2020-08-06T22:54:12Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import static io.opentelemetry.context.ContextUtils.withScopedContext;\n+import static io.opentelemetry.trace.TracingContextUtils.withSpan;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.auto.config.Config;\n+import io.opentelemetry.auto.instrumentation.api.MoreAttributes;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.context.propagation.HttpTextFormat.Setter;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import io.opentelemetry.trace.attributes.SemanticAttributes;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public abstract class HttpClientTracer<REQUEST, RESPONSE> extends BaseTracer {\n+\n+  private static final Logger log = LoggerFactory.getLogger(HttpClientTracer.class);\n+\n+  public static final String DEFAULT_SPAN_NAME = \"HTTP request\";\n+\n+  protected static final String USER_AGENT = \"User-Agent\";\n+\n+  protected abstract String method(REQUEST request);\n+\n+  protected abstract URI url(REQUEST request) throws URISyntaxException;\n+\n+  protected abstract Integer status(RESPONSE response);\n+\n+  protected abstract String requestHeader(REQUEST request, String name);\n+\n+  protected abstract String responseHeader(RESPONSE response, String name);\n+\n+  protected HttpTextFormat.Setter<REQUEST> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f3bb12b8a244d7f98b4234d637a71efdf548dbe"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad96a25d53c2d0bc0b234727a1dc509573d658dc", "author": {"user": {"login": "heyams", "name": "Helen Y."}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ad96a25d53c2d0bc0b234727a1dc509573d658dc", "committedDate": "2020-08-06T23:38:18Z", "message": "Change getSetter() to be abstract"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyOTQ2NzQ2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/893#pullrequestreview-462946746", "createdAt": "2020-08-06T23:39:59Z", "commit": {"oid": "ad96a25d53c2d0bc0b234727a1dc509573d658dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2935, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}