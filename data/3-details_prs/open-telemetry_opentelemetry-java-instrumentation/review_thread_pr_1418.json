{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1NjU1MjQ1", "number": 1418, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwMzozNjozM1rOExvWzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjozMDo0MlrOEyMxzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNTkxNTY0OnYy", "diffSide": "RIGHT", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "isResolved": true, "comments": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwMzozNjozM1rOHn_9sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDo1MjoxMFrOHorXIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng==", "bodyText": "Isn't this too specific a use case to put in BaseTracer?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511704496", "createdAt": "2020-10-26T03:36:33Z", "author": {"login": "anuraaga"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDYzMw==", "bodyText": "Also is context the only way? I thought servlet has getServletPath and getRequestUri we'd be able to compute the context path based on it?\nhttps://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511704633", "createdAt": "2020-10-26T03:37:25Z", "author": {"login": "anuraaga"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNjE3MA==", "bodyText": "Isn't this too specific a use case to put in BaseTracer?\n\nThat's a good idea, I can move this to something like an ApplicationRoot utility class in instrumentation-api\n\nAlso is context the only way? I thought servlet has getServletPath and getRequestUri we'd be able to compute the context path based on it?\n\nI'm not following this suggestion, can you expand?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511706170", "createdAt": "2020-10-26T03:45:43Z", "author": {"login": "trask"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNjU3OQ==", "bodyText": "I'm not following this suggestion, can you expand?\n\nI also might not be following the problem :) But if the problem is the URL we populate is incomplete, I would assume something on HttpServlerRequest would be sufficient to provide the complete URL?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511706579", "createdAt": "2020-10-26T03:48:21Z", "author": {"login": "anuraaga"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNzA2NA==", "bodyText": "Got it, ya, that's what this PR does. When servlet starts, it captures request.getContextPath() and stores in the context, so that later on, when routes are updated, they can pre-pend the context path in front of the route.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511707064", "createdAt": "2020-10-26T03:50:57Z", "author": {"login": "trask"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcxNDExMQ==", "bodyText": "I see I think I follow - there are places we compute the route and update name, but have no access to the HttpServletRequest. It feels a bit weird to put a string into Context like this, I'd probably put HttpServletRequest itself to indicate we are propagating information about the request.\nAlso instead of ApplicationRoot utility, I was hoping this could go in HttpServletTracer since it's specific to servlet.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511714111", "createdAt": "2020-10-26T04:28:43Z", "author": {"login": "anuraaga"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcxNTU4NQ==", "bodyText": "I see I think I follow - there are places we compute the route and update name, but have no access to the HttpServletRequest. It feels a bit weird to put a string into Context like this, I'd probably put HttpServletRequest itself to indicate we are propagating information about the request.\n\nWe can't have a ContextKey<HttpServletRequest> in instrumentation-api, since instrumentation-api doesn't have access to HttpServletRequest.\nWe could do ContextKey<Object> and cast it when we pull it out, but that doesn't feel great either.\n\nAlso instead of ApplicationRoot utility, I was hoping this could go in HttpServletTracer since it's specific to servlet.\n\nIt needs to be accessed from Tracers which don't extend HttpServletTracer.\nWe could still put it in HttpServletTracer, and access it from those Tracers, do u think that's better? I don't have strong opinion.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511715585", "createdAt": "2020-10-26T04:35:37Z", "author": {"login": "trask"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyMjg5OQ==", "bodyText": "Perhaps we could have a servlet-utils with a static helper then - actually I had no idea webflux works with servlet since our instrumentation doesn't have a dependency on it! So it seems to make sense that we could have a package dedicated to helping out servlet implementations. Having it outside the main instrumentation API would make me a lot less anxious.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511722899", "createdAt": "2020-10-26T05:12:57Z", "author": {"login": "anuraaga"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyNTQ2Ng==", "bodyText": "That being said if my below suggestions make sense I may have been able to avoid the propagation requirement \ud83e\udd1e", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511725466", "createdAt": "2020-10-26T05:25:21Z", "author": {"login": "anuraaga"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczOTkxNg==", "bodyText": "I think we need propagation at least for JAX-RS.\nI agree there's danger of making it look too general, and people thinking that they need to always use it for all instrumentation.\nA new module :instrumentation:servlet:servlet-context-path that can be imported into other instrumentation as needed seems nice.\nThough if the initial filter/servlet isn't in the same class loader as the jax-rs resource, that may not work, because we will inject the class w/ context key into each place, and they won't share.\nWhat do you think of putting the context key in io.opentelemetry.instrumentation.api.servlet.ContextPath, to make it look less general?\nOr create servlet-context-path as a secondary \"instrumentation-api\" that we include in the bootstrap class loader?\nOr...", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511739916", "createdAt": "2020-10-26T06:25:40Z", "author": {"login": "trask"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NjMxMg==", "bodyText": "\"Secondar api\" \ud83d\ude31\nIs this whole problem specific to servlets? Or for other HTTP Server spans as well? E.g. Ratpack or Ktor or I-dont-know-what-else?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511746312", "createdAt": "2020-10-26T06:48:12Z", "author": {"login": "iNikem"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc3NDQ5Mg==", "bodyText": "Yeah I'm trying to find a way to avoid extra API for a seemingly very specific use case.\nI have a theory that any request handled by servlet always has access to the HttpServletRequest somehow :) It's one of the reasons I've been persistent here.\nAdding a break point at updateSpanNames and see what's available when running the tests has helped find some options I think.\nI found for resteasy, we can get HttpServletRequest anywhere with this static call ResteasyProviderFactory.getContextData(HttpServletRequest.class)\nFor jersey, it's not HttpServletRequest but we seem to have a similar static call ContextHandler.getCurrentContext().getContextPath().\nSo is it possible for us to use these to solve the problem at the bottom layer? I guess it means introducing e.g., ResteasyAnnotationsTracer extends JaxRsAnnotationsTracer for the implementation-specific extraction but doesn't seem too bad.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511774492", "createdAt": "2020-10-26T08:03:42Z", "author": {"login": "anuraaga"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwMDQ5Nw==", "bodyText": "@anuraaga It looks like ContextHandler.getCurrentContext().getContextPath() is for jetty not jersey (well, would work for jersey running in jetty).", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512400497", "createdAt": "2020-10-27T03:49:50Z", "author": {"login": "trask"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxNTUyMQ==", "bodyText": "Is this whole problem specific to servlets? Or for other HTTP Server spans as well? E.g. Ratpack or Ktor or I-dont-know-what-else?\n\nIt's specific to any routing framework that runs inside of a servlet container. I think I was trying to generalize it too much to \"application root\", but better to keep it specific to \"servlet context path\".", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512415521", "createdAt": "2020-10-27T04:52:10Z", "author": {"login": "trask"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/tracer/BaseTracer.java", "diffHunk": "@@ -30,6 +30,11 @@\n   public static final ContextKey<Span> CONTEXT_CLIENT_SPAN_KEY =\n       ContextKey.named(\"opentelemetry-trace-auto-client-span-key\");\n \n+  // Keeps track of the application root (e.g. servlet context path) that needs to be prepended", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcwNDQ5Ng=="}, "originalCommit": {"oid": "9ac0afc7c67684ecd763595ad1c41b5d18639b96"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjA1MzAyOnYy", "diffSide": "RIGHT", "path": "instrumentation/jaxrs/jaxrs-1.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v1_0/JaxRsAnnotationsTracer.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNToxNjo1MVrOHoBIqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMzowMzo0NFrOHopu8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyMzY4OQ==", "bodyText": "I suspect we don't need this since we calculate the server span name correctly in the tracer IIUC. The fact that no tests changed means either this update isn't necessary or we're missing a test :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511723689", "createdAt": "2020-10-26T05:16:51Z", "author": {"login": "anuraaga"}, "path": "instrumentation/jaxrs/jaxrs-1.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v1_0/JaxRsAnnotationsTracer.java", "diffHunk": "@@ -26,23 +27,24 @@\n \n   public Span startSpan(Class<?> target, Method method) {\n     String pathBasedSpanName = getPathSpanName(target, method);\n-    Span serverSpan = BaseTracer.getCurrentServerSpan();\n+    Context context = Context.current();\n+    Span serverSpan = BaseTracer.getCurrentServerSpan(context);\n \n     // When jax-rs is the root, we want to name using the path, otherwise use the class/method.\n     String spanName;\n     if (serverSpan == null) {\n       spanName = pathBasedSpanName;\n     } else {\n       spanName = spanNameForMethod(target, method);\n-      updateServerSpanName(serverSpan, pathBasedSpanName);\n+      updateServerSpanName(context, serverSpan, pathBasedSpanName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db6d34dd5fb172884da95f93ef49677b048a7c0"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczNDcyNQ==", "bodyText": "we didn't have any JAX-RS test that used a non-root context path, I added one now", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511734725", "createdAt": "2020-10-26T06:05:35Z", "author": {"login": "trask"}, "path": "instrumentation/jaxrs/jaxrs-1.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v1_0/JaxRsAnnotationsTracer.java", "diffHunk": "@@ -26,23 +27,24 @@\n \n   public Span startSpan(Class<?> target, Method method) {\n     String pathBasedSpanName = getPathSpanName(target, method);\n-    Span serverSpan = BaseTracer.getCurrentServerSpan();\n+    Context context = Context.current();\n+    Span serverSpan = BaseTracer.getCurrentServerSpan(context);\n \n     // When jax-rs is the root, we want to name using the path, otherwise use the class/method.\n     String spanName;\n     if (serverSpan == null) {\n       spanName = pathBasedSpanName;\n     } else {\n       spanName = spanNameForMethod(target, method);\n-      updateServerSpanName(serverSpan, pathBasedSpanName);\n+      updateServerSpanName(context, serverSpan, pathBasedSpanName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyMzY4OQ=="}, "originalCommit": {"oid": "8db6d34dd5fb172884da95f93ef49677b048a7c0"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1MjU2OQ==", "bodyText": "But you did not for JAX-RS 1.0 :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511752569", "createdAt": "2020-10-26T07:08:33Z", "author": {"login": "iNikem"}, "path": "instrumentation/jaxrs/jaxrs-1.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v1_0/JaxRsAnnotationsTracer.java", "diffHunk": "@@ -26,23 +27,24 @@\n \n   public Span startSpan(Class<?> target, Method method) {\n     String pathBasedSpanName = getPathSpanName(target, method);\n-    Span serverSpan = BaseTracer.getCurrentServerSpan();\n+    Context context = Context.current();\n+    Span serverSpan = BaseTracer.getCurrentServerSpan(context);\n \n     // When jax-rs is the root, we want to name using the path, otherwise use the class/method.\n     String spanName;\n     if (serverSpan == null) {\n       spanName = pathBasedSpanName;\n     } else {\n       spanName = spanNameForMethod(target, method);\n-      updateServerSpanName(serverSpan, pathBasedSpanName);\n+      updateServerSpanName(context, serverSpan, pathBasedSpanName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyMzY4OQ=="}, "originalCommit": {"oid": "8db6d34dd5fb172884da95f93ef49677b048a7c0"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4ODg0OA==", "bodyText": "I added comment below about missing tests for jaxrs-1.0 and webflux", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512388848", "createdAt": "2020-10-27T03:03:44Z", "author": {"login": "trask"}, "path": "instrumentation/jaxrs/jaxrs-1.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v1_0/JaxRsAnnotationsTracer.java", "diffHunk": "@@ -26,23 +27,24 @@\n \n   public Span startSpan(Class<?> target, Method method) {\n     String pathBasedSpanName = getPathSpanName(target, method);\n-    Span serverSpan = BaseTracer.getCurrentServerSpan();\n+    Context context = Context.current();\n+    Span serverSpan = BaseTracer.getCurrentServerSpan(context);\n \n     // When jax-rs is the root, we want to name using the path, otherwise use the class/method.\n     String spanName;\n     if (serverSpan == null) {\n       spanName = pathBasedSpanName;\n     } else {\n       spanName = spanNameForMethod(target, method);\n-      updateServerSpanName(serverSpan, pathBasedSpanName);\n+      updateServerSpanName(context, serverSpan, pathBasedSpanName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyMzY4OQ=="}, "originalCommit": {"oid": "8db6d34dd5fb172884da95f93ef49677b048a7c0"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjA1NTAyOnYy", "diffSide": "RIGHT", "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-common/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v2_0/JaxRsAnnotationsTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNToxODozMFrOHoBJ2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNjowNzowNlrOHoB1Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyMzk5NA==", "bodyText": "Here also I suspect updateSpanName(serverSpan) isn't doing anything, and for the non-serverspan case we don't need the getApplicationRoot call", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511723994", "createdAt": "2020-10-26T05:18:30Z", "author": {"login": "anuraaga"}, "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-common/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v2_0/JaxRsAnnotationsTracer.java", "diffHunk": "@@ -32,14 +33,16 @@ public Span startSpan(Class<?> target, Method method) {\n     // We create span and immediately update its name\n     // We do that in order to reuse logic inside updateSpanNames method, which is used externally as\n     // well.\n-    Span span = tracer.spanBuilder(\"jax-rs.request\").startSpan();\n-    updateSpanNames(span, BaseTracer.getCurrentServerSpan(), target, method);\n+    Context context = Context.current();\n+    Span span = tracer.spanBuilder(\"jax-rs.request\").setParent(context).startSpan();\n+    updateSpanNames(context, span, BaseTracer.getCurrentServerSpan(context), target, method);\n     return span;\n   }\n \n-  public void updateSpanNames(Span span, Span serverSpan, Class<?> target, Method method) {\n-    // When jax-rs is the root, we want to name using the path, otherwise use the class/method.\n-    String pathBasedSpanName = getPathSpanName(target, method);\n+  public void updateSpanNames(\n+      Context context, Span span, Span serverSpan, Class<?> target, Method method) {\n+    String pathBasedSpanName =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db6d34dd5fb172884da95f93ef49677b048a7c0"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczNTEwMw==", "bodyText": "I think this is needed, I added a test for this now", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511735103", "createdAt": "2020-10-26T06:07:06Z", "author": {"login": "trask"}, "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-common/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v2_0/JaxRsAnnotationsTracer.java", "diffHunk": "@@ -32,14 +33,16 @@ public Span startSpan(Class<?> target, Method method) {\n     // We create span and immediately update its name\n     // We do that in order to reuse logic inside updateSpanNames method, which is used externally as\n     // well.\n-    Span span = tracer.spanBuilder(\"jax-rs.request\").startSpan();\n-    updateSpanNames(span, BaseTracer.getCurrentServerSpan(), target, method);\n+    Context context = Context.current();\n+    Span span = tracer.spanBuilder(\"jax-rs.request\").setParent(context).startSpan();\n+    updateSpanNames(context, span, BaseTracer.getCurrentServerSpan(context), target, method);\n     return span;\n   }\n \n-  public void updateSpanNames(Span span, Span serverSpan, Class<?> target, Method method) {\n-    // When jax-rs is the root, we want to name using the path, otherwise use the class/method.\n-    String pathBasedSpanName = getPathSpanName(target, method);\n+  public void updateSpanNames(\n+      Context context, Span span, Span serverSpan, Class<?> target, Method method) {\n+    String pathBasedSpanName =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyMzk5NA=="}, "originalCommit": {"oid": "8db6d34dd5fb172884da95f93ef49677b048a7c0"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjA2NDE2OnYy", "diffSide": "RIGHT", "path": "instrumentation/spring/spring-webflux-5.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/spring/webflux/server/HandlerAdapterAdvice.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNToyNDoyNVrOHoBOww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNToyNDoyNVrOHoBOww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyNTI1MQ==", "bodyText": "I think for webflux we can access the ServletHttpRequest directly with an instanceof for the ServerRequest\nhttps://github.com/spring-projects/spring-framework/blob/master/spring-web/src/main/java/org/springframework/http/server/ServletServerHttpRequest.java#L57", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511725251", "createdAt": "2020-10-26T05:24:25Z", "author": {"login": "anuraaga"}, "path": "instrumentation/spring/spring-webflux-5.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/spring/webflux/server/HandlerAdapterAdvice.java", "diffHunk": "@@ -51,7 +51,8 @@ public static SpanWithScope methodEnter(\n       PathPattern bestPattern =\n           exchange.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);\n       if (serverSpan != null && bestPattern != null) {\n-        serverSpan.updateName(bestPattern.getPatternString());\n+        serverSpan.updateName(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db6d34dd5fb172884da95f93ef49677b048a7c0"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjA2NDYxOnYy", "diffSide": "RIGHT", "path": "instrumentation/spring/spring-webmvc-3.1/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/springwebmvc/SpringWebMvcTracer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNToyNDo0MlrOHoBPAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNToyNDo0MlrOHoBPAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyNTMxMw==", "bodyText": "Let's just use the HttpServletRequest", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511725313", "createdAt": "2020-10-26T05:24:42Z", "author": {"login": "anuraaga"}, "path": "instrumentation/spring/spring-webmvc-3.1/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/springwebmvc/SpringWebMvcTracer.java", "diffHunk": "@@ -31,12 +32,12 @@ public Span startSpan(ModelAndView mv) {\n     return span;\n   }\n \n-  public void onRequest(Span span, HttpServletRequest request) {\n+  public void onRequest(Context context, Span span, HttpServletRequest request) {\n     if (request != null) {\n       Object bestMatchingPattern =\n           request.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);\n       if (bestMatchingPattern != null) {\n-        span.updateName(bestMatchingPattern.toString());\n+        span.updateName(BaseTracer.getApplicationRoot(context) + bestMatchingPattern.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db6d34dd5fb172884da95f93ef49677b048a7c0"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjEzNzQyOnYy", "diffSide": "RIGHT", "path": "instrumentation/spring/spring-webflux-5.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/spring/webflux/server/RouteOnSuccessOrError.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNjoxMDoyNVrOHoB4VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMzowMDoyNlrOHoprwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczNTg5Mw==", "bodyText": "I didn't see how to get context path directly here, but will look at it closer tomorrow", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511735893", "createdAt": "2020-10-26T06:10:25Z", "author": {"login": "trask"}, "path": "instrumentation/spring/spring-webflux-5.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/spring/webflux/server/RouteOnSuccessOrError.java", "diffHunk": "@@ -41,7 +41,8 @@ public void accept(HandlerFunction<?> handler, Throwable throwable) {\n \n           Span serverSpan = context.get(BaseTracer.CONTEXT_SERVER_SPAN_KEY);\n           if (serverSpan != null) {\n-            serverSpan.updateName(parseRoute(predicateString));\n+            serverSpan.updateName(\n+                BaseTracer.getApplicationRoot(context) + parseRoute(predicateString));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc3OTgyOA==", "bodyText": "It looks like this will work on all webflux, as suspicious as it may appear (let's of course put a instanceof for good measure, but from what I can tell it's always been implemented like this)\n((RequestPath) serverRequest.pathContainer()).contextPath()", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511779828", "createdAt": "2020-10-26T08:15:01Z", "author": {"login": "anuraaga"}, "path": "instrumentation/spring/spring-webflux-5.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/spring/webflux/server/RouteOnSuccessOrError.java", "diffHunk": "@@ -41,7 +41,8 @@ public void accept(HandlerFunction<?> handler, Throwable throwable) {\n \n           Span serverSpan = context.get(BaseTracer.CONTEXT_SERVER_SPAN_KEY);\n           if (serverSpan != null) {\n-            serverSpan.updateName(parseRoute(predicateString));\n+            serverSpan.updateName(\n+                BaseTracer.getApplicationRoot(context) + parseRoute(predicateString));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczNTg5Mw=="}, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4ODAzNA==", "bodyText": "updated", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512388034", "createdAt": "2020-10-27T03:00:26Z", "author": {"login": "trask"}, "path": "instrumentation/spring/spring-webflux-5.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/spring/webflux/server/RouteOnSuccessOrError.java", "diffHunk": "@@ -41,7 +41,8 @@ public void accept(HandlerFunction<?> handler, Throwable throwable) {\n \n           Span serverSpan = context.get(BaseTracer.CONTEXT_SERVER_SPAN_KEY);\n           if (serverSpan != null) {\n-            serverSpan.updateName(parseRoute(predicateString));\n+            serverSpan.updateName(\n+                BaseTracer.getApplicationRoot(context) + parseRoute(predicateString));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTczNTg5Mw=="}, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjIxNzg0OnYy", "diffSide": "RIGHT", "path": "instrumentation-core/servlet-2.2/src/main/java/io/opentelemetry/instrumentation/servlet/ServletHttpServerTracer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNjo1MTozMlrOHoClGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDozNzozMVrOHorJHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NzM1Mg==", "bodyText": "Why are you doing it in startScope and not in startSpan? Or even by overriding some getSpanName method?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511747352", "createdAt": "2020-10-26T06:51:32Z", "author": {"login": "iNikem"}, "path": "instrumentation-core/servlet-2.2/src/main/java/io/opentelemetry/instrumentation/servlet/ServletHttpServerTracer.java", "diffHunk": "@@ -23,6 +24,22 @@\n \n   private static final Logger log = LoggerFactory.getLogger(ServletHttpServerTracer.class);\n \n+  @Override\n+  public Scope startScope(Span span, HttpServletRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwMjMzMA==", "bodyText": "this is a really good question \ud83e\uddd0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512402330", "createdAt": "2020-10-27T03:57:32Z", "author": {"login": "trask"}, "path": "instrumentation-core/servlet-2.2/src/main/java/io/opentelemetry/instrumentation/servlet/ServletHttpServerTracer.java", "diffHunk": "@@ -23,6 +24,22 @@\n \n   private static final Logger log = LoggerFactory.getLogger(ServletHttpServerTracer.class);\n \n+  @Override\n+  public Scope startScope(Span span, HttpServletRequest request) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NzM1Mg=="}, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxMTkzNA==", "bodyText": "fixed \ud83d\udc4d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512411934", "createdAt": "2020-10-27T04:37:31Z", "author": {"login": "trask"}, "path": "instrumentation-core/servlet-2.2/src/main/java/io/opentelemetry/instrumentation/servlet/ServletHttpServerTracer.java", "diffHunk": "@@ -23,6 +24,22 @@\n \n   private static final Logger log = LoggerFactory.getLogger(ServletHttpServerTracer.class);\n \n+  @Override\n+  public Scope startScope(Span span, HttpServletRequest request) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NzM1Mg=="}, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjI0MzEyOnYy", "diffSide": "RIGHT", "path": "instrumentation/jaxrs/jaxrs-1.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v1_0/JaxRsAnnotationsTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNzowMzozNlrOHoCzfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMjo1OTozNVrOHopqxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1MTAzOQ==", "bodyText": "How can this work? I see in JAX-RS 1.0 tests that we expect span name to be POST /test/hello/{name}. And now you just prepend application root to it?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511751039", "createdAt": "2020-10-26T07:03:36Z", "author": {"login": "iNikem"}, "path": "instrumentation/jaxrs/jaxrs-1.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v1_0/JaxRsAnnotationsTracer.java", "diffHunk": "@@ -26,23 +27,24 @@\n \n   public Span startSpan(Class<?> target, Method method) {\n     String pathBasedSpanName = getPathSpanName(target, method);\n-    Span serverSpan = BaseTracer.getCurrentServerSpan();\n+    Context context = Context.current();\n+    Span serverSpan = BaseTracer.getCurrentServerSpan(context);\n \n     // When jax-rs is the root, we want to name using the path, otherwise use the class/method.\n     String spanName;\n     if (serverSpan == null) {\n       spanName = pathBasedSpanName;\n     } else {\n       spanName = spanNameForMethod(target, method);\n-      updateServerSpanName(serverSpan, pathBasedSpanName);\n+      updateServerSpanName(context, serverSpan, pathBasedSpanName);\n     }\n \n     return tracer.spanBuilder(spanName).startSpan();\n   }\n \n-  private void updateServerSpanName(Span span, String spanName) {\n+  private void updateServerSpanName(Context context, Span span, String spanName) {\n     if (!spanName.isEmpty()) {\n-      span.updateName(spanName);\n+      span.updateName(BaseTracer.getApplicationRoot(context) + spanName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4Nzc4Mg==", "bodyText": "Oops! I fixed the JAX-RS 1.0 instrumentation. Still no test for JAX-RS 1.0 + non-root context path though, I added comment about this below.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512387782", "createdAt": "2020-10-27T02:59:35Z", "author": {"login": "trask"}, "path": "instrumentation/jaxrs/jaxrs-1.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v1_0/JaxRsAnnotationsTracer.java", "diffHunk": "@@ -26,23 +27,24 @@\n \n   public Span startSpan(Class<?> target, Method method) {\n     String pathBasedSpanName = getPathSpanName(target, method);\n-    Span serverSpan = BaseTracer.getCurrentServerSpan();\n+    Context context = Context.current();\n+    Span serverSpan = BaseTracer.getCurrentServerSpan(context);\n \n     // When jax-rs is the root, we want to name using the path, otherwise use the class/method.\n     String spanName;\n     if (serverSpan == null) {\n       spanName = pathBasedSpanName;\n     } else {\n       spanName = spanNameForMethod(target, method);\n-      updateServerSpanName(serverSpan, pathBasedSpanName);\n+      updateServerSpanName(context, serverSpan, pathBasedSpanName);\n     }\n \n     return tracer.spanBuilder(spanName).startSpan();\n   }\n \n-  private void updateServerSpanName(Span span, String spanName) {\n+  private void updateServerSpanName(Context context, Span span, String spanName) {\n     if (!spanName.isEmpty()) {\n-      span.updateName(spanName);\n+      span.updateName(BaseTracer.getApplicationRoot(context) + spanName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1MTAzOQ=="}, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjI0OTkwOnYy", "diffSide": "RIGHT", "path": "instrumentation/jaxrs/jaxrs-1.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v1_0/JaxRsAnnotationsTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNzowNjo0MlrOHoC3Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNTowMzoxMVrOHoripQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1MjAwNw==", "bodyText": "Also I don't like this scattered non-obvious logic :( Several places which are very far from each other and not really related now have to implement the same rule for span name. If/when we change them again, it is certain we don't find all these places.\nAt the very least we should encapsulate this name rule and application root access into a separate class. E.g. ServletSpanName or something.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511752007", "createdAt": "2020-10-26T07:06:42Z", "author": {"login": "iNikem"}, "path": "instrumentation/jaxrs/jaxrs-1.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v1_0/JaxRsAnnotationsTracer.java", "diffHunk": "@@ -26,23 +27,24 @@\n \n   public Span startSpan(Class<?> target, Method method) {\n     String pathBasedSpanName = getPathSpanName(target, method);\n-    Span serverSpan = BaseTracer.getCurrentServerSpan();\n+    Context context = Context.current();\n+    Span serverSpan = BaseTracer.getCurrentServerSpan(context);\n \n     // When jax-rs is the root, we want to name using the path, otherwise use the class/method.\n     String spanName;\n     if (serverSpan == null) {\n       spanName = pathBasedSpanName;\n     } else {\n       spanName = spanNameForMethod(target, method);\n-      updateServerSpanName(serverSpan, pathBasedSpanName);\n+      updateServerSpanName(context, serverSpan, pathBasedSpanName);\n     }\n \n     return tracer.spanBuilder(spanName).startSpan();\n   }\n \n-  private void updateServerSpanName(Span span, String spanName) {\n+  private void updateServerSpanName(Context context, Span span, String spanName) {\n     if (!spanName.isEmpty()) {\n-      span.updateName(spanName);\n+      span.updateName(BaseTracer.getApplicationRoot(context) + spanName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxODQ2OQ==", "bodyText": "I think this is addressed now, let me know what u think", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512418469", "createdAt": "2020-10-27T05:03:11Z", "author": {"login": "trask"}, "path": "instrumentation/jaxrs/jaxrs-1.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jaxrs/v1_0/JaxRsAnnotationsTracer.java", "diffHunk": "@@ -26,23 +27,24 @@\n \n   public Span startSpan(Class<?> target, Method method) {\n     String pathBasedSpanName = getPathSpanName(target, method);\n-    Span serverSpan = BaseTracer.getCurrentServerSpan();\n+    Context context = Context.current();\n+    Span serverSpan = BaseTracer.getCurrentServerSpan(context);\n \n     // When jax-rs is the root, we want to name using the path, otherwise use the class/method.\n     String spanName;\n     if (serverSpan == null) {\n       spanName = pathBasedSpanName;\n     } else {\n       spanName = spanNameForMethod(target, method);\n-      updateServerSpanName(serverSpan, pathBasedSpanName);\n+      updateServerSpanName(context, serverSpan, pathBasedSpanName);\n     }\n \n     return tracer.spanBuilder(spanName).startSpan();\n   }\n \n-  private void updateServerSpanName(Span span, String spanName) {\n+  private void updateServerSpanName(Context context, Span span, String spanName) {\n     if (!spanName.isEmpty()) {\n-      span.updateName(spanName);\n+      span.updateName(BaseTracer.getApplicationRoot(context) + spanName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1MjAwNw=="}, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjI3MTM5OnYy", "diffSide": "RIGHT", "path": "instrumentation/spring/spring-webmvc-3.1/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/springwebmvc/SpringWebMvcTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNzoxNjoxOFrOHoDDcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNTowMjozOVrOHoriPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1NTEyMQ==", "bodyText": "This is essentially one more way to calculate span name. Why we don't use BaseTracer.getApplicationRoot here? We have similar but something different rule scattered across the code base.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r511755121", "createdAt": "2020-10-26T07:16:18Z", "author": {"login": "iNikem"}, "path": "instrumentation/spring/spring-webmvc-3.1/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/springwebmvc/SpringWebMvcTracer.java", "diffHunk": "@@ -36,7 +36,12 @@ public void onRequest(Span span, HttpServletRequest request) {\n       Object bestMatchingPattern =\n           request.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);\n       if (bestMatchingPattern != null) {\n-        span.updateName(bestMatchingPattern.toString());\n+        String contextPath = request.getContextPath();\n+        if (contextPath != null && !contextPath.isEmpty() && !contextPath.equals(\"/\")) {\n+          span.updateName(contextPath + bestMatchingPattern.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQxODM2NQ==", "bodyText": "the latest commit consolidates everything to single approach", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512418365", "createdAt": "2020-10-27T05:02:39Z", "author": {"login": "trask"}, "path": "instrumentation/spring/spring-webmvc-3.1/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/springwebmvc/SpringWebMvcTracer.java", "diffHunk": "@@ -36,7 +36,12 @@ public void onRequest(Span span, HttpServletRequest request) {\n       Object bestMatchingPattern =\n           request.getAttribute(HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);\n       if (bestMatchingPattern != null) {\n-        span.updateName(bestMatchingPattern.toString());\n+        String contextPath = request.getContextPath();\n+        if (contextPath != null && !contextPath.isEmpty() && !contextPath.equals(\"/\")) {\n+          span.updateName(contextPath + bestMatchingPattern.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1NTEyMQ=="}, "originalCommit": {"oid": "a5bc6eb730c114d65a77f07876c5d109ba5e436a"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDY3Nzk1OnYy", "diffSide": "RIGHT", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/servlet/ServletContextPath.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjowMjowNVrOHosihg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjozODozNlrOHotP1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNDgyMg==", "bodyText": "ServletContextContextUtils? Just kidding :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512434822", "createdAt": "2020-10-27T06:02:05Z", "author": {"login": "anuraaga"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/servlet/ServletContextPath.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.instrumentation.api.servlet;\n+\n+import io.opentelemetry.context.Context;\n+import io.opentelemetry.context.ContextKey;\n+\n+public class ServletContextPath {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dccee64d3ae995c2439615a5824282de7349099"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNDk4Mw==", "bodyText": "Let's add some class javadoc to explain what's going on, including why this needs to go in instrumentation-api", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512434983", "createdAt": "2020-10-27T06:02:31Z", "author": {"login": "anuraaga"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/servlet/ServletContextPath.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.instrumentation.api.servlet;\n+\n+import io.opentelemetry.context.Context;\n+import io.opentelemetry.context.ContextKey;\n+\n+public class ServletContextPath {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNDgyMg=="}, "originalCommit": {"oid": "6dccee64d3ae995c2439615a5824282de7349099"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0NjQyMw==", "bodyText": "\ud83d\udc4d will do tomorrow before merging", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512446423", "createdAt": "2020-10-27T06:38:36Z", "author": {"login": "trask"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/servlet/ServletContextPath.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.instrumentation.api.servlet;\n+\n+import io.opentelemetry.context.Context;\n+import io.opentelemetry.context.ContextKey;\n+\n+public class ServletContextPath {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNDgyMg=="}, "originalCommit": {"oid": "6dccee64d3ae995c2439615a5824282de7349099"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDY5ODMxOnYy", "diffSide": "RIGHT", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/servlet/ServletContextPath.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjoxMjo1N1rOHosurg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjoxMjo1N1rOHosurg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNzkzNA==", "bodyText": "This javadoc is obsolete", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512437934", "createdAt": "2020-10-27T06:12:57Z", "author": {"login": "iNikem"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/servlet/ServletContextPath.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.instrumentation.api.servlet;\n+\n+import io.opentelemetry.context.Context;\n+import io.opentelemetry.context.ContextKey;\n+\n+public class ServletContextPath {\n+\n+  // Keeps track of the servlet context path that needs to be prepended to the route when updating\n+  // the span name\n+  public static final ContextKey<String> CONTEXT_KEY =\n+      ContextKey.named(\"opentelemetry-servlet-context-path-key\");\n+\n+  /** Returns the servlet context path from the given context or <code>\"\"</code> if not found. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dccee64d3ae995c2439615a5824282de7349099"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDczMjk0OnYy", "diffSide": "RIGHT", "path": "instrumentation/spring/spring-webflux-5.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/spring/webflux/server/RouteOnSuccessOrError.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjoyOToyMlrOHotDbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjozNjoxOVrOHotMqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0MzI0Ng==", "bodyText": "Is this method used?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512443246", "createdAt": "2020-10-27T06:29:22Z", "author": {"login": "iNikem"}, "path": "instrumentation/spring/spring-webflux-5.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/spring/webflux/server/RouteOnSuccessOrError.java", "diffHunk": "@@ -69,4 +72,13 @@ private String parseRoute(String routerString) {\n                 .trim())\n         .replaceAll(\"\");\n   }\n+\n+  private static String getContextPath(ServerRequest serverRequest) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dccee64d3ae995c2439615a5824282de7349099"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0NTYwOQ==", "bodyText": "nope, gone \ud83d\udc4d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512445609", "createdAt": "2020-10-27T06:36:19Z", "author": {"login": "trask"}, "path": "instrumentation/spring/spring-webflux-5.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/spring/webflux/server/RouteOnSuccessOrError.java", "diffHunk": "@@ -69,4 +72,13 @@ private String parseRoute(String routerString) {\n                 .trim())\n         .replaceAll(\"\");\n   }\n+\n+  private static String getContextPath(ServerRequest serverRequest) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0MzI0Ng=="}, "originalCommit": {"oid": "6dccee64d3ae995c2439615a5824282de7349099"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDczNjE0OnYy", "diffSide": "RIGHT", "path": "instrumentation-core/servlet-2.2/src/main/java/io/opentelemetry/instrumentation/servlet/ServletHttpServerTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjozMDo0MlrOHotFQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjozODoxMVrOHotPOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0MzcxMw==", "bodyText": "Technically, this is a duplication with ServletContextPath.prepend", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512443713", "createdAt": "2020-10-27T06:30:42Z", "author": {"login": "iNikem"}, "path": "instrumentation-core/servlet-2.2/src/main/java/io/opentelemetry/instrumentation/servlet/ServletHttpServerTracer.java", "diffHunk": "@@ -107,4 +125,13 @@ protected String flavor(HttpServletRequest connection, HttpServletRequest reques\n   protected String requestHeader(HttpServletRequest httpServletRequest, String name) {\n     return httpServletRequest.getHeader(name);\n   }\n+\n+  private static String getSpanName(HttpServletRequest request) {\n+    String spanName = request.getServletPath();\n+    String contextPath = request.getContextPath();\n+    if (contextPath != null && !contextPath.isEmpty() && !contextPath.equals(\"/\")) {\n+      spanName = contextPath + spanName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dccee64d3ae995c2439615a5824282de7349099"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0NjI2Ng==", "bodyText": "ya, I could add public static String prepend(String contextPath, String spanName) to ServletContextPath, but I'm thinking better to live with the duplication instead of adding API surface to an already confusing class ServletContextPath", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1418#discussion_r512446266", "createdAt": "2020-10-27T06:38:11Z", "author": {"login": "trask"}, "path": "instrumentation-core/servlet-2.2/src/main/java/io/opentelemetry/instrumentation/servlet/ServletHttpServerTracer.java", "diffHunk": "@@ -107,4 +125,13 @@ protected String flavor(HttpServletRequest connection, HttpServletRequest reques\n   protected String requestHeader(HttpServletRequest httpServletRequest, String name) {\n     return httpServletRequest.getHeader(name);\n   }\n+\n+  private static String getSpanName(HttpServletRequest request) {\n+    String spanName = request.getServletPath();\n+    String contextPath = request.getContextPath();\n+    if (contextPath != null && !contextPath.isEmpty() && !contextPath.equals(\"/\")) {\n+      spanName = contextPath + spanName;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ0MzcxMw=="}, "originalCommit": {"oid": "6dccee64d3ae995c2439615a5824282de7349099"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4706, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}