{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyODAzMTY5", "number": 1184, "title": "Implement some support for JAX-RS 2.1 additions", "bodyText": "HTTP method PATCH\nAsync resource methods returning a CompletionStage", "createdAt": "2020-09-09T12:19:45Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184", "merged": true, "mergeCommit": {"oid": "70a5a3eb6e16eb8144d07cbd8cef92a580f879b7"}, "closed": true, "closedAt": "2020-09-11T11:13:00Z", "author": {"login": "mateuszrzeszutek"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHLQRXABqjM3NDU1NDk4Mzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHzeMzgFqTQ4NjcxNTc2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44778fc8b0687f647345c1b203e1666123af732c", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/44778fc8b0687f647345c1b203e1666123af732c", "committedDate": "2020-09-09T12:18:47Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}, "afterCommit": {"oid": "c207902636429c525d81141e64e758b8671cf187", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c207902636429c525d81141e64e758b8671cf187", "committedDate": "2020-09-09T12:21:08Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c207902636429c525d81141e64e758b8671cf187", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c207902636429c525d81141e64e758b8671cf187", "committedDate": "2020-09-09T12:21:08Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}, "afterCommit": {"oid": "1b3a19cb9f9b547a9791b698bc03fb3129c1c041", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1b3a19cb9f9b547a9791b698bc03fb3129c1c041", "committedDate": "2020-09-09T12:33:40Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b3a19cb9f9b547a9791b698bc03fb3129c1c041", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1b3a19cb9f9b547a9791b698bc03fb3129c1c041", "committedDate": "2020-09-09T12:33:40Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}, "afterCommit": {"oid": "116d13b4efc89bcef8cebfa2246e71d54a4e87c5", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/116d13b4efc89bcef8cebfa2246e71d54a4e87c5", "committedDate": "2020-09-09T12:41:24Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "116d13b4efc89bcef8cebfa2246e71d54a4e87c5", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/116d13b4efc89bcef8cebfa2246e71d54a4e87c5", "committedDate": "2020-09-09T12:41:24Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}, "afterCommit": {"oid": "32db9a852fc02bd5f893f74387835b5c6931532c", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/32db9a852fc02bd5f893f74387835b5c6931532c", "committedDate": "2020-09-11T07:20:19Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NTY3MDk2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#pullrequestreview-486567096", "createdAt": "2020-09-11T08:12:22Z", "commit": {"oid": "32db9a852fc02bd5f893f74387835b5c6931532c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwODoxMjoyMlrOHQS6UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwODoxODoyNVrOHQTGjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg0OTEwNQ==", "bodyText": "I don't think we consistently do so in this codebase, but FWIU handle has much better performance than whenComplete (due to a JDK bug?)\nline/armeria#1426\nCan we use handle here?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486849105", "createdAt": "2020-09-11T08:12:22Z", "author": {"login": "anuraaga"}, "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-common/src/main/java/io/opentelemetry/instrumentation/auto/jaxrs/v2_0/JaxRsAnnotationsInstrumentation.java", "diffHunk": "@@ -155,15 +157,23 @@ public static void stopSpan(\n         return;\n       }\n \n+      CompletionStage<?> asyncReturnValue =\n+          returnValue instanceof CompletionStage ? (CompletionStage<?>) returnValue : null;\n+\n       if (asyncResponse != null && !asyncResponse.isSuspended()) {\n         // Clear span from the asyncResponse. Logically this should never happen. Added to be safe.\n         InstrumentationContext.get(AsyncResponse.class, Span.class).put(asyncResponse, null);\n       }\n-      if (asyncResponse == null || !asyncResponse.isSuspended()) {\n+      if (asyncReturnValue != null) {\n+        // span finished by CompletionStageFinishCallback\n+        asyncReturnValue = asyncReturnValue.whenComplete(new CompletionStageFinishCallback<>(span));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32db9a852fc02bd5f893f74387835b5c6931532c"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg1MDk4MA==", "bodyText": "If this is false normally and true when running latest deps, recommend being more explicit about it like our redisson instrumentation\nhttps://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/master/instrumentation/redisson-3.0/redisson-3.0.gradle#L21", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486850980", "createdAt": "2020-09-11T08:15:59Z", "author": {"login": "anuraaga"}, "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-testing/src/main/groovy/JaxRsHttpServerTest.groovy", "diffHunk": "@@ -73,6 +104,15 @@ abstract class JaxRsHttpServerTest<S> extends HttpServerTest<S> {\n     true\n   }\n \n+  private static boolean supportsJaxRs21() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32db9a852fc02bd5f893f74387835b5c6931532c"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg1MjIzNw==", "bodyText": "IIUC, it's important our test makes sure a span hasn't been ended before the future is completed. How about adding some sleep in the API method, and separate out making the call, checking there are no traces (with previous code I think there would have been), than joining on the future, then checking there are traces?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486852237", "createdAt": "2020-09-11T08:18:25Z", "author": {"login": "anuraaga"}, "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-testing/src/main/groovy/JaxRsHttpServerTest.groovy", "diffHunk": "@@ -58,6 +59,36 @@ abstract class JaxRsHttpServerTest<S> extends HttpServerTest<S> {\n     \"canceled\"   | \"cancel\"  | 503        | { it instanceof String } | true        | false   | null\n   }\n \n+  @Unroll\n+  def \"should handle #desc CompletionStage (JAX-RS 2.1+ only)\"() {\n+    assumeTrue(supportsJaxRs21())\n+\n+    given:\n+    def url = HttpUrl.get(address.resolve(\"/async-completion-stage\")).newBuilder()\n+      .addQueryParameter(\"action\", action)\n+      .build()\n+    def request = request(url, \"GET\", null).build()\n+\n+    when:\n+    def response = client.newCall(request).execute()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32db9a852fc02bd5f893f74387835b5c6931532c"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32db9a852fc02bd5f893f74387835b5c6931532c", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/32db9a852fc02bd5f893f74387835b5c6931532c", "committedDate": "2020-09-11T07:20:19Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}, "afterCommit": {"oid": "4330e12dc1689e831d2168556b41f4092318cabf", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4330e12dc1689e831d2168556b41f4092318cabf", "committedDate": "2020-09-11T09:06:35Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4330e12dc1689e831d2168556b41f4092318cabf", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4330e12dc1689e831d2168556b41f4092318cabf", "committedDate": "2020-09-11T09:06:35Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}, "afterCommit": {"oid": "cbed7ed7f8d5b7b17aabad6c31900b4a1867687b", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cbed7ed7f8d5b7b17aabad6c31900b4a1867687b", "committedDate": "2020-09-11T09:13:34Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da831c1c1d09b980e1bc52042a60f969b79c9650", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/da831c1c1d09b980e1bc52042a60f969b79c9650", "committedDate": "2020-09-11T09:20:10Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbed7ed7f8d5b7b17aabad6c31900b4a1867687b", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cbed7ed7f8d5b7b17aabad6c31900b4a1867687b", "committedDate": "2020-09-11T09:13:34Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}, "afterCommit": {"oid": "da831c1c1d09b980e1bc52042a60f969b79c9650", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/da831c1c1d09b980e1bc52042a60f969b79c9650", "committedDate": "2020-09-11T09:20:10Z", "message": "Implement some support for JAX-RS 2.1 additions\n\n* HTTP method `PATCH`\n* Async resource methods returning a `CompletionStage`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NjUzMDY0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#pullrequestreview-486653064", "createdAt": "2020-09-11T09:31:42Z", "commit": {"oid": "da831c1c1d09b980e1bc52042a60f969b79c9650"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NzE1MDk2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#pullrequestreview-486715096", "createdAt": "2020-09-11T11:11:38Z", "commit": {"oid": "da831c1c1d09b980e1bc52042a60f969b79c9650"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMToxMTozOFrOHQap4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMToxMTozOFrOHQap4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3NTk3MA==", "bodyText": "Why is this needed? @anuraaga is it?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#discussion_r486975970", "createdAt": "2020-09-11T11:11:38Z", "author": {"login": "iNikem"}, "path": "instrumentation/jaxrs/jaxrs-2.0/jaxrs-2.0-jersey-2.0/jaxrs-2.0-jersey-2.0.gradle", "diffHunk": "@@ -24,3 +24,7 @@ dependencies {\n   testImplementation group: 'javax.xml.bind', name: 'jaxb-api', version: '2.2.3'\n   testImplementation group: 'com.fasterxml.jackson.module', name: 'jackson-module-afterburner', version: '2.9.10'\n }\n+\n+test {\n+  systemProperty 'testLatestDeps', testLatestDeps", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da831c1c1d09b980e1bc52042a60f969b79c9650"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NzE1NzY1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1184#pullrequestreview-486715765", "createdAt": "2020-09-11T11:12:52Z", "commit": {"oid": "da831c1c1d09b980e1bc52042a60f969b79c9650"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2569, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}