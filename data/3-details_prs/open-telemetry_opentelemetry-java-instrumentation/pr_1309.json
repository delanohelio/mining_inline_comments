{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2ODg2NzQ3", "number": 1309, "title": "Add system metrics", "bodyText": "It is based on open-telemetry/opentelemetry-java#1323\nSpec: https://github.com/open-telemetry/opentelemetry-specification/blob/master/specification/metrics/semantic_conventions/system-metrics.md", "createdAt": "2020-10-02T12:50:16Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1309", "merged": true, "mergeCommit": {"oid": "d2813c838d956b6db05f9ca975b8bac3c82dcc71"}, "closed": true, "closedAt": "2020-10-27T15:48:37Z", "author": {"login": "malafeev"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOlV6mAH2gAyNDk2ODg2NzQ3OjNiMjE2ZWE1ZmNjM2E1YWM3MGIwZTQ1ZjVhYjRmMzczYTRlYWNmNTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWo8NOAFqTUxNzY5ODAxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3b216ea5fcc3a5ac70b0e45f5ab4f373a4eacf53", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3b216ea5fcc3a5ac70b0e45f5ab4f373a4eacf53", "committedDate": "2020-10-02T12:42:36Z", "message": "initial system metrics\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b64b61a37d36c458415917ac74c701058cffd1fe", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b64b61a37d36c458415917ac74c701058cffd1fe", "committedDate": "2020-10-02T12:46:57Z", "message": "Merge branch 'master' into system-metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93c986e6ca1b922837301e0a9e4b0b47f617fcd9", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/93c986e6ca1b922837301e0a9e4b0b47f617fcd9", "committedDate": "2020-10-05T12:20:18Z", "message": "Merge remote-tracking branch 'upstream/master' into system-metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0053ccf7b664551c94d2ac752eb89e67564fb286", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0053ccf7b664551c94d2ac752eb89e67564fb286", "committedDate": "2020-10-05T13:54:59Z", "message": "update copyright\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa2b7de9f12a26f39a10457a08c4dfdb4740125b", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/fa2b7de9f12a26f39a10457a08c4dfdb4740125b", "committedDate": "2020-10-06T13:18:28Z", "message": "add system.disk callbacks\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb33c8e7b21174a6f3db8b228d30dfd9eeb774f6", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/eb33c8e7b21174a6f3db8b228d30dfd9eeb774f6", "committedDate": "2020-10-07T14:21:25Z", "message": "add java metrics and tests\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38d554eb2c418e13d905f866f8b10438d4b06ae2", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/38d554eb2c418e13d905f866f8b10438d4b06ae2", "committedDate": "2020-10-07T15:33:30Z", "message": "Merge branch 'master' into system-metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a1888132c045349cd053eefd687c14884f5ef2f", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9a1888132c045349cd053eefd687c14884f5ef2f", "committedDate": "2020-10-08T12:50:24Z", "message": "update observers type and tests\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDMyNTcx", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1309#pullrequestreview-507432571", "createdAt": "2020-10-13T13:26:50Z", "commit": {"oid": "9a1888132c045349cd053eefd687c14884f5ef2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTI1MDQ5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1309#pullrequestreview-511925049", "createdAt": "2020-10-19T16:05:22Z", "commit": {"oid": "9a1888132c045349cd053eefd687c14884f5ef2f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjowNToyMlrOHkWJxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjowNToyMlrOHkWJxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg3MzczMg==", "bodyText": "3.4MB with transitive dependencies", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1309#discussion_r507873732", "createdAt": "2020-10-19T16:05:22Z", "author": {"login": "malafeev"}, "path": "system-metrics/system-metrics.gradle", "diffHunk": "@@ -0,0 +1,11 @@\n+apply from: \"$rootDir/gradle/java.gradle\"\n+apply from: \"$rootDir/gradle/publish.gradle\"\n+\n+\n+dependencies {\n+  implementation deps.opentelemetryApi\n+  implementation \"com.github.oshi:oshi-core:5.2.5\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a1888132c045349cd053eefd687c14884f5ef2f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05c6bf3ce0d9ce573e14296060d21663640725ef", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/05c6bf3ce0d9ce573e14296060d21663640725ef", "committedDate": "2020-10-21T12:18:32Z", "message": "Merge branch 'master' into system-metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77abab95e199bb1982b2f58299dd2a1d17ef8620", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/77abab95e199bb1982b2f58299dd2a1d17ef8620", "committedDate": "2020-10-21T13:08:07Z", "message": "move metrics to instrumentation/oshi/library\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c675ce1e048e931a957f296c4851695eb9494de2", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c675ce1e048e931a957f296c4851695eb9494de2", "committedDate": "2020-10-21T13:09:34Z", "message": "update oshi to 5.3.1\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e520f46e75b1ec50e8c90b21f2841c1e021a942", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5e520f46e75b1ec50e8c90b21f2841c1e021a942", "committedDate": "2020-10-23T02:28:24Z", "message": "Merge branch 'master' into system-metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTY0ODIw", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1309#pullrequestreview-517164820", "createdAt": "2020-10-26T20:50:38Z", "commit": {"oid": "5e520f46e75b1ec50e8c90b21f2841c1e021a942"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMDo1MDozOFrOHoh2Dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMDo1MTo0NFrOHoh4qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI1OTU5OQ==", "bodyText": "maybe rename to ProcessMetrics to make clear these are not just standard Java-provided metrics?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1309#discussion_r512259599", "createdAt": "2020-10-26T20:50:38Z", "author": {"login": "trask"}, "path": "instrumentation/oshi/library/src/main/java/io/opentelemetry/instrumentation/oshi/JavaMetrics.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.instrumentation.oshi;\n+\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.common.Labels;\n+import io.opentelemetry.metrics.AsynchronousInstrument.Callback;\n+import io.opentelemetry.metrics.AsynchronousInstrument.DoubleResult;\n+import io.opentelemetry.metrics.AsynchronousInstrument.LongResult;\n+import io.opentelemetry.metrics.Meter;\n+import java.lang.management.GarbageCollectorMXBean;\n+import java.lang.management.ManagementFactory;\n+import oshi.SystemInfo;\n+import oshi.software.os.OSProcess;\n+import oshi.software.os.OperatingSystem;\n+\n+/** Java Runtime Metrics Utility */\n+public class JavaMetrics {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e520f46e75b1ec50e8c90b21f2841c1e021a942"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2MDI2NA==", "bodyText": "can this be part of the other (future) module that only depends on JVM-provided metrics?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1309#discussion_r512260264", "createdAt": "2020-10-26T20:51:44Z", "author": {"login": "trask"}, "path": "instrumentation/oshi/library/src/main/java/io/opentelemetry/instrumentation/oshi/JavaMetrics.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.instrumentation.oshi;\n+\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.common.Labels;\n+import io.opentelemetry.metrics.AsynchronousInstrument.Callback;\n+import io.opentelemetry.metrics.AsynchronousInstrument.DoubleResult;\n+import io.opentelemetry.metrics.AsynchronousInstrument.LongResult;\n+import io.opentelemetry.metrics.Meter;\n+import java.lang.management.GarbageCollectorMXBean;\n+import java.lang.management.ManagementFactory;\n+import oshi.SystemInfo;\n+import oshi.software.os.OSProcess;\n+import oshi.software.os.OperatingSystem;\n+\n+/** Java Runtime Metrics Utility */\n+public class JavaMetrics {\n+  private static final String TYPE_LABEL_KEY = \"type\";\n+\n+  private JavaMetrics() {}\n+\n+  /** Register observers for java runtime metrics */\n+  public static void registerObservers() {\n+    Meter meter = OpenTelemetry.getMeterProvider().get(JavaMetrics.class.getName());\n+    SystemInfo systemInfo = new SystemInfo();\n+    OperatingSystem osInfo = systemInfo.getOperatingSystem();\n+    OSProcess processInfo = osInfo.getProcess(osInfo.getProcessId());\n+\n+    meter\n+        .longUpDownSumObserverBuilder(\"runtime.java.memory\")\n+        .setDescription(\"Runtime Java memory\")\n+        .setUnit(\"bytes\")\n+        .build()\n+        .setCallback(\n+            new Callback<LongResult>() {\n+              @Override\n+              public void update(LongResult r) {\n+                processInfo.updateAttributes();\n+                r.observe(processInfo.getResidentSetSize(), Labels.of(TYPE_LABEL_KEY, \"rss\"));\n+                r.observe(processInfo.getVirtualSize(), Labels.of(TYPE_LABEL_KEY, \"vms\"));\n+              }\n+            });\n+\n+    meter\n+        .doubleValueObserverBuilder(\"runtime.java.cpu_time\")\n+        .setDescription(\"Runtime Java CPU time\")\n+        .setUnit(\"seconds\")\n+        .build()\n+        .setCallback(\n+            new Callback<DoubleResult>() {\n+              @Override\n+              public void update(DoubleResult r) {\n+                processInfo.updateAttributes();\n+                r.observe(processInfo.getUserTime() * 1000, Labels.of(TYPE_LABEL_KEY, \"user\"));\n+                r.observe(processInfo.getKernelTime() * 1000, Labels.of(TYPE_LABEL_KEY, \"system\"));\n+              }\n+            });\n+\n+    meter\n+        .longValueObserverBuilder(\"runtime.java.gc_count\")\n+        .setDescription(\"Runtime Java GC count\")\n+        .setUnit(\"counts\")\n+        .build()\n+        .setCallback(\n+            new Callback<LongResult>() {\n+              @Override\n+              public void update(LongResult r) {\n+                long gcCount = 0;\n+                for (final GarbageCollectorMXBean gcBean :\n+                    ManagementFactory.getGarbageCollectorMXBeans()) {\n+                  gcCount += gcBean.getCollectionCount();\n+                }\n+\n+                r.observe(gcCount, Labels.of(TYPE_LABEL_KEY, \"count\"));\n+              }\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e520f46e75b1ec50e8c90b21f2841c1e021a942"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8dfeff4e44dbbe31145f15f5b80e6f7d17ac03a", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b8dfeff4e44dbbe31145f15f5b80e6f7d17ac03a", "committedDate": "2020-10-27T02:39:07Z", "message": "rename JavaMetrics to ProcessMetrics\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f02697573169218e71623426fa3dfe9e16bec732", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f02697573169218e71623426fa3dfe9e16bec732", "committedDate": "2020-10-27T02:52:57Z", "message": "get rid of runtime.java.gc_count\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzEyNzYw", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1309#pullrequestreview-517312760", "createdAt": "2020-10-27T02:54:56Z", "commit": {"oid": "f02697573169218e71623426fa3dfe9e16bec732"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed75264a4696a16d84c3a1eac903d0d80adbc7d7", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ed75264a4696a16d84c3a1eac903d0d80adbc7d7", "committedDate": "2020-10-27T02:59:16Z", "message": "update observer for system.memory.utilization\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a762928f5d224d16965d75b3efa3a01f72879035", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a762928f5d224d16965d75b3efa3a01f72879035", "committedDate": "2020-10-27T03:55:00Z", "message": "fix tests\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6483731ce7c581be0d87749331bf480020e9d94f", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6483731ce7c581be0d87749331bf480020e9d94f", "committedDate": "2020-10-27T03:58:04Z", "message": "Merge branch 'master' into system-metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02c908483bc459d9e9cf50b9869b1311809690d1", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/02c908483bc459d9e9cf50b9869b1311809690d1", "committedDate": "2020-10-27T04:18:53Z", "message": "sync with master\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f192cad4222e72c224c9247ee370879a04e0cb4", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1f192cad4222e72c224c9247ee370879a04e0cb4", "committedDate": "2020-10-27T04:20:18Z", "message": "sync with master\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6172a68731fb5d76f2901daffadf95701268d9f6", "author": {"user": {"login": "malafeev", "name": "Sergei Malafeev"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6172a68731fb5d76f2901daffadf95701268d9f6", "committedDate": "2020-10-27T13:18:45Z", "message": "Merge branch 'master' into system-metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3Njk4MDE2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1309#pullrequestreview-517698016", "createdAt": "2020-10-27T13:25:32Z", "commit": {"oid": "6172a68731fb5d76f2901daffadf95701268d9f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2459, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}