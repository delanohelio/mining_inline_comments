{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNjAyMDIx", "number": 189, "title": "Made couchbase agent compliant to semantic conventions", "bodyText": "Bucket name is sent as db.instance (seems like the closest we have to an instance name)\n\n\nWhen possible, obtains a textual representation of the query and sends it as db.statement", "createdAt": "2020-02-27T02:20:31Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/189", "merged": true, "mergeCommit": {"oid": "147b536891b0cdcdec0a9496f268aec6928fed0c"}, "closed": true, "closedAt": "2020-02-27T20:28:19Z", "author": {"login": "prydin"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIRttDgH2gAyMzgwNjAyMDIxOjRlZjdlOTlmNWViMTA0YmQ1OWJhMjc1ZTNmM2RkZDYxZWMxNDhiNjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIhIE_AFqTM2NTk2NjExOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4ef7e99f5eb104bd59ba275e3f3ddd61ec148b60", "author": {"user": {"login": "prydin", "name": "Pontus Rydin"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4ef7e99f5eb104bd59ba275e3f3ddd61ec148b60", "committedDate": "2020-02-27T02:15:47Z", "message": "Made couchbase agent compliant to semantic conventions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ef7b646123675383de275426098cb23ab54551c", "author": {"user": {"login": "prydin", "name": "Pontus Rydin"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5ef7b646123675383de275426098cb23ab54551c", "committedDate": "2020-02-27T04:20:30Z", "message": "Fixed test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e5c92984ea28b4e0ddbe69ecbc9c457f69e1b39", "author": {"user": {"login": "prydin", "name": "Pontus Rydin"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2e5c92984ea28b4e0ddbe69ecbc9c457f69e1b39", "committedDate": "2020-02-27T16:38:48Z", "message": "Made tests resilient to variations in internally generated queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49530470add1e8444ff425a337e779b680129fd2", "author": {"user": {"login": "prydin", "name": "Pontus Rydin"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/49530470add1e8444ff425a337e779b680129fd2", "committedDate": "2020-02-27T17:11:43Z", "message": "Fixed test function signatures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f47ed72f969994261bf3697ee5985a31912d0632", "author": {"user": {"login": "prydin", "name": "Pontus Rydin"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f47ed72f969994261bf3697ee5985a31912d0632", "committedDate": "2020-02-27T17:53:15Z", "message": "Final (famous last words) fix to tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODg1NTgy", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/189#pullrequestreview-365885582", "createdAt": "2020-02-27T18:12:15Z", "commit": {"oid": "f47ed72f969994261bf3697ee5985a31912d0632"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoxMjoxNVrOFvbz8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoxMjoxNVrOFvbz8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4MzA1Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \\\n          \n      \n    \n    \n  \n\nAnd extra newlines too...", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/189#discussion_r385283056", "createdAt": "2020-02-27T18:12:15Z", "author": {"login": "tylerbenson"}, "path": "instrumentation/couchbase-2.0/src/test/groovy/springdata/CouchbaseSpringRepositoryTest.groovy", "diffHunk": "@@ -61,6 +61,9 @@ class CouchbaseSpringRepositoryTest extends AbstractCouchbaseTest {\n \n     applicationContext = new AnnotationConfigApplicationContext(CouchbaseConfig)\n     repo = applicationContext.getBean(DocRepository)\n+    \\\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f47ed72f969994261bf3697ee5985a31912d0632"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "306e1765c75df7bc14f2d12c5784ac935cea2925", "author": {"user": {"login": "prydin", "name": "Pontus Rydin"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/306e1765c75df7bc14f2d12c5784ac935cea2925", "committedDate": "2020-02-27T19:09:15Z", "message": "Removed extra newlines.\n\nCo-Authored-By: Tyler Benson <tylerbenson@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4090e7f8c83c7759610e6b84b015c5b5dbe1bf0", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c4090e7f8c83c7759610e6b84b015c5b5dbe1bf0", "committedDate": "2020-02-27T20:11:53Z", "message": "Merge branch 'master' into prydin-db-semantics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTY1NDQz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/189#pullrequestreview-365965443", "createdAt": "2020-02-27T20:12:06Z", "commit": {"oid": "c4090e7f8c83c7759610e6b84b015c5b5dbe1bf0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTY2MTE5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/189#pullrequestreview-365966119", "createdAt": "2020-02-27T20:13:09Z", "commit": {"oid": "c4090e7f8c83c7759610e6b84b015c5b5dbe1bf0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMDoxMzowOVrOFvfsyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMDoxMzowOVrOFvfsyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM0Njc2MA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/189#discussion_r385346760", "createdAt": "2020-02-27T20:13:09Z", "author": {"login": "trask"}, "path": "instrumentation/couchbase-2.0/src/main/java/io/opentelemetry/auto/instrumentation/couchbase/client/CouchbaseBucketInstrumentation.java", "diffHunk": "@@ -74,8 +79,35 @@ public static void subscribeResult(\n         return;\n       }\n       CallDepthThreadLocalMap.reset(CouchbaseCluster.class);\n+      result = Observable.create(new CouchbaseOnSubscribe(result, method, bucket, null));\n+    }\n+  }\n+\n+  public static class CouchbaseClientQueryAdvice {\n+\n+    @Advice.OnMethodEnter\n+    public static int trackCallDepth() {\n+      return CallDepthThreadLocalMap.incrementCallDepth(CouchbaseCluster.class);\n+    }\n+\n+    @Advice.OnMethodExit(onThrowable = Throwable.class)\n+    public static void subscribeResult(\n+        @Advice.Enter final int callDepth,\n+        @Advice.Origin final Method method,\n+        @Advice.FieldValue(\"bucket\") final String bucket,\n+        @Advice.Argument(value = 0, optional = true) final Object query,\n+        @Advice.Return(readOnly = false) Observable result) {\n+      if (callDepth > 0) {\n+        return;\n+      }\n+      CallDepthThreadLocalMap.reset(CouchbaseCluster.class);\n \n-      result = Observable.create(new CouchbaseOnSubscribe(result, method, bucket));\n+      // A query can be of many different types. We could track the creation of them and try to\n+      // rewind back to when they were created from a string, but for now we rely on toString()\n+      // returning something useful. That seems to be the case. If we're starting to see strange\n+      // query texts, this is the place to look!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4090e7f8c83c7759610e6b84b015c5b5dbe1bf0"}, "originalPosition": 63}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3319, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}