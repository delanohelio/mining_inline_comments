{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMDc5NzQz", "number": 1836, "title": "Use Context more in DatabaseClientTracer", "bodyText": "Pass Context in to DatabaseClientTracer.startSpan() and return new Context\nAdd CONTEXT_CLIENT_SPAN_KEY in startSpan()\nRemove DatabaseClientTracer.startScope() and use Context.makeCurrent() directly instead\nAdded DatabaseClientTracer.shouldStartSpan() but only used it to replace existing call depth tracking for now", "createdAt": "2020-12-05T19:19:51Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836", "merged": true, "mergeCommit": {"oid": "4cbfb361e144589773f8c59e3389c4bda1ef5e76"}, "closed": true, "closedAt": "2020-12-07T07:15:16Z", "author": {"login": "trask"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjRWA8gH2gAyNTMzMDc5NzQzOjA1MGI3MDJmY2YwN2RjMjA5MGM2MGYxN2E0M2FmMGEwNjUwZTAwZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjwN0HgFqTU0NTg3ODY4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "050b702fcf07dc2090c60f17a43af0a0650e00d5", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/050b702fcf07dc2090c60f17a43af0a0650e00d5", "committedDate": "2020-12-05T19:17:01Z", "message": "Use Context more in DatabaseClientTracer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NzkzNDQ0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836#pullrequestreview-545793444", "createdAt": "2020-12-07T02:33:03Z", "commit": {"oid": "050b702fcf07dc2090c60f17a43af0a0650e00d5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMjozMzowNFrOIATgFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMjozMzowNFrOIATgFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE5MDQyMw==", "bodyText": "We're really lucky that default interface methods work fine, heh", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836#discussion_r537190423", "createdAt": "2020-12-07T02:33:04Z", "author": {"login": "anuraaga"}, "path": "instrumentation/elasticsearch/elasticsearch-transport-5.3/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/elasticsearch/transport/v5_3/Elasticsearch53TransportClientInstrumentationModule.java", "diffHunk": "@@ -67,27 +68,27 @@ public Elasticsearch53TransportClientInstrumentationModule() {\n     public static void onEnter(\n         @Advice.Argument(0) Action action,\n         @Advice.Argument(1) ActionRequest actionRequest,\n-        @Advice.Local(\"otelSpan\") Span span,\n+        @Advice.Local(\"otelContext\") Context context,\n         @Advice.Local(\"otelScope\") Scope scope,\n         @Advice.Argument(value = 2, readOnly = false)\n             ActionListener<ActionResponse> actionListener) {\n \n-      span = tracer().startSpan(null, action);\n-      scope = tracer().startScope(span);\n+      context = tracer().startSpan(currentContext(), null, action);\n+      scope = context.makeCurrent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050b702fcf07dc2090c60f17a43af0a0650e00d5"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1ODY3MTQ5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836#pullrequestreview-545867149", "createdAt": "2020-12-07T06:47:24Z", "commit": {"oid": "050b702fcf07dc2090c60f17a43af0a0650e00d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNjo0NzoyNVrOIAYMGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNjo0NzoyNVrOIAYMGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2NzIyNw==", "bodyText": "In some places above you use Context.current() directly. What are the rules? How to choose when to use which? Are they written in CONTRIBUTING.md?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836#discussion_r537267227", "createdAt": "2020-12-07T06:47:25Z", "author": {"login": "iNikem"}, "path": "instrumentation/elasticsearch/elasticsearch-rest-5.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/elasticsearch/rest/v5_0/Elasticsearch5RestClientInstrumentationModule.java", "diffHunk": "@@ -5,6 +5,7 @@\n \n package io.opentelemetry.javaagent.instrumentation.elasticsearch.rest.v5_0;\n \n+import static io.opentelemetry.javaagent.instrumentation.api.Java8BytecodeBridge.currentContext;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050b702fcf07dc2090c60f17a43af0a0650e00d5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1ODc4Njgw", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1836#pullrequestreview-545878680", "createdAt": "2020-12-07T07:15:07Z", "commit": {"oid": "050b702fcf07dc2090c60f17a43af0a0650e00d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2137, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}