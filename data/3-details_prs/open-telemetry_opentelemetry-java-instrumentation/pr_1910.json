{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5OTE0NDE1", "number": 1910, "title": "HTTP client instrumentation cleanup: google-http-client", "bodyText": "Split out from #1840", "createdAt": "2020-12-15T01:38:23Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910", "merged": true, "mergeCommit": {"oid": "6dcc819f7784bad9f18331bf7bcd560c361911f0"}, "closed": true, "closedAt": "2020-12-16T05:49:01Z", "author": {"login": "trask"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmQLbJgH2gAyNTM5OTE0NDE1OjJmMmM3NTI3YWY2YTY5NmU2NzM0YzEyNWNmYTVjM2Y3ZDc2YjQ0ZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmoYDdAFqTU1MzM3NDEyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2f2c7527af6a696e6734c125cfa5c3f7d76b44e5", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2f2c7527af6a696e6734c125cfa5c3f7d76b44e5", "committedDate": "2020-12-15T01:37:19Z", "message": "HTTP client instrumentation cleanup: google-http-client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTIyOTY3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#pullrequestreview-552122967", "createdAt": "2020-12-15T05:46:33Z", "commit": {"oid": "2f2c7527af6a696e6734c125cfa5c3f7d76b44e5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNTo0NjozM1rOIF5-eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNTo0NjozM1rOIF5-eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA2MzY3NA==", "bodyText": "I liked this comment", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543063674", "createdAt": "2020-12-15T05:46:33Z", "author": {"login": "anuraaga"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -85,21 +82,19 @@ public static void methodEnter(\n         @Advice.Local(\"otelContext\") Context context,\n         @Advice.Local(\"otelScope\") Scope scope) {\n \n-      ContextStore<HttpRequest, Context> contextStore =\n-          InstrumentationContext.get(HttpRequest.class, Context.class);\n-      context = contextStore.get(request);\n-\n-      if (context == null) {\n-        Context parentContext = currentContext();\n-        if (tracer().shouldStartSpan(parentContext)) {\n-          context = tracer().startSpan(parentContext, request, request.getHeaders());\n-          contextStore.put(request, context);\n-          scope = context.makeCurrent();\n-        }\n-      } else {\n-        // span was created by GoogleHttpClientAsyncAdvice instrumentation below", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f2c7527af6a696e6734c125cfa5c3f7d76b44e5"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67165da95b60eb7c3d94d3c0dc2f38741a3086d5", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/67165da95b60eb7c3d94d3c0dc2f38741a3086d5", "committedDate": "2020-12-15T06:34:23Z", "message": "Bring back comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTU0NzU5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#pullrequestreview-552154759", "createdAt": "2020-12-15T07:02:15Z", "commit": {"oid": "67165da95b60eb7c3d94d3c0dc2f38741a3086d5"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzowMjoxNVrOIF72dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzowMzo1MFrOIF75GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NDM5MQ==", "bodyText": "Is this not needed anymore?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543094391", "createdAt": "2020-12-15T07:02:15Z", "author": {"login": "iNikem"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -85,21 +82,20 @@ public static void methodEnter(\n         @Advice.Local(\"otelContext\") Context context,\n         @Advice.Local(\"otelScope\") Scope scope) {\n \n-      ContextStore<HttpRequest, Context> contextStore =\n-          InstrumentationContext.get(HttpRequest.class, Context.class);\n-      context = contextStore.get(request);\n-\n-      if (context == null) {\n-        Context parentContext = currentContext();\n-        if (tracer().shouldStartSpan(parentContext)) {\n-          context = tracer().startSpan(parentContext, request, request.getHeaders());\n-          contextStore.put(request, context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67165da95b60eb7c3d94d3c0dc2f38741a3086d5"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NDk1OQ==", "bodyText": "I find this comment suspicious. Why of all places here to want to work without executors instrumentations?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543094959", "createdAt": "2020-12-15T07:03:34Z", "author": {"login": "iNikem"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -138,15 +125,12 @@ public static void methodEnter(\n         return;\n       }\n \n-      context = tracer().startSpan(parentContext, request, request.getHeaders());\n+      context = tracer().startSpan(parentContext, request);\n+      scope = context.makeCurrent();\n \n       // propagating the context manually here so this instrumentation will work with and without\n       // the executors instrumentation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67165da95b60eb7c3d94d3c0dc2f38741a3086d5"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NTA2NQ==", "bodyText": "Is this not needed anymore?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543095065", "createdAt": "2020-12-15T07:03:50Z", "author": {"login": "iNikem"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -113,16 +109,7 @@ public static void methodExit(\n       }\n \n       scope.close();\n-      if (throwable == null) {\n-        tracer().end(context, response);\n-      } else {\n-        tracer().endExceptionally(context, response, throwable);\n-      }\n-      // If HttpRequest.setThrowExceptionOnExecuteError is set to false, there are no exceptions\n-      // for a failed request.  Thus, check the response code\n-      if (response != null && !response.isSuccessStatusCode()) {\n-        spanFromContext(context).setStatus(StatusCode.ERROR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67165da95b60eb7c3d94d3c0dc2f38741a3086d5"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ba38f19b89baf6a817e7972beb7e8e8aee6c08c", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8ba38f19b89baf6a817e7972beb7e8e8aee6c08c", "committedDate": "2020-12-15T23:17:22Z", "message": "Feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMzc0MTIz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#pullrequestreview-553374123", "createdAt": "2020-12-16T05:48:50Z", "commit": {"oid": "8ba38f19b89baf6a817e7972beb7e8e8aee6c08c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2002, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}