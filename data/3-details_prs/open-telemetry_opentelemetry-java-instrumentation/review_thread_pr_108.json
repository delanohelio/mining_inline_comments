{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NzcyMTcx", "number": 108, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMTo0NTo0OFrODcEgqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMTo1ODoyM1rODcEujQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNzYwNjE3OnYy", "diffSide": "RIGHT", "path": "instrumentation/grizzly-2/src/main/java/io/opentelemetry/auto/instrumentation/grizzly/GrizzlyHttpHandlerInstrumentation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMTo0NTo0OFrOFj684g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMTo1MToxMFrOFj7F_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxMDMzOA==", "bodyText": "this is my first PR review in here, and I know this isn't totally the right place to mention this, but what about calling this thing a SpanWithScope, rather than explicitly calling out the pair nature?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/108#discussion_r373210338", "createdAt": "2020-01-30T21:45:48Z", "author": {"login": "jkwatson"}, "path": "instrumentation/grizzly-2/src/main/java/io/opentelemetry/auto/instrumentation/grizzly/GrizzlyHttpHandlerInstrumentation.java", "diffHunk": "@@ -66,39 +64,44 @@ public boolean defaultEnabled() {\n   public static class HandleAdvice {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n-    public static AgentScope methodEnter(@Advice.Argument(0) final Request request) {\n+    public static SpanScopePair methodEnter(@Advice.Argument(0) final Request request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3d5a8e7ef5ddeeb8f5289790b66fcd9df66c538"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxMjY2OQ==", "bodyText": "\ud83d\udc4d SpanWithScope sounds good to me, I'll open an issue to track that", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/108#discussion_r373212669", "createdAt": "2020-01-30T21:51:10Z", "author": {"login": "trask"}, "path": "instrumentation/grizzly-2/src/main/java/io/opentelemetry/auto/instrumentation/grizzly/GrizzlyHttpHandlerInstrumentation.java", "diffHunk": "@@ -66,39 +64,44 @@ public boolean defaultEnabled() {\n   public static class HandleAdvice {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n-    public static AgentScope methodEnter(@Advice.Argument(0) final Request request) {\n+    public static SpanScopePair methodEnter(@Advice.Argument(0) final Request request) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxMDMzOA=="}, "originalCommit": {"oid": "d3d5a8e7ef5ddeeb8f5289790b66fcd9df66c538"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNzYyOTc2OnYy", "diffSide": "RIGHT", "path": "instrumentation/grizzly-2/src/main/java/io/opentelemetry/auto/instrumentation/grizzly/GrizzlyHttpHandlerInstrumentation.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMTo1NDoxMVrOFj7LZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMTo1NzoxNlrOFj7Q0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNDA1Mg==", "bodyText": "hmm. If this is the API that we're providing for this in the opentelemetry-java API, it makes me a little sad. Is there a better way to do this than requiring everyone to catch this?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/108#discussion_r373214052", "createdAt": "2020-01-30T21:54:11Z", "author": {"login": "jkwatson"}, "path": "instrumentation/grizzly-2/src/main/java/io/opentelemetry/auto/instrumentation/grizzly/GrizzlyHttpHandlerInstrumentation.java", "diffHunk": "@@ -66,39 +64,44 @@ public boolean defaultEnabled() {\n   public static class HandleAdvice {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n-    public static AgentScope methodEnter(@Advice.Argument(0) final Request request) {\n+    public static SpanScopePair methodEnter(@Advice.Argument(0) final Request request) {\n       if (request.getAttribute(SPAN_ATTRIBUTE) != null) {\n         return null;\n       }\n \n-      final Context parentContext = propagate().extract(request, GETTER);\n-      final AgentSpan span = startSpan(\"grizzly.request\", parentContext);\n+      final Span.Builder spanBuilder = TRACER.spanBuilder(\"grizzly.request\");\n+      try {\n+        final SpanContext extractedContext = TRACER.getHttpTextFormat().extract(request, GETTER);\n+        spanBuilder.setParent(extractedContext);\n+      } catch (final IllegalArgumentException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3d5a8e7ef5ddeeb8f5289790b66fcd9df66c538"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNTAzNw==", "bodyText": "see open-telemetry/opentelemetry-java#767", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/108#discussion_r373215037", "createdAt": "2020-01-30T21:56:20Z", "author": {"login": "trask"}, "path": "instrumentation/grizzly-2/src/main/java/io/opentelemetry/auto/instrumentation/grizzly/GrizzlyHttpHandlerInstrumentation.java", "diffHunk": "@@ -66,39 +64,44 @@ public boolean defaultEnabled() {\n   public static class HandleAdvice {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n-    public static AgentScope methodEnter(@Advice.Argument(0) final Request request) {\n+    public static SpanScopePair methodEnter(@Advice.Argument(0) final Request request) {\n       if (request.getAttribute(SPAN_ATTRIBUTE) != null) {\n         return null;\n       }\n \n-      final Context parentContext = propagate().extract(request, GETTER);\n-      final AgentSpan span = startSpan(\"grizzly.request\", parentContext);\n+      final Span.Builder spanBuilder = TRACER.spanBuilder(\"grizzly.request\");\n+      try {\n+        final SpanContext extractedContext = TRACER.getHttpTextFormat().extract(request, GETTER);\n+        spanBuilder.setParent(extractedContext);\n+      } catch (final IllegalArgumentException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNDA1Mg=="}, "originalCommit": {"oid": "d3d5a8e7ef5ddeeb8f5289790b66fcd9df66c538"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNTQ0MA==", "bodyText": "ah! sweet. awesome. I hadn't connected the dots.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/108#discussion_r373215440", "createdAt": "2020-01-30T21:57:16Z", "author": {"login": "jkwatson"}, "path": "instrumentation/grizzly-2/src/main/java/io/opentelemetry/auto/instrumentation/grizzly/GrizzlyHttpHandlerInstrumentation.java", "diffHunk": "@@ -66,39 +64,44 @@ public boolean defaultEnabled() {\n   public static class HandleAdvice {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n-    public static AgentScope methodEnter(@Advice.Argument(0) final Request request) {\n+    public static SpanScopePair methodEnter(@Advice.Argument(0) final Request request) {\n       if (request.getAttribute(SPAN_ATTRIBUTE) != null) {\n         return null;\n       }\n \n-      final Context parentContext = propagate().extract(request, GETTER);\n-      final AgentSpan span = startSpan(\"grizzly.request\", parentContext);\n+      final Span.Builder spanBuilder = TRACER.spanBuilder(\"grizzly.request\");\n+      try {\n+        final SpanContext extractedContext = TRACER.getHttpTextFormat().extract(request, GETTER);\n+        spanBuilder.setParent(extractedContext);\n+      } catch (final IllegalArgumentException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNDA1Mg=="}, "originalCommit": {"oid": "d3d5a8e7ef5ddeeb8f5289790b66fcd9df66c538"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNzY0MTczOnYy", "diffSide": "RIGHT", "path": "instrumentation/jetty-8/src/main/java/io/opentelemetry/auto/instrumentation/jetty8/JettyHandlerAdvice.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMTo1ODoyM1rOFj7StQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMzoxMDo0MlrOFj8-Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNTkyNQ==", "bodyText": "once we have a real SpanWithScope, it makes sense to add a close() method to it, I think.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/108#discussion_r373215925", "createdAt": "2020-01-30T21:58:23Z", "author": {"login": "jkwatson"}, "path": "instrumentation/jetty-8/src/main/java/io/opentelemetry/auto/instrumentation/jetty8/JettyHandlerAdvice.java", "diffHunk": "@@ -80,9 +83,9 @@ public static void stopSpan(\n       if (!req.isAsyncStarted() && activated.compareAndSet(false, true)) {\n         DECORATE.onResponse(span, resp);\n         DECORATE.beforeFinish(span);\n-        span.finish(); // Finish the span manually since finishSpanOnClose was false\n+        span.end(); // Finish the span manually since finishSpanOnClose was false\n       }\n     }\n-    scope.close();\n+    spanScopePair.getScope().close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3d5a8e7ef5ddeeb8f5289790b66fcd9df66c538"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIyMjQxNA==", "bodyText": "i hesitated to add close() because people might think that method applies to both the span and scope (ending the span in addition to closing the scope).\nand there's no need to implement Closeable, since this class isn't used in try-with-resource, at least in auto instrumentation (where this class is needed/used to pass the values from one method to another), though i could see contrib instrumentation wanting to use it in try-with-resource...", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/108#discussion_r373222414", "createdAt": "2020-01-30T22:13:52Z", "author": {"login": "trask"}, "path": "instrumentation/jetty-8/src/main/java/io/opentelemetry/auto/instrumentation/jetty8/JettyHandlerAdvice.java", "diffHunk": "@@ -80,9 +83,9 @@ public static void stopSpan(\n       if (!req.isAsyncStarted() && activated.compareAndSet(false, true)) {\n         DECORATE.onResponse(span, resp);\n         DECORATE.beforeFinish(span);\n-        span.finish(); // Finish the span manually since finishSpanOnClose was false\n+        span.end(); // Finish the span manually since finishSpanOnClose was false\n       }\n     }\n-    scope.close();\n+    spanScopePair.getScope().close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNTkyNQ=="}, "originalCommit": {"oid": "d3d5a8e7ef5ddeeb8f5289790b66fcd9df66c538"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI0MjU5NQ==", "bodyText": "yeah, maybe a \"closeScope\" would be more clear.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/108#discussion_r373242595", "createdAt": "2020-01-30T23:07:57Z", "author": {"login": "jkwatson"}, "path": "instrumentation/jetty-8/src/main/java/io/opentelemetry/auto/instrumentation/jetty8/JettyHandlerAdvice.java", "diffHunk": "@@ -80,9 +83,9 @@ public static void stopSpan(\n       if (!req.isAsyncStarted() && activated.compareAndSet(false, true)) {\n         DECORATE.onResponse(span, resp);\n         DECORATE.beforeFinish(span);\n-        span.finish(); // Finish the span manually since finishSpanOnClose was false\n+        span.end(); // Finish the span manually since finishSpanOnClose was false\n       }\n     }\n-    scope.close();\n+    spanScopePair.getScope().close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNTkyNQ=="}, "originalCommit": {"oid": "d3d5a8e7ef5ddeeb8f5289790b66fcd9df66c538"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI0MzQ5MA==", "bodyText": "i like that, then don't need getScope(), i'll add that note to #114", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/108#discussion_r373243490", "createdAt": "2020-01-30T23:10:42Z", "author": {"login": "trask"}, "path": "instrumentation/jetty-8/src/main/java/io/opentelemetry/auto/instrumentation/jetty8/JettyHandlerAdvice.java", "diffHunk": "@@ -80,9 +83,9 @@ public static void stopSpan(\n       if (!req.isAsyncStarted() && activated.compareAndSet(false, true)) {\n         DECORATE.onResponse(span, resp);\n         DECORATE.beforeFinish(span);\n-        span.finish(); // Finish the span manually since finishSpanOnClose was false\n+        span.end(); // Finish the span manually since finishSpanOnClose was false\n       }\n     }\n-    scope.close();\n+    spanScopePair.getScope().close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNTkyNQ=="}, "originalCommit": {"oid": "d3d5a8e7ef5ddeeb8f5289790b66fcd9df66c538"}, "originalPosition": 99}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 631, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}