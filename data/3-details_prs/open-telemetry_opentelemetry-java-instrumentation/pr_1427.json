{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2NzAyMzkw", "number": 1427, "title": "Cassandra instrumentations should store normalised CQL queries as db.statement", "bodyText": "Resolves #1407\n\nMove DbSystem to package ...instrumentation.api.db\nMove SqlNormalizer to javaagent-api\nRefactor Cassandra 3.0 tests so that they use testcontainers (and run on Java 11)\nImplement Cassandra statement normalization", "createdAt": "2020-10-20T11:11:02Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1427", "merged": true, "mergeCommit": {"oid": "50990a7c17e06787b6ceea6177463da54674c9e2"}, "closed": true, "closedAt": "2020-10-22T15:56:07Z", "author": {"login": "mateuszrzeszutek"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUW2OyAFqTUxMjU5MzU3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdU-f65ABqjM5MDgwMjgwNzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNTkzNTcw", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1427#pullrequestreview-512593570", "createdAt": "2020-10-20T11:12:51Z", "commit": {"oid": "e1840b8e49ec380c61264fc977a9ab2deb71836b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMToxMjo1MVrOHk3JxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMToxMjo1MVrOHk3JxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQxNDQwNQ==", "bodyText": "Should I change Cassandra 4.0 tests to use testcontainers as well? WDYT?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1427#discussion_r508414405", "createdAt": "2020-10-20T11:12:51Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/cassandra/cassandra-3.0/src/test/groovy/CassandraClientTest.groovy", "diffHunk": "@@ -13,39 +13,45 @@ import io.opentelemetry.instrumentation.test.AgentTestRunner\n import io.opentelemetry.instrumentation.test.asserts.TraceAssert\n import io.opentelemetry.sdk.trace.data.SpanData\n import io.opentelemetry.trace.attributes.SemanticAttributes\n+import java.time.Duration\n import java.util.concurrent.Executors\n import java.util.concurrent.atomic.AtomicBoolean\n-import org.cassandraunit.utils.EmbeddedCassandraServerHelper\n+import org.slf4j.Logger\n+import org.slf4j.LoggerFactory\n+import org.testcontainers.containers.GenericContainer\n+import org.testcontainers.containers.output.Slf4jLogConsumer\n import spock.lang.Shared\n \n class CassandraClientTest extends AgentTestRunner {\n+  private static final Logger log = LoggerFactory.getLogger(CassandraClientTest)\n \n   @Shared\n-  Cluster cluster\n+  def executor = Executors.newCachedThreadPool()\n \n   @Shared\n-  def executor = Executors.newCachedThreadPool()\n+  GenericContainer cassandra\n+  @Shared\n+  int cassandraPort\n+  @Shared\n+  Cluster cluster\n \n   def setupSpec() {\n-    /*\n-     This timeout seems excessive but we've seen tests fail with timeout of 40s.\n-     TODO: if we continue to see failures we may want to consider using 'real' Cassandra\n-     started in container like we do for memcached. Note: this will complicate things because\n-     tests would have to assume they run under shared Cassandra and act accordingly.\n-      */\n-    EmbeddedCassandraServerHelper.startEmbeddedCassandra(EmbeddedCassandraServerHelper.CASSANDRA_RNDPORT_YML_FILE, 120000L)\n-\n-    cluster = EmbeddedCassandraServerHelper.getCluster()\n-\n-    /*\n-    Looks like sometimes our requests fail because Cassandra takes to long to respond,\n-    Increase this timeout as well to try to cope with this.\n-     */\n-    cluster.getConfiguration().getSocketOptions().setReadTimeoutMillis(120000)\n+    cassandra = new GenericContainer(\"cassandra:3\")\n+      .withExposedPorts(9042)\n+      .withLogConsumer(new Slf4jLogConsumer(log))\n+      .withStartupTimeout(Duration.ofSeconds(120))\n+    cassandra.start()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1840b8e49ec380c61264fc977a9ab2deb71836b"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNjUxMjEz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1427#pullrequestreview-512651213", "createdAt": "2020-10-20T12:29:08Z", "commit": {"oid": "21411639181b1718429b53a8bd1d722fb7520113"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMjoyOTowOVrOHk52DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMjoyOTowOVrOHk52DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ1ODUwOA==", "bodyText": "I don't like this new package structure. How many classes in total are there under io.opentelemetry.javaagent.instrumentation.api.db package? Do we really need to split them even more into several subpackages?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1427#discussion_r508458508", "createdAt": "2020-10-20T12:29:09Z", "author": {"login": "iNikem"}, "path": "javaagent-api/src/main/java/io/opentelemetry/javaagent/instrumentation/api/db/cassandra/CassandraQueryNormalizer.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.api.db.cassandra;\n+\n+import io.opentelemetry.javaagent.instrumentation.api.db.sql.normalizer.ParseException;\n+import io.opentelemetry.javaagent.instrumentation.api.db.sql.normalizer.SqlNormalizer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21411639181b1718429b53a8bd1d722fb7520113"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMjUxOTEz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1427#pullrequestreview-513251913", "createdAt": "2020-10-21T01:54:04Z", "commit": {"oid": "5bae7d96ac93d95187e14c739ac19825675f1467"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwMTo1NDowNFrOHlXWWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwMjoyNjowMlrOHlX36w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk0MTkxNA==", "bodyText": "\ud83e\udd73", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1427#discussion_r508941914", "createdAt": "2020-10-21T01:54:04Z", "author": {"login": "trask"}, "path": "instrumentation/cassandra/cassandra-3.0/cassandra-3.0.gradle", "diffHunk": "@@ -1,8 +1,5 @@\n // Set properties before any plugins get loaded\n ext {\n-  // TODO switch to container-based tests (away from cassandraunit)\n-  // Tests use cassandraunit, which runs embedded Cassandra 3, which is currently incompatible with Java 9.\n-  maxJavaVersionForTests = JavaVersion.VERSION_1_8", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bae7d96ac93d95187e14c739ac19825675f1467"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk0NDk0OA==", "bodyText": "this feels cassandra-specific enough, and small enough, to not include in the api", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1427#discussion_r508944948", "createdAt": "2020-10-21T02:05:30Z", "author": {"login": "trask"}, "path": "javaagent-api/src/main/java/io/opentelemetry/javaagent/instrumentation/api/db/CassandraQueryNormalizer.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.api.db;\n+\n+import io.opentelemetry.javaagent.instrumentation.api.db.normalizer.ParseException;\n+import io.opentelemetry.javaagent.instrumentation.api.db.normalizer.SqlNormalizer;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class CassandraQueryNormalizer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bae7d96ac93d95187e14c739ac19825675f1467"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk1MDUwNw==", "bodyText": "how about io.opentelemetry.javaagent.instrumentation.api.normalizer?\ni'm hoping io.opentelemetry.javaagent.instrumentation.api.db.DbSystem may go away open-telemetry/opentelemetry-java#1841, which would then leave .db empty\nalso, maybe it should go in instrumentation-api? (we can also decide this later)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1427#discussion_r508950507", "createdAt": "2020-10-21T02:26:02Z", "author": {"login": "trask"}, "path": "javaagent-api/src/main/javacc/SqlNormalizer.jj", "diffHunk": "@@ -22,7 +11,7 @@ options {\n \n PARSER_BEGIN(SqlNormalizer)\n \n-package io.opentelemetry.javaagent.instrumentation.jdbc.normalizer;\n+package io.opentelemetry.javaagent.instrumentation.api.db.normalizer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bae7d96ac93d95187e14c739ac19825675f1467"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNDI0MjA0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1427#pullrequestreview-513424204", "createdAt": "2020-10-21T08:23:08Z", "commit": {"oid": "5bae7d96ac93d95187e14c739ac19825675f1467"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bae7d96ac93d95187e14c739ac19825675f1467", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5bae7d96ac93d95187e14c739ac19825675f1467", "committedDate": "2020-10-20T14:27:58Z", "message": "Move SqlNormalizer to package ...api.db.normalizer"}, "afterCommit": {"oid": "99fa6a20bb997ccc1a374ee4a1a791bb268f2312", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/99fa6a20bb997ccc1a374ee4a1a791bb268f2312", "committedDate": "2020-10-21T09:52:11Z", "message": "Move CassandraQueryNormalizer to cassandra instrumentations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTg4NzM0", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1427#pullrequestreview-514188734", "createdAt": "2020-10-21T21:10:43Z", "commit": {"oid": "2c8f610df63d8504aa55b9d95ca879f7313d93e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fc74a00013f301ac17f08a15e6d1cd7d662f06c", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0fc74a00013f301ac17f08a15e6d1cd7d662f06c", "committedDate": "2020-10-22T09:24:28Z", "message": "Cassandra instrumentations should store normalised CQL queries as db.statement\n\n* Move `DbSystem` to package `...instrumentation.api.db`\n* Move `SqlNormalizer` to `javaagent-api`\n* Refactor Cassandra 3.0 tests so that they use testcontainers (and run on Java 11)\n* Implement Cassandra statement normalization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20e4c301e8b4b4b67757fad6ce34289f5a2517aa", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/20e4c301e8b4b4b67757fad6ce34289f5a2517aa", "committedDate": "2020-10-22T09:24:28Z", "message": "spotbugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bed1b940ccaa323040907570a6a437b727c8c62e", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/bed1b940ccaa323040907570a6a437b727c8c62e", "committedDate": "2020-10-22T09:24:28Z", "message": "Remove no longer needed classes from JDBC instrumentations' helperClassNames()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87ae8d79f28e32c5ae97cacf1dd9ea2a3698c352", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/87ae8d79f28e32c5ae97cacf1dd9ea2a3698c352", "committedDate": "2020-10-22T09:24:28Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4334831327a7c571a0bb49fe21b15356e2ed012c", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4334831327a7c571a0bb49fe21b15356e2ed012c", "committedDate": "2020-10-22T09:24:28Z", "message": "Use testcontainers in cassandra 4.0 tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97424dceb7ca60b7d4ca8ef6909125582a6e2553", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/97424dceb7ca60b7d4ca8ef6909125582a6e2553", "committedDate": "2020-10-22T09:24:28Z", "message": "Move SqlNormalizer to package ...api.db.normalizer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16b885645e02b9920c3528b75f41087e2a54e2af", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/16b885645e02b9920c3528b75f41087e2a54e2af", "committedDate": "2020-10-22T09:24:28Z", "message": "Move CassandraQueryNormalizer to cassandra instrumentations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd417f913b259470f9ec18c72b9074831e0f02d1", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/bd417f913b259470f9ec18c72b9074831e0f02d1", "committedDate": "2020-10-22T09:24:28Z", "message": "muzzle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1d6cc0cbb438a177fbc353ad45ad95215179ddf", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d1d6cc0cbb438a177fbc353ad45ad95215179ddf", "committedDate": "2020-10-22T09:24:28Z", "message": "Exclude Cassandra tests from CircleCI"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c8f610df63d8504aa55b9d95ca879f7313d93e0", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2c8f610df63d8504aa55b9d95ca879f7313d93e0", "committedDate": "2020-10-21T16:31:08Z", "message": "Exclude Cassandra tests from CircleCI"}, "afterCommit": {"oid": "d1d6cc0cbb438a177fbc353ad45ad95215179ddf", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d1d6cc0cbb438a177fbc353ad45ad95215179ddf", "committedDate": "2020-10-22T09:24:28Z", "message": "Exclude Cassandra tests from CircleCI"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2371, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}