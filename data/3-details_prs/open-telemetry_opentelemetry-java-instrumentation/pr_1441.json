{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NTc1MzE0", "number": 1441, "title": "Log normalised full statement in Redis instrumentations", "bodyText": "Resolves #1406\nImplemented for: Lettuce 5.0, Jedis and Redisson.\nLettuce 4.0 was skipped because args are not accessible, they're written straight into the command's byte array.\nRediscala was skipped because it has a separate class for every command, and every class has separate fields for the command's args. It pretty much requires writing a separate normalizer.", "createdAt": "2020-10-21T14:02:27Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441", "merged": true, "mergeCommit": {"oid": "35dc9071ef00aeb7e10e9442c52b594f3d1ec503"}, "closed": true, "closedAt": "2020-10-27T21:29:48Z", "author": {"login": "mateuszrzeszutek"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdU_y8XgFqTUxNDU4NzkwNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWphZGgBqjM5MjYxMjIyNjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NTg3OTA1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#pullrequestreview-514587905", "createdAt": "2020-10-22T10:37:08Z", "commit": {"oid": "270b7cc11876285f433d04744ece70af6a43c826"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMDozNzowOFrOHmbeAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMDo1NDozNlrOHmcDeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA1Nzk4Ng==", "bodyText": "Why this is removed?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r510057986", "createdAt": "2020-10-22T10:37:08Z", "author": {"login": "iNikem"}, "path": "instrumentation/jedis/jedis-3.0/src/main/java/io/opentelemetry/javaagent/instrumentation/jedis/v3_0/JedisInstrumentation.java", "diffHunk": "@@ -59,14 +63,10 @@ public JedisInstrumentation() {\n     public static void onEnter(\n         @Advice.This Connection connection,\n         @Advice.Argument(0) ProtocolCommand command,\n+        @Advice.Argument(1) byte[][] args,\n         @Advice.Local(\"otelSpan\") Span span,\n         @Advice.Local(\"otelScope\") Scope scope) {\n-      int callDepth = CallDepthThreadLocalMap.incrementCallDepth(Connection.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270b7cc11876285f433d04744ece70af6a43c826"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA1OTIyMQ==", "bodyText": "I am not sure about this. foo here is cache key, right? Thus its cardinality is high. Thousands and millions potentially. Semantic convention says that span name should be low-cardinality value. select * from table_name is Ok span name, but here in Redis having cache key as part of the name - I am not sure.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r510059221", "createdAt": "2020-10-22T10:39:33Z", "author": {"login": "iNikem"}, "path": "instrumentation/jedis/jedis-3.0/src/test/groovy/Jedis30ClientTest.groovy", "diffHunk": "@@ -76,29 +76,29 @@ class Jedis30ClientTest extends AgentTestRunner {\n     assertTraces(2) {\n       trace(0, 1) {\n         span(0) {\n-          name \"SET\"\n+          name \"SET foo ?\"\n           kind CLIENT\n           attributes {\n-            \"${SemanticAttributes.DB_SYSTEM.key()}\" \"redis\"\n-            \"${SemanticAttributes.DB_CONNECTION_STRING.key()}\" \"localhost:$port\"\n-            \"${SemanticAttributes.DB_STATEMENT.key()}\" \"SET\"\n-            \"${SemanticAttributes.NET_PEER_IP.key()}\" \"127.0.0.1\"\n-            \"${SemanticAttributes.NET_PEER_NAME.key()}\" \"localhost\"\n-            \"${SemanticAttributes.NET_PEER_PORT.key()}\" port\n+            \"$SemanticAttributes.DB_SYSTEM.key\" \"redis\"\n+            \"$SemanticAttributes.DB_CONNECTION_STRING.key\" \"localhost:$port\"\n+            \"$SemanticAttributes.DB_STATEMENT.key\" \"SET foo ?\"\n+            \"$SemanticAttributes.NET_PEER_IP.key\" \"127.0.0.1\"\n+            \"$SemanticAttributes.NET_PEER_NAME.key\" \"localhost\"\n+            \"$SemanticAttributes.NET_PEER_PORT.key\" port\n           }\n         }\n       }\n       trace(1, 1) {\n         span(0) {\n-          name \"GET\"\n+          name \"GET foo\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270b7cc11876285f433d04744ece70af6a43c826"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA2NzU3OA==", "bodyText": "Can args be List<Object>? This would eliminate this stream and thus extra allocations.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r510067578", "createdAt": "2020-10-22T10:54:36Z", "author": {"login": "iNikem"}, "path": "instrumentation/redisson-3.0/src/main/java/io/opentelemetry/javaagent/instrumentation/redisson/RedissonClientTracer.java", "diffHunk": "@@ -24,24 +28,33 @@ protected String getInstrumentationName() {\n   }\n \n   @Override\n-  protected String normalizeQuery(Object args) {\n+  protected String normalizeQuery(Object command) {\n     // get command\n-    if (args instanceof CommandsData) {\n-      List<CommandData<?, ?>> commands = ((CommandsData) args).getCommands();\n+    if (command instanceof CommandsData) {\n+      List<CommandData<?, ?>> commands = ((CommandsData) command).getCommands();\n       StringBuilder commandStrings = new StringBuilder();\n-      for (CommandData commandData : commands) {\n-        commandStrings.append(commandData.getCommand().getName()).append(\";\");\n+      for (CommandData<?, ?> commandData : commands) {\n+        commandStrings.append(normalizeSingleCommand(commandData)).append(\";\");\n       }\n       if (commandStrings.length() > 0) {\n         commandStrings.deleteCharAt(commandStrings.length() - 1);\n       }\n       return commandStrings.toString();\n-    } else if (args instanceof CommandData) {\n-      return ((CommandData) args).getCommand().getName();\n+    } else if (command instanceof CommandData) {\n+      return normalizeSingleCommand((CommandData<?, ?>) command);\n     }\n     return \"Redis Command\";\n   }\n \n+  private static String normalizeSingleCommand(CommandData<?, ?> command) {\n+    List<String> args = new ArrayList<>();\n+    if (command.getCommand().getSubName() != null) {\n+      args.add(command.getCommand().getSubName());\n+    }\n+    args.addAll(Stream.of(command.getParams()).map(String::valueOf).collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270b7cc11876285f433d04744ece70af6a43c826"}, "originalPosition": 48}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "270b7cc11876285f433d04744ece70af6a43c826", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/270b7cc11876285f433d04744ece70af6a43c826", "committedDate": "2020-10-21T13:54:24Z", "message": "Log normalised full statement in Redis instrumentations (jedis, lettuce, redisson)"}, "afterCommit": {"oid": "cdde6c6a7ffc8b5d65d43c4d2aad86042ff5f894", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cdde6c6a7ffc8b5d65d43c4d2aad86042ff5f894", "committedDate": "2020-10-26T15:31:19Z", "message": "Log only command in redis span names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTg0NTQ4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#pullrequestreview-516984548", "createdAt": "2020-10-26T16:54:43Z", "commit": {"oid": "cdde6c6a7ffc8b5d65d43c4d2aad86042ff5f894"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDY1NDM5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#pullrequestreview-517065439", "createdAt": "2020-10-26T18:30:31Z", "commit": {"oid": "cdde6c6a7ffc8b5d65d43c4d2aad86042ff5f894"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxODozMDozMVrOHodCYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxODozMDozMVrOHodCYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE4MDgzNA==", "bodyText": "can we extract constant for new byte[0][] to avoid allocating each time?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#discussion_r512180834", "createdAt": "2020-10-26T18:30:31Z", "author": {"login": "trask"}, "path": "instrumentation/jedis/jedis-1.4/src/main/java/io/opentelemetry/javaagent/instrumentation/jedis/v1_4/JedisInstrumentation.java", "diffHunk": "@@ -47,34 +50,81 @@ public JedisInstrumentation() {\n   @Override\n   public String[] helperClassNames() {\n     return new String[] {\n-      packageName + \".JedisClientTracer\",\n+      packageName + \".JedisClientTracer$CommandWithArgs\", packageName + \".JedisClientTracer\",\n     };\n   }\n \n   @Override\n   public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n-    return singletonMap(\n+    // FIXME: This instrumentation only incorporates sending the command, not processing the result.\n+    Map<ElementMatcher.Junction<MethodDescription>, String> transformers = new HashMap<>();\n+    transformers.put(\n         isMethod()\n             .and(named(\"sendCommand\"))\n+            .and(takesArguments(1))\n             .and(takesArgument(0, named(\"redis.clients.jedis.Protocol$Command\"))),\n-        JedisInstrumentation.class.getName() + \"$JedisAdvice\");\n-    // FIXME: This instrumentation only incorporates sending the command, not processing the result.\n+        JedisInstrumentation.class.getName() + \"$JedisNoArgsAdvice\");\n+    transformers.put(\n+        isMethod()\n+            .and(named(\"sendCommand\"))\n+            .and(takesArguments(2))\n+            .and(takesArgument(0, named(\"redis.clients.jedis.Protocol$Command\")))\n+            .and(takesArgument(1, is(byte[][].class))),\n+        JedisInstrumentation.class.getName() + \"$JedisArgsAdvice\");\n+    return transformers;\n+  }\n+\n+  public static class JedisNoArgsAdvice {\n+\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    public static void onEnter(\n+        @Advice.This Connection connection,\n+        @Advice.Argument(0) Command command,\n+        @Advice.Local(\"otelSpan\") Span span,\n+        @Advice.Local(\"otelScope\") Scope scope) {\n+      int callDepth = CallDepthThreadLocalMap.incrementCallDepth(Connection.class);\n+      if (callDepth > 0) {\n+        return;\n+      }\n+\n+      span = TRACER.startSpan(connection, new CommandWithArgs(command, new byte[0][]));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdde6c6a7ffc8b5d65d43c4d2aad86042ff5f894"}, "originalPosition": 67}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d80067927f7195eee4c6d6ca7c03f51e110f75f2", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d80067927f7195eee4c6d6ca7c03f51e110f75f2", "committedDate": "2020-10-27T10:03:13Z", "message": "Apply code review comments"}, "afterCommit": {"oid": "a46d2a21cda879f929f1ba43bb6e5a5487aab666", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a46d2a21cda879f929f1ba43bb6e5a5487aab666", "committedDate": "2020-10-27T10:27:40Z", "message": "Apply code review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NjUzMzM1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1441#pullrequestreview-517653335", "createdAt": "2020-10-27T12:35:36Z", "commit": {"oid": "a46d2a21cda879f929f1ba43bb6e5a5487aab666"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d72f77050fe469462210456a4a550dec42e0d25", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3d72f77050fe469462210456a4a550dec42e0d25", "committedDate": "2020-10-27T14:05:53Z", "message": "Log normalised full statement in Redis instrumentations (jedis, lettuce, redisson)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ce878dc0a3f15cbc47ccd19d244c20986cc6bb7", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/7ce878dc0a3f15cbc47ccd19d244c20986cc6bb7", "committedDate": "2020-10-27T14:05:53Z", "message": "Use List<?> for command args to avoid unnecessary allocation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "895b5ddd84585786311f6ea2ccbe84a3b2a02aa2", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/895b5ddd84585786311f6ea2ccbe84a3b2a02aa2", "committedDate": "2020-10-27T14:05:53Z", "message": "Log only command in redis span names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27da9ce2e515b0dcaa6f045ab36f4fcaec3ac34f", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/27da9ce2e515b0dcaa6f045ab36f4fcaec3ac34f", "committedDate": "2020-10-27T14:05:53Z", "message": "Apply code review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a46d2a21cda879f929f1ba43bb6e5a5487aab666", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a46d2a21cda879f929f1ba43bb6e5a5487aab666", "committedDate": "2020-10-27T10:27:40Z", "message": "Apply code review comments"}, "afterCommit": {"oid": "27da9ce2e515b0dcaa6f045ab36f4fcaec3ac34f", "author": {"user": {"login": "mateuszrzeszutek", "name": "Mateusz Rzeszutek"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/27da9ce2e515b0dcaa6f045ab36f4fcaec3ac34f", "committedDate": "2020-10-27T14:05:53Z", "message": "Apply code review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2378, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}