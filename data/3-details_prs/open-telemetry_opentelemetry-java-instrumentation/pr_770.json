{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NTc1MTYx", "number": 770, "title": "Run tests using JUnit5 platform and remove SpockRunner", "bodyText": "I noticed that we're adding junit platform tests in the spring instrumentation and figured it'd be good if we go ahead and upgrade to give us the option of using it. I'm still interested in doing a side-by-side comparison of spock and junit5 just to see :)\nThis also tries to simplify the tests by removing SpockRunner - only three tests actually depended on its behavior, and it seems OK to let Gradle take care of the classloader isolation instead of using a JUnit runner which constrains options for the future.", "createdAt": "2020-07-23T09:10:58Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770", "merged": true, "mergeCommit": {"oid": "0eafc286085043da8151d2050327548919ac429a"}, "closed": true, "closedAt": "2020-08-12T02:05:27Z", "author": {"login": "anuraaga"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3rxrnABqjM1NzkwODI3MTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc91EbWAH2gAyNDU1NTc1MTYxOmJmMmJhNjY0NjkzNmFiN2Q2ZmZlMGRhNDJkNWViOWI4YmE2MTQxZmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc5200d7f2686657dcc9e603dffb6a3008600fa7", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cc5200d7f2686657dcc9e603dffb6a3008600fa7", "committedDate": "2020-07-23T08:54:24Z", "message": "Run tests using JUnit5 platform"}, "afterCommit": {"oid": "ca6e7173242d67bd4064f49b82f105acfd0bbd72", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ca6e7173242d67bd4064f49b82f105acfd0bbd72", "committedDate": "2020-07-23T09:03:34Z", "message": "Run tests using JUnit5 platform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5549e2b172643ad27768e6fca49694550931eb3", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d5549e2b172643ad27768e6fca49694550931eb3", "committedDate": "2020-08-03T08:47:53Z", "message": "Run tests with JUnit platform"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2358e49d5e8eae09bd255e370e0ca0b7944a3d8a", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2358e49d5e8eae09bd255e370e0ca0b7944a3d8a", "committedDate": "2020-07-30T05:53:10Z", "message": "Merge branch 'junit-platform' of github.com:anuraaga/opentelemetry-auto-instr-java into junit-platform"}, "afterCommit": {"oid": "d5549e2b172643ad27768e6fca49694550931eb3", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d5549e2b172643ad27768e6fca49694550931eb3", "committedDate": "2020-08-03T08:47:53Z", "message": "Run tests with JUnit platform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a8ba9a92ca943032e1d890f4f5bb13e86efccf4", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4a8ba9a92ca943032e1d890f4f5bb13e86efccf4", "committedDate": "2020-08-03T08:52:38Z", "message": "Matcher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODU2OTAz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#pullrequestreview-459856903", "createdAt": "2020-08-03T08:52:43Z", "commit": {"oid": "d5549e2b172643ad27768e6fca49694550931eb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODo1Mjo0M1rOG6xY9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODo1Mjo0M1rOG6xY9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI3OTc5Nw==", "bodyText": "In this PR PlayJavaWEClientTest fails because of invalid header name characters (space) which looks correct to me... The Play tests have a couple other assertions that fail (TimeoutException vs ConnectException) that seem similarly like they should be failing, as if on current master we're not actually running these tests so I need to investigate more what's going on...", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r464279797", "createdAt": "2020-08-03T08:52:43Z", "author": {"login": "anuraaga"}, "path": "testing-common/src/main/groovy/io/opentelemetry/auto/test/base/HttpClientTest.groovy", "diffHunk": "@@ -42,7 +42,7 @@ import static org.junit.Assume.assumeTrue\n abstract class HttpClientTest extends AgentTestRunner {\n   protected static final BODY_METHODS = [\"POST\", \"PUT\"]\n   protected static final CONNECT_TIMEOUT_MS = 1000\n-  protected static final BASIC_AUTH_KEY = \"custom authorization header\"\n+  protected static final BASIC_AUTH_KEY = \"custom-authorization-header\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5549e2b172643ad27768e6fca49694550931eb3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0cb3396b643816e1847b682f136e14a7e7b5c14", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b0cb3396b643816e1847b682f136e14a7e7b5c14", "committedDate": "2020-08-03T09:16:04Z", "message": "Restore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c70bd27cee544542dec733e367ae65f07ba1dd39", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c70bd27cee544542dec733e367ae65f07ba1dd39", "committedDate": "2020-08-04T05:28:22Z", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into junit-platform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29cb1fc8a446d21038c4c3b3a396606e7006a6ae", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/29cb1fc8a446d21038c4c3b3a396606e7006a6ae", "committedDate": "2020-08-04T05:35:08Z", "message": "Don't mix JUnit4 with JUunit5 in spring tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dc18c14f3df6801698f4e1006bc20ac3a8288ec", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/5dc18c14f3df6801698f4e1006bc20ac3a8288ec", "committedDate": "2020-08-04T05:40:16Z", "message": "Merge branch 'spring-no-mix-junit4' into junit-platform"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTIxOTIz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#pullrequestreview-460521923", "createdAt": "2020-08-04T06:13:39Z", "commit": {"oid": "5dc18c14f3df6801698f4e1006bc20ac3a8288ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNjoxMzozOVrOG7Se-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNjoxMzozOVrOG7Se-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgyMjAxMQ==", "bodyText": "@trask Yup! My biggest concern right now is this test, not sure why it's not passing with JUnit5. The issues with assumeTrue I'll need to file an issue with JUnit team for.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r464822011", "createdAt": "2020-08-04T06:13:39Z", "author": {"login": "anuraaga"}, "path": "agent-tooling/src/test/groovy/io/opentelemetry/auto/test/HelperInjectionTest.groovy", "diffHunk": "@@ -33,13 +32,15 @@ import java.util.concurrent.atomic.AtomicReference\n import static io.opentelemetry.auto.test.utils.ClasspathUtils.isClassLoaded\n import static io.opentelemetry.auto.tooling.ClassLoaderMatcher.BOOTSTRAP_CLASSLOADER\n import static io.opentelemetry.auto.util.gc.GCUtils.awaitGC\n+import static org.junit.Assume.assumeTrue\n \n class HelperInjectionTest extends AgentSpecification {\n \n   @Timeout(10)\n   def \"helpers injected to non-delegating classloader\"() {\n     setup:\n     String helperClassName = HelperInjectionTest.getPackage().getName() + '.HelperClass'\n+    assumeTrue(!isClassLoaded(helperClassName, Utils.getAgentClassLoader()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5dc18c14f3df6801698f4e1006bc20ac3a8288ec"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9521d6614c5eba2ba4e0b1d7b36d89d18ad00ea", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f9521d6614c5eba2ba4e0b1d7b36d89d18ad00ea", "committedDate": "2020-08-04T06:20:49Z", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into junit-platform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65e07fc651d5c4edae25d44602a3189d222715b7", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/65e07fc651d5c4edae25d44602a3189d222715b7", "committedDate": "2020-08-04T06:33:33Z", "message": "Separate out tests that need custom class loader."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6b3540d9271d8f7862c2adf885b55eccf917642", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c6b3540d9271d8f7862c2adf885b55eccf917642", "committedDate": "2020-08-04T07:24:21Z", "message": "Separate out test for a couple classes that need it, try to remove SpockRunner, but Grizzly?"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTYxNDg3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#pullrequestreview-460561487", "createdAt": "2020-08-04T07:28:16Z", "commit": {"oid": "c6b3540d9271d8f7862c2adf885b55eccf917642"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNzoyODoxNlrOG7UbCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNzoyODoxNlrOG7UbCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg1Mzc3MA==", "bodyText": "When I thought I finally had a good mental model of what's going on in our tests, a grizzly shows up \ud83d\udc3b\nI think one of the reasons a couple of test failed is because with JUnit5, there is no way to intercept class loading\njunit-team/junit5#201\nThis is a fundamental aspect of JUnit5 so presumably even when using the vintage engine, the limitation applies.\nI noticed only two tests in the entire repo actually seem to rely on this behavior though, so I gave them special treatment. At that point, it seemed SpockRunner doesn't actually do anything anymore, so I tried removing it completely. Everything worked, except for this one test.\n@trask if you feel like it, maybe you could look at this test without and with SpockRunner and teach me what function it's serving and why it would only affect this test :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r464853770", "createdAt": "2020-08-04T07:28:16Z", "author": {"login": "anuraaga"}, "path": "instrumentation/grizzly-client-1.9/src/test/groovy/GrizzlyAsyncHttpClientTest.groovy", "diffHunk": "@@ -20,10 +20,13 @@ import com.ning.http.client.Request\n import com.ning.http.client.RequestBuilder\n import com.ning.http.client.Response\n import com.ning.http.client.uri.Uri\n+import io.opentelemetry.auto.test.SpockRunner\n import io.opentelemetry.auto.test.base.HttpClientTest\n+import org.junit.runner.RunWith\n import spock.lang.AutoCleanup\n import spock.lang.Shared\n \n+@RunWith(SpockRunner)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6b3540d9271d8f7862c2adf885b55eccf917642"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcc1d8f21e2b565c024f4b6941c62e152d9099cc", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/fcc1d8f21e2b565c024f4b6941c62e152d9099cc", "committedDate": "2020-08-05T04:55:38Z", "message": "Remove SpockRunner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fae9f6daf6dc7455147efc13cb6b7bf3e5ccd6b", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9fae9f6daf6dc7455147efc13cb6b7bf3e5ccd6b", "committedDate": "2020-08-05T07:17:49Z", "message": "Fix grizzly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2178f04b6c077aeac702c0ef89fa96c01e3f1dc9", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2178f04b6c077aeac702c0ef89fa96c01e3f1dc9", "committedDate": "2020-08-06T08:59:54Z", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into junit-platform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85b9d10aa1f6ef41b5443897167c820ae172d235", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/85b9d10aa1f6ef41b5443897167c820ae172d235", "committedDate": "2020-08-06T09:03:34Z", "message": "Remove assumeTrue workaround."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyOTg5MjI5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#pullrequestreview-462989229", "createdAt": "2020-08-07T02:06:04Z", "commit": {"oid": "85b9d10aa1f6ef41b5443897167c820ae172d235"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMDMyMTM4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#pullrequestreview-463032138", "createdAt": "2020-08-07T04:50:29Z", "commit": {"oid": "85b9d10aa1f6ef41b5443897167c820ae172d235"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNDo1MDozMFrOG9MYTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNDo1MTo0MVrOG9MZiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgxOTE1MA==", "bodyText": "Do we need a milestone or current stable is enough?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r466819150", "createdAt": "2020-08-07T04:50:30Z", "author": {"login": "iNikem"}, "path": "gradle/dependencies.gradle", "diffHunk": "@@ -24,6 +24,7 @@ ext {\n     kotlin            : \"1.3.72\",\n     coroutines        : \"1.3.0\",\n     springboot        : \"2.3.1.RELEASE\",\n+    junit5            : \"5.7.0-M1\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85b9d10aa1f6ef41b5443897167c820ae172d235"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgxOTI1NA==", "bodyText": "Do we need both old and new engines?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r466819254", "createdAt": "2020-08-07T04:50:56Z", "author": {"login": "iNikem"}, "path": "gradle/java.gradle", "diffHunk": "@@ -99,6 +99,12 @@ repositories {\n }\n \n dependencies {\n+  testImplementation enforcedPlatform(group: 'org.junit', name: 'junit-bom', version: versions.junit5)\n+  testImplementation group: 'org.junit.jupiter', name: 'junit-jupiter-api'\n+  testImplementation group: 'org.junit.jupiter', name: 'junit-jupiter-params'\n+  testRuntimeOnly group: 'org.junit.jupiter', name: 'junit-jupiter-engine'\n+  testRuntimeOnly group: 'org.junit.vintage', name: 'junit-vintage-engine'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85b9d10aa1f6ef41b5443897167c820ae172d235"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgxOTQ2NQ==", "bodyText": "Why?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/770#discussion_r466819465", "createdAt": "2020-08-07T04:51:41Z", "author": {"login": "iNikem"}, "path": "instrumentation/annotations/annotations.gradle", "diffHunk": "@@ -28,3 +28,17 @@ dependencies {\n     transitive = false\n   }\n }\n+\n+test {\n+  filter {\n+    excludeTestsMatching 'TraceProvidersTest'\n+  }\n+}\n+\n+// Needs a fresh classloader.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85b9d10aa1f6ef41b5443897167c820ae172d235"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f02afd24e7477a35c5c7e0c2a9c1e857136d21b1", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/f02afd24e7477a35c5c7e0c2a9c1e857136d21b1", "committedDate": "2020-08-07T04:56:24Z", "message": "Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "298c7a00e2ba6e68128c2707071012c26d3cadf9", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/298c7a00e2ba6e68128c2707071012c26d3cadf9", "committedDate": "2020-08-09T01:46:56Z", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into junit-platform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf2ba6646936ab7d6ffe0da42d5eb9b8ba6141fe", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/bf2ba6646936ab7d6ffe0da42d5eb9b8ba6141fe", "committedDate": "2020-08-11T11:25:16Z", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-auto-instr-java into junit-platform"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2833, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}