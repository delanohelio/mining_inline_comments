{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5OTE0NDE1", "number": 1910, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNTo0NjozM1rOFFaGRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzowMzo1MFrOFFbfUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjE0NzkwOnYy", "diffSide": "LEFT", "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNTo0NjozM1rOIF5-eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjozNTowMVrOIF7IFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA2MzY3NA==", "bodyText": "I liked this comment", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543063674", "createdAt": "2020-12-15T05:46:33Z", "author": {"login": "anuraaga"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -85,21 +82,19 @@ public static void methodEnter(\n         @Advice.Local(\"otelContext\") Context context,\n         @Advice.Local(\"otelScope\") Scope scope) {\n \n-      ContextStore<HttpRequest, Context> contextStore =\n-          InstrumentationContext.get(HttpRequest.class, Context.class);\n-      context = contextStore.get(request);\n-\n-      if (context == null) {\n-        Context parentContext = currentContext();\n-        if (tracer().shouldStartSpan(parentContext)) {\n-          context = tracer().startSpan(parentContext, request, request.getHeaders());\n-          contextStore.put(request, context);\n-          scope = context.makeCurrent();\n-        }\n-      } else {\n-        // span was created by GoogleHttpClientAsyncAdvice instrumentation below", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f2c7527af6a696e6734c125cfa5c3f7d76b44e5"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4MjUxNg==", "bodyText": "It's back \ud83d\udc4d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543082516", "createdAt": "2020-12-15T06:35:01Z", "author": {"login": "trask"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -85,21 +82,19 @@ public static void methodEnter(\n         @Advice.Local(\"otelContext\") Context context,\n         @Advice.Local(\"otelScope\") Scope scope) {\n \n-      ContextStore<HttpRequest, Context> contextStore =\n-          InstrumentationContext.get(HttpRequest.class, Context.class);\n-      context = contextStore.get(request);\n-\n-      if (context == null) {\n-        Context parentContext = currentContext();\n-        if (tracer().shouldStartSpan(parentContext)) {\n-          context = tracer().startSpan(parentContext, request, request.getHeaders());\n-          contextStore.put(request, context);\n-          scope = context.makeCurrent();\n-        }\n-      } else {\n-        // span was created by GoogleHttpClientAsyncAdvice instrumentation below", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA2MzY3NA=="}, "originalCommit": {"oid": "2f2c7527af6a696e6734c125cfa5c3f7d76b44e5"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjM3MTA4OnYy", "diffSide": "LEFT", "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzowMjoxNVrOIF72dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzowOTo0OVrOIF8ETQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NDM5MQ==", "bodyText": "Is this not needed anymore?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543094391", "createdAt": "2020-12-15T07:02:15Z", "author": {"login": "iNikem"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -85,21 +82,20 @@ public static void methodEnter(\n         @Advice.Local(\"otelContext\") Context context,\n         @Advice.Local(\"otelScope\") Scope scope) {\n \n-      ContextStore<HttpRequest, Context> contextStore =\n-          InstrumentationContext.get(HttpRequest.class, Context.class);\n-      context = contextStore.get(request);\n-\n-      if (context == null) {\n-        Context parentContext = currentContext();\n-        if (tracer().shouldStartSpan(parentContext)) {\n-          context = tracer().startSpan(parentContext, request, request.getHeaders());\n-          contextStore.put(request, context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67165da95b60eb7c3d94d3c0dc2f38741a3086d5"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NzkzMw==", "bodyText": "I don't think it was needed previously. The ContextStore is only needed to propagate Context from the executeAsync() method to the execute() method.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543097933", "createdAt": "2020-12-15T07:09:49Z", "author": {"login": "trask"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -85,21 +82,20 @@ public static void methodEnter(\n         @Advice.Local(\"otelContext\") Context context,\n         @Advice.Local(\"otelScope\") Scope scope) {\n \n-      ContextStore<HttpRequest, Context> contextStore =\n-          InstrumentationContext.get(HttpRequest.class, Context.class);\n-      context = contextStore.get(request);\n-\n-      if (context == null) {\n-        Context parentContext = currentContext();\n-        if (tracer().shouldStartSpan(parentContext)) {\n-          context = tracer().startSpan(parentContext, request, request.getHeaders());\n-          contextStore.put(request, context);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NDM5MQ=="}, "originalCommit": {"oid": "67165da95b60eb7c3d94d3c0dc2f38741a3086d5"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjM3NTEzOnYy", "diffSide": "RIGHT", "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzowMzozNFrOIF74rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMzoyMzozOFrOIGkfXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NDk1OQ==", "bodyText": "I find this comment suspicious. Why of all places here to want to work without executors instrumentations?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543094959", "createdAt": "2020-12-15T07:03:34Z", "author": {"login": "iNikem"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -138,15 +125,12 @@ public static void methodEnter(\n         return;\n       }\n \n-      context = tracer().startSpan(parentContext, request, request.getHeaders());\n+      context = tracer().startSpan(parentContext, request);\n+      scope = context.makeCurrent();\n \n       // propagating the context manually here so this instrumentation will work with and without\n       // the executors instrumentation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67165da95b60eb7c3d94d3c0dc2f38741a3086d5"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc2MDIyMw==", "bodyText": "I agree this comment is suspicious, so I removed it \ud83d\ude01.\nI think we always propagate the span out-of-band to the place where it is ended. (this was actually something nice about the Operation concept, b/c you had to pass the Operation object out-of-band to the place where it was ended, orthogonal to in-band Context propagation)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543760223", "createdAt": "2020-12-15T23:23:38Z", "author": {"login": "trask"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -138,15 +125,12 @@ public static void methodEnter(\n         return;\n       }\n \n-      context = tracer().startSpan(parentContext, request, request.getHeaders());\n+      context = tracer().startSpan(parentContext, request);\n+      scope = context.makeCurrent();\n \n       // propagating the context manually here so this instrumentation will work with and without\n       // the executors instrumentation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NDk1OQ=="}, "originalCommit": {"oid": "67165da95b60eb7c3d94d3c0dc2f38741a3086d5"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjM3NTg2OnYy", "diffSide": "LEFT", "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzowMzo1MFrOIF75GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzoxMDoxN1rOIF8FBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NTA2NQ==", "bodyText": "Is this not needed anymore?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543095065", "createdAt": "2020-12-15T07:03:50Z", "author": {"login": "iNikem"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -113,16 +109,7 @@ public static void methodExit(\n       }\n \n       scope.close();\n-      if (throwable == null) {\n-        tracer().end(context, response);\n-      } else {\n-        tracer().endExceptionally(context, response, throwable);\n-      }\n-      // If HttpRequest.setThrowExceptionOnExecuteError is set to false, there are no exceptions\n-      // for a failed request.  Thus, check the response code\n-      if (response != null && !response.isSuccessStatusCode()) {\n-        spanFromContext(context).setStatus(StatusCode.ERROR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67165da95b60eb7c3d94d3c0dc2f38741a3086d5"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5ODExOA==", "bodyText": "I don't think this was needed previously either. status is set in one of the end() methods above.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1910#discussion_r543098118", "createdAt": "2020-12-15T07:10:17Z", "author": {"login": "trask"}, "path": "instrumentation/google-http-client-1.19/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/googlehttpclient/GoogleHttpClientInstrumentationModule.java", "diffHunk": "@@ -113,16 +109,7 @@ public static void methodExit(\n       }\n \n       scope.close();\n-      if (throwable == null) {\n-        tracer().end(context, response);\n-      } else {\n-        tracer().endExceptionally(context, response, throwable);\n-      }\n-      // If HttpRequest.setThrowExceptionOnExecuteError is set to false, there are no exceptions\n-      // for a failed request.  Thus, check the response code\n-      if (response != null && !response.isSuccessStatusCode()) {\n-        spanFromContext(context).setStatus(StatusCode.ERROR);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NTA2NQ=="}, "originalCommit": {"oid": "67165da95b60eb7c3d94d3c0dc2f38741a3086d5"}, "originalPosition": 64}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4375, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}