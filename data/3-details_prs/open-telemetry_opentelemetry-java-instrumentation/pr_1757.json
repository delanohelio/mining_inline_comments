{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NzY0MjU4", "number": 1757, "title": "Simplify netty-4.1 AttributeKeys", "bodyText": "This logic appears to have been copied over unnecessarily from netty-4.0 instrumentation.\nnetty-4.1 has AttributeKey.valueOf(..) which serves the same purpose of ensuring AttributeKey uniqueness at the netty layer.", "createdAt": "2020-11-24T20:37:46Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757", "merged": true, "mergeCommit": {"oid": "7a6613ca6cf4db6de72ab74b7f7dd15dea6175a9"}, "closed": true, "closedAt": "2020-11-26T02:49:53Z", "author": {"login": "trask"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfv3MrgH2gAyNTI2NzY0MjU4Ojc2MDI4M2FiNzA4NjU0MjU3YWYxMmMxMDMxMjhkOWYxZjdkZjhlYWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgCZLBgH2gAyNTI2NzY0MjU4OjMwMTM1YWVmMDgxZDNkMTUxMzRlOGU1ZjUwZDk5YWI3N2ZlNmE4Y2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "760283ab708654257af12c103128d9f1f7df8eaa", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/760283ab708654257af12c103128d9f1f7df8eaa", "committedDate": "2020-11-24T20:34:43Z", "message": "Simplify netty-4.1 AttributeKeys"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MDg5Njg3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#pullrequestreview-538089687", "createdAt": "2020-11-25T01:24:17Z", "commit": {"oid": "760283ab708654257af12c103128d9f1f7df8eaa"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMToyNDoxN1rOH5fk3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMToyNDo1OVrOH5flow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0ODIyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class.getName() + \".context\");\n          \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class, \"server-span\");", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#discussion_r530048223", "createdAt": "2020-11-25T01:24:17Z", "author": {"login": "anuraaga"}, "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/javaagent/instrumentation/netty/v4_1/AttributeKeys.java", "diffHunk": "@@ -8,51 +8,19 @@\n import io.netty.util.AttributeKey;\n import io.opentelemetry.api.trace.Span;\n import io.opentelemetry.context.Context;\n-import io.opentelemetry.javaagent.instrumentation.api.WeakMap;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ConcurrentMap;\n \n public class AttributeKeys {\n-  private static final WeakMap<ClassLoader, ConcurrentMap<String, AttributeKey<?>>> map =\n-      WeakMap.Implementation.DEFAULT.get();\n-  private static final WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>\n-      mapSupplier =\n-          new WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>() {\n-            @Override\n-            public ConcurrentMap<String, AttributeKey<?>> get(ClassLoader ignore) {\n-              return new ConcurrentHashMap<>();\n-            }\n-          };\n \n   public static final AttributeKey<Context> CONNECT_CONTEXT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \"connect.context\");\n+      AttributeKey.valueOf(AttributeKeys.class, \"connect.context\");\n \n   // this attribute key is also used by ratpack instrumentation\n   public static final AttributeKey<Context> SERVER_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".context\");\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".context\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "760283ab708654257af12c103128d9f1f7df8eaa"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0ODM0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class.getName() + \".span\");\n          \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class, \"client-span\");", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#discussion_r530048341", "createdAt": "2020-11-25T01:24:40Z", "author": {"login": "anuraaga"}, "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/javaagent/instrumentation/netty/v4_1/AttributeKeys.java", "diffHunk": "@@ -8,51 +8,19 @@\n import io.netty.util.AttributeKey;\n import io.opentelemetry.api.trace.Span;\n import io.opentelemetry.context.Context;\n-import io.opentelemetry.javaagent.instrumentation.api.WeakMap;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ConcurrentMap;\n \n public class AttributeKeys {\n-  private static final WeakMap<ClassLoader, ConcurrentMap<String, AttributeKey<?>>> map =\n-      WeakMap.Implementation.DEFAULT.get();\n-  private static final WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>\n-      mapSupplier =\n-          new WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>() {\n-            @Override\n-            public ConcurrentMap<String, AttributeKey<?>> get(ClassLoader ignore) {\n-              return new ConcurrentHashMap<>();\n-            }\n-          };\n \n   public static final AttributeKey<Context> CONNECT_CONTEXT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \"connect.context\");\n+      AttributeKey.valueOf(AttributeKeys.class, \"connect.context\");\n \n   // this attribute key is also used by ratpack instrumentation\n   public static final AttributeKey<Context> SERVER_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".context\");\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".context\");\n \n   public static final AttributeKey<Span> CLIENT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".span\");\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".span\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "760283ab708654257af12c103128d9f1f7df8eaa"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0ODQxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class.getName() + \".parent\");\n          \n          \n            \n                  AttributeKey.valueOf(AttributeKeys.class, \"client-parent-span\");", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#discussion_r530048419", "createdAt": "2020-11-25T01:24:59Z", "author": {"login": "anuraaga"}, "path": "instrumentation/netty/netty-4.1/src/main/java/io/opentelemetry/javaagent/instrumentation/netty/v4_1/AttributeKeys.java", "diffHunk": "@@ -8,51 +8,19 @@\n import io.netty.util.AttributeKey;\n import io.opentelemetry.api.trace.Span;\n import io.opentelemetry.context.Context;\n-import io.opentelemetry.javaagent.instrumentation.api.WeakMap;\n-import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ConcurrentMap;\n \n public class AttributeKeys {\n-  private static final WeakMap<ClassLoader, ConcurrentMap<String, AttributeKey<?>>> map =\n-      WeakMap.Implementation.DEFAULT.get();\n-  private static final WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>\n-      mapSupplier =\n-          new WeakMap.ValueSupplier<ClassLoader, ConcurrentMap<String, AttributeKey<?>>>() {\n-            @Override\n-            public ConcurrentMap<String, AttributeKey<?>> get(ClassLoader ignore) {\n-              return new ConcurrentHashMap<>();\n-            }\n-          };\n \n   public static final AttributeKey<Context> CONNECT_CONTEXT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \"connect.context\");\n+      AttributeKey.valueOf(AttributeKeys.class, \"connect.context\");\n \n   // this attribute key is also used by ratpack instrumentation\n   public static final AttributeKey<Context> SERVER_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".context\");\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".context\");\n \n   public static final AttributeKey<Span> CLIENT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".span\");\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".span\");\n \n   public static final AttributeKey<Context> CLIENT_PARENT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".parent\");\n-\n-  /**\n-   * Generate an attribute key or reuse the one existing in the global app map. This implementation\n-   * creates attributes only once even if the current class is loaded by several class loaders and\n-   * prevents an issue with Apache Atlas project were this class loaded by multiple class loaders,\n-   * while the Attribute class is loaded by a third class loader and used internally for the\n-   * cassandra driver.\n-   */\n-  private static <T> AttributeKey<T> attributeKey(String key) {\n-    ConcurrentMap<String, AttributeKey<?>> classLoaderMap =\n-        map.computeIfAbsent(AttributeKey.class.getClassLoader(), mapSupplier);\n-    if (classLoaderMap.containsKey(key)) {\n-      return (AttributeKey<T>) classLoaderMap.get(key);\n-    }\n-\n-    AttributeKey<T> value = AttributeKey.valueOf(key);\n-    classLoaderMap.put(key, value);\n-    return value;\n-  }\n+      AttributeKey.valueOf(AttributeKeys.class.getName() + \".parent\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "760283ab708654257af12c103128d9f1f7df8eaa"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2313933b37f68802a1707a4320e3b96a0d614fdb", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2313933b37f68802a1707a4320e3b96a0d614fdb", "committedDate": "2020-11-25T01:43:25Z", "message": "Suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48c4f0c6c401e98eb3cbdf116b1af3640295aa4c", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/48c4f0c6c401e98eb3cbdf116b1af3640295aa4c", "committedDate": "2020-11-25T01:47:43Z", "message": "Shorten names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0984d4bae6aad2a78fef1da95affba83983e423", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a0984d4bae6aad2a78fef1da95affba83983e423", "committedDate": "2020-11-25T01:49:42Z", "message": "Make same naming changes for netty-4.0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MTU1NzUx", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#pullrequestreview-538155751", "createdAt": "2020-11-25T04:52:48Z", "commit": {"oid": "a0984d4bae6aad2a78fef1da95affba83983e423"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4Mjc5NDU5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#pullrequestreview-538279459", "createdAt": "2020-11-25T09:01:02Z", "commit": {"oid": "a0984d4bae6aad2a78fef1da95affba83983e423"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTowMTowMlrOH5pPhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTowMTowMlrOH5pPhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwNjU5OQ==", "bodyText": "Typo?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  attributeKey(AttributeKeys.class.getName() + \".connect0context\");\n          \n          \n            \n                  attributeKey(AttributeKeys.class.getName() + \".connect-context\");", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#discussion_r530206599", "createdAt": "2020-11-25T09:01:02Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/netty/netty-4.0/src/main/java/io/opentelemetry/javaagent/instrumentation/netty/v4_0/AttributeKeys.java", "diffHunk": "@@ -24,17 +24,18 @@\n             }\n           };\n \n-  public static final AttributeKey<Context> CONNECT_CONTEXT_ATTRIBUTE_KEY =\n-      attributeKey(AttributeKeys.class.getName() + \".connect.context\");\n+  public static final AttributeKey<Context> CONNECT_CONTEXT =\n+      attributeKey(AttributeKeys.class.getName() + \".connect0context\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0984d4bae6aad2a78fef1da95affba83983e423"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NDY4NDky", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1757#pullrequestreview-538468492", "createdAt": "2020-11-25T12:59:22Z", "commit": {"oid": "a0984d4bae6aad2a78fef1da95affba83983e423"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30135aef081d3d15134e8e5f50d99ab77fe6a8ca", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/30135aef081d3d15134e8e5f50d99ab77fe6a8ca", "committedDate": "2020-11-25T18:10:07Z", "message": "Update instrumentation/netty/netty-4.0/src/main/java/io/opentelemetry/javaagent/instrumentation/netty/v4_0/AttributeKeys.java\n\nCo-authored-by: Mateusz Rzeszutek <mrzeszutek@splunk.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2073, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}