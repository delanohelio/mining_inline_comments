{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MjY0NDM0", "number": 1621, "reviewThreads": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMToxODozOVrOE34LbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjozNzo1NFrOE5_0eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDI3NTY0OnYy", "diffSide": "RIGHT", "path": "examples/distro/build.gradle", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMToxODozOVrOHxepog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwODozODozNlrOHxv-iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0NDQ1MA==", "bodyText": "why different version property for javaagent-spi? or is this just gradle best practice?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521644450", "createdAt": "2020-11-11T21:18:39Z", "author": {"login": "trask"}, "path": "examples/distro/build.gradle", "diffHunk": "@@ -0,0 +1,57 @@\n+group 'io.opentelemetry.example'\n+version '1.0-SNAPSHOT'\n+\n+subprojects {\n+    version = rootProject.version\n+\n+    apply plugin: \"java\"\n+\n+    ext {\n+        versions = [\n+                opentelemetry            : \"0.10.0\",\n+                opentelemetryJavaagent   : \"0.10.0\",\n+                opentelemetryJavaagentSpi: \"0.10.0\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg5NTUxOQ==", "bodyText": "I guess best practice is for us to publish a BOM :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521895519", "createdAt": "2020-11-12T07:44:59Z", "author": {"login": "anuraaga"}, "path": "examples/distro/build.gradle", "diffHunk": "@@ -0,0 +1,57 @@\n+group 'io.opentelemetry.example'\n+version '1.0-SNAPSHOT'\n+\n+subprojects {\n+    version = rootProject.version\n+\n+    apply plugin: \"java\"\n+\n+    ext {\n+        versions = [\n+                opentelemetry            : \"0.10.0\",\n+                opentelemetryJavaagent   : \"0.10.0\",\n+                opentelemetryJavaagentSpi: \"0.10.0\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0NDQ1MA=="}, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkyODMyOQ==", "bodyText": "This remains from my first attempt which used snapshots. Will remove.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521928329", "createdAt": "2020-11-12T08:38:36Z", "author": {"login": "iNikem"}, "path": "examples/distro/build.gradle", "diffHunk": "@@ -0,0 +1,57 @@\n+group 'io.opentelemetry.example'\n+version '1.0-SNAPSHOT'\n+\n+subprojects {\n+    version = rootProject.version\n+\n+    apply plugin: \"java\"\n+\n+    ext {\n+        versions = [\n+                opentelemetry            : \"0.10.0\",\n+                opentelemetryJavaagent   : \"0.10.0\",\n+                opentelemetryJavaagentSpi: \"0.10.0\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0NDQ1MA=="}, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDI4ODczOnYy", "diffSide": "RIGHT", "path": "examples/distro/custom/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMToyMjo0M1rOHxexIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMToyMjo0M1rOHxexIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0NjM3MA==", "bodyText": "this isn't needed anymore since grpc context gone in 0.10.0\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n                    // relocate OpenTelemetry API dependency\n          \n          \n            \n                    relocate(\"io.grpc\", \"io.opentelemetry.javaagent.shaded.io.grpc\")", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521646370", "createdAt": "2020-11-11T21:22:43Z", "author": {"login": "trask"}, "path": "examples/distro/custom/build.gradle", "diffHunk": "@@ -0,0 +1,40 @@\n+plugins {\n+    id \"java\"\n+    id(\"com.github.johnrengelman.shadow\") version \"6.0.0\"\n+}\n+\n+dependencies {\n+    implementation(\"io.opentelemetry:opentelemetry-sdk:${versions.opentelemetry}\")\n+    implementation(\"io.opentelemetry.javaagent:opentelemetry-javaagent-spi:${versions.opentelemetryJavaagentSpi}\")\n+    implementation(\"io.opentelemetry.javaagent:opentelemetry-javaagent-tooling:${versions.opentelemetryJavaagent}\")\n+\n+    implementation deps.bytebuddy\n+    implementation deps.bytebuddyagent\n+    annotationProcessor deps.autoservice\n+    implementation deps.autoservice\n+\n+    compileOnly group: 'javax.servlet', name: 'javax.servlet-api', version: '3.0.1'\n+}\n+\n+tasks {\n+    shadowJar {\n+        mergeServiceFiles()\n+\n+        exclude(\"**/module-info.class\")\n+\n+        // Prevents conflict with other SLF4J instances. Important for premain.\n+        relocate(\"org.slf4j\", \"io.opentelemetry.javaagent.slf4j\")\n+        // rewrite dependencies calling Logger.getLogger\n+        relocate(\"java.util.logging.Logger\", \"io.opentelemetry.javaagent.bootstrap.PatchLogger\")\n+\n+        // prevents conflict with library instrumentation\n+        relocate(\"io.opentelemetry.instrumentation.api\", \"io.opentelemetry.javaagent.shaded.instrumentation.api\")\n+\n+        // relocate OpenTelemetry API\n+        relocate(\"io.opentelemetry.api\", \"io.opentelemetry.javaagent.shaded.io.opentelemetry.api\")\n+        relocate(\"io.opentelemetry.context\", \"io.opentelemetry.javaagent.shaded.io.opentelemetry.context\")\n+\n+        // relocate OpenTelemetry API dependency\n+        relocate(\"io.grpc\", \"io.opentelemetry.javaagent.shaded.io.grpc\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDI5MTE0OnYy", "diffSide": "RIGHT", "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/DemoIdGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMToyMzo0MlrOHxeysg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMToyMzo0MlrOHxeysg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0Njc3MA==", "bodyText": "just to return valid span id\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return String.valueOf(spanId.incrementAndGet());\n          \n          \n            \n                return String.format(\"%016d\", spanId.incrementAndGet());", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521646770", "createdAt": "2020-11-11T21:23:42Z", "author": {"login": "trask"}, "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/DemoIdGenerator.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package io.opentelemetry.demo;\n+\n+import io.opentelemetry.sdk.trace.IdGenerator;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+/**\n+ * Custom {@link IdGenerator} which provides span and trace ids.\n+ *\n+ * @see io.opentelemetry.sdk.trace.TracerSdkProvider\n+ * @see DemoTracerCustomizer\n+ */\n+public class DemoIdGenerator implements IdGenerator {\n+  private static final AtomicLong traceId = new AtomicLong(0);\n+  private static final AtomicLong spanId = new AtomicLong(0);\n+\n+  @Override\n+  public String generateSpanId() {\n+    return String.valueOf(spanId.incrementAndGet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDMwMzE0OnYy", "diffSide": "RIGHT", "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/DemoSampler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMToyNzoxMlrOHxe5jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMToyNzoxMlrOHxe5jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0ODUyNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return null;\n          \n          \n            \n                return \"DemoSampler\";", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521648527", "createdAt": "2020-11-11T21:27:12Z", "author": {"login": "trask"}, "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/DemoSampler.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package io.opentelemetry.demo;\n+\n+import io.opentelemetry.api.common.ReadableAttributes;\n+import io.opentelemetry.api.trace.Span;\n+import io.opentelemetry.context.Context;\n+import io.opentelemetry.sdk.trace.data.SpanData;\n+import io.opentelemetry.sdk.trace.samplers.Sampler;\n+import io.opentelemetry.sdk.trace.samplers.SamplingResult;\n+import java.util.List;\n+\n+/**\n+ * This demo sampler filters out all internal spans whose name contains string \"greeting\".\n+ *\n+ * See <a href=\"https://github.com/open-telemetry/opentelemetry-specification/blob/master/specification/trace/sdk.md#sampling\">\n+ * OpenTelemetry Specification</a> for more information about span sampling.\n+ *\n+ * @see DemoTracerCustomizer\n+ */\n+public class DemoSampler implements Sampler {\n+  @Override\n+  public SamplingResult shouldSample(Context parentContext, String traceId, String name, Span.Kind spanKind, ReadableAttributes attributes, List<SpanData.Link> parentLinks) {\n+    if (spanKind == Span.Kind.INTERNAL && name.contains(\"greeting\")) {\n+      return SamplingResult.create(SamplingResult.Decision.DROP);\n+    } else {\n+      return SamplingResult.create(SamplingResult.Decision.RECORD_AND_SAMPLE);\n+    }\n+  }\n+\n+  @Override\n+  public String getDescription() {\n+    return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDMwOTI0OnYy", "diffSide": "RIGHT", "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/DemoTracerCustomizer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMToyOToyMFrOHxe9TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMToyOToyMFrOHxe9TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0OTQ4NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Just read the {@link #configure(TracerSdkManagement)} method.\n          \n          \n            \n             * See the {@link #configure(TracerSdkManagement)} method below.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521649485", "createdAt": "2020-11-11T21:29:20Z", "author": {"login": "trask"}, "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/DemoTracerCustomizer.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package io.opentelemetry.demo;\n+\n+import io.opentelemetry.api.OpenTelemetry;\n+import io.opentelemetry.context.propagation.DefaultContextPropagators;\n+import io.opentelemetry.javaagent.spi.TracerCustomizer;\n+import io.opentelemetry.sdk.OpenTelemetrySdk;\n+import io.opentelemetry.sdk.trace.TracerSdkManagement;\n+import io.opentelemetry.sdk.trace.config.TraceConfig;\n+import io.opentelemetry.sdk.trace.export.SimpleSpanProcessor;\n+\n+/**\n+ * This is the main entry point for the majority of Instrumentation Agent's customizations.\n+ * It allows for configuring various aspects of OpenTelemetrySdk.\n+ * Just read the {@link #configure(TracerSdkManagement)} method.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDMzMDYyOnYy", "diffSide": "RIGHT", "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/instrumentation/DemoServlet3Instrumentation.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTozNjoyM1rOHxfJ6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDowNjozMVrOHyMFhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MjcxMw==", "bodyText": "I don't think muzzle will like this since the Advice class itself lives in AgentClassLoader, maybe add helper class and helperClassNames() since that's a common need", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521652713", "createdAt": "2020-11-11T21:36:23Z", "author": {"login": "trask"}, "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/instrumentation/DemoServlet3Instrumentation.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package io.opentelemetry.demo.instrumentation;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.safeHasSuperType;\n+import static io.opentelemetry.javaagent.tooling.matcher.NameMatchers.namedOneOf;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isPublic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.api.trace.Span;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Map;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+/**\n+ * This is a demo instrumentation which hooks into servlet invocation and modifies the http response.\n+ */\n+@AutoService(Instrumenter.class)\n+public final class DemoServlet3Instrumentation extends Instrumenter.Default {\n+  public DemoServlet3Instrumentation() {\n+    super(\"servlet-demo\", \"servlet-3\");\n+  }\n+\n+  /*\n+  We want this instrumentation to be applied after the standard servlet instrumentation.\n+  The latter creates a server span around http request.\n+  This instrumentation needs access to that server span.\n+   */\n+  @Override\n+  public int getOrder() {\n+    return 1;\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"javax.servlet.http.HttpServlet\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return safeHasSuperType(\n+        namedOneOf(\"javax.servlet.FilterChain\", \"javax.servlet.http.HttpServlet\"));\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return singletonMap(\n+        namedOneOf(\"doFilter\", \"service\")\n+            .and(takesArgument(0, named(\"javax.servlet.ServletRequest\")))\n+            .and(takesArgument(1, named(\"javax.servlet.ServletResponse\")))\n+            .and(isPublic()),\n+        DemoServlet3Instrumentation.class.getName() + \"$DemoServlet3Advice\");\n+  }\n+\n+  @SuppressWarnings(\"unused\")\n+  public static class DemoServlet3Advice {\n+\n+    public static final String X_SERVER_ID = \"X-server-id\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg4OTIwMw==", "bodyText": "Muzzle is not configured in this example. Since there are compile-time dependencies and can it can result in runtime errors I would document this in a readme and add links to issues.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521889203", "createdAt": "2020-11-12T07:31:05Z", "author": {"login": "pavolloffay"}, "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/instrumentation/DemoServlet3Instrumentation.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package io.opentelemetry.demo.instrumentation;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.safeHasSuperType;\n+import static io.opentelemetry.javaagent.tooling.matcher.NameMatchers.namedOneOf;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isPublic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.api.trace.Span;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Map;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+/**\n+ * This is a demo instrumentation which hooks into servlet invocation and modifies the http response.\n+ */\n+@AutoService(Instrumenter.class)\n+public final class DemoServlet3Instrumentation extends Instrumenter.Default {\n+  public DemoServlet3Instrumentation() {\n+    super(\"servlet-demo\", \"servlet-3\");\n+  }\n+\n+  /*\n+  We want this instrumentation to be applied after the standard servlet instrumentation.\n+  The latter creates a server span around http request.\n+  This instrumentation needs access to that server span.\n+   */\n+  @Override\n+  public int getOrder() {\n+    return 1;\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"javax.servlet.http.HttpServlet\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return safeHasSuperType(\n+        namedOneOf(\"javax.servlet.FilterChain\", \"javax.servlet.http.HttpServlet\"));\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return singletonMap(\n+        namedOneOf(\"doFilter\", \"service\")\n+            .and(takesArgument(0, named(\"javax.servlet.ServletRequest\")))\n+            .and(takesArgument(1, named(\"javax.servlet.ServletResponse\")))\n+            .and(isPublic()),\n+        DemoServlet3Instrumentation.class.getName() + \"$DemoServlet3Advice\");\n+  }\n+\n+  @SuppressWarnings(\"unused\")\n+  public static class DemoServlet3Advice {\n+\n+    public static final String X_SERVER_ID = \"X-server-id\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MjcxMw=="}, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMxNjYxOQ==", "bodyText": "I don't understand the concern, tbh :) Do you mean static field in Advice?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r522316619", "createdAt": "2020-11-12T18:16:25Z", "author": {"login": "iNikem"}, "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/instrumentation/DemoServlet3Instrumentation.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package io.opentelemetry.demo.instrumentation;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.safeHasSuperType;\n+import static io.opentelemetry.javaagent.tooling.matcher.NameMatchers.namedOneOf;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isPublic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.api.trace.Span;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Map;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+/**\n+ * This is a demo instrumentation which hooks into servlet invocation and modifies the http response.\n+ */\n+@AutoService(Instrumenter.class)\n+public final class DemoServlet3Instrumentation extends Instrumenter.Default {\n+  public DemoServlet3Instrumentation() {\n+    super(\"servlet-demo\", \"servlet-3\");\n+  }\n+\n+  /*\n+  We want this instrumentation to be applied after the standard servlet instrumentation.\n+  The latter creates a server span around http request.\n+  This instrumentation needs access to that server span.\n+   */\n+  @Override\n+  public int getOrder() {\n+    return 1;\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"javax.servlet.http.HttpServlet\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return safeHasSuperType(\n+        namedOneOf(\"javax.servlet.FilterChain\", \"javax.servlet.http.HttpServlet\"));\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return singletonMap(\n+        namedOneOf(\"doFilter\", \"service\")\n+            .and(takesArgument(0, named(\"javax.servlet.ServletRequest\")))\n+            .and(takesArgument(1, named(\"javax.servlet.ServletResponse\")))\n+            .and(isPublic()),\n+        DemoServlet3Instrumentation.class.getName() + \"$DemoServlet3Advice\");\n+  }\n+\n+  @SuppressWarnings(\"unused\")\n+  public static class DemoServlet3Advice {\n+\n+    public static final String X_SERVER_ID = \"X-server-id\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MjcxMw=="}, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4MjgwMw==", "bodyText": "Oh good point about no muzzle here.\nI think the only reason this example works is because javac is inlining the string constant.\nIf doesn't inline the string constant, this should fail, because the advice class itself lives in the AgentClassLoader, while the bytecode inside of the advice methods is injected into the instrumented class, which lives in the user class loader, and so the bytecode inside of the advice methods should not be allowed to reference a static field in the advice class, and you should get a runtime error.\nI'd suggest inlining the string here, otherwise it may give the impression that this is a valid pattern (e.g. for Loggers, Tracers, other static fields on Advice).", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r522382803", "createdAt": "2020-11-12T19:55:46Z", "author": {"login": "trask"}, "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/instrumentation/DemoServlet3Instrumentation.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package io.opentelemetry.demo.instrumentation;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.safeHasSuperType;\n+import static io.opentelemetry.javaagent.tooling.matcher.NameMatchers.namedOneOf;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isPublic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.api.trace.Span;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Map;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+/**\n+ * This is a demo instrumentation which hooks into servlet invocation and modifies the http response.\n+ */\n+@AutoService(Instrumenter.class)\n+public final class DemoServlet3Instrumentation extends Instrumenter.Default {\n+  public DemoServlet3Instrumentation() {\n+    super(\"servlet-demo\", \"servlet-3\");\n+  }\n+\n+  /*\n+  We want this instrumentation to be applied after the standard servlet instrumentation.\n+  The latter creates a server span around http request.\n+  This instrumentation needs access to that server span.\n+   */\n+  @Override\n+  public int getOrder() {\n+    return 1;\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"javax.servlet.http.HttpServlet\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return safeHasSuperType(\n+        namedOneOf(\"javax.servlet.FilterChain\", \"javax.servlet.http.HttpServlet\"));\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return singletonMap(\n+        namedOneOf(\"doFilter\", \"service\")\n+            .and(takesArgument(0, named(\"javax.servlet.ServletRequest\")))\n+            .and(takesArgument(1, named(\"javax.servlet.ServletResponse\")))\n+            .and(isPublic()),\n+        DemoServlet3Instrumentation.class.getName() + \"$DemoServlet3Advice\");\n+  }\n+\n+  @SuppressWarnings(\"unused\")\n+  public static class DemoServlet3Advice {\n+\n+    public static final String X_SERVER_ID = \"X-server-id\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MjcxMw=="}, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM4ODg2OA==", "bodyText": "Done", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r522388868", "createdAt": "2020-11-12T20:06:31Z", "author": {"login": "iNikem"}, "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/instrumentation/DemoServlet3Instrumentation.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package io.opentelemetry.demo.instrumentation;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.safeHasSuperType;\n+import static io.opentelemetry.javaagent.tooling.matcher.NameMatchers.namedOneOf;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isPublic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.api.trace.Span;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Map;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletResponse;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+/**\n+ * This is a demo instrumentation which hooks into servlet invocation and modifies the http response.\n+ */\n+@AutoService(Instrumenter.class)\n+public final class DemoServlet3Instrumentation extends Instrumenter.Default {\n+  public DemoServlet3Instrumentation() {\n+    super(\"servlet-demo\", \"servlet-3\");\n+  }\n+\n+  /*\n+  We want this instrumentation to be applied after the standard servlet instrumentation.\n+  The latter creates a server span around http request.\n+  This instrumentation needs access to that server span.\n+   */\n+  @Override\n+  public int getOrder() {\n+    return 1;\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"javax.servlet.http.HttpServlet\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return safeHasSuperType(\n+        namedOneOf(\"javax.servlet.FilterChain\", \"javax.servlet.http.HttpServlet\"));\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return singletonMap(\n+        namedOneOf(\"doFilter\", \"service\")\n+            .and(takesArgument(0, named(\"javax.servlet.ServletRequest\")))\n+            .and(takesArgument(1, named(\"javax.servlet.ServletResponse\")))\n+            .and(isPublic()),\n+        DemoServlet3Instrumentation.class.getName() + \"$DemoServlet3Advice\");\n+  }\n+\n+  @SuppressWarnings(\"unused\")\n+  public static class DemoServlet3Advice {\n+\n+    public static final String X_SERVER_ID = \"X-server-id\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MjcxMw=="}, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDMzOTk0OnYy", "diffSide": "RIGHT", "path": "examples/distro/smoke-tests/src/test/java/com/splunk/opentelemetry/OkHttpUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTozODo0OVrOHxfPVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNzo0ODoxNVrOHxuEeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1NDEwMw==", "bodyText": "spotlessApply?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521654103", "createdAt": "2020-11-11T21:38:49Z", "author": {"login": "trask"}, "path": "examples/distro/smoke-tests/src/test/java/com/splunk/opentelemetry/OkHttpUtils.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright Splunk Inc.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg5NzA4MA==", "bodyText": "Don't think this example has it :) We should remove copyright headers from sample code.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521897080", "createdAt": "2020-11-12T07:48:15Z", "author": {"login": "anuraaga"}, "path": "examples/distro/smoke-tests/src/test/java/com/splunk/opentelemetry/OkHttpUtils.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright Splunk Inc.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1NDEwMw=="}, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDM0MzM3OnYy", "diffSide": "RIGHT", "path": "examples/distro/smoke-tests/src/test/java/com/splunk/opentelemetry/OkHttpUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTozOTozN1rOHxfRNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTozOTozN1rOHxfRNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1NDU4Mg==", "bodyText": "com.example.javaagent.smoketest?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521654582", "createdAt": "2020-11-11T21:39:37Z", "author": {"login": "trask"}, "path": "examples/distro/smoke-tests/src/test/java/com/splunk/opentelemetry/OkHttpUtils.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright Splunk Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.splunk.opentelemetry;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDM0NzAzOnYy", "diffSide": "RIGHT", "path": "examples/distro/smoke-tests/src/test/java/com/splunk/opentelemetry/SmokeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo0MDo0N1rOHxfTag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo0MDo0N1rOHxfTag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1NTE0Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .withEnv(\"OTEL_INTEGRATION_GEODE_ENABLED\",\"false\")", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521655146", "createdAt": "2020-11-11T21:40:47Z", "author": {"login": "trask"}, "path": "examples/distro/smoke-tests/src/test/java/com/splunk/opentelemetry/SmokeTest.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+ * Copyright Splunk Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.splunk.opentelemetry;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.google.protobuf.util.JsonFormat;\n+import io.opentelemetry.proto.collector.trace.v1.ExportTraceServiceRequest;\n+import io.opentelemetry.proto.common.v1.AnyValue;\n+import io.opentelemetry.proto.common.v1.KeyValue;\n+import io.opentelemetry.proto.trace.v1.Span;\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import java.util.stream.StreamSupport;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.ResponseBody;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.Network;\n+import org.testcontainers.containers.output.Slf4jLogConsumer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.utility.MountableFile;\n+\n+abstract class SmokeTest {\n+  private static final Logger logger = LoggerFactory.getLogger(SmokeTest.class);\n+\n+  private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();\n+\n+  protected static OkHttpClient client = OkHttpUtils.client();\n+\n+  private static final Network network = Network.newNetwork();\n+  protected static final String agentPath =\n+      System.getProperty(\"io.opentelemetry.smoketest.agent.shadowJar.path\");\n+\n+  protected abstract String getTargetImage(int jdk);\n+\n+  /**\n+   * Subclasses can override this method to customise target application's environment\n+   */\n+  protected Map<String, String> getExtraEnv() {\n+    return Collections.emptyMap();\n+  }\n+\n+  private static GenericContainer backend;\n+  private static GenericContainer collector;\n+\n+  @BeforeAll\n+  static void setupSpec() {\n+    backend =\n+        new GenericContainer<>(\n+            \"open-telemetry-docker-dev.bintray.io/java/smoke-fake-backend:latest\")\n+            .withExposedPorts(8080)\n+            .waitingFor(Wait.forHttp(\"/health\").forPort(8080))\n+            .withNetwork(network)\n+            .withNetworkAliases(\"backend\")\n+            .withLogConsumer(new Slf4jLogConsumer(logger));\n+    backend.start();\n+\n+    collector =\n+        new GenericContainer<>(\"otel/opentelemetry-collector-dev:latest\")\n+            .dependsOn(backend)\n+            .withNetwork(network)\n+            .withNetworkAliases(\"collector\")\n+            .withLogConsumer(new Slf4jLogConsumer(logger))\n+            .withCopyFileToContainer(\n+                MountableFile.forClasspathResource(\"/otel.yaml\"), \"/etc/otel.yaml\")\n+            .withCommand(\"--config /etc/otel.yaml\");\n+    collector.start();\n+  }\n+\n+  protected GenericContainer target;\n+\n+  void startTarget(int jdk) {\n+    target =\n+        new GenericContainer<>(getTargetImage(jdk))\n+            .withExposedPorts(8080)\n+            .withNetwork(network)\n+            .withLogConsumer(new Slf4jLogConsumer(logger))\n+            .withCopyFileToContainer(\n+                MountableFile.forHostPath(agentPath), \"/opentelemetry-javaagent.jar\")\n+            .withEnv(\"JAVA_TOOL_OPTIONS\", \"-javaagent:/opentelemetry-javaagent.jar\")\n+            .withEnv(\"OTEL_BSP_MAX_EXPORT_BATCH\", \"1\")\n+            .withEnv(\"OTEL_BSP_SCHEDULE_DELAY\", \"10\")\n+            .withEnv(\"OTEL_INTEGRATION_GEODE_ENABLED\",\"false\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDM1MjYxOnYy", "diffSide": "RIGHT", "path": "examples/distro/smoke-tests/src/test/java/com/splunk/opentelemetry/SpringBootSmokeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo0Mjo0NlrOHxfW0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo0Mjo0NlrOHxfW0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1NjAxOQ==", "bodyText": "Very nice test of so many things \ud83d\udc4d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521656019", "createdAt": "2020-11-11T21:42:46Z", "author": {"login": "trask"}, "path": "examples/distro/smoke-tests/src/test/java/com/splunk/opentelemetry/SpringBootSmokeTest.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright Splunk Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.splunk.opentelemetry;\n+\n+import io.opentelemetry.api.trace.TraceId;\n+import io.opentelemetry.proto.collector.trace.v1.ExportTraceServiceRequest;\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.jar.Attributes;\n+import java.util.jar.JarFile;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+\n+class SpringBootSmokeTest extends SmokeTest {\n+\n+  protected String getTargetImage(int jdk) {\n+    return \"open-telemetry-docker-dev.bintray.io/java/smoke-springboot-jdk\" + jdk + \":latest\";\n+  }\n+\n+  @Test\n+  public void springBootSmokeTestOnJDK() throws IOException, InterruptedException {\n+    startTarget(11);\n+    String url = String.format(\"http://localhost:%d/greeting\", target.getMappedPort(8080));\n+    Request request = new Request.Builder().url(url).get().build();\n+\n+    String currentAgentVersion =\n+        (String) new JarFile(agentPath)\n+            .getManifest()\n+            .getMainAttributes()\n+            .get(Attributes.Name.IMPLEMENTATION_VERSION);\n+\n+    Response response = client.newCall(request).execute();\n+    System.out.println(response.headers().toString());\n+\n+    Collection<ExportTraceServiceRequest> traces = waitForTraces();\n+\n+    Assertions.assertNotNull(response.header(\"X-server-id\"));\n+    Assertions.assertEquals(1, response.headers(\"X-server-id\").size());\n+    Assertions.assertTrue(TraceId.isValid(response.header(\"X-server-id\")));\n+    Assertions.assertEquals(response.body().string(), \"Hi!\");\n+    Assertions.assertEquals(1, countSpansByName(traces, \"/greeting\"));\n+    Assertions.assertEquals(0, countSpansByName(traces, \"WebController.greeting\"));\n+    Assertions.assertEquals(1, countSpansByName(traces, \"WebController.withSpan\"));\n+    Assertions.assertEquals(2, countSpansByAttributeValue(traces, \"custom\", \"demo\"));\n+    Assertions.assertEquals(1, countResourcesByValue(traces, \"telemetry.auto.version\", currentAgentVersion));\n+    Assertions.assertEquals(1, countResourcesByValue(traces, \"custom.resource\", \"demo\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDM1NTIyOnYy", "diffSide": "RIGHT", "path": "examples/distro/smoke-tests/src/test/java/com/splunk/opentelemetry/SmokeTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo0Mzo0OFrOHxfYdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo0Mzo0OFrOHxfYdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1NjQzOA==", "bodyText": "can we publish artifact with our SmokeTest and reuse this and OkHttpUtils? (not in this PR)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521656438", "createdAt": "2020-11-11T21:43:48Z", "author": {"login": "trask"}, "path": "examples/distro/smoke-tests/src/test/java/com/splunk/opentelemetry/SmokeTest.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+ * Copyright Splunk Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.splunk.opentelemetry;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.google.protobuf.util.JsonFormat;\n+import io.opentelemetry.proto.collector.trace.v1.ExportTraceServiceRequest;\n+import io.opentelemetry.proto.common.v1.AnyValue;\n+import io.opentelemetry.proto.common.v1.KeyValue;\n+import io.opentelemetry.proto.trace.v1.Span;\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import java.util.stream.StreamSupport;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.ResponseBody;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.Network;\n+import org.testcontainers.containers.output.Slf4jLogConsumer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.utility.MountableFile;\n+\n+abstract class SmokeTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDQxMTI0OnYy", "diffSide": "RIGHT", "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/DemoIdGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjowMjoxNFrOHxf6Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjowMjoxNFrOHxf6Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2NTA5NQ==", "bodyText": "same here\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return String.valueOf(traceId.incrementAndGet());\n          \n          \n            \n                return String.format(\"%032d\", spanId.incrementAndGet());", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521665095", "createdAt": "2020-11-11T22:02:14Z", "author": {"login": "trask"}, "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/DemoIdGenerator.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package io.opentelemetry.demo;\n+\n+import io.opentelemetry.sdk.trace.IdGenerator;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+/**\n+ * Custom {@link IdGenerator} which provides span and trace ids.\n+ *\n+ * @see io.opentelemetry.sdk.trace.TracerSdkProvider\n+ * @see DemoTracerCustomizer\n+ */\n+public class DemoIdGenerator implements IdGenerator {\n+  private static final AtomicLong traceId = new AtomicLong(0);\n+  private static final AtomicLong spanId = new AtomicLong(0);\n+\n+  @Override\n+  public String generateSpanId() {\n+    return String.valueOf(spanId.incrementAndGet());\n+  }\n+\n+  @Override\n+  public String generateTraceId() {\n+    return String.valueOf(traceId.incrementAndGet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDQyNjg1OnYy", "diffSide": "RIGHT", "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/DemoIdGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjowNzo0OVrOHxgDoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjowNzo0OVrOHxgDoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2NzQ4OA==", "bodyText": "what do u think of putting everything under com.example.javaagent instead of io.opentelemetry.demo?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521667488", "createdAt": "2020-11-11T22:07:49Z", "author": {"login": "trask"}, "path": "examples/distro/custom/src/main/java/io/opentelemetry/demo/DemoIdGenerator.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package io.opentelemetry.demo;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MTkwMzMxOnYy", "diffSide": "RIGHT", "path": "examples/distro/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNzo0NDowN1rOHxt8pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOToyMzoyNVrOHyKNXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg5NTA3OQ==", "bodyText": "This might be too much personal preference, but I wonder if it's worth demonstrating a versioning pattern where the distro name is suffixed? e.g., 1.0.0-aws.1, 1.0.0-demo.1. It's a free way of getting the telemetry.sdk stuff to identify the distro and might be nice for vendors (I'm not doing it yet but am planning on it).", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521895079", "createdAt": "2020-11-12T07:44:07Z", "author": {"login": "anuraaga"}, "path": "examples/distro/build.gradle", "diffHunk": "@@ -0,0 +1,57 @@\n+group 'io.opentelemetry.example'\n+version '1.0-SNAPSHOT'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1ODExMA==", "bodyText": "Take a look at Implementation-Version in agent/build.gradle. I totally agree with you on telemetry.sdk, but I think that jar built from the project should have just \"local\" version. Vendor name and otel version can go to manifest.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r522358110", "createdAt": "2020-11-12T19:23:25Z", "author": {"login": "iNikem"}, "path": "examples/distro/build.gradle", "diffHunk": "@@ -0,0 +1,57 @@\n+group 'io.opentelemetry.example'\n+version '1.0-SNAPSHOT'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg5NTA3OQ=="}, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MTkwNTY2OnYy", "diffSide": "RIGHT", "path": "examples/distro/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNzo0NDo0OFrOHxt-AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNzo0NDo0OFrOHxt-AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg5NTQyNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            opentelemetryJavaagent   : \"0.10.0\",\n          \n          \n            \n                            opentelemetryJavaagentSpi: \"0.10.0\",\n          \n          \n            \n                            opentelemetryJavaagent   : \"0.10.1\",\n          \n          \n            \n                            opentelemetryJavaagentSpi: \"0.10.1\",", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r521895425", "createdAt": "2020-11-12T07:44:48Z", "author": {"login": "anuraaga"}, "path": "examples/distro/build.gradle", "diffHunk": "@@ -0,0 +1,57 @@\n+group 'io.opentelemetry.example'\n+version '1.0-SNAPSHOT'\n+\n+subprojects {\n+    version = rootProject.version\n+\n+    apply plugin: \"java\"\n+\n+    ext {\n+        versions = [\n+                opentelemetry            : \"0.10.0\",\n+                opentelemetryJavaagent   : \"0.10.0\",\n+                opentelemetryJavaagentSpi: \"0.10.0\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717b5d96bad27568a002443969a3d2621f00fd01"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NTg2NDQzOnYy", "diffSide": "RIGHT", "path": "examples/distro/custom/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOTo1NTo0NVrOHzxmiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOTo1NTo0NVrOHzxmiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA1MjEwNQ==", "bodyText": "I don't like at all that this config is currently copy-pasted around. In the future we HAVE to address this.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r524052105", "createdAt": "2020-11-16T09:55:45Z", "author": {"login": "iNikem"}, "path": "examples/distro/custom/build.gradle", "diffHunk": "@@ -1,37 +1,30 @@\n plugins {\n-    id \"java\"\n-    id(\"com.github.johnrengelman.shadow\") version \"6.0.0\"\n+  id \"java\"\n+  id(\"com.github.johnrengelman.shadow\") version \"6.0.0\"\n }\n \n dependencies {\n-    implementation(\"io.opentelemetry:opentelemetry-sdk:${versions.opentelemetry}\")\n-    implementation(\"io.opentelemetry.javaagent:opentelemetry-javaagent-spi:${versions.opentelemetryJavaagent}\")\n-    implementation(\"io.opentelemetry.javaagent:opentelemetry-javaagent-tooling:${versions.opentelemetryJavaagent}\")\n-\n-    implementation deps.bytebuddy\n-    implementation deps.bytebuddyagent\n-    annotationProcessor deps.autoservice\n-    implementation deps.autoservice\n-\n-    compileOnly group: 'javax.servlet', name: 'javax.servlet-api', version: '3.0.1'\n+  compileOnly(\"io.opentelemetry:opentelemetry-sdk:${versions.opentelemetry}\")\n+  compileOnly(\"io.opentelemetry.javaagent:opentelemetry-javaagent-spi:${versions.opentelemetryJavaagent}\")\n+  compileOnly(\"io.opentelemetry.javaagent:opentelemetry-javaagent-tooling:${versions.opentelemetryJavaagent}\")\n }\n \n tasks {\n-    shadowJar {\n-        mergeServiceFiles()\n+  shadowJar {\n+    mergeServiceFiles()\n \n-        exclude(\"**/module-info.class\")\n+    exclude(\"**/module-info.class\")\n \n-        // Prevents conflict with other SLF4J instances. Important for premain.\n-        relocate(\"org.slf4j\", \"io.opentelemetry.javaagent.slf4j\")\n-        // rewrite dependencies calling Logger.getLogger\n-        relocate(\"java.util.logging.Logger\", \"io.opentelemetry.javaagent.bootstrap.PatchLogger\")\n+    // Prevents conflict with other SLF4J instances. Important for premain.\n+    relocate(\"org.slf4j\", \"io.opentelemetry.javaagent.slf4j\")\n+    // rewrite dependencies calling Logger.getLogger\n+    relocate(\"java.util.logging.Logger\", \"io.opentelemetry.javaagent.bootstrap.PatchLogger\")\n \n-        // prevents conflict with library instrumentation\n-        relocate(\"io.opentelemetry.instrumentation.api\", \"io.opentelemetry.javaagent.shaded.instrumentation.api\")\n+    // prevents conflict with library instrumentation\n+    relocate(\"io.opentelemetry.instrumentation.api\", \"io.opentelemetry.javaagent.shaded.instrumentation.api\")\n \n-        // relocate OpenTelemetry API\n-        relocate(\"io.opentelemetry.api\", \"io.opentelemetry.javaagent.shaded.io.opentelemetry.api\")\n-        relocate(\"io.opentelemetry.context\", \"io.opentelemetry.javaagent.shaded.io.opentelemetry.context\")\n-    }\n+    // relocate OpenTelemetry API\n+    relocate(\"io.opentelemetry.api\", \"io.opentelemetry.javaagent.shaded.io.opentelemetry.api\")\n+    relocate(\"io.opentelemetry.context\", \"io.opentelemetry.javaagent.shaded.io.opentelemetry.context\")\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df3ad0e2af2cb65dd9475f76197efbaf35a7a89a"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MjQ1NjMxOnYy", "diffSide": "RIGHT", "path": "examples/distro/README.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjoyNjoxMVrOH0yfug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjoyNjoxMVrOH0yfug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTExNTMyMg==", "bodyText": "Four submodules, now that we have instrumentation?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r525115322", "createdAt": "2020-11-17T12:26:11Z", "author": {"login": "mateuszrzeszutek"}, "path": "examples/distro/README.md", "diffHunk": "@@ -0,0 +1,25 @@\n+## Introduction\n+\n+This repository serves as a collection of examples of extending functionality of OpenTelemetry Java instrumentation agent.\n+It demonstrates how to repackage the aforementioned agent adding custom functionality.\n+For every extension point provided by OpenTelemetry Java instrumentation, this repository contains an example of\n+its usage.\n+\n+## General structure\n+\n+This repository has three main submodules:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df3ad0e2af2cb65dd9475f76197efbaf35a7a89a"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MjQ2MTA5OnYy", "diffSide": "RIGHT", "path": "examples/distro/README.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjoyNzozNlrOH0yinw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjoyNzozNlrOH0yinw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTExNjA2Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * [DemoServlet3Instrumentation](custom/src/main/java/io/opentelemetry/demo/instrumentation/DemoServlet3Instrumentation.java) - additional instrumentation\n          \n          \n            \n            * [DemoServlet3Instrumentation](instrumentation/servlet-3/src/main/java/io/opentelemetry/demo/instrumentation/DemoServlet3Instrumentation.java) - additional instrumentation", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r525116063", "createdAt": "2020-11-17T12:27:36Z", "author": {"login": "mateuszrzeszutek"}, "path": "examples/distro/README.md", "diffHunk": "@@ -0,0 +1,25 @@\n+## Introduction\n+\n+This repository serves as a collection of examples of extending functionality of OpenTelemetry Java instrumentation agent.\n+It demonstrates how to repackage the aforementioned agent adding custom functionality.\n+For every extension point provided by OpenTelemetry Java instrumentation, this repository contains an example of\n+its usage.\n+\n+## General structure\n+\n+This repository has three main submodules:\n+\n+* `custom` contains all custom functionality, SPI and other extensions\n+* `agent` contains the main repackaging functionality and, optionally, an entry point to the agent, if one wishes to\n+customize that\n+* `smoke-tests` contains simple tests to verify that resulting agent builds and applies correctly\n+\n+## Extensions examples\n+\n+* [DemoIdGenerator](custom/src/main/java/io/opentelemetry/demo/DemoIdGenerator.java) - custom `IdGenerator`\n+* [DemoPropagator](custom/src/main/java/io/opentelemetry/demo/DemoPropagator.java) - custom `TextMapPropagator`\n+* [DemoPropertySource](custom/src/main/java/io/opentelemetry/demo/DemoPropertySource.java) - default configuration\n+* [DemoSampler](custom/src/main/java/io/opentelemetry/demo/DemoSampler.java) - custom `Sampler`\n+* [DemoSpanProcessor](custom/src/main/java/io/opentelemetry/demo/DemoSpanProcessor.java) - custom `SpanProcessor`\n+* [DemoSpanExporter](custom/src/main/java/io/opentelemetry/demo/DemoSpanExporter.java) - custom `SpanExporter`\n+* [DemoServlet3Instrumentation](custom/src/main/java/io/opentelemetry/demo/instrumentation/DemoServlet3Instrumentation.java) - additional instrumentation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df3ad0e2af2cb65dd9475f76197efbaf35a7a89a"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MjQ5MTgyOnYy", "diffSide": "RIGHT", "path": "examples/distro/smoke-tests/src/test/resources/logback.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjozNTo0NlrOH0y0-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjozNTo0NlrOH0y0-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyMDc2Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              <logger name=\"com.splunk\" level=\"debug\"/>\n          \n          \n            \n              <logger name=\"com.example.javaagent\" level=\"debug\"/>\n          \n      \n    \n    \n  \n\n\ud83d\ude04", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r525120763", "createdAt": "2020-11-17T12:35:46Z", "author": {"login": "mateuszrzeszutek"}, "path": "examples/distro/smoke-tests/src/test/resources/logback.xml", "diffHunk": "@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<configuration>\n+\n+  <appender name=\"console\" class=\"ch.qos.logback.core.ConsoleAppender\">\n+    <encoder>\n+      <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>\n+    </encoder>\n+  </appender>\n+\n+  <root level=\"INFO\">\n+    <appender-ref ref=\"console\"/>\n+  </root>\n+\n+  <logger name=\"io.opentelemetry\" level=\"debug\"/>\n+  <logger name=\"com.splunk\" level=\"debug\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df3ad0e2af2cb65dd9475f76197efbaf35a7a89a"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MjQ5OTEyOnYy", "diffSide": "RIGHT", "path": "examples/distro/smoke-tests/src/test/java/com/example/javaagent/smoketest/SpringBootSmokeTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjozNzo1NFrOH0y5mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjozNzo1NFrOH0y5mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyMTk0Ng==", "bodyText": "What do you think about adding // given // when // then comments?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1621#discussion_r525121946", "createdAt": "2020-11-17T12:37:54Z", "author": {"login": "mateuszrzeszutek"}, "path": "examples/distro/smoke-tests/src/test/java/com/example/javaagent/smoketest/SpringBootSmokeTest.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package com.example.javaagent.smoketest;\n+\n+import io.opentelemetry.api.trace.TraceId;\n+import io.opentelemetry.proto.collector.trace.v1.ExportTraceServiceRequest;\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.jar.Attributes;\n+import java.util.jar.JarFile;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+\n+class SpringBootSmokeTest extends SmokeTest {\n+\n+  protected String getTargetImage(int jdk) {\n+    return \"open-telemetry-docker-dev.bintray.io/java/smoke-springboot-jdk\" + jdk + \":latest\";\n+  }\n+\n+  @Test\n+  public void springBootSmokeTestOnJDK() throws IOException, InterruptedException {\n+    startTarget(11);\n+    String url = String.format(\"http://localhost:%d/greeting\", target.getMappedPort(8080));\n+    Request request = new Request.Builder().url(url).get().build();\n+\n+    String currentAgentVersion =\n+        (String) new JarFile(agentPath)\n+            .getManifest()\n+            .getMainAttributes()\n+            .get(Attributes.Name.IMPLEMENTATION_VERSION);\n+\n+    Response response = client.newCall(request).execute();\n+    System.out.println(response.headers().toString());\n+\n+    Collection<ExportTraceServiceRequest> traces = waitForTraces();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df3ad0e2af2cb65dd9475f76197efbaf35a7a89a"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4563, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}