{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczODA4MDM2", "number": 156, "title": "Capture servlet dispatch as INTERNAL span", "bodyText": "This PR changes behavior for dispatches via AsyncContext.\nDispatches via RequestDispatcher are already captured as INTERNAL spans.\nDispatches via AsyncContext are a bit harder though, since we can't just wrap the dispatch itself in an internal span. We have to let the dispatched servlet know that it is a dispatch, and capture the span there.\nOne other related change here is that I removed propagation of the SpanContext in the request attributes during dispatching, since we are propagating the (parent) Span in request attributes already, so this seems unnecessary.", "createdAt": "2020-02-11T18:16:15Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/156", "merged": true, "mergeCommit": {"oid": "23f6e1513deda253a928656f97d0cd98d544479e"}, "closed": true, "closedAt": "2020-02-21T17:31:49Z", "author": {"login": "trask"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDLH8KgH2gAyMzczODA4MDM2OmE5YjQxZjM1ZWY1YzRlZWNhNGY4MDBkMTA1Yjc3ZWIxZDdkNGRkNTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGi6q4gH2gAyMzczODA4MDM2OmEwMjcxMDRkNDg4OTJkNjIxYzRkMmU4N2EwZmU4MzY4NjZhMTQ4ZTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a9b41f35ef5c4eeca4f800d105b77eb1d7d4dd57", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a9b41f35ef5c4eeca4f800d105b77eb1d7d4dd57", "committedDate": "2020-02-11T05:45:29Z", "message": "Capture servlet dispatch as INTERNAL span"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff7321622937f1f02ec26243343675443860bc83", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ff7321622937f1f02ec26243343675443860bc83", "committedDate": "2020-02-11T18:36:44Z", "message": "Empty commit to trigger CI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a6c028ee2b309c739d6664f945883ae2a41c1f2", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9a6c028ee2b309c739d6664f945883ae2a41c1f2", "committedDate": "2020-02-14T01:14:45Z", "message": "Merge branch 'master' into capture-servlet-dispatch-as-internal-span"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNTczMzE4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/156#pullrequestreview-360573318", "createdAt": "2020-02-18T18:31:14Z", "commit": {"oid": "9a6c028ee2b309c739d6664f945883ae2a41c1f2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODozMToxNFrOFrNoYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODozMToxNFrOFrNoYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg1NjQxOA==", "bodyText": "Why remove the null check?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/156#discussion_r380856418", "createdAt": "2020-02-18T18:31:14Z", "author": {"login": "tylerbenson"}, "path": "instrumentation/servlet/src/main/java/io/opentelemetry/auto/instrumentation/servlet/dispatcher/RequestDispatcherInstrumentation.java", "diffHunk": "@@ -95,17 +92,15 @@ public static SpanWithScope start(\n     @Advice.OnMethodExit(onThrowable = Throwable.class, suppress = Throwable.class)\n     public static void stop(\n         @Advice.Enter final SpanWithScope spanWithScope,\n-        @Advice.Local(\"_requestSpan\") final Object requestSpan,\n+        @Advice.Local(\"_originalServletSpan\") final Object originalServletSpan,\n         @Advice.Argument(0) final ServletRequest request,\n         @Advice.Thrown final Throwable throwable) {\n       if (spanWithScope == null) {\n         return;\n       }\n \n-      if (requestSpan != null) {\n-        // now add it back...\n-        request.setAttribute(SPAN_ATTRIBUTE, requestSpan);\n-      }\n+      // restore the original servlet span\n+      request.setAttribute(SPAN_ATTRIBUTE, originalServletSpan);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a6c028ee2b309c739d6664f945883ae2a41c1f2"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e2f4988c981da2caa6450ad604a22b637fe4495", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3e2f4988c981da2caa6450ad604a22b637fe4495", "committedDate": "2020-02-18T19:16:54Z", "message": "Add clarifying comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e5fffb81f443c28b030486f3f00648085b443ff", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/6e5fffb81f443c28b030486f3f00648085b443ff", "committedDate": "2020-02-18T19:56:23Z", "message": "Merge branch 'master' into capture-servlet-dispatch-as-internal-span"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39072542a2c744edb06fb58e9c01d8a464baba30", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/39072542a2c744edb06fb58e9c01d8a464baba30", "committedDate": "2020-02-20T03:14:17Z", "message": "Merge branch 'master' into capture-servlet-dispatch-as-internal-span"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a027104d48892d621c4d2e87a0fe836866a148e7", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/a027104d48892d621c4d2e87a0fe836866a148e7", "committedDate": "2020-02-21T17:10:29Z", "message": "Merge branch 'master' into capture-servlet-dispatch-as-internal-span"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3306, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}