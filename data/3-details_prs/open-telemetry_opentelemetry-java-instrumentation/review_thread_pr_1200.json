{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2NjM1MDEz", "number": 1200, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNDo0MzoxN1rOEjLGgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjo0NjozM1rOEkCbjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MzE3NTA0OnYy", "diffSide": "RIGHT", "path": "README.md", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNDo0MzoxN1rOHRYaGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNTozNzo0NVrOHRbERw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk4NzczOA==", "bodyText": "We generally try to support as old version as possible. Are there some hard reasons why we cannot decrease this version?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r487987738", "createdAt": "2020-09-14T14:43:17Z", "author": {"login": "iNikem"}, "path": "README.md", "diffHunk": "@@ -204,6 +204,7 @@ provide the path to a JAR file including an SPI implementation using the system\n | [khttp](https://khttp.readthedocs.io)                                                                                                 | 0.1+                           |\n | [Kubernetes Client](https://github.com/kubernetes-client/java)                                                                        | 7.0+                           |\n | [Lettuce](https://github.com/lettuce-io/lettuce-core)                                                                                 | 4.0+                           |\n+| [Log4j 2](https://logging.apache.org/log4j/2.x/)                                                                                      | 2.13.2+                        |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e860520997f48c8529ba9458d55e5bdb8570bf8a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk5MDU5Mw==", "bodyText": "A, I see. Our current manual instrumentation uses a recent SPI. But if we go to bytecode level, can we actually provide support for older versions?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r487990593", "createdAt": "2020-09-14T14:47:05Z", "author": {"login": "iNikem"}, "path": "README.md", "diffHunk": "@@ -204,6 +204,7 @@ provide the path to a JAR file including an SPI implementation using the system\n | [khttp](https://khttp.readthedocs.io)                                                                                                 | 0.1+                           |\n | [Kubernetes Client](https://github.com/kubernetes-client/java)                                                                        | 7.0+                           |\n | [Lettuce](https://github.com/lettuce-io/lettuce-core)                                                                                 | 4.0+                           |\n+| [Log4j 2](https://logging.apache.org/log4j/2.x/)                                                                                      | 2.13.2+                        |", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk4NzczOA=="}, "originalCommit": {"oid": "e860520997f48c8529ba9458d55e5bdb8570bf8a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk5ODk3MA==", "bodyText": "But if we go to bytecode level, can we actually provide support for older versions?\n\nYes, we can. I can add a separate instrumentation and instrument all ContecxtDataInjector implementations and support as low as 2.7 (which is 4 years old). If we want to go lower it'd probably turn out to be more complicated.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r487998970", "createdAt": "2020-09-14T14:57:48Z", "author": {"login": "mateuszrzeszutek"}, "path": "README.md", "diffHunk": "@@ -204,6 +204,7 @@ provide the path to a JAR file including an SPI implementation using the system\n | [khttp](https://khttp.readthedocs.io)                                                                                                 | 0.1+                           |\n | [Kubernetes Client](https://github.com/kubernetes-client/java)                                                                        | 7.0+                           |\n | [Lettuce](https://github.com/lettuce-io/lettuce-core)                                                                                 | 4.0+                           |\n+| [Log4j 2](https://logging.apache.org/log4j/2.x/)                                                                                      | 2.13.2+                        |", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk4NzczOA=="}, "originalCommit": {"oid": "e860520997f48c8529ba9458d55e5bdb8570bf8a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzMTMwMw==", "bodyText": "Done.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r488031303", "createdAt": "2020-09-14T15:37:45Z", "author": {"login": "mateuszrzeszutek"}, "path": "README.md", "diffHunk": "@@ -204,6 +204,7 @@ provide the path to a JAR file including an SPI implementation using the system\n | [khttp](https://khttp.readthedocs.io)                                                                                                 | 0.1+                           |\n | [Kubernetes Client](https://github.com/kubernetes-client/java)                                                                        | 7.0+                           |\n | [Lettuce](https://github.com/lettuce-io/lettuce-core)                                                                                 | 4.0+                           |\n+| [Log4j 2](https://logging.apache.org/log4j/2.x/)                                                                                      | 2.13.2+                        |", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk4NzczOA=="}, "originalCommit": {"oid": "e860520997f48c8529ba9458d55e5bdb8570bf8a"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MzQ1ODUyOnYy", "diffSide": "RIGHT", "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27Instrumentation.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNTo0MDoxMlrOHRbK4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMDo0NzozN1rOHR75nQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzMjk5NQ==", "bodyText": "By the way, what do you think about adding some logging constant class to keep those three strings somewhere in auto-api?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r488032995", "createdAt": "2020-09-14T15:40:12Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27Instrumentation.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_7;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.implementsInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner.Typing;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.util.SortedArrayStringMap;\n+import org.apache.logging.log4j.util.StringMap;\n+\n+@AutoService(Instrumenter.class)\n+public class Log4j27Instrumentation extends Instrumenter.Default {\n+  public Log4j27Instrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j2.7\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\"));\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return implementsInterface(named(\"org.apache.logging.log4j.core.ContextDataInjector\"));\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return Collections.singletonMap(\n+        isMethod()\n+            .and(named(\"injectContextData\"))\n+            .and(returns(named(\"org.apache.logging.log4j.util.StringMap\"))),\n+        Log4j27Instrumentation.class.getName() + \"$InjectContextDataAdvice\");\n+  }\n+\n+  public static class InjectContextDataAdvice {\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static void onExit(\n+        @Advice.Return(typing = Typing.DYNAMIC, readOnly = false) StringMap contextData) {\n+      SpanContext currentContext = TracingContextUtils.getCurrentSpan().getContext();\n+      if (!currentContext.isValid()) {\n+        return;\n+      }\n+\n+      if (contextData.containsKey(\"traceId\")) {\n+        // Assume already instrumented event if traceId is present.\n+        return;\n+      }\n+\n+      StringMap newContextData = new SortedArrayStringMap(contextData);\n+      newContextData.putValue(\"traceId\", currentContext.getTraceId().toLowerBase16());\n+      newContextData.putValue(\"spanId\", currentContext.getSpanId().toLowerBase16());\n+      newContextData.putValue(\"traceFlags\", currentContext.getTraceFlags().toLowerBase16());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5687f2ee54a1dca8c3471f4fdf61e54a2fddef36"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzNjAwOA==", "bodyText": "If they are used in multiple places, why not", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r488036008", "createdAt": "2020-09-14T15:44:27Z", "author": {"login": "iNikem"}, "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27Instrumentation.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_7;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.implementsInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner.Typing;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.util.SortedArrayStringMap;\n+import org.apache.logging.log4j.util.StringMap;\n+\n+@AutoService(Instrumenter.class)\n+public class Log4j27Instrumentation extends Instrumenter.Default {\n+  public Log4j27Instrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j2.7\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\"));\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return implementsInterface(named(\"org.apache.logging.log4j.core.ContextDataInjector\"));\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return Collections.singletonMap(\n+        isMethod()\n+            .and(named(\"injectContextData\"))\n+            .and(returns(named(\"org.apache.logging.log4j.util.StringMap\"))),\n+        Log4j27Instrumentation.class.getName() + \"$InjectContextDataAdvice\");\n+  }\n+\n+  public static class InjectContextDataAdvice {\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static void onExit(\n+        @Advice.Return(typing = Typing.DYNAMIC, readOnly = false) StringMap contextData) {\n+      SpanContext currentContext = TracingContextUtils.getCurrentSpan().getContext();\n+      if (!currentContext.isValid()) {\n+        return;\n+      }\n+\n+      if (contextData.containsKey(\"traceId\")) {\n+        // Assume already instrumented event if traceId is present.\n+        return;\n+      }\n+\n+      StringMap newContextData = new SortedArrayStringMap(contextData);\n+      newContextData.putValue(\"traceId\", currentContext.getTraceId().toLowerBase16());\n+      newContextData.putValue(\"spanId\", currentContext.getSpanId().toLowerBase16());\n+      newContextData.putValue(\"traceFlags\", currentContext.getTraceFlags().toLowerBase16());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzMjk5NQ=="}, "originalCommit": {"oid": "5687f2ee54a1dca8c3471f4fdf61e54a2fddef36"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU2OTI0NQ==", "bodyText": "Done.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r488569245", "createdAt": "2020-09-15T10:47:37Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27Instrumentation.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_7;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.implementsInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner.Typing;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.util.SortedArrayStringMap;\n+import org.apache.logging.log4j.util.StringMap;\n+\n+@AutoService(Instrumenter.class)\n+public class Log4j27Instrumentation extends Instrumenter.Default {\n+  public Log4j27Instrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j2.7\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\"));\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return implementsInterface(named(\"org.apache.logging.log4j.core.ContextDataInjector\"));\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return Collections.singletonMap(\n+        isMethod()\n+            .and(named(\"injectContextData\"))\n+            .and(returns(named(\"org.apache.logging.log4j.util.StringMap\"))),\n+        Log4j27Instrumentation.class.getName() + \"$InjectContextDataAdvice\");\n+  }\n+\n+  public static class InjectContextDataAdvice {\n+    @Advice.OnMethodExit(suppress = Throwable.class)\n+    public static void onExit(\n+        @Advice.Return(typing = Typing.DYNAMIC, readOnly = false) StringMap contextData) {\n+      SpanContext currentContext = TracingContextUtils.getCurrentSpan().getContext();\n+      if (!currentContext.isValid()) {\n+        return;\n+      }\n+\n+      if (contextData.containsKey(\"traceId\")) {\n+        // Assume already instrumented event if traceId is present.\n+        return;\n+      }\n+\n+      StringMap newContextData = new SortedArrayStringMap(contextData);\n+      newContextData.putValue(\"traceId\", currentContext.getTraceId().toLowerBase16());\n+      newContextData.putValue(\"spanId\", currentContext.getSpanId().toLowerBase16());\n+      newContextData.putValue(\"traceFlags\", currentContext.getTraceFlags().toLowerBase16());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAzMjk5NQ=="}, "originalCommit": {"oid": "5687f2ee54a1dca8c3471f4fdf61e54a2fddef36"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NzQ5NjU1OnYy", "diffSide": "RIGHT", "path": "README.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMzoxMjoyNlrOHSBIMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMzoxMjoyNlrOHSBIMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY1NDg5OQ==", "bodyText": "2.7+ now, correct?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r488654899", "createdAt": "2020-09-15T13:12:26Z", "author": {"login": "iNikem"}, "path": "README.md", "diffHunk": "@@ -204,6 +204,7 @@ provide the path to a JAR file including an SPI implementation using the system\n | [khttp](https://khttp.readthedocs.io)                                                                                                 | 0.1+                           |\n | [Kubernetes Client](https://github.com/kubernetes-client/java)                                                                        | 7.0+                           |\n | [Lettuce](https://github.com/lettuce-io/lettuce-core)                                                                                 | 4.0+                           |\n+| [Log4j 2](https://logging.apache.org/log4j/2.x/)                                                                                      | 2.13.2+                        |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3146643d5348feec28bfeac3391fa5b9b88e841c"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NzQ5ODYzOnYy", "diffSide": "RIGHT", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/log/MdcConstants.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMzoxMjo1NlrOHSBJkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMzoxMjo1NlrOHSBJkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY1NTI0OA==", "bodyText": "This is not MDC specific", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r488655248", "createdAt": "2020-09-15T13:12:56Z", "author": {"login": "iNikem"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/log/MdcConstants.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.log;\n+\n+/** This class contains several constants used in logging libraries' MDC instrumentations. */\n+public final class MdcConstants {\n+  /** Key under which the current trace id will be injected into the context data. */\n+  public static final String TRACE_ID = \"traceId\";\n+  /** Key under which the current span id will be injected into the context data. */\n+  public static final String SPAN_ID = \"spanId\";\n+  /**\n+   * Key under which a boolean indicating whether current span is sampled will be injected into the\n+   * context data.\n+   */\n+  public static final String SAMPLED = \"sampled\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3146643d5348feec28bfeac3391fa5b9b88e841c"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MDE0NzI2OnYy", "diffSide": "RIGHT", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/log/MdcConstants.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMDoxMToxOVrOHSbelw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwODozNDoxNlrOHSmJMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4NjYxNQ==", "bodyText": "MDC is a name used by slf4j but these are more generic, how about LoggingContextConstants or LoggingTags?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489086615", "createdAt": "2020-09-16T00:11:19Z", "author": {"login": "anuraaga"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/log/MdcConstants.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.log;\n+\n+/** This class contains several constants used in logging libraries' MDC instrumentations. */\n+public final class MdcConstants {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3146643d5348feec28bfeac3391fa5b9b88e841c"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI2MTM2Mg==", "bodyText": "Good point, done.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489261362", "createdAt": "2020-09-16T08:34:16Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/log/MdcConstants.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.api.log;\n+\n+/** This class contains several constants used in logging libraries' MDC instrumentations. */\n+public final class MdcConstants {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4NjYxNQ=="}, "originalCommit": {"oid": "3146643d5348feec28bfeac3391fa5b9b88e841c"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MDE1MjcwOnYy", "diffSide": "RIGHT", "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27MdcInstrumentation.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMDoxNDoyMFrOHSbh1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwODozNToyNVrOHSmMJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4NzQ0Nw==", "bodyText": "Generally looking good - is there a reason to use bytecode instrumentation here instead of the SPI?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489087447", "createdAt": "2020-09-16T00:14:20Z", "author": {"login": "anuraaga"}, "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_7;\n+\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.SAMPLED;\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.SPAN_ID;\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.TRACE_ID;\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.implementsInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner.Typing;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.util.SortedArrayStringMap;\n+import org.apache.logging.log4j.util.StringMap;\n+\n+@AutoService(Instrumenter.class)\n+public class Log4j27MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j27MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.7\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\"));\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return implementsInterface(named(\"org.apache.logging.log4j.core.ContextDataInjector\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3146643d5348feec28bfeac3391fa5b9b88e841c"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4Nzg3Mw==", "bodyText": "Oops - now I remember this wasn't even SPI >< https://logging.apache.org/log4j/2.x/log4j-core/apidocs/org/apache/logging/log4j/core/impl/ContextDataInjectorFactory.html", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489087873", "createdAt": "2020-09-16T00:15:44Z", "author": {"login": "anuraaga"}, "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_7;\n+\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.SAMPLED;\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.SPAN_ID;\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.TRACE_ID;\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.implementsInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner.Typing;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.util.SortedArrayStringMap;\n+import org.apache.logging.log4j.util.StringMap;\n+\n+@AutoService(Instrumenter.class)\n+public class Log4j27MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j27MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.7\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\"));\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return implementsInterface(named(\"org.apache.logging.log4j.core.ContextDataInjector\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4NzQ0Nw=="}, "originalCommit": {"oid": "3146643d5348feec28bfeac3391fa5b9b88e841c"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI2MjExNw==", "bodyText": "Yeah, unfortunately it's not an SPI - but it's still a nice, single responsibility interface for context data injection.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489262117", "createdAt": "2020-09-16T08:35:25Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_7;\n+\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.SAMPLED;\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.SPAN_ID;\n+import static io.opentelemetry.instrumentation.api.log.MdcConstants.TRACE_ID;\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.implementsInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import io.opentelemetry.trace.SpanContext;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner.Typing;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.util.SortedArrayStringMap;\n+import org.apache.logging.log4j.util.StringMap;\n+\n+@AutoService(Instrumenter.class)\n+public class Log4j27MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j27MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.7\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\"));\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return implementsInterface(named(\"org.apache.logging.log4j.core.ContextDataInjector\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4NzQ0Nw=="}, "originalCommit": {"oid": "3146643d5348feec28bfeac3391fa5b9b88e841c"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MTMxMjIzOnYy", "diffSide": "RIGHT", "path": "instrumentation/log4j/log4j-2-testing/src/main/groovy/Log4j2Test.groovy", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwODozNzowNlrOHSmQQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwODo0NzozNVrOHSmtZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI2MzE2OA==", "bodyText": "If I'm reading correctly, this is the base for both library and auto instrumentation. In that case it can't extend AgentTestRunner which executes auto instrumentation. We AgentTestTrait and InstrumentationTestTrait instead, do those work?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489263168", "createdAt": "2020-09-16T08:37:06Z", "author": {"login": "anuraaga"}, "path": "instrumentation/log4j/log4j-2-testing/src/main/groovy/Log4j2Test.groovy", "diffHunk": "@@ -14,24 +14,22 @@\n  * limitations under the License.\n  */\n \n-package io.opentelemetry.instrumentation.log4j.v2_13_2\n-\n+import io.opentelemetry.auto.test.AgentTestRunner\n import io.opentelemetry.auto.test.utils.TraceUtils\n+import io.opentelemetry.instrumentation.log4j.v2_13_2.ListAppender\n import io.opentelemetry.trace.Span\n import io.opentelemetry.trace.TracingContextUtils\n import org.apache.logging.log4j.LogManager\n-import org.apache.logging.log4j.Logger\n-import spock.lang.Specification\n-\n-class Log4j2Test extends Specification {\n-\n-  private static final Logger logger = LogManager.getLogger(\"TestLogger\")\n \n+abstract class Log4j2Test extends AgentTestRunner {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e323d3c55ef9522d33c0fe3e9462a8f1bac1f626"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI3MDYzMA==", "bodyText": "It shouldn't execute auto instrumentation because it's not on classpath, but using those traits is a good idea anyway -- no need to run the agent if it's unnecessary. I'll fix that.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489270630", "createdAt": "2020-09-16T08:47:35Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/log4j/log4j-2-testing/src/main/groovy/Log4j2Test.groovy", "diffHunk": "@@ -14,24 +14,22 @@\n  * limitations under the License.\n  */\n \n-package io.opentelemetry.instrumentation.log4j.v2_13_2\n-\n+import io.opentelemetry.auto.test.AgentTestRunner\n import io.opentelemetry.auto.test.utils.TraceUtils\n+import io.opentelemetry.instrumentation.log4j.v2_13_2.ListAppender\n import io.opentelemetry.trace.Span\n import io.opentelemetry.trace.TracingContextUtils\n import org.apache.logging.log4j.LogManager\n-import org.apache.logging.log4j.Logger\n-import spock.lang.Specification\n-\n-class Log4j2Test extends Specification {\n-\n-  private static final Logger logger = LogManager.getLogger(\"TestLogger\")\n \n+abstract class Log4j2Test extends AgentTestRunner {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI2MzE2OA=="}, "originalCommit": {"oid": "e323d3c55ef9522d33c0fe3e9462a8f1bac1f626"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MjAyMTg3OnYy", "diffSide": "RIGHT", "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27MdcInstrumentation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMTo0NzoyNlrOHStB7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjozNzozN1rOHSuxag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3NDE5MA==", "bodyText": "This is too broad matcher. The goal of classLoaderMatcher is to filter out as much classloaders as possible and not to match every class in it.\nAdd hasClasssName(\"org.apache.logging.log4j.core.impl.ContextDataInjectorFactory\") or similar.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489374190", "createdAt": "2020-09-16T11:47:26Z", "author": {"login": "iNikem"}, "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_7;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.isPublic;\n+import static net.bytebuddy.matcher.ElementMatchers.isStatic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner.Typing;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.core.ContextDataInjector;\n+\n+@AutoService(Instrumenter.class)\n+public class Log4j27MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j27MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.7\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\n+      \"io.opentelemetry.instrumentation.auto.log4j.v2_7.SpanDecoratingContextDataInjector\"\n+    };\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbb2d17e6e1dd40a8a466a4bde9ff8b925b87d86"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwMjczMA==", "bodyText": "Done.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489402730", "createdAt": "2020-09-16T12:37:37Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/log4j/log4j-2.7/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_7/Log4j27MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_7;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.isPublic;\n+import static net.bytebuddy.matcher.ElementMatchers.isStatic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.returns;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner.Typing;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.core.ContextDataInjector;\n+\n+@AutoService(Instrumenter.class)\n+public class Log4j27MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j27MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.7\");\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\n+      \"io.opentelemetry.instrumentation.auto.log4j.v2_7.SpanDecoratingContextDataInjector\"\n+    };\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return not(hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3NDE5MA=="}, "originalCommit": {"oid": "cbb2d17e6e1dd40a8a466a4bde9ff8b925b87d86"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MjA1MDY3OnYy", "diffSide": "RIGHT", "path": "instrumentation/log4j/log4j-2.13.2/auto/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_13_2/Log4j2MdcInstrumentation.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMTo1NToxN1rOHStTkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwODowNjozN1rOHTWWCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODcwNQ==", "bodyText": "Change to org.apache.logging.log4j.core.util.ContextDataProvider for consistency?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489378705", "createdAt": "2020-09-16T11:55:17Z", "author": {"login": "iNikem"}, "path": "instrumentation/log4j/log4j-2.13.2/auto/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_13_2/Log4j2MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_13_2;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public final class Log4j2MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j2MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.13.2\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return named(\"org.apache.logging.log4j.core.impl.ThreadContextDataInjector\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbb2d17e6e1dd40a8a466a4bde9ff8b925b87d86"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwMzYwNg==", "bodyText": "Unfortunately the instrumentation does not work if I use ContextDataProvider here: I suspect that it's because it's an interface.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489403606", "createdAt": "2020-09-16T12:39:16Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/log4j/log4j-2.13.2/auto/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_13_2/Log4j2MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_13_2;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public final class Log4j2MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j2MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.13.2\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return named(\"org.apache.logging.log4j.core.impl.ThreadContextDataInjector\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODcwNQ=="}, "originalCommit": {"oid": "cbb2d17e6e1dd40a8a466a4bde9ff8b925b87d86"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwNDkwNA==", "bodyText": "Then at least add the comment", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489404904", "createdAt": "2020-09-16T12:41:21Z", "author": {"login": "iNikem"}, "path": "instrumentation/log4j/log4j-2.13.2/auto/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_13_2/Log4j2MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_13_2;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public final class Log4j2MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j2MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.13.2\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return named(\"org.apache.logging.log4j.core.impl.ThreadContextDataInjector\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODcwNQ=="}, "originalCommit": {"oid": "cbb2d17e6e1dd40a8a466a4bde9ff8b925b87d86"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzMDY3OQ==", "bodyText": "Interfaces are ok.\nThe problem with using org.apache.logging.log4j.core.util.ContextDataProvider is that then helper class injection is performed during the loading (and transformation) of ContextDataProvider, which is a problem because one of the classes that we inject implements this same interface, causing the interface to be loaded while it's being transformed, which leads to duplicate class definition error after the interface is transformed and the triggering class loader tries to load it.\nIt seems this will be a common problem with injecting SPI resources, which is too bad, we'll need to be careful to pick type for the typeMatcher in these cases that we know will get loaded before SPI is triggered", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489830679", "createdAt": "2020-09-17T00:48:25Z", "author": {"login": "trask"}, "path": "instrumentation/log4j/log4j-2.13.2/auto/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_13_2/Log4j2MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_13_2;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public final class Log4j2MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j2MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.13.2\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return named(\"org.apache.logging.log4j.core.impl.ThreadContextDataInjector\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODcwNQ=="}, "originalCommit": {"oid": "cbb2d17e6e1dd40a8a466a4bde9ff8b925b87d86"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA1MTA4MQ==", "bodyText": "\ud83d\ude2e Thanks for the explanation, it makes much more sense now!\nI've replaced my comment with your explanation.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r490051081", "createdAt": "2020-09-17T08:06:37Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/log4j/log4j-2.13.2/auto/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_13_2/Log4j2MdcInstrumentation.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.log4j.v2_13_2;\n+\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.javaagent.tooling.Instrumenter;\n+import java.util.Collections;\n+import java.util.Map;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(Instrumenter.class)\n+public final class Log4j2MdcInstrumentation extends Instrumenter.Default {\n+  public Log4j2MdcInstrumentation() {\n+    super(\"log4j2\", \"log4j\", \"log4j-2.13.2\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"org.apache.logging.log4j.core.util.ContextDataProvider\");\n+  }\n+\n+  @Override\n+  public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    return named(\"org.apache.logging.log4j.core.impl.ThreadContextDataInjector\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODcwNQ=="}, "originalCommit": {"oid": "cbb2d17e6e1dd40a8a466a4bde9ff8b925b87d86"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MjI0MDEzOnYy", "diffSide": "RIGHT", "path": "instrumentation/log4j/log4j-2.13.2/auto/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_13_2/Log4j2MdcInstrumentation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjo0NjozM1rOHSvHEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjo0Nzo1NlrOHSvKYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwODI3NQ==", "bodyText": "\"match\", not \"instrument\" :) As you say yourself in transformers: \"Nothing to instrument\"", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489408275", "createdAt": "2020-09-16T12:46:33Z", "author": {"login": "iNikem"}, "path": "instrumentation/log4j/log4j-2.13.2/auto/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_13_2/Log4j2MdcInstrumentation.java", "diffHunk": "@@ -40,6 +40,8 @@ public Log4j2MdcInstrumentation() {\n \n   @Override\n   public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    // need to instrument a class, not an interface (ContextDataProvider) - otherwise helper classes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65d866f07b31bfbd8ef47f021e6c3096e4c05e08"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwOTEyMg==", "bodyText": "That's true \ud83e\udd26\nLittle things like that are the easiest to miss \ud83d\ude04", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1200#discussion_r489409122", "createdAt": "2020-09-16T12:47:56Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/log4j/log4j-2.13.2/auto/src/main/java/io/opentelemetry/instrumentation/auto/log4j/v2_13_2/Log4j2MdcInstrumentation.java", "diffHunk": "@@ -40,6 +40,8 @@ public Log4j2MdcInstrumentation() {\n \n   @Override\n   public ElementMatcher<? super TypeDescription> typeMatcher() {\n+    // need to instrument a class, not an interface (ContextDataProvider) - otherwise helper classes", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwODI3NQ=="}, "originalCommit": {"oid": "65d866f07b31bfbd8ef47f021e6c3096e4c05e08"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4910, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}