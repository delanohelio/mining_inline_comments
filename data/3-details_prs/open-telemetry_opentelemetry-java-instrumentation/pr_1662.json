{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNjIwNjkx", "number": 1662, "title": "Report only known collection names in MongoClientTracer (#1625)", "bodyText": "Use allow-list of commands that are known to use collection name as the value of the command\nSpecial-case getMore command, which uses a different field for the collection name", "createdAt": "2020-11-17T18:39:18Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662", "merged": true, "mergeCommit": {"oid": "d093a561b9b473751478b2dfbe9386c427122a70"}, "closed": true, "closedAt": "2020-11-20T00:26:27Z", "author": {"login": "jyemin"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddcwX2gH2gAyNTIyNjIwNjkxOmRiZmFjMmMyYzZkYzYwNDQyMmFmZWRjOTk4MTg1YjNjYmRhZTA1N2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeK5QOgH2gAyNTIyNjIwNjkxOmNmMzBlNWJhMGQ0NWVlNjUyMDg5ZDI2ZjFlYThlYzUzNTJiMGQ5OTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dbfac2c2c6dc604422afedc998185b3cbdae057e", "author": {"user": {"login": "jyemin", "name": "Jeff Yemin"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/dbfac2c2c6dc604422afedc998185b3cbdae057e", "committedDate": "2020-11-17T17:11:13Z", "message": "Report only known collection names in MongoClientTracer (#1625)\n\n* Use allow-list of commands that are known to use collection name as the value of the command\n* Special-case getMore command, which uses a different field for the collection name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNjg0Mjgx", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#pullrequestreview-532684281", "createdAt": "2020-11-17T18:47:56Z", "commit": {"oid": "dbfac2c2c6dc604422afedc998185b3cbdae057e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODo0Nzo1N1rOH1EEiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODo0Nzo1N1rOH1EEiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMzI3Mw==", "bodyText": "While a n allow-list is in some ways not future proof, in practice I think it's safe as the trend in MongoDB has been to use new initiating stages in aggregation pipelines to add new functionality (e.g. the $changeStream stage.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#discussion_r525403273", "createdAt": "2020-11-17T18:47:57Z", "author": {"login": "jyemin"}, "path": "instrumentation/mongo/mongo-common/src/main/java/io/opentelemetry/javaagent/instrumentation/mongo/MongoClientTracer.java", "diffHunk": "@@ -130,10 +133,24 @@ private static BsonValue scrub(BsonValue origin) {\n     return scrubbed;\n   }\n \n+  private static final Set<String> COMMANDS_WITH_COLLECTION_NAME_AS_VALUE =\n+      new HashSet<>(asList(\n+          \"aggregate\", \"count\", \"distinct\", \"mapReduce\", \"geoSearch\", \"delete\", \"find\", \"killCursors\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbfac2c2c6dc604422afedc998185b3cbdae057e"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNjg0NjM4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#pullrequestreview-532684638", "createdAt": "2020-11-17T18:48:25Z", "commit": {"oid": "dbfac2c2c6dc604422afedc998185b3cbdae057e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODo0ODoyNlrOH1EFjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODo0ODoyNlrOH1EFjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMzUzNQ==", "bodyText": "See https://docs.mongodb.com/manual/reference/command/getMore/", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#discussion_r525403535", "createdAt": "2020-11-17T18:48:26Z", "author": {"login": "jyemin"}, "path": "instrumentation/mongo/mongo-common/src/main/java/io/opentelemetry/javaagent/instrumentation/mongo/MongoClientTracer.java", "diffHunk": "@@ -130,10 +133,24 @@ private static BsonValue scrub(BsonValue origin) {\n     return scrubbed;\n   }\n \n+  private static final Set<String> COMMANDS_WITH_COLLECTION_NAME_AS_VALUE =\n+      new HashSet<>(asList(\n+          \"aggregate\", \"count\", \"distinct\", \"mapReduce\", \"geoSearch\", \"delete\", \"find\", \"killCursors\",\n+          \"findAndModify\", \"insert\", \"update\", \"listIndexes\"));\n+\n   private static String collectionName(CommandStartedEvent event) {\n-    BsonValue collectionValue = event.getCommand().get(event.getCommandName());\n-    if (collectionValue != null && collectionValue.isString()) {\n-      return collectionValue.asString().getValue();\n+    if (event.getCommandName().equals(\"getMore\")) {\n+      if (event.getCommand().containsKey(\"collection\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbfac2c2c6dc604422afedc998185b3cbdae057e"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dfd36984d01631bd4034d7f2b27a5219a58c4a8", "author": {"user": {"login": "jyemin", "name": "Jeff Yemin"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8dfd36984d01631bd4034d7f2b27a5219a58c4a8", "committedDate": "2020-11-17T21:29:44Z", "message": "Run spotlessApply"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTEzNjQ5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#pullrequestreview-533113649", "createdAt": "2020-11-18T05:26:52Z", "commit": {"oid": "8dfd36984d01631bd4034d7f2b27a5219a58c4a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNToyNjo1MlrOH1ds0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNToyNjo1MlrOH1ds0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyMzE4Ng==", "bodyText": "does it make sense to include create in this list?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#discussion_r525823186", "createdAt": "2020-11-18T05:26:52Z", "author": {"login": "trask"}, "path": "instrumentation/mongo/mongo-common/src/main/java/io/opentelemetry/javaagent/instrumentation/mongo/MongoClientTracer.java", "diffHunk": "@@ -130,10 +133,35 @@ private static BsonValue scrub(BsonValue origin) {\n     return scrubbed;\n   }\n \n+  private static final Set<String> COMMANDS_WITH_COLLECTION_NAME_AS_VALUE =\n+      new HashSet<>(\n+          asList(\n+              \"aggregate\",\n+              \"count\",\n+              \"distinct\",\n+              \"mapReduce\",\n+              \"geoSearch\",\n+              \"delete\",\n+              \"find\",\n+              \"killCursors\",\n+              \"findAndModify\",\n+              \"insert\",\n+              \"update\",\n+              \"listIndexes\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dfd36984d01631bd4034d7f2b27a5219a58c4a8"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4844c7a8f339568716adf3c0c7dbf5bb58bf173b", "author": {"user": {"login": "jyemin", "name": "Jeff Yemin"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/4844c7a8f339568716adf3c0c7dbf5bb58bf173b", "committedDate": "2020-11-19T12:30:30Z", "message": "Add create, drop, and createIndexes to list of commands with collection name as their values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9eba0a2c2dfa4aae807dd593e8eeae9b73cbc5e", "author": {"user": {"login": "jyemin", "name": "Jeff Yemin"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c9eba0a2c2dfa4aae807dd593e8eeae9b73cbc5e", "committedDate": "2020-11-19T12:37:26Z", "message": "Fixed async test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NjQwMDg5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1662#pullrequestreview-534640089", "createdAt": "2020-11-19T16:43:06Z", "commit": {"oid": "c9eba0a2c2dfa4aae807dd593e8eeae9b73cbc5e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf30e5ba0d45ee652089d26f1ea8ec5352b0d993", "author": {"user": {"login": "trask", "name": "Trask Stalnaker"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/cf30e5ba0d45ee652089d26f1ea8ec5352b0d993", "committedDate": "2020-11-19T22:56:33Z", "message": "Merge remote-tracking branch 'upstream/master' into pr-1625-2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2268, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}