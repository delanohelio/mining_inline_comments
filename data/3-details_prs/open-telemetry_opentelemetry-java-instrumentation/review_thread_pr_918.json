{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MzQwMTQx", "number": 918, "reviewThreads": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMTozNDo1MVrOEWDAkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzowOToyMFrOEXFQzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTUzNDI1OnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMTozNDo1MVrOG9JiPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxOToyNzo1N1rOG9lbZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3MjU0MQ==", "bodyText": "I did try to replace SpanWithScope with Scope, but I have a problem getting the span out of the Scope.\nI need some feedback on howto.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r466772541", "createdAt": "2020-08-07T01:34:51Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "diffHunk": "@@ -74,14 +74,12 @@ public static void methodExit(\n         @Advice.Argument(value = 0, optional = true) final Request<?> request,\n         @Advice.Thrown final Throwable throwable) {\n       if (throwable != null) {\n-        SpanWithScope spanWithScope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n-        if (spanWithScope != null) {\n+        SpanWithScope scope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n+        if (scope != null) {\n           request.addHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY, null);\n-          Span span = spanWithScope.getSpan();\n-          DECORATE.onError(span, throwable);\n-          DECORATE.beforeFinish(span);\n-          span.end();\n-          spanWithScope.closeScope();\n+          Span span = scope.getSpan();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d2d53cb8de50108ef082c0453de9a91c5bc6fc"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5MTMyNQ==", "bodyText": "i'm not sure what to do about this either, i recommend out of scope for this PR", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467191325", "createdAt": "2020-08-07T18:04:03Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "diffHunk": "@@ -74,14 +74,12 @@ public static void methodExit(\n         @Advice.Argument(value = 0, optional = true) final Request<?> request,\n         @Advice.Thrown final Throwable throwable) {\n       if (throwable != null) {\n-        SpanWithScope spanWithScope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n-        if (spanWithScope != null) {\n+        SpanWithScope scope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n+        if (scope != null) {\n           request.addHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY, null);\n-          Span span = spanWithScope.getSpan();\n-          DECORATE.onError(span, throwable);\n-          DECORATE.beforeFinish(span);\n-          span.end();\n-          spanWithScope.closeScope();\n+          Span span = scope.getSpan();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3MjU0MQ=="}, "originalCommit": {"oid": "30d2d53cb8de50108ef082c0453de9a91c5bc6fc"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIyOTU0MA==", "bodyText": "Not sure how to setup onMethodEnter... so that we can take local \"otelSpan\" as parameter and then onMethodExit can pass that span as an incoming parameter.. that's the pattern we have elsewhere.  @anuraaga might be able to help with this?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467229540", "createdAt": "2020-08-07T19:27:57Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "diffHunk": "@@ -74,14 +74,12 @@ public static void methodExit(\n         @Advice.Argument(value = 0, optional = true) final Request<?> request,\n         @Advice.Thrown final Throwable throwable) {\n       if (throwable != null) {\n-        SpanWithScope spanWithScope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n-        if (spanWithScope != null) {\n+        SpanWithScope scope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n+        if (scope != null) {\n           request.addHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY, null);\n-          Span span = spanWithScope.getSpan();\n-          DECORATE.onError(span, throwable);\n-          DECORATE.beforeFinish(span);\n-          span.end();\n-          spanWithScope.closeScope();\n+          Span span = scope.getSpan();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3MjU0MQ=="}, "originalCommit": {"oid": "30d2d53cb8de50108ef082c0453de9a91c5bc6fc"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTUzNDk3OnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMTozNTowN1rOG9Jimw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMTozNTowN1rOG9Jimw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3MjYzNQ==", "bodyText": "Same as above.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r466772635", "createdAt": "2020-08-07T01:35:07Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "diffHunk": "@@ -112,14 +110,12 @@ public static void methodExit(\n           @Advice.FieldValue(\"request\") final Request<?> request,\n           @Advice.Thrown final Throwable throwable) {\n         if (throwable != null) {\n-          SpanWithScope spanWithScope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n-          if (spanWithScope != null) {\n+          SpanWithScope scope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n+          if (scope != null) {\n             request.addHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY, null);\n-            Span span = spanWithScope.getSpan();\n-            DECORATE.onError(span, throwable);\n-            DECORATE.beforeFinish(span);\n-            span.end();\n-            spanWithScope.closeScope();\n+            Span span = scope.getSpan();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d2d53cb8de50108ef082c0453de9a91c5bc6fc"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTUzNjU3OnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/OnErrorTracer.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMTozNjowMFrOG9Jjgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMjoyNDo1NVrOG9qbmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3Mjg2Ng==", "bodyText": "Not sure if i have followed the right naming convention here.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r466772866", "createdAt": "2020-08-07T01:36:00Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/OnErrorTracer.java", "diffHunk": "@@ -16,8 +16,13 @@\n \n package io.opentelemetry.auto.instrumentation.awssdk.v1_11;\n \n-import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseDecorator;\n+import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseTracer;\n \n-public class OnErrorDecorator extends BaseDecorator {\n-  public static final OnErrorDecorator DECORATE = new OnErrorDecorator();\n+public class OnErrorTracer extends BaseTracer {\n+  public static final OnErrorTracer ERROR_TRACER = new OnErrorTracer();\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.aws-sdk-1.11-error\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d2d53cb8de50108ef082c0453de9a91c5bc6fc"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5NzEwMw==", "bodyText": "current convention is for this to be based on module name only, e.g. io.opentelemetry.auto.aws-sdk-1.11", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467197103", "createdAt": "2020-08-07T18:16:00Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/OnErrorTracer.java", "diffHunk": "@@ -16,8 +16,13 @@\n \n package io.opentelemetry.auto.instrumentation.awssdk.v1_11;\n \n-import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseDecorator;\n+import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseTracer;\n \n-public class OnErrorDecorator extends BaseDecorator {\n-  public static final OnErrorDecorator DECORATE = new OnErrorDecorator();\n+public class OnErrorTracer extends BaseTracer {\n+  public static final OnErrorTracer ERROR_TRACER = new OnErrorTracer();\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.aws-sdk-1.11-error\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3Mjg2Ng=="}, "originalCommit": {"oid": "30d2d53cb8de50108ef082c0453de9a91c5bc6fc"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIyNzMyNw==", "bodyText": "AwsSdkClientTracer has already used \"io.opentelemetry.auto.aws-sdk-1.11\".", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467227327", "createdAt": "2020-08-07T19:22:47Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/OnErrorTracer.java", "diffHunk": "@@ -16,8 +16,13 @@\n \n package io.opentelemetry.auto.instrumentation.awssdk.v1_11;\n \n-import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseDecorator;\n+import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseTracer;\n \n-public class OnErrorDecorator extends BaseDecorator {\n-  public static final OnErrorDecorator DECORATE = new OnErrorDecorator();\n+public class OnErrorTracer extends BaseTracer {\n+  public static final OnErrorTracer ERROR_TRACER = new OnErrorTracer();\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.aws-sdk-1.11-error\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3Mjg2Ng=="}, "originalCommit": {"oid": "30d2d53cb8de50108ef082c0453de9a91c5bc6fc"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI0MzA3Mg==", "bodyText": "it's ok, the SDK will return the same Tracer when we re-use the same instrumentationName / instrumentationVersion pair", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467243072", "createdAt": "2020-08-07T20:00:33Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/OnErrorTracer.java", "diffHunk": "@@ -16,8 +16,13 @@\n \n package io.opentelemetry.auto.instrumentation.awssdk.v1_11;\n \n-import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseDecorator;\n+import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseTracer;\n \n-public class OnErrorDecorator extends BaseDecorator {\n-  public static final OnErrorDecorator DECORATE = new OnErrorDecorator();\n+public class OnErrorTracer extends BaseTracer {\n+  public static final OnErrorTracer ERROR_TRACER = new OnErrorTracer();\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.aws-sdk-1.11-error\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3Mjg2Ng=="}, "originalCommit": {"oid": "30d2d53cb8de50108ef082c0453de9a91c5bc6fc"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMTUxNA==", "bodyText": "This is removed in #922.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467311514", "createdAt": "2020-08-07T22:24:55Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/OnErrorTracer.java", "diffHunk": "@@ -16,8 +16,13 @@\n \n package io.opentelemetry.auto.instrumentation.awssdk.v1_11;\n \n-import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseDecorator;\n+import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseTracer;\n \n-public class OnErrorDecorator extends BaseDecorator {\n-  public static final OnErrorDecorator DECORATE = new OnErrorDecorator();\n+public class OnErrorTracer extends BaseTracer {\n+  public static final OnErrorTracer ERROR_TRACER = new OnErrorTracer();\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.aws-sdk-1.11-error\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3Mjg2Ng=="}, "originalCommit": {"oid": "30d2d53cb8de50108ef082c0453de9a91c5bc6fc"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTU3Mjc1OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/ClientTracer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMTo1Njo1N1rOG9J4KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMDozMTo1MFrOG-ewrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3ODE1Mw==", "bodyText": "this is used by TracingExecutionInterceptor.beforeExecution.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r466778153", "createdAt": "2020-08-07T01:56:57Z", "author": {"login": "heyams"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/ClientTracer.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.Tracer;\n+import io.opentelemetry.trace.TracingContextUtils;\n+\n+public abstract class ClientTracer extends BaseTracer {\n+\n+  // Keeps track of the client span in a subtree corresponding to a client request.\n+  // Visible for testing\n+  static final Context.Key<Span> CONTEXT_CLIENT_SPAN_KEY =\n+      Context.key(\"opentelemetry-trace-auto-client-span-key\");\n+\n+  /**\n+   * Returns a new client {@link Span} if there is no client {@link Span} in the current {@link\n+   * Context}, or an invalid {@link Span} otherwise.\n+   */\n+  public Span getOrCreateSpan(String name, Tracer tracer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c03f0432ef415b8dac816648a27ecb093b7b90ce"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1NTkzMQ==", "bodyText": "hopefully we can use the normal startSpan in the future, since it's almost the same as this method\nfor now since this is only needed from aws-sdk-2.2, i think better put it in the AwsSdkClientTracer subclass\nalso, can remove Tracer param, and it will use the protected tracer field from BaseTracer super class", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467355931", "createdAt": "2020-08-08T03:34:45Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/ClientTracer.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.Tracer;\n+import io.opentelemetry.trace.TracingContextUtils;\n+\n+public abstract class ClientTracer extends BaseTracer {\n+\n+  // Keeps track of the client span in a subtree corresponding to a client request.\n+  // Visible for testing\n+  static final Context.Key<Span> CONTEXT_CLIENT_SPAN_KEY =\n+      Context.key(\"opentelemetry-trace-auto-client-span-key\");\n+\n+  /**\n+   * Returns a new client {@link Span} if there is no client {@link Span} in the current {@link\n+   * Context}, or an invalid {@link Span} otherwise.\n+   */\n+  public Span getOrCreateSpan(String name, Tracer tracer) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3ODE1Mw=="}, "originalCommit": {"oid": "c03f0432ef415b8dac816648a27ecb093b7b90ce"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE2ODg3Ng==", "bodyText": "This is also used in spring-webflux-5.0.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468168876", "createdAt": "2020-08-10T20:31:50Z", "author": {"login": "heyams"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/ClientTracer.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.Tracer;\n+import io.opentelemetry.trace.TracingContextUtils;\n+\n+public abstract class ClientTracer extends BaseTracer {\n+\n+  // Keeps track of the client span in a subtree corresponding to a client request.\n+  // Visible for testing\n+  static final Context.Key<Span> CONTEXT_CLIENT_SPAN_KEY =\n+      Context.key(\"opentelemetry-trace-auto-client-span-key\");\n+\n+  /**\n+   * Returns a new client {@link Span} if there is no client {@link Span} in the current {@link\n+   * Context}, or an invalid {@link Span} otherwise.\n+   */\n+  public Span getOrCreateSpan(String name, Tracer tracer) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3ODE1Mw=="}, "originalCommit": {"oid": "c03f0432ef415b8dac816648a27ecb093b7b90ce"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTU3Mzk0OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMTo1NzozMVrOG9J4zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMTo1NzozMVrOG9J4zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc3ODMxNw==", "bodyText": "this is needed by TracingExecutionInterceptor.afterMarshalling (2.2)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r466778317", "createdAt": "2020-08-07T01:57:31Z", "author": {"login": "heyams"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -100,7 +100,7 @@ private Span startSpan(REQUEST request, String name) {\n     return span;\n   }\n \n-  private Span onRequest(final Span span, final REQUEST request) {\n+  public Span onRequest(final Span span, final REQUEST request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c03f0432ef415b8dac816648a27ecb093b7b90ce"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxODI3ODAyOnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxODoxMDoxNVrOG9jR-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMDowMToyNlrOG9mRlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5NDM2MQ==", "bodyText": "i think consolidating these into a single method would be nice, e.g.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  TRACER.onRequest(span, context.httpRequest());\n          \n          \n            \n                  TRACER.onSdkRequest(span, context.request());\n          \n          \n            \n                  TRACER.onAttributes(span, executionAttributes);\n          \n          \n            \n                  TRACER.afterMarshalling(span, context, executionAttributes);", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467194361", "createdAt": "2020-08-07T18:10:15Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -53,9 +50,9 @@ public void afterMarshalling(\n     Span span = executionAttributes.getAttribute(SPAN_ATTRIBUTE);\n \n     if (span != null) {\n-      DECORATE.onRequest(span, context.httpRequest());\n-      DECORATE.onSdkRequest(span, context.request());\n-      DECORATE.onAttributes(span, executionAttributes);\n+      TRACER.onRequest(span, context.httpRequest());\n+      TRACER.onSdkRequest(span, context.request());\n+      TRACER.onAttributes(span, executionAttributes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1ddac5dd4ec8738b4bdf5d3e6db322898bf4720"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI0MzQxMg==", "bodyText": "Create a method called afterMarshalling in AwsSdkClientTracer or HttpClientTracer? There is no such a method in TRACER yet.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467243412", "createdAt": "2020-08-07T20:01:26Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -53,9 +50,9 @@ public void afterMarshalling(\n     Span span = executionAttributes.getAttribute(SPAN_ATTRIBUTE);\n \n     if (span != null) {\n-      DECORATE.onRequest(span, context.httpRequest());\n-      DECORATE.onSdkRequest(span, context.request());\n-      DECORATE.onAttributes(span, executionAttributes);\n+      TRACER.onRequest(span, context.httpRequest());\n+      TRACER.onSdkRequest(span, context.request());\n+      TRACER.onAttributes(span, executionAttributes);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5NDM2MQ=="}, "originalCommit": {"oid": "b1ddac5dd4ec8738b4bdf5d3e6db322898bf4720"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxODI4ODE0OnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxODoxMzozOVrOG9jYLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxODoxMzozOVrOG9jYLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5NTk0OQ==", "bodyText": "same here\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  TRACER.afterExecution(span, context.httpRequest());\n          \n          \n            \n                  // Call onResponse on both types of responses:\n          \n          \n            \n                  TRACER.onSdkResponse(span, context.response());\n          \n          \n            \n                  TRACER.end(span, context.httpResponse());\n          \n          \n            \n                  TRACER.afterExecution(span, context);", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467195949", "createdAt": "2020-08-07T18:13:39Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -64,16 +61,11 @@ public void afterExecution(\n       final Context.AfterExecution context, final ExecutionAttributes executionAttributes) {\n     Span span = executionAttributes.getAttribute(SPAN_ATTRIBUTE);\n     if (span != null) {\n-      try {\n-        executionAttributes.putAttribute(SPAN_ATTRIBUTE, null);\n-        DECORATE.afterExecution(span, context.httpRequest());\n-        // Call onResponse on both types of responses:\n-        DECORATE.onSdkResponse(span, context.response());\n-        DECORATE.onResponse(span, context.httpResponse());\n-        DECORATE.beforeFinish(span);\n-      } finally {\n-        span.end();\n-      }\n+      executionAttributes.putAttribute(SPAN_ATTRIBUTE, null);\n+      TRACER.afterExecution(span, context.httpRequest());\n+      // Call onResponse on both types of responses:\n+      TRACER.onSdkResponse(span, context.response());\n+      TRACER.end(span, context.httpResponse());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1ddac5dd4ec8738b4bdf5d3e6db322898bf4720"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxODMwMTM5OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxODoxODowNlrOG9jgcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMDowMjoyMFrOG9mS9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5ODA2NQ==", "bodyText": "i think this can stay private for now at least", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467198065", "createdAt": "2020-08-07T18:18:06Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -172,7 +171,7 @@ private Span onResponse(final Span span, final RESPONSE response) {\n     return span;\n   }\n \n-  private String spanNameForRequest(final REQUEST request) {\n+  protected String spanNameForRequest(final REQUEST request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1ddac5dd4ec8738b4bdf5d3e6db322898bf4720"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI0Mzc2Nw==", "bodyText": "It is needed in the branch 3.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467243767", "createdAt": "2020-08-07T20:02:20Z", "author": {"login": "heyams"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpClientTracer.java", "diffHunk": "@@ -172,7 +171,7 @@ private Span onResponse(final Span span, final RESPONSE response) {\n     return span;\n   }\n \n-  private String spanNameForRequest(final REQUEST request) {\n+  protected String spanNameForRequest(final REQUEST request) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5ODA2NQ=="}, "originalCommit": {"oid": "b1ddac5dd4ec8738b4bdf5d3e6db322898bf4720"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxOTM1MTY3OnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdk.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMzo0NTo1MFrOG9tMsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMDozMzowMFrOG-ey5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1Njg1MQ==", "bodyText": "these changes doesn't follow pattern used elsewhere, would be better to make this kind of change to convention in a separate PR, and across all modules, so we don't end up following different patterns in different places", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467356851", "createdAt": "2020-08-08T03:45:50Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdk.java", "diffHunk": "@@ -40,12 +40,12 @@\n  */\n public class AwsSdk {\n \n-  private static final Tracer TRACER =\n-      OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto.aws-sdk-2.2\");\n+  private static final Tracer tracer =\n+      OpenTelemetry.getTracerProvider().get(AwsSdkClientTracer.TRACER.getInstrumentationName());\n \n   /** Returns the {@link Tracer} used to instrument the AWS SDK. */\n   public static Tracer tracer() {\n-    return TRACER;\n+    return tracer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e75d9179acb7ec62ccb3ff1f3da2e77c27ac07ce"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE2ODEwNA==", "bodyText": "getOrCreateSpan is also used by spring-webflux-5.0 in another PR.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468168104", "createdAt": "2020-08-10T20:30:15Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdk.java", "diffHunk": "@@ -40,12 +40,12 @@\n  */\n public class AwsSdk {\n \n-  private static final Tracer TRACER =\n-      OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto.aws-sdk-2.2\");\n+  private static final Tracer tracer =\n+      OpenTelemetry.getTracerProvider().get(AwsSdkClientTracer.TRACER.getInstrumentationName());\n \n   /** Returns the {@link Tracer} used to instrument the AWS SDK. */\n   public static Tracer tracer() {\n-    return TRACER;\n+    return tracer;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1Njg1MQ=="}, "originalCommit": {"oid": "e75d9179acb7ec62ccb3ff1f3da2e77c27ac07ce"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE2OTQ0NQ==", "bodyText": "this is a rename of the instance variable.  i didn't introduce a new pattern.. it exists like this before.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468169445", "createdAt": "2020-08-10T20:33:00Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdk.java", "diffHunk": "@@ -40,12 +40,12 @@\n  */\n public class AwsSdk {\n \n-  private static final Tracer TRACER =\n-      OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto.aws-sdk-2.2\");\n+  private static final Tracer tracer =\n+      OpenTelemetry.getTracerProvider().get(AwsSdkClientTracer.TRACER.getInstrumentationName());\n \n   /** Returns the {@link Tracer} used to instrument the AWS SDK. */\n   public static Tracer tracer() {\n-    return TRACER;\n+    return tracer;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1Njg1MQ=="}, "originalCommit": {"oid": "e75d9179acb7ec62ccb3ff1f3da2e77c27ac07ce"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxOTM1MzgwOnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/ClientTracer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMzo0ODo1MlrOG9tNog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMzo0ODo1MlrOG9tNog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1NzA5MA==", "bodyText": "can you (either in this PR or add to #912) change DatabaseClientTracer to extend ClientTracer and remove DatabaseClientTracer.CONTEXT_CLIENT_SPAN_KEY since that's a duplicate of this now?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467357090", "createdAt": "2020-08-08T03:48:52Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/ClientTracer.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.bootstrap.instrumentation.decorator;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.trace.DefaultSpan;\n+import io.opentelemetry.trace.Span;\n+import io.opentelemetry.trace.Span.Kind;\n+import io.opentelemetry.trace.Tracer;\n+import io.opentelemetry.trace.TracingContextUtils;\n+\n+public abstract class ClientTracer extends BaseTracer {\n+\n+  // Keeps track of the client span in a subtree corresponding to a client request.\n+  // Visible for testing\n+  static final Context.Key<Span> CONTEXT_CLIENT_SPAN_KEY =\n+      Context.key(\"opentelemetry-trace-auto-client-span-key\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e75d9179acb7ec62ccb3ff1f3da2e77c27ac07ce"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxOTM1NjUzOnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/TracingRequestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMzo1Mjo0N1rOG9tO5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMzo1Mjo0N1rOG9tO5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1NzQxMw==", "bodyText": "this will look a little nicer i think\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Span span = scope.getSpan();\n          \n          \n            \n                  tracer.end(span, response);\n          \n          \n            \n                  tracer.end(scope.getSpan(), response);", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467357413", "createdAt": "2020-08-08T03:52:47Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/TracingRequestHandler.java", "diffHunk": "@@ -49,38 +45,31 @@ public AmazonWebServiceRequest beforeMarshalling(final AmazonWebServiceRequest r\n \n   @Override\n   public void beforeRequest(final Request<?> request) {\n-    Span span = decorate.getOrCreateSpan(request, TRACER);\n-    decorate.afterStart(span);\n-    decorate.onRequest(span, request);\n+    Span span = tracer.startSpan(request);\n     request.addHandlerContext(\n         SPAN_SCOPE_PAIR_CONTEXT_KEY,\n-        new SpanWithScope(\n-            span, ContextUtils.withScopedContext(ClientDecorator.currentContextWith(span))));\n+        new SpanWithScope(span, withScopedContext(currentContextWith(span))));\n   }\n \n   @Override\n   public void afterResponse(final Request<?> request, final Response<?> response) {\n-    SpanWithScope spanWithScope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n-    if (spanWithScope != null) {\n+    SpanWithScope scope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n+    if (scope != null) {\n       request.addHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY, null);\n-      spanWithScope.closeScope();\n-      Span span = spanWithScope.getSpan();\n-      decorate.onResponse(span, response);\n-      decorate.beforeFinish(span);\n-      span.end();\n+      scope.closeScope();\n+      Span span = scope.getSpan();\n+      tracer.end(span, response);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e75d9179acb7ec62ccb3ff1f3da2e77c27ac07ce"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxOTM1Njc1OnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/TracingRequestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMzo1MzowNVrOG9tO_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMzo1MzowNVrOG9tO_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1NzQzNw==", "bodyText": "same here\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Span span = scope.getSpan();\n          \n          \n            \n                  tracer.endExceptionally(span, e);\n          \n          \n            \n                  tracer.endExceptionally(scope.getSpan(), e);", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467357437", "createdAt": "2020-08-08T03:53:05Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/TracingRequestHandler.java", "diffHunk": "@@ -49,38 +45,31 @@ public AmazonWebServiceRequest beforeMarshalling(final AmazonWebServiceRequest r\n \n   @Override\n   public void beforeRequest(final Request<?> request) {\n-    Span span = decorate.getOrCreateSpan(request, TRACER);\n-    decorate.afterStart(span);\n-    decorate.onRequest(span, request);\n+    Span span = tracer.startSpan(request);\n     request.addHandlerContext(\n         SPAN_SCOPE_PAIR_CONTEXT_KEY,\n-        new SpanWithScope(\n-            span, ContextUtils.withScopedContext(ClientDecorator.currentContextWith(span))));\n+        new SpanWithScope(span, withScopedContext(currentContextWith(span))));\n   }\n \n   @Override\n   public void afterResponse(final Request<?> request, final Response<?> response) {\n-    SpanWithScope spanWithScope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n-    if (spanWithScope != null) {\n+    SpanWithScope scope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n+    if (scope != null) {\n       request.addHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY, null);\n-      spanWithScope.closeScope();\n-      Span span = spanWithScope.getSpan();\n-      decorate.onResponse(span, response);\n-      decorate.beforeFinish(span);\n-      span.end();\n+      scope.closeScope();\n+      Span span = scope.getSpan();\n+      tracer.end(span, response);\n     }\n   }\n \n   @Override\n   public void afterError(final Request<?> request, final Response<?> response, final Exception e) {\n-    SpanWithScope spanWithScope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n-    if (spanWithScope != null) {\n+    SpanWithScope scope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n+    if (scope != null) {\n       request.addHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY, null);\n-      spanWithScope.closeScope();\n-      Span span = spanWithScope.getSpan();\n-      decorate.onError(span, e);\n-      decorate.beforeFinish(span);\n-      span.end();\n+      scope.closeScope();\n+      Span span = scope.getSpan();\n+      tracer.endExceptionally(span, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e75d9179acb7ec62ccb3ff1f3da2e77c27ac07ce"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxOTM1Njk5OnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdkClientTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMzo1Mzo1NVrOG9tPIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMDo1Mjo0MVrOG-fY0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1NzQ3Mg==", "bodyText": "it looks like this method is not needed since only calls super\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n              @Override\n          \n          \n            \n              protected Span onRequest(Span span, SdkHttpRequest sdkHttpRequest) {\n          \n          \n            \n                return super.onRequest(span, sdkHttpRequest);\n          \n          \n            \n              }", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467357472", "createdAt": "2020-08-08T03:53:55Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdkClientTracer.java", "diffHunk": "@@ -115,7 +119,43 @@ protected String responseHeader(SdkHttpResponse sdkHttpResponse, String name) {\n     return header(sdkHttpResponse, name);\n   }\n \n+  @Override\n+  protected Setter<SdkHttpRequest> getSetter() {\n+    return null;\n+  }\n+\n   private static String header(SdkHttpHeaders headers, String name) {\n     return headers.firstMatchingHeader(name).orElse(null);\n   }\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.aws-sdk-2.2\";\n+  }\n+\n+  @Override\n+  protected Span onRequest(Span span, SdkHttpRequest sdkHttpRequest) {\n+    return super.onRequest(span, sdkHttpRequest);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e75d9179acb7ec62ccb3ff1f3da2e77c27ac07ce"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3OTE1NQ==", "bodyText": "Yeah, onRequest is now called inside afterMarshalling in the same class.  this is no longer needed.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468179155", "createdAt": "2020-08-10T20:52:41Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdkClientTracer.java", "diffHunk": "@@ -115,7 +119,43 @@ protected String responseHeader(SdkHttpResponse sdkHttpResponse, String name) {\n     return header(sdkHttpResponse, name);\n   }\n \n+  @Override\n+  protected Setter<SdkHttpRequest> getSetter() {\n+    return null;\n+  }\n+\n   private static String header(SdkHttpHeaders headers, String name) {\n     return headers.firstMatchingHeader(name).orElse(null);\n   }\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.aws-sdk-2.2\";\n+  }\n+\n+  @Override\n+  protected Span onRequest(Span span, SdkHttpRequest sdkHttpRequest) {\n+    return super.onRequest(span, sdkHttpRequest);\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1NzQ3Mg=="}, "originalCommit": {"oid": "e75d9179acb7ec62ccb3ff1f3da2e77c27ac07ce"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxOTM2MDAwOnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdkClientTracer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMzo1ODoxNVrOG9tQkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMTozMjoxOFrOG-ztvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1Nzg0MQ==", "bodyText": "i think better to handle executionAttributes.get/putAttribute(SPAN_ATTRIBUTE) consistently in one place, so either all of them in this class or all of them in TracingExecutionInterceptor. then also i think you can make SPAN_ATTRIBUTE private (in whichever class you choose to handle this in)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r467357841", "createdAt": "2020-08-08T03:58:15Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdkClientTracer.java", "diffHunk": "@@ -115,7 +119,43 @@ protected String responseHeader(SdkHttpResponse sdkHttpResponse, String name) {\n     return header(sdkHttpResponse, name);\n   }\n \n+  @Override\n+  protected Setter<SdkHttpRequest> getSetter() {\n+    return null;\n+  }\n+\n   private static String header(SdkHttpHeaders headers, String name) {\n     return headers.firstMatchingHeader(name).orElse(null);\n   }\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.aws-sdk-2.2\";\n+  }\n+\n+  @Override\n+  protected Span onRequest(Span span, SdkHttpRequest sdkHttpRequest) {\n+    return super.onRequest(span, sdkHttpRequest);\n+  }\n+\n+  public void afterMarshalling(\n+      final Context.AfterMarshalling context, final ExecutionAttributes executionAttributes) {\n+    Span span = executionAttributes.getAttribute(SPAN_ATTRIBUTE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e75d9179acb7ec62ccb3ff1f3da2e77c27ac07ce"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3MzgzMA==", "bodyText": "it's not clear to me.  let's sync up on this offline.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468173830", "createdAt": "2020-08-10T20:41:54Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdkClientTracer.java", "diffHunk": "@@ -115,7 +119,43 @@ protected String responseHeader(SdkHttpResponse sdkHttpResponse, String name) {\n     return header(sdkHttpResponse, name);\n   }\n \n+  @Override\n+  protected Setter<SdkHttpRequest> getSetter() {\n+    return null;\n+  }\n+\n   private static String header(SdkHttpHeaders headers, String name) {\n     return headers.firstMatchingHeader(name).orElse(null);\n   }\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.aws-sdk-2.2\";\n+  }\n+\n+  @Override\n+  protected Span onRequest(Span span, SdkHttpRequest sdkHttpRequest) {\n+    return super.onRequest(span, sdkHttpRequest);\n+  }\n+\n+  public void afterMarshalling(\n+      final Context.AfterMarshalling context, final ExecutionAttributes executionAttributes) {\n+    Span span = executionAttributes.getAttribute(SPAN_ATTRIBUTE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1Nzg0MQ=="}, "originalCommit": {"oid": "e75d9179acb7ec62ccb3ff1f3da2e77c27ac07ce"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUxMjE4OQ==", "bodyText": "I sort of agree it's a bit weird to copy interceptor lifecycle methods into the tracer - I don't think we have to delegate everything into tracer, keeping the latter closer to the normal lifecycle methods of tracer is easier to reason about.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468512189", "createdAt": "2020-08-11T11:32:18Z", "author": {"login": "anuraaga"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdkClientTracer.java", "diffHunk": "@@ -115,7 +119,43 @@ protected String responseHeader(SdkHttpResponse sdkHttpResponse, String name) {\n     return header(sdkHttpResponse, name);\n   }\n \n+  @Override\n+  protected Setter<SdkHttpRequest> getSetter() {\n+    return null;\n+  }\n+\n   private static String header(SdkHttpHeaders headers, String name) {\n     return headers.firstMatchingHeader(name).orElse(null);\n   }\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.aws-sdk-2.2\";\n+  }\n+\n+  @Override\n+  protected Span onRequest(Span span, SdkHttpRequest sdkHttpRequest) {\n+    return super.onRequest(span, sdkHttpRequest);\n+  }\n+\n+  public void afterMarshalling(\n+      final Context.AfterMarshalling context, final ExecutionAttributes executionAttributes) {\n+    Span span = executionAttributes.getAttribute(SPAN_ATTRIBUTE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM1Nzg0MQ=="}, "originalCommit": {"oid": "e75d9179acb7ec62ccb3ff1f3da2e77c27ac07ce"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNTU3NTU3OnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMDowMToxM1rOG-jvgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMDozMTozMVrOG-kQ5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MDQ5OQ==", "bodyText": "I think reads a little nicer\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      Span span = scope.getSpan();\n          \n          \n            \n                      ERROR_TRACER.endExceptionally(span, throwable);\n          \n          \n            \n                      ERROR_TRACER.endExceptionally(scope.getSpan(), throwable);", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468250499", "createdAt": "2020-08-11T00:01:13Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "diffHunk": "@@ -74,14 +74,12 @@ public static void methodExit(\n         @Advice.Argument(value = 0, optional = true) final Request<?> request,\n         @Advice.Thrown final Throwable throwable) {\n       if (throwable != null) {\n-        SpanWithScope spanWithScope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n-        if (spanWithScope != null) {\n+        SpanWithScope scope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n+        if (scope != null) {\n           request.addHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY, null);\n-          Span span = spanWithScope.getSpan();\n-          DECORATE.onError(span, throwable);\n-          DECORATE.beforeFinish(span);\n-          span.end();\n-          spanWithScope.closeScope();\n+          Span span = scope.getSpan();\n+          ERROR_TRACER.endExceptionally(span, throwable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1OTA0NQ==", "bodyText": "Fixed in #922.  There is no longer ERROR_TRACER.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468259045", "createdAt": "2020-08-11T00:31:31Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "diffHunk": "@@ -74,14 +74,12 @@ public static void methodExit(\n         @Advice.Argument(value = 0, optional = true) final Request<?> request,\n         @Advice.Thrown final Throwable throwable) {\n       if (throwable != null) {\n-        SpanWithScope spanWithScope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n-        if (spanWithScope != null) {\n+        SpanWithScope scope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n+        if (scope != null) {\n           request.addHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY, null);\n-          Span span = spanWithScope.getSpan();\n-          DECORATE.onError(span, throwable);\n-          DECORATE.beforeFinish(span);\n-          span.end();\n-          spanWithScope.closeScope();\n+          Span span = scope.getSpan();\n+          ERROR_TRACER.endExceptionally(span, throwable);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MDQ5OQ=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNTU3NjYzOnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMDowMTo0N1rOG-jwHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMDozMTowMVrOG-kQWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MDY1Mw==", "bodyText": "same\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Span span = scope.getSpan();\n          \n          \n            \n                        ERROR_TRACER.endExceptionally(span, throwable);\n          \n          \n            \n                        ERROR_TRACER.endExceptionally(scope.getSpan(), throwable);", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468250653", "createdAt": "2020-08-11T00:01:47Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "diffHunk": "@@ -112,14 +110,12 @@ public static void methodExit(\n           @Advice.FieldValue(\"request\") final Request<?> request,\n           @Advice.Thrown final Throwable throwable) {\n         if (throwable != null) {\n-          SpanWithScope spanWithScope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n-          if (spanWithScope != null) {\n+          SpanWithScope scope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n+          if (scope != null) {\n             request.addHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY, null);\n-            Span span = spanWithScope.getSpan();\n-            DECORATE.onError(span, throwable);\n-            DECORATE.beforeFinish(span);\n-            span.end();\n-            spanWithScope.closeScope();\n+            Span span = scope.getSpan();\n+            ERROR_TRACER.endExceptionally(span, throwable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1ODkwNw==", "bodyText": "Fixed it in branch 3.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468258907", "createdAt": "2020-08-11T00:31:01Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AWSHttpClientInstrumentation.java", "diffHunk": "@@ -112,14 +110,12 @@ public static void methodExit(\n           @Advice.FieldValue(\"request\") final Request<?> request,\n           @Advice.Thrown final Throwable throwable) {\n         if (throwable != null) {\n-          SpanWithScope spanWithScope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n-          if (spanWithScope != null) {\n+          SpanWithScope scope = request.getHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY);\n+          if (scope != null) {\n             request.addHandlerContext(SPAN_SCOPE_PAIR_CONTEXT_KEY, null);\n-            Span span = spanWithScope.getSpan();\n-            DECORATE.onError(span, throwable);\n-            DECORATE.beforeFinish(span);\n-            span.end();\n-            spanWithScope.closeScope();\n+            Span span = scope.getSpan();\n+            ERROR_TRACER.endExceptionally(span, throwable);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MDY1Mw=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNjM2ODY1OnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AwsSdkClientTracer.java", "isResolved": true, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzowMjozMlrOG-q6QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxOTo1Mzo1NlrOG_G-EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2NzkzNg==", "bodyText": "Why is this null?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468367936", "createdAt": "2020-08-11T07:02:32Z", "author": {"login": "iNikem"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AwsSdkClientTracer.java", "diffHunk": "@@ -125,4 +125,14 @@ protected String requestHeader(Request<?> request, String name) {\n   protected String responseHeader(Response<?> response, String name) {\n     return response.getHttpResponse().getHeaders().get(name);\n   }\n+\n+  @Override\n+  protected Setter<Request<?>> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc0OTk1Mw==", "bodyText": "There is no SETTER.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468749953", "createdAt": "2020-08-11T17:35:14Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AwsSdkClientTracer.java", "diffHunk": "@@ -125,4 +125,14 @@ protected String requestHeader(Request<?> request, String name) {\n   protected String responseHeader(Response<?> response, String name) {\n     return response.getHttpResponse().getHeaders().get(name);\n   }\n+\n+  @Override\n+  protected Setter<Request<?>> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2NzkzNg=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2NDc0OA==", "bodyText": "#893 (comment)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468764748", "createdAt": "2020-08-11T18:00:29Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AwsSdkClientTracer.java", "diffHunk": "@@ -125,4 +125,14 @@ protected String requestHeader(Request<?> request, String name) {\n   protected String responseHeader(Response<?> response, String name) {\n     return response.getHttpResponse().getHeaders().get(name);\n   }\n+\n+  @Override\n+  protected Setter<Request<?>> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2NzkzNg=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgwMDk2NA==", "bodyText": "I don't understand. Do you want to say that one cannot inject new headers into aws sdk Request? And we cannot propagate context with it?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468800964", "createdAt": "2020-08-11T19:02:10Z", "author": {"login": "iNikem"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AwsSdkClientTracer.java", "diffHunk": "@@ -125,4 +125,14 @@ protected String requestHeader(Request<?> request, String name) {\n   protected String responseHeader(Response<?> response, String name) {\n     return response.getHttpResponse().getHeaders().get(name);\n   }\n+\n+  @Override\n+  protected Setter<Request<?>> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2NzkzNg=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgwMzgxNA==", "bodyText": "aws sdk doesn't need to inject headers into its request.  @trask might know the reason why?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468803814", "createdAt": "2020-08-11T19:07:30Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AwsSdkClientTracer.java", "diffHunk": "@@ -125,4 +125,14 @@ protected String requestHeader(Request<?> request, String name) {\n   protected String responseHeader(Response<?> response, String name) {\n     return response.getHttpResponse().getHeaders().get(name);\n   }\n+\n+  @Override\n+  protected Setter<Request<?>> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2NzkzNg=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgwNTMyMw==", "bodyText": "my understanding is that no need to inject headers, since requests are all going to backend AWS services", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468805323", "createdAt": "2020-08-11T19:10:33Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AwsSdkClientTracer.java", "diffHunk": "@@ -125,4 +125,14 @@ protected String requestHeader(Request<?> request, String name) {\n   protected String responseHeader(Response<?> response, String name) {\n     return response.getHttpResponse().getHeaders().get(name);\n   }\n+\n+  @Override\n+  protected Setter<Request<?>> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2NzkzNg=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxNTg4NA==", "bodyText": "Then should it be HttpClientTracer? It has startScope method which will throw an exception if it gets null setter. So everybody has to remember not to call startScope for AwsSdkClientTracer which extends HttpClientTracer", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468815884", "createdAt": "2020-08-11T19:30:30Z", "author": {"login": "iNikem"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AwsSdkClientTracer.java", "diffHunk": "@@ -125,4 +125,14 @@ protected String requestHeader(Request<?> request, String name) {\n   protected String responseHeader(Response<?> response, String name) {\n     return response.getHttpResponse().getHeaders().get(name);\n   }\n+\n+  @Override\n+  protected Setter<Request<?>> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2NzkzNg=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgyNTU4NA==", "bodyText": "yeah, there's lots of stuff in aws-sdk instrumentation that doesn't follow the normal Tracer pattern so this may make sense.\nI'll open a separate issue for this, so we can move this PR forward.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468825584", "createdAt": "2020-08-11T19:49:54Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AwsSdkClientTracer.java", "diffHunk": "@@ -125,4 +125,14 @@ protected String requestHeader(Request<?> request, String name) {\n   protected String responseHeader(Response<?> response, String name) {\n     return response.getHttpResponse().getHeaders().get(name);\n   }\n+\n+  @Override\n+  protected Setter<Request<?>> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2NzkzNg=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgyNzY2NQ==", "bodyText": "Opened #944", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468827665", "createdAt": "2020-08-11T19:53:56Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/AwsSdkClientTracer.java", "diffHunk": "@@ -125,4 +125,14 @@ protected String requestHeader(Request<?> request, String name) {\n   protected String responseHeader(Response<?> response, String name) {\n     return response.getHttpResponse().getHeaders().get(name);\n   }\n+\n+  @Override\n+  protected Setter<Request<?>> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2NzkzNg=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNjM3NTA0OnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/TracingRequestHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzowNDo0M1rOG-q95Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNzozNTozM1rOG_CPOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2ODg2OQ==", "bodyText": "I think this logic should be in tracer.startScope", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468368869", "createdAt": "2020-08-11T07:04:43Z", "author": {"login": "iNikem"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/TracingRequestHandler.java", "diffHunk": "@@ -49,38 +45,29 @@ public AmazonWebServiceRequest beforeMarshalling(final AmazonWebServiceRequest r\n \n   @Override\n   public void beforeRequest(final Request<?> request) {\n-    Span span = decorate.getOrCreateSpan(request, TRACER);\n-    decorate.afterStart(span);\n-    decorate.onRequest(span, request);\n+    Span span = tracer.startSpan(request);\n     request.addHandlerContext(\n         SPAN_SCOPE_PAIR_CONTEXT_KEY,\n-        new SpanWithScope(\n-            span, ContextUtils.withScopedContext(ClientDecorator.currentContextWith(span))));\n+        new SpanWithScope(span, withScopedContext(currentContextWith(span))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc1MDEzNw==", "bodyText": "This has been refactored in #922.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468750137", "createdAt": "2020-08-11T17:35:33Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-1.11/src/main/java/io/opentelemetry/auto/instrumentation/awssdk/v1_11/TracingRequestHandler.java", "diffHunk": "@@ -49,38 +45,29 @@ public AmazonWebServiceRequest beforeMarshalling(final AmazonWebServiceRequest r\n \n   @Override\n   public void beforeRequest(final Request<?> request) {\n-    Span span = decorate.getOrCreateSpan(request, TRACER);\n-    decorate.afterStart(span);\n-    decorate.onRequest(span, request);\n+    Span span = tracer.startSpan(request);\n     request.addHandlerContext(\n         SPAN_SCOPE_PAIR_CONTEXT_KEY,\n-        new SpanWithScope(\n-            span, ContextUtils.withScopedContext(ClientDecorator.currentContextWith(span))));\n+        new SpanWithScope(span, withScopedContext(currentContextWith(span))));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2ODg2OQ=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNjM3OTMyOnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdkClientTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzowNjowMFrOG-rAYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNzozNjo0NFrOG_CRgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2OTUwNg==", "bodyText": "Why is this null?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468369506", "createdAt": "2020-08-11T07:06:00Z", "author": {"login": "iNikem"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdkClientTracer.java", "diffHunk": "@@ -115,7 +123,55 @@ protected String responseHeader(SdkHttpResponse sdkHttpResponse, String name) {\n     return header(sdkHttpResponse, name);\n   }\n \n+  @Override\n+  protected Setter<SdkHttpRequest> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc1MDcyMg==", "bodyText": "no SETTER.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468750722", "createdAt": "2020-08-11T17:36:44Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/AwsSdkClientTracer.java", "diffHunk": "@@ -115,7 +123,55 @@ protected String responseHeader(SdkHttpResponse sdkHttpResponse, String name) {\n     return header(sdkHttpResponse, name);\n   }\n \n+  @Override\n+  protected Setter<SdkHttpRequest> getSetter() {\n+    return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2OTUwNg=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNjM4OTI3OnYy", "diffSide": "RIGHT", "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "isResolved": true, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzowOToyMFrOG-rGIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMzo1NzozNVrOG_2z4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDk3Nw==", "bodyText": "Do you really need to call spanName separately? Why getOrCreateSpan cannot handle this?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468370977", "createdAt": "2020-08-11T07:09:20Z", "author": {"login": "iNikem"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -41,54 +40,29 @@\n   @Override\n   public void beforeExecution(\n       final Context.BeforeExecution context, final ExecutionAttributes executionAttributes) {\n-    Span span =\n-        ClientDecorator.getOrCreateSpan(DECORATE.spanName(executionAttributes), AwsSdk.tracer());\n-    DECORATE.afterStart(span);\n+    Span span = TRACER.getOrCreateSpan(TRACER.spanName(executionAttributes), AwsSdk.tracer());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2NzEzNQ==", "bodyText": "We don't have the request.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468767135", "createdAt": "2020-08-11T18:04:52Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -41,54 +40,29 @@\n   @Override\n   public void beforeExecution(\n       final Context.BeforeExecution context, final ExecutionAttributes executionAttributes) {\n-    Span span =\n-        ClientDecorator.getOrCreateSpan(DECORATE.spanName(executionAttributes), AwsSdk.tracer());\n-    DECORATE.afterStart(span);\n+    Span span = TRACER.getOrCreateSpan(TRACER.spanName(executionAttributes), AwsSdk.tracer());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDk3Nw=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgwMTg4NA==", "bodyText": "What do you mean? You can pass executionAttributes into TRACER.getOrCreateSpan, no? Tracer's startSpan method (or its analogue) can accept all data that is needed for him to create a new span. In this case tracer needs ExecutionAttributes to deduce span name.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468801884", "createdAt": "2020-08-11T19:04:02Z", "author": {"login": "iNikem"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -41,54 +40,29 @@\n   @Override\n   public void beforeExecution(\n       final Context.BeforeExecution context, final ExecutionAttributes executionAttributes) {\n-    Span span =\n-        ClientDecorator.getOrCreateSpan(DECORATE.spanName(executionAttributes), AwsSdk.tracer());\n-    DECORATE.afterStart(span);\n+    Span span = TRACER.getOrCreateSpan(TRACER.spanName(executionAttributes), AwsSdk.tracer());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDk3Nw=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgwNTY4Mg==", "bodyText": "getOrCreateSpan takes Tracer as one of the input parameters.\npublic Span getOrCreateSpan(String name, Tracer tracer) \nCan't use startSpan because getting the span is needed in beforeExecution and onRequest is called inside afterMarshalling.  ExecutionInterceptor has its own lifecycle.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468805682", "createdAt": "2020-08-11T19:11:16Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -41,54 +40,29 @@\n   @Override\n   public void beforeExecution(\n       final Context.BeforeExecution context, final ExecutionAttributes executionAttributes) {\n-    Span span =\n-        ClientDecorator.getOrCreateSpan(DECORATE.spanName(executionAttributes), AwsSdk.tracer());\n-    DECORATE.afterStart(span);\n+    Span span = TRACER.getOrCreateSpan(TRACER.spanName(executionAttributes), AwsSdk.tracer());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDk3Nw=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgwNzM0Ng==", "bodyText": "@iNikem are you suggesting adding startSpan overload in AwsSdkClientTracer that also accepts executionAttributes?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468807346", "createdAt": "2020-08-11T19:14:13Z", "author": {"login": "trask"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -41,54 +40,29 @@\n   @Override\n   public void beforeExecution(\n       final Context.BeforeExecution context, final ExecutionAttributes executionAttributes) {\n-    Span span =\n-        ClientDecorator.getOrCreateSpan(DECORATE.spanName(executionAttributes), AwsSdk.tracer());\n-    DECORATE.afterStart(span);\n+    Span span = TRACER.getOrCreateSpan(TRACER.spanName(executionAttributes), AwsSdk.tracer());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDk3Nw=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgyMjU3MQ==", "bodyText": "This getOrCreateSpan is already defined in AwsSdkClientTracer and used only from here. Just pass executionAttributes as first parameter and that's it, API surface is already smaller.\nAlso, AwsSdk.tracer() should not go here, it should go into the constructor of the tracer. There is io.opentelemetry.instrumentation.api.decorator.BaseTracer#tracer for that.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468822571", "createdAt": "2020-08-11T19:43:52Z", "author": {"login": "iNikem"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -41,54 +40,29 @@\n   @Override\n   public void beforeExecution(\n       final Context.BeforeExecution context, final ExecutionAttributes executionAttributes) {\n-    Span span =\n-        ClientDecorator.getOrCreateSpan(DECORATE.spanName(executionAttributes), AwsSdk.tracer());\n-    DECORATE.afterStart(span);\n+    Span span = TRACER.getOrCreateSpan(TRACER.spanName(executionAttributes), AwsSdk.tracer());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDk3Nw=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgzNzg5OQ==", "bodyText": "moved spanName helper method to interceptor class.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r468837899", "createdAt": "2020-08-11T20:14:28Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -41,54 +40,29 @@\n   @Override\n   public void beforeExecution(\n       final Context.BeforeExecution context, final ExecutionAttributes executionAttributes) {\n-    Span span =\n-        ClientDecorator.getOrCreateSpan(DECORATE.spanName(executionAttributes), AwsSdk.tracer());\n-    DECORATE.afterStart(span);\n+    Span span = TRACER.getOrCreateSpan(TRACER.spanName(executionAttributes), AwsSdk.tracer());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDk3Nw=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwMzMzNQ==", "bodyText": "I beg your pardon? My intention was to move as much code as possible from this interceptor into the tracer. You did the exact opposite??", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r469003335", "createdAt": "2020-08-12T04:50:25Z", "author": {"login": "iNikem"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -41,54 +40,29 @@\n   @Override\n   public void beforeExecution(\n       final Context.BeforeExecution context, final ExecutionAttributes executionAttributes) {\n-    Span span =\n-        ClientDecorator.getOrCreateSpan(DECORATE.spanName(executionAttributes), AwsSdk.tracer());\n-    DECORATE.afterStart(span);\n+    Span span = TRACER.getOrCreateSpan(TRACER.spanName(executionAttributes), AwsSdk.tracer());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDk3Nw=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwMzg0NQ==", "bodyText": "I think this is related to my comment here\n#918 (comment)\nI found it hard to understand the tracer when it had so much of the AWS SDK lifecycle copied into it.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r469003845", "createdAt": "2020-08-12T04:52:33Z", "author": {"login": "anuraaga"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -41,54 +40,29 @@\n   @Override\n   public void beforeExecution(\n       final Context.BeforeExecution context, final ExecutionAttributes executionAttributes) {\n-    Span span =\n-        ClientDecorator.getOrCreateSpan(DECORATE.spanName(executionAttributes), AwsSdk.tracer());\n-    DECORATE.afterStart(span);\n+    Span span = TRACER.getOrCreateSpan(TRACER.spanName(executionAttributes), AwsSdk.tracer());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDk3Nw=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMTQ5MA==", "bodyText": "this spanName method is customizing the span name.  It is only used in the interceptor and nowhere else.\nI also moved a few other helper methods related to AWS SDK lifecycle to the interceptor class.\n@trask has created an issue to clean up AwsSdkClientTracer.  I think we all agreed that AWS SDK doesn't fit well with the HttpClientTracer pattern.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/918#discussion_r469611490", "createdAt": "2020-08-12T23:57:35Z", "author": {"login": "heyams"}, "path": "instrumentation/aws-sdk/aws-sdk-2.2/library/src/main/java/io/opentelemetry/instrumentation/awssdk/v2_2/TracingExecutionInterceptor.java", "diffHunk": "@@ -41,54 +40,29 @@\n   @Override\n   public void beforeExecution(\n       final Context.BeforeExecution context, final ExecutionAttributes executionAttributes) {\n-    Span span =\n-        ClientDecorator.getOrCreateSpan(DECORATE.spanName(executionAttributes), AwsSdk.tracer());\n-    DECORATE.afterStart(span);\n+    Span span = TRACER.getOrCreateSpan(TRACER.spanName(executionAttributes), AwsSdk.tracer());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDk3Nw=="}, "originalCommit": {"oid": "327757e48651a8f15fe53064a3f61b9a222d95fa"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4990, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}