{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3NDc0OTc0", "number": 553, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODowMzo0NlrOEHV_Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMzoyNDo1N1rOEHwrtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM1NzAyOnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODowMzo0NlrOGmqY-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjo0MTowNFrOGnTVOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5MzU5Mw==", "bodyText": "I think it is better idea to put such common properties into project source code: https://docs.gradle.org/current/userguide/build_environment.html#sec:gradle_configuration_properties", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443193593", "createdAt": "2020-06-21T08:03:46Z", "author": {"login": "iNikem"}, "path": ".circleci/config.yml", "diffHunk": "@@ -13,7 +13,11 @@ cache_keys: &cache_keys\n     # Rev the version when the cache gets too big\n     - trace-java-v1-{{ .Branch }}-{{ .Revision }}\n     - trace-java-v1-{{ .Branch }}\n-    # - dd-trace-java-v1-\n+\n+parameters:\n+  gradle_flags:\n+    type: string\n+    default: \"--build-cache --parallel --stacktrace --no-daemon\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg2NDM3Ng==", "bodyText": "see https://github.com/DataDog/dd-trace-java/pull/1607/files, coming in v0.56.0 merge \ud83d\ude04", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443864376", "createdAt": "2020-06-22T22:41:04Z", "author": {"login": "trask"}, "path": ".circleci/config.yml", "diffHunk": "@@ -13,7 +13,11 @@ cache_keys: &cache_keys\n     # Rev the version when the cache gets too big\n     - trace-java-v1-{{ .Branch }}-{{ .Revision }}\n     - trace-java-v1-{{ .Branch }}\n-    # - dd-trace-java-v1-\n+\n+parameters:\n+  gradle_flags:\n+    type: string\n+    default: \"--build-cache --parallel --stacktrace --no-daemon\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5MzU5Mw=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM1ODcyOnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODowNjoyOVrOGmqZ0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjo0MTozNlrOGnTV5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5MzgxMA==", "bodyText": "our default java is 11, so running test will use java11, not 8", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443193810", "createdAt": "2020-06-21T08:06:29Z", "author": {"login": "iNikem"}, "path": ".circleci/config.yml", "diffHunk": "@@ -239,40 +209,39 @@ jobs:\n \n \n workflows:\n-  version: 2\n   build_test_deploy:\n     jobs:\n       - build:\n           filters:\n             tags:\n               only: /.*/\n-      - test_7:\n-          requires:\n-            - build\n-          filters:\n-            tags:\n-              only: /.*/\n-      - test_8:\n-          requires:\n-            - build\n-          filters:\n-            tags:\n-              only: /.*/\n-      - test_latest:\n+\n+      - default_test_job:\n           requires:\n             - build\n+          prefixTestTask: true\n+          name: test_<< matrix.testTask >>\n+          matrix:\n+            parameters:\n+              testTask: [\"7\", \"11\", \"14\"]\n           filters:\n             tags:\n               only: /.*/\n-      - test_11:\n+\n+      - default_test_job:\n           requires:\n             - build\n+          name: test_8\n+          testTask: test jacocoTestReport jacocoTestCoverageVerification", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 199}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg2NDU0OA==", "bodyText": "fixed", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443864548", "createdAt": "2020-06-22T22:41:36Z", "author": {"login": "trask"}, "path": ".circleci/config.yml", "diffHunk": "@@ -239,40 +209,39 @@ jobs:\n \n \n workflows:\n-  version: 2\n   build_test_deploy:\n     jobs:\n       - build:\n           filters:\n             tags:\n               only: /.*/\n-      - test_7:\n-          requires:\n-            - build\n-          filters:\n-            tags:\n-              only: /.*/\n-      - test_8:\n-          requires:\n-            - build\n-          filters:\n-            tags:\n-              only: /.*/\n-      - test_latest:\n+\n+      - default_test_job:\n           requires:\n             - build\n+          prefixTestTask: true\n+          name: test_<< matrix.testTask >>\n+          matrix:\n+            parameters:\n+              testTask: [\"7\", \"11\", \"14\"]\n           filters:\n             tags:\n               only: /.*/\n-      - test_11:\n+\n+      - default_test_job:\n           requires:\n             - build\n+          name: test_8\n+          testTask: test jacocoTestReport jacocoTestCoverageVerification", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5MzgxMA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 199}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM2MDUwOnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODoxMDoxOVrOGmqa2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjo1NToyNFrOGnTmcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDA3Mg==", "bodyText": "Field shadowing is a bad thing", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443194072", "createdAt": "2020-06-21T08:10:19Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java", "diffHunk": "@@ -88,25 +97,71 @@ public static void addThrowable(final Span span, final Throwable throwable) {\n    * reference. Anonymous classes are named based on their parent.\n    */\n   public String spanNameForMethod(final Method method) {\n-    return spanNameForClass(method.getDeclaringClass()) + \".\" + method.getName();\n+    return spanNameForMethod(method.getDeclaringClass(), method);\n+  }\n+\n+  /**\n+   * This method is used to generate an acceptable span (operation) name based on a given method\n+   * reference. Anonymous classes are named based on their parent.\n+   *\n+   * @param method the method to get the name from, nullable\n+   * @return the span name from the class and method\n+   */\n+  public String spanNameForMethod(final Class<?> clazz, final Method method) {\n+    return spanNameForMethod(clazz, null == method ? null : method.getName());\n+  }\n+\n+  /**\n+   * This method is used to generate an acceptable span (operation) name based on a given method\n+   * reference. Anonymous classes are named based on their parent.\n+   *\n+   * @param methodName the name of the method to get the name from, nullable\n+   * @return the span name from the class and method\n+   */\n+  public String spanNameForMethod(final Class<?> clazz, final String methodName) {\n+    ClassName cn = CLASS_NAMES.get(clazz);\n+    return null == methodName ? cn.getName() : cn.getMethodName(methodName);\n   }\n \n   /**\n    * This method is used to generate an acceptable span (operation) name based on a given class\n    * reference. Anonymous classes are named based on their parent.\n    */\n-  public String spanNameForClass(final Class clazz) {\n-    if (!clazz.isAnonymousClass()) {\n-      return clazz.getSimpleName();\n+  public String spanNameForClass(final Class<?> clazz) {\n+    String simpleName = clazz.getSimpleName();\n+    return simpleName.isEmpty() ? CLASS_NAMES.get(clazz).getName() : simpleName;\n+  }\n+\n+  private static class ClassName {\n+    private final String name;\n+    private final ConcurrentHashMap<String, String> methodNames = new ConcurrentHashMap<>(1);\n+\n+    private ClassName(String name) {\n+      this.name = name;\n     }\n-    String className = clazz.getName();\n-    if (clazz.getPackage() != null) {\n-      final String pkgName = clazz.getPackage().getName();\n-      if (!pkgName.isEmpty()) {\n-        className = clazz.getName().replace(pkgName, \"\").substring(1);\n+\n+    public String getName() {\n+      return name;\n+    }\n+\n+    public String getMethodName(String name) {\n+      String methodName = methodNames.get(name);\n+      if (null == methodName) {\n+        methodName = this.name + \".\" + name;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg2ODc4NQ==", "bodyText": "fixed", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443868785", "createdAt": "2020-06-22T22:55:24Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java", "diffHunk": "@@ -88,25 +97,71 @@ public static void addThrowable(final Span span, final Throwable throwable) {\n    * reference. Anonymous classes are named based on their parent.\n    */\n   public String spanNameForMethod(final Method method) {\n-    return spanNameForClass(method.getDeclaringClass()) + \".\" + method.getName();\n+    return spanNameForMethod(method.getDeclaringClass(), method);\n+  }\n+\n+  /**\n+   * This method is used to generate an acceptable span (operation) name based on a given method\n+   * reference. Anonymous classes are named based on their parent.\n+   *\n+   * @param method the method to get the name from, nullable\n+   * @return the span name from the class and method\n+   */\n+  public String spanNameForMethod(final Class<?> clazz, final Method method) {\n+    return spanNameForMethod(clazz, null == method ? null : method.getName());\n+  }\n+\n+  /**\n+   * This method is used to generate an acceptable span (operation) name based on a given method\n+   * reference. Anonymous classes are named based on their parent.\n+   *\n+   * @param methodName the name of the method to get the name from, nullable\n+   * @return the span name from the class and method\n+   */\n+  public String spanNameForMethod(final Class<?> clazz, final String methodName) {\n+    ClassName cn = CLASS_NAMES.get(clazz);\n+    return null == methodName ? cn.getName() : cn.getMethodName(methodName);\n   }\n \n   /**\n    * This method is used to generate an acceptable span (operation) name based on a given class\n    * reference. Anonymous classes are named based on their parent.\n    */\n-  public String spanNameForClass(final Class clazz) {\n-    if (!clazz.isAnonymousClass()) {\n-      return clazz.getSimpleName();\n+  public String spanNameForClass(final Class<?> clazz) {\n+    String simpleName = clazz.getSimpleName();\n+    return simpleName.isEmpty() ? CLASS_NAMES.get(clazz).getName() : simpleName;\n+  }\n+\n+  private static class ClassName {\n+    private final String name;\n+    private final ConcurrentHashMap<String, String> methodNames = new ConcurrentHashMap<>(1);\n+\n+    private ClassName(String name) {\n+      this.name = name;\n     }\n-    String className = clazz.getName();\n-    if (clazz.getPackage() != null) {\n-      final String pkgName = clazz.getPackage().getName();\n-      if (!pkgName.isEmpty()) {\n-        className = clazz.getName().replace(pkgName, \"\").substring(1);\n+\n+    public String getName() {\n+      return name;\n+    }\n+\n+    public String getMethodName(String name) {\n+      String methodName = methodNames.get(name);\n+      if (null == methodName) {\n+        methodName = this.name + \".\" + name;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDA3Mg=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM2MTEwOnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODoxMToyMVrOGmqbHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjo1NTowNFrOGnTmAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDE0Mw==", "bodyText": "So much changes in this class, new methods, but no changed/new tests?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443194143", "createdAt": "2020-06-21T08:11:21Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java", "diffHunk": "@@ -29,10 +29,19 @@\n import java.lang.reflect.Method;\n import java.net.InetAddress;\n import java.net.InetSocketAddress;\n+import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.ExecutionException;\n \n public abstract class BaseDecorator {\n \n+  private static final ClassValue<ClassName> CLASS_NAMES =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg2ODY3Mw==", "bodyText": "BaseDecorator is heavily tested by instrumentation tests", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443868673", "createdAt": "2020-06-22T22:55:04Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java", "diffHunk": "@@ -29,10 +29,19 @@\n import java.lang.reflect.Method;\n import java.net.InetAddress;\n import java.net.InetSocketAddress;\n+import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.ExecutionException;\n \n public abstract class BaseDecorator {\n \n+  private static final ClassValue<ClassName> CLASS_NAMES =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDE0Mw=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM2MjU4OnYy", "diffSide": "RIGHT", "path": "agent-tooling/src/main/java/io/opentelemetry/auto/tooling/bytebuddy/matcher/SafeHasSuperTypeMatcher.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODoxNDoxNFrOGmqb5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjo1NTozNVrOGnTmsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDM0MQ==", "bodyText": "throw UnsupportedOperationException?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443194341", "createdAt": "2020-06-21T08:14:14Z", "author": {"login": "iNikem"}, "path": "agent-tooling/src/main/java/io/opentelemetry/auto/tooling/bytebuddy/matcher/SafeHasSuperTypeMatcher.java", "diffHunk": "@@ -167,4 +143,67 @@ public boolean equals(final Object other) {\n   public int hashCode() {\n     return 17 * 31 + matcher.hashCode();\n   }\n+\n+  /**\n+   * TypeDefinition#getInterfaces() produces an iterator which may throw an exception during\n+   * iteration if an interface is absent from the classpath.\n+   *\n+   * <p>The caller MUST call hasNext() before calling next().\n+   *\n+   * <p>This wrapper exists to allow getting interfaces even if the lookup on one fails.\n+   */\n+  private static class SafeInterfaceIterator\n+      implements Iterator<TypeDefinition>, Iterable<TypeDefinition> {\n+    private final TypeDefinition typeDefinition;\n+    private final Iterator<TypeDescription.Generic> it;\n+    private TypeDefinition next;\n+\n+    private SafeInterfaceIterator(TypeDefinition typeDefinition) {\n+      this.typeDefinition = typeDefinition;\n+      Iterator<TypeDescription.Generic> it = null;\n+      try {\n+        it = typeDefinition.getInterfaces().iterator();\n+      } catch (Exception e) {\n+        logException(typeDefinition, e);\n+      }\n+      this.it = it;\n+    }\n+\n+    @Override\n+    public boolean hasNext() {\n+      if (null != it && it.hasNext()) {\n+        try {\n+          this.next = it.next();\n+          return true;\n+        } catch (Exception e) {\n+          logException(typeDefinition, e);\n+          return false;\n+        }\n+      }\n+      return false;\n+    }\n+\n+    @Override\n+    public TypeDefinition next() {\n+      return next;\n+    }\n+\n+    @Override\n+    public void remove() {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg2ODg1MA==", "bodyText": "done", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443868850", "createdAt": "2020-06-22T22:55:35Z", "author": {"login": "trask"}, "path": "agent-tooling/src/main/java/io/opentelemetry/auto/tooling/bytebuddy/matcher/SafeHasSuperTypeMatcher.java", "diffHunk": "@@ -167,4 +143,67 @@ public boolean equals(final Object other) {\n   public int hashCode() {\n     return 17 * 31 + matcher.hashCode();\n   }\n+\n+  /**\n+   * TypeDefinition#getInterfaces() produces an iterator which may throw an exception during\n+   * iteration if an interface is absent from the classpath.\n+   *\n+   * <p>The caller MUST call hasNext() before calling next().\n+   *\n+   * <p>This wrapper exists to allow getting interfaces even if the lookup on one fails.\n+   */\n+  private static class SafeInterfaceIterator\n+      implements Iterator<TypeDefinition>, Iterable<TypeDefinition> {\n+    private final TypeDefinition typeDefinition;\n+    private final Iterator<TypeDescription.Generic> it;\n+    private TypeDefinition next;\n+\n+    private SafeInterfaceIterator(TypeDefinition typeDefinition) {\n+      this.typeDefinition = typeDefinition;\n+      Iterator<TypeDescription.Generic> it = null;\n+      try {\n+        it = typeDefinition.getInterfaces().iterator();\n+      } catch (Exception e) {\n+        logException(typeDefinition, e);\n+      }\n+      this.it = it;\n+    }\n+\n+    @Override\n+    public boolean hasNext() {\n+      if (null != it && it.hasNext()) {\n+        try {\n+          this.next = it.next();\n+          return true;\n+        } catch (Exception e) {\n+          logException(typeDefinition, e);\n+          return false;\n+        }\n+      }\n+      return false;\n+    }\n+\n+    @Override\n+    public TypeDefinition next() {\n+      return next;\n+    }\n+\n+    @Override\n+    public void remove() {}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDM0MQ=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM2NTYxOnYy", "diffSide": "RIGHT", "path": "build.gradle", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODoxODoxM1rOGmqdaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjo0MjoxNFrOGnTWow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDcyOA==", "bodyText": "I think this need explanation", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443194728", "createdAt": "2020-06-21T08:18:13Z", "author": {"login": "iNikem"}, "path": "build.gradle", "diffHunk": "@@ -55,3 +55,14 @@ allprojects {\n     jvmArgs \"-XX:ErrorFile=/tmp/hs_err_pid%p.log\"\n   }\n }\n+\n+task writeMuzzleTasksToFile {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3MzUwOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            task writeMuzzleTasksToFile {\n          \n          \n            \n            // Writes tasks to file allowing us to leverage CircleCI's file based task parallelization\n          \n          \n            \n            task writeMuzzleTasksToFile {", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443573509", "createdAt": "2020-06-22T13:52:31Z", "author": {"login": "devinsba"}, "path": "build.gradle", "diffHunk": "@@ -55,3 +55,14 @@ allprojects {\n     jvmArgs \"-XX:ErrorFile=/tmp/hs_err_pid%p.log\"\n   }\n }\n+\n+task writeMuzzleTasksToFile {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDcyOA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg2NDczOQ==", "bodyText": "done", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443864739", "createdAt": "2020-06-22T22:42:14Z", "author": {"login": "trask"}, "path": "build.gradle", "diffHunk": "@@ -55,3 +55,14 @@ allprojects {\n     jvmArgs \"-XX:ErrorFile=/tmp/hs_err_pid%p.log\"\n   }\n }\n+\n+task writeMuzzleTasksToFile {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDcyOA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM2NTkwOnYy", "diffSide": "RIGHT", "path": "instrumentation/apache-httpasyncclient-4.0/src/main/java/io/opentelemetry/auto/instrumentation/apachehttpasyncclient/ApacheHttpClientRedirectInstrumentation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODoxODo1MVrOGmqdlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjo1NjoxOVrOGnTnnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDc3Mg==", "bodyText": "headers names are wrong", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443194772", "createdAt": "2020-06-21T08:18:51Z", "author": {"login": "iNikem"}, "path": "instrumentation/apache-httpasyncclient-4.0/src/main/java/io/opentelemetry/auto/instrumentation/apachehttpasyncclient/ApacheHttpClientRedirectInstrumentation.java", "diffHunk": "@@ -73,12 +73,23 @@ private static void onAfterExecute(\n       if (redirect == null) {\n         return;\n       }\n-\n-      for (final Header header : original.getAllHeaders()) {\n-        final String name = header.getName().toLowerCase();\n-        if (name.equals(\"traceparent\")) {\n-          if (!redirect.containsHeader(header.getName())) {\n-            redirect.setHeader(header.getName(), header.getValue());\n+      // Apache HttpClient 4.0.1+ copies headers from original to redirect only\n+      // if redirect headers are empty. Because we add headers\n+      // \"x-datadog-\" and \"x-b3-\" to redirect: it means redirect headers never", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg2OTA4NQ==", "bodyText": "fixed", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443869085", "createdAt": "2020-06-22T22:56:19Z", "author": {"login": "trask"}, "path": "instrumentation/apache-httpasyncclient-4.0/src/main/java/io/opentelemetry/auto/instrumentation/apachehttpasyncclient/ApacheHttpClientRedirectInstrumentation.java", "diffHunk": "@@ -73,12 +73,23 @@ private static void onAfterExecute(\n       if (redirect == null) {\n         return;\n       }\n-\n-      for (final Header header : original.getAllHeaders()) {\n-        final String name = header.getName().toLowerCase();\n-        if (name.equals(\"traceparent\")) {\n-          if (!redirect.containsHeader(header.getName())) {\n-            redirect.setHeader(header.getName(), header.getValue());\n+      // Apache HttpClient 4.0.1+ copies headers from original to redirect only\n+      // if redirect headers are empty. Because we add headers\n+      // \"x-datadog-\" and \"x-b3-\" to redirect: it means redirect headers never", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NDc3Mg=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM3MTkyOnYy", "diffSide": "RIGHT", "path": "instrumentation/java-concurrent/java-completablefuture/java-completablefuture.gradle", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODoyODo0MFrOGmqguQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwNjo1NTowMlrOGnbp1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTU3Nw==", "bodyText": "Maybe instead of creating a whole new module just for one test, put it with all others but guard with spock.lang.Requires check for current java version?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443195577", "createdAt": "2020-06-21T08:28:40Z", "author": {"login": "iNikem"}, "path": "instrumentation/java-concurrent/java-completablefuture/java-completablefuture.gradle", "diffHunk": "@@ -0,0 +1,6 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg2NjA4NA==", "bodyText": "i'm not sure how that would work? wouldn't these tests fail to compile if they are in a module that targets Java 7?\nmaybe another reason to abandon Java 7 for instrumentation tests?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443866084", "createdAt": "2020-06-22T22:46:39Z", "author": {"login": "trask"}, "path": "instrumentation/java-concurrent/java-completablefuture/java-completablefuture.gradle", "diffHunk": "@@ -0,0 +1,6 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTU3Nw=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk2Mzc2MQ==", "bodyText": "I am not sure. We compile everything with java11, test\u2019s bytecode will be 7 but it will use a class absent from java7 sdk. If Spock will run it only on 8+ everything should work.\nBut at least I think we have to document why this separate module exists. Then we will remember to merge it back when/if we abandon java7", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443963761", "createdAt": "2020-06-23T05:06:48Z", "author": {"login": "iNikem"}, "path": "instrumentation/java-concurrent/java-completablefuture/java-completablefuture.gradle", "diffHunk": "@@ -0,0 +1,6 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTU3Nw=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk4NjU0Mw==", "bodyText": "oh what you are suggesting works because it's groovy, so it isn't subject to javac --release 7 restrictions \ud83d\ude2d\ni will implement your suggestion \ud83d\udc4d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443986543", "createdAt": "2020-06-23T06:19:51Z", "author": {"login": "trask"}, "path": "instrumentation/java-concurrent/java-completablefuture/java-completablefuture.gradle", "diffHunk": "@@ -0,0 +1,6 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTU3Nw=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk4NzY4Mg==", "bodyText": "done", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443987682", "createdAt": "2020-06-23T06:23:15Z", "author": {"login": "trask"}, "path": "instrumentation/java-concurrent/java-completablefuture/java-completablefuture.gradle", "diffHunk": "@@ -0,0 +1,6 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTU3Nw=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAwMDcyNw==", "bodyText": "Aaa! I was wrong in my line of thought, -release 7 would break my suggestion indeed. But anyway, all good that ends good", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r444000727", "createdAt": "2020-06-23T06:55:02Z", "author": {"login": "iNikem"}, "path": "instrumentation/java-concurrent/java-completablefuture/java-completablefuture.gradle", "diffHunk": "@@ -0,0 +1,6 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTU3Nw=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM3NDExOnYy", "diffSide": "RIGHT", "path": "instrumentation/rediscala-1.8/src/main/java/io/opentelemetry/auto/instrumentation/rediscala/RediscalaInstrumentation.java", "isResolved": true, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODozMToyNVrOGmqhwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMDoxMzozOVrOGn46Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTg0MA==", "bodyText": "Does not look right to me. Passing span name as statement?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443195840", "createdAt": "2020-06-21T08:31:25Z", "author": {"login": "iNikem"}, "path": "instrumentation/rediscala-1.8/src/main/java/io/opentelemetry/auto/instrumentation/rediscala/RediscalaInstrumentation.java", "diffHunk": "@@ -83,10 +83,10 @@ public RediscalaInstrumentation() {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SpanWithScope onEnter(@Advice.Argument(0) final RedisCommand cmd) {\n-      final Span span =\n-          TRACER.spanBuilder(cmd.getClass().getName()).setSpanKind(CLIENT).startSpan();\n+      String statement = DECORATE.spanNameForClass(cmd.getClass());\n+      final Span span = TRACER.spanBuilder(statement).setSpanKind(CLIENT).startSpan();\n       DECORATE.afterStart(span);\n-      DECORATE.onStatement(span, cmd.getClass().getName());\n+      DECORATE.onStatement(span, statement);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg2NzEwNw==", "bodyText": "can u explain your concern here?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443867107", "createdAt": "2020-06-22T22:49:59Z", "author": {"login": "trask"}, "path": "instrumentation/rediscala-1.8/src/main/java/io/opentelemetry/auto/instrumentation/rediscala/RediscalaInstrumentation.java", "diffHunk": "@@ -83,10 +83,10 @@ public RediscalaInstrumentation() {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SpanWithScope onEnter(@Advice.Argument(0) final RedisCommand cmd) {\n-      final Span span =\n-          TRACER.spanBuilder(cmd.getClass().getName()).setSpanKind(CLIENT).startSpan();\n+      String statement = DECORATE.spanNameForClass(cmd.getClass());\n+      final Span span = TRACER.spanBuilder(statement).setSpanKind(CLIENT).startSpan();\n       DECORATE.afterStart(span);\n-      DECORATE.onStatement(span, cmd.getClass().getName());\n+      DECORATE.onStatement(span, statement);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTg0MA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk4NDA0NQ==", "bodyText": "Old code passed cmd.getClass().getName() to onStatement method. Ok, looks good: using class name for RedisCommand subclass as query string.\nNew code calls DECORATE.spanNameForClass and decides to pass this to onStatement method. Does not look good: using span name (which can change in future) as query string?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443984045", "createdAt": "2020-06-23T06:12:40Z", "author": {"login": "iNikem"}, "path": "instrumentation/rediscala-1.8/src/main/java/io/opentelemetry/auto/instrumentation/rediscala/RediscalaInstrumentation.java", "diffHunk": "@@ -83,10 +83,10 @@ public RediscalaInstrumentation() {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SpanWithScope onEnter(@Advice.Argument(0) final RedisCommand cmd) {\n-      final Span span =\n-          TRACER.spanBuilder(cmd.getClass().getName()).setSpanKind(CLIENT).startSpan();\n+      String statement = DECORATE.spanNameForClass(cmd.getClass());\n+      final Span span = TRACER.spanBuilder(statement).setSpanKind(CLIENT).startSpan();\n       DECORATE.afterStart(span);\n-      DECORATE.onStatement(span, cmd.getClass().getName());\n+      DECORATE.onStatement(span, statement);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTg0MA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk4NTcwNQ==", "bodyText": "from https://github.com/open-telemetry/opentelemetry-specification/blob/master/specification/trace/semantic_conventions/database.md:\n\nSpan name should be set to low cardinality value representing the statement executed on the database\n\nin this case the statement is already low cardinality, so it serves for both span name and statement.\ni'm not clear on what you'd like to change here, can you propose a specific change?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443985705", "createdAt": "2020-06-23T06:17:29Z", "author": {"login": "trask"}, "path": "instrumentation/rediscala-1.8/src/main/java/io/opentelemetry/auto/instrumentation/rediscala/RediscalaInstrumentation.java", "diffHunk": "@@ -83,10 +83,10 @@ public RediscalaInstrumentation() {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SpanWithScope onEnter(@Advice.Argument(0) final RedisCommand cmd) {\n-      final Span span =\n-          TRACER.spanBuilder(cmd.getClass().getName()).setSpanKind(CLIENT).startSpan();\n+      String statement = DECORATE.spanNameForClass(cmd.getClass());\n+      final Span span = TRACER.spanBuilder(statement).setSpanKind(CLIENT).startSpan();\n       DECORATE.afterStart(span);\n-      DECORATE.onStatement(span, cmd.getClass().getName());\n+      DECORATE.onStatement(span, statement);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTg0MA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAwMjQ4NQ==", "bodyText": "I propose to pass cmd.getClass().getName() to DECORATE.onStatement method instead of the result of the DECOREATE.spanNameForClass().\nLook at it this way: does DECORATE.onStatement(span, DECOREATE.spanNameForClass(cmd)) make sense to you? Question is not in cardinality, question is in semantics. onStatement expects to receive the equivalent of database query. Span name can be changed at any moment and may be completely different from database query.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r444002485", "createdAt": "2020-06-23T06:58:47Z", "author": {"login": "iNikem"}, "path": "instrumentation/rediscala-1.8/src/main/java/io/opentelemetry/auto/instrumentation/rediscala/RediscalaInstrumentation.java", "diffHunk": "@@ -83,10 +83,10 @@ public RediscalaInstrumentation() {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SpanWithScope onEnter(@Advice.Argument(0) final RedisCommand cmd) {\n-      final Span span =\n-          TRACER.spanBuilder(cmd.getClass().getName()).setSpanKind(CLIENT).startSpan();\n+      String statement = DECORATE.spanNameForClass(cmd.getClass());\n+      final Span span = TRACER.spanBuilder(statement).setSpanKind(CLIENT).startSpan();\n       DECORATE.afterStart(span);\n-      DECORATE.onStatement(span, cmd.getClass().getName());\n+      DECORATE.onStatement(span, statement);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTg0MA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQzNzI3Ng==", "bodyText": "Span name can be changed at any moment\n\nnot without breaking our tests\nwhy would we calculate the same value twice, when we can calculate it once and use it in two places?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r444437276", "createdAt": "2020-06-23T18:52:06Z", "author": {"login": "trask"}, "path": "instrumentation/rediscala-1.8/src/main/java/io/opentelemetry/auto/instrumentation/rediscala/RediscalaInstrumentation.java", "diffHunk": "@@ -83,10 +83,10 @@ public RediscalaInstrumentation() {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SpanWithScope onEnter(@Advice.Argument(0) final RedisCommand cmd) {\n-      final Span span =\n-          TRACER.spanBuilder(cmd.getClass().getName()).setSpanKind(CLIENT).startSpan();\n+      String statement = DECORATE.spanNameForClass(cmd.getClass());\n+      final Span span = TRACER.spanBuilder(statement).setSpanKind(CLIENT).startSpan();\n       DECORATE.afterStart(span);\n-      DECORATE.onStatement(span, cmd.getClass().getName());\n+      DECORATE.onStatement(span, statement);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTg0MA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ1NDI5OQ==", "bodyText": "So you are Ok with DECORATE.onStatement(span, DECOREATE.spanNameForClass(cmd))? For me this code is currently passing span name as a db query. It just happens atm that they have the same value, but this is accidental.\nTechnically this code is right now correct, so I will not object to this PR. But this \"homonym\" will bite us in the future, I am sure :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r444454299", "createdAt": "2020-06-23T19:23:26Z", "author": {"login": "iNikem"}, "path": "instrumentation/rediscala-1.8/src/main/java/io/opentelemetry/auto/instrumentation/rediscala/RediscalaInstrumentation.java", "diffHunk": "@@ -83,10 +83,10 @@ public RediscalaInstrumentation() {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SpanWithScope onEnter(@Advice.Argument(0) final RedisCommand cmd) {\n-      final Span span =\n-          TRACER.spanBuilder(cmd.getClass().getName()).setSpanKind(CLIENT).startSpan();\n+      String statement = DECORATE.spanNameForClass(cmd.getClass());\n+      final Span span = TRACER.spanBuilder(statement).setSpanKind(CLIENT).startSpan();\n       DECORATE.afterStart(span);\n-      DECORATE.onStatement(span, cmd.getClass().getName());\n+      DECORATE.onStatement(span, statement);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTg0MA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3MTkwMg==", "bodyText": "will your concern go away once we migrate to the new DatabaseClientTracer (where you've made the spanName / statement separation more clear)?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r444471902", "createdAt": "2020-06-23T19:57:36Z", "author": {"login": "trask"}, "path": "instrumentation/rediscala-1.8/src/main/java/io/opentelemetry/auto/instrumentation/rediscala/RediscalaInstrumentation.java", "diffHunk": "@@ -83,10 +83,10 @@ public RediscalaInstrumentation() {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SpanWithScope onEnter(@Advice.Argument(0) final RedisCommand cmd) {\n-      final Span span =\n-          TRACER.spanBuilder(cmd.getClass().getName()).setSpanKind(CLIENT).startSpan();\n+      String statement = DECORATE.spanNameForClass(cmd.getClass());\n+      final Span span = TRACER.spanBuilder(statement).setSpanKind(CLIENT).startSpan();\n       DECORATE.afterStart(span);\n-      DECORATE.onStatement(span, cmd.getClass().getName());\n+      DECORATE.onStatement(span, statement);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTg0MA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ4MDAwMw==", "bodyText": "Hm, in fact I believe yes :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r444480003", "createdAt": "2020-06-23T20:13:39Z", "author": {"login": "iNikem"}, "path": "instrumentation/rediscala-1.8/src/main/java/io/opentelemetry/auto/instrumentation/rediscala/RediscalaInstrumentation.java", "diffHunk": "@@ -83,10 +83,10 @@ public RediscalaInstrumentation() {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n     public static SpanWithScope onEnter(@Advice.Argument(0) final RedisCommand cmd) {\n-      final Span span =\n-          TRACER.spanBuilder(cmd.getClass().getName()).setSpanKind(CLIENT).startSpan();\n+      String statement = DECORATE.spanNameForClass(cmd.getClass());\n+      final Span span = TRACER.spanBuilder(statement).setSpanKind(CLIENT).startSpan();\n       DECORATE.afterStart(span);\n-      DECORATE.onStatement(span, cmd.getClass().getName());\n+      DECORATE.onStatement(span, statement);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTg0MA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM3NTMwOnYy", "diffSide": "RIGHT", "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODozMzowNlrOGmqiSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwNTowNzo1NVrOGnZaZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTk3Ng==", "bodyText": "Old name was better :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443195976", "createdAt": "2020-06-21T08:33:06Z", "author": {"login": "iNikem"}, "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "diffHunk": "@@ -71,24 +73,26 @@ public static void agentmain(final String agentArgs, final Instrumentation inst)\n       startMethod.invoke(null, inst, bootstrapURL);\n     } catch (final Throwable ex) {\n       // Don't rethrow.  We don't have a log manager here, so just print.\n+      System.err.println(\"ERROR \" + thisClass.getName());\n       ex.printStackTrace();\n     }\n   }\n \n   private static synchronized URL installBootstrapJar(final Instrumentation inst)\n       throws IOException, URISyntaxException {\n-    URL bootstrapURL = null;\n+    URL ddJavaAgentJarURL = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg1NDUwMQ==", "bodyText": "Even worse thing is that I created 3rd name for the same var. It also called bootstrapJarLocation :\nhttps://github.com/DataDog/dd-trace-java/blob/03ec987180f3f79bb355690ac080c344e9bee906/dd-java-agent/agent-bootstrap/src/main/java/datadog/trace/bootstrap/DatadogClassLoader.java#L31 which I think is better.\nI think it should be one name for this var across all methods.\nPlease help me which name to choose:\n\nbootstrapURL\nbootstrapJarLocation\nddJavaAgentJarURL\nsomething else ?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443854501", "createdAt": "2020-06-22T22:12:17Z", "author": {"login": "lpriima"}, "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "diffHunk": "@@ -71,24 +73,26 @@ public static void agentmain(final String agentArgs, final Instrumentation inst)\n       startMethod.invoke(null, inst, bootstrapURL);\n     } catch (final Throwable ex) {\n       // Don't rethrow.  We don't have a log manager here, so just print.\n+      System.err.println(\"ERROR \" + thisClass.getName());\n       ex.printStackTrace();\n     }\n   }\n \n   private static synchronized URL installBootstrapJar(final Instrumentation inst)\n       throws IOException, URISyntaxException {\n-    URL bootstrapURL = null;\n+    URL ddJavaAgentJarURL = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTk3Ng=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg3MTc1Mg==", "bodyText": "i like ddJavaAgentJarURL, i think it is very descriptive. i did fix it just now to remove the dd prefix in this repo. @iNikem was that your concern?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443871752", "createdAt": "2020-06-22T23:05:07Z", "author": {"login": "trask"}, "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "diffHunk": "@@ -71,24 +73,26 @@ public static void agentmain(final String agentArgs, final Instrumentation inst)\n       startMethod.invoke(null, inst, bootstrapURL);\n     } catch (final Throwable ex) {\n       // Don't rethrow.  We don't have a log manager here, so just print.\n+      System.err.println(\"ERROR \" + thisClass.getName());\n       ex.printStackTrace();\n     }\n   }\n \n   private static synchronized URL installBootstrapJar(final Instrumentation inst)\n       throws IOException, URISyntaxException {\n-    URL bootstrapURL = null;\n+    URL ddJavaAgentJarURL = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTk3Ng=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk2NDAwNQ==", "bodyText": "Yes, dd was my problem :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443964005", "createdAt": "2020-06-23T05:07:55Z", "author": {"login": "iNikem"}, "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "diffHunk": "@@ -71,24 +73,26 @@ public static void agentmain(final String agentArgs, final Instrumentation inst)\n       startMethod.invoke(null, inst, bootstrapURL);\n     } catch (final Throwable ex) {\n       // Don't rethrow.  We don't have a log manager here, so just print.\n+      System.err.println(\"ERROR \" + thisClass.getName());\n       ex.printStackTrace();\n     }\n   }\n \n   private static synchronized URL installBootstrapJar(final Instrumentation inst)\n       throws IOException, URISyntaxException {\n-    URL bootstrapURL = null;\n+    URL ddJavaAgentJarURL = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NTk3Ng=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM3NTQ3OnYy", "diffSide": "RIGHT", "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODozMzozMFrOGmqiYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMzoxNToyM1rOGnT-gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjAwMA==", "bodyText": "Why is this better than AgentBootstrap.class?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443196000", "createdAt": "2020-06-21T08:33:30Z", "author": {"login": "iNikem"}, "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "diffHunk": "@@ -55,6 +56,7 @@\n  * </ul>\n  */\n public class AgentBootstrap {\n+  private static final Class<?> thisClass = MethodHandles.lookup().lookupClass();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3NjYyOA==", "bodyText": "Looks like it could be either: https://github.com/DataDog/dd-trace-java/pull/1561/files#r437482125", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443576628", "createdAt": "2020-06-22T13:56:59Z", "author": {"login": "devinsba"}, "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "diffHunk": "@@ -55,6 +56,7 @@\n  * </ul>\n  */\n public class AgentBootstrap {\n+  private static final Class<?> thisClass = MethodHandles.lookup().lookupClass();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjAwMA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3ODg0MA==", "bodyText": "I argue that AgentBootstrap.class is much easier to understand.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443578840", "createdAt": "2020-06-22T14:00:12Z", "author": {"login": "iNikem"}, "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "diffHunk": "@@ -55,6 +56,7 @@\n  * </ul>\n  */\n public class AgentBootstrap {\n+  private static final Class<?> thisClass = MethodHandles.lookup().lookupClass();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjAwMA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg3NDk0Ng==", "bodyText": "done", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443874946", "createdAt": "2020-06-22T23:15:23Z", "author": {"login": "trask"}, "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "diffHunk": "@@ -55,6 +56,7 @@\n  * </ul>\n  */\n public class AgentBootstrap {\n+  private static final Class<?> thisClass = MethodHandles.lookup().lookupClass();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjAwMA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MTM3OTU5OnYy", "diffSide": "RIGHT", "path": "java-agent/src/test/groovy/io/opentelemetry/auto/AgentLoadedIntoBootstrapTest.groovy", "isResolved": true, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwODozOTowOFrOGmqkZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwNDo1Mjo1MVrOGnZLCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjUxOA==", "bodyText": "I don't understand what this test does and how it is related to changes in AgentBootstrap. Extra documentation maybe?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443196518", "createdAt": "2020-06-21T08:39:08Z", "author": {"login": "iNikem"}, "path": "java-agent/src/test/groovy/io/opentelemetry/auto/AgentLoadedIntoBootstrapTest.groovy", "diffHunk": "@@ -31,4 +33,23 @@ class AgentLoadedIntoBootstrapTest extends Specification {\n       , [:]\n       , true) == 0\n   }\n+\n+  def \"AgentBootstrap is loaded not from dd-java-agent.jar\"() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3Njk2NA==", "bodyText": "PR that added this change: DataDog/dd-trace-java#1561", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443576964", "createdAt": "2020-06-22T13:57:27Z", "author": {"login": "devinsba"}, "path": "java-agent/src/test/groovy/io/opentelemetry/auto/AgentLoadedIntoBootstrapTest.groovy", "diffHunk": "@@ -31,4 +33,23 @@ class AgentLoadedIntoBootstrapTest extends Specification {\n       , [:]\n       , true) == 0\n   }\n+\n+  def \"AgentBootstrap is loaded not from dd-java-agent.jar\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjUxOA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU4MTcyMg==", "bodyText": "I still don't understand. AgentBootstrap was changed to throw a RuntimException if it detects that it is being loaded from the unknown jar. Test seems to create some new jar, runs it and verifies that exit code is 0. Does not make sense to me. It should throw an exception, right? If not, then at least one developer (me) got confused by this test :) Thus, it needs explanation.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443581722", "createdAt": "2020-06-22T14:04:17Z", "author": {"login": "iNikem"}, "path": "java-agent/src/test/groovy/io/opentelemetry/auto/AgentLoadedIntoBootstrapTest.groovy", "diffHunk": "@@ -31,4 +33,23 @@ class AgentLoadedIntoBootstrapTest extends Specification {\n       , [:]\n       , true) == 0\n   }\n+\n+  def \"AgentBootstrap is loaded not from dd-java-agent.jar\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjUxOA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc1NDkyNw==", "bodyText": "You are right: it might be confusing.\nThe actual condition check of this test here:\nhttps://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553/files#diff-c9d742d3b84ae27c73d8b33c042b0c0cR20\nTest is checking that application level class was not loaded by bootstrap classloader. Check for exit code 0, means app exits w/o throwing that exception in user code.\nNo exception and exit code 0 in test, because we don't crash user app, if user wrongly packed (https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553/files#diff-81978fbee285440c149c08f06b126fe8R40) our AgentBootstrap (and maybe some other dd agent classes) into their own \"uber.jar\" (fat jar). We just disable dd agent with ERROR log in this case, and keep user app running.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443754927", "createdAt": "2020-06-22T18:41:07Z", "author": {"login": "lpriima"}, "path": "java-agent/src/test/groovy/io/opentelemetry/auto/AgentLoadedIntoBootstrapTest.groovy", "diffHunk": "@@ -31,4 +33,23 @@ class AgentLoadedIntoBootstrapTest extends Specification {\n       , [:]\n       , true) == 0\n   }\n+\n+  def \"AgentBootstrap is loaded not from dd-java-agent.jar\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjUxOA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2NDc5Nw==", "bodyText": "So, any chance somebody of original authors could provide better name/docs/comments for this test?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443764797", "createdAt": "2020-06-22T19:00:53Z", "author": {"login": "iNikem"}, "path": "java-agent/src/test/groovy/io/opentelemetry/auto/AgentLoadedIntoBootstrapTest.groovy", "diffHunk": "@@ -31,4 +33,23 @@ class AgentLoadedIntoBootstrapTest extends Specification {\n       , [:]\n       , true) == 0\n   }\n+\n+  def \"AgentBootstrap is loaded not from dd-java-agent.jar\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjUxOA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg0MTE0OA==", "bodyText": "Sure. What you think would be the better name for this test?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443841148", "createdAt": "2020-06-22T21:38:46Z", "author": {"login": "lpriima"}, "path": "java-agent/src/test/groovy/io/opentelemetry/auto/AgentLoadedIntoBootstrapTest.groovy", "diffHunk": "@@ -31,4 +33,23 @@ class AgentLoadedIntoBootstrapTest extends Specification {\n       , [:]\n       , true) == 0\n   }\n+\n+  def \"AgentBootstrap is loaded not from dd-java-agent.jar\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjUxOA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg3NDI2Mw==", "bodyText": "done, please review\nbtw, @lpriima thx for adding this guard! i had to troubleshoot a really weird error earlier this year, it did not exhibit itself as NPE like here, but ended up being same issue where customer had bundled our agent into their uber jar", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443874263", "createdAt": "2020-06-22T23:13:06Z", "author": {"login": "trask"}, "path": "java-agent/src/test/groovy/io/opentelemetry/auto/AgentLoadedIntoBootstrapTest.groovy", "diffHunk": "@@ -31,4 +33,23 @@ class AgentLoadedIntoBootstrapTest extends Specification {\n       , [:]\n       , true) == 0\n   }\n+\n+  def \"AgentBootstrap is loaded not from dd-java-agent.jar\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjUxOA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk2MDA3Mw==", "bodyText": "That happens several times with us as well. We got NPEs on de-referencing classloader of random application classes around user code.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443960073", "createdAt": "2020-06-23T04:52:51Z", "author": {"login": "lpriima"}, "path": "java-agent/src/test/groovy/io/opentelemetry/auto/AgentLoadedIntoBootstrapTest.groovy", "diffHunk": "@@ -31,4 +33,23 @@ class AgentLoadedIntoBootstrapTest extends Specification {\n       , [:]\n       , true) == 0\n   }\n+\n+  def \"AgentBootstrap is loaded not from dd-java-agent.jar\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE5NjUxOA=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NTUxNTkzOnYy", "diffSide": "RIGHT", "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMTo0NDozNVrOGnSD8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMjo1ODozOVrOGnTqjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg0MzU2OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final Class<?> thisClass = MethodHandles.lookup().lookupClass();\n          \n          \n            \n              private static final Class<?> thisClass = AgentBootstrap.class;", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443843569", "createdAt": "2020-06-22T21:44:35Z", "author": {"login": "lpriima"}, "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "diffHunk": "@@ -55,6 +56,7 @@\n  * </ul>\n  */\n public class AgentBootstrap {\n+  private static final Class<?> thisClass = MethodHandles.lookup().lookupClass();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg1MDAzMA==", "bodyText": "I want gradle formatter to do that for me.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443850030", "createdAt": "2020-06-22T22:00:17Z", "author": {"login": "lpriima"}, "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "diffHunk": "@@ -55,6 +56,7 @@\n  * </ul>\n  */\n public class AgentBootstrap {\n+  private static final Class<?> thisClass = MethodHandles.lookup().lookupClass();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg0MzU2OQ=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg2OTgzNw==", "bodyText": "done", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443869837", "createdAt": "2020-06-22T22:58:39Z", "author": {"login": "trask"}, "path": "java-agent/src/main/java/io/opentelemetry/auto/bootstrap/AgentBootstrap.java", "diffHunk": "@@ -55,6 +56,7 @@\n  * </ul>\n  */\n public class AgentBootstrap {\n+  private static final Class<?> thisClass = MethodHandles.lookup().lookupClass();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg0MzU2OQ=="}, "originalCommit": {"oid": "802cfd24ded0eae871ebe80284f86931c9426ae3"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NTczMTA4OnYy", "diffSide": "RIGHT", "path": "instrumentation/apache-httpasyncclient-4.0/src/main/java/io/opentelemetry/auto/instrumentation/apachehttpasyncclient/ApacheHttpClientRedirectInstrumentation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMzoyNDo1N1rOGnUJMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMzoyNDo1N1rOGnUJMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg3NzY4Mw==", "bodyText": "Created #559 for this TODO", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/553#discussion_r443877683", "createdAt": "2020-06-22T23:24:57Z", "author": {"login": "trask"}, "path": "instrumentation/apache-httpasyncclient-4.0/src/main/java/io/opentelemetry/auto/instrumentation/apachehttpasyncclient/ApacheHttpClientRedirectInstrumentation.java", "diffHunk": "@@ -73,12 +73,24 @@ private static void onAfterExecute(\n       if (redirect == null) {\n         return;\n       }\n-\n-      for (final Header header : original.getAllHeaders()) {\n-        final String name = header.getName().toLowerCase();\n-        if (name.equals(\"traceparent\")) {\n-          if (!redirect.containsHeader(header.getName())) {\n-            redirect.setHeader(header.getName(), header.getValue());\n+      // TODO this only handles W3C headers", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b05d97710a8be44dccb52c4a62445f4c1e972038"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 269, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}