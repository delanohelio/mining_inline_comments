{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3MTkwMTAy", "number": 1314, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQwMzozMjozMFrOEqDvRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQyMzoxMDoyMFrOFNcqZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNTM2OTAzOnYy", "diffSide": "RIGHT", "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/MoreAttributes.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQwMzozMjozMFrOHcE3sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQwNDowNDoyMFrOHcE9sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIwMTk3MQ==", "bodyText": "I think in parallel with the spec change we could proceed if this is scoped to cassandra. How about moving these into the cassandra package and prefixing with that for now? @trask what do you think?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r499201971", "createdAt": "2020-10-04T03:32:30Z", "author": {"login": "anuraaga"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/MoreAttributes.java", "diffHunk": "@@ -21,4 +21,11 @@\n   public static final String HTTP_FRAGMENT = \"http.fragment.string\";\n \n   public static final String USER_NAME = \"user.principal\";\n+  public static final String QUERY_PAGE_SIZE = \"query.pageSize\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39b9bdd054a5a401f1402ebcb4a135f8d9a8fd8d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIwMzUwNg==", "bodyText": "I think in parallel with the spec change we could proceed if this is scoped to cassandra\n\nOnce a spec PR is opened, I'm good merging something here that implements the initial spec PR (and we can sync it up later with whatever ends up getting approved/merged in the spec).\n\nHow about moving these into the cassandra package and prefixing with that for now?\n\n\ud83d\udc4d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r499203506", "createdAt": "2020-10-04T04:04:20Z", "author": {"login": "trask"}, "path": "instrumentation-api/src/main/java/io/opentelemetry/instrumentation/api/MoreAttributes.java", "diffHunk": "@@ -21,4 +21,11 @@\n   public static final String HTTP_FRAGMENT = \"http.fragment.string\";\n \n   public static final String USER_NAME = \"user.principal\";\n+  public static final String QUERY_PAGE_SIZE = \"query.pageSize\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIwMTk3MQ=="}, "originalCommit": {"oid": "39b9bdd054a5a401f1402ebcb4a135f8d9a8fd8d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3MjQ4NDU1OnYy", "diffSide": "RIGHT", "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwNjo0MDoyMVrOIOLvdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwNjo0MDoyMVrOIOLvdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc0MzM0OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Boolean idempotent = statement.isIdempotent();\n          \n          \n            \n                if (idempotent != null) {\n          \n          \n            \n                  return idempotent;\n          \n          \n            \n                }\n          \n          \n            \n                return false;\n          \n          \n            \n                return Boolean.TRUE.equals(Statement.isIdempotent());", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r551743348", "createdAt": "2021-01-05T06:40:21Z", "author": {"login": "anuraaga"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +62,85 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));\n+    return span;\n+  }\n+\n   public void onResponse(Context context, ExecutionInfo executionInfo) {\n+    Span span = Span.fromContext(context);\n     Node coordinator = executionInfo.getCoordinator();\n     if (coordinator != null) {\n       SocketAddress socketAddress = coordinator.getEndPoint().resolve();\n       if (socketAddress instanceof InetSocketAddress) {\n-        Span span = Span.fromContext(context);\n         NetPeerUtils.INSTANCE.setNetPeer(span, ((InetSocketAddress) socketAddress));\n       }\n+      if (coordinator.getDatacenter() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC, coordinator.getDatacenter());\n+      }\n+      if (coordinator.getHostId() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID, coordinator.getHostId().toString());\n+      }\n+    }\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT,\n+        executionInfo.getSpeculativeExecutionCount());\n+\n+    Statement<?> statement = executionInfo.getStatement();\n+    // override connection default if present\n+    if (statement.getConsistencyLevel() != null) {\n+      span.setAttribute(\n+          SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+          statement.getConsistencyLevel().name());\n+    }\n+    // override connection default if present\n+    if (statement.getPageSize() > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, statement.getPageSize());\n+    }\n+    span.setAttribute(SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE, isIdempotent(statement));\n+  }\n+\n+  @Override\n+  protected void onStatement(Span span, String statement) {\n+    super.onStatement(span, statement);\n+    String table = extractTableNameFromQuery(statement);\n+    if (table != null) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_TABLE, table);\n+    }\n+  }\n+\n+  @Nullable\n+  private static String extractTableNameFromQuery(String query) {\n+    String tableName = null;\n+    Matcher matcher = tableNameRegex.matcher(query);\n+    if (matcher.find()) {\n+      if (matcher.group(2) != null) {\n+        tableName = matcher.group(2);\n+      } else {\n+        tableName = matcher.group(1);\n+      }\n+    }\n+    return tableName;\n+  }\n+\n+  private static boolean isIdempotent(Statement<?> statement) {\n+    Boolean idempotent = statement.isIdempotent();\n+    if (idempotent != null) {\n+      return idempotent;\n     }\n+    return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3465108ed414963eeda05c1b14f593f2b30795a2"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3MjQ4NTYwOnYy", "diffSide": "RIGHT", "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwNjo0MTowMFrOIOLwFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQwMDoyMzo0NlrOIQBTYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc0MzUwOA==", "bodyText": "Do we have a unit test for these two types of matches?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r551743508", "createdAt": "2021-01-05T06:41:00Z", "author": {"login": "anuraaga"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +62,85 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));\n+    return span;\n+  }\n+\n   public void onResponse(Context context, ExecutionInfo executionInfo) {\n+    Span span = Span.fromContext(context);\n     Node coordinator = executionInfo.getCoordinator();\n     if (coordinator != null) {\n       SocketAddress socketAddress = coordinator.getEndPoint().resolve();\n       if (socketAddress instanceof InetSocketAddress) {\n-        Span span = Span.fromContext(context);\n         NetPeerUtils.INSTANCE.setNetPeer(span, ((InetSocketAddress) socketAddress));\n       }\n+      if (coordinator.getDatacenter() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC, coordinator.getDatacenter());\n+      }\n+      if (coordinator.getHostId() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID, coordinator.getHostId().toString());\n+      }\n+    }\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT,\n+        executionInfo.getSpeculativeExecutionCount());\n+\n+    Statement<?> statement = executionInfo.getStatement();\n+    // override connection default if present\n+    if (statement.getConsistencyLevel() != null) {\n+      span.setAttribute(\n+          SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+          statement.getConsistencyLevel().name());\n+    }\n+    // override connection default if present\n+    if (statement.getPageSize() > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, statement.getPageSize());\n+    }\n+    span.setAttribute(SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE, isIdempotent(statement));\n+  }\n+\n+  @Override\n+  protected void onStatement(Span span, String statement) {\n+    super.onStatement(span, statement);\n+    String table = extractTableNameFromQuery(statement);\n+    if (table != null) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_TABLE, table);\n+    }\n+  }\n+\n+  @Nullable\n+  private static String extractTableNameFromQuery(String query) {\n+    String tableName = null;\n+    Matcher matcher = tableNameRegex.matcher(query);\n+    if (matcher.find()) {\n+      if (matcher.group(2) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3465108ed414963eeda05c1b14f593f2b30795a2"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI0MTk2Nw==", "bodyText": "I have added unit tests", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r552241967", "createdAt": "2021-01-05T22:40:12Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +62,85 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));\n+    return span;\n+  }\n+\n   public void onResponse(Context context, ExecutionInfo executionInfo) {\n+    Span span = Span.fromContext(context);\n     Node coordinator = executionInfo.getCoordinator();\n     if (coordinator != null) {\n       SocketAddress socketAddress = coordinator.getEndPoint().resolve();\n       if (socketAddress instanceof InetSocketAddress) {\n-        Span span = Span.fromContext(context);\n         NetPeerUtils.INSTANCE.setNetPeer(span, ((InetSocketAddress) socketAddress));\n       }\n+      if (coordinator.getDatacenter() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC, coordinator.getDatacenter());\n+      }\n+      if (coordinator.getHostId() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID, coordinator.getHostId().toString());\n+      }\n+    }\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT,\n+        executionInfo.getSpeculativeExecutionCount());\n+\n+    Statement<?> statement = executionInfo.getStatement();\n+    // override connection default if present\n+    if (statement.getConsistencyLevel() != null) {\n+      span.setAttribute(\n+          SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+          statement.getConsistencyLevel().name());\n+    }\n+    // override connection default if present\n+    if (statement.getPageSize() > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, statement.getPageSize());\n+    }\n+    span.setAttribute(SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE, isIdempotent(statement));\n+  }\n+\n+  @Override\n+  protected void onStatement(Span span, String statement) {\n+    super.onStatement(span, statement);\n+    String table = extractTableNameFromQuery(statement);\n+    if (table != null) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_TABLE, table);\n+    }\n+  }\n+\n+  @Nullable\n+  private static String extractTableNameFromQuery(String query) {\n+    String tableName = null;\n+    Matcher matcher = tableNameRegex.matcher(query);\n+    if (matcher.find()) {\n+      if (matcher.group(2) != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc0MzUwOA=="}, "originalCommit": {"oid": "3465108ed414963eeda05c1b14f593f2b30795a2"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2OTY4OQ==", "bodyText": "@anuraaga I can't figure out why the unit test is unable to see the public CassandraTableNameExtractor (and before that, the embedded extractor method). Am I missing some test directives in the gradle file?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r552269689", "createdAt": "2021-01-05T23:54:25Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +62,85 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));\n+    return span;\n+  }\n+\n   public void onResponse(Context context, ExecutionInfo executionInfo) {\n+    Span span = Span.fromContext(context);\n     Node coordinator = executionInfo.getCoordinator();\n     if (coordinator != null) {\n       SocketAddress socketAddress = coordinator.getEndPoint().resolve();\n       if (socketAddress instanceof InetSocketAddress) {\n-        Span span = Span.fromContext(context);\n         NetPeerUtils.INSTANCE.setNetPeer(span, ((InetSocketAddress) socketAddress));\n       }\n+      if (coordinator.getDatacenter() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC, coordinator.getDatacenter());\n+      }\n+      if (coordinator.getHostId() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID, coordinator.getHostId().toString());\n+      }\n+    }\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT,\n+        executionInfo.getSpeculativeExecutionCount());\n+\n+    Statement<?> statement = executionInfo.getStatement();\n+    // override connection default if present\n+    if (statement.getConsistencyLevel() != null) {\n+      span.setAttribute(\n+          SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+          statement.getConsistencyLevel().name());\n+    }\n+    // override connection default if present\n+    if (statement.getPageSize() > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, statement.getPageSize());\n+    }\n+    span.setAttribute(SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE, isIdempotent(statement));\n+  }\n+\n+  @Override\n+  protected void onStatement(Span span, String statement) {\n+    super.onStatement(span, statement);\n+    String table = extractTableNameFromQuery(statement);\n+    if (table != null) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_TABLE, table);\n+    }\n+  }\n+\n+  @Nullable\n+  private static String extractTableNameFromQuery(String query) {\n+    String tableName = null;\n+    Matcher matcher = tableNameRegex.matcher(query);\n+    if (matcher.find()) {\n+      if (matcher.group(2) != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc0MzUwOA=="}, "originalCommit": {"oid": "3465108ed414963eeda05c1b14f593f2b30795a2"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI3MDQzMw==", "bodyText": "for ref the task is :instrumentation:cassandra:cassandra-4.0:javaagent:test", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r552270433", "createdAt": "2021-01-05T23:56:40Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +62,85 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));\n+    return span;\n+  }\n+\n   public void onResponse(Context context, ExecutionInfo executionInfo) {\n+    Span span = Span.fromContext(context);\n     Node coordinator = executionInfo.getCoordinator();\n     if (coordinator != null) {\n       SocketAddress socketAddress = coordinator.getEndPoint().resolve();\n       if (socketAddress instanceof InetSocketAddress) {\n-        Span span = Span.fromContext(context);\n         NetPeerUtils.INSTANCE.setNetPeer(span, ((InetSocketAddress) socketAddress));\n       }\n+      if (coordinator.getDatacenter() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC, coordinator.getDatacenter());\n+      }\n+      if (coordinator.getHostId() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID, coordinator.getHostId().toString());\n+      }\n+    }\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT,\n+        executionInfo.getSpeculativeExecutionCount());\n+\n+    Statement<?> statement = executionInfo.getStatement();\n+    // override connection default if present\n+    if (statement.getConsistencyLevel() != null) {\n+      span.setAttribute(\n+          SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+          statement.getConsistencyLevel().name());\n+    }\n+    // override connection default if present\n+    if (statement.getPageSize() > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, statement.getPageSize());\n+    }\n+    span.setAttribute(SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE, isIdempotent(statement));\n+  }\n+\n+  @Override\n+  protected void onStatement(Span span, String statement) {\n+    super.onStatement(span, statement);\n+    String table = extractTableNameFromQuery(statement);\n+    if (table != null) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_TABLE, table);\n+    }\n+  }\n+\n+  @Nullable\n+  private static String extractTableNameFromQuery(String query) {\n+    String tableName = null;\n+    Matcher matcher = tableNameRegex.matcher(query);\n+    if (matcher.find()) {\n+      if (matcher.group(2) != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc0MzUwOA=="}, "originalCommit": {"oid": "3465108ed414963eeda05c1b14f593f2b30795a2"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzIwNTAwMg==", "bodyText": "Sorry for the trouble - we merged a change which has our tests behave more like an instrumented app, meaning indeed they don't get access to the agent's classes. You'll need to split out a unit tests module for them (long term we should split out library instrumentation instead).\nhttps://github.com/open-telemetry/opentelemetry-java-instrumentation/tree/master/instrumentation/jdbc/javaagent-unittests", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r553205002", "createdAt": "2021-01-07T09:24:00Z", "author": {"login": "anuraaga"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +62,85 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));\n+    return span;\n+  }\n+\n   public void onResponse(Context context, ExecutionInfo executionInfo) {\n+    Span span = Span.fromContext(context);\n     Node coordinator = executionInfo.getCoordinator();\n     if (coordinator != null) {\n       SocketAddress socketAddress = coordinator.getEndPoint().resolve();\n       if (socketAddress instanceof InetSocketAddress) {\n-        Span span = Span.fromContext(context);\n         NetPeerUtils.INSTANCE.setNetPeer(span, ((InetSocketAddress) socketAddress));\n       }\n+      if (coordinator.getDatacenter() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC, coordinator.getDatacenter());\n+      }\n+      if (coordinator.getHostId() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID, coordinator.getHostId().toString());\n+      }\n+    }\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT,\n+        executionInfo.getSpeculativeExecutionCount());\n+\n+    Statement<?> statement = executionInfo.getStatement();\n+    // override connection default if present\n+    if (statement.getConsistencyLevel() != null) {\n+      span.setAttribute(\n+          SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+          statement.getConsistencyLevel().name());\n+    }\n+    // override connection default if present\n+    if (statement.getPageSize() > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, statement.getPageSize());\n+    }\n+    span.setAttribute(SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE, isIdempotent(statement));\n+  }\n+\n+  @Override\n+  protected void onStatement(Span span, String statement) {\n+    super.onStatement(span, statement);\n+    String table = extractTableNameFromQuery(statement);\n+    if (table != null) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_TABLE, table);\n+    }\n+  }\n+\n+  @Nullable\n+  private static String extractTableNameFromQuery(String query) {\n+    String tableName = null;\n+    Matcher matcher = tableNameRegex.matcher(query);\n+    if (matcher.find()) {\n+      if (matcher.group(2) != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc0MzUwOA=="}, "originalCommit": {"oid": "3465108ed414963eeda05c1b14f593f2b30795a2"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY2OTQ3Mg==", "bodyText": "should be good now @anuraaga", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r553669472", "createdAt": "2021-01-08T00:23:46Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +62,85 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));\n+    return span;\n+  }\n+\n   public void onResponse(Context context, ExecutionInfo executionInfo) {\n+    Span span = Span.fromContext(context);\n     Node coordinator = executionInfo.getCoordinator();\n     if (coordinator != null) {\n       SocketAddress socketAddress = coordinator.getEndPoint().resolve();\n       if (socketAddress instanceof InetSocketAddress) {\n-        Span span = Span.fromContext(context);\n         NetPeerUtils.INSTANCE.setNetPeer(span, ((InetSocketAddress) socketAddress));\n       }\n+      if (coordinator.getDatacenter() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC, coordinator.getDatacenter());\n+      }\n+      if (coordinator.getHostId() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID, coordinator.getHostId().toString());\n+      }\n+    }\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT,\n+        executionInfo.getSpeculativeExecutionCount());\n+\n+    Statement<?> statement = executionInfo.getStatement();\n+    // override connection default if present\n+    if (statement.getConsistencyLevel() != null) {\n+      span.setAttribute(\n+          SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+          statement.getConsistencyLevel().name());\n+    }\n+    // override connection default if present\n+    if (statement.getPageSize() > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, statement.getPageSize());\n+    }\n+    span.setAttribute(SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE, isIdempotent(statement));\n+  }\n+\n+  @Override\n+  protected void onStatement(Span span, String statement) {\n+    super.onStatement(span, statement);\n+    String table = extractTableNameFromQuery(statement);\n+    if (table != null) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_TABLE, table);\n+    }\n+  }\n+\n+  @Nullable\n+  private static String extractTableNameFromQuery(String query) {\n+    String tableName = null;\n+    Matcher matcher = tableNameRegex.matcher(query);\n+    if (matcher.find()) {\n+      if (matcher.group(2) != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc0MzUwOA=="}, "originalCommit": {"oid": "3465108ed414963eeda05c1b14f593f2b30795a2"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5NjM5NzIzOnYy", "diffSide": "RIGHT", "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "isResolved": true, "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQyMjo0ODoxOFrOIRqSCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQxODo0MDo0N1rOIWcItg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA==", "bodyText": "If Statement is provided with overridden consistency or page size, and then the query throws an exception, the instrumentation never calls onResponse, and I think we will be left capturing the wrong value?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555389448", "createdAt": "2021-01-11T22:48:18Z", "author": {"login": "trask"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQxNzM1MA==", "bodyText": "that is correct", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555417350", "createdAt": "2021-01-12T00:05:13Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQyODY4Ng==", "bodyText": "it's a little less dire than that, on exception it will still attempt to extract the execution info and invoke onResponse", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555428686", "createdAt": "2021-01-12T00:27:48Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQyODc2Ng==", "bodyText": "can we avoid capturing the wrong value? In general it's better to capture no value than to capture the wrong value", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555428766", "createdAt": "2021-01-12T00:28:06Z", "author": {"login": "trask"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQzMDA3MQ==", "bodyText": "it seems that actually did not come over on the rebase, I'll add that back in", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555430071", "createdAt": "2021-01-12T00:32:17Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQzMDcyMg==", "bodyText": "it's a little less dire than that, on exception it will still attempt to extract the execution info and invoke onResponse\n\ncan you point me where you're seeing that? this is what I'm looking at in TracingCqlSession, and on exception it doesn't call onResponse:\n      try {\n        ResultSet resultSet = session.execute(query);\n        tracer().onResponse(context, resultSet.getExecutionInfo());\n        return resultSet;\n      } catch (RuntimeException e) {\n        tracer().endExceptionally(context, e);\n        throw e;\n      } finally {\n        tracer().end(context);\n      }", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555430722", "createdAt": "2021-01-12T00:34:21Z", "author": {"login": "trask"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQzMTA5MA==", "bodyText": "it seems that actually did not come over on the rebase, I'll add that back in\n\n\ud83d\udc4d (ignore my last comment)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555431090", "createdAt": "2021-01-12T00:35:33Z", "author": {"login": "trask"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQzMjE4OQ==", "bodyText": "what is the best way to clear the attribute on a span @trask? The setAttribute method is annotated with not null.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555432189", "createdAt": "2021-01-12T00:38:52Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQzMzM3Mg==", "bodyText": "can we set the attributes only once we have the statement?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555433372", "createdAt": "2021-01-12T00:42:50Z", "author": {"login": "trask"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ4OTU0OA==", "bodyText": "the default values comes out of the session which is only available in onConnection, not in onResponse", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555489548", "createdAt": "2021-01-12T03:36:29Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTUzMjAyNg==", "bodyText": "can we pass the session in to onResponse?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555532026", "createdAt": "2021-01-12T06:02:29Z", "author": {"login": "trask"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU1MDQxNQ==", "bodyText": "we can, but it means the endExceptionally method no longer overrides the superclass method since it also needs the session. I have added that and an implementation that throws an illegal state exception if called.\nanother option would be to pass the session and execution info as a pair, but that may create undesired garbage.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555550415", "createdAt": "2021-01-12T06:58:41Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDQwMDU2Ng==", "bodyText": "hey @trask, are you happy with the change to add the session into onResponse meaning it also needs to be passed into endExceptionally?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r560400566", "createdAt": "2021-01-19T18:40:47Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM4OTQ0OA=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5NjQwNTExOnYy", "diffSide": "RIGHT", "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQyMjo1MToyMFrOIRqW2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQwMzozNzo0NVrOIRwaOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM5MDY4Mg==", "bodyText": "if we can't check for the default when isIdempotent returns null, then I think better to capture nothing when it's null (instead of a potentially incorrect value)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555390682", "createdAt": "2021-01-11T22:51:20Z", "author": {"login": "trask"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));\n+    return span;\n+  }\n+\n   public void onResponse(Context context, ExecutionInfo executionInfo) {\n+    Span span = Span.fromContext(context);\n     Node coordinator = executionInfo.getCoordinator();\n     if (coordinator != null) {\n       SocketAddress socketAddress = coordinator.getEndPoint().resolve();\n       if (socketAddress instanceof InetSocketAddress) {\n-        Span span = Span.fromContext(context);\n         NetPeerUtils.INSTANCE.setNetPeer(span, ((InetSocketAddress) socketAddress));\n       }\n+      if (coordinator.getDatacenter() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC, coordinator.getDatacenter());\n+      }\n+      if (coordinator.getHostId() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID, coordinator.getHostId().toString());\n+      }\n     }\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT,\n+        executionInfo.getSpeculativeExecutionCount());\n+\n+    Statement<?> statement = executionInfo.getStatement();\n+    // override connection default if present\n+    if (statement.getConsistencyLevel() != null) {\n+      span.setAttribute(\n+          SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+          statement.getConsistencyLevel().name());\n+    }\n+    // override connection default if present\n+    if (statement.getPageSize() > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, statement.getPageSize());\n+    }\n+    span.setAttribute(SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE, isIdempotent(statement));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQyNzg5Mg==", "bodyText": "statements are not idempotent by default. I can't think of a situation where it would be idempotent but not tagged as such. by default it isn't specified though so null should be treated as false. for example, I just tested out running an insert statement which is not idempotent. it had a null idempotent field.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555427892", "createdAt": "2021-01-12T00:25:30Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));\n+    return span;\n+  }\n+\n   public void onResponse(Context context, ExecutionInfo executionInfo) {\n+    Span span = Span.fromContext(context);\n     Node coordinator = executionInfo.getCoordinator();\n     if (coordinator != null) {\n       SocketAddress socketAddress = coordinator.getEndPoint().resolve();\n       if (socketAddress instanceof InetSocketAddress) {\n-        Span span = Span.fromContext(context);\n         NetPeerUtils.INSTANCE.setNetPeer(span, ((InetSocketAddress) socketAddress));\n       }\n+      if (coordinator.getDatacenter() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC, coordinator.getDatacenter());\n+      }\n+      if (coordinator.getHostId() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID, coordinator.getHostId().toString());\n+      }\n     }\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT,\n+        executionInfo.getSpeculativeExecutionCount());\n+\n+    Statement<?> statement = executionInfo.getStatement();\n+    // override connection default if present\n+    if (statement.getConsistencyLevel() != null) {\n+      span.setAttribute(\n+          SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+          statement.getConsistencyLevel().name());\n+    }\n+    // override connection default if present\n+    if (statement.getPageSize() > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, statement.getPageSize());\n+    }\n+    span.setAttribute(SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE, isIdempotent(statement));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM5MDY4Mg=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQyOTIwNw==", "bodyText": "the javadoc for isIdempotent() says it returns null to use the default value defined in the configuration and references DefaultDriverOption.REQUEST_DEFAULT_IDEMPOTENCE", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555429207", "createdAt": "2021-01-12T00:29:32Z", "author": {"login": "trask"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));\n+    return span;\n+  }\n+\n   public void onResponse(Context context, ExecutionInfo executionInfo) {\n+    Span span = Span.fromContext(context);\n     Node coordinator = executionInfo.getCoordinator();\n     if (coordinator != null) {\n       SocketAddress socketAddress = coordinator.getEndPoint().resolve();\n       if (socketAddress instanceof InetSocketAddress) {\n-        Span span = Span.fromContext(context);\n         NetPeerUtils.INSTANCE.setNetPeer(span, ((InetSocketAddress) socketAddress));\n       }\n+      if (coordinator.getDatacenter() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC, coordinator.getDatacenter());\n+      }\n+      if (coordinator.getHostId() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID, coordinator.getHostId().toString());\n+      }\n     }\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT,\n+        executionInfo.getSpeculativeExecutionCount());\n+\n+    Statement<?> statement = executionInfo.getStatement();\n+    // override connection default if present\n+    if (statement.getConsistencyLevel() != null) {\n+      span.setAttribute(\n+          SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+          statement.getConsistencyLevel().name());\n+    }\n+    // override connection default if present\n+    if (statement.getPageSize() > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, statement.getPageSize());\n+    }\n+    span.setAttribute(SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE, isIdempotent(statement));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM5MDY4Mg=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ4OTg1MA==", "bodyText": "hmm, that's a good catch. I will add it into the same set as the other default driver options.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555489850", "createdAt": "2021-01-12T03:37:45Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraDatabaseClientTracer.java", "diffHunk": "@@ -49,14 +56,67 @@ protected InetSocketAddress peerAddress(CqlSession cqlSession) {\n     return null;\n   }\n \n+  @Override\n+  protected Span onConnection(Span span, CqlSession cqlSession) {\n+    span = super.onConnection(span, cqlSession);\n+    DriverExecutionProfile config = cqlSession.getContext().getConfig().getDefaultProfile();\n+    // may be overwritten by statement, but take the default for now\n+    int pageSize = config.getInt(DefaultDriverOption.REQUEST_PAGE_SIZE);\n+    if (pageSize > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, pageSize);\n+    }\n+    // may be overwritten by statement, but take the default for now\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+        config.getString(DefaultDriverOption.REQUEST_CONSISTENCY));\n+    return span;\n+  }\n+\n   public void onResponse(Context context, ExecutionInfo executionInfo) {\n+    Span span = Span.fromContext(context);\n     Node coordinator = executionInfo.getCoordinator();\n     if (coordinator != null) {\n       SocketAddress socketAddress = coordinator.getEndPoint().resolve();\n       if (socketAddress instanceof InetSocketAddress) {\n-        Span span = Span.fromContext(context);\n         NetPeerUtils.INSTANCE.setNetPeer(span, ((InetSocketAddress) socketAddress));\n       }\n+      if (coordinator.getDatacenter() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC, coordinator.getDatacenter());\n+      }\n+      if (coordinator.getHostId() != null) {\n+        span.setAttribute(\n+            SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID, coordinator.getHostId().toString());\n+      }\n     }\n+    span.setAttribute(\n+        SemanticAttributes.DB_CASSANDRA_SPECULATIVE_EXECUTION_COUNT,\n+        executionInfo.getSpeculativeExecutionCount());\n+\n+    Statement<?> statement = executionInfo.getStatement();\n+    // override connection default if present\n+    if (statement.getConsistencyLevel() != null) {\n+      span.setAttribute(\n+          SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL,\n+          statement.getConsistencyLevel().name());\n+    }\n+    // override connection default if present\n+    if (statement.getPageSize() > 0) {\n+      span.setAttribute(SemanticAttributes.DB_CASSANDRA_PAGE_SIZE, statement.getPageSize());\n+    }\n+    span.setAttribute(SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE, isIdempotent(statement));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM5MDY4Mg=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5NjQxMzUxOnYy", "diffSide": "RIGHT", "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/test/groovy/CassandraClientTest.groovy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQyMjo1NDozNFrOIRqb6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQyMjo1NDozNFrOIRqb6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM5MTk3Nw==", "bodyText": "this is the convention used elsewhere for verifying presence of attribute:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"$SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID.key\" { id -> true } // not tested\n          \n          \n            \n                    \"$SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE.key\" { idempotence -> true } // not tested\n          \n          \n            \n                    \"$SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID.key\" String\n          \n          \n            \n                    \"$SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE.key\" Boolean", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555391977", "createdAt": "2021-01-11T22:54:34Z", "author": {"login": "trask"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/test/groovy/CassandraClientTest.groovy", "diffHunk": "@@ -113,6 +114,13 @@ class CassandraClientTest extends AgentTestRunner {\n         \"$SemanticAttributes.DB_SYSTEM.key\" \"cassandra\"\n         \"$SemanticAttributes.DB_NAME.key\" keyspace\n         \"$SemanticAttributes.DB_STATEMENT.key\" statement\n+        \"$SemanticAttributes.DB_CASSANDRA_CONSISTENCY_LEVEL.key\" \"LOCAL_ONE\"\n+        \"$SemanticAttributes.DB_CASSANDRA_COORDINATOR_DC.key\" \"datacenter1\"\n+        \"$SemanticAttributes.DB_CASSANDRA_COORDINATOR_ID.key\" { id -> true } // not tested\n+        \"$SemanticAttributes.DB_CASSANDRA_IDEMPOTENCE.key\" { idempotence -> true } // not tested", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5NjQ1NDE0OnYy", "diffSide": "RIGHT", "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraTableNameExtractor.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQyMzoxMDoyMFrOIRq0Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMlQwMzo0MTowNVrOId-X-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM5ODIwNg==", "bodyText": "from https://github.com/open-telemetry/opentelemetry-specification/blob/master/specification/trace/semantic_conventions/database.md\n\nIt is not recommended to attempt any client-side parsing of db.statement just to get this property\n\nWe also parse jdbc SQL for the table name, though, violating this, so ??? <-- @mateuszrzeszutek @iNikem @johnbley @anuraaga\nIf we are going to parse/capture the table name, it would be great to use it in the span name: <db.operation> <db.name>.<db.sql.table>", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555398206", "createdAt": "2021-01-11T23:10:20Z", "author": {"login": "trask"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraTableNameExtractor.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.cassandra.v4_0;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * this class is separate to enable testing. when the {@link #extractTableNameFromQuery} method was\n+ * embedded there was an issue with visibility, even if the method was public.\n+ */\n+public class CassandraTableNameExtractor {\n+\n+  private CassandraTableNameExtractor() {}\n+\n+  private static final Pattern tableNameRegex =\n+      Pattern.compile(\n+          \".*(?:FROM|INTO|UPDATE|TRUNCATE|(?:CREATE|ALTER|DROP) TABLE)\\\\s+(?:IF (?:NOT )?EXISTS\\\\s+)?([A-Z1-9_]+\\\\.([A-Z1-9_]+)|([A-Z1-9_]+))\",\n+          Pattern.CASE_INSENSITIVE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQxODIyNA==", "bodyText": "we could extract the table name without parsing anything if the statement is a prepared statement, but if the statement is a simplestatement that's the only way I could find to get it out.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r555418224", "createdAt": "2021-01-12T00:07:52Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraTableNameExtractor.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.cassandra.v4_0;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * this class is separate to enable testing. when the {@link #extractTableNameFromQuery} method was\n+ * embedded there was an issue with visibility, even if the method was public.\n+ */\n+public class CassandraTableNameExtractor {\n+\n+  private CassandraTableNameExtractor() {}\n+\n+  private static final Pattern tableNameRegex =\n+      Pattern.compile(\n+          \".*(?:FROM|INTO|UPDATE|TRUNCATE|(?:CREATE|ALTER|DROP) TABLE)\\\\s+(?:IF (?:NOT )?EXISTS\\\\s+)?([A-Z1-9_]+\\\\.([A-Z1-9_]+)|([A-Z1-9_]+))\",\n+          Pattern.CASE_INSENSITIVE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM5ODIwNg=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDQ0MzAxOA==", "bodyText": "We already parse the cassandra query to sanitize it - once #2113 is in operation & table name will be available for free (although the current sanitizer implementation cannot extract table name from create/drop table statements, but I suspect that those are rare cases anyway).", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r564443018", "createdAt": "2021-01-26T11:31:32Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraTableNameExtractor.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.cassandra.v4_0;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * this class is separate to enable testing. when the {@link #extractTableNameFromQuery} method was\n+ * embedded there was an issue with visibility, even if the method was public.\n+ */\n+public class CassandraTableNameExtractor {\n+\n+  private CassandraTableNameExtractor() {}\n+\n+  private static final Pattern tableNameRegex =\n+      Pattern.compile(\n+          \".*(?:FROM|INTO|UPDATE|TRUNCATE|(?:CREATE|ALTER|DROP) TABLE)\\\\s+(?:IF (?:NOT )?EXISTS\\\\s+)?([A-Z1-9_]+\\\\.([A-Z1-9_]+)|([A-Z1-9_]+))\",\n+          Pattern.CASE_INSENSITIVE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM5ODIwNg=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDkyMTkxNA==", "bodyText": "Okay, I'll have a look at refactoring and basing the table extraction on this.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r564921914", "createdAt": "2021-01-27T00:02:17Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraTableNameExtractor.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.cassandra.v4_0;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * this class is separate to enable testing. when the {@link #extractTableNameFromQuery} method was\n+ * embedded there was an issue with visibility, even if the method was public.\n+ */\n+public class CassandraTableNameExtractor {\n+\n+  private CassandraTableNameExtractor() {}\n+\n+  private static final Pattern tableNameRegex =\n+      Pattern.compile(\n+          \".*(?:FROM|INTO|UPDATE|TRUNCATE|(?:CREATE|ALTER|DROP) TABLE)\\\\s+(?:IF (?:NOT )?EXISTS\\\\s+)?([A-Z1-9_]+\\\\.([A-Z1-9_]+)|([A-Z1-9_]+))\",\n+          Pattern.CASE_INSENSITIVE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM5ODIwNg=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODMwMTU2Mw==", "bodyText": "done", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1314#discussion_r568301563", "createdAt": "2021-02-02T03:41:05Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/cassandra/cassandra-4.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/cassandra/v4_0/CassandraTableNameExtractor.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.cassandra.v4_0;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * this class is separate to enable testing. when the {@link #extractTableNameFromQuery} method was\n+ * embedded there was an issue with visibility, even if the method was public.\n+ */\n+public class CassandraTableNameExtractor {\n+\n+  private CassandraTableNameExtractor() {}\n+\n+  private static final Pattern tableNameRegex =\n+      Pattern.compile(\n+          \".*(?:FROM|INTO|UPDATE|TRUNCATE|(?:CREATE|ALTER|DROP) TABLE)\\\\s+(?:IF (?:NOT )?EXISTS\\\\s+)?([A-Z1-9_]+\\\\.([A-Z1-9_]+)|([A-Z1-9_]+))\",\n+          Pattern.CASE_INSENSITIVE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM5ODIwNg=="}, "originalCommit": {"oid": "f8907dfbf4994ce917db26e744fb65b3c0ba1408"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4795, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}