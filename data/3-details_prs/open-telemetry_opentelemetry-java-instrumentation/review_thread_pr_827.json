{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MTA1NzQ4", "number": 827, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzoyNTowM1rOETCVgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDozODo0MFrOETee4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mzk2NjczOnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzoyNTowM1rOG4jJpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMDo0ODoxNFrOG4kqwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk0OTM0OQ==", "bodyText": "do you think we need to support this header?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461949349", "createdAt": "2020-07-28T23:25:03Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,44 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3NDIxMA==", "bodyText": "yeah, mozilla says it's the real standard while x-forwarded-for is the defacto standard. best to get both imo. https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Forwarded", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461974210", "createdAt": "2020-07-29T00:48:14Z", "author": {"login": "FrankSpitulski"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,44 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk0OTM0OQ=="}, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mzk3MTc5OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzoyNzowN1rOG4jMfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMTo0MjowNVrOG4liBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MDA3Ng==", "bodyText": "should be slightly faster to split by , and then trim result", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461950076", "createdAt": "2020-07-28T23:27:07Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,44 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      // may be split by ; or ,\n+      for (String forwardedValues : forwarded.split(\";|(, *)\")) {\n+        String[] split = forwardedValues.split(\"=\", 2);\n+        if (split.length != 2) {\n+          continue;\n+        }\n+        if (\"for\".equalsIgnoreCase(split[0]) && !split[1].isEmpty()) {\n+          return split[1];\n+        }\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      String[] split = forwarded.split(\", *\", 2); // only need the first", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk4ODM1OQ==", "bodyText": "I got rid of the regex in the x-forwarded-for case", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461988359", "createdAt": "2020-07-29T01:42:05Z", "author": {"login": "FrankSpitulski"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,44 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      // may be split by ; or ,\n+      for (String forwardedValues : forwarded.split(\";|(, *)\")) {\n+        String[] split = forwardedValues.split(\"=\", 2);\n+        if (split.length != 2) {\n+          continue;\n+        }\n+        if (\"for\".equalsIgnoreCase(split[0]) && !split[1].isEmpty()) {\n+          return split[1];\n+        }\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      String[] split = forwarded.split(\", *\", 2); // only need the first", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MDA3Ng=="}, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mzk3NzE5OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/typedspan/DelegatingSpan.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzoyOToxNlrOG4jPkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMTo0MjoxNFrOG4liOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MDg2NQ==", "bodyText": "ya, fix should be merged shortly in #824 \ud83d\udc4d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461950865", "createdAt": "2020-07-28T23:29:16Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/typedspan/DelegatingSpan.java", "diffHunk": "@@ -91,6 +91,11 @@ public void setStatus(final Status status) {\n     delegate.setStatus(status);\n   }\n \n+  @Override\n+  public void recordException(Throwable throwable) {\n+    delegate.recordException(throwable);\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk4ODQxMA==", "bodyText": "rebased", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461988410", "createdAt": "2020-07-29T01:42:14Z", "author": {"login": "FrankSpitulski"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/typedspan/DelegatingSpan.java", "diffHunk": "@@ -91,6 +91,11 @@ public void setStatus(final Status status) {\n     delegate.setStatus(status);\n   }\n \n+  @Override\n+  public void recordException(Throwable throwable) {\n+    delegate.recordException(throwable);\n+  }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MDg2NQ=="}, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mzk4MTQzOnYy", "diffSide": "RIGHT", "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/auto/instrumentation/netty/v3_8/server/NettyHttpServerTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzozMTowOFrOG4jSAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMDo0OTozMVrOG4ksIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MTQ4OA==", "bodyText": "does this work?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return null; // TODO flavor is on the request, not the connection for this tracer\n          \n          \n            \n                return request.getProtocolVersion().toString();", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461951488", "createdAt": "2020-07-28T23:31:08Z", "author": {"login": "trask"}, "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/auto/instrumentation/netty/v3_8/server/NettyHttpServerTracer.java", "diffHunk": "@@ -67,6 +72,11 @@ protected String peerHostIP(final Channel channel) {\n     return null;\n   }\n \n+  @Override\n+  protected String flavor(Channel channel, HttpRequest request) {\n+    return null; // TODO flavor is on the request, not the connection for this tracer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3NDU2MQ==", "bodyText": "yep, I just missed this one when I added the request param.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461974561", "createdAt": "2020-07-29T00:49:31Z", "author": {"login": "FrankSpitulski"}, "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/auto/instrumentation/netty/v3_8/server/NettyHttpServerTracer.java", "diffHunk": "@@ -67,6 +72,11 @@ protected String peerHostIP(final Channel channel) {\n     return null;\n   }\n \n+  @Override\n+  protected String flavor(Channel channel, HttpRequest request) {\n+    return null; // TODO flavor is on the request, not the connection for this tracer", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MTQ4OA=="}, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mzk5ODQ4OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzozODo1MFrOG4jb2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMDo1MDoyNVrOG4ktNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1NDAxMA==", "bodyText": "split(regex) is really slow, if we need a regex we should use Pattern.compile at least. But it'd be best if we can avoid split too due to the array allocations, do you think we can loop through to find the indexes instead of splitting?\n@trask By the way, is it ok to use Guava here? CharMatcher can help with such searches.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461954010", "createdAt": "2020-07-28T23:38:50Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,44 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      // may be split by ; or ,\n+      for (String forwardedValues : forwarded.split(\";|(, *)\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1ODUyNA==", "bodyText": "is it ok to use Guava here?\n\nCurrently we don't, maybe better not to add this [EDIT: all of Guava] to our instrumentation api contract. We could expose something in our instrumentation api that wraps specific guava functionality if we need. I'd probably lean towards doing the index looping here for now (assuming we need to support the \"Forwarded\" header).", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461958524", "createdAt": "2020-07-28T23:52:59Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,44 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      // may be split by ; or ,\n+      for (String forwardedValues : forwarded.split(\";|(, *)\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1NDAxMA=="}, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2MTczMQ==", "bodyText": "Ah forgot this is the instrumentation API, also used in library instrumentation. Agree not to add dependencies.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461961731", "createdAt": "2020-07-29T00:03:38Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,44 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      // may be split by ; or ,\n+      for (String forwardedValues : forwarded.split(\";|(, *)\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1NDAxMA=="}, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3NDgzNw==", "bodyText": "I'll change it to pattern.compile and incorporate the trim optimisation", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r461974837", "createdAt": "2020-07-29T00:50:25Z", "author": {"login": "FrankSpitulski"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,44 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      // may be split by ; or ,\n+      for (String forwardedValues : forwarded.split(\";|(, *)\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1NDAxMA=="}, "originalCommit": {"oid": "952c19e5130f7075f2e747c5367da719107dcbb3"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDQwNDcxOnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMzoxNzo0NVrOG4nEWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMzo1ODowMFrOG4nr6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxMzUzMQ==", "bodyText": "did we need trim here?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    forwarded = forwarded.substring(0, endIndex);\n          \n          \n            \n                    forwarded = forwarded.substring(0, endIndex).trim();", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462013531", "createdAt": "2020-07-29T03:17:45Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +205,48 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      // may be split by ; or ,\n+      for (String forwardedValues : FORWARDED_SPLIT_PATTERN.split(forwarded)) {\n+        forwardedValues = forwardedValues.trim();\n+        String[] split = EQUALS_PATTERN.split(forwardedValues, 2);\n+        if (split.length != 2) {\n+          continue;\n+        }\n+        if (\"for\".equalsIgnoreCase(split[0]) && !split[1].isEmpty()) {\n+          return split[1];\n+        }\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      int endIndex = forwarded.indexOf(',');\n+      if (endIndex > 0) {\n+        forwarded = forwarded.substring(0, endIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ee612c5aa6d6225c35a224a66e30a152c98739c"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyMzY1Ng==", "bodyText": "no, there aren't going to be any spaces before the first comma and we only need the first value", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462023656", "createdAt": "2020-07-29T03:58:00Z", "author": {"login": "FrankSpitulski"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +205,48 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      // may be split by ; or ,\n+      for (String forwardedValues : FORWARDED_SPLIT_PATTERN.split(forwarded)) {\n+        forwardedValues = forwardedValues.trim();\n+        String[] split = EQUALS_PATTERN.split(forwardedValues, 2);\n+        if (split.length != 2) {\n+          continue;\n+        }\n+        if (\"for\".equalsIgnoreCase(split[0]) && !split[1].isEmpty()) {\n+          return split[1];\n+        }\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      int endIndex = forwarded.indexOf(',');\n+      if (endIndex > 0) {\n+        forwarded = forwarded.substring(0, endIndex);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxMzUzMQ=="}, "originalCommit": {"oid": "2ee612c5aa6d6225c35a224a66e30a152c98739c"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDQyMTg0OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMzoyNzo0M1rOG4nOYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNToyODo0OFrOG4pHVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxNjA5OQ==", "bodyText": "can you convert EQUALS_PATTERN to indexOf/substring to avoid that regex? I don't think that would add code complexity.\nreplacing FORWARDED_SPLIT_PATTERN would definitely add code complexity, so i don't mind keeping", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462016099", "createdAt": "2020-07-29T03:27:43Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +205,48 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      // may be split by ; or ,\n+      for (String forwardedValues : FORWARDED_SPLIT_PATTERN.split(forwarded)) {\n+        forwardedValues = forwardedValues.trim();\n+        String[] split = EQUALS_PATTERN.split(forwardedValues, 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ee612c5aa6d6225c35a224a66e30a152c98739c"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyNTQ5MA==", "bodyText": "Out of curiosity, what do you think about this? I noticed the lines of code are very close to what we have right now even though we define a helper method.\nint forIndex = forwarded.indexOf(\"for=\");\nint endIndex = findForwardedEnd(forwarded, forIndex + 4);\nforwarded.substring(forIndex + 4, endIndex);\n\nint find forwardedEnd(String s, int start) {\n  for (int i = start; i < s.length(); i++) {\n    char c = s.charAt(i);\n    if (c == ',' || c == ';') {\n      return i;\n    }\n  }\n  return s.length()", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462025490", "createdAt": "2020-07-29T04:05:37Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +205,48 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      // may be split by ; or ,\n+      for (String forwardedValues : FORWARDED_SPLIT_PATTERN.split(forwarded)) {\n+        forwardedValues = forwardedValues.trim();\n+        String[] split = EQUALS_PATTERN.split(forwardedValues, 2);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxNjA5OQ=="}, "originalCommit": {"oid": "2ee612c5aa6d6225c35a224a66e30a152c98739c"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0NzA2Mg==", "bodyText": "@anuraaga this would work for regular cases but would not catch a malformed header such as \"for=, for=1.1.1.1\" That's probably okay though. I will use your implementation.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462047062", "createdAt": "2020-07-29T05:28:48Z", "author": {"login": "FrankSpitulski"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +205,48 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      // may be split by ; or ,\n+      for (String forwardedValues : FORWARDED_SPLIT_PATTERN.split(forwarded)) {\n+        forwardedValues = forwardedValues.trim();\n+        String[] split = EQUALS_PATTERN.split(forwardedValues, 2);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxNjA5OQ=="}, "originalCommit": {"oid": "2ee612c5aa6d6225c35a224a66e30a152c98739c"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODA4MjUyOnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMToxMTo0NlrOG5KXeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDoyOToxMlrOG5Oz2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5MTg2Ng==", "bodyText": "Can you add unit test for this method (to mitigate against the extra complexity we asked for \ud83d\ude04)?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462591866", "createdAt": "2020-07-29T21:11:46Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,59 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      forwarded = extractForwardedFor(forwarded);\n+      if (forwarded != null) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      int endIndex = forwarded.indexOf(',');\n+      if (endIndex > 0) {\n+        forwarded = forwarded.substring(0, endIndex);\n+      }\n+      if (!forwarded.isEmpty()) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // fallback to peer IP if there are no proxy headers\n+    return peerHostIP(connection);\n+  }\n+\n+  private static String extractForwardedFor(String forwarded) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eddbad4b7a4e00fe62587b74a1f5e3700119617"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY0Nzk4NQ==", "bodyText": "added tests, caught an edge case", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462647985", "createdAt": "2020-07-29T23:32:06Z", "author": {"login": "FrankSpitulski"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,59 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      forwarded = extractForwardedFor(forwarded);\n+      if (forwarded != null) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      int endIndex = forwarded.indexOf(',');\n+      if (endIndex > 0) {\n+        forwarded = forwarded.substring(0, endIndex);\n+      }\n+      if (!forwarded.isEmpty()) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // fallback to peer IP if there are no proxy headers\n+    return peerHostIP(connection);\n+  }\n+\n+  private static String extractForwardedFor(String forwarded) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5MTg2Ng=="}, "originalCommit": {"oid": "3eddbad4b7a4e00fe62587b74a1f5e3700119617"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2NDY2NA==", "bodyText": "getting another issue with latestDepTest though.\n./gradlew :instrumentation:grpc-1.5:latestDepTest fails\n./gradlew :instrumentation:grpc-1.5:test works", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462664664", "createdAt": "2020-07-30T00:29:12Z", "author": {"login": "FrankSpitulski"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,59 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      forwarded = extractForwardedFor(forwarded);\n+      if (forwarded != null) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      int endIndex = forwarded.indexOf(',');\n+      if (endIndex > 0) {\n+        forwarded = forwarded.substring(0, endIndex);\n+      }\n+      if (!forwarded.isEmpty()) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // fallback to peer IP if there are no proxy headers\n+    return peerHostIP(connection);\n+  }\n+\n+  private static String extractForwardedFor(String forwarded) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5MTg2Ng=="}, "originalCommit": {"oid": "3eddbad4b7a4e00fe62587b74a1f5e3700119617"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODU3ODI2OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDozODo0MFrOG5O-Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjowMzowMVrOG5QY8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2NzMzOQ==", "bodyText": "Since the spec seems to use lowercase, and it's not a commonly used header anyways, I probably wouldn't be so permissive and just not do the toLowerCase but it's ok too. From what I can tell, we consider it unimportant enough to not have unit tests :P", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462667339", "createdAt": "2020-07-30T00:38:40Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,63 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      forwarded = extractForwardedFor(forwarded);\n+      if (forwarded != null) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      int endIndex = forwarded.indexOf(',');\n+      if (endIndex > 0) {\n+        forwarded = forwarded.substring(0, endIndex);\n+      }\n+      if (!forwarded.isEmpty()) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // fallback to peer IP if there are no proxy headers\n+    return peerHostIP(connection);\n+  }\n+\n+  // VisibleForTesting\n+  static String extractForwardedFor(String forwarded) {\n+    int start = forwarded.toLowerCase().indexOf(\"for=\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6ce87ff1410f21df72a561d814623bcc08a0c46"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY4MDQ2MQ==", "bodyText": "the mozilla spec says it can be any case, so I just stuck that in there. I've never seen it used in practice but it's apparently the standard.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462680461", "createdAt": "2020-07-30T01:28:13Z", "author": {"login": "FrankSpitulski"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,63 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      forwarded = extractForwardedFor(forwarded);\n+      if (forwarded != null) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      int endIndex = forwarded.indexOf(',');\n+      if (endIndex > 0) {\n+        forwarded = forwarded.substring(0, endIndex);\n+      }\n+      if (!forwarded.isEmpty()) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // fallback to peer IP if there are no proxy headers\n+    return peerHostIP(connection);\n+  }\n+\n+  // VisibleForTesting\n+  static String extractForwardedFor(String forwarded) {\n+    int start = forwarded.toLowerCase().indexOf(\"for=\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2NzMzOQ=="}, "originalCommit": {"oid": "f6ce87ff1410f21df72a561d814623bcc08a0c46"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY4MDc5Mw==", "bodyText": "there's an uppercase example in the RFC https://tools.ietf.org/html/rfc7239#section-4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462680793", "createdAt": "2020-07-30T01:29:18Z", "author": {"login": "FrankSpitulski"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,63 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      forwarded = extractForwardedFor(forwarded);\n+      if (forwarded != null) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      int endIndex = forwarded.indexOf(',');\n+      if (endIndex > 0) {\n+        forwarded = forwarded.substring(0, endIndex);\n+      }\n+      if (!forwarded.isEmpty()) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // fallback to peer IP if there are no proxy headers\n+    return peerHostIP(connection);\n+  }\n+\n+  // VisibleForTesting\n+  static String extractForwardedFor(String forwarded) {\n+    int start = forwarded.toLowerCase().indexOf(\"for=\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2NzMzOQ=="}, "originalCommit": {"oid": "f6ce87ff1410f21df72a561d814623bcc08a0c46"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY4MTM2Mw==", "bodyText": "Ah thanks I couldn't find it, in that case can we add one test case for it?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462681363", "createdAt": "2020-07-30T01:31:18Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,63 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      forwarded = extractForwardedFor(forwarded);\n+      if (forwarded != null) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      int endIndex = forwarded.indexOf(',');\n+      if (endIndex > 0) {\n+        forwarded = forwarded.substring(0, endIndex);\n+      }\n+      if (!forwarded.isEmpty()) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // fallback to peer IP if there are no proxy headers\n+    return peerHostIP(connection);\n+  }\n+\n+  // VisibleForTesting\n+  static String extractForwardedFor(String forwarded) {\n+    int start = forwarded.toLowerCase().indexOf(\"for=\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2NzMzOQ=="}, "originalCommit": {"oid": "f6ce87ff1410f21df72a561d814623bcc08a0c46"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5MDU0Ng==", "bodyText": "sure, added", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/827#discussion_r462690546", "createdAt": "2020-07-30T02:03:01Z", "author": {"login": "FrankSpitulski"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/HttpServerTracer.java", "diffHunk": "@@ -195,6 +201,63 @@ protected void onRequest(final Span span, final REQUEST request) {\n     // TODO set resource name from URL.\n   }\n \n+  protected void onConnectionAndRequest(Span span, CONNECTION connection, REQUEST request) {\n+    String flavor = flavor(connection, request);\n+    if (flavor != null) {\n+      SemanticAttributes.HTTP_FLAVOR.set(span, flavor);\n+    }\n+    SemanticAttributes.HTTP_CLIENT_IP.set(span, clientIP(connection, request));\n+  }\n+\n+  protected String clientIP(CONNECTION connection, REQUEST request) {\n+    // try Forwarded\n+    String forwarded = requestHeader(request, \"Forwarded\");\n+    if (forwarded != null) {\n+      forwarded = extractForwardedFor(forwarded);\n+      if (forwarded != null) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // try X-Forwarded-For\n+    forwarded = requestHeader(request, \"X-Forwarded-For\");\n+    if (forwarded != null) {\n+      // may be split by ,\n+      int endIndex = forwarded.indexOf(',');\n+      if (endIndex > 0) {\n+        forwarded = forwarded.substring(0, endIndex);\n+      }\n+      if (!forwarded.isEmpty()) {\n+        return forwarded;\n+      }\n+    }\n+\n+    // fallback to peer IP if there are no proxy headers\n+    return peerHostIP(connection);\n+  }\n+\n+  // VisibleForTesting\n+  static String extractForwardedFor(String forwarded) {\n+    int start = forwarded.toLowerCase().indexOf(\"for=\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2NzMzOQ=="}, "originalCommit": {"oid": "f6ce87ff1410f21df72a561d814623bcc08a0c46"}, "originalPosition": 70}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 174, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}