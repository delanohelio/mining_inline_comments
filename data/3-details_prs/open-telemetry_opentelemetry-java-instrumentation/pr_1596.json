{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NDU2MjQz", "number": 1596, "title": "Update ByteBuddy to 1.10.18, adjust to new ByteBuddy gradle plugin", "bodyText": "Updating to ByteBuddy 1.10.18. The motivation is to include the following fix for WebLogic Server:\nraphw/byte-buddy#965\nIn version 1.10.15, ByteBuddy changed how the Gradle plugin works. It is now automatically configured in a way which is incompatible with the current use case, therefore I configure the transformation task from the plugin manually. The specifics are included as comments for the new buildSrc classes, but I will include them in the decription as well:\nByteBuddyPluginConfigurator:\nStarting from version 1.10.15, ByteBuddy gradle plugin transformation task autoconfiguration is hardcoded to be applied to javaCompile task. This causes the dependencies to be resolved during an afterEvaluate that runs before any afterEvaluate specified in the build script, which in turn makes it impossible to add dependencies in afterEvaluate. Additionally the autoconfiguration will attempt to scan the entire project for tasks which depend on the compile task, to make each task that depends on compile also depend on the transformation task. This is an extremely inefficient operation in this project to the point of causing a stack overflow in some environments.\nTo avoid all the issues with autoconfiguration, this class manually configures the ByteBuddy transformation task. This also allows it to be applied to source languages other than Java. The transformation task is configured to run between the compile and the classes tasks, assuming no other task depends directly on the compile task, but instead other tasks depend on classes task. Contrary to how the ByteBuddy plugin worked in versions up to 1.10.14, this changes the compile task output directory, as starting from 1.10.15, the plugin does not allow the source and target directories to be the same. The transformation task then writes to the original output directory of the compile task.\nClasspathByteBuddyPlugin:\nStarting from version 1.10.15, ByteBuddy gradle plugin transformations require that plugin classes are given as class instances instead of a class name string. To be able to still use a plugin implementation that is not a buildscript dependency, this reimplements the previous logic by taking a delegate class name and class path as arguments and loading the plugin class from the provided classloader when the plugin is instantiated.\nManually verified that the shadowJar that is built includes the transformed classes.", "createdAt": "2020-11-09T04:21:56Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1596", "merged": true, "mergeCommit": {"oid": "995e2caee0e34ab51af9dd1d4cd631b02843af75"}, "closed": true, "closedAt": "2020-11-12T10:34:07Z", "author": {"login": "agoallikmaa"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdasT0OAH2gAyNTE3NDU2MjQzOjJhZTVmOThkNjlmODc4ZTkwZTBkMzIzNDY2YmMxZTU1YjY3NTdmYTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbwCmAAFqTUyODk1MTM1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2ae5f98d69f878e90e0d323466bc1e55b6757fa1", "author": {"user": {"login": "agoallikmaa", "name": "Ago Allikmaa"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/2ae5f98d69f878e90e0d323466bc1e55b6757fa1", "committedDate": "2020-11-09T03:36:44Z", "message": "Adjust for use with ByteBuddy 1.10.18"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1e686d52429233e7a80ee6f0a16c9e5238095e9", "author": {"user": {"login": "agoallikmaa", "name": "Ago Allikmaa"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c1e686d52429233e7a80ee6f0a16c9e5238095e9", "committedDate": "2020-11-09T03:40:16Z", "message": "Fix language choices for ByteBuddy transformation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MTk3NTAz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1596#pullrequestreview-527197503", "createdAt": "2020-11-10T13:26:03Z", "commit": {"oid": "c1e686d52429233e7a80ee6f0a16c9e5238095e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MTkzMDMx", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1596#pullrequestreview-528193031", "createdAt": "2020-11-11T13:57:09Z", "commit": {"oid": "c1e686d52429233e7a80ee6f0a16c9e5238095e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMzo1NzowOVrOHxONcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMzo1NzowOVrOHxONcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM3NTA4OA==", "bodyText": "Can we remove this NoOp class if it's no longer used?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1596#discussion_r521375088", "createdAt": "2020-11-11T13:57:09Z", "author": {"login": "mateuszrzeszutek"}, "path": "gradle/instrumentation.gradle", "diffHunk": "@@ -9,14 +10,6 @@ ext {\n   mavenGroupId = 'io.opentelemetry.javaagent.instrumentation'\n }\n \n-byteBuddy {\n-  transformation {\n-    // Applying NoOp optimizes build by applying bytebuddy plugin to only compileJava task\n-    tasks = ['compileJava', 'compileScala', 'compileKotlin']\n-    plugin = 'io.opentelemetry.javaagent.tooling.muzzle.collector.MuzzleCodeGenerationPlugin$NoOp'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1e686d52429233e7a80ee6f0a16c9e5238095e9"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4Nzk5NDE3", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1596#pullrequestreview-528799417", "createdAt": "2020-11-12T07:10:48Z", "commit": {"oid": "c1e686d52429233e7a80ee6f0a16c9e5238095e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06ca9d88ee1fa347e485dd747d749c87db26625f", "author": {"user": {"login": "agoallikmaa", "name": "Ago Allikmaa"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/06ca9d88ee1fa347e485dd747d749c87db26625f", "committedDate": "2020-11-12T08:47:03Z", "message": "Remove no longer used MuzzleCodeGenerationPlugin$NoOp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4OTUxMzU5", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1596#pullrequestreview-528951359", "createdAt": "2020-11-12T10:31:28Z", "commit": {"oid": "06ca9d88ee1fa347e485dd747d749c87db26625f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2190, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}