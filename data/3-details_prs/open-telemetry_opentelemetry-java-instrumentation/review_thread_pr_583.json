{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNDAwMzU0", "number": 583, "reviewThreads": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNjoxNzo0N1rOEJBAyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoyODozMlrOEJOgcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3ODg5MjI2OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNjoxNzo0N1rOGpU-Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDozOTo0NVrOGp5Trw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4ODQyMg==", "bodyText": "Realize it's the same as the previous pattern so optional update, we should probably set this to an unmodifaibleSet in the constructor instead of passing a mutable object around?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r445988422", "createdAt": "2020-06-26T06:17:47Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -16,53 +16,80 @@\n \n package io.opentelemetry.auto.bootstrap;\n \n+import io.opentelemetry.auto.bootstrap.instrumentation.api.Pair;\n import java.io.ByteArrayInputStream;\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.lang.ref.WeakReference;\n import java.net.URISyntaxException;\n import java.net.URL;\n import java.net.URLConnection;\n import java.net.URLStreamHandler;\n-import java.nio.file.NoSuchFileException;\n import java.security.Permission;\n import java.util.Enumeration;\n-import java.util.HashMap;\n-import java.util.Map;\n+import java.util.HashSet;\n+import java.util.Set;\n import java.util.jar.JarEntry;\n import java.util.jar.JarFile;\n import lombok.extern.slf4j.Slf4j;\n \n @Slf4j\n public class InternalJarURLHandler extends URLStreamHandler {\n-  private final Map<String, JarEntry> filenameToEntry = new HashMap<>();\n-  private JarFile bootstrapJarFile;\n+\n+  private static final WeakReference<Pair<String, JarEntry>> NULL = new WeakReference<>(null);\n+\n+  private final String name;\n+  private final FileNotInInternalJar notFound;\n+  private final Set<String> packages = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNDcwOA==", "bodyText": "This is only used within a very narrow context where (in the Datadog codebase, at least) we will not mutate the set once it's built, making the unmodifiable wrapper a pointless cost. If we wanted to present a view of this set to untrusted callers, we would have wrapped it.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446024708", "createdAt": "2020-06-26T07:50:19Z", "author": {"login": "richardstartin"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -16,53 +16,80 @@\n \n package io.opentelemetry.auto.bootstrap;\n \n+import io.opentelemetry.auto.bootstrap.instrumentation.api.Pair;\n import java.io.ByteArrayInputStream;\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.lang.ref.WeakReference;\n import java.net.URISyntaxException;\n import java.net.URL;\n import java.net.URLConnection;\n import java.net.URLStreamHandler;\n-import java.nio.file.NoSuchFileException;\n import java.security.Permission;\n import java.util.Enumeration;\n-import java.util.HashMap;\n-import java.util.Map;\n+import java.util.HashSet;\n+import java.util.Set;\n import java.util.jar.JarEntry;\n import java.util.jar.JarFile;\n import lombok.extern.slf4j.Slf4j;\n \n @Slf4j\n public class InternalJarURLHandler extends URLStreamHandler {\n-  private final Map<String, JarEntry> filenameToEntry = new HashMap<>();\n-  private JarFile bootstrapJarFile;\n+\n+  private static final WeakReference<Pair<String, JarEntry>> NULL = new WeakReference<>(null);\n+\n+  private final String name;\n+  private final FileNotInInternalJar notFound;\n+  private final Set<String> packages = new HashSet<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4ODQyMg=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAzNjQ5MA==", "bodyText": "Note that in this fork, you're not actually using the set at all, so I recommend just removing it and saving a bit of space.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446036490", "createdAt": "2020-06-26T08:14:56Z", "author": {"login": "richardstartin"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -16,53 +16,80 @@\n \n package io.opentelemetry.auto.bootstrap;\n \n+import io.opentelemetry.auto.bootstrap.instrumentation.api.Pair;\n import java.io.ByteArrayInputStream;\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.lang.ref.WeakReference;\n import java.net.URISyntaxException;\n import java.net.URL;\n import java.net.URLConnection;\n import java.net.URLStreamHandler;\n-import java.nio.file.NoSuchFileException;\n import java.security.Permission;\n import java.util.Enumeration;\n-import java.util.HashMap;\n-import java.util.Map;\n+import java.util.HashSet;\n+import java.util.Set;\n import java.util.jar.JarEntry;\n import java.util.jar.JarFile;\n import lombok.extern.slf4j.Slf4j;\n \n @Slf4j\n public class InternalJarURLHandler extends URLStreamHandler {\n-  private final Map<String, JarEntry> filenameToEntry = new HashMap<>();\n-  private JarFile bootstrapJarFile;\n+\n+  private static final WeakReference<Pair<String, JarEntry>> NULL = new WeakReference<>(null);\n+\n+  private final String name;\n+  private final FileNotInInternalJar notFound;\n+  private final Set<String> packages = new HashSet<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4ODQyMg=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MzcyNw==", "bodyText": "thx! removed", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446583727", "createdAt": "2020-06-28T00:39:45Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -16,53 +16,80 @@\n \n package io.opentelemetry.auto.bootstrap;\n \n+import io.opentelemetry.auto.bootstrap.instrumentation.api.Pair;\n import java.io.ByteArrayInputStream;\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.lang.ref.WeakReference;\n import java.net.URISyntaxException;\n import java.net.URL;\n import java.net.URLConnection;\n import java.net.URLStreamHandler;\n-import java.nio.file.NoSuchFileException;\n import java.security.Permission;\n import java.util.Enumeration;\n-import java.util.HashMap;\n-import java.util.Map;\n+import java.util.HashSet;\n+import java.util.Set;\n import java.util.jar.JarEntry;\n import java.util.jar.JarFile;\n import lombok.extern.slf4j.Slf4j;\n \n @Slf4j\n public class InternalJarURLHandler extends URLStreamHandler {\n-  private final Map<String, JarEntry> filenameToEntry = new HashMap<>();\n-  private JarFile bootstrapJarFile;\n+\n+  private static final WeakReference<Pair<String, JarEntry>> NULL = new WeakReference<>(null);\n+\n+  private final String name;\n+  private final FileNotInInternalJar notFound;\n+  private final Set<String> packages = new HashSet<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4ODQyMg=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3ODg5OTQ3OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNjoyMTo0NlrOGpVCxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNzoyMDo1MVrOGqHyIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4OTU3NA==", "bodyText": "Just curious, is it possible for this class to be accessed from multiple threads? I wonder how many, if there are a lot of copies of this buffer, it's unfortunate they all get stuck in memory after classloading is done sort of lean towards not using a threadlocal for it, string seems pretty small.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r445989574", "createdAt": "2020-06-26T06:21:46Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -75,12 +102,32 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      StringBuilder sb = JAR_ENTRY_QUERY.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MDMxOQ==", "bodyText": "it will come here from any thread that triggers class loading for AgentClassLoader, so likely not too many different threads, as the various instrumentation classes will only be loaded the first time they are used\nwe could do ThreadLocal<WeakReference<StringBuilder>>, but that wouldn't get it out of the ThreadLocal map, which is also nice to reduce collisions\nso maybe WeakReference<ThreadLocal<StringBuilder>>?\n(i'm also ok with no change here)\n@richardstartin wdyt?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446580319", "createdAt": "2020-06-27T23:53:53Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -75,12 +102,32 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      StringBuilder sb = JAR_ENTRY_QUERY.get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4OTU3NA=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU5MTY5Ng==", "bodyText": "I sort of lean towards not using the threadlocal optimization for these small strings and let it all be garbage that can be collected, over the complexity of weak references, since I suspect this is a tiny part of the optimization in the attached PR.\nBut if we're only leaking a few hundred bytes it's not so bad either.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446591696", "createdAt": "2020-06-28T02:41:17Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -75,12 +102,32 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      StringBuilder sb = JAR_ENTRY_QUERY.get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4OTU3NA=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYzMTQ2OQ==", "bodyText": "@trask actually this was an insurance policy against there ever being more than one thread accessing the variable. We haven't seen any negative consequences in our benchmarks, but I think it's a question of \"take it or leave it\" - if it doesn't look right to you, please just change it.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446631469", "createdAt": "2020-06-28T10:21:02Z", "author": {"login": "richardstartin"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -75,12 +102,32 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      StringBuilder sb = JAR_ENTRY_QUERY.get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4OTU3NA=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgyMDg5Nw==", "bodyText": "removed the ThreadLocal<StringBuilder>", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446820897", "createdAt": "2020-06-29T07:20:51Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -75,12 +102,32 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      StringBuilder sb = JAR_ENTRY_QUERY.get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk4OTU3NA=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3ODkwNTIwOnYy", "diffSide": "RIGHT", "path": "benchmark-integration/jetty-perftest/jetty-perftest.gradle", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNjoyNDo1MFrOGpVGfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDo0MToxNVrOGp5ULA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk5MDUyNg==", "bodyText": "Intended?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r445990526", "createdAt": "2020-06-26T06:24:50Z", "author": {"login": "anuraaga"}, "path": "benchmark-integration/jetty-perftest/jetty-perftest.gradle", "diffHunk": "@@ -10,6 +10,6 @@ jar {\n   manifest {\n     attributes(\n       \"Main-Class\": \"io.opentelemetry.perftest.jetty.JettyPerftest\"\n-    )\n+      )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1MDgyMw==", "bodyText": "unfortunate side effect of the new formatting.  If you know of better settings to make it better align with how intellij does it, please let me know.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446350823", "createdAt": "2020-06-26T18:43:17Z", "author": {"login": "tylerbenson"}, "path": "benchmark-integration/jetty-perftest/jetty-perftest.gradle", "diffHunk": "@@ -10,6 +10,6 @@ jar {\n   manifest {\n     attributes(\n       \"Main-Class\": \"io.opentelemetry.perftest.jetty.JettyPerftest\"\n-    )\n+      )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk5MDUyNg=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4Mzg1Mg==", "bodyText": "reverted auto-formatting of gradle files for now", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446583852", "createdAt": "2020-06-28T00:41:15Z", "author": {"login": "trask"}, "path": "benchmark-integration/jetty-perftest/jetty-perftest.gradle", "diffHunk": "@@ -10,6 +10,6 @@ jar {\n   manifest {\n     attributes(\n       \"Main-Class\": \"io.opentelemetry.perftest.jetty.JettyPerftest\"\n-    )\n+      )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk5MDUyNg=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3ODkwNjIyOnYy", "diffSide": "RIGHT", "path": "gradle.properties", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNjoyNToxNFrOGpVHEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNjoyNToxNFrOGpVHEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk5MDY3NA==", "bodyText": "Yay", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r445990674", "createdAt": "2020-06-26T06:25:14Z", "author": {"login": "anuraaga"}, "path": "gradle.properties", "diffHunk": "@@ -1 +1,4 @@\n+org.gradle.parallel=true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3ODkxNjgzOnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNjozMDoxNFrOGpVNgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDo0MToyN1rOGp5UMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk5MjMyMw==", "bodyText": "This is because this is a performance optimization, not for correctness, I'm presuming", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r445992323", "createdAt": "2020-06-26T06:30:14Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -75,12 +102,32 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      StringBuilder sb = JAR_ENTRY_QUERY.get();\n+      sb.append(this.name).append(filename);\n+      if (filename.endsWith(\".class\")) {\n+        sb.append(\"data\");\n+      }\n+      String classFileName = sb.toString();\n+      sb.setLength(0);\n+      JarEntry entry = bootstrapJarFile.getJarEntry(classFileName);\n+      if (null != entry) {\n+        pair = Pair.of(filename, entry);\n+        // this mechanism intentionally does not ensure visibility of this write, because it doesn't", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyMzQ4Mg==", "bodyText": "Reference assignment is atomic so this cannot lead to inconsistency.\nIf some other thread doesn't see the write, they just see another instance or null, and may or may not do extra work.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446023482", "createdAt": "2020-06-26T07:47:46Z", "author": {"login": "richardstartin"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -75,12 +102,32 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      StringBuilder sb = JAR_ENTRY_QUERY.get();\n+      sb.append(this.name).append(filename);\n+      if (filename.endsWith(\".class\")) {\n+        sb.append(\"data\");\n+      }\n+      String classFileName = sb.toString();\n+      sb.setLength(0);\n+      JarEntry entry = bootstrapJarFile.getJarEntry(classFileName);\n+      if (null != entry) {\n+        pair = Pair.of(filename, entry);\n+        // this mechanism intentionally does not ensure visibility of this write, because it doesn't", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk5MjMyMw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNTAwOA==", "bodyText": "may or may not do extra work.\n\nSo the answer is yes :) I think the comment can be more self-explantory by talking about the motivation instead of the detail\n// This is a performance optimization, so in the rare event this write is not visible to another thread, it just means the same work is recomputed but does not affect consistency.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446025008", "createdAt": "2020-06-26T07:50:55Z", "author": {"login": "anuraaga"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -75,12 +102,32 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      StringBuilder sb = JAR_ENTRY_QUERY.get();\n+      sb.append(this.name).append(filename);\n+      if (filename.endsWith(\".class\")) {\n+        sb.append(\"data\");\n+      }\n+      String classFileName = sb.toString();\n+      sb.setLength(0);\n+      JarEntry entry = bootstrapJarFile.getJarEntry(classFileName);\n+      if (null != entry) {\n+        pair = Pair.of(filename, entry);\n+        // this mechanism intentionally does not ensure visibility of this write, because it doesn't", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk5MjMyMw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4Mzg1OA==", "bodyText": "updated comment", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446583858", "createdAt": "2020-06-28T00:41:27Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -75,12 +102,32 @@ protected URLConnection openConnection(final URL url) throws IOException {\n       // nullInputStream() is not available until Java 11\n       return new InternalJarURLConnection(url, new ByteArrayInputStream(new byte[0]));\n     }\n-    final JarEntry entry = filenameToEntry.get(filename);\n-    if (null != entry) {\n-      return new InternalJarURLConnection(url, bootstrapJarFile.getInputStream(entry));\n+    // believe it or not, we're going to get called twice for this,\n+    // and the key will be a new object each time.\n+    Pair<String, JarEntry> pair = cache.get();\n+    if (null == pair || !filename.equals(pair.getLeft())) {\n+      StringBuilder sb = JAR_ENTRY_QUERY.get();\n+      sb.append(this.name).append(filename);\n+      if (filename.endsWith(\".class\")) {\n+        sb.append(\"data\");\n+      }\n+      String classFileName = sb.toString();\n+      sb.setLength(0);\n+      JarEntry entry = bootstrapJarFile.getJarEntry(classFileName);\n+      if (null != entry) {\n+        pair = Pair.of(filename, entry);\n+        // this mechanism intentionally does not ensure visibility of this write, because it doesn't", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk5MjMyMw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTAzMDkzOnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODowMjo1NlrOGpp-_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QyMjo1Njo0NVrOGp42lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMjY2OQ==", "bodyText": "If I understand correctly, all these changes to this class are performance optimisations, no? Is there any benchmark or, even better, a real use-case, which demonstrate the benefit of this?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446332669", "createdAt": "2020-06-26T18:02:56Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -16,53 +16,80 @@\n \n package io.opentelemetry.auto.bootstrap;\n \n+import io.opentelemetry.auto.bootstrap.instrumentation.api.Pair;\n import java.io.ByteArrayInputStream;\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.lang.ref.WeakReference;\n import java.net.URISyntaxException;\n import java.net.URL;\n import java.net.URLConnection;\n import java.net.URLStreamHandler;\n-import java.nio.file.NoSuchFileException;\n import java.security.Permission;\n import java.util.Enumeration;\n-import java.util.HashMap;\n-import java.util.Map;\n+import java.util.HashSet;\n+import java.util.Set;\n import java.util.jar.JarEntry;\n import java.util.jar.JarFile;\n import lombok.extern.slf4j.Slf4j;\n \n @Slf4j\n public class InternalJarURLHandler extends URLStreamHandler {\n-  private final Map<String, JarEntry> filenameToEntry = new HashMap<>();\n-  private JarFile bootstrapJarFile;\n+\n+  private static final WeakReference<Pair<String, JarEntry>> NULL = new WeakReference<>(null);\n+\n+  private final String name;\n+  private final FileNotInInternalJar notFound;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU3NjI3Nw==", "bodyText": "see DataDog/dd-trace-java#1598", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446576277", "createdAt": "2020-06-27T22:56:45Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/InternalJarURLHandler.java", "diffHunk": "@@ -16,53 +16,80 @@\n \n package io.opentelemetry.auto.bootstrap;\n \n+import io.opentelemetry.auto.bootstrap.instrumentation.api.Pair;\n import java.io.ByteArrayInputStream;\n import java.io.File;\n import java.io.IOException;\n import java.io.InputStream;\n+import java.lang.ref.WeakReference;\n import java.net.URISyntaxException;\n import java.net.URL;\n import java.net.URLConnection;\n import java.net.URLStreamHandler;\n-import java.nio.file.NoSuchFileException;\n import java.security.Permission;\n import java.util.Enumeration;\n-import java.util.HashMap;\n-import java.util.Map;\n+import java.util.HashSet;\n+import java.util.Set;\n import java.util.jar.JarEntry;\n import java.util.jar.JarFile;\n import lombok.extern.slf4j.Slf4j;\n \n @Slf4j\n public class InternalJarURLHandler extends URLStreamHandler {\n-  private final Map<String, JarEntry> filenameToEntry = new HashMap<>();\n-  private JarFile bootstrapJarFile;\n+\n+  private static final WeakReference<Pair<String, JarEntry>> NULL = new WeakReference<>(null);\n+\n+  private final String name;\n+  private final FileNotInInternalJar notFound;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMjY2OQ=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTAzNTk1OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "isResolved": true, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODowNDo0NFrOGpqCHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNTowODo0NlrOGqE-ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzQ3MQ==", "bodyText": "Don't understand, what does this test do exactly?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446333471", "createdAt": "2020-06-26T18:04:44Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MDM2Ng==", "bodyText": "i updated the comment to explain a bit more", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446580366", "createdAt": "2020-06-27T23:54:36Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzQ3MQ=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY1MDQ0MA==", "bodyText": "Still don't understand :( Why we should specifically test that we can read class on our second attempt? How does second attempt differ from the first or the third one?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446650440", "createdAt": "2020-06-28T13:21:33Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzQ3MQ=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY4MjA1Mg==", "bodyText": "@iNikem I'm going to assume that you are keeping an open mind here so I will try to explain :).\nThere are two reasons related to a caching mechanism:\n\nConstrain what is cached: I wanted to test that a load does not cache the stream after releasing it and losing control over its lifecyle. What's special about the second load which makes it distinct from the first load is that there was a predecessor.  There is a caching mechanism in place, (the JarEntry is cached with the class name), but what if someone comes along later and tried to cache something closeable like the stream instead? That would be unfortunate, but this test would break if that ever happened.\nHitting the branch where caching has occurred: there happen to be about 800 classloads early on which go all the way down the chain and end up in the leaf-level classloader twice. Preventing this from happening would have been a much more invasive change than mitigating it with a cache. Unless you test the load twice, you won't test the branch where the cache is hit. The logic actually dismisses the cache after a hit, based on knowledge of this pattern, making the third load indistinguishable from the first load, hence the lack of a test for it. Good question though.\n\nDoes that make sense? :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446682052", "createdAt": "2020-06-28T18:23:28Z", "author": {"login": "richardstartin"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzQ3MQ=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY4NDUxNQ==", "bodyText": "Great, this explanation does make sense :) What is now missing, is this (or abridged) explanation in the test itself :) For that poor developer who will try to understand this test half a year in the future.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446684515", "createdAt": "2020-06-28T18:48:42Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzQ3MQ=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY4NDgyMQ==", "bodyText": "thx @richardstartin! @iNikem i will add this explanation to the test \ud83d\udc4d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446684821", "createdAt": "2020-06-28T18:51:29Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzQ3MQ=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY4NzE4OQ==", "bodyText": "@iNikem I would love to live in a world where each and every test I'm unfamiliar with happens to have a nice two paragraph explanation attached and I never need to go and take a look at the system under test, but it's not the kind of luxury I've experienced myself.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446687189", "createdAt": "2020-06-28T19:13:59Z", "author": {"login": "richardstartin"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzQ3MQ=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY4OTYwMA==", "bodyText": "If our world is not ideal, it does not mean we should not try to make it a better place. I hope you are not saying \u201cThere are a lot of bad code out there, why bother writing good one?\u201d :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446689600", "createdAt": "2020-06-28T19:38:43Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzQ3MQ=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY5MzA0MQ==", "bodyText": "hm, i don't think that's what @richardstartin was saying. but anyways, i think we're good here. i will add the (very nice) comment to this test.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446693041", "createdAt": "2020-06-28T20:14:26Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzQ3MQ=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3NDk3MA==", "bodyText": "comment added \ud83d\udc4d", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446774970", "createdAt": "2020-06-29T05:08:46Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzQ3MQ=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTAzODIzOnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODowNTozNVrOGpqDig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDo0OTozM1rOGp5WNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzgzNA==", "bodyText": "Why do you want to test several non-existent paths here? Why 1 is not enough?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446333834", "createdAt": "2020-06-26T18:05:35Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {\n+    // guards against caching the stream\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    InputStream is = connection.getInputStream()\n+    is.close()\n+    connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    is = connection.getInputStream()\n+    byte[] data = new byte[128]\n+    int read = is.read(data)\n+\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+  def \"handle not found\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    handler.openConnection(new File(file).toURI().toURL())\n+    then:\n+    // not going to specify (and thereby constrain) the sub type because it doesn't matter\n+    thrown IOException\n+\n+    // permuted\n+    where:\n+    dir      | file", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NDM3Mw==", "bodyText": "updated", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446584373", "createdAt": "2020-06-28T00:49:33Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/test/groovy/io/opentelemetry/auto/bootstrap/InternalJarURLHandlerTest.groovy", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package datadog.trace.bootstrap\n+\n+import io.opentelemetry.auto.bootstrap.InternalJarURLHandler\n+import io.opentelemetry.auto.util.test.AgentSpecification\n+import spock.lang.Shared\n+\n+class InternalJarURLHandlerTest extends AgentSpecification {\n+\n+  @Shared\n+  URL testJarLocation = new File(\"src/test/resources/classloader-test-jar/testjar-jdk8\").toURI().toURL()\n+\n+\n+  def \"test extract packages\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    expect:\n+    packages == handler.getPackages()\n+\n+    where:\n+    dir      | packages\n+    \"parent\" | ['a', 'a.b', 'a.b.c'].toSet()\n+    \"child\"  | ['x', 'x.y', 'x.y.z'].toSet()\n+  }\n+\n+  def \"test get URL\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    byte[] data = new byte[128]\n+    int read = connection.getInputStream().read(data)\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+\n+  def \"test read class twice\"() {\n+    // guards against caching the stream\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    URLConnection connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    InputStream is = connection.getInputStream()\n+    is.close()\n+    connection = handler.openConnection(new URL('file://' + file))\n+    assert connection != null\n+    is = connection.getInputStream()\n+    byte[] data = new byte[128]\n+    int read = is.read(data)\n+\n+    then:\n+    read > 0\n+\n+    where:\n+    dir      | file\n+    \"parent\" | '/a/A.class'\n+    \"parent\" | '/a/b/B.class'\n+    \"parent\" | '/a/b/c/C.class'\n+    \"child\"  | '/x/X.class'\n+    \"child\"  | '/x/y/Y.class'\n+    \"child\"  | '/x/y/z/Z.class'\n+  }\n+\n+  def \"handle not found\"() {\n+    setup:\n+    InternalJarURLHandler handler = new InternalJarURLHandler(dir, testJarLocation)\n+    when:\n+    handler.openConnection(new File(file).toURI().toURL())\n+    then:\n+    // not going to specify (and thereby constrain) the sub type because it doesn't matter\n+    thrown IOException\n+\n+    // permuted\n+    where:\n+    dir      | file", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzMzgzNA=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA0MTUzOnYy", "diffSide": "RIGHT", "path": "agent-tooling/src/main/java/io/opentelemetry/auto/tooling/matcher/AdditionalLibraryIgnoresMatcher.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODowNjozNVrOGpqFZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNToyMjozMVrOGqFL5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNDMxMA==", "bodyText": "I would love to see some explanations, why these class loaders in particular are listed.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446334310", "createdAt": "2020-06-26T18:06:35Z", "author": {"login": "iNikem"}, "path": "agent-tooling/src/main/java/io/opentelemetry/auto/tooling/matcher/AdditionalLibraryIgnoresMatcher.java", "diffHunk": "@@ -116,7 +116,11 @@ public boolean matches(final T target) {\n             || name.startsWith(\n                 \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainer$\")\n             || name.equals(\n-                \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader\")) {\n+                \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc3ODM0Mg==", "bodyText": "this was not changed in this PR, but class loaders are listed in here so that java-classloader instrumentation will not be skipped. the way these are caught and added here is that AgentTestRunner does not use AdditionalLibraryIgnoresMatcher, and then it validates that there are no classes that were instrumented that would have been skipped by AdditionalLibraryIgnoresMatcher, and so the test fails, and then you add suppress the class from being skipped in here", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446778342", "createdAt": "2020-06-29T05:22:31Z", "author": {"login": "trask"}, "path": "agent-tooling/src/main/java/io/opentelemetry/auto/tooling/matcher/AdditionalLibraryIgnoresMatcher.java", "diffHunk": "@@ -116,7 +116,11 @@ public boolean matches(final T target) {\n             || name.startsWith(\n                 \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainer$\")\n             || name.equals(\n-                \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader\")) {\n+                \"org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedWebappClassLoader\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNDMxMA=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA0NjQwOnYy", "diffSide": "RIGHT", "path": "agent-tooling/src/main/java/io/opentelemetry/auto/tooling/muzzle/ReferenceMatcher.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODowODoyNVrOGpqIqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDowNTowMFrOGp5JtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNTE0Ng==", "bodyText": "What is the motivation of this optimisation?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446335146", "createdAt": "2020-06-26T18:08:25Z", "author": {"login": "iNikem"}, "path": "agent-tooling/src/main/java/io/opentelemetry/auto/tooling/muzzle/ReferenceMatcher.java", "diffHunk": "@@ -293,4 +300,19 @@ private static boolean matchesPrimitive(String longName, String shortName) {\n     }\n     return null;\n   }\n+\n+  private static List<Mismatch> lazyAdd(List<Mismatch> mismatches, Mismatch mismatch) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1NTU1MQ==", "bodyText": "I suggest you review the original PR.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446355551", "createdAt": "2020-06-26T18:53:46Z", "author": {"login": "tylerbenson"}, "path": "agent-tooling/src/main/java/io/opentelemetry/auto/tooling/muzzle/ReferenceMatcher.java", "diffHunk": "@@ -293,4 +300,19 @@ private static boolean matchesPrimitive(String longName, String shortName) {\n     }\n     return null;\n   }\n+\n+  private static List<Mismatch> lazyAdd(List<Mismatch> mismatches, Mismatch mismatch) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNTE0Ng=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MTE3Mg==", "bodyText": "added comment", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446581172", "createdAt": "2020-06-28T00:05:00Z", "author": {"login": "trask"}, "path": "agent-tooling/src/main/java/io/opentelemetry/auto/tooling/muzzle/ReferenceMatcher.java", "diffHunk": "@@ -293,4 +300,19 @@ private static boolean matchesPrimitive(String longName, String shortName) {\n     }\n     return null;\n   }\n+\n+  private static List<Mismatch> lazyAdd(List<Mismatch> mismatches, Mismatch mismatch) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNTE0Ng=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 159}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA1NTk5OnYy", "diffSide": "RIGHT", "path": ".githooks/pre-commit", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxMTozNlrOGpqOjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQxMzoyODoyMVrOGp9bEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNjY1Mg==", "bodyText": "By committing this file you leave a developer without any way to configure his own pre-commit hooks. I think this is a very bad idea.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446336652", "createdAt": "2020-06-26T18:11:36Z", "author": {"login": "iNikem"}, "path": ".githooks/pre-commit", "diffHunk": "@@ -0,0 +1,14 @@\n+#!/bin/bash\n+# http://redsymbol.net/articles/unofficial-bash-strict-mode/\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+if ! ./gradlew spotlessCheck; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1NTMxNA==", "bodyText": "how do you suggest providing this kind of functionality then?  I feel if we don't provide it, 99% of people won't automatically run it before commit, get a failure in CI, have to recommit due to failures.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446355314", "createdAt": "2020-06-26T18:53:16Z", "author": {"login": "tylerbenson"}, "path": ".githooks/pre-commit", "diffHunk": "@@ -0,0 +1,14 @@\n+#!/bin/bash\n+# http://redsymbol.net/articles/unofficial-bash-strict-mode/\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+if ! ./gradlew spotlessCheck; then", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNjY1Mg=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ4MjE5Ng==", "bodyText": "We currently provide an example script and a suggestion in CONTRIBUTING to symlink it here. I think this is enough. If a developer frequently have to recommit due to formatting issues, they will remember to actually use this hook.\nI don't think we have to force all developers to use exactly one pre-commit hook blessed by us. Especially if this is \"for their benefit\".", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446482196", "createdAt": "2020-06-27T04:16:28Z", "author": {"login": "iNikem"}, "path": ".githooks/pre-commit", "diffHunk": "@@ -0,0 +1,14 @@\n+#!/bin/bash\n+# http://redsymbol.net/articles/unofficial-bash-strict-mode/\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+if ! ./gradlew spotlessCheck; then", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNjY1Mg=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU3NjExOA==", "bodyText": "@iNikem did u notice this file is under .githooks/pre-commit and not .git/hooks/pre-commit? does that change your opinion on this?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446576118", "createdAt": "2020-06-27T22:54:57Z", "author": {"login": "trask"}, "path": ".githooks/pre-commit", "diffHunk": "@@ -0,0 +1,14 @@\n+#!/bin/bash\n+# http://redsymbol.net/articles/unofficial-bash-strict-mode/\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+if ! ./gradlew spotlessCheck; then", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNjY1Mg=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY1MTE1Mg==", "bodyText": "A. I wonder, how many developers will be confused by this name similarity. IMO from this POV old location, buildscripts was less confusing. But let it be.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446651152", "createdAt": "2020-06-28T13:28:21Z", "author": {"login": "iNikem"}, "path": ".githooks/pre-commit", "diffHunk": "@@ -0,0 +1,14 @@\n+#!/bin/bash\n+# http://redsymbol.net/articles/unofficial-bash-strict-mode/\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+if ! ./gradlew spotlessCheck; then", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNjY1Mg=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA1ODY2OnYy", "diffSide": "RIGHT", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/AgentClassLoader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxMjoxNFrOGpqP-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDo1MDoxN1rOGp5Whg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNzAxNw==", "bodyText": "Why extract this to a field? It is still used only inside one method, no?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446337017", "createdAt": "2020-06-26T18:12:14Z", "author": {"login": "iNikem"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/AgentClassLoader.java", "diffHunk": "@@ -36,11 +36,14 @@\n \n   private static final String AGENT_INITIALIZER_JAR = System.getProperty(\"ota.initializer.jar\", \"\");\n \n+  protected final InternalJarURLHandler internalJarURLHandler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NDQ1NA==", "bodyText": "updated", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446584454", "createdAt": "2020-06-28T00:50:17Z", "author": {"login": "trask"}, "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/AgentClassLoader.java", "diffHunk": "@@ -36,11 +36,14 @@\n \n   private static final String AGENT_INITIALIZER_JAR = System.getProperty(\"ota.initializer.jar\", \"\");\n \n+  protected final InternalJarURLHandler internalJarURLHandler;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNzAxNw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA2MDE2OnYy", "diffSide": "RIGHT", "path": "gradle.properties", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxMjo0NlrOGpqQ3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDoxMDoyN1rOGp5LoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNzI0Nw==", "bodyText": "btw, why do we have/need this?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446337247", "createdAt": "2020-06-26T18:12:46Z", "author": {"login": "iNikem"}, "path": "gradle.properties", "diffHunk": "@@ -1 +1,4 @@\n+org.gradle.parallel=true\n+org.gradle.caching=true\n+\n org.gradle.jvmargs=-XX:MaxMetaspaceSize=1g", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MTY2NA==", "bodyText": "good question, created #590 to remove", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446581664", "createdAt": "2020-06-28T00:10:27Z", "author": {"login": "trask"}, "path": "gradle.properties", "diffHunk": "@@ -1 +1,4 @@\n+org.gradle.parallel=true\n+org.gradle.caching=true\n+\n org.gradle.jvmargs=-XX:MaxMetaspaceSize=1g", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNzI0Nw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA2MjM4OnYy", "diffSide": "RIGHT", "path": "gradle/spotless.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxMzoyM1rOGpqSHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDo1MTo0MVrOGp5W6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNzU2Ng==", "bodyText": "which one?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446337566", "createdAt": "2020-06-26T18:13:23Z", "author": {"login": "iNikem"}, "path": "gradle/spotless.gradle", "diffHunk": "@@ -2,16 +2,36 @@ apply plugin: 'com.diffplug.gradle.spotless'\n \n spotless {\n   java {\n+    googleJavaFormat()\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|public)'\n     target 'src/**/*.java'\n   }\n   groovy {\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|class)'\n   }\n   scala {\n+    scalafmt()\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|public)'\n   }\n   kotlin {\n+    // ktfmt() // Requires newer version of java", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NDU1Mg==", "bodyText": "is requires Java 11, which is fine for us, so i tried it, but it only supports 4-space indent, i updated comment", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446584552", "createdAt": "2020-06-28T00:51:41Z", "author": {"login": "trask"}, "path": "gradle/spotless.gradle", "diffHunk": "@@ -2,16 +2,36 @@ apply plugin: 'com.diffplug.gradle.spotless'\n \n spotless {\n   java {\n+    googleJavaFormat()\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|public)'\n     target 'src/**/*.java'\n   }\n   groovy {\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|class)'\n   }\n   scala {\n+    scalafmt()\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|public)'\n   }\n   kotlin {\n+    // ktfmt() // Requires newer version of java", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNzU2Ng=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA2MzY3OnYy", "diffSide": "RIGHT", "path": "gradle/spotless.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxMzo1MFrOGpqS8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDo1MjowNlrOGp5XAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNzc3Ng==", "bodyText": "Does not work above but works here?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446337776", "createdAt": "2020-06-26T18:13:50Z", "author": {"login": "iNikem"}, "path": "gradle/spotless.gradle", "diffHunk": "@@ -2,16 +2,36 @@ apply plugin: 'com.diffplug.gradle.spotless'\n \n spotless {\n   java {\n+    googleJavaFormat()\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|public)'\n     target 'src/**/*.java'\n   }\n   groovy {\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|class)'\n   }\n   scala {\n+    scalafmt()\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|public)'\n   }\n   kotlin {\n+    // ktfmt() // Requires newer version of java\n+    ktlint().userData(['indent_size': '2', 'continuation_indent_size': '2'])\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|public)'\n   }\n+  groovyGradle {\n+    greclipse().configFile(rootProject.rootDir.path + '/gradle/enforcement/spotless-groovy.properties')\n+  }\n+  kotlinGradle {\n+    ktfmt()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NDU3Nw==", "bodyText": "removed gradle auto-formatting now", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446584577", "createdAt": "2020-06-28T00:52:06Z", "author": {"login": "trask"}, "path": "gradle/spotless.gradle", "diffHunk": "@@ -2,16 +2,36 @@ apply plugin: 'com.diffplug.gradle.spotless'\n \n spotless {\n   java {\n+    googleJavaFormat()\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|public)'\n     target 'src/**/*.java'\n   }\n   groovy {\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|class)'\n   }\n   scala {\n+    scalafmt()\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|public)'\n   }\n   kotlin {\n+    // ktfmt() // Requires newer version of java\n+    ktlint().userData(['indent_size': '2', 'continuation_indent_size': '2'])\n     licenseHeaderFile rootProject.file('gradle/enforcement/spotless.license.java'), '(package|import|public)'\n   }\n+  groovyGradle {\n+    greclipse().configFile(rootProject.rootDir.path + '/gradle/enforcement/spotless-groovy.properties')\n+  }\n+  kotlinGradle {\n+    ktfmt()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNzc3Ng=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA3NjYxOnYy", "diffSide": "LEFT", "path": "instrumentation/jdbc/jdbc.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxODoyN1rOGpqbEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDoxNDoxMVrOGp5MmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzOTg1OQ==", "bodyText": "These are generated files and should be excluded from format check.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446339859", "createdAt": "2020-06-26T18:18:27Z", "author": {"login": "iNikem"}, "path": "instrumentation/jdbc/jdbc.gradle", "diffHunk": "@@ -21,9 +21,6 @@ javacc {\n   }\n }\n \n-tasks.withType(com.github.sherter.googlejavaformatgradleplugin.VerifyGoogleJavaFormat).configureEach {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MTkxMw==", "bodyText": "spotless appears to be smarter and excludes files under build/generated, so this isn't needed anymore", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446581913", "createdAt": "2020-06-28T00:14:11Z", "author": {"login": "trask"}, "path": "instrumentation/jdbc/jdbc.gradle", "diffHunk": "@@ -21,9 +21,6 @@ javacc {\n   }\n }\n \n-tasks.withType(com.github.sherter.googlejavaformatgradleplugin.VerifyGoogleJavaFormat).configureEach {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzOTg1OQ=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA4MTA2OnYy", "diffSide": "RIGHT", "path": "instrumentation/kafka-clients-0.11/src/main/java/io/opentelemetry/auto/instrumentation/kafkaclients/KafkaProducerInstrumentation.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoxOTo1OVrOGpqd5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQxOTowOTowOFrOGp_l5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MDU4Mw==", "bodyText": "This attribute is certainly not from semantic convention. Why should we want this into Otel?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446340583", "createdAt": "2020-06-26T18:19:59Z", "author": {"login": "iNikem"}, "path": "instrumentation/kafka-clients-0.11/src/main/java/io/opentelemetry/auto/instrumentation/kafkaclients/KafkaProducerInstrumentation.java", "diffHunk": "@@ -93,6 +93,11 @@ public static SpanWithScope onEnter(\n \n       callback = new ProducerCallback(callback, span);\n \n+      boolean isTombstone = record.value() == null && !record.headers().iterator().hasNext();\n+      if (isTombstone) {\n+        span.setAttribute(\"tombstone\", true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU5NjMyOA==", "bodyText": "we (currently at least) capture lots of span attributes that are not defined by semantic conventions\nmaybe better if we prefixed this, e.g. kafka.tombstone, so it doesn't look like a semantic attribute?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446596328", "createdAt": "2020-06-28T03:50:31Z", "author": {"login": "trask"}, "path": "instrumentation/kafka-clients-0.11/src/main/java/io/opentelemetry/auto/instrumentation/kafkaclients/KafkaProducerInstrumentation.java", "diffHunk": "@@ -93,6 +93,11 @@ public static SpanWithScope onEnter(\n \n       callback = new ProducerCallback(callback, span);\n \n+      boolean isTombstone = record.value() == null && !record.headers().iterator().hasNext();\n+      if (isTombstone) {\n+        span.setAttribute(\"tombstone\", true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MDU4Mw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY1MTQyNw==", "bodyText": "\"We are already doing strange things, let us do more strange things\" is not exactly good reason :) We already have unanswered questions \"why do we have this attribute here\", such as dispatcher.target or servlet.origin. I am hesitant to add more.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446651427", "createdAt": "2020-06-28T13:30:42Z", "author": {"login": "iNikem"}, "path": "instrumentation/kafka-clients-0.11/src/main/java/io/opentelemetry/auto/instrumentation/kafkaclients/KafkaProducerInstrumentation.java", "diffHunk": "@@ -93,6 +93,11 @@ public static SpanWithScope onEnter(\n \n       callback = new ProducerCallback(callback, span);\n \n+      boolean isTombstone = record.value() == null && !record.headers().iterator().hasNext();\n+      if (isTombstone) {\n+        span.setAttribute(\"tombstone\", true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MDU4Mw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY4NjY5NQ==", "bodyText": "i created #602 to track and make decision about this", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446686695", "createdAt": "2020-06-28T19:09:08Z", "author": {"login": "trask"}, "path": "instrumentation/kafka-clients-0.11/src/main/java/io/opentelemetry/auto/instrumentation/kafkaclients/KafkaProducerInstrumentation.java", "diffHunk": "@@ -93,6 +93,11 @@ public static SpanWithScope onEnter(\n \n       callback = new ProducerCallback(callback, span);\n \n+      boolean isTombstone = record.value() == null && !record.headers().iterator().hasNext();\n+      if (isTombstone) {\n+        span.setAttribute(\"tombstone\", true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MDU4Mw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA4ODM5OnYy", "diffSide": "RIGHT", "path": "instrumentation/spring-webmvc-3.1/spring-webmvc-3.1.gradle", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoyMjo0N1rOGpqimw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDo1Mjo0NVrOGp5XTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MTc4Nw==", "bodyText": "Not sure new format is better :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446341787", "createdAt": "2020-06-26T18:22:47Z", "author": {"login": "iNikem"}, "path": "instrumentation/spring-webmvc-3.1/spring-webmvc-3.1.gradle", "diffHunk": "@@ -5,7 +5,11 @@ muzzle {\n     group = 'org.springframework'\n     module = 'spring-webmvc'\n     versions = \"[3.1.0.RELEASE,]\"\n-    skipVersions += ['1.2.1', '1.2.2', '1.2.3', '1.2.4'] // broken releases... missing dependencies\n+    skipVersions += [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1MTg2Nw==", "bodyText": "yeah, I agree... Intellij does a better job at formatting these, but unfortunately doesn't have a command line tool, so no validation of proper formatting.  If you have a better configuration please suggest.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446351867", "createdAt": "2020-06-26T18:45:36Z", "author": {"login": "tylerbenson"}, "path": "instrumentation/spring-webmvc-3.1/spring-webmvc-3.1.gradle", "diffHunk": "@@ -5,7 +5,11 @@ muzzle {\n     group = 'org.springframework'\n     module = 'spring-webmvc'\n     versions = \"[3.1.0.RELEASE,]\"\n-    skipVersions += ['1.2.1', '1.2.2', '1.2.3', '1.2.4'] // broken releases... missing dependencies\n+    skipVersions += [", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MTc4Nw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ4NDE1MA==", "bodyText": "I would lean towards not auto formatting Gradle files if the formatter doesn't give a result we're happy with, they're a very small part of this repo, compared to Java.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446484150", "createdAt": "2020-06-27T04:40:36Z", "author": {"login": "anuraaga"}, "path": "instrumentation/spring-webmvc-3.1/spring-webmvc-3.1.gradle", "diffHunk": "@@ -5,7 +5,11 @@ muzzle {\n     group = 'org.springframework'\n     module = 'spring-webmvc'\n     versions = \"[3.1.0.RELEASE,]\"\n-    skipVersions += ['1.2.1', '1.2.2', '1.2.3', '1.2.4'] // broken releases... missing dependencies\n+    skipVersions += [", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MTc4Nw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NDY1NA==", "bodyText": "reverted auto-formatting of gradle files for now", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446584654", "createdAt": "2020-06-28T00:52:45Z", "author": {"login": "trask"}, "path": "instrumentation/spring-webmvc-3.1/spring-webmvc-3.1.gradle", "diffHunk": "@@ -5,7 +5,11 @@ muzzle {\n     group = 'org.springframework'\n     module = 'spring-webmvc'\n     versions = \"[3.1.0.RELEASE,]\"\n-    skipVersions += ['1.2.1', '1.2.2', '1.2.3', '1.2.4'] // broken releases... missing dependencies\n+    skipVersions += [", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0MTc4Nw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTA5NDA5OnYy", "diffSide": "RIGHT", "path": "instrumentation/spring-webmvc-3.1/src/main/java/io/opentelemetry/auto/instrumentation/springwebmvc/WebApplicationContextInstrumentation.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoyNTowMlrOGpqmXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoyNTowMlrOGpqmXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0Mjc1MA==", "bodyText": "This will benefit from documentation. This is a good place to document how different instrumentation coordinate with each other and for what purpose.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446342750", "createdAt": "2020-06-26T18:25:02Z", "author": {"login": "iNikem"}, "path": "instrumentation/spring-webmvc-3.1/src/main/java/io/opentelemetry/auto/instrumentation/springwebmvc/WebApplicationContextInstrumentation.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.auto.instrumentation.springwebmvc;\n+\n+import static io.opentelemetry.auto.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.auto.tooling.bytebuddy.matcher.AgentElementMatchers.extendsClass;\n+import static io.opentelemetry.auto.tooling.bytebuddy.matcher.AgentElementMatchers.implementsInterface;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.auto.tooling.Instrumenter;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;\n+import org.springframework.beans.factory.support.BeanDefinitionRegistry;\n+\n+@AutoService(Instrumenter.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTEwMzIzOnYy", "diffSide": "RIGHT", "path": "java-agent/java-agent.gradle", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODoyODozMlrOGpqsUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMDoyMToyMVrOGp5OvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0NDI3Mw==", "bodyText": "Why this change?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446344273", "createdAt": "2020-06-26T18:28:32Z", "author": {"login": "iNikem"}, "path": "java-agent/java-agent.gradle", "diffHunk": "@@ -22,14 +22,14 @@ jar {\n       \"Premain-Class\": \"io.opentelemetry.auto.bootstrap.AgentBootstrap\",\n       \"Can-Redefine-Classes\": true,\n       \"Can-Retransform-Classes\": true,\n-    )\n+      )\n   }\n }\n \n CopySpec isolateSpec(Collection<Task> sourceTasks) {\n   return copySpec {\n     from(sourceTasks.collect { zipTree(it.archiveFile) }) {\n-      into 'auto-tooling-and-instrumentation.isolated'\n+      into 'inst'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1MjE3OQ==", "bodyText": "I suggest you review the original PR.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446352179", "createdAt": "2020-06-26T18:46:17Z", "author": {"login": "tylerbenson"}, "path": "java-agent/java-agent.gradle", "diffHunk": "@@ -22,14 +22,14 @@ jar {\n       \"Premain-Class\": \"io.opentelemetry.auto.bootstrap.AgentBootstrap\",\n       \"Can-Redefine-Classes\": true,\n       \"Can-Retransform-Classes\": true,\n-    )\n+      )\n   }\n }\n \n CopySpec isolateSpec(Collection<Task> sourceTasks) {\n   return copySpec {\n     from(sourceTasks.collect { zipTree(it.archiveFile) }) {\n-      into 'auto-tooling-and-instrumentation.isolated'\n+      into 'inst'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0NDI3Mw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1NDA2NA==", "bodyText": "Link? :)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446354064", "createdAt": "2020-06-26T18:50:31Z", "author": {"login": "iNikem"}, "path": "java-agent/java-agent.gradle", "diffHunk": "@@ -22,14 +22,14 @@ jar {\n       \"Premain-Class\": \"io.opentelemetry.auto.bootstrap.AgentBootstrap\",\n       \"Can-Redefine-Classes\": true,\n       \"Can-Retransform-Classes\": true,\n-    )\n+      )\n   }\n }\n \n CopySpec isolateSpec(Collection<Task> sourceTasks) {\n   return copySpec {\n     from(sourceTasks.collect { zipTree(it.archiveFile) }) {\n-      into 'auto-tooling-and-instrumentation.isolated'\n+      into 'inst'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0NDI3Mw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MjQ2MA==", "bodyText": "i added comment\nalso, the original PRs are all linked in the corresponding commit messages", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/583#discussion_r446582460", "createdAt": "2020-06-28T00:21:21Z", "author": {"login": "trask"}, "path": "java-agent/java-agent.gradle", "diffHunk": "@@ -22,14 +22,14 @@ jar {\n       \"Premain-Class\": \"io.opentelemetry.auto.bootstrap.AgentBootstrap\",\n       \"Can-Redefine-Classes\": true,\n       \"Can-Retransform-Classes\": true,\n-    )\n+      )\n   }\n }\n \n CopySpec isolateSpec(Collection<Task> sourceTasks) {\n   return copySpec {\n     from(sourceTasks.collect { zipTree(it.archiveFile) }) {\n-      into 'auto-tooling-and-instrumentation.isolated'\n+      into 'inst'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM0NDI3Mw=="}, "originalCommit": {"oid": "d446f389332bd616d5f97612e1e68385851f8bf4"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 292, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}