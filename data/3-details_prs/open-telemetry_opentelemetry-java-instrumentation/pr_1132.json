{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1ODYyODA1", "number": 1132, "title": "Add support for redisson instrumentation", "bodyText": "closes #1061", "createdAt": "2020-08-30T04:47:24Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1132", "merged": true, "mergeCommit": {"oid": "8415a908b515236f7ea43b3ae98a3cced0478a0e"}, "closed": true, "closedAt": "2020-09-01T01:05:51Z", "author": {"login": "dengliming"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdD2wFQAH2gAyNDc1ODYyODA1OjY2ZDM3Yzc4YmFlZGQ5NWIyODIwNDVjZjYwNjM1MDYzYjBjNTY1MDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEcyvnAFqTQ3OTI0NTk2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "66d37c78baedd95b282045cf60635063b0c56500", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/66d37c78baedd95b282045cf60635063b0c56500", "committedDate": "2020-08-30T04:46:24Z", "message": "Add support for redisson instrumentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79d8790edf0bb79d2e6618d1495a178f6f36f37f", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/79d8790edf0bb79d2e6618d1495a178f6f36f37f", "committedDate": "2020-08-30T05:00:10Z", "message": "Fix ci"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1864a995399939f956b97a887fd7fa585d1db57", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d1864a995399939f956b97a887fd7fa585d1db57", "committedDate": "2020-08-30T05:20:35Z", "message": "Implement dbConnectionString"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MTczMTUw", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1132#pullrequestreview-478173150", "createdAt": "2020-08-30T05:32:34Z", "commit": {"oid": "d1864a995399939f956b97a887fd7fa585d1db57"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQwNTozMjozNFrOHJgDWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQwNTozNTowNFrOHJgD-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcyNDM3Nw==", "bodyText": "i think this can be consolidated\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              compileOnly group: 'org.redisson', name: 'redisson', version: '3.0.0'\n          \n          \n            \n            \n          \n          \n            \n              testLibrary group: 'org.redisson', name: 'redisson', version: '3.0.0'\n          \n          \n            \n              library group: 'org.redisson', name: 'redisson', version: '3.0.0'", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1132#discussion_r479724377", "createdAt": "2020-08-30T05:32:34Z", "author": {"login": "trask"}, "path": "instrumentation/redisson-3.0/redisson-3.0.gradle", "diffHunk": "@@ -0,0 +1,23 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+apply from: \"$rootDir/gradle/instrumentation.gradle\"\n+\n+muzzle {\n+  pass {\n+    group = \"org.redisson\"\n+    module = \"redisson\"\n+    versions = \"[3.0.0,)\"\n+    assertInverse = true\n+  }\n+}\n+\n+dependencies {\n+  compileOnly group: 'org.redisson', name: 'redisson', version: '3.0.0'\n+\n+  testLibrary group: 'org.redisson', name: 'redisson', version: '3.0.0'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1864a995399939f956b97a887fd7fa585d1db57"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcyNDUzNw==", "bodyText": "it looks like 3.+ resolves the same as +, so using the new library dependencies, you don't need this (it will default to +)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              latestDepTestLibrary group: 'org.redisson', name: 'redisson', version: '3.+'", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1132#discussion_r479724537", "createdAt": "2020-08-30T05:35:04Z", "author": {"login": "trask"}, "path": "instrumentation/redisson-3.0/redisson-3.0.gradle", "diffHunk": "@@ -0,0 +1,23 @@\n+// Set properties before any plugins get loaded\n+ext {\n+  minJavaVersionForTests = JavaVersion.VERSION_1_8\n+}\n+\n+apply from: \"$rootDir/gradle/instrumentation.gradle\"\n+\n+muzzle {\n+  pass {\n+    group = \"org.redisson\"\n+    module = \"redisson\"\n+    versions = \"[3.0.0,)\"\n+    assertInverse = true\n+  }\n+}\n+\n+dependencies {\n+  compileOnly group: 'org.redisson', name: 'redisson', version: '3.0.0'\n+\n+  testLibrary group: 'org.redisson', name: 'redisson', version: '3.0.0'\n+  testImplementation group: 'com.github.kstyrc', name: 'embedded-redis', version: '0.6'\n+  latestDepTestLibrary group: 'org.redisson', name: 'redisson', version: '3.+'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1864a995399939f956b97a887fd7fa585d1db57"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf5408666536aee79fdcb1f2b25847ba912ddd2e", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/bf5408666536aee79fdcb1f2b25847ba912ddd2e", "committedDate": "2020-08-30T07:00:25Z", "message": "Fix review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1600ec6e51e6b01351b1c6d1ee065b5934e2cf3e", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/1600ec6e51e6b01351b1c6d1ee065b5934e2cf3e", "committedDate": "2020-08-30T11:03:48Z", "message": "Remove assertInverse = true"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjYwNDkx", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1132#pullrequestreview-478260491", "createdAt": "2020-08-31T01:30:23Z", "commit": {"oid": "1600ec6e51e6b01351b1c6d1ee065b5934e2cf3e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwMTozMDoyM1rOHJnfjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwMTozNTo0OVrOHJnjYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0NjI4NQ==", "bodyText": "I don't think we do any truncation in other places, like Lettuce or DB instrumentation. It probably is a good idea but we should do it consistently for all the instrumentation, how about storing everything for now?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1132#discussion_r479846285", "createdAt": "2020-08-31T01:30:23Z", "author": {"login": "anuraaga"}, "path": "instrumentation/redisson-3.0/src/main/java/io/opentelemetry/instrumentation/auto/redisson/RedissonClientTracer.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.instrumentation.auto.redisson;\n+\n+import io.netty.channel.Channel;\n+import io.opentelemetry.instrumentation.api.tracer.DatabaseClientTracer;\n+import io.opentelemetry.instrumentation.auto.api.jdbc.DbSystem;\n+import java.net.InetSocketAddress;\n+import java.util.List;\n+import org.redisson.client.RedisConnection;\n+import org.redisson.client.protocol.CommandData;\n+import org.redisson.client.protocol.CommandsData;\n+\n+public class RedissonClientTracer extends DatabaseClientTracer<RedisConnection, Object> {\n+\n+  public static final RedissonClientTracer TRACER = new RedissonClientTracer();\n+\n+  @Override\n+  protected String getInstrumentationName() {\n+    return \"io.opentelemetry.auto.redisson-3.0\";\n+  }\n+\n+  @Override\n+  protected String normalizeQuery(Object args) {\n+    String commandName = \"Redis Command\";\n+    // get command\n+    if (args instanceof CommandsData) {\n+      List<CommandData<?, ?>> commands = ((CommandsData) args).getCommands();\n+      if (commands != null && !commands.isEmpty()) {\n+        commandName = commands.get(0).getCommand().getName() + \"... [bulk]\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1600ec6e51e6b01351b1c6d1ee065b5934e2cf3e"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0NzI2Nw==", "bodyText": "Does it make sense to have a more complete async test with callbacks? I notice the return type is RFuture I wonder if our concurrent instrumentation will apply to it.\nhttps://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/master/instrumentation/lettuce/lettuce-5.1/src/test/groovy/io/opentelemetry/instrumentation/auto/lettuce/v5_1/LettuceAsyncClientTest.groovy#L327\nWe can focus on async in another PR though.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1132#discussion_r479847267", "createdAt": "2020-08-31T01:35:49Z", "author": {"login": "anuraaga"}, "path": "instrumentation/redisson-3.0/src/test/groovy/RedissonClientTest.groovy", "diffHunk": "@@ -0,0 +1,303 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import io.opentelemetry.auto.test.AgentTestRunner\n+import io.opentelemetry.auto.test.utils.PortUtils\n+import io.opentelemetry.trace.attributes.SemanticAttributes\n+import org.redisson.Redisson\n+import org.redisson.api.RAtomicLong\n+import org.redisson.api.RBatch\n+import org.redisson.api.RBucket\n+import org.redisson.api.RList\n+import org.redisson.api.RLock\n+import org.redisson.api.RMap\n+import org.redisson.api.RScoredSortedSet\n+import org.redisson.api.RSet\n+import org.redisson.api.RedissonClient\n+import org.redisson.config.Config\n+import redis.embedded.RedisServer\n+import spock.lang.Shared\n+\n+import static io.opentelemetry.trace.Span.Kind.CLIENT\n+\n+class RedissonClientTest extends AgentTestRunner {\n+\n+  @Shared\n+  int port = PortUtils.randomOpenPort()\n+\n+  @Shared\n+  RedisServer redisServer = RedisServer.builder()\n+  // bind to localhost to avoid firewall popup\n+    .setting(\"bind 127.0.0.1\")\n+  // set max memory to avoid problems in CI\n+    .setting(\"maxmemory 128M\")\n+    .port(port).build()\n+  @Shared\n+  RedissonClient redisson\n+\n+  def setupSpec() {\n+    println \"Using redis: $redisServer.args\"\n+    redisServer.start()\n+  }\n+\n+  def cleanupSpec() {\n+    redisson.shutdown()\n+    redisServer.stop()\n+  }\n+\n+  def setup() {\n+    Config config = new Config()\n+    config.useSingleServer().setAddress(\"localhost:\" + port)\n+    redisson = Redisson.create(config)\n+    TEST_WRITER.clear()\n+  }\n+\n+  def \"test string command\"() {\n+    when:\n+    RBucket<String> keyObject = redisson.getBucket(\"foo\")\n+    keyObject.set(\"bar\")\n+    keyObject.get()\n+    then:\n+    assertTraces(2) {\n+      trace(0, 1) {\n+        span(0) {\n+          operationName \"SET\"\n+          spanKind CLIENT\n+          attributes {\n+            \"${SemanticAttributes.DB_SYSTEM.key()}\" \"redis\"\n+            \"${SemanticAttributes.NET_PEER_IP.key()}\" \"127.0.0.1\"\n+            \"${SemanticAttributes.NET_PEER_NAME.key()}\" \"localhost\"\n+            \"${SemanticAttributes.DB_CONNECTION_STRING.key()}\" \"localhost:$port\"\n+            \"${SemanticAttributes.NET_PEER_PORT.key()}\" port\n+            \"${SemanticAttributes.DB_STATEMENT.key()}\" \"SET\"\n+          }\n+        }\n+      }\n+      trace(1, 1) {\n+        span(0) {\n+          operationName \"GET\"\n+          spanKind CLIENT\n+          attributes {\n+            \"${SemanticAttributes.DB_SYSTEM.key()}\" \"redis\"\n+            \"${SemanticAttributes.NET_PEER_IP.key()}\" \"127.0.0.1\"\n+            \"${SemanticAttributes.NET_PEER_NAME.key()}\" \"localhost\"\n+            \"${SemanticAttributes.DB_CONNECTION_STRING.key()}\" \"localhost:$port\"\n+            \"${SemanticAttributes.NET_PEER_PORT.key()}\" port\n+            \"${SemanticAttributes.DB_STATEMENT.key()}\" \"GET\"\n+          }\n+        }\n+      }\n+    }\n+  }\n+\n+  def \"test batch command\"() {\n+    when:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1600ec6e51e6b01351b1c6d1ee065b5934e2cf3e"}, "originalPosition": 107}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecb8e62275c92e68081ec6082334ac763de4f55d", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ecb8e62275c92e68081ec6082334ac763de4f55d", "committedDate": "2020-08-31T13:09:49Z", "message": "Fix batch commands and Add Redisson Async Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2baa5c958e7b3c4100c8bf935e763fcbadab461", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c2baa5c958e7b3c4100c8bf935e763fcbadab461", "committedDate": "2020-08-31T13:17:02Z", "message": "Fix codenarcTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5MTYzMDY2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1132#pullrequestreview-479163066", "createdAt": "2020-09-01T00:27:34Z", "commit": {"oid": "c2baa5c958e7b3c4100c8bf935e763fcbadab461"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMDoyNzozNFrOHKPJ4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMDoyNzozNFrOHKPJ4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ5NjA5OA==", "bodyText": "Thanks, this is a good test! I just noticed our async redis tests don't check context propagation, we can look at that separately #1139", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1132#discussion_r480496098", "createdAt": "2020-09-01T00:27:34Z", "author": {"login": "anuraaga"}, "path": "instrumentation/redisson-3.0/src/test/groovy/RedissonAsyncClientTest.groovy", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import io.opentelemetry.auto.test.AgentTestRunner\n+import io.opentelemetry.auto.test.utils.PortUtils\n+import io.opentelemetry.trace.attributes.SemanticAttributes\n+import org.redisson.Redisson\n+import org.redisson.api.*\n+import org.redisson.config.Config\n+import redis.embedded.RedisServer\n+import spock.lang.Shared\n+\n+import java.util.concurrent.TimeUnit\n+import java.util.function.BiConsumer\n+\n+import static io.opentelemetry.trace.Span.Kind.CLIENT\n+\n+class RedissonAsyncClientTest extends AgentTestRunner {\n+\n+  @Shared\n+  int port = PortUtils.randomOpenPort()\n+\n+  @Shared\n+  RedisServer redisServer = RedisServer.builder()\n+  // bind to localhost to avoid firewall popup\n+    .setting(\"bind 127.0.0.1\")\n+  // set max memory to avoid problems in CI\n+    .setting(\"maxmemory 128M\")\n+    .port(port).build()\n+  @Shared\n+  RedissonClient redisson\n+\n+  def setupSpec() {\n+    println \"Using redis: $redisServer.args\"\n+    redisServer.start()\n+  }\n+\n+  def cleanupSpec() {\n+    redisson.shutdown()\n+    redisServer.stop()\n+  }\n+\n+  def setup() {\n+    Config config = new Config()\n+    config.useSingleServer().setAddress(\"localhost:\" + port)\n+    redisson = Redisson.create(config)\n+    TEST_WRITER.clear()\n+  }\n+\n+  def \"test future get\"() {\n+    when:\n+    RBucket<String> keyObject = redisson.getBucket(\"foo\")\n+    RFuture future = keyObject.setAsync(\"bar\")\n+    future.get(3, TimeUnit.SECONDS)\n+    then:\n+    assertTraces(1) {\n+      trace(0, 1) {\n+        span(0) {\n+          operationName \"SET\"\n+          spanKind CLIENT\n+          attributes {\n+            \"${SemanticAttributes.DB_SYSTEM.key()}\" \"redis\"\n+            \"${SemanticAttributes.NET_PEER_IP.key()}\" \"127.0.0.1\"\n+            \"${SemanticAttributes.NET_PEER_NAME.key()}\" \"localhost\"\n+            \"${SemanticAttributes.DB_CONNECTION_STRING.key()}\" \"localhost:$port\"\n+            \"${SemanticAttributes.NET_PEER_PORT.key()}\" port\n+            \"${SemanticAttributes.DB_STATEMENT.key()}\" \"SET\"\n+          }\n+        }\n+      }\n+    }\n+  }\n+\n+  def \"test future whenComplete\"() {\n+    when:\n+    RSet<String> rSet = redisson.getSet(\"set1\")\n+    RFuture<Boolean> result = rSet.addAsync(\"s1\")\n+    result.whenComplete(new BiConsumer<Boolean, Throwable>() {\n+      @Override\n+      void accept(Boolean res, Throwable throwable) {\n+        RList<String> strings = redisson.getList(\"list1\")\n+        strings.add(\"a\")\n+      }\n+    })\n+    then:\n+    result.get(3, TimeUnit.SECONDS)\n+    assertTraces(2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2baa5c958e7b3c4100c8bf935e763fcbadab461"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5MjQ1OTYz", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1132#pullrequestreview-479245963", "createdAt": "2020-09-01T01:05:42Z", "commit": {"oid": "c2baa5c958e7b3c4100c8bf935e763fcbadab461"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2531, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}