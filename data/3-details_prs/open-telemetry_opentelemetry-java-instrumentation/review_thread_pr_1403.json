{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0Nzc4ODg4", "number": 1403, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNjowOTozOVrOEvKAXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNjowOTozOVrOEvKAXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3ODgyNDYyOnYy", "diffSide": "RIGHT", "path": "instrumentation/jdbc/src/main/java/io/opentelemetry/javaagent/instrumentation/jdbc/JDBCConnectionUrlParser.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNjowOTozOVrOHj-0rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNDozMDo0MVrOHkRjQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw==", "bodyText": "There cannot be port in this case?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507491503", "createdAt": "2020-10-19T06:09:39Z", "author": {"login": "iNikem"}, "path": "instrumentation/jdbc/src/main/java/io/opentelemetry/javaagent/instrumentation/jdbc/JDBCConnectionUrlParser.java", "diffHunk": "@@ -159,7 +188,19 @@\n         serverName = serverName.substring(0, instanceLoc);\n       }\n \n-      int portLoc = serverName.indexOf(\":\");\n+      Matcher ipv6Matcher = IPv6.matcher(serverName);\n+      boolean isIpv6 = ipv6Matcher.find();\n+\n+      int portLoc = -1;\n+      if (isIpv6) {\n+        if (serverName.startsWith(\"[\")) {\n+          portLoc = serverName.indexOf(\"]:\") + 1;\n+        } else {\n+          serverName = \"[\" + serverName + \"]\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83e3c1f4eeefc42d83def6d2a2670f68fa4223ab"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU1ODcwMg==", "bodyText": "There isn't one, but because the shortUrl contains the port number, it needs to be formatted that way\nshortUrl example sqlserver://[2001:0db8:85a3:0000:0000:8a2e:0370:7334]:1433.\nI'm now thinking though, whether this is not appropriate for the host attribute i.e. [2001:0db8:85a3:0000:0000:8a2e:0370:7334]. What do you think?\nBy the way, the mariadb test is partially incorrect because it includes the port as part of the shortUrl\nEDIT\nFor\n\"jdbc:mariadb:loadbalance://[2001:0660:7401:0200:0000:0000:0edf:bdd7]:33,mdb.host/mdbdb\"\n\nshortUrl becomes\n\"mariadb:loadbalance://2001:0660:7401:0200:0000:0000:0edf:bdd7:33\"", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507558702", "createdAt": "2020-10-19T08:20:17Z", "author": {"login": "imavroukakis"}, "path": "instrumentation/jdbc/src/main/java/io/opentelemetry/javaagent/instrumentation/jdbc/JDBCConnectionUrlParser.java", "diffHunk": "@@ -159,7 +188,19 @@\n         serverName = serverName.substring(0, instanceLoc);\n       }\n \n-      int portLoc = serverName.indexOf(\":\");\n+      Matcher ipv6Matcher = IPv6.matcher(serverName);\n+      boolean isIpv6 = ipv6Matcher.find();\n+\n+      int portLoc = -1;\n+      if (isIpv6) {\n+        if (serverName.startsWith(\"[\")) {\n+          portLoc = serverName.indexOf(\"]:\") + 1;\n+        } else {\n+          serverName = \"[\" + serverName + \"]\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw=="}, "originalCommit": {"oid": "83e3c1f4eeefc42d83def6d2a2670f68fa4223ab"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4MzgwOQ==", "bodyText": "You lost me :) I am not proficient with ip6 formats. I just see:\nif (serverName.startsWith(\"[\")) {\n   portLoc = XXX\n} else {\n  serverName = \"[\" + serverName + \"]\";\n}\n\nand wonder, why if serverName does not start with [, then it means there is no port?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507683809", "createdAt": "2020-10-19T11:50:37Z", "author": {"login": "iNikem"}, "path": "instrumentation/jdbc/src/main/java/io/opentelemetry/javaagent/instrumentation/jdbc/JDBCConnectionUrlParser.java", "diffHunk": "@@ -159,7 +188,19 @@\n         serverName = serverName.substring(0, instanceLoc);\n       }\n \n-      int portLoc = serverName.indexOf(\":\");\n+      Matcher ipv6Matcher = IPv6.matcher(serverName);\n+      boolean isIpv6 = ipv6Matcher.find();\n+\n+      int portLoc = -1;\n+      if (isIpv6) {\n+        if (serverName.startsWith(\"[\")) {\n+          portLoc = serverName.indexOf(\"]:\") + 1;\n+        } else {\n+          serverName = \"[\" + serverName + \"]\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw=="}, "originalCommit": {"oid": "83e3c1f4eeefc42d83def6d2a2670f68fa4223ab"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzczNzU0MA==", "bodyText": "Apologies, I went neck-deep into IPv6 land. Yes, since : is a delimiter for the IPv6 parts, the only way to define a port in a URL/URI-like manner, is to wrap the address in [-] and then append the port with a :\nDoes this make sense, especially with regards to my point about the MariaDB tests?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507737540", "createdAt": "2020-10-19T13:18:12Z", "author": {"login": "imavroukakis"}, "path": "instrumentation/jdbc/src/main/java/io/opentelemetry/javaagent/instrumentation/jdbc/JDBCConnectionUrlParser.java", "diffHunk": "@@ -159,7 +188,19 @@\n         serverName = serverName.substring(0, instanceLoc);\n       }\n \n-      int portLoc = serverName.indexOf(\":\");\n+      Matcher ipv6Matcher = IPv6.matcher(serverName);\n+      boolean isIpv6 = ipv6Matcher.find();\n+\n+      int portLoc = -1;\n+      if (isIpv6) {\n+        if (serverName.startsWith(\"[\")) {\n+          portLoc = serverName.indexOf(\"]:\") + 1;\n+        } else {\n+          serverName = \"[\" + serverName + \"]\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw=="}, "originalCommit": {"oid": "83e3c1f4eeefc42d83def6d2a2670f68fa4223ab"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc0Njc4Nw==", "bodyText": "Clarification, when I say\n\nthe only way to define a port in a URL/URI-like manner\n\n, I should have said instead, \"the only unambigious way to define a port in a URL/URI-like manner\"", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507746787", "createdAt": "2020-10-19T13:29:55Z", "author": {"login": "imavroukakis"}, "path": "instrumentation/jdbc/src/main/java/io/opentelemetry/javaagent/instrumentation/jdbc/JDBCConnectionUrlParser.java", "diffHunk": "@@ -159,7 +188,19 @@\n         serverName = serverName.substring(0, instanceLoc);\n       }\n \n-      int portLoc = serverName.indexOf(\":\");\n+      Matcher ipv6Matcher = IPv6.matcher(serverName);\n+      boolean isIpv6 = ipv6Matcher.find();\n+\n+      int portLoc = -1;\n+      if (isIpv6) {\n+        if (serverName.startsWith(\"[\")) {\n+          portLoc = serverName.indexOf(\"]:\") + 1;\n+        } else {\n+          serverName = \"[\" + serverName + \"]\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw=="}, "originalCommit": {"oid": "83e3c1f4eeefc42d83def6d2a2670f68fa4223ab"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5ODMzOA==", "bodyText": "I see. I have left a comment in #1421, but that is a separate issue.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1403#discussion_r507798338", "createdAt": "2020-10-19T14:30:41Z", "author": {"login": "iNikem"}, "path": "instrumentation/jdbc/src/main/java/io/opentelemetry/javaagent/instrumentation/jdbc/JDBCConnectionUrlParser.java", "diffHunk": "@@ -159,7 +188,19 @@\n         serverName = serverName.substring(0, instanceLoc);\n       }\n \n-      int portLoc = serverName.indexOf(\":\");\n+      Matcher ipv6Matcher = IPv6.matcher(serverName);\n+      boolean isIpv6 = ipv6Matcher.find();\n+\n+      int portLoc = -1;\n+      if (isIpv6) {\n+        if (serverName.startsWith(\"[\")) {\n+          portLoc = serverName.indexOf(\"]:\") + 1;\n+        } else {\n+          serverName = \"[\" + serverName + \"]\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ5MTUwMw=="}, "originalCommit": {"oid": "83e3c1f4eeefc42d83def6d2a2670f68fa4223ab"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4694, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}