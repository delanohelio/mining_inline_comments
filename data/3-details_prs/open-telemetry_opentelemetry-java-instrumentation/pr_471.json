{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MDM2Njkw", "number": 471, "title": "Fixed Mongo client double tracing bug", "bodyText": "Added traceListener to MongoClientSettingsBuilder only if it didn't exist already\nCloses #457", "createdAt": "2020-06-03T08:12:21Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471", "merged": true, "mergeCommit": {"oid": "cfade733b899a2f02cfec7033c6a1efd7c54fd8b"}, "closed": true, "closedAt": "2020-06-04T16:48:06Z", "author": {"login": "RashmiRam"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnk56ZAH2gAyNDI3MDM2NjkwOjI1NGRlOTMzMjFiMjk2ZTVmZjI2OWYzMjEwZDcwZjAxZTAzYmI5YzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn_GvxgH2gAyNDI3MDM2NjkwOjBiOWYxN2MxMDY1NWY3MGY2ZjgxZTkzNTllNmIyMmMzZWRkZmRhOGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "254de93321b296e5ff269f3210d70f01e03bb9c2", "author": {"user": {"login": "RashmiRam", "name": "Rashmi"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/254de93321b296e5ff269f3210d70f01e03bb9c2", "committedDate": "2020-06-03T08:08:58Z", "message": "Fixes #457"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzkwNTkx", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#pullrequestreview-423390591", "createdAt": "2020-06-03T09:45:07Z", "commit": {"oid": "254de93321b296e5ff269f3210d70f01e03bb9c2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTo0NTowN1rOGeUVRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTo0ODoyOVrOGeUc-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0MzU5MQ==", "bodyText": "Inline this variable", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r434443591", "createdAt": "2020-06-03T09:45:07Z", "author": {"login": "iNikem"}, "path": "instrumentation/mongo/mongo-3.1/src/main/java/io/opentelemetry/auto/instrumentation/mongo/v3_1/MongoClientInstrumentation.java", "diffHunk": "@@ -75,8 +77,16 @@ public MongoClientInstrumentation() {\n   public static class MongoClientAdvice {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n-    public static void injectTraceListener(@Advice.This final MongoClientOptions.Builder builder) {\n-      builder.addCommandListener(new TracingCommandListener());\n+    public static void injectTraceListener(\n+        @Advice.This final MongoClientOptions.Builder builder,\n+        @Advice.FieldValue(\"commandListeners\") final List<CommandListener> commandListeners) {\n+      for (final CommandListener commandListener : commandListeners) {\n+        if (commandListener instanceof TracingCommandListener) {\n+          return;\n+        }\n+      }\n+      final TracingCommandListener listener = new TracingCommandListener();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "254de93321b296e5ff269f3210d70f01e03bb9c2"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0NDQ2NA==", "bodyText": "I think you don't need where block here. Just use this values/variable directly in setup block", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r434444464", "createdAt": "2020-06-03T09:46:30Z", "author": {"login": "iNikem"}, "path": "instrumentation/mongo/mongo-3.1/src/test/groovy/MongoClientTest.groovy", "diffHunk": "@@ -68,6 +68,27 @@ class MongoClientTest extends MongoBaseTest {\n     collectionName = \"testCollection\"\n   }\n \n+  def \"test create collection with already built ClientSettings\"() {\n+    setup:\n+    def clientOptions = client.mongoClientOptions\n+    def newClientOptions = MongoClientOptions.builder(clientOptions).build()\n+    MongoDatabase db = new MongoClient(new ServerAddress(\"localhost\", port), newClientOptions).getDatabase(dbName)\n+\n+    when:\n+    db.createCollection(collectionName)\n+\n+    then:\n+    assertTraces(1) {\n+      trace(0, 1) {\n+        mongoSpan(it, 0, \"{\\\"create\\\":\\\"$collectionName\\\",\\\"capped\\\":\\\"?\\\"}\")\n+      }\n+    }\n+\n+    where:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "254de93321b296e5ff269f3210d70f01e03bb9c2"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0NTU2Mg==", "bodyText": "I don't quite understand how this test is related to the change in MongoClientAdvice. I would expect that you test e.g. calling build method twice and then check that only one span is created. Do I miss something?", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r434445562", "createdAt": "2020-06-03T09:48:29Z", "author": {"login": "iNikem"}, "path": "instrumentation/mongo/mongo-3.1/src/test/groovy/MongoClientTest.groovy", "diffHunk": "@@ -68,6 +68,27 @@ class MongoClientTest extends MongoBaseTest {\n     collectionName = \"testCollection\"\n   }\n \n+  def \"test create collection with already built ClientSettings\"() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "254de93321b296e5ff269f3210d70f01e03bb9c2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c573f1df84b2ca8eb1f8e68867871d46495cc3df", "author": {"user": {"login": "RashmiRam", "name": "Rashmi"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c573f1df84b2ca8eb1f8e68867871d46495cc3df", "committedDate": "2020-06-04T08:31:21Z", "message": "Addressing review comments\n1. Added comments in test\n2. Fixed latestDepTest failures in MongoAsyncClient by adding `declaresField`\n3. Made TracingCommandListener inline in MongoClientAdvice"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MjQ4MTUx", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#pullrequestreview-424248151", "createdAt": "2020-06-04T09:07:57Z", "commit": {"oid": "c573f1df84b2ca8eb1f8e68867871d46495cc3df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b9f17c10655f70f6f81e9359e6b22c3eddfda8c", "author": {"user": {"login": "iNikem", "name": "Nikita Salnikov-Tarnovski"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0b9f17c10655f70f6f81e9359e6b22c3eddfda8c", "committedDate": "2020-06-04T14:40:31Z", "message": "Merge branch 'master' into master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3204, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}