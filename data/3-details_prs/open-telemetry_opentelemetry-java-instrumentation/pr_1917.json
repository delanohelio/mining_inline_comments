{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxMTE1ODUx", "number": 1917, "title": "Add support for Undertow server runtime", "bodyText": "Part of #1886 .\nChanges in servlets should be replaced by those from #1902 when that is merged.", "createdAt": "2020-12-16T12:01:51Z", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1917", "merged": true, "mergeCommit": {"oid": "088871157447e73a04547da49402f97c905f891a"}, "closed": true, "closedAt": "2020-12-22T12:13:51Z", "author": {"login": "iNikem"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmtsJFAH2gAyNTQxMTE1ODUxOmRmZTg2OGUwZmU3YmQzNDY3YTBhNzhkOTJmMjFiNjNiMDAzMTViNGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdoa6RPgFqTU1NjYwNjI5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dfe868e0fe7bd3467a0a78d92f21b63b00315b4e", "author": {"user": {"login": "iNikem", "name": "Nikita Salnikov-Tarnovski"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/dfe868e0fe7bd3467a0a78d92f21b63b00315b4e", "committedDate": "2020-12-16T12:00:18Z", "message": "Add support for Undertow server runtime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8001d0ee0aa9303448adc854def48735cbcf3a48", "author": {"user": {"login": "iNikem", "name": "Nikita Salnikov-Tarnovski"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/8001d0ee0aa9303448adc854def48735cbcf3a48", "committedDate": "2020-12-16T13:01:59Z", "message": "Polish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7726dbbbf5bb0c42761ec6862aa68843d7715a49", "author": {"user": {"login": "iNikem", "name": "Nikita Salnikov-Tarnovski"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/7726dbbbf5bb0c42761ec6862aa68843d7715a49", "committedDate": "2020-12-16T14:58:15Z", "message": "Damn be classloaders"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTE5MDg4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1917#pullrequestreview-554119088", "createdAt": "2020-12-16T21:59:53Z", "commit": {"oid": "7726dbbbf5bb0c42761ec6862aa68843d7715a49"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMTo1OTo1M1rOIHa_zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMjoxNTo0OVrOIHbhww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY1MzI2MA==", "bodyText": "this is a great idea, definitely other places we can take advantage of this", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1917#discussion_r544653260", "createdAt": "2020-12-16T21:59:53Z", "author": {"login": "trask"}, "path": "javaagent/javaagent.gradle", "diffHunk": "@@ -32,10 +32,15 @@ CopySpec isolateSpec(Collection<Project> projectsWithShadowJar) {\n     from({ projectsWithShadowJar.tasks.shadowJar.collect { zipTree(it.archiveFile) } }) {\n       // important to keep prefix 'inst' short, as it is prefixed to lots of strings in runtime mem\n       into 'inst'\n+      exclude 'io/opentelemetry/javaagent/instrumentation/api/**/*.class'\n       rename '(^.*)\\\\.class$', '$1.classdata'\n       // Rename LICENSE file since it clashes with license dir on non-case sensitive FSs (i.e. Mac)\n       rename '^LICENSE$', 'LICENSE.renamed'\n     }\n+    //This allows every instrumentation to have their own classes that should go to bootstrap classloader", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7726dbbbf5bb0c42761ec6862aa68843d7715a49"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY1NTgyNg==", "bodyText": "I don't think we generally perform this check (maybe we should?)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      if (!Java8BytecodeBridge.currentContext().equals(attachedContext)) {\n          \n          \n            \n                        scope = attachedContext.makeCurrent();\n          \n          \n            \n                      }\n          \n          \n            \n                      scope = attachedContext.makeCurrent();", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1917#discussion_r544655826", "createdAt": "2020-12-16T22:04:20Z", "author": {"login": "trask"}, "path": "instrumentation/undertow/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/undertow/UndertowInstrumentationModule.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.undertow;\n+\n+import static io.opentelemetry.javaagent.instrumentation.undertow.UndertowHttpServerTracer.tracer;\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.implementsInterface;\n+import static java.util.Collections.singletonList;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isPublic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.context.Context;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.javaagent.instrumentation.api.Java8BytecodeBridge;\n+import io.opentelemetry.javaagent.tooling.InstrumentationModule;\n+import io.opentelemetry.javaagent.tooling.TypeInstrumentation;\n+import io.undertow.server.HttpServerExchange;\n+import java.lang.reflect.Method;\n+import java.util.List;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(InstrumentationModule.class)\n+public class UndertowInstrumentationModule extends InstrumentationModule {\n+\n+  public UndertowInstrumentationModule() {\n+    super(\"undertow\", \"undertow-2.0\");\n+  }\n+\n+  @Override\n+  public ElementMatcher.Junction<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"io.undertow.server.HttpHandler\");\n+  }\n+\n+  @Override\n+  public List<TypeInstrumentation> typeInstrumentations() {\n+    return singletonList(new HandlerInstrumentation());\n+  }\n+\n+  public static class HandlerInstrumentation implements TypeInstrumentation {\n+\n+    @Override\n+    public ElementMatcher<TypeDescription> typeMatcher() {\n+      return implementsInterface(named(\"io.undertow.server.HttpHandler\"));\n+    }\n+\n+    @Override\n+    public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+      return singletonMap(\n+          named(\"handleRequest\")\n+              .and(takesArgument(0, named(\"io.undertow.server.HttpServerExchange\")))\n+              .and(isPublic()),\n+          UndertowHandlerAdvice.class.getName());\n+    }\n+\n+    public static class UndertowHandlerAdvice {\n+      @Advice.OnMethodEnter(suppress = Throwable.class)\n+      public static void onEnter(\n+          @Advice.Origin Method method,\n+          @Advice.Argument(value = 0, readOnly = false) HttpServerExchange exchange,\n+          @Advice.Local(\"otelScope\") Scope scope) {\n+        Context attachedContext = tracer().getServerContext(exchange);\n+        if (attachedContext != null) {\n+          if (!Java8BytecodeBridge.currentContext().equals(attachedContext)) {\n+            scope = attachedContext.makeCurrent();\n+          }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7726dbbbf5bb0c42761ec6862aa68843d7715a49"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY1Nzg3MA==", "bodyText": "is this needed? (see javadoc on classLoaderMatcher)", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1917#discussion_r544657870", "createdAt": "2020-12-16T22:08:06Z", "author": {"login": "trask"}, "path": "instrumentation/undertow/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/undertow/UndertowInstrumentationModule.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.undertow;\n+\n+import static io.opentelemetry.javaagent.instrumentation.undertow.UndertowHttpServerTracer.tracer;\n+import static io.opentelemetry.javaagent.tooling.ClassLoaderMatcher.hasClassesNamed;\n+import static io.opentelemetry.javaagent.tooling.bytebuddy.matcher.AgentElementMatchers.implementsInterface;\n+import static java.util.Collections.singletonList;\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.isPublic;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.context.Context;\n+import io.opentelemetry.context.Scope;\n+import io.opentelemetry.javaagent.instrumentation.api.Java8BytecodeBridge;\n+import io.opentelemetry.javaagent.tooling.InstrumentationModule;\n+import io.opentelemetry.javaagent.tooling.TypeInstrumentation;\n+import io.undertow.server.HttpServerExchange;\n+import java.lang.reflect.Method;\n+import java.util.List;\n+import java.util.Map;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+@AutoService(InstrumentationModule.class)\n+public class UndertowInstrumentationModule extends InstrumentationModule {\n+\n+  public UndertowInstrumentationModule() {\n+    super(\"undertow\", \"undertow-2.0\");\n+  }\n+\n+  @Override\n+  public ElementMatcher.Junction<ClassLoader> classLoaderMatcher() {\n+    return hasClassesNamed(\"io.undertow.server.HttpHandler\");\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7726dbbbf5bb0c42761ec6862aa68843d7715a49"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY2MTk1NQ==", "bodyText": "two thoughts:\n\na bootstrap class can't really reference the AttachmentKey class, the reason this is working is because of erasure, but think better to not hide that, and use Object here in the signature\nI think better to use Map<ClassLoader, Object> (where the value is AttachmentKey), in case undertow itself is loaded by two different class loaders, in which case you really do need two different AttachmentKey instances. The key of the map would be AttachmentKey.class.getClassLoader().", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1917#discussion_r544661955", "createdAt": "2020-12-16T22:15:49Z", "author": {"login": "trask"}, "path": "instrumentation/undertow/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/api/KeyHolder.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.api;\n+\n+import io.opentelemetry.context.Context;\n+import io.undertow.server.HttpServerExchange;\n+import io.undertow.util.AttachmentKey;\n+import java.util.IdentityHashMap;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+/**\n+ * Undertow's {@link HttpServerExchange} uses {@link AttachmentKey} as a key for storing arbitrary\n+ * data. It uses {@link IdentityHashMap} and thus all keys are compared for equality by object\n+ * reference. This means that we cannot hold an instance of {@link AttachmentKey} in a static field\n+ * of the corresponding Tracer, as we usually do. Tracers are loaded into user's classloaders and\n+ * thus it is totally possible to have several instances of tracers. Each of those instances will\n+ * have a separate value in a static field and {@link HttpServerExchange} will treat them as\n+ * different keys then.\n+ *\n+ * <p>That is why this class exists and resides in a separate package. This package is treated in a\n+ * special way and is always loaded by bootstrap classloader. This makes sure that this class is\n+ * available to all tracers from every classloader.\n+ *\n+ * <p>But at the same time, being loaded by bootstrap classloader, this class itself cannot initiate\n+ * the loading of {@link AttachmentKey} class. Class has to be loaded by <i>any</i> classloader that\n+ * has it, e.g. by the classloader of a Tracer that uses this key holder. After that, <i>all</i>\n+ * Tracers, loaded by all classloaders, will be able to use exactly the same sole instance of the\n+ * key.\n+ */\n+public class KeyHolder {\n+  public static final AtomicReference<AttachmentKey<Context>> contextKey = new AtomicReference<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7726dbbbf5bb0c42761ec6862aa68843d7715a49"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d380d5c5302a117d3bc7c275c2c7b8697bd7850a", "author": {"user": {"login": "iNikem", "name": "Nikita Salnikov-Tarnovski"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/d380d5c5302a117d3bc7c275c2c7b8697bd7850a", "committedDate": "2020-12-17T12:42:53Z", "message": "Merge remote-tracking branch 'upstream/master' into undertow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d2ac5f54d8ff78d80b64b9e50bb31446b65c882", "author": {"user": {"login": "iNikem", "name": "Nikita Salnikov-Tarnovski"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9d2ac5f54d8ff78d80b64b9e50bb31446b65c882", "committedDate": "2020-12-17T14:18:55Z", "message": "Fix correct span name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NzMyMjI4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1917#pullrequestreview-554732228", "createdAt": "2020-12-17T15:46:33Z", "commit": {"oid": "9d2ac5f54d8ff78d80b64b9e50bb31446b65c882"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNTo0NjozM1rOIH77Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNTo0NjozM1rOIH77Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE5MjczOQ==", "bodyText": "Consider creating an undertow sub-package.", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1917#discussion_r545192739", "createdAt": "2020-12-17T15:46:33Z", "author": {"login": "mateuszrzeszutek"}, "path": "instrumentation/undertow/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/api/KeyHolder.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.api;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d2ac5f54d8ff78d80b64b9e50bb31446b65c882"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fd6feb9536dd9cd58d3c8f279695631dfd6ad17", "author": {"user": {"login": "iNikem", "name": "Nikita Salnikov-Tarnovski"}}, "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/7fd6feb9536dd9cd58d3c8f279695631dfd6ad17", "committedDate": "2020-12-21T11:34:13Z", "message": "Polish"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NjA2Mjk1", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1917#pullrequestreview-556606295", "createdAt": "2020-12-21T19:15:23Z", "commit": {"oid": "7fd6feb9536dd9cd58d3c8f279695631dfd6ad17"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2006, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}