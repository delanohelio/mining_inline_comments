{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3ODQ2MzMx", "number": 848, "title": "Phoenix-5947 Add tests and extensions to Schema Extraction Tool utility", "bodyText": "Added support for extracting ddl for salted tables, array column type and non-default column families\nAdded tests for extracting table, view and index ddls", "createdAt": "2020-07-28T14:25:33Z", "url": "https://github.com/apache/phoenix/pull/848", "merged": true, "mergeCommit": {"oid": "2b72758fa5ad1cfdbe94cfe6f941414bb5ccaaef"}, "closed": true, "closedAt": "2020-08-05T20:51:18Z", "author": {"login": "Qinrui98"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5XBsfAH2gAyNDU3ODQ2MzMxOmJiNjZmOGRkMzkzOTkwMjhkY2Y2Y2ZkZWNlNjJlMGM1NWRhNTQxYWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7_zQSgFqTQ2MTkzMjE1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bb66f8dd39399028dcf6cfdece62e0c55da541ac", "author": {"user": {"login": "Qinrui98", "name": "Qinrui Li"}}, "url": "https://github.com/apache/phoenix/commit/bb66f8dd39399028dcf6cfdece62e0c55da541ac", "committedDate": "2020-07-28T14:09:26Z", "message": "add unit tests and fixes to the Extraction Tool"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2ODE4MjAx", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-456818201", "createdAt": "2020-07-28T16:42:43Z", "commit": {"oid": "bb66f8dd39399028dcf6cfdece62e0c55da541ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjo0Mjo0M1rOG4VUUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjo0Mjo0M1rOG4VUUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcyMjcwNQ==", "bodyText": "This PR does not completely support the multiple column families, especially if there are different properties for each column family as mentioned by Goeffrey on the previous review. Let's modify this if clause to be specific unless you want to include the change in this one and completely get rid of \"Not Supported Exception\".", "url": "https://github.com/apache/phoenix/pull/848#discussion_r461722705", "createdAt": "2020-07-28T16:42:43Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -54,9 +55,6 @@ public String process() throws Exception {\n         if (ddl != null) {\n             return ddl;\n         }\n-        if(this.table.getColumnFamilies().size() > 1 ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb66f8dd39399028dcf6cfdece62e0c55da541ac"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b", "author": {"user": {"login": "Qinrui98", "name": "Qinrui Li"}}, "url": "https://github.com/apache/phoenix/commit/1e63d93b0c1e6e74f2b024efcf17b6381999048b", "committedDate": "2020-07-29T22:30:47Z", "message": "support multiple CFs with distinct properties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTY3MTg4", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457967188", "createdAt": "2020-07-29T23:32:38Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozMjozOFrOG5NzSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozMjozOFrOG5NzSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY0ODEzNg==", "bodyText": "This should be available in other parts of the code. You can just import here.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462648136", "createdAt": "2020-07-29T23:32:38Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -1,35 +1,35 @@\n package org.apache.phoenix.schema;\n \n+import com.google.common.collect.ImmutableList;\n import com.google.common.collect.Sets;\n+import com.google.inject.internal.util.$ImmutableCollection;\n import org.apache.commons.lang.StringUtils;\n import org.apache.hadoop.conf.Configuration;\n import org.apache.hadoop.hbase.HColumnDescriptor;\n+import org.apache.hadoop.hbase.HConstants;\n import org.apache.hadoop.hbase.HTableDescriptor;\n import org.apache.hadoop.hbase.TableName;\n import org.apache.hadoop.hbase.io.ImmutableBytesWritable;\n import org.apache.hadoop.hbase.util.Bytes;\n import org.apache.phoenix.jdbc.PhoenixConnection;\n import org.apache.phoenix.mapreduce.util.ConnectionUtil;\n import org.apache.phoenix.query.ConnectionQueryServices;\n+import org.apache.phoenix.query.QueryConstants;\n import org.apache.phoenix.util.MetaDataUtil;\n import org.apache.phoenix.util.PhoenixRuntime;\n import org.apache.phoenix.util.SchemaUtil;\n \n import java.io.IOException;\n import java.sql.Connection;\n import java.sql.SQLException;\n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.HashSet;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Set;\n+import java.util.*;\n \n public class SchemaExtractionProcessor {\n \n-    public static final String\n-            FEATURE_NOT_SUPPORTED_ON_EXTRACTION_TOOL =\n-            \"Multiple CF feature not supported on extraction tool\";\n+    public static final List<String> SYNCED_DATA_TABLE_AND_INDEX_COL_FAM_PROPERTIES = ImmutableList.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTY3Mjgw", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457967280", "createdAt": "2020-07-29T23:32:54Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozMjo1NFrOG5Nzqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozMjo1NFrOG5Nzqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY0ODIzNQ==", "bodyText": "Avoid import *", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462648235", "createdAt": "2020-07-29T23:32:54Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -1,35 +1,35 @@\n package org.apache.phoenix.schema;\n \n+import com.google.common.collect.ImmutableList;\n import com.google.common.collect.Sets;\n+import com.google.inject.internal.util.$ImmutableCollection;\n import org.apache.commons.lang.StringUtils;\n import org.apache.hadoop.conf.Configuration;\n import org.apache.hadoop.hbase.HColumnDescriptor;\n+import org.apache.hadoop.hbase.HConstants;\n import org.apache.hadoop.hbase.HTableDescriptor;\n import org.apache.hadoop.hbase.TableName;\n import org.apache.hadoop.hbase.io.ImmutableBytesWritable;\n import org.apache.hadoop.hbase.util.Bytes;\n import org.apache.phoenix.jdbc.PhoenixConnection;\n import org.apache.phoenix.mapreduce.util.ConnectionUtil;\n import org.apache.phoenix.query.ConnectionQueryServices;\n+import org.apache.phoenix.query.QueryConstants;\n import org.apache.phoenix.util.MetaDataUtil;\n import org.apache.phoenix.util.PhoenixRuntime;\n import org.apache.phoenix.util.SchemaUtil;\n \n import java.io.IOException;\n import java.sql.Connection;\n import java.sql.SQLException;\n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.HashSet;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Set;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTY3NjUx", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457967651", "createdAt": "2020-07-29T23:34:01Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozNDowMVrOG5N03g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozNDowMVrOG5N03g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY0ODU0Mg==", "bodyText": "nit: cfMap or cfToPropertyValueMap", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462648542", "createdAt": "2020-07-29T23:34:01Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -250,12 +247,31 @@ private void setHTableProperties(HTableDescriptor htd) {\n         }\n     }\n \n-    private void setHColumnFamilyProperties(HColumnDescriptor columnDescriptor) {\n-        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptor.getValues();\n-        for (Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()) {\n+    private void setHColumnFamilyProperties(HColumnDescriptor[] columnDescriptors) {\n+        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptors[0].getValues();\n+        for(Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()){\n             ImmutableBytesWritable key = entry.getKey();\n-            ImmutableBytesWritable value = entry.getValue();\n-            definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+            ImmutableBytesWritable defaultValue = entry.getValue();\n+            Map<String, String> CFMap = new HashMap<String, String>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTY3ODgw", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457967880", "createdAt": "2020-07-29T23:34:38Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozNDozOVrOG5N1iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozNDozOVrOG5N1iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY0ODcxMw==", "bodyText": "space before {", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462648713", "createdAt": "2020-07-29T23:34:39Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -250,12 +247,31 @@ private void setHTableProperties(HTableDescriptor htd) {\n         }\n     }\n \n-    private void setHColumnFamilyProperties(HColumnDescriptor columnDescriptor) {\n-        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptor.getValues();\n-        for (Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()) {\n+    private void setHColumnFamilyProperties(HColumnDescriptor[] columnDescriptors) {\n+        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptors[0].getValues();\n+        for(Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()){\n             ImmutableBytesWritable key = entry.getKey();\n-            ImmutableBytesWritable value = entry.getValue();\n-            definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+            ImmutableBytesWritable defaultValue = entry.getValue();\n+            Map<String, String> CFMap = new HashMap<String, String>();\n+            Set<ImmutableBytesWritable> set = new HashSet<ImmutableBytesWritable>();\n+            for(HColumnDescriptor columnDescriptor: columnDescriptors){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTY4NTI0", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457968524", "createdAt": "2020-07-29T23:36:31Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozNjozMVrOG5N3-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozNjozMVrOG5N3-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY0OTMzOA==", "bodyText": "space before { and at other similar spots", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462649338", "createdAt": "2020-07-29T23:36:31Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -250,12 +247,31 @@ private void setHTableProperties(HTableDescriptor htd) {\n         }\n     }\n \n-    private void setHColumnFamilyProperties(HColumnDescriptor columnDescriptor) {\n-        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptor.getValues();\n-        for (Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()) {\n+    private void setHColumnFamilyProperties(HColumnDescriptor[] columnDescriptors) {\n+        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptors[0].getValues();\n+        for(Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()){\n             ImmutableBytesWritable key = entry.getKey();\n-            ImmutableBytesWritable value = entry.getValue();\n-            definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+            ImmutableBytesWritable defaultValue = entry.getValue();\n+            Map<String, String> CFMap = new HashMap<String, String>();\n+            Set<ImmutableBytesWritable> set = new HashSet<ImmutableBytesWritable>();\n+            for(HColumnDescriptor columnDescriptor: columnDescriptors){\n+                String columnFamilyName = Bytes.toString(columnDescriptor.getName());\n+                ImmutableBytesWritable value = columnDescriptor.getValues().get(key);\n+                // check if it is universal properties\n+                if (SYNCED_DATA_TABLE_AND_INDEX_COL_FAM_PROPERTIES.contains(Bytes.toString(key.get()))){\n+                    definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+                    continue;\n+                }\n+                CFMap.put(columnFamilyName, Bytes.toString(value.get()));\n+                set.add(value);\n+            }\n+            if (set.size() > 1){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 116}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTY4OTA1", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457968905", "createdAt": "2020-07-29T23:37:41Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozNzo0MVrOG5N5YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzozNzo0MVrOG5N5YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY0OTY5Nw==", "bodyText": "let's call it globalValue", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462649697", "createdAt": "2020-07-29T23:37:41Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -250,12 +247,31 @@ private void setHTableProperties(HTableDescriptor htd) {\n         }\n     }\n \n-    private void setHColumnFamilyProperties(HColumnDescriptor columnDescriptor) {\n-        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptor.getValues();\n-        for (Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()) {\n+    private void setHColumnFamilyProperties(HColumnDescriptor[] columnDescriptors) {\n+        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptors[0].getValues();\n+        for(Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()){\n             ImmutableBytesWritable key = entry.getKey();\n-            ImmutableBytesWritable value = entry.getValue();\n-            definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+            ImmutableBytesWritable defaultValue = entry.getValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTcxNzQx", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457971741", "createdAt": "2020-07-29T23:46:17Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzo0NjoxOFrOG5ODrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzo0NjoxOFrOG5ODrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY1MjMzMg==", "bodyText": "nit: cfPropertyValueSet", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462652332", "createdAt": "2020-07-29T23:46:18Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -250,12 +247,31 @@ private void setHTableProperties(HTableDescriptor htd) {\n         }\n     }\n \n-    private void setHColumnFamilyProperties(HColumnDescriptor columnDescriptor) {\n-        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptor.getValues();\n-        for (Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()) {\n+    private void setHColumnFamilyProperties(HColumnDescriptor[] columnDescriptors) {\n+        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptors[0].getValues();\n+        for(Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()){\n             ImmutableBytesWritable key = entry.getKey();\n-            ImmutableBytesWritable value = entry.getValue();\n-            definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+            ImmutableBytesWritable defaultValue = entry.getValue();\n+            Map<String, String> CFMap = new HashMap<String, String>();\n+            Set<ImmutableBytesWritable> set = new HashSet<ImmutableBytesWritable>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 104}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTcyODE1", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457972815", "createdAt": "2020-07-29T23:49:31Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzo0OTozMVrOG5OHnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzo0OTozMVrOG5OHnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY1MzM0MQ==", "bodyText": "Let's say there are 3 CFs and only 2 of them have VERSIONS=2. Would this work? Let's add a test if we don't have one to cover this scenario.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462653341", "createdAt": "2020-07-29T23:49:31Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -250,12 +247,31 @@ private void setHTableProperties(HTableDescriptor htd) {\n         }\n     }\n \n-    private void setHColumnFamilyProperties(HColumnDescriptor columnDescriptor) {\n-        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptor.getValues();\n-        for (Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()) {\n+    private void setHColumnFamilyProperties(HColumnDescriptor[] columnDescriptors) {\n+        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptors[0].getValues();\n+        for(Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()){\n             ImmutableBytesWritable key = entry.getKey();\n-            ImmutableBytesWritable value = entry.getValue();\n-            definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+            ImmutableBytesWritable defaultValue = entry.getValue();\n+            Map<String, String> CFMap = new HashMap<String, String>();\n+            Set<ImmutableBytesWritable> set = new HashSet<ImmutableBytesWritable>();\n+            for(HColumnDescriptor columnDescriptor: columnDescriptors){\n+                String columnFamilyName = Bytes.toString(columnDescriptor.getName());\n+                ImmutableBytesWritable value = columnDescriptor.getValues().get(key);\n+                // check if it is universal properties\n+                if (SYNCED_DATA_TABLE_AND_INDEX_COL_FAM_PROPERTIES.contains(Bytes.toString(key.get()))){\n+                    definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+                    continue;\n+                }\n+                CFMap.put(columnFamilyName, Bytes.toString(value.get()));\n+                set.add(value);\n+            }\n+            if (set.size() > 1){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 116}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTc1NTE0", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457975514", "createdAt": "2020-07-29T23:57:30Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzo1NzozMFrOG5OQyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMzo1NzozMFrOG5OQyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY1NTY4OA==", "bodyText": "I think we can maintain a map of [propertyValue and occurances] and execute line no. 273 only when exactly one entry from the map has occurrences equal to the no. of column families.\nAlso, good to refactor this logic in another function.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462655688", "createdAt": "2020-07-29T23:57:30Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -250,12 +247,31 @@ private void setHTableProperties(HTableDescriptor htd) {\n         }\n     }\n \n-    private void setHColumnFamilyProperties(HColumnDescriptor columnDescriptor) {\n-        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptor.getValues();\n-        for (Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()) {\n+    private void setHColumnFamilyProperties(HColumnDescriptor[] columnDescriptors) {\n+        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptors[0].getValues();\n+        for(Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()){\n             ImmutableBytesWritable key = entry.getKey();\n-            ImmutableBytesWritable value = entry.getValue();\n-            definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+            ImmutableBytesWritable defaultValue = entry.getValue();\n+            Map<String, String> CFMap = new HashMap<String, String>();\n+            Set<ImmutableBytesWritable> set = new HashSet<ImmutableBytesWritable>();\n+            for(HColumnDescriptor columnDescriptor: columnDescriptors){\n+                String columnFamilyName = Bytes.toString(columnDescriptor.getName());\n+                ImmutableBytesWritable value = columnDescriptor.getValues().get(key);\n+                // check if it is universal properties\n+                if (SYNCED_DATA_TABLE_AND_INDEX_COL_FAM_PROPERTIES.contains(Bytes.toString(key.get()))){\n+                    definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+                    continue;\n+                }\n+                CFMap.put(columnFamilyName, Bytes.toString(value.get()));\n+                set.add(value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTc2NDgw", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457976480", "createdAt": "2020-07-30T00:00:09Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDowMDowOVrOG5OUMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDowMDowOVrOG5OUMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY1NjU2MA==", "bodyText": "nit: this if condition is duplicated in the else part. Please refactor it by extracting common parts and executing specific Array related logic when if clause passes.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462656560", "createdAt": "2020-07-30T00:00:09Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -374,20 +397,49 @@ private String getColumnInfoStringForView(PTable table, PTable baseTable) {\n \n     private String extractColumn(PColumn column) {\n         String colName = column.getName().getString();\n+        if (column.getFamilyName() != null){\n+            String colFamilyName = column.getFamilyName().getString();\n+            // check if it is default column family name\n+            colName = colFamilyName.equals(QueryConstants.DEFAULT_COLUMN_FAMILY)? colName : String.format(\"\\\"%s\\\".\\\"%s\\\"\", colFamilyName, colName);\n+        }\n+        boolean isArrayType = column.getDataType().isArrayType();\n         String type = column.getDataType().getSqlTypeName();\n+        Integer maxLength = column.getMaxLength();\n+        Integer arrSize = column.getArraySize();\n+        Integer scale = column.getScale();\n         StringBuilder buf = new StringBuilder(colName);\n         buf.append(' ');\n-        buf.append(type);\n-        Integer maxLength = column.getMaxLength();\n-        if (maxLength != null) {\n-            buf.append('(');\n-            buf.append(maxLength);\n-            Integer scale = column.getScale();\n-            if (scale != null) {\n-                buf.append(',');\n-                buf.append(scale); // has both max length and scale. For ex- decimal(10,2)\n+\n+        if (isArrayType) {\n+            String arrayPrefix = type.split(\"\\\\s+\")[0];\n+            buf.append(arrayPrefix);\n+            if (maxLength != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 191}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTc2ODc3", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457976877", "createdAt": "2020-07-30T00:01:24Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDowMToyNFrOG5OVjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDowMToyNFrOG5OVjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY1NjkxMA==", "bodyText": "Thanks for adding this.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462656910", "createdAt": "2020-07-30T00:01:24Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/it/java/org/apache/phoenix/schema/SchemaExtractionToolIT.java", "diffHunk": "@@ -210,4 +206,188 @@ public void testCreateViewIndexStatement() throws Exception {\n             Assert.assertEquals(createIndexStatement.toUpperCase(), set.getOutput().toUpperCase());\n         }\n     }\n+\n+    @Test\n+    public void testSaltedTableStatement() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_integer integer not null CONSTRAINT pk PRIMARY KEY (a_integer)) SALT_BUCKETS=16\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+            String actualProperties = set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1);\n+            Assert.assertEquals(true, actualProperties.contains(\"SALT_BUCKETS=16\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithPKConstraint() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(15) NOT NULL, \" +\n+                    \"c_bigint BIGINT NOT NULL CONSTRAINT PK PRIMARY KEY (a_char, b_char, c_bigint)) IMMUTABLE_ROWS=TRUE\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithArrayColumn() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"c_var_array VARCHAR ARRAY, \" +\n+                    \"d_char_array CHAR(15) ARRAY[3] CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                    \"TTL=2592000, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, DISABLE_TABLE_SOR=true, REPLICATION_SCOPE=1\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithNonDefaultColumnFamily() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                    \"TTL=1209600, IMMUTABLE_ROWS=true, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, DISABLE_TABLE_SOR=true, MULTI_TENANT=true\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithUniversalCFProperties() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"KEEP_DELETED_CELLS=TRUE, TTL=1209600, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, REPLICATION_SCOPE=1\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+\n+    @Test\n+    public void testCreateTableWithMultipleCFs() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"\\\"av\\\".VERSIONS=2, \\\"bv\\\".VERSIONS=3, \" +\n+                \"\\\"cv\\\".VERSIONS=4, DATA_BLOCK_ENCODING=DIFF, \" +\n+                \"IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, DISABLE_TABLE_SOR=true, MULTI_TENANT=true\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(true, compareProperties(properties, set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1)));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateIndexStatementWithColumnFamily() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        String indexName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            conn.createStatement().execute(\"CREATE TABLE \"+pTableFullName + \"(k VARCHAR NOT NULL PRIMARY KEY, \\\"av\\\".\\\"_\\\" CHAR(1), v2 VARCHAR)\");\n+            String createIndexStatement = \"CREATE INDEX \"+ indexName + \" ON \"+pTableFullName+ \"(\\\"av\\\".\\\"_\\\")\";\n+            conn.createStatement().execute(createIndexStatement);\n+            conn.commit();\n+\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            String [] args2 = {\"-tb\", indexName, \"-s\", schemaName};\n+            set.run(args2);\n+            Assert.assertEquals(createIndexStatement.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    private boolean compareProperties(String prop1, String prop2){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 220}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTc3MTE5", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457977119", "createdAt": "2020-07-30T00:02:09Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDowMjowOVrOG5OWeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDowMjowOVrOG5OWeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY1NzE0Ng==", "bodyText": "nit: remove the commented code", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462657146", "createdAt": "2020-07-30T00:02:09Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/it/java/org/apache/phoenix/schema/SchemaExtractionToolIT.java", "diffHunk": "@@ -33,22 +30,21 @@ public void testCreateTableStatement() throws Exception {\n         String tableName = generateUniqueName();\n         String schemaName = generateUniqueName();\n         Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n         String properties = \"TTL=2592000,IMMUTABLE_ROWS=true,DISABLE_WAL=true\";\n+        String createTable = \"CREATE TABLE \"+ pTableFullName + \"(K VARCHAR NOT NULL PRIMARY KEY, \"\n+                + \"V1 VARCHAR, V2 VARCHAR) TTL=2592000, IMMUTABLE_ROWS=TRUE, DISABLE_WAL=TRUE\";\n \n         try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n-\n-            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n-            conn.createStatement().execute(\"CREATE TABLE \"+ pTableFullName + \"(k VARCHAR NOT NULL PRIMARY KEY, \"\n-                    + \"v1 VARCHAR, v2 VARCHAR)\"\n-                    + properties);\n+            conn.createStatement().execute(createTable);\n             conn.commit();\n             String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n \n             SchemaExtractionTool set = new SchemaExtractionTool();\n             set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n             set.run(args);\n-            String actualProperties = set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1).replace(\" \",\"\");\n-            Assert.assertEquals(3, actualProperties.split(\",\").length);\n+            //String actualProperties = set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1).replace(\" \",\"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTc3Mzg2", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457977386", "createdAt": "2020-07-30T00:03:00Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDowMzowMVrOG5OXWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDowMzowMVrOG5OXWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY1NzM3MQ==", "bodyText": "can use assertTrue directly.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462657371", "createdAt": "2020-07-30T00:03:01Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/it/java/org/apache/phoenix/schema/SchemaExtractionToolIT.java", "diffHunk": "@@ -210,4 +206,188 @@ public void testCreateViewIndexStatement() throws Exception {\n             Assert.assertEquals(createIndexStatement.toUpperCase(), set.getOutput().toUpperCase());\n         }\n     }\n+\n+    @Test\n+    public void testSaltedTableStatement() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_integer integer not null CONSTRAINT pk PRIMARY KEY (a_integer)) SALT_BUCKETS=16\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+            String actualProperties = set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1);\n+            Assert.assertEquals(true, actualProperties.contains(\"SALT_BUCKETS=16\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithPKConstraint() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(15) NOT NULL, \" +\n+                    \"c_bigint BIGINT NOT NULL CONSTRAINT PK PRIMARY KEY (a_char, b_char, c_bigint)) IMMUTABLE_ROWS=TRUE\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithArrayColumn() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"c_var_array VARCHAR ARRAY, \" +\n+                    \"d_char_array CHAR(15) ARRAY[3] CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                    \"TTL=2592000, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, DISABLE_TABLE_SOR=true, REPLICATION_SCOPE=1\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithNonDefaultColumnFamily() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                    \"TTL=1209600, IMMUTABLE_ROWS=true, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, DISABLE_TABLE_SOR=true, MULTI_TENANT=true\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithUniversalCFProperties() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"KEEP_DELETED_CELLS=TRUE, TTL=1209600, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, REPLICATION_SCOPE=1\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+\n+    @Test\n+    public void testCreateTableWithMultipleCFs() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"\\\"av\\\".VERSIONS=2, \\\"bv\\\".VERSIONS=3, \" +\n+                \"\\\"cv\\\".VERSIONS=4, DATA_BLOCK_ENCODING=DIFF, \" +\n+                \"IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, DISABLE_TABLE_SOR=true, MULTI_TENANT=true\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(true, compareProperties(properties, set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 195}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTc3NzE5", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457977719", "createdAt": "2020-07-30T00:04:01Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDowNDowMVrOG5OYWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDowNDowMVrOG5OYWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY1NzYyNw==", "bodyText": "nit: could you please remove this variable? It is not used anymore.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r462657627", "createdAt": "2020-07-30T00:04:01Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/it/java/org/apache/phoenix/schema/SchemaExtractionToolIT.java", "diffHunk": "@@ -33,22 +30,21 @@ public void testCreateTableStatement() throws Exception {\n         String tableName = generateUniqueName();\n         String schemaName = generateUniqueName();\n         Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n         String properties = \"TTL=2592000,IMMUTABLE_ROWS=true,DISABLE_WAL=true\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTc5OTc4", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-457979978", "createdAt": "2020-07-30T00:09:50Z", "commit": {"oid": "1e63d93b0c1e6e74f2b024efcf17b6381999048b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fa8f10577f99bd7232e1bd5b2a196c3f2c19ea3", "author": {"user": {"login": "Qinrui98", "name": "Qinrui Li"}}, "url": "https://github.com/apache/phoenix/commit/4fa8f10577f99bd7232e1bd5b2a196c3f2c19ea3", "committedDate": "2020-07-30T16:16:08Z", "message": "p table stash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a13afa29a0414f6149642a279e7a482a4a9dedaa", "author": {"user": {"login": "Qinrui98", "name": "Qinrui Li"}}, "url": "https://github.com/apache/phoenix/commit/a13afa29a0414f6149642a279e7a482a4a9dedaa", "committedDate": "2020-07-30T17:27:13Z", "message": "add additional tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d64d2181405117b79f4e723678f3db85501663a2", "author": {"user": {"login": "Qinrui98", "name": "Qinrui Li"}}, "url": "https://github.com/apache/phoenix/commit/d64d2181405117b79f4e723678f3db85501663a2", "committedDate": "2020-07-30T18:29:39Z", "message": "add more tests and refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15831283360d140e55a8fc091d6db64f41f71445", "author": {"user": {"login": "Qinrui98", "name": "Qinrui Li"}}, "url": "https://github.com/apache/phoenix/commit/15831283360d140e55a8fc091d6db64f41f71445", "committedDate": "2020-07-30T18:40:13Z", "message": "add imports back"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NzQxNDY5", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-458741469", "createdAt": "2020-07-30T20:42:43Z", "commit": {"oid": "15831283360d140e55a8fc091d6db64f41f71445"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMDo0Mjo0M1rOG5zG_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMTowODoxOVrOG5z49g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI1OTM5MQ==", "bodyText": "Several of these tests are of the form:\n\nCreate a table according to some SQL and table name\nRun SchemaExtractionTool\nAssert that output is equal to the original SQL.\n\nCan we extract that logic into a helper function and you just pass in different tablename and SQL in each test?", "url": "https://github.com/apache/phoenix/pull/848#discussion_r463259391", "createdAt": "2020-07-30T20:42:43Z", "author": {"login": "gjacoby126"}, "path": "phoenix-tools/src/it/java/org/apache/phoenix/schema/SchemaExtractionToolIT.java", "diffHunk": "@@ -210,4 +204,242 @@ public void testCreateViewIndexStatement() throws Exception {\n             Assert.assertEquals(createIndexStatement.toUpperCase(), set.getOutput().toUpperCase());\n         }\n     }\n+\n+    @Test\n+    public void testSaltedTableStatement() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_integer integer not null CONSTRAINT pk PRIMARY KEY (a_integer)) SALT_BUCKETS=16\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+            String actualProperties = set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1);\n+            Assert.assertEquals(true, actualProperties.contains(\"SALT_BUCKETS=16\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithPKConstraint() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15831283360d140e55a8fc091d6db64f41f71445"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI2MTk4Ng==", "bodyText": "Good edge case to check!", "url": "https://github.com/apache/phoenix/pull/848#discussion_r463261986", "createdAt": "2020-07-30T20:47:57Z", "author": {"login": "gjacoby126"}, "path": "phoenix-tools/src/it/java/org/apache/phoenix/schema/SchemaExtractionToolIT.java", "diffHunk": "@@ -210,4 +204,242 @@ public void testCreateViewIndexStatement() throws Exception {\n             Assert.assertEquals(createIndexStatement.toUpperCase(), set.getOutput().toUpperCase());\n         }\n     }\n+\n+    @Test\n+    public void testSaltedTableStatement() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_integer integer not null CONSTRAINT pk PRIMARY KEY (a_integer)) SALT_BUCKETS=16\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+            String actualProperties = set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1);\n+            Assert.assertEquals(true, actualProperties.contains(\"SALT_BUCKETS=16\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithPKConstraint() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(15) NOT NULL, \" +\n+                    \"c_bigint BIGINT NOT NULL CONSTRAINT PK PRIMARY KEY (a_char, b_char, c_bigint)) IMMUTABLE_ROWS=TRUE\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithArrayColumn() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"c_var_array VARCHAR ARRAY, \" +\n+                    \"d_char_array CHAR(15) ARRAY[3] CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15831283360d140e55a8fc091d6db64f41f71445"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI2NTY1NA==", "bodyText": "nit: comment on what exactly you're checking here would be useful.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r463265654", "createdAt": "2020-07-30T20:55:05Z", "author": {"login": "gjacoby126"}, "path": "phoenix-tools/src/it/java/org/apache/phoenix/schema/SchemaExtractionToolIT.java", "diffHunk": "@@ -210,4 +204,242 @@ public void testCreateViewIndexStatement() throws Exception {\n             Assert.assertEquals(createIndexStatement.toUpperCase(), set.getOutput().toUpperCase());\n         }\n     }\n+\n+    @Test\n+    public void testSaltedTableStatement() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_integer integer not null CONSTRAINT pk PRIMARY KEY (a_integer)) SALT_BUCKETS=16\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+            String actualProperties = set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1);\n+            Assert.assertEquals(true, actualProperties.contains(\"SALT_BUCKETS=16\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithPKConstraint() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(15) NOT NULL, \" +\n+                    \"c_bigint BIGINT NOT NULL CONSTRAINT PK PRIMARY KEY (a_char, b_char, c_bigint)) IMMUTABLE_ROWS=TRUE\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithArrayColumn() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"c_var_array VARCHAR ARRAY, \" +\n+                    \"d_char_array CHAR(15) ARRAY[3] CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                    \"TTL=2592000, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, DISABLE_TABLE_SOR=true, REPLICATION_SCOPE=1\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithNonDefaultColumnFamily() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                    \"TTL=1209600, IMMUTABLE_ROWS=true, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, DISABLE_TABLE_SOR=true, MULTI_TENANT=true\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithUniversalCFProperties() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"KEEP_DELETED_CELLS=TRUE, TTL=1209600, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, REPLICATION_SCOPE=1\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithDefaultCFProperties() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"KEEP_DELETED_CELLS=TRUE, TTL=1209600, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, REPLICATION_SCOPE=1, DEFAULT_COLUMN_FAMILY=cv\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertTrue(compareProperties(properties, set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15831283360d140e55a8fc091d6db64f41f71445"}, "originalPosition": 191}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI2NjA2OA==", "bodyText": "nit: please use a more informative name.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r463266068", "createdAt": "2020-07-30T20:55:47Z", "author": {"login": "gjacoby126"}, "path": "phoenix-tools/src/it/java/org/apache/phoenix/schema/SchemaExtractionToolIT.java", "diffHunk": "@@ -210,4 +204,242 @@ public void testCreateViewIndexStatement() throws Exception {\n             Assert.assertEquals(createIndexStatement.toUpperCase(), set.getOutput().toUpperCase());\n         }\n     }\n+\n+    @Test\n+    public void testSaltedTableStatement() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_integer integer not null CONSTRAINT pk PRIMARY KEY (a_integer)) SALT_BUCKETS=16\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+            String actualProperties = set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1);\n+            Assert.assertEquals(true, actualProperties.contains(\"SALT_BUCKETS=16\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithPKConstraint() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(15) NOT NULL, \" +\n+                    \"c_bigint BIGINT NOT NULL CONSTRAINT PK PRIMARY KEY (a_char, b_char, c_bigint)) IMMUTABLE_ROWS=TRUE\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithArrayColumn() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"c_var_array VARCHAR ARRAY, \" +\n+                    \"d_char_array CHAR(15) ARRAY[3] CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                    \"TTL=2592000, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, DISABLE_TABLE_SOR=true, REPLICATION_SCOPE=1\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithNonDefaultColumnFamily() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                    \"TTL=1209600, IMMUTABLE_ROWS=true, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, DISABLE_TABLE_SOR=true, MULTI_TENANT=true\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithUniversalCFProperties() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"KEEP_DELETED_CELLS=TRUE, TTL=1209600, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, REPLICATION_SCOPE=1\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithDefaultCFProperties() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"KEEP_DELETED_CELLS=TRUE, TTL=1209600, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, REPLICATION_SCOPE=1, DEFAULT_COLUMN_FAMILY=cv\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertTrue(compareProperties(properties, set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1)));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithMultipleCFProperties() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"\\\"av\\\".VERSIONS=2, \\\"bv\\\".VERSIONS=3, \" +\n+                \"\\\"cv\\\".VERSIONS=4, DATA_BLOCK_ENCODING=DIFF, \" +\n+                \"IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, DISABLE_TABLE_SOR=true, MULTI_TENANT=true\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertTrue(compareProperties(properties, set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1)));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithMultipleCFProperties2() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15831283360d140e55a8fc091d6db64f41f71445"}, "originalPosition": 225}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI2NjY4Mw==", "bodyText": "likewise, please specify what you're trying to show here. You also might want to extract \"set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1)\" into a function with a user-friendly name since you do this operation in many tests, I think to get the properties.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r463266683", "createdAt": "2020-07-30T20:57:05Z", "author": {"login": "gjacoby126"}, "path": "phoenix-tools/src/it/java/org/apache/phoenix/schema/SchemaExtractionToolIT.java", "diffHunk": "@@ -210,4 +204,242 @@ public void testCreateViewIndexStatement() throws Exception {\n             Assert.assertEquals(createIndexStatement.toUpperCase(), set.getOutput().toUpperCase());\n         }\n     }\n+\n+    @Test\n+    public void testSaltedTableStatement() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_integer integer not null CONSTRAINT pk PRIMARY KEY (a_integer)) SALT_BUCKETS=16\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+            String actualProperties = set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1);\n+            Assert.assertEquals(true, actualProperties.contains(\"SALT_BUCKETS=16\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithPKConstraint() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(15) NOT NULL, \" +\n+                    \"c_bigint BIGINT NOT NULL CONSTRAINT PK PRIMARY KEY (a_char, b_char, c_bigint)) IMMUTABLE_ROWS=TRUE\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String [] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithArrayColumn() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"c_var_array VARCHAR ARRAY, \" +\n+                    \"d_char_array CHAR(15) ARRAY[3] CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                    \"TTL=2592000, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, DISABLE_TABLE_SOR=true, REPLICATION_SCOPE=1\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithNonDefaultColumnFamily() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                    \"TTL=1209600, IMMUTABLE_ROWS=true, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, DISABLE_TABLE_SOR=true, MULTI_TENANT=true\";\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithUniversalCFProperties() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"KEEP_DELETED_CELLS=TRUE, TTL=1209600, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, REPLICATION_SCOPE=1\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertEquals(query.toUpperCase(), set.getOutput().toUpperCase());\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithDefaultCFProperties() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"KEEP_DELETED_CELLS=TRUE, TTL=1209600, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, REPLICATION_SCOPE=1, DEFAULT_COLUMN_FAMILY=cv\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertTrue(compareProperties(properties, set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1)));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithMultipleCFProperties() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"\\\"av\\\".VERSIONS=2, \\\"bv\\\".VERSIONS=3, \" +\n+                \"\\\"cv\\\".VERSIONS=4, DATA_BLOCK_ENCODING=DIFF, \" +\n+                \"IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, DISABLE_TABLE_SOR=true, MULTI_TENANT=true\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertTrue(compareProperties(properties, set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1)));\n+        }\n+    }\n+\n+    @Test\n+    public void testCreateTableWithMultipleCFProperties2() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        String properties = \"\\\"av\\\".VERSIONS=2, \\\"bv\\\".VERSIONS=2, \" +\n+                \"DATA_BLOCK_ENCODING=DIFF, \" +\n+                \"IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, DISABLE_TABLE_SOR=true, MULTI_TENANT=true\";\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+            String query = \"create table \" + pTableFullName +\n+                    \"(a_char CHAR(15) NOT NULL, \" +\n+                    \"b_char CHAR(10) NOT NULL, \" +\n+                    \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                    \"\\\"cv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+            conn.createStatement().execute(query);\n+            conn.commit();\n+            String[] args = {\"-tb\", tableName, \"-s\", schemaName};\n+            SchemaExtractionTool set = new SchemaExtractionTool();\n+            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n+            set.run(args);\n+\n+            Assert.assertTrue(compareProperties(properties, set.getOutput().substring(set.getOutput().lastIndexOf(\")\")+1)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15831283360d140e55a8fc091d6db64f41f71445"}, "originalPosition": 248}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI3MTM5NQ==", "bodyText": "I'm curious why we're qualifying the CF properties in one flat HashSet instead of a HashSet<String, HashSet<String, String>>? Can we guarantee that no CF properties will ever have a period in them?", "url": "https://github.com/apache/phoenix/pull/848#discussion_r463271395", "createdAt": "2020-07-30T21:06:33Z", "author": {"login": "gjacoby126"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -250,12 +247,31 @@ private void setHTableProperties(HTableDescriptor htd) {\n         }\n     }\n \n-    private void setHColumnFamilyProperties(HColumnDescriptor columnDescriptor) {\n-        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptor.getValues();\n-        for (Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()) {\n+    private void setHColumnFamilyProperties(HColumnDescriptor[] columnDescriptors) {\n+        Map<ImmutableBytesWritable, ImmutableBytesWritable> propsMap = columnDescriptors[0].getValues();\n+        for(Map.Entry<ImmutableBytesWritable, ImmutableBytesWritable> entry : propsMap.entrySet()) {\n             ImmutableBytesWritable key = entry.getKey();\n-            ImmutableBytesWritable value = entry.getValue();\n-            definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+            ImmutableBytesWritable globalValue = entry.getValue();\n+            Map<String, String> cfToPropertyValueMap = new HashMap<String, String>();\n+            Set<ImmutableBytesWritable> cfPropertyValueSet = new HashSet<ImmutableBytesWritable>();\n+            for(HColumnDescriptor columnDescriptor: columnDescriptors) {\n+                String columnFamilyName = Bytes.toString(columnDescriptor.getName());\n+                ImmutableBytesWritable value = columnDescriptor.getValues().get(key);\n+                // check if it is universal properties\n+                if (SYNCED_DATA_TABLE_AND_INDEX_COL_FAM_PROPERTIES.contains(Bytes.toString(key.get()))) {\n+                    definedProps.put(Bytes.toString(key.get()), Bytes.toString(value.get()));\n+                    break;\n+                }\n+                cfToPropertyValueMap.put(columnFamilyName, Bytes.toString(value.get()));\n+                cfPropertyValueSet.add(value);\n+            }\n+            if (cfPropertyValueSet.size() > 1) {\n+                for(Map.Entry<String, String> mapEntry: cfToPropertyValueMap.entrySet()) {\n+                    definedProps.put(String.format(\"%s.%s\",  mapEntry.getKey(), Bytes.toString(key.get())), mapEntry.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15831283360d140e55a8fc091d6db64f41f71445"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI3MjE4Mg==", "bodyText": "Good catch for salted tables, those are easy to miss.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r463272182", "createdAt": "2020-07-30T21:08:19Z", "author": {"login": "gjacoby126"}, "path": "phoenix-tools/src/main/java/org/apache/phoenix/schema/SchemaExtractionProcessor.java", "diffHunk": "@@ -312,9 +336,8 @@ public Connection getConnection() throws SQLException {\n \n     private String getColumnInfoStringForTable(PTable table) {\n         StringBuilder colInfo = new StringBuilder();\n-\n-        List<PColumn> columns = table.getColumns();\n-        List<PColumn> pkColumns = table.getPKColumns();\n+        List<PColumn> columns = table.getBucketNum() == null ? table.getColumns() : table.getColumns().subList(1, table.getColumns().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15831283360d140e55a8fc091d6db64f41f71445"}, "originalPosition": 145}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fd9e0853e801009e7f9895eb604d5459996815d", "author": {"user": {"login": "Qinrui98", "name": "Qinrui Li"}}, "url": "https://github.com/apache/phoenix/commit/6fd9e0853e801009e7f9895eb604d5459996815d", "committedDate": "2020-08-03T20:59:24Z", "message": "refactor IT tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbf621e75a9d5c2f68e9497574b1fc70fc67ec1b", "author": {"user": {"login": "Qinrui98", "name": "Qinrui Li"}}, "url": "https://github.com/apache/phoenix/commit/fbf621e75a9d5c2f68e9497574b1fc70fc67ec1b", "committedDate": "2020-08-03T21:28:24Z", "message": "fix IT tests typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzk4MzI0", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-460398324", "createdAt": "2020-08-03T23:19:01Z", "commit": {"oid": "fbf621e75a9d5c2f68e9497574b1fc70fc67ec1b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMzoxOTowMVrOG7Ltfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMzoxOTowMVrOG7Ltfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxMTAzOQ==", "bodyText": "I feel this and testCreateTableWithNonDefaultColumnFamily can be clubbed into one test?", "url": "https://github.com/apache/phoenix/pull/848#discussion_r464711039", "createdAt": "2020-08-03T23:19:01Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/it/java/org/apache/phoenix/schema/SchemaExtractionToolIT.java", "diffHunk": "@@ -58,156 +130,251 @@ public void testCreateTableStatement_tenant() throws Exception {\n         String viewName = generateUniqueName();\n         String schemaName = generateUniqueName();\n         String tenantId = \"abc\";\n-        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n         String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n-        String properties = \"TTL=2592000,IMMUTABLE_ROWS=true,DISABLE_WAL=true\";\n-        SchemaExtractionTool set;\n+        String createTableStmt = \"CREATE TABLE \"+pTableFullName + \"(k BIGINT NOT NULL PRIMARY KEY, \"\n+                + \"v1 VARCHAR, v2 VARCHAR)\";\n         String viewFullName = SchemaUtil.getQualifiedTableName(schemaName, viewName);\n-        String createView = \"CREATE VIEW \"+viewFullName + \"(id1 BIGINT, id2 BIGINT NOT NULL, \"\n+        String createViewStmt = \"CREATE VIEW \"+viewFullName + \"(id1 BIGINT, id2 BIGINT NOT NULL, \"\n                 + \"id3 VARCHAR NOT NULL CONSTRAINT PKVIEW PRIMARY KEY (id2, id3 DESC)) \"\n                 + \"AS SELECT * FROM \"+pTableFullName;\n \n-        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n-\n-            conn.createStatement().execute(\"CREATE TABLE \"+pTableFullName + \"(k BIGINT NOT NULL PRIMARY KEY, \"\n-                    + \"v1 VARCHAR, v2 VARCHAR)\"\n-                    + properties);\n-            set = new SchemaExtractionTool();\n-            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n-            conn.commit();\n-        }\n-        try (Connection conn = getTenantConnection(getUrl(), tenantId)) {\n-            conn.createStatement().execute(createView);\n-            conn.commit();\n-        }\n-        String [] args = {\"-tb\", viewName, \"-s\", schemaName, \"-t\", tenantId};\n-        set.run(args);\n-        Assert.assertEquals(createView.toUpperCase(), set.getOutput().toUpperCase());\n+        List<String> queries1 = new ArrayList<String>(){};\n+        queries1.add(createTableStmt);\n+        runSchemaExtractionTool(schemaName, tableName, null, queries1);\n+        List<String> queries2 = new ArrayList<String>();\n+        queries2.add(createViewStmt);\n+        String result2 = runSchemaExtractionTool(schemaName, viewName, tenantId, queries2);\n+        Assert.assertEquals(createViewStmt.toUpperCase(), result2.toUpperCase());\n     }\n \n-    private Connection getTenantConnection(String url, String tenantId) throws SQLException {\n-        Properties props = new Properties();\n-        props.setProperty(PhoenixRuntime.TENANT_ID_ATTRIB, tenantId);\n-        return DriverManager.getConnection(url, props);\n+    @Test\n+    public void testSaltedTableStatement() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+        String query = \"create table \" + pTableFullName +\n+                \"(a_integer integer not null CONSTRAINT pk PRIMARY KEY (a_integer)) SALT_BUCKETS=16\";\n+        List<String> queries = new ArrayList<String>(){};\n+        queries.add(query);\n+        String result = runSchemaExtractionTool(schemaName, tableName, null, queries);\n+        Assert.assertTrue(getProperties(result).contains(\"SALT_BUCKETS=16\"));\n     }\n \n     @Test\n-    public void testCreateIndexStatement() throws Exception {\n+    public void testCreateTableWithPKConstraint() throws Exception {\n         String tableName = generateUniqueName();\n         String schemaName = generateUniqueName();\n-        String indexName = generateUniqueName();\n-        String indexName1 = generateUniqueName();\n-        String indexName2 = generateUniqueName();\n-        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n-        String properties = \"TTL=2592000,IMMUTABLE_ROWS=true,DISABLE_WAL=true\";\n-\n-        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n-\n-            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n-            conn.createStatement().execute(\"CREATE TABLE \"+pTableFullName + \"(k VARCHAR NOT NULL PRIMARY KEY, v1 VARCHAR, v2 VARCHAR)\"\n-                    + properties);\n-\n-            String createIndexStatement = \"CREATE INDEX \"+indexName + \" ON \"+pTableFullName+\"(v1 DESC) INCLUDE (v2)\";\n-\n-            String createIndexStatement1 = \"CREATE INDEX \"+indexName1 + \" ON \"+pTableFullName+\"(v2 DESC) INCLUDE (v1)\";\n-\n-            String createIndexStatement2 = \"CREATE INDEX \"+indexName2 + \" ON \"+pTableFullName+\"(k)\";\n-\n-            conn.createStatement().execute(createIndexStatement);\n-            conn.createStatement().execute(createIndexStatement1);\n-            conn.createStatement().execute(createIndexStatement2);\n-            conn.commit();\n-            SchemaExtractionTool set = new SchemaExtractionTool();\n-            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n-\n-            String [] args = {\"-tb\", indexName, \"-s\", schemaName};\n-            set.run(args);\n-            Assert.assertEquals(createIndexStatement.toUpperCase(), set.getOutput().toUpperCase());\n-\n-            String [] args1 = {\"-tb\", indexName1, \"-s\", schemaName};\n-            set.run(args1);\n-            Assert.assertEquals(createIndexStatement1.toUpperCase(), set.getOutput().toUpperCase());\n-\n-            String [] args2 = {\"-tb\", indexName2, \"-s\", schemaName};\n-            set.run(args2);\n-            Assert.assertEquals(createIndexStatement2.toUpperCase(), set.getOutput().toUpperCase());\n-        }\n+        String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+        String query = \"create table \" + pTableFullName +\n+                \"(a_char CHAR(15) NOT NULL, \" +\n+                \"b_char CHAR(15) NOT NULL, \" +\n+                \"c_bigint BIGINT NOT NULL CONSTRAINT PK PRIMARY KEY (a_char, b_char, c_bigint)) IMMUTABLE_ROWS=TRUE\";\n+        List<String> queries = new ArrayList<String>(){};\n+        queries.add(query);\n+        String result = runSchemaExtractionTool(schemaName, tableName, null, queries);\n+        Assert.assertEquals(query.toUpperCase(), result.toUpperCase());\n     }\n \n     @Test\n-    public void testCreateViewStatement() throws Exception {\n+    public void testCreateTableWithArrayColumn() throws Exception {\n         String tableName = generateUniqueName();\n         String schemaName = generateUniqueName();\n-        String viewName = generateUniqueName();\n-        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n-        String properties = \"TTL=2592000,IMMUTABLE_ROWS=true,DISABLE_WAL=true\";\n+        String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+        String query = \"create table \" + pTableFullName +\n+                \"(a_char CHAR(15) NOT NULL, \" +\n+                \"b_char CHAR(10) NOT NULL, \" +\n+                \"c_var_array VARCHAR ARRAY, \" +\n+                \"d_char_array CHAR(15) ARRAY[3] CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                \"TTL=2592000, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, REPLICATION_SCOPE=1\";\n+        List<String> queries = new ArrayList<String>(){};\n+        queries.add(query);\n+        String result = runSchemaExtractionTool(schemaName, tableName, null, queries);\n+        Assert.assertEquals(query.toUpperCase(), result.toUpperCase());\n+    }\n \n-        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+    @Test\n+    public void testCreateTableWithNonDefaultColumnFamily() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+        String query = \"create table \" + pTableFullName +\n+                \"(a_char CHAR(15) NOT NULL, \" +\n+                \"b_char CHAR(10) NOT NULL, \" +\n+                \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                \"TTL=1209600, IMMUTABLE_ROWS=true, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, MULTI_TENANT=true\";\n+        List<String> queries = new ArrayList<String>(){};\n+        queries.add(query);\n+        String result = runSchemaExtractionTool(schemaName, tableName, null, queries);\n+        Assert.assertEquals(query.toUpperCase(), result.toUpperCase());\n+    }\n \n-            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n-            conn.createStatement().execute(\"CREATE TABLE \"+pTableFullName + \"(k BIGINT NOT NULL PRIMARY KEY, \"\n-                    + \"v1 VARCHAR, v2 VARCHAR)\"\n-                    + properties);\n-            String viewFullName = SchemaUtil.getQualifiedTableName(schemaName, viewName);\n-            String viewFullName1 = SchemaUtil.getQualifiedTableName(schemaName, viewName+\"1\");\n+    @Test\n+    public void testCreateTableWithUniversalCFProperties() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf621e75a9d5c2f68e9497574b1fc70fc67ec1b"}, "originalPosition": 282}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzk4NDk2", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-460398496", "createdAt": "2020-08-03T23:19:35Z", "commit": {"oid": "fbf621e75a9d5c2f68e9497574b1fc70fc67ec1b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMzoxOTozNVrOG7LuVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMzoxOTozNVrOG7LuVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxMTI1NQ==", "bodyText": "even this can be clubbed with above one as there is only one extra property here.", "url": "https://github.com/apache/phoenix/pull/848#discussion_r464711255", "createdAt": "2020-08-03T23:19:35Z", "author": {"login": "swaroopak"}, "path": "phoenix-tools/src/it/java/org/apache/phoenix/schema/SchemaExtractionToolIT.java", "diffHunk": "@@ -58,156 +130,251 @@ public void testCreateTableStatement_tenant() throws Exception {\n         String viewName = generateUniqueName();\n         String schemaName = generateUniqueName();\n         String tenantId = \"abc\";\n-        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n         String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n-        String properties = \"TTL=2592000,IMMUTABLE_ROWS=true,DISABLE_WAL=true\";\n-        SchemaExtractionTool set;\n+        String createTableStmt = \"CREATE TABLE \"+pTableFullName + \"(k BIGINT NOT NULL PRIMARY KEY, \"\n+                + \"v1 VARCHAR, v2 VARCHAR)\";\n         String viewFullName = SchemaUtil.getQualifiedTableName(schemaName, viewName);\n-        String createView = \"CREATE VIEW \"+viewFullName + \"(id1 BIGINT, id2 BIGINT NOT NULL, \"\n+        String createViewStmt = \"CREATE VIEW \"+viewFullName + \"(id1 BIGINT, id2 BIGINT NOT NULL, \"\n                 + \"id3 VARCHAR NOT NULL CONSTRAINT PKVIEW PRIMARY KEY (id2, id3 DESC)) \"\n                 + \"AS SELECT * FROM \"+pTableFullName;\n \n-        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n-\n-            conn.createStatement().execute(\"CREATE TABLE \"+pTableFullName + \"(k BIGINT NOT NULL PRIMARY KEY, \"\n-                    + \"v1 VARCHAR, v2 VARCHAR)\"\n-                    + properties);\n-            set = new SchemaExtractionTool();\n-            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n-            conn.commit();\n-        }\n-        try (Connection conn = getTenantConnection(getUrl(), tenantId)) {\n-            conn.createStatement().execute(createView);\n-            conn.commit();\n-        }\n-        String [] args = {\"-tb\", viewName, \"-s\", schemaName, \"-t\", tenantId};\n-        set.run(args);\n-        Assert.assertEquals(createView.toUpperCase(), set.getOutput().toUpperCase());\n+        List<String> queries1 = new ArrayList<String>(){};\n+        queries1.add(createTableStmt);\n+        runSchemaExtractionTool(schemaName, tableName, null, queries1);\n+        List<String> queries2 = new ArrayList<String>();\n+        queries2.add(createViewStmt);\n+        String result2 = runSchemaExtractionTool(schemaName, viewName, tenantId, queries2);\n+        Assert.assertEquals(createViewStmt.toUpperCase(), result2.toUpperCase());\n     }\n \n-    private Connection getTenantConnection(String url, String tenantId) throws SQLException {\n-        Properties props = new Properties();\n-        props.setProperty(PhoenixRuntime.TENANT_ID_ATTRIB, tenantId);\n-        return DriverManager.getConnection(url, props);\n+    @Test\n+    public void testSaltedTableStatement() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+        String query = \"create table \" + pTableFullName +\n+                \"(a_integer integer not null CONSTRAINT pk PRIMARY KEY (a_integer)) SALT_BUCKETS=16\";\n+        List<String> queries = new ArrayList<String>(){};\n+        queries.add(query);\n+        String result = runSchemaExtractionTool(schemaName, tableName, null, queries);\n+        Assert.assertTrue(getProperties(result).contains(\"SALT_BUCKETS=16\"));\n     }\n \n     @Test\n-    public void testCreateIndexStatement() throws Exception {\n+    public void testCreateTableWithPKConstraint() throws Exception {\n         String tableName = generateUniqueName();\n         String schemaName = generateUniqueName();\n-        String indexName = generateUniqueName();\n-        String indexName1 = generateUniqueName();\n-        String indexName2 = generateUniqueName();\n-        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n-        String properties = \"TTL=2592000,IMMUTABLE_ROWS=true,DISABLE_WAL=true\";\n-\n-        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n-\n-            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n-            conn.createStatement().execute(\"CREATE TABLE \"+pTableFullName + \"(k VARCHAR NOT NULL PRIMARY KEY, v1 VARCHAR, v2 VARCHAR)\"\n-                    + properties);\n-\n-            String createIndexStatement = \"CREATE INDEX \"+indexName + \" ON \"+pTableFullName+\"(v1 DESC) INCLUDE (v2)\";\n-\n-            String createIndexStatement1 = \"CREATE INDEX \"+indexName1 + \" ON \"+pTableFullName+\"(v2 DESC) INCLUDE (v1)\";\n-\n-            String createIndexStatement2 = \"CREATE INDEX \"+indexName2 + \" ON \"+pTableFullName+\"(k)\";\n-\n-            conn.createStatement().execute(createIndexStatement);\n-            conn.createStatement().execute(createIndexStatement1);\n-            conn.createStatement().execute(createIndexStatement2);\n-            conn.commit();\n-            SchemaExtractionTool set = new SchemaExtractionTool();\n-            set.setConf(conn.unwrap(PhoenixConnection.class).getQueryServices().getConfiguration());\n-\n-            String [] args = {\"-tb\", indexName, \"-s\", schemaName};\n-            set.run(args);\n-            Assert.assertEquals(createIndexStatement.toUpperCase(), set.getOutput().toUpperCase());\n-\n-            String [] args1 = {\"-tb\", indexName1, \"-s\", schemaName};\n-            set.run(args1);\n-            Assert.assertEquals(createIndexStatement1.toUpperCase(), set.getOutput().toUpperCase());\n-\n-            String [] args2 = {\"-tb\", indexName2, \"-s\", schemaName};\n-            set.run(args2);\n-            Assert.assertEquals(createIndexStatement2.toUpperCase(), set.getOutput().toUpperCase());\n-        }\n+        String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+        String query = \"create table \" + pTableFullName +\n+                \"(a_char CHAR(15) NOT NULL, \" +\n+                \"b_char CHAR(15) NOT NULL, \" +\n+                \"c_bigint BIGINT NOT NULL CONSTRAINT PK PRIMARY KEY (a_char, b_char, c_bigint)) IMMUTABLE_ROWS=TRUE\";\n+        List<String> queries = new ArrayList<String>(){};\n+        queries.add(query);\n+        String result = runSchemaExtractionTool(schemaName, tableName, null, queries);\n+        Assert.assertEquals(query.toUpperCase(), result.toUpperCase());\n     }\n \n     @Test\n-    public void testCreateViewStatement() throws Exception {\n+    public void testCreateTableWithArrayColumn() throws Exception {\n         String tableName = generateUniqueName();\n         String schemaName = generateUniqueName();\n-        String viewName = generateUniqueName();\n-        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n-        String properties = \"TTL=2592000,IMMUTABLE_ROWS=true,DISABLE_WAL=true\";\n+        String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+        String query = \"create table \" + pTableFullName +\n+                \"(a_char CHAR(15) NOT NULL, \" +\n+                \"b_char CHAR(10) NOT NULL, \" +\n+                \"c_var_array VARCHAR ARRAY, \" +\n+                \"d_char_array CHAR(15) ARRAY[3] CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                \"TTL=2592000, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, REPLICATION_SCOPE=1\";\n+        List<String> queries = new ArrayList<String>(){};\n+        queries.add(query);\n+        String result = runSchemaExtractionTool(schemaName, tableName, null, queries);\n+        Assert.assertEquals(query.toUpperCase(), result.toUpperCase());\n+    }\n \n-        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+    @Test\n+    public void testCreateTableWithNonDefaultColumnFamily() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+        String query = \"create table \" + pTableFullName +\n+                \"(a_char CHAR(15) NOT NULL, \" +\n+                \"b_char CHAR(10) NOT NULL, \" +\n+                \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" +\n+                \"TTL=1209600, IMMUTABLE_ROWS=true, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, SALT_BUCKETS=16, MULTI_TENANT=true\";\n+        List<String> queries = new ArrayList<String>(){};\n+        queries.add(query);\n+        String result = runSchemaExtractionTool(schemaName, tableName, null, queries);\n+        Assert.assertEquals(query.toUpperCase(), result.toUpperCase());\n+    }\n \n-            String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n-            conn.createStatement().execute(\"CREATE TABLE \"+pTableFullName + \"(k BIGINT NOT NULL PRIMARY KEY, \"\n-                    + \"v1 VARCHAR, v2 VARCHAR)\"\n-                    + properties);\n-            String viewFullName = SchemaUtil.getQualifiedTableName(schemaName, viewName);\n-            String viewFullName1 = SchemaUtil.getQualifiedTableName(schemaName, viewName+\"1\");\n+    @Test\n+    public void testCreateTableWithUniversalCFProperties() throws Exception {\n+        String tableName = generateUniqueName();\n+        String schemaName = generateUniqueName();\n+        String properties = \"KEEP_DELETED_CELLS=TRUE, TTL=1209600, IMMUTABLE_STORAGE_SCHEME=ONE_CELL_PER_COLUMN, REPLICATION_SCOPE=1\";\n+        String pTableFullName = SchemaUtil.getQualifiedTableName(schemaName, tableName);\n+        String query = \"create table \" + pTableFullName +\n+                \"(a_char CHAR(15) NOT NULL, \" +\n+                \"b_char CHAR(10) NOT NULL, \" +\n+                \"\\\"av\\\".\\\"_\\\" CHAR(1), \" +\n+                \"\\\"bv\\\".\\\"_\\\" CHAR(1), \" +\n+                \"\\\"cv\\\".\\\"_\\\" CHAR(1), \" +\n+                \"\\\"dv\\\".\\\"_\\\" CHAR(1) CONSTRAINT PK PRIMARY KEY (a_char, b_char)) \" + properties;\n+        List<String> queries = new ArrayList<String>(){};\n+        queries.add(query);\n+        String result = runSchemaExtractionTool(schemaName, tableName, null, queries);\n+        Assert.assertEquals(query.toUpperCase(), result.toUpperCase());\n+    }\n \n+    @Test\n+    public void testCreateTableWithDefaultCFProperties() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf621e75a9d5c2f68e9497574b1fc70fc67ec1b"}, "originalPosition": 301}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9456d69ef937cbeaffba8746219d086c74fc81ab", "author": {"user": {"login": "Qinrui98", "name": "Qinrui Li"}}, "url": "https://github.com/apache/phoenix/commit/9456d69ef937cbeaffba8746219d086c74fc81ab", "committedDate": "2020-08-04T00:00:05Z", "message": "merge tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTIxNTM5", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-461121539", "createdAt": "2020-08-04T19:45:56Z", "commit": {"oid": "9456d69ef937cbeaffba8746219d086c74fc81ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxOTMyMTUw", "url": "https://github.com/apache/phoenix/pull/848#pullrequestreview-461932150", "createdAt": "2020-08-05T18:47:37Z", "commit": {"oid": "9456d69ef937cbeaffba8746219d086c74fc81ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1891, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}