{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NDMwNDE1", "number": 935, "title": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog", "bodyText": "", "createdAt": "2020-10-22T16:55:14Z", "url": "https://github.com/apache/phoenix/pull/935", "merged": true, "mergeCommit": {"oid": "55c41f7bb34d363a30d3704644aacd2580c0a926"}, "closed": true, "closedAt": "2020-11-20T01:41:54Z", "author": {"login": "gjacoby126"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWeCZEAFqTUxNzI1NDAwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeMMrGAFqTUzNDk4Njc4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MjU0MDAz", "url": "https://github.com/apache/phoenix/pull/935#pullrequestreview-517254003", "createdAt": "2020-10-26T23:46:44Z", "commit": {"oid": "51cbc3ed03f0ac8baf82772839752517defb54b4"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzo0Njo0NVrOHombpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMDo0MzoxN1rOHonYzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzNDc1Ng==", "bodyText": "nit: Don't need commit() since they are DDL statements.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r512334756", "createdAt": "2020-10-26T23:46:45Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/ViewIT.java", "diffHunk": "@@ -387,6 +388,31 @@ public void testViewUsesTableLocalIndex() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testCreateViewTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        final String schemaName = \"S_\" + generateUniqueName();\n+        final String tableName = \"T_\" + generateUniqueName();\n+        final String viewName = \"V_\" + generateUniqueName();\n+        final String dataTableFullName = SchemaUtil.getTableName(schemaName, tableName);\n+        final String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+        String tableDDL =\n+            \"CREATE TABLE \" + dataTableFullName + \" (\\n\" + \"ID1 VARCHAR(15) NOT NULL,\\n\"\n+                + \"ID2 VARCHAR(15) NOT NULL,\\n\" + \"CREATED_DATE DATE,\\n\"\n+                + \"CREATION_TIME BIGINT,\\n\" + \"LAST_USED DATE,\\n\"\n+                + \"CONSTRAINT PK PRIMARY KEY (ID1, ID2)) \";\n+        String viewDDL = \"CREATE VIEW \" + viewFullName  + \" AS SELECT * \" +\n+            \"FROM \" + dataTableFullName;\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(viewDDL);\n+            conn.commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51cbc3ed03f0ac8baf82772839752517defb54b4"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzNTQ3NA==", "bodyText": "Once we converge on the expected behavior for column inheritance from a parent to its child views, we should add some tests for those scenarios too.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r512335474", "createdAt": "2020-10-26T23:49:23Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1217,50 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51cbc3ed03f0ac8baf82772839752517defb54b4"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzNTYwMQ==", "bodyText": "Can we add a test which confirms that ALTER SET  doesn't modify the timestamp?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r512335601", "createdAt": "2020-10-26T23:49:53Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableIT.java", "diffHunk": "@@ -1326,7 +1327,40 @@ public void testAddingColumnsToTablesAndViews() throws Exception {\n             assertSequenceNumber(schemaName, viewName, PTable.INITIAL_SEQ_NUM + 1);\n         }\n     }\n-\t\n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String tableDDL = \"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" ENTITY_ID integer NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (ENTITY_ID, COL1, COL2)\"\n+            + \" ) \" + generateDDLOptions(\"\");\n+\n+        String columnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51cbc3ed03f0ac8baf82772839752517defb54b4"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzNTkzNQ==", "bodyText": "Do we need some tests to confirm tenant-view behavior? And then subsequently make this helper method work for resolving those?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r512335935", "createdAt": "2020-10-26T23:50:54Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/CreateTableIT.java", "diffHunk": "@@ -910,6 +911,48 @@ public void testTableDescriptorPriority() throws SQLException, IOException {\n         }\n     }\n \n+    @Test\n+    public void testCreateTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        final String schemaName = generateUniqueName();\n+        final String tableName = generateUniqueName();\n+        final String dataTableFullName = SchemaUtil.getTableName(schemaName, tableName);\n+        String ddl =\n+            \"CREATE TABLE \" + dataTableFullName + \" (\\n\" + \"ID1 VARCHAR(15) NOT NULL,\\n\"\n+                + \"ID2 VARCHAR(15) NOT NULL,\\n\" + \"CREATED_DATE DATE,\\n\"\n+                + \"CREATION_TIME BIGINT,\\n\" + \"LAST_USED DATE,\\n\"\n+                + \"CONSTRAINT PK PRIMARY KEY (ID1, ID2)) \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(ddl);\n+            verifyLastDDLTimestamp(schemaName, tableName, dataTableFullName, startTS, conn);\n+        }\n+    }\n+\n+    public static long verifyLastDDLTimestamp(String schemaName, String tableName,\n+                                              String dataTableFullName, long startTS, Connection conn) throws SQLException {\n+        long endTS = EnvironmentEdgeManager.currentTimeMillis();\n+        //First try the JDBC metadata API\n+        PhoenixDatabaseMetaData metadata = (PhoenixDatabaseMetaData) conn.getMetaData();\n+        ResultSet rs = metadata.getTables(\"\", schemaName, tableName, null);\n+        assertTrue(\"No metadata returned\", rs.next());\n+        Long ddlTimestamp = rs.getLong(PhoenixDatabaseMetaData.LAST_DDL_TIMESTAMP);\n+        assertNotNull(\"JDBC DDL timestamp is null!\", ddlTimestamp);\n+        assertTrue(\"JDBC DDL Timestamp not in the right range!\",\n+            ddlTimestamp >= startTS && ddlTimestamp <= endTS);\n+        //Now try the PTable API\n+        PTable table = PhoenixRuntime.getTableNoCache(conn, dataTableFullName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51cbc3ed03f0ac8baf82772839752517defb54b4"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzODM1Mg==", "bodyText": "Can we add a simple unit test for this inside MetaDataUtilTest?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r512338352", "createdAt": "2020-10-26T23:59:12Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/util/MetaDataUtil.java", "diffHunk": "@@ -107,6 +107,18 @@\n             HColumnDescriptor.KEEP_DELETED_CELLS,\n             HColumnDescriptor.REPLICATION_SCOPE);\n \n+    public static Mutation getLastDDLTimestampUpdate(byte[] tableHeaderRowKey,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51cbc3ed03f0ac8baf82772839752517defb54b4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzODU4MQ==", "bodyText": "This will get triggered even for ALTER TABLE/VIEW SET <property>. I thought we didn't want to update the ddl timestamp in those cases.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r512338581", "createdAt": "2020-10-26T23:59:52Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/AddColumnMutator.java", "diffHunk": "@@ -399,6 +399,10 @@ public MetaDataMutationResult validateAndAddMetadata(PTable table, byte[][] rowK\n                                 rowKeyMetaData[TABLE_NAME_INDEX])));\n             }\n         }\n+        //We're changing the application-facing schema by adding a column, so update the DDL\n+        // timestamp\n+        additionalTableMetadataMutations.add(MetaDataUtil.getLastDDLTimestampUpdate(tableHeaderRowKey,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51cbc3ed03f0ac8baf82772839752517defb54b4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0Nzg2Ng==", "bodyText": "This seems risky since we are relying on the fact that the PTable returned from the server has all the necessary attributes set as the PTable we create on the client-side. There are some that we set explicitly inside MetaDataClient which depend on the parent so I'm not sure we still have those set as expected.\nInstead, to be safe we can maybe getDDLTimestamp() from this returned PTable and set that in the builder. Better yet, we could just send the DDL timestamp in the server response rather than the entire PTable. We could then use the setter for this attribute when creating the PTable from its builder.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r512347866", "createdAt": "2020-10-27T00:33:17Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/schema/MetaDataClient.java", "diffHunk": "@@ -3048,7 +3048,13 @@ public boolean isViewReferenced() {\n              * the counter as NULL_COUNTER for extra safety.\n              */\n             EncodedCQCounter cqCounterToBe = tableType == PTableType.VIEW ? NULL_COUNTER : cqCounter;\n-            PTable table = new PTableImpl.Builder()\n+            PTable table;\n+            //better to use the table sent back from the server so we get an accurate DDL\n+            // timestamp, which is server-generated.\n+            if (result.getTable() != null ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51cbc3ed03f0ac8baf82772839752517defb54b4"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0ODU0Ng==", "bodyText": "It might be better to just send the DDL timestamp from the server instead of the entire PTable. This is because on the client, we set certain properties which may be derived from the parent, etc. so we probably can't blindly cache the PTable that is returned from the server anyhow.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r512348546", "createdAt": "2020-10-27T00:36:01Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/MetaDataEndpointImpl.java", "diffHunk": "@@ -2100,6 +2115,13 @@ public void createTable(RpcController controller, CreateTableRequest request,\n                     builder.setViewIndexIdType(PLong.INSTANCE.getSqlType());\n                 }\n                 builder.setMutationTime(currentTimeStamp);\n+                //send the newly built table back because we generated the DDL timestamp server\n+                // side and the client doesn't have it.\n+                PTable newTable = buildTable(tableKey, cacheKey, region,\n+                    clientTimeStamp, clientVersion);\n+                if (newTable != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51cbc3ed03f0ac8baf82772839752517defb54b4"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM1MDE3Mw==", "bodyText": "Similar kind of concern here?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r512350173", "createdAt": "2020-10-27T00:42:16Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/schema/MetaDataClient.java", "diffHunk": "@@ -4416,10 +4423,15 @@ else if (columnToDrop.isViewReferenced()) {\n                     // client-side cache as it would be too painful. Just let it pull it over from\n                     // the server when needed.\n                     if (tableColumnsToDrop.size() > 0) {\n-                        if (removedIndexTableOrColumn)\n+                        if (removedIndexTableOrColumn) {\n                             connection.removeTable(tenantId, tableName, table.getParentName() == null ? null : table.getParentName().getString(), table.getTimeStamp());\n-                        else\n-                            connection.removeColumn(tenantId, SchemaUtil.getTableName(schemaName, tableName) , tableColumnsToDrop, result.getMutationTime(), seqNum, TransactionUtil.getResolvedTime(connection, result));\n+                        }\n+                        else {\n+                            //replace the cache of this table with the updated one we got back\n+                            // from the server\n+                            connection.addTable(result.getTable(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51cbc3ed03f0ac8baf82772839752517defb54b4"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM1MDQxNA==", "bodyText": "What is this change for?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r512350414", "createdAt": "2020-10-27T00:43:17Z", "author": {"login": "ChinmaySKulkarni"}, "path": "pom.xml", "diffHunk": "@@ -318,7 +318,7 @@\n             <execution>\n               <id>ParallelStatsDisabledTest</id>\n               <configuration>\n-                <reuseForks>true</reuseForks>\n+                <reuseForks>false</reuseForks>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51cbc3ed03f0ac8baf82772839752517defb54b4"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ceec53c1bbc5b86b77a1b885fb3b46fc284dbcc", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/7ceec53c1bbc5b86b77a1b885fb3b46fc284dbcc", "committedDate": "2020-10-30T19:50:05Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}, "afterCommit": {"oid": "5252eda018d17a0ae0e1e95d61de1745db954283", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/5252eda018d17a0ae0e1e95d61de1745db954283", "committedDate": "2020-11-05T17:55:39Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzE3MTE5", "url": "https://github.com/apache/phoenix/pull/935#pullrequestreview-526717119", "createdAt": "2020-11-09T22:48:02Z", "commit": {"oid": "5252eda018d17a0ae0e1e95d61de1745db954283"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjo0ODowMlrOHwErQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzozNDo1MFrOHwFzxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MDMwNQ==", "bodyText": "In splittable-SYSTEM.CATALOG world, we avoid making synchronous changes to child views when the parent changes, so if a column is added to the parent, we wouldn't add that to each child view's metadata. Instead on resolving the view, we'd combine the parent columns and inherit them that way. This was done for scalability in case child views span many SYSCAT regions. I'm wondering if we can use similar inheritance logic for lastDDLTs of child views.\nThis becomes more complicated for diverged views. In that case, any columns added to a parent view/physical table are inherited by its child views only if they haven't diverged. In those cases, the LastDDLTs for diverged views ideally shouldn't even be modified if a column is added to its parent.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r520170305", "createdAt": "2020-11-09T22:48:02Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/AddColumnMutator.java", "diffHunk": "@@ -399,6 +401,19 @@ public MetaDataMutationResult validateAndAddMetadata(PTable table, byte[][] rowK\n                                 rowKeyMetaData[TABLE_NAME_INDEX])));\n             }\n         }\n+        if (isAddingColumns) {\n+            //We're changing the application-facing schema by adding a column, so update the DDL\n+            // timestamp\n+            long serverTimestamp = EnvironmentEdgeManager.currentTimeMillis();\n+            additionalTableMetadataMutations.add(MetaDataUtil.getLastDDLTimestampUpdate(tableHeaderRowKey,\n+                clientTimeStamp, serverTimestamp));\n+            for (PTable viewTable : childViews) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5252eda018d17a0ae0e1e95d61de1745db954283"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MTE5NQ==", "bodyText": "Another complication is, pre-4.15 clients do not have this logic to just store view-specific columns. They don't have EXCLUDED_COLUMN linking rows either. The parent column combining logic in those cases is different too.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r520171195", "createdAt": "2020-11-09T22:49:45Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/AddColumnMutator.java", "diffHunk": "@@ -399,6 +401,19 @@ public MetaDataMutationResult validateAndAddMetadata(PTable table, byte[][] rowK\n                                 rowKeyMetaData[TABLE_NAME_INDEX])));\n             }\n         }\n+        if (isAddingColumns) {\n+            //We're changing the application-facing schema by adding a column, so update the DDL\n+            // timestamp\n+            long serverTimestamp = EnvironmentEdgeManager.currentTimeMillis();\n+            additionalTableMetadataMutations.add(MetaDataUtil.getLastDDLTimestampUpdate(tableHeaderRowKey,\n+                clientTimeStamp, serverTimestamp));\n+            for (PTable viewTable : childViews) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MDMwNQ=="}, "originalCommit": {"oid": "5252eda018d17a0ae0e1e95d61de1745db954283"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MTI3OA==", "bodyText": "Same concerns here with parent column inheritance and diverged views, etc.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r520171278", "createdAt": "2020-11-09T22:49:55Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/DropColumnMutator.java", "diffHunk": "@@ -268,7 +272,20 @@ public MetaDataMutationResult validateAndAddMetadata(PTable table,\n             }\n \n         }\n-        tableMetaData.addAll(additionalTableMetaData);\n+        if (isDroppingColumns) {\n+            //We're changing the application-facing schema by dropping a column, so update the DDL\n+            // timestamp to current _server_ timestamp\n+            long serverTimestamp = EnvironmentEdgeManager.currentTimeMillis();\n+            additionalTableMetaData.add(MetaDataUtil.getLastDDLTimestampUpdate(tableHeaderRowKey,\n+                clientTimeStamp, serverTimestamp));\n+            for (PTable viewTable : childViews) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5252eda018d17a0ae0e1e95d61de1745db954283"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzM2Nw==", "bodyText": "Why are we changing this?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r520173367", "createdAt": "2020-11-09T22:54:33Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/MetaDataProtocol.java", "diffHunk": "@@ -94,7 +94,7 @@\n     public static final long MIN_SYSTEM_TABLE_TIMESTAMP_4_13_0 = MIN_SYSTEM_TABLE_TIMESTAMP_4_11_0;\n     public static final long MIN_SYSTEM_TABLE_TIMESTAMP_4_14_0 = MIN_TABLE_TIMESTAMP + 28;\n     public static final long MIN_SYSTEM_TABLE_TIMESTAMP_4_15_0 = MIN_TABLE_TIMESTAMP + 29;\n-    public static final long MIN_SYSTEM_TABLE_TIMESTAMP_4_16_0 = MIN_TABLE_TIMESTAMP + 31;\n+    public static final long MIN_SYSTEM_TABLE_TIMESTAMP_4_16_0 = MIN_TABLE_TIMESTAMP + 33;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5252eda018d17a0ae0e1e95d61de1745db954283"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3NzU1OA==", "bodyText": "I'm a little unclear on these changes. Shouldn't all these 4.16-specific columns be added at the 4.16 ts rather than 4.16 ts - something?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r520177558", "createdAt": "2020-11-09T23:04:44Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -3707,15 +3709,20 @@ protected PhoenixConnection upgradeSystemCatalogIfRequired(PhoenixConnection met\n             metaConnection = addColumnsIfNotExists(\n                 metaConnection,\n                 PhoenixDatabaseMetaData.SYSTEM_CATALOG,\n-                MIN_SYSTEM_TABLE_TIMESTAMP_4_16_0 - 1,\n+                MIN_SYSTEM_TABLE_TIMESTAMP_4_16_0 - 2,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5252eda018d17a0ae0e1e95d61de1745db954283"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3OTU0Ng==", "bodyText": "nit: Instead of using u and v, use PTableType.. API", "url": "https://github.com/apache/phoenix/pull/935#discussion_r520179546", "createdAt": "2020-11-09T23:09:57Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/util/UpgradeUtil.java", "diffHunk": "@@ -2586,4 +2588,18 @@ public static boolean isNoUpgradeSet(Properties props) {\n     public static void doNotUpgradeOnFirstConnection(Properties props) {\n         props.setProperty(DO_NOT_UPGRADE, String.valueOf(true));\n     }\n+\n+    //When upgrading to Phoenix 4.16, make each existing table's DDL timestamp equal to its last\n+    // updated row timestamp.\n+    public static void bootstrapLastDDLTimestamp(PhoenixConnection metaConnection) throws SQLException  {\n+        String pkCols = TENANT_ID + \", \" + TABLE_SCHEM +\n+            \", \" + TABLE_NAME + \", \" + COLUMN_NAME + \", \" + COLUMN_FAMILY;\n+        String upsertSql =\n+            \"UPSERT INTO \" + SYSTEM_CATALOG_NAME + \" (\" + pkCols + \", \" +\n+        LAST_DDL_TIMESTAMP + \")\" + \" \" +\n+            \"SELECT \" + pkCols + \", PHOENIX_ROW_TIMESTAMP() FROM \" + SYSTEM_CATALOG_NAME + \" \" +\n+                \"WHERE \" + TABLE_TYPE + \" \" + \" in \" + \"('u','v')\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5252eda018d17a0ae0e1e95d61de1745db954283"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3OTg5OQ==", "bodyText": "Can we add a log before and after this UPSERT SELECT to help track the upgrade progress?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r520179899", "createdAt": "2020-11-09T23:10:51Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/util/UpgradeUtil.java", "diffHunk": "@@ -2586,4 +2588,18 @@ public static boolean isNoUpgradeSet(Properties props) {\n     public static void doNotUpgradeOnFirstConnection(Properties props) {\n         props.setProperty(DO_NOT_UPGRADE, String.valueOf(true));\n     }\n+\n+    //When upgrading to Phoenix 4.16, make each existing table's DDL timestamp equal to its last\n+    // updated row timestamp.\n+    public static void bootstrapLastDDLTimestamp(PhoenixConnection metaConnection) throws SQLException  {\n+        String pkCols = TENANT_ID + \", \" + TABLE_SCHEM +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5252eda018d17a0ae0e1e95d61de1745db954283"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4ODEyNw==", "bodyText": "Do we want to restrict this to just tables and views i.e. 'u' and 'v' table_types? The upgrade code only adds a ts for existing tables and views, but not indexes and SYSTEM tables, but here we do it for all types. There will be inconsistency in that case between an index created before the 4.16 metadata upgrade (no ts) vs an index created after the 4.16 metadata upgrade (has ts), not to mention fresh clusters will have a ts for all entities.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r520188127", "createdAt": "2020-11-09T23:32:47Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/MetaDataEndpointImpl.java", "diffHunk": "@@ -2037,7 +2049,10 @@ public void createTable(RpcController controller, CreateTableRequest request,\n                     // view's property in case they are different from the parent\n                     ViewUtil.addTagsToPutsForViewAlteredProperties(tableMetadata, parentTable);\n                 }\n-\n+                //set the last DDL timestamp to the current server time since we're creating the\n+                // table\n+                tableMetadata.add(MetaDataUtil.getLastDDLTimestampUpdate(tableKey,\n+                    clientTimeStamp, EnvironmentEdgeManager.currentTimeMillis()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5252eda018d17a0ae0e1e95d61de1745db954283"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4ODg2OA==", "bodyText": "Also, can we add a comment about why we don't do this for system tables and indexes? Might be better to invert the condition and say WHERE TABLE_TYPE NOT IN ('s', i')", "url": "https://github.com/apache/phoenix/pull/935#discussion_r520188868", "createdAt": "2020-11-09T23:34:50Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/util/UpgradeUtil.java", "diffHunk": "@@ -2586,4 +2588,18 @@ public static boolean isNoUpgradeSet(Properties props) {\n     public static void doNotUpgradeOnFirstConnection(Properties props) {\n         props.setProperty(DO_NOT_UPGRADE, String.valueOf(true));\n     }\n+\n+    //When upgrading to Phoenix 4.16, make each existing table's DDL timestamp equal to its last\n+    // updated row timestamp.\n+    public static void bootstrapLastDDLTimestamp(PhoenixConnection metaConnection) throws SQLException  {\n+        String pkCols = TENANT_ID + \", \" + TABLE_SCHEM +\n+            \", \" + TABLE_NAME + \", \" + COLUMN_NAME + \", \" + COLUMN_FAMILY;\n+        String upsertSql =\n+            \"UPSERT INTO \" + SYSTEM_CATALOG_NAME + \" (\" + pkCols + \", \" +\n+        LAST_DDL_TIMESTAMP + \")\" + \" \" +\n+            \"SELECT \" + pkCols + \", PHOENIX_ROW_TIMESTAMP() FROM \" + SYSTEM_CATALOG_NAME + \" \" +\n+                \"WHERE \" + TABLE_TYPE + \" \" + \" in \" + \"('u','v')\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3OTU0Ng=="}, "originalCommit": {"oid": "5252eda018d17a0ae0e1e95d61de1745db954283"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTY4MzM0", "url": "https://github.com/apache/phoenix/pull/935#pullrequestreview-529568334", "createdAt": "2020-11-12T22:56:18Z", "commit": {"oid": "d7e52a93c8d8b5becdf3dd2d8e1ec8fe18074459"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjo1NjoxOFrOHySEig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMzo0Mzo0NFrOHyTcYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NjkyMg==", "bodyText": "Do we need to add childViews to validateAndAddMetadata method ? Maybe I am reading it wrong but I don't see childViews getting used either in AddColumnMutator#validateAndAddMetadata or DropColumnMutator#validateAndAddMetadata.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r522486922", "createdAt": "2020-11-12T22:56:18Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/AddColumnMutator.java", "diffHunk": "@@ -293,7 +293,9 @@ public MetaDataMutationResult validateAndAddMetadata(PTable table, byte[][] rowK\n                                                          List<ImmutableBytesPtr> invalidateList,\n                                                          List<Region.RowLock> locks,\n                                                          long clientTimeStamp,\n-                                                         long clientVersion) {\n+                                                         long clientVersion,\n+                                                         boolean isAddingColumns,\n+                                                         List<PTable> childViews) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7e52a93c8d8b5becdf3dd2d8e1ec8fe18074459"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4OTk2NA==", "bodyText": "tableMetaData.addAll(additionalTableMetaData);\nThe above line won't be executed if isDroppingColumns is false. Earlier it was getting executed even if we are dropping columns.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r522489964", "createdAt": "2020-11-12T23:01:32Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/DropColumnMutator.java", "diffHunk": "@@ -268,7 +272,19 @@ public MetaDataMutationResult validateAndAddMetadata(PTable table,\n             }\n \n         }\n-        tableMetaData.addAll(additionalTableMetaData);\n+        if (isDroppingColumns) {\n+            //We're changing the application-facing schema by dropping a column, so update the DDL\n+            // timestamp to current _server_ timestamp\n+            if (MetaDataUtil.isTableQueryable(table.getType())) {\n+                long serverTimestamp = EnvironmentEdgeManager.currentTimeMillis();\n+                additionalTableMetaData.add(MetaDataUtil.getLastDDLTimestampUpdate(tableHeaderRowKey,\n+                    clientTimeStamp, serverTimestamp));\n+            }\n+            //we don't need to update the DDL timestamp for any child views we may have, because\n+            // when we look up a PTable for any of those child views, we'll take the max timestamp\n+            // of the view and all its ancestors\n+            tableMetaData.addAll(additionalTableMetaData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7e52a93c8d8b5becdf3dd2d8e1ec8fe18074459"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ5MDY0MA==", "bodyText": "The changes here looks exactly same as the changes in AddColumnMutator. Can we create a helper method which accepts table and additionalTableMetaData as argument ?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r522490640", "createdAt": "2020-11-12T23:03:10Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/DropColumnMutator.java", "diffHunk": "@@ -268,7 +272,19 @@ public MetaDataMutationResult validateAndAddMetadata(PTable table,\n             }\n \n         }\n-        tableMetaData.addAll(additionalTableMetaData);\n+        if (isDroppingColumns) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7e52a93c8d8b5becdf3dd2d8e1ec8fe18074459"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwNjI1MA==", "bodyText": "Unable to understand the need of this field addingColumns in builder ? If we need this, then why not a corresponding field in DropColumn request.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r522506250", "createdAt": "2020-11-12T23:36:28Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -2285,6 +2286,7 @@ public MetaDataResponse call(MetaDataService instance) throws IOException {\n                     builder.setClientVersion(VersionUtil.encodeVersion(PHOENIX_MAJOR_VERSION, PHOENIX_MINOR_VERSION, PHOENIX_PATCH_NUMBER));\n                     if (parentTable!=null)\n                         builder.setParentTable(PTableImpl.toProto(parentTable));\n+                    builder.setAddingColumns(addingColumns);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7e52a93c8d8b5becdf3dd2d8e1ec8fe18074459"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwODE2NQ==", "bodyText": "Here we are adding just 1 filed to builder method. Can we please undo the formatting changes which is making the diff look more than actual changes.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r522508165", "createdAt": "2020-11-12T23:42:01Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/schema/MetaDataClient.java", "diffHunk": "@@ -3063,60 +3063,62 @@ public boolean isViewReferenced() {\n              */\n             EncodedCQCounter cqCounterToBe = tableType == PTableType.VIEW ? NULL_COUNTER : cqCounter;\n             PTable table = new PTableImpl.Builder()\n-                    .setType(tableType)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7e52a93c8d8b5becdf3dd2d8e1ec8fe18074459"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwOTQwOQ==", "bodyText": "I am not that much aware of the change here but isn't system table directly queryable ?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r522509409", "createdAt": "2020-11-12T23:43:44Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/util/MetaDataUtil.java", "diffHunk": "@@ -107,6 +107,29 @@\n             HColumnDescriptor.KEEP_DELETED_CELLS,\n             HColumnDescriptor.REPLICATION_SCOPE);\n \n+    public static Put getLastDDLTimestampUpdate(byte[] tableHeaderRowKey,\n+                                                     long clientTimestamp,\n+                                                     long lastDDLTimestamp) {\n+        //use client timestamp as the timestamp of the Cell, to match the other Cells that might\n+        // be created by this DDL. But the actual value will be a _server_ timestamp\n+        Put p = new Put(tableHeaderRowKey, clientTimestamp);\n+        byte[] lastDDLTimestampBytes = PLong.INSTANCE.toBytes(lastDDLTimestamp);\n+        p.addColumn(PhoenixDatabaseMetaData.TABLE_FAMILY_BYTES,\n+            PhoenixDatabaseMetaData.LAST_DDL_TIMESTAMP_BYTES, lastDDLTimestampBytes);\n+        return p;\n+    }\n+\n+    /**\n+     * Checks if a table is meant to be queried directly (and hence is relevant to external\n+     * systems tracking Phoenix schema)\n+     * @param tableType\n+     * @return True if a table or view, false otherwise (such as for an index, system table, or\n+     * subquery)\n+     */\n+    public static boolean isTableQueryable(PTableType tableType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7e52a93c8d8b5becdf3dd2d8e1ec8fe18074459"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMTc0MDQz", "url": "https://github.com/apache/phoenix/pull/935#pullrequestreview-530174043", "createdAt": "2020-11-13T15:47:25Z", "commit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNTo0NzoyNVrOHyzkXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjo1MzoyMVrOHy2HtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAzNTc0Mw==", "bodyText": "is this comment carried forward from previous test and no longer relevant here ?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523035743", "createdAt": "2020-11-13T15:47:25Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableIT.java", "diffHunk": "@@ -1326,7 +1328,69 @@ public void testAddingColumnsToTablesAndViews() throws Exception {\n             assertSequenceNumber(schemaName, viewName, PTable.INITIAL_SEQ_NUM + 1);\n         }\n     }\n-\t\n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String tableDDL = \"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" ENTITY_ID integer NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (ENTITY_ID, COL1, COL2)\"\n+            + \" ) \" + generateDDLOptions(\"\");\n+\n+        String columnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testSetPropertyDoesntUpdateDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String tableDDL = \"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" ENTITY_ID integer NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (ENTITY_ID, COL1, COL2)\"\n+            + \" ) \" + generateDDLOptions(\"\");\n+\n+        String setPropertyDDL = \"ALTER TABLE \" + dataTableFullName +\n+            \" SET UPDATE_CACHE_FREQUENCY=300000 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAzNzg2MQ==", "bodyText": "just 1 minor nit. DriverManager has method getConnection without Properties argument. We can use that in all newly added test cases since we don't override any properties here. If it is too much change please feel free to ignore also.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523037861", "createdAt": "2020-11-13T15:50:44Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableIT.java", "diffHunk": "@@ -1326,7 +1328,69 @@ public void testAddingColumnsToTablesAndViews() throws Exception {\n             assertSequenceNumber(schemaName, viewName, PTable.INITIAL_SEQ_NUM + 1);\n         }\n     }\n-\t\n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String tableDDL = \"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" ENTITY_ID integer NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (ENTITY_ID, COL1, COL2)\"\n+            + \" ) \" + generateDDLOptions(\"\");\n+\n+        String columnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA0MjUwOA==", "bodyText": "Acc to comment, shouldn't the argument for startTime be \"viewDDLTimestamp + 1\"  since we are assuming that timestamp should change.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523042508", "createdAt": "2020-11-13T15:57:54Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1218,248 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior\n+        // extends to DDL timestamp\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String divergeDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL2\";\n+        String viewColumnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String viewColumnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        String tableColumnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL4 varchar\" +\n+            \"(50) NULL\";\n+        String tableColumnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL4 \";\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(viewDDL);\n+            long viewDDLTimestamp = getLastDDLTimestamp(conn, viewFullName);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(divergeDDL);\n+            //verify DDL timestamp changed\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA0NDE0MA==", "bodyText": "I understand it is strictly not required but should we sleep for 1 millisecond just to make sure that 1 ms passed between divergeDDL and viewColumnAddDDL execution and the same argument applies for other ddl statements that we execute subsequently in this test.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523044140", "createdAt": "2020-11-13T16:00:25Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1218,248 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior\n+        // extends to DDL timestamp\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String divergeDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL2\";\n+        String viewColumnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String viewColumnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        String tableColumnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL4 varchar\" +\n+            \"(50) NULL\";\n+        String tableColumnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL4 \";\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(viewDDL);\n+            long viewDDLTimestamp = getLastDDLTimestamp(conn, viewFullName);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(divergeDDL);\n+            //verify DDL timestamp changed\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(viewColumnAddDDL);\n+            //verify DDL timestamp changed because we added a column to the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA0NjM5Nw==", "bodyText": "Does it make sense to add a check that after dropping column from view it didn't change the ddlTimestamp of the base table ?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523046397", "createdAt": "2020-11-13T16:04:14Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1218,248 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior\n+        // extends to DDL timestamp\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String divergeDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL2\";\n+        String viewColumnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String viewColumnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        String tableColumnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL4 varchar\" +\n+            \"(50) NULL\";\n+        String tableColumnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL4 \";\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(viewDDL);\n+            long viewDDLTimestamp = getLastDDLTimestamp(conn, viewFullName);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(divergeDDL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA0ODA3MA==", "bodyText": "Any reason why we want this test to run only if multiTenant is true ? I am not that much aware of this testsuite.\nIf we want to ensure isMultiTenant is true then can we change the test name to testLastDDLTimestampWith_Tenant_ChildViews to be more specific.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523048070", "createdAt": "2020-11-13T16:06:51Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1218,248 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior\n+        // extends to DDL timestamp\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String divergeDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL2\";\n+        String viewColumnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String viewColumnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        String tableColumnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL4 varchar\" +\n+            \"(50) NULL\";\n+        String tableColumnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL4 \";\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(viewDDL);\n+            long viewDDLTimestamp = getLastDDLTimestamp(conn, viewFullName);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(divergeDDL);\n+            //verify DDL timestamp changed\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(viewColumnAddDDL);\n+            //verify DDL timestamp changed because we added a column to the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(viewColumnDropDDL);\n+            //verify DDL timestamp changed because we dropped a column from the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(tableColumnAddDDL);\n+            //verify DDL timestamp DID NOT change because we added a column from the base table\n+            assertEquals(viewDDLTimestamp, getLastDDLTimestamp(conn, viewFullName));\n+            conn.createStatement().execute(tableColumnDropDDL);\n+            assertEquals(viewDDLTimestamp, getLastDDLTimestamp(conn, viewFullName));\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampWithChildViews() throws Exception {\n+        Assume.assumeTrue(isMultiTenant);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA0OTkwNw==", "bodyText": "Should we move this helper method to CreateTableIT since we are doing almost same thing in CreateTableIT#verifyLastDDLTimestamp and additional timestamp bounds verification.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523049907", "createdAt": "2020-11-13T16:09:49Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1218,248 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior\n+        // extends to DDL timestamp\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String divergeDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL2\";\n+        String viewColumnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String viewColumnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        String tableColumnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL4 varchar\" +\n+            \"(50) NULL\";\n+        String tableColumnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL4 \";\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(viewDDL);\n+            long viewDDLTimestamp = getLastDDLTimestamp(conn, viewFullName);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(divergeDDL);\n+            //verify DDL timestamp changed\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(viewColumnAddDDL);\n+            //verify DDL timestamp changed because we added a column to the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(viewColumnDropDDL);\n+            //verify DDL timestamp changed because we dropped a column from the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(tableColumnAddDDL);\n+            //verify DDL timestamp DID NOT change because we added a column from the base table\n+            assertEquals(viewDDLTimestamp, getLastDDLTimestamp(conn, viewFullName));\n+            conn.createStatement().execute(tableColumnDropDDL);\n+            assertEquals(viewDDLTimestamp, getLastDDLTimestamp(conn, viewFullName));\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampWithChildViews() throws Exception {\n+        Assume.assumeTrue(isMultiTenant);\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String globalViewName = \"V_\" + generateUniqueName();\n+        String tenantViewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String globalViewFullName = SchemaUtil.getTableName(schemaName, globalViewName);\n+        String tenantViewFullName = SchemaUtil.getTableName(schemaName, tenantViewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        //create a table with a child global view, who then has a child tenant view\n+        String globalViewDDL =\n+            \"CREATE VIEW \" + globalViewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String tenantViewDDL =\n+            \"CREATE VIEW \" + tenantViewFullName + \" AS SELECT * FROM \" + globalViewFullName;\n+\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        long tableDDLTimestamp, globalViewDDLTimestamp;\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(globalViewDDL);\n+            tableDDLTimestamp = getLastDDLTimestamp(conn, dataTableFullName);\n+            globalViewDDLTimestamp = getLastDDLTimestamp(conn, globalViewFullName);\n+        }\n+        props.setProperty(TENANT_ID_ATTRIB, TENANT1);\n+        try (Connection tenantConn = DriverManager.getConnection(getUrl(), props)) {\n+            tenantConn.createStatement().execute(tenantViewDDL);\n+        }\n+        // First, check that adding a child view didn't change the timestamps\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            long newTableDDLTimestamp = getLastDDLTimestamp(conn, dataTableFullName);\n+            assertEquals(tableDDLTimestamp, newTableDDLTimestamp);\n+\n+            long newGlobalViewDDLTimestamp = getLastDDLTimestamp(conn, globalViewFullName);\n+            assertEquals(globalViewDDLTimestamp, newGlobalViewDDLTimestamp);\n+        }\n+        Thread.sleep(1);\n+        //now add / drop a column from the tenant view and make sure it doesn't change its\n+        // ancestors' timestamps\n+        String tenantViewColumnAddDDL = \"ALTER VIEW \" + tenantViewFullName + \" ADD COL3 varchar\" +\n+            \"(50) \" + \"NULL \";\n+        String tenantViewColumnDropDDL = \"ALTER VIEW \" + tenantViewFullName + \" DROP COLUMN COL3 \";\n+\n+        try (Connection tenantConn = DriverManager.getConnection(getUrl(), props)) {\n+            tenantConn.createStatement().execute(tenantViewColumnAddDDL);\n+            long newTableDDLTimestamp = getLastDDLTimestamp(tenantConn, dataTableFullName);\n+            assertEquals(tableDDLTimestamp, newTableDDLTimestamp);\n+\n+            long afterTenantColumnAddViewDDLTimestamp = getLastDDLTimestamp(tenantConn,\n+                globalViewFullName);\n+            assertEquals(globalViewDDLTimestamp, afterTenantColumnAddViewDDLTimestamp);\n+\n+            tenantConn.createStatement().execute(tenantViewColumnDropDDL);\n+            //update the tenant view timestamp (we'll need it later)\n+            long afterTenantColumnDropTableDDLTimestamp = getLastDDLTimestamp(tenantConn,\n+                dataTableFullName);\n+            assertEquals(tableDDLTimestamp, afterTenantColumnDropTableDDLTimestamp);\n+\n+            long afterTenantColumnDropViewDDLTimestamp = getLastDDLTimestamp(tenantConn,\n+                globalViewFullName);\n+            assertEquals(globalViewDDLTimestamp, afterTenantColumnDropViewDDLTimestamp);\n+        }\n+        Thread.sleep(1);\n+        //now add / drop a column from the base table and make sure it changes the timestamps for\n+        // both the global view (its child) and the tenant view (its grandchild)\n+        String tableColumnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL4 varchar\" +\n+            \"(50) \" + \"NULL \";\n+        String tableColumnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL4 \";\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableColumnAddDDL);\n+            tableDDLTimestamp = getLastDDLTimestamp(conn, dataTableFullName);\n+            try (Connection tenantConn = DriverManager.getConnection(getUrl(), props)) {\n+                long tenantViewDDLTimestamp = getLastDDLTimestamp(tenantConn,\n+                    tenantViewFullName);\n+                assertEquals(tableDDLTimestamp, tenantViewDDLTimestamp);\n+            }\n+            globalViewDDLTimestamp = getLastDDLTimestamp(conn,\n+                globalViewFullName);\n+            assertEquals(tableDDLTimestamp, globalViewDDLTimestamp);\n+\n+            conn.createStatement().execute(tableColumnDropDDL);\n+            tableDDLTimestamp = getLastDDLTimestamp(conn, dataTableFullName);\n+            try (Connection tenantConn = DriverManager.getConnection(getUrl(), props)) {\n+                long tenantViewDDLTimestamp = getLastDDLTimestamp(tenantConn,\n+                    tenantViewFullName);\n+                assertEquals(tableDDLTimestamp, tenantViewDDLTimestamp);\n+            }\n+            globalViewDDLTimestamp = getLastDDLTimestamp(conn,\n+                globalViewFullName);\n+            assertEquals(tableDDLTimestamp, globalViewDDLTimestamp);\n+        }\n+\n+        //now add / drop a column from the global view and make sure it doesn't change its\n+        // parent (the base table) but does change the timestamp for its child (the tenant view)\n+        String globalViewColumnAddDDL = \"ALTER VIEW \" + globalViewFullName + \" ADD COL5 varchar\" +\n+            \"(50) \" + \"NULL \";\n+        String globalViewColumnDropDDL = \"ALTER VIEW \" + globalViewFullName + \" DROP COLUMN COL5 \";\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(globalViewColumnAddDDL);\n+            globalViewDDLTimestamp = getLastDDLTimestamp(conn, globalViewFullName);\n+            long newTableDDLTimestamp = getLastDDLTimestamp(conn,\n+                dataTableFullName);\n+            //table DDL timestamp shouldn't have changed\n+            assertEquals(tableDDLTimestamp, newTableDDLTimestamp);\n+            try (Connection tenantConn = DriverManager.getConnection(getUrl(), props)) {\n+                long tenantViewDDLTimestamp = getLastDDLTimestamp(tenantConn,\n+                    tenantViewFullName);\n+                //but tenant timestamp should have changed\n+                assertEquals(globalViewDDLTimestamp, tenantViewDDLTimestamp);\n+            }\n+\n+            conn.createStatement().execute(globalViewColumnDropDDL);\n+            globalViewDDLTimestamp = getLastDDLTimestamp(conn, globalViewFullName);\n+            newTableDDLTimestamp = getLastDDLTimestamp(conn,\n+                dataTableFullName);\n+            //table DDL timestamp shouldn't have changed\n+            assertEquals(tableDDLTimestamp, newTableDDLTimestamp);\n+            try (Connection tenantConn = DriverManager.getConnection(getUrl(), props)) {\n+                long tenantViewDDLTimestamp = getLastDDLTimestamp(tenantConn,\n+                    tenantViewFullName);\n+                //but tenant timestamp should have changed\n+                assertEquals(globalViewDDLTimestamp, tenantViewDDLTimestamp);\n+            }\n+        }\n+\n+    }\n+\n+    public static long getLastDDLTimestamp(Connection conn, String dataTableFullName) throws SQLException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 256}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1MzEzNw==", "bodyText": "nit: could you please change the comment to be more specific.\n// First, check that adding a child view didn't change the timestamps of base table", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523053137", "createdAt": "2020-11-13T16:14:56Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1218,248 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior\n+        // extends to DDL timestamp\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String divergeDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL2\";\n+        String viewColumnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String viewColumnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        String tableColumnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL4 varchar\" +\n+            \"(50) NULL\";\n+        String tableColumnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL4 \";\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(viewDDL);\n+            long viewDDLTimestamp = getLastDDLTimestamp(conn, viewFullName);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(divergeDDL);\n+            //verify DDL timestamp changed\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(viewColumnAddDDL);\n+            //verify DDL timestamp changed because we added a column to the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(viewColumnDropDDL);\n+            //verify DDL timestamp changed because we dropped a column from the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(tableColumnAddDDL);\n+            //verify DDL timestamp DID NOT change because we added a column from the base table\n+            assertEquals(viewDDLTimestamp, getLastDDLTimestamp(conn, viewFullName));\n+            conn.createStatement().execute(tableColumnDropDDL);\n+            assertEquals(viewDDLTimestamp, getLastDDLTimestamp(conn, viewFullName));\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampWithChildViews() throws Exception {\n+        Assume.assumeTrue(isMultiTenant);\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String globalViewName = \"V_\" + generateUniqueName();\n+        String tenantViewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String globalViewFullName = SchemaUtil.getTableName(schemaName, globalViewName);\n+        String tenantViewFullName = SchemaUtil.getTableName(schemaName, tenantViewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        //create a table with a child global view, who then has a child tenant view\n+        String globalViewDDL =\n+            \"CREATE VIEW \" + globalViewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String tenantViewDDL =\n+            \"CREATE VIEW \" + tenantViewFullName + \" AS SELECT * FROM \" + globalViewFullName;\n+\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        long tableDDLTimestamp, globalViewDDLTimestamp;\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(globalViewDDL);\n+            tableDDLTimestamp = getLastDDLTimestamp(conn, dataTableFullName);\n+            globalViewDDLTimestamp = getLastDDLTimestamp(conn, globalViewFullName);\n+        }\n+        props.setProperty(TENANT_ID_ATTRIB, TENANT1);\n+        try (Connection tenantConn = DriverManager.getConnection(getUrl(), props)) {\n+            tenantConn.createStatement().execute(tenantViewDDL);\n+        }\n+        // First, check that adding a child view didn't change the timestamps", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 157}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1NDk0Nw==", "bodyText": "I don't see any usage of first 3 arguments String tenantId, String schemaName, String tableName\nMaybe you used them in earlier draft then removed them ?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523054947", "createdAt": "2020-11-13T16:17:55Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/CreateTableIT.java", "diffHunk": "@@ -910,6 +911,41 @@ public void testTableDescriptorPriority() throws SQLException, IOException {\n         }\n     }\n \n+    @Test\n+    public void testCreateTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        final String schemaName = generateUniqueName();\n+        final String tableName = generateUniqueName();\n+        final String dataTableFullName = SchemaUtil.getTableName(schemaName, tableName);\n+        String ddl =\n+            \"CREATE TABLE \" + dataTableFullName + \" (\\n\" + \"ID1 VARCHAR(15) NOT NULL,\\n\"\n+                + \"ID2 VARCHAR(15) NOT NULL,\\n\" + \"CREATED_DATE DATE,\\n\"\n+                + \"CREATION_TIME BIGINT,\\n\" + \"LAST_USED DATE,\\n\"\n+                + \"CONSTRAINT PK PRIMARY KEY (ID1, ID2)) \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(ddl);\n+            verifyLastDDLTimestamp(schemaName, tableName, dataTableFullName, startTS, conn);\n+        }\n+    }\n+\n+    public static long verifyLastDDLTimestamp(String schemaName, String tableName,\n+                                              String dataTableFullName, long startTS, Connection conn) throws SQLException {\n+        return verifyLastDDLTimestamp(\"\", schemaName, tableName, dataTableFullName, startTS, conn);\n+    }\n+\n+    public static long verifyLastDDLTimestamp(String tenantId, String schemaName, String tableName,\n+                                              String dataTableFullName, long startTS, Connection conn) throws SQLException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2NTM0MA==", "bodyText": "nit: indentation mismatch.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523065340", "createdAt": "2020-11-13T16:34:18Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/MetaDataEndpointImpl.java", "diffHunk": "@@ -2802,7 +2827,8 @@ private MetaDataMutationResult mutateColumn(\n                         getParentPhysicalTableName(table), table.getType());\n \n                 result = mutator.validateAndAddMetadata(table, rowKeyMetaData, tableMetadata,\n-                        region, invalidateList, locks, clientTimeStamp, clientVersion);\n+                        region, invalidateList, locks, clientTimeStamp, clientVersion,\n+                    isAddingOrDroppingColumns);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2NzcwNQ==", "bodyText": "Thank you for educating me. :)", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523067705", "createdAt": "2020-11-13T16:37:33Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -2285,6 +2286,7 @@ public MetaDataResponse call(MetaDataService instance) throws IOException {\n                     builder.setClientVersion(VersionUtil.encodeVersion(PHOENIX_MAJOR_VERSION, PHOENIX_MINOR_VERSION, PHOENIX_PATCH_NUMBER));\n                     if (parentTable!=null)\n                         builder.setParentTable(PTableImpl.toProto(parentTable));\n+                    builder.setAddingColumns(addingColumns);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwNjI1MA=="}, "originalCommit": {"oid": "d7e52a93c8d8b5becdf3dd2d8e1ec8fe18074459"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3NTc5Nw==", "bodyText": "I know this is a very nit pick.. but for split lines the spacing rule is 8 spaces. For conditional/loop statements body I agree it is 4 spaces.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523075797", "createdAt": "2020-11-13T16:50:31Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/schema/MetaDataClient.java", "diffHunk": "@@ -3063,60 +3063,62 @@ public boolean isViewReferenced() {\n              */\n             EncodedCQCounter cqCounterToBe = tableType == PTableType.VIEW ? NULL_COUNTER : cqCounter;\n             PTable table = new PTableImpl.Builder()\n-                    .setType(tableType)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwODE2NQ=="}, "originalCommit": {"oid": "d7e52a93c8d8b5becdf3dd2d8e1ec8fe18074459"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3NzU1Nw==", "bodyText": "I am ok with the name just wanted to learn more context. thank you !", "url": "https://github.com/apache/phoenix/pull/935#discussion_r523077557", "createdAt": "2020-11-13T16:53:21Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/util/MetaDataUtil.java", "diffHunk": "@@ -107,6 +107,29 @@\n             HColumnDescriptor.KEEP_DELETED_CELLS,\n             HColumnDescriptor.REPLICATION_SCOPE);\n \n+    public static Put getLastDDLTimestampUpdate(byte[] tableHeaderRowKey,\n+                                                     long clientTimestamp,\n+                                                     long lastDDLTimestamp) {\n+        //use client timestamp as the timestamp of the Cell, to match the other Cells that might\n+        // be created by this DDL. But the actual value will be a _server_ timestamp\n+        Put p = new Put(tableHeaderRowKey, clientTimestamp);\n+        byte[] lastDDLTimestampBytes = PLong.INSTANCE.toBytes(lastDDLTimestamp);\n+        p.addColumn(PhoenixDatabaseMetaData.TABLE_FAMILY_BYTES,\n+            PhoenixDatabaseMetaData.LAST_DDL_TIMESTAMP_BYTES, lastDDLTimestampBytes);\n+        return p;\n+    }\n+\n+    /**\n+     * Checks if a table is meant to be queried directly (and hence is relevant to external\n+     * systems tracking Phoenix schema)\n+     * @param tableType\n+     * @return True if a table or view, false otherwise (such as for an index, system table, or\n+     * subquery)\n+     */\n+    public static boolean isTableQueryable(PTableType tableType) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwOTQwOQ=="}, "originalCommit": {"oid": "d7e52a93c8d8b5becdf3dd2d8e1ec8fe18074459"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNTg1NDgz", "url": "https://github.com/apache/phoenix/pull/935#pullrequestreview-532585483", "createdAt": "2020-11-17T16:59:04Z", "commit": {"oid": "c467995234204c9d9ed0682f3b3bfde2121c9f2a"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNjo1OTowNFrOH0_SCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzowMDoxNlrOH0_XCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMyNDgwOQ==", "bodyText": "@gjacoby126  looks like this comment was missed ?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525324809", "createdAt": "2020-11-17T16:59:04Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableIT.java", "diffHunk": "@@ -1326,7 +1328,69 @@ public void testAddingColumnsToTablesAndViews() throws Exception {\n             assertSequenceNumber(schemaName, viewName, PTable.INITIAL_SEQ_NUM + 1);\n         }\n     }\n-\t\n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String tableDDL = \"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" ENTITY_ID integer NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (ENTITY_ID, COL1, COL2)\"\n+            + \" ) \" + generateDDLOptions(\"\");\n+\n+        String columnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAzNzg2MQ=="}, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMyNDk1NA==", "bodyText": "@gjacoby126  looks like this comment was missed ?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525324954", "createdAt": "2020-11-17T16:59:14Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableIT.java", "diffHunk": "@@ -1326,7 +1328,69 @@ public void testAddingColumnsToTablesAndViews() throws Exception {\n             assertSequenceNumber(schemaName, viewName, PTable.INITIAL_SEQ_NUM + 1);\n         }\n     }\n-\t\n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String tableDDL = \"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" ENTITY_ID integer NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (ENTITY_ID, COL1, COL2)\"\n+            + \" ) \" + generateDDLOptions(\"\");\n+\n+        String columnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testSetPropertyDoesntUpdateDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String tableDDL = \"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" ENTITY_ID integer NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (ENTITY_ID, COL1, COL2)\"\n+            + \" ) \" + generateDDLOptions(\"\");\n+\n+        String setPropertyDDL = \"ALTER TABLE \" + dataTableFullName +\n+            \" SET UPDATE_CACHE_FREQUENCY=300000 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAzNTc0Mw=="}, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMyNTgxNg==", "bodyText": "@gjacoby126  This is not a comment for changing anything. This is just for my knowledge.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525325816", "createdAt": "2020-11-17T17:00:01Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1218,248 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior\n+        // extends to DDL timestamp\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String divergeDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL2\";\n+        String viewColumnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String viewColumnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        String tableColumnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL4 varchar\" +\n+            \"(50) NULL\";\n+        String tableColumnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL4 \";\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(viewDDL);\n+            long viewDDLTimestamp = getLastDDLTimestamp(conn, viewFullName);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(divergeDDL);\n+            //verify DDL timestamp changed\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(viewColumnAddDDL);\n+            //verify DDL timestamp changed because we added a column to the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(viewColumnDropDDL);\n+            //verify DDL timestamp changed because we dropped a column from the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(tableColumnAddDDL);\n+            //verify DDL timestamp DID NOT change because we added a column from the base table\n+            assertEquals(viewDDLTimestamp, getLastDDLTimestamp(conn, viewFullName));\n+            conn.createStatement().execute(tableColumnDropDDL);\n+            assertEquals(viewDDLTimestamp, getLastDDLTimestamp(conn, viewFullName));\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampWithChildViews() throws Exception {\n+        Assume.assumeTrue(isMultiTenant);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA0ODA3MA=="}, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMyNjA4OQ==", "bodyText": "@gjacoby126  looks like this comment was missed ?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525326089", "createdAt": "2020-11-17T17:00:16Z", "author": {"login": "shahrs87"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1218,248 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, dataTableName,\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior\n+        // extends to DDL timestamp\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String divergeDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL2\";\n+        String viewColumnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String viewColumnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        String tableColumnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL4 varchar\" +\n+            \"(50) NULL\";\n+        String tableColumnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL4 \";\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(viewDDL);\n+            long viewDDLTimestamp = getLastDDLTimestamp(conn, viewFullName);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(divergeDDL);\n+            //verify DDL timestamp changed\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(viewColumnAddDDL);\n+            //verify DDL timestamp changed because we added a column to the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(viewColumnDropDDL);\n+            //verify DDL timestamp changed because we dropped a column from the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(schemaName, viewName,\n+                viewFullName, viewDDLTimestamp, conn);\n+            conn.createStatement().execute(tableColumnAddDDL);\n+            //verify DDL timestamp DID NOT change because we added a column from the base table\n+            assertEquals(viewDDLTimestamp, getLastDDLTimestamp(conn, viewFullName));\n+            conn.createStatement().execute(tableColumnDropDDL);\n+            assertEquals(viewDDLTimestamp, getLastDDLTimestamp(conn, viewFullName));\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampWithChildViews() throws Exception {\n+        Assume.assumeTrue(isMultiTenant);\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String globalViewName = \"V_\" + generateUniqueName();\n+        String tenantViewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String globalViewFullName = SchemaUtil.getTableName(schemaName, globalViewName);\n+        String tenantViewFullName = SchemaUtil.getTableName(schemaName, tenantViewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        //create a table with a child global view, who then has a child tenant view\n+        String globalViewDDL =\n+            \"CREATE VIEW \" + globalViewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String tenantViewDDL =\n+            \"CREATE VIEW \" + tenantViewFullName + \" AS SELECT * FROM \" + globalViewFullName;\n+\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        long tableDDLTimestamp, globalViewDDLTimestamp;\n+\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            conn.createStatement().execute(globalViewDDL);\n+            tableDDLTimestamp = getLastDDLTimestamp(conn, dataTableFullName);\n+            globalViewDDLTimestamp = getLastDDLTimestamp(conn, globalViewFullName);\n+        }\n+        props.setProperty(TENANT_ID_ATTRIB, TENANT1);\n+        try (Connection tenantConn = DriverManager.getConnection(getUrl(), props)) {\n+            tenantConn.createStatement().execute(tenantViewDDL);\n+        }\n+        // First, check that adding a child view didn't change the timestamps", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1MzEzNw=="}, "originalCommit": {"oid": "07c5ed5b6bb14ce4f583431f25b5ebf6699d8958"}, "originalPosition": 157}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/68558234b685922a6c3b29d86153d0054e0f7b83", "committedDate": "2020-11-17T17:30:23Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}, "afterCommit": {"oid": "7f6c9895009a67280e825944ab0019096b916fc2", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/7f6c9895009a67280e825944ab0019096b916fc2", "committedDate": "2020-11-17T21:35:26Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNzU1Mzkx", "url": "https://github.com/apache/phoenix/pull/935#pullrequestreview-532755391", "createdAt": "2020-11-17T19:49:28Z", "commit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0OToyOVrOH1HDsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMTo1Nzo0NFrOH1NIsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1MjIxMA==", "bodyText": "nit: We already have conn.commit()inside nullDDLTimestamps()", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525452210", "createdAt": "2020-11-17T19:49:29Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/UpgradeIT.java", "diffHunk": "@@ -747,4 +640,83 @@ private void verifyExpectedCellValue(byte[] rowKey, byte[] syscatBytes,\n             assertArrayEquals(expectedDateTypeBytes, CellUtil.cloneValue(cell));\n         }\n     }\n+\n+    @Test\n+    public void testLastDDLTimestampBootstrap() throws Exception {\n+        //Create a table, view, and index\n+        String schemaName = \"S_\" + generateUniqueName();\n+        String tableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String fullTableName = SchemaUtil.getTableName(schemaName, tableName);\n+        String fullViewName = SchemaUtil.getTableName(schemaName, viewName);\n+        try (Connection conn = getConnection(false, null)) {\n+            conn.createStatement().execute(\n+                \"CREATE TABLE \" + fullTableName\n+                    + \" (PK1 VARCHAR NOT NULL, PK2 VARCHAR, KV1 VARCHAR, KV2 VARCHAR CONSTRAINT \" +\n+                    \"PK PRIMARY KEY(PK1, PK2)) \");\n+            conn.createStatement().execute(\n+                \"CREATE VIEW \" + fullViewName + \" AS SELECT * FROM \" + fullTableName);\n+\n+            //Now we null out any existing last ddl timestamps\n+            nullDDLTimestamps(conn);\n+            conn.commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 169}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1NDE1OQ==", "bodyText": "Should we also move this test to UpgradeNamespaceIT?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525454159", "createdAt": "2020-11-17T19:51:04Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/UpgradeIT.java", "diffHunk": "@@ -91,122 +100,6 @@\n @Category(NeedsOwnMiniClusterTest.class)\n public class UpgradeIT extends ParallelStatsDisabledIT {\n \n-    @Test\n-    public void testMapTableToNamespaceDuringUpgrade()\n-            throws SQLException, IOException, IllegalArgumentException, InterruptedException {\n-        String[] strings = new String[] { \"a\", \"b\", \"c\", \"d\" };\n-\n-        try (Connection conn = DriverManager.getConnection(getUrl())) {\n-            String schemaName = \"TEST\";\n-            String phoenixFullTableName = schemaName + \".\" + generateUniqueName();\n-            String indexName = \"IDX_\" + generateUniqueName();\n-            String localIndexName = \"LIDX_\" + generateUniqueName();\n-\n-            String viewName = \"VIEW_\" + generateUniqueName();\n-            String viewIndexName = \"VIDX_\" + generateUniqueName();\n-\n-            String[] tableNames = new String[] { phoenixFullTableName, schemaName + \".\" + indexName,\n-                    schemaName + \".\" + localIndexName, \"diff.\" + viewName, \"test.\" + viewName, viewName};\n-            String[] viewIndexes = new String[] { \"diff.\" + viewIndexName, \"test.\" + viewIndexName };\n-            conn.createStatement().execute(\"CREATE TABLE \" + phoenixFullTableName\n-                    + \"(k VARCHAR PRIMARY KEY, v INTEGER, f INTEGER, g INTEGER NULL, h INTEGER NULL)\");\n-            PreparedStatement upsertStmt = conn\n-                    .prepareStatement(\"UPSERT INTO \" + phoenixFullTableName + \" VALUES(?, ?, 0, 0, 0)\");\n-            int i = 1;\n-            for (String str : strings) {\n-                upsertStmt.setString(1, str);\n-                upsertStmt.setInt(2, i++);\n-                upsertStmt.execute();\n-            }\n-            conn.commit();\n-            // creating local index\n-            conn.createStatement()\n-                    .execute(\"create local index \" + localIndexName + \" on \" + phoenixFullTableName + \"(K)\");\n-            // creating global index\n-            conn.createStatement().execute(\"create index \" + indexName + \" on \" + phoenixFullTableName + \"(k)\");\n-            // creating view in schema 'diff'\n-            conn.createStatement().execute(\"CREATE VIEW diff.\" + viewName + \" (col VARCHAR) AS SELECT * FROM \" + phoenixFullTableName);\n-            // creating view in schema 'test'\n-            conn.createStatement().execute(\"CREATE VIEW test.\" + viewName + \" (col VARCHAR) AS SELECT * FROM \" + phoenixFullTableName);\n-            conn.createStatement().execute(\"CREATE VIEW \" + viewName + \"(col VARCHAR) AS SELECT * FROM \" + phoenixFullTableName);\n-            // Creating index on views\n-            conn.createStatement().execute(\"create index \" + viewIndexName + \"  on diff.\" + viewName + \"(col)\");\n-            conn.createStatement().execute(\"create index \" + viewIndexName + \" on test.\" + viewName + \"(col)\");\n-\n-            // validate data\n-            for (String tableName : tableNames) {\n-                ResultSet rs = conn.createStatement().executeQuery(\"select * from \" + tableName);\n-                for (String str : strings) {\n-                    assertTrue(rs.next());\n-                    assertEquals(str, rs.getString(1));\n-                }\n-            }\n-\n-            // validate view Index data\n-            for (String viewIndex : viewIndexes) {\n-                ResultSet rs = conn.createStatement().executeQuery(\"select * from \" + viewIndex);\n-                for (String str : strings) {\n-                    assertTrue(rs.next());\n-                    assertEquals(str, rs.getString(2));\n-                }\n-            }\n-\n-            HBaseAdmin admin = conn.unwrap(PhoenixConnection.class).getQueryServices().getAdmin();\n-            assertTrue(admin.tableExists(phoenixFullTableName));\n-            assertTrue(admin.tableExists(schemaName + QueryConstants.NAME_SEPARATOR + indexName));\n-            assertTrue(admin.tableExists(MetaDataUtil.getViewIndexPhysicalName(Bytes.toBytes(phoenixFullTableName))));\n-            Properties props = new Properties();\n-            props.setProperty(QueryServices.IS_NAMESPACE_MAPPING_ENABLED, Boolean.toString(true));\n-            props.setProperty(QueryServices.IS_SYSTEM_TABLE_MAPPED_TO_NAMESPACE, Boolean.toString(false));\n-            admin.close();\n-            PhoenixConnection phxConn = DriverManager.getConnection(getUrl(), props).unwrap(PhoenixConnection.class);\n-            UpgradeUtil.upgradeTable(phxConn, phoenixFullTableName);\n-            phxConn.close();\n-            props = new Properties();\n-            phxConn = DriverManager.getConnection(getUrl(), props).unwrap(PhoenixConnection.class);\n-            // purge MetaDataCache except for system tables\n-            phxConn.getMetaDataCache().pruneTables(new PMetaData.Pruner() {\n-                @Override public boolean prune(PTable table) {\n-                    return table.getType() != PTableType.SYSTEM;\n-                }\n-\n-                @Override public boolean prune(PFunction function) {\n-                    return false;\n-                }\n-            });\n-            admin = phxConn.getQueryServices().getAdmin();\n-            String hbaseTableName = SchemaUtil.getPhysicalTableName(Bytes.toBytes(phoenixFullTableName), true)\n-                    .getNameAsString();\n-            assertTrue(admin.tableExists(hbaseTableName));\n-            assertTrue(admin.tableExists(Bytes.toBytes(hbaseTableName)));\n-            assertTrue(admin.tableExists(schemaName + QueryConstants.NAMESPACE_SEPARATOR + indexName));\n-            assertTrue(admin.tableExists(MetaDataUtil.getViewIndexPhysicalName(Bytes.toBytes(hbaseTableName))));\n-            i = 0;\n-            // validate data\n-            for (String tableName : tableNames) {\n-                ResultSet rs = phxConn.createStatement().executeQuery(\"select * from \" + tableName);\n-                for (String str : strings) {\n-                    assertTrue(rs.next());\n-                    assertEquals(str, rs.getString(1));\n-                }\n-            }\n-            // validate view Index data\n-            for (String viewIndex : viewIndexes) {\n-                ResultSet rs = conn.createStatement().executeQuery(\"select * from \" + viewIndex);\n-                for (String str : strings) {\n-                    assertTrue(rs.next());\n-                    assertEquals(str, rs.getString(2));\n-                }\n-            }\n-            PName tenantId = phxConn.getTenantId();\n-            PName physicalName = PNameFactory.newName(hbaseTableName);\n-            String newSchemaName = MetaDataUtil.getViewIndexSequenceSchemaName(physicalName, true);\n-            String newSequenceName = MetaDataUtil.getViewIndexSequenceName(physicalName, tenantId, true);\n-            verifySequenceValue(null, newSequenceName, newSchemaName, Short.MIN_VALUE + 3);\n-            admin.close();\n-        }\n-    }\n-\n     @Test\n     public void testMapMultiTenantTableToNamespaceDuringUpgrade() throws SQLException, SnapshotCreationException,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1NDk5Nw==", "bodyText": "nit: Don't need the tenantId variable here", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525454997", "createdAt": "2020-11-17T19:51:43Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/ViewIT.java", "diffHunk": "@@ -387,6 +388,48 @@ public void testViewUsesTableLocalIndex() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testCreateViewTimestamp() throws Exception {\n+        String tenantId = null;\n+        createViewTimestampHelper(tenantId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1NjM3Ng==", "bodyText": "I think we can remove this else block since the reinitialized value for tenantId isn't being used anywhere", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525456376", "createdAt": "2020-11-17T19:52:52Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/ViewIT.java", "diffHunk": "@@ -387,6 +388,48 @@ public void testViewUsesTableLocalIndex() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testCreateViewTimestamp() throws Exception {\n+        String tenantId = null;\n+        createViewTimestampHelper(tenantId);\n+    }\n+\n+    @Test\n+    public void testCreateTenantViewTimestamp() throws Exception {\n+        createViewTimestampHelper(TENANT1);\n+    }\n+\n+    private void createViewTimestampHelper(String tenantId) throws SQLException {\n+        Properties props = new Properties();\n+        if (tenantId != null) {\n+            props.setProperty(PhoenixRuntime.TENANT_ID_ATTRIB, tenantId);\n+        } else {\n+            tenantId = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1OTk0Mw==", "bodyText": "I also think this name is a little confusing. Maybe something like isTableTypeDirectlyQueried() is more in line with what we mean", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525459943", "createdAt": "2020-11-17T19:55:45Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/util/MetaDataUtil.java", "diffHunk": "@@ -107,6 +107,29 @@\n             HColumnDescriptor.KEEP_DELETED_CELLS,\n             HColumnDescriptor.REPLICATION_SCOPE);\n \n+    public static Put getLastDDLTimestampUpdate(byte[] tableHeaderRowKey,\n+                                                     long clientTimestamp,\n+                                                     long lastDDLTimestamp) {\n+        //use client timestamp as the timestamp of the Cell, to match the other Cells that might\n+        // be created by this DDL. But the actual value will be a _server_ timestamp\n+        Put p = new Put(tableHeaderRowKey, clientTimestamp);\n+        byte[] lastDDLTimestampBytes = PLong.INSTANCE.toBytes(lastDDLTimestamp);\n+        p.addColumn(PhoenixDatabaseMetaData.TABLE_FAMILY_BYTES,\n+            PhoenixDatabaseMetaData.LAST_DDL_TIMESTAMP_BYTES, lastDDLTimestampBytes);\n+        return p;\n+    }\n+\n+    /**\n+     * Checks if a table is meant to be queried directly (and hence is relevant to external\n+     * systems tracking Phoenix schema)\n+     * @param tableType\n+     * @return True if a table or view, false otherwise (such as for an index, system table, or\n+     * subquery)\n+     */\n+    public static boolean isTableQueryable(PTableType tableType) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwOTQwOQ=="}, "originalCommit": {"oid": "d7e52a93c8d8b5becdf3dd2d8e1ec8fe18074459"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzOTQ0OQ==", "bodyText": "This is not entirely true. I know this is frustrating (I was in the same boat), but in 4.15+ based on what I've gathered, here are the rules for column inheritance w.r.t. diverged and non-diverged views:\nDropping columns from a parent\n\nAny columns dropped from an ancestor that is a physical base table are \"inherited\" by its entire child view hierarchy. This is obvious since the physical column no longer exists and so any descendant view wouldn't be able to project anything for those dropped columns.\n\nSince the shape of the child view changes in this case, we should probably use max(view_DDL_ts, parent_DDL_ts_corresponding_to_col_drop).\nNot sure how easy of a change it would be to store this ts corresponding to column dropped from the parent.\n\n\nAny columns dropped from an ancestor that is a view are \"inherited\" by its entire child view hierarchy even if a child view has diverged.\n\nSame here\n\n\n\nAdding columns to a parent\n\nAny columns added to an ancestor that is a view or physical base table are only inherited by its descendant views that have not diverged.\n\nI think your changes already capture this.\n\n\n\nOverall, the rule seems to be:\nOnce a view diverges from its parent, any columns added to an ancestor base table/view are no longer propagated to the view. A column dropped on an ancestor base table/view is however, always propagated to the child view.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525539449", "createdAt": "2020-11-17T21:34:37Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1216,251 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzOTczNQ==", "bodyText": "We should ideally drop a pre-existing column from the parent for this test rather than a column that was newly added to the parent.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525539735", "createdAt": "2020-11-17T21:35:07Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1216,251 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior\n+        // extends to DDL timestamp\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String divergeDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL2\";\n+        String viewColumnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String viewColumnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzOTkxMA==", "bodyText": "Same here.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525539910", "createdAt": "2020-11-17T21:35:27Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1216,251 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior\n+        // extends to DDL timestamp\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String divergeDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL2\";\n+        String viewColumnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String viewColumnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        String tableColumnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL4 varchar\" +\n+            \"(50) NULL\";\n+        String tableColumnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL4 \";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU0MDI5Mw==", "bodyText": "Column drop should change the last DDL timestamp for child views as explained in my previous comment.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525540293", "createdAt": "2020-11-17T21:36:11Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/AlterTableWithViewsIT.java", "diffHunk": "@@ -1216,5 +1216,251 @@ public void testDroppingIndexedColDropsViewIndex() throws Exception {\n             assertNull(results.next());\n         }\n     }\n-    \n+\n+    @Test\n+    public void testAddThenDropColumnTableDDLTimestamp() throws Exception {\n+        Properties props = new Properties();\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint NOT NULL,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1, COL2)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String columnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String columnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        long startTS = EnvironmentEdgeManager.currentTimeMillis();\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n+            conn.createStatement().execute(tableDDL);\n+            //first get the original DDL timestamp when we created the table\n+            long tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                dataTableFullName, startTS,\n+                conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName, tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            //now add a column and make sure the timestamp updates\n+            conn.createStatement().execute(columnAddDDL);\n+            tableDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName,\n+                tableDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(columnDropDDL);\n+            CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName,\n+                tableDDLTimestamp + 1 , conn);\n+        }\n+    }\n+\n+    @Test\n+    public void testLastDDLTimestampForDivergedViews() throws Exception {\n+        //Phoenix allows users to \"drop\" columns from views that are inherited from their ancestor\n+        // views or tables. These columns are then excluded from the view schema, and the view is\n+        // considered \"diverged\" from its parents, and so no longer inherit any additional schema\n+        // changes that are applied to their ancestors. This test make sure that this behavior\n+        // extends to DDL timestamp\n+        String schemaName = SCHEMA1;\n+        String dataTableName = \"T_\" + generateUniqueName();\n+        String viewName = \"V_\" + generateUniqueName();\n+        String dataTableFullName = SchemaUtil.getTableName(schemaName, dataTableName);\n+        String viewFullName = SchemaUtil.getTableName(schemaName, viewName);\n+\n+        String tableDDL = generateDDL(\"CREATE TABLE IF NOT EXISTS \" + dataTableFullName + \" (\"\n+            + \" %s ID char(1) NOT NULL,\"\n+            + \" COL1 integer NOT NULL,\"\n+            + \" COL2 bigint,\"\n+            + \" CONSTRAINT NAME_PK PRIMARY KEY (%s ID, COL1)\"\n+            + \" ) %s\");\n+\n+        String viewDDL = \"CREATE VIEW \" + viewFullName + \" AS SELECT * FROM \" + dataTableFullName;\n+\n+        String divergeDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL2\";\n+        String viewColumnAddDDL = \"ALTER VIEW \" + viewFullName + \" ADD COL3 varchar(50) NULL \";\n+        String viewColumnDropDDL = \"ALTER VIEW \" + viewFullName + \" DROP COLUMN COL3 \";\n+        String tableColumnAddDDL = \"ALTER TABLE \" + dataTableFullName + \" ADD COL4 varchar\" +\n+            \"(50) NULL\";\n+        String tableColumnDropDDL = \"ALTER TABLE \" + dataTableFullName + \" DROP COLUMN COL4 \";\n+        try (Connection conn = DriverManager.getConnection(getUrl())) {\n+            conn.createStatement().execute(tableDDL);\n+            long tableDDLTimestamp = CreateTableIT.getLastDDLTimestamp(conn, dataTableFullName);\n+            conn.createStatement().execute(viewDDL);\n+            long viewDDLTimestamp = CreateTableIT.getLastDDLTimestamp(conn, viewFullName);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(divergeDDL);\n+            //verify table DDL timestamp DID NOT change\n+            assertEquals(tableDDLTimestamp, CreateTableIT.getLastDDLTimestamp(conn, dataTableFullName));\n+            //verify view DDL timestamp changed\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName, viewDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewColumnAddDDL);\n+            //verify DDL timestamp changed because we added a column to the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName, viewDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(viewColumnDropDDL);\n+            //verify DDL timestamp changed because we dropped a column from the view\n+            viewDDLTimestamp = CreateTableIT.verifyLastDDLTimestamp(\n+                viewFullName, viewDDLTimestamp + 1, conn);\n+            Thread.sleep(1);\n+            conn.createStatement().execute(tableColumnAddDDL);\n+            //verify DDL timestamp DID NOT change because we added a column from the base table\n+            assertEquals(viewDDLTimestamp, CreateTableIT.getLastDDLTimestamp(conn, viewFullName));\n+            conn.createStatement().execute(tableColumnDropDDL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU0MTkyMw==", "bodyText": "Just for clarity, can we mention that this logic only applies to non-diverged views?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525541923", "createdAt": "2020-11-17T21:39:15Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/AddColumnMutator.java", "diffHunk": "@@ -399,6 +400,17 @@ public MetaDataMutationResult validateAndAddMetadata(PTable table, byte[][] rowK\n                                 rowKeyMetaData[TABLE_NAME_INDEX])));\n             }\n         }\n+        if (isAddingColumns) {\n+            //We're changing the application-facing schema by adding a column, so update the DDL\n+            // timestamp\n+            long serverTimestamp = EnvironmentEdgeManager.currentTimeMillis();\n+            if (MetaDataUtil.isTableQueryable(table.getType())) {\n+                additionalTableMetadataMutations.add(MetaDataUtil.getLastDDLTimestampUpdate(tableHeaderRowKey,\n+                    clientTimeStamp, serverTimestamp));\n+            }\n+            //we don't need to update the DDL timestamp for child views, because when we look up", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU0MjIyMQ==", "bodyText": "For clarity, can we mention that this logic also applies for diverged views?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525542221", "createdAt": "2020-11-17T21:39:45Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/DropColumnMutator.java", "diffHunk": "@@ -268,6 +272,16 @@ public MetaDataMutationResult validateAndAddMetadata(PTable table,\n             }\n \n         }\n+        //We're changing the application-facing schema by dropping a column, so update the DDL\n+        // timestamp to current _server_ timestamp\n+        if (MetaDataUtil.isTableQueryable(table.getType())) {\n+            long serverTimestamp = EnvironmentEdgeManager.currentTimeMillis();\n+            additionalTableMetaData.add(MetaDataUtil.getLastDDLTimestampUpdate(tableHeaderRowKey,\n+                clientTimeStamp, serverTimestamp));\n+        }\n+        //we don't need to update the DDL timestamp for any child views we may have, because", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU0Mjg2Ng==", "bodyText": "This comment is no longer valid right?", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525542866", "createdAt": "2020-11-17T21:40:59Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/MetaDataEndpointImpl.java", "diffHunk": "@@ -2846,21 +2872,25 @@ private MetaDataMutationResult mutateColumn(\n                 separateLocalAndRemoteMutations(region, tableMetadata, localMutations,\n                         remoteMutations);\n                 if (!remoteMutations.isEmpty()) {\n-                    // there should only be remote mutations if we are adding a column to a view\n+                    // there should only be remote mutations if we are updating the last ddl", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU0MzU4OQ==", "bodyText": "Shouldn't this be done even if if (!remoteMutations.isEmpty()) is false if the table/view has child views??", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525543589", "createdAt": "2020-11-17T21:42:22Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/MetaDataEndpointImpl.java", "diffHunk": "@@ -2846,21 +2872,25 @@ private MetaDataMutationResult mutateColumn(\n                 separateLocalAndRemoteMutations(region, tableMetadata, localMutations,\n                         remoteMutations);\n                 if (!remoteMutations.isEmpty()) {\n-                    // there should only be remote mutations if we are adding a column to a view\n+                    // there should only be remote mutations if we are updating the last ddl\n+                    // timestamp for child views, or we are adding a column to a view\n                     // that uses encoded column qualifiers (the remote mutations are to update the\n                     // encoded column qualifier counter on the parent table)\n-                    if (mutator.getMutateColumnType() == ColumnMutator.MutateColumnType.ADD_COLUMN\n+                    if (childViews.size() > 0 || ( mutator.getMutateColumnType() == ColumnMutator.MutateColumnType.ADD_COLUMN", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU0OTcyNw==", "bodyText": "Except for when a column is dropped from some ancestor after the view diverged. In that case, they do \"inherit\" that change, just like they would have before diverging.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525549727", "createdAt": "2020-11-17T21:53:54Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/util/ViewUtil.java", "diffHunk": "@@ -654,10 +654,17 @@ public static PTable addDerivedColumnsFromParent(PTable view, PTable parentTable\n         }\n \n         long maxTableTimestamp = view.getTimeStamp();\n+        long maxDDLTimestamp = view.getLastDDLTimestamp() != null ? view.getLastDDLTimestamp() : 0L;\n         int numPKCols = view.getPKColumns().size();\n-        // set the final table timestamp as the max timestamp of the view/view index or its\n-        // ancestors\n+        // set the final table timestamp and DDL timestamp as the respective max timestamps of the\n+        // view/view index or its ancestors\n         maxTableTimestamp = Math.max(maxTableTimestamp, parentTable.getTimeStamp());\n+        //Diverged views no longer inherit ddl timestamps from their ancestors because they don't\n+        // inherit column changes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1MTc5Mw==", "bodyText": "Maybe we need to introduce another field in PTable to explicitly store any drop column DDLs being issued to a table/view. Then we could use that to get the lastDDLTs of diverged views.", "url": "https://github.com/apache/phoenix/pull/935#discussion_r525551793", "createdAt": "2020-11-17T21:57:44Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/util/ViewUtil.java", "diffHunk": "@@ -654,10 +654,17 @@ public static PTable addDerivedColumnsFromParent(PTable view, PTable parentTable\n         }\n \n         long maxTableTimestamp = view.getTimeStamp();\n+        long maxDDLTimestamp = view.getLastDDLTimestamp() != null ? view.getLastDDLTimestamp() : 0L;\n         int numPKCols = view.getPKColumns().size();\n-        // set the final table timestamp as the max timestamp of the view/view index or its\n-        // ancestors\n+        // set the final table timestamp and DDL timestamp as the respective max timestamps of the\n+        // view/view index or its ancestors\n         maxTableTimestamp = Math.max(maxTableTimestamp, parentTable.getTimeStamp());\n+        //Diverged views no longer inherit ddl timestamps from their ancestors because they don't\n+        // inherit column changes", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU0OTcyNw=="}, "originalCommit": {"oid": "68558234b685922a6c3b29d86153d0054e0f7b83"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f427501628fcb482405b0c0dff7cf510650dee00", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/f427501628fcb482405b0c0dff7cf510650dee00", "committedDate": "2020-11-18T21:33:32Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d62faa2e2ff95ff93d10dfc946f8d6dd8c39f418", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/d62faa2e2ff95ff93d10dfc946f8d6dd8c39f418", "committedDate": "2020-11-18T21:33:33Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75c5bdfd326cdf71c0a3ec8b76756ffa0ae1e058", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/75c5bdfd326cdf71c0a3ec8b76756ffa0ae1e058", "committedDate": "2020-11-18T21:52:39Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac5daf584648e36dc0e3bee69d6f186225b3700e", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/ac5daf584648e36dc0e3bee69d6f186225b3700e", "committedDate": "2020-11-18T17:57:41Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}, "afterCommit": {"oid": "75c5bdfd326cdf71c0a3ec8b76756ffa0ae1e058", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/75c5bdfd326cdf71c0a3ec8b76756ffa0ae1e058", "committedDate": "2020-11-18T21:52:39Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80982e2a559aaad6a0d25885455b0bc6698ac58b", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/80982e2a559aaad6a0d25885455b0bc6698ac58b", "committedDate": "2020-11-19T05:55:55Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "171e7e2891314a309eafb03bd5c5fe37bf85bc89", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/171e7e2891314a309eafb03bd5c5fe37bf85bc89", "committedDate": "2020-11-19T17:02:06Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "939db6e26a7538da918f967c49f1ab43b8f0c806", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/939db6e26a7538da918f967c49f1ab43b8f0c806", "committedDate": "2020-11-19T21:56:04Z", "message": "PHOENIX-6186 - Store last DDL timestamp in System.Catalog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTg2Nzgx", "url": "https://github.com/apache/phoenix/pull/935#pullrequestreview-534986781", "createdAt": "2020-11-20T00:27:41Z", "commit": {"oid": "939db6e26a7538da918f967c49f1ab43b8f0c806"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1806, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}