{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MDk3ODky", "number": 857, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNTo0MToyN1rOEZUcOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMDo0OTozMlrOEaJPWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0OTg0NzYyOnYy", "diffSide": "RIGHT", "path": "phoenix-core/src/main/java/org/apache/hadoop/hbase/regionserver/ScanInfoUtil.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNTo0MToyN1rOHCEHyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNTo0MToyN1rOHCEHyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyNjcyOQ==", "bodyText": "This doesn't seem to be referenced anywhere.", "url": "https://github.com/apache/phoenix/pull/857#discussion_r471926729", "createdAt": "2020-08-18T05:41:27Z", "author": {"login": "stoty"}, "path": "phoenix-core/src/main/java/org/apache/hadoop/hbase/regionserver/ScanInfoUtil.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.regionserver;\n+\n+import org.apache.hadoop.conf.Configuration;\n+\n+public class ScanInfoUtil {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69e0550c30a87df82d350961b7512004077c8a88"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0OTg1NzExOnYy", "diffSide": "RIGHT", "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/BaseScannerRegionObserver.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNTo0NTo1NFrOHCENSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNTo0NTo1NFrOHCENSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyODEzNg==", "bodyText": "This doesn't seem to do anything since the subclassing.", "url": "https://github.com/apache/phoenix/pull/857#discussion_r471928136", "createdAt": "2020-08-18T05:45:54Z", "author": {"login": "stoty"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/BaseScannerRegionObserver.java", "diffHunk": "@@ -367,4 +374,16 @@ RegionScanner getWrappedScanner(final ObserverContext<RegionCoprocessorEnvironme\n                 dataRegion, indexMaintainer, null, viewConstants, null, null, projector, ptr, useQualiferAsListIndex);\n     }\n \n+    @Override\n+    public void preStoreScannerOpen(ObserverContext<RegionCoprocessorEnvironment> ctx, Store store,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69e0550c30a87df82d350961b7512004077c8a88"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0OTg1ODAxOnYy", "diffSide": "RIGHT", "path": "phoenix-hbase-compat-2.2.1/src/main/java/org/apache/phoenix/compat/hbase/HbaseCompatCapabilities.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNTo0NjoyM1rOHCEN3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNTo0NjoyM1rOHCEN3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyODI4NQ==", "bodyText": "Nit: indent like above in both files?", "url": "https://github.com/apache/phoenix/pull/857#discussion_r471928285", "createdAt": "2020-08-18T05:46:23Z", "author": {"login": "stoty"}, "path": "phoenix-hbase-compat-2.2.1/src/main/java/org/apache/phoenix/compat/hbase/HbaseCompatCapabilities.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.phoenix.compat.hbase;\n+\n+import org.apache.hadoop.conf.Configuration;\n+\n+public class HbaseCompatCapabilities {\n+\n+    public static boolean isMaxLookbackTimeSupported() {\n+        return false;\n+    }\n+\n+    //In HBase 2.1 and 2.2, a lookback query won't return any results if covered by a future delete\n+    public static boolean isLookbackBeyondDeletesSupported() { return false; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69e0550c30a87df82d350961b7512004077c8a88"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1ODQ5ODE3OnYy", "diffSide": "RIGHT", "path": "phoenix-core/src/main/java/org/apache/phoenix/compile/QueryCompiler.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMDo0OTozMlrOHDYjhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMjo0ODoxNVrOHDeM4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMDA4NQ==", "bodyText": "nit: would be good in understanding if s -> ms conversion happens outside of if condition.", "url": "https://github.com/apache/phoenix/pull/857#discussion_r473310085", "createdAt": "2020-08-19T20:49:32Z", "author": {"login": "swaroopak"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/compile/QueryCompiler.java", "diffHunk": "@@ -172,6 +178,28 @@ public QueryPlan compile() throws SQLException{\n         return plan;\n     }\n \n+    private void verifySCN() throws SQLException {\n+        if (!HbaseCompatCapabilities.isMaxLookbackTimeSupported()) {\n+            return;\n+        }\n+        PhoenixConnection conn = statement.getConnection();\n+        Long scn = conn.getSCN();\n+        if (scn == null) {\n+            return;\n+        }\n+        ColumnResolver resolver =\n+            FromCompiler.getResolverForQuery(select, conn);\n+        int maxLookBackAge = conn.getQueryServices().\n+            getConfiguration().getInt(CompatBaseScannerRegionObserver.PHOENIX_MAX_LOOKBACK_AGE_CONF_KEY,\n+            CompatBaseScannerRegionObserver.DEFAULT_PHOENIX_MAX_LOOKBACK_AGE);\n+        long now = EnvironmentEdgeManager.currentTimeMillis();\n+        if (maxLookBackAge > 0 && now - maxLookBackAge * 1000L > scn){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09694033b829e80597d01cea695a784c4d66ba85"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM0ODk3Ng==", "bodyText": "Not sure I follow? The configuration property is in seconds (to correspond with HBase TTL, which is also in seconds), but we convert to ms in the if-block to compare with the current timestamp.", "url": "https://github.com/apache/phoenix/pull/857#discussion_r473348976", "createdAt": "2020-08-19T21:39:42Z", "author": {"login": "gjacoby126"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/compile/QueryCompiler.java", "diffHunk": "@@ -172,6 +178,28 @@ public QueryPlan compile() throws SQLException{\n         return plan;\n     }\n \n+    private void verifySCN() throws SQLException {\n+        if (!HbaseCompatCapabilities.isMaxLookbackTimeSupported()) {\n+            return;\n+        }\n+        PhoenixConnection conn = statement.getConnection();\n+        Long scn = conn.getSCN();\n+        if (scn == null) {\n+            return;\n+        }\n+        ColumnResolver resolver =\n+            FromCompiler.getResolverForQuery(select, conn);\n+        int maxLookBackAge = conn.getQueryServices().\n+            getConfiguration().getInt(CompatBaseScannerRegionObserver.PHOENIX_MAX_LOOKBACK_AGE_CONF_KEY,\n+            CompatBaseScannerRegionObserver.DEFAULT_PHOENIX_MAX_LOOKBACK_AGE);\n+        long now = EnvironmentEdgeManager.currentTimeMillis();\n+        if (maxLookBackAge > 0 && now - maxLookBackAge * 1000L > scn){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMDA4NQ=="}, "originalCommit": {"oid": "09694033b829e80597d01cea695a784c4d66ba85"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1MTk5Ng==", "bodyText": "maxLookBackAge*1000 can be stored into a variable like done for ttl in other function.", "url": "https://github.com/apache/phoenix/pull/857#discussion_r473351996", "createdAt": "2020-08-19T21:43:33Z", "author": {"login": "swaroopak"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/compile/QueryCompiler.java", "diffHunk": "@@ -172,6 +178,28 @@ public QueryPlan compile() throws SQLException{\n         return plan;\n     }\n \n+    private void verifySCN() throws SQLException {\n+        if (!HbaseCompatCapabilities.isMaxLookbackTimeSupported()) {\n+            return;\n+        }\n+        PhoenixConnection conn = statement.getConnection();\n+        Long scn = conn.getSCN();\n+        if (scn == null) {\n+            return;\n+        }\n+        ColumnResolver resolver =\n+            FromCompiler.getResolverForQuery(select, conn);\n+        int maxLookBackAge = conn.getQueryServices().\n+            getConfiguration().getInt(CompatBaseScannerRegionObserver.PHOENIX_MAX_LOOKBACK_AGE_CONF_KEY,\n+            CompatBaseScannerRegionObserver.DEFAULT_PHOENIX_MAX_LOOKBACK_AGE);\n+        long now = EnvironmentEdgeManager.currentTimeMillis();\n+        if (maxLookBackAge > 0 && now - maxLookBackAge * 1000L > scn){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMDA4NQ=="}, "originalCommit": {"oid": "09694033b829e80597d01cea695a784c4d66ba85"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQwMjU5NA==", "bodyText": "@swaroopak Switched to using an existing helper function to get the millisecond version of the max lookback config.", "url": "https://github.com/apache/phoenix/pull/857#discussion_r473402594", "createdAt": "2020-08-19T22:48:15Z", "author": {"login": "gjacoby126"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/compile/QueryCompiler.java", "diffHunk": "@@ -172,6 +178,28 @@ public QueryPlan compile() throws SQLException{\n         return plan;\n     }\n \n+    private void verifySCN() throws SQLException {\n+        if (!HbaseCompatCapabilities.isMaxLookbackTimeSupported()) {\n+            return;\n+        }\n+        PhoenixConnection conn = statement.getConnection();\n+        Long scn = conn.getSCN();\n+        if (scn == null) {\n+            return;\n+        }\n+        ColumnResolver resolver =\n+            FromCompiler.getResolverForQuery(select, conn);\n+        int maxLookBackAge = conn.getQueryServices().\n+            getConfiguration().getInt(CompatBaseScannerRegionObserver.PHOENIX_MAX_LOOKBACK_AGE_CONF_KEY,\n+            CompatBaseScannerRegionObserver.DEFAULT_PHOENIX_MAX_LOOKBACK_AGE);\n+        long now = EnvironmentEdgeManager.currentTimeMillis();\n+        if (maxLookBackAge > 0 && now - maxLookBackAge * 1000L > scn){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMxMDA4NQ=="}, "originalCommit": {"oid": "09694033b829e80597d01cea695a784c4d66ba85"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4586, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}