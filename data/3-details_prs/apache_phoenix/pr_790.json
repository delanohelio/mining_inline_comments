{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MTYyMDc1", "number": 790, "title": "PHOENIX-5922 - IndexUpgradeTool should always re-enable tables on fai\u2026", "bodyText": "\u2026lure", "createdAt": "2020-05-27T23:20:34Z", "url": "https://github.com/apache/phoenix/pull/790", "merged": true, "mergeCommit": {"oid": "eacfcd4ac54196c6d36f8eb0363ac7fe89e66805"}, "closed": true, "closedAt": "2020-05-28T17:33:34Z", "author": {"login": "gjacoby126"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcliGycAFqTQxOTY4MzEzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABclxYetABqjMzODM4OTc3NDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NjgzMTM1", "url": "https://github.com/apache/phoenix/pull/790#pullrequestreview-419683135", "createdAt": "2020-05-27T23:41:08Z", "commit": {"oid": "353b2640d6e4ba80c77bf76b15eb22931620310e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMzo0MTowOVrOGbg3bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMzo0MzoyOFrOGbg6ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMzIxNA==", "bodyText": "Nit: comment", "url": "https://github.com/apache/phoenix/pull/790#discussion_r431503214", "createdAt": "2020-05-27T23:41:09Z", "author": {"login": "abhishek-chouhan"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexUpgradeTool.java", "diffHunk": "@@ -463,14 +489,20 @@ private void handleFailure(ConnectionQueryServices queryServices,\n             upgrade = !upgrade;\n \n             tablesAndIndexes.remove(dataTableFullName); //removing from the map\n-            tableList.remove(dataTableFullName); //removing from the list\n+            failedTables.add(dataTableFullName); //removing from the list", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "353b2640d6e4ba80c77bf76b15eb22931620310e"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMzk3Mw==", "bodyText": "Should we just catch throwable here(and in the mutable case), so that we cover errors too? in all cases i guess we want the tables to be enabled back.", "url": "https://github.com/apache/phoenix/pull/790#discussion_r431503973", "createdAt": "2020-05-27T23:43:28Z", "author": {"login": "abhishek-chouhan"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexUpgradeTool.java", "diffHunk": "@@ -398,28 +414,34 @@ private int executeTool(Connection conn,\n         executeToolForMutableTables(conn, queryServices, conf, mutableList);\n         enableImmutableTables(queryServices, immutableList, startWaitTime);\n         rebuildIndexes(conn, conf, immutableList);\n-        return 0;\n+        if (hasFailure) {\n+            return -1;\n+        } else {\n+            return 0;\n+        }\n     }\n \n     private long executeToolForImmutableTables(ConnectionQueryServices queryServices,\n-            ArrayList<String> immutableList) {\n+            List<String> immutableList) {\n         if (immutableList.isEmpty()) {\n             return 0;\n         }\n         LOGGER.info(\"Started \" + operation + \" for immutable tables\");\n+        List<String> failedTables = new ArrayList<String>();\n         for (String dataTableFullName : immutableList) {\n             try (Admin admin = queryServices.getAdmin()) {\n                 HashSet<String> indexes = tablesAndIndexes.get(dataTableFullName);\n                 LOGGER.info(\"Executing \" + operation + \" of \" + dataTableFullName\n                         + \" (immutable)\");\n                 disableTable(admin, dataTableFullName, indexes);\n                 modifyTable(admin, dataTableFullName, indexes);\n-            } catch (IOException | SQLException e) {\n+            } catch (IOException | SQLException | RuntimeException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "353b2640d6e4ba80c77bf76b15eb22931620310e"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NzMzNDcy", "url": "https://github.com/apache/phoenix/pull/790#pullrequestreview-419733472", "createdAt": "2020-05-28T02:21:22Z", "commit": {"oid": "8162965dc6762e4344c02491360b18e2d15459f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5Nzc3NzM5", "url": "https://github.com/apache/phoenix/pull/790#pullrequestreview-419777739", "createdAt": "2020-05-28T04:59:44Z", "commit": {"oid": "8162965dc6762e4344c02491360b18e2d15459f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "110ef81f0a63ba7b33eb0a868f97d29d57afa5c3", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/110ef81f0a63ba7b33eb0a868f97d29d57afa5c3", "committedDate": "2020-05-28T17:33:08Z", "message": "PHOENIX-5922 - IndexUpgradeTool should always re-enable tables on failure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8162965dc6762e4344c02491360b18e2d15459f2", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/8162965dc6762e4344c02491360b18e2d15459f2", "committedDate": "2020-05-28T01:19:40Z", "message": "PHOENIX-5922 - IndexUpgradeTool should always re-enable tables on failure"}, "afterCommit": {"oid": "110ef81f0a63ba7b33eb0a868f97d29d57afa5c3", "author": {"user": {"login": "gjacoby126", "name": "Geoffrey Jacoby"}}, "url": "https://github.com/apache/phoenix/commit/110ef81f0a63ba7b33eb0a868f97d29d57afa5c3", "committedDate": "2020-05-28T17:33:08Z", "message": "PHOENIX-5922 - IndexUpgradeTool should always re-enable tables on failure"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2029, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}