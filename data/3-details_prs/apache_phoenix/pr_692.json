{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NjIzMjAz", "number": 692, "title": "PHOENIX-5689: TableNotFoundException in IndexUpgradeTool in case of v\u2026", "bodyText": "\u2026iew indexes", "createdAt": "2020-01-27T17:52:23Z", "url": "https://github.com/apache/phoenix/pull/692", "merged": true, "mergeCommit": {"oid": "9b347438ee57f1d77d54b47d39afe3f6795f6457"}, "closed": true, "closedAt": "2020-01-29T19:58:05Z", "author": {"login": "swaroopak"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-gelSAH2gAyMzY3NjIzMjAzOmVmYjQxN2Q0ZjU4ZWFhZmViNWJiMjU1ZDMzMDk4YTg0YmQxNjBlOWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_KdgLAH2gAyMzY3NjIzMjAzOmVlNzZlNGU4NjY4MWE4NGViNzNkYmJmMTBiNTBjYzc2ZWFjOGEwMjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "efb417d4f58eaafeb5bb255d33098a84bd160e9a", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/efb417d4f58eaafeb5bb255d33098a84bd160e9a", "committedDate": "2020-01-27T17:48:36Z", "message": "PHOENIX-5689: TableNotFoundException in IndexUpgradeTool in case of view indexes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NjI4MjIz", "url": "https://github.com/apache/phoenix/pull/692#pullrequestreview-349628223", "createdAt": "2020-01-28T19:07:15Z", "commit": {"oid": "efb417d4f58eaafeb5bb255d33098a84bd160e9a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxOTowNzoxNVrOFixAww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxOTowNzoxNVrOFixAww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk5ODkxNQ==", "bodyText": "Will this be adding null for multiTenant=false?", "url": "https://github.com/apache/phoenix/pull/692#discussion_r371998915", "createdAt": "2020-01-28T19:07:15Z", "author": {"login": "gokceni"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/IndexUpgradeToolIT.java", "diffHunk": "@@ -19,76 +19,121 @@\n \n import org.apache.phoenix.mapreduce.index.IndexUpgradeTool;\n import org.apache.phoenix.query.BaseTest;\n+import org.apache.phoenix.util.PhoenixRuntime;\n+import org.apache.phoenix.util.PropertiesUtil;\n import org.apache.phoenix.util.ReadOnlyProps;\n import org.apache.phoenix.util.SchemaUtil;\n import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import org.junit.runners.Parameterized.Parameters;\n+\n \n import java.sql.Connection;\n import java.sql.DriverManager;\n import java.sql.ResultSet;\n import java.sql.SQLException;\n import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.Properties;\n \n+import static org.apache.phoenix.util.TestUtil.TEST_PROPERTIES;\n+\n+@RunWith(Parameterized.class)\n public class IndexUpgradeToolIT extends BaseTest {\n \n     public static final String\n             VERIFY_COUNT_ASSERT_MESSAGE = \"view-index count in system table doesn't match\";\n+    private final boolean multiTenant;\n+    private String tenantId = null;\n+\n+    public IndexUpgradeToolIT(boolean multiTenant) {\n+        this.multiTenant = multiTenant;\n+    }\n+\n+    @Parameters(name=\"isMultiTenant = {0}\")\n+    public static synchronized Collection<Boolean[]> data() {\n+        return Arrays.asList(new Boolean[][] {\n+                { true },{ false }\n+        });\n+    }\n+\n+    @BeforeClass\n+    public static void setup() throws Exception {\n+        Map<String, String> props = Collections.emptyMap();\n+        setUpTestDriver(new ReadOnlyProps(props.entrySet().iterator()));\n+    }\n \n     @Test\n     public void verifyViewAndViewIndexes() throws Exception {\n         String tableName = generateUniqueName();\n         String schemaName = generateUniqueName();\n-        Map<String, String> props = Collections.emptyMap();\n-        setUpTestDriver(new ReadOnlyProps(props.entrySet().iterator()));\n-\n-        try (Connection conn = DriverManager.getConnection(getUrl(), new Properties())) {\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        if (multiTenant) {\n+            tenantId = generateUniqueName();\n+            props.setProperty(PhoenixRuntime.TENANT_ID_ATTRIB, tenantId);\n+        }\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n             prepareForTest(conn, schemaName, tableName);\n-            IndexUpgradeTool iut = new IndexUpgradeTool();\n-            String viewQuery = iut.getViewSql(tableName, schemaName);\n+            String viewQuery = IndexUpgradeTool.getViewSql(tableName, schemaName);\n             ResultSet rs = conn.createStatement().executeQuery(viewQuery);\n             int countViews = 0;\n             List<String> views = new ArrayList<>();\n-            List<Integer> indexCount = new ArrayList<>();\n+            List<String> tenants = new ArrayList<>();\n             while (rs.next()) {\n                 views.add(rs.getString(1));\n+                if(multiTenant) {\n+                    Assert.assertNotNull(rs.getString(2));\n+                }\n+                tenants.add(rs.getString(2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efb417d4f58eaafeb5bb255d33098a84bd160e9a"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzEyNDU4", "url": "https://github.com/apache/phoenix/pull/692#pullrequestreview-349712458", "createdAt": "2020-01-28T21:22:16Z", "commit": {"oid": "efb417d4f58eaafeb5bb255d33098a84bd160e9a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMToyMjoxN1rOFi1B8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjowNDozMlrOFi2Prg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA2NDc1NQ==", "bodyText": "Comment would be useful to remind that the first column is the view and the second column is the tenant id", "url": "https://github.com/apache/phoenix/pull/692#discussion_r372064755", "createdAt": "2020-01-28T21:22:17Z", "author": {"login": "gjacoby126"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/IndexUpgradeToolIT.java", "diffHunk": "@@ -19,76 +19,121 @@\n \n import org.apache.phoenix.mapreduce.index.IndexUpgradeTool;\n import org.apache.phoenix.query.BaseTest;\n+import org.apache.phoenix.util.PhoenixRuntime;\n+import org.apache.phoenix.util.PropertiesUtil;\n import org.apache.phoenix.util.ReadOnlyProps;\n import org.apache.phoenix.util.SchemaUtil;\n import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import org.junit.runners.Parameterized.Parameters;\n+\n \n import java.sql.Connection;\n import java.sql.DriverManager;\n import java.sql.ResultSet;\n import java.sql.SQLException;\n import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.Properties;\n \n+import static org.apache.phoenix.util.TestUtil.TEST_PROPERTIES;\n+\n+@RunWith(Parameterized.class)\n public class IndexUpgradeToolIT extends BaseTest {\n \n     public static final String\n             VERIFY_COUNT_ASSERT_MESSAGE = \"view-index count in system table doesn't match\";\n+    private final boolean multiTenant;\n+    private String tenantId = null;\n+\n+    public IndexUpgradeToolIT(boolean multiTenant) {\n+        this.multiTenant = multiTenant;\n+    }\n+\n+    @Parameters(name=\"isMultiTenant = {0}\")\n+    public static synchronized Collection<Boolean[]> data() {\n+        return Arrays.asList(new Boolean[][] {\n+                { true },{ false }\n+        });\n+    }\n+\n+    @BeforeClass\n+    public static void setup() throws Exception {\n+        Map<String, String> props = Collections.emptyMap();\n+        setUpTestDriver(new ReadOnlyProps(props.entrySet().iterator()));\n+    }\n \n     @Test\n     public void verifyViewAndViewIndexes() throws Exception {\n         String tableName = generateUniqueName();\n         String schemaName = generateUniqueName();\n-        Map<String, String> props = Collections.emptyMap();\n-        setUpTestDriver(new ReadOnlyProps(props.entrySet().iterator()));\n-\n-        try (Connection conn = DriverManager.getConnection(getUrl(), new Properties())) {\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        if (multiTenant) {\n+            tenantId = generateUniqueName();\n+            props.setProperty(PhoenixRuntime.TENANT_ID_ATTRIB, tenantId);\n+        }\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n             prepareForTest(conn, schemaName, tableName);\n-            IndexUpgradeTool iut = new IndexUpgradeTool();\n-            String viewQuery = iut.getViewSql(tableName, schemaName);\n+            String viewQuery = IndexUpgradeTool.getViewSql(tableName, schemaName);\n             ResultSet rs = conn.createStatement().executeQuery(viewQuery);\n             int countViews = 0;\n             List<String> views = new ArrayList<>();\n-            List<Integer> indexCount = new ArrayList<>();\n+            List<String> tenants = new ArrayList<>();\n             while (rs.next()) {\n                 views.add(rs.getString(1));\n+                if(multiTenant) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efb417d4f58eaafeb5bb255d33098a84bd160e9a"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA2NjE3Nw==", "bodyText": "A comment somewhere around here would be good to remind us that there are 2 indexes on the first tenant's view, 1, on the second, and so on, to explain the assert, which is otherwise counterintuitive.\nAlternately, you could have a map of tenant id -> expected view index count that you build in the prepareForTest method and reference in the assert here, but that might be overkill. Up to you.", "url": "https://github.com/apache/phoenix/pull/692#discussion_r372066177", "createdAt": "2020-01-28T21:25:28Z", "author": {"login": "gjacoby126"}, "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/IndexUpgradeToolIT.java", "diffHunk": "@@ -19,76 +19,121 @@\n \n import org.apache.phoenix.mapreduce.index.IndexUpgradeTool;\n import org.apache.phoenix.query.BaseTest;\n+import org.apache.phoenix.util.PhoenixRuntime;\n+import org.apache.phoenix.util.PropertiesUtil;\n import org.apache.phoenix.util.ReadOnlyProps;\n import org.apache.phoenix.util.SchemaUtil;\n import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import org.junit.runners.Parameterized.Parameters;\n+\n \n import java.sql.Connection;\n import java.sql.DriverManager;\n import java.sql.ResultSet;\n import java.sql.SQLException;\n import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.Properties;\n \n+import static org.apache.phoenix.util.TestUtil.TEST_PROPERTIES;\n+\n+@RunWith(Parameterized.class)\n public class IndexUpgradeToolIT extends BaseTest {\n \n     public static final String\n             VERIFY_COUNT_ASSERT_MESSAGE = \"view-index count in system table doesn't match\";\n+    private final boolean multiTenant;\n+    private String tenantId = null;\n+\n+    public IndexUpgradeToolIT(boolean multiTenant) {\n+        this.multiTenant = multiTenant;\n+    }\n+\n+    @Parameters(name=\"isMultiTenant = {0}\")\n+    public static synchronized Collection<Boolean[]> data() {\n+        return Arrays.asList(new Boolean[][] {\n+                { true },{ false }\n+        });\n+    }\n+\n+    @BeforeClass\n+    public static void setup() throws Exception {\n+        Map<String, String> props = Collections.emptyMap();\n+        setUpTestDriver(new ReadOnlyProps(props.entrySet().iterator()));\n+    }\n \n     @Test\n     public void verifyViewAndViewIndexes() throws Exception {\n         String tableName = generateUniqueName();\n         String schemaName = generateUniqueName();\n-        Map<String, String> props = Collections.emptyMap();\n-        setUpTestDriver(new ReadOnlyProps(props.entrySet().iterator()));\n-\n-        try (Connection conn = DriverManager.getConnection(getUrl(), new Properties())) {\n+        Properties props = PropertiesUtil.deepCopy(TEST_PROPERTIES);\n+        if (multiTenant) {\n+            tenantId = generateUniqueName();\n+            props.setProperty(PhoenixRuntime.TENANT_ID_ATTRIB, tenantId);\n+        }\n+        try (Connection conn = DriverManager.getConnection(getUrl(), props)) {\n             prepareForTest(conn, schemaName, tableName);\n-            IndexUpgradeTool iut = new IndexUpgradeTool();\n-            String viewQuery = iut.getViewSql(tableName, schemaName);\n+            String viewQuery = IndexUpgradeTool.getViewSql(tableName, schemaName);\n             ResultSet rs = conn.createStatement().executeQuery(viewQuery);\n             int countViews = 0;\n             List<String> views = new ArrayList<>();\n-            List<Integer> indexCount = new ArrayList<>();\n+            List<String> tenants = new ArrayList<>();\n             while (rs.next()) {\n                 views.add(rs.getString(1));\n+                if(multiTenant) {\n+                    Assert.assertNotNull(rs.getString(2));\n+                }\n+                tenants.add(rs.getString(2));\n                 countViews++;\n             }\n             Assert.assertEquals(\"view count in system table doesn't match\", 2, countViews);\n+\n             for (int i = 0; i < views.size(); i++) {\n                 String viewName = SchemaUtil.getTableNameFromFullName(views.get(i));\n-                String viewIndexQuery = iut.getViewIndexesSql(viewName, schemaName, null);\n+                String viewIndexQuery = IndexUpgradeTool.getViewIndexesSql(viewName, schemaName,\n+                        tenants.get(i));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efb417d4f58eaafeb5bb255d33098a84bd160e9a"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA4NDY1NA==", "bodyText": "this is now taken care of within the index tool?", "url": "https://github.com/apache/phoenix/pull/692#discussion_r372084654", "createdAt": "2020-01-28T22:04:32Z", "author": {"login": "gjacoby126"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexUpgradeTool.java", "diffHunk": "@@ -652,51 +652,15 @@ private int startIndexRebuilds(Connection conn,\n                     (GLOBAL_INDEX_ID.equals(tenantId)?\"\":\"_\"+tenantId) +\"_\"\n                     + UUID.randomUUID().toString();\n             String[] args = getIndexToolArgValues(schema, baseTable, indexName, outFile, tenantId);\n-            Connection newConnection = conn;\n-            Connection tenantConnection = null;\n             try {\n                 LOGGER.info(\"Rebuilding index: \" + StringUtils.join( args,\",\"));\n                 if (!dryRun) {\n-                    // If the index is in DISABLED state, indexTool will fail.\n-                    // First to ALTER REBUILD ASYNC.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efb417d4f58eaafeb5bb255d33098a84bd160e9a"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c77e9a728c3c70ed000faad15781688331faeba2", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/c77e9a728c3c70ed000faad15781688331faeba2", "committedDate": "2020-01-29T01:37:35Z", "message": "Fixing review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODYxMDE1", "url": "https://github.com/apache/phoenix/pull/692#pullrequestreview-349861015", "createdAt": "2020-01-29T04:55:20Z", "commit": {"oid": "c77e9a728c3c70ed000faad15781688331faeba2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee76e4e86681a84eb73dbbf10b50cc76eac8a024", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/ee76e4e86681a84eb73dbbf10b50cc76eac8a024", "committedDate": "2020-01-29T18:43:26Z", "message": "Added defensive checks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2094, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}