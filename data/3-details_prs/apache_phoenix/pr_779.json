{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MjY1ODMy", "number": 779, "title": "PHOENIX-5896: Implement incremental rebuild along the failed regions \u2026", "bodyText": "\u2026in IndexTool\nIT and unit tests in progress. Sending out for early feedback.", "createdAt": "2020-05-14T21:54:06Z", "url": "https://github.com/apache/phoenix/pull/779", "merged": true, "mergeCommit": {"oid": "5f9364db7e4925229704706e148e62f4cf4ec4c2"}, "closed": true, "closedAt": "2020-05-19T01:59:34Z", "author": {"login": "swaroopak"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchVBQtAFqTQxMjIyMjk2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABciqnq3gBqjMzNDk3NDQ2MzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMjIyOTYw", "url": "https://github.com/apache/phoenix/pull/779#pullrequestreview-412222960", "createdAt": "2020-05-14T22:14:57Z", "commit": {"oid": "dde52d9d738d4040e5a30f67fbe6d6a16994340a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMjoxNDo1OFrOGVwFfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMjoxNDo1OFrOGVwFfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ2MTExNw==", "bodyText": "Please rename as shouldVerify", "url": "https://github.com/apache/phoenix/pull/779#discussion_r425461117", "createdAt": "2020-05-14T22:14:58Z", "author": {"login": "gokceni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java", "diffHunk": "@@ -159,6 +161,16 @@ public IndexRebuildRegionScanner(final RegionScanner innerScanner, final Region\n         }\n     }\n \n+    private boolean shouldRebuildOrVerify() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dde52d9d738d4040e5a30f67fbe6d6a16994340a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMjMwNzA4", "url": "https://github.com/apache/phoenix/pull/779#pullrequestreview-412230708", "createdAt": "2020-05-14T22:32:32Z", "commit": {"oid": "dde52d9d738d4040e5a30f67fbe6d6a16994340a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMjozMjozM1rOGVweQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMjozMjozM1rOGVweQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ2NzQ1Nw==", "bodyText": "Have we decided that we would do this check always? Should we do this only when incremental build is specified? At least we should not do this check for read-repair since it will unnecessarily impact the read performance.", "url": "https://github.com/apache/phoenix/pull/779#discussion_r425467457", "createdAt": "2020-05-14T22:32:33Z", "author": {"login": "kadirozde"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java", "diffHunk": "@@ -1191,6 +1203,9 @@ public boolean next(List<Cell> results) throws IOException {\n         }\n         Cell lastCell = null;\n         int rowCount = 0;\n+        if(!shouldRebuildOrVerify()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dde52d9d738d4040e5a30f67fbe6d6a16994340a"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMjM2NTg1", "url": "https://github.com/apache/phoenix/pull/779#pullrequestreview-412236585", "createdAt": "2020-05-14T22:47:23Z", "commit": {"oid": "dde52d9d738d4040e5a30f67fbe6d6a16994340a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMjo0NzoyM1rOGVww8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMjo0NzoyM1rOGVww8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ3MjI0MA==", "bodyText": "rather than importing the generateResultTableRowKey here, might be cleaner to have a ResultRepository \"exists\" overload that takes Scan, indexMaintainer, and region name. That keeps the internal details of the table from \"leaking\" back into the region scanner.", "url": "https://github.com/apache/phoenix/pull/779#discussion_r425472240", "createdAt": "2020-05-14T22:47:23Z", "author": {"login": "gjacoby126"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/coprocessor/IndexRebuildRegionScanner.java", "diffHunk": "@@ -159,6 +161,16 @@ public IndexRebuildRegionScanner(final RegionScanner innerScanner, final Region\n         }\n     }\n \n+    private boolean shouldRebuildOrVerify() throws IOException {\n+        if(verifyType == IndexTool.IndexVerifyType.ONLY) {\n+            return true;\n+        }\n+        byte [] rowKey = generateResultTableRowKey(scan.getTimeRange().getMax(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dde52d9d738d4040e5a30f67fbe6d6a16994340a"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72aa5f09788d0abfb551c43ed7fa0bacca5ccb56", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/72aa5f09788d0abfb551c43ed7fa0bacca5ccb56", "committedDate": "2020-05-15T01:09:58Z", "message": "Fixing review comments (2/2)"}, "afterCommit": {"oid": "daa864e91ddd2addce18d710439b8242a95ecd19", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/daa864e91ddd2addce18d710439b8242a95ecd19", "committedDate": "2020-05-15T01:10:52Z", "message": "Fixing review comments (2/2)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMzYyOTI5", "url": "https://github.com/apache/phoenix/pull/779#pullrequestreview-412362929", "createdAt": "2020-05-15T05:48:23Z", "commit": {"oid": "daa864e91ddd2addce18d710439b8242a95ecd19"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNTo0ODoyM1rOGV3S6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNTo0ODoyM1rOGV3S6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU3OTI0Mw==", "bodyText": "This test class is written to test a tiny method which does a simple check. Given how this test class is constructed, I do not see any value of these tests and the entire class. I am not sure if you notice that these tests verifies that the following block of code is correct\nif(a != null || b == IndexTool.IndexVerifyType.ONLY) {\nreturn true;\n}\nreturn !c;\nwhere a, b and c are supplied by the tests.\nI suggest adding a test to an existing integration test to test this incremental verification feature end to end. The jira does not explain how this feature is activated. It seems one needs to provide the end time parameter. If so, the same end time parameter needs to be used for the base run and the incremental runs.  How do we differentiate the result table entries of one run from those for another run when these runs use the same end time? Do we need to differentiate it? How about the start time? What happens if the end times are the same but the start times are different for these runs. All these questions would have been considered if an integration test were written. Have you considered them?", "url": "https://github.com/apache/phoenix/pull/779#discussion_r425579243", "createdAt": "2020-05-15T05:48:23Z", "author": {"login": "kadirozde"}, "path": "phoenix-core/src/test/java/org/apache/phoenix/index/ShouldVerifyTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.phoenix.index;\n+\n+import org.apache.hadoop.hbase.client.Scan;\n+import org.apache.hadoop.hbase.regionserver.Region;\n+import org.apache.hadoop.hbase.util.Bytes;\n+import org.apache.phoenix.coprocessor.IndexRebuildRegionScanner;\n+import org.apache.phoenix.mapreduce.index.IndexTool;\n+import org.apache.phoenix.mapreduce.index.IndexVerificationResultRepository;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Matchers;\n+import org.mockito.Mock;\n+import org.mockito.MockitoAnnotations;\n+\n+import java.io.IOException;\n+\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.when;\n+\n+public class ShouldVerifyTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "daa864e91ddd2addce18d710439b8242a95ecd19"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "daa864e91ddd2addce18d710439b8242a95ecd19", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/daa864e91ddd2addce18d710439b8242a95ecd19", "committedDate": "2020-05-15T01:10:52Z", "message": "Fixing review comments (2/2)"}, "afterCommit": {"oid": "ce23255dd3f47499e32e737516966f0c82921e21", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/ce23255dd3f47499e32e737516966f0c82921e21", "committedDate": "2020-05-16T01:15:12Z", "message": "PHOENIX-5896: Implement incremental rebuild along the failed regions in IndexTool"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce23255dd3f47499e32e737516966f0c82921e21", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/ce23255dd3f47499e32e737516966f0c82921e21", "committedDate": "2020-05-16T01:15:12Z", "message": "PHOENIX-5896: Implement incremental rebuild along the failed regions in IndexTool"}, "afterCommit": {"oid": "5f3ddf80708347e9bb5aba227f215088cde6d51d", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/5f3ddf80708347e9bb5aba227f215088cde6d51d", "committedDate": "2020-05-16T01:16:40Z", "message": "PHOENIX-5896: Implement incremental rebuild along the failed regions in IndexTool"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f3ddf80708347e9bb5aba227f215088cde6d51d", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/5f3ddf80708347e9bb5aba227f215088cde6d51d", "committedDate": "2020-05-16T01:16:40Z", "message": "PHOENIX-5896: Implement incremental rebuild along the failed regions in IndexTool"}, "afterCommit": {"oid": "85612b647d36050b78cd6f6dbc0b6eb6b9c196b8", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/85612b647d36050b78cd6f6dbc0b6eb6b9c196b8", "committedDate": "2020-05-16T01:21:09Z", "message": "PHOENIX-5896: Implement incremental rebuild along the failed regions in IndexTool"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODEyMjY2", "url": "https://github.com/apache/phoenix/pull/779#pullrequestreview-413812266", "createdAt": "2020-05-18T17:49:54Z", "commit": {"oid": "e98fd0d12dde23ddbd0e517e8bfe38e6b3b1dd9c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNzo0OTo1NVrOGXBmIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNzo0OTo1NVrOGXBmIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5NjU3OA==", "bodyText": "Nit: Please change this to full \"incremental-verify\"", "url": "https://github.com/apache/phoenix/pull/779#discussion_r426796578", "createdAt": "2020-05-18T17:49:55Z", "author": {"login": "priyankporwal"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java", "diffHunk": "@@ -235,15 +235,22 @@ public static IndexVerifyType fromValue(byte[] value) {\n     private static final Option END_TIME_OPTION = new Option(\"et\", \"endtime\",\n             true, \"End time for indextool rebuild or verify\");\n \n+    private static final Option INCREMENTAL_VERIFY_OPTION = new Option(\"iv\", \"incre-verify\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98fd0d12dde23ddbd0e517e8bfe38e6b3b1dd9c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODEyNzkw", "url": "https://github.com/apache/phoenix/pull/779#pullrequestreview-413812790", "createdAt": "2020-05-18T17:50:41Z", "commit": {"oid": "e98fd0d12dde23ddbd0e517e8bfe38e6b3b1dd9c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNzo1MDo0MVrOGXBn0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNzo1MDo0MVrOGXBn0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5NzAwOA==", "bodyText": "For consistency: These should both use \"start-time\" / \"end-time\" .. just like all other composite-word options.", "url": "https://github.com/apache/phoenix/pull/779#discussion_r426797008", "createdAt": "2020-05-18T17:50:41Z", "author": {"login": "priyankporwal"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/mapreduce/index/IndexTool.java", "diffHunk": "@@ -235,15 +235,22 @@ public static IndexVerifyType fromValue(byte[] value) {\n     private static final Option END_TIME_OPTION = new Option(\"et\", \"endtime\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98fd0d12dde23ddbd0e517e8bfe38e6b3b1dd9c"}, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e98fd0d12dde23ddbd0e517e8bfe38e6b3b1dd9c", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/e98fd0d12dde23ddbd0e517e8bfe38e6b3b1dd9c", "committedDate": "2020-05-18T16:43:40Z", "message": "Additional scenario to test in the IT"}, "afterCommit": {"oid": "44975fd233d3dbd4d6bcbfc1efabe0c0359211f5", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/44975fd233d3dbd4d6bcbfc1efabe0c0359211f5", "committedDate": "2020-05-18T19:25:55Z", "message": "Added isValidLastVerifyTime method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44975fd233d3dbd4d6bcbfc1efabe0c0359211f5", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/44975fd233d3dbd4d6bcbfc1efabe0c0359211f5", "committedDate": "2020-05-18T19:25:55Z", "message": "Added isValidLastVerifyTime method"}, "afterCommit": {"oid": "26d9ad6593a0c996cf5efe13a903a3de90f8846e", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/26d9ad6593a0c996cf5efe13a903a3de90f8846e", "committedDate": "2020-05-18T22:05:31Z", "message": "effeciently validating lastVerifyTime and fixed nits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26d9ad6593a0c996cf5efe13a903a3de90f8846e", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/26d9ad6593a0c996cf5efe13a903a3de90f8846e", "committedDate": "2020-05-18T22:05:31Z", "message": "effeciently validating lastVerifyTime and fixed nits"}, "afterCommit": {"oid": "5fe3e99678ad69cc53c33033dc18298175849f0d", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/5fe3e99678ad69cc53c33033dc18298175849f0d", "committedDate": "2020-05-18T22:08:28Z", "message": "effeciently validating lastVerifyTime and fixed nits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5fe3e99678ad69cc53c33033dc18298175849f0d", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/5fe3e99678ad69cc53c33033dc18298175849f0d", "committedDate": "2020-05-18T22:08:28Z", "message": "effeciently validating lastVerifyTime and fixed nits"}, "afterCommit": {"oid": "d49a489ab8163234a73c8b5a2e93fe536cc69e9b", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/d49a489ab8163234a73c8b5a2e93fe536cc69e9b", "committedDate": "2020-05-18T22:43:04Z", "message": "PHOENIX-5896: Implement incremental rebuild along the failed regions in IndexTool"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MDI4MDQ5", "url": "https://github.com/apache/phoenix/pull/779#pullrequestreview-414028049", "createdAt": "2020-05-19T00:47:08Z", "commit": {"oid": "d49a489ab8163234a73c8b5a2e93fe536cc69e9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50c21ac4be8f7c002d3fcd46cd294b98c23c965b", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/50c21ac4be8f7c002d3fcd46cd294b98c23c965b", "committedDate": "2020-05-19T01:27:48Z", "message": "PHOENIX-5896: Implement incremental rebuild along the failed regions in IndexTool"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d49a489ab8163234a73c8b5a2e93fe536cc69e9b", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/d49a489ab8163234a73c8b5a2e93fe536cc69e9b", "committedDate": "2020-05-18T22:43:04Z", "message": "PHOENIX-5896: Implement incremental rebuild along the failed regions in IndexTool"}, "afterCommit": {"oid": "50c21ac4be8f7c002d3fcd46cd294b98c23c965b", "author": {"user": null}, "url": "https://github.com/apache/phoenix/commit/50c21ac4be8f7c002d3fcd46cd294b98c23c965b", "committedDate": "2020-05-19T01:27:48Z", "message": "PHOENIX-5896: Implement incremental rebuild along the failed regions in IndexTool"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2019, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}