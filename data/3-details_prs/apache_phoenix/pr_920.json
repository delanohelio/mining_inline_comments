{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMzEyODc4", "number": 920, "title": "PHOENIX-6129 : Optimize tableExists() call while retrieving correct MUTEX table", "bodyText": "", "createdAt": "2020-10-14T11:43:05Z", "url": "https://github.com/apache/phoenix/pull/920", "merged": true, "mergeCommit": {"oid": "b9fb461a353633fb38c51c464726e34c4d3989d7"}, "closed": true, "closedAt": "2020-10-26T18:53:10Z", "author": {"login": "virajjasani"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSbpewgH2gAyNTAzMzEyODc4OjVlM2I1ZDk3MjBhMzk1MTliMTcxMDY0MmVhMmRkMTliMmFkODZiNzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWX19-AFqTUxNzAxNjQ5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5e3b5d9720a39519b1710642ea2dd19b2ad86b75", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/5e3b5d9720a39519b1710642ea2dd19b2ad86b75", "committedDate": "2020-10-14T11:40:37Z", "message": "PHOENIX-6129 : Avoid redundant Admin API call in the absence of SYSTEM.MUTEX table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aafabf08960b698b38cb00088650cfeabeab9d3", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/9aafabf08960b698b38cb00088650cfeabeab9d3", "committedDate": "2020-10-14T14:31:51Z", "message": "removing redundant call to getSysMutexPhysicalTableNameBytes() from acquireUpgradeMutex()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9e180164090b06294e5d2cc21ce1454f16366a8", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/d9e180164090b06294e5d2cc21ce1454f16366a8", "committedDate": "2020-10-14T14:22:11Z", "message": "removing redundant call to getSysMutexPhysicalTableNameBytes() from acquireUpgradeMutex()"}, "afterCommit": {"oid": "9aafabf08960b698b38cb00088650cfeabeab9d3", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/9aafabf08960b698b38cb00088650cfeabeab9d3", "committedDate": "2020-10-14T14:31:51Z", "message": "removing redundant call to getSysMutexPhysicalTableNameBytes() from acquireUpgradeMutex()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30e1a9eca2f528fb0380b98d1cdfa40b2fe4e6e8", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/30e1a9eca2f528fb0380b98d1cdfa40b2fe4e6e8", "committedDate": "2020-10-14T14:39:02Z", "message": "Revert \"removing redundant call to getSysMutexPhysicalTableNameBytes() from acquireUpgradeMutex()\"\n\nThis reverts commit 9aafabf08960b698b38cb00088650cfeabeab9d3."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NDQzNDU5", "url": "https://github.com/apache/phoenix/pull/920#pullrequestreview-508443459", "createdAt": "2020-10-14T15:01:33Z", "commit": {"oid": "5e3b5d9720a39519b1710642ea2dd19b2ad86b75"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNTowMTozM1rOHhXjOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNTowNDoyNFrOHhXr5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1MDkwNw==", "bodyText": "byte[] sysMutexPhysicalTableNameBytes = getSysMutexPhysicalTableNameBytes();\nIf I understand correctly what @ChinmaySKulkarni described in the ticket, this call will still result to an admin.tableExists call to check the existance of SYSTEM.MUTEX/SYSTEM:MUTEX and you didn't changed that.", "url": "https://github.com/apache/phoenix/pull/920#discussion_r504750907", "createdAt": "2020-10-14T15:01:33Z", "author": {"login": "richardantal"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4294,11 +4295,9 @@ public boolean acquireUpgradeMutex(long currentServerSideTableTimestamp)\n     public boolean writeMutexCell(String tenantId, String schemaName, String tableName,\n             String columnName, String familyName) throws SQLException {\n         try {\n-            byte[] rowKey =\n-                    columnName != null\n-                            ? SchemaUtil.getColumnKey(tenantId, schemaName, tableName, columnName,\n-                                familyName)\n-                            : SchemaUtil.getTableKey(tenantId, schemaName, tableName);\n+            byte[] rowKey = columnName != null ?\n+                SchemaUtil.getColumnKey(tenantId, schemaName, tableName, columnName, familyName) :\n+                SchemaUtil.getTableKey(tenantId, schemaName, tableName);\n             // at this point the system mutex table should have been created or\n             // an exception thrown\n             byte[] sysMutexPhysicalTableNameBytes = getSysMutexPhysicalTableNameBytes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e3b5d9720a39519b1710642ea2dd19b2ad86b75"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1MzEyNA==", "bodyText": "try (Table sysMutexTable = getTable(sysMutexPhysicalTableNameBytes)) {\nInstead We could try the Table sysMutexTable =getTable() call with one of them and catch HBase TableNotFoundException, in that case try with the other one.", "url": "https://github.com/apache/phoenix/pull/920#discussion_r504753124", "createdAt": "2020-10-14T15:04:24Z", "author": {"login": "richardantal"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4294,11 +4295,9 @@ public boolean acquireUpgradeMutex(long currentServerSideTableTimestamp)\n     public boolean writeMutexCell(String tenantId, String schemaName, String tableName,\n             String columnName, String familyName) throws SQLException {\n         try {\n-            byte[] rowKey =\n-                    columnName != null\n-                            ? SchemaUtil.getColumnKey(tenantId, schemaName, tableName, columnName,\n-                                familyName)\n-                            : SchemaUtil.getTableKey(tenantId, schemaName, tableName);\n+            byte[] rowKey = columnName != null ?\n+                SchemaUtil.getColumnKey(tenantId, schemaName, tableName, columnName, familyName) :\n+                SchemaUtil.getTableKey(tenantId, schemaName, tableName);\n             // at this point the system mutex table should have been created or\n             // an exception thrown\n             byte[] sysMutexPhysicalTableNameBytes = getSysMutexPhysicalTableNameBytes();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1MDkwNw=="}, "originalCommit": {"oid": "5e3b5d9720a39519b1710642ea2dd19b2ad86b75"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0abcd6fa537ea708014cf8b904f62c4d65fdbcb", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/c0abcd6fa537ea708014cf8b904f62c4d65fdbcb", "committedDate": "2020-10-15T13:49:53Z", "message": "checkstyle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da486863e993d0d4fc9b96519cb359b2a0c3d49c", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/da486863e993d0d4fc9b96519cb359b2a0c3d49c", "committedDate": "2020-10-16T13:16:43Z", "message": "incorporating review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdc830a0ea890056f0d6b3a15e1fc6743f08cdaa", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/fdc830a0ea890056f0d6b3a15e1fc6743f08cdaa", "committedDate": "2020-10-16T06:08:08Z", "message": "incorporating review"}, "afterCommit": {"oid": "da486863e993d0d4fc9b96519cb359b2a0c3d49c", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/da486863e993d0d4fc9b96519cb359b2a0c3d49c", "committedDate": "2020-10-16T13:16:43Z", "message": "incorporating review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f376592bd41cc38122f4d823b74e2da104f36d22", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/f376592bd41cc38122f4d823b74e2da104f36d22", "committedDate": "2020-10-16T13:17:38Z", "message": "Merge branch 'master' of github.com:apache/phoenix into PHOENIX-6129-master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzOTk1NjAw", "url": "https://github.com/apache/phoenix/pull/920#pullrequestreview-513995600", "createdAt": "2020-10-21T17:22:54Z", "commit": {"oid": "f376592bd41cc38122f4d823b74e2da104f36d22"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzoyMjo1NFrOHl3mOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzozMjo1NVrOHl4UIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ3MDI2NA==", "bodyText": "nit: table variable is unnecessary here", "url": "https://github.com/apache/phoenix/pull/920#discussion_r509470264", "createdAt": "2020-10-21T17:22:54Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4364,17 +4353,17 @@ public void deleteMutexCell(String tenantId, String schemaName, String tableName\n         }\n     }\n \n-    private byte[] getSysMutexPhysicalTableNameBytes() throws IOException, SQLException {\n-        byte[] sysMutexPhysicalTableNameBytes = null;\n-        try(Admin admin = getAdmin()) {\n-            if(admin.tableExists(PhoenixDatabaseMetaData.SYSTEM_MUTEX_HBASE_TABLE_NAME)) {\n-                sysMutexPhysicalTableNameBytes = PhoenixDatabaseMetaData.SYSTEM_MUTEX_NAME_BYTES;\n-            } else if (admin.tableExists(TableName.valueOf(\n-                    SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName()))) {\n-                sysMutexPhysicalTableNameBytes = SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName();\n+    private Table getSysMutexTable() throws SQLException, IOException {\n+        String table = SYSTEM_MUTEX_NAME;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f376592bd41cc38122f4d823b74e2da104f36d22"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ3NDk2MQ==", "bodyText": "Please add a unit test for this new method.", "url": "https://github.com/apache/phoenix/pull/920#discussion_r509474961", "createdAt": "2020-10-21T17:27:32Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4364,17 +4353,17 @@ public void deleteMutexCell(String tenantId, String schemaName, String tableName\n         }\n     }\n \n-    private byte[] getSysMutexPhysicalTableNameBytes() throws IOException, SQLException {\n-        byte[] sysMutexPhysicalTableNameBytes = null;\n-        try(Admin admin = getAdmin()) {\n-            if(admin.tableExists(PhoenixDatabaseMetaData.SYSTEM_MUTEX_HBASE_TABLE_NAME)) {\n-                sysMutexPhysicalTableNameBytes = PhoenixDatabaseMetaData.SYSTEM_MUTEX_NAME_BYTES;\n-            } else if (admin.tableExists(TableName.valueOf(\n-                    SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName()))) {\n-                sysMutexPhysicalTableNameBytes = SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName();\n+    private Table getSysMutexTable() throws SQLException, IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f376592bd41cc38122f4d823b74e2da104f36d22"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ4MjAxOA==", "bodyText": "Just want to clarify one thing based on your comment about connection.getTable(). At this point, SYS.MUTEX doesn't exist so we try to retrieve SYS:MUTEX. As per your findings, connection.getTable(SYS:MUTEX) would return a Table object however it is not guaranteed that the table actually exists. This scenario is the same as returning null from the previous getSysMutexPhysicalTableNameBytes() method and then attempting to retrieve a null table.\nCan you confirm that this scenario (probably an impossible one albeit) is safe and we don't run into any weirdness?", "url": "https://github.com/apache/phoenix/pull/920#discussion_r509482018", "createdAt": "2020-10-21T17:32:55Z", "author": {"login": "ChinmaySKulkarni"}, "path": "phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java", "diffHunk": "@@ -4364,17 +4353,17 @@ public void deleteMutexCell(String tenantId, String schemaName, String tableName\n         }\n     }\n \n-    private byte[] getSysMutexPhysicalTableNameBytes() throws IOException, SQLException {\n-        byte[] sysMutexPhysicalTableNameBytes = null;\n-        try(Admin admin = getAdmin()) {\n-            if(admin.tableExists(PhoenixDatabaseMetaData.SYSTEM_MUTEX_HBASE_TABLE_NAME)) {\n-                sysMutexPhysicalTableNameBytes = PhoenixDatabaseMetaData.SYSTEM_MUTEX_NAME_BYTES;\n-            } else if (admin.tableExists(TableName.valueOf(\n-                    SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName()))) {\n-                sysMutexPhysicalTableNameBytes = SchemaUtil.getPhysicalTableName(SYSTEM_MUTEX_NAME, props).getName();\n+    private Table getSysMutexTable() throws SQLException, IOException {\n+        String table = SYSTEM_MUTEX_NAME;\n+        TableName tableName = TableName.valueOf(table);\n+        try (Admin admin = getAdmin()) {\n+            if (!admin.tableExists(tableName)) {\n+                table = table.replace(QueryConstants.NAME_SEPARATOR,\n+                    QueryConstants.NAMESPACE_SEPARATOR);\n+                tableName = TableName.valueOf(table);\n             }\n+            return connection.getTable(tableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f376592bd41cc38122f4d823b74e2da104f36d22"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecf175e7698ec76328a5b40893d36c9064a82c4d", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/ecf175e7698ec76328a5b40893d36c9064a82c4d", "committedDate": "2020-10-21T18:00:26Z", "message": "Merge branch 'master' of github.com:apache/phoenix into PHOENIX-6129-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d341b40d5336a1bc7c14b704590683e025f839df", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/phoenix/commit/d341b40d5336a1bc7c14b704590683e025f839df", "committedDate": "2020-10-21T19:33:21Z", "message": "addressing review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDE2NDk5", "url": "https://github.com/apache/phoenix/pull/920#pullrequestreview-517016499", "createdAt": "2020-10-26T17:30:20Z", "commit": {"oid": "d341b40d5336a1bc7c14b704590683e025f839df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1952, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}