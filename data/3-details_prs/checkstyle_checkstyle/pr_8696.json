{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MzIwNzAy", "number": 8696, "title": "Issue #8664: NeedBraces throws a NPE when parsing switch expression syntax", "bodyText": "Issue #8664: NeedBraces throws a NPE when parsing switch expression syntax\nDiff Regression projects: https://gist.githubusercontent.com/nmancus1/e3988f8092d919b5cbe70f5359c4d9e8/raw/a0f6f5860f8025c19868061dee6e0e40960b992f/projects-to-test-on.properties\nDiff Regression config: https://gist.githubusercontent.com/nmancus1/9856763c94e3283016546a6dcd709208/raw/7e2b5b9c4f472f935ea48d958dbdd926e215aa2a/NeedBraces.xml", "createdAt": "2020-08-15T14:03:31Z", "url": "https://github.com/checkstyle/checkstyle/pull/8696", "merged": true, "mergeCommit": {"oid": "ea5b4e6ce5f98c6fc4758d6d38f881c82468344f"}, "closed": true, "closedAt": "2020-08-16T16:49:08Z", "author": {"login": "nmancus1"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_LTEtABqjM2NTg2Mzk5OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_grNQAFqTQ2ODA3ODUzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9ed26dec8fc45afaad80d3b846d71e298d39331", "author": {"user": {"login": "nmancus1", "name": "Nick Mancuso"}}, "url": "https://github.com/checkstyle/checkstyle/commit/f9ed26dec8fc45afaad80d3b846d71e298d39331", "committedDate": "2020-08-15T14:00:54Z", "message": "Issue #8664: NeedBracesCheck throws a NPE when parsing switch expression syntax"}, "afterCommit": {"oid": "a5aec537228b464ae9c8753a5cd24fdaef8f097a", "author": {"user": {"login": "nmancus1", "name": "Nick Mancuso"}}, "url": "https://github.com/checkstyle/checkstyle/commit/a5aec537228b464ae9c8753a5cd24fdaef8f097a", "committedDate": "2020-08-15T15:52:49Z", "message": "Issue #8664: NeedBraces throws a NPE when parsing switch expression syntax"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDQ2NTg0", "url": "https://github.com/checkstyle/checkstyle/pull/8696#pullrequestreview-468046584", "createdAt": "2020-08-16T08:55:56Z", "commit": {"oid": "a5aec537228b464ae9c8753a5cd24fdaef8f097a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNlQwODo1NTo1NlrOHBQzug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNlQwOTowNTozMFrOHBQ3nQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA4NjAxMA==", "bodyText": "Extra space before .", "url": "https://github.com/checkstyle/checkstyle/pull/8696#discussion_r471086010", "createdAt": "2020-08-16T08:55:56Z", "author": {"login": "pbludov"}, "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/blocks/NeedBracesCheck.java", "diffHunk": "@@ -476,26 +492,115 @@ private static DetailAST getLastLambdaToken(DetailAST lambda) {\n     }\n \n     /**\n-     * Checks if switch member (case or default statement) is single-line statement, e.g.:\n+     * Checks if current lambda belongs to a switch rule, e.g.:\n      * <p>\n      * {@code\n-     * case 1: doSomeStuff(); break;\n-     * case 2: doSomeStuff(); break;\n+     * case 1 ->  monthString = \"January\";\n+     * }\n+     * </p>\n+     *\n+     * @param lambda {@link TokenTypes#LAMBDA}.\n+     * @return true if current lambda belongs to a switch rule.\n+     */\n+    private static boolean isSwitchRuleLambda(DetailAST lambda) {\n+        return lambda.getParent().getType() == TokenTypes.SWITCH_RULE;\n+    }\n+\n+    /**\n+     * Checks if current expression is a switch labeled expression . If so,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5aec537228b464ae9c8753a5cd24fdaef8f097a"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA4NjUwMg==", "bodyText": "This code duplicates method isSwitchRuleLambda. Should this method be used here?", "url": "https://github.com/checkstyle/checkstyle/pull/8696#discussion_r471086502", "createdAt": "2020-08-16T09:00:38Z", "author": {"login": "pbludov"}, "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/blocks/NeedBracesCheck.java", "diffHunk": "@@ -476,26 +492,115 @@ private static DetailAST getLastLambdaToken(DetailAST lambda) {\n     }\n \n     /**\n-     * Checks if switch member (case or default statement) is single-line statement, e.g.:\n+     * Checks if current lambda belongs to a switch rule, e.g.:\n      * <p>\n      * {@code\n-     * case 1: doSomeStuff(); break;\n-     * case 2: doSomeStuff(); break;\n+     * case 1 ->  monthString = \"January\";\n+     * }\n+     * </p>\n+     *\n+     * @param lambda {@link TokenTypes#LAMBDA}.\n+     * @return true if current lambda belongs to a switch rule.\n+     */\n+    private static boolean isSwitchRuleLambda(DetailAST lambda) {\n+        return lambda.getParent().getType() == TokenTypes.SWITCH_RULE;\n+    }\n+\n+    /**\n+     * Checks if current expression is a switch labeled expression . If so,\n+     * braces are not allowed e.g.:\n+     * <p>\n+     * {@code\n+     * case 1 -> 4;\n+     * }\n+     * </p>\n+     *\n+     * @param ast the ast to check\n+     * @return true if current expression is a switch labeled expression.\n+     */\n+    private static boolean isSwitchLabeledExpression(DetailAST ast) {\n+        final DetailAST parent = ast.getParent();\n+        return switchRuleHasSingleExpression(parent);\n+    }\n+\n+    /**\n+     * Checks if current switch labeled expression contains only a single expression.\n+     *\n+     * @param switchRule {@link TokenTypes#SWITCH_RULE}.\n+     * @return true if current switch rule has a single expression.\n+     */\n+    private static boolean switchRuleHasSingleExpression(DetailAST switchRule) {\n+        final DetailAST possibleExpression = switchRule.findFirstToken(TokenTypes.EXPR);\n+        return possibleExpression != null\n+                && possibleExpression.getFirstChild().getFirstChild() == null;\n+    }\n+\n+    /**\n+     * Checks if switch member (case or default statement) in a switch rule or\n+     * case group is on a single line.\n+     *\n+     * @param statement {@link TokenTypes#LITERAL_CASE case statement} or\n+     * {@link TokenTypes#LITERAL_DEFAULT default statement}.\n+     * @return true if current switch member is single-line statement.\n+     */\n+    private static boolean isSingleLineSwitchMember(DetailAST statement) {\n+        final boolean isInSwitchRule =\n+            statement.getParent().getType() == TokenTypes.SWITCH_RULE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5aec537228b464ae9c8753a5cd24fdaef8f097a"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA4NzAwNQ==", "bodyText": "getLastSibling == parent.getLastChild(), no reason for new method here.", "url": "https://github.com/checkstyle/checkstyle/pull/8696#discussion_r471087005", "createdAt": "2020-08-16T09:05:30Z", "author": {"login": "pbludov"}, "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/blocks/NeedBracesCheck.java", "diffHunk": "@@ -293,9 +298,19 @@ private boolean isEmptyLoopBodyAllowed(DetailAST ast) {\n      */\n     private static boolean hasUnbracedStatements(DetailAST ast) {\n         final DetailAST nextSibling = ast.getNextSibling();\n-        return nextSibling != null\n+        final DetailAST parent = ast.getParent();\n+        boolean result = false;\n+\n+        if (parent.getType() == TokenTypes.SWITCH_RULE) {\n+            final DetailAST lastSibling = getLastSibling(ast);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5aec537228b464ae9c8753a5cd24fdaef8f097a"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0a857deeefddb3bb897c07c3ca4fed134bdeea9", "author": {"user": {"login": "nmancus1", "name": "Nick Mancuso"}}, "url": "https://github.com/checkstyle/checkstyle/commit/d0a857deeefddb3bb897c07c3ca4fed134bdeea9", "committedDate": "2020-08-16T11:20:42Z", "message": "Issue #8664: NeedBraces throws a NPE when parsing switch expression syntax"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5aec537228b464ae9c8753a5cd24fdaef8f097a", "author": {"user": {"login": "nmancus1", "name": "Nick Mancuso"}}, "url": "https://github.com/checkstyle/checkstyle/commit/a5aec537228b464ae9c8753a5cd24fdaef8f097a", "committedDate": "2020-08-15T15:52:49Z", "message": "Issue #8664: NeedBraces throws a NPE when parsing switch expression syntax"}, "afterCommit": {"oid": "d0a857deeefddb3bb897c07c3ca4fed134bdeea9", "author": {"user": {"login": "nmancus1", "name": "Nick Mancuso"}}, "url": "https://github.com/checkstyle/checkstyle/commit/d0a857deeefddb3bb897c07c3ca4fed134bdeea9", "committedDate": "2020-08-16T11:20:42Z", "message": "Issue #8664: NeedBraces throws a NPE when parsing switch expression syntax"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDc0OTI3", "url": "https://github.com/checkstyle/checkstyle/pull/8696#pullrequestreview-468074927", "createdAt": "2020-08-16T15:52:40Z", "commit": {"oid": "d0a857deeefddb3bb897c07c3ca4fed134bdeea9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDc4NTMx", "url": "https://github.com/checkstyle/checkstyle/pull/8696#pullrequestreview-468078531", "createdAt": "2020-08-16T16:47:28Z", "commit": {"oid": "d0a857deeefddb3bb897c07c3ca4fed134bdeea9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 361, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}