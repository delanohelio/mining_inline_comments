{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwOTA5Nzk2", "number": 7905, "title": "Issue #7812: OneTopLevelClass: Improve data structure efficiency", "bodyText": "Fix #7812: OneTopLevelClass: Improve data structure efficiency\nEven though this is not really important, I feel that I should at least tie up the loose end from #7790 (comment). Right now using a SortedMap just to store a redundant line number is an awkward implementation, no matter how you look at it.\nRegression: https://wltan.github.io/checkstyle-reports/2020-03-26/onetoplevel-detailast-regression/diff/", "createdAt": "2020-03-19T10:08:39Z", "url": "https://github.com/checkstyle/checkstyle/pull/7905", "merged": true, "mergeCommit": {"oid": "32c6d986004ec58f883f1d0651fccb376f1ef33a"}, "closed": true, "closedAt": "2020-04-03T13:21:56Z", "author": {"login": "wltan"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQyzFHgBqjMxNTk2MTg1MTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUA0RqAFqTM4NzI0OTExMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97255f5386aa6c9a7a15562bcc9414e42a6356b3", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/97255f5386aa6c9a7a15562bcc9414e42a6356b3", "committedDate": "2020-03-19T09:58:07Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}, "afterCommit": {"oid": "e3b038efbfd11615dc58559debe685a57429d1cc", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/e3b038efbfd11615dc58559debe685a57429d1cc", "committedDate": "2020-03-24T13:19:23Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MDIwOTY4", "url": "https://github.com/checkstyle/checkstyle/pull/7905#pullrequestreview-379020968", "createdAt": "2020-03-22T16:14:47Z", "commit": {"oid": "97255f5386aa6c9a7a15562bcc9414e42a6356b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQxNjoxNDo0N1rOF5wt3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwMTo0MjoyMlrOF7JSQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjExMTMyNw==", "bodyText": "Annotation Def is missing as a type. This should be a separate issue as the original code is like this too.", "url": "https://github.com/checkstyle/checkstyle/pull/7905#discussion_r396111327", "createdAt": "2020-03-22T16:14:47Z", "author": {"login": "rnveach"}, "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheck.java", "diffHunk": "@@ -126,41 +113,49 @@\n     @Override\n     public void beginTree(DetailAST rootAST) {\n         publicTypeFound = false;\n-        lineNumberTypeMap.clear();\n \n         DetailAST currentNode = rootAST;\n         while (currentNode != null) {\n-            if (currentNode.getType() == TokenTypes.CLASS_DEF\n-                    || currentNode.getType() == TokenTypes.ENUM_DEF\n-                    || currentNode.getType() == TokenTypes.INTERFACE_DEF) {\n-                if (isPublic(currentNode)) {\n-                    publicTypeFound = true;\n-                }\n-                else {\n-                    final String typeName = currentNode\n-                            .findFirstToken(TokenTypes.IDENT).getText();\n-                    lineNumberTypeMap.put(currentNode, typeName);\n-                }\n+            if (isTypeDef(currentNode) && isPublic(currentNode)) {\n+                publicTypeFound = true;\n+                break;\n             }\n             currentNode = currentNode.getNextSibling();\n         }\n     }\n \n     @Override\n     public void finishTree(DetailAST rootAST) {\n-        if (!lineNumberTypeMap.isEmpty()) {\n-            if (!publicTypeFound) {\n-                // skip first top-level type.\n-                lineNumberTypeMap.remove(lineNumberTypeMap.firstKey());\n-            }\n-\n-            for (Map.Entry<DetailAST, String> entry\n-                    : lineNumberTypeMap.entrySet()) {\n-                log(entry.getKey(), MSG_KEY, entry.getValue());\n+        DetailAST currentNode = rootAST;\n+        boolean firstTypeSkipped = false;\n+        while (currentNode != null) {\n+            if (isTypeDef(currentNode) && !isPublic(currentNode)) {\n+                if (publicTypeFound || firstTypeSkipped) {\n+                    // log violation\n+                    final String typeName = currentNode\n+                            .findFirstToken(TokenTypes.IDENT).getText();\n+                    log(currentNode, MSG_KEY, typeName);\n+                }\n+                else {\n+                    // no public type found, skip the first type\n+                    firstTypeSkipped = true;\n+                }\n             }\n+            currentNode = currentNode.getNextSibling();\n         }\n     }\n \n+    /**\n+     * Checks if an AST node is a type definition.\n+     * @param node AST node to check.\n+     * @return true if the node is a type (class, enum, interface) definition.\n+     */\n+    public static boolean isTypeDef(DetailAST node) {\n+        return node.getType() == TokenTypes.CLASS_DEF\n+                || node.getType() == TokenTypes.ENUM_DEF\n+                || node.getType() == TokenTypes.INTERFACE_DEF;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97255f5386aa6c9a7a15562bcc9414e42a6356b3"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2MTU3NQ==", "bodyText": "@romani\n\nChecks that each top-level class, interface or enum resides in a source file of its own.\n\nIf we have 2 public classes in the same file, shouldn't we produce a violation on one of them since there is more than 1 top level class?\n$ cat TestClass.java\npublic class TestClass1 {\n    void method() {\n    }\n}\npublic class TestClass2 {\n    void method() {\n    }\n}\n\n$ cat TestConfig.xml\n<?xml version=\"1.0\"?>\n<!DOCTYPE module PUBLIC\n          \"-//Puppy Crawl//DTD Check Configuration 1.3//EN\"\n          \"https://checkstyle.org/dtds/configuration_1_3.dtd\">\n\n<module name=\"Checker\">\n    <property name=\"charset\" value=\"UTF-8\"/>\n\n    <module name=\"TreeWalker\">\n<module name=\"OneTopLevelClassCheck\" />\n    </module>\n</module>\n\n$ java -jar checkstyle-8.30-all.jar -c TestConfig.xml TestClass.java\nStarting audit...\nAudit done.\n\nShouldn't we expect a violation on line 5?", "url": "https://github.com/checkstyle/checkstyle/pull/7905#discussion_r397561575", "createdAt": "2020-03-25T01:38:46Z", "author": {"login": "rnveach"}, "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheck.java", "diffHunk": "@@ -126,41 +113,49 @@\n     @Override\n     public void beginTree(DetailAST rootAST) {\n         publicTypeFound = false;\n-        lineNumberTypeMap.clear();\n \n         DetailAST currentNode = rootAST;\n         while (currentNode != null) {\n-            if (currentNode.getType() == TokenTypes.CLASS_DEF\n-                    || currentNode.getType() == TokenTypes.ENUM_DEF\n-                    || currentNode.getType() == TokenTypes.INTERFACE_DEF) {\n-                if (isPublic(currentNode)) {\n-                    publicTypeFound = true;\n-                }\n-                else {\n-                    final String typeName = currentNode\n-                            .findFirstToken(TokenTypes.IDENT).getText();\n-                    lineNumberTypeMap.put(currentNode, typeName);\n-                }\n+            if (isTypeDef(currentNode) && isPublic(currentNode)) {\n+                publicTypeFound = true;\n+                break;\n             }\n             currentNode = currentNode.getNextSibling();\n         }\n     }\n \n     @Override\n     public void finishTree(DetailAST rootAST) {\n-        if (!lineNumberTypeMap.isEmpty()) {\n-            if (!publicTypeFound) {\n-                // skip first top-level type.\n-                lineNumberTypeMap.remove(lineNumberTypeMap.firstKey());\n-            }\n-\n-            for (Map.Entry<DetailAST, String> entry\n-                    : lineNumberTypeMap.entrySet()) {\n-                log(entry.getKey(), MSG_KEY, entry.getValue());\n+        DetailAST currentNode = rootAST;\n+        boolean firstTypeSkipped = false;\n+        while (currentNode != null) {\n+            if (isTypeDef(currentNode) && !isPublic(currentNode)) {\n+                if (publicTypeFound || firstTypeSkipped) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3b038efbfd11615dc58559debe685a57429d1cc"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2MjQzMg==", "bodyText": "Now the code is trimmed down to a bare 2 methods, both look like they pretty much do the same thing. beginTree only checks for a public type and finishTree does the final violations. Other than that they both do the same thing and scan all the siblings connected to the root.\nI question if we should just merge the 2 methods together and remove all the fields, and see if we can do the AST sibling scan only once. What is the benefit now of keeping them in different methods?", "url": "https://github.com/checkstyle/checkstyle/pull/7905#discussion_r397562432", "createdAt": "2020-03-25T01:42:22Z", "author": {"login": "rnveach"}, "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheck.java", "diffHunk": "@@ -126,41 +113,49 @@\n     @Override\n     public void beginTree(DetailAST rootAST) {\n         publicTypeFound = false;\n-        lineNumberTypeMap.clear();\n \n         DetailAST currentNode = rootAST;\n         while (currentNode != null) {\n-            if (currentNode.getType() == TokenTypes.CLASS_DEF\n-                    || currentNode.getType() == TokenTypes.ENUM_DEF\n-                    || currentNode.getType() == TokenTypes.INTERFACE_DEF) {\n-                if (isPublic(currentNode)) {\n-                    publicTypeFound = true;\n-                }\n-                else {\n-                    final String typeName = currentNode\n-                            .findFirstToken(TokenTypes.IDENT).getText();\n-                    lineNumberTypeMap.put(currentNode, typeName);\n-                }\n+            if (isTypeDef(currentNode) && isPublic(currentNode)) {\n+                publicTypeFound = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3b038efbfd11615dc58559debe685a57429d1cc"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e3b038efbfd11615dc58559debe685a57429d1cc", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/e3b038efbfd11615dc58559debe685a57429d1cc", "committedDate": "2020-03-24T13:19:23Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}, "afterCommit": {"oid": "f5c0fdae72163327544f36c855f8c65db659c4ff", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/f5c0fdae72163327544f36c855f8c65db659c4ff", "committedDate": "2020-03-25T18:35:46Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5c0fdae72163327544f36c855f8c65db659c4ff", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/f5c0fdae72163327544f36c855f8c65db659c4ff", "committedDate": "2020-03-25T18:35:46Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}, "afterCommit": {"oid": "bf2299b61ccd48b40d8488264f30d56f9c108b57", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/bf2299b61ccd48b40d8488264f30d56f9c108b57", "committedDate": "2020-03-26T04:02:37Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMTg2NDc4", "url": "https://github.com/checkstyle/checkstyle/pull/7905#pullrequestreview-382186478", "createdAt": "2020-03-26T16:29:16Z", "commit": {"oid": "bf2299b61ccd48b40d8488264f30d56f9c108b57"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf2299b61ccd48b40d8488264f30d56f9c108b57", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/bf2299b61ccd48b40d8488264f30d56f9c108b57", "committedDate": "2020-03-26T04:02:37Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}, "afterCommit": {"oid": "544132b79ff45c45abdfa40dc499232a2ece24b6", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/544132b79ff45c45abdfa40dc499232a2ece24b6", "committedDate": "2020-03-29T07:24:32Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "544132b79ff45c45abdfa40dc499232a2ece24b6", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/544132b79ff45c45abdfa40dc499232a2ece24b6", "committedDate": "2020-03-29T07:24:32Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}, "afterCommit": {"oid": "0ae3b4b0ec556ec78a11b3b5bea63801a1a1ecaf", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/0ae3b4b0ec556ec78a11b3b5bea63801a1a1ecaf", "committedDate": "2020-04-02T04:01:04Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NzI1Mjg5", "url": "https://github.com/checkstyle/checkstyle/pull/7905#pullrequestreview-386725289", "createdAt": "2020-04-02T19:19:14Z", "commit": {"oid": "0ae3b4b0ec556ec78a11b3b5bea63801a1a1ecaf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxOToxOToxNFrOF_59MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxOToyMjoyMVrOF_6ECw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU1NDE2MA==", "bodyText": "why public?", "url": "https://github.com/checkstyle/checkstyle/pull/7905#discussion_r402554160", "createdAt": "2020-04-02T19:19:14Z", "author": {"login": "strkkk"}, "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheck.java", "diffHunk": "@@ -125,42 +106,49 @@\n \n     @Override\n     public void beginTree(DetailAST rootAST) {\n-        publicTypeFound = false;\n-        lineNumberTypeMap.clear();\n-\n         DetailAST currentNode = rootAST;\n+        boolean publicTypeFound = false;\n+        DetailAST firstType = null;\n+\n         while (currentNode != null) {\n-            if (currentNode.getType() == TokenTypes.CLASS_DEF\n-                    || currentNode.getType() == TokenTypes.ENUM_DEF\n-                    || currentNode.getType() == TokenTypes.INTERFACE_DEF) {\n+            if (isTypeDef(currentNode)) {\n                 if (isPublic(currentNode)) {\n+                    // log the first type later\n                     publicTypeFound = true;\n                 }\n-                else {\n+                if (firstType == null) {\n+                    // first type is set aside\n+                    firstType = currentNode;\n+                }\n+                else if (!isPublic(currentNode)) {\n+                    // extra non-public type, log immediately\n                     final String typeName = currentNode\n-                            .findFirstToken(TokenTypes.IDENT).getText();\n-                    lineNumberTypeMap.put(currentNode, typeName);\n+                        .findFirstToken(TokenTypes.IDENT).getText();\n+                    log(currentNode, MSG_KEY, typeName);\n                 }\n             }\n             currentNode = currentNode.getNextSibling();\n         }\n-    }\n \n-    @Override\n-    public void finishTree(DetailAST rootAST) {\n-        if (!lineNumberTypeMap.isEmpty()) {\n-            if (!publicTypeFound) {\n-                // skip first top-level type.\n-                lineNumberTypeMap.remove(lineNumberTypeMap.firstKey());\n-            }\n-\n-            for (Map.Entry<DetailAST, String> entry\n-                    : lineNumberTypeMap.entrySet()) {\n-                log(entry.getKey(), MSG_KEY, entry.getValue());\n-            }\n+        // if there was a public type and first type is non-public, log it\n+        if (publicTypeFound && !isPublic(firstType)) {\n+            final String typeName = firstType\n+                .findFirstToken(TokenTypes.IDENT).getText();\n+            log(firstType, MSG_KEY, typeName);\n         }\n     }\n \n+    /**\n+     * Checks if an AST node is a type definition.\n+     * @param node AST node to check.\n+     * @return true if the node is a type (class, enum, interface) definition.\n+     */\n+    public static boolean isTypeDef(DetailAST node) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ae3b4b0ec556ec78a11b3b5bea63801a1a1ecaf"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU1NTkxNQ==", "bodyText": "can it be changed to something like\nDetailAST firstType = TokenUtil.findFirstTokenByPredicate(rootAST, this::isTypeDef)\n\n?\nIt will look better as current logic", "url": "https://github.com/checkstyle/checkstyle/pull/7905#discussion_r402555915", "createdAt": "2020-04-02T19:22:21Z", "author": {"login": "strkkk"}, "path": "src/main/java/com/puppycrawl/tools/checkstyle/checks/design/OneTopLevelClassCheck.java", "diffHunk": "@@ -125,42 +106,49 @@\n \n     @Override\n     public void beginTree(DetailAST rootAST) {\n-        publicTypeFound = false;\n-        lineNumberTypeMap.clear();\n-\n         DetailAST currentNode = rootAST;\n+        boolean publicTypeFound = false;\n+        DetailAST firstType = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ae3b4b0ec556ec78a11b3b5bea63801a1a1ecaf"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93a0757c2c6b790d0b1df6f3d92910d7aec85b9b", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/93a0757c2c6b790d0b1df6f3d92910d7aec85b9b", "committedDate": "2020-04-03T06:26:08Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ae3b4b0ec556ec78a11b3b5bea63801a1a1ecaf", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/0ae3b4b0ec556ec78a11b3b5bea63801a1a1ecaf", "committedDate": "2020-04-02T04:01:04Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}, "afterCommit": {"oid": "93a0757c2c6b790d0b1df6f3d92910d7aec85b9b", "author": {"user": {"login": "wltan", "name": "Tan Wei Liang"}}, "url": "https://github.com/checkstyle/checkstyle/commit/93a0757c2c6b790d0b1df6f3d92910d7aec85b9b", "committedDate": "2020-04-03T06:26:08Z", "message": "Issue #7812: OneTopLevelClass: Improve data structure efficiency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTIzMjkz", "url": "https://github.com/checkstyle/checkstyle/pull/7905#pullrequestreview-387123293", "createdAt": "2020-04-03T10:06:27Z", "commit": {"oid": "93a0757c2c6b790d0b1df6f3d92910d7aec85b9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MjQ5MTEw", "url": "https://github.com/checkstyle/checkstyle/pull/7905#pullrequestreview-387249110", "createdAt": "2020-04-03T13:21:40Z", "commit": {"oid": "93a0757c2c6b790d0b1df6f3d92910d7aec85b9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 904, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}