{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwOTgxNjA2", "number": 848, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMzo0MToxMVrOD-bXeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMDozOTowOVrOD-b_Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2Nzg2NjgwOnYy", "diffSide": "RIGHT", "path": "titus-common/src/main/java/com/netflix/titus/common/util/limiter/tokenbucket/internal/FixedIntervalTokenBucketSupplier.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMzo0MToxMVrOGYhgYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDowMzo0N1rOGZA-kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2Nzk2OQ==", "bodyText": "Should the null check be also part of the isSame method because the latter is also used by get()?", "url": "https://github.com/Netflix/titus-control-plane/pull/848#discussion_r428367969", "createdAt": "2020-05-20T23:41:11Z", "author": {"login": "joshi-keyur"}, "path": "titus-common/src/main/java/com/netflix/titus/common/util/limiter/tokenbucket/internal/FixedIntervalTokenBucketSupplier.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.common.util.limiter.tokenbucket.internal;\n+\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+\n+import com.google.common.base.Stopwatch;\n+import com.netflix.titus.common.runtime.TitusRuntime;\n+import com.netflix.titus.common.util.Evaluators;\n+import com.netflix.titus.common.util.ExceptionExt;\n+import com.netflix.titus.common.util.limiter.tokenbucket.FixedIntervalTokenBucketConfiguration;\n+import com.netflix.titus.common.util.limiter.tokenbucket.RefillStrategy;\n+import com.netflix.titus.common.util.limiter.tokenbucket.TokenBucket;\n+\n+/**\n+ * {@link TokenBucket} supplier which recreates a token bucket if any of its configurable parameters changes.\n+ * The configuration parameters are read from {@link FixedIntervalTokenBucketConfiguration}.\n+ */\n+public class FixedIntervalTokenBucketSupplier implements Supplier<TokenBucket> {\n+\n+    private final String name;\n+    private final FixedIntervalTokenBucketConfiguration configuration;\n+    private final Consumer<TokenBucket> onChangeListener;\n+    private final Optional<TitusRuntime> titusRuntime;\n+\n+    private volatile ActiveConfiguration activeConfiguration;\n+\n+    private final Object lock = new Object();\n+\n+    public FixedIntervalTokenBucketSupplier(String name,\n+                                            FixedIntervalTokenBucketConfiguration configuration,\n+                                            Consumer<TokenBucket> onChangeListener,\n+                                            Optional<TitusRuntime> titusRuntime) {\n+        this.name = name;\n+        this.configuration = configuration;\n+        this.onChangeListener = onChangeListener;\n+        this.titusRuntime = titusRuntime;\n+        this.activeConfiguration = reload();\n+    }\n+\n+    @Override\n+    public TokenBucket get() {\n+        return isSame() ? activeConfiguration.getTokenBucket() : reload().getTokenBucket();\n+    }\n+\n+    private boolean isSame() {\n+        return activeConfiguration.getCapacity() == configuration.getCapacity()\n+                && activeConfiguration.getInitialNumberOfTokens() == configuration.getInitialNumberOfTokens()\n+                && activeConfiguration.getIntervalMs() == configuration.getIntervalMs()\n+                && activeConfiguration.getNumberOfTokensPerInterval() == configuration.getNumberOfTokensPerInterval();\n+    }\n+\n+    private ActiveConfiguration reload() {\n+        boolean same;\n+        synchronized (lock) {\n+            same = activeConfiguration != null && isSame();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f20716f5e57862fd201915f71753c9ae19ece119"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4MzYwMw==", "bodyText": "Good idea. I will change it as suggested.", "url": "https://github.com/Netflix/titus-control-plane/pull/848#discussion_r428883603", "createdAt": "2020-05-21T20:03:47Z", "author": {"login": "tbak"}, "path": "titus-common/src/main/java/com/netflix/titus/common/util/limiter/tokenbucket/internal/FixedIntervalTokenBucketSupplier.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.common.util.limiter.tokenbucket.internal;\n+\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+\n+import com.google.common.base.Stopwatch;\n+import com.netflix.titus.common.runtime.TitusRuntime;\n+import com.netflix.titus.common.util.Evaluators;\n+import com.netflix.titus.common.util.ExceptionExt;\n+import com.netflix.titus.common.util.limiter.tokenbucket.FixedIntervalTokenBucketConfiguration;\n+import com.netflix.titus.common.util.limiter.tokenbucket.RefillStrategy;\n+import com.netflix.titus.common.util.limiter.tokenbucket.TokenBucket;\n+\n+/**\n+ * {@link TokenBucket} supplier which recreates a token bucket if any of its configurable parameters changes.\n+ * The configuration parameters are read from {@link FixedIntervalTokenBucketConfiguration}.\n+ */\n+public class FixedIntervalTokenBucketSupplier implements Supplier<TokenBucket> {\n+\n+    private final String name;\n+    private final FixedIntervalTokenBucketConfiguration configuration;\n+    private final Consumer<TokenBucket> onChangeListener;\n+    private final Optional<TitusRuntime> titusRuntime;\n+\n+    private volatile ActiveConfiguration activeConfiguration;\n+\n+    private final Object lock = new Object();\n+\n+    public FixedIntervalTokenBucketSupplier(String name,\n+                                            FixedIntervalTokenBucketConfiguration configuration,\n+                                            Consumer<TokenBucket> onChangeListener,\n+                                            Optional<TitusRuntime> titusRuntime) {\n+        this.name = name;\n+        this.configuration = configuration;\n+        this.onChangeListener = onChangeListener;\n+        this.titusRuntime = titusRuntime;\n+        this.activeConfiguration = reload();\n+    }\n+\n+    @Override\n+    public TokenBucket get() {\n+        return isSame() ? activeConfiguration.getTokenBucket() : reload().getTokenBucket();\n+    }\n+\n+    private boolean isSame() {\n+        return activeConfiguration.getCapacity() == configuration.getCapacity()\n+                && activeConfiguration.getInitialNumberOfTokens() == configuration.getInitialNumberOfTokens()\n+                && activeConfiguration.getIntervalMs() == configuration.getIntervalMs()\n+                && activeConfiguration.getNumberOfTokensPerInterval() == configuration.getNumberOfTokensPerInterval();\n+    }\n+\n+    private ActiveConfiguration reload() {\n+        boolean same;\n+        synchronized (lock) {\n+            same = activeConfiguration != null && isSame();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2Nzk2OQ=="}, "originalCommit": {"oid": "f20716f5e57862fd201915f71753c9ae19ece119"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2Nzk2ODE4OnYy", "diffSide": "RIGHT", "path": "titus-common/src/main/java/com/netflix/titus/common/util/limiter/tokenbucket/FixedIntervalTokenBucketConfiguration.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMDozOTowOVrOGYiftg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDowMDozOFrOGZA4hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4NDE4Mg==", "bodyText": "Should we add Configuration prefix for better namespacing here?", "url": "https://github.com/Netflix/titus-control-plane/pull/848#discussion_r428384182", "createdAt": "2020-05-21T00:39:09Z", "author": {"login": "joshi-keyur"}, "path": "titus-common/src/main/java/com/netflix/titus/common/util/limiter/tokenbucket/FixedIntervalTokenBucketConfiguration.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.common.util.limiter.tokenbucket;\n+\n+import com.netflix.archaius.api.annotations.DefaultValue;\n+\n+public interface FixedIntervalTokenBucketConfiguration {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f20716f5e57862fd201915f71753c9ae19ece119"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4MjA1Mw==", "bodyText": "Prefix must be provided by a client, but we can create a default value here.", "url": "https://github.com/Netflix/titus-control-plane/pull/848#discussion_r428882053", "createdAt": "2020-05-21T20:00:38Z", "author": {"login": "tbak"}, "path": "titus-common/src/main/java/com/netflix/titus/common/util/limiter/tokenbucket/FixedIntervalTokenBucketConfiguration.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.common.util.limiter.tokenbucket;\n+\n+import com.netflix.archaius.api.annotations.DefaultValue;\n+\n+public interface FixedIntervalTokenBucketConfiguration {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4NDE4Mg=="}, "originalCommit": {"oid": "f20716f5e57862fd201915f71753c9ae19ece119"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3958, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}