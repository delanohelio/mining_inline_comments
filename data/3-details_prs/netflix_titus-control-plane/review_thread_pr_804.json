{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NjgwNzA5", "number": 804, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNjoxNjozNFrODmXXWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzozODowNFrODmZY6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNTU1Mjg5OnYy", "diffSide": "RIGHT", "path": "titus-common/src/main/java/com/netflix/titus/common/util/StringExt.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNjoxNjozNFrOFzvdTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODoyMjowM1rOF1qKAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5OTI0Nw==", "bodyText": "worth using a try-with-resources here (and move some of the declarations outside of the try-catch block) just to avoid leaking the stream on errors?", "url": "https://github.com/Netflix/titus-control-plane/pull/804#discussion_r389799247", "createdAt": "2020-03-09T16:16:34Z", "author": {"login": "fabiokung"}, "path": "titus-common/src/main/java/com/netflix/titus/common/util/StringExt.java", "diffHunk": "@@ -540,4 +543,24 @@ public static String startWithLowercase(String text) {\n         }\n         return Optional.of(result);\n     }\n+\n+    /**\n+     * GZip a string and base64 encode the result in order to compress a string while keeping the String type.\n+     *\n+     * @return gzipped and base64 encoded string.\n+     */\n+    public static String gzipAndBase64Encode(String s) {\n+        if (StringExt.isEmpty(s)) {\n+            return s;\n+        }\n+        try {\n+            ByteArrayOutputStream out = new ByteArrayOutputStream();\n+            GZIPOutputStream gzip = new GZIPOutputStream(out);\n+            gzip.write(s.getBytes());\n+            gzip.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79260c79073becdec5ccf6ed2970b198b7f05edb"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwOTUzNw==", "bodyText": "I like this idea, but will address it in a followup PR.", "url": "https://github.com/Netflix/titus-control-plane/pull/804#discussion_r391809537", "createdAt": "2020-03-12T18:22:03Z", "author": {"login": "corindwyer"}, "path": "titus-common/src/main/java/com/netflix/titus/common/util/StringExt.java", "diffHunk": "@@ -540,4 +543,24 @@ public static String startWithLowercase(String text) {\n         }\n         return Optional.of(result);\n     }\n+\n+    /**\n+     * GZip a string and base64 encode the result in order to compress a string while keeping the String type.\n+     *\n+     * @return gzipped and base64 encoded string.\n+     */\n+    public static String gzipAndBase64Encode(String s) {\n+        if (StringExt.isEmpty(s)) {\n+            return s;\n+        }\n+        try {\n+            ByteArrayOutputStream out = new ByteArrayOutputStream();\n+            GZIPOutputStream gzip = new GZIPOutputStream(out);\n+            gzip.write(s.getBytes());\n+            gzip.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5OTI0Nw=="}, "originalCommit": {"oid": "79260c79073becdec5ccf6ed2970b198b7f05edb"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNTU4NTE5OnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNjoyNDoyMlrOFzvxQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODoyMjowNlrOF1qKGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgwNDM1Mw==", "bodyText": "minor: use ObjectMappers.storeMapper()#writeValue(OutputStream, Object) to save some heap space, avoid String allocations and unnecessary UTF-16 shenanigans.\nThat way you can also pass in a GZIPOutputStream directly to the writeValue() method and allow chunked encoding of the whole jobDescriptor.", "url": "https://github.com/Netflix/titus-control-plane/pull/804#discussion_r389804353", "createdAt": "2020-03-09T16:24:22Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "diffHunk": "@@ -209,4 +213,24 @@ public static String getNodeIpV4Address(V1Node node) {\n                 .map(V1NodeAddress::getAddress)\n                 .orElse(\"UnknownIpAddress\");\n     }\n+\n+    public static Map<String, String> createPodAnnotations(\n+            Job<?> job,\n+            byte[] containerInfoData,\n+            Map<String, String> passthroughAttributes,\n+            boolean includeJobDescriptor\n+    ) {\n+        String encodedContainerInfo = Base64.getEncoder().encodeToString(containerInfoData);\n+\n+        Map<String, String> annotations = new HashMap<>(passthroughAttributes);\n+        annotations.putAll(PerformanceToolUtil.toAnnotations(job));\n+        annotations.put(\"containerInfo\", encodedContainerInfo);\n+\n+        if (includeJobDescriptor) {\n+            String jobDescriptorJson = CommonObjectMappers.writeValueAsString(ObjectMappers.storeMapper(), job.getJobDescriptor());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79260c79073becdec5ccf6ed2970b198b7f05edb"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwOTU2MQ==", "bodyText": "I like this idea, but will address it in a followup PR.", "url": "https://github.com/Netflix/titus-control-plane/pull/804#discussion_r391809561", "createdAt": "2020-03-12T18:22:06Z", "author": {"login": "corindwyer"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "diffHunk": "@@ -209,4 +213,24 @@ public static String getNodeIpV4Address(V1Node node) {\n                 .map(V1NodeAddress::getAddress)\n                 .orElse(\"UnknownIpAddress\");\n     }\n+\n+    public static Map<String, String> createPodAnnotations(\n+            Job<?> job,\n+            byte[] containerInfoData,\n+            Map<String, String> passthroughAttributes,\n+            boolean includeJobDescriptor\n+    ) {\n+        String encodedContainerInfo = Base64.getEncoder().encodeToString(containerInfoData);\n+\n+        Map<String, String> annotations = new HashMap<>(passthroughAttributes);\n+        annotations.putAll(PerformanceToolUtil.toAnnotations(job));\n+        annotations.put(\"containerInfo\", encodedContainerInfo);\n+\n+        if (includeJobDescriptor) {\n+            String jobDescriptorJson = CommonObjectMappers.writeValueAsString(ObjectMappers.storeMapper(), job.getJobDescriptor());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgwNDM1Mw=="}, "originalCommit": {"oid": "79260c79073becdec5ccf6ed2970b198b7f05edb"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNTg4NDU3OnYy", "diffSide": "RIGHT", "path": "titus-common/src/test/java/com/netflix/titus/common/util/StringExtTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzozODowNFrOFzyohw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODoyMjo1MlrOF1qLng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg1MTI3MQ==", "bodyText": "Looks like this assertion is unique to the input in this case.\nShould we generalize the test and possibly validate the decoded-gunzipped output is the same as input?\nAlso empty string is an interesting case since its output is non-empty. Maybe also handle that instead of returning an empty string. Curious to know what you think.", "url": "https://github.com/Netflix/titus-control-plane/pull/804#discussion_r389851271", "createdAt": "2020-03-09T17:38:04Z", "author": {"login": "joshi-keyur"}, "path": "titus-common/src/test/java/com/netflix/titus/common/util/StringExtTest.java", "diffHunk": "@@ -81,4 +81,11 @@ public void testParseDurationList() {\n                 Duration.ofMillis(1), Duration.ofMillis(2), Duration.ofMillis(3)\n         );\n     }\n+\n+    @Test\n+    public void testGzipAndBase64Encode() {\n+        String input = \"{aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa:bbbbbbbbbbbbbbbbbbbbbbbbbbb}\";\n+        String output = StringExt.gzipAndBase64Encode(input);\n+        assertThat(output.length()).isLessThan(input.length());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79260c79073becdec5ccf6ed2970b198b7f05edb"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwOTk1MA==", "bodyText": "I didn't go do that because I didn't write the decode and ungzip method, but I will think about this some more and potentially change it in a followup PR.", "url": "https://github.com/Netflix/titus-control-plane/pull/804#discussion_r391809950", "createdAt": "2020-03-12T18:22:52Z", "author": {"login": "corindwyer"}, "path": "titus-common/src/test/java/com/netflix/titus/common/util/StringExtTest.java", "diffHunk": "@@ -81,4 +81,11 @@ public void testParseDurationList() {\n                 Duration.ofMillis(1), Duration.ofMillis(2), Duration.ofMillis(3)\n         );\n     }\n+\n+    @Test\n+    public void testGzipAndBase64Encode() {\n+        String input = \"{aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa:bbbbbbbbbbbbbbbbbbbbbbbbbbb}\";\n+        String output = StringExt.gzipAndBase64Encode(input);\n+        assertThat(output.length()).isLessThan(input.length());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg1MTI3MQ=="}, "originalCommit": {"oid": "79260c79073becdec5ccf6ed2970b198b7f05edb"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4090, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}