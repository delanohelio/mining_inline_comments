{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzOTQ1MzEw", "number": 967, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzoyMzo1OFrOFIPIYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzozMjo0M1rOFIPTYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0MTgwODMyOnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/env/AggregatingContainerEnvFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzoyMzo1OFrOIKC0GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxOTo0ODoyMlrOIKHR8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwMjc3Nw==", "bodyText": "Is there a value in extracting it as an abstract class?", "url": "https://github.com/Netflix/titus-control-plane/pull/967#discussion_r547402777", "createdAt": "2020-12-22T17:23:58Z", "author": {"login": "tbak"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/env/AggregatingContainerEnvFactory.java", "diffHunk": "@@ -17,31 +17,17 @@\n package com.netflix.titus.master.mesos.kubeapiserver.direct.env;\n \n import java.util.Arrays;\n-import java.util.HashMap;\n import java.util.List;\n-import java.util.Map;\n-\n-import com.netflix.titus.api.jobmanager.model.job.Job;\n-import com.netflix.titus.api.jobmanager.model.job.Task;\n \n /**\n  * Aggregate container environment variables from many sources. Evaluation happens from left to right, with the\n  * next item overriding entries from previous evaluations if there is a collision.\n  */\n-public class AggregatingContainerEnvFactory implements ContainerEnvFactory {\n+public abstract class AggregatingContainerEnvFactory implements ContainerEnvFactory {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2057f6b9cbe9f58e95eff8acbe16ddaf7283f8ea"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ3NTk1NQ==", "bodyText": "I will refactor and embed the initialization in the default implementation and remove this class for brevity. Thank you!", "url": "https://github.com/Netflix/titus-control-plane/pull/967#discussion_r547475955", "createdAt": "2020-12-22T19:48:22Z", "author": {"login": "joshi-keyur"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/env/AggregatingContainerEnvFactory.java", "diffHunk": "@@ -17,31 +17,17 @@\n package com.netflix.titus.master.mesos.kubeapiserver.direct.env;\n \n import java.util.Arrays;\n-import java.util.HashMap;\n import java.util.List;\n-import java.util.Map;\n-\n-import com.netflix.titus.api.jobmanager.model.job.Job;\n-import com.netflix.titus.api.jobmanager.model.job.Task;\n \n /**\n  * Aggregate container environment variables from many sources. Evaluation happens from left to right, with the\n  * next item overriding entries from previous evaluations if there is a collision.\n  */\n-public class AggregatingContainerEnvFactory implements ContainerEnvFactory {\n+public abstract class AggregatingContainerEnvFactory implements ContainerEnvFactory {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwMjc3Nw=="}, "originalCommit": {"oid": "2057f6b9cbe9f58e95eff8acbe16ddaf7283f8ea"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0MTgyODEzOnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/env/DefaultAggregatingContainerEnvFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzoyOTo1MVrOIKC_tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzoyOTo1MVrOIKC_tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwNTc0OQ==", "bodyText": "The this. prefixes don't seem needed.", "url": "https://github.com/Netflix/titus-control-plane/pull/967#discussion_r547405749", "createdAt": "2020-12-22T17:29:51Z", "author": {"login": "andrew-leung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/env/DefaultAggregatingContainerEnvFactory.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.master.mesos.kubeapiserver.direct.env;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.spectator.api.Id;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.titus.api.jobmanager.model.job.Job;\n+import com.netflix.titus.api.jobmanager.model.job.Task;\n+import com.netflix.titus.common.runtime.TitusRuntime;\n+\n+@Singleton\n+public class DefaultAggregatingContainerEnvFactory extends AggregatingContainerEnvFactory {\n+\n+    private static final String CONFLICT_COUNTER = \"titus.aggregatingContainerEnv.conflict\";\n+\n+    private final Registry registry;\n+\n+    private final Id conflictId;\n+\n+    @Inject\n+    public DefaultAggregatingContainerEnvFactory(TitusRuntime titusRuntime) {\n+        super(UserProvidedContainerEnvFactory.getInstance(), TitusProvidedContainerEnvFactory.getInstance());\n+        this.registry = titusRuntime.getRegistry();\n+        this.conflictId = registry.createId(CONFLICT_COUNTER);\n+    }\n+\n+    @Override\n+    public Map<String, String> buildContainerEnv(Job<?> job, Task task) {\n+        Map<String, String> env = new HashMap<>();\n+        for (ContainerEnvFactory factory : factories) {\n+            Map<String, String> envMap = factory.buildContainerEnv(job, task);\n+            // Tracking conflicting env var for any two given factories\n+            env.keySet().stream().filter(envMap::containsKey).forEach(this::incrementConflictCounter);\n+            env.putAll(envMap);\n+        }\n+        return env;\n+    }\n+\n+    private void incrementConflictCounter(String envVarName) {\n+        this.registry.counter(this.conflictId.withTags(\"env\", envVarName)).increment();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2057f6b9cbe9f58e95eff8acbe16ddaf7283f8ea"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0MTgzNjUwOnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/env/DefaultAggregatingContainerEnvFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzozMjo0M1rOIKDEyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxOToyNTo1NVrOIKGoBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwNzA0OQ==", "bodyText": "It seems like we're depending on the order here to make sure that factories with higher precedence override others. If that's the case, maybe we should add a comment here or where we do the put()/overwrite?", "url": "https://github.com/Netflix/titus-control-plane/pull/967#discussion_r547407049", "createdAt": "2020-12-22T17:32:43Z", "author": {"login": "andrew-leung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/env/DefaultAggregatingContainerEnvFactory.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.master.mesos.kubeapiserver.direct.env;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.spectator.api.Id;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.titus.api.jobmanager.model.job.Job;\n+import com.netflix.titus.api.jobmanager.model.job.Task;\n+import com.netflix.titus.common.runtime.TitusRuntime;\n+\n+@Singleton\n+public class DefaultAggregatingContainerEnvFactory extends AggregatingContainerEnvFactory {\n+\n+    private static final String CONFLICT_COUNTER = \"titus.aggregatingContainerEnv.conflict\";\n+\n+    private final Registry registry;\n+\n+    private final Id conflictId;\n+\n+    @Inject\n+    public DefaultAggregatingContainerEnvFactory(TitusRuntime titusRuntime) {\n+        super(UserProvidedContainerEnvFactory.getInstance(), TitusProvidedContainerEnvFactory.getInstance());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2057f6b9cbe9f58e95eff8acbe16ddaf7283f8ea"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQ2NTIyMA==", "bodyText": "Good point.", "url": "https://github.com/Netflix/titus-control-plane/pull/967#discussion_r547465220", "createdAt": "2020-12-22T19:25:55Z", "author": {"login": "joshi-keyur"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/env/DefaultAggregatingContainerEnvFactory.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.master.mesos.kubeapiserver.direct.env;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.spectator.api.Id;\n+import com.netflix.spectator.api.Registry;\n+import com.netflix.titus.api.jobmanager.model.job.Job;\n+import com.netflix.titus.api.jobmanager.model.job.Task;\n+import com.netflix.titus.common.runtime.TitusRuntime;\n+\n+@Singleton\n+public class DefaultAggregatingContainerEnvFactory extends AggregatingContainerEnvFactory {\n+\n+    private static final String CONFLICT_COUNTER = \"titus.aggregatingContainerEnv.conflict\";\n+\n+    private final Registry registry;\n+\n+    private final Id conflictId;\n+\n+    @Inject\n+    public DefaultAggregatingContainerEnvFactory(TitusRuntime titusRuntime) {\n+        super(UserProvidedContainerEnvFactory.getInstance(), TitusProvidedContainerEnvFactory.getInstance());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwNzA0OQ=="}, "originalCommit": {"oid": "2057f6b9cbe9f58e95eff8acbe16ddaf7283f8ea"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3923, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}