{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzOTYyMjU3", "number": 800, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjo0Nzo1OFrODlf-aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo1Njo0NFrODliw4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNjQ3Nzg1OnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjo0Nzo1OFrOFybaIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjo1NTozMlrOFybuHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyMjE3OA==", "bodyText": "The first ipv4 ip address should be used as the host ip like in:\nhttps://github.com/Netflix/titus-control-plane/blob/master/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java#L453", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388422178", "createdAt": "2020-03-05T16:47:58Z", "author": {"login": "corindwyer"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java", "diffHunk": "@@ -264,6 +266,16 @@ private Task attachNodeMetadata(Task task, V1Node node) {\n \n         acceptNotNull(node.getMetadata().getName(), nodeName -> agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_KUBE_NODE_NAME, nodeName));\n \n+        List<V1NodeAddress> addresses = node.getStatus().getAddresses();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "364c6a14e43e5ee4064a76c64a96ad3a624c873b"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyNDUyNQ==", "bodyText": "@corindwyer I have seen your recent PR. We should share your address filter in both places. Once you merge, I will rebase and create a function in KubeUtil.", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388424525", "createdAt": "2020-03-05T16:51:26Z", "author": {"login": "tbak"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java", "diffHunk": "@@ -264,6 +266,16 @@ private Task attachNodeMetadata(Task task, V1Node node) {\n \n         acceptNotNull(node.getMetadata().getName(), nodeName -> agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_KUBE_NODE_NAME, nodeName));\n \n+        List<V1NodeAddress> addresses = node.getStatus().getAddresses();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyMjE3OA=="}, "originalCommit": {"oid": "364c6a14e43e5ee4064a76c64a96ad3a624c873b"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyNzI5Mg==", "bodyText": "Sounds good. I already merged.", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388427292", "createdAt": "2020-03-05T16:55:32Z", "author": {"login": "corindwyer"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java", "diffHunk": "@@ -264,6 +266,16 @@ private Task attachNodeMetadata(Task task, V1Node node) {\n \n         acceptNotNull(node.getMetadata().getName(), nodeName -> agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_KUBE_NODE_NAME, nodeName));\n \n+        List<V1NodeAddress> addresses = node.getStatus().getAddresses();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyMjE3OA=="}, "originalCommit": {"oid": "364c6a14e43e5ee4064a76c64a96ad3a624c873b"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNjYzMDQ3OnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNzoyNjoxMlrOFyc4Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNzoyNjoxMlrOFyc4Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0NjIzMA==", "bodyText": "this looks incorrectly indented", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388446230", "createdAt": "2020-03-05T17:26:12Z", "author": {"login": "corindwyer"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "diffHunk": "@@ -191,4 +197,12 @@ public static boolean isOwnedByKubeScheduler(V1Pod v1Pod) {\n         }\n         return false;\n     }\n+\n+    public static String getNodeIpV4Address(V1Node node) {\n+        return   node.getStatus().getAddresses().stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56dbe6d10d178829b6fb132efd470def8ee963b7"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNjkxNDQ5OnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/batch/BatchDifferenceResolver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo1MToxNlrOFyfqmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTowMTo0NFrOFygCAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MTkyOA==", "bodyText": "why not centralize this check into the kubeSchedulerPredicate?", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388491928", "createdAt": "2020-03-05T18:51:16Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/batch/BatchDifferenceResolver.java", "diffHunk": "@@ -238,7 +244,7 @@ public BatchDifferenceResolver(\n         }\n \n         Map<String, String> taskContext = getTaskContext(previousTask, unassignedIpAllocations);\n-        if (kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {\n+        if (KubeUtil.findFarzoneId(kubeConfiguration, refJobView.getJob()).isPresent() || kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56dbe6d10d178829b6fb132efd470def8ee963b7"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5NzkyMA==", "bodyText": "I have tried that, but the code is in a different subproject.", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388497920", "createdAt": "2020-03-05T19:01:44Z", "author": {"login": "tbak"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/batch/BatchDifferenceResolver.java", "diffHunk": "@@ -238,7 +244,7 @@ public BatchDifferenceResolver(\n         }\n \n         Map<String, String> taskContext = getTaskContext(previousTask, unassignedIpAllocations);\n-        if (kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {\n+        if (KubeUtil.findFarzoneId(kubeConfiguration, refJobView.getJob()).isPresent() || kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MTkyOA=="}, "originalCommit": {"oid": "56dbe6d10d178829b6fb132efd470def8ee963b7"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNjkxNjQyOnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/service/ServiceDifferenceResolver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo1MTo0NVrOFyfrvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTowMjoyMFrOFygDQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MjIyMA==", "bodyText": "same as above, centralize this into the predicate", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388492220", "createdAt": "2020-03-05T18:51:45Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/service/ServiceDifferenceResolver.java", "diffHunk": "@@ -261,7 +267,7 @@ public ServiceDifferenceResolver(\n         }\n \n         Map<String, String> taskContext = getTaskContext(previousTask, unassignedIpAllocations);\n-        if (kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {\n+        if (KubeUtil.findFarzoneId(kubeConfiguration, refJobView.getJob()).isPresent() || kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56dbe6d10d178829b6fb132efd470def8ee963b7"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5ODI0MA==", "bodyText": "I have tried that, but the code is in a different subproject.", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388498240", "createdAt": "2020-03-05T19:02:20Z", "author": {"login": "tbak"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/service/ServiceDifferenceResolver.java", "diffHunk": "@@ -261,7 +267,7 @@ public ServiceDifferenceResolver(\n         }\n \n         Map<String, String> taskContext = getTaskContext(previousTask, unassignedIpAllocations);\n-        if (kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {\n+        if (KubeUtil.findFarzoneId(kubeConfiguration, refJobView.getJob()).isPresent() || kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MjIyMA=="}, "originalCommit": {"oid": "56dbe6d10d178829b6fb132efd470def8ee963b7"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNjkyOTA5OnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo1NToyMlrOFyfztQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTowNDo0OFrOFygIsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5NDI2MQ==", "bodyText": "could this be generalized to any availabilityZones? Does it matter that it is a farzone? I'd recommend naming this isAvailabilityZoneOwnedByKubeScheduler() and configuration.getAvailabilityZonesOwnedByKubeScheduler(), or similar.\nIOW, can we abstract away that some AZs are farzones?", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388494261", "createdAt": "2020-03-05T18:55:22Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "diffHunk": "@@ -148,4 +161,48 @@ public static String formatV1ContainerState(V1ContainerState containerState) {\n \n         return \"{state=<not set>}\";\n     }\n+\n+    /**\n+     * If a job has an availability zone hard constraint with a farzone id, return this farzone id.\n+     */\n+    public static Optional<String> findFarzoneId(DirectKubeConfiguration configuration, Job job) {\n+        List<String> farzones = configuration.getFarzones();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56dbe6d10d178829b6fb132efd470def8ee963b7"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5OTYzNQ==", "bodyText": "It is more than an additional zone. Farzones are excluded from the default scheduling, and there is extra logic around that. I would prefer to keep it explicit.", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388499635", "createdAt": "2020-03-05T19:04:48Z", "author": {"login": "tbak"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "diffHunk": "@@ -148,4 +161,48 @@ public static String formatV1ContainerState(V1ContainerState containerState) {\n \n         return \"{state=<not set>}\";\n     }\n+\n+    /**\n+     * If a job has an availability zone hard constraint with a farzone id, return this farzone id.\n+     */\n+    public static Optional<String> findFarzoneId(DirectKubeConfiguration configuration, Job job) {\n+        List<String> farzones = configuration.getFarzones();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5NDI2MQ=="}, "originalCommit": {"oid": "56dbe6d10d178829b6fb132efd470def8ee963b7"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNjkzNDc0OnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultPodAffinityFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo1Njo0NFrOFyf3AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTowNTowN1rOFygJVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5NTEwNQ==", "bodyText": "same, generalize to any AZs, farzone or not", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388495105", "createdAt": "2020-03-05T18:56:44Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultPodAffinityFactory.java", "diffHunk": "@@ -181,6 +186,12 @@ private void addNodeAffinityPreferredSelectorConstraint(String key, String value\n             term.addMatchExpressionsItem(requirement);\n         }\n \n+        private void processFarzoneConstraints() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56dbe6d10d178829b6fb132efd470def8ee963b7"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5OTc5OQ==", "bodyText": "See my comment above ^^^.", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388499799", "createdAt": "2020-03-05T19:05:07Z", "author": {"login": "tbak"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultPodAffinityFactory.java", "diffHunk": "@@ -181,6 +186,12 @@ private void addNodeAffinityPreferredSelectorConstraint(String key, String value\n             term.addMatchExpressionsItem(requirement);\n         }\n \n+        private void processFarzoneConstraints() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5NTEwNQ=="}, "originalCommit": {"oid": "56dbe6d10d178829b6fb132efd470def8ee963b7"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4088, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}