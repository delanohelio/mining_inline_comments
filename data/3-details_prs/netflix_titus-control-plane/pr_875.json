{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2Mjk1MjQ0", "number": 875, "title": "Adding compliance check for container accountId and subnets", "bodyText": "Description of the Change\nWhen default values for accountId and subnets container attributes are present in the JobManagerConfiguration but not defined in the JobDescriptor (in container attributes), a violation is recorded. Consequently, the job descriptor is sanitized with the default values from the configuration properties.\nCurrently we are limiting the compliance check only when default values for these two attributes are present as configuration properties since not all deployment stacks may be ready for us to enforce this strict requirement. Note that we are not providing any extra safety guards yet to make sure the accountId and subnet list are compatible. It is possible that an invalid combination is used which will result in failure to run the task. This is the current behavior and  unchanged.", "createdAt": "2020-06-18T07:54:18Z", "url": "https://github.com/Netflix/titus-control-plane/pull/875", "merged": true, "mergeCommit": {"oid": "06d88a5e944b99f9799df43911fbf1d49e45bca3"}, "closed": true, "closedAt": "2020-06-26T02:07:23Z", "author": {"login": "joshi-keyur"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsZmZbgH2gAyNDM2Mjk1MjQ0OjkzNzU4Nzk1ZGQ2ZDAxZjAzOWNmMWE0Nzk2MjdiZTU4YWE3YTUwNGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcucYAtAFqTQzNjc5ODM3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "93758795dd6d01f039cf1a479627be58aa7a504d", "author": {"user": {"login": "joshi-keyur", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/93758795dd6d01f039cf1a479627be58aa7a504d", "committedDate": "2020-06-18T07:48:19Z", "message": "Adding compliance check for container accountId and subnets"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTI3MzU4", "url": "https://github.com/Netflix/titus-control-plane/pull/875#pullrequestreview-433527358", "createdAt": "2020-06-18T18:07:26Z", "commit": {"oid": "93758795dd6d01f039cf1a479627be58aa7a504d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODowNzoyNlrOGl6k0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODoxMDowMVrOGl6qJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQxMDE5Mg==", "bodyText": "Isn't account/subnets configuration the same feature?", "url": "https://github.com/Netflix/titus-control-plane/pull/875#discussion_r442410192", "createdAt": "2020-06-18T18:07:26Z", "author": {"login": "tbak"}, "path": "titus-api/src/main/java/com/netflix/titus/api/FeatureRolloutPlans.java", "diffHunk": "@@ -76,4 +76,19 @@\n             description = \"Integrate Kube scheduler\"\n     )\n     String KUBE_SCHEDULER_FEATURE = \"kubeSchedulerFeature\";\n+\n+    @FeatureRollout(\n+            featureId = \"accountId\",\n+            deadline = \"10/01/2020\",\n+            description = \"Jobs should explicity provide AWS accountId the container should launch in\"\n+    )\n+    String CONTAINER_ACCOUNT_ID_REQUIRED_FEATURE = \"accountId\";\n+\n+    @FeatureRollout(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93758795dd6d01f039cf1a479627be58aa7a504d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQxMTU1OA==", "bodyText": "What if a user sets an account id (non-default), but not subnets?  Setting default subnets will be incorrect.\nI think we should validate/set this data together, as they must be mutually consistent.", "url": "https://github.com/Netflix/titus-control-plane/pull/875#discussion_r442411558", "createdAt": "2020-06-18T18:10:01Z", "author": {"login": "tbak"}, "path": "titus-server-gateway/src/main/java/com/netflix/titus/gateway/service/v3/internal/ExtendedJobSanitizer.java", "diffHunk": "@@ -151,6 +157,26 @@ public ExtendedJobSanitizer(JobManagerConfiguration jobManagerConfiguration,\n                 }\n             });\n \n+            Map<String, String> defaultContainerAttributes = new HashMap<>();\n+            violations.findViolation(CONTAINER_ACCOUNT_ID_REQUIRED_FEATURE).ifPresent(nonCompliance -> {\n+                if (!StringExt.isEmpty(jobManagerConfiguration.getDefaultContainerAccountId())) {\n+                    defaultContainerAttributes.put(JobAttributes.JOB_CONTAINER_ATTRIBUTE_ACCOUNT_ID, jobManagerConfiguration.getDefaultContainerAccountId());\n+                }\n+            });\n+            violations.findViolation(SUBNETS_REQUIRED_FEATURE).ifPresent(nonCompliance -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93758795dd6d01f039cf1a479627be58aa7a504d"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85f169b7db4dcfba887f119039af538667896963", "author": {"user": {"login": "joshi-keyur", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/85f169b7db4dcfba887f119039af538667896963", "committedDate": "2020-06-19T01:37:22Z", "message": "Combine accountId and subnets validations and sanitize with defaults when applicable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjM4ODI3", "url": "https://github.com/Netflix/titus-control-plane/pull/875#pullrequestreview-434238827", "createdAt": "2020-06-19T17:28:40Z", "commit": {"oid": "85f169b7db4dcfba887f119039af538667896963"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoyODo0MFrOGmcV5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoyODo0MFrOGmcV5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2MzQyOA==", "bodyText": "If I understand it correctly, setting accontId parameter to the default account id is non-compliant?", "url": "https://github.com/Netflix/titus-control-plane/pull/875#discussion_r442963428", "createdAt": "2020-06-19T17:28:40Z", "author": {"login": "tbak"}, "path": "titus-server-gateway/src/main/java/com/netflix/titus/gateway/service/v3/internal/JobFeatureComplianceChecks.java", "diffHunk": "@@ -106,6 +111,39 @@\n         };\n     }\n \n+    /**\n+     * A feature compliance is violated if there is a default accountId and subnets combination present in the {@link JobManagerConfiguration} for the deployment stack\n+     * but the container attributes in the {@link JobDescriptor} are missing one or both values.\n+     * @param jobManagerConfiguration {@link JobManagerConfiguration}\n+     * @return feature compliance evaluation\n+     */\n+    static FeatureCompliance<JobDescriptor<?>> missingContainerAccountIdAndSubnets(JobManagerConfiguration jobManagerConfiguration) {\n+        return jobDescriptor -> {\n+            String defaultAccountId = jobManagerConfiguration.getDefaultContainerAccountId();\n+            String defaultSubnets = jobManagerConfiguration.getDefaultSubnets();\n+            // Ignore this compliance check unless both default accountId and subnet configuration properties are set implying our\n+            // intent to aid the job descriptor sanitization\n+            if (StringExt.isEmpty(defaultAccountId) || StringExt.isEmpty(defaultSubnets)) {\n+                return Optional.empty();\n+            }\n+\n+            String accountIdContainerAttribute = jobDescriptor.getContainer().getAttributes().get(JOB_CONTAINER_ATTRIBUTE_ACCOUNT_ID);\n+            String subnetContainerAttribute = jobDescriptor.getContainer().getAttributes().get(JOB_CONTAINER_ATTRIBUTE_SUBNETS);\n+\n+            // Feature compliance is violated if either (i) both attributes are not set, or (ii) accountId is set to the default value but the subnets value is not set.\n+            // In either case, we should take action in response to this violation.\n+            if ((StringExt.isEmpty(accountIdContainerAttribute) || defaultAccountId.equals(accountIdContainerAttribute)) && StringExt.isEmpty(subnetContainerAttribute)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85f169b7db4dcfba887f119039af538667896963"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjQ5NDMy", "url": "https://github.com/Netflix/titus-control-plane/pull/875#pullrequestreview-434249432", "createdAt": "2020-06-19T17:48:17Z", "commit": {"oid": "85f169b7db4dcfba887f119039af538667896963"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2Nzk4Mzc2", "url": "https://github.com/Netflix/titus-control-plane/pull/875#pullrequestreview-436798376", "createdAt": "2020-06-24T16:10:10Z", "commit": {"oid": "85f169b7db4dcfba887f119039af538667896963"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 542, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}