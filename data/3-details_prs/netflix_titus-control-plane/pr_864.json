{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMzg5MDA5", "number": 864, "title": "Do not attempt scheduling if Kube integrator is not ready or healthy", "bodyText": "", "createdAt": "2020-06-08T20:48:58Z", "url": "https://github.com/Netflix/titus-control-plane/pull/864", "merged": true, "mergeCommit": {"oid": "fb27bab650de9ccdf2cfe11ae338fd885060096b"}, "closed": true, "closedAt": "2020-06-08T21:52:15Z", "author": {"login": "tbak"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpWvITAH2gAyNDMxMzg5MDA5OjM1MTBmZmYwYWJkMzg3YzExYTZjNDQzN2NmNTBiYTFmYjdhZmMzYzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpXZ0uAFqTQyNjYzNzQxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3510fff0abd387c11a6c4437cf50ba1fb7afc3c8", "author": {"user": {"login": "tbak", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/3510fff0abd387c11a6c4437cf50ba1fb7afc3c8", "committedDate": "2020-06-08T20:46:22Z", "message": "Do not attempt scheduling if Kube integrator is not ready or healthy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjIwOTU1", "url": "https://github.com/Netflix/titus-control-plane/pull/864#pullrequestreview-426620955", "createdAt": "2020-06-08T21:06:15Z", "commit": {"oid": "3510fff0abd387c11a6c4437cf50ba1fb7afc3c8"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMTowNjoxNlrOGgwaww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMTowOToyOFrOGgwgwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwMDg5OQ==", "bodyText": "minor: combine the if below into a single boolean logic operation (&&)", "url": "https://github.com/Netflix/titus-control-plane/pull/864#discussion_r437000899", "createdAt": "2020-06-08T21:06:16Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/batch/BatchDifferenceResolver.java", "diffHunk": "@@ -269,17 +269,19 @@ public BatchDifferenceResolver(\n         for (BatchJobTask refTask : tasks) {\n             BatchJobTask runningTask = runningJobView.getTaskById(refTask.getId());\n             if (JobFunctions.isOwnedByKubeScheduler(refTask)) {\n-                // TODO This complexity exists due to the way Fenzo is initialized on bootstrap. This code can be simplified one we move off Fenzo.\n-                if (runningTask == null || (refTask.getStatus().getState() == TaskState.Accepted && !TaskStatus.hasPod(refTask))) {\n-                    missingTasks.add(BasicTaskActions.launchTaskInKube(\n-                            kubeApiServerIntegrator,\n-                            configuration,\n-                            engine,\n-                            runningJobView.getJob(),\n-                            refTask,\n-                            RECONCILER_CALLMETADATA.toBuilder().withCallReason(\"Launching task in Kube\").build(),\n-                            titusRuntime\n-                    ));\n+                if (kubeApiServerIntegrator.isReadyForScheduling()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3510fff0abd387c11a6c4437cf50ba1fb7afc3c8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwMTE3Nw==", "bodyText": "even better, maybe consider extracting the boolean logic chain into a separate method/function", "url": "https://github.com/Netflix/titus-control-plane/pull/864#discussion_r437001177", "createdAt": "2020-06-08T21:06:53Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/batch/BatchDifferenceResolver.java", "diffHunk": "@@ -269,17 +269,19 @@ public BatchDifferenceResolver(\n         for (BatchJobTask refTask : tasks) {\n             BatchJobTask runningTask = runningJobView.getTaskById(refTask.getId());\n             if (JobFunctions.isOwnedByKubeScheduler(refTask)) {\n-                // TODO This complexity exists due to the way Fenzo is initialized on bootstrap. This code can be simplified one we move off Fenzo.\n-                if (runningTask == null || (refTask.getStatus().getState() == TaskState.Accepted && !TaskStatus.hasPod(refTask))) {\n-                    missingTasks.add(BasicTaskActions.launchTaskInKube(\n-                            kubeApiServerIntegrator,\n-                            configuration,\n-                            engine,\n-                            runningJobView.getJob(),\n-                            refTask,\n-                            RECONCILER_CALLMETADATA.toBuilder().withCallReason(\"Launching task in Kube\").build(),\n-                            titusRuntime\n-                    ));\n+                if (kubeApiServerIntegrator.isReadyForScheduling()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwMDg5OQ=="}, "originalCommit": {"oid": "3510fff0abd387c11a6c4437cf50ba1fb7afc3c8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwMjQzMg==", "bodyText": "typo s/Abi/Api/", "url": "https://github.com/Netflix/titus-control-plane/pull/864#discussion_r437002432", "createdAt": "2020-06-08T21:09:28Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/scheduler/TaskPlacementFailureClassifier.java", "diffHunk": "@@ -153,6 +155,23 @@ private boolean processNoActiveAgent(T taskRequest, List<TaskAssignmentResult> a\n         return true;\n     }\n \n+    private boolean processKubeAbiNotReady(T taskRequest, List<TaskAssignmentResult> assignmentResults,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3510fff0abd387c11a6c4437cf50ba1fb7afc3c8"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b27b876201f349ace33a7a08375b1d8235b1ebb", "author": {"user": {"login": "tbak", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/8b27b876201f349ace33a7a08375b1d8235b1ebb", "committedDate": "2020-06-08T21:29:05Z", "message": "Code review updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjM3NDEz", "url": "https://github.com/Netflix/titus-control-plane/pull/864#pullrequestreview-426637413", "createdAt": "2020-06-08T21:33:00Z", "commit": {"oid": "8b27b876201f349ace33a7a08375b1d8235b1ebb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 532, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}