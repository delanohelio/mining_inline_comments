{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NTU3NjQz", "number": 775, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMDoyOToxM1rODgAkQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMzozNzo0OFrODgC8EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0ODkwMzA3OnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFactory.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMDoyOToxM1rOFqCzrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMDozNjo0OVrOFqC-ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMDUxMQ==", "bodyText": "minor nit: first time I read the code, the name Factory implied to me that new instances would be returned for each call, since this is providing singletons (memoized instances), maybe rename this class to ...Provider, or ...Holder?", "url": "https://github.com/Netflix/titus-control-plane/pull/775#discussion_r379630511", "createdAt": "2020-02-14T20:29:13Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFactory.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.master.mesos.kubeapiserver.direct;\n+\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.titus.common.util.ExceptionExt;\n+import com.netflix.titus.common.util.guice.annotation.Deactivator;\n+import io.kubernetes.client.ApiClient;\n+import io.kubernetes.client.apis.CoreV1Api;\n+import io.kubernetes.client.informer.SharedIndexInformer;\n+import io.kubernetes.client.informer.SharedInformerFactory;\n+import io.kubernetes.client.models.V1Node;\n+import io.kubernetes.client.models.V1NodeList;\n+import io.kubernetes.client.models.V1Pod;\n+import io.kubernetes.client.models.V1PodList;\n+import io.kubernetes.client.util.CallGeneratorParams;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.netflix.titus.master.mesos.kubeapiserver.KubeUtil.createSharedInformerFactory;\n+\n+@Singleton\n+public class DefaultKubeApiFactory implements KubeApiFactory {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a242e90fabe2c580f77bb288910e194bba7f5221"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMjY5NQ==", "bodyText": "Provider would be better suffix, but it is used by Guice, and it would be confusing.\nI will try to find a better name.", "url": "https://github.com/Netflix/titus-control-plane/pull/775#discussion_r379632695", "createdAt": "2020-02-14T20:35:05Z", "author": {"login": "tbak"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFactory.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.master.mesos.kubeapiserver.direct;\n+\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.titus.common.util.ExceptionExt;\n+import com.netflix.titus.common.util.guice.annotation.Deactivator;\n+import io.kubernetes.client.ApiClient;\n+import io.kubernetes.client.apis.CoreV1Api;\n+import io.kubernetes.client.informer.SharedIndexInformer;\n+import io.kubernetes.client.informer.SharedInformerFactory;\n+import io.kubernetes.client.models.V1Node;\n+import io.kubernetes.client.models.V1NodeList;\n+import io.kubernetes.client.models.V1Pod;\n+import io.kubernetes.client.models.V1PodList;\n+import io.kubernetes.client.util.CallGeneratorParams;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.netflix.titus.master.mesos.kubeapiserver.KubeUtil.createSharedInformerFactory;\n+\n+@Singleton\n+public class DefaultKubeApiFactory implements KubeApiFactory {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMDUxMQ=="}, "originalCommit": {"oid": "a242e90fabe2c580f77bb288910e194bba7f5221"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMzMxMA==", "bodyText": "well, I already used ...Provider in some other places :-)", "url": "https://github.com/Netflix/titus-control-plane/pull/775#discussion_r379633310", "createdAt": "2020-02-14T20:36:49Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFactory.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.master.mesos.kubeapiserver.direct;\n+\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.titus.common.util.ExceptionExt;\n+import com.netflix.titus.common.util.guice.annotation.Deactivator;\n+import io.kubernetes.client.ApiClient;\n+import io.kubernetes.client.apis.CoreV1Api;\n+import io.kubernetes.client.informer.SharedIndexInformer;\n+import io.kubernetes.client.informer.SharedInformerFactory;\n+import io.kubernetes.client.models.V1Node;\n+import io.kubernetes.client.models.V1NodeList;\n+import io.kubernetes.client.models.V1Pod;\n+import io.kubernetes.client.models.V1PodList;\n+import io.kubernetes.client.util.CallGeneratorParams;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.netflix.titus.master.mesos.kubeapiserver.KubeUtil.createSharedInformerFactory;\n+\n+@Singleton\n+public class DefaultKubeApiFactory implements KubeApiFactory {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMDUxMQ=="}, "originalCommit": {"oid": "a242e90fabe2c580f77bb288910e194bba7f5221"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0OTA3NDg4OnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFacade.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMTozOTo0NlrOFqEa-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMjoxMzozMVrOFqFIjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1Njk1Mg==", "bodyText": "Since these are now centrally managed, would be nice to have gauges that show their current size.", "url": "https://github.com/Netflix/titus-control-plane/pull/775#discussion_r379656952", "createdAt": "2020-02-14T21:39:46Z", "author": {"login": "corindwyer"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFacade.java", "diffHunk": "@@ -119,8 +148,9 @@ private void activate() {\n                         apiClient\n                 );\n \n-                this.nodeInformer = createNodeInformer(sharedInformerFactory, coreV1Api);\n-                this.podInformer = createPodInformer(sharedInformerFactory, coreV1Api);\n+                this.nodeInformer = createNodeInformer(sharedInformerFactory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a9adaa37a2d2dbf95115bc3c881777e5efdca70"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2ODYyMQ==", "bodyText": "I am working on metrics in another PR. I will include this as well.", "url": "https://github.com/Netflix/titus-control-plane/pull/775#discussion_r379668621", "createdAt": "2020-02-14T22:13:31Z", "author": {"login": "tbak"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFacade.java", "diffHunk": "@@ -119,8 +148,9 @@ private void activate() {\n                         apiClient\n                 );\n \n-                this.nodeInformer = createNodeInformer(sharedInformerFactory, coreV1Api);\n-                this.podInformer = createPodInformer(sharedInformerFactory, coreV1Api);\n+                this.nodeInformer = createNodeInformer(sharedInformerFactory);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1Njk1Mg=="}, "originalCommit": {"oid": "5a9adaa37a2d2dbf95115bc3c881777e5efdca70"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0OTI4MjIxOnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFacade.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMzozMzozNFrOFqGZXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMzozMzozNFrOFqGZXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4OTMxMQ==", "bodyText": "you can drop this TODO, I wanted to use jackson instead of gson to get support for immutable POJOs, but it's not worth the effort", "url": "https://github.com/Netflix/titus-control-plane/pull/775#discussion_r379689311", "createdAt": "2020-02-14T23:33:34Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFacade.java", "diffHunk": "@@ -0,0 +1,243 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.master.mesos.kubeapiserver.direct;\n+\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.titus.common.runtime.TitusRuntime;\n+import com.netflix.titus.common.util.ExceptionExt;\n+import com.netflix.titus.common.util.guice.annotation.Deactivator;\n+import com.netflix.titus.master.mesos.kubeapiserver.model.v1.V1OpportunisticResource;\n+import com.netflix.titus.master.mesos.kubeapiserver.model.v1.V1OpportunisticResourceList;\n+import com.squareup.okhttp.Call;\n+import io.kubernetes.client.ApiClient;\n+import io.kubernetes.client.ApiException;\n+import io.kubernetes.client.apis.CoreV1Api;\n+import io.kubernetes.client.apis.CustomObjectsApi;\n+import io.kubernetes.client.informer.SharedIndexInformer;\n+import io.kubernetes.client.informer.SharedInformerFactory;\n+import io.kubernetes.client.models.V1Node;\n+import io.kubernetes.client.models.V1NodeList;\n+import io.kubernetes.client.models.V1Pod;\n+import io.kubernetes.client.models.V1PodList;\n+import io.kubernetes.client.util.CallGeneratorParams;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.netflix.titus.master.mesos.kubeapiserver.KubeUtil.createSharedInformerFactory;\n+\n+@Singleton\n+public class DefaultKubeApiFacade implements KubeApiFacade {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(DefaultKubeApiFacade.class);\n+\n+    private static final String KUBERNETES_NAMESPACE = \"default\";\n+\n+    private static final String OPPORTUNISTIC_RESOURCE_GROUP = \"titus.netflix.com\";\n+    private static final String OPPORTUNISTIC_RESOURCE_VERSION = \"v1\";\n+    private static final String OPPORTUNISTIC_RESOURCE_NAMESPACE = \"default\";\n+    private static final String OPPORTUNISTIC_RESOURCE_PLURAL = \"opportunistic-resources\";\n+\n+    private final DirectKubeConfiguration configuration;\n+\n+    private final ApiClient apiClient;\n+    private final CoreV1Api coreV1Api;\n+    private final CustomObjectsApi customObjectsApi;\n+    private final TitusRuntime titusRuntime;\n+\n+    private final Object activationLock = new Object();\n+\n+    private volatile SharedInformerFactory sharedInformerFactory;\n+    private volatile SharedIndexInformer<V1Node> nodeInformer;\n+    private volatile SharedIndexInformer<V1Pod> podInformer;\n+    private volatile SharedIndexInformer<V1OpportunisticResource> opportunisticResourceInformer;\n+\n+    private volatile boolean deactivated;\n+\n+    @Inject\n+    public DefaultKubeApiFacade(DirectKubeConfiguration configuration, ApiClient apiClient, TitusRuntime titusRuntime) {\n+        this.configuration = configuration;\n+        this.apiClient = apiClient;\n+        this.coreV1Api = new CoreV1Api(apiClient);\n+        this.customObjectsApi = new CustomObjectsApi(apiClient);\n+        this.titusRuntime = titusRuntime;\n+    }\n+\n+    @PreDestroy\n+    public void shutdown() {\n+        if (sharedInformerFactory != null) {\n+            sharedInformerFactory.stopAllRegisteredInformers();\n+        }\n+    }\n+\n+    @Deactivator\n+    public void deactivate() {\n+        if (!deactivated) {\n+            synchronized (activationLock) {\n+                shutdown();\n+                this.deactivated = true;\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public ApiClient getApiClient() {\n+        activate();\n+        return apiClient;\n+    }\n+\n+    @Override\n+    public CoreV1Api getCoreV1Api() {\n+        activate();\n+        return coreV1Api;\n+    }\n+\n+    @Override\n+    public CustomObjectsApi getCustomObjectsApi() {\n+        activate();\n+        return customObjectsApi;\n+    }\n+\n+    @Override\n+    public SharedIndexInformer<V1Node> getNodeInformer() {\n+        activate();\n+        return nodeInformer;\n+    }\n+\n+    @Override\n+    public SharedIndexInformer<V1Pod> getPodInformer() {\n+        activate();\n+        return podInformer;\n+    }\n+\n+    @Override\n+    public SharedIndexInformer<V1OpportunisticResource> getOpportunisticResourceInformer() {\n+        activate();\n+        return opportunisticResourceInformer;\n+    }\n+\n+    private void activate() {\n+        synchronized (activationLock) {\n+            if (deactivated) {\n+                throw new IllegalStateException(\"Deactivated\");\n+            }\n+\n+            if (sharedInformerFactory != null) {\n+                return;\n+            }\n+\n+            try {\n+                this.sharedInformerFactory = createSharedInformerFactory(\n+                        \"kube-api-server-integrator-shared-informer-\",\n+                        apiClient\n+                );\n+\n+                this.nodeInformer = createNodeInformer(sharedInformerFactory);\n+                this.podInformer = createPodInformer(sharedInformerFactory);\n+                this.opportunisticResourceInformer = createOpportunisticResourceInformer(sharedInformerFactory);\n+\n+                sharedInformerFactory.startAllRegisteredInformers();\n+\n+                logger.info(\"Kube node and pod informers activated\");\n+            } catch (Exception e) {\n+                logger.error(\"Could not initialize Kube client shared informer\", e);\n+                if (sharedInformerFactory != null) {\n+                    ExceptionExt.silent(() -> sharedInformerFactory.stopAllRegisteredInformers());\n+                }\n+                sharedInformerFactory = null;\n+                nodeInformer = null;\n+                podInformer = null;\n+                throw e;\n+            }\n+        }\n+    }\n+\n+    private SharedIndexInformer<V1Node> createNodeInformer(SharedInformerFactory sharedInformerFactory) {\n+        return sharedInformerFactory.sharedIndexInformerFor(\n+                (CallGeneratorParams params) -> coreV1Api.listNodeCall(\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        params.resourceVersion,\n+                        params.timeoutSeconds,\n+                        params.watch,\n+                        null,\n+                        null),\n+                V1Node.class,\n+                V1NodeList.class,\n+                configuration.getKubeApiServerIntegratorRefreshIntervalMs()\n+        );\n+    }\n+\n+    private SharedIndexInformer<V1Pod> createPodInformer(SharedInformerFactory sharedInformerFactory) {\n+        return sharedInformerFactory.sharedIndexInformerFor(\n+                (CallGeneratorParams params) -> coreV1Api.listNamespacedPodCall(\n+                        KUBERNETES_NAMESPACE,\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        params.resourceVersion,\n+                        params.timeoutSeconds,\n+                        params.watch,\n+                        null,\n+                        null\n+                ),\n+                V1Pod.class,\n+                V1PodList.class,\n+                configuration.getKubeApiServerIntegratorRefreshIntervalMs()\n+        );\n+    }\n+\n+    private SharedIndexInformer<V1OpportunisticResource> createOpportunisticResourceInformer(SharedInformerFactory sharedInformerFactory) {\n+        // TODO(fabio): enhance the kube client to support custom JSON deserialization options", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a9adaa37a2d2dbf95115bc3c881777e5efdca70"}, "originalPosition": 212}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0OTI5MTY5OnYy", "diffSide": "RIGHT", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFacade.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMzozNzo0OFrOFqGeBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMzo0MjoyNFrOFqGi0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5MDUwMw==", "bodyText": "probably safe to remove this try catch now and the return null below", "url": "https://github.com/Netflix/titus-control-plane/pull/775#discussion_r379690503", "createdAt": "2020-02-14T23:37:48Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFacade.java", "diffHunk": "@@ -0,0 +1,243 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.master.mesos.kubeapiserver.direct;\n+\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.titus.common.runtime.TitusRuntime;\n+import com.netflix.titus.common.util.ExceptionExt;\n+import com.netflix.titus.common.util.guice.annotation.Deactivator;\n+import com.netflix.titus.master.mesos.kubeapiserver.model.v1.V1OpportunisticResource;\n+import com.netflix.titus.master.mesos.kubeapiserver.model.v1.V1OpportunisticResourceList;\n+import com.squareup.okhttp.Call;\n+import io.kubernetes.client.ApiClient;\n+import io.kubernetes.client.ApiException;\n+import io.kubernetes.client.apis.CoreV1Api;\n+import io.kubernetes.client.apis.CustomObjectsApi;\n+import io.kubernetes.client.informer.SharedIndexInformer;\n+import io.kubernetes.client.informer.SharedInformerFactory;\n+import io.kubernetes.client.models.V1Node;\n+import io.kubernetes.client.models.V1NodeList;\n+import io.kubernetes.client.models.V1Pod;\n+import io.kubernetes.client.models.V1PodList;\n+import io.kubernetes.client.util.CallGeneratorParams;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.netflix.titus.master.mesos.kubeapiserver.KubeUtil.createSharedInformerFactory;\n+\n+@Singleton\n+public class DefaultKubeApiFacade implements KubeApiFacade {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(DefaultKubeApiFacade.class);\n+\n+    private static final String KUBERNETES_NAMESPACE = \"default\";\n+\n+    private static final String OPPORTUNISTIC_RESOURCE_GROUP = \"titus.netflix.com\";\n+    private static final String OPPORTUNISTIC_RESOURCE_VERSION = \"v1\";\n+    private static final String OPPORTUNISTIC_RESOURCE_NAMESPACE = \"default\";\n+    private static final String OPPORTUNISTIC_RESOURCE_PLURAL = \"opportunistic-resources\";\n+\n+    private final DirectKubeConfiguration configuration;\n+\n+    private final ApiClient apiClient;\n+    private final CoreV1Api coreV1Api;\n+    private final CustomObjectsApi customObjectsApi;\n+    private final TitusRuntime titusRuntime;\n+\n+    private final Object activationLock = new Object();\n+\n+    private volatile SharedInformerFactory sharedInformerFactory;\n+    private volatile SharedIndexInformer<V1Node> nodeInformer;\n+    private volatile SharedIndexInformer<V1Pod> podInformer;\n+    private volatile SharedIndexInformer<V1OpportunisticResource> opportunisticResourceInformer;\n+\n+    private volatile boolean deactivated;\n+\n+    @Inject\n+    public DefaultKubeApiFacade(DirectKubeConfiguration configuration, ApiClient apiClient, TitusRuntime titusRuntime) {\n+        this.configuration = configuration;\n+        this.apiClient = apiClient;\n+        this.coreV1Api = new CoreV1Api(apiClient);\n+        this.customObjectsApi = new CustomObjectsApi(apiClient);\n+        this.titusRuntime = titusRuntime;\n+    }\n+\n+    @PreDestroy\n+    public void shutdown() {\n+        if (sharedInformerFactory != null) {\n+            sharedInformerFactory.stopAllRegisteredInformers();\n+        }\n+    }\n+\n+    @Deactivator\n+    public void deactivate() {\n+        if (!deactivated) {\n+            synchronized (activationLock) {\n+                shutdown();\n+                this.deactivated = true;\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public ApiClient getApiClient() {\n+        activate();\n+        return apiClient;\n+    }\n+\n+    @Override\n+    public CoreV1Api getCoreV1Api() {\n+        activate();\n+        return coreV1Api;\n+    }\n+\n+    @Override\n+    public CustomObjectsApi getCustomObjectsApi() {\n+        activate();\n+        return customObjectsApi;\n+    }\n+\n+    @Override\n+    public SharedIndexInformer<V1Node> getNodeInformer() {\n+        activate();\n+        return nodeInformer;\n+    }\n+\n+    @Override\n+    public SharedIndexInformer<V1Pod> getPodInformer() {\n+        activate();\n+        return podInformer;\n+    }\n+\n+    @Override\n+    public SharedIndexInformer<V1OpportunisticResource> getOpportunisticResourceInformer() {\n+        activate();\n+        return opportunisticResourceInformer;\n+    }\n+\n+    private void activate() {\n+        synchronized (activationLock) {\n+            if (deactivated) {\n+                throw new IllegalStateException(\"Deactivated\");\n+            }\n+\n+            if (sharedInformerFactory != null) {\n+                return;\n+            }\n+\n+            try {\n+                this.sharedInformerFactory = createSharedInformerFactory(\n+                        \"kube-api-server-integrator-shared-informer-\",\n+                        apiClient\n+                );\n+\n+                this.nodeInformer = createNodeInformer(sharedInformerFactory);\n+                this.podInformer = createPodInformer(sharedInformerFactory);\n+                this.opportunisticResourceInformer = createOpportunisticResourceInformer(sharedInformerFactory);\n+\n+                sharedInformerFactory.startAllRegisteredInformers();\n+\n+                logger.info(\"Kube node and pod informers activated\");\n+            } catch (Exception e) {\n+                logger.error(\"Could not initialize Kube client shared informer\", e);\n+                if (sharedInformerFactory != null) {\n+                    ExceptionExt.silent(() -> sharedInformerFactory.stopAllRegisteredInformers());\n+                }\n+                sharedInformerFactory = null;\n+                nodeInformer = null;\n+                podInformer = null;\n+                throw e;\n+            }\n+        }\n+    }\n+\n+    private SharedIndexInformer<V1Node> createNodeInformer(SharedInformerFactory sharedInformerFactory) {\n+        return sharedInformerFactory.sharedIndexInformerFor(\n+                (CallGeneratorParams params) -> coreV1Api.listNodeCall(\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        params.resourceVersion,\n+                        params.timeoutSeconds,\n+                        params.watch,\n+                        null,\n+                        null),\n+                V1Node.class,\n+                V1NodeList.class,\n+                configuration.getKubeApiServerIntegratorRefreshIntervalMs()\n+        );\n+    }\n+\n+    private SharedIndexInformer<V1Pod> createPodInformer(SharedInformerFactory sharedInformerFactory) {\n+        return sharedInformerFactory.sharedIndexInformerFor(\n+                (CallGeneratorParams params) -> coreV1Api.listNamespacedPodCall(\n+                        KUBERNETES_NAMESPACE,\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        params.resourceVersion,\n+                        params.timeoutSeconds,\n+                        params.watch,\n+                        null,\n+                        null\n+                ),\n+                V1Pod.class,\n+                V1PodList.class,\n+                configuration.getKubeApiServerIntegratorRefreshIntervalMs()\n+        );\n+    }\n+\n+    private SharedIndexInformer<V1OpportunisticResource> createOpportunisticResourceInformer(SharedInformerFactory sharedInformerFactory) {\n+        // TODO(fabio): enhance the kube client to support custom JSON deserialization options\n+        return sharedInformerFactory.sharedIndexInformerFor(\n+                this::listOpportunisticResourcesCall,\n+                V1OpportunisticResource.class,\n+                V1OpportunisticResourceList.class,\n+                configuration.getKubeOpportunisticRefreshIntervalMs()\n+        );\n+    }\n+\n+    private Call listOpportunisticResourcesCall(CallGeneratorParams params) {\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a9adaa37a2d2dbf95115bc3c881777e5efdca70"}, "originalPosition": 222}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5MTczMQ==", "bodyText": "This method throws checked exception. Wrapping it with IllegalStateException", "url": "https://github.com/Netflix/titus-control-plane/pull/775#discussion_r379691731", "createdAt": "2020-02-14T23:42:24Z", "author": {"login": "tbak"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultKubeApiFacade.java", "diffHunk": "@@ -0,0 +1,243 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.master.mesos.kubeapiserver.direct;\n+\n+import javax.annotation.PreDestroy;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.titus.common.runtime.TitusRuntime;\n+import com.netflix.titus.common.util.ExceptionExt;\n+import com.netflix.titus.common.util.guice.annotation.Deactivator;\n+import com.netflix.titus.master.mesos.kubeapiserver.model.v1.V1OpportunisticResource;\n+import com.netflix.titus.master.mesos.kubeapiserver.model.v1.V1OpportunisticResourceList;\n+import com.squareup.okhttp.Call;\n+import io.kubernetes.client.ApiClient;\n+import io.kubernetes.client.ApiException;\n+import io.kubernetes.client.apis.CoreV1Api;\n+import io.kubernetes.client.apis.CustomObjectsApi;\n+import io.kubernetes.client.informer.SharedIndexInformer;\n+import io.kubernetes.client.informer.SharedInformerFactory;\n+import io.kubernetes.client.models.V1Node;\n+import io.kubernetes.client.models.V1NodeList;\n+import io.kubernetes.client.models.V1Pod;\n+import io.kubernetes.client.models.V1PodList;\n+import io.kubernetes.client.util.CallGeneratorParams;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static com.netflix.titus.master.mesos.kubeapiserver.KubeUtil.createSharedInformerFactory;\n+\n+@Singleton\n+public class DefaultKubeApiFacade implements KubeApiFacade {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(DefaultKubeApiFacade.class);\n+\n+    private static final String KUBERNETES_NAMESPACE = \"default\";\n+\n+    private static final String OPPORTUNISTIC_RESOURCE_GROUP = \"titus.netflix.com\";\n+    private static final String OPPORTUNISTIC_RESOURCE_VERSION = \"v1\";\n+    private static final String OPPORTUNISTIC_RESOURCE_NAMESPACE = \"default\";\n+    private static final String OPPORTUNISTIC_RESOURCE_PLURAL = \"opportunistic-resources\";\n+\n+    private final DirectKubeConfiguration configuration;\n+\n+    private final ApiClient apiClient;\n+    private final CoreV1Api coreV1Api;\n+    private final CustomObjectsApi customObjectsApi;\n+    private final TitusRuntime titusRuntime;\n+\n+    private final Object activationLock = new Object();\n+\n+    private volatile SharedInformerFactory sharedInformerFactory;\n+    private volatile SharedIndexInformer<V1Node> nodeInformer;\n+    private volatile SharedIndexInformer<V1Pod> podInformer;\n+    private volatile SharedIndexInformer<V1OpportunisticResource> opportunisticResourceInformer;\n+\n+    private volatile boolean deactivated;\n+\n+    @Inject\n+    public DefaultKubeApiFacade(DirectKubeConfiguration configuration, ApiClient apiClient, TitusRuntime titusRuntime) {\n+        this.configuration = configuration;\n+        this.apiClient = apiClient;\n+        this.coreV1Api = new CoreV1Api(apiClient);\n+        this.customObjectsApi = new CustomObjectsApi(apiClient);\n+        this.titusRuntime = titusRuntime;\n+    }\n+\n+    @PreDestroy\n+    public void shutdown() {\n+        if (sharedInformerFactory != null) {\n+            sharedInformerFactory.stopAllRegisteredInformers();\n+        }\n+    }\n+\n+    @Deactivator\n+    public void deactivate() {\n+        if (!deactivated) {\n+            synchronized (activationLock) {\n+                shutdown();\n+                this.deactivated = true;\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public ApiClient getApiClient() {\n+        activate();\n+        return apiClient;\n+    }\n+\n+    @Override\n+    public CoreV1Api getCoreV1Api() {\n+        activate();\n+        return coreV1Api;\n+    }\n+\n+    @Override\n+    public CustomObjectsApi getCustomObjectsApi() {\n+        activate();\n+        return customObjectsApi;\n+    }\n+\n+    @Override\n+    public SharedIndexInformer<V1Node> getNodeInformer() {\n+        activate();\n+        return nodeInformer;\n+    }\n+\n+    @Override\n+    public SharedIndexInformer<V1Pod> getPodInformer() {\n+        activate();\n+        return podInformer;\n+    }\n+\n+    @Override\n+    public SharedIndexInformer<V1OpportunisticResource> getOpportunisticResourceInformer() {\n+        activate();\n+        return opportunisticResourceInformer;\n+    }\n+\n+    private void activate() {\n+        synchronized (activationLock) {\n+            if (deactivated) {\n+                throw new IllegalStateException(\"Deactivated\");\n+            }\n+\n+            if (sharedInformerFactory != null) {\n+                return;\n+            }\n+\n+            try {\n+                this.sharedInformerFactory = createSharedInformerFactory(\n+                        \"kube-api-server-integrator-shared-informer-\",\n+                        apiClient\n+                );\n+\n+                this.nodeInformer = createNodeInformer(sharedInformerFactory);\n+                this.podInformer = createPodInformer(sharedInformerFactory);\n+                this.opportunisticResourceInformer = createOpportunisticResourceInformer(sharedInformerFactory);\n+\n+                sharedInformerFactory.startAllRegisteredInformers();\n+\n+                logger.info(\"Kube node and pod informers activated\");\n+            } catch (Exception e) {\n+                logger.error(\"Could not initialize Kube client shared informer\", e);\n+                if (sharedInformerFactory != null) {\n+                    ExceptionExt.silent(() -> sharedInformerFactory.stopAllRegisteredInformers());\n+                }\n+                sharedInformerFactory = null;\n+                nodeInformer = null;\n+                podInformer = null;\n+                throw e;\n+            }\n+        }\n+    }\n+\n+    private SharedIndexInformer<V1Node> createNodeInformer(SharedInformerFactory sharedInformerFactory) {\n+        return sharedInformerFactory.sharedIndexInformerFor(\n+                (CallGeneratorParams params) -> coreV1Api.listNodeCall(\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        params.resourceVersion,\n+                        params.timeoutSeconds,\n+                        params.watch,\n+                        null,\n+                        null),\n+                V1Node.class,\n+                V1NodeList.class,\n+                configuration.getKubeApiServerIntegratorRefreshIntervalMs()\n+        );\n+    }\n+\n+    private SharedIndexInformer<V1Pod> createPodInformer(SharedInformerFactory sharedInformerFactory) {\n+        return sharedInformerFactory.sharedIndexInformerFor(\n+                (CallGeneratorParams params) -> coreV1Api.listNamespacedPodCall(\n+                        KUBERNETES_NAMESPACE,\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        null,\n+                        params.resourceVersion,\n+                        params.timeoutSeconds,\n+                        params.watch,\n+                        null,\n+                        null\n+                ),\n+                V1Pod.class,\n+                V1PodList.class,\n+                configuration.getKubeApiServerIntegratorRefreshIntervalMs()\n+        );\n+    }\n+\n+    private SharedIndexInformer<V1OpportunisticResource> createOpportunisticResourceInformer(SharedInformerFactory sharedInformerFactory) {\n+        // TODO(fabio): enhance the kube client to support custom JSON deserialization options\n+        return sharedInformerFactory.sharedIndexInformerFor(\n+                this::listOpportunisticResourcesCall,\n+                V1OpportunisticResource.class,\n+                V1OpportunisticResourceList.class,\n+                configuration.getKubeOpportunisticRefreshIntervalMs()\n+        );\n+    }\n+\n+    private Call listOpportunisticResourcesCall(CallGeneratorParams params) {\n+        try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5MDUwMw=="}, "originalCommit": {"oid": "5a9adaa37a2d2dbf95115bc3c881777e5efdca70"}, "originalPosition": 222}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4056, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}