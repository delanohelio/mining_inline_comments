{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyMjgxNjQ5", "number": 964, "title": "TITUS-4588 Add support for EBS persistent volume claims", "bodyText": "This PR changes how EBS persistent volumes are being used. Persistent volumes directly specify the CSI driver rather than the legacy AWS block store and expecting Kube CSI migration to do the mapping. Also, Persistent volume claims are used rather than the specifying the persistent volume directly on the pod.", "createdAt": "2020-12-18T04:36:42Z", "url": "https://github.com/Netflix/titus-control-plane/pull/964", "merged": true, "mergeCommit": {"oid": "a730647a0d3e909702b6885226ffd0645e628cf9"}, "closed": true, "closedAt": "2020-12-19T00:35:22Z", "author": {"login": "andrew-leung"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnQfGeAH2gAyNTQyMjgxNjQ5OjUxMjI1NDJjNmRkZDgzZTMxOWQyMzY4MjY3NTE1MDhkYzQ4NzQ0ZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnhVcJAH2gAyNTQyMjgxNjQ5OmRlM2Q3M2ZjOGJiMjUzZjU2N2ZmMmVhMWU5ZjMxMGQwMmZmYTdjY2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5122542c6ddd83e319d236826751508dc48744e1", "author": {"user": {"login": "andrew-leung", "name": "Andrew Leung"}}, "url": "https://github.com/Netflix/titus-control-plane/commit/5122542c6ddd83e319d236826751508dc48744e1", "committedDate": "2020-12-18T04:32:44Z", "message": "TITUS-4588 Add support for EBS persistent volume claims"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NzcxNTUx", "url": "https://github.com/Netflix/titus-control-plane/pull/964#pullrequestreview-555771551", "createdAt": "2020-12-18T19:48:05Z", "commit": {"oid": "5122542c6ddd83e319d236826751508dc48744e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1ODM3ODYy", "url": "https://github.com/Netflix/titus-control-plane/pull/964#pullrequestreview-555837862", "createdAt": "2020-12-18T21:57:20Z", "commit": {"oid": "5122542c6ddd83e319d236826751508dc48744e1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMTo1NzoyMVrOIIz53A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMTo1NzoyMVrOIIz53A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwOTkxNg==", "bodyText": "This is just grace period seconds. Any idea why it was 1 before?", "url": "https://github.com/Netflix/titus-control-plane/pull/964#discussion_r546109916", "createdAt": "2020-12-18T21:57:21Z", "author": {"login": "solarkennedy"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/kubernetes/controller/PersistentVolumeUnassociatedGcController.java", "diffHunk": "@@ -97,13 +98,26 @@ public boolean shouldGc() {\n \n     @Override\n     public boolean gcItem(V1PersistentVolume pv) {\n+        // Delete the volume's PVC first\n+        if (!gcPersistentVolumeClaim(pv)) {\n+            // If we cannot delete the PVC then we did not successfully GC the volume.\n+            // The PVC and PV will be part of a subsequent GC iteration.\n+            return false;\n+        }\n+        return gcPersistentVolume(pv);\n+    }\n+\n+    private boolean gcPersistentVolume(V1PersistentVolume pv) {\n         String volumeName = KubeUtil.getMetadataName(pv.getMetadata());\n         try {\n+            // If the PV is deleted while still associated with a PVC (though that is not expected), the PV\n+            // will not be removed until it is no longer bound to a PVC.\n+            // https://kubernetes.io/docs/concepts/storage/persistent-volumes/#storage-object-in-use-protection\n             kubeApiFacade.getCoreV1Api().deletePersistentVolume(\n                     volumeName,\n                     null,\n                     null,\n-                    1,\n+                    0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5122542c6ddd83e319d236826751508dc48744e1"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1ODgwNTA1", "url": "https://github.com/Netflix/titus-control-plane/pull/964#pullrequestreview-555880505", "createdAt": "2020-12-18T23:41:22Z", "commit": {"oid": "5122542c6ddd83e319d236826751508dc48744e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMzo0MToyMlrOII2NfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMzo0MToyMlrOII2NfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0NzcwOA==", "bodyText": "return true when it is not found in the catch(ApiException) block?", "url": "https://github.com/Netflix/titus-control-plane/pull/964#discussion_r546147708", "createdAt": "2020-12-18T23:41:22Z", "author": {"login": "joshi-keyur"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/kubernetes/controller/PersistentVolumeUnassociatedGcController.java", "diffHunk": "@@ -120,6 +134,38 @@ public boolean gcItem(V1PersistentVolume pv) {\n         return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5122542c6ddd83e319d236826751508dc48744e1"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1ODg0MzI3", "url": "https://github.com/Netflix/titus-control-plane/pull/964#pullrequestreview-555884327", "createdAt": "2020-12-18T23:47:08Z", "commit": {"oid": "5122542c6ddd83e319d236826751508dc48744e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de3d73fc8bb253f567ff2ea1e9f310d02ffa7ccb", "author": {"user": {"login": "andrew-leung", "name": "Andrew Leung"}}, "url": "https://github.com/Netflix/titus-control-plane/commit/de3d73fc8bb253f567ff2ea1e9f310d02ffa7ccb", "committedDate": "2020-12-19T00:10:34Z", "message": "Consider gc of non existent PV success"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 479, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}