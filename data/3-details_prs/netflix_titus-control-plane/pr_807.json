{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3NDk1MjA4", "number": 807, "title": "Support Kube scheduler zone balancing", "bodyText": "", "createdAt": "2020-03-12T21:57:59Z", "url": "https://github.com/Netflix/titus-control-plane/pull/807", "merged": true, "mergeCommit": {"oid": "8a244a9eb527ca112543e0c00bbc7ff2e6903eb2"}, "closed": true, "closedAt": "2020-03-12T23:33:20Z", "author": {"login": "tbak"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNDt10gFqTM3Mzk0Nzg3Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNEKomABqjMxMjQ4Nzk2NjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczOTQ3ODcy", "url": "https://github.com/Netflix/titus-control-plane/pull/807#pullrequestreview-373947872", "createdAt": "2020-03-12T22:43:10Z", "commit": {"oid": "3e5cf7916b19bbdc515e223ec5c69bed12d37942"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMjo0MzoxMFrOF1yXeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMjo0NDozMlrOF1yZCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NDA1OA==", "bodyText": "minor: configurable", "url": "https://github.com/Netflix/titus-control-plane/pull/807#discussion_r391944058", "createdAt": "2020-03-12T22:43:10Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultTaskToPodConverter.java", "diffHunk": "@@ -81,6 +84,12 @@\n     private static final String ARN_SUFFIX = \":role/\";\n     private static final Pattern IAM_PROFILE_RE = Pattern.compile(ARN_PREFIX + \"(\\\\d+)\" + ARN_SUFFIX + \"\\\\S+\");\n \n+    /**\n+     * Max allowed skew for zone load balancing as a soft constraint. As we do not want to prevent placement in any\n+     * case, it must be >= max job size.\n+     */\n+    private static final int SOFT_MAX_SKEW = 100_000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e5cf7916b19bbdc515e223ec5c69bed12d37942"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NDQ1OA==", "bodyText": "nice \ud83d\udc4f", "url": "https://github.com/Netflix/titus-control-plane/pull/807#discussion_r391944458", "createdAt": "2020-03-12T22:44:32Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultTaskToPodConverter.java", "diffHunk": "@@ -331,4 +341,24 @@ private void setJobAcceptedTimestamp(TitanProtos.ContainerInfo.Builder container\n                 .build()\n         ).collect(Collectors.toList());\n     }\n+\n+    private List<V1TopologySpreadConstraint> buildTopologySpreadConstraints(Job<?> job) {\n+        boolean hard = Boolean.parseBoolean(job.getJobDescriptor().getContainer().getHardConstraints().get(JobConstraints.ZONE_BALANCE));\n+        boolean soft = Boolean.parseBoolean(job.getJobDescriptor().getContainer().getSoftConstraints().get(JobConstraints.ZONE_BALANCE));\n+        if (!hard && !soft) {\n+            return Collections.emptyList();\n+        }\n+\n+        V1TopologySpreadConstraint constraint = new V1TopologySpreadConstraint()\n+                .topologyKey(KubeConstants.NODE_LABEL_ZONE)\n+                .labelSelector(new V1LabelSelector().matchLabels(Collections.singletonMap(KubeConstants.POD_LABEL_JOB_ID, job.getId())));\n+\n+        if (hard) {\n+            constraint.maxSkew(1).whenUnsatisfiable(\"DoNotSchedule\");\n+        } else {\n+            constraint.maxSkew(SOFT_MAX_SKEW).whenUnsatisfiable(\"ScheduleAnyway\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e5cf7916b19bbdc515e223ec5c69bed12d37942"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczOTUwNTE4", "url": "https://github.com/Netflix/titus-control-plane/pull/807#pullrequestreview-373950518", "createdAt": "2020-03-12T22:50:34Z", "commit": {"oid": "3e5cf7916b19bbdc515e223ec5c69bed12d37942"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "214f2bfc9aea7901aee3ff1ac31089ff9d3ee06e", "author": {"user": {"login": "tbak", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/214f2bfc9aea7901aee3ff1ac31089ff9d3ee06e", "committedDate": "2020-03-12T23:07:39Z", "message": "Support Kube scheduler zone balancing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51515835260fd2cd9aa8e4d96027603e76176fb6", "author": {"user": {"login": "tbak", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/51515835260fd2cd9aa8e4d96027603e76176fb6", "committedDate": "2020-03-12T23:17:59Z", "message": "Dependency lock update"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e5cf7916b19bbdc515e223ec5c69bed12d37942", "author": {"user": {"login": "tbak", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/3e5cf7916b19bbdc515e223ec5c69bed12d37942", "committedDate": "2020-03-12T21:57:34Z", "message": "Support Kube scheduler zone balancing"}, "afterCommit": {"oid": "51515835260fd2cd9aa8e4d96027603e76176fb6", "author": {"user": {"login": "tbak", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/51515835260fd2cd9aa8e4d96027603e76176fb6", "committedDate": "2020-03-12T23:17:59Z", "message": "Dependency lock update"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 663, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}