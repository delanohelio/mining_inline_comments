{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2Mjk1MjQ0", "number": 875, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODowNzoyNlrOEG29Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoyODo0MFrOEHMHOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NjI3MzEwOnYy", "diffSide": "RIGHT", "path": "titus-api/src/main/java/com/netflix/titus/api/FeatureRolloutPlans.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODowNzoyNlrOGl6k0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODowNzoyNlrOGl6k0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQxMDE5Mg==", "bodyText": "Isn't account/subnets configuration the same feature?", "url": "https://github.com/Netflix/titus-control-plane/pull/875#discussion_r442410192", "createdAt": "2020-06-18T18:07:26Z", "author": {"login": "tbak"}, "path": "titus-api/src/main/java/com/netflix/titus/api/FeatureRolloutPlans.java", "diffHunk": "@@ -76,4 +76,19 @@\n             description = \"Integrate Kube scheduler\"\n     )\n     String KUBE_SCHEDULER_FEATURE = \"kubeSchedulerFeature\";\n+\n+    @FeatureRollout(\n+            featureId = \"accountId\",\n+            deadline = \"10/01/2020\",\n+            description = \"Jobs should explicity provide AWS accountId the container should launch in\"\n+    )\n+    String CONTAINER_ACCOUNT_ID_REQUIRED_FEATURE = \"accountId\";\n+\n+    @FeatureRollout(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93758795dd6d01f039cf1a479627be58aa7a504d"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NjI4MTQwOnYy", "diffSide": "RIGHT", "path": "titus-server-gateway/src/main/java/com/netflix/titus/gateway/service/v3/internal/ExtendedJobSanitizer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODoxMDowMVrOGl6qJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODoxMDowMVrOGl6qJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQxMTU1OA==", "bodyText": "What if a user sets an account id (non-default), but not subnets?  Setting default subnets will be incorrect.\nI think we should validate/set this data together, as they must be mutually consistent.", "url": "https://github.com/Netflix/titus-control-plane/pull/875#discussion_r442411558", "createdAt": "2020-06-18T18:10:01Z", "author": {"login": "tbak"}, "path": "titus-server-gateway/src/main/java/com/netflix/titus/gateway/service/v3/internal/ExtendedJobSanitizer.java", "diffHunk": "@@ -151,6 +157,26 @@ public ExtendedJobSanitizer(JobManagerConfiguration jobManagerConfiguration,\n                 }\n             });\n \n+            Map<String, String> defaultContainerAttributes = new HashMap<>();\n+            violations.findViolation(CONTAINER_ACCOUNT_ID_REQUIRED_FEATURE).ifPresent(nonCompliance -> {\n+                if (!StringExt.isEmpty(jobManagerConfiguration.getDefaultContainerAccountId())) {\n+                    defaultContainerAttributes.put(JobAttributes.JOB_CONTAINER_ATTRIBUTE_ACCOUNT_ID, jobManagerConfiguration.getDefaultContainerAccountId());\n+                }\n+            });\n+            violations.findViolation(SUBNETS_REQUIRED_FEATURE).ifPresent(nonCompliance -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93758795dd6d01f039cf1a479627be58aa7a504d"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTczOTQ2OnYy", "diffSide": "RIGHT", "path": "titus-server-gateway/src/main/java/com/netflix/titus/gateway/service/v3/internal/JobFeatureComplianceChecks.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoyODo0MFrOGmcV5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzozMjo0MlrOGmccag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2MzQyOA==", "bodyText": "If I understand it correctly, setting accontId parameter to the default account id is non-compliant?", "url": "https://github.com/Netflix/titus-control-plane/pull/875#discussion_r442963428", "createdAt": "2020-06-19T17:28:40Z", "author": {"login": "tbak"}, "path": "titus-server-gateway/src/main/java/com/netflix/titus/gateway/service/v3/internal/JobFeatureComplianceChecks.java", "diffHunk": "@@ -106,6 +111,39 @@\n         };\n     }\n \n+    /**\n+     * A feature compliance is violated if there is a default accountId and subnets combination present in the {@link JobManagerConfiguration} for the deployment stack\n+     * but the container attributes in the {@link JobDescriptor} are missing one or both values.\n+     * @param jobManagerConfiguration {@link JobManagerConfiguration}\n+     * @return feature compliance evaluation\n+     */\n+    static FeatureCompliance<JobDescriptor<?>> missingContainerAccountIdAndSubnets(JobManagerConfiguration jobManagerConfiguration) {\n+        return jobDescriptor -> {\n+            String defaultAccountId = jobManagerConfiguration.getDefaultContainerAccountId();\n+            String defaultSubnets = jobManagerConfiguration.getDefaultSubnets();\n+            // Ignore this compliance check unless both default accountId and subnet configuration properties are set implying our\n+            // intent to aid the job descriptor sanitization\n+            if (StringExt.isEmpty(defaultAccountId) || StringExt.isEmpty(defaultSubnets)) {\n+                return Optional.empty();\n+            }\n+\n+            String accountIdContainerAttribute = jobDescriptor.getContainer().getAttributes().get(JOB_CONTAINER_ATTRIBUTE_ACCOUNT_ID);\n+            String subnetContainerAttribute = jobDescriptor.getContainer().getAttributes().get(JOB_CONTAINER_ATTRIBUTE_SUBNETS);\n+\n+            // Feature compliance is violated if either (i) both attributes are not set, or (ii) accountId is set to the default value but the subnets value is not set.\n+            // In either case, we should take action in response to this violation.\n+            if ((StringExt.isEmpty(accountIdContainerAttribute) || defaultAccountId.equals(accountIdContainerAttribute)) && StringExt.isEmpty(subnetContainerAttribute)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85f169b7db4dcfba887f119039af538667896963"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2NTA5OA==", "bodyText": "Non compliant if:\n(1). default account_id and subnets are set in the configuration (expected for the stack),\nAND\n(2a). account_id and subnets are empty in the job descriptor, OR\n(2b). account_id is set to the default account_id but subnets is not set in the job descriptor\nAll other cases are given a pass under current/default behavior.", "url": "https://github.com/Netflix/titus-control-plane/pull/875#discussion_r442965098", "createdAt": "2020-06-19T17:32:42Z", "author": {"login": "joshi-keyur"}, "path": "titus-server-gateway/src/main/java/com/netflix/titus/gateway/service/v3/internal/JobFeatureComplianceChecks.java", "diffHunk": "@@ -106,6 +111,39 @@\n         };\n     }\n \n+    /**\n+     * A feature compliance is violated if there is a default accountId and subnets combination present in the {@link JobManagerConfiguration} for the deployment stack\n+     * but the container attributes in the {@link JobDescriptor} are missing one or both values.\n+     * @param jobManagerConfiguration {@link JobManagerConfiguration}\n+     * @return feature compliance evaluation\n+     */\n+    static FeatureCompliance<JobDescriptor<?>> missingContainerAccountIdAndSubnets(JobManagerConfiguration jobManagerConfiguration) {\n+        return jobDescriptor -> {\n+            String defaultAccountId = jobManagerConfiguration.getDefaultContainerAccountId();\n+            String defaultSubnets = jobManagerConfiguration.getDefaultSubnets();\n+            // Ignore this compliance check unless both default accountId and subnet configuration properties are set implying our\n+            // intent to aid the job descriptor sanitization\n+            if (StringExt.isEmpty(defaultAccountId) || StringExt.isEmpty(defaultSubnets)) {\n+                return Optional.empty();\n+            }\n+\n+            String accountIdContainerAttribute = jobDescriptor.getContainer().getAttributes().get(JOB_CONTAINER_ATTRIBUTE_ACCOUNT_ID);\n+            String subnetContainerAttribute = jobDescriptor.getContainer().getAttributes().get(JOB_CONTAINER_ATTRIBUTE_SUBNETS);\n+\n+            // Feature compliance is violated if either (i) both attributes are not set, or (ii) accountId is set to the default value but the subnets value is not set.\n+            // In either case, we should take action in response to this violation.\n+            if ((StringExt.isEmpty(accountIdContainerAttribute) || defaultAccountId.equals(accountIdContainerAttribute)) && StringExt.isEmpty(subnetContainerAttribute)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2MzQyOA=="}, "originalCommit": {"oid": "85f169b7db4dcfba887f119039af538667896963"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3979, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}