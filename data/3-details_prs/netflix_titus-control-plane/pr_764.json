{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNjQwMTc4", "number": 764, "title": "Add containers per node limit placement constraint", "bodyText": "", "createdAt": "2020-02-07T23:13:41Z", "url": "https://github.com/Netflix/titus-control-plane/pull/764", "merged": true, "mergeCommit": {"oid": "f5438ea68a7c98770af73b3afd6bdac314938d31"}, "closed": true, "closedAt": "2020-02-10T18:36:51Z", "author": {"login": "tbak"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCHZqnAH2gAyMzcyNjQwMTc4Ojk5NTI1NjlhNzRlNmZiMGM0OGJhNGUzZjcxOGQ2OTdjOGJmN2E4ZDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDBO3kAFqTM1NjE1MzY1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9952569a74e6fb0c48ba4e3f718d697c8bf7a8d0", "author": {"user": {"login": "tbak", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/9952569a74e6fb0c48ba4e3f718d697c8bf7a8d0", "committedDate": "2020-02-07T22:51:18Z", "message": "Add containers per node limit placement constraint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTA1NjQ1", "url": "https://github.com/Netflix/titus-control-plane/pull/764#pullrequestreview-355505645", "createdAt": "2020-02-08T00:10:55Z", "commit": {"oid": "9952569a74e6fb0c48ba4e3f718d697c8bf7a8d0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMDoxMDo1NlrOFnNuIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMDoxMzozMVrOFnNv_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY2MzU4NA==", "bodyText": "add this new kind to FailureKind.IGNORED_FOR_OPPORTUNISTIC_SCHEDULING since it should not cause opportunistic behavior to change", "url": "https://github.com/Netflix/titus-control-plane/pull/764#discussion_r376663584", "createdAt": "2020-02-08T00:10:56Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/scheduler/TaskPlacementFailure.java", "diffHunk": "@@ -54,6 +54,11 @@\n          */\n         LaunchGuard,\n \n+        /**\n+         * Task not launched on an agent, as it runs the maximum allowed number of containers.\n+         */\n+        AgentContainerLimit,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9952569a74e6fb0c48ba4e3f718d697c8bf7a8d0"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY2NDA2MA==", "bodyText": "should this be protected against the empty string? Why not use .equals() instead of .contains()?", "url": "https://github.com/Netflix/titus-control-plane/pull/764#discussion_r376664060", "createdAt": "2020-02-08T00:13:31Z", "author": {"login": "fabiokung"}, "path": "titus-server-master/src/main/java/com/netflix/titus/master/scheduler/constraint/AgentContainerLimitSystemConstraint.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.master.scheduler.constraint;\n+\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+import com.netflix.fenzo.TaskRequest;\n+import com.netflix.fenzo.TaskTrackerState;\n+import com.netflix.fenzo.VirtualMachineCurrentState;\n+import com.netflix.titus.master.scheduler.SchedulerConfiguration;\n+\n+@Singleton\n+public class AgentContainerLimitSystemConstraint implements SystemConstraint {\n+\n+    public static final String NAME = AgentContainerLimitSystemConstraint.class.getSimpleName();\n+\n+    private static final Result VALID = new Result(true, \"\");\n+    private static final Result TOO_MANY_CONTAINERS = new Result(false, \"Too many containers on the agent node\");\n+\n+    private final SchedulerConfiguration configuration;\n+\n+    @Inject\n+    public AgentContainerLimitSystemConstraint(SchedulerConfiguration configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public Result evaluate(TaskRequest taskRequest, VirtualMachineCurrentState targetVM, TaskTrackerState taskTrackerState) {\n+        int total = targetVM.getRunningTasks().size() + targetVM.getTasksCurrentlyAssigned().size();\n+        int max = Math.max(1, configuration.getMaxTasksPerMachine());\n+        return total < max ? VALID : TOO_MANY_CONTAINERS;\n+    }\n+\n+    public static boolean isAgentContainerLimitSystemConstraint(String reason) {\n+        return reason != null && TOO_MANY_CONTAINERS.getFailureReason().contains(reason);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9952569a74e6fb0c48ba4e3f718d697c8bf7a8d0"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a501e9bf48ab3f10493eb21c623d60ac91581757", "author": {"user": {"login": "tbak", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/a501e9bf48ab3f10493eb21c623d60ac91581757", "committedDate": "2020-02-10T16:16:13Z", "message": "Code review updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTM4Mzk0", "url": "https://github.com/Netflix/titus-control-plane/pull/764#pullrequestreview-356138394", "createdAt": "2020-02-10T17:49:31Z", "commit": {"oid": "a501e9bf48ab3f10493eb21c623d60ac91581757"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTUzNjU1", "url": "https://github.com/Netflix/titus-control-plane/pull/764#pullrequestreview-356153655", "createdAt": "2020-02-10T18:14:01Z", "commit": {"oid": "a501e9bf48ab3f10493eb21c623d60ac91581757"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 611, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}