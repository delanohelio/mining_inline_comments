{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNDA1MTAy", "number": 836, "title": "Moving elastic search http client into titus-common module", "bodyText": "Moving Elastic Search Client code to titus-common module\nElastic search client interface along with its http based implementation and the corresponding model classes are reusable beyond its current usage in a Titus supplementary component - taskspublisher. This involves a bunch of refactoring around taskspublisher code as well as the test code.", "createdAt": "2020-04-12T21:58:07Z", "url": "https://github.com/Netflix/titus-control-plane/pull/836", "merged": true, "mergeCommit": {"oid": "44bd5d5f87d2a91c19f5d5361de87694634b1e0e"}, "closed": true, "closedAt": "2020-04-14T16:50:09Z", "author": {"login": "amit-git"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVeOKngH2gAyNDAyNDA1MTAyOjAxZmJmMTZlZTkwY2EyYzQzZTcyODNhYzdmNjZmNTMzN2M0Yzk1ZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXmJnRAFqTM5MzEwMDc4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "01fbf16ee90ca2c43e7283ac7f66f5337c4c95fb", "author": {"user": {"login": "amit-git", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/01fbf16ee90ca2c43e7283ac7f66f5337c4c95fb", "committedDate": "2020-04-08T02:11:07Z", "message": "saving work elastic search client work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "086f3661e972d1d298162696f9b9174bb1578d73", "author": {"user": {"login": "amit-git", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/086f3661e972d1d298162696f9b9174bb1578d73", "committedDate": "2020-04-10T19:22:25Z", "message": "saving work for default es client (http)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "351226129e57bf8149491670e5e37f63a7079010", "author": {"user": {"login": "amit-git", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/351226129e57bf8149491670e5e37f63a7079010", "committedDate": "2020-04-11T01:52:31Z", "message": "default Elastic search client test against local ES container, manually setup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63bc30fe86673aa987504df68fd32df79b3ffd96", "author": {"user": {"login": "amit-git", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/63bc30fe86673aa987504df68fd32df79b3ffd96", "committedDate": "2020-04-11T06:08:51Z", "message": "starting a big refactoring, still a test build broken"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8880072635495a4bb8e149bd540d20787df168d", "author": {"user": {"login": "amit-git", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/b8880072635495a4bb8e149bd540d20787df168d", "committedDate": "2020-04-11T18:42:37Z", "message": "unit and integration test setup for elastic search default/http client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98b95359bedbab275354be17fe9a5586ad5fa04d", "author": {"user": {"login": "amit-git", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/98b95359bedbab275354be17fe9a5586ad5fa04d", "committedDate": "2020-04-12T06:41:06Z", "message": "minor refactoring, adding file headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56eacff381ee61bdfd8d70fa4d61a904042b150b", "author": {"user": {"login": "amit-git", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/56eacff381ee61bdfd8d70fa4d61a904042b150b", "committedDate": "2020-04-12T22:06:48Z", "message": "minor cleanup, comments etc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjIyMDUz", "url": "https://github.com/Netflix/titus-control-plane/pull/836#pullrequestreview-392222053", "createdAt": "2020-04-13T15:33:45Z", "commit": {"oid": "56eacff381ee61bdfd8d70fa4d61a904042b150b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjcyNTQ5", "url": "https://github.com/Netflix/titus-control-plane/pull/836#pullrequestreview-392272549", "createdAt": "2020-04-13T16:50:37Z", "commit": {"oid": "56eacff381ee61bdfd8d70fa4d61a904042b150b"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjo1MDozN1rOGEs5rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjo1NTo0NlrOGEtEmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4MzE0OQ==", "bodyText": "I think for consistency we should use the Archaius2 annotations and factories provided by Archaius2Ext.", "url": "https://github.com/Netflix/titus-control-plane/pull/836#discussion_r407583149", "createdAt": "2020-04-13T16:50:37Z", "author": {"login": "tbak"}, "path": "titus-common-ext/elasticsearch/src/main/java/com/netflix/titus/ext/elasticsearch/EsClientConfiguration.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.titus.ext.elasticsearch;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class EsClientConfiguration {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56eacff381ee61bdfd8d70fa4d61a904042b150b"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4NDAyNw==", "bodyText": "Not used?", "url": "https://github.com/Netflix/titus-control-plane/pull/836#discussion_r407584027", "createdAt": "2020-04-13T16:52:18Z", "author": {"login": "tbak"}, "path": "titus-common-ext/elasticsearch/src/test/java/com/netflix/titus/ext/elasticsearch/DefaultEsWebClientFactoryTest.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.titus.ext.elasticsearch;\n+\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.assertj.core.api.Java6Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class DefaultEsWebClientFactoryTest {\n+    private static final Logger logger = LoggerFactory.getLogger(DefaultEsWebClientFactoryTest.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56eacff381ee61bdfd8d70fa4d61a904042b150b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4NTMwMA==", "bodyText": "With Archaius2 interface getting defaults is a one liner.", "url": "https://github.com/Netflix/titus-control-plane/pull/836#discussion_r407585300", "createdAt": "2020-04-13T16:54:38Z", "author": {"login": "tbak"}, "path": "titus-common-ext/elasticsearch/src/test/java/com/netflix/titus/ext/elasticsearch/EsExternalResource.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.titus.ext.elasticsearch;\n+\n+import com.google.common.base.Preconditions;\n+import org.junit.rules.ExternalResource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.web.reactive.function.client.WebClient;\n+\n+public class EsExternalResource extends ExternalResource {\n+    private static final Logger logger = LoggerFactory.getLogger(EsExternalResource.class);\n+\n+    private EsClientConfiguration esClientConfiguration;\n+\n+    @Override\n+    protected void before() throws Throwable {\n+        String esHostName = Preconditions.checkNotNull(System.getenv(\"ES_HOST_NAME\"),\n+                \"'ES_HOST_NAME' environment variable not set\"\n+        );\n+\n+        String esPortStr = Preconditions.checkNotNull(System.getenv(\"ES_PORT\"),\n+                \"'ES_PORT' environment variable not set\"\n+        );\n+\n+        int esPort = Integer.parseInt(esPortStr);\n+\n+        // check if a ES cluster state is Green\n+        WebClient webClient = WebClient.builder()\n+                .baseUrl(String.format(\"http://%s:%d\", esHostName, esPort)).build();\n+        String resp = webClient.get()\n+                .uri(\"/_cat/health\")\n+                .retrieve()\n+                .bodyToMono(String.class).block();\n+\n+        if (resp == null || !resp.contains(\"green\")) {\n+            throw new IllegalStateException(String.format(\"Elastic search cluster %s:%d not READY\", esHostName, esPort));\n+        }\n+\n+        buildEsClientConfiguration(esHostName, esPort);\n+    }\n+\n+    public EsClientConfiguration getEsClientConfiguration() {\n+        return esClientConfiguration;\n+    }\n+\n+    private void buildEsClientConfiguration(String esHostName, int esPort) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56eacff381ee61bdfd8d70fa4d61a904042b150b"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4NTk0Ng==", "bodyText": "Minor. Constructors should be first, followed by getters and last setters.", "url": "https://github.com/Netflix/titus-control-plane/pull/836#discussion_r407585946", "createdAt": "2020-04-13T16:55:46Z", "author": {"login": "tbak"}, "path": "titus-common-ext/elasticsearch/src/test/java/com/netflix/titus/ext/elasticsearch/TestDoc.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.titus.ext.elasticsearch;\n+\n+public class TestDoc implements EsDoc {\n+    String id;\n+    String state;\n+    long ts;\n+\n+    public TestDoc() {\n+    }\n+\n+    public void setId(String id) {\n+        this.id = id;\n+    }\n+\n+    public void setState(String state) {\n+        this.state = state;\n+    }\n+\n+    public void setTs(long ts) {\n+        this.ts = ts;\n+    }\n+\n+    public TestDoc(String id, String state, long ts) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56eacff381ee61bdfd8d70fa4d61a904042b150b"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46af771c7daf53d36f504d30de97f0e9403bc8dd", "author": {"user": {"login": "amit-git", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/46af771c7daf53d36f504d30de97f0e9403bc8dd", "committedDate": "2020-04-13T20:55:28Z", "message": "review comments applied"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNDM5MzQ3", "url": "https://github.com/Netflix/titus-control-plane/pull/836#pullrequestreview-392439347", "createdAt": "2020-04-13T21:05:57Z", "commit": {"oid": "46af771c7daf53d36f504d30de97f0e9403bc8dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNDQ3NjI0", "url": "https://github.com/Netflix/titus-control-plane/pull/836#pullrequestreview-392447624", "createdAt": "2020-04-13T21:19:24Z", "commit": {"oid": "46af771c7daf53d36f504d30de97f0e9403bc8dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMToxOToyNFrOGE1u8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMToxOToyNFrOGE1u8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNzg1Ng==", "bodyText": "are these POJOs auto-generated code? Can they be immutable? They are inconsistent in some other ways as well, it would be nice to normalize them all with:\n\nmany don't have private fields\nnon-standard coding conventions for field and getter/setter methods on some (with underscores)\nonly some implement toString()\ndo they all need equals() and hashcode()?", "url": "https://github.com/Netflix/titus-control-plane/pull/836#discussion_r407727856", "createdAt": "2020-04-13T21:19:24Z", "author": {"login": "fabiokung"}, "path": "titus-common-ext/elasticsearch/src/main/java/com/netflix/titus/ext/elasticsearch/model/BulkEsIndexResp.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.titus.ext.elasticsearch.model;\n+\n+import java.util.List;\n+\n+/**\n+ * Elastic search data model as defined by REST API documentation\n+ * https://www.elastic.co/guide/en/elasticsearch/reference/master/rest-apis.html\n+ */\n+public class BulkEsIndexResp {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46af771c7daf53d36f504d30de97f0e9403bc8dd"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "101f0586a5de074f34f40440c1ecbac2d29a1fba", "author": {"user": {"login": "amit-git", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/101f0586a5de074f34f40440c1ecbac2d29a1fba", "committedDate": "2020-04-14T01:32:30Z", "message": "elastic search data model cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7093c70e0f7c0d01971b081224a62da5caa9cd58", "author": {"user": {"login": "amit-git", "name": null}}, "url": "https://github.com/Netflix/titus-control-plane/commit/7093c70e0f7c0d01971b081224a62da5caa9cd58", "committedDate": "2020-04-14T01:51:28Z", "message": "fixing test failures"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMTAwMjQ5", "url": "https://github.com/Netflix/titus-control-plane/pull/836#pullrequestreview-393100249", "createdAt": "2020-04-14T16:32:34Z", "commit": {"oid": "7093c70e0f7c0d01971b081224a62da5caa9cd58"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMTAwNzgw", "url": "https://github.com/Netflix/titus-control-plane/pull/836#pullrequestreview-393100780", "createdAt": "2020-04-14T16:33:14Z", "commit": {"oid": "7093c70e0f7c0d01971b081224a62da5caa9cd58"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 498, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}