{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMjIyODI3", "number": 644, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzowNTowOVrOEaEp-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNjoyNToyNFrOEbOqlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Nzc0NzEzOnYy", "diffSide": "RIGHT", "path": "tools/scripts/ansible/setup-playbook.yml", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzowNTowOVrOHDRO9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNjoyNDowOFrOHFGMGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MDEzMg==", "bodyText": "All this does is create the nginx config file.  Where do you generate the actual certificate, and how do you point the nginx config file to that certificate?", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473190132", "createdAt": "2020-08-19T17:05:09Z", "author": {"login": "sffc"}, "path": "tools/scripts/ansible/setup-playbook.yml", "diffHunk": "@@ -81,3 +133,19 @@\n           - mosh\n           - emacs-nox\n           - byobu\n+- hosts: letsencrypt\n+  become: yes\n+  vars_files:\n+    - vars/main.yml\n+    - local-vars/local.yml\n+  tasks:\n+    - name: Install certbot packages\n+      apt:\n+        pkg:\n+          - python3-certbot-nginx\n+    - name: setup certbot\n+      command: sudo certbot --nginx  --agree-tos -m {{ certbot_admin_email }} -d {{ inventory_hostname }} --non-interactive --keep", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f41df0d463733eea5f5b58794777aab33ed204e"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxNDY0NQ==", "bodyText": "For certbot config, cf. https://unicode-org.atlassian.net/browse/CLDR-13567", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473214645", "createdAt": "2020-08-19T17:47:28Z", "author": {"login": "btangmu"}, "path": "tools/scripts/ansible/setup-playbook.yml", "diffHunk": "@@ -81,3 +133,19 @@\n           - mosh\n           - emacs-nox\n           - byobu\n+- hosts: letsencrypt\n+  become: yes\n+  vars_files:\n+    - vars/main.yml\n+    - local-vars/local.yml\n+  tasks:\n+    - name: Install certbot packages\n+      apt:\n+        pkg:\n+          - python3-certbot-nginx\n+    - name: setup certbot\n+      command: sudo certbot --nginx  --agree-tos -m {{ certbot_admin_email }} -d {{ inventory_hostname }} --non-interactive --keep", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MDEzMg=="}, "originalCommit": {"oid": "4f41df0d463733eea5f5b58794777aab33ed204e"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxOTU3MA==", "bodyText": "The current production server uses /etc/nginx/sites-enabled/stproxy\nI think certbot automatically generates the certificate if installed right.", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473219570", "createdAt": "2020-08-19T17:55:51Z", "author": {"login": "btangmu"}, "path": "tools/scripts/ansible/setup-playbook.yml", "diffHunk": "@@ -81,3 +133,19 @@\n           - mosh\n           - emacs-nox\n           - byobu\n+- hosts: letsencrypt\n+  become: yes\n+  vars_files:\n+    - vars/main.yml\n+    - local-vars/local.yml\n+  tasks:\n+    - name: Install certbot packages\n+      apt:\n+        pkg:\n+          - python3-certbot-nginx\n+    - name: setup certbot\n+      command: sudo certbot --nginx  --agree-tos -m {{ certbot_admin_email }} -d {{ inventory_hostname }} --non-interactive --keep", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MDEzMg=="}, "originalCommit": {"oid": "4f41df0d463733eea5f5b58794777aab33ed204e"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIyNjUxNA==", "bodyText": "@sffc this does create the certificate and updates the config file, that's why the python3-certbot-nginx plugin was installed. https://cldr-smoke2.unicode.org was setup using only this playbook.", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473226514", "createdAt": "2020-08-19T18:08:07Z", "author": {"login": "srl295"}, "path": "tools/scripts/ansible/setup-playbook.yml", "diffHunk": "@@ -81,3 +133,19 @@\n           - mosh\n           - emacs-nox\n           - byobu\n+- hosts: letsencrypt\n+  become: yes\n+  vars_files:\n+    - vars/main.yml\n+    - local-vars/local.yml\n+  tasks:\n+    - name: Install certbot packages\n+      apt:\n+        pkg:\n+          - python3-certbot-nginx\n+    - name: setup certbot\n+      command: sudo certbot --nginx  --agree-tos -m {{ certbot_admin_email }} -d {{ inventory_hostname }} --non-interactive --keep", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MDEzMg=="}, "originalCommit": {"oid": "4f41df0d463733eea5f5b58794777aab33ed204e"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjMyOQ==", "bodyText": "If this command creates the certs, then why are the certs not listed in\n      args:\n        creates: /etc/letsencrypt/options-ssl-nginx.conf", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r475106329", "createdAt": "2020-08-22T16:24:08Z", "author": {"login": "sffc"}, "path": "tools/scripts/ansible/setup-playbook.yml", "diffHunk": "@@ -81,3 +133,19 @@\n           - mosh\n           - emacs-nox\n           - byobu\n+- hosts: letsencrypt\n+  become: yes\n+  vars_files:\n+    - vars/main.yml\n+    - local-vars/local.yml\n+  tasks:\n+    - name: Install certbot packages\n+      apt:\n+        pkg:\n+          - python3-certbot-nginx\n+    - name: setup certbot\n+      command: sudo certbot --nginx  --agree-tos -m {{ certbot_admin_email }} -d {{ inventory_hostname }} --non-interactive --keep", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MDEzMg=="}, "originalCommit": {"oid": "4f41df0d463733eea5f5b58794777aab33ed204e"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Nzc1MzA1OnYy", "diffSide": "RIGHT", "path": "tools/scripts/ansible/README.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzowNjoyN1rOHDRTAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxODozNDoyMlrOHDUTiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MTE3MA==", "bodyText": "The -f ./local-surveytool option in the ssh-keygen command above seems to not match the filename .../surveytool.pub.", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473191170", "createdAt": "2020-08-19T17:06:27Z", "author": {"login": "echeran"}, "path": "tools/scripts/ansible/README.md", "diffHunk": "@@ -38,6 +38,28 @@ cldr-ref.unicode.org | SUCCESS => {\n \n - Install python3. Make sure `python --version` returns \"Python 3\u2026\"\n \n+- TODO: these shouldn't be needed, but they are. Here's the entire install command:\n+\n+```shell\n+sudo apt-get update && sudo apt-get install python3 python-apt python3-pymysql\n+```\n+\n+### Setup: surveytool keypair\n+\n+```shell\n+mkdir -p ./local-vars\n+ssh-keygen -t rsa -b 4096 -f ./local-surveytool -P '' -C 'surveytool deploy'\n+```\n+\n+The contents of the `local-vars/surveytool.pub` file is used for the `key:` parameter below in `local.yml`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f41df0d463733eea5f5b58794777aab33ed204e"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0MDQ1Ng==", "bodyText": "@echeran fixed in bc5742a", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473240456", "createdAt": "2020-08-19T18:34:22Z", "author": {"login": "srl295"}, "path": "tools/scripts/ansible/README.md", "diffHunk": "@@ -38,6 +38,28 @@ cldr-ref.unicode.org | SUCCESS => {\n \n - Install python3. Make sure `python --version` returns \"Python 3\u2026\"\n \n+- TODO: these shouldn't be needed, but they are. Here's the entire install command:\n+\n+```shell\n+sudo apt-get update && sudo apt-get install python3 python-apt python3-pymysql\n+```\n+\n+### Setup: surveytool keypair\n+\n+```shell\n+mkdir -p ./local-vars\n+ssh-keygen -t rsa -b 4096 -f ./local-surveytool -P '' -C 'surveytool deploy'\n+```\n+\n+The contents of the `local-vars/surveytool.pub` file is used for the `key:` parameter below in `local.yml`.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MTE3MA=="}, "originalCommit": {"oid": "4f41df0d463733eea5f5b58794777aab33ed204e"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Nzk4ODY0OnYy", "diffSide": "RIGHT", "path": "tools/scripts/ansible/setup-playbook.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxODoxMzoyNFrOHDTnsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxODozMjowOVrOHDUO6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIyOTIzMg==", "bodyText": "The GH Action for Ansible build is currently failing with an error saying that there's an invalid key name in the YAML around somewhere here.", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473229232", "createdAt": "2020-08-19T18:13:24Z", "author": {"login": "echeran"}, "path": "tools/scripts/ansible/setup-playbook.yml", "diffHunk": "@@ -52,25 +61,69 @@\n         force: no\n         owner: tomcat8\n         group: tomcat8\n-        mode: 0644\n+        mode: \"0644\"\n       notify: Restart Tomcat\n     - name: Checkout CLDR trunk\n       git:\n         repo: https://github.com/unicode-org/cldr.git\n         dest: /var/lib/tomcat8/cldr/cldr-trunk\n-        depth: 1 # don't need all history\n         force: no\n+        update: no\n         version: master\n+        # this is deep because we will need to keep updating\n+        # it with history. It does not include LFS as that\n+        # is not needed for the surveytool.\n+    - name: Setup index.html\n+      copy:\n+        src: templates/index.html\n+        dest: /var/www/html\n+        owner: root\n+        group: root\n+        mode: '0644'\n+    - name: Setup reverse proxy\n+      blockinfile:\n+        path: /etc/nginx/sites-enabled/default\n+        block: |\n+          # proxy /cldr-apps/ to tomcat\n+          location /cldr-apps/ {\n+            allow all;\n+            proxy_pass http://localhost:8080/cldr-apps/;\n+            proxy_set_header Host $host;\n+            proxy_set_header X-Real-IP $remote_addr;\n+          }\n+        marker: '# {mark} ANSIBLE MANAGED BLOCK'\n+        insertafter: '^[\\s]*server_name' # the LAST uncommented server block\n+      notify: 'Restart Nginx'\n+    - name: Setup surveytool user for deploy\n+      user:\n+        name: surveytool\n+        shell: /bin/bash\n+    - name: Give acess to surveytool user\n+      file:\n+        path: /var/lib/tomcat8/cldr/cldr-trunk\n+        owner: surveytool\n+        recurse: yes\n+    - name: Setup surveytool auth", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff2f3710030e97c6b9f8b908ec3dc1b559bf4c7"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzOTI3NA==", "bodyText": "@echeran please recheck\u2026\u00a0think i fixed it", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r473239274", "createdAt": "2020-08-19T18:32:09Z", "author": {"login": "srl295"}, "path": "tools/scripts/ansible/setup-playbook.yml", "diffHunk": "@@ -52,25 +61,69 @@\n         force: no\n         owner: tomcat8\n         group: tomcat8\n-        mode: 0644\n+        mode: \"0644\"\n       notify: Restart Tomcat\n     - name: Checkout CLDR trunk\n       git:\n         repo: https://github.com/unicode-org/cldr.git\n         dest: /var/lib/tomcat8/cldr/cldr-trunk\n-        depth: 1 # don't need all history\n         force: no\n+        update: no\n         version: master\n+        # this is deep because we will need to keep updating\n+        # it with history. It does not include LFS as that\n+        # is not needed for the surveytool.\n+    - name: Setup index.html\n+      copy:\n+        src: templates/index.html\n+        dest: /var/www/html\n+        owner: root\n+        group: root\n+        mode: '0644'\n+    - name: Setup reverse proxy\n+      blockinfile:\n+        path: /etc/nginx/sites-enabled/default\n+        block: |\n+          # proxy /cldr-apps/ to tomcat\n+          location /cldr-apps/ {\n+            allow all;\n+            proxy_pass http://localhost:8080/cldr-apps/;\n+            proxy_set_header Host $host;\n+            proxy_set_header X-Real-IP $remote_addr;\n+          }\n+        marker: '# {mark} ANSIBLE MANAGED BLOCK'\n+        insertafter: '^[\\s]*server_name' # the LAST uncommented server block\n+      notify: 'Restart Nginx'\n+    - name: Setup surveytool user for deploy\n+      user:\n+        name: surveytool\n+        shell: /bin/bash\n+    - name: Give acess to surveytool user\n+      file:\n+        path: /var/lib/tomcat8/cldr/cldr-trunk\n+        owner: surveytool\n+        recurse: yes\n+    - name: Setup surveytool auth", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIyOTIzMg=="}, "originalCommit": {"oid": "8ff2f3710030e97c6b9f8b908ec3dc1b559bf4c7"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2OTg3Mjg1OnYy", "diffSide": "RIGHT", "path": "tools/scripts/ansible/vars/main.yml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNjoyNToyNVrOHFGMtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNzo1OToyNVrOHFGuKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjQ4Ng==", "bodyText": "What's the difference between certbot above and certbot down here?", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r475106486", "createdAt": "2020-08-22T16:25:25Z", "author": {"login": "sffc"}, "path": "tools/scripts/ansible/vars/main.yml", "diffHunk": "@@ -3,4 +3,9 @@ mysql_databases:\n     encoding: latin1\n     collation: latin1_bin\n mysql_enabled_on_startup: true\n-mysql_bind_address: localhost\n\\ No newline at end of file\n+mysql_bind_address: localhost\n+certbot_create_standalone_stop_services:\n+  - nginx\n+certbot_auto_renew: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc5742a530ed06892b6d456e8b877e5e551cebd7"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExNDQ3MQ==", "bodyText": "actually, I think these lines are extraneous. I was using a certbot role and it didn't end up working out.", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r475114471", "createdAt": "2020-08-22T17:52:34Z", "author": {"login": "srl295"}, "path": "tools/scripts/ansible/vars/main.yml", "diffHunk": "@@ -3,4 +3,9 @@ mysql_databases:\n     encoding: latin1\n     collation: latin1_bin\n mysql_enabled_on_startup: true\n-mysql_bind_address: localhost\n\\ No newline at end of file\n+mysql_bind_address: localhost\n+certbot_create_standalone_stop_services:\n+  - nginx\n+certbot_auto_renew: true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjQ4Ng=="}, "originalCommit": {"oid": "bc5742a530ed06892b6d456e8b877e5e551cebd7"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExNTA1MA==", "bodyText": "deleted", "url": "https://github.com/unicode-org/cldr/pull/644#discussion_r475115050", "createdAt": "2020-08-22T17:59:25Z", "author": {"login": "srl295"}, "path": "tools/scripts/ansible/vars/main.yml", "diffHunk": "@@ -3,4 +3,9 @@ mysql_databases:\n     encoding: latin1\n     collation: latin1_bin\n mysql_enabled_on_startup: true\n-mysql_bind_address: localhost\n\\ No newline at end of file\n+mysql_bind_address: localhost\n+certbot_create_standalone_stop_services:\n+  - nginx\n+certbot_auto_renew: true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjQ4Ng=="}, "originalCommit": {"oid": "bc5742a530ed06892b6d456e8b877e5e551cebd7"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 469, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}