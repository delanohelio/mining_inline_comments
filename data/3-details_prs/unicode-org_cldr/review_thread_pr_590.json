{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MTU4OTYx", "number": 590, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDoxMzo1M1rOETFlBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDoxNTo0N1rOETFmJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDQ5Nzk2OnYy", "diffSide": "RIGHT", "path": "tools/cldr-apps/WebContent/js/special/forum_participation.js", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDoxMzo1M1rOG4n6bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDoxMzo1M1rOG4n6bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyNzM3Mw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/unicode-org/cldr/pull/590#discussion_r462027373", "createdAt": "2020-07-29T04:13:53Z", "author": {"login": "srl295"}, "path": "tools/cldr-apps/WebContent/js/special/forum_participation.js", "diffHunk": "@@ -0,0 +1,25 @@\n+'use strict';\n+\n+/**\n+ * Based on specials/forum.js\n+ *\n+ * TODO: use modern JavaScript -- import/export, not define", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "136522be8dcac045554b614afb5373f6c6075d14"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDUwMDg2OnYy", "diffSide": "RIGHT", "path": "tools/cldr-apps/src/org/unicode/cldr/web/SurveyForumParticipation.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDoxNTo0N1rOG4n8OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNToyNjoxOVrOG493Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyNzgzMg==", "bodyText": "Ideally these would be ? params. But ok", "url": "https://github.com/unicode-org/cldr/pull/590#discussion_r462027832", "createdAt": "2020-07-29T04:15:47Z", "author": {"login": "srl295"}, "path": "tools/cldr-apps/src/org/unicode/cldr/web/SurveyForumParticipation.java", "diffHunk": "@@ -138,6 +132,133 @@ private int queryForumDb(Cell cell, String loc) throws SQLException {\n         return count;\n     }\n \n+    /**\n+     * \"Forum: Needing action (Requests and Discussions my organization has not responded to)\"\n+     *\n+     * \"Needs action\" means:\n+     *    - (Open request from other org AND (my org haven\u2019t agreed or declined))\n+     *    - OR (open discuss-only thread AND the last poster is not in my org)\n+     *\n+     * Compare JavaScript \"passIfNeedingAction\". Different on server since not \"I\" but \"We\" = \"anybody in my org\".\n+     *\n+     * @param conn\n+     * @param loc\n+     * @return the count\n+     * @throws SQLException\n+     *\n+     * TODO: make this faster; it's slow\n+     */\n+    private int queryForumDbAct(String loc) throws SQLException {\n+        PreparedStatement ps = null;\n+        Integer count = -1;\n+        try {\n+            ps = prepareForumActQuery(loc);\n+            ResultSet rs = ps.executeQuery();\n+            count = 0;\n+            while (rs.next()) {\n+                int forumId = rs.getInt(1);\n+                int postType =rs.getInt(2);\n+                /*\n+                 * For Discuss: look at the LAST reply in the thread, and skip the item if our org was its poster\n+                 * For Request: look at each reply in the thread, and skip the item if our org agreed or declined\n+                 */\n+                if (postType == typeDiscuss) {\n+                    if (!ourOrgPostedLast(forumId)) {\n+                        ++count;\n+                    }\n+                } else { // Request\n+                    if (!ourOrgAgreedOrDeclined(forumId)) {\n+                        ++count;\n+                    }\n+                }\n+            }\n+        } finally {\n+            DBUtils.close(ps);\n+        }\n+        return count;\n+    }\n+\n+    private PreparedStatement prepareForumActQuery(String loc) throws SQLException {\n+        String sql = \"SELECT \" + forumTable + \".id, \" +  forumTable + \".type\"\n+            + \" FROM \" + forumTable\n+            + \" JOIN \" + userTable\n+            + \" ON \" + forumTable + \".poster=\" + userTable + \".id\"\n+            + \" WHERE \" + forumTable + \".parent=-1\"\n+            + \" AND \" + forumTable + \".open=true\"\n+            + \" AND \" + forumTable + \".loc=?\"\n+            + \" AND (\" + forumTable + \".type=?\"\n+            + \" OR NOT \" + userTable + \".org=?)\";\n+\n+        PreparedStatement ps = DBUtils.prepareForwardReadOnly(conn, sql);\n+        ps.setString(1, loc);\n+        ps.setInt(2, typeDiscuss);\n+        ps.setString(3, org);\n+        return ps;\n+    }\n+\n+    /**\n+     * Does the poster who made the last post in this thread belong to this org?\n+     *\n+     * @param conn the Connection\n+     * @param forumRootId the id of the root (initial) forum post of the thread\n+     * @return true or false\n+     * @throws SQLException\n+     */\n+    private boolean ourOrgPostedLast(int forumRootId) throws SQLException {\n+        boolean result = false;\n+        PreparedStatement ps = null;\n+        String sql = \"SELECT \" + userTable + \".org \"\n+            + \" FROM \" + forumTable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "136522be8dcac045554b614afb5373f6c6075d14"}, "originalPosition": 190}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM0NTc5NA==", "bodyText": "I'm not sure what benefit that would have. The table names don't vary for these queries. Would there be a performance benefit in spite of that?", "url": "https://github.com/unicode-org/cldr/pull/590#discussion_r462345794", "createdAt": "2020-07-29T14:32:03Z", "author": {"login": "btangmu"}, "path": "tools/cldr-apps/src/org/unicode/cldr/web/SurveyForumParticipation.java", "diffHunk": "@@ -138,6 +132,133 @@ private int queryForumDb(Cell cell, String loc) throws SQLException {\n         return count;\n     }\n \n+    /**\n+     * \"Forum: Needing action (Requests and Discussions my organization has not responded to)\"\n+     *\n+     * \"Needs action\" means:\n+     *    - (Open request from other org AND (my org haven\u2019t agreed or declined))\n+     *    - OR (open discuss-only thread AND the last poster is not in my org)\n+     *\n+     * Compare JavaScript \"passIfNeedingAction\". Different on server since not \"I\" but \"We\" = \"anybody in my org\".\n+     *\n+     * @param conn\n+     * @param loc\n+     * @return the count\n+     * @throws SQLException\n+     *\n+     * TODO: make this faster; it's slow\n+     */\n+    private int queryForumDbAct(String loc) throws SQLException {\n+        PreparedStatement ps = null;\n+        Integer count = -1;\n+        try {\n+            ps = prepareForumActQuery(loc);\n+            ResultSet rs = ps.executeQuery();\n+            count = 0;\n+            while (rs.next()) {\n+                int forumId = rs.getInt(1);\n+                int postType =rs.getInt(2);\n+                /*\n+                 * For Discuss: look at the LAST reply in the thread, and skip the item if our org was its poster\n+                 * For Request: look at each reply in the thread, and skip the item if our org agreed or declined\n+                 */\n+                if (postType == typeDiscuss) {\n+                    if (!ourOrgPostedLast(forumId)) {\n+                        ++count;\n+                    }\n+                } else { // Request\n+                    if (!ourOrgAgreedOrDeclined(forumId)) {\n+                        ++count;\n+                    }\n+                }\n+            }\n+        } finally {\n+            DBUtils.close(ps);\n+        }\n+        return count;\n+    }\n+\n+    private PreparedStatement prepareForumActQuery(String loc) throws SQLException {\n+        String sql = \"SELECT \" + forumTable + \".id, \" +  forumTable + \".type\"\n+            + \" FROM \" + forumTable\n+            + \" JOIN \" + userTable\n+            + \" ON \" + forumTable + \".poster=\" + userTable + \".id\"\n+            + \" WHERE \" + forumTable + \".parent=-1\"\n+            + \" AND \" + forumTable + \".open=true\"\n+            + \" AND \" + forumTable + \".loc=?\"\n+            + \" AND (\" + forumTable + \".type=?\"\n+            + \" OR NOT \" + userTable + \".org=?)\";\n+\n+        PreparedStatement ps = DBUtils.prepareForwardReadOnly(conn, sql);\n+        ps.setString(1, loc);\n+        ps.setInt(2, typeDiscuss);\n+        ps.setString(3, org);\n+        return ps;\n+    }\n+\n+    /**\n+     * Does the poster who made the last post in this thread belong to this org?\n+     *\n+     * @param conn the Connection\n+     * @param forumRootId the id of the root (initial) forum post of the thread\n+     * @return true or false\n+     * @throws SQLException\n+     */\n+    private boolean ourOrgPostedLast(int forumRootId) throws SQLException {\n+        boolean result = false;\n+        PreparedStatement ps = null;\n+        String sql = \"SELECT \" + userTable + \".org \"\n+            + \" FROM \" + forumTable", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyNzgzMg=="}, "originalCommit": {"oid": "136522be8dcac045554b614afb5373f6c6075d14"}, "originalPosition": 190}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM4Njk1OQ==", "bodyText": "@btangmu sorry, correct these are table names, not parameters.", "url": "https://github.com/unicode-org/cldr/pull/590#discussion_r462386959", "createdAt": "2020-07-29T15:26:19Z", "author": {"login": "srl295"}, "path": "tools/cldr-apps/src/org/unicode/cldr/web/SurveyForumParticipation.java", "diffHunk": "@@ -138,6 +132,133 @@ private int queryForumDb(Cell cell, String loc) throws SQLException {\n         return count;\n     }\n \n+    /**\n+     * \"Forum: Needing action (Requests and Discussions my organization has not responded to)\"\n+     *\n+     * \"Needs action\" means:\n+     *    - (Open request from other org AND (my org haven\u2019t agreed or declined))\n+     *    - OR (open discuss-only thread AND the last poster is not in my org)\n+     *\n+     * Compare JavaScript \"passIfNeedingAction\". Different on server since not \"I\" but \"We\" = \"anybody in my org\".\n+     *\n+     * @param conn\n+     * @param loc\n+     * @return the count\n+     * @throws SQLException\n+     *\n+     * TODO: make this faster; it's slow\n+     */\n+    private int queryForumDbAct(String loc) throws SQLException {\n+        PreparedStatement ps = null;\n+        Integer count = -1;\n+        try {\n+            ps = prepareForumActQuery(loc);\n+            ResultSet rs = ps.executeQuery();\n+            count = 0;\n+            while (rs.next()) {\n+                int forumId = rs.getInt(1);\n+                int postType =rs.getInt(2);\n+                /*\n+                 * For Discuss: look at the LAST reply in the thread, and skip the item if our org was its poster\n+                 * For Request: look at each reply in the thread, and skip the item if our org agreed or declined\n+                 */\n+                if (postType == typeDiscuss) {\n+                    if (!ourOrgPostedLast(forumId)) {\n+                        ++count;\n+                    }\n+                } else { // Request\n+                    if (!ourOrgAgreedOrDeclined(forumId)) {\n+                        ++count;\n+                    }\n+                }\n+            }\n+        } finally {\n+            DBUtils.close(ps);\n+        }\n+        return count;\n+    }\n+\n+    private PreparedStatement prepareForumActQuery(String loc) throws SQLException {\n+        String sql = \"SELECT \" + forumTable + \".id, \" +  forumTable + \".type\"\n+            + \" FROM \" + forumTable\n+            + \" JOIN \" + userTable\n+            + \" ON \" + forumTable + \".poster=\" + userTable + \".id\"\n+            + \" WHERE \" + forumTable + \".parent=-1\"\n+            + \" AND \" + forumTable + \".open=true\"\n+            + \" AND \" + forumTable + \".loc=?\"\n+            + \" AND (\" + forumTable + \".type=?\"\n+            + \" OR NOT \" + userTable + \".org=?)\";\n+\n+        PreparedStatement ps = DBUtils.prepareForwardReadOnly(conn, sql);\n+        ps.setString(1, loc);\n+        ps.setInt(2, typeDiscuss);\n+        ps.setString(3, org);\n+        return ps;\n+    }\n+\n+    /**\n+     * Does the poster who made the last post in this thread belong to this org?\n+     *\n+     * @param conn the Connection\n+     * @param forumRootId the id of the root (initial) forum post of the thread\n+     * @return true or false\n+     * @throws SQLException\n+     */\n+    private boolean ourOrgPostedLast(int forumRootId) throws SQLException {\n+        boolean result = false;\n+        PreparedStatement ps = null;\n+        String sql = \"SELECT \" + userTable + \".org \"\n+            + \" FROM \" + forumTable", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyNzgzMg=="}, "originalCommit": {"oid": "136522be8dcac045554b614afb5373f6c6075d14"}, "originalPosition": 190}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 429, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}