{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MTU4OTYx", "number": 590, "title": "CLDR-13616 Monitor Forum Participation", "bodyText": "-New column: Needing action\n-Since slower now, revise implementation to use ajax and show Loading... message\n-For server, use SurveyAjax instead of SurveyMain; return json, build table on client\n-New special: forum_participation\n-New special/forum_participation.js and CldrStForumParticipation.js\n-More unit testing\n\nChecklist\n\n Issue filed: https://unicode-org.atlassian.net/browse/CLDR-13616\n Updated PR title and link in previous line to include Issue number", "createdAt": "2020-07-29T02:44:02Z", "url": "https://github.com/unicode-org/cldr/pull/590", "merged": true, "mergeCommit": {"oid": "0d90de1af4963accb624ef3aa408264e0a9bcb5b"}, "closed": true, "closedAt": "2020-07-29T13:22:43Z", "author": {"login": "btangmu"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5hoMUAH2gAyNDU4MTU4OTYxOjEzNjUyMmJlOGRjYWMwNDU1NTRiNjE0YWZiNTM3M2Y2YzYwNzVkMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5jI04gFqTQ1NzE4MTk2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "136522be8dcac045554b614afb5373f6c6075d14", "author": {"user": {"login": "btangmu", "name": "Tom Bishop"}}, "url": "https://github.com/unicode-org/cldr/commit/136522be8dcac045554b614afb5373f6c6075d14", "committedDate": "2020-07-29T02:30:32Z", "message": "CLDR-13616 Monitor Forum Participation\n\n-New column: Needing action\n\n-Since slower now, use ajax and show Loading... message\n\n-New special: forum_participation\n\n-New special/forum_participation.js and CldrStForumParticipation.js\n\n-For server, use SurveyAjax instead of SurveyMain; serve json, build table on client\n\n-Skip asterisk (*) if present in the set of locales, as for organization Gaeilge\n\n-More unit testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTYyNjc2", "url": "https://github.com/unicode-org/cldr/pull/590#pullrequestreview-457162676", "createdAt": "2020-07-29T03:03:40Z", "commit": {"oid": "136522be8dcac045554b614afb5373f6c6075d14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTgxOTY5", "url": "https://github.com/unicode-org/cldr/pull/590#pullrequestreview-457181969", "createdAt": "2020-07-29T04:13:52Z", "commit": {"oid": "136522be8dcac045554b614afb5373f6c6075d14"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDoxMzo1M1rOG4n6bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDoxNTo0N1rOG4n8OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyNzM3Mw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/unicode-org/cldr/pull/590#discussion_r462027373", "createdAt": "2020-07-29T04:13:53Z", "author": {"login": "srl295"}, "path": "tools/cldr-apps/WebContent/js/special/forum_participation.js", "diffHunk": "@@ -0,0 +1,25 @@\n+'use strict';\n+\n+/**\n+ * Based on specials/forum.js\n+ *\n+ * TODO: use modern JavaScript -- import/export, not define", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "136522be8dcac045554b614afb5373f6c6075d14"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyNzgzMg==", "bodyText": "Ideally these would be ? params. But ok", "url": "https://github.com/unicode-org/cldr/pull/590#discussion_r462027832", "createdAt": "2020-07-29T04:15:47Z", "author": {"login": "srl295"}, "path": "tools/cldr-apps/src/org/unicode/cldr/web/SurveyForumParticipation.java", "diffHunk": "@@ -138,6 +132,133 @@ private int queryForumDb(Cell cell, String loc) throws SQLException {\n         return count;\n     }\n \n+    /**\n+     * \"Forum: Needing action (Requests and Discussions my organization has not responded to)\"\n+     *\n+     * \"Needs action\" means:\n+     *    - (Open request from other org AND (my org haven\u2019t agreed or declined))\n+     *    - OR (open discuss-only thread AND the last poster is not in my org)\n+     *\n+     * Compare JavaScript \"passIfNeedingAction\". Different on server since not \"I\" but \"We\" = \"anybody in my org\".\n+     *\n+     * @param conn\n+     * @param loc\n+     * @return the count\n+     * @throws SQLException\n+     *\n+     * TODO: make this faster; it's slow\n+     */\n+    private int queryForumDbAct(String loc) throws SQLException {\n+        PreparedStatement ps = null;\n+        Integer count = -1;\n+        try {\n+            ps = prepareForumActQuery(loc);\n+            ResultSet rs = ps.executeQuery();\n+            count = 0;\n+            while (rs.next()) {\n+                int forumId = rs.getInt(1);\n+                int postType =rs.getInt(2);\n+                /*\n+                 * For Discuss: look at the LAST reply in the thread, and skip the item if our org was its poster\n+                 * For Request: look at each reply in the thread, and skip the item if our org agreed or declined\n+                 */\n+                if (postType == typeDiscuss) {\n+                    if (!ourOrgPostedLast(forumId)) {\n+                        ++count;\n+                    }\n+                } else { // Request\n+                    if (!ourOrgAgreedOrDeclined(forumId)) {\n+                        ++count;\n+                    }\n+                }\n+            }\n+        } finally {\n+            DBUtils.close(ps);\n+        }\n+        return count;\n+    }\n+\n+    private PreparedStatement prepareForumActQuery(String loc) throws SQLException {\n+        String sql = \"SELECT \" + forumTable + \".id, \" +  forumTable + \".type\"\n+            + \" FROM \" + forumTable\n+            + \" JOIN \" + userTable\n+            + \" ON \" + forumTable + \".poster=\" + userTable + \".id\"\n+            + \" WHERE \" + forumTable + \".parent=-1\"\n+            + \" AND \" + forumTable + \".open=true\"\n+            + \" AND \" + forumTable + \".loc=?\"\n+            + \" AND (\" + forumTable + \".type=?\"\n+            + \" OR NOT \" + userTable + \".org=?)\";\n+\n+        PreparedStatement ps = DBUtils.prepareForwardReadOnly(conn, sql);\n+        ps.setString(1, loc);\n+        ps.setInt(2, typeDiscuss);\n+        ps.setString(3, org);\n+        return ps;\n+    }\n+\n+    /**\n+     * Does the poster who made the last post in this thread belong to this org?\n+     *\n+     * @param conn the Connection\n+     * @param forumRootId the id of the root (initial) forum post of the thread\n+     * @return true or false\n+     * @throws SQLException\n+     */\n+    private boolean ourOrgPostedLast(int forumRootId) throws SQLException {\n+        boolean result = false;\n+        PreparedStatement ps = null;\n+        String sql = \"SELECT \" + userTable + \".org \"\n+            + \" FROM \" + forumTable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "136522be8dcac045554b614afb5373f6c6075d14"}, "originalPosition": 190}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2016, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}