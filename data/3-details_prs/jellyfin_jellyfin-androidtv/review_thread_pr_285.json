{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwMjY0NTM5", "number": 285, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzoxNzowM1rODcoKvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzo0NjozMVrODcovkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMzQ0ODI5OnYy", "diffSide": "RIGHT", "path": "app/src/main/java/org/jellyfin/androidtv/model/itemtypes/LiftedItems.kt", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzoxNzowM1rOFkw82Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNTo0MToxOVrOFk11sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA5NTA2NQ==", "bodyText": "I think the playbackPositionTicks > 0 check should be sufficient, since the original.canResume just does a basically equivalent check.\n\tpublic final boolean getCanResume()\n\t{\n\t\treturn getUserData() != null && getUserData().getPlaybackPositionTicks() > 0;\n\t}\nhttps://github.com/jellyfin/jellyfin-apiclient-java/blob/master/library/src/main/java/org/jellyfin/apiclient/model/dto/BaseItemDto.java#L2311", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374095065", "createdAt": "2020-02-03T13:17:03Z", "author": {"login": "AndreasGB"}, "path": "app/src/main/java/org/jellyfin/androidtv/model/itemtypes/LiftedItems.kt", "diffHunk": "@@ -4,20 +4,23 @@ import org.jellyfin.apiclient.model.dto.BaseItemDto\n import org.jellyfin.apiclient.model.dto.BaseItemType\n import org.jellyfin.apiclient.model.dto.ChapterInfoDto\n import java.util.*\n+import kotlin.properties.Delegates\n \n-sealed class BaseItem(original: BaseItemDto) {\n+sealed class BaseItem(original: BaseItemDto) : ObservableParent() {\n \tval id: String = original.id\n \tval name: String = original.name\n \tval description: String? = original.overview\n \tval images: ImageCollection = ImageCollection(original)\n \tval added: Date = original.dateCreated\n+\tvar favorite: Boolean by Delegates.observable(original.userData.isFavorite, ::observer)\n }\n \n sealed class PlayableItem(original: BaseItemDto) : BaseItem(original) {\n-\tval canResume: Boolean = original.canResume\n \tval playbackPositionTicks: Long = original.userData.playbackPositionTicks\n+\tval canResume: Boolean = original.canResume && playbackPositionTicks > 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a289e38659caaf1715b78808950becfdb2259b84"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE3NTE1NA==", "bodyText": "I didn't even look at the baseItem. I assumed it was just passed from the server!", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374175154", "createdAt": "2020-02-03T15:41:19Z", "author": {"login": "nielsvanvelzen"}, "path": "app/src/main/java/org/jellyfin/androidtv/model/itemtypes/LiftedItems.kt", "diffHunk": "@@ -4,20 +4,23 @@ import org.jellyfin.apiclient.model.dto.BaseItemDto\n import org.jellyfin.apiclient.model.dto.BaseItemType\n import org.jellyfin.apiclient.model.dto.ChapterInfoDto\n import java.util.*\n+import kotlin.properties.Delegates\n \n-sealed class BaseItem(original: BaseItemDto) {\n+sealed class BaseItem(original: BaseItemDto) : ObservableParent() {\n \tval id: String = original.id\n \tval name: String = original.name\n \tval description: String? = original.overview\n \tval images: ImageCollection = ImageCollection(original)\n \tval added: Date = original.dateCreated\n+\tvar favorite: Boolean by Delegates.observable(original.userData.isFavorite, ::observer)\n }\n \n sealed class PlayableItem(original: BaseItemDto) : BaseItem(original) {\n-\tval canResume: Boolean = original.canResume\n \tval playbackPositionTicks: Long = original.userData.playbackPositionTicks\n+\tval canResume: Boolean = original.canResume && playbackPositionTicks > 0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA5NTA2NQ=="}, "originalCommit": {"oid": "a289e38659caaf1715b78808950becfdb2259b84"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMzQ4OTg2OnYy", "diffSide": "RIGHT", "path": "app/src/main/java/org/jellyfin/androidtv/util/apiclient/ApiClientExtensions.kt", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzozMDowNFrOFkxVdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNTo0MjoxNFrOFk14Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEwMTM2Ng==", "bodyText": "Maybe we should add proper error handling for all these coroutines before we release", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374101366", "createdAt": "2020-02-03T13:30:04Z", "author": {"login": "AndreasGB"}, "path": "app/src/main/java/org/jellyfin/androidtv/util/apiclient/ApiClientExtensions.kt", "diffHunk": "@@ -29,3 +30,25 @@ suspend fun ApiClient.getItem(id: String): BaseItemDto? = suspendCoroutine { con\n \t\toverride fun onError(exception: Exception?) = continuation.resume(null)\n \t})\n }\n+\n+suspend fun ApiClient.markPlayed(itemId: String, userId: String, datePlayed: Date?) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tMarkPlayedAsync(itemId, userId, datePlayed, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }\n+\t})\n+}\n+\n+suspend fun ApiClient.markUnplayed(itemId: String, userId: String) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tMarkUnplayedAsync(itemId, userId, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }\n+\t})\n+}\n+\n+\n+suspend fun ApiClient.updateFavoriteStatus(itemId: String, userId: String, isFavorite: Boolean) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tUpdateFavoriteStatusAsync(itemId, userId, isFavorite, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a289e38659caaf1715b78808950becfdb2259b84"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE3NTc5MA==", "bodyText": "I'll make a note in the issue for that.", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374175790", "createdAt": "2020-02-03T15:42:14Z", "author": {"login": "nielsvanvelzen"}, "path": "app/src/main/java/org/jellyfin/androidtv/util/apiclient/ApiClientExtensions.kt", "diffHunk": "@@ -29,3 +30,25 @@ suspend fun ApiClient.getItem(id: String): BaseItemDto? = suspendCoroutine { con\n \t\toverride fun onError(exception: Exception?) = continuation.resume(null)\n \t})\n }\n+\n+suspend fun ApiClient.markPlayed(itemId: String, userId: String, datePlayed: Date?) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tMarkPlayedAsync(itemId, userId, datePlayed, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }\n+\t})\n+}\n+\n+suspend fun ApiClient.markUnplayed(itemId: String, userId: String) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tMarkUnplayedAsync(itemId, userId, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }\n+\t})\n+}\n+\n+\n+suspend fun ApiClient.updateFavoriteStatus(itemId: String, userId: String, isFavorite: Boolean) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tUpdateFavoriteStatusAsync(itemId, userId, isFavorite, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEwMTM2Ng=="}, "originalCommit": {"oid": "a289e38659caaf1715b78808950becfdb2259b84"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMzU0MjU4OnYy", "diffSide": "RIGHT", "path": "app/src/main/java/org/jellyfin/androidtv/details/actions/ToggleWatchedAction.kt", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzo0NjozMlrOFkx1NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzo0NjozMlrOFkx1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEwOTQ5Mw==", "bodyText": "I missed this in my review, we probably should overwrite everything in the item with information that the server sends us in response to marking played / unplayed.", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374109493", "createdAt": "2020-02-03T13:46:32Z", "author": {"login": "AndreasGB"}, "path": "app/src/main/java/org/jellyfin/androidtv/details/actions/ToggleWatchedAction.kt", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.jellyfin.androidtv.details.actions\n+\n+import android.content.Context\n+import kotlinx.coroutines.Dispatchers\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.launch\n+import org.jellyfin.androidtv.R\n+import org.jellyfin.androidtv.TvApp\n+import org.jellyfin.androidtv.model.itemtypes.PlayableItem\n+import org.jellyfin.androidtv.util.apiclient.markPlayed\n+import org.jellyfin.androidtv.util.apiclient.markUnplayed\n+\n+class ToggleWatchedAction(context: Context, val item: PlayableItem) : ToggleAction(ActionID.TOGGLE_WATCHED.id, context) {\n+\tinit {\n+\t\tactive = item.played\n+\t\tlabel1 = context.getString(R.string.lbl_watched)\n+\t}\n+\n+\toverride fun onClick() {\n+\t\tGlobalScope.launch(Dispatchers.Main) {\n+\t\t\tval apiClient = TvApp.getApplication().apiClient\n+\n+\t\t\tif (item.played) apiClient.markUnplayed(item.id, TvApp.getApplication().currentUser.id)\n+\t\t\telse apiClient.markPlayed(item.id, TvApp.getApplication().currentUser.id, null)\n+\n+\t\t\titem.played = !item.played", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a289e38659caaf1715b78808950becfdb2259b84"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1129, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}