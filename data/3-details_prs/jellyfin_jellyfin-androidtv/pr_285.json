{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwMjY0NTM5", "number": 285, "title": "Details refactor", "bodyText": "I did quite a lot on this branch.. whoops\nChanged include:\n\nObserver implementation for item classes\nBetter looking code for the detail fragments\nCustom action adapter\n\nSupports resetting all items\nShows icons above text\nAdds a new \"ToggleAction\" class that will be colored on screen when active\n\n\nAdded new icons\n\nReplace bitmap resume with vector icon (custom made)\nAdd menu vector icon\n\n\n\nI probably broke things too!", "createdAt": "2020-02-03T11:21:54Z", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285", "merged": true, "mergeCommit": {"oid": "5d7131d6162a1e1d1db623a2f217edf998a3d256"}, "closed": true, "closedAt": "2020-02-03T15:58:10Z", "author": {"login": "nielsvanvelzen"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAFyyigH2gAyMzcwMjY0NTM5OjA0Yjk1MmFiZWU3NzJjNGI2YzFjMzg1NGFmYTcxZmM0NWU1NmEyODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAu-gFgH2gAyMzcwMjY0NTM5OjE5NWE1Njk1ZTRmZTM5YTdmNWE1NTRmZmU4ZWY5NGY1MGJjZjM4YWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "04b952abee772c4b6c1c3854afa71fc45e56a283", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/04b952abee772c4b6c1c3854afa71fc45e56a283", "committedDate": "2020-02-01T15:51:05Z", "message": "Rewrite BaseDetailsFragment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ae6feb39c98131383164bc8080590a2ea4170f7", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/3ae6feb39c98131383164bc8080590a2ea4170f7", "committedDate": "2020-02-01T16:25:41Z", "message": "Add actions (Includes #280)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7a9a1d07809be87b3282997470480949f275f55", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/c7a9a1d07809be87b3282997470480949f275f55", "committedDate": "2020-02-02T11:00:17Z", "message": "Add vector icon for ic_resume"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15213410417e5e90c8dd5f10f4a679b48299a5c0", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/15213410417e5e90c8dd5f10f4a679b48299a5c0", "committedDate": "2020-02-02T11:12:44Z", "message": "Add actions with icons"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01d3b7da0a86e04a528133259bc79263c2d5aead", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/01d3b7da0a86e04a528133259bc79263c2d5aead", "committedDate": "2020-02-03T09:41:27Z", "message": "Add observer implementation for dynamic updates of the layout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53ed6a0227a94134e4ea3e69fb0762e9f52c0a91", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/53ed6a0227a94134e4ea3e69fb0762e9f52c0a91", "committedDate": "2020-02-03T09:42:12Z", "message": "Misc changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "493046aeb9abcbe3eef8ae8f9390b0541544176d", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/493046aeb9abcbe3eef8ae8f9390b0541544176d", "committedDate": "2020-02-03T10:07:17Z", "message": "Add favorite toggle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a289e38659caaf1715b78808950becfdb2259b84", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/a289e38659caaf1715b78808950becfdb2259b84", "committedDate": "2020-02-03T11:17:05Z", "message": "Add custom actionbar design"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMjQzNzcy", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#pullrequestreview-352243772", "createdAt": "2020-02-03T13:17:03Z", "commit": {"oid": "a289e38659caaf1715b78808950becfdb2259b84"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzoxNzowM1rOFkw82Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzozMDowNFrOFkxVdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA5NTA2NQ==", "bodyText": "I think the playbackPositionTicks > 0 check should be sufficient, since the original.canResume just does a basically equivalent check.\n\tpublic final boolean getCanResume()\n\t{\n\t\treturn getUserData() != null && getUserData().getPlaybackPositionTicks() > 0;\n\t}\nhttps://github.com/jellyfin/jellyfin-apiclient-java/blob/master/library/src/main/java/org/jellyfin/apiclient/model/dto/BaseItemDto.java#L2311", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374095065", "createdAt": "2020-02-03T13:17:03Z", "author": {"login": "AndreasGB"}, "path": "app/src/main/java/org/jellyfin/androidtv/model/itemtypes/LiftedItems.kt", "diffHunk": "@@ -4,20 +4,23 @@ import org.jellyfin.apiclient.model.dto.BaseItemDto\n import org.jellyfin.apiclient.model.dto.BaseItemType\n import org.jellyfin.apiclient.model.dto.ChapterInfoDto\n import java.util.*\n+import kotlin.properties.Delegates\n \n-sealed class BaseItem(original: BaseItemDto) {\n+sealed class BaseItem(original: BaseItemDto) : ObservableParent() {\n \tval id: String = original.id\n \tval name: String = original.name\n \tval description: String? = original.overview\n \tval images: ImageCollection = ImageCollection(original)\n \tval added: Date = original.dateCreated\n+\tvar favorite: Boolean by Delegates.observable(original.userData.isFavorite, ::observer)\n }\n \n sealed class PlayableItem(original: BaseItemDto) : BaseItem(original) {\n-\tval canResume: Boolean = original.canResume\n \tval playbackPositionTicks: Long = original.userData.playbackPositionTicks\n+\tval canResume: Boolean = original.canResume && playbackPositionTicks > 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a289e38659caaf1715b78808950becfdb2259b84"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEwMTM2Ng==", "bodyText": "Maybe we should add proper error handling for all these coroutines before we release", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374101366", "createdAt": "2020-02-03T13:30:04Z", "author": {"login": "AndreasGB"}, "path": "app/src/main/java/org/jellyfin/androidtv/util/apiclient/ApiClientExtensions.kt", "diffHunk": "@@ -29,3 +30,25 @@ suspend fun ApiClient.getItem(id: String): BaseItemDto? = suspendCoroutine { con\n \t\toverride fun onError(exception: Exception?) = continuation.resume(null)\n \t})\n }\n+\n+suspend fun ApiClient.markPlayed(itemId: String, userId: String, datePlayed: Date?) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tMarkPlayedAsync(itemId, userId, datePlayed, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }\n+\t})\n+}\n+\n+suspend fun ApiClient.markUnplayed(itemId: String, userId: String) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tMarkUnplayedAsync(itemId, userId, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }\n+\t})\n+}\n+\n+\n+suspend fun ApiClient.updateFavoriteStatus(itemId: String, userId: String, isFavorite: Boolean) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tUpdateFavoriteStatusAsync(itemId, userId, isFavorite, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a289e38659caaf1715b78808950becfdb2259b84"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMjYyNDA0", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#pullrequestreview-352262404", "createdAt": "2020-02-03T13:46:31Z", "commit": {"oid": "a289e38659caaf1715b78808950becfdb2259b84"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzo0NjozMlrOFkx1NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzo0NjozMlrOFkx1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEwOTQ5Mw==", "bodyText": "I missed this in my review, we probably should overwrite everything in the item with information that the server sends us in response to marking played / unplayed.", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374109493", "createdAt": "2020-02-03T13:46:32Z", "author": {"login": "AndreasGB"}, "path": "app/src/main/java/org/jellyfin/androidtv/details/actions/ToggleWatchedAction.kt", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.jellyfin.androidtv.details.actions\n+\n+import android.content.Context\n+import kotlinx.coroutines.Dispatchers\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.launch\n+import org.jellyfin.androidtv.R\n+import org.jellyfin.androidtv.TvApp\n+import org.jellyfin.androidtv.model.itemtypes.PlayableItem\n+import org.jellyfin.androidtv.util.apiclient.markPlayed\n+import org.jellyfin.androidtv.util.apiclient.markUnplayed\n+\n+class ToggleWatchedAction(context: Context, val item: PlayableItem) : ToggleAction(ActionID.TOGGLE_WATCHED.id, context) {\n+\tinit {\n+\t\tactive = item.played\n+\t\tlabel1 = context.getString(R.string.lbl_watched)\n+\t}\n+\n+\toverride fun onClick() {\n+\t\tGlobalScope.launch(Dispatchers.Main) {\n+\t\t\tval apiClient = TvApp.getApplication().apiClient\n+\n+\t\t\tif (item.played) apiClient.markUnplayed(item.id, TvApp.getApplication().currentUser.id)\n+\t\t\telse apiClient.markPlayed(item.id, TvApp.getApplication().currentUser.id, null)\n+\n+\t\t\titem.played = !item.played", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a289e38659caaf1715b78808950becfdb2259b84"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "195a5695e4fe39a7f5a554ffe8ef94f50bcf38aa", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/195a5695e4fe39a7f5a554ffe8ef94f50bcf38aa", "committedDate": "2020-02-03T15:49:59Z", "message": "Set item values from api response"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4372, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}