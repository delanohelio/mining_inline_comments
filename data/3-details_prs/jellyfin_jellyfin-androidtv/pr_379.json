{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0OTY1Mjc2", "number": 379, "title": "Replace leanback details fragment with custom implementation", "bodyText": "This PR replaces the DetailsSupportFragment with the way more simple RowsSupportFragment and creates a custom row for the details instead of using DetailsOverviewRow.\nThese changes allow us to add more customization instead of being bound to the way Leanback wants us to do it.\nScreenshots\n\nInitial changes that could compile\n\nInitial working version with basic layouting\n\nAdding poster/backdrop\n\nFixed backdrop+actions\n\nConverting to a single ConstraintLayout\n\nPink theme!\n\nFinal design for now, working on fixing actions\n\nChanged the padding/marings on the buttons and started on fixing their behavior\n\nWhat still needs to be done before merging:\n\n Fix action styling\n Add back parallax scrolling\n Fix action logic", "createdAt": "2020-03-06T18:40:22Z", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/379", "merged": true, "mergeCommit": {"oid": "670c513aae578e7def2f6806db68bcb52c6b825c"}, "closed": true, "closedAt": "2020-03-22T11:13:58Z", "author": {"login": "nielsvanvelzen"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLSC3MABqjMxMDc2MTY2MDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQHytwAFqTM3ODk5NDE4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2748169ff6cffc62d96845401e224050ec3c0c42", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/2748169ff6cffc62d96845401e224050ec3c0c42", "committedDate": "2020-03-06T18:33:22Z", "message": "Replace leanback details fragment with custom implementation"}, "afterCommit": {"oid": "543e72621339d1e427e748ee9991ced01606c730", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/543e72621339d1e427e748ee9991ced01606c730", "committedDate": "2020-03-07T10:20:30Z", "message": "Replace leanback details fragment with custom implementation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "543e72621339d1e427e748ee9991ced01606c730", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/543e72621339d1e427e748ee9991ced01606c730", "committedDate": "2020-03-07T10:20:30Z", "message": "Replace leanback details fragment with custom implementation"}, "afterCommit": {"oid": "7103e2d8bfa0953931e8f8452017c0ec98551103", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/7103e2d8bfa0953931e8f8452017c0ec98551103", "committedDate": "2020-03-07T13:55:56Z", "message": "Replace leanback details fragment with custom implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d566b31bd9dc278f54205d2c2afc8dc16679be0", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/4d566b31bd9dc278f54205d2c2afc8dc16679be0", "committedDate": "2020-03-10T21:02:35Z", "message": "Replace leanback details fragment with custom implementation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7103e2d8bfa0953931e8f8452017c0ec98551103", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/7103e2d8bfa0953931e8f8452017c0ec98551103", "committedDate": "2020-03-07T13:55:56Z", "message": "Replace leanback details fragment with custom implementation"}, "afterCommit": {"oid": "4d566b31bd9dc278f54205d2c2afc8dc16679be0", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/4d566b31bd9dc278f54205d2c2afc8dc16679be0", "committedDate": "2020-03-10T21:02:35Z", "message": "Replace leanback details fragment with custom implementation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edb12e75821f3b1f9a0ff4e7906d229b502f7ce9", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/edb12e75821f3b1f9a0ff4e7906d229b502f7ce9", "committedDate": "2020-03-13T11:17:00Z", "message": "Convert actions to LiveData"}, "afterCommit": {"oid": "b16055bb8c45983e12ad2d72e199579ed273584b", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/b16055bb8c45983e12ad2d72e199579ed273584b", "committedDate": "2020-03-13T12:34:16Z", "message": "Convert actions to LiveData"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9bce59d52135ef1c707ae593c91110ca5e3614f", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/d9bce59d52135ef1c707ae593c91110ca5e3614f", "committedDate": "2020-03-13T12:54:41Z", "message": "Convert actions to LiveData"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b16055bb8c45983e12ad2d72e199579ed273584b", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/b16055bb8c45983e12ad2d72e199579ed273584b", "committedDate": "2020-03-13T12:34:16Z", "message": "Convert actions to LiveData"}, "afterCommit": {"oid": "d9bce59d52135ef1c707ae593c91110ca5e3614f", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/d9bce59d52135ef1c707ae593c91110ca5e3614f", "committedDate": "2020-03-13T12:54:41Z", "message": "Convert actions to LiveData"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d20d60396080c9a0245be090f5756fbb9dd22d74", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/d20d60396080c9a0245be090f5756fbb9dd22d74", "committedDate": "2020-03-13T13:10:16Z", "message": "Misc fixes\n\n- Interfaces for action\n- fixed ugly casting for actions\n- random cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e6fdc48362329d965a6801ab57458d47c2e37dc", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/9e6fdc48362329d965a6801ab57458d47c2e37dc", "committedDate": "2020-03-14T20:02:06Z", "message": "Fix duplicate actions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0ODMwNjQ2", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/379#pullrequestreview-374830646", "createdAt": "2020-03-15T20:24:22Z", "commit": {"oid": "9e6fdc48362329d965a6801ab57458d47c2e37dc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQyMDoyNDoyM1rOF2hEKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQyMDo0NToxNFrOF2hLKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcwOTE2MQ==", "bodyText": "We probably should decide on one image handling library before we ship this", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/379#discussion_r392709161", "createdAt": "2020-03-15T20:24:23Z", "author": {"login": "AndreasGB"}, "path": "app/src/main/java/org/jellyfin/androidtv/details/DetailsOverviewPresenter.kt", "diffHunk": "@@ -52,17 +68,41 @@ class DetailsDescriptionPresenter : Presenter() {\n \t\tval textStreamValue: TextView = view.details_description_streams_text_value\n \t}\n \n-\toverride fun onCreateViewHolder(parent: ViewGroup): ViewHolder {\n+\toverride fun createRowViewHolder(parent: ViewGroup): ViewHolder {\n \t\tval view = LayoutInflater\n \t\t\t.from(parent.context)\n \t\t\t.inflate(R.layout.row_details_description, parent, false)\n \n \t\treturn ViewHolder(view)\n \t}\n \n-\toverride fun onBindViewHolder(viewHolder: Presenter.ViewHolder, item: Any) {\n+\toverride fun onBindRowViewHolder(viewHolder: RowPresenter.ViewHolder, row: Any) {\n \t\tviewHolder as ViewHolder\n-\t\titem as BaseItem\n+\t\trow as DetailsOverviewRow\n+\t\tval item = row.item\n+\n+\t\t// banner\n+\t\t//todo hide banner view when none found, support multiple banners\n+\t\titem.images.backdrops.firstOrNull()?.let {\n+\t\t\t// Android doesn't crop automatically but Glide does\n+\t\t\t// Picasso can also do this but doesn't read the XML attributes of the target view for it\n+\t\t\t// so the way Glide does it is preferred to avoid duplicate settings\n+\t\t\tGlide.with(viewHolder.view.context).load(it.url).into(viewHolder.banner)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e6fdc48362329d965a6801ab57458d47c2e37dc"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcxMDk1Mw==", "bodyText": "Should this be changed on unbind?", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/379#discussion_r392710953", "createdAt": "2020-03-15T20:45:14Z", "author": {"login": "AndreasGB"}, "path": "app/src/main/java/org/jellyfin/androidtv/details/actions/ActionAdapter.kt", "diffHunk": "@@ -1,86 +1,74 @@\n package org.jellyfin.androidtv.details.actions\n \n+import android.content.res.ColorStateList\n+import android.os.Build\n import android.view.LayoutInflater\n import android.view.View\n import android.view.ViewGroup\n import android.widget.Button\n-import androidx.leanback.widget.Action\n-import androidx.leanback.widget.ObjectAdapter\n-import androidx.leanback.widget.Presenter\n+import androidx.lifecycle.Lifecycle\n+import androidx.lifecycle.LifecycleOwner\n+import androidx.lifecycle.LifecycleRegistry\n+import androidx.lifecycle.Observer\n+import androidx.recyclerview.widget.RecyclerView\n+import kotlinx.coroutines.Dispatchers\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.launch\n import org.jellyfin.androidtv.R\n \n-class ActionAdapter : ObjectAdapter(ActionPresenter()) {\n-\tprivate val actions = arrayListOf<Action>()\n-\tprivate var visibleActions = emptyList<Action>()\n+class ActionAdapter() {\n+\tfun createViewHolder(parent: ViewGroup): ActionViewHolder {\n+\t\tval view = LayoutInflater\n+\t\t\t.from(parent.context)\n+\t\t\t.inflate(R.layout.action, parent, false)\n \n-\tfun add(action: Action) {\n-\t\t// Add action\n-\t\tactions += action\n-\n-\t\t// Bind listener\n-\t\tif (action is BaseAction) action.onVisibilityChanged = ::commit\n+\t\treturn ActionViewHolder(view)\n \t}\n \n-\tfun commit() {\n-\t\t// Update visible actions\n-\t\tvisibleActions = actions.filter { action -> action !is BaseAction || action.isVisible }\n-\n-\t\t// Notify the actions have changed\n-\t\tnotifyChanged()\n-\t}\n-\n-\toverride fun size() = visibleActions.size\n-\toverride fun get(position: Int) = visibleActions.getOrNull(position)\n-\n-\tfun setVisibility(action: BaseAction, visible: Boolean) {\n-\t\taction.isVisible = visible\n-\n-\t\tcommit()\n-\t}\n-\n-\tprivate class ActionPresenter : Presenter() {\n-\t\toverride fun onCreateViewHolder(parent: ViewGroup): ViewHolder {\n-\t\t\tval view = LayoutInflater\n-\t\t\t\t.from(parent.context)\n-\t\t\t\t.inflate(R.layout.action, parent, false)\n-\n-\t\t\treturn ActionViewHolder(view)\n+\tfun bindViewHolder(viewHolder: ActionViewHolder, action: Action) {\n+\t\t// Visibility\n+\t\taction.visible.observe(viewHolder, Observer { visible ->\n+\t\t\tviewHolder.view.visibility = if (visible) View.VISIBLE else View.GONE\n+\t\t\tviewHolder.button.visibility = if (visible) View.VISIBLE else View.GONE\n+\t\t})\n+\n+\t\t// Icon\n+\t\taction.icon.observe(viewHolder, Observer { icon ->\n+\t\t\tviewHolder.button.setCompoundDrawablesWithIntrinsicBounds(null, icon, null, null)\n+\t\t})\n+\n+\t\t// Text\n+\t\taction.text.observe(viewHolder, Observer { text ->\n+\t\t\tviewHolder.button.text = text\n+\t\t})\n+\n+\t\t// Active state\n+\t\tif (action is ToggleableAction) {\n+\t\t\taction.active.observe(viewHolder, Observer { active ->\n+\t\t\t\tval color = viewHolder.button.resources.getColor(if (active) R.color.action_active else R.color.white)\n+\t\t\t\tviewHolder.button.setTextColor(color)\n+\t\t\t\tif (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M)\n+\t\t\t\t\tviewHolder.button.compoundDrawableTintList = ColorStateList.valueOf(color)\n+\t\t\t})\n \t\t}\n \n-\t\toverride fun onBindViewHolder(viewHolder: ViewHolder, action: Any) {\n-\t\t\t// Cast types\n-\t\t\taction as Action\n-\t\t\tviewHolder as ActionViewHolder\n-\n-\t\t\t// Set data\n-\t\t\tviewHolder.button.setCompoundDrawablesWithIntrinsicBounds(null, action.icon, null, null)\n-\t\t\tviewHolder.button.text = action.label1\n-\n-\t\t\tif (action is SecondariesPopupAction) {\n-\t\t\t\taction.anchor = viewHolder.button\n-\t\t\t}\n-\n-\t\t\tif (action is ToggleAction) {\n-\t\t\t\tval color = if (action.active) R.color.action_active else R.color.white\n-\n-\t\t\t\tviewHolder.button.apply {\n-\t\t\t\t\taction.icon.setTint(resources.getColor(color))\n-\t\t\t\t\tsetTextColor(resources.getColor(color))\n-\t\t\t\t}\n+\t\t// Click listener\n+\t\tviewHolder.button.setOnClickListener { view ->\n+\t\t\tGlobalScope.launch(Dispatchers.Main) {\n+\t\t\t\taction.onClick(view)\n \t\t\t}\n \t\t}\n \n-\t\toverride fun onUnbindViewHolder(viewHolder: ViewHolder) {\n-\t\t\tviewHolder as ActionViewHolder\n+\t\t// Set state so the observers initialize\n+\t\tviewHolder.lifecycle.currentState = Lifecycle.State.STARTED", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e6fdc48362329d965a6801ab57458d47c2e37dc"}, "originalPosition": 121}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a471bf81b7bf93d19760d0c0d163a339cbe18f4", "author": {"user": {"login": "nielsvanvelzen", "name": "Niels van Velzen"}}, "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/7a471bf81b7bf93d19760d0c0d163a339cbe18f4", "committedDate": "2020-03-21T08:54:19Z", "message": "Implement unbinding for action adapter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4OTk0MTg4", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/379#pullrequestreview-378994188", "createdAt": "2020-03-22T11:13:36Z", "commit": {"oid": "7a471bf81b7bf93d19760d0c0d163a339cbe18f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4286, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}