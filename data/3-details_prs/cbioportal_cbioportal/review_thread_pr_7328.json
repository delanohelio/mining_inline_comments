{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMTI4OTgz", "number": 7328, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxODoxMzoxM1rOD3Ugdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMDoyNjoyOVrOD3XgEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MzM0MjYyOnYy", "diffSide": "RIGHT", "path": "db-scripts/src/main/resources/migration.sql", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxODoxMzoxM1rOGNg07g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMDo0Njo0NVrOGNmP8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgyMjUxMA==", "bodyText": "These mappings correspond with inventory of survival types captured in 7292.  Note when the select statement is run against clinical_attribute_meta on the private database, additional attributes are identified beyond which are captured in the issue (which is restricted to the public database).  We should clarify if/when this gets run on the private database.", "url": "https://github.com/cBioPortal/cbioportal/pull/7328#discussion_r416822510", "createdAt": "2020-04-28T18:13:13Z", "author": {"login": "n1zea144"}, "path": "db-scripts/src/main/resources/migration.sql", "diffHunk": "@@ -849,4 +849,23 @@ CREATE TABLE `resource_study` (\n   PRIMARY KEY (`INTERNAL_ID`, `RESOURCE_ID`, `URL`),\n   FOREIGN KEY (`INTERNAL_ID`) REFERENCES `cancer_study` (`CANCER_STUDY_ID`) ON DELETE CASCADE\n );\n-UPDATE `info` SET `DB_SCHEMA_VERSION`=\"2.12.4\";\n\\ No newline at end of file\n+UPDATE `info` SET `DB_SCHEMA_VERSION`=\"2.12.4\";\n+\n+##version: 2.12.5\n+-- survival data migration\n+-- create temporary table to store survival attributes\n+CREATE TEMPORARY TABLE IF NOT EXISTS survival_attributes AS \n+  (SELECT DISTINCT Concat(Substr(ATTR_ID, 1, Char_length(ATTR_ID) - 7), \n+                   \"_STATUS\") AS ATTR_ID \n+   FROM   clinical_attribute_meta \n+   WHERE  ATTR_ID LIKE \"%_STATUS\" \n+          AND Substr(ATTR_ID, 1, Char_length(ATTR_ID) - 7)IN (SELECT DISTINCT \n+              Substr(ATTR_ID, 1, Char_length(ATTR_ID) - 7) AS \n+              SurvivalDataStatusPrefix \n+              FROM   clinical_attribute_meta \n+              WHERE  ATTR_ID LIKE \"%_MONTHS\")); \n+\n+-- mapping to 0/1\n+UPDATE clinical_patient SET ATTR_VALUE = CONCAT(\"1:\",ATTR_ID) WHERE ATTR_ID in (SELECT ATTR_ID FROM survival_attributes) AND ATTR_VALUE in ('DECEASED','Recurred/Progressed','Recurred','Progressed','Yes','yes','1','PROGRESSION','Event','DEAD OF MELANOMA','DEAD WITH TUMOR','Metastatic','Relapse','Localized');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "765a1ee68d84ae3abb0ad6f5837494b7d08bceef"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkxMTM0Ng==", "bodyText": "FYI, 7323 also captured the vocabularies from the MSK portal.", "url": "https://github.com/cBioPortal/cbioportal/pull/7328#discussion_r416911346", "createdAt": "2020-04-28T20:46:45Z", "author": {"login": "dippindots"}, "path": "db-scripts/src/main/resources/migration.sql", "diffHunk": "@@ -849,4 +849,23 @@ CREATE TABLE `resource_study` (\n   PRIMARY KEY (`INTERNAL_ID`, `RESOURCE_ID`, `URL`),\n   FOREIGN KEY (`INTERNAL_ID`) REFERENCES `cancer_study` (`CANCER_STUDY_ID`) ON DELETE CASCADE\n );\n-UPDATE `info` SET `DB_SCHEMA_VERSION`=\"2.12.4\";\n\\ No newline at end of file\n+UPDATE `info` SET `DB_SCHEMA_VERSION`=\"2.12.4\";\n+\n+##version: 2.12.5\n+-- survival data migration\n+-- create temporary table to store survival attributes\n+CREATE TEMPORARY TABLE IF NOT EXISTS survival_attributes AS \n+  (SELECT DISTINCT Concat(Substr(ATTR_ID, 1, Char_length(ATTR_ID) - 7), \n+                   \"_STATUS\") AS ATTR_ID \n+   FROM   clinical_attribute_meta \n+   WHERE  ATTR_ID LIKE \"%_STATUS\" \n+          AND Substr(ATTR_ID, 1, Char_length(ATTR_ID) - 7)IN (SELECT DISTINCT \n+              Substr(ATTR_ID, 1, Char_length(ATTR_ID) - 7) AS \n+              SurvivalDataStatusPrefix \n+              FROM   clinical_attribute_meta \n+              WHERE  ATTR_ID LIKE \"%_MONTHS\")); \n+\n+-- mapping to 0/1\n+UPDATE clinical_patient SET ATTR_VALUE = CONCAT(\"1:\",ATTR_ID) WHERE ATTR_ID in (SELECT ATTR_ID FROM survival_attributes) AND ATTR_VALUE in ('DECEASED','Recurred/Progressed','Recurred','Progressed','Yes','yes','1','PROGRESSION','Event','DEAD OF MELANOMA','DEAD WITH TUMOR','Metastatic','Relapse','Localized');", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgyMjUxMA=="}, "originalCommit": {"oid": "765a1ee68d84ae3abb0ad6f5837494b7d08bceef"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MzM1NjEwOnYy", "diffSide": "RIGHT", "path": "db-scripts/src/main/resources/migration.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxODoxNjo0MlrOGNg9QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxODoxNjo0MlrOGNg9QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgyNDY0MQ==", "bodyText": "Only select %_STATUS attributes which have a corresponding %_MONTHS attribute.", "url": "https://github.com/cBioPortal/cbioportal/pull/7328#discussion_r416824641", "createdAt": "2020-04-28T18:16:42Z", "author": {"login": "n1zea144"}, "path": "db-scripts/src/main/resources/migration.sql", "diffHunk": "@@ -849,4 +849,23 @@ CREATE TABLE `resource_study` (\n   PRIMARY KEY (`INTERNAL_ID`, `RESOURCE_ID`, `URL`),\n   FOREIGN KEY (`INTERNAL_ID`) REFERENCES `cancer_study` (`CANCER_STUDY_ID`) ON DELETE CASCADE\n );\n-UPDATE `info` SET `DB_SCHEMA_VERSION`=\"2.12.4\";\n\\ No newline at end of file\n+UPDATE `info` SET `DB_SCHEMA_VERSION`=\"2.12.4\";\n+\n+##version: 2.12.5\n+-- survival data migration\n+-- create temporary table to store survival attributes\n+CREATE TEMPORARY TABLE IF NOT EXISTS survival_attributes AS \n+  (SELECT DISTINCT Concat(Substr(ATTR_ID, 1, Char_length(ATTR_ID) - 7), \n+                   \"_STATUS\") AS ATTR_ID \n+   FROM   clinical_attribute_meta \n+   WHERE  ATTR_ID LIKE \"%_STATUS\" \n+          AND Substr(ATTR_ID, 1, Char_length(ATTR_ID) - 7)IN (SELECT DISTINCT \n+              Substr(ATTR_ID, 1, Char_length(ATTR_ID) - 7) AS \n+              SurvivalDataStatusPrefix \n+              FROM   clinical_attribute_meta \n+              WHERE  ATTR_ID LIKE \"%_MONTHS\")); ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "765a1ee68d84ae3abb0ad6f5837494b7d08bceef"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MzgzMzE1OnYy", "diffSide": "RIGHT", "path": "db-scripts/src/main/resources/migration.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMDoyNjoyOVrOGNlkIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMDoyNjoyOVrOGNlkIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkwMDEyOQ==", "bodyText": "Given that a temporary table is created, I don't think the \"If not exists\" clause is required, but it doesn't hurt.", "url": "https://github.com/cBioPortal/cbioportal/pull/7328#discussion_r416900129", "createdAt": "2020-04-28T20:26:29Z", "author": {"login": "n1zea144"}, "path": "db-scripts/src/main/resources/migration.sql", "diffHunk": "@@ -849,4 +849,23 @@ CREATE TABLE `resource_study` (\n   PRIMARY KEY (`INTERNAL_ID`, `RESOURCE_ID`, `URL`),\n   FOREIGN KEY (`INTERNAL_ID`) REFERENCES `cancer_study` (`CANCER_STUDY_ID`) ON DELETE CASCADE\n );\n-UPDATE `info` SET `DB_SCHEMA_VERSION`=\"2.12.4\";\n\\ No newline at end of file\n+UPDATE `info` SET `DB_SCHEMA_VERSION`=\"2.12.4\";\n+\n+##version: 2.12.5\n+-- survival data migration\n+-- create temporary table to store survival attributes\n+CREATE TEMPORARY TABLE IF NOT EXISTS survival_attributes AS ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "765a1ee68d84ae3abb0ad6f5837494b7d08bceef"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3608, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}