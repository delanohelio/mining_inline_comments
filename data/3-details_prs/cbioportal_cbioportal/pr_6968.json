{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4ODA3ODA3", "number": 6968, "title": "Structural variant fixes for 3.2.0", "bodyText": "Fix #6966\nChanges proposed in this pull request:\n\n modify the existing GeneticProfileReader DAO object to add a structural variant profile when importing a study with old style fusion data\n modify existing Sample service to mark samples profiled by Fusion and supports any studies with or without a _sv case list\n update File-Formats.md to include a new structural variant/fusion case list which will be used to calculate the percentage of samples with fusions.\n use sequenced case list to calculate the percentage of samples with fusions if no structural variant/fusion case list suplied\n\nChecks\n\n Runs on heroku\n Has tests or has a separate issue that describes the types of test that should be created. If no test is included it should explicitly be mentioned in the PR why there is no test.\n The commit log is comprehensible. It follows 7 rules of great commit messages. For most PRs a single commit should suffice, in some cases multiple topical commits can be useful. During review it is ok to see tiny commits (e.g. Fix reviewer comments), but right before the code gets merged to master or rc branch, any such commits should be squashed since they are useless to the other developers. Definitely avoid merge commits, use rebase instead.\n Is this PR adding logic based on one or more clinical attributes? If yes, please make sure validation for this attribute is also present in the data validation / data loading layers (in backend repo) and documented in File-Formats Clinical data section!\n\nAny screenshots or GIFs?\nIf this is a new visual feature please add a before/after screenshot or gif\nhere with e.g. GifGrabber.\nNotify reviewers\nRead our Pull request merging\npolicy. It can help to figure out who worked on the\nfile before you. Please use git blame <filename> to determine that\nand notify them either through slack or by assigning them as a reviewer on the PR", "createdAt": "2020-01-02T21:56:28Z", "url": "https://github.com/cBioPortal/cbioportal/pull/6968", "merged": true, "mergeCommit": {"oid": "88f8cfd2b0cace48e5fa1f7e03693a82927c602b"}, "closed": true, "closedAt": "2020-01-14T18:16:45Z", "author": {"login": "khzhu"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2g1ewgH2gAyMzU4ODA3ODA3OjEzOGVmZWRlNzM4Y2Q1NmQ4YTRkYTk0MjNlNmFjODMzNjliNGFmYmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6BJPUAH2gAyMzU4ODA3ODA3OjM1MTlmMzU3NTAzN2E0NzMyOWVhODYzMWU3NzJjNjYwZDZhYzRhNjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "138efede738cd56d8a4da9423e6ac83369b4afbc", "author": {"user": null}, "url": "https://github.com/cBioPortal/cbioportal/commit/138efede738cd56d8a4da9423e6ac83369b4afbc", "committedDate": "2020-01-02T21:42:13Z", "message": "populate structural variant profile after importing mutation and fusion data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57babf99549b6c763ed4bf7b6eac957eccd79d68", "author": {"user": null}, "url": "https://github.com/cBioPortal/cbioportal/commit/57babf99549b6c763ed4bf7b6eac957eccd79d68", "committedDate": "2020-01-02T23:08:25Z", "message": "fixing CI build error and correcting genetic profile counts for fusions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MjIyNDcz", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#pullrequestreview-338222473", "createdAt": "2020-01-03T18:53:27Z", "commit": {"oid": "57babf99549b6c763ed4bf7b6eac957eccd79d68"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxODo1MzoyN1rOFaG5XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxODo1MzoyN1rOFaG5XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMDI4NQ==", "bodyText": "there is a comment right above this:\n// Is there a separate fusion profile? -> false\n\nthe test is now changed to actually check if a separate fusion profile exists, so that comment should prolly be updated if this is indeed what we want", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#discussion_r362920285", "createdAt": "2020-01-03T18:53:27Z", "author": {"login": "inodb"}, "path": "core/src/test/java/org/mskcc/cbio/portal/scripts/TestIntegrationTest.java", "diffHunk": "@@ -184,7 +184,7 @@ public void testLoadStudyEs0() throws Throwable {\n             geneticProfileStableIds.add(\"study_es_0_fusion\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57babf99549b6c763ed4bf7b6eac957eccd79d68"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19c6402aad61f9a926f8a29ff8bbf2446af44c87", "author": {"user": null}, "url": "https://github.com/cBioPortal/cbioportal/commit/19c6402aad61f9a926f8a29ff8bbf2446af44c87", "committedDate": "2020-01-04T21:59:22Z", "message": "solve the fusion case list backfilling issue by using existing Sample service to mark samples profiled by Fusion and supports any studies with/without a _sv case list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29990cb05e7a80f2fac52f3df0e2e09f574b206d", "author": {"user": null}, "url": "https://github.com/cBioPortal/cbioportal/commit/29990cb05e7a80f2fac52f3df0e2e09f574b206d", "committedDate": "2020-01-05T00:05:40Z", "message": "fixing CI build null point exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4ODM4MzAw", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#pullrequestreview-338838300", "createdAt": "2020-01-06T19:16:23Z", "commit": {"oid": "29990cb05e7a80f2fac52f3df0e2e09f574b206d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MzE5Nzg0", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#pullrequestreview-339319784", "createdAt": "2020-01-07T15:43:35Z", "commit": {"oid": "29990cb05e7a80f2fac52f3df0e2e09f574b206d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNTo0MzozNlrOFa9PyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNTo0MzozNlrOFa9PyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgxMDc2MA==", "bodyText": "I guess this relies on this part? \n  \n    \n      cbioportal/core/src/main/java/org/mskcc/cbio/portal/util/GeneticProfileReader.java\n    \n    \n        Lines 290 to 301\n      in\n      7ae3828\n    \n    \n    \n    \n\n        \n          \n           // Workaround to import fusion data as mutation genetic profile. This way fusion meta file can contain 'stable_id: fusion'. \n        \n\n        \n          \n           // The validator will check for 'stable_id: fusion', and this section in the importer \n        \n\n        \n          \n           // will convert it to 'stable_id: mutations'. See https://github.com/cBioPortal/cbioportal/pull/2506 \n        \n\n        \n          \n           // TODO: This should be removed when other parts of cBioPortal have implemented support for a separate fusion profile\". \n        \n\n        \n          \n           if (stableId.equals(cancerStudyIdentifier + \"_fusion\")) { \n        \n\n        \n          \n               String newStableId = cancerStudyIdentifier + \"_mutations\"; \n        \n\n        \n          \n               GeneticProfile existingGeneticProfile = DaoGeneticProfile.getGeneticProfileByStableId(newStableId); \n        \n\n        \n          \n               if (existingGeneticProfile == null) { \n        \n\n        \n          \n                   throw new IllegalArgumentException(\"Wrong order: FUSION data should be loaded after MUTATION data\"); \n        \n\n        \n          \n               } \n        \n\n        \n          \n               stableId = newStableId; \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nit's a little funky but I guess we can remove all the FUSION conditional once we remove FUSION data and only have STRUCTURAL_VARIANT GeneticAlterationType:\nhttps://github.com/cBioPortal/cbioportal/blob/master/core/src/main/java/org/mskcc/cbio/portal/model/GeneticAlterationType.java#L42-L43", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#discussion_r363810760", "createdAt": "2020-01-07T15:43:36Z", "author": {"login": "inodb"}, "path": "core/src/main/java/org/mskcc/cbio/portal/util/GeneticProfileReader.java", "diffHunk": "@@ -82,6 +82,12 @@ public static GeneticProfile loadGeneticProfile(File file) throws IOException, D\n                throw new RuntimeException(\"Error: genetic_profile record found with same Stable ID as the one used in your data:  \"\n                        + existingGeneticProfile.getStableId() + \". Remove the existing genetic_profile record first.\");\n             } else if (geneticProfile.getDatatype().equals(\"FUSION\")) {\n+                // populate the structural variant genetic profile for fusions\n+                GeneticProfile gp = new GeneticProfile(geneticProfile);\n+                gp.setGeneticAlterationType(GeneticAlterationType.STRUCTURAL_VARIANT);\n+                gp.setStableId(gp.getStableId().replace(\"mutations\",\"fusion\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29990cb05e7a80f2fac52f3df0e2e09f574b206d"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MzI5MzYy", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#pullrequestreview-339329362", "createdAt": "2020-01-07T15:56:57Z", "commit": {"oid": "29990cb05e7a80f2fac52f3df0e2e09f574b206d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNTo1Njo1N1rOFa9rlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNTo1Njo1N1rOFa9rlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgxNzg3OQ==", "bodyText": "Thanks for updating this! Just one issue: we have already applied this migration to one production database.\nI guess I can rerun this thing?\nFrom: #6945 (comment)\ndelete from genetic_profile where STABLE_ID like '%_structural_variants%'\ndelete from sample_list_list where list_id in (select list_id from sample_list where CATEGORY = 'all_cases_with_sv_data')\ndelete from sample_list where CATEGORY = 'all_cases_with_sv_data'\n\nAnother thing - now that you've updated the sample service to support studies with a case list. Should we just remove this whole part of filling in case lists? I think it would be more comprehensible if running the migration on old studies with FUSION datafiles results in the same state of the database as importing the data. Right now from what I understand the migration creates a case list, but importing a study with FUSION data only adds a new profile.", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#discussion_r363817879", "createdAt": "2020-01-07T15:56:57Z", "author": {"login": "inodb"}, "path": "db-scripts/src/main/resources/migration.sql", "diffHunk": "@@ -806,7 +806,7 @@ AS (\n     WHERE MUTATION_TYPE = 'fusion'\n );\n INSERT INTO genetic_profile(STABLE_ID, CANCER_STUDY_ID, GENETIC_ALTERATION_TYPE, DATATYPE, NAME, DESCRIPTION, SHOW_PROFILE_IN_ANALYSIS_TAB)\n-SELECT CONCAT(CANCER_STUDY_IDENTIFIER, '_structural_variants'), CANCER_STUDY_ID, 'STRUCTURAL_VARIANT','SV','Fusions','Fusions',0\n+SELECT CONCAT(CANCER_STUDY_IDENTIFIER, '_fusion'), CANCER_STUDY_ID, 'STRUCTURAL_VARIANT','SV','Fusions','Fusions',0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29990cb05e7a80f2fac52f3df0e2e09f574b206d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MzM2OTcx", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#pullrequestreview-339336971", "createdAt": "2020-01-07T16:07:58Z", "commit": {"oid": "29990cb05e7a80f2fac52f3df0e2e09f574b206d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNjowNzo1OFrOFa-AnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNjowNzo1OFrOFa-AnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgyMzI2MA==", "bodyText": "might be good to have a comment here. Something like:\n/*\nTODO: Eventually all studies with STRUCTURAL_VARIANT data should have case lists, so there should always be an entry in `structuralVariantSampleIdsMap`. This case is to support old `FUSION` data in the mutations table that don't have case lists. In that case we assume any sample that has been sequenced to have been profiled for fusions as well\n*/\n\nMakes sense?", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#discussion_r363823260", "createdAt": "2020-01-07T16:07:58Z", "author": {"login": "inodb"}, "path": "service/src/main/java/org/cbioportal/service/impl/SampleServiceImpl.java", "diffHunk": "@@ -193,13 +201,17 @@ private void processSamples(List<Sample> samples, String projection) {\n             \n             Set<Integer> samplesWithCopyNumberSegMap = new HashSet<>();\n             samplesWithCopyNumberSegMap.addAll(samplesWithCopyNumberSeg);\n-           \n+\n             samples.forEach(sample -> {\n                 sample.setSequenced(sequencedSampleIdsMap.get(sample.getCancerStudyIdentifier())\n                     .contains(sample.getStableId()));\n                 sample.setCopyNumberSegmentPresent(samplesWithCopyNumberSegMap.contains(sample.getInternalId()));\n-                if (!structuralVariantSampleIdsMap.isEmpty()) {\n-                    sample.setProfiledForFusions(structuralVariantSampleIdsMap.get(sample.getCancerStudyIdentifier()).contains(sample.getStableId()));\n+                if (studiesProfiledWithSVs.contains(sample.getCancerStudyIdentifier())) {\n+                    if (!structuralVariantSampleIdsMap.get(sample.getCancerStudyIdentifier()).isEmpty()) {\n+                        sample.setProfiledForFusions(structuralVariantSampleIdsMap.get(sample.getCancerStudyIdentifier()).contains(sample.getStableId()));\n+                    } else {\n+                        sample.setProfiledForFusions(sequencedSampleIdsMap.get(sample.getCancerStudyIdentifier()).contains(sample.getStableId()));\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29990cb05e7a80f2fac52f3df0e2e09f574b206d"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MzM3OTc0", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#pullrequestreview-339337974", "createdAt": "2020-01-07T16:09:31Z", "commit": {"oid": "29990cb05e7a80f2fac52f3df0e2e09f574b206d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNjowOTozMVrOFa-DcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNjowOTozMVrOFa-DcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgyMzk4NA==", "bodyText": "nice test", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#discussion_r363823984", "createdAt": "2020-01-07T16:09:31Z", "author": {"login": "inodb"}, "path": "service/src/test/java/org/cbioportal/service/impl/SampleServiceImplTest.java", "diffHunk": "@@ -259,6 +263,15 @@ public void fetchSamplesDetailed() throws Exception {\n             .thenReturn(new ArrayList<>());\n         Mockito.when(copyNumberSegmentRepository.fetchSamplesWithCopyNumberSegments(Mockito.anyListOf(String.class),\n             Mockito.anyListOf(String.class), Mockito.anyString())).thenReturn(expectedInternalIdList);\n+\n+        List<MolecularProfile> expectedMolecularProfileList = new ArrayList<>();\n+        MolecularProfile molecularProfile = new MolecularProfile();\n+        molecularProfile.setCancerStudyIdentifier(STUDY_ID);\n+        molecularProfile.setMolecularAlterationType(MolecularProfile.MolecularAlterationType.STRUCTURAL_VARIANT);\n+        expectedMolecularProfileList.add(molecularProfile);\n+\n+        Mockito.when(molecularProfileRepository.getMolecularProfilesInStudies(Arrays.asList(STUDY_ID), \"DETAILED\"))\n+            .thenReturn(expectedMolecularProfileList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29990cb05e7a80f2fac52f3df0e2e09f574b206d"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MzM5MjMy", "url": "https://github.com/cBioPortal/cbioportal/pull/6968#pullrequestreview-339339232", "createdAt": "2020-01-07T16:11:27Z", "commit": {"oid": "29990cb05e7a80f2fac52f3df0e2e09f574b206d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b32f063df995bba691aa529f24628431b25025cf", "author": {"user": null}, "url": "https://github.com/cBioPortal/cbioportal/commit/b32f063df995bba691aa529f24628431b25025cf", "committedDate": "2020-01-13T17:10:12Z", "message": "removing backfilling in case lists from migration code, as sample service has been updated to support studies with a case list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3519f3575037a47329ea8631e772c660d6ac4a62", "author": {"user": {"login": "inodb", "name": "Ino de Bruijn"}}, "url": "https://github.com/cBioPortal/cbioportal/commit/3519f3575037a47329ea8631e772c660d6ac4a62", "committedDate": "2020-01-13T19:02:32Z", "message": "add comment about missing sv case lists"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1499, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}