{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NDcwNzg3", "number": 7032, "title": "Add a check for existing \"SV Genetic Profile\" during import", "bodyText": "Previously, SV genetic profile was automatically generated for fusion files,\nbut this could result in adding multiple genetic profiles with same names\ncausing an exception\nAdded unit tests for \"split\" fusions file\nFix #7026  (see https://help.github.com/en/articles/closing-issues-using-keywords)\nNew code was recently introduced to auto-generate a Structural Variant profile when coming across a fusion file. Code did not take into account possibility of a study with multiple fusion files such as impact (with fusions and fusions_gml). On the second fusions file, an SV genetic profile with the same name would be generated. Import of a genetic profile with the same name would cause the import to throw and exception and exit out.\nDescribe changes proposed in this pull request:\n\nAdd a check for if SV genetic profile is already present in db and do nothing if found\nUnit tests for a \"split\" fusions file.\n\nChecks\n\n Runs on heroku\n Has tests or has a separate issue that describes the types of test that should be created. If no test is included it should explicitly be mentioned in the PR why there is no test.\n The commit log is comprehensible. It follows 7 rules of great commit messages. For most PRs a single commit should suffice, in some cases multiple topical commits can be useful. During review it is ok to see tiny commits (e.g. Fix reviewer comments), but right before the code gets merged to master or rc branch, any such commits should be squashed since they are useless to the other developers. Definitely avoid merge commits, use rebase instead.\n Is this PR adding logic based on one or more clinical attributes? If yes, please make sure validation for this attribute is also present in the data validation / data loading layers (in backend repo) and documented in File-Formats Clinical data section!\n\nAny screenshots or GIFs?\nIf this is a new visual feature please add a before/after screenshot or gif\nhere with e.g. Giphy CAPTURE or Peek\nNotify reviewers\nRead our Pull request merging\npolicy. It can help to figure out who worked on the\nfile before you. Please use git blame <filename> to determine that\nand notify them either through slack or by assigning them as a reviewer on the PR", "createdAt": "2020-01-21T19:28:05Z", "url": "https://github.com/cBioPortal/cbioportal/pull/7032", "merged": true, "mergeCommit": {"oid": "497b253fd259289922905c1939b77be0603c41f7"}, "closed": true, "closedAt": "2020-01-21T21:35:04Z", "author": {"login": "averyniceday"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8mVZegFqTM0NjEzNDA4OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8oHfPAFqTM0NjIwNzQxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTM0MDg4", "url": "https://github.com/cBioPortal/cbioportal/pull/7032#pullrequestreview-346134088", "createdAt": "2020-01-21T19:29:24Z", "commit": {"oid": "87ec72fe5bfb455ace91e419aa2fd9d5c3bd5b36"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToyOToyNFrOFgGG2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToyOTo1OFrOFgGH1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5ODgwOQ==", "bodyText": "Can you add a comment explaining the logic here?", "url": "https://github.com/cBioPortal/cbioportal/pull/7032#discussion_r369198809", "createdAt": "2020-01-21T19:29:24Z", "author": {"login": "ao508"}, "path": "core/src/main/java/org/mskcc/cbio/portal/util/GeneticProfileReader.java", "diffHunk": "@@ -82,11 +82,18 @@ public static GeneticProfile loadGeneticProfile(File file) throws IOException, D\n                throw new RuntimeException(\"Error: genetic_profile record found with same Stable ID as the one used in your data:  \"\n                        + existingGeneticProfile.getStableId() + \". Remove the existing genetic_profile record first.\");\n             } else if (geneticProfile.getDatatype().equals(\"FUSION\")) {\n+                String svStableId = existingGeneticProfile.getStableId().replace(\"mutations\", \"fusion\");\n+                // check if structural variant genetic proile already exists for fusions\n+                // if an auto-generated <study_id>_fusion genetic profile exists, do not attempt to add it again\n+                // otherwise, exception is thrown causing import to exit\n                 // populate the structural variant genetic profile for fusions\n-                GeneticProfile gp = new GeneticProfile(geneticProfile);\n-                gp.setGeneticAlterationType(GeneticAlterationType.STRUCTURAL_VARIANT);\n-                gp.setStableId(gp.getStableId().replace(\"mutations\",\"fusion\"));\n-                DaoGeneticProfile.addGeneticProfile(gp);\n+                GeneticProfile existingSVGeneticProfile = DaoGeneticProfile.getGeneticProfileByStableId(svStableId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87ec72fe5bfb455ace91e419aa2fd9d5c3bd5b36"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5ODkwNw==", "bodyText": "Give a tiny bit more detail here for context.\nWhat does \"two files\" mean? Just add something like, \"i.e., somatic fusions and germline fusions\"\nOtherwise someone looking at this might be confused as to why there would be fusion data stored in multiple files.", "url": "https://github.com/cBioPortal/cbioportal/pull/7032#discussion_r369198907", "createdAt": "2020-01-21T19:29:37Z", "author": {"login": "ao508"}, "path": "core/src/test/java/org/mskcc/cbio/portal/scripts/TestImportProfileData.java", "diffHunk": "@@ -218,6 +219,41 @@ public void testImportSplitMutationsFile() throws Exception {\n         assertEquals(\"1\", clinicalData.get(1).getAttrVal());\n     }\n \n+    @Test\n+    public void testImportSplitFusionsFile() throws Exception {\n+        /*\n+         * Check case where study has multiple fusions file.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87ec72fe5bfb455ace91e419aa2fd9d5c3bd5b36"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5OTAwMQ==", "bodyText": "Would you mind cleaning up the comments in this test data file and in the germline data file? It's probably best to strictly keep the data mocked so as to not contain any information resembling the original file, especially in the germline cases.", "url": "https://github.com/cBioPortal/cbioportal/pull/7032#discussion_r369199001", "createdAt": "2020-01-21T19:29:50Z", "author": {"login": "ao508"}, "path": "core/src/test/resources/splitFusionsData/data_fusions.txt", "diffHunk": "@@ -0,0 +1,3 @@\n+Hugo_Symbol\tEntrez_Gene_Id\tCenter\tTumor_Sample_Barcode\tFusion\tDNA_support\tRNA_support\tMethod\tFrame\tComments", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87ec72fe5bfb455ace91e419aa2fd9d5c3bd5b36"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5OTA2MQ==", "bodyText": "extra new lines here", "url": "https://github.com/cBioPortal/cbioportal/pull/7032#discussion_r369199061", "createdAt": "2020-01-21T19:29:58Z", "author": {"login": "ao508"}, "path": "core/src/test/resources/splitFusionsData/meta_fusions.txt", "diffHunk": "@@ -0,0 +1,9 @@\n+cancer_study_identifier: study_tcga_pub\n+stable_id: study_tcga_pub_mutations\n+datatype: FUSION\n+genetic_alteration_type: FUSION\n+show_profile_in_analysis_tab: true\n+profile_description: Fusions.\n+profile_name: Fusions\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87ec72fe5bfb455ace91e419aa2fd9d5c3bd5b36"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3208fd1970dda8bc0be4f3aefecc8ea5dd6752e2", "author": {"user": {"login": "averyniceday", "name": null}}, "url": "https://github.com/cBioPortal/cbioportal/commit/3208fd1970dda8bc0be4f3aefecc8ea5dd6752e2", "committedDate": "2020-01-21T19:31:55Z", "message": "Add a check for existing \"SV Genetic Profile\" during import\nPreviously, SV genetic profile was automatically generated for fusion files,\nbut this could result in adding multiple genetic profiles with same names\ncausing an exception\nAdded unit tests for \"split\" fusions file"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87ec72fe5bfb455ace91e419aa2fd9d5c3bd5b36", "author": {"user": {"login": "averyniceday", "name": null}}, "url": "https://github.com/cBioPortal/cbioportal/commit/87ec72fe5bfb455ace91e419aa2fd9d5c3bd5b36", "committedDate": "2020-01-21T19:25:30Z", "message": "Add a check for existing \"SV Genetic Profile\" during import\nPreviously, SV genetic profile was automatically generated for fusion files,\nbut this could result in adding multiple genetic profiles with same names\ncausing an exception\nAdded unit tests for \"split\" fusions file"}, "afterCommit": {"oid": "3208fd1970dda8bc0be4f3aefecc8ea5dd6752e2", "author": {"user": {"login": "averyniceday", "name": null}}, "url": "https://github.com/cBioPortal/cbioportal/commit/3208fd1970dda8bc0be4f3aefecc8ea5dd6752e2", "committedDate": "2020-01-21T19:31:55Z", "message": "Add a check for existing \"SV Genetic Profile\" during import\nPreviously, SV genetic profile was automatically generated for fusion files,\nbut this could result in adding multiple genetic profiles with same names\ncausing an exception\nAdded unit tests for \"split\" fusions file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTM2NTE2", "url": "https://github.com/cBioPortal/cbioportal/pull/7032#pullrequestreview-346136516", "createdAt": "2020-01-21T19:33:17Z", "commit": {"oid": "3208fd1970dda8bc0be4f3aefecc8ea5dd6752e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MjA3NDE2", "url": "https://github.com/cBioPortal/cbioportal/pull/7032#pullrequestreview-346207416", "createdAt": "2020-01-21T21:34:46Z", "commit": {"oid": "3208fd1970dda8bc0be4f3aefecc8ea5dd6752e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1517, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}