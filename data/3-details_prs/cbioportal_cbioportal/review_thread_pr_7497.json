{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NDk0OTEw", "number": 7497, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMDowNlrOD9hRUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTozMDoxNVrOD9hpeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODM0ODM1OnYy", "diffSide": "RIGHT", "path": "persistence/persistence-api/src/main/java/org/cbioportal/persistence/StructuralVariantRepository.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMDowNlrOGXEILA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMDowNlrOGXEILA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzODA2MA==", "bodyText": "We need @Cacheable tags here.", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r426838060", "createdAt": "2020-05-18T19:10:06Z", "author": {"login": "n1zea144"}, "path": "persistence/persistence-api/src/main/java/org/cbioportal/persistence/StructuralVariantRepository.java", "diffHunk": "@@ -1,11 +1,15 @@\n package org.cbioportal.persistence;\n \n import org.cbioportal.model.StructuralVariant;\n+import org.cbioportal.model.StructuralVariantCountByGene;\n \n import java.util.List;\n \n public interface StructuralVariantRepository {\n \n-    List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds, \n-            List<Integer> entrezGeneIds, List<String> sampleIds);\n+    List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds, List<Integer> entrezGeneIds,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODM1OTUwOnYy", "diffSide": "RIGHT", "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/StructuralVariantMyBatisRepository.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMzozM1rOGXEPQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMzozM1rOGXEPQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTg3NQ==", "bodyText": "For consistency with other service classes, can we move validation checks to service layer?", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r426839875", "createdAt": "2020-05-18T19:13:33Z", "author": {"login": "n1zea144"}, "path": "persistence/persistence-mybatis/src/main/java/org/cbioportal/persistence/mybatis/StructuralVariantMyBatisRepository.java", "diffHunk": "@@ -35,16 +36,23 @@\n \n     @Autowired\n     private StructuralVariantMapper structuralVariantMapper;\n-    \n+\n     @Override\n-    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds, \n+    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds,\n             List<Integer> entrezGeneIds, List<String> sampleIds) {\n \n         if ((sampleIds.size() > 0) && (molecularProfileIds.size() != sampleIds.size())) {\n             throw new RuntimeException(\"molecularProfileIds list and sampleIds list should be the same length.\");\n         }\n \n-        return structuralVariantMapper.fetchStructuralVariants(molecularProfileIds,\n-                entrezGeneIds, sampleIds);\n+        return structuralVariantMapper.fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODM4MzQ2OnYy", "diffSide": "RIGHT", "path": "persistence/persistence-mybatis/src/main/resources/org/cbioportal/persistence/mybatis/StructuralVariantMapper.xml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToyMTozNFrOGXEeSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMzowMToxOFrOGXfR0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0MzcyMQ==", "bodyText": "Any idea what to expect of the runtime performance of this query?", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r426843721", "createdAt": "2020-05-18T19:21:34Z", "author": {"login": "n1zea144"}, "path": "persistence/persistence-mybatis/src/main/resources/org/cbioportal/persistence/mybatis/StructuralVariantMapper.xml", "diffHunk": "@@ -51,6 +51,49 @@\n         structural_variant.DRIVER_TIERS_FILTER_ANNOTATION AS \"${prefix}driverTiersFilterAnn\"\n     </sql>\n \n+    <sql id=\"whereInMultipleMolecularProfiles\">\n+        <where>\n+            <if test=\"sampleIds != null and !sampleIds.isEmpty()\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI4Mjg5Ng==", "bodyText": "No idea, but it's similar to what's in mutation query and even at other places", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r427282896", "createdAt": "2020-05-19T13:01:18Z", "author": {"login": "kalletlak"}, "path": "persistence/persistence-mybatis/src/main/resources/org/cbioportal/persistence/mybatis/StructuralVariantMapper.xml", "diffHunk": "@@ -51,6 +51,49 @@\n         structural_variant.DRIVER_TIERS_FILTER_ANNOTATION AS \"${prefix}driverTiersFilterAnn\"\n     </sql>\n \n+    <sql id=\"whereInMultipleMolecularProfiles\">\n+        <where>\n+            <if test=\"sampleIds != null and !sampleIds.isEmpty()\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0MzcyMQ=="}, "originalCommit": {"oid": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODQwMjA0OnYy", "diffSide": "RIGHT", "path": "service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToyNzoyNlrOGXEqBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToyNzoyNlrOGXEqBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0NjcyNg==", "bodyText": "Nice.  Should we add a \"TODO\" comment here to remove once fusions are migrated to sv table in database?", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r426846726", "createdAt": "2020-05-18T19:27:26Z", "author": {"login": "n1zea144"}, "path": "service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java", "diffHunk": "@@ -36,12 +40,42 @@\n \n     @Autowired\n     private StructuralVariantRepository structuralVariantRepository;\n-    \n+    @Autowired\n+    private MutationRepository mutationRepository;\n+    @Autowired\n+    private MutationMapperUtils mutationMapperUtils;\n+    @Autowired\n+    private AlterationEnrichmentUtil<StructuralVariantCountByGene> alterationEnrichmentUtil;\n+\n     @Override\n-    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds, \n-            List<Integer> entrezGeneIds,  List<String> sampleIds) {\n-        \n-        return structuralVariantRepository.fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds);\n+    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds,\n+            List<Integer> entrezGeneIds, List<String> sampleIds) {\n+\n+        List<StructuralVariant> structuralVariants = mutationMapperUtils.mapFusionsToStructuralVariants(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODQwODM5OnYy", "diffSide": "RIGHT", "path": "service/src/main/java/org/cbioportal/service/util/MutationMapperUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToyOTo0NVrOGXEuJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToyOTo0NVrOGXEuJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0Nzc4Mg==", "bodyText": "Typo here - s/Couts/Counts/", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r426847782", "createdAt": "2020-05-18T19:29:45Z", "author": {"login": "n1zea144"}, "path": "service/src/main/java/org/cbioportal/service/util/MutationMapperUtils.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package org.cbioportal.service.util;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.cbioportal.model.Mutation;\n+import org.cbioportal.model.MutationCountByGene;\n+import org.cbioportal.model.StructuralVariant;\n+import org.cbioportal.model.StructuralVariantCountByGene;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class MutationMapperUtils {\n+\n+    public List<StructuralVariant> mapFusionsToStructuralVariants(List<Mutation> fusions) {\n+\n+        return fusions.stream().map(fusion -> {\n+            StructuralVariant structuralVariant = new StructuralVariant();\n+\n+            // Sample details\n+            structuralVariant.setPatientId(fusion.getPatientId());\n+            structuralVariant.setSampleId(fusion.getSampleId());\n+            structuralVariant.setStudyId(fusion.getStudyId());\n+            structuralVariant.setMolecularProfileId(fusion.getMolecularProfileId());\n+\n+            // Fusion details\n+            structuralVariant.setSite1EntrezGeneId(fusion.getEntrezGeneId());\n+            structuralVariant.setSite1HugoSymbol(fusion.getGene().getHugoGeneSymbol());\n+            structuralVariant.setSite1Chromosome(fusion.getChr());\n+            structuralVariant.setCenter(fusion.getCenter());\n+            structuralVariant.setSite1Position(fusion.getStartPosition().intValue());\n+            structuralVariant.setComments(fusion.getKeyword());\n+            structuralVariant.setNcbiBuild(fusion.getNcbiBuild());\n+\n+            return structuralVariant;\n+        }).collect(Collectors.toList());\n+    }\n+\n+    public List<StructuralVariantCountByGene> mapFusionCoutsToStructuralVariantCounts(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODQxMDE4OnYy", "diffSide": "RIGHT", "path": "service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTozMDoxNVrOGXEvOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTozMDoxNVrOGXEvOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0ODA1Ng==", "bodyText": "Looks like typo here s/Couts/Counts/", "url": "https://github.com/cBioPortal/cbioportal/pull/7497#discussion_r426848056", "createdAt": "2020-05-18T19:30:15Z", "author": {"login": "n1zea144"}, "path": "service/src/main/java/org/cbioportal/service/impl/StructuralVariantServiceImpl.java", "diffHunk": "@@ -36,12 +40,42 @@\n \n     @Autowired\n     private StructuralVariantRepository structuralVariantRepository;\n-    \n+    @Autowired\n+    private MutationRepository mutationRepository;\n+    @Autowired\n+    private MutationMapperUtils mutationMapperUtils;\n+    @Autowired\n+    private AlterationEnrichmentUtil<StructuralVariantCountByGene> alterationEnrichmentUtil;\n+\n     @Override\n-    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds, \n-            List<Integer> entrezGeneIds,  List<String> sampleIds) {\n-        \n-        return structuralVariantRepository.fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds);\n+    public List<StructuralVariant> fetchStructuralVariants(List<String> molecularProfileIds,\n+            List<Integer> entrezGeneIds, List<String> sampleIds) {\n+\n+        List<StructuralVariant> structuralVariants = mutationMapperUtils.mapFusionsToStructuralVariants(\n+                mutationRepository.getFusionsInMultipleMolecularProfiles(molecularProfileIds, sampleIds, entrezGeneIds,\n+                        \"DETAILED\", null, null, null, null));\n+\n+        structuralVariants.addAll(\n+                structuralVariantRepository.fetchStructuralVariants(molecularProfileIds, entrezGeneIds, sampleIds));\n+\n+        return structuralVariants;\n+    }\n+\n+    @Override\n+    public List<StructuralVariantCountByGene> getSampleCountInMultipleMolecularProfiles(\n+            List<String> molecularProfileIds, List<String> sampleIds, List<Integer> entrezGeneIds,\n+            boolean includeFrequency, boolean includeMissingAlterationsFromGenePanel) {\n+\n+        List<StructuralVariantCountByGene> countByGenes = mutationMapperUtils.mapFusionCoutsToStructuralVariantCounts(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7a8f75cefee04450ffd059d69ab8f192fe7b33"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3653, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}