{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1Mzc0OTQy", "number": 2207, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzozMjoyMlrOEWy0bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzo0NzowM1rOEWzM_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzM2NzUxOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzozMjoyMlrOG-OrnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzozMjoyMlrOG-OrnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNTQzNg==", "bodyText": "move the log into fetchNextBatchAsyncIfPresent", "url": "https://github.com/apache/hadoop/pull/2207#discussion_r467905436", "createdAt": "2020-08-10T13:32:22Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java", "diffHunk": "@@ -761,29 +777,44 @@ public boolean hasNext() throws IOException {\n     @Retries.RetryTranslated\n     public S3ListResult next() throws IOException {\n       if (firstListing) {\n-        // on the first listing, don't request more data.\n-        // Instead just clear the firstListing flag so that it future calls\n-        // will request new data.\n+        // clear the firstListing flag for future calls.\n         firstListing = false;\n+        // Calculating the result of last async list call.\n+        objects = awaitFuture(s3ListResultFuture);\n+        fetchNextBatchAsyncIfPresent();\n       } else {\n         try {\n-          if (!objects.isTruncated()) {\n+          if (objectsPrev!= null && !objectsPrev.isTruncated()) {\n             // nothing more to request: fail.\n             throw new NoSuchElementException(\"No more results in listing of \"\n-                + listPath);\n+                    + listPath);\n           }\n-          // need to request a new set of objects.\n+          // Calculating the result of last async list call.\n+          objects = awaitFuture(s3ListResultFuture);\n+          // Requesting next batch of results.\n           LOG.debug(\"[{}], Requesting next {} objects under {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d4126a745103e0874950b687948d90feae8b7e1"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzM3MjM3OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzozMzoyOVrOG-OujQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzozMzoyOVrOG-OujQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNjE4OQ==", "bodyText": "make private unless someone needs to get at these in mockito tests", "url": "https://github.com/apache/hadoop/pull/2207#discussion_r467906189", "createdAt": "2020-08-10T13:33:29Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java", "diffHunk": "@@ -1956,6 +1956,14 @@ protected S3ListResult listObjects(S3ListRequest request) throws IOException {\n     }\n   }\n \n+  protected CompletableFuture<S3ListResult> listObjectsAsync(S3ListRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d4126a745103e0874950b687948d90feae8b7e1"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzM3NzM1OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzozNDo0M1rOG-OxmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzozNDo0M1rOG-OxmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwNjk2OA==", "bodyText": "get a WriteOperationHelper instance and invoke via that", "url": "https://github.com/apache/hadoop/pull/2207#discussion_r467906968", "createdAt": "2020-08-10T13:34:43Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java", "diffHunk": "@@ -2244,8 +2263,9 @@ public UploadInfo putObject(PutObjectRequest putObjectRequest) {\n    * not be saved to the metadata store and\n    * fs.s3a.metadatastore.fail.on.write.error=true\n    */\n+  @VisibleForTesting\n   @Retries.OnceRaw(\"For PUT; post-PUT actions are RetryTranslated\")\n-  PutObjectResult putObjectDirect(PutObjectRequest putObjectRequest)\n+  public PutObjectResult putObjectDirect(PutObjectRequest putObjectRequest)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d4126a745103e0874950b687948d90feae8b7e1"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzQyNDI0OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/scale/ITestS3ADirectoryPerformance.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzo0NTozMVrOG-PNfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwOTo1Njo1OVrOHAEmhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkxNDEwOQ==", "bodyText": "any reason to not use a local variable here?", "url": "https://github.com/apache/hadoop/pull/2207#discussion_r467914109", "createdAt": "2020-08-10T13:45:31Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/scale/ITestS3ADirectoryPerformance.java", "diffHunk": "@@ -137,6 +159,78 @@ public void testListOperations() throws Throwable {\n     }\n   }\n \n+  @Test\n+  public void testMultiPagesListingPerformanceAndCorrectness() throws Throwable {\n+    describe(\"Check performance and correctness for multi page listing \" +\n+            \"using different listing api\");\n+    Path dir = path(this.getMethodName());\n+    Configuration conf = getConfigurationWithConfiguredBatchSize(10);\n+    fs = (S3AFileSystem) FileSystem.get(dir.toUri(), conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d4126a745103e0874950b687948d90feae8b7e1"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgzNzQ0NA==", "bodyText": "Initially there were two tests so I thought of reusing the class level variable and closing the fs in teardown.\nSince there is just one test, I have moved to a local variable and closing using try-with-resources.", "url": "https://github.com/apache/hadoop/pull/2207#discussion_r469837444", "createdAt": "2020-08-13T09:56:59Z", "author": {"login": "mukund-thakur"}, "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/scale/ITestS3ADirectoryPerformance.java", "diffHunk": "@@ -137,6 +159,78 @@ public void testListOperations() throws Throwable {\n     }\n   }\n \n+  @Test\n+  public void testMultiPagesListingPerformanceAndCorrectness() throws Throwable {\n+    describe(\"Check performance and correctness for multi page listing \" +\n+            \"using different listing api\");\n+    Path dir = path(this.getMethodName());\n+    Configuration conf = getConfigurationWithConfiguredBatchSize(10);\n+    fs = (S3AFileSystem) FileSystem.get(dir.toUri(), conf);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkxNDEwOQ=="}, "originalCommit": {"oid": "7d4126a745103e0874950b687948d90feae8b7e1"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzQyNDcxOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/scale/ITestS3ADirectoryPerformance.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzo0NTozOVrOG-PNyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzo0NTozOVrOG-PNyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkxNDE4Nw==", "bodyText": "methodPath()", "url": "https://github.com/apache/hadoop/pull/2207#discussion_r467914187", "createdAt": "2020-08-10T13:45:39Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/scale/ITestS3ADirectoryPerformance.java", "diffHunk": "@@ -137,6 +159,78 @@ public void testListOperations() throws Throwable {\n     }\n   }\n \n+  @Test\n+  public void testMultiPagesListingPerformanceAndCorrectness() throws Throwable {\n+    describe(\"Check performance and correctness for multi page listing \" +\n+            \"using different listing api\");\n+    Path dir = path(this.getMethodName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d4126a745103e0874950b687948d90feae8b7e1"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzQyODI4OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/scale/ITestS3ADirectoryPerformance.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzo0NjozNFrOG-PQCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzo0NjozNFrOG-PQCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkxNDc2Mw==", "bodyText": "Add some tracking/logging of how long it took to create all these files.", "url": "https://github.com/apache/hadoop/pull/2207#discussion_r467914763", "createdAt": "2020-08-10T13:46:34Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/scale/ITestS3ADirectoryPerformance.java", "diffHunk": "@@ -137,6 +159,78 @@ public void testListOperations() throws Throwable {\n     }\n   }\n \n+  @Test\n+  public void testMultiPagesListingPerformanceAndCorrectness() throws Throwable {\n+    describe(\"Check performance and correctness for multi page listing \" +\n+            \"using different listing api\");\n+    Path dir = path(this.getMethodName());\n+    Configuration conf = getConfigurationWithConfiguredBatchSize(10);\n+    fs = (S3AFileSystem) FileSystem.get(dir.toUri(), conf);\n+    assume(\"Test is only for raw fs\", !fs.hasMetadataStore());\n+    fs.create(dir);\n+    final InputStream im = new InputStream() {\n+      @Override\n+      public int read() throws IOException {\n+        return -1;\n+      }\n+    };\n+    final int numOfPutRequests = 500;\n+    final List<String> originalListOfFiles = new ArrayList<>();\n+    List<Callable<PutObjectResult>> putObjectRequests = new ArrayList<>();\n+    ExecutorService executorService = Executors.newFixedThreadPool(50);\n+    try {\n+      for (int i=0; i<numOfPutRequests; i++) {\n+        Path file = new Path(dir, String.format(\"file-%03d\", i));\n+        originalListOfFiles.add(file.toString());\n+        ObjectMetadata om = fs.newObjectMetadata(0L);\n+        PutObjectRequest put = new PutObjectRequest(fs.getBucket(),\n+                fs.pathToKey(file),\n+                im,\n+                om);\n+        putObjectRequests.add(() -> fs.putObjectDirect(put));\n+      }\n+      executorService.invokeAll(putObjectRequests);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d4126a745103e0874950b687948d90feae8b7e1"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzQzMDM5OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/scale/ITestS3ADirectoryPerformance.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzo0NzowM1rOG-PRWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzo0NzowM1rOG-PRWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkxNTA5OQ==", "bodyText": "use a shorter name so the lines after are less wide", "url": "https://github.com/apache/hadoop/pull/2207#discussion_r467915099", "createdAt": "2020-08-10T13:47:03Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/scale/ITestS3ADirectoryPerformance.java", "diffHunk": "@@ -137,6 +159,78 @@ public void testListOperations() throws Throwable {\n     }\n   }\n \n+  @Test\n+  public void testMultiPagesListingPerformanceAndCorrectness() throws Throwable {\n+    describe(\"Check performance and correctness for multi page listing \" +\n+            \"using different listing api\");\n+    Path dir = path(this.getMethodName());\n+    Configuration conf = getConfigurationWithConfiguredBatchSize(10);\n+    fs = (S3AFileSystem) FileSystem.get(dir.toUri(), conf);\n+    assume(\"Test is only for raw fs\", !fs.hasMetadataStore());\n+    fs.create(dir);\n+    final InputStream im = new InputStream() {\n+      @Override\n+      public int read() throws IOException {\n+        return -1;\n+      }\n+    };\n+    final int numOfPutRequests = 500;\n+    final List<String> originalListOfFiles = new ArrayList<>();\n+    List<Callable<PutObjectResult>> putObjectRequests = new ArrayList<>();\n+    ExecutorService executorService = Executors.newFixedThreadPool(50);\n+    try {\n+      for (int i=0; i<numOfPutRequests; i++) {\n+        Path file = new Path(dir, String.format(\"file-%03d\", i));\n+        originalListOfFiles.add(file.toString());\n+        ObjectMetadata om = fs.newObjectMetadata(0L);\n+        PutObjectRequest put = new PutObjectRequest(fs.getBucket(),\n+                fs.pathToKey(file),\n+                im,\n+                om);\n+        putObjectRequests.add(() -> fs.putObjectDirect(put));\n+      }\n+      executorService.invokeAll(putObjectRequests);\n+    } finally {\n+      executorService.shutdown();\n+    }\n+    RemoteIterator<LocatedFileStatus> locatedFileStatusRemoteIterator =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d4126a745103e0874950b687948d90feae8b7e1"}, "originalPosition": 82}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3373, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}