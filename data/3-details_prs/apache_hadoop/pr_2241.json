{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNjY5MTk3", "number": 2241, "title": "HADOOP-17222. Create socket address combined with URI cache", "bodyText": "https://issues.apache.org/jira/browse/HADOOP-17222\nCreate socket address combined with cache to speed up hdfs client choose DataNode", "createdAt": "2020-08-24T17:42:34Z", "url": "https://github.com/apache/hadoop/pull/2241", "merged": true, "mergeCommit": {"oid": "56ebabd426757dd95c778535548abb8c01fbc1fb"}, "closed": true, "closedAt": "2020-09-11T05:30:52Z", "author": {"login": "1996fanrui"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCOQUpgBqjM2ODc5ODgzNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHCrUjAH2gAyNDcyNjY5MTk3OjliYWJhNzgyZjljZTI5NWNiMzIxMzgwYTI1N2U5MGQ4YmFkZjNlZTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eabf42a4351b9a078d939e3ec6eede7893aabd13", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/eabf42a4351b9a078d939e3ec6eede7893aabd13", "committedDate": "2020-08-24T17:40:35Z", "message": "HADOOP-17222. Create socket address combined with cache"}, "afterCommit": {"oid": "987820528a7754ce83ffa963d10c5a47aa9a5779", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/987820528a7754ce83ffa963d10c5a47aa9a5779", "committedDate": "2020-08-25T03:00:34Z", "message": "HADOOP-17222. Create socket address combined with cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "987820528a7754ce83ffa963d10c5a47aa9a5779", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/987820528a7754ce83ffa963d10c5a47aa9a5779", "committedDate": "2020-08-25T03:00:34Z", "message": "HADOOP-17222. Create socket address combined with cache"}, "afterCommit": {"oid": "f08b5120268a57b5a439d452ddc7cd87c0bbba8f", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/f08b5120268a57b5a439d452ddc7cd87c0bbba8f", "committedDate": "2020-08-25T03:19:23Z", "message": "HADOOP-17222. Create socket address combined with cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MTE0NjQ1", "url": "https://github.com/apache/hadoop/pull/2241#pullrequestreview-474114645", "createdAt": "2020-08-25T03:47:05Z", "commit": {"oid": "f08b5120268a57b5a439d452ddc7cd87c0bbba8f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMzo0NzowNVrOHGEiKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMzo0NzowNVrOHGEiKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjEyNzc4NQ==", "bodyText": "Thanks @1996fanrui for your proposal here.\nA. Not sure if this improvement could impact some other modules because {{NetUtil}} is very common util for different modules rather than DFSClient only.\nB. It is better to make the scope to DFSClient only if we could based on the original description HADOOP-17222.\nC. add evict policy for {{URI_CACHE}}?", "url": "https://github.com/apache/hadoop/pull/2241#discussion_r476127785", "createdAt": "2020-08-25T03:47:05Z", "author": {"login": "Hexiaoqiao"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/net/NetUtils.java", "diffHunk": "@@ -218,6 +211,28 @@ public static InetSocketAddress createSocketAddr(String target,\n     return createSocketAddrForHost(host, port);\n   }\n \n+  private static final Map<String, URI> URI_CACHE = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f08b5120268a57b5a439d452ddc7cd87c0bbba8f"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5be64e594431b57a0f5f9bae76eb818c9ca60145", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/5be64e594431b57a0f5f9bae76eb818c9ca60145", "committedDate": "2020-08-25T06:40:28Z", "message": "HADOOP-17222. Create socket address combined with cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f08b5120268a57b5a439d452ddc7cd87c0bbba8f", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/f08b5120268a57b5a439d452ddc7cd87c0bbba8f", "committedDate": "2020-08-25T03:19:23Z", "message": "HADOOP-17222. Create socket address combined with cache"}, "afterCommit": {"oid": "5be64e594431b57a0f5f9bae76eb818c9ca60145", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/5be64e594431b57a0f5f9bae76eb818c9ca60145", "committedDate": "2020-08-25T06:40:28Z", "message": "HADOOP-17222. Create socket address combined with cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2221aa0ecd5ab37032ec53021117f3af32425129", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/2221aa0ecd5ab37032ec53021117f3af32425129", "committedDate": "2020-08-25T11:39:19Z", "message": "add conf of dfs.client.read.uri.cache.enable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "266831f1e1b658435d0f542c52749df34852eb59", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/266831f1e1b658435d0f542c52749df34852eb59", "committedDate": "2020-08-26T14:11:55Z", "message": "add parameter of uri cache expire time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7a46d4987a9a2fed7f447aef10aae1e5c12c1f5", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/f7a46d4987a9a2fed7f447aef10aae1e5c12c1f5", "committedDate": "2020-08-27T03:28:10Z", "message": "refactor to fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0Njk3MzU1", "url": "https://github.com/apache/hadoop/pull/2241#pullrequestreview-474697355", "createdAt": "2020-08-25T17:23:14Z", "commit": {"oid": "2221aa0ecd5ab37032ec53021117f3af32425129"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzoyMzoxNFrOHGiLdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwNDo1MTo1NVrOHH9z-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYxMzQ5NQ==", "bodyText": "nit: let's remove this sentence. The default value is clear in 5 lines above. Otherwise if we update the default value in future, we may miss this one which will cause confusion.", "url": "https://github.com/apache/hadoop/pull/2241#discussion_r476613495", "createdAt": "2020-08-25T17:23:14Z", "author": {"login": "liuml07"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/resources/hdfs-default.xml", "diffHunk": "@@ -4185,6 +4185,16 @@\n   </description>\n </property>\n \n+<property>\n+  <name>dfs.client.read.uri.cache.enable</name>\n+  <value>false</value>\n+  <description>\n+    If true, dfs client will use cache when creating URI based on host:port\n+    to reduce the frequency of URI object creation.\n+    Default is false.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2221aa0ecd5ab37032ec53021117f3af32425129"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYxODY5Mg==", "bodyText": "nit: name this ...uri.cache.enabled by replacing enable with enabled?\nAlso change other variables related to uriCacheEnable", "url": "https://github.com/apache/hadoop/pull/2241#discussion_r476618692", "createdAt": "2020-08-25T17:27:21Z", "author": {"login": "liuml07"}, "path": "hadoop-hdfs-project/hadoop-hdfs-client/src/main/java/org/apache/hadoop/hdfs/client/HdfsClientConfigKeys.java", "diffHunk": "@@ -414,6 +414,9 @@\n \n     String  PREFETCH_SIZE_KEY = PREFIX + \"prefetch.size\";\n \n+    String URI_CACHE_KEY = PREFIX + \"uri.cache.enable\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2221aa0ecd5ab37032ec53021117f3af32425129"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODExNDgxMA==", "bodyText": "I think it's better not to have this config as I suggested in the JIRA. It's for two reasons:\n\nThis seems not critical parameter and Hadoop already has too many configurations. I think the default value 12hours is good enough. It's not meant to be tuned by per client since the cache is static and shared. So removing this config seems preferred to me.\nThe URI cache is initialized only once. So passing the uriCacheExpireMs parameter every time does not really carry useful information. And it may be confusing if people mistakenly interpret this as a per-URI setting when they call NetUtils.createSocketAddr() which is not.\n\nThoughts?", "url": "https://github.com/apache/hadoop/pull/2241#discussion_r478114810", "createdAt": "2020-08-27T04:51:55Z", "author": {"login": "liuml07"}, "path": "hadoop-hdfs-project/hadoop-hdfs-client/src/main/java/org/apache/hadoop/hdfs/client/HdfsClientConfigKeys.java", "diffHunk": "@@ -414,6 +415,11 @@\n \n     String  PREFETCH_SIZE_KEY = PREFIX + \"prefetch.size\";\n \n+    String URI_CACHE_KEY = PREFIX + \"uri.cache.enable\";\n+    boolean URI_CACHE_DEFAULT = false;\n+    String URI_CACHE_EXPIRE_MS_KEY = PREFIX + \"uri.cache.expire.ms\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7a46d4987a9a2fed7f447aef10aae1e5c12c1f5"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0a0103b7887d612217800c4f7d7647fe4d29dd9", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/e0a0103b7887d612217800c4f7d7647fe4d29dd9", "committedDate": "2020-08-27T06:14:41Z", "message": "remove parameter of uri cache expire time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5ccabdc5ce9a9bd0762a40e39f8ea9125025c79", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/a5ccabdc5ce9a9bd0762a40e39f8ea9125025c79", "committedDate": "2020-08-27T06:09:18Z", "message": "remove parameter of uri cache expire time"}, "afterCommit": {"oid": "e0a0103b7887d612217800c4f7d7647fe4d29dd9", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/e0a0103b7887d612217800c4f7d7647fe4d29dd9", "committedDate": "2020-08-27T06:14:41Z", "message": "remove parameter of uri cache expire time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NDI1NTc2", "url": "https://github.com/apache/hadoop/pull/2241#pullrequestreview-476425576", "createdAt": "2020-08-27T06:40:20Z", "commit": {"oid": "e0a0103b7887d612217800c4f7d7647fe4d29dd9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2Njc4OTI0", "url": "https://github.com/apache/hadoop/pull/2241#pullrequestreview-476678924", "createdAt": "2020-08-27T12:40:57Z", "commit": {"oid": "e0a0103b7887d612217800c4f7d7647fe4d29dd9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMjo0MDo1OFrOHIOdmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMjo0NzowN1rOHIOtXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM4NzYxMQ==", "bodyText": "nit: delete no meaningless annotation?", "url": "https://github.com/apache/hadoop/pull/2241#discussion_r478387611", "createdAt": "2020-08-27T12:40:58Z", "author": {"login": "Hexiaoqiao"}, "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/net/TestNetUtils.java", "diffHunk": "@@ -360,6 +360,49 @@ public void testCreateSocketAddress() throws Throwable {\n     }\n   }\n \n+  @Test\n+  public void testCreateSocketAddressWithURICache() throws Throwable {\n+    InetSocketAddress addr = NetUtils.createSocketAddr(\n+        \"127.0.0.1:12345\", 1000, \"myconfig\", true);\n+    assertEquals(\"127.0.0.1\", addr.getAddress().getHostAddress());\n+    assertEquals(12345, addr.getPort());\n+\n+    addr = NetUtils.createSocketAddr(\n+        \"127.0.0.1:12345\", 1000, \"myconfig\", true);\n+    assertEquals(\"127.0.0.1\", addr.getAddress().getHostAddress());\n+    assertEquals(12345, addr.getPort());\n+\n+    // ----------------------------------------------------", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0a0103b7887d612217800c4f7d7647fe4d29dd9"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM4ODMxNA==", "bodyText": "nit: addr seems useless? no need to assign to addr anymore?", "url": "https://github.com/apache/hadoop/pull/2241#discussion_r478388314", "createdAt": "2020-08-27T12:42:03Z", "author": {"login": "Hexiaoqiao"}, "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/net/TestNetUtils.java", "diffHunk": "@@ -360,6 +360,49 @@ public void testCreateSocketAddress() throws Throwable {\n     }\n   }\n \n+  @Test\n+  public void testCreateSocketAddressWithURICache() throws Throwable {\n+    InetSocketAddress addr = NetUtils.createSocketAddr(\n+        \"127.0.0.1:12345\", 1000, \"myconfig\", true);\n+    assertEquals(\"127.0.0.1\", addr.getAddress().getHostAddress());\n+    assertEquals(12345, addr.getPort());\n+\n+    addr = NetUtils.createSocketAddr(\n+        \"127.0.0.1:12345\", 1000, \"myconfig\", true);\n+    assertEquals(\"127.0.0.1\", addr.getAddress().getHostAddress());\n+    assertEquals(12345, addr.getPort());\n+\n+    // ----------------------------------------------------\n+\n+    addr = NetUtils.createSocketAddr(\n+        \"127.0.0.1\", 1000, \"myconfig\", true);\n+    assertEquals(\"127.0.0.1\", addr.getAddress().getHostAddress());\n+    assertEquals(1000, addr.getPort());\n+\n+    addr = NetUtils.createSocketAddr(\n+        \"127.0.0.1\", 1000, \"myconfig\", true);\n+    assertEquals(\"127.0.0.1\", addr.getAddress().getHostAddress());\n+    assertEquals(1000, addr.getPort());\n+\n+    // ----------------------------------------------------\n+\n+    try {\n+      addr = NetUtils.createSocketAddr(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0a0103b7887d612217800c4f7d7647fe4d29dd9"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM5MTY0NQ==", "bodyText": "nit: the changes seems no related with this ticket,  Should we update it in another single one?", "url": "https://github.com/apache/hadoop/pull/2241#discussion_r478391645", "createdAt": "2020-08-27T12:47:07Z", "author": {"login": "Hexiaoqiao"}, "path": "hadoop-hdfs-project/hadoop-hdfs-client/src/main/java/org/apache/hadoop/hdfs/client/impl/DfsClientConf.java", "diffHunk": "@@ -211,24 +212,7 @@ public DfsClientConf(Configuration conf) {\n         Write.MAX_PACKETS_IN_FLIGHT_KEY,\n         Write.MAX_PACKETS_IN_FLIGHT_DEFAULT);\n \n-    final boolean byteArrayManagerEnabled = conf.getBoolean(\n-        Write.ByteArrayManager.ENABLED_KEY,\n-        Write.ByteArrayManager.ENABLED_DEFAULT);\n-    if (!byteArrayManagerEnabled) {\n-      writeByteArrayManagerConf = null;\n-    } else {\n-      final int countThreshold = conf.getInt(\n-          Write.ByteArrayManager.COUNT_THRESHOLD_KEY,\n-          Write.ByteArrayManager.COUNT_THRESHOLD_DEFAULT);\n-      final int countLimit = conf.getInt(\n-          Write.ByteArrayManager.COUNT_LIMIT_KEY,\n-          Write.ByteArrayManager.COUNT_LIMIT_DEFAULT);\n-      final long countResetTimePeriodMs = conf.getLong(\n-          Write.ByteArrayManager.COUNT_RESET_TIME_PERIOD_MS_KEY,\n-          Write.ByteArrayManager.COUNT_RESET_TIME_PERIOD_MS_DEFAULT);\n-      writeByteArrayManagerConf = new ByteArrayManager.Conf(\n-          countThreshold, countLimit, countResetTimePeriodMs);\n-    }\n+    writeByteArrayManagerConf = loadWriteByteArrayManagerConf(conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0a0103b7887d612217800c4f7d7647fe4d29dd9"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "008d865ca93009b38638b1347df11295dc71790e", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/008d865ca93009b38638b1347df11295dc71790e", "committedDate": "2020-08-27T14:29:14Z", "message": "remove some useless variables"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2ODQwMTE0", "url": "https://github.com/apache/hadoop/pull/2241#pullrequestreview-476840114", "createdAt": "2020-08-27T15:30:46Z", "commit": {"oid": "008d865ca93009b38638b1347df11295dc71790e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9baba782f9ce295cb321380a257e90d8badf3ee0", "author": {"user": {"login": "1996fanrui", "name": null}}, "url": "https://github.com/apache/hadoop/commit/9baba782f9ce295cb321380a257e90d8badf3ee0", "committedDate": "2020-09-09T02:21:50Z", "message": "trigger new CI check"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3944, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}