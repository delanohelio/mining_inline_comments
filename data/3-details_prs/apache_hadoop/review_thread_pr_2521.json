{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyODU1NjQz", "number": 2521, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjoxMzoyM1rOFCnyZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjozODoyNlrOFCoZOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4MjkzMzQ4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/java/org/apache/hadoop/fs/http/server/HttpFSServerWebApp.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjoxMzoyM1rOIB4mrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjoxMzoyM1rOIB4mrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0Njg5Mg==", "bodyText": "I think you need to increment OpsCheckAccess() in FSAccess.execute().", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538846892", "createdAt": "2020-12-08T22:13:23Z", "author": {"login": "jbrennan333"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/java/org/apache/hadoop/fs/http/server/HttpFSServerWebApp.java", "diffHunk": "@@ -123,6 +143,14 @@ public static HttpFSServerWebApp get() {\n     return SERVER;\n   }\n \n+  /**\n+   * gets the HttpFSServerMetrics instance.\n+   * @return the HttpFSServerMetrics singleton.\n+   */\n+  public static HttpFSServerMetrics getMetrics() {\n+    return metrics;\n+  }\n+\n   /**\n    * Returns HttpFSServer admin group.\n    *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4Mjk0ODIzOnYy", "diffSide": "RIGHT", "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/test/java/org/apache/hadoop/fs/http/server/TestHttpFSServer.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjoxNzowNVrOIB4vHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzo0Njo0OFrOIDVuRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0OTA1Mw==", "bodyText": "It's not clear to me why we need this metricsGetter.   Seems to add complexity with no added value.  Can't you just call the appropriate HttpFSServerWebApp.get().getMetrics().get* function wherever this is used?", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538849053", "createdAt": "2020-12-08T22:17:05Z", "author": {"login": "jbrennan333"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/test/java/org/apache/hadoop/fs/http/server/TestHttpFSServer.java", "diffHunk": "@@ -120,6 +122,25 @@\n  */\n public class TestHttpFSServer extends HFSTestCase {\n \n+  /**\n+   * define metric getters for unit tests.\n+   */\n+  private static Callable<Long> defaultEntryMetricGetter = () -> 0L;\n+  private static Callable<Long> defaultExitMetricGetter = () -> 1L;\n+  private static HashMap<String, Callable<Long>> metricsGetter =\n+      new HashMap<String, Callable<Long>>() {\n+        {\n+          put(\"LISTSTATUS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsListing());\n+          put(\"MKDIRS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsMkdir());\n+          put(\"GETFILESTATUS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsStat());\n+        }\n+      };\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwNTU0Mg==", "bodyText": "I found that the best way to check the metrics is to inject code in getStatus. This reduced the diff significantly. getStatus() accepts the cmd as a string, so adding if-then-else for each cmd will be more difficult to maintain. Finally, it is easier to add a command to the metricsGetter to extend the set of tests.\nAlso, the default callable saves NPE in case the command is not mapped to a metricGetter.", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538905542", "createdAt": "2020-12-09T00:12:12Z", "author": {"login": "amahussein"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/test/java/org/apache/hadoop/fs/http/server/TestHttpFSServer.java", "diffHunk": "@@ -120,6 +122,25 @@\n  */\n public class TestHttpFSServer extends HFSTestCase {\n \n+  /**\n+   * define metric getters for unit tests.\n+   */\n+  private static Callable<Long> defaultEntryMetricGetter = () -> 0L;\n+  private static Callable<Long> defaultExitMetricGetter = () -> 1L;\n+  private static HashMap<String, Callable<Long>> metricsGetter =\n+      new HashMap<String, Callable<Long>>() {\n+        {\n+          put(\"LISTSTATUS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsListing());\n+          put(\"MKDIRS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsMkdir());\n+          put(\"GETFILESTATUS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsStat());\n+        }\n+      };\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0OTA1Mw=="}, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYwMTYxNg==", "bodyText": "Oh I see that makes sense for getStatus().  I was looking at testMkdirs() when I was trying to understand why you were using it, and it didn't make sense to me.  I don't think you should use the metricsGetter in testMkdirs(), or at least not use getOrDefault() - the default case here does not make sense - it renders that part of the test meaningless.  I'd prefer to just get the ops directly in this case.", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r539601616", "createdAt": "2020-12-09T19:53:44Z", "author": {"login": "jbrennan333"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/test/java/org/apache/hadoop/fs/http/server/TestHttpFSServer.java", "diffHunk": "@@ -120,6 +122,25 @@\n  */\n public class TestHttpFSServer extends HFSTestCase {\n \n+  /**\n+   * define metric getters for unit tests.\n+   */\n+  private static Callable<Long> defaultEntryMetricGetter = () -> 0L;\n+  private static Callable<Long> defaultExitMetricGetter = () -> 1L;\n+  private static HashMap<String, Callable<Long>> metricsGetter =\n+      new HashMap<String, Callable<Long>>() {\n+        {\n+          put(\"LISTSTATUS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsListing());\n+          put(\"MKDIRS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsMkdir());\n+          put(\"GETFILESTATUS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsStat());\n+        }\n+      };\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0OTA1Mw=="}, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM3MjU0OA==", "bodyText": "Thanks @jbrennan333 .\nThis makes sense.\nI fixed testMkdirs, createDirWithHttp, testGlobFilter, and testHdfsAccess", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r540372548", "createdAt": "2020-12-10T17:46:48Z", "author": {"login": "amahussein"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/test/java/org/apache/hadoop/fs/http/server/TestHttpFSServer.java", "diffHunk": "@@ -120,6 +122,25 @@\n  */\n public class TestHttpFSServer extends HFSTestCase {\n \n+  /**\n+   * define metric getters for unit tests.\n+   */\n+  private static Callable<Long> defaultEntryMetricGetter = () -> 0L;\n+  private static Callable<Long> defaultExitMetricGetter = () -> 1L;\n+  private static HashMap<String, Callable<Long>> metricsGetter =\n+      new HashMap<String, Callable<Long>>() {\n+        {\n+          put(\"LISTSTATUS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsListing());\n+          put(\"MKDIRS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsMkdir());\n+          put(\"GETFILESTATUS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsStat());\n+        }\n+      };\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0OTA1Mw=="}, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4Mjk1MzQ4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/test/java/org/apache/hadoop/fs/http/server/TestHttpFSServer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjoxNzo1N1rOIB4yPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwMDoxMjoyNFrOIB8MHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0OTg1Mw==", "bodyText": "Seems like extra blank lines were added by accident.", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538849853", "createdAt": "2020-12-08T22:17:57Z", "author": {"login": "jbrennan333"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/test/java/org/apache/hadoop/fs/http/server/TestHttpFSServer.java", "diffHunk": "@@ -542,8 +572,12 @@ private void createDirWithHttp(String dirname, String perms,\n     conn.setRequestMethod(\"PUT\");\n     conn.connect();\n     Assert.assertEquals(HttpURLConnection.HTTP_OK, conn.getResponseCode());\n+    Assert.assertEquals(1 + oldOpsMkdir,\n+        HttpFSServerWebApp.get().getMetrics().getOpsMkdir());\n   }\n \n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwNTYzMA==", "bodyText": "done", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538905630", "createdAt": "2020-12-09T00:12:24Z", "author": {"login": "amahussein"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/test/java/org/apache/hadoop/fs/http/server/TestHttpFSServer.java", "diffHunk": "@@ -542,8 +572,12 @@ private void createDirWithHttp(String dirname, String perms,\n     conn.setRequestMethod(\"PUT\");\n     conn.connect();\n     Assert.assertEquals(HttpURLConnection.HTTP_OK, conn.getResponseCode());\n+    Assert.assertEquals(1 + oldOpsMkdir,\n+        HttpFSServerWebApp.get().getMetrics().getOpsMkdir());\n   }\n \n+\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0OTg1Mw=="}, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4MzAyNjk5OnYy", "diffSide": "RIGHT", "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/java/org/apache/hadoop/fs/http/server/HttpFSServerWebApp.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjozNjo1MVrOIB5bJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjozNjo1MVrOIB5bJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg2MDMyNw==", "bodyText": "Can you make this private?  It is only used by init() in this class.", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538860327", "createdAt": "2020-12-08T22:36:51Z", "author": {"login": "jbrennan333"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/java/org/apache/hadoop/fs/http/server/HttpFSServerWebApp.java", "diffHunk": "@@ -110,9 +116,23 @@ public void init() throws ServerException {\n   @Override\n   public void destroy() {\n     SERVER = null;\n+    if (metrics != null) {\n+      metrics.shutdown();\n+    }\n     super.destroy();\n   }\n \n+  public static void setMetrics(Configuration config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4MzAzMjkxOnYy", "diffSide": "RIGHT", "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/java/org/apache/hadoop/fs/http/server/HttpFSServerWebApp.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjozODoyNlrOIB5eWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjozODoyNlrOIB5eWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg2MTE0Nw==", "bodyText": "Can't you just use metrics instead of HttpFSServerWebApp.metrics?  Same a few lines below.", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538861147", "createdAt": "2020-12-08T22:38:26Z", "author": {"login": "jbrennan333"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/java/org/apache/hadoop/fs/http/server/HttpFSServerWebApp.java", "diffHunk": "@@ -110,9 +116,23 @@ public void init() throws ServerException {\n   @Override\n   public void destroy() {\n     SERVER = null;\n+    if (metrics != null) {\n+      metrics.shutdown();\n+    }\n     super.destroy();\n   }\n \n+  public static void setMetrics(Configuration config) {\n+    LOG.info(\"Initializing HttpFSServerMetrics\");\n+    HttpFSServerWebApp.metrics =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3169, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}