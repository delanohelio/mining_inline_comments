{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExMjY1MjU5", "number": 2419, "title": "HDFS-15654. TestBPOfferService#testMissBlocksWhenReregister fails intermittently", "bodyText": "\u2026ermittently\nNOTICE\nPlease create an issue in ASF JIRA before opening a pull request,\nand you need to set the title of the pull request which starts with\nthe corresponding JIRA issue number. (e.g. HADOOP-XXXXX. Fix a typo in YYY.)\nFor more details, please see https://cwiki.apache.org/confluence/display/HADOOP/How+To+Contribute", "createdAt": "2020-10-28T04:11:04Z", "url": "https://github.com/apache/hadoop/pull/2419", "merged": true, "mergeCommit": {"oid": "324879127a4fdfd0c2baedb81d79664daf4e3804"}, "closed": true, "closedAt": "2020-10-28T23:24:34Z", "author": {"login": "amahussein"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdW_TdzgFqTUxODc5MTIxNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXFvkzgBqjM5MzM3MzE5MDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NzkxMjE3", "url": "https://github.com/apache/hadoop/pull/2419#pullrequestreview-518791217", "createdAt": "2020-10-28T15:28:46Z", "commit": {"oid": "470cbc7df24a637de9bcdd226ecab1f65addde8b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNToyODo0NlrOHpv6uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNToyODo0NlrOHpv6uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUzODc0Nw==", "bodyText": "Remove this extra line added.", "url": "https://github.com/apache/hadoop/pull/2419#discussion_r513538747", "createdAt": "2020-10-28T15:28:46Z", "author": {"login": "goiri"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBPOfferService.java", "diffHunk": "@@ -280,26 +282,24 @@ public void testBasicFunctionality() throws Exception {\n    */\n   @Test\n   public void testMissBlocksWhenReregister() throws Exception {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "470cbc7df24a637de9bcdd226ecab1f65addde8b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4ODQwNTYw", "url": "https://github.com/apache/hadoop/pull/2419#pullrequestreview-518840560", "createdAt": "2020-10-28T16:13:23Z", "commit": {"oid": "d05e70d9b7b22a46c298201b6885ccb28816607a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjoxMzoyM1rOHpyJaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjoxMzoyM1rOHpyJaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3NTI3Mw==", "bodyText": "You might want to put the previous log message in the fail().", "url": "https://github.com/apache/hadoop/pull/2419#discussion_r513575273", "createdAt": "2020-10-28T16:13:23Z", "author": {"login": "goiri"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBPOfferService.java", "diffHunk": "@@ -318,45 +317,41 @@ public void blockUtilSendFullBlockReport() {\n             count.addAndGet(1);\n             Thread.sleep(1);\n           } catch (Exception e) {\n-            e.printStackTrace();\n+            LOG.error(\"error addNewBlockThread\", e);\n           }\n         }\n       });\n       addNewBlockThread.start();\n \n       // Make sure that generate blocks for DataNode and IBR not empty now.\n-      GenericTestUtils.waitFor(() -> {\n-        if(count.get() > 0) {\n-          return true;\n-        }\n-        return false;\n-      }, 100, 1000);\n+      GenericTestUtils.waitFor(() -> count.get() > 0, 100, 1000);\n \n       // Trigger re-register using DataNode Command.\n       datanodeCommands[0] = new DatanodeCommand[]{RegisterCommand.REGISTER};\n-      bpos.triggerHeartbeatForTests();\n \n+      bpos.triggerHeartbeatForTests();\n+      addNewBlockThread.join();\n+      addNewBlockThread = null;\n+      // Verify FBR/IBR count is equal to generate number.\n       try {\n-        GenericTestUtils.waitFor(() -> {\n-          if(fullBlockReportCount == totalTestBlocks ||\n-              incrBlockReportCount == totalTestBlocks) {\n-            return true;\n-          }\n-          return false;\n-        }, 1000, 15000);\n-      } catch (Exception e) {}\n+        GenericTestUtils.waitFor(() ->\n+            (fullBlockReportCount == totalTestBlocks ||\n+                incrBlockReportCount == totalTestBlocks), 1000, 15000);\n+      } catch (Exception e) {\n+        LOG.error(\"Timed out wait for IBR counts FBRCount = {},\"\n+                + \" IBRCount = {}; expected = {}\",\n+            fullBlockReportCount, incrBlockReportCount, totalTestBlocks);\n+        Assert.fail();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05e70d9b7b22a46c298201b6885ccb28816607a"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "651ade391610d987ca4b90d9afbb2729f66d8354", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/651ade391610d987ca4b90d9afbb2729f66d8354", "committedDate": "2020-10-28T22:58:32Z", "message": "HDFS-15654. TestBPOfferService#testMissBlocksWhenReregister fails intermittently"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "910c6bc5cb5e2ed6e2bd8bad4516ccb130401bc7", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/910c6bc5cb5e2ed6e2bd8bad4516ccb130401bc7", "committedDate": "2020-10-28T22:58:32Z", "message": "HDFS-15654. remove extra empty line."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f22a94a848d6d2de68029534446461604b734547", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/f22a94a848d6d2de68029534446461604b734547", "committedDate": "2020-10-28T22:58:32Z", "message": "HDFS-15654. fix imports"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d05e70d9b7b22a46c298201b6885ccb28816607a", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/d05e70d9b7b22a46c298201b6885ccb28816607a", "committedDate": "2020-10-28T15:41:40Z", "message": "HDFS-15654. remove extra empty line."}, "afterCommit": {"oid": "f22a94a848d6d2de68029534446461604b734547", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/f22a94a848d6d2de68029534446461604b734547", "committedDate": "2020-10-28T22:58:32Z", "message": "HDFS-15654. fix imports"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3517, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}