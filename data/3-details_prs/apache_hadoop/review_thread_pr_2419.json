{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExMjY1MjU5", "number": 2419, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNToyODo0NlrOEy3mmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjoxMzoyM1rOEy4-dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNzc1MjU4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBPOfferService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNToyODo0NlrOHpv6uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNToyODo0NlrOHpv6uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUzODc0Nw==", "bodyText": "Remove this extra line added.", "url": "https://github.com/apache/hadoop/pull/2419#discussion_r513538747", "createdAt": "2020-10-28T15:28:46Z", "author": {"login": "goiri"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBPOfferService.java", "diffHunk": "@@ -280,26 +282,24 @@ public void testBasicFunctionality() throws Exception {\n    */\n   @Test\n   public void testMissBlocksWhenReregister() throws Exception {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "470cbc7df24a637de9bcdd226ecab1f65addde8b"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNzk3NzUxOnYy", "diffSide": "RIGHT", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBPOfferService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjoxMzoyM1rOHpyJaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjoxNjo0NFrOHpyTHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3NTI3Mw==", "bodyText": "You might want to put the previous log message in the fail().", "url": "https://github.com/apache/hadoop/pull/2419#discussion_r513575273", "createdAt": "2020-10-28T16:13:23Z", "author": {"login": "goiri"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBPOfferService.java", "diffHunk": "@@ -318,45 +317,41 @@ public void blockUtilSendFullBlockReport() {\n             count.addAndGet(1);\n             Thread.sleep(1);\n           } catch (Exception e) {\n-            e.printStackTrace();\n+            LOG.error(\"error addNewBlockThread\", e);\n           }\n         }\n       });\n       addNewBlockThread.start();\n \n       // Make sure that generate blocks for DataNode and IBR not empty now.\n-      GenericTestUtils.waitFor(() -> {\n-        if(count.get() > 0) {\n-          return true;\n-        }\n-        return false;\n-      }, 100, 1000);\n+      GenericTestUtils.waitFor(() -> count.get() > 0, 100, 1000);\n \n       // Trigger re-register using DataNode Command.\n       datanodeCommands[0] = new DatanodeCommand[]{RegisterCommand.REGISTER};\n-      bpos.triggerHeartbeatForTests();\n \n+      bpos.triggerHeartbeatForTests();\n+      addNewBlockThread.join();\n+      addNewBlockThread = null;\n+      // Verify FBR/IBR count is equal to generate number.\n       try {\n-        GenericTestUtils.waitFor(() -> {\n-          if(fullBlockReportCount == totalTestBlocks ||\n-              incrBlockReportCount == totalTestBlocks) {\n-            return true;\n-          }\n-          return false;\n-        }, 1000, 15000);\n-      } catch (Exception e) {}\n+        GenericTestUtils.waitFor(() ->\n+            (fullBlockReportCount == totalTestBlocks ||\n+                incrBlockReportCount == totalTestBlocks), 1000, 15000);\n+      } catch (Exception e) {\n+        LOG.error(\"Timed out wait for IBR counts FBRCount = {},\"\n+                + \" IBRCount = {}; expected = {}\",\n+            fullBlockReportCount, incrBlockReportCount, totalTestBlocks);\n+        Assert.fail();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d05e70d9b7b22a46c298201b6885ccb28816607a"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3Nzc1Nw==", "bodyText": "And do the static import of fail() as the other assertEquals() and so on.", "url": "https://github.com/apache/hadoop/pull/2419#discussion_r513577757", "createdAt": "2020-10-28T16:16:44Z", "author": {"login": "goiri"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBPOfferService.java", "diffHunk": "@@ -318,45 +317,41 @@ public void blockUtilSendFullBlockReport() {\n             count.addAndGet(1);\n             Thread.sleep(1);\n           } catch (Exception e) {\n-            e.printStackTrace();\n+            LOG.error(\"error addNewBlockThread\", e);\n           }\n         }\n       });\n       addNewBlockThread.start();\n \n       // Make sure that generate blocks for DataNode and IBR not empty now.\n-      GenericTestUtils.waitFor(() -> {\n-        if(count.get() > 0) {\n-          return true;\n-        }\n-        return false;\n-      }, 100, 1000);\n+      GenericTestUtils.waitFor(() -> count.get() > 0, 100, 1000);\n \n       // Trigger re-register using DataNode Command.\n       datanodeCommands[0] = new DatanodeCommand[]{RegisterCommand.REGISTER};\n-      bpos.triggerHeartbeatForTests();\n \n+      bpos.triggerHeartbeatForTests();\n+      addNewBlockThread.join();\n+      addNewBlockThread = null;\n+      // Verify FBR/IBR count is equal to generate number.\n       try {\n-        GenericTestUtils.waitFor(() -> {\n-          if(fullBlockReportCount == totalTestBlocks ||\n-              incrBlockReportCount == totalTestBlocks) {\n-            return true;\n-          }\n-          return false;\n-        }, 1000, 15000);\n-      } catch (Exception e) {}\n+        GenericTestUtils.waitFor(() ->\n+            (fullBlockReportCount == totalTestBlocks ||\n+                incrBlockReportCount == totalTestBlocks), 1000, 15000);\n+      } catch (Exception e) {\n+        LOG.error(\"Timed out wait for IBR counts FBRCount = {},\"\n+                + \" IBRCount = {}; expected = {}\",\n+            fullBlockReportCount, incrBlockReportCount, totalTestBlocks);\n+        Assert.fail();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3NTI3Mw=="}, "originalCommit": {"oid": "d05e70d9b7b22a46c298201b6885ccb28816607a"}, "originalPosition": 80}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3238, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}