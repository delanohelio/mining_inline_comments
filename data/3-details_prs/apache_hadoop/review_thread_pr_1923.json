{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NTIzMjUx", "number": 1923, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNjoyMzoyM1rODv2WBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNjozNzozOFrODv2jww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTAwMDM3OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/CustomTokenProviderAdapter.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNjoyMzoyM1rOGCgmgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNDozMjo0M1rOGJi49w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NDQ4MA==", "bodyText": "Throwable might be safer?", "url": "https://github.com/apache/hadoop/pull/1923#discussion_r405284480", "createdAt": "2020-04-08T06:23:23Z", "author": {"login": "DadanielZ"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/CustomTokenProviderAdapter.java", "diffHunk": "@@ -46,16 +48,53 @@\n    *\n    * @param adaptee the custom token provider\n    */\n-  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee) {\n+  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee, int customTokenFetchRetryCount) {\n     Preconditions.checkNotNull(adaptee, \"adaptee\");\n     this.adaptee = adaptee;\n+    fetchTokenRetryCount = customTokenFetchRetryCount;\n   }\n \n   protected AzureADToken refreshToken() throws IOException {\n     LOG.debug(\"AADToken: refreshing custom based token\");\n \n     AzureADToken azureADToken = new AzureADToken();\n-    azureADToken.setAccessToken(adaptee.getAccessToken());\n+\n+    String accessToken = null;\n+\n+    Exception ex;\n+    boolean succeeded = false;\n+    // Custom token providers should have their own retry policies,\n+    // Providing a linear retry option for the the retry count\n+    // mentioned in config \"fs.azure.custom.token.fetch.retry.count\"\n+    int retryCount = fetchTokenRetryCount;\n+    do {\n+      ex = null;\n+      try {\n+        accessToken = adaptee.getAccessToken();\n+        LOG.trace(\"CustomTokenProvider Access token fetch was successful with retry count {}\", retryCount);\n+      } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57bb403440aa9a4638a887c904f099709bc4ae9b"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyMDYyNw==", "bodyText": "I checked across few articles and recommendation seems to be to not catch throwable. At this point we need to catch any exception coming from the CustomTokenProvider.\nPasting couple of links I referenced:\n\nhttps://stackify.com/best-practices-exceptions-java/ => scroll to \"6. Don\u2019t Catch Throwable\"\nhttps://www.baeldung.com/java-catch-throwable-bad-practice#catching-throwable\n\nPlease let me know if you still think this needs to be changed.", "url": "https://github.com/apache/hadoop/pull/1923#discussion_r412520627", "createdAt": "2020-04-21T21:59:03Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/CustomTokenProviderAdapter.java", "diffHunk": "@@ -46,16 +48,53 @@\n    *\n    * @param adaptee the custom token provider\n    */\n-  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee) {\n+  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee, int customTokenFetchRetryCount) {\n     Preconditions.checkNotNull(adaptee, \"adaptee\");\n     this.adaptee = adaptee;\n+    fetchTokenRetryCount = customTokenFetchRetryCount;\n   }\n \n   protected AzureADToken refreshToken() throws IOException {\n     LOG.debug(\"AADToken: refreshing custom based token\");\n \n     AzureADToken azureADToken = new AzureADToken();\n-    azureADToken.setAccessToken(adaptee.getAccessToken());\n+\n+    String accessToken = null;\n+\n+    Exception ex;\n+    boolean succeeded = false;\n+    // Custom token providers should have their own retry policies,\n+    // Providing a linear retry option for the the retry count\n+    // mentioned in config \"fs.azure.custom.token.fetch.retry.count\"\n+    int retryCount = fetchTokenRetryCount;\n+    do {\n+      ex = null;\n+      try {\n+        accessToken = adaptee.getAccessToken();\n+        LOG.trace(\"CustomTokenProvider Access token fetch was successful with retry count {}\", retryCount);\n+      } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NDQ4MA=="}, "originalCommit": {"oid": "57bb403440aa9a4638a887c904f099709bc4ae9b"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY2MjAwNw==", "bodyText": "yea Exception should be enough", "url": "https://github.com/apache/hadoop/pull/1923#discussion_r412662007", "createdAt": "2020-04-22T04:32:43Z", "author": {"login": "DadanielZ"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/CustomTokenProviderAdapter.java", "diffHunk": "@@ -46,16 +48,53 @@\n    *\n    * @param adaptee the custom token provider\n    */\n-  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee) {\n+  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee, int customTokenFetchRetryCount) {\n     Preconditions.checkNotNull(adaptee, \"adaptee\");\n     this.adaptee = adaptee;\n+    fetchTokenRetryCount = customTokenFetchRetryCount;\n   }\n \n   protected AzureADToken refreshToken() throws IOException {\n     LOG.debug(\"AADToken: refreshing custom based token\");\n \n     AzureADToken azureADToken = new AzureADToken();\n-    azureADToken.setAccessToken(adaptee.getAccessToken());\n+\n+    String accessToken = null;\n+\n+    Exception ex;\n+    boolean succeeded = false;\n+    // Custom token providers should have their own retry policies,\n+    // Providing a linear retry option for the the retry count\n+    // mentioned in config \"fs.azure.custom.token.fetch.retry.count\"\n+    int retryCount = fetchTokenRetryCount;\n+    do {\n+      ex = null;\n+      try {\n+        accessToken = adaptee.getAccessToken();\n+        LOG.trace(\"CustomTokenProvider Access token fetch was successful with retry count {}\", retryCount);\n+      } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NDQ4MA=="}, "originalCommit": {"oid": "57bb403440aa9a4638a887c904f099709bc4ae9b"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTAzNTU1OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/CustomTokenProviderAdapter.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNjozNzozOFrOGCg7UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNDozNDo1MFrOGJi7kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4OTgwOA==", "bodyText": "Is it necessary to add trace log here? it affects the perf for all rereshToken requests including those succeed without retry.\nAnd the retryCount in the message is confusing,  the total times of retries that have been executed should be fetchTokenRetryCount - retryCount, same for the msg in the catch block.", "url": "https://github.com/apache/hadoop/pull/1923#discussion_r405289808", "createdAt": "2020-04-08T06:37:38Z", "author": {"login": "DadanielZ"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/CustomTokenProviderAdapter.java", "diffHunk": "@@ -46,16 +48,53 @@\n    *\n    * @param adaptee the custom token provider\n    */\n-  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee) {\n+  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee, int customTokenFetchRetryCount) {\n     Preconditions.checkNotNull(adaptee, \"adaptee\");\n     this.adaptee = adaptee;\n+    fetchTokenRetryCount = customTokenFetchRetryCount;\n   }\n \n   protected AzureADToken refreshToken() throws IOException {\n     LOG.debug(\"AADToken: refreshing custom based token\");\n \n     AzureADToken azureADToken = new AzureADToken();\n-    azureADToken.setAccessToken(adaptee.getAccessToken());\n+\n+    String accessToken = null;\n+\n+    Exception ex;\n+    boolean succeeded = false;\n+    // Custom token providers should have their own retry policies,\n+    // Providing a linear retry option for the the retry count\n+    // mentioned in config \"fs.azure.custom.token.fetch.retry.count\"\n+    int retryCount = fetchTokenRetryCount;\n+    do {\n+      ex = null;\n+      try {\n+        accessToken = adaptee.getAccessToken();\n+        LOG.trace(\"CustomTokenProvider Access token fetch was successful with retry count {}\", retryCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57bb403440aa9a4638a887c904f099709bc4ae9b"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUxODE4Nw==", "bodyText": "Retaining the trace log as we have had couple of debugging scenarios where customTokenProvider implementation hung on execution. Trace log right after the adapter.getAccessToken() will provide quick indication of the issue.\nFrom previous PRs, have confirmation from Steve too that its not costly.\n#1842 (comment)\nHave fixed the wrong retry count getting displayed in log.", "url": "https://github.com/apache/hadoop/pull/1923#discussion_r412518187", "createdAt": "2020-04-21T21:54:26Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/CustomTokenProviderAdapter.java", "diffHunk": "@@ -46,16 +48,53 @@\n    *\n    * @param adaptee the custom token provider\n    */\n-  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee) {\n+  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee, int customTokenFetchRetryCount) {\n     Preconditions.checkNotNull(adaptee, \"adaptee\");\n     this.adaptee = adaptee;\n+    fetchTokenRetryCount = customTokenFetchRetryCount;\n   }\n \n   protected AzureADToken refreshToken() throws IOException {\n     LOG.debug(\"AADToken: refreshing custom based token\");\n \n     AzureADToken azureADToken = new AzureADToken();\n-    azureADToken.setAccessToken(adaptee.getAccessToken());\n+\n+    String accessToken = null;\n+\n+    Exception ex;\n+    boolean succeeded = false;\n+    // Custom token providers should have their own retry policies,\n+    // Providing a linear retry option for the the retry count\n+    // mentioned in config \"fs.azure.custom.token.fetch.retry.count\"\n+    int retryCount = fetchTokenRetryCount;\n+    do {\n+      ex = null;\n+      try {\n+        accessToken = adaptee.getAccessToken();\n+        LOG.trace(\"CustomTokenProvider Access token fetch was successful with retry count {}\", retryCount);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4OTgwOA=="}, "originalCommit": {"oid": "57bb403440aa9a4638a887c904f099709bc4ae9b"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY2MjY3NQ==", "bodyText": "I see, this is not string concatenation.", "url": "https://github.com/apache/hadoop/pull/1923#discussion_r412662675", "createdAt": "2020-04-22T04:34:50Z", "author": {"login": "DadanielZ"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/CustomTokenProviderAdapter.java", "diffHunk": "@@ -46,16 +48,53 @@\n    *\n    * @param adaptee the custom token provider\n    */\n-  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee) {\n+  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee, int customTokenFetchRetryCount) {\n     Preconditions.checkNotNull(adaptee, \"adaptee\");\n     this.adaptee = adaptee;\n+    fetchTokenRetryCount = customTokenFetchRetryCount;\n   }\n \n   protected AzureADToken refreshToken() throws IOException {\n     LOG.debug(\"AADToken: refreshing custom based token\");\n \n     AzureADToken azureADToken = new AzureADToken();\n-    azureADToken.setAccessToken(adaptee.getAccessToken());\n+\n+    String accessToken = null;\n+\n+    Exception ex;\n+    boolean succeeded = false;\n+    // Custom token providers should have their own retry policies,\n+    // Providing a linear retry option for the the retry count\n+    // mentioned in config \"fs.azure.custom.token.fetch.retry.count\"\n+    int retryCount = fetchTokenRetryCount;\n+    do {\n+      ex = null;\n+      try {\n+        accessToken = adaptee.getAccessToken();\n+        LOG.trace(\"CustomTokenProvider Access token fetch was successful with retry count {}\", retryCount);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4OTgwOA=="}, "originalCommit": {"oid": "57bb403440aa9a4638a887c904f099709bc4ae9b"}, "originalPosition": 45}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3639, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}