{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4OTc1NjM0", "number": 2178, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxOTo0NjowMlrOET0etw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjozMjowNlrOET3g7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjE4MjMxOnYy", "diffSide": "RIGHT", "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxOTo0NjowMlrOG5xXLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDozNzo0OVrOG54V_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMDc2Nw==", "bodyText": "error text should include the values at fault, so we can debug better from nothing but a junit report", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463230767", "createdAt": "2020-07-30T19:46:02Z", "author": {"login": "steveloughran"}, "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java", "diffHunk": "@@ -100,13 +101,34 @@ public void stopMiniKdc() {\n       executor.shutdownNow();\n     }\n   }\n+  \n+  /**\n+   * Login from keytab using the MiniKDC\n+   */\n+  @Test\n+  public void testUGILoginFromKeytab() throws Exception {\n+    long beforeLogin = Time.now();\n+    String principal = \"foo\";\n+    File keytab = new File(workDir, \"foo.keytab\");\n+    kdc.createPrincipal(keytab, principal);\n+\n+    UserGroupInformation.loginUserFromKeytab(principal, keytab.getPath());\n+    UserGroupInformation ugi = UserGroupInformation.getLoginUser();\n+    Assert.assertTrue(\"UGI should be configured to login from keytab\",\n+        ugi.isFromKeytab());\n+\n+    User user = getUser(ugi.getSubject());\n+    Assert.assertNotNull(user.getLogin());\n+    Assert.assertTrue(\"User last login time is not set correctly\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31386063d9935c058ba4812e7e2c88f44c42f4d5"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NTE1MA==", "bodyText": "Agreed, updated the code", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463345150", "createdAt": "2020-07-31T00:37:49Z", "author": {"login": "sguggilam"}, "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java", "diffHunk": "@@ -100,13 +101,34 @@ public void stopMiniKdc() {\n       executor.shutdownNow();\n     }\n   }\n+  \n+  /**\n+   * Login from keytab using the MiniKDC\n+   */\n+  @Test\n+  public void testUGILoginFromKeytab() throws Exception {\n+    long beforeLogin = Time.now();\n+    String principal = \"foo\";\n+    File keytab = new File(workDir, \"foo.keytab\");\n+    kdc.createPrincipal(keytab, principal);\n+\n+    UserGroupInformation.loginUserFromKeytab(principal, keytab.getPath());\n+    UserGroupInformation ugi = UserGroupInformation.getLoginUser();\n+    Assert.assertTrue(\"UGI should be configured to login from keytab\",\n+        ugi.isFromKeytab());\n+\n+    User user = getUser(ugi.getSubject());\n+    Assert.assertNotNull(user.getLogin());\n+    Assert.assertTrue(\"User last login time is not set correctly\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMDc2Nw=="}, "originalCommit": {"oid": "31386063d9935c058ba4812e7e2c88f44c42f4d5"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjE4ODQ0OnYy", "diffSide": "RIGHT", "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxOTo0Nzo0NFrOG5xa8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDozODowMVrOG54WIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMTcyOQ==", "bodyText": "if you really want >1s of interval, make it a 2s, delay. There's too much risk of clock/sleep granularity issues", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463231729", "createdAt": "2020-07-30T19:47:44Z", "author": {"login": "steveloughran"}, "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java", "diffHunk": "@@ -121,6 +143,9 @@ public void testUGILoginFromKeytab() throws Exception {\n     final long firstLogin = user.getLastLogin();\n     final LoginContext login1 = user.getLogin();\n     Assert.assertNotNull(login1);\n+    \n+    // Sleep for 1 sec to have a difference between first and second login\n+    Thread.sleep(1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31386063d9935c058ba4812e7e2c88f44c42f4d5"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NTE4NA==", "bodyText": "Makes sense, changed it to 2 sec", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463345184", "createdAt": "2020-07-31T00:38:01Z", "author": {"login": "sguggilam"}, "path": "hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java", "diffHunk": "@@ -121,6 +143,9 @@ public void testUGILoginFromKeytab() throws Exception {\n     final long firstLogin = user.getLastLogin();\n     final LoginContext login1 = user.getLogin();\n     Assert.assertNotNull(login1);\n+    \n+    // Sleep for 1 sec to have a difference between first and second login\n+    Thread.sleep(1000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMTcyOQ=="}, "originalCommit": {"oid": "31386063d9935c058ba4812e7e2c88f44c42f4d5"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjE5MTI0OnYy", "diffSide": "RIGHT", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxOTo0ODozNFrOG5xcqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDozODoxOVrOG54WYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMjE3MA==", "bodyText": "add javadoc, note unit of time. Milliseconds, right?", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463232170", "createdAt": "2020-07-30T19:48:34Z", "author": {"login": "steveloughran"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java", "diffHunk": "@@ -528,6 +528,10 @@ private HadoopLoginContext getLogin() {\n   private void setLogin(LoginContext login) {\n     user.setLogin(login);\n   }\n+  \n+  private void setLastLogin(long now) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31386063d9935c058ba4812e7e2c88f44c42f4d5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwNDA4Nw==", "bodyText": "Make @param time and long now the same variable name? e.g. name it loginTime", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463304087", "createdAt": "2020-07-30T22:21:58Z", "author": {"login": "liuml07"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java", "diffHunk": "@@ -528,6 +528,10 @@ private HadoopLoginContext getLogin() {\n   private void setLogin(LoginContext login) {\n     user.setLogin(login);\n   }\n+  \n+  private void setLastLogin(long now) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMjE3MA=="}, "originalCommit": {"oid": "31386063d9935c058ba4812e7e2c88f44c42f4d5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0NTI0OA==", "bodyText": "Yes agreed, made the change", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463345248", "createdAt": "2020-07-31T00:38:19Z", "author": {"login": "sguggilam"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java", "diffHunk": "@@ -528,6 +528,10 @@ private HadoopLoginContext getLogin() {\n   private void setLogin(LoginContext login) {\n     user.setLogin(login);\n   }\n+  \n+  private void setLastLogin(long now) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMjE3MA=="}, "originalCommit": {"oid": "31386063d9935c058ba4812e7e2c88f44c42f4d5"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjY3OTUxOnYy", "diffSide": "RIGHT", "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjozMjowNlrOG52GTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjo0NTozOVrOG52XiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwODM2NA==", "bodyText": "the user::lastLogin was the last attempt to login. I'm not sure if we should put this before the try clause (aka before new L1969)?\nCC: @steveloughran", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463308364", "createdAt": "2020-07-30T22:32:06Z", "author": {"login": "liuml07"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java", "diffHunk": "@@ -1968,6 +1976,7 @@ private static UserGroupInformation doSubjectLogin(\n       if (subject == null) {\n         params.put(LoginParam.PRINCIPAL, ugi.getUserName());\n         ugi.setLogin(login);\n+        ugi.setLastLogin(Time.now());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43c5a89c1dbdbe9f85a6d25971f47b66c46f5038"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMxMjc3Nw==", "bodyText": "@liuml07 We should set this only after the login is successful right ? If we add it before the try, then we might update it even in case of unsuccessful login in which case a retry should be permitted immediately. Please let me know your thoughts", "url": "https://github.com/apache/hadoop/pull/2178#discussion_r463312777", "createdAt": "2020-07-30T22:45:39Z", "author": {"login": "sguggilam"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java", "diffHunk": "@@ -1968,6 +1976,7 @@ private static UserGroupInformation doSubjectLogin(\n       if (subject == null) {\n         params.put(LoginParam.PRINCIPAL, ugi.getUserName());\n         ugi.setLogin(login);\n+        ugi.setLastLogin(Time.now());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwODM2NA=="}, "originalCommit": {"oid": "43c5a89c1dbdbe9f85a6d25971f47b66c46f5038"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3346, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}