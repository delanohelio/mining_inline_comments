{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwMTU5MTQ4", "number": 2148, "title": "HADOOP-17131. Refactor S3A Listing code for better isolation.", "bodyText": "Ran tests in ap-south-1 bucket using mvn clean verify   -Dparallel-tests  and mvn clean verify  -Ds3guard -Ddynamo -Dparallel-tests\nAll good.", "createdAt": "2020-07-16T12:32:06Z", "url": "https://github.com/apache/hadoop/pull/2148", "merged": true, "mergeCommit": {"oid": "8fd4f5490f59a2e9e561b6438b30b3a7453c808b"}, "closed": true, "closedAt": "2020-08-04T15:00:03Z", "author": {"login": "mukund-thakur"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1cI-mgH2gAyNDUwMTU5MTQ4OjMxNWFhNDMxNTNlYWRlNmJiYTQ0Mjg4YjQ5M2I4NDNkNGRiZjc1NDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7n8BIAFqTQ2MDg5ODczNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "315aa43153eade6bba44288b493b843d4dbf7540", "author": {"user": {"login": "mukund-thakur", "name": "Mukund Thakur"}}, "url": "https://github.com/apache/hadoop/commit/315aa43153eade6bba44288b493b843d4dbf7540", "committedDate": "2020-07-16T09:51:13Z", "message": "HADOOP-17131 Moving listing to use operation callback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a70b6507650f63fb7e5f5330283a4018c68a5ec", "author": {"user": {"login": "mukund-thakur", "name": "Mukund Thakur"}}, "url": "https://github.com/apache/hadoop/commit/3a70b6507650f63fb7e5f5330283a4018c68a5ec", "committedDate": "2020-07-17T09:38:45Z", "message": "Moving listing methods to Listing class for better abstraction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bda8f84040fd81aa54485441d40b108f8e46d6ed", "author": {"user": {"login": "mukund-thakur", "name": "Mukund Thakur"}}, "url": "https://github.com/apache/hadoop/commit/bda8f84040fd81aa54485441d40b108f8e46d6ed", "committedDate": "2020-07-20T14:49:27Z", "message": "Adding ListingOperationCallbacks interface for list ops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MzcxNDAy", "url": "https://github.com/apache/hadoop/pull/2148#pullrequestreview-457371402", "createdAt": "2020-07-29T09:56:43Z", "commit": {"oid": "bda8f84040fd81aa54485441d40b108f8e46d6ed"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NTYyNTYz", "url": "https://github.com/apache/hadoop/pull/2148#pullrequestreview-457562563", "createdAt": "2020-07-29T14:12:19Z", "commit": {"oid": "bda8f84040fd81aa54485441d40b108f8e46d6ed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NzU5ODA5", "url": "https://github.com/apache/hadoop/pull/2148#pullrequestreview-457759809", "createdAt": "2020-07-29T17:57:55Z", "commit": {"oid": "bda8f84040fd81aa54485441d40b108f8e46d6ed"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNzo1Nzo1NVrOG5Dyuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxODowNDo1OFrOG5ECvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4NDE1NQ==", "bodyText": "not true any more though, not now there's a new listing interface, right?", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462484155", "createdAt": "2020-07-29T17:57:55Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/OperationCallbacks.java", "diffHunk": "@@ -40,7 +40,8 @@\n import org.apache.hadoop.fs.s3a.s3guard.BulkOperationState;\n \n /**\n- * These are all the callbacks which the {@link RenameOperation}\n+ * These are all the callbacks which the {@link RenameOperation},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda8f84040fd81aa54485441d40b108f8e46d6ed"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4NTEzNA==", "bodyText": "I'd rather these were left out of the context and only explicitly passed to those classes which explicitly needed the operations. That helps us stay in control of what operations specific modules can perform", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462485134", "createdAt": "2020-07-29T17:59:36Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/impl/StoreContext.java", "diffHunk": "@@ -116,6 +116,16 @@\n    */\n   private ITtlTimeProvider timeProvider;\n \n+  /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda8f84040fd81aa54485441d40b108f8e46d6ed"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4NjI2MA==", "bodyText": "have this take the context and the ListingOperationCallbacks, add a method in S3AFS createListing() which can be used there and in DumpS3GuardDynamoTable...that avoids having to extend the store context", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462486260", "createdAt": "2020-07-29T18:01:24Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java", "diffHunk": "@@ -46,25 +56,27 @@\n import java.util.Set;\n \n import static org.apache.hadoop.fs.s3a.Constants.S3N_FOLDER_SUFFIX;\n+import static org.apache.hadoop.fs.s3a.S3AUtils.ACCEPT_ALL;\n import static org.apache.hadoop.fs.s3a.S3AUtils.createFileStatus;\n+import static org.apache.hadoop.fs.s3a.S3AUtils.maybeAddTrailingSlash;\n import static org.apache.hadoop.fs.s3a.S3AUtils.objectRepresentsDirectory;\n import static org.apache.hadoop.fs.s3a.S3AUtils.stringify;\n import static org.apache.hadoop.fs.s3a.S3AUtils.translateException;\n+import static org.apache.hadoop.fs.s3a.auth.RoleModel.pathToKey;\n \n /**\n  * Place for the S3A listing classes; keeps all the small classes under control.\n  */\n @InterfaceAudience.Private\n-public class Listing {\n+public class Listing extends AbstractStoreOperation {\n \n-  private final S3AFileSystem owner;\n   private static final Logger LOG = S3AFileSystem.LOG;\n \n   static final FileStatusAcceptor ACCEPT_ALL_BUT_S3N =\n       new AcceptAllButS3nDirs();\n \n-  public Listing(S3AFileSystem owner) {\n-    this.owner = owner;\n+  public Listing(StoreContext storeContext) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda8f84040fd81aa54485441d40b108f8e46d6ed"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4NzEzOQ==", "bodyText": "Make the type of this field the interface for strictness", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462487139", "createdAt": "2020-07-29T18:02:59Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java", "diffHunk": "@@ -293,6 +294,9 @@\n   private final S3AFileSystem.OperationCallbacksImpl\n       operationCallbacks = new OperationCallbacksImpl();\n \n+  private final S3AFileSystem.ListingOperationCallbacksImpl", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda8f84040fd81aa54485441d40b108f8e46d6ed"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4NzYyMA==", "bodyText": "nice touch", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462487620", "createdAt": "2020-07-29T18:03:53Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java", "diffHunk": "@@ -1599,6 +1603,36 @@ public boolean allowAuthoritative(final Path p) {\n     }\n   }\n \n+  protected class ListingOperationCallbacksImpl implements ListingOperationCallbacks {\n+\n+    @Override\n+    @Retries.RetryRaw\n+    public S3ListResult listObjects(\n+            S3ListRequest request)\n+            throws IOException {\n+      return S3AFileSystem.this.listObjects(request);\n+    }\n+\n+    @Override\n+    @Retries.RetryRaw", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda8f84040fd81aa54485441d40b108f8e46d6ed"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4ODI1Mw==", "bodyText": "Add to the ListingOperationCallbacks", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r462488253", "createdAt": "2020-07-29T18:04:58Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java", "diffHunk": "@@ -4847,5 +4800,20 @@ public String getBucketLocation() throws IOException {\n     public Path makeQualified(final Path path) {\n       return S3AFileSystem.this.makeQualified(path);\n     }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda8f84040fd81aa54485441d40b108f8e46d6ed"}, "originalPosition": 192}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61", "author": {"user": {"login": "mukund-thakur", "name": "Mukund Thakur"}}, "url": "https://github.com/apache/hadoop/commit/cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61", "committedDate": "2020-07-31T13:59:04Z", "message": "Review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTczMDIw", "url": "https://github.com/apache/hadoop/pull/2148#pullrequestreview-459573020", "createdAt": "2020-08-01T11:44:45Z", "commit": {"oid": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQxMTo0NDo0NVrOG6dhkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQxMTo0NDo0NVrOG6dhkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk1NDMyMQ==", "bodyText": "I'd keep it as a subclass of AbstractStoreOperation.\nwe may want to declare it as Closeable, and in tests and S3AFS call close()/closeQuietly() on it. Gives us the option of doing more with it later\n\nWhat I don't want -and which you have done in this commit, is add the new list commands into the OperationCallbacks interface", "url": "https://github.com/apache/hadoop/pull/2148#discussion_r463954321", "createdAt": "2020-08-01T11:44:45Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java", "diffHunk": "@@ -68,15 +68,21 @@\n  * Place for the S3A listing classes; keeps all the small classes under control.\n  */\n @InterfaceAudience.Private\n-public class Listing extends AbstractStoreOperation {\n+public class Listing {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTczMDkw", "url": "https://github.com/apache/hadoop/pull/2148#pullrequestreview-459573090", "createdAt": "2020-08-01T11:46:15Z", "commit": {"oid": "cd1b0a7169da4fe279b0a5a9fe1de582f30e5f61"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d5b331e8911ebc171bfa1bce163d04830b7fce4", "author": {"user": {"login": "mukund-thakur", "name": "Mukund Thakur"}}, "url": "https://github.com/apache/hadoop/commit/2d5b331e8911ebc171bfa1bce163d04830b7fce4", "committedDate": "2020-08-03T08:18:22Z", "message": "Final touch and checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d625e94dad30bb2d38909d7e60cfc82c84b37e07", "author": {"user": {"login": "mukund-thakur", "name": "Mukund Thakur"}}, "url": "https://github.com/apache/hadoop/commit/d625e94dad30bb2d38909d7e60cfc82c84b37e07", "committedDate": "2020-08-04T07:29:50Z", "message": "license and findbugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwODk4NzM2", "url": "https://github.com/apache/hadoop/pull/2148#pullrequestreview-460898736", "createdAt": "2020-08-04T14:59:28Z", "commit": {"oid": "d625e94dad30bb2d38909d7e60cfc82c84b37e07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4164, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}