{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4OTg4MDcw", "number": 2406, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNjo1NToyMlrOExSSJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDoyMzoxOFrOEyRvxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTE1MjM4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileCreation.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNjo1NToyMlrOHnV7Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNjoyNTozNVrOHny0lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAxNTY5MA==", "bodyText": "Should we wait a little longer than 100ms?", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r511015690", "createdAt": "2020-10-23T16:55:22Z", "author": {"login": "goiri"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileCreation.java", "diffHunk": "@@ -273,10 +272,17 @@ public void testServerDefaultsWithMinimalCaching()\n               defaults.getDefaultStoragePolicyId());\n       doReturn(newDefaults).when(spyNamesystem).getServerDefaults();\n \n-      Thread.sleep(1);\n-      defaults = dfsClient.getServerDefaults();\n-      // Value is updated correctly\n-      assertEquals(updatedDefaultBlockSize, defaults.getBlockSize());\n+      // Verify that the value is updated correctly\n+      GenericTestUtils.waitFor(()->{\n+        try {\n+          FsServerDefaults currDef = dfsClient.getServerDefaults();\n+          return (currDef.getBlockSize() == updatedDefaultBlockSize);\n+        } catch (IOException e) {\n+          // do nothing;\n+          return false;\n+        }\n+      }, 1, 100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d54e819bccd13905ca277ba0556cb898b1807ac"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzNjA0MQ==", "bodyText": "Thanks @goiri for taking the time to look at the fix.\nThe old code used to sleep 1 ms. So, theoretically, we are doing 100x in case the node is slow compared to before.\nHow long do you suggest we should wait?", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r511036041", "createdAt": "2020-10-23T17:34:47Z", "author": {"login": "amahussein"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileCreation.java", "diffHunk": "@@ -273,10 +272,17 @@ public void testServerDefaultsWithMinimalCaching()\n               defaults.getDefaultStoragePolicyId());\n       doReturn(newDefaults).when(spyNamesystem).getServerDefaults();\n \n-      Thread.sleep(1);\n-      defaults = dfsClient.getServerDefaults();\n-      // Value is updated correctly\n-      assertEquals(updatedDefaultBlockSize, defaults.getBlockSize());\n+      // Verify that the value is updated correctly\n+      GenericTestUtils.waitFor(()->{\n+        try {\n+          FsServerDefaults currDef = dfsClient.getServerDefaults();\n+          return (currDef.getBlockSize() == updatedDefaultBlockSize);\n+        } catch (IOException e) {\n+          // do nothing;\n+          return false;\n+        }\n+      }, 1, 100);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAxNTY5MA=="}, "originalCommit": {"oid": "8d54e819bccd13905ca277ba0556cb898b1807ac"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4OTE3NA==", "bodyText": "I think something like 1 second is reasonable.\nTaking into account that this extra time would only happen when the test fails, we would never see this.\nIn this case I prefer to be conservative and handle corner cases.", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r511489174", "createdAt": "2020-10-24T16:25:35Z", "author": {"login": "goiri"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileCreation.java", "diffHunk": "@@ -273,10 +272,17 @@ public void testServerDefaultsWithMinimalCaching()\n               defaults.getDefaultStoragePolicyId());\n       doReturn(newDefaults).when(spyNamesystem).getServerDefaults();\n \n-      Thread.sleep(1);\n-      defaults = dfsClient.getServerDefaults();\n-      // Value is updated correctly\n-      assertEquals(updatedDefaultBlockSize, defaults.getBlockSize());\n+      // Verify that the value is updated correctly\n+      GenericTestUtils.waitFor(()->{\n+        try {\n+          FsServerDefaults currDef = dfsClient.getServerDefaults();\n+          return (currDef.getBlockSize() == updatedDefaultBlockSize);\n+        } catch (IOException e) {\n+          // do nothing;\n+          return false;\n+        }\n+      }, 1, 100);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAxNTY5MA=="}, "originalCommit": {"oid": "8d54e819bccd13905ca277ba0556cb898b1807ac"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMTU1MDEzOnYy", "diffSide": "RIGHT", "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileCreation.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDoyMzoxOFrOHo00uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMTo1NjowOVrOHpXL5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3MDU1Mg==", "bodyText": "Thank you @amahussein. How about increasing the timeout to 2 or 3 seconds?", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r512570552", "createdAt": "2020-10-27T10:23:18Z", "author": {"login": "aajisaka"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileCreation.java", "diffHunk": "@@ -273,10 +272,17 @@ public void testServerDefaultsWithMinimalCaching()\n               defaults.getDefaultStoragePolicyId());\n       doReturn(newDefaults).when(spyNamesystem).getServerDefaults();\n \n-      Thread.sleep(1);\n-      defaults = dfsClient.getServerDefaults();\n-      // Value is updated correctly\n-      assertEquals(updatedDefaultBlockSize, defaults.getBlockSize());\n+      // Verify that the value is updated correctly\n+      GenericTestUtils.waitFor(()->{\n+        try {\n+          FsServerDefaults currDef = dfsClient.getServerDefaults();\n+          return (currDef.getBlockSize() == updatedDefaultBlockSize);\n+        } catch (IOException e) {\n+          // do nothing;\n+          return false;\n+        }\n+      }, 1, 1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61af10856763fcde7a7e99ad5fdc6f2bddff08eb"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4Nzg0OQ==", "bodyText": "Thank you @aajisaka .. I updated the Pr setting the waitTime to 3 seconds.", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r512987849", "createdAt": "2020-10-27T19:51:37Z", "author": {"login": "amahussein"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileCreation.java", "diffHunk": "@@ -273,10 +272,17 @@ public void testServerDefaultsWithMinimalCaching()\n               defaults.getDefaultStoragePolicyId());\n       doReturn(newDefaults).when(spyNamesystem).getServerDefaults();\n \n-      Thread.sleep(1);\n-      defaults = dfsClient.getServerDefaults();\n-      // Value is updated correctly\n-      assertEquals(updatedDefaultBlockSize, defaults.getBlockSize());\n+      // Verify that the value is updated correctly\n+      GenericTestUtils.waitFor(()->{\n+        try {\n+          FsServerDefaults currDef = dfsClient.getServerDefaults();\n+          return (currDef.getBlockSize() == updatedDefaultBlockSize);\n+        } catch (IOException e) {\n+          // do nothing;\n+          return false;\n+        }\n+      }, 1, 1000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3MDU1Mg=="}, "originalCommit": {"oid": "61af10856763fcde7a7e99ad5fdc6f2bddff08eb"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEzMzU0Mg==", "bodyText": "This is changed so I assume @aajisaka is fine with this.", "url": "https://github.com/apache/hadoop/pull/2406#discussion_r513133542", "createdAt": "2020-10-28T01:56:09Z", "author": {"login": "goiri"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileCreation.java", "diffHunk": "@@ -273,10 +272,17 @@ public void testServerDefaultsWithMinimalCaching()\n               defaults.getDefaultStoragePolicyId());\n       doReturn(newDefaults).when(spyNamesystem).getServerDefaults();\n \n-      Thread.sleep(1);\n-      defaults = dfsClient.getServerDefaults();\n-      // Value is updated correctly\n-      assertEquals(updatedDefaultBlockSize, defaults.getBlockSize());\n+      // Verify that the value is updated correctly\n+      GenericTestUtils.waitFor(()->{\n+        try {\n+          FsServerDefaults currDef = dfsClient.getServerDefaults();\n+          return (currDef.getBlockSize() == updatedDefaultBlockSize);\n+        } catch (IOException e) {\n+          // do nothing;\n+          return false;\n+        }\n+      }, 1, 1000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3MDU1Mg=="}, "originalCommit": {"oid": "61af10856763fcde7a7e99ad5fdc6f2bddff08eb"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3228, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}