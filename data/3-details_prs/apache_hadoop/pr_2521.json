{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyODU1NjQz", "number": 2521, "title": "HDFS-15711. Add Metrics to HttpFS Server.", "bodyText": "NOTICE\nPlease create an issue in ASF JIRA before opening a pull request,\nand you need to set the title of the pull request which starts with\nthe corresponding JIRA issue number. (e.g. HADOOP-XXXXX. Fix a typo in YYY.)\nFor more details, please see https://cwiki.apache.org/confluence/display/HADOOP/How+To+Contribute", "createdAt": "2020-12-05T00:14:47Z", "url": "https://github.com/apache/hadoop/pull/2521", "merged": true, "mergeCommit": {"oid": "3ec01b1bb3043dc263015a7f2a46e4e49bd6919f"}, "closed": true, "closedAt": "2020-12-10T19:09:53Z", "author": {"login": "amahussein"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj2kHDABqjQwNzk5NzQwMDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk4N0OgFqTU0OTUxNjY4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34be9cfd33571e5aec71a206aa871df3bfe5b59d", "author": {"user": {"login": "amahussein", "name": "Ahmed Hussein"}}, "url": "https://github.com/apache/hadoop/commit/34be9cfd33571e5aec71a206aa871df3bfe5b59d", "committedDate": "2020-12-05T02:36:10Z", "message": "HDFS-15711. Fix checkstyling and findBugs"}, "afterCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3", "author": {"user": {"login": "amahussein", "name": "Ahmed Hussein"}}, "url": "https://github.com/apache/hadoop/commit/c2cc329d0e77c16a5c68e55f616eacbb63ac36b3", "committedDate": "2020-12-07T14:38:21Z", "message": "HDFS-15711. Add Metrics to HttpFS Server."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3Njc2Njk3", "url": "https://github.com/apache/hadoop/pull/2521#pullrequestreview-547676697", "createdAt": "2020-12-08T22:13:23Z", "commit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjoxMzoyM1rOIB4mrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjozODoyNlrOIB5eWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0Njg5Mg==", "bodyText": "I think you need to increment OpsCheckAccess() in FSAccess.execute().", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538846892", "createdAt": "2020-12-08T22:13:23Z", "author": {"login": "jbrennan333"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/java/org/apache/hadoop/fs/http/server/HttpFSServerWebApp.java", "diffHunk": "@@ -123,6 +143,14 @@ public static HttpFSServerWebApp get() {\n     return SERVER;\n   }\n \n+  /**\n+   * gets the HttpFSServerMetrics instance.\n+   * @return the HttpFSServerMetrics singleton.\n+   */\n+  public static HttpFSServerMetrics getMetrics() {\n+    return metrics;\n+  }\n+\n   /**\n    * Returns HttpFSServer admin group.\n    *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0OTA1Mw==", "bodyText": "It's not clear to me why we need this metricsGetter.   Seems to add complexity with no added value.  Can't you just call the appropriate HttpFSServerWebApp.get().getMetrics().get* function wherever this is used?", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538849053", "createdAt": "2020-12-08T22:17:05Z", "author": {"login": "jbrennan333"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/test/java/org/apache/hadoop/fs/http/server/TestHttpFSServer.java", "diffHunk": "@@ -120,6 +122,25 @@\n  */\n public class TestHttpFSServer extends HFSTestCase {\n \n+  /**\n+   * define metric getters for unit tests.\n+   */\n+  private static Callable<Long> defaultEntryMetricGetter = () -> 0L;\n+  private static Callable<Long> defaultExitMetricGetter = () -> 1L;\n+  private static HashMap<String, Callable<Long>> metricsGetter =\n+      new HashMap<String, Callable<Long>>() {\n+        {\n+          put(\"LISTSTATUS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsListing());\n+          put(\"MKDIRS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsMkdir());\n+          put(\"GETFILESTATUS\",\n+              () -> HttpFSServerWebApp.get().getMetrics().getOpsStat());\n+        }\n+      };\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0OTg1Mw==", "bodyText": "Seems like extra blank lines were added by accident.", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538849853", "createdAt": "2020-12-08T22:17:57Z", "author": {"login": "jbrennan333"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/test/java/org/apache/hadoop/fs/http/server/TestHttpFSServer.java", "diffHunk": "@@ -542,8 +572,12 @@ private void createDirWithHttp(String dirname, String perms,\n     conn.setRequestMethod(\"PUT\");\n     conn.connect();\n     Assert.assertEquals(HttpURLConnection.HTTP_OK, conn.getResponseCode());\n+    Assert.assertEquals(1 + oldOpsMkdir,\n+        HttpFSServerWebApp.get().getMetrics().getOpsMkdir());\n   }\n \n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg2MDMyNw==", "bodyText": "Can you make this private?  It is only used by init() in this class.", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538860327", "createdAt": "2020-12-08T22:36:51Z", "author": {"login": "jbrennan333"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/java/org/apache/hadoop/fs/http/server/HttpFSServerWebApp.java", "diffHunk": "@@ -110,9 +116,23 @@ public void init() throws ServerException {\n   @Override\n   public void destroy() {\n     SERVER = null;\n+    if (metrics != null) {\n+      metrics.shutdown();\n+    }\n     super.destroy();\n   }\n \n+  public static void setMetrics(Configuration config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg2MTE0Nw==", "bodyText": "Can't you just use metrics instead of HttpFSServerWebApp.metrics?  Same a few lines below.", "url": "https://github.com/apache/hadoop/pull/2521#discussion_r538861147", "createdAt": "2020-12-08T22:38:26Z", "author": {"login": "jbrennan333"}, "path": "hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/java/org/apache/hadoop/fs/http/server/HttpFSServerWebApp.java", "diffHunk": "@@ -110,9 +116,23 @@ public void init() throws ServerException {\n   @Override\n   public void destroy() {\n     SERVER = null;\n+    if (metrics != null) {\n+      metrics.shutdown();\n+    }\n     super.destroy();\n   }\n \n+  public static void setMetrics(Configuration config) {\n+    LOG.info(\"Initializing HttpFSServerMetrics\");\n+    HttpFSServerWebApp.metrics =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3"}, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2cc329d0e77c16a5c68e55f616eacbb63ac36b3", "author": {"user": {"login": "amahussein", "name": "Ahmed Hussein"}}, "url": "https://github.com/apache/hadoop/commit/c2cc329d0e77c16a5c68e55f616eacbb63ac36b3", "committedDate": "2020-12-07T14:38:21Z", "message": "HDFS-15711. Add Metrics to HttpFS Server."}, "afterCommit": {"oid": "b833540d47457d02c831a9f2dacdea0e60423fbf", "author": {"user": {"login": "amahussein", "name": "Ahmed Hussein"}}, "url": "https://github.com/apache/hadoop/commit/b833540d47457d02c831a9f2dacdea0e60423fbf", "committedDate": "2020-12-09T00:16:10Z", "message": "HDFS-15711. code reviews."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06a3276d392dcb7d5924a21cba30062b6c832ae6", "author": {"user": {"login": "amahussein", "name": "Ahmed Hussein"}}, "url": "https://github.com/apache/hadoop/commit/06a3276d392dcb7d5924a21cba30062b6c832ae6", "committedDate": "2020-12-10T17:39:43Z", "message": "HDFS-15711. Add Metrics to HttpFS Server."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfa6bc9c1f4eb77a2cdcc91810b2e1b5526c4514", "author": {"user": {"login": "amahussein", "name": "Ahmed Hussein"}}, "url": "https://github.com/apache/hadoop/commit/dfa6bc9c1f4eb77a2cdcc91810b2e1b5526c4514", "committedDate": "2020-12-10T17:39:43Z", "message": "HDFS-15711. code reviews."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "989b16ee779551734e36dabc8ea787218d5565df", "author": {"user": {"login": "amahussein", "name": "Ahmed Hussein"}}, "url": "https://github.com/apache/hadoop/commit/989b16ee779551734e36dabc8ea787218d5565df", "committedDate": "2020-12-10T17:39:43Z", "message": "HDFS-15711. fix mkdir ops getter."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b833540d47457d02c831a9f2dacdea0e60423fbf", "author": {"user": {"login": "amahussein", "name": "Ahmed Hussein"}}, "url": "https://github.com/apache/hadoop/commit/b833540d47457d02c831a9f2dacdea0e60423fbf", "committedDate": "2020-12-09T00:16:10Z", "message": "HDFS-15711. code reviews."}, "afterCommit": {"oid": "989b16ee779551734e36dabc8ea787218d5565df", "author": {"user": {"login": "amahussein", "name": "Ahmed Hussein"}}, "url": "https://github.com/apache/hadoop/commit/989b16ee779551734e36dabc8ea787218d5565df", "committedDate": "2020-12-10T17:39:43Z", "message": "HDFS-15711. fix mkdir ops getter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NTE2Njg0", "url": "https://github.com/apache/hadoop/pull/2521#pullrequestreview-549516684", "createdAt": "2020-12-10T19:08:17Z", "commit": {"oid": "989b16ee779551734e36dabc8ea787218d5565df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3379, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}