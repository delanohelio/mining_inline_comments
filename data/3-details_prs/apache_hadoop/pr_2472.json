{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzMDgzMTQy", "number": 2472, "title": "HDFS-15689. allow/disallowSnapshot on EZ roots shouldn't fail due to trash provisioning/emptiness check", "bodyText": "https://issues.apache.org/jira/browse/HDFS-15689\nSee the jira description for details.\nWill add UT in TestDFSAdmin later. Maybe also in TestEncryptionZones.", "createdAt": "2020-11-18T10:32:04Z", "url": "https://github.com/apache/hadoop/pull/2472", "merged": true, "mergeCommit": {"oid": "235947e282261716353e52bb7e4d393c5aad7561"}, "closed": true, "closedAt": "2020-11-25T19:01:05Z", "author": {"login": "smengcl"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddrjzmAH2gAyNTIzMDgzMTQyOjZmMjY0NjgxYTQ1YjEwZjRhZDFmMGZjYTFjMjNlNTU2ODg3MmQzNWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf3ipzgFqTUzODE2Nzk0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6f264681a45b10f4ad1f0fca1c23e5568872d35a", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/hadoop/commit/6f264681a45b10f4ad1f0fca1c23e5568872d35a", "committedDate": "2020-11-18T10:26:04Z", "message": "HDFS-15689. allow/disallowSnapshot on EZ roots shouldn't fail due to trash provisioning/emptiness check\n\nChange-Id: Ic4bbdfad7aa4cb07082dc8b6ba1c50caa2769360"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f03391493b7b98b0e8f335500a0160ac5bbc306", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/hadoop/commit/2f03391493b7b98b0e8f335500a0160ac5bbc306", "committedDate": "2020-11-18T10:45:22Z", "message": "Add UT.\n\nChange-Id: Ib5ab219f384d4886cc5654216073a34ef1b14dfe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMzc4NDY5", "url": "https://github.com/apache/hadoop/pull/2472#pullrequestreview-533378469", "createdAt": "2020-11-18T12:05:17Z", "commit": {"oid": "2f03391493b7b98b0e8f335500a0160ac5bbc306"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMjowNToxN1rOH1qp5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMjowNToxN1rOH1qp5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzNTQyOA==", "bodyText": "I think there are 2 approaches instead of just ignoring the FileAlreadyExists exception:\n\nwe can just validate whether the existing Trash path is a directory and validate the permissions and not throw FileAlreadyExists exception itself in DistributedFileSystem.java#provisionSnapshotTrash\nIf the trash path already exists with right permissions, we can check if the path is an encryption zone as well and throw FileAlreadyExists exception only if its not an encryption zone. Similar change will be required for making an snapshottable dir an encryption zone.\n\nI am ok with either of the above approaches. I think just ignoring the exception here will not work in case. the existing path is not a directory or has right permissions.", "url": "https://github.com/apache/hadoop/pull/2472#discussion_r526035428", "createdAt": "2020-11-18T12:05:17Z", "author": {"login": "bshashikant"}, "path": "hadoop-hdfs-project/hadoop-hdfs-client/src/main/java/org/apache/hadoop/hdfs/client/HdfsAdmin.java", "diffHunk": "@@ -171,7 +174,15 @@ public void clearQuotaByStorageType(Path src, StorageType type) throws IOExcepti\n   public void allowSnapshot(Path path) throws IOException {\n     dfs.allowSnapshot(path);\n     if (dfs.isSnapshotTrashRootEnabled()) {\n-      dfs.provisionSnapshotTrash(path, TRASH_PERMISSION);\n+      try {\n+        dfs.provisionSnapshotTrash(path, TRASH_PERMISSION);\n+      } catch (FileAlreadyExistsException ex) {\n+        // Don't throw on FileAlreadyExistsException since it is likely due to\n+        // admin allowing snapshot on an EZ root.\n+        LOG.warn(ex.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f03391493b7b98b0e8f335500a0160ac5bbc306"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6996910eb0c1b8f66a543ab79234517ea7a06f45", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/hadoop/commit/6996910eb0c1b8f66a543ab79234517ea7a06f45", "committedDate": "2020-11-23T11:29:59Z", "message": "Don't throw if trash dir exists and permission matches.\n\nChange-Id: I03ec3bcc547be656b5d568853d477ee433c51978"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a07d917d574004adabe9cde9156aed40285626ef", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/hadoop/commit/a07d917d574004adabe9cde9156aed40285626ef", "committedDate": "2020-11-23T19:09:37Z", "message": "Fix NPE in DFSClient#isEZRoot\n\nChange-Id: I11fb879dbf9a18bef286a1995506916dfd4fca60"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MTY3OTQ0", "url": "https://github.com/apache/hadoop/pull/2472#pullrequestreview-538167944", "createdAt": "2020-11-25T05:31:31Z", "commit": {"oid": "a07d917d574004adabe9cde9156aed40285626ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3277, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}