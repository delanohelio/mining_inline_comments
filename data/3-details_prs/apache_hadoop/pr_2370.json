{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwMDgzMjQ3", "number": 2370, "title": "HDFS-15614. Initialize snapshot trash root during NameNode startup if enabled", "bodyText": "https://issues.apache.org/jira/browse/HDFS-15614\nAdded checkAndProvisionSnapshotTrashRoots in FSNamesystem. Triggered in NameNode on startup if dfs.namenode.snapshot.trashroot.enabled set to true.\nUT added in TestDistributedFileSystem.\nThe logic is ready for review.\nI am considering adding another UT for HA case. Now that we put the check in startActiveServices() it shouldn't be a problem anymore. Thanks @bshashikant for the suggestion.", "createdAt": "2020-10-08T17:40:03Z", "url": "https://github.com/apache/hadoop/pull/2370", "merged": true, "mergeCommit": {"oid": "a308a1ec22befa919ad8b6509f1b8c888c80f350"}, "closed": true, "closedAt": "2020-10-13T17:59:42Z", "author": {"login": "smengcl"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQlI9lAH2gAyNTAwMDgzMjQ3OmRjZTU3NTIwNjhhMzI3Yjg2ZTI4YzhjZjFjNjQyNjkxZjk1ZDY3NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSK4OSAH2gAyNTAwMDgzMjQ3OmJlYTBjMTU2ZTY0MDQ3MDAyZDJiNDUxOTQ4MjUxNDk1MTRkNDBjODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dce5752068a327b86e28c8cf1c642691f95d6741", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/hadoop/commit/dce5752068a327b86e28c8cf1c642691f95d6741", "committedDate": "2020-10-08T17:36:18Z", "message": "Add checkAndProvisionSnapshotTrashRoots in FSNamesystem.\nAdd UT.\n\nChange-Id: If679da69024056697bf633094a359530bffc74d3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MDIwNTg0", "url": "https://github.com/apache/hadoop/pull/2370#pullrequestreview-505020584", "createdAt": "2020-10-08T17:43:47Z", "commit": {"oid": "dce5752068a327b86e28c8cf1c642691f95d6741"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNzo0Mzo0N1rOHepjGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNzo0Mzo0N1rOHepjGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkwMDA1Ng==", "bodyText": "I am not 100% sure about this condition check. Any suggestions/confirmations?\nThe goal is to only let Active NN to check and provision snapshot trash roots. The assumption is that the mkdirs() call below propagates the write to standby NameNode.", "url": "https://github.com/apache/hadoop/pull/2370#discussion_r501900056", "createdAt": "2020-10-08T17:43:47Z", "author": {"login": "smengcl"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java", "diffHunk": "@@ -8524,6 +8530,39 @@ void checkAccess(String src, FsAction mode) throws IOException {\n     logAuditEvent(true, operationName, src);\n   }\n \n+  /**\n+   * Check if snapshot roots are created for all existing snapshottable\n+   * directories. Create them if not.\n+   */\n+  void checkAndProvisionSnapshotTrashRoots() throws IOException {\n+    if (haEnabled) {\n+      if (!inActiveState()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dce5752068a327b86e28c8cf1c642691f95d6741"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NTQ3MDg3", "url": "https://github.com/apache/hadoop/pull/2370#pullrequestreview-505547087", "createdAt": "2020-10-09T10:22:12Z", "commit": {"oid": "dce5752068a327b86e28c8cf1c642691f95d6741"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMDoyMjoxMlrOHfD95Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMDoyNTo1MlrOHfEEsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzMjkwMQ==", "bodyText": "getIsSnapshotTrashRootEnabled --> isSnapshotTrashRootEnabled??", "url": "https://github.com/apache/hadoop/pull/2370#discussion_r502332901", "createdAt": "2020-10-09T10:22:12Z", "author": {"login": "bshashikant"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java", "diffHunk": "@@ -2031,6 +2033,10 @@ private String metaSaveAsString() {\n     return sw.toString();\n   }\n \n+  public boolean getIsSnapshotTrashRootEnabled() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dce5752068a327b86e28c8cf1c642691f95d6741"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMzNDY0Mw==", "bodyText": "how about doing this here:\n @Override\n    public void startActiveServices() throws IOException {\n      try {\n        namesystem.startActiveServices();\n        startTrashEmptier(getConf());\n      } catch (Throwable t) {\n        doImmediateShutdown(t);\n      }\n    }\n\njust before starting the trashEmptier thread. We don't need to check for Active or standby state here as these should be called in only Active NameNode.", "url": "https://github.com/apache/hadoop/pull/2370#discussion_r502334643", "createdAt": "2020-10-09T10:25:52Z", "author": {"login": "bshashikant"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/NameNode.java", "diffHunk": "@@ -781,6 +781,10 @@ protected void initialize(Configuration conf) throws IOException {\n       }\n     }\n \n+    if (namesystem.getIsSnapshotTrashRootEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dce5752068a327b86e28c8cf1c642691f95d6741"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78c9621978c83a9484eae3c54c18121480aa988f", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/hadoop/commit/78c9621978c83a9484eae3c54c18121480aa988f", "committedDate": "2020-10-12T17:01:39Z", "message": "Move check to startActiveServices;\nremove redundant getIsSnapshotTrashRootEnabled method.\n\nChange-Id: Ic9293e36907ee88ab2bf17855a8927e4e6c4c949"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a66b25308975eb1eca621526879d3cf53467691", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/hadoop/commit/8a66b25308975eb1eca621526879d3cf53467691", "committedDate": "2020-10-12T17:06:53Z", "message": "Checkstyle.\n\nChange-Id: Ibd167312dd6a2db5f90e15fe6b01300274770867"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MjE3OTY2", "url": "https://github.com/apache/hadoop/pull/2370#pullrequestreview-507217966", "createdAt": "2020-10-13T09:00:06Z", "commit": {"oid": "8a66b25308975eb1eca621526879d3cf53467691"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be0a2825b419f502083a8999b9acdf9b315b00c0", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/hadoop/commit/be0a2825b419f502083a8999b9acdf9b315b00c0", "committedDate": "2020-10-13T14:15:24Z", "message": "Retrigger checks\n\nChange-Id: Ib761a58fec35f8f967e008268a020db28effbc8f"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bea0c156e64047002d2b45194825149514d40c87", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/hadoop/commit/bea0c156e64047002d2b45194825149514d40c87", "committedDate": "2020-10-13T16:08:20Z", "message": "Merge branch 'trunk' into HDFS-15614"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3441, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}