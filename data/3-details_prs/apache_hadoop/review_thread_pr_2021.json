{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NTA5Nzk3", "number": 2021, "reviewThreads": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODoxODo0OVrOD8LudA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODoxNDo0NVrOD8xrKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDMzMjY4OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/DateTimeUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODoxODo0OVrOGU98og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODoyMzoxOFrOGVRSBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzOTY1MA==", "bodyText": "I think private is enough here.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424639650", "createdAt": "2020-05-13T18:18:49Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/DateTimeUtils.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class DateTimeUtils {\n+  public static final Logger LOG = LoggerFactory.getLogger(DateTimeUtils.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1NjQyMw==", "bodyText": "Done", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424956423", "createdAt": "2020-05-14T08:23:18Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/DateTimeUtils.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class DateTimeUtils {\n+  public static final Logger LOG = LoggerFactory.getLogger(DateTimeUtils.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzOTY1MA=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDM0NTA2OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/DateTimeUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODoyMjoxM1rOGU-Elg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODoyMzoyNlrOGVRSYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0MTY4Ng==", "bodyText": "This line exceeds checkstyle limit of 80 chars", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424641686", "createdAt": "2020-05-13T18:22:13Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/DateTimeUtils.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class DateTimeUtils {\n+  public static final Logger LOG = LoggerFactory.getLogger(DateTimeUtils.class);\n+  private static final String DATE_TIME_PATTERN = \"E, dd MMM yyyy HH:mm:ss z\";\n+\n+  public static long parseLastModifiedTime(final String lastModifiedTime) {\n+    long parsedTime = 0;\n+    try {\n+      Date utcDate = new SimpleDateFormat(DATE_TIME_PATTERN, Locale.US).parse(lastModifiedTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1NjUxNA==", "bodyText": "Fixed", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424956514", "createdAt": "2020-05-14T08:23:26Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/DateTimeUtils.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class DateTimeUtils {\n+  public static final Logger LOG = LoggerFactory.getLogger(DateTimeUtils.class);\n+  private static final String DATE_TIME_PATTERN = \"E, dd MMM yyyy HH:mm:ss z\";\n+\n+  public static long parseLastModifiedTime(final String lastModifiedTime) {\n+    long parsedTime = 0;\n+    try {\n+      Date utcDate = new SimpleDateFormat(DATE_TIME_PATTERN, Locale.US).parse(lastModifiedTime);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0MTY4Ng=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDM1NzI1OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODoyNToyMVrOGU-MOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODoyMzozMlrOGVRSog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0MzY0MA==", "bodyText": "Import order", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424643640", "createdAt": "2020-05-13T18:25:21Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -28,20 +28,36 @@\n \n import org.junit.Test;\n \n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsHttpOperation;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsPerfTracker;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation;\n+import org.apache.hadoop.fs.azurebfs.services.ExponentialRetryPolicy;\n+import org.apache.hadoop.fs.azurebfs.services.SharedKeyCredentials;\n import org.apache.hadoop.fs.FileAlreadyExistsException;\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.Path;\n \n+import static java.net.HttpURLConnection.HTTP_NOT_FOUND;\n+import static java.net.HttpURLConnection.HTTP_OK;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.DOT;\n+import static org.apache.hadoop.fs.azurebfs.constants.FileSystemConfigurations.DEFAULT_DELETE_CONSIDERED_IDEMPOTENT;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertDeleted;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertPathDoesNotExist;\n import static org.apache.hadoop.test.LambdaTestUtils.intercept;\n+import static org.mockito.Mockito.mock;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1NjU3OA==", "bodyText": "Fixed", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424956578", "createdAt": "2020-05-14T08:23:32Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -28,20 +28,36 @@\n \n import org.junit.Test;\n \n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsHttpOperation;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsPerfTracker;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation;\n+import org.apache.hadoop.fs.azurebfs.services.ExponentialRetryPolicy;\n+import org.apache.hadoop.fs.azurebfs.services.SharedKeyCredentials;\n import org.apache.hadoop.fs.FileAlreadyExistsException;\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.Path;\n \n+import static java.net.HttpURLConnection.HTTP_NOT_FOUND;\n+import static java.net.HttpURLConnection.HTTP_OK;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.DOT;\n+import static org.apache.hadoop.fs.azurebfs.constants.FileSystemConfigurations.DEFAULT_DELETE_CONSIDERED_IDEMPOTENT;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertDeleted;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertPathDoesNotExist;\n import static org.apache.hadoop.test.LambdaTestUtils.intercept;\n+import static org.mockito.Mockito.mock;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0MzY0MA=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDM2Mzc4OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystemStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODoyNzowNlrOGU-QYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODoyMzo0MFrOGVRS5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0NDcwNQ==", "bodyText": "CheckStyle: I think this line exceeds 80 chars limit", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424644705", "createdAt": "2020-05-13T18:27:06Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystemStore.java", "diffHunk": "@@ -748,7 +747,7 @@ public FileStatus getFileStatus(final Path path) throws IOException {\n           long contentLength = entry.contentLength() == null ? 0 : entry.contentLength();\n           boolean isDirectory = entry.isDirectory() == null ? false : entry.isDirectory();\n           if (entry.lastModified() != null && !entry.lastModified().isEmpty()) {\n-            lastModifiedMillis = parseLastModifiedTime(entry.lastModified());\n+            lastModifiedMillis = DateTimeUtils.parseLastModifiedTime(entry.lastModified());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1NjY0Nw==", "bodyText": "Fixed", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424956647", "createdAt": "2020-05-14T08:23:40Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystemStore.java", "diffHunk": "@@ -748,7 +747,7 @@ public FileStatus getFileStatus(final Path path) throws IOException {\n           long contentLength = entry.contentLength() == null ? 0 : entry.contentLength();\n           boolean isDirectory = entry.isDirectory() == null ? false : entry.isDirectory();\n           if (entry.lastModified() != null && !entry.lastModified().isEmpty()) {\n-            lastModifiedMillis = parseLastModifiedTime(entry.lastModified());\n+            lastModifiedMillis = DateTimeUtils.parseLastModifiedTime(entry.lastModified());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0NDcwNQ=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDQ0MjU4OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClient.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODo0ODozOFrOGU_CBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzo0ODoyMVrOGV6JOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1NzQxNQ==", "bodyText": "Would it be better to move the idempotency related methods to a separate Utility/Helper class?", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424657415", "createdAt": "2020-05-13T18:48:38Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClient.java", "diffHunk": "@@ -321,9 +324,81 @@ public AbfsRestOperation renamePath(String source, final String destination, fin\n             url,\n             requestHeaders);\n     op.execute();\n+\n+    if (op.getResult().getStatusCode() != HttpURLConnection.HTTP_OK) {\n+      return renameIdempotencyCheckOp(op, destination);\n+    }\n+\n     return op;\n   }\n \n+  /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1NzY0OQ==", "bodyText": "The changes are not utility related and are insync with the handling of the ABFS response. The reason they were included as separate methods was to enable mock testing which was otherwise not possible. Retaining the change as such.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424957649", "createdAt": "2020-05-14T08:25:14Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClient.java", "diffHunk": "@@ -321,9 +324,81 @@ public AbfsRestOperation renamePath(String source, final String destination, fin\n             url,\n             requestHeaders);\n     op.execute();\n+\n+    if (op.getResult().getStatusCode() != HttpURLConnection.HTTP_OK) {\n+      return renameIdempotencyCheckOp(op, destination);\n+    }\n+\n     return op;\n   }\n \n+  /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1NzQxNQ=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMxNzQ0Nw==", "bodyText": "One option is restrict the method accessibility tp package level and use @VisibleForTesting annotation. Keeping a method public solely for testing doesn't look good practice.\nAlso the idea is, If you have methods 'assisting', chances are the class is actually doing too much. Moving these methods into separate classes with public interfaces keeps the class with the assisting methods responsible for one thing and one thing only (see Single Responsibility Principle). This move into separte classes automatically makes for a testable structure as your methods must be made public\nhttps://softwareengineering.stackexchange.com/questions/274937/is-it-bad-practice-to-make-methods-public-solely-for-the-sake-of-unit-testing", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425317447", "createdAt": "2020-05-14T17:40:45Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClient.java", "diffHunk": "@@ -321,9 +324,81 @@ public AbfsRestOperation renamePath(String source, final String destination, fin\n             url,\n             requestHeaders);\n     op.execute();\n+\n+    if (op.getResult().getStatusCode() != HttpURLConnection.HTTP_OK) {\n+      return renameIdempotencyCheckOp(op, destination);\n+    }\n+\n     return op;\n   }\n \n+  /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1NzQxNQ=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYyNTkxNA==", "bodyText": "AbfsClient class handles triggering of requests to Store backend and returning the AbfsRestOperation back. For Rename and Delete, the response to return is not determined if request was re-tried by the idempotent logic. It will be not right to consider these methods as \"assisting\" or providing a utility service and are part of the actual flow.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425625914", "createdAt": "2020-05-15T07:48:21Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClient.java", "diffHunk": "@@ -321,9 +324,81 @@ public AbfsRestOperation renamePath(String source, final String destination, fin\n             url,\n             requestHeaders);\n     op.execute();\n+\n+    if (op.getResult().getStatusCode() != HttpURLConnection.HTTP_OK) {\n+      return renameIdempotencyCheckOp(op, destination);\n+    }\n+\n     return op;\n   }\n \n+  /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1NzQxNQ=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDQ1MzUzOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/FileSystemConfigurations.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODo1MToyNlrOGU_Itw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMzoyNjozNlrOGV1PdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1OTEyNw==", "bodyText": "Does it convey the right meaning by keeping DEFAULT prefix(as the same is not a configurable flag)?", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424659127", "createdAt": "2020-05-13T18:51:26Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/FileSystemConfigurations.java", "diffHunk": "@@ -81,5 +81,7 @@\n   public static final String DEFAULT_FS_AZURE_USER_AGENT_PREFIX = EMPTY_STRING;\n   public static final String DEFAULT_VALUE_UNKNOWN = \"UNKNOWN\";\n \n+  public static final boolean DEFAULT_DELETE_CONSIDERED_IDEMPOTENT = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1ODc5OQ==", "bodyText": "DEFAULT prefix is to highlight the default behaviour of these fields in ABFS driver. There do not mandate the need to be backed by user modifiable config in AbfsConfiguration. AbfsConfiguration is the consumer of these defaults.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424958799", "createdAt": "2020-05-14T08:27:07Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/FileSystemConfigurations.java", "diffHunk": "@@ -81,5 +81,7 @@\n   public static final String DEFAULT_FS_AZURE_USER_AGENT_PREFIX = EMPTY_STRING;\n   public static final String DEFAULT_VALUE_UNKNOWN = \"UNKNOWN\";\n \n+  public static final boolean DEFAULT_DELETE_CONSIDERED_IDEMPOTENT = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1OTEyNw=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMyOTkyNA==", "bodyText": "As you said keeping the DEFAULT prefix to highlight the default behaviour it is assumed that there are non default behaviours associated with this feature, are there any?", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425329924", "createdAt": "2020-05-14T17:59:20Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/FileSystemConfigurations.java", "diffHunk": "@@ -81,5 +81,7 @@\n   public static final String DEFAULT_FS_AZURE_USER_AGENT_PREFIX = EMPTY_STRING;\n   public static final String DEFAULT_VALUE_UNKNOWN = \"UNKNOWN\";\n \n+  public static final boolean DEFAULT_DELETE_CONSIDERED_IDEMPOTENT = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1OTEyNw=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0NTU4OA==", "bodyText": "Definition of defaults need not be confused with what should be given an option to override using core-site configs.\nThe behaviour of delete idempotency is being defined by default now, and the non default behaviour (where handling is absent) would be its not idempotent.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425545588", "createdAt": "2020-05-15T03:26:36Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/FileSystemConfigurations.java", "diffHunk": "@@ -81,5 +81,7 @@\n   public static final String DEFAULT_FS_AZURE_USER_AGENT_PREFIX = EMPTY_STRING;\n   public static final String DEFAULT_VALUE_UNKNOWN = \"UNKNOWN\";\n \n+  public static final boolean DEFAULT_DELETE_CONSIDERED_IDEMPOTENT = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1OTEyNw=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDQ3MzMyOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODo1Njo1NlrOGU_VoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODoyNzoxNFrOGVRblg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2MjQzMg==", "bodyText": "Better to declare constant as static", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424662432", "createdAt": "2020-05-13T18:56:56Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -28,20 +28,36 @@\n \n import org.junit.Test;\n \n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsHttpOperation;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsPerfTracker;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation;\n+import org.apache.hadoop.fs.azurebfs.services.ExponentialRetryPolicy;\n+import org.apache.hadoop.fs.azurebfs.services.SharedKeyCredentials;\n import org.apache.hadoop.fs.FileAlreadyExistsException;\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.Path;\n \n+import static java.net.HttpURLConnection.HTTP_NOT_FOUND;\n+import static java.net.HttpURLConnection.HTTP_OK;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.DOT;\n+import static org.apache.hadoop.fs.azurebfs.constants.FileSystemConfigurations.DEFAULT_DELETE_CONSIDERED_IDEMPOTENT;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertDeleted;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertPathDoesNotExist;\n import static org.apache.hadoop.test.LambdaTestUtils.intercept;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n \n /**\n  * Test delete operation.\n  */\n public class ITestAzureBlobFileSystemDelete extends\n     AbstractAbfsIntegrationTest {\n \n+  private final int reducedRetryCount = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1ODg3MA==", "bodyText": "Fixed", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424958870", "createdAt": "2020-05-14T08:27:14Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -28,20 +28,36 @@\n \n import org.junit.Test;\n \n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsHttpOperation;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsPerfTracker;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation;\n+import org.apache.hadoop.fs.azurebfs.services.ExponentialRetryPolicy;\n+import org.apache.hadoop.fs.azurebfs.services.SharedKeyCredentials;\n import org.apache.hadoop.fs.FileAlreadyExistsException;\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.Path;\n \n+import static java.net.HttpURLConnection.HTTP_NOT_FOUND;\n+import static java.net.HttpURLConnection.HTTP_OK;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.DOT;\n+import static org.apache.hadoop.fs.azurebfs.constants.FileSystemConfigurations.DEFAULT_DELETE_CONSIDERED_IDEMPOTENT;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertDeleted;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertPathDoesNotExist;\n import static org.apache.hadoop.test.LambdaTestUtils.intercept;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n \n /**\n  * Test delete operation.\n  */\n public class ITestAzureBlobFileSystemDelete extends\n     AbstractAbfsIntegrationTest {\n \n+  private final int reducedRetryCount = 1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2MjQzMg=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDQ4NTYxOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTowMDozMVrOGU_ddg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODoyNzoxOVrOGVRbyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2NDQzOA==", "bodyText": "Try to use the better alternative assertJ.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424664438", "createdAt": "2020-05-13T19:00:31Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -130,4 +146,49 @@ public Void call() throws Exception {\n     assertPathDoesNotExist(fs, \"deleted\", dir);\n \n   }\n+\n+  @Test\n+  public void testDeleteIdempotency() throws Exception {\n+    org.junit.Assume.assumeTrue(DEFAULT_DELETE_CONSIDERED_IDEMPOTENT);\n+    // Config to reduce the retry and maxBackoff time for test run\n+    AbfsConfiguration abfsConfig = getConfiguration();\n+    abfsConfig.setMaxIoRetries(reducedRetryCount);\n+    abfsConfig.setMaxBackoffIntervalMilliseconds(reducedMaxBackoffIntervalMs);\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    AbfsClient abfsClient = fs.getAbfsStore().getClient();\n+    AbfsPerfTracker tracker = new AbfsPerfTracker(\"test\",\n+        this.getAccountName(),\n+        abfsConfig);\n+\n+    // Create test AbfsClient\n+    AbfsClient testClient = new AbfsClient(\n+        abfsClient.getBaseUrl(),\n+        new SharedKeyCredentials(abfsConfig.getAccountName().substring(0,\n+            abfsConfig.getAccountName().indexOf(DOT)),\n+            abfsConfig.getStorageAccountKey()),\n+        abfsConfig,\n+        new ExponentialRetryPolicy(reducedRetryCount),\n+        abfsConfig.getTokenProvider(),\n+        tracker);\n+\n+    // Mock instance of AbfsRestOperation\n+    AbfsRestOperation op = mock(AbfsRestOperation.class);\n+    // Set retryCount to non-zero\n+    when(op.getRetryCount()).thenReturn(reducedRetryCount);\n+\n+    // Mock instance of Http Operation response. This will return HTTP:Not Found\n+    AbfsHttpOperation http404Op = mock(AbfsHttpOperation.class);\n+    when(http404Op.getStatusCode()).thenReturn(HTTP_NOT_FOUND);\n+\n+    // Mock delete response to 404\n+    when(op.getResult()).thenReturn(http404Op);\n+\n+    assertTrue(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1ODkyMQ==", "bodyText": "Fixed", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424958921", "createdAt": "2020-05-14T08:27:19Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -130,4 +146,49 @@ public Void call() throws Exception {\n     assertPathDoesNotExist(fs, \"deleted\", dir);\n \n   }\n+\n+  @Test\n+  public void testDeleteIdempotency() throws Exception {\n+    org.junit.Assume.assumeTrue(DEFAULT_DELETE_CONSIDERED_IDEMPOTENT);\n+    // Config to reduce the retry and maxBackoff time for test run\n+    AbfsConfiguration abfsConfig = getConfiguration();\n+    abfsConfig.setMaxIoRetries(reducedRetryCount);\n+    abfsConfig.setMaxBackoffIntervalMilliseconds(reducedMaxBackoffIntervalMs);\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    AbfsClient abfsClient = fs.getAbfsStore().getClient();\n+    AbfsPerfTracker tracker = new AbfsPerfTracker(\"test\",\n+        this.getAccountName(),\n+        abfsConfig);\n+\n+    // Create test AbfsClient\n+    AbfsClient testClient = new AbfsClient(\n+        abfsClient.getBaseUrl(),\n+        new SharedKeyCredentials(abfsConfig.getAccountName().substring(0,\n+            abfsConfig.getAccountName().indexOf(DOT)),\n+            abfsConfig.getStorageAccountKey()),\n+        abfsConfig,\n+        new ExponentialRetryPolicy(reducedRetryCount),\n+        abfsConfig.getTokenProvider(),\n+        tracker);\n+\n+    // Mock instance of AbfsRestOperation\n+    AbfsRestOperation op = mock(AbfsRestOperation.class);\n+    // Set retryCount to non-zero\n+    when(op.getRetryCount()).thenReturn(reducedRetryCount);\n+\n+    // Mock instance of Http Operation response. This will return HTTP:Not Found\n+    AbfsHttpOperation http404Op = mock(AbfsHttpOperation.class);\n+    when(http404Op.getStatusCode()).thenReturn(HTTP_NOT_FOUND);\n+\n+    // Mock delete response to 404\n+    when(op.getResult()).thenReturn(http404Op);\n+\n+    assertTrue(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2NDQzOA=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDQ4NzkwOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemRename.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTowMTowN1rOGU_e0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODoyNzoyN1rOGVRcGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2NDc4NQ==", "bodyText": "Import order", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424664785", "createdAt": "2020-05-13T19:01:07Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemRename.java", "diffHunk": "@@ -28,20 +28,37 @@\n import org.junit.Assert;\n import org.junit.Test;\n \n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsHttpOperation;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsPerfTracker;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation;\n+import org.apache.hadoop.fs.azurebfs.services.ExponentialRetryPolicy;\n+import org.apache.hadoop.fs.azurebfs.services.SharedKeyCredentials;\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.Path;\n \n+import static java.util.UUID.randomUUID;\n+import static java.net.HttpURLConnection.HTTP_BAD_REQUEST;\n+import static java.net.HttpURLConnection.HTTP_NOT_FOUND;\n+import static java.net.HttpURLConnection.HTTP_OK;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.DOT;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertMkdirs;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertPathDoesNotExist;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertRenameOutcome;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertIsFile;\n+import static org.mockito.Mockito.mock;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1OTAwMA==", "bodyText": "Fixed", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424959000", "createdAt": "2020-05-14T08:27:27Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemRename.java", "diffHunk": "@@ -28,20 +28,37 @@\n import org.junit.Assert;\n import org.junit.Test;\n \n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsHttpOperation;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsPerfTracker;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation;\n+import org.apache.hadoop.fs.azurebfs.services.ExponentialRetryPolicy;\n+import org.apache.hadoop.fs.azurebfs.services.SharedKeyCredentials;\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.Path;\n \n+import static java.util.UUID.randomUUID;\n+import static java.net.HttpURLConnection.HTTP_BAD_REQUEST;\n+import static java.net.HttpURLConnection.HTTP_NOT_FOUND;\n+import static java.net.HttpURLConnection.HTTP_OK;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.DOT;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertMkdirs;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertPathDoesNotExist;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertRenameOutcome;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertIsFile;\n+import static org.mockito.Mockito.mock;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2NDc4NQ=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDQ4OTE0OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemRename.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTowMTozMFrOGU_foA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODoyNzozM1rOGVRcVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2NDk5Mg==", "bodyText": "Better to keep constants as static", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424664992", "createdAt": "2020-05-13T19:01:30Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemRename.java", "diffHunk": "@@ -28,20 +28,37 @@\n import org.junit.Assert;\n import org.junit.Test;\n \n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsHttpOperation;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsPerfTracker;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation;\n+import org.apache.hadoop.fs.azurebfs.services.ExponentialRetryPolicy;\n+import org.apache.hadoop.fs.azurebfs.services.SharedKeyCredentials;\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.Path;\n \n+import static java.util.UUID.randomUUID;\n+import static java.net.HttpURLConnection.HTTP_BAD_REQUEST;\n+import static java.net.HttpURLConnection.HTTP_NOT_FOUND;\n+import static java.net.HttpURLConnection.HTTP_OK;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.DOT;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertMkdirs;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertPathDoesNotExist;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertRenameOutcome;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertIsFile;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n \n /**\n  * Test rename operation.\n  */\n public class ITestAzureBlobFileSystemRename extends\n     AbstractAbfsIntegrationTest {\n \n+  private final int reducedRetryCount = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1OTA2Mg==", "bodyText": "Fixed", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424959062", "createdAt": "2020-05-14T08:27:33Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemRename.java", "diffHunk": "@@ -28,20 +28,37 @@\n import org.junit.Assert;\n import org.junit.Test;\n \n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsHttpOperation;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsPerfTracker;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation;\n+import org.apache.hadoop.fs.azurebfs.services.ExponentialRetryPolicy;\n+import org.apache.hadoop.fs.azurebfs.services.SharedKeyCredentials;\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.Path;\n \n+import static java.util.UUID.randomUUID;\n+import static java.net.HttpURLConnection.HTTP_BAD_REQUEST;\n+import static java.net.HttpURLConnection.HTTP_NOT_FOUND;\n+import static java.net.HttpURLConnection.HTTP_OK;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.DOT;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertMkdirs;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertPathDoesNotExist;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertRenameOutcome;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertIsFile;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n \n /**\n  * Test rename operation.\n  */\n public class ITestAzureBlobFileSystemRename extends\n     AbstractAbfsIntegrationTest {\n \n+  private final int reducedRetryCount = 1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2NDk5Mg=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDUzMzAxOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemRename.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOToxNDozNVrOGU_7kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzo1MTo0NFrOGV6PuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY3MjE0NA==", "bodyText": "Couldn't find it reasonable to keep all the cases into the same method with if-else. I think separating the same could improve readability of the test cases.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424672144", "createdAt": "2020-05-13T19:14:35Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemRename.java", "diffHunk": "@@ -149,4 +166,135 @@ public void testPosixRenameDirectory() throws Exception {\n     assertTrue(fs.exists(new Path(\"testDir2/test4/test3\")));\n     assertFalse(fs.exists(new Path(\"testDir2/test1/test2/test3\")));\n   }\n+\n+  @Test\n+  public void testRenameRetryFailureAsHTTP400() throws Exception {\n+    // Rename failed as Bad Request\n+    // RenameIdempotencyCheck should throw back the rename failure Op\n+    testRenameTimeout(HTTP_BAD_REQUEST, HTTP_BAD_REQUEST, false);\n+  }\n+\n+  @Test\n+  public void testRenameRetryFailureAsHTTP404() throws Exception {\n+    // Rename failed as FileNotFound and the destination LMT is\n+    // within TimespanForIdentifyingRecentOperationThroughLMT\n+    testRenameTimeout(HTTP_NOT_FOUND, HTTP_OK, false);\n+  }\n+\n+  @Test\n+  public void testRenameRetryFailureWithDestOldLMT() throws Exception {\n+    // Rename failed as FileNotFound and the destination LMT is\n+    // older than TimespanForIdentifyingRecentOperationThroughLMT\n+    testRenameTimeout(HTTP_NOT_FOUND, HTTP_NOT_FOUND, true);\n+  }\n+\n+  private void testRenameTimeout(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk2MDMyNg==", "bodyText": "Over the past PRs we have had several instances of reusable code being duplicated. These test cases share a lot of reusable code, hence the reusable code is put into a method. Have made some minor updates which might help improve readability.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424960326", "createdAt": "2020-05-14T08:29:33Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemRename.java", "diffHunk": "@@ -149,4 +166,135 @@ public void testPosixRenameDirectory() throws Exception {\n     assertTrue(fs.exists(new Path(\"testDir2/test4/test3\")));\n     assertFalse(fs.exists(new Path(\"testDir2/test1/test2/test3\")));\n   }\n+\n+  @Test\n+  public void testRenameRetryFailureAsHTTP400() throws Exception {\n+    // Rename failed as Bad Request\n+    // RenameIdempotencyCheck should throw back the rename failure Op\n+    testRenameTimeout(HTTP_BAD_REQUEST, HTTP_BAD_REQUEST, false);\n+  }\n+\n+  @Test\n+  public void testRenameRetryFailureAsHTTP404() throws Exception {\n+    // Rename failed as FileNotFound and the destination LMT is\n+    // within TimespanForIdentifyingRecentOperationThroughLMT\n+    testRenameTimeout(HTTP_NOT_FOUND, HTTP_OK, false);\n+  }\n+\n+  @Test\n+  public void testRenameRetryFailureWithDestOldLMT() throws Exception {\n+    // Rename failed as FileNotFound and the destination LMT is\n+    // older than TimespanForIdentifyingRecentOperationThroughLMT\n+    testRenameTimeout(HTTP_NOT_FOUND, HTTP_NOT_FOUND, true);\n+  }\n+\n+  private void testRenameTimeout(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY3MjE0NA=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0Mzg0MA==", "bodyText": "I see common code as (1. Creating FS instance, 2. Creating testClient instance, 3. Creating mock AbfsRestOperation  instance, 4. Common assertion). This is clubbed with the non common codes (1. Creating http400Op  instance for one particular test case, 2. Creating http404Op  instance for another particular test case)\nShall we move the common instances that are required to a separate private methods and call those methods in each test case? That would help improve readability and solved the problem of code duplication.\nI think we should relook and address the issues with the old PRs if those are recent, where resusable code is duplicated. Could you please create a workitem for this.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425343840", "createdAt": "2020-05-14T18:23:51Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemRename.java", "diffHunk": "@@ -149,4 +166,135 @@ public void testPosixRenameDirectory() throws Exception {\n     assertTrue(fs.exists(new Path(\"testDir2/test4/test3\")));\n     assertFalse(fs.exists(new Path(\"testDir2/test1/test2/test3\")));\n   }\n+\n+  @Test\n+  public void testRenameRetryFailureAsHTTP400() throws Exception {\n+    // Rename failed as Bad Request\n+    // RenameIdempotencyCheck should throw back the rename failure Op\n+    testRenameTimeout(HTTP_BAD_REQUEST, HTTP_BAD_REQUEST, false);\n+  }\n+\n+  @Test\n+  public void testRenameRetryFailureAsHTTP404() throws Exception {\n+    // Rename failed as FileNotFound and the destination LMT is\n+    // within TimespanForIdentifyingRecentOperationThroughLMT\n+    testRenameTimeout(HTTP_NOT_FOUND, HTTP_OK, false);\n+  }\n+\n+  @Test\n+  public void testRenameRetryFailureWithDestOldLMT() throws Exception {\n+    // Rename failed as FileNotFound and the destination LMT is\n+    // older than TimespanForIdentifyingRecentOperationThroughLMT\n+    testRenameTimeout(HTTP_NOT_FOUND, HTTP_NOT_FOUND, true);\n+  }\n+\n+  private void testRenameTimeout(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY3MjE0NA=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYyNzU3Nw==", "bodyText": "Creating a method, passing over all indiividual mock instances created back to test method will actually render code more unreadable. Will leave this comment open if any other reviewer feels the code is unreadable too.\nFor issues that have come across for my code changes, i have made modifications with the respective PRs. Should definitely keep a look out for any that come across.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425627577", "createdAt": "2020-05-15T07:51:44Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemRename.java", "diffHunk": "@@ -149,4 +166,135 @@ public void testPosixRenameDirectory() throws Exception {\n     assertTrue(fs.exists(new Path(\"testDir2/test4/test3\")));\n     assertFalse(fs.exists(new Path(\"testDir2/test1/test2/test3\")));\n   }\n+\n+  @Test\n+  public void testRenameRetryFailureAsHTTP400() throws Exception {\n+    // Rename failed as Bad Request\n+    // RenameIdempotencyCheck should throw back the rename failure Op\n+    testRenameTimeout(HTTP_BAD_REQUEST, HTTP_BAD_REQUEST, false);\n+  }\n+\n+  @Test\n+  public void testRenameRetryFailureAsHTTP404() throws Exception {\n+    // Rename failed as FileNotFound and the destination LMT is\n+    // within TimespanForIdentifyingRecentOperationThroughLMT\n+    testRenameTimeout(HTTP_NOT_FOUND, HTTP_OK, false);\n+  }\n+\n+  @Test\n+  public void testRenameRetryFailureWithDestOldLMT() throws Exception {\n+    // Rename failed as FileNotFound and the destination LMT is\n+    // older than TimespanForIdentifyingRecentOperationThroughLMT\n+    testRenameTimeout(HTTP_NOT_FOUND, HTTP_NOT_FOUND, true);\n+  }\n+\n+  private void testRenameTimeout(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY3MjE0NA=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDUzNzY2OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOToxNTo1NFrOGU_-hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODozMDozMVrOGVRjxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY3MjkwMA==", "bodyText": "this. prefix?", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424672900", "createdAt": "2020-05-13T19:15:54Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "diffHunk": "@@ -157,7 +175,7 @@ void execute() throws AzureBlobFileSystemException {\n       requestHeaders.add(httpHeader);\n     }\n \n-    int retryCount = 0;\n+    retryCount = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk2MDk2NA==", "bodyText": "this. usage has been advised against many times in previous PRs by Steve to align with diff IDE. Retaining current code.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r424960964", "createdAt": "2020-05-14T08:30:31Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "diffHunk": "@@ -157,7 +175,7 @@ void execute() throws AzureBlobFileSystemException {\n       requestHeaders.add(httpHeader);\n     }\n \n-    int retryCount = 0;\n+    retryCount = 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY3MjkwMA=="}, "originalCommit": {"oid": "77f54cb8323ef8137df430aff3e16caf6ab3497f"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODU3MjkwOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzo1MDoxMlrOGVnvVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODowMjo1OVrOGV6mKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMyNDM3Mw==", "bodyText": "Widening the method accessibility by making it public solely for testing is not a good practice. See if at least the acces can be restricted to package level and use @VisibleForTesting annotation.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425324373", "createdAt": "2020-05-14T17:50:12Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClient.java", "diffHunk": "@@ -131,7 +135,7 @@ public String getFileSystem() {\n     return filesystem;\n   }\n \n-  protected AbfsPerfTracker getAbfsPerfTracker() {\n+  public AbfsPerfTracker getAbfsPerfTracker() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db5c57826fd39894ad88a2ea0628ebbe84b48091"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzMzMyMQ==", "bodyText": "This wont be necessary as test code is refactored.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425633321", "createdAt": "2020-05-15T08:02:59Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsClient.java", "diffHunk": "@@ -131,7 +135,7 @@ public String getFileSystem() {\n     return filesystem;\n   }\n \n-  protected AbfsPerfTracker getAbfsPerfTracker() {\n+  public AbfsPerfTracker getAbfsPerfTracker() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMyNDM3Mw=="}, "originalCommit": {"oid": "db5c57826fd39894ad88a2ea0628ebbe84b48091"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODcyMTcwOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODozMzoxMFrOGVpPzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODowMjowN1rOGV6kdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0OTA3MQ==", "bodyText": "These are not asserJ assertions.\nThat is better alternative, defenitly improved readability. Steve also reccomands the same.\nthe format is assertThat()\n.describedAs(\"describe what assertion is going tobe made and the same is going to be printed in logs\").<assertion method ex: isEqualTo()>", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425349071", "createdAt": "2020-05-14T18:33:10Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -130,4 +148,50 @@ public Void call() throws Exception {\n     assertPathDoesNotExist(fs, \"deleted\", dir);\n \n   }\n+\n+  @Test\n+  public void testDeleteIdempotency() throws Exception {\n+    org.junit.Assume.assumeTrue(DEFAULT_DELETE_CONSIDERED_IDEMPOTENT);\n+    // Config to reduce the retry and maxBackoff time for test run\n+    AbfsConfiguration abfsConfig = getConfiguration();\n+    abfsConfig.setMaxIoRetries(REDUCED_RETRY_COUNT);\n+    abfsConfig.setMaxBackoffIntervalMilliseconds(REDUCED_MAX_BACKOFF_INTERVALS_MS);\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    AbfsClient abfsClient = fs.getAbfsStore().getClient();\n+    AbfsPerfTracker tracker = new AbfsPerfTracker(\"test\",\n+        this.getAccountName(),\n+        abfsConfig);\n+\n+    // Create test AbfsClient\n+    AbfsClient testClient = new AbfsClient(\n+        abfsClient.getBaseUrl(),\n+        new SharedKeyCredentials(abfsConfig.getAccountName().substring(0,\n+            abfsConfig.getAccountName().indexOf(DOT)),\n+            abfsConfig.getStorageAccountKey()),\n+        abfsConfig,\n+        new ExponentialRetryPolicy(REDUCED_RETRY_COUNT),\n+        abfsConfig.getTokenProvider(),\n+        tracker);\n+\n+    // Mock instance of AbfsRestOperation\n+    AbfsRestOperation op = mock(AbfsRestOperation.class);\n+    // Set retryCount to non-zero\n+    when(op.isARetriedRequest()).thenReturn(true);\n+\n+    // Mock instance of Http Operation response. This will return HTTP:Not Found\n+    AbfsHttpOperation http404Op = mock(AbfsHttpOperation.class);\n+    when(http404Op.getStatusCode()).thenReturn(HTTP_NOT_FOUND);\n+\n+    // Mock delete response to 404\n+    when(op.getResult()).thenReturn(http404Op);\n+\n+    assertEquals(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db5c57826fd39894ad88a2ea0628ebbe84b48091"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzMjg4Ng==", "bodyText": "Fixed.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425632886", "createdAt": "2020-05-15T08:02:07Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -130,4 +148,50 @@ public Void call() throws Exception {\n     assertPathDoesNotExist(fs, \"deleted\", dir);\n \n   }\n+\n+  @Test\n+  public void testDeleteIdempotency() throws Exception {\n+    org.junit.Assume.assumeTrue(DEFAULT_DELETE_CONSIDERED_IDEMPOTENT);\n+    // Config to reduce the retry and maxBackoff time for test run\n+    AbfsConfiguration abfsConfig = getConfiguration();\n+    abfsConfig.setMaxIoRetries(REDUCED_RETRY_COUNT);\n+    abfsConfig.setMaxBackoffIntervalMilliseconds(REDUCED_MAX_BACKOFF_INTERVALS_MS);\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    AbfsClient abfsClient = fs.getAbfsStore().getClient();\n+    AbfsPerfTracker tracker = new AbfsPerfTracker(\"test\",\n+        this.getAccountName(),\n+        abfsConfig);\n+\n+    // Create test AbfsClient\n+    AbfsClient testClient = new AbfsClient(\n+        abfsClient.getBaseUrl(),\n+        new SharedKeyCredentials(abfsConfig.getAccountName().substring(0,\n+            abfsConfig.getAccountName().indexOf(DOT)),\n+            abfsConfig.getStorageAccountKey()),\n+        abfsConfig,\n+        new ExponentialRetryPolicy(REDUCED_RETRY_COUNT),\n+        abfsConfig.getTokenProvider(),\n+        tracker);\n+\n+    // Mock instance of AbfsRestOperation\n+    AbfsRestOperation op = mock(AbfsRestOperation.class);\n+    // Set retryCount to non-zero\n+    when(op.isARetriedRequest()).thenReturn(true);\n+\n+    // Mock instance of Http Operation response. This will return HTTP:Not Found\n+    AbfsHttpOperation http404Op = mock(AbfsHttpOperation.class);\n+    when(http404Op.getStatusCode()).thenReturn(HTTP_NOT_FOUND);\n+\n+    // Mock delete response to 404\n+    when(op.getResult()).thenReturn(http404Op);\n+\n+    assertEquals(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0OTA3MQ=="}, "originalCommit": {"oid": "db5c57826fd39894ad88a2ea0628ebbe84b48091"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODczMTk1OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AbfsConfiguration.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODozNjoxM1rOGVpWag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzozODoxNVrOGV52Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDc2Mg==", "bodyText": "I am not sure if this annotation is reccommanded as the method is anyway public. I personaly find it ok as it adds to readability.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425350762", "createdAt": "2020-05-14T18:36:13Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AbfsConfiguration.java", "diffHunk": "@@ -764,6 +764,11 @@ public void setMaxIoRetries(int maxIoRetries) {\n     this.maxIoRetries = maxIoRetries;\n   }\n \n+  @VisibleForTesting", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db5c57826fd39894ad88a2ea0628ebbe84b48091"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYyMTAzOQ==", "bodyText": "Yes. As can be seen for other methods  below.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425621039", "createdAt": "2020-05-15T07:38:15Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AbfsConfiguration.java", "diffHunk": "@@ -764,6 +764,11 @@ public void setMaxIoRetries(int maxIoRetries) {\n     this.maxIoRetries = maxIoRetries;\n   }\n \n+  @VisibleForTesting", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDc2Mg=="}, "originalCommit": {"oid": "db5c57826fd39894ad88a2ea0628ebbe84b48091"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODc1Njk2OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/site/markdown/abfs.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODo0MzoxOFrOGVpmTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzo0ODo1N1rOGV6KQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1NDgyOQ==", "bodyText": "Make changes if required as per the similar conversation we are having in the same PR. I mean mentioning it as the \"default\".", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425354829", "createdAt": "2020-05-14T18:43:18Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/site/markdown/abfs.md", "diffHunk": "@@ -691,6 +691,18 @@ Config `fs.azure.account.hns.enabled` provides an option to specify whether\n Config `fs.azure.enable.check.access` needs to be set true to enable\n  the AzureBlobFileSystem.access().\n \n+### <a name=\"idempotency\"></a> Operation Idempotency\n+\n+Requests failing due to server timeouts and network failures will be retried.\n+PUT/POST operations are idempotent and need no specific handling\n+except for Rename and Delete operations.\n+\n+Rename idempotency checks are made by ensuring the LastModifiedTime on destination\n+is recent if source path is found to be non-existent on retry.\n+\n+Delete is considered to be idempotent by default if the target does not exist on", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db5c57826fd39894ad88a2ea0628ebbe84b48091"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYyNjE3OA==", "bodyText": "I guess the oflline conversation on what Default means clarifies.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425626178", "createdAt": "2020-05-15T07:48:57Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/site/markdown/abfs.md", "diffHunk": "@@ -691,6 +691,18 @@ Config `fs.azure.account.hns.enabled` provides an option to specify whether\n Config `fs.azure.enable.check.access` needs to be set true to enable\n  the AzureBlobFileSystem.access().\n \n+### <a name=\"idempotency\"></a> Operation Idempotency\n+\n+Requests failing due to server timeouts and network failures will be retried.\n+PUT/POST operations are idempotent and need no specific handling\n+except for Rename and Delete operations.\n+\n+Rename idempotency checks are made by ensuring the LastModifiedTime on destination\n+is recent if source path is found to be non-existent on retry.\n+\n+Delete is considered to be idempotent by default if the target does not exist on", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1NDgyOQ=="}, "originalCommit": {"oid": "db5c57826fd39894ad88a2ea0628ebbe84b48091"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDUzNDA2OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/TestAbfsConfigurationFieldsValidation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODowOTozOVrOGV6zNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODo0MDozM1rOGV7z0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzNjY2MQ==", "bodyText": "Not sure if this class is the right place for this method.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425636661", "createdAt": "2020-05-15T08:09:39Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/TestAbfsConfigurationFieldsValidation.java", "diffHunk": "@@ -182,4 +182,11 @@ public void testSSLSocketFactoryConfiguration()\n     assertEquals(DelegatingSSLSocketFactory.SSLChannelMode.OpenSSL, localAbfsConfiguration.getPreferredSSLFactoryOption());\n   }\n \n+  public static AbfsConfiguration updateRetryConfigs(AbfsConfiguration abfsConfig,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14be440a53dfcd63a6a89548ab8bdc2ca48d2ea1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY1MzIwMQ==", "bodyText": "This is the unit test class for AbfsConfiguration. I do not want to create separate utility class just to return a test instance of main class.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425653201", "createdAt": "2020-05-15T08:40:33Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/TestAbfsConfigurationFieldsValidation.java", "diffHunk": "@@ -182,4 +182,11 @@ public void testSSLSocketFactoryConfiguration()\n     assertEquals(DelegatingSSLSocketFactory.SSLChannelMode.OpenSSL, localAbfsConfiguration.getPreferredSSLFactoryOption());\n   }\n \n+  public static AbfsConfiguration updateRetryConfigs(AbfsConfiguration abfsConfig,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzNjY2MQ=="}, "originalCommit": {"oid": "14be440a53dfcd63a6a89548ab8bdc2ca48d2ea1"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDU0NDU2OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/services/TestAbfsClient.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODoxMzowM1rOGV65qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODo0MjowMFrOGV723g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzODMxMg==", "bodyText": "Same doubt as the above comment.\nTestAbfsClient should have test methods the AbfsClient and supporting methods.\nThis method looks more like a Utility.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425638312", "createdAt": "2020-05-15T08:13:03Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/services/TestAbfsClient.java", "diffHunk": "@@ -240,4 +242,25 @@ public void verifyUserAgentClusterType() throws Exception {\n       .contains(DEFAULT_VALUE_UNKNOWN);\n   }\n \n+  public static AbfsClient createTestClientFromCurrentContext(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14be440a53dfcd63a6a89548ab8bdc2ca48d2ea1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY1Mzk4Mg==", "bodyText": "Again, dont want to create a separate test utility class for AbfsClient alone to return a test instance and hence have placed it in the unit test class for AbfsClient.\nFor future tests that will need to mock or create new instances, it will be easy to check respective unit test class for any method available.", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425653982", "createdAt": "2020-05-15T08:42:00Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/services/TestAbfsClient.java", "diffHunk": "@@ -240,4 +242,25 @@ public void verifyUserAgentClusterType() throws Exception {\n       .contains(DEFAULT_VALUE_UNKNOWN);\n   }\n \n+  public static AbfsClient createTestClientFromCurrentContext(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzODMxMg=="}, "originalCommit": {"oid": "14be440a53dfcd63a6a89548ab8bdc2ca48d2ea1"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDU1MDE2OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODoxNDo0NVrOGV69Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODo1NToyOFrOGV8TbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzOTE3NQ==", "bodyText": "This new line can be removed", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425639175", "createdAt": "2020-05-15T08:14:45Z", "author": {"login": "bilaharith"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -26,22 +26,40 @@\n import java.util.concurrent.Executors;\n import java.util.concurrent.Future;\n \n+import org.assertj.core.api.Assertions;\n+import org.junit.Assume;\n import org.junit.Test;\n \n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsHttpOperation;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation;\n+import org.apache.hadoop.fs.azurebfs.services.TestAbfsClient;\n import org.apache.hadoop.fs.FileAlreadyExistsException;\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.Path;\n \n+import static java.net.HttpURLConnection.HTTP_NOT_FOUND;\n+import static java.net.HttpURLConnection.HTTP_OK;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.FileSystemConfigurations.DEFAULT_DELETE_CONSIDERED_IDEMPOTENT;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertDeleted;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertPathDoesNotExist;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14be440a53dfcd63a6a89548ab8bdc2ca48d2ea1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY2MTI5Mw==", "bodyText": "Fixed,", "url": "https://github.com/apache/hadoop/pull/2021#discussion_r425661293", "createdAt": "2020-05-15T08:55:28Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -26,22 +26,40 @@\n import java.util.concurrent.Executors;\n import java.util.concurrent.Future;\n \n+import org.assertj.core.api.Assertions;\n+import org.junit.Assume;\n import org.junit.Test;\n \n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsHttpOperation;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsRestOperation;\n+import org.apache.hadoop.fs.azurebfs.services.TestAbfsClient;\n import org.apache.hadoop.fs.FileAlreadyExistsException;\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.Path;\n \n+import static java.net.HttpURLConnection.HTTP_NOT_FOUND;\n+import static java.net.HttpURLConnection.HTTP_OK;\n+\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.FileSystemConfigurations.DEFAULT_DELETE_CONSIDERED_IDEMPOTENT;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertDeleted;\n import static org.apache.hadoop.fs.contract.ContractTestUtils.assertPathDoesNotExist;\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzOTE3NQ=="}, "originalCommit": {"oid": "14be440a53dfcd63a6a89548ab8bdc2ca48d2ea1"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3567, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}