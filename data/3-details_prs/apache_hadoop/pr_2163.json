{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0MzU2Njgx", "number": 2163, "title": "HDFS-15480. Ordered snapshot deletion: record snapshot deletion in XAttr", "bodyText": "Please see https://issues.apache.org/jira/browse/HDFS-15480", "createdAt": "2020-07-21T10:21:22Z", "url": "https://github.com/apache/hadoop/pull/2163", "merged": true, "mergeCommit": {"oid": "2d12496643b1b7cfa4eb270ec9b2fcdb78a58798"}, "closed": true, "closedAt": "2020-07-22T23:16:28Z", "author": {"login": "bshashikant"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3DhjigH2gAyNDU0MzU2NjgxOmNiYTdjMDBjM2ZjODI5OTE4MTUyMjgxMjI3MThmZDU1ZDljYzVhMTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3gBTRAH2gAyNDU0MzU2NjgxOjc2MTMxNjFhYzE2M2EyZmY0NDFhMzkwOWIwMTg0NWE3ZTQ3MjNhZTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cba7c00c3fc82991815228122718fd55d9cc5a13", "author": {"user": {"login": "bshashikant", "name": null}}, "url": "https://github.com/apache/hadoop/commit/cba7c00c3fc82991815228122718fd55d9cc5a13", "committedDate": "2020-07-21T10:18:17Z", "message": "HDFS-15480. Ordered snapshot deletion: record snapshot deletion in XAttr."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7dfa8dc5ba55eecf59862c867812234112589e1", "author": {"user": {"login": "bshashikant", "name": null}}, "url": "https://github.com/apache/hadoop/commit/f7dfa8dc5ba55eecf59862c867812234112589e1", "committedDate": "2020-07-21T11:09:40Z", "message": "Addressed review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNTk4MDQz", "url": "https://github.com/apache/hadoop/pull/2163#pullrequestreview-452598043", "createdAt": "2020-07-21T15:52:02Z", "commit": {"oid": "f7dfa8dc5ba55eecf59862c867812234112589e1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNTo1MjowMlrOG0-mmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNTo1MjowMlrOG0-mmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIwNDgyNQ==", "bodyText": "Expand the wildcard imports", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458204825", "createdAt": "2020-07-21T15:52:02Z", "author": {"login": "mukul1987"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java", "diffHunk": "@@ -41,10 +41,7 @@\n import java.util.List;\n import java.util.ListIterator;\n \n-import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.CRYPTO_XATTR_ENCRYPTION_ZONE;\n-import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.SECURITY_XATTR_UNREADABLE_BY_SUPERUSER;\n-import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.XATTR_SATISFY_STORAGE_POLICY;\n-import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.CRYPTO_XATTR_FILE_ENCRYPTION_INFO;\n+import static org.apache.hadoop.hdfs.server.common.HdfsServerConstants.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7dfa8dc5ba55eecf59862c867812234112589e1"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f2efde88eade660d22c4dee3b6038d63f9870aa", "author": {"user": {"login": "bshashikant", "name": null}}, "url": "https://github.com/apache/hadoop/commit/4f2efde88eade660d22c4dee3b6038d63f9870aa", "committedDate": "2020-07-21T17:05:29Z", "message": "Addressed checkstyle and review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNjYzNjM0", "url": "https://github.com/apache/hadoop/pull/2163#pullrequestreview-452663634", "createdAt": "2020-07-21T17:09:31Z", "commit": {"oid": "4f2efde88eade660d22c4dee3b6038d63f9870aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNjcwOTAz", "url": "https://github.com/apache/hadoop/pull/2163#pullrequestreview-452670903", "createdAt": "2020-07-21T17:19:14Z", "commit": {"oid": "f7dfa8dc5ba55eecf59862c867812234112589e1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNzoxOToxNFrOG1CFqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNzoyNTo0MFrOG1CVBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2MTkyOA==", "bodyText": "We cannot return null since it will skip the fsd.getEditLog().logDeleteSnapshot(..).", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458261928", "createdAt": "2020-07-21T17:19:14Z", "author": {"login": "szetszwo"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirSnapshotOp.java", "diffHunk": "@@ -263,11 +269,18 @@ static SnapshotDiffReportListing getSnapshotDiffReportListing(FSDirectory fsd,\n       final int earliest = snapshottable.getDiffs().iterator().next()\n           .getSnapshotId();\n       if (snapshot.getId() != earliest) {\n-        throw new SnapshotException(\"Failed to delete snapshot \" + snapshotName\n-            + \" from directory \" + srcRoot.getFullPathName()\n-            + \": \" + snapshot + \" is not the earliest snapshot id=\" + earliest\n-            + \" (\" + DFSConfigKeys.DFS_NAMENODE_SNAPSHOT_DELETION_ORDERED\n-            + \" is \" + fsd.isSnapshotDeletionOrdered() + \")\");\n+        final XAttr snapshotXAttr = buildXAttr(snapshotName);\n+        final List<XAttr> xattrs = Lists.newArrayListWithCapacity(1);\n+        xattrs.add(snapshotXAttr);\n+\n+        // The snapshot to be deleted is just marked for deletion in the xAttr.\n+        // Same snaphot delete call can happen multiple times until annd unless\n+        // the very 1st instance of a snapshot delete hides it/remove it from\n+        // snapshot list. XAttrSetFlag.REPLACE needs to be set to here in order\n+        // to address this.\n+        FSDirXAttrOp.unprotectedSetXAttrs(fsd, iip, xattrs,\n+            EnumSet.of(XAttrSetFlag.CREATE, XAttrSetFlag.REPLACE));\n+        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7dfa8dc5ba55eecf59862c867812234112589e1"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2NDE3MQ==", "bodyText": "To be consistent with SECURITY_XATTR_UNREADABLE_BY_SUPERUSER, should we throw IOException?", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458264171", "createdAt": "2020-07-21T17:22:54Z", "author": {"login": "szetszwo"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java", "diffHunk": "@@ -326,6 +323,11 @@ static INode unprotectedSetXAttrs(\n         throw new IOException(\"Can only set '\" +\n             SECURITY_XATTR_UNREADABLE_BY_SUPERUSER + \"' on a file.\");\n       }\n+\n+      if (xaName.contains(SNAPSHOT_XATTR_NAME)) {\n+        Preconditions.checkArgument(inode.isDirectory() &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7dfa8dc5ba55eecf59862c867812234112589e1"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2NDU1OA==", "bodyText": "Why removing the check?", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458264558", "createdAt": "2020-07-21T17:23:32Z", "author": {"login": "szetszwo"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java", "diffHunk": "@@ -359,14 +359,6 @@ public int getListLimit() {\n             DFSConfigKeys.DFS_NAMENODE_SNAPSHOT_DELETION_ORDERED_DEFAULT);\n     LOG.info(\"{} = {}\", DFSConfigKeys.DFS_NAMENODE_SNAPSHOT_DELETION_ORDERED,\n         snapshotDeletionOrdered);\n-    if (snapshotDeletionOrdered && !xattrsEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7dfa8dc5ba55eecf59862c867812234112589e1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2NTg2MA==", "bodyText": "@arp7 seems to suggest not to add the conf in hdfs-default.xml.", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458265860", "createdAt": "2020-07-21T17:25:40Z", "author": {"login": "szetszwo"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/resources/hdfs-default.xml", "diffHunk": "@@ -5119,7 +5119,14 @@\n     for storing directory snapshot diffs. By default, value is set to 10.\n   </description>\n </property>\n-\n+<property>\n+  <name>dfs.namenode.snapshot.deletion.ordered</name>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7dfa8dc5ba55eecf59862c867812234112589e1"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e43dbc026767894b9c60b10d2c13dc84ba42c1ea", "author": {"user": {"login": "bshashikant", "name": null}}, "url": "https://github.com/apache/hadoop/commit/e43dbc026767894b9c60b10d2c13dc84ba42c1ea", "committedDate": "2020-07-22T06:46:25Z", "message": "Addressed review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMjA4NzQw", "url": "https://github.com/apache/hadoop/pull/2163#pullrequestreview-453208740", "createdAt": "2020-07-22T10:56:07Z", "commit": {"oid": "e43dbc026767894b9c60b10d2c13dc84ba42c1ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMDo1NjowN1rOG1dUAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMDo1NjowN1rOG1dUAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcwNzk3MA==", "bodyText": "lets set the xattrs to be disabled in this unit test ?", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458707970", "createdAt": "2020-07-22T10:56:07Z", "author": {"login": "mukul1987"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestOrderedSnapshotDeletion.java", "diffHunk": "@@ -67,7 +70,7 @@ public void tearDown() throws Exception {\n     }\n   }\n \n-  @Test (timeout=60000)\n+  @Test(timeout = 60000)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e43dbc026767894b9c60b10d2c13dc84ba42c1ea"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "918026c2bc484e37770802e8ed2ccb922aa75aad", "author": {"user": {"login": "bshashikant", "name": null}}, "url": "https://github.com/apache/hadoop/commit/918026c2bc484e37770802e8ed2ccb922aa75aad", "committedDate": "2020-07-22T16:12:40Z", "message": "Addressed checkstyle and findbug issues."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTIwNzky", "url": "https://github.com/apache/hadoop/pull/2163#pullrequestreview-453520792", "createdAt": "2020-07-22T17:11:26Z", "commit": {"oid": "918026c2bc484e37770802e8ed2ccb922aa75aad"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNzoxMToyNlrOG1sKUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNzoxNjowMVrOG1sVOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTI1MA==", "bodyText": "The xattr name should contain \"deleted\".  How about \"system.hdfs.snapshot.deleted\"?", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458951250", "createdAt": "2020-07-22T17:11:26Z", "author": {"login": "szetszwo"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/HdfsServerConstants.java", "diffHunk": "@@ -366,6 +366,7 @@ public void write(DataOutput out) throws IOException {\n       \"security.hdfs.unreadable.by.superuser\";\n   String XATTR_ERASURECODING_POLICY =\n       \"system.hdfs.erasurecoding.policy\";\n+  String SNAPSHOT_XATTR_NAME = \"system.hdfs.snapshot\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "918026c2bc484e37770802e8ed2ccb922aa75aad"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MzExOA==", "bodyText": "Let's check \"!(inode instanceof of Snapshot.Root)\" instead of \"!(inode.isDirectory() && inode.getParent().isSnapshottable())?", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458953118", "createdAt": "2020-07-22T17:14:35Z", "author": {"login": "szetszwo"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirXAttrOp.java", "diffHunk": "@@ -326,6 +327,12 @@ static INode unprotectedSetXAttrs(\n         throw new IOException(\"Can only set '\" +\n             SECURITY_XATTR_UNREADABLE_BY_SUPERUSER + \"' on a file.\");\n       }\n+\n+      if (xaName.equals(SNAPSHOT_XATTR_NAME) && !(inode.isDirectory() &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "918026c2bc484e37770802e8ed2ccb922aa75aad"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1NDA0MQ==", "bodyText": "We should leave hdfs-default.xml untouched since we are not changing anything.", "url": "https://github.com/apache/hadoop/pull/2163#discussion_r458954041", "createdAt": "2020-07-22T17:16:01Z", "author": {"login": "szetszwo"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/resources/hdfs-default.xml", "diffHunk": "@@ -5119,7 +5119,6 @@\n     for storing directory snapshot diffs. By default, value is set to 10.\n   </description>\n </property>\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "918026c2bc484e37770802e8ed2ccb922aa75aad"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7613161ac163a2ff441a3909b01845a7e4723ae8", "author": {"user": {"login": "bshashikant", "name": null}}, "url": "https://github.com/apache/hadoop/commit/7613161ac163a2ff441a3909b01845a7e4723ae8", "committedDate": "2020-07-22T19:30:18Z", "message": "Fixed a bug while replaying edits and addressed review comments."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3774, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}