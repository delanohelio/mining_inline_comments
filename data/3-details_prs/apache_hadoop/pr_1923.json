{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NTIzMjUx", "number": 1923, "title": "Hadoop 16857. ABFS: Stop CustomTokenProvider retry logic to depend on AbfsRestOp retry policy", "bodyText": "urrent behaviour:\nAzureADAuthenticator includes retry logic for all oAuth token providers that are implemented in ABFS Driver. Where as CustomTokenProvider failures end up in retry from the ABFS Driver REST request invoking layer which is not expected.\nExpected behaviour:\nIdeally custom token provider implementation should include retry logic too. Raising PR to stop retries getting triggered from the REST op layer due to exceptions from custom token provider.\nAs custom token providers might have had benefited by the unintentional retry happening, have retained a linear retry to trigger getAccessToken. The retry count is made configurable.\nTesting:\nThe fix is tested with mock failures of a CustomTokenProvider by modifying a existing testcase that injects this scenario.\nThe modified testcase previously used to test a new config introduced to control the number of request retries done by exponential retry policy. New test class TestExponentialRetryPolicy is added to ensure that tests for this older config is present.", "createdAt": "2020-03-30T09:29:58Z", "url": "https://github.com/apache/hadoop/pull/1923", "merged": true, "mergeCommit": {"oid": "3d69383c26649e272ce591061c919b8c96ee7cfc"}, "closed": true, "closedAt": "2020-04-22T04:39:48Z", "author": {"login": "snvijaya"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSq9JLgH2gAyMzk1NTIzMjUxOjhiMWEzODJiZGJlMWYzMTA1MDYzMjE0MDEyZjZkOGVjZWZhNWZiMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaArnOgFqTM5NzgzNzI0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8b1a382bdbe1f3105063214012f6d8ecefa5fb14", "author": {"user": {"login": "snvijaya", "name": "Sneha Vijayarajan"}}, "url": "https://github.com/apache/hadoop/commit/8b1a382bdbe1f3105063214012f6d8ecefa5fb14", "committedDate": "2020-03-30T09:19:31Z", "message": "Stop retries from AbfsRestOperation due to exception from CustomTokenProvider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d75c4c6612a7402ecd4d45ad6f3491677c75014", "author": {"user": {"login": "snvijaya", "name": "Sneha Vijayarajan"}}, "url": "https://github.com/apache/hadoop/commit/9d75c4c6612a7402ecd4d45ad6f3491677c75014", "committedDate": "2020-03-30T09:28:41Z", "message": "Merge branch 'trunk' into HADOOP-16857"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3af12949021ae16164f05f1f28bb08cb44ffdf20", "author": {"user": {"login": "snvijaya", "name": "Sneha Vijayarajan"}}, "url": "https://github.com/apache/hadoop/commit/3af12949021ae16164f05f1f28bb08cb44ffdf20", "committedDate": "2020-04-06T08:54:45Z", "message": "Checkstyle fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d917f7cc3b25c3382c81139c5af50b9497b0ac89", "author": {"user": {"login": "snvijaya", "name": "Sneha Vijayarajan"}}, "url": "https://github.com/apache/hadoop/commit/d917f7cc3b25c3382c81139c5af50b9497b0ac89", "committedDate": "2020-04-06T09:43:39Z", "message": "Fixing checkstyle issues for erro NoWhitespacebefore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4aa751ecd434256414a338f9b35c3173ceca7cf", "author": {"user": {"login": "snvijaya", "name": "Sneha Vijayarajan"}}, "url": "https://github.com/apache/hadoop/commit/c4aa751ecd434256414a338f9b35c3173ceca7cf", "committedDate": "2020-04-06T10:50:03Z", "message": "Merge branch 'trunk' into HADOOP-16857"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57bb403440aa9a4638a887c904f099709bc4ae9b", "author": {"user": {"login": "snvijaya", "name": "Sneha Vijayarajan"}}, "url": "https://github.com/apache/hadoop/commit/57bb403440aa9a4638a887c904f099709bc4ae9b", "committedDate": "2020-04-07T04:27:32Z", "message": "Checkstyle issues for MagicNumber errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NjgxNzQy", "url": "https://github.com/apache/hadoop/pull/1923#pullrequestreview-389681742", "createdAt": "2020-04-08T06:23:23Z", "commit": {"oid": "57bb403440aa9a4638a887c904f099709bc4ae9b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNjoyMzoyM1rOGCgmgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNjozNzozOFrOGCg7UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NDQ4MA==", "bodyText": "Throwable might be safer?", "url": "https://github.com/apache/hadoop/pull/1923#discussion_r405284480", "createdAt": "2020-04-08T06:23:23Z", "author": {"login": "DadanielZ"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/CustomTokenProviderAdapter.java", "diffHunk": "@@ -46,16 +48,53 @@\n    *\n    * @param adaptee the custom token provider\n    */\n-  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee) {\n+  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee, int customTokenFetchRetryCount) {\n     Preconditions.checkNotNull(adaptee, \"adaptee\");\n     this.adaptee = adaptee;\n+    fetchTokenRetryCount = customTokenFetchRetryCount;\n   }\n \n   protected AzureADToken refreshToken() throws IOException {\n     LOG.debug(\"AADToken: refreshing custom based token\");\n \n     AzureADToken azureADToken = new AzureADToken();\n-    azureADToken.setAccessToken(adaptee.getAccessToken());\n+\n+    String accessToken = null;\n+\n+    Exception ex;\n+    boolean succeeded = false;\n+    // Custom token providers should have their own retry policies,\n+    // Providing a linear retry option for the the retry count\n+    // mentioned in config \"fs.azure.custom.token.fetch.retry.count\"\n+    int retryCount = fetchTokenRetryCount;\n+    do {\n+      ex = null;\n+      try {\n+        accessToken = adaptee.getAccessToken();\n+        LOG.trace(\"CustomTokenProvider Access token fetch was successful with retry count {}\", retryCount);\n+      } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57bb403440aa9a4638a887c904f099709bc4ae9b"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4OTgwOA==", "bodyText": "Is it necessary to add trace log here? it affects the perf for all rereshToken requests including those succeed without retry.\nAnd the retryCount in the message is confusing,  the total times of retries that have been executed should be fetchTokenRetryCount - retryCount, same for the msg in the catch block.", "url": "https://github.com/apache/hadoop/pull/1923#discussion_r405289808", "createdAt": "2020-04-08T06:37:38Z", "author": {"login": "DadanielZ"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/oauth2/CustomTokenProviderAdapter.java", "diffHunk": "@@ -46,16 +48,53 @@\n    *\n    * @param adaptee the custom token provider\n    */\n-  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee) {\n+  public CustomTokenProviderAdapter(CustomTokenProviderAdaptee adaptee, int customTokenFetchRetryCount) {\n     Preconditions.checkNotNull(adaptee, \"adaptee\");\n     this.adaptee = adaptee;\n+    fetchTokenRetryCount = customTokenFetchRetryCount;\n   }\n \n   protected AzureADToken refreshToken() throws IOException {\n     LOG.debug(\"AADToken: refreshing custom based token\");\n \n     AzureADToken azureADToken = new AzureADToken();\n-    azureADToken.setAccessToken(adaptee.getAccessToken());\n+\n+    String accessToken = null;\n+\n+    Exception ex;\n+    boolean succeeded = false;\n+    // Custom token providers should have their own retry policies,\n+    // Providing a linear retry option for the the retry count\n+    // mentioned in config \"fs.azure.custom.token.fetch.retry.count\"\n+    int retryCount = fetchTokenRetryCount;\n+    do {\n+      ex = null;\n+      try {\n+        accessToken = adaptee.getAccessToken();\n+        LOG.trace(\"CustomTokenProvider Access token fetch was successful with retry count {}\", retryCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57bb403440aa9a4638a887c904f099709bc4ae9b"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "716c8d80c7553da95efd277a2bf5341a6d83de26", "author": {"user": {"login": "snvijaya", "name": "Sneha Vijayarajan"}}, "url": "https://github.com/apache/hadoop/commit/716c8d80c7553da95efd277a2bf5341a6d83de26", "committedDate": "2020-04-21T18:21:51Z", "message": "Fix the retry count printed in the log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2515f7d169b86a17eacb0c83cf44387e97771179", "author": {"user": {"login": "snvijaya", "name": "Sneha Vijayarajan"}}, "url": "https://github.com/apache/hadoop/commit/2515f7d169b86a17eacb0c83cf44387e97771179", "committedDate": "2020-04-21T21:47:24Z", "message": "Javadoc fix for max retry count param"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODM3MjQz", "url": "https://github.com/apache/hadoop/pull/1923#pullrequestreview-397837243", "createdAt": "2020-04-22T04:35:45Z", "commit": {"oid": "2515f7d169b86a17eacb0c83cf44387e97771179"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4527, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}