{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxMTMxMzgy", "number": 2150, "title": "Hadoop 17132. ABFS: Fix Rename and Delete Idempotency check trigger", "bodyText": "Trigger to call the idempotent code introduced in https://issues.apache.org/jira/browse/HADOOP-17015 is incomplete.\nWhen a request fails at the AbfsRestOperation, an exception is thrown from the REST response handling code . HADOOP-17015 was failing to catch it before checking the AbfsRestOperation instance status code.\nThe request retry count was also getting set to 1 even when request wasnt re-tired. That has been fixed too.\nTests are added by setting final fields in AbfsClient by reflection and mimicking the idempotency check return values to ensure that the trigger handles all scenarios.", "createdAt": "2020-07-17T13:38:20Z", "url": "https://github.com/apache/hadoop/pull/2150", "merged": true, "mergeCommit": {"oid": "d23cc9d85d887f01d72180bdf1af87dfdee15c5a"}, "closed": true, "closedAt": "2020-07-21T16:22:39Z", "author": {"login": "snvijaya"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1ZNMDAH2gAyNDUxMTMxMzgyOmYxZGFkM2RlNzYyMmMyYmY5OTJiZDQwODFmMzZhYTY5YTQ2MjY4NDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3ItrZgFqTQ1MjYyMzgwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f1dad3de7622c2bf992bd4081f36aa69a4626849", "author": {"user": {"login": "snvijaya", "name": "Sneha Vijayarajan"}}, "url": "https://github.com/apache/hadoop/commit/f1dad3de7622c2bf992bd4081f36aa69a4626849", "committedDate": "2020-07-16T06:26:06Z", "message": "Fix idempotency pre-check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d4a5931ca4b0e79e4e4e9a8b7fb4848daae2472", "author": {"user": {"login": "snvijaya", "name": "Sneha Vijayarajan"}}, "url": "https://github.com/apache/hadoop/commit/0d4a5931ca4b0e79e4e4e9a8b7fb4848daae2472", "committedDate": "2020-07-17T07:19:50Z", "message": "Fix for idempotency fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMjc4NjEz", "url": "https://github.com/apache/hadoop/pull/2150#pullrequestreview-451278613", "createdAt": "2020-07-20T03:44:45Z", "commit": {"oid": "0d4a5931ca4b0e79e4e4e9a8b7fb4848daae2472"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTI5MzQ3", "url": "https://github.com/apache/hadoop/pull/2150#pullrequestreview-451929347", "createdAt": "2020-07-20T20:19:31Z", "commit": {"oid": "0d4a5931ca4b0e79e4e4e9a8b7fb4848daae2472"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDoxOTozMlrOG0d1QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDoyMDozOVrOG0d3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY2NzkwNA==", "bodyText": "tag this as @VisibleForTesting too", "url": "https://github.com/apache/hadoop/pull/2150#discussion_r457667904", "createdAt": "2020-07-20T20:19:32Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "diffHunk": "@@ -170,7 +170,7 @@ String getSasToken() {\n    * Executes the REST operation with retry, by issuing one or more\n    * HTTP operations.\n    */\n-  void execute() throws AzureBlobFileSystemException {\n+   public void execute() throws AzureBlobFileSystemException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d4a5931ca4b0e79e4e4e9a8b7fb4848daae2472"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY2ODQwNQ==", "bodyText": "check spelling of mimic", "url": "https://github.com/apache/hadoop/pull/2150#discussion_r457668405", "createdAt": "2020-07-20T20:20:39Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-azure/src/test/java/org/apache/hadoop/fs/azurebfs/ITestAzureBlobFileSystemDelete.java", "diffHunk": "@@ -181,6 +186,64 @@ public void testDeleteIdempotency() throws Exception {\n         .describedAs(\n             \"Delete is considered idempotent by default and should return success.\")\n         .isEqualTo(HTTP_OK);\n+\n+    // Case 2: Mock instance of Http Operation response. This will return\n+    // HTTP:Bad Request\n+    AbfsHttpOperation http400Op = mock(AbfsHttpOperation.class);\n+    when(http400Op.getStatusCode()).thenReturn(HTTP_BAD_REQUEST);\n+\n+    // Mock delete response to 400\n+    when(op.getResult()).thenReturn(http400Op);\n+\n+    Assertions.assertThat(testClient.deleteIdempotencyCheckOp(op)\n+        .getResult()\n+        .getStatusCode())\n+        .describedAs(\n+            \"Idempotency check to happen only for HTTP 404 response.\")\n+        .isEqualTo(HTTP_BAD_REQUEST);\n+\n+  }\n+\n+  @Test\n+  public void testDeleteIdempotencyTriggerHttp404() throws Exception {\n+\n+    final AzureBlobFileSystem fs = getFileSystem();\n+    AbfsClient client = TestAbfsClient.createTestClientFromCurrentContext(\n+        fs.getAbfsStore().getClient(),\n+        this.getConfiguration());\n+\n+    // Case 1: Not a retried case should throw error back\n+    intercept(AbfsRestOperationException.class,\n+        () -> client.deletePath(\n+        \"/NonExistingPath\",\n+        false,\n+        null));\n+\n+    // mock idempotency check to mimick retried case", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d4a5931ca4b0e79e4e4e9a8b7fb4848daae2472"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bf8fcdb22701e0042d802a43124a74e13a7935f", "author": {"user": {"login": "snvijaya", "name": "Sneha Vijayarajan"}}, "url": "https://github.com/apache/hadoop/commit/7bf8fcdb22701e0042d802a43124a74e13a7935f", "committedDate": "2020-07-20T20:46:23Z", "message": "Review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNjIzODA5", "url": "https://github.com/apache/hadoop/pull/2150#pullrequestreview-452623809", "createdAt": "2020-07-21T16:21:03Z", "commit": {"oid": "7bf8fcdb22701e0042d802a43124a74e13a7935f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4176, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}