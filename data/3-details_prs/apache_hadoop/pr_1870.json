{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNTYzNzQ2", "number": 1870, "title": "HDFS-15201 SnapshotCounter hits MaxSnapshotID limit", "bodyText": "Jira: https://issues.apache.org/jira/browse/HDFS-15201\nUsers reported that they are unable to take HDFS snapshots and their snapshotCounter hits MaxSnapshotID limit. MaxSnapshotID limit is\u00a016777215.\nSnapshotManager.java\n\nprivate static final int SNAPSHOT_ID_BIT_WIDTH = 24;\n\n/**\n * Returns the maximum allowable snapshot ID based on the bit width of the\n * snapshot ID.\n *\n * @return maximum allowable snapshot ID.\n */\n public int getMaxSnapshotID() {\n return ((1 << SNAPSHOT_ID_BIT_WIDTH) - 1);\n}\n\nI think, SNAPSHOT_ID_BIT_WIDTH is too low. May be good idea to increase SNAPSHOT_ID_BIT_WIDTH to 31? to aline with our CURRENT_STATE_ID limit (Integer.MAX_VALUE - 1).\n/**\n * This id is used to indicate the current state (vs. snapshots)\n */\npublic static final int CURRENT_STATE_ID = Integer.MAX_VALUE - 1;", "createdAt": "2020-03-02T19:25:50Z", "url": "https://github.com/apache/hadoop/pull/1870", "merged": true, "mergeCommit": {"oid": "5250cd6db3a6b7abeb5c9a0a4059f1d95986c07b"}, "closed": true, "closedAt": "2020-03-24T09:45:47Z", "author": {"login": "karthikhw"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJyzCYAH2gAyMzgyNTYzNzQ2OjE1OTI5ZjZmNmM1NzYxMDg4YmMwMGZiMThiN2IzODRiNzVlMzVkYTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQvttSAFqTM4MDE0MzY5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "15929f6f6c5761088bc00fb18b7b384b75e35da9", "author": {"user": {"login": "karthikhw", "name": "Karthik Palanisamy"}}, "url": "https://github.com/apache/hadoop/commit/15929f6f6c5761088bc00fb18b7b384b75e35da9", "committedDate": "2020-03-02T19:22:24Z", "message": "HDFS-15201 SnapshotCounter hits MaxSnapshotID limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NDk3Mjcy", "url": "https://github.com/apache/hadoop/pull/1870#pullrequestreview-367497272", "createdAt": "2020-03-02T20:17:33Z", "commit": {"oid": "15929f6f6c5761088bc00fb18b7b384b75e35da9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMDoxNzozNFrOFwtznQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMDoxNzozNFrOFwtznQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYyNjQ2MQ==", "bodyText": "I believe @szetszwo recommended setting this to 28 bits for now (something less than 31).", "url": "https://github.com/apache/hadoop/pull/1870#discussion_r386626461", "createdAt": "2020-03-02T20:17:34Z", "author": {"login": "arp7"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/snapshot/SnapshotManager.java", "diffHunk": "@@ -96,7 +96,7 @@\n   private final boolean snapshotDiffAllowSnapRootDescendant;\n \n   private final AtomicInteger numSnapshots = new AtomicInteger();\n-  private static final int SNAPSHOT_ID_BIT_WIDTH = 24;\n+  private static final int SNAPSHOT_ID_BIT_WIDTH = 31;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15929f6f6c5761088bc00fb18b7b384b75e35da9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "558f9547389f6df26f110afa359d6ec496a50d8e", "author": {"user": {"login": "karthikhw", "name": "Karthik Palanisamy"}}, "url": "https://github.com/apache/hadoop/commit/558f9547389f6df26f110afa359d6ec496a50d8e", "committedDate": "2020-03-02T22:17:27Z", "message": "Set SNAPSHOT_ID_BIT_WIDTH to 28"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjQ2ODI2", "url": "https://github.com/apache/hadoop/pull/1870#pullrequestreview-367646826", "createdAt": "2020-03-03T01:27:15Z", "commit": {"oid": "558f9547389f6df26f110afa359d6ec496a50d8e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToyNzoxNVrOFw1XIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToyNzoxNVrOFw1XIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1MDI0Mg==", "bodyText": "can you add a description/comment to explain this assertion.", "url": "https://github.com/apache/hadoop/pull/1870#discussion_r386750242", "createdAt": "2020-03-03T01:27:15Z", "author": {"login": "jojochuang"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/snapshot/TestSnapshotManager.java", "diffHunk": "@@ -92,4 +92,15 @@ public void testSnapshotLimits() throws Exception {\n           StringUtils.toLowerCase(se.getMessage()).contains(\"rollover\"));\n     }\n   }\n+\n+\n+  @Test\n+  public void testValidateSnapshotIDWidth() {\n+    FSDirectory fsdir = mock(FSDirectory.class);\n+    SnapshotManager snapshotManager = new SnapshotManager(new Configuration(),\n+        fsdir);\n+    Assert.assertTrue(snapshotManager.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "558f9547389f6df26f110afa359d6ec496a50d8e"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjY2OTEy", "url": "https://github.com/apache/hadoop/pull/1870#pullrequestreview-367666912", "createdAt": "2020-03-03T02:34:21Z", "commit": {"oid": "558f9547389f6df26f110afa359d6ec496a50d8e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMjozNDoyMVrOFw2c6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMjozNDoyMVrOFw2c6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc2ODEwNg==", "bodyText": "I think we can still leave this as max index -1, as we would only have one snapshot id here.", "url": "https://github.com/apache/hadoop/pull/1870#discussion_r386768106", "createdAt": "2020-03-03T02:34:21Z", "author": {"login": "mukul1987"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/snapshot/SnapshotManager.java", "diffHunk": "@@ -541,8 +541,8 @@ public void clearSnapshottableDirs() {\n    *\n    * @return maximum allowable snapshot ID.\n    */\n-   public int getMaxSnapshotID() {\n-    return ((1 << SNAPSHOT_ID_BIT_WIDTH) - 1);\n+  public int getMaxSnapshotID() {\n+    return (1 << SNAPSHOT_ID_BIT_WIDTH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "558f9547389f6df26f110afa359d6ec496a50d8e"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a189ef1bb3488d1f11fdc6f9da4e0c2d2c5ddc97", "author": {"user": {"login": "karthikhw", "name": "Karthik Palanisamy"}}, "url": "https://github.com/apache/hadoop/commit/a189ef1bb3488d1f11fdc6f9da4e0c2d2c5ddc97", "committedDate": "2020-03-04T21:12:45Z", "message": "Review fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f6830c10796d2f034991070b077f4b91b8e465a", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/3f6830c10796d2f034991070b077f4b91b8e465a", "committedDate": "2020-03-04T21:15:18Z", "message": "Update TestSnapshotManager.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDg2MDcy", "url": "https://github.com/apache/hadoop/pull/1870#pullrequestreview-369086072", "createdAt": "2020-03-04T20:07:56Z", "commit": {"oid": "558f9547389f6df26f110afa359d6ec496a50d8e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDowNzo1NlrOFx76rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDowNzo1NlrOFx76rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwNjIyMQ==", "bodyText": "Thank you @mukul1987. I didn't understand this \"as we would only have one snapshot id here\".\nSNAPSHOT_ID_BIT_WIDTH  has no relation with anyone. Not sure why would we need index -1.", "url": "https://github.com/apache/hadoop/pull/1870#discussion_r387906221", "createdAt": "2020-03-04T20:07:56Z", "author": {"login": "karthikhw"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/snapshot/SnapshotManager.java", "diffHunk": "@@ -541,8 +541,8 @@ public void clearSnapshottableDirs() {\n    *\n    * @return maximum allowable snapshot ID.\n    */\n-   public int getMaxSnapshotID() {\n-    return ((1 << SNAPSHOT_ID_BIT_WIDTH) - 1);\n+  public int getMaxSnapshotID() {\n+    return (1 << SNAPSHOT_ID_BIT_WIDTH);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc2ODEwNg=="}, "originalCommit": {"oid": "558f9547389f6df26f110afa359d6ec496a50d8e"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDIyODM0", "url": "https://github.com/apache/hadoop/pull/1870#pullrequestreview-371422834", "createdAt": "2020-03-09T18:22:02Z", "commit": {"oid": "3f6830c10796d2f034991070b077f4b91b8e465a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9f05e22ee9f119cef83fb4c152ee81f81c6fb56", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/b9f05e22ee9f119cef83fb4c152ee81f81c6fb56", "committedDate": "2020-03-13T00:04:49Z", "message": "Changed -1 from -2 for getMaxSnapshotID"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTQzNjkx", "url": "https://github.com/apache/hadoop/pull/1870#pullrequestreview-380143691", "createdAt": "2020-03-24T09:44:20Z", "commit": {"oid": "b9f05e22ee9f119cef83fb4c152ee81f81c6fb56"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4413, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}