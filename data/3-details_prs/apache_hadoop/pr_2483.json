{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1Mzk4ODE4", "number": 2483, "title": "HDFS-14904. Option to let Balancer prefer top used nodes in each iteration.", "bodyText": "Normally the most important purpose for HDFS balancer is to reduce the top used node to prevent datanode usage from being too high.\nCurrently, balancer almost randomly picks nodes as sources regardless of usage, which makes it slow to bring down the top used datanodes in the cluster, when there are less underutilized nodes in the cluster (consider expansion).\nWe can add an option to prefer top used nodes first in each iteration.", "createdAt": "2020-11-23T01:30:14Z", "url": "https://github.com/apache/hadoop/pull/2483", "merged": true, "mergeCommit": {"oid": "6ff2409b31766cee71cedc30608f4a22e06d31e7"}, "closed": true, "closedAt": "2020-12-02T23:53:10Z", "author": {"login": "LeonGao91"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfJafVAH2gAyNTI1Mzk4ODE4OjFhMjkzYTlhM2IyYzUyNzE2YzczMDg3Y2I4ZTQ0ZGIwZmYzZWMwOTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiC4l2gH2gAyNTI1Mzk4ODE4OjRkMjJkZjQ4Yzg5Yjk0YzU3Mjk1OGQ1YTgyMjE4ZDhmODNiNTE3YzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a293a9a3b2c52716c73087cb8e44db0ff3ec094", "author": {"user": {"login": "LeonGao91", "name": "LeonGao"}}, "url": "https://github.com/apache/hadoop/commit/1a293a9a3b2c52716c73087cb8e44db0ff3ec094", "committedDate": "2020-11-22T23:46:58Z", "message": "Initial code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e495b7db13f4c8869aa83b08bfddc7f9d07b1a6", "author": {"user": {"login": "LeonGao91", "name": "LeonGao"}}, "url": "https://github.com/apache/hadoop/commit/3e495b7db13f4c8869aa83b08bfddc7f9d07b1a6", "committedDate": "2020-11-23T01:17:59Z", "message": "Fix style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d36dc29ba9ca1a2467272c8461d183598f431fb", "author": {"user": {"login": "LeonGao91", "name": "LeonGao"}}, "url": "https://github.com/apache/hadoop/commit/8d36dc29ba9ca1a2467272c8461d183598f431fb", "committedDate": "2020-11-23T06:05:54Z", "message": "Fix style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddd66e0b65e51ca31cb1b628fb05505554078ba6", "author": {"user": {"login": "LeonGao91", "name": "LeonGao"}}, "url": "https://github.com/apache/hadoop/commit/ddd66e0b65e51ca31cb1b628fb05505554078ba6", "committedDate": "2020-11-23T06:11:14Z", "message": "Fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzEzNjkw", "url": "https://github.com/apache/hadoop/pull/2483#pullrequestreview-541313690", "createdAt": "2020-11-30T21:35:37Z", "commit": {"oid": "ddd66e0b65e51ca31cb1b628fb05505554078ba6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMTozNTozOFrOH8OxgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzo1NTo1OFrOH8SmVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxODY1Nw==", "bodyText": "How about describe the parameter option as: \"sort datanodes based on the utilization so that highly utilized datanodes get scheduled first\"?", "url": "https://github.com/apache/hadoop/pull/2483#discussion_r532918657", "createdAt": "2020-11-30T21:35:38Z", "author": {"login": "Jing9"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/balancer/Balancer.java", "diffHunk": "@@ -199,7 +199,10 @@\n       + \"\\tWhether to run the balancer during an ongoing HDFS upgrade.\"\n       + \"This is usually not desired since it will not affect used space \"\n       + \"on over-utilized machines.\"\n-      + \"\\n\\t[-asService]\\tRun as a long running service.\";\n+      + \"\\n\\t[-asService]\\tRun as a long running service.\"\n+      + \"\\n\\t[-sortTopNodes]\"\n+      + \"\\tSort over-utilized nodes by capacity to\"\n+      + \" bring down top used datanode faster.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddd66e0b65e51ca31cb1b628fb05505554078ba6"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyNTA5MA==", "bodyText": "Do we need this \"if\" statement? Maybe use a Preconditions instead?", "url": "https://github.com/apache/hadoop/pull/2483#discussion_r532925090", "createdAt": "2020-11-30T21:48:17Z", "author": {"login": "Jing9"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/balancer/Balancer.java", "diffHunk": "@@ -435,6 +444,22 @@ private long init(List<DatanodeStorageReport> reports) {\n     return Math.max(overLoadedBytes, underLoadedBytes);\n   }\n \n+  private void sortOverUtilizedNodes() {\n+    LOG.info(\"Sorting over-utilized nodes by capacity\" +\n+        \" to bring down top used datanode capacity faster\");\n+\n+    if (overUtilized instanceof List) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddd66e0b65e51ca31cb1b628fb05505554078ba6"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk4MTMzMw==", "bodyText": "Do we need to consider StorageType (which is associated with Source)? E.g., suppose a DN has 2 storage types, one of which is highly utilized and the other is just above average. Do we want to first schedule the movement for the highly-utilized storage type on this node?", "url": "https://github.com/apache/hadoop/pull/2483#discussion_r532981333", "createdAt": "2020-11-30T23:55:58Z", "author": {"login": "Jing9"}, "path": "hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/balancer/Balancer.java", "diffHunk": "@@ -435,6 +444,22 @@ private long init(List<DatanodeStorageReport> reports) {\n     return Math.max(overLoadedBytes, underLoadedBytes);\n   }\n \n+  private void sortOverUtilizedNodes() {\n+    LOG.info(\"Sorting over-utilized nodes by capacity\" +\n+        \" to bring down top used datanode capacity faster\");\n+\n+    if (overUtilized instanceof List) {\n+      List<Source> list = (List<Source>) overUtilized;\n+      list.sort(\n+          (Source source1, Source source2) ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddd66e0b65e51ca31cb1b628fb05505554078ba6"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca36965781af65ee61f753a6afe4f3683a374133", "author": {"user": {"login": "LeonGao91", "name": "LeonGao"}}, "url": "https://github.com/apache/hadoop/commit/ca36965781af65ee61f753a6afe4f3683a374133", "committedDate": "2020-12-01T21:19:22Z", "message": "Resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d22df48c89b94c572958d5a82218d8f83b517c3", "author": {"user": {"login": "LeonGao91", "name": "LeonGao"}}, "url": "https://github.com/apache/hadoop/commit/4d22df48c89b94c572958d5a82218d8f83b517c3", "committedDate": "2020-12-01T23:52:17Z", "message": "Trigger Build"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3321, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}