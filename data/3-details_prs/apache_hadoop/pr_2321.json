{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMjQ1MDAx", "number": 2321, "title": "HADOOP-17267: Add debug-level logs in Filesystem#close", "bodyText": "HDFS reuses the same cached FileSystem object across the file system. If the client calls FileSystem.close(), closeAllForUgi(), or closeAll() (if it applies to the instance) anywhere in the system it purges the cache of that FS instance, and trying to use the instance results in an IOException: FileSystem closed.\nIt would be a great help to clients to see where and when a given FS instance was closed. I.e. in close(), closeAllForUgi(), or closeAll(), it would be great to see a DEBUG-level log of\n\ncalling method name, class, file name/line number\nFileSystem object's identity hash (FileSystem.close() only)", "createdAt": "2020-09-21T12:02:25Z", "url": "https://github.com/apache/hadoop/pull/2321", "merged": true, "mergeCommit": {"oid": "75d10f849981f467dcf4ef16d0d0d3270e5b9885"}, "closed": true, "closedAt": "2020-09-29T15:06:51Z", "author": {"login": "klcopp"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLCJQDgH2gAyNDkwMjQ1MDAxOjcyMTQwMmY5YzQwYWRlYzczMWM1NzM5ODM0ZWU1Y2VmY2EzODlmODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNj4XvAH2gAyNDkwMjQ1MDAxOjg1YzU4MzQwYTQ5ZTk4YmE3M2VkZDY5ODY3OWFkMTU4ODVkMjY4NDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "721402f9c40adec731c5739834ee5cefca389f86", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/721402f9c40adec731c5739834ee5cefca389f86", "committedDate": "2020-09-21T12:00:19Z", "message": "HADOOP-17267: Add debug-level logs in Filesystem#close"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODg1MzAx", "url": "https://github.com/apache/hadoop/pull/2321#pullrequestreview-492885301", "createdAt": "2020-09-21T18:43:14Z", "commit": {"oid": "721402f9c40adec731c5739834ee5cefca389f86"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxODo0MzoxNFrOHVd1cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxODo0NTo1MlrOHVd7Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3MDk2Mw==", "bodyText": "pass in \"\" instead of null and theres' no need for the ? : below", "url": "https://github.com/apache/hadoop/pull/2321#discussion_r492270963", "createdAt": "2020-09-21T18:43:14Z", "author": {"login": "steveloughran"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/FileSystem.java", "diffHunk": "@@ -621,6 +621,9 @@ public static LocalFileSystem newInstanceLocal(Configuration conf)\n    * @throws IOException a problem arose closing one or more filesystem.\n    */\n   public static void closeAll() throws IOException {\n+    if (LOGGER.isDebugEnabled()) {\n+      debugLogFileSystemClose(\"closeAll\", null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "721402f9c40adec731c5739834ee5cefca389f86"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3MTE5MQ==", "bodyText": "just use ugi and let the automatic to.String to the work", "url": "https://github.com/apache/hadoop/pull/2321#discussion_r492271191", "createdAt": "2020-09-21T18:43:41Z", "author": {"login": "steveloughran"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/FileSystem.java", "diffHunk": "@@ -632,9 +635,21 @@ public static void closeAll() throws IOException {\n    */\n   public static void closeAllForUGI(UserGroupInformation ugi)\n   throws IOException {\n+    if (LOGGER.isDebugEnabled()) {\n+      debugLogFileSystemClose(\"closeAllForUGI\", \"UGI: \" + ugi.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "721402f9c40adec731c5739834ee5cefca389f86"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3MjQyMg==", "bodyText": "Prefer SLF4J {} and the values as varargs.\nYou might want to think that at TRACE the entire throwable is logged. Why so? one level up isn't always enough", "url": "https://github.com/apache/hadoop/pull/2321#discussion_r492272422", "createdAt": "2020-09-21T18:45:52Z", "author": {"login": "steveloughran"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/FileSystem.java", "diffHunk": "@@ -632,9 +635,21 @@ public static void closeAll() throws IOException {\n    */\n   public static void closeAllForUGI(UserGroupInformation ugi)\n   throws IOException {\n+    if (LOGGER.isDebugEnabled()) {\n+      debugLogFileSystemClose(\"closeAllForUGI\", \"UGI: \" + ugi.toString());\n+    }\n     CACHE.closeAll(ugi);\n   }\n \n+  private static void debugLogFileSystemClose(String methodName, String additionalInfo) {\n+    StackTraceElement callingMethod = new Throwable().fillInStackTrace().getStackTrace()[2];\n+    LOGGER.debug(\n+        \"FileSystem.\" + methodName + \"() called by method: \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "721402f9c40adec731c5739834ee5cefca389f86"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b4342e2636a20e358219ba59982f3e6995e3cbf", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/2b4342e2636a20e358219ba59982f3e6995e3cbf", "committedDate": "2020-09-23T15:54:40Z", "message": "Addressed review comments and fixed some formatting issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODg0MzM0", "url": "https://github.com/apache/hadoop/pull/2321#pullrequestreview-494884334", "createdAt": "2020-09-23T17:23:33Z", "commit": {"oid": "2b4342e2636a20e358219ba59982f3e6995e3cbf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzoyMzozM1rOHW45sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzoyNTo0M1rOHW4-yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2Mjk5Mg==", "bodyText": "just use the throwable created on Line 645", "url": "https://github.com/apache/hadoop/pull/2321#discussion_r493762992", "createdAt": "2020-09-23T17:23:33Z", "author": {"login": "steveloughran"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/FileSystem.java", "diffHunk": "@@ -636,18 +636,19 @@ public static void closeAll() throws IOException {\n   public static void closeAllForUGI(UserGroupInformation ugi)\n   throws IOException {\n     if (LOGGER.isDebugEnabled()) {\n-      debugLogFileSystemClose(\"closeAllForUGI\", \"UGI: \" + ugi.toString());\n+      debugLogFileSystemClose(\"closeAllForUGI\", \"UGI: \" + ugi);\n     }\n     CACHE.closeAll(ugi);\n   }\n \n   private static void debugLogFileSystemClose(String methodName, String additionalInfo) {\n     StackTraceElement callingMethod = new Throwable().fillInStackTrace().getStackTrace()[2];\n-    LOGGER.debug(\n-        \"FileSystem.\" + methodName + \"() called by method: \"\n-            + callingMethod.getClassName() + \".\" + callingMethod.getMethodName()\n-            + \"(\" + callingMethod.getFileName() + \":\" + callingMethod.getLineNumber() + \"); \"\n-            + (additionalInfo != null ? additionalInfo : \"\"));\n+    LOGGER.debug(\"FileSystem.{}() called by method: {}.{}({}:{}); {}\", methodName, callingMethod.getClassName(),\n+            callingMethod.getMethodName(), callingMethod.getFileName(), callingMethod.getLineNumber(), additionalInfo);\n+    if (LOGGER.isTraceEnabled()) {\n+      LOGGER.trace(\"FileSystem.{}() full stack trace:\", methodName, new Throwable().fillInStackTrace());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b4342e2636a20e358219ba59982f3e6995e3cbf"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2NDI5OA==", "bodyText": "include URI of filesystem\npass in callingMethod and let it's toString() include all the information; no need to replicate -especially as toString handles file/line unknown.", "url": "https://github.com/apache/hadoop/pull/2321#discussion_r493764298", "createdAt": "2020-09-23T17:25:43Z", "author": {"login": "steveloughran"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/FileSystem.java", "diffHunk": "@@ -636,18 +636,19 @@ public static void closeAll() throws IOException {\n   public static void closeAllForUGI(UserGroupInformation ugi)\n   throws IOException {\n     if (LOGGER.isDebugEnabled()) {\n-      debugLogFileSystemClose(\"closeAllForUGI\", \"UGI: \" + ugi.toString());\n+      debugLogFileSystemClose(\"closeAllForUGI\", \"UGI: \" + ugi);\n     }\n     CACHE.closeAll(ugi);\n   }\n \n   private static void debugLogFileSystemClose(String methodName, String additionalInfo) {\n     StackTraceElement callingMethod = new Throwable().fillInStackTrace().getStackTrace()[2];\n-    LOGGER.debug(\n-        \"FileSystem.\" + methodName + \"() called by method: \"\n-            + callingMethod.getClassName() + \".\" + callingMethod.getMethodName()\n-            + \"(\" + callingMethod.getFileName() + \":\" + callingMethod.getLineNumber() + \"); \"\n-            + (additionalInfo != null ? additionalInfo : \"\"));\n+    LOGGER.debug(\"FileSystem.{}() called by method: {}.{}({}:{}); {}\", methodName, callingMethod.getClassName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b4342e2636a20e358219ba59982f3e6995e3cbf"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31cb09a6b586e7cfdb97c252be7b673ce2b89bc4", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/31cb09a6b586e7cfdb97c252be7b673ce2b89bc4", "committedDate": "2020-09-24T07:33:04Z", "message": "Addressed additional review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6f1bef27314d0215de0dd6d3f4a68687aa83f0b", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/d6f1bef27314d0215de0dd6d3f4a68687aa83f0b", "committedDate": "2020-09-24T09:52:37Z", "message": "Cosmetic fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MDM1NjE1", "url": "https://github.com/apache/hadoop/pull/2321#pullrequestreview-496035615", "createdAt": "2020-09-25T00:31:22Z", "commit": {"oid": "d6f1bef27314d0215de0dd6d3f4a68687aa83f0b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85c58340a49e98ba73edd698679ad15885d26848", "author": {"user": null}, "url": "https://github.com/apache/hadoop/commit/85c58340a49e98ba73edd698679ad15885d26848", "committedDate": "2020-09-29T08:26:30Z", "message": "Move isDebugEnabled checks to debugLogFileSystemClose"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3679, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}