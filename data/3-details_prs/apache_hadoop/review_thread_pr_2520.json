{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNDcxOTUy", "number": 2520, "reviewThreads": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjo1MTozN1rOFFbPCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOTo1NzowOVrOGO4tRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjMzNDE5OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjo1MTozN1rOIF7jAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNTowMjoxNVrOIK-psw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4OTQwOQ==", "bodyText": "This will only be used by test code ? If so, lower accessibility to private and set VisibleForTesting.", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r543089409", "createdAt": "2020-12-15T06:51:37Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -1202,6 +1287,10 @@ public String getCanonicalServiceName() {\n     return this.statistics;\n   }\n \n+  public void setListenerOperation(String operation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5b64ed6af46fca88dbe7eca9c60b318cf8728ba"}, "originalPosition": 433}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM4MzE1NQ==", "bodyText": "done", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r548383155", "createdAt": "2020-12-24T05:02:15Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -1202,6 +1287,10 @@ public String getCanonicalServiceName() {\n     return this.statistics;\n   }\n \n+  public void setListenerOperation(String operation) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4OTQwOQ=="}, "originalCommit": {"oid": "a5b64ed6af46fca88dbe7eca9c60b318cf8728ba"}, "originalPosition": 433}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjQwMzQ4OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsInputStream.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzoxMTo1MlrOIF8ICg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNTowOToxNlrOIK-vBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5ODg5MA==", "bodyText": "Same as before. Methods used by test need to be private and annotated with VisibleForTesting", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r543098890", "createdAt": "2020-12-15T07:11:52Z", "author": {"login": "snvijaya"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsInputStream.java", "diffHunk": "@@ -107,6 +122,15 @@ public String getPath() {\n     return path;\n   }\n \n+  private String getInputStreamID() {\n+    return StringUtils.right(UUID.randomUUID().toString(), STREAM_ID_LEN);\n+  }\n+\n+  public void registerListener(Listener listener1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5b64ed6af46fca88dbe7eca9c60b318cf8728ba"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM4NDUxOA==", "bodyText": "Cannot make it private since the test classes using it are in a different package. Have moved to the end of file where other VisibleForTesting methods are written (which are also public due to the same reason).", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r548384518", "createdAt": "2020-12-24T05:09:16Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsInputStream.java", "diffHunk": "@@ -107,6 +122,15 @@ public String getPath() {\n     return path;\n   }\n \n+  private String getInputStreamID() {\n+    return StringUtils.right(UUID.randomUUID().toString(), STREAM_ID_LEN);\n+  }\n+\n+  public void registerListener(Listener listener1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5ODg5MA=="}, "originalCommit": {"oid": "a5b64ed6af46fca88dbe7eca9c60b318cf8728ba"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDA5OTg2ODgxOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/ConfigurationKeys.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0wNlQwOTo1MTowMFrOJoLMsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0xN1QxMToxMzo0NFrOJvMa1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjEwNjI5MA==", "bodyText": "Can you give me the example of possible value ?\nWhat if in same jvm two FS objects are there ?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r646106290", "createdAt": "2021-06-06T09:51:00Z", "author": {"login": "surendralilhore"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/ConfigurationKeys.java", "diffHunk": "@@ -109,6 +109,12 @@\n    *  Default value of this config is true. **/\n   public static final String FS_AZURE_DISABLE_OUTPUTSTREAM_FLUSH = \"fs.azure.disable.outputstream.flush\";\n   public static final String FS_AZURE_USER_AGENT_PREFIX_KEY = \"fs.azure.user.agent.prefix\";\n+  /**\n+   * The client correlation ID provided over config that will be added to\n+   * x-ms-client-request-Id header. Defaults to empty string if the length and\n+   * character constraints are not satisfied. **/\n+  public static final String FS_AZURE_CLIENT_CORRELATIONID = \"fs.azure.client.correlationid\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0b33c151b9331b9f542aa2a94d48b1a25e14d8c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MzQ2NjMyNg==", "bodyText": "The client correlation ID can be any client-provided string within the specified length/character constraints (eg, a GUID like \"faaffc18-5a5d-426d-a259-c1a25c442898\", or a simple string such as \"correlation-id\"). If two or more filesystem instances are created using the same Configuration, or using configurations with the same value of fs.azure.client.correlationid, the identifier will be common for those objects.\nThis allows us to correlate requests across different FS and stream instances (for debugging/analysis purposes) as it is passed over a configuration. To filter among filesystem objects, we can use the unique filesystemId (GUID, generated per AzureBlobFileSystem instance)", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r653466326", "createdAt": "2021-06-17T11:13:44Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/ConfigurationKeys.java", "diffHunk": "@@ -109,6 +109,12 @@\n    *  Default value of this config is true. **/\n   public static final String FS_AZURE_DISABLE_OUTPUTSTREAM_FLUSH = \"fs.azure.disable.outputstream.flush\";\n   public static final String FS_AZURE_USER_AGENT_PREFIX_KEY = \"fs.azure.user.agent.prefix\";\n+  /**\n+   * The client correlation ID provided over config that will be added to\n+   * x-ms-client-request-Id header. Defaults to empty string if the length and\n+   * character constraints are not satisfied. **/\n+  public static final String FS_AZURE_CLIENT_CORRELATIONID = \"fs.azure.client.correlationid\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjEwNjI5MA=="}, "originalCommit": {"oid": "d0b33c151b9331b9f542aa2a94d48b1a25e14d8c"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDEzMDk4OTM5OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsInputStream.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0xNFQwOToyNjozNFrOJso5DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0xN1QxMToyMDowOFrOJvMrPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDc4NzA4NQ==", "bodyText": "Why this applicable for only stream id, not for filesystem id ? ?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r650787085", "createdAt": "2021-06-14T09:26:34Z", "author": {"login": "surendralilhore"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsInputStream.java", "diffHunk": "@@ -142,6 +156,10 @@ public String getPath() {\n     return path;\n   }\n \n+  private String getInputStreamID() {\n+    return StringUtils.right(UUID.randomUUID().toString(), STREAM_ID_LEN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0b33c151b9331b9f542aa2a94d48b1a25e14d8c"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MzQ3MDUyNQ==", "bodyText": "This was done to minimize length of header wherever possible. FilesystemId is applicable to all requests, and hence needs to be a complete GUID to ensure uniqueness. StreamId, on the other hand, appears only for a fraction of the API called (read/write), and we may not require a full GUID for it to remain unique across different streams", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r653470525", "createdAt": "2021-06-17T11:20:08Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsInputStream.java", "diffHunk": "@@ -142,6 +156,10 @@ public String getPath() {\n     return path;\n   }\n \n+  private String getInputStreamID() {\n+    return StringUtils.right(UUID.randomUUID().toString(), STREAM_ID_LEN);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDc4NzA4NQ=="}, "originalCommit": {"oid": "d0b33c151b9331b9f542aa2a94d48b1a25e14d8c"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3MzY5NTEwOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AbfsConfiguration.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxNjoyNToxOFrOJy0pNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowMzowMlrOJzt51w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzI3MTA5Mw==", "bodyText": "clientCorrelationId ?   To be similar as 'userAgentId' etc?  And the getter also", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657271093", "createdAt": "2021-06-23T16:25:18Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AbfsConfiguration.java", "diffHunk": "@@ -264,6 +266,10 @@\n       DefaultValue = DEFAULT_VALUE_UNKNOWN)\n   private String clusterType;\n \n+  @StringConfigurationValidatorAnnotation(ConfigurationKey = FS_AZURE_CLIENT_CORRELATIONID,\n+          DefaultValue = EMPTY_STRING)\n+  private String clientCorrelationID;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIwOTIzOQ==", "bodyText": "renamed", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658209239", "createdAt": "2021-06-24T19:03:02Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AbfsConfiguration.java", "diffHunk": "@@ -264,6 +266,10 @@\n       DefaultValue = DEFAULT_VALUE_UNKNOWN)\n   private String clusterType;\n \n+  @StringConfigurationValidatorAnnotation(ConfigurationKey = FS_AZURE_CLIENT_CORRELATIONID,\n+          DefaultValue = EMPTY_STRING)\n+  private String clientCorrelationID;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzI3MTA5Mw=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3MzczMjcwOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxNjozMjozOVrOJy1AHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowMzo0OFrOJzt7cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzI3Njk1OQ==", "bodyText": "All places ID to Id?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657276959", "createdAt": "2021-06-23T16:32:39Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -111,10 +116,14 @@\n   private Path workingDir;\n   private AzureBlobFileSystemStore abfsStore;\n   private boolean isClosed;\n+  private final String fileSystemID = UUID.randomUUID().toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIwOTY1MQ==", "bodyText": "yes, done", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658209651", "createdAt": "2021-06-24T19:03:48Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -111,10 +116,14 @@\n   private Path workingDir;\n   private AzureBlobFileSystemStore abfsStore;\n   private boolean isClosed;\n+  private final String fileSystemID = UUID.randomUUID().toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzI3Njk1OQ=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3NDEyNzU1OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxODowMDowOVrOJy41ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowNToyN1rOJzt-_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzMzOTgzNA==", "bodyText": "Here is a call to getFileStatus(Path) but as part of LISTSTATUS op.  So we should the context created above , during getFileStatus also right?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657339834", "createdAt": "2021-06-23T18:00:09Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -1049,8 +1130,11 @@ public boolean exists(Path f) throws IOException {\n       throws IOException {\n     LOG.debug(\"AzureBlobFileSystem.listStatusIterator path : {}\", path);\n     if (abfsStore.getAbfsConfiguration().enableAbfsListIterator()) {\n+      TracingContext tracingContext = new TracingContext(clientCorrelationID,\n+          fileSystemID, HdfsOperationConstants.LISTSTATUS, true,\n+          tracingContextFormat, listener);\n       AbfsListStatusRemoteIterator abfsLsItr =\n-          new AbfsListStatusRemoteIterator(getFileStatus(path), abfsStore);\n+          new AbfsListStatusRemoteIterator(getFileStatus(path), abfsStore, tracingContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 419}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIxMDU1Ng==", "bodyText": "modified getFileStatus to take tracingContext arg", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658210556", "createdAt": "2021-06-24T19:05:27Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -1049,8 +1130,11 @@ public boolean exists(Path f) throws IOException {\n       throws IOException {\n     LOG.debug(\"AzureBlobFileSystem.listStatusIterator path : {}\", path);\n     if (abfsStore.getAbfsConfiguration().enableAbfsListIterator()) {\n+      TracingContext tracingContext = new TracingContext(clientCorrelationID,\n+          fileSystemID, HdfsOperationConstants.LISTSTATUS, true,\n+          tracingContextFormat, listener);\n       AbfsListStatusRemoteIterator abfsLsItr =\n-          new AbfsListStatusRemoteIterator(getFileStatus(path), abfsStore);\n+          new AbfsListStatusRemoteIterator(getFileStatus(path), abfsStore, tracingContext);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzMzOTgzNA=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 419}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3NDEzODA2OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxODowMjo1NVrOJy48ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowNjo1NlrOJzuCDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM0MTU3OA==", "bodyText": "Even this call to FileSystem#listStatusIterator() will create ADL gen2  calls right?  So should there be way for having a single context(above created) to be used for call from there too?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657341578", "createdAt": "2021-06-23T18:02:55Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -1049,8 +1130,11 @@ public boolean exists(Path f) throws IOException {\n       throws IOException {\n     LOG.debug(\"AzureBlobFileSystem.listStatusIterator path : {}\", path);\n     if (abfsStore.getAbfsConfiguration().enableAbfsListIterator()) {\n+      TracingContext tracingContext = new TracingContext(clientCorrelationID,\n+          fileSystemID, HdfsOperationConstants.LISTSTATUS, true,\n+          tracingContextFormat, listener);\n       AbfsListStatusRemoteIterator abfsLsItr =\n-          new AbfsListStatusRemoteIterator(getFileStatus(path), abfsStore);\n+          new AbfsListStatusRemoteIterator(getFileStatus(path), abfsStore, tracingContext);\n       return RemoteIterators.typeCastingRemoteIterator(abfsLsItr);\n     } else {\n       return super.listStatusIterator(path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 422}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIxMTM0MQ==", "bodyText": "the else block eventually calls ABFS liststatus method, which generates its own context. It is equivalent to generating and passing object from here as there is no action (request) before/after the super method call", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658211341", "createdAt": "2021-06-24T19:06:56Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -1049,8 +1130,11 @@ public boolean exists(Path f) throws IOException {\n       throws IOException {\n     LOG.debug(\"AzureBlobFileSystem.listStatusIterator path : {}\", path);\n     if (abfsStore.getAbfsConfiguration().enableAbfsListIterator()) {\n+      TracingContext tracingContext = new TracingContext(clientCorrelationID,\n+          fileSystemID, HdfsOperationConstants.LISTSTATUS, true,\n+          tracingContextFormat, listener);\n       AbfsListStatusRemoteIterator abfsLsItr =\n-          new AbfsListStatusRemoteIterator(getFileStatus(path), abfsStore);\n+          new AbfsListStatusRemoteIterator(getFileStatus(path), abfsStore, tracingContext);\n       return RemoteIterators.typeCastingRemoteIterator(abfsLsItr);\n     } else {\n       return super.listStatusIterator(path);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM0MTU3OA=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 422}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3NDE1OTkyOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxODowNzowOFrOJy5KAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowNzozN1rOJzuDgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM0NTAyNw==", "bodyText": "Within tryGetFileStatus() there is call to getFileStatus.  We should be using this context created here.\ntryGetFileStatus() been called by createNonRecursive API also.\nHave to handle these.", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657345027", "createdAt": "2021-06-23T18:07:08Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -335,7 +361,10 @@ public boolean rename(final Path src, final Path dst) throws IOException {\n     }\n \n     // Non-HNS account need to check dst status on driver side.\n-    if (!abfsStore.getIsNamespaceEnabled() && dstFileStatus == null) {\n+    TracingContext tracingContext = new TracingContext(clientCorrelationID,\n+        fileSystemID, HdfsOperationConstants.RENAME, true, tracingContextFormat,\n+        listener);\n+    if (!abfsStore.getIsNamespaceEnabled(tracingContext) && dstFileStatus == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIxMTcxNQ==", "bodyText": "refactored the getFileStatus methods in AzureBlobFileSystem class to accommodate these. Changes done:\n\noverload getFileStatus to use context passed by other methods\ntryGetFileStatus to take context as arg\npvt method createFileSystem signature change to avoid overloading tryGetFileStatus", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658211715", "createdAt": "2021-06-24T19:07:37Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -335,7 +361,10 @@ public boolean rename(final Path src, final Path dst) throws IOException {\n     }\n \n     // Non-HNS account need to check dst status on driver side.\n-    if (!abfsStore.getIsNamespaceEnabled() && dstFileStatus == null) {\n+    TracingContext tracingContext = new TracingContext(clientCorrelationID,\n+        fileSystemID, HdfsOperationConstants.RENAME, true, tracingContextFormat,\n+        listener);\n+    if (!abfsStore.getIsNamespaceEnabled(tracingContext) && dstFileStatus == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM0NTAyNw=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3NDE2NzY4OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxODowODoyMlrOJy5PHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowODozMlrOJzuF5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM0NjMzMg==", "bodyText": "GET_FILESTATUS op?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657346332", "createdAt": "2021-06-23T18:08:22Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -1071,7 +1155,10 @@ private boolean fileSystemExists() throws IOException {\n     LOG.debug(\n             \"AzureBlobFileSystem.fileSystemExists uri: {}\", uri);\n     try {\n-      abfsStore.getFilesystemProperties();\n+      TracingContext tracingContext = new TracingContext(clientCorrelationID,\n+          fileSystemID, HdfsOperationConstants.GET_FILESTATUS,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 429}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIxMjMyNA==", "bodyText": "This is a private method that does not implement any Hadoop function, and is never used in the Driver. However, we need to pass in a dummy tracing object for syntax. Modified to use test operation type", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658212324", "createdAt": "2021-06-24T19:08:32Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -1071,7 +1155,10 @@ private boolean fileSystemExists() throws IOException {\n     LOG.debug(\n             \"AzureBlobFileSystem.fileSystemExists uri: {}\", uri);\n     try {\n-      abfsStore.getFilesystemProperties();\n+      TracingContext tracingContext = new TracingContext(clientCorrelationID,\n+          fileSystemID, HdfsOperationConstants.GET_FILESTATUS,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM0NjMzMg=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 429}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3NDE3NTAzOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxODowOToyNlrOJy5Tog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowODo1NFrOJzuGpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM0NzQ5MA==", "bodyText": "What is this operation been set on Listener?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657347490", "createdAt": "2021-06-23T18:09:26Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -1283,6 +1373,11 @@ public String getCanonicalServiceName() {\n     return this.statistics;\n   }\n \n+  @VisibleForTesting\n+  void setListenerOperation(String operation) {\n+    listener.setOperation(operation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 453}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIxMjUxOQ==", "bodyText": "this is to reset and verify the 2-letter operation type (along with other IDs) when header tests are triggered using callback after header construction", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658212519", "createdAt": "2021-06-24T19:08:54Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/AzureBlobFileSystem.java", "diffHunk": "@@ -1283,6 +1373,11 @@ public String getCanonicalServiceName() {\n     return this.statistics;\n   }\n \n+  @VisibleForTesting\n+  void setListenerOperation(String operation) {\n+    listener.setOperation(operation);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM0NzQ5MA=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 453}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3NDIyNTIyOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/ConfigurationKeys.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxODoxNjo1OVrOJy5ztw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowODo1OVrOJzuGyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM1NTcwMw==", "bodyText": "This is the tracing header format right?  Will that be a better name?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657355703", "createdAt": "2021-06-23T18:16:59Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/ConfigurationKeys.java", "diffHunk": "@@ -109,6 +109,12 @@\n    *  Default value of this config is true. **/\n   public static final String FS_AZURE_DISABLE_OUTPUTSTREAM_FLUSH = \"fs.azure.disable.outputstream.flush\";\n   public static final String FS_AZURE_USER_AGENT_PREFIX_KEY = \"fs.azure.user.agent.prefix\";\n+  /**\n+   * The client correlation ID provided over config that will be added to\n+   * x-ms-client-request-Id header. Defaults to empty string if the length and\n+   * character constraints are not satisfied. **/\n+  public static final String FS_AZURE_CLIENT_CORRELATIONID = \"fs.azure.client.correlationid\";\n+  public static final String FS_AZURE_TRACINGCONTEXT_FORMAT = \"fs.azure.tracingcontext.format\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIxMjU1Mw==", "bodyText": "Yes, renamed", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658212553", "createdAt": "2021-06-24T19:08:59Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/ConfigurationKeys.java", "diffHunk": "@@ -109,6 +109,12 @@\n    *  Default value of this config is true. **/\n   public static final String FS_AZURE_DISABLE_OUTPUTSTREAM_FLUSH = \"fs.azure.disable.outputstream.flush\";\n   public static final String FS_AZURE_USER_AGENT_PREFIX_KEY = \"fs.azure.user.agent.prefix\";\n+  /**\n+   * The client correlation ID provided over config that will be added to\n+   * x-ms-client-request-Id header. Defaults to empty string if the length and\n+   * character constraints are not satisfied. **/\n+  public static final String FS_AZURE_CLIENT_CORRELATIONID = \"fs.azure.client.correlationid\";\n+  public static final String FS_AZURE_TRACINGCONTEXT_FORMAT = \"fs.azure.tracingcontext.format\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM1NTcwMw=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3NDI0OTk4OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/HdfsOperationConstants.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxODoyMTo1MVrOJy6DqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowOToxNFrOJzuHWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM1OTc4NA==", "bodyText": "Can be Enum?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657359784", "createdAt": "2021-06-23T18:21:51Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/HdfsOperationConstants.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.constants;\n+\n+public final class HdfsOperationConstants {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzY0MDA3MA==", "bodyText": "Can we avoid the hdfs in this ?  Its after all Hadoop common FS API types", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657640070", "createdAt": "2021-06-24T05:38:43Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/HdfsOperationConstants.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.constants;\n+\n+public final class HdfsOperationConstants {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM1OTc4NA=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIxMjY5Ng==", "bodyText": "switched to enum; renamed class to FSOperationType", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658212696", "createdAt": "2021-06-24T19:09:14Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/constants/HdfsOperationConstants.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.constants;\n+\n+public final class HdfsOperationConstants {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM1OTc4NA=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3NDI3NzM3OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsHttpOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxODoyODoyOFrOJy6Utg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowOToyM1rOJzuHqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM2NDE1MA==", "bodyText": "Only used for tests?  Should be returning List only?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657364150", "createdAt": "2021-06-23T18:28:28Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsHttpOperation.java", "diffHunk": "@@ -166,6 +166,11 @@ public String getResponseHeader(String httpHeader) {\n     return connection.getHeaderField(httpHeader);\n   }\n \n+  @VisibleForTesting\n+  public String getRequestHeader(String httpHeader) {\n+    return connection.getRequestProperties().get(httpHeader).toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIxMjc3OA==", "bodyText": "method not required, removed", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658212778", "createdAt": "2021-06-24T19:09:23Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsHttpOperation.java", "diffHunk": "@@ -166,6 +166,11 @@ public String getResponseHeader(String httpHeader) {\n     return connection.getHeaderField(httpHeader);\n   }\n \n+  @VisibleForTesting\n+  public String getRequestHeader(String httpHeader) {\n+    return connection.getRequestProperties().get(httpHeader).toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM2NDE1MA=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3NDMwNDUxOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxODozNDo0NVrOJy6lOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowOTozOVrOJzuIXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM2ODM3OA==", "bodyText": "Can avoid this way of explicit call which for sure should get executed before setting of this header.\nCan we have a better method name than toString() for generation of required header value?  This has to consider the format and generate.", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657368378", "createdAt": "2021-06-23T18:34:45Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "diffHunk": "@@ -221,17 +226,27 @@ private void completeExecute() throws AzureBlobFileSystemException {\n     LOG.trace(\"{} REST operation complete\", operationType);\n   }\n \n+  private void updateClientRequestHeader(AbfsHttpOperation httpOperation,\n+      TracingContext tracingContext) {\n+    tracingContext.generateClientRequestID();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIxMjk1Nw==", "bodyText": "Generating the clientRequestId in the toString() method of tracingContext is not a good option as it will re-generate it every time the method is called. Also, we need tracingContext to store the id for consistency\nHave renamed toString to constructHeader. Format is passed over config and already available to tracingContext object", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658212957", "createdAt": "2021-06-24T19:09:39Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "diffHunk": "@@ -221,17 +226,27 @@ private void completeExecute() throws AzureBlobFileSystemException {\n     LOG.trace(\"{} REST operation complete\", operationType);\n   }\n \n+  private void updateClientRequestHeader(AbfsHttpOperation httpOperation,\n+      TracingContext tracingContext) {\n+    tracingContext.generateClientRequestID();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM2ODM3OA=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE3NDM0OTgwOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsInputStream.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yM1QxODo0NTo1MFrOJy7BIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNFQxOTowOTo1MVrOJzuI0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM3NTUyMw==", "bodyText": "Why passing 'tracingContext' when its set as instance member?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r657375523", "createdAt": "2021-06-23T18:45:50Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsInputStream.java", "diffHunk": "@@ -451,15 +472,15 @@ private int readInternal(final long position, final byte[] b, final int offset,\n       }\n \n       // got nothing from read-ahead, do our own read now\n-      receivedBytes = readRemote(position, b, offset, length);\n+      receivedBytes = readRemote(position, b, offset, length, new TracingContext(tracingContext));\n       return receivedBytes;\n     } else {\n       LOG.debug(\"read ahead disabled, reading remote\");\n-      return readRemote(position, b, offset, length);\n+      return readRemote(position, b, offset, length, new TracingContext(tracingContext));\n     }\n   }\n \n-  int readRemote(long position, byte[] b, int offset, int length) throws IOException {\n+  int readRemote(long position, byte[] b, int offset, int length, TracingContext tracingContext) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODIxMzA3NA==", "bodyText": "The readRemote function is also used by the readahead worker threads (in ReadBufferWorker). The tracingContext passed from the readahead buffers may correspond to independent read requests", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658213074", "createdAt": "2021-06-24T19:09:51Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsInputStream.java", "diffHunk": "@@ -451,15 +472,15 @@ private int readInternal(final long position, final byte[] b, final int offset,\n       }\n \n       // got nothing from read-ahead, do our own read now\n-      receivedBytes = readRemote(position, b, offset, length);\n+      receivedBytes = readRemote(position, b, offset, length, new TracingContext(tracingContext));\n       return receivedBytes;\n     } else {\n       LOG.debug(\"read ahead disabled, reading remote\");\n-      return readRemote(position, b, offset, length);\n+      return readRemote(position, b, offset, length, new TracingContext(tracingContext));\n     }\n   }\n \n-  int readRemote(long position, byte[] b, int offset, int length) throws IOException {\n+  int readRemote(long position, byte[] b, int offset, int length, TracingContext tracingContext) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzM3NTUyMw=="}, "originalCommit": {"oid": "6250d04f25d1efed187a0835e70f53415f0e1378"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjQyMDU2OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsLease.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOTowNzoxMFrOJ0Glag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOFQyMDowOTo1MlrOJ1gUxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxMzYxMA==", "bodyText": "This clone of Context needed here?  What gets changed?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658613610", "createdAt": "2021-06-25T09:07:10Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsLease.java", "diffHunk": "@@ -114,13 +119,15 @@ public AbfsLease(AbfsClient client, String path, int acquireMaxRetries,\n     LOG.debug(\"Acquired lease {} on {}\", leaseID, path);\n   }\n \n-  private void acquireLease(RetryPolicy retryPolicy, int numRetries, int retryInterval, long delay)\n+  private void acquireLease(RetryPolicy retryPolicy, int numRetries,\n+      int retryInterval, long delay)\n       throws LeaseException {\n     LOG.debug(\"Attempting to acquire lease on {}, retry {}\", path, numRetries);\n     if (future != null && !future.isDone()) {\n       throw new LeaseException(ERR_LEASE_FUTURE_EXISTS);\n     }\n-    future = client.schedule(() -> client.acquireLease(path, INFINITE_LEASE_DURATION),\n+    future = client.schedule(() -> client.acquireLease(path,\n+        INFINITE_LEASE_DURATION, new TracingContext(tracingContext)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA4MzkwOQ==", "bodyText": "not needed; moved to calling method (constructor) where it is cloned only once, instead of per retry", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r660083909", "createdAt": "2021-06-28T20:09:52Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsLease.java", "diffHunk": "@@ -114,13 +119,15 @@ public AbfsLease(AbfsClient client, String path, int acquireMaxRetries,\n     LOG.debug(\"Acquired lease {} on {}\", leaseID, path);\n   }\n \n-  private void acquireLease(RetryPolicy retryPolicy, int numRetries, int retryInterval, long delay)\n+  private void acquireLease(RetryPolicy retryPolicy, int numRetries,\n+      int retryInterval, long delay)\n       throws LeaseException {\n     LOG.debug(\"Attempting to acquire lease on {}, retry {}\", path, numRetries);\n     if (future != null && !future.isDone()) {\n       throw new LeaseException(ERR_LEASE_FUTURE_EXISTS);\n     }\n-    future = client.schedule(() -> client.acquireLease(path, INFINITE_LEASE_DURATION),\n+    future = client.schedule(() -> client.acquireLease(path,\n+        INFINITE_LEASE_DURATION, new TracingContext(tracingContext)),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxMzYxMA=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjQzMjI3OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsOutputStream.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOToxMDowOFrOJ0GszQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOFQyMDowOTo1OVrOJ1gVBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxNTUwMQ==", "bodyText": "getOutputStreamId() and getStreamID() -> Both create some confusion.  Normally the Getter just return a already available value.  getStreamID() make sense.\nYou can use createOutputStreamId() instead?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658615501", "createdAt": "2021-06-25T09:10:08Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsOutputStream.java", "diffHunk": "@@ -160,6 +170,14 @@ public AbfsOutputStream(\n     if (outputStreamStatistics != null) {\n       this.ioStatistics = outputStreamStatistics.getIOStatistics();\n     }\n+    this.outputStreamId = getOutputStreamId();\n+    this.tracingContext = new TracingContext(tracingContext);\n+    this.tracingContext.setStreamID(outputStreamId);\n+    this.tracingContext.setOperation(FSOperationType.WRITE);\n+  }\n+\n+  private String getOutputStreamId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxNTY5NA==", "bodyText": "The same thing in ABFSInputStream also", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658615694", "createdAt": "2021-06-25T09:10:23Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsOutputStream.java", "diffHunk": "@@ -160,6 +170,14 @@ public AbfsOutputStream(\n     if (outputStreamStatistics != null) {\n       this.ioStatistics = outputStreamStatistics.getIOStatistics();\n     }\n+    this.outputStreamId = getOutputStreamId();\n+    this.tracingContext = new TracingContext(tracingContext);\n+    this.tracingContext.setStreamID(outputStreamId);\n+    this.tracingContext.setOperation(FSOperationType.WRITE);\n+  }\n+\n+  private String getOutputStreamId() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxNTUwMQ=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA4Mzk3NA==", "bodyText": "done", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r660083974", "createdAt": "2021-06-28T20:09:59Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsOutputStream.java", "diffHunk": "@@ -160,6 +170,14 @@ public AbfsOutputStream(\n     if (outputStreamStatistics != null) {\n       this.ioStatistics = outputStreamStatistics.getIOStatistics();\n     }\n+    this.outputStreamId = getOutputStreamId();\n+    this.tracingContext = new TracingContext(tracingContext);\n+    this.tracingContext.setStreamID(outputStreamId);\n+    this.tracingContext.setOperation(FSOperationType.WRITE);\n+  }\n+\n+  private String getOutputStreamId() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxNTUwMQ=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjQzNzcwOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsOutputStream.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOToxMToyMlrOJ0GwEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOFQyMDoxMDowMlrOJ1gVJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxNjMzNw==", "bodyText": "Ok the context been passed here might get changed at least wrt the retryCount.  that is why been cloned here?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658616337", "createdAt": "2021-06-25T09:11:22Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsOutputStream.java", "diffHunk": "@@ -385,7 +412,9 @@ private void writeAppendBlobCurrentBufferToService() throws IOException {\n             \"writeCurrentBufferToService\", \"append\")) {\n       AppendRequestParameters reqParams = new AppendRequestParameters(offset, 0,\n           bytesLength, APPEND_MODE, true, leaseId);\n-      AbfsRestOperation op = client.append(path, bytes, reqParams, cachedSasToken.get());\n+      AbfsRestOperation op = client\n+          .append(path, bytes, reqParams, cachedSasToken.get(),\n+              new TracingContext(tracingContext));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA4NDAwNA==", "bodyText": "yes", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r660084004", "createdAt": "2021-06-28T20:10:02Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsOutputStream.java", "diffHunk": "@@ -385,7 +412,9 @@ private void writeAppendBlobCurrentBufferToService() throws IOException {\n             \"writeCurrentBufferToService\", \"append\")) {\n       AppendRequestParameters reqParams = new AppendRequestParameters(offset, 0,\n           bytesLength, APPEND_MODE, true, leaseId);\n-      AbfsRestOperation op = client.append(path, bytes, reqParams, cachedSasToken.get());\n+      AbfsRestOperation op = client\n+          .append(path, bytes, reqParams, cachedSasToken.get(),\n+              new TracingContext(tracingContext));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxNjMzNw=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjQzOTkyOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOToxMTo1NFrOJ0Gxcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOToxMTo1NFrOJ0Gxcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxNjY5MA==", "bodyText": "Yaaa here.", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658616690", "createdAt": "2021-06-25T09:11:54Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "diffHunk": "@@ -202,9 +206,10 @@ private void completeExecute() throws AzureBlobFileSystemException {\n \n     retryCount = 0;\n     LOG.debug(\"First execution of REST operation - {}\", operationType);\n-    while (!executeHttpOperation(retryCount)) {\n+    while (!executeHttpOperation(retryCount, tracingContext)) {\n       try {\n         ++retryCount;\n+        tracingContext.setRetryCount(retryCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjQ0OTY4OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOToxNDoyMVrOJ0G3eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOFQyMDoxMDoyN1rOJ1gWCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxODIzMg==", "bodyText": "generateClientRequestId() can be done internally within constructHeader()?  Else its upto callee to set it proper before.  Actually the UUID clientReqId generation should be an internal responsibility of this tracingContext right?\nAll other methods are like setter.", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658618232", "createdAt": "2021-06-25T09:14:21Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "diffHunk": "@@ -221,17 +226,27 @@ private void completeExecute() throws AzureBlobFileSystemException {\n     LOG.trace(\"{} REST operation complete\", operationType);\n   }\n \n+  private void updateClientRequestHeader(AbfsHttpOperation httpOperation,\n+      TracingContext tracingContext) {\n+    tracingContext.generateClientRequestId();\n+    httpOperation.getConnection()\n+        .setRequestProperty(HttpHeaderConfigurations.X_MS_CLIENT_REQUEST_ID,\n+            tracingContext.constructHeader());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA4NDIzMw==", "bodyText": "constructHeader() may be called simply to display IDs, in which case it should not regenerate new clientReqId each time\ncallee setting it would mean adding code to all methods to call this, and retry case would not be handled\nCan be done internally within TC: have a generateClientRequestId function to create guid, and call it in constructor as well as the setRetryCount which is invoked per retry. However, had avoided this since we are populating ID variables only as and when they pass through the corresponding ABFS layers.", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r660084233", "createdAt": "2021-06-28T20:10:27Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "diffHunk": "@@ -221,17 +226,27 @@ private void completeExecute() throws AzureBlobFileSystemException {\n     LOG.trace(\"{} REST operation complete\", operationType);\n   }\n \n+  private void updateClientRequestHeader(AbfsHttpOperation httpOperation,\n+      TracingContext tracingContext) {\n+    tracingContext.generateClientRequestId();\n+    httpOperation.getConnection()\n+        .setRequestProperty(HttpHeaderConfigurations.X_MS_CLIENT_REQUEST_ID,\n+            tracingContext.constructHeader());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxODIzMg=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjQ1MzcwOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOToxNToxN1rOJ0G53w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOFQyMDoxMDozNFrOJ1gWUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxODg0Nw==", "bodyText": "Its actually a fresh AbfsHttpOperation operation and here by we set the header.  Can we call it setXXX  than updateXXX?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658618847", "createdAt": "2021-06-25T09:15:17Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "diffHunk": "@@ -221,17 +226,27 @@ private void completeExecute() throws AzureBlobFileSystemException {\n     LOG.trace(\"{} REST operation complete\", operationType);\n   }\n \n+  private void updateClientRequestHeader(AbfsHttpOperation httpOperation,\n+      TracingContext tracingContext) {\n+    tracingContext.generateClientRequestId();\n+    httpOperation.getConnection()\n+        .setRequestProperty(HttpHeaderConfigurations.X_MS_CLIENT_REQUEST_ID,\n+            tracingContext.constructHeader());\n+  }\n+\n   /**\n    * Executes a single HTTP operation to complete the REST operation.  If it\n    * fails, there may be a retry.  The retryCount is incremented with each\n    * attempt.\n    */\n-  private boolean executeHttpOperation(final int retryCount) throws AzureBlobFileSystemException {\n+  private boolean executeHttpOperation(final int retryCount,\n+    TracingContext tracingContext) throws AzureBlobFileSystemException {\n     AbfsHttpOperation httpOperation = null;\n     try {\n       // initialize the HTTP request and open the connection\n       httpOperation = new AbfsHttpOperation(url, method, requestHeaders);\n       incrementCounter(AbfsStatistic.CONNECTIONS_MADE, 1);\n+      updateClientRequestHeader(httpOperation, tracingContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA4NDMwNQ==", "bodyText": "done", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r660084305", "createdAt": "2021-06-28T20:10:34Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/services/AbfsRestOperation.java", "diffHunk": "@@ -221,17 +226,27 @@ private void completeExecute() throws AzureBlobFileSystemException {\n     LOG.trace(\"{} REST operation complete\", operationType);\n   }\n \n+  private void updateClientRequestHeader(AbfsHttpOperation httpOperation,\n+      TracingContext tracingContext) {\n+    tracingContext.generateClientRequestId();\n+    httpOperation.getConnection()\n+        .setRequestProperty(HttpHeaderConfigurations.X_MS_CLIENT_REQUEST_ID,\n+            tracingContext.constructHeader());\n+  }\n+\n   /**\n    * Executes a single HTTP operation to complete the REST operation.  If it\n    * fails, there may be a retry.  The retryCount is incremented with each\n    * attempt.\n    */\n-  private boolean executeHttpOperation(final int retryCount) throws AzureBlobFileSystemException {\n+  private boolean executeHttpOperation(final int retryCount,\n+    TracingContext tracingContext) throws AzureBlobFileSystemException {\n     AbfsHttpOperation httpOperation = null;\n     try {\n       // initialize the HTTP request and open the connection\n       httpOperation = new AbfsHttpOperation(url, method, requestHeaders);\n       incrementCounter(AbfsStatistic.CONNECTIONS_MADE, 1);\n+      updateClientRequestHeader(httpOperation, tracingContext);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxODg0Nw=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjQ2MDk4OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/Listener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOToxNzoxMFrOJ0G-iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOFQyMDoxMDo0NVrOJ1gWwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYyMDA0MQ==", "bodyText": "This is for testability only?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658620041", "createdAt": "2021-06-25T09:17:10Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/Listener.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import org.apache.hadoop.fs.azurebfs.constants.FSOperationType;\n+\n+/**\n+ * Interface for testing identifiers tracked via TracingContext\n+ * Implemented in TracingHeaderValidator\n+ */\n+\n+public interface Listener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA4NDQxNg==", "bodyText": "yes, it's an interface to trigger header tests through callback when header is constructed. The tests are run only when listener is registered (not null), which is done across existing tests for different methods", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r660084416", "createdAt": "2021-06-28T20:10:45Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/Listener.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import org.apache.hadoop.fs.azurebfs.constants.FSOperationType;\n+\n+/**\n+ * Interface for testing identifiers tracked via TracingContext\n+ * Implemented in TracingHeaderValidator\n+ */\n+\n+public interface Listener {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYyMDA0MQ=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjUyODI4OnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOTozNDowM1rOJ0Hnyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOFQyMDoxMDo1NlrOJ1gXMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYzMDYwMg==", "bodyText": "primaryRequestID will be used in case of Read ahead?  Worth adding come comments about its use here", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658630602", "createdAt": "2021-06-25T09:34:03Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.util.UUID;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.hadoop.fs.azurebfs.constants.FSOperationType;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.EMPTY_STRING;\n+\n+/**\n+ * The TracingContext class to correlate Store requests using unique\n+ * identifiers and resources common to requests (e.g. filesystem, stream)\n+ *\n+ * Implementing new HDFS method:\n+ * Create TracingContext instance in method of outer layer of\n+ * ABFS driver (AzureBlobFileSystem/AbfsInputStream/AbfsOutputStream), to be\n+ * passed through ABFS layers up to AbfsRestOperation.\n+ *\n+ * Add new operations to HdfsOperationConstants file.\n+ *\n+ * PrimaryRequestId can be enabled for individual HDFS API that invoke\n+ * multiple Store calls.\n+ *\n+ * Testing:\n+ * Pass an instance of TracingHeaderValidator to registerListener() of ABFS\n+ * filesystem/stream class before calling the API in tests.\n+ */\n+\n+public class TracingContext {\n+  private final String clientCorrelationID;\n+  private final String fileSystemID;\n+  private String clientRequestId = EMPTY_STRING;\n+  private String primaryRequestID;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA4NDUzMA==", "bodyText": "primaryRequestId is applicable for any method call that triggers more than one http request. For example, methods using continuation logic like listStatus and rename\nHave added comments explaining use of tracingContext and its members at the beginning of file", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r660084530", "createdAt": "2021-06-28T20:10:56Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.util.UUID;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.hadoop.fs.azurebfs.constants.FSOperationType;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.EMPTY_STRING;\n+\n+/**\n+ * The TracingContext class to correlate Store requests using unique\n+ * identifiers and resources common to requests (e.g. filesystem, stream)\n+ *\n+ * Implementing new HDFS method:\n+ * Create TracingContext instance in method of outer layer of\n+ * ABFS driver (AzureBlobFileSystem/AbfsInputStream/AbfsOutputStream), to be\n+ * passed through ABFS layers up to AbfsRestOperation.\n+ *\n+ * Add new operations to HdfsOperationConstants file.\n+ *\n+ * PrimaryRequestId can be enabled for individual HDFS API that invoke\n+ * multiple Store calls.\n+ *\n+ * Testing:\n+ * Pass an instance of TracingHeaderValidator to registerListener() of ABFS\n+ * filesystem/stream class before calling the API in tests.\n+ */\n+\n+public class TracingContext {\n+  private final String clientCorrelationID;\n+  private final String fileSystemID;\n+  private String clientRequestId = EMPTY_STRING;\n+  private String primaryRequestID;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYzMDYwMg=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjUzMTkzOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOTozNDo1MlrOJ0Hp2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOFQyMDoxMTowMVrOJ1gXaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYzMTEzMQ==", "bodyText": "call it opType only?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658631131", "createdAt": "2021-06-25T09:34:52Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.util.UUID;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.hadoop.fs.azurebfs.constants.FSOperationType;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.EMPTY_STRING;\n+\n+/**\n+ * The TracingContext class to correlate Store requests using unique\n+ * identifiers and resources common to requests (e.g. filesystem, stream)\n+ *\n+ * Implementing new HDFS method:\n+ * Create TracingContext instance in method of outer layer of\n+ * ABFS driver (AzureBlobFileSystem/AbfsInputStream/AbfsOutputStream), to be\n+ * passed through ABFS layers up to AbfsRestOperation.\n+ *\n+ * Add new operations to HdfsOperationConstants file.\n+ *\n+ * PrimaryRequestId can be enabled for individual HDFS API that invoke\n+ * multiple Store calls.\n+ *\n+ * Testing:\n+ * Pass an instance of TracingHeaderValidator to registerListener() of ABFS\n+ * filesystem/stream class before calling the API in tests.\n+ */\n+\n+public class TracingContext {\n+  private final String clientCorrelationID;\n+  private final String fileSystemID;\n+  private String clientRequestId = EMPTY_STRING;\n+  private String primaryRequestID;\n+  private String streamID;\n+  private int retryCount;\n+  private FSOperationType hadoopOpName;\n+  private final TracingHeaderFormat format;\n+  private Listener listener = null;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AbfsClient.class);\n+  public static final int MAX_CLIENT_CORRELATION_ID_LENGTH = 72;\n+  public static final String CLIENT_CORRELATION_ID_PATTERN = \"[a-zA-Z0-9-]*\";\n+\n+  /**\n+   * Initialize TracingContext\n+   * @param clientCorrelationID Provided over config by client\n+   * @param fileSystemID Unique guid for AzureBlobFileSystem instance\n+   * @param hadoopOpName Code indicating the high-level Hadoop operation that\n+   *                    triggered the current Store request\n+   * @param tracingHeaderFormat Format of IDs to be printed in header and logs\n+   * @param listener Holds instance of TracingHeaderValidator during testing,\n+   *                null otherwise\n+   */\n+  public TracingContext(String clientCorrelationID, String fileSystemID,\n+      FSOperationType hadoopOpName, TracingHeaderFormat tracingHeaderFormat,\n+      Listener listener) {\n+    this.fileSystemID = fileSystemID;\n+    this.hadoopOpName = hadoopOpName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA4NDU4NA==", "bodyText": "done", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r660084584", "createdAt": "2021-06-28T20:11:01Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.util.UUID;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.hadoop.fs.azurebfs.constants.FSOperationType;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.EMPTY_STRING;\n+\n+/**\n+ * The TracingContext class to correlate Store requests using unique\n+ * identifiers and resources common to requests (e.g. filesystem, stream)\n+ *\n+ * Implementing new HDFS method:\n+ * Create TracingContext instance in method of outer layer of\n+ * ABFS driver (AzureBlobFileSystem/AbfsInputStream/AbfsOutputStream), to be\n+ * passed through ABFS layers up to AbfsRestOperation.\n+ *\n+ * Add new operations to HdfsOperationConstants file.\n+ *\n+ * PrimaryRequestId can be enabled for individual HDFS API that invoke\n+ * multiple Store calls.\n+ *\n+ * Testing:\n+ * Pass an instance of TracingHeaderValidator to registerListener() of ABFS\n+ * filesystem/stream class before calling the API in tests.\n+ */\n+\n+public class TracingContext {\n+  private final String clientCorrelationID;\n+  private final String fileSystemID;\n+  private String clientRequestId = EMPTY_STRING;\n+  private String primaryRequestID;\n+  private String streamID;\n+  private int retryCount;\n+  private FSOperationType hadoopOpName;\n+  private final TracingHeaderFormat format;\n+  private Listener listener = null;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AbfsClient.class);\n+  public static final int MAX_CLIENT_CORRELATION_ID_LENGTH = 72;\n+  public static final String CLIENT_CORRELATION_ID_PATTERN = \"[a-zA-Z0-9-]*\";\n+\n+  /**\n+   * Initialize TracingContext\n+   * @param clientCorrelationID Provided over config by client\n+   * @param fileSystemID Unique guid for AzureBlobFileSystem instance\n+   * @param hadoopOpName Code indicating the high-level Hadoop operation that\n+   *                    triggered the current Store request\n+   * @param tracingHeaderFormat Format of IDs to be printed in header and logs\n+   * @param listener Holds instance of TracingHeaderValidator during testing,\n+   *                null otherwise\n+   */\n+  public TracingContext(String clientCorrelationID, String fileSystemID,\n+      FSOperationType hadoopOpName, TracingHeaderFormat tracingHeaderFormat,\n+      Listener listener) {\n+    this.fileSystemID = fileSystemID;\n+    this.hadoopOpName = hadoopOpName;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYzMTEzMQ=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjU0NzIzOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOTozODozMlrOJ0Hy8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOFQyMDoxMTowN1rOJ1gXqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYzMzQ1Ng==", "bodyText": "A regex matching call is not that cheap. We will end up calling this for every object creation of this TracingContext.  Can we limit this check only at the time of FS instantiation?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658633456", "createdAt": "2021-06-25T09:38:32Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.util.UUID;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.hadoop.fs.azurebfs.constants.FSOperationType;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.EMPTY_STRING;\n+\n+/**\n+ * The TracingContext class to correlate Store requests using unique\n+ * identifiers and resources common to requests (e.g. filesystem, stream)\n+ *\n+ * Implementing new HDFS method:\n+ * Create TracingContext instance in method of outer layer of\n+ * ABFS driver (AzureBlobFileSystem/AbfsInputStream/AbfsOutputStream), to be\n+ * passed through ABFS layers up to AbfsRestOperation.\n+ *\n+ * Add new operations to HdfsOperationConstants file.\n+ *\n+ * PrimaryRequestId can be enabled for individual HDFS API that invoke\n+ * multiple Store calls.\n+ *\n+ * Testing:\n+ * Pass an instance of TracingHeaderValidator to registerListener() of ABFS\n+ * filesystem/stream class before calling the API in tests.\n+ */\n+\n+public class TracingContext {\n+  private final String clientCorrelationID;\n+  private final String fileSystemID;\n+  private String clientRequestId = EMPTY_STRING;\n+  private String primaryRequestID;\n+  private String streamID;\n+  private int retryCount;\n+  private FSOperationType hadoopOpName;\n+  private final TracingHeaderFormat format;\n+  private Listener listener = null;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AbfsClient.class);\n+  public static final int MAX_CLIENT_CORRELATION_ID_LENGTH = 72;\n+  public static final String CLIENT_CORRELATION_ID_PATTERN = \"[a-zA-Z0-9-]*\";\n+\n+  /**\n+   * Initialize TracingContext\n+   * @param clientCorrelationID Provided over config by client\n+   * @param fileSystemID Unique guid for AzureBlobFileSystem instance\n+   * @param hadoopOpName Code indicating the high-level Hadoop operation that\n+   *                    triggered the current Store request\n+   * @param tracingHeaderFormat Format of IDs to be printed in header and logs\n+   * @param listener Holds instance of TracingHeaderValidator during testing,\n+   *                null otherwise\n+   */\n+  public TracingContext(String clientCorrelationID, String fileSystemID,\n+      FSOperationType hadoopOpName, TracingHeaderFormat tracingHeaderFormat,\n+      Listener listener) {\n+    this.fileSystemID = fileSystemID;\n+    this.hadoopOpName = hadoopOpName;\n+    this.clientCorrelationID = validateClientCorrelationID(clientCorrelationID);\n+    streamID = EMPTY_STRING;\n+    retryCount = 0;\n+    primaryRequestID = EMPTY_STRING;\n+    format = tracingHeaderFormat;\n+    this.listener = listener;\n+  }\n+\n+  public TracingContext(String clientCorrelationID, String fileSystemID,\n+      FSOperationType hadoopOpName, boolean needsPrimaryReqId,\n+      TracingHeaderFormat tracingHeaderFormat, Listener listener) {\n+    this(clientCorrelationID, fileSystemID, hadoopOpName, tracingHeaderFormat,\n+        listener);\n+    primaryRequestID = needsPrimaryReqId ? UUID.randomUUID().toString() : \"\";\n+    if (listener != null) {\n+      listener.updatePrimaryRequestID(primaryRequestID);\n+    }\n+  }\n+\n+  public TracingContext(TracingContext originalTracingContext) {\n+    this.fileSystemID = originalTracingContext.fileSystemID;\n+    this.streamID = originalTracingContext.streamID;\n+    this.clientCorrelationID = originalTracingContext.clientCorrelationID;\n+    this.hadoopOpName = originalTracingContext.hadoopOpName;\n+    this.retryCount = 0;\n+    this.primaryRequestID = originalTracingContext.primaryRequestID;\n+    this.format = originalTracingContext.format;\n+    if (originalTracingContext.listener != null) {\n+      this.listener = originalTracingContext.listener.getClone();\n+    }\n+  }\n+\n+  public String validateClientCorrelationID(String clientCorrelationID) {\n+    if ((clientCorrelationID.length() > MAX_CLIENT_CORRELATION_ID_LENGTH)\n+        || (!clientCorrelationID.matches(CLIENT_CORRELATION_ID_PATTERN))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA4NDY0OA==", "bodyText": "true. Changed the validate method to be static, calling from ABFS constructor only now", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r660084648", "createdAt": "2021-06-28T20:11:07Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.util.UUID;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.hadoop.fs.azurebfs.constants.FSOperationType;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.EMPTY_STRING;\n+\n+/**\n+ * The TracingContext class to correlate Store requests using unique\n+ * identifiers and resources common to requests (e.g. filesystem, stream)\n+ *\n+ * Implementing new HDFS method:\n+ * Create TracingContext instance in method of outer layer of\n+ * ABFS driver (AzureBlobFileSystem/AbfsInputStream/AbfsOutputStream), to be\n+ * passed through ABFS layers up to AbfsRestOperation.\n+ *\n+ * Add new operations to HdfsOperationConstants file.\n+ *\n+ * PrimaryRequestId can be enabled for individual HDFS API that invoke\n+ * multiple Store calls.\n+ *\n+ * Testing:\n+ * Pass an instance of TracingHeaderValidator to registerListener() of ABFS\n+ * filesystem/stream class before calling the API in tests.\n+ */\n+\n+public class TracingContext {\n+  private final String clientCorrelationID;\n+  private final String fileSystemID;\n+  private String clientRequestId = EMPTY_STRING;\n+  private String primaryRequestID;\n+  private String streamID;\n+  private int retryCount;\n+  private FSOperationType hadoopOpName;\n+  private final TracingHeaderFormat format;\n+  private Listener listener = null;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AbfsClient.class);\n+  public static final int MAX_CLIENT_CORRELATION_ID_LENGTH = 72;\n+  public static final String CLIENT_CORRELATION_ID_PATTERN = \"[a-zA-Z0-9-]*\";\n+\n+  /**\n+   * Initialize TracingContext\n+   * @param clientCorrelationID Provided over config by client\n+   * @param fileSystemID Unique guid for AzureBlobFileSystem instance\n+   * @param hadoopOpName Code indicating the high-level Hadoop operation that\n+   *                    triggered the current Store request\n+   * @param tracingHeaderFormat Format of IDs to be printed in header and logs\n+   * @param listener Holds instance of TracingHeaderValidator during testing,\n+   *                null otherwise\n+   */\n+  public TracingContext(String clientCorrelationID, String fileSystemID,\n+      FSOperationType hadoopOpName, TracingHeaderFormat tracingHeaderFormat,\n+      Listener listener) {\n+    this.fileSystemID = fileSystemID;\n+    this.hadoopOpName = hadoopOpName;\n+    this.clientCorrelationID = validateClientCorrelationID(clientCorrelationID);\n+    streamID = EMPTY_STRING;\n+    retryCount = 0;\n+    primaryRequestID = EMPTY_STRING;\n+    format = tracingHeaderFormat;\n+    this.listener = listener;\n+  }\n+\n+  public TracingContext(String clientCorrelationID, String fileSystemID,\n+      FSOperationType hadoopOpName, boolean needsPrimaryReqId,\n+      TracingHeaderFormat tracingHeaderFormat, Listener listener) {\n+    this(clientCorrelationID, fileSystemID, hadoopOpName, tracingHeaderFormat,\n+        listener);\n+    primaryRequestID = needsPrimaryReqId ? UUID.randomUUID().toString() : \"\";\n+    if (listener != null) {\n+      listener.updatePrimaryRequestID(primaryRequestID);\n+    }\n+  }\n+\n+  public TracingContext(TracingContext originalTracingContext) {\n+    this.fileSystemID = originalTracingContext.fileSystemID;\n+    this.streamID = originalTracingContext.streamID;\n+    this.clientCorrelationID = originalTracingContext.clientCorrelationID;\n+    this.hadoopOpName = originalTracingContext.hadoopOpName;\n+    this.retryCount = 0;\n+    this.primaryRequestID = originalTracingContext.primaryRequestID;\n+    this.format = originalTracingContext.format;\n+    if (originalTracingContext.listener != null) {\n+      this.listener = originalTracingContext.listener.getClone();\n+    }\n+  }\n+\n+  public String validateClientCorrelationID(String clientCorrelationID) {\n+    if ((clientCorrelationID.length() > MAX_CLIENT_CORRELATION_ID_LENGTH)\n+        || (!clientCorrelationID.matches(CLIENT_CORRELATION_ID_PATTERN))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYzMzQ1Ng=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjYxNjIwOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOTo1NToyMVrOJ0IcPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOFQyMDoxMToxN1rOJ1gYBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY0NDAzMA==", "bodyText": "In any kind of op clientCorrelationID , clientRequestId , fileSystemID , hadoopOpName and retryCount will be present\nOptional things are primaryRequestID and streamID .  Correct?\nWorth detailing in some comments here.\nWhen these 2 are not there it will come like ::::...  ?", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658644030", "createdAt": "2021-06-25T09:55:21Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.util.UUID;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.hadoop.fs.azurebfs.constants.FSOperationType;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.EMPTY_STRING;\n+\n+/**\n+ * The TracingContext class to correlate Store requests using unique\n+ * identifiers and resources common to requests (e.g. filesystem, stream)\n+ *\n+ * Implementing new HDFS method:\n+ * Create TracingContext instance in method of outer layer of\n+ * ABFS driver (AzureBlobFileSystem/AbfsInputStream/AbfsOutputStream), to be\n+ * passed through ABFS layers up to AbfsRestOperation.\n+ *\n+ * Add new operations to HdfsOperationConstants file.\n+ *\n+ * PrimaryRequestId can be enabled for individual HDFS API that invoke\n+ * multiple Store calls.\n+ *\n+ * Testing:\n+ * Pass an instance of TracingHeaderValidator to registerListener() of ABFS\n+ * filesystem/stream class before calling the API in tests.\n+ */\n+\n+public class TracingContext {\n+  private final String clientCorrelationID;\n+  private final String fileSystemID;\n+  private String clientRequestId = EMPTY_STRING;\n+  private String primaryRequestID;\n+  private String streamID;\n+  private int retryCount;\n+  private FSOperationType hadoopOpName;\n+  private final TracingHeaderFormat format;\n+  private Listener listener = null;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AbfsClient.class);\n+  public static final int MAX_CLIENT_CORRELATION_ID_LENGTH = 72;\n+  public static final String CLIENT_CORRELATION_ID_PATTERN = \"[a-zA-Z0-9-]*\";\n+\n+  /**\n+   * Initialize TracingContext\n+   * @param clientCorrelationID Provided over config by client\n+   * @param fileSystemID Unique guid for AzureBlobFileSystem instance\n+   * @param hadoopOpName Code indicating the high-level Hadoop operation that\n+   *                    triggered the current Store request\n+   * @param tracingHeaderFormat Format of IDs to be printed in header and logs\n+   * @param listener Holds instance of TracingHeaderValidator during testing,\n+   *                null otherwise\n+   */\n+  public TracingContext(String clientCorrelationID, String fileSystemID,\n+      FSOperationType hadoopOpName, TracingHeaderFormat tracingHeaderFormat,\n+      Listener listener) {\n+    this.fileSystemID = fileSystemID;\n+    this.hadoopOpName = hadoopOpName;\n+    this.clientCorrelationID = validateClientCorrelationID(clientCorrelationID);\n+    streamID = EMPTY_STRING;\n+    retryCount = 0;\n+    primaryRequestID = EMPTY_STRING;\n+    format = tracingHeaderFormat;\n+    this.listener = listener;\n+  }\n+\n+  public TracingContext(String clientCorrelationID, String fileSystemID,\n+      FSOperationType hadoopOpName, boolean needsPrimaryReqId,\n+      TracingHeaderFormat tracingHeaderFormat, Listener listener) {\n+    this(clientCorrelationID, fileSystemID, hadoopOpName, tracingHeaderFormat,\n+        listener);\n+    primaryRequestID = needsPrimaryReqId ? UUID.randomUUID().toString() : \"\";\n+    if (listener != null) {\n+      listener.updatePrimaryRequestID(primaryRequestID);\n+    }\n+  }\n+\n+  public TracingContext(TracingContext originalTracingContext) {\n+    this.fileSystemID = originalTracingContext.fileSystemID;\n+    this.streamID = originalTracingContext.streamID;\n+    this.clientCorrelationID = originalTracingContext.clientCorrelationID;\n+    this.hadoopOpName = originalTracingContext.hadoopOpName;\n+    this.retryCount = 0;\n+    this.primaryRequestID = originalTracingContext.primaryRequestID;\n+    this.format = originalTracingContext.format;\n+    if (originalTracingContext.listener != null) {\n+      this.listener = originalTracingContext.listener.getClone();\n+    }\n+  }\n+\n+  public String validateClientCorrelationID(String clientCorrelationID) {\n+    if ((clientCorrelationID.length() > MAX_CLIENT_CORRELATION_ID_LENGTH)\n+        || (!clientCorrelationID.matches(CLIENT_CORRELATION_ID_PATTERN))) {\n+      LOG.debug(\n+          \"Invalid config provided; correlation id not included in header.\");\n+      return EMPTY_STRING;\n+    }\n+    return clientCorrelationID;\n+  }\n+\n+  public void generateClientRequestId() {\n+    clientRequestId = UUID.randomUUID().toString();\n+  }\n+\n+  public void setPrimaryRequestID() {\n+    primaryRequestID = UUID.randomUUID().toString();\n+    if (listener != null) {\n+      listener.updatePrimaryRequestID(primaryRequestID);\n+    }\n+  }\n+\n+  public void setStreamID(String stream) {\n+    streamID = stream;\n+  }\n+\n+  public void setOperation(FSOperationType operation) {\n+    this.hadoopOpName = operation;\n+  }\n+\n+  public void setRetryCount(int retryCount) {\n+    this.retryCount = retryCount;\n+  }\n+\n+  public void setListener(Listener listener) {\n+    this.listener = listener;\n+  }\n+\n+  public String constructHeader() {\n+    String header;\n+    switch (format) {\n+    case ALL_ID_FORMAT:\n+      header =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA4NDc0Mg==", "bodyText": "Added description to member declaration and added note in the fn\nYes the number of separators (:) is kept constant for parsing", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r660084742", "createdAt": "2021-06-28T20:11:17Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingContext.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+import java.util.UUID;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import org.apache.hadoop.fs.azurebfs.constants.FSOperationType;\n+import org.apache.hadoop.fs.azurebfs.services.AbfsClient;\n+\n+import static org.apache.hadoop.fs.azurebfs.constants.AbfsHttpConstants.EMPTY_STRING;\n+\n+/**\n+ * The TracingContext class to correlate Store requests using unique\n+ * identifiers and resources common to requests (e.g. filesystem, stream)\n+ *\n+ * Implementing new HDFS method:\n+ * Create TracingContext instance in method of outer layer of\n+ * ABFS driver (AzureBlobFileSystem/AbfsInputStream/AbfsOutputStream), to be\n+ * passed through ABFS layers up to AbfsRestOperation.\n+ *\n+ * Add new operations to HdfsOperationConstants file.\n+ *\n+ * PrimaryRequestId can be enabled for individual HDFS API that invoke\n+ * multiple Store calls.\n+ *\n+ * Testing:\n+ * Pass an instance of TracingHeaderValidator to registerListener() of ABFS\n+ * filesystem/stream class before calling the API in tests.\n+ */\n+\n+public class TracingContext {\n+  private final String clientCorrelationID;\n+  private final String fileSystemID;\n+  private String clientRequestId = EMPTY_STRING;\n+  private String primaryRequestID;\n+  private String streamID;\n+  private int retryCount;\n+  private FSOperationType hadoopOpName;\n+  private final TracingHeaderFormat format;\n+  private Listener listener = null;\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AbfsClient.class);\n+  public static final int MAX_CLIENT_CORRELATION_ID_LENGTH = 72;\n+  public static final String CLIENT_CORRELATION_ID_PATTERN = \"[a-zA-Z0-9-]*\";\n+\n+  /**\n+   * Initialize TracingContext\n+   * @param clientCorrelationID Provided over config by client\n+   * @param fileSystemID Unique guid for AzureBlobFileSystem instance\n+   * @param hadoopOpName Code indicating the high-level Hadoop operation that\n+   *                    triggered the current Store request\n+   * @param tracingHeaderFormat Format of IDs to be printed in header and logs\n+   * @param listener Holds instance of TracingHeaderValidator during testing,\n+   *                null otherwise\n+   */\n+  public TracingContext(String clientCorrelationID, String fileSystemID,\n+      FSOperationType hadoopOpName, TracingHeaderFormat tracingHeaderFormat,\n+      Listener listener) {\n+    this.fileSystemID = fileSystemID;\n+    this.hadoopOpName = hadoopOpName;\n+    this.clientCorrelationID = validateClientCorrelationID(clientCorrelationID);\n+    streamID = EMPTY_STRING;\n+    retryCount = 0;\n+    primaryRequestID = EMPTY_STRING;\n+    format = tracingHeaderFormat;\n+    this.listener = listener;\n+  }\n+\n+  public TracingContext(String clientCorrelationID, String fileSystemID,\n+      FSOperationType hadoopOpName, boolean needsPrimaryReqId,\n+      TracingHeaderFormat tracingHeaderFormat, Listener listener) {\n+    this(clientCorrelationID, fileSystemID, hadoopOpName, tracingHeaderFormat,\n+        listener);\n+    primaryRequestID = needsPrimaryReqId ? UUID.randomUUID().toString() : \"\";\n+    if (listener != null) {\n+      listener.updatePrimaryRequestID(primaryRequestID);\n+    }\n+  }\n+\n+  public TracingContext(TracingContext originalTracingContext) {\n+    this.fileSystemID = originalTracingContext.fileSystemID;\n+    this.streamID = originalTracingContext.streamID;\n+    this.clientCorrelationID = originalTracingContext.clientCorrelationID;\n+    this.hadoopOpName = originalTracingContext.hadoopOpName;\n+    this.retryCount = 0;\n+    this.primaryRequestID = originalTracingContext.primaryRequestID;\n+    this.format = originalTracingContext.format;\n+    if (originalTracingContext.listener != null) {\n+      this.listener = originalTracingContext.listener.getClone();\n+    }\n+  }\n+\n+  public String validateClientCorrelationID(String clientCorrelationID) {\n+    if ((clientCorrelationID.length() > MAX_CLIENT_CORRELATION_ID_LENGTH)\n+        || (!clientCorrelationID.matches(CLIENT_CORRELATION_ID_PATTERN))) {\n+      LOG.debug(\n+          \"Invalid config provided; correlation id not included in header.\");\n+      return EMPTY_STRING;\n+    }\n+    return clientCorrelationID;\n+  }\n+\n+  public void generateClientRequestId() {\n+    clientRequestId = UUID.randomUUID().toString();\n+  }\n+\n+  public void setPrimaryRequestID() {\n+    primaryRequestID = UUID.randomUUID().toString();\n+    if (listener != null) {\n+      listener.updatePrimaryRequestID(primaryRequestID);\n+    }\n+  }\n+\n+  public void setStreamID(String stream) {\n+    streamID = stream;\n+  }\n+\n+  public void setOperation(FSOperationType operation) {\n+    this.hadoopOpName = operation;\n+  }\n+\n+  public void setRetryCount(int retryCount) {\n+    this.retryCount = retryCount;\n+  }\n+\n+  public void setListener(Listener listener) {\n+    this.listener = listener;\n+  }\n+\n+  public String constructHeader() {\n+    String header;\n+    switch (format) {\n+    case ALL_ID_FORMAT:\n+      header =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY0NDAzMA=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 153}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MjYyMzQyOnYy", "diffSide": "RIGHT", "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingHeaderFormat.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOTo1NzowOVrOJ0IgiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOFQyMDoxMToyMlrOJ1gYMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY0NTEyOQ==", "bodyText": "Will the below way will be more consistent?\nSINGLE_ID_FORMAT,  // client-req-id\nTWO_ID_FORMAT; // client-req-id:client-correlation-id\nALL_ID_FORMAT,  // client-req-id:client-correlation-id:filesystem-id:primary-req-id:stream-id:hdfs-operation:retry-count", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r658645129", "createdAt": "2021-06-25T09:57:09Z", "author": {"login": "anoopsjohn"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingHeaderFormat.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+public enum TracingHeaderFormat {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDA4NDc4Nw==", "bodyText": "switched enum, but keeping correlationId at the start would be easier to distinguish it as a custom id of variable length", "url": "https://github.com/apache/hadoop/pull/2520#discussion_r660084787", "createdAt": "2021-06-28T20:11:22Z", "author": {"login": "sumangala-patki"}, "path": "hadoop-tools/hadoop-azure/src/main/java/org/apache/hadoop/fs/azurebfs/utils/TracingHeaderFormat.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.fs.azurebfs.utils;\n+\n+public enum TracingHeaderFormat {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY0NTEyOQ=="}, "originalCommit": {"oid": "1567e3e82240a242a6f11970d6d313db575a3787"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3166, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}