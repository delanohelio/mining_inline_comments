{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyOTAzNjk4", "number": 2469, "title": "MAPREDUCE-7307. Potential thread leak in LocatedFileStatusFetcher", "bodyText": "NOTICE\nPlease create an issue in ASF JIRA before opening a pull request,\nand you need to set the title of the pull request which starts with\nthe corresponding JIRA issue number. (e.g. HADOOP-XXXXX. Fix a typo in YYY.)\nFor more details, please see https://cwiki.apache.org/confluence/display/HADOOP/How+To+Contribute", "createdAt": "2020-11-18T04:32:11Z", "url": "https://github.com/apache/hadoop/pull/2469", "merged": true, "mergeCommit": {"oid": "f13c7b1b0267e75fc590a59db86163405c673bb4"}, "closed": true, "closedAt": "2020-11-23T15:40:22Z", "author": {"login": "dengzhhu653"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddmRYagH2gAyNTIyOTAzNjk4OjBlZTAxMGE4NmEzYjQyYzZjMjE5NTMwNDUzZGFiZDI5ZDcxZmE4Yjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfXBK9gFqTUzNjU5MTM1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ee010a86a3b42c6c219530453dabd29d71fa8b9", "author": {"user": {"login": "dengzhhu653", "name": "dengzh"}}, "url": "https://github.com/apache/hadoop/commit/0ee010a86a3b42c6c219530453dabd29d71fa8b9", "committedDate": "2020-11-18T04:16:25Z", "message": "Potential thread leak in LocatedFileStatusFetcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8581bea57b933668c1155c158722fb6518dcb912", "author": {"user": {"login": "dengzhhu653", "name": "dengzh"}}, "url": "https://github.com/apache/hadoop/commit/8581bea57b933668c1155c158722fb6518dcb912", "committedDate": "2020-11-19T12:14:01Z", "message": "add unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NDc3ODY1", "url": "https://github.com/apache/hadoop/pull/2469#pullrequestreview-534477865", "createdAt": "2020-11-19T14:06:06Z", "commit": {"oid": "8581bea57b933668c1155c158722fb6518dcb912"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNDowNjowN1rOH2gLSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNDoxMzowMVrOH2geCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkxMjMzMQ==", "bodyText": "we're using a shaded org.apache.hadoop.thirdparty ref here. Guava has been too painful", "url": "https://github.com/apache/hadoop/pull/2469#discussion_r526912331", "createdAt": "2020-11-19T14:06:07Z", "author": {"login": "steveloughran"}, "path": "hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/main/java/org/apache/hadoop/mapred/LocatedFileStatusFetcher.java", "diffHunk": "@@ -29,6 +29,7 @@\n import java.util.concurrent.locks.Condition;\n import java.util.concurrent.locks.ReentrantLock;\n \n+import com.google.common.annotations.VisibleForTesting;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8581bea57b933668c1155c158722fb6518dcb912"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkxNDE1Mw==", "bodyText": "import ordering on new code should be\njava.*\nnon-org.apache\norg.apache.*\nstatics\nexisting stuff we normally leave alone as it makes cherrypicking harder. Imports are core part of merge pain", "url": "https://github.com/apache/hadoop/pull/2469#discussion_r526914153", "createdAt": "2020-11-19T14:08:48Z", "author": {"login": "steveloughran"}, "path": "hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/test/java/org/apache/hadoop/mapred/TestLocatedFileStatusFetcher.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.mapred;\n+\n+import org.apache.hadoop.conf.Configuration;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8581bea57b933668c1155c158722fb6518dcb912"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkxNDg5Nw==", "bodyText": "make a subclass of AbstractHadoopTestBase for timeout rull and thread naming", "url": "https://github.com/apache/hadoop/pull/2469#discussion_r526914897", "createdAt": "2020-11-19T14:09:53Z", "author": {"login": "steveloughran"}, "path": "hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/test/java/org/apache/hadoop/mapred/TestLocatedFileStatusFetcher.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.mapred;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.FileUtil;\n+import org.apache.hadoop.fs.LocalFileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.PathFilter;\n+import org.apache.hadoop.test.GenericTestUtils;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+public class TestLocatedFileStatusFetcher {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8581bea57b933668c1155c158722fb6518dcb912"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkxNTY1Ng==", "bodyText": "add an error message for the assertion", "url": "https://github.com/apache/hadoop/pull/2469#discussion_r526915656", "createdAt": "2020-11-19T14:10:54Z", "author": {"login": "steveloughran"}, "path": "hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/test/java/org/apache/hadoop/mapred/TestLocatedFileStatusFetcher.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.mapred;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.FileUtil;\n+import org.apache.hadoop.fs.LocalFileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.PathFilter;\n+import org.apache.hadoop.test.GenericTestUtils;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+public class TestLocatedFileStatusFetcher {\n+\n+  private Configuration conf;\n+  private FileSystem fileSys;\n+  private boolean mkdirs;\n+  private File dir = GenericTestUtils.getTestDir(\"test-localfs\");\n+  private static long TIME_FOR_SLEEP = 10000;\n+\n+  @Before\n+  public void setup() throws Exception {\n+    conf = new Configuration(false);\n+    conf.set(\"fs.file.impl\", MockFileSystem.class.getName());\n+    fileSys = FileSystem.getLocal(conf);\n+  }\n+\n+  @After\n+  public void after() throws IOException {\n+    if (mkdirs) {\n+      FileUtil.fullyDelete(dir);\n+    }\n+  }\n+\n+  @Test\n+  public void testExecutorsShutDown() throws Exception {\n+    Path scanPath = new Path(dir.getAbsolutePath());\n+    mkdirs = fileSys.mkdirs(scanPath);\n+    Path[] dirs = new Path[] {scanPath};\n+    final LocatedFileStatusFetcher fetcher = new LocatedFileStatusFetcher(conf, dirs, true,\n+        new PathFilter() {\n+          @Override\n+          public boolean accept(Path path) {\n+            return true;\n+          }\n+        }, true);\n+\n+    Thread t = new Thread() {\n+      @Override\n+      public void run() {\n+        try {\n+          fetcher.getFileStatuses();\n+        } catch (Exception e) {\n+          // This should interrupt condition.await()\n+          Assert.assertTrue(e instanceof InterruptedException);\n+        }\n+      }\n+    };\n+\n+    t.start();\n+    Thread.sleep(TIME_FOR_SLEEP / 2);\n+\n+    t.interrupt();\n+    t.join();\n+    // Check the status for executor service\n+    Assert.assertTrue(fetcher.getListeningExecutorService().isShutdown());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8581bea57b933668c1155c158722fb6518dcb912"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkxNzEzMQ==", "bodyText": "do we need this separate thread? Shouldn't the fetcher.getFileStatuses be enough?", "url": "https://github.com/apache/hadoop/pull/2469#discussion_r526917131", "createdAt": "2020-11-19T14:13:01Z", "author": {"login": "steveloughran"}, "path": "hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/test/java/org/apache/hadoop/mapred/TestLocatedFileStatusFetcher.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.mapred;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.FileUtil;\n+import org.apache.hadoop.fs.LocalFileSystem;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.PathFilter;\n+import org.apache.hadoop.test.GenericTestUtils;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+public class TestLocatedFileStatusFetcher {\n+\n+  private Configuration conf;\n+  private FileSystem fileSys;\n+  private boolean mkdirs;\n+  private File dir = GenericTestUtils.getTestDir(\"test-localfs\");\n+  private static long TIME_FOR_SLEEP = 10000;\n+\n+  @Before\n+  public void setup() throws Exception {\n+    conf = new Configuration(false);\n+    conf.set(\"fs.file.impl\", MockFileSystem.class.getName());\n+    fileSys = FileSystem.getLocal(conf);\n+  }\n+\n+  @After\n+  public void after() throws IOException {\n+    if (mkdirs) {\n+      FileUtil.fullyDelete(dir);\n+    }\n+  }\n+\n+  @Test\n+  public void testExecutorsShutDown() throws Exception {\n+    Path scanPath = new Path(dir.getAbsolutePath());\n+    mkdirs = fileSys.mkdirs(scanPath);\n+    Path[] dirs = new Path[] {scanPath};\n+    final LocatedFileStatusFetcher fetcher = new LocatedFileStatusFetcher(conf, dirs, true,\n+        new PathFilter() {\n+          @Override\n+          public boolean accept(Path path) {\n+            return true;\n+          }\n+        }, true);\n+\n+    Thread t = new Thread() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8581bea57b933668c1155c158722fb6518dcb912"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eadfcc198837dfbd0a70d5b186b8b49b4d685306", "author": {"user": {"login": "dengzhhu653", "name": "dengzh"}}, "url": "https://github.com/apache/hadoop/commit/eadfcc198837dfbd0a70d5b186b8b49b4d685306", "committedDate": "2020-11-19T15:30:42Z", "message": "address the comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b286cbba3b6ad481a7299ae51d6d5aa4aa4aae0b", "author": {"user": {"login": "dengzhhu653", "name": "dengzh"}}, "url": "https://github.com/apache/hadoop/commit/b286cbba3b6ad481a7299ae51d6d5aa4aa4aae0b", "committedDate": "2020-11-19T15:52:30Z", "message": "Merge branch 'trunk' of https://github.com/apache/hadoop into test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c061f6b0b48ff18a88df6747aec70005425e388", "author": {"user": {"login": "dengzhhu653", "name": "dengzh"}}, "url": "https://github.com/apache/hadoop/commit/3c061f6b0b48ff18a88df6747aec70005425e388", "committedDate": "2020-11-19T16:21:11Z", "message": "refine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af5323ff389b98c73188814eb2917ee5640b392f", "author": {"user": {"login": "dengzhhu653", "name": "dengzh"}}, "url": "https://github.com/apache/hadoop/commit/af5323ff389b98c73188814eb2917ee5640b392f", "committedDate": "2020-11-21T00:55:37Z", "message": "fix the comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c217bf29b978c40626042da22667c1d0626313cc", "author": {"user": {"login": "dengzhhu653", "name": "dengzh"}}, "url": "https://github.com/apache/hadoop/commit/c217bf29b978c40626042da22667c1d0626313cc", "committedDate": "2020-11-22T02:15:06Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NTkxMzU2", "url": "https://github.com/apache/hadoop/pull/2469#pullrequestreview-536591356", "createdAt": "2020-11-23T15:37:59Z", "commit": {"oid": "c217bf29b978c40626042da22667c1d0626313cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3265, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}