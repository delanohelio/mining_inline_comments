{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MjMxODg4", "number": 1851, "title": "HADOOP-16858. S3Guard fsck: Add option to remove orphaned entries", "bodyText": "Change-Id: I2cdb6601fea1d859b54370046b827ef06eb1107d", "createdAt": "2020-02-17T16:44:27Z", "url": "https://github.com/apache/hadoop/pull/1851", "merged": true, "mergeCommit": {"oid": "c91ff8c18ffc070eeef22afeb2e519b184398e89"}, "closed": true, "closedAt": "2020-03-18T11:48:53Z", "author": {"login": "bgaborg"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFUp5XAFqTM1OTk4MTI0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO11cfAFqTM3Njc4NjUwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTgxMjQ0", "url": "https://github.com/apache/hadoop/pull/1851#pullrequestreview-359981244", "createdAt": "2020-02-17T21:59:33Z", "commit": {"oid": "e13eabfecfb311f7585fd76865345ae70c5e1882"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMTo1OTozNFrOFqweuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMTo1OTozNFrOFqweuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM3ODgwOQ==", "bodyText": "you could probably do this in the base class for now", "url": "https://github.com/apache/hadoop/pull/1851#discussion_r380378809", "createdAt": "2020-02-17T21:59:34Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/s3guard/S3GuardFsckViolationHandler.java", "diffHunk": "@@ -152,6 +184,12 @@ public NoMetadataEntry(S3GuardFsck.ComparePair comparePair) {\n     public String getError() {\n       return \"No PathMetadata for this path in the MS.\";\n     }\n+\n+    @Override\n+    public String fixViolation(S3AFileSystem fs, DynamoDBMetadataStore ddbms) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e13eabfecfb311f7585fd76865345ae70c5e1882"}, "originalPosition": 109}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzOTcyMDg4", "url": "https://github.com/apache/hadoop/pull/1851#pullrequestreview-363972088", "createdAt": "2020-02-25T09:09:30Z", "commit": {"oid": "eae4dc2f1c876ad9185161f3746e3b1b90fd2f40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwOTowOTozMVrOFt91HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwOTowOTozMVrOFt91HA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc0MzI2MA==", "bodyText": "Don't you think CASE statements would be better option here.", "url": "https://github.com/apache/hadoop/pull/1851#discussion_r383743260", "createdAt": "2020-02-25T09:09:31Z", "author": {"login": "mukund-thakur"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/s3guard/S3GuardFsckViolationHandler.java", "diffHunk": "@@ -60,28 +66,51 @@ public void handle(S3GuardFsck.ComparePair comparePair) {\n     sB.append(newLine)\n         .append(\"On path: \").append(comparePair.getPath()).append(newLine);\n \n-    handleComparePair(comparePair, sB);\n+    handleComparePair(comparePair, sB, HandleMode.LOG);\n \n     LOG.error(sB.toString());\n   }\n \n+  public void doFix(S3GuardFsck.ComparePair comparePair) throws IOException {\n+    if (!comparePair.containsViolation()) {\n+      LOG.debug(\"There is no violation in the compare pair: {}\", comparePair);\n+      return;\n+    }\n+\n+    StringBuilder sB = new StringBuilder();\n+    sB.append(newLine)\n+        .append(\"On path: \").append(comparePair.getPath()).append(newLine);\n+\n+    handleComparePair(comparePair, sB, HandleMode.FIX);\n+\n+    LOG.info(sB.toString());\n+  }\n+\n   /**\n    * Create a new instance of the violation handler for all the violations\n    * found in the compare pair and use it.\n    *\n    * @param comparePair the compare pair with violations\n    * @param sB StringBuilder to append error strings from violations.\n    */\n-  protected static void handleComparePair(S3GuardFsck.ComparePair comparePair,\n-      StringBuilder sB) {\n+  protected void handleComparePair(S3GuardFsck.ComparePair comparePair,\n+      StringBuilder sB, HandleMode handleMode) throws IOException {\n \n     for (S3GuardFsck.Violation violation : comparePair.getViolations()) {\n       try {\n         ViolationHandler handler = violation.getHandler()\n             .getDeclaredConstructor(S3GuardFsck.ComparePair.class)\n             .newInstance(comparePair);\n-        final String errorStr = handler.getError();\n-        sB.append(errorStr);\n+\n+        if (handleMode == HandleMode.LOG) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eae4dc2f1c876ad9185161f3746e3b1b90fd2f40"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MDU2MjY0", "url": "https://github.com/apache/hadoop/pull/1851#pullrequestreview-364056264", "createdAt": "2020-02-25T11:06:18Z", "commit": {"oid": "eae4dc2f1c876ad9185161f3746e3b1b90fd2f40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMTowNjoxOFrOFuB-Cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMTowNjoxOFrOFuB-Cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgxMTA4Mw==", "bodyText": "It would be nice if you can add some comments here. Thanks.", "url": "https://github.com/apache/hadoop/pull/1851#discussion_r383811083", "createdAt": "2020-02-25T11:06:18Z", "author": {"login": "mukund-thakur"}, "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/s3guard/ITestS3GuardFsck.java", "diffHunk": "@@ -599,6 +613,12 @@ private void checkForViolationInPairs(Path file,\n   private void checkNoViolationInPairs(Path file2,\n       List<S3GuardFsck.ComparePair> comparePairs,\n       S3GuardFsck.Violation violation) {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eae4dc2f1c876ad9185161f3746e3b1b90fd2f40"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MDc2NDMx", "url": "https://github.com/apache/hadoop/pull/1851#pullrequestreview-364076431", "createdAt": "2020-02-25T11:41:55Z", "commit": {"oid": "eae4dc2f1c876ad9185161f3746e3b1b90fd2f40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMTo0MTo1NVrOFuC-XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMTo0MTo1NVrOFuC-XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgyNzU0OA==", "bodyText": "I am wondering why there is no assert here.", "url": "https://github.com/apache/hadoop/pull/1851#discussion_r383827548", "createdAt": "2020-02-25T11:41:55Z", "author": {"login": "mukund-thakur"}, "path": "hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/s3guard/ITestS3GuardToolDynamoDB.java", "diffHunk": "@@ -353,6 +353,28 @@ public void testCLIFsckCheckExclusive() throws Exception {\n         \"s3a://\" + getFileSystem().getBucket()));\n   }\n \n+  @Test\n+  public void testCLIFsckDDbFixOnlyFails() throws Exception {\n+    describe(\"This test serves the purpose to run fsck with the correct \" +\n+        \"parameters, so there will be no exception thrown.\");\n+    final int result = run(S3GuardTool.Fsck.NAME,\n+        \"-\" + Fsck.FIX_FLAG,\n+        \"s3a://\" + getFileSystem().getBucket());\n+    LOG.info(\"The return value of the run: {}\", result);\n+    assertEquals(ERROR, result);\n+  }\n+\n+  @Test\n+  public void testCLIFsckDDbFixAndInternalSucceed() throws Exception {\n+    describe(\"This test serves the purpose to run fsck with the correct \" +\n+        \"parameters, so there will be no exception thrown.\");\n+    final int result = run(S3GuardTool.Fsck.NAME,\n+        \"-\" + Fsck.FIX_FLAG,\n+        \"-\" + Fsck.DDB_MS_CONSISTENCY_FLAG,\n+        \"s3a://\" + getFileSystem().getBucket());\n+    LOG.info(\"The return value of the run: {}\", result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eae4dc2f1c876ad9185161f3746e3b1b90fd2f40"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ff36a085f22184cc335b9f71eac2c022c06f13f", "author": {"user": {"login": "bgaborg", "name": "Gabor Bota"}}, "url": "https://github.com/apache/hadoop/commit/1ff36a085f22184cc335b9f71eac2c022c06f13f", "committedDate": "2020-02-27T10:03:23Z", "message": "addig javadoc to a private test function\n\nChange-Id: If35368a307660e6560c9a98d25260f0ef00f5ea0"}, "afterCommit": {"oid": "01c4be2c9212f48315367f57389adf9a7dd20815", "author": {"user": {"login": "bgaborg", "name": "Gabor Bota"}}, "url": "https://github.com/apache/hadoop/commit/01c4be2c9212f48315367f57389adf9a7dd20815", "committedDate": "2020-02-27T12:46:04Z", "message": "addig javadoc to a private test function\n\nChange-Id: If35368a307660e6560c9a98d25260f0ef00f5ea0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MzkzMjYw", "url": "https://github.com/apache/hadoop/pull/1851#pullrequestreview-367393260", "createdAt": "2020-03-02T17:40:16Z", "commit": {"oid": "01c4be2c9212f48315367f57389adf9a7dd20815"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNzo0MDoyMFrOFwow5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNzo0MDoyMFrOFwow5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0Mzg0NA==", "bodyText": "javadoc change?", "url": "https://github.com/apache/hadoop/pull/1851#discussion_r386543844", "createdAt": "2020-03-02T17:40:20Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/s3guard/S3GuardFsckViolationHandler.java", "diffHunk": "@@ -60,28 +66,55 @@ public void handle(S3GuardFsck.ComparePair comparePair) {\n     sB.append(newLine)\n         .append(\"On path: \").append(comparePair.getPath()).append(newLine);\n \n-    handleComparePair(comparePair, sB);\n+    handleComparePair(comparePair, sB, HandleMode.LOG);\n \n     LOG.error(sB.toString());\n   }\n \n+  public void doFix(S3GuardFsck.ComparePair comparePair) throws IOException {\n+    if (!comparePair.containsViolation()) {\n+      LOG.debug(\"There is no violation in the compare pair: {}\", comparePair);\n+      return;\n+    }\n+\n+    StringBuilder sB = new StringBuilder();\n+    sB.append(newLine)\n+        .append(\"On path: \").append(comparePair.getPath()).append(newLine);\n+\n+    handleComparePair(comparePair, sB, HandleMode.FIX);\n+\n+    LOG.info(sB.toString());\n+  }\n+\n   /**\n    * Create a new instance of the violation handler for all the violations\n    * found in the compare pair and use it.\n    *\n    * @param comparePair the compare pair with violations\n    * @param sB StringBuilder to append error strings from violations.\n    */\n-  protected static void handleComparePair(S3GuardFsck.ComparePair comparePair,\n-      StringBuilder sB) {\n+  protected void handleComparePair(S3GuardFsck.ComparePair comparePair,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01c4be2c9212f48315367f57389adf9a7dd20815"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3Mzk2MTg3", "url": "https://github.com/apache/hadoop/pull/1851#pullrequestreview-367396187", "createdAt": "2020-03-02T17:44:39Z", "commit": {"oid": "01c4be2c9212f48315367f57389adf9a7dd20815"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d9833621c74191d462ef39b5655f9f90e2175f6", "author": {"user": {"login": "bgaborg", "name": "Gabor Bota"}}, "url": "https://github.com/apache/hadoop/commit/5d9833621c74191d462ef39b5655f9f90e2175f6", "committedDate": "2020-03-18T09:58:23Z", "message": "HADOOP-16858. S3Guard fsck: Add option to remove orphaned entries\n\nChange-Id: I2cdb6601fea1d859b54370046b827ef06eb1107d"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d93d0ed980f1f1596c4d3ae31bea9258f02e9aa7", "author": {"user": {"login": "bgaborg", "name": "Gabor Bota"}}, "url": "https://github.com/apache/hadoop/commit/d93d0ed980f1f1596c4d3ae31bea9258f02e9aa7", "committedDate": "2020-03-18T09:58:23Z", "message": "remove impl from subclasses and add itest for fix\n\nChange-Id: Ic35c3d69117c7de1129f299ad0a64cd93e94de7b"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61a69a5ebd84bd15d1eedcbda62d3ab2359bd244", "author": {"user": {"login": "bgaborg", "name": "Gabor Bota"}}, "url": "https://github.com/apache/hadoop/commit/61a69a5ebd84bd15d1eedcbda62d3ab2359bd244", "committedDate": "2020-03-18T09:58:23Z", "message": "fixing based on Mukund's review\n\nChange-Id: If4cd6b9bd19c741ee2dfa566105f2f1bebea6fd8"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0051d19ae2403d7c028552d36b4e43baec8798a", "author": {"user": {"login": "bgaborg", "name": "Gabor Bota"}}, "url": "https://github.com/apache/hadoop/commit/c0051d19ae2403d7c028552d36b4e43baec8798a", "committedDate": "2020-03-18T09:58:23Z", "message": "addig javadoc to a private test function\n\nChange-Id: If35368a307660e6560c9a98d25260f0ef00f5ea0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dbdbffe26514d34eba18c021d64c1ed0f8a6f36", "author": {"user": {"login": "bgaborg", "name": "Gabor Bota"}}, "url": "https://github.com/apache/hadoop/commit/2dbdbffe26514d34eba18c021d64c1ed0f8a6f36", "committedDate": "2020-03-18T11:43:21Z", "message": "adding docs\n\nChange-Id: I82e992425ba15fdf9fe717c48b4a5cea73f3c99f"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01c4be2c9212f48315367f57389adf9a7dd20815", "author": {"user": {"login": "bgaborg", "name": "Gabor Bota"}}, "url": "https://github.com/apache/hadoop/commit/01c4be2c9212f48315367f57389adf9a7dd20815", "committedDate": "2020-02-27T12:46:04Z", "message": "addig javadoc to a private test function\n\nChange-Id: If35368a307660e6560c9a98d25260f0ef00f5ea0"}, "afterCommit": {"oid": "2dbdbffe26514d34eba18c021d64c1ed0f8a6f36", "author": {"user": {"login": "bgaborg", "name": "Gabor Bota"}}, "url": "https://github.com/apache/hadoop/commit/2dbdbffe26514d34eba18c021d64c1ed0f8a6f36", "committedDate": "2020-03-18T11:43:21Z", "message": "adding docs\n\nChange-Id: I82e992425ba15fdf9fe717c48b4a5cea73f3c99f"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2Nzg2NTA1", "url": "https://github.com/apache/hadoop/pull/1851#pullrequestreview-376786505", "createdAt": "2020-03-18T11:44:22Z", "commit": {"oid": "2dbdbffe26514d34eba18c021d64c1ed0f8a6f36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4754, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}