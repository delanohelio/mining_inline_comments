{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1NjgyNDM0", "number": 2259, "title": "HADOOP-17208. LoadBalanceKMSClientProvider#deleteKey should invalidat\u2026", "bodyText": "https://issues.apache.org/jira/browse/HADOOP-17208\nProposed Fix:\nSend invalidCache to all KMS provider instances upon delete to ensure the server side key cache is drained upon deletion.\nAlso fix a NPE when invalidCache for a key that has been deleted.\nHow is it tested:\nTested with RangerKMS with 3 instances.", "createdAt": "2020-08-28T23:36:42Z", "url": "https://github.com/apache/hadoop/pull/2259", "merged": true, "mergeCommit": {"oid": "6adf8462bafc27e3f4bf83948a974c089bd70682"}, "closed": true, "closedAt": "2020-09-17T17:39:20Z", "author": {"login": "xiaoyuyao"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDdpj3gH2gAyNDc1NjgyNDM0OjYwOTM1N2Y2YjUyYTBmYzM0NjliZmI0M2EyYTI3N2VhZDVhZWNkNzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJs0QJgFqTQ5MDM2NjI0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "609357f6b52a0fc3469bfb43a2a277ead5aecd75", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/hadoop/commit/609357f6b52a0fc3469bfb43a2a277ead5aecd75", "committedDate": "2020-08-28T23:31:39Z", "message": "HADOOP-17208. LoadBalanceKMSClientProvider#deleteKey should invalidateCache via all KMSClientProvider instances."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MTE0MzAx", "url": "https://github.com/apache/hadoop/pull/2259#pullrequestreview-478114301", "createdAt": "2020-08-29T09:34:21Z", "commit": {"oid": "609357f6b52a0fc3469bfb43a2a277ead5aecd75"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NzM2Njgy", "url": "https://github.com/apache/hadoop/pull/2259#pullrequestreview-478736682", "createdAt": "2020-08-31T15:53:00Z", "commit": {"oid": "609357f6b52a0fc3469bfb43a2a277ead5aecd75"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4Mjk5MzAz", "url": "https://github.com/apache/hadoop/pull/2259#pullrequestreview-488299303", "createdAt": "2020-09-15T03:36:58Z", "commit": {"oid": "609357f6b52a0fc3469bfb43a2a277ead5aecd75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMzozNjo1OFrOHRvTqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMzozNjo1OFrOHRvTqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM2MjkyMg==", "bodyText": "Hi @xiaoyuyao , Not sure if it is compatible to throw out this exception. Other are fair enough to me. Thanks.", "url": "https://github.com/apache/hadoop/pull/2259#discussion_r488362922", "createdAt": "2020-09-15T03:36:58Z", "author": {"login": "Hexiaoqiao"}, "path": "hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/crypto/key/kms/ValueQueue.java", "diffHunk": "@@ -299,19 +299,18 @@ public E getNext(String keyName)\n    * @param keyName the key to drain the Queue for\n    */\n   public void drain(String keyName) {\n+    Runnable e;\n+    while ((e = queue.deleteByName(keyName)) != null) {\n+      executor.remove(e);\n+    }\n+    writeLock(keyName);\n     try {\n-      Runnable e;\n-      while ((e = queue.deleteByName(keyName)) != null) {\n-        executor.remove(e);\n-      }\n-      writeLock(keyName);\n-      try {\n-        keyQueues.get(keyName).clear();\n-      } finally {\n-        writeUnlock(keyName);\n+      LinkedBlockingQueue kq = keyQueues.getIfPresent(keyName);\n+      if (kq != null) {\n+        kq.clear();\n       }\n-    } catch (ExecutionException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "609357f6b52a0fc3469bfb43a2a277ead5aecd75"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODM5MDMw", "url": "https://github.com/apache/hadoop/pull/2259#pullrequestreview-489839030", "createdAt": "2020-09-16T17:21:33Z", "commit": {"oid": "609357f6b52a0fc3469bfb43a2a277ead5aecd75"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMzY2MjQz", "url": "https://github.com/apache/hadoop/pull/2259#pullrequestreview-490366243", "createdAt": "2020-09-17T08:35:27Z", "commit": {"oid": "609357f6b52a0fc3469bfb43a2a277ead5aecd75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3982, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}