{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NzIwOTEy", "number": 2133, "title": "HADOOP-17122: Preserving Directory Attributes in DistCp with Atomic Copy", "bodyText": "NOTICE\nPlease create an issue in ASF JIRA before opening a pull request,\nand you need to set the title of the pull request which starts with\nthe corresponding JIRA issue number. (e.g. HADOOP-XXXXX. Fix a typo in YYY.)\nFor more details, please see https://cwiki.apache.org/confluence/display/HADOOP/How+To+Contribute", "createdAt": "2020-07-11T05:10:27Z", "url": "https://github.com/apache/hadoop/pull/2133", "merged": true, "mergeCommit": {"oid": "872c2909bdc636ec2c7da3f94b9e07348e3a6f0f"}, "closed": true, "closedAt": "2020-08-22T17:48:22Z", "author": {"login": "swamirishi"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcz7v-MgH2gAyNDQ3NzIwOTEyOjEwZDBmYWI3MjZjODBlMzIyODdjMmI5MDE4MjQ3YTI0NjlkNzMxNTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAX0gQAH2gAyNDQ3NzIwOTEyOjk4N2E5YWExYTFhMDM5MDk2ODAzYzNlZWE1YTJkYWU4Nzc4NDQyYjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "10d0fab726c80e32287c2b9018247a2469d73154", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/10d0fab726c80e32287c2b9018247a2469d73154", "committedDate": "2020-07-11T17:33:01Z", "message": "HADOOP-17122: Preserving Directory Attributes in DistCp with Atomic Copy"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed88a21116de29e3dc5ed77df68ae5978cc8c1ec", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/ed88a21116de29e3dc5ed77df68ae5978cc8c1ec", "committedDate": "2020-07-11T05:02:24Z", "message": "HADOOP-17122: Preserving Directory Attributes in DistCp with Atomic Copy"}, "afterCommit": {"oid": "10d0fab726c80e32287c2b9018247a2469d73154", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/10d0fab726c80e32287c2b9018247a2469d73154", "committedDate": "2020-07-11T17:33:01Z", "message": "HADOOP-17122: Preserving Directory Attributes in DistCp with Atomic Copy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NjczMDE4", "url": "https://github.com/apache/hadoop/pull/2133#pullrequestreview-459673018", "createdAt": "2020-08-02T19:29:57Z", "commit": {"oid": "10d0fab726c80e32287c2b9018247a2469d73154"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQxOToyOTo1N1rOG6nUEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQxOToyOTo1N1rOG6nUEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDExNDcwNQ==", "bodyText": "this wil be the HDFS minicluster, right?", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r464114705", "createdAt": "2020-08-02T19:29:57Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -177,6 +177,44 @@ public void testPreserveStatus() throws IOException {\n       conf.unset(DistCpConstants.CONF_LABEL_PRESERVE_STATUS);\n     }\n \n+  }\n+  @Test\n+  public void testPreserveStatusWithAtomicCommit() throws IOException {\n+    TaskAttemptContext taskAttemptContext = getTaskAttemptContext(config);\n+    JobContext jobContext = new JobContextImpl(taskAttemptContext.getConfiguration(),\n+                            taskAttemptContext.getTaskAttemptID().getJobID());\n+    Configuration conf = jobContext.getConfiguration();\n+    String sourceBase;\n+    String workBase;\n+    String targetBase;\n+    FileSystem fs = null;\n+    try {\n+      OutputCommitter committer = new CopyCommitter(null, taskAttemptContext);\n+      fs = FileSystem.get(conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10d0fab726c80e32287c2b9018247a2469d73154"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODY4NDM3", "url": "https://github.com/apache/hadoop/pull/2133#pullrequestreview-459868437", "createdAt": "2020-08-03T09:08:50Z", "commit": {"oid": "10d0fab726c80e32287c2b9018247a2469d73154"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOTowODo1MFrOG6x7Uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOTowODo1MFrOG6x7Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4ODU5NQ==", "bodyText": "Why we changed the path here ?? Assuming this test is for non-atomic, values of CONF_LABEL_TARGET_FINAL_PATH and CONF_LABEL_TARGET_WORK_PATH will be same.", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r464288595", "createdAt": "2020-08-03T09:08:50Z", "author": {"login": "mukund-thakur"}, "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -160,10 +160,10 @@ public void testPreserveStatus() throws IOException {\n       context.setTargetPathExists(false);\n \n       CopyListing listing = new GlobbedCopyListing(conf, CREDENTIALS);\n-      Path listingFile = new Path(\"/tmp1/\" + String.valueOf(rand.nextLong()));\n+      Path listingFile = new Path(\"/tmp1/\" + rand.nextLong());\n       listing.buildListing(listingFile, context);\n \n-      conf.set(DistCpConstants.CONF_LABEL_TARGET_WORK_PATH, targetBase);\n+      conf.set(DistCpConstants.CONF_LABEL_TARGET_FINAL_PATH, targetBase);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10d0fab726c80e32287c2b9018247a2469d73154"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MjcwNjEw", "url": "https://github.com/apache/hadoop/pull/2133#pullrequestreview-464270610", "createdAt": "2020-08-10T14:18:36Z", "commit": {"oid": "10d0fab726c80e32287c2b9018247a2469d73154"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoxODozNlrOG-QjUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyMjowOFrOG-QslA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzNjA4Mg==", "bodyText": "add newline", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r467936082", "createdAt": "2020-08-10T14:18:36Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -177,6 +177,44 @@ public void testPreserveStatus() throws IOException {\n       conf.unset(DistCpConstants.CONF_LABEL_PRESERVE_STATUS);\n     }\n \n+  }\n+  @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10d0fab726c80e32287c2b9018247a2469d73154"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzNjY1NA==", "bodyText": "do the same on lines 168 and 206", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r467936654", "createdAt": "2020-08-10T14:19:32Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -160,10 +160,10 @@ public void testPreserveStatus() throws IOException {\n       context.setTargetPathExists(false);\n \n       CopyListing listing = new GlobbedCopyListing(conf, CREDENTIALS);\n-      Path listingFile = new Path(\"/tmp1/\" + String.valueOf(rand.nextLong()));\n+      Path listingFile = new Path(\"/tmp1/\" + rand.nextLong());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10d0fab726c80e32287c2b9018247a2469d73154"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzODQ1Mg==", "bodyText": "you can do a static import for these constants if it keeps the code cleaner", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r467938452", "createdAt": "2020-08-10T14:22:08Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -177,6 +177,44 @@ public void testPreserveStatus() throws IOException {\n       conf.unset(DistCpConstants.CONF_LABEL_PRESERVE_STATUS);\n     }\n \n+  }\n+  @Test\n+  public void testPreserveStatusWithAtomicCommit() throws IOException {\n+    TaskAttemptContext taskAttemptContext = getTaskAttemptContext(config);\n+    JobContext jobContext = new JobContextImpl(taskAttemptContext.getConfiguration(),\n+                            taskAttemptContext.getTaskAttemptID().getJobID());\n+    Configuration conf = jobContext.getConfiguration();\n+    String sourceBase;\n+    String workBase;\n+    String targetBase;\n+    FileSystem fs = null;\n+    try {\n+      OutputCommitter committer = new CopyCommitter(null, taskAttemptContext);\n+      fs = FileSystem.get(conf);\n+      FsPermission sourcePerm = new FsPermission((short) 511);\n+      FsPermission initialPerm = new FsPermission((short) 448);\n+      sourceBase = TestDistCpUtils.createTestSetup(fs, sourcePerm);\n+      workBase = TestDistCpUtils.createTestSetup(fs, initialPerm);\n+      targetBase = \"/tmp1/\" + String.valueOf(rand.nextLong());\n+      final DistCpOptions options = new DistCpOptions.Builder(\n+              Collections.singletonList(new Path(sourceBase)), new Path(\"/out\"))\n+              .preserve(FileAttribute.PERMISSION).build();\n+      options.appendToConf(conf);\n+      final DistCpContext context = new DistCpContext(options);\n+      context.setTargetPathExists(false);\n+      CopyListing listing = new GlobbedCopyListing(conf, CREDENTIALS);\n+      Path listingFile = new Path(\"/tmp1/\" + String.valueOf(rand.nextLong()));\n+      listing.buildListing(listingFile, context);\n+      conf.set(DistCpConstants.CONF_LABEL_TARGET_FINAL_PATH, targetBase);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10d0fab726c80e32287c2b9018247a2469d73154"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91f2f8729d363f2bdba5070798a6e356f6f35aa1", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/91f2f8729d363f2bdba5070798a6e356f6f35aa1", "committedDate": "2020-08-10T16:28:19Z", "message": " HADOOP-17122: Addressing Review Comments for Preserving Directory Attributes"}, "afterCommit": {"oid": "1dc17b5db47c1cb43511756f58c3a20174f2fe46", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/1dc17b5db47c1cb43511756f58c3a20174f2fe46", "committedDate": "2020-08-10T16:35:24Z", "message": " HADOOP-17122: Addressing Review Comments for Preserving Directory Attributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "166ec387af72ca70b612154d1fc1e47a65647cad", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/166ec387af72ca70b612154d1fc1e47a65647cad", "committedDate": "2020-08-11T05:04:55Z", "message": " HADOOP-17122: Addressing Review Comments for Preserving Directory Attributes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1dc17b5db47c1cb43511756f58c3a20174f2fe46", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/1dc17b5db47c1cb43511756f58c3a20174f2fe46", "committedDate": "2020-08-10T16:35:24Z", "message": " HADOOP-17122: Addressing Review Comments for Preserving Directory Attributes"}, "afterCommit": {"oid": "166ec387af72ca70b612154d1fc1e47a65647cad", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/166ec387af72ca70b612154d1fc1e47a65647cad", "committedDate": "2020-08-11T05:04:55Z", "message": " HADOOP-17122: Addressing Review Comments for Preserving Directory Attributes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1ODk2MDI5", "url": "https://github.com/apache/hadoop/pull/2133#pullrequestreview-465896029", "createdAt": "2020-08-12T13:06:00Z", "commit": {"oid": "166ec387af72ca70b612154d1fc1e47a65647cad"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMzowNjowMFrOG_gZBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMzowNjowMFrOG_gZBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0NDE2Nw==", "bodyText": "nit: restore the line ending", "url": "https://github.com/apache/hadoop/pull/2133#discussion_r469244167", "createdAt": "2020-08-12T13:06:00Z", "author": {"login": "steveloughran"}, "path": "hadoop-tools/hadoop-distcp/src/test/java/org/apache/hadoop/tools/mapred/TestCopyCommitter.java", "diffHunk": "@@ -650,4 +653,4 @@ public RecordReader createRecordReader(InputSplit split,\n       return null;\n     }\n   }\n-}\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "166ec387af72ca70b612154d1fc1e47a65647cad"}, "originalPosition": 120}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f97e6f79a943aa76c174300df698af96793a176f", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/f97e6f79a943aa76c174300df698af96793a176f", "committedDate": "2020-08-13T06:11:52Z", "message": " HADOOP-17122: Restoring new line at the end"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4ad2f73de56136b31b739d55f918e20cc15abca", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/c4ad2f73de56136b31b739d55f918e20cc15abca", "committedDate": "2020-08-13T06:18:48Z", "message": " HADOOP-17122: Removing Whitespace from Added New line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eeff2e61d2838cdfd2322126964a298c6b74bda2", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/eeff2e61d2838cdfd2322126964a298c6b74bda2", "committedDate": "2020-08-19T09:00:30Z", "message": "HADOOP-17122: Correcting Whitespace checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "987a9aa1a1a039096803c3eea5a2dae8778442b3", "author": {"user": {"login": "swaminathan-b", "name": null}}, "url": "https://github.com/apache/hadoop/commit/987a9aa1a1a039096803c3eea5a2dae8778442b3", "committedDate": "2020-08-19T09:02:24Z", "message": "HADOOP-17122: Correcting Whitespace checks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4133, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}