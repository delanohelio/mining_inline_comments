{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MTMxMzA0", "number": 472, "title": "Added a query param to Create Artifact (ifExists)", "bodyText": "@carlesarnal I've created a new branch issues/362 so we can collaborate on this.  The branch exists on the upstream repository.  So you should be able to check it out and work on the back-end impl.", "createdAt": "2020-05-14T17:01:11Z", "url": "https://github.com/Apicurio/apicurio-registry/pull/472", "merged": true, "mergeCommit": {"oid": "923ba169147182e32ecab6ee0b4173a01451810c"}, "closed": true, "closedAt": "2020-05-18T12:37:54Z", "author": {"login": "EricWittmann"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchQgfQgH2gAyNDE4MTMxMzA0OjU5ZmY1N2QwZWVlNTU1OTZhZDRmMDliNTVlMTkxZDNkNTQ2NGQzNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcie99SAH2gAyNDE4MTMxMzA0OmI0ODU5MGY2ZGM5M2JhOWMzODAzMmM0YjA1ZDQ4MWRkZTY0YTE3YjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "59ff57d0eee55596ad4f09b55e191d3d5464d377", "author": {"user": {"login": "EricWittmann", "name": "Eric Wittmann"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/59ff57d0eee55596ad4f09b55e191d3d5464d377", "committedDate": "2020-05-14T16:59:33Z", "message": "Added a query param to Create Artifact to determine what happens when the artifact already exists."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a58f5e1040306d7ca9d2bc241fb52a21835b762", "author": {"user": {"login": "EricWittmann", "name": "Eric Wittmann"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/3a58f5e1040306d7ca9d2bc241fb52a21835b762", "committedDate": "2020-05-14T17:01:23Z", "message": "Merge branch 'master' into issues/362"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4130223eda4b2258441dbee69f6f738dc714cafd", "author": {"user": {"login": "carlesarnal", "name": "Carles Arnal"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/4130223eda4b2258441dbee69f6f738dc714cafd", "committedDate": "2020-05-15T11:20:49Z", "message": "Add if exists operation variants for artifact creation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNTc2OTU3", "url": "https://github.com/Apicurio/apicurio-registry/pull/472#pullrequestreview-412576957", "createdAt": "2020-05-15T11:49:04Z", "commit": {"oid": "4130223eda4b2258441dbee69f6f738dc714cafd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMTo0OTowNFrOGWBmrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMTo0OTowNFrOGWBmrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc0ODE0Mg==", "bodyText": "I think this introduces a race condition, but I'm not sure if we should care.  What do you think?  If two attempts to create the same artifact happen at the same time, they might both return null from handleIfExists and then both try to do the create.  The result would be a failure for one of them even if they passed something like RETURN for the new query param.\nAn alternative could be to actually go ahead and try the create.  Then if it fails handle the \"if exists\" logic at that point.  Thoughts?", "url": "https://github.com/Apicurio/apicurio-registry/pull/472#discussion_r425748142", "createdAt": "2020-05-15T11:49:04Z", "author": {"login": "EricWittmann"}, "path": "app/src/main/java/io/apicurio/registry/rest/ArtifactsResourceImpl.java", "diffHunk": "@@ -225,23 +258,21 @@ public void testUpdateArtifact(String artifactId, ArtifactType xRegistryArtifact\n     }\n \n     /**\n-     * @see io.apicurio.registry.rest.ArtifactsResource#createArtifact(io.apicurio.registry.types.ArtifactType, java.lang.String, java.io.InputStream)\n+     * @see io.apicurio.registry.rest.ArtifactsResource#createArtifact(io.apicurio.registry.types.ArtifactType, java.lang.String, io.apicurio.registry.rest.beans.IfExistsType, java.io.InputStream)\n      */\n     @Override\n-    public CompletionStage<ArtifactMetaData> createArtifact(ArtifactType xRegistryArtifactType, String xRegistryArtifactId,\n-                                                            InputStream data) {\n-        String artifactId = xRegistryArtifactId;\n-        if (artifactId == null || artifactId.trim().isEmpty()) {\n-            artifactId = idGenerator.generate();\n+    public CompletionStage<ArtifactMetaData> createArtifact(ArtifactType xRegistryArtifactType,\n+            String xRegistryArtifactId, IfExistsType ifExists, InputStream data) {\n+\n+        final CompletionStage<ArtifactMetaData> alreadyExistingArtifactResult = handleIfExists(\n+                xRegistryArtifactType, xRegistryArtifactId, ifExists, data);\n+\n+        if ( null != alreadyExistingArtifactResult) {\n+\n+            return alreadyExistingArtifactResult;\n         }\n-        ContentHandle content = ContentHandle.create(data);\n \n-        ArtifactType artifactType = determineArtifactType(content, xRegistryArtifactType, request);\n-        rulesService.applyRules(artifactId, artifactType, content, RuleApplicationType.CREATE);\n-        String finalArtifactId = artifactId;\n-        return storage.createArtifact(artifactId, artifactType, content)\n-                      .thenCompose(amdd -> indexArtifact(finalArtifactId, content, amdd))\n-                      .thenApply(dto -> DtoUtil.dtoToMetaData(finalArtifactId, artifactType, dto));\n+        return handleNotExistingArtifactCreation(xRegistryArtifactType, xRegistryArtifactId, data);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4130223eda4b2258441dbee69f6f738dc714cafd"}, "originalPosition": 104}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fa5bbb243a896afd45289cca6b5b76a8ec3fd46", "author": {"user": {"login": "carlesarnal", "name": "Carles Arnal"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/7fa5bbb243a896afd45289cca6b5b76a8ec3fd46", "committedDate": "2020-05-15T15:22:02Z", "message": "Fix search tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4af9c9179e7fd7a264018965c6ff84081303beb", "author": {"user": {"login": "carlesarnal", "name": "Carles Arnal"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/b4af9c9179e7fd7a264018965c6ff84081303beb", "committedDate": "2020-05-15T16:04:48Z", "message": "Randomize artifactId for test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4395c10e56d013dc37cd60a1453fcf7cfc6e2a3f", "author": {"user": {"login": "carlesarnal", "name": "Carles Arnal"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/4395c10e56d013dc37cd60a1453fcf7cfc6e2a3f", "committedDate": "2020-05-18T07:29:58Z", "message": "Add ifexists param handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ccac653d59e66ea4495b3522797eed56d69a23f", "author": {"user": {"login": "carlesarnal", "name": "Carles Arnal"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/9ccac653d59e66ea4495b3522797eed56d69a23f", "committedDate": "2020-05-18T07:39:10Z", "message": "Merge branch 'master' into issues/362"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b48590f6dc93ba9c38032c4b05d481dde64a17b1", "author": {"user": {"login": "EricWittmann", "name": "Eric Wittmann"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/b48590f6dc93ba9c38032c4b05d481dde64a17b1", "committedDate": "2020-05-18T12:24:20Z", "message": "Fixed indentation of handleIfExists()"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3478, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}