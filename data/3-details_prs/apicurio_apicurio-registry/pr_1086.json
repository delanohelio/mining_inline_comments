{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwNDcwNjcx", "number": 1086, "title": "special characters handling - % and non ASCII characters are now forbidden", "bodyText": "This PR implements the handling of special characters in artifactId in the UI, rest client and api backend.\nAfter some investigation around react-router (used in the UI) and okhttp and retrofit (used in the rest client) I concluded to no longer allow non ASCII characters and the percentage simbol &  to be part of an artifactId\nThe api now validates when creating an artifact if it's allowed, otherwise the backend returns http status 400\nIn the UI , react-router produced URI encoding issues that caused crashes in the web when the artifactId contained the character % , I have not been able to solve this by updating the router dependency so I decided to forbid the problematic character\nThe rest client had several issues handling special characters.\nokhttp does not allow to have non-ascii characters in the http headers (and we put the artifactId in a header when creating a new artifact), the solution I found was to forbid non ASCII characters in the whole project.\nThe other issue was with retrofit and the encoding of special characters in the URI , after some testing I noticed the encoding performed by retrofit is not compatible with the decoding that happens in the quarkus side (the registry backend). The solution I found was to implement the encoding of the artifactId in the rest client side.\nThis PR also includes new integration tests to verify all the changes made to the UI, the API and the rest-client", "createdAt": "2020-12-15T17:42:20Z", "url": "https://github.com/Apicurio/apicurio-registry/pull/1086", "merged": true, "mergeCommit": {"oid": "441de73bf7507ec818e920a1a52cd94d0ce959d8"}, "closed": true, "closedAt": "2020-12-17T16:57:56Z", "author": {"login": "famartinrh"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmdqyCAH2gAyNTQwNDcwNjcxOmUxMzBlMTdjM2FiM2MxMDZhZGE5YTE4YzVhNDVkMDY3NzBiNjg1OWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnGi5rAFqTU1NDc5OTU1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e130e17c3ab3c106ada9a18c5a45d06770b6859c", "author": {"user": {"login": "famartinrh", "name": "Fabian Martinez"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/e130e17c3ab3c106ada9a18c5a45d06770b6859c", "committedDate": "2020-12-15T17:20:20Z", "message": "special characters handling - % and non ASCII characters are now forbidden"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDYwMDIx", "url": "https://github.com/Apicurio/apicurio-registry/pull/1086#pullrequestreview-553460021", "createdAt": "2020-12-16T08:37:47Z", "commit": {"oid": "e130e17c3ab3c106ada9a18c5a45d06770b6859c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwODozNzo0N1rOIG5xxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwODozNzo0N1rOIG5xxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwODk5OQ==", "bodyText": "Since UTF-8 legacily supports ASCII, for me, +1 to UTF-8. That said if we end up using only US-ASCII characters (no accents etc) and I think that's the case here, then it shouldn't matter.", "url": "https://github.com/Apicurio/apicurio-registry/pull/1086#discussion_r544108999", "createdAt": "2020-12-16T08:37:47Z", "author": {"login": "carlesarnal"}, "path": "rest-client/src/main/java/io/apicurio/registry/client/RegistryRestClientImpl.java", "diffHunk": "@@ -438,4 +447,13 @@ public void setNextRequestHeaders(Map<String, String> headers) {\n     public Map<String, String> getHeaders() {\n         return requestHeaders.get();\n     }\n+\n+    private String encodeURIComponent(String value) {\n+        try {\n+            //TODO what to use here ASCII or UTF_8 ??", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e130e17c3ab3c106ada9a18c5a45d06770b6859c"}, "originalPosition": 201}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDYxOTMz", "url": "https://github.com/Apicurio/apicurio-registry/pull/1086#pullrequestreview-553461933", "createdAt": "2020-12-16T08:40:29Z", "commit": {"oid": "e130e17c3ab3c106ada9a18c5a45d06770b6859c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "215cddb8f590bacd7bc9e7097e7fa1e1b9733a24", "author": {"user": {"login": "EricWittmann", "name": "Eric Wittmann"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/215cddb8f590bacd7bc9e7097e7fa1e1b9733a24", "committedDate": "2020-12-17T12:42:29Z", "message": "Update ArtifactIdValidator.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTY4MDE3", "url": "https://github.com/Apicurio/apicurio-registry/pull/1086#pullrequestreview-554568017", "createdAt": "2020-12-17T12:43:09Z", "commit": {"oid": "e130e17c3ab3c106ada9a18c5a45d06770b6859c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjo0MzowOVrOIHz4wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjo0MzowOVrOIHz4wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA2MTA1Ng==", "bodyText": "Check it in the client to fail-fast, smart.", "url": "https://github.com/Apicurio/apicurio-registry/pull/1086#discussion_r545061056", "createdAt": "2020-12-17T12:43:09Z", "author": {"login": "EricWittmann"}, "path": "rest-client/src/main/java/io/apicurio/registry/client/RegistryRestClientImpl.java", "diffHunk": "@@ -231,133 +237,136 @@ public ArtifactMetaData createArtifact(String artifactId, ArtifactType artifactT\n     @Override\n     public ArtifactMetaData createArtifact(String artifactId, ArtifactType artifactType, InputStream data,\n                                            IfExistsType ifExists, Boolean canonical) {\n+        if (artifactId != null && !ArtifactIdValidator.isArtifactIdAllowed(artifactId)) {\n+            throw new InvalidArtifactIdException();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e130e17c3ab3c106ada9a18c5a45d06770b6859c"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTY5NTg3", "url": "https://github.com/Apicurio/apicurio-registry/pull/1086#pullrequestreview-554569587", "createdAt": "2020-12-17T12:45:33Z", "commit": {"oid": "e130e17c3ab3c106ada9a18c5a45d06770b6859c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjo0NTozM1rOIHz-Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMjo0NTozM1rOIHz-Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA2MjQyNg==", "bodyText": "UTF8 here too I guess.", "url": "https://github.com/Apicurio/apicurio-registry/pull/1086#discussion_r545062426", "createdAt": "2020-12-17T12:45:33Z", "author": {"login": "EricWittmann"}, "path": "tests/src/main/java/io/apicurio/tests/utils/subUtils/ArtifactUtils.java", "diffHunk": "@@ -206,4 +214,13 @@ public static Response createSchema(String schemeDefinition, String schemaName,\n     public static Response updateSchemaMetadata(String schemaName, String metadata, int returnCode) {\n         return putRequest(RestConstants.JSON, metadata, \"/ccompat/subjects/\" + schemaName + \"/meta\", returnCode);\n     }\n+\n+    private static String encodeURIComponent(String value) {\n+        try {\n+            //TODO what to use here ASCII or UTF_8 ??\n+            return URLEncoder.encode(value, StandardCharsets.US_ASCII.name());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e130e17c3ab3c106ada9a18c5a45d06770b6859c"}, "originalPosition": 174}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NTcxNTcy", "url": "https://github.com/Apicurio/apicurio-registry/pull/1086#pullrequestreview-554571572", "createdAt": "2020-12-17T12:48:25Z", "commit": {"oid": "e130e17c3ab3c106ada9a18c5a45d06770b6859c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f93c96a6e6db7c75530e948f27a4a99de9ea554f", "author": {"user": {"login": "famartinrh", "name": "Fabian Martinez"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/f93c96a6e6db7c75530e948f27a4a99de9ea554f", "committedDate": "2020-12-17T16:31:41Z", "message": "fix TODOs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0Nzk5NTUw", "url": "https://github.com/Apicurio/apicurio-registry/pull/1086#pullrequestreview-554799550", "createdAt": "2020-12-17T16:57:50Z", "commit": {"oid": "f93c96a6e6db7c75530e948f27a4a99de9ea554f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4311, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}