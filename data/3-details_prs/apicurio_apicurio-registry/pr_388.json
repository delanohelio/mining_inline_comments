{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2MDk0MTQy", "number": 388, "title": "Autodetect xml type", "bodyText": "@EricWittmann  as per comment at #355 (comment)\nTry to detect what type of XML format is being sent when no type is defined", "createdAt": "2020-04-20T14:19:59Z", "url": "https://github.com/Apicurio/apicurio-registry/pull/388", "merged": true, "mergeCommit": {"oid": "98309c32a28c54d1a2ca33b683737f9cb6831ecd"}, "closed": true, "closedAt": "2020-04-21T11:51:18Z", "author": {"login": "cfoskin"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZi_WCgFqTM5NjY4NjU0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZj5REgBqjMyNTMxNTYwMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2Njg2NTQ5", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#pullrequestreview-396686549", "createdAt": "2020-04-20T18:00:08Z", "commit": {"oid": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxODowMDowOVrOGIg2-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxODowMDowOVrOGIg2-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MDE1Mw==", "bodyText": "Can you remove this?  It's not needed.", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411580153", "createdAt": "2020-04-20T18:00:09Z", "author": {"login": "EricWittmann"}, "path": "app/src/main/java/io/apicurio/registry/util/ArtifactTypeUtil.java", "diffHunk": "@@ -29,29 +38,49 @@\n  * @author eric.wittmann@gmail.com\n  */\n public final class ArtifactTypeUtil {\n-    \n+\n     private static final ObjectMapper mapper = new ObjectMapper();\n-    \n+\n+    protected static ThreadLocal<DocumentBuilder> threadLocaldocBuilder = new ThreadLocal<DocumentBuilder>() {\n+        @Override\n+        protected DocumentBuilder initialValue() {\n+            DocumentBuilder builder = null;\n+            try {\n+                DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+                factory.setNamespaceAware(true);\n+                builder = factory.newDocumentBuilder();\n+            } catch (ParserConfigurationException e) {\n+                throw new RuntimeException(e);\n+            }\n+            return builder;\n+        }\n+\n+        @Override\n+        public DocumentBuilder get() {\n+            return super.get();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2Njg4NjI1", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#pullrequestreview-396688625", "createdAt": "2020-04-20T18:03:00Z", "commit": {"oid": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxODowMzowMFrOGIg-Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxODowMzowMFrOGIg-Hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4MTk4Mw==", "bodyText": "This should be the \"else\" clause in this logic.  Should be:  if isXsd() else if isWsdl() else { type = XML }", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411581983", "createdAt": "2020-04-20T18:03:00Z", "author": {"login": "EricWittmann"}, "path": "app/src/main/java/io/apicurio/registry/util/ArtifactTypeUtil.java", "diffHunk": "@@ -84,20 +113,47 @@ public static ArtifactType discoverType(ContentHandle content, String contentTyp\n         } catch (Exception e) {\n             // Apparently it's not JSON.\n         }\n-        \n+\n         // Try protobuf (only if we haven't already)\n         if (!triedProto) {\n             ArtifactType type = tryProto(content);\n             if (type != null) {\n                 return type;\n             }\n         }\n-        \n+\n         // Try GraphQL (SDL)\n         if (tryGraphQL(content)) {\n             return ArtifactType.GRAPHQL;\n         }\n-        \n+\n+        // Try the various XML formatted types\n+        try (InputStream stream = content.stream()) {\n+            Document xmlDocument = threadLocaldocBuilder.get().parse(stream);\n+            Element root = xmlDocument.getDocumentElement();\n+            String ns = root.getNamespaceURI();\n+\n+            if (ns == null) {\n+                // XML\n+                return ArtifactType.XML;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4"}, "originalPosition": 120}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjkxMTQ1", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#pullrequestreview-396691145", "createdAt": "2020-04-20T18:06:35Z", "commit": {"oid": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxODowNjozNlrOGIhGhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxODowNjozNlrOGIhGhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NDEzMw==", "bodyText": "We need to be more specific here - don't use contains.  Use equals and specifically check for the XSD namespace:  http://www.w3.org/2001/XMLSchema", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411584133", "createdAt": "2020-04-20T18:06:36Z", "author": {"login": "EricWittmann"}, "path": "app/src/main/java/io/apicurio/registry/util/ArtifactTypeUtil.java", "diffHunk": "@@ -84,20 +113,47 @@ public static ArtifactType discoverType(ContentHandle content, String contentTyp\n         } catch (Exception e) {\n             // Apparently it's not JSON.\n         }\n-        \n+\n         // Try protobuf (only if we haven't already)\n         if (!triedProto) {\n             ArtifactType type = tryProto(content);\n             if (type != null) {\n                 return type;\n             }\n         }\n-        \n+\n         // Try GraphQL (SDL)\n         if (tryGraphQL(content)) {\n             return ArtifactType.GRAPHQL;\n         }\n-        \n+\n+        // Try the various XML formatted types\n+        try (InputStream stream = content.stream()) {\n+            Document xmlDocument = threadLocaldocBuilder.get().parse(stream);\n+            Element root = xmlDocument.getDocumentElement();\n+            String ns = root.getNamespaceURI();\n+\n+            if (ns == null) {\n+                // XML\n+                return ArtifactType.XML;\n+            }\n+\n+            // XSD\n+            if (ns.contains(\"www.w3.org/2001/XMLSchema\")) {\n+                return ArtifactType.XSD;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4"}, "originalPosition": 125}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2Njk0NzE5", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#pullrequestreview-396694719", "createdAt": "2020-04-20T18:11:42Z", "commit": {"oid": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxODoxMTo0MlrOGIhTCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxODoxMTo0MlrOGIhTCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NzMzNw==", "bodyText": "We should look for specific namespace(s) here rather than use contains.  I think we need to check both of these:\n\nhttp://schemas.xmlsoap.org/wsdl/\nhttp://www.w3.org/ns/wsdl\n\nI do not believe that 2nd namespace ever got much traction, but that is WSDL 2.0's namespace.", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411587337", "createdAt": "2020-04-20T18:11:42Z", "author": {"login": "EricWittmann"}, "path": "app/src/main/java/io/apicurio/registry/util/ArtifactTypeUtil.java", "diffHunk": "@@ -84,20 +113,47 @@ public static ArtifactType discoverType(ContentHandle content, String contentTyp\n         } catch (Exception e) {\n             // Apparently it's not JSON.\n         }\n-        \n+\n         // Try protobuf (only if we haven't already)\n         if (!triedProto) {\n             ArtifactType type = tryProto(content);\n             if (type != null) {\n                 return type;\n             }\n         }\n-        \n+\n         // Try GraphQL (SDL)\n         if (tryGraphQL(content)) {\n             return ArtifactType.GRAPHQL;\n         }\n-        \n+\n+        // Try the various XML formatted types\n+        try (InputStream stream = content.stream()) {\n+            Document xmlDocument = threadLocaldocBuilder.get().parse(stream);\n+            Element root = xmlDocument.getDocumentElement();\n+            String ns = root.getNamespaceURI();\n+\n+            if (ns == null) {\n+                // XML\n+                return ArtifactType.XML;\n+            }\n+\n+            // XSD\n+            if (ns.contains(\"www.w3.org/2001/XMLSchema\")) {\n+                return ArtifactType.XSD;\n+            }\n+\n+            // WSDL\n+            if (ns.contains(\"schemas.xmlsoap.org/wsdl\")) {\n+                return ArtifactType.WSDL;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4"}, "originalPosition": 130}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2Njk1NTI2", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#pullrequestreview-396695526", "createdAt": "2020-04-20T18:12:57Z", "commit": {"oid": "f9a7951013aa4b338fdf7ffdcedfe86e651a62c4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NzI3MzYz", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#pullrequestreview-396727363", "createdAt": "2020-04-20T18:57:35Z", "commit": {"oid": "28ea0b94c377ad02d85e0086b721576fe57346d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxODo1NzozNVrOGIjCCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxODo1NzozNVrOGIjCCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYxNTc1NA==", "bodyText": "Now I see better why you had the null check up top.  But this is good I think.", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#discussion_r411615754", "createdAt": "2020-04-20T18:57:35Z", "author": {"login": "EricWittmann"}, "path": "app/src/main/java/io/apicurio/registry/util/ArtifactTypeUtil.java", "diffHunk": "@@ -84,20 +108,41 @@ public static ArtifactType discoverType(ContentHandle content, String contentTyp\n         } catch (Exception e) {\n             // Apparently it's not JSON.\n         }\n-        \n+\n         // Try protobuf (only if we haven't already)\n         if (!triedProto) {\n             ArtifactType type = tryProto(content);\n             if (type != null) {\n                 return type;\n             }\n         }\n-        \n+\n         // Try GraphQL (SDL)\n         if (tryGraphQL(content)) {\n             return ArtifactType.GRAPHQL;\n         }\n-        \n+\n+        // Try the various XML formatted types\n+        try (InputStream stream = content.stream()) {\n+            Document xmlDocument = threadLocaldocBuilder.get().parse(stream);\n+            Element root = xmlDocument.getDocumentElement();\n+            String ns = root.getNamespaceURI();\n+\n+            // XSD\n+            if (ns != null && ns.equals(\"http://www.w3.org/2001/XMLSchema\")) {\n+                return ArtifactType.XSD;\n+            } // WSDL\n+            else if (ns != null && (ns.equals(\"http://schemas.xmlsoap.org/wsdl/\")\n+                    || ns.equals(\"http://www.w3.org/ns/wsdl/\"))) {\n+                return ArtifactType.WSDL;\n+            } else {\n+                // default to XML since its been parsed\n+                return ArtifactType.XML;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28ea0b94c377ad02d85e0086b721576fe57346d6"}, "originalPosition": 122}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NzI3NjE0", "url": "https://github.com/Apicurio/apicurio-registry/pull/388#pullrequestreview-396727614", "createdAt": "2020-04-20T18:57:53Z", "commit": {"oid": "28ea0b94c377ad02d85e0086b721576fe57346d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c356c0b0427031182f4fb41e2587a9f653322a4", "author": {"user": {"login": "EricWittmann", "name": "Eric Wittmann"}}, "url": "https://github.com/Apicurio/apicurio-registry/commit/6c356c0b0427031182f4fb41e2587a9f653322a4", "committedDate": "2020-04-20T18:57:59Z", "message": "Merge branch 'master' into autodetect-xml-type"}, "afterCommit": {"oid": "5deb6f3600c1ed39c877ec7a4719a893234fa372", "author": {"user": null}, "url": "https://github.com/Apicurio/apicurio-registry/commit/5deb6f3600c1ed39c877ec7a4719a893234fa372", "committedDate": "2020-04-20T18:54:16Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "392bb6d67d1468f9b8123be7dfa692803c2c3105", "author": {"user": null}, "url": "https://github.com/Apicurio/apicurio-registry/commit/392bb6d67d1468f9b8123be7dfa692803c2c3105", "committedDate": "2020-04-20T19:02:44Z", "message": "added autodetection for xml,wsdl or xsd"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e793c25d01175d95760953023fd4e0bd812f75a9", "author": {"user": null}, "url": "https://github.com/Apicurio/apicurio-registry/commit/e793c25d01175d95760953023fd4e0bd812f75a9", "committedDate": "2020-04-20T19:02:44Z", "message": "removed unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9683d45234d8915b5712747798eec1d868085d9a", "author": {"user": null}, "url": "https://github.com/Apicurio/apicurio-registry/commit/9683d45234d8915b5712747798eec1d868085d9a", "committedDate": "2020-04-20T19:02:44Z", "message": "feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5deb6f3600c1ed39c877ec7a4719a893234fa372", "author": {"user": null}, "url": "https://github.com/Apicurio/apicurio-registry/commit/5deb6f3600c1ed39c877ec7a4719a893234fa372", "committedDate": "2020-04-20T18:54:16Z", "message": "feedback"}, "afterCommit": {"oid": "9683d45234d8915b5712747798eec1d868085d9a", "author": {"user": null}, "url": "https://github.com/Apicurio/apicurio-registry/commit/9683d45234d8915b5712747798eec1d868085d9a", "committedDate": "2020-04-20T19:02:44Z", "message": "feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3457, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}