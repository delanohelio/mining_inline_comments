{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MDE4MzE1", "number": 1034, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTo0ODoyM1rOE9mfqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODoxNjo1MlrOE-x54Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDI5Mjg5OnYy", "diffSide": "RIGHT", "path": "utils/sql/src/main/java/io/apicurio/registry/storage/impl/sql/CommonSqlStatements.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTo0ODoyM1rOH6YFZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODozNToxNFrOH8IXRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3NDA1Mw==", "bodyText": "Why don't just bind the globalId, like we're doing with the other parameters?", "url": "https://github.com/Apicurio/apicurio-registry/pull/1034#discussion_r530974053", "createdAt": "2020-11-26T11:48:23Z", "author": {"login": "carlesarnal"}, "path": "utils/sql/src/main/java/io/apicurio/registry/storage/impl/sql/CommonSqlStatements.java", "diffHunk": "@@ -147,17 +147,20 @@ public String updateArtifactLatest() {\n     public String updateArtifactLatestGlobalId() {\n         return \"UPDATE artifacts SET latest = (SELECT v.globalId FROM versions v WHERE v.artifactId = ? AND v.version = ?) WHERE artifactId = ?\";\n     }\n-    \n+\n     /**\n      * @see io.apicurio.registry.storage.impl.sql.SqlStatements#insertVersion()\n      */\n     @Override\n-    public String insertVersion(boolean firstVersion) {\n+    public String insertVersion(boolean firstVersion, String globalId) {\n+        String query;\n         if (firstVersion) {\n-            return \"INSERT INTO versions (artifactId, version, state, name, description, createdBy, createdOn, labels, properties, contentId) VALUES (?, 1, ?, ?, ?, ?, ?, ?, ?, ?)\";\n+            query = \"INSERT INTO versions (globalId, artifactId, version, state, name, description, createdBy, createdOn, labels, properties, contentId) VALUES (%s, ?, 1, ?, ?, ?, ?, ?, ?, ?, ?)\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf117c7ad67c9b9f931d80c9ef0bdb518d6a867e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk4MDQzNA==", "bodyText": "I tried that before, and in the case of the sql sequence case triying to bind nextval('globalidsequence') does not work.\nThe library we are using tries to bind that as the value to insert, and in that case it is an expression for the db to generate the value.\nAnd I needed to combine both, allowing the db to generate the value or providing the value beforehand", "url": "https://github.com/Apicurio/apicurio-registry/pull/1034#discussion_r530980434", "createdAt": "2020-11-26T11:59:56Z", "author": {"login": "famartinrh"}, "path": "utils/sql/src/main/java/io/apicurio/registry/storage/impl/sql/CommonSqlStatements.java", "diffHunk": "@@ -147,17 +147,20 @@ public String updateArtifactLatest() {\n     public String updateArtifactLatestGlobalId() {\n         return \"UPDATE artifacts SET latest = (SELECT v.globalId FROM versions v WHERE v.artifactId = ? AND v.version = ?) WHERE artifactId = ?\";\n     }\n-    \n+\n     /**\n      * @see io.apicurio.registry.storage.impl.sql.SqlStatements#insertVersion()\n      */\n     @Override\n-    public String insertVersion(boolean firstVersion) {\n+    public String insertVersion(boolean firstVersion, String globalId) {\n+        String query;\n         if (firstVersion) {\n-            return \"INSERT INTO versions (artifactId, version, state, name, description, createdBy, createdOn, labels, properties, contentId) VALUES (?, 1, ?, ?, ?, ?, ?, ?, ?, ?)\";\n+            query = \"INSERT INTO versions (globalId, artifactId, version, state, name, description, createdBy, createdOn, labels, properties, contentId) VALUES (%s, ?, 1, ?, ?, ?, ?, ?, ?, ?, ?)\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3NDA1Mw=="}, "originalCommit": {"oid": "cf117c7ad67c9b9f931d80c9ef0bdb518d6a867e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4OTc3Mg==", "bodyText": "I understand, but I think doing it this way is going to trigger security scanners to flag this as a SQL injection vulnerability (technically it is).  We could bind the value just like the other parameters if we make a separate DB call to get the next sequence value.  What do you think about that approach?", "url": "https://github.com/Apicurio/apicurio-registry/pull/1034#discussion_r532789772", "createdAt": "2020-11-30T17:56:11Z", "author": {"login": "EricWittmann"}, "path": "utils/sql/src/main/java/io/apicurio/registry/storage/impl/sql/CommonSqlStatements.java", "diffHunk": "@@ -147,17 +147,20 @@ public String updateArtifactLatest() {\n     public String updateArtifactLatestGlobalId() {\n         return \"UPDATE artifacts SET latest = (SELECT v.globalId FROM versions v WHERE v.artifactId = ? AND v.version = ?) WHERE artifactId = ?\";\n     }\n-    \n+\n     /**\n      * @see io.apicurio.registry.storage.impl.sql.SqlStatements#insertVersion()\n      */\n     @Override\n-    public String insertVersion(boolean firstVersion) {\n+    public String insertVersion(boolean firstVersion, String globalId) {\n+        String query;\n         if (firstVersion) {\n-            return \"INSERT INTO versions (artifactId, version, state, name, description, createdBy, createdOn, labels, properties, contentId) VALUES (?, 1, ?, ?, ?, ?, ?, ?, ?, ?)\";\n+            query = \"INSERT INTO versions (globalId, artifactId, version, state, name, description, createdBy, createdOn, labels, properties, contentId) VALUES (%s, ?, 1, ?, ?, ?, ?, ?, ?, ?, ?)\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3NDA1Mw=="}, "originalCommit": {"oid": "cf117c7ad67c9b9f931d80c9ef0bdb518d6a867e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwMTYyOQ==", "bodyText": "if making a separate DB call is fine with transactionality, which I guess it is , I'm ok with your approach", "url": "https://github.com/Apicurio/apicurio-registry/pull/1034#discussion_r532801629", "createdAt": "2020-11-30T18:15:29Z", "author": {"login": "famartinrh"}, "path": "utils/sql/src/main/java/io/apicurio/registry/storage/impl/sql/CommonSqlStatements.java", "diffHunk": "@@ -147,17 +147,20 @@ public String updateArtifactLatest() {\n     public String updateArtifactLatestGlobalId() {\n         return \"UPDATE artifacts SET latest = (SELECT v.globalId FROM versions v WHERE v.artifactId = ? AND v.version = ?) WHERE artifactId = ?\";\n     }\n-    \n+\n     /**\n      * @see io.apicurio.registry.storage.impl.sql.SqlStatements#insertVersion()\n      */\n     @Override\n-    public String insertVersion(boolean firstVersion) {\n+    public String insertVersion(boolean firstVersion, String globalId) {\n+        String query;\n         if (firstVersion) {\n-            return \"INSERT INTO versions (artifactId, version, state, name, description, createdBy, createdOn, labels, properties, contentId) VALUES (?, 1, ?, ?, ?, ?, ?, ?, ?, ?)\";\n+            query = \"INSERT INTO versions (globalId, artifactId, version, state, name, description, createdBy, createdOn, labels, properties, contentId) VALUES (%s, ?, 1, ?, ?, ?, ?, ?, ?, ?, ?)\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3NDA1Mw=="}, "originalCommit": {"oid": "cf117c7ad67c9b9f931d80c9ef0bdb518d6a867e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMzYzNw==", "bodyText": "Yeah should be fine with the Tx.  Let's try doing that - it should clean some things up.", "url": "https://github.com/Apicurio/apicurio-registry/pull/1034#discussion_r532813637", "createdAt": "2020-11-30T18:35:14Z", "author": {"login": "EricWittmann"}, "path": "utils/sql/src/main/java/io/apicurio/registry/storage/impl/sql/CommonSqlStatements.java", "diffHunk": "@@ -147,17 +147,20 @@ public String updateArtifactLatest() {\n     public String updateArtifactLatestGlobalId() {\n         return \"UPDATE artifacts SET latest = (SELECT v.globalId FROM versions v WHERE v.artifactId = ? AND v.version = ?) WHERE artifactId = ?\";\n     }\n-    \n+\n     /**\n      * @see io.apicurio.registry.storage.impl.sql.SqlStatements#insertVersion()\n      */\n     @Override\n-    public String insertVersion(boolean firstVersion) {\n+    public String insertVersion(boolean firstVersion, String globalId) {\n+        String query;\n         if (firstVersion) {\n-            return \"INSERT INTO versions (artifactId, version, state, name, description, createdBy, createdOn, labels, properties, contentId) VALUES (?, 1, ?, ?, ?, ?, ?, ?, ?, ?)\";\n+            query = \"INSERT INTO versions (globalId, artifactId, version, state, name, description, createdBy, createdOn, labels, properties, contentId) VALUES (%s, ?, 1, ?, ?, ?, ?, ?, ?, ?, ?)\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3NDA1Mw=="}, "originalCommit": {"oid": "cf117c7ad67c9b9f931d80c9ef0bdb518d6a867e"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjYyNzczOnYy", "diffSide": "RIGHT", "path": "storage/ksql/src/main/java/io/apicurio/registry/storage/impl/ksql/sql/KafkaSQLSink.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODoxMTo0MlrOH8HfiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODoxMTo0MlrOH8HfiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc5OTM2OA==", "bodyText": "We may need to revisit this for multi-tenancy if we go that way.  Fine for now though.  I wonder if we could use 10 or 12 bits when shifting to give us more headroom for the offset.  The less we bitshift the offset the fewer partitions we can have, but right now we can have 65k partitions which seems high.  Bitshifting by 10 would give us 1024 partitions and more headroom before we overran the integer.  Overrunning the integer is a concern for the ccompat API, which uses an integer for the globalId instead of a long.\nThoughts @Apicurio/developers ?", "url": "https://github.com/Apicurio/apicurio-registry/pull/1034#discussion_r532799368", "createdAt": "2020-11-30T18:11:42Z", "author": {"login": "EricWittmann"}, "path": "storage/ksql/src/main/java/io/apicurio/registry/storage/impl/ksql/sql/KafkaSQLSink.java", "diffHunk": "@@ -233,4 +264,16 @@ private boolean isGlobalRules(String artifactId) {\n         return artifactId.equals(KafkaSqlRegistryStorage.GLOBAL_RULES_ID);\n     }\n \n+    public long toGlobalId(long offset, int partition) {\n+        return getBaseOffset() + (offset << 16) + partition;\n+    }\n+\n+    // just to make sure we can always move the whole system\n+    // and not get duplicates; e.g. after move baseOffset = max(globalId) + 1\n+    public long getBaseOffset() {\n+        //TODO\n+        //        return Long.parseLong(properties.getProperty(\"storage.base.offset\", \"0\"));\n+        return 0;\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf117c7ad67c9b9f931d80c9ef0bdb518d6a867e"}, "originalPosition": 150}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjYzNjgyOnYy", "diffSide": "RIGHT", "path": "utils/sql/src/main/java/io/apicurio/registry/storage/impl/sql/SqlGlobalIdGenerator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODoxNDowN1rOH8HlGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODoxNDowN1rOH8HlGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwMDc5Mg==", "bodyText": "To avoid a SQL injection vector, this could instead actually make a call to the DB to get the next value and return it.", "url": "https://github.com/Apicurio/apicurio-registry/pull/1034#discussion_r532800792", "createdAt": "2020-11-30T18:14:07Z", "author": {"login": "EricWittmann"}, "path": "utils/sql/src/main/java/io/apicurio/registry/storage/impl/sql/SqlGlobalIdGenerator.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright 2020 Red Hat\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.apicurio.registry.storage.impl.sql;\n+\n+/**\n+ * @author Fabian Martinez\n+ */\n+public class SqlGlobalIdGenerator implements GlobalIdGenerator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf117c7ad67c9b9f931d80c9ef0bdb518d6a867e"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjY0ODAxOnYy", "diffSide": "RIGHT", "path": "utils/sql/src/main/resources/io/apicurio/registry/storage/impl/sql/h2.ddl", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODoxNjo1MlrOH8HrnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODoyMDozNFrOH8H0Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwMjQ2MA==", "bodyText": "If we change the date type to add WITHOUT TIME ZONE then I think we should do it in the artifacts table too.  Also we should change any other CLOB types to TEXT.  Should be consistent...", "url": "https://github.com/Apicurio/apicurio-registry/pull/1034#discussion_r532802460", "createdAt": "2020-11-30T18:16:52Z", "author": {"login": "EricWittmann"}, "path": "utils/sql/src/main/resources/io/apicurio/registry/storage/impl/sql/h2.ddl", "diffHunk": "@@ -25,7 +25,9 @@ ALTER TABLE content ADD CONSTRAINT UNQ_content_1 UNIQUE (contentHash);\n CREATE INDEX IDX_content_1 ON content(canonicalHash);\n CREATE INDEX IDX_content_2 ON content(contentHash);\n \n-CREATE TABLE versions (globalId BIGINT AUTO_INCREMENT NOT NULL, artifactId VARCHAR(512) NOT NULL, version INT NOT NULL, state VARCHAR(64) NOT NULL, name VARCHAR(512), description VARCHAR(1024), createdBy VARCHAR(256), createdOn TIMESTAMP NOT NULL, labels CLOB, properties CLOB, contentId BIGINT NOT NULL);\n+CREATE SEQUENCE globalidsequence;\n+\n+CREATE TABLE versions (globalId BIGINT NOT NULL, artifactId VARCHAR(512) NOT NULL, version INT NOT NULL, state VARCHAR(64) NOT NULL, name VARCHAR(512), description VARCHAR(1024), createdBy VARCHAR(256), createdOn TIMESTAMP WITHOUT TIME ZONE NOT NULL, labels TEXT, properties TEXT, contentId BIGINT NOT NULL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf117c7ad67c9b9f931d80c9ef0bdb518d6a867e"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwMzU5MA==", "bodyText": "I don't remember changing that column type, I'll return that to TIMESTAMP NOT NULL", "url": "https://github.com/Apicurio/apicurio-registry/pull/1034#discussion_r532803590", "createdAt": "2020-11-30T18:18:49Z", "author": {"login": "famartinrh"}, "path": "utils/sql/src/main/resources/io/apicurio/registry/storage/impl/sql/h2.ddl", "diffHunk": "@@ -25,7 +25,9 @@ ALTER TABLE content ADD CONSTRAINT UNQ_content_1 UNIQUE (contentHash);\n CREATE INDEX IDX_content_1 ON content(canonicalHash);\n CREATE INDEX IDX_content_2 ON content(contentHash);\n \n-CREATE TABLE versions (globalId BIGINT AUTO_INCREMENT NOT NULL, artifactId VARCHAR(512) NOT NULL, version INT NOT NULL, state VARCHAR(64) NOT NULL, name VARCHAR(512), description VARCHAR(1024), createdBy VARCHAR(256), createdOn TIMESTAMP NOT NULL, labels CLOB, properties CLOB, contentId BIGINT NOT NULL);\n+CREATE SEQUENCE globalidsequence;\n+\n+CREATE TABLE versions (globalId BIGINT NOT NULL, artifactId VARCHAR(512) NOT NULL, version INT NOT NULL, state VARCHAR(64) NOT NULL, name VARCHAR(512), description VARCHAR(1024), createdBy VARCHAR(256), createdOn TIMESTAMP WITHOUT TIME ZONE NOT NULL, labels TEXT, properties TEXT, contentId BIGINT NOT NULL);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwMjQ2MA=="}, "originalCommit": {"oid": "cf117c7ad67c9b9f931d80c9ef0bdb518d6a867e"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwNDY1MA==", "bodyText": "No I think the change is good - and is more consistent with PG!  :)  Let's just make the same change to the other types.  I think when I looked up the H2 types I must not have realized they supported that.  Same with TEXT.", "url": "https://github.com/Apicurio/apicurio-registry/pull/1034#discussion_r532804650", "createdAt": "2020-11-30T18:20:34Z", "author": {"login": "EricWittmann"}, "path": "utils/sql/src/main/resources/io/apicurio/registry/storage/impl/sql/h2.ddl", "diffHunk": "@@ -25,7 +25,9 @@ ALTER TABLE content ADD CONSTRAINT UNQ_content_1 UNIQUE (contentHash);\n CREATE INDEX IDX_content_1 ON content(canonicalHash);\n CREATE INDEX IDX_content_2 ON content(contentHash);\n \n-CREATE TABLE versions (globalId BIGINT AUTO_INCREMENT NOT NULL, artifactId VARCHAR(512) NOT NULL, version INT NOT NULL, state VARCHAR(64) NOT NULL, name VARCHAR(512), description VARCHAR(1024), createdBy VARCHAR(256), createdOn TIMESTAMP NOT NULL, labels CLOB, properties CLOB, contentId BIGINT NOT NULL);\n+CREATE SEQUENCE globalidsequence;\n+\n+CREATE TABLE versions (globalId BIGINT NOT NULL, artifactId VARCHAR(512) NOT NULL, version INT NOT NULL, state VARCHAR(64) NOT NULL, name VARCHAR(512), description VARCHAR(1024), createdBy VARCHAR(256), createdOn TIMESTAMP WITHOUT TIME ZONE NOT NULL, labels TEXT, properties TEXT, contentId BIGINT NOT NULL);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwMjQ2MA=="}, "originalCommit": {"oid": "cf117c7ad67c9b9f931d80c9ef0bdb518d6a867e"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3504, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}