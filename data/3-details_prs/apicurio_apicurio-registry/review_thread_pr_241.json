{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NTMxMzEz", "number": 241, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMzo0MzoyNFrODbOVfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNjozNzo1MVrODbo_NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5ODczMDIyOnYy", "diffSide": "RIGHT", "path": "app/src/main/java/io/apicurio/registry/metrics/RestMetricsInterceptor.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMzo0MzoyNFrOFilYbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNDo1MDowNFrOFjLG8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgwODM2Ng==", "bodyText": "Surprised to see this here.", "url": "https://github.com/Apicurio/apicurio-registry/pull/241#discussion_r371808366", "createdAt": "2020-01-28T13:43:24Z", "author": {"login": "EricWittmann"}, "path": "app/src/main/java/io/apicurio/registry/metrics/RestMetricsInterceptor.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package io.apicurio.registry.metrics;\n+\n+import org.eclipse.microprofile.metrics.ConcurrentGauge;\n+import org.eclipse.microprofile.metrics.Counter;\n+import org.eclipse.microprofile.metrics.Metadata;\n+import org.eclipse.microprofile.metrics.MetricRegistry;\n+import org.eclipse.microprofile.metrics.Tag;\n+import org.eclipse.microprofile.metrics.Timer;\n+import org.eclipse.microprofile.metrics.annotation.RegistryType;\n+\n+import javax.inject.Inject;\n+import javax.interceptor.AroundInvoke;\n+import javax.interceptor.Interceptor;\n+import javax.interceptor.InvocationContext;\n+\n+import static io.apicurio.registry.metrics.MetricIDs.*;\n+import static org.eclipse.microprofile.metrics.MetricRegistry.Type.APPLICATION;\n+import static org.eclipse.microprofile.metrics.MetricType.*;\n+import static org.eclipse.microprofile.metrics.MetricUnits.MILLISECONDS;\n+\n+/**\n+ * Interceptor that tracks metrics across all REST resources.\n+ *\n+ * @author Jakub Senko <jsenko@redhat.com>\n+ */\n+@Interceptor\n+@RestMetricsApply", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdcab3462127f1ac77e9a01a3c0ed120917bae8d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgxMTAxNQ==", "bodyText": "Where else is this annotation used and also where is it processed?  I can't figure out who processes this annotation.  Not sure how I missed that part of the review...", "url": "https://github.com/Apicurio/apicurio-registry/pull/241#discussion_r371811015", "createdAt": "2020-01-28T13:48:12Z", "author": {"login": "EricWittmann"}, "path": "app/src/main/java/io/apicurio/registry/metrics/RestMetricsInterceptor.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package io.apicurio.registry.metrics;\n+\n+import org.eclipse.microprofile.metrics.ConcurrentGauge;\n+import org.eclipse.microprofile.metrics.Counter;\n+import org.eclipse.microprofile.metrics.Metadata;\n+import org.eclipse.microprofile.metrics.MetricRegistry;\n+import org.eclipse.microprofile.metrics.Tag;\n+import org.eclipse.microprofile.metrics.Timer;\n+import org.eclipse.microprofile.metrics.annotation.RegistryType;\n+\n+import javax.inject.Inject;\n+import javax.interceptor.AroundInvoke;\n+import javax.interceptor.Interceptor;\n+import javax.interceptor.InvocationContext;\n+\n+import static io.apicurio.registry.metrics.MetricIDs.*;\n+import static org.eclipse.microprofile.metrics.MetricRegistry.Type.APPLICATION;\n+import static org.eclipse.microprofile.metrics.MetricType.*;\n+import static org.eclipse.microprofile.metrics.MetricUnits.MILLISECONDS;\n+\n+/**\n+ * Interceptor that tracks metrics across all REST resources.\n+ *\n+ * @author Jakub Senko <jsenko@redhat.com>\n+ */\n+@Interceptor\n+@RestMetricsApply", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgwODM2Ng=="}, "originalCommit": {"oid": "cdcab3462127f1ac77e9a01a3c0ed120917bae8d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg5MzE3Ng==", "bodyText": "This annotation binds this interceptor to be used on REST resource classes e.g https://github.com/Apicurio/apicurio-registry/pull/241/files?file-filters%5B%5D=.java#diff-f9081a654b4a4101633c7b7b1b7caf1fR78\nIt's collecting metrics across all of them, since the standard metrics annotations can only do this per-class/method.\nIt's possible that such aggregated metrics can be created on the receiver's side e.g. Prometheus, but this could be a way to provide smaller number of more useful metrics.", "url": "https://github.com/Apicurio/apicurio-registry/pull/241#discussion_r371893176", "createdAt": "2020-01-28T15:58:27Z", "author": {"login": "jsenko"}, "path": "app/src/main/java/io/apicurio/registry/metrics/RestMetricsInterceptor.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package io.apicurio.registry.metrics;\n+\n+import org.eclipse.microprofile.metrics.ConcurrentGauge;\n+import org.eclipse.microprofile.metrics.Counter;\n+import org.eclipse.microprofile.metrics.Metadata;\n+import org.eclipse.microprofile.metrics.MetricRegistry;\n+import org.eclipse.microprofile.metrics.Tag;\n+import org.eclipse.microprofile.metrics.Timer;\n+import org.eclipse.microprofile.metrics.annotation.RegistryType;\n+\n+import javax.inject.Inject;\n+import javax.interceptor.AroundInvoke;\n+import javax.interceptor.Interceptor;\n+import javax.interceptor.InvocationContext;\n+\n+import static io.apicurio.registry.metrics.MetricIDs.*;\n+import static org.eclipse.microprofile.metrics.MetricRegistry.Type.APPLICATION;\n+import static org.eclipse.microprofile.metrics.MetricType.*;\n+import static org.eclipse.microprofile.metrics.MetricUnits.MILLISECONDS;\n+\n+/**\n+ * Interceptor that tracks metrics across all REST resources.\n+ *\n+ * @author Jakub Senko <jsenko@redhat.com>\n+ */\n+@Interceptor\n+@RestMetricsApply", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgwODM2Ng=="}, "originalCommit": {"oid": "cdcab3462127f1ac77e9a01a3c0ed120917bae8d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk4Mzk4Mw==", "bodyText": "So I guess it's the platform that performs that binding?  The annotation doesn't have to be registered in any way?  Also, the definition of the annotation @RestMetricsApply indicates it can be used on a class or on a method but it's only used (I think) on classes.", "url": "https://github.com/Apicurio/apicurio-registry/pull/241#discussion_r371983983", "createdAt": "2020-01-28T18:37:36Z", "author": {"login": "EricWittmann"}, "path": "app/src/main/java/io/apicurio/registry/metrics/RestMetricsInterceptor.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package io.apicurio.registry.metrics;\n+\n+import org.eclipse.microprofile.metrics.ConcurrentGauge;\n+import org.eclipse.microprofile.metrics.Counter;\n+import org.eclipse.microprofile.metrics.Metadata;\n+import org.eclipse.microprofile.metrics.MetricRegistry;\n+import org.eclipse.microprofile.metrics.Tag;\n+import org.eclipse.microprofile.metrics.Timer;\n+import org.eclipse.microprofile.metrics.annotation.RegistryType;\n+\n+import javax.inject.Inject;\n+import javax.interceptor.AroundInvoke;\n+import javax.interceptor.Interceptor;\n+import javax.interceptor.InvocationContext;\n+\n+import static io.apicurio.registry.metrics.MetricIDs.*;\n+import static org.eclipse.microprofile.metrics.MetricRegistry.Type.APPLICATION;\n+import static org.eclipse.microprofile.metrics.MetricType.*;\n+import static org.eclipse.microprofile.metrics.MetricUnits.MILLISECONDS;\n+\n+/**\n+ * Interceptor that tracks metrics across all REST resources.\n+ *\n+ * @author Jakub Senko <jsenko@redhat.com>\n+ */\n+@Interceptor\n+@RestMetricsApply", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgwODM2Ng=="}, "originalCommit": {"oid": "cdcab3462127f1ac77e9a01a3c0ed120917bae8d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQyNjQ4MQ==", "bodyText": "Note: I misunderstood, the binding is done via @javax.interceptor.InterceptorBinding", "url": "https://github.com/Apicurio/apicurio-registry/pull/241#discussion_r372426481", "createdAt": "2020-01-29T14:50:04Z", "author": {"login": "jsenko"}, "path": "app/src/main/java/io/apicurio/registry/metrics/RestMetricsInterceptor.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package io.apicurio.registry.metrics;\n+\n+import org.eclipse.microprofile.metrics.ConcurrentGauge;\n+import org.eclipse.microprofile.metrics.Counter;\n+import org.eclipse.microprofile.metrics.Metadata;\n+import org.eclipse.microprofile.metrics.MetricRegistry;\n+import org.eclipse.microprofile.metrics.Tag;\n+import org.eclipse.microprofile.metrics.Timer;\n+import org.eclipse.microprofile.metrics.annotation.RegistryType;\n+\n+import javax.inject.Inject;\n+import javax.interceptor.AroundInvoke;\n+import javax.interceptor.Interceptor;\n+import javax.interceptor.InvocationContext;\n+\n+import static io.apicurio.registry.metrics.MetricIDs.*;\n+import static org.eclipse.microprofile.metrics.MetricRegistry.Type.APPLICATION;\n+import static org.eclipse.microprofile.metrics.MetricType.*;\n+import static org.eclipse.microprofile.metrics.MetricUnits.MILLISECONDS;\n+\n+/**\n+ * Interceptor that tracks metrics across all REST resources.\n+ *\n+ * @author Jakub Senko <jsenko@redhat.com>\n+ */\n+@Interceptor\n+@RestMetricsApply", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgwODM2Ng=="}, "originalCommit": {"oid": "cdcab3462127f1ac77e9a01a3c0ed120917bae8d"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjY1NzQ5OnYy", "diffSide": "RIGHT", "path": "app/src/main/java/io/apicurio/registry/metrics/RestMetricsApply.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNDo1MDo0NVrOFjLIbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNDo1MDo0NVrOFjLIbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQyNjg2Mg==", "bodyText": "Note: Remove ElementType.METHOD", "url": "https://github.com/Apicurio/apicurio-registry/pull/241#discussion_r372426862", "createdAt": "2020-01-29T14:50:45Z", "author": {"login": "jsenko"}, "path": "app/src/main/java/io/apicurio/registry/metrics/RestMetricsApply.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package io.apicurio.registry.metrics;\n+\n+import javax.interceptor.InterceptorBinding;\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+/**\n+ * @author Jakub Senko <jsenko@redhat.com>\n+ */\n+@InterceptorBinding\n+@Retention(RetentionPolicy.RUNTIME)\n+@Target({ElementType.TYPE, ElementType.METHOD})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdcab3462127f1ac77e9a01a3c0ed120917bae8d"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMzA4ODU0OnYy", "diffSide": "RIGHT", "path": "app/src/main/java/io/apicurio/registry/metrics/RestMetricsInterceptor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNjozNTo0OFrOFjPR4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNjozNTo0OFrOFjPR4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ5NDgxNw==", "bodyText": "MethodNotFound?", "url": "https://github.com/Apicurio/apicurio-registry/pull/241#discussion_r372494817", "createdAt": "2020-01-29T16:35:48Z", "author": {"login": "alesj"}, "path": "app/src/main/java/io/apicurio/registry/metrics/RestMetricsInterceptor.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package io.apicurio.registry.metrics;\n+\n+import org.eclipse.microprofile.metrics.ConcurrentGauge;\n+import org.eclipse.microprofile.metrics.Counter;\n+import org.eclipse.microprofile.metrics.Metadata;\n+import org.eclipse.microprofile.metrics.MetricRegistry;\n+import org.eclipse.microprofile.metrics.Tag;\n+import org.eclipse.microprofile.metrics.Timer;\n+import org.eclipse.microprofile.metrics.annotation.RegistryType;\n+\n+import javax.inject.Inject;\n+import javax.interceptor.AroundInvoke;\n+import javax.interceptor.Interceptor;\n+import javax.interceptor.InvocationContext;\n+\n+import static io.apicurio.registry.metrics.MetricIDs.*;\n+import static org.eclipse.microprofile.metrics.MetricRegistry.Type.APPLICATION;\n+import static org.eclipse.microprofile.metrics.MetricType.*;\n+import static org.eclipse.microprofile.metrics.MetricUnits.MILLISECONDS;\n+\n+/**\n+ * Interceptor that tracks metrics across all REST resources.\n+ *\n+ * @author Jakub Senko <jsenko@redhat.com>\n+ */\n+@Interceptor\n+@RestMetricsApply\n+public class RestMetricsInterceptor {\n+\n+\n+    @Inject\n+    @RegistryType(type = APPLICATION)\n+    MetricRegistry metricRegistry;\n+\n+    private Counter counter;\n+\n+    private ConcurrentGauge gauge;\n+\n+    private Timer timer;\n+\n+\n+    void init() {\n+        // Total counter\n+        final Metadata m1 = Metadata.builder()\n+                .withName(REST_REQUEST_COUNT)\n+                .withDescription(REST_REQUEST_COUNT_DESC + \" Across all endpoints.\")\n+                .withType(COUNTER)\n+                .build();\n+        final Tag[] tags1 = {new Tag(\"group\", REST_GROUP_TAG), new Tag(\"metric\", REST_REQUEST_COUNT)};\n+        counter = metricRegistry.counter(m1, tags1);\n+        // Concurrent gauge\n+        final Metadata m2 = Metadata.builder()\n+                .withName(REST_CONCURRENT_REQUEST_COUNT)\n+                .withDescription(REST_CONCURRENT_REQUEST_COUNT_DESC + \" Across all endpoints.\")\n+                .withType(CONCURRENT_GAUGE)\n+                .build();\n+        final Tag[] tags2 = {new Tag(\"group\", REST_GROUP_TAG), new Tag(\"metric\", REST_CONCURRENT_REQUEST_COUNT)};\n+        gauge = metricRegistry.concurrentGauge(m2, tags2);\n+        // Timer\n+        final Metadata m3 = Metadata.builder()\n+                .withName(REST_REQUEST_RESPONSE_TIME)\n+                .withDescription(REST_REQUEST_RESPONSE_TIME_DESC + \" Across all endpoints.\")\n+                .withType(TIMER)\n+                .withUnit(MILLISECONDS)\n+                .build();\n+        final Tag[] tags3 = {new Tag(\"group\", REST_GROUP_TAG), new Tag(\"metric\", REST_REQUEST_RESPONSE_TIME)};\n+        timer = metricRegistry.timer(m3, tags3);\n+    }\n+\n+    @AroundInvoke\n+    public Object intercept(InvocationContext context) throws Exception {\n+        if (counter == null) {\n+            init(); // @PostConstruct causes MethodNotFound ex.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "936bbead945e61445b419d78b8cba2130884cd85"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMzA5Njg1OnYy", "diffSide": "RIGHT", "path": "common/pom.xml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNjozNzo1MVrOFjPW0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNjo0MDo1OVrOFjPewA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ5NjA4MA==", "bodyText": "@jsenko perhaps this brings in quarkus-core  dep ... ?", "url": "https://github.com/Apicurio/apicurio-registry/pull/241#discussion_r372496080", "createdAt": "2020-01-29T16:37:51Z", "author": {"login": "alesj"}, "path": "common/pom.xml", "diffHunk": "@@ -38,6 +38,11 @@\n             <scope>provided</scope>\n         </dependency>\n \n+        <dependency>\n+            <groupId>io.quarkus</groupId>\n+            <artifactId>quarkus-smallrye-metrics</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "936bbead945e61445b419d78b8cba2130884cd85"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ5ODExMg==", "bodyText": "Needs to be provided?", "url": "https://github.com/Apicurio/apicurio-registry/pull/241#discussion_r372498112", "createdAt": "2020-01-29T16:40:59Z", "author": {"login": "EricWittmann"}, "path": "common/pom.xml", "diffHunk": "@@ -38,6 +38,11 @@\n             <scope>provided</scope>\n         </dependency>\n \n+        <dependency>\n+            <groupId>io.quarkus</groupId>\n+            <artifactId>quarkus-smallrye-metrics</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ5NjA4MA=="}, "originalCommit": {"oid": "936bbead945e61445b419d78b8cba2130884cd85"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3412, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}