{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MzcxNjg0", "number": 6492, "title": "Making ENSEMBL GTF Codec more permissive", "bodyText": "This will allow the ENSEMBL GTF codec to decode any ENSEMBL GTF file that they host.\nFixes #6488", "createdAt": "2020-03-10T21:23:06Z", "url": "https://github.com/broadinstitute/gatk/pull/6492", "merged": true, "mergeCommit": {"oid": "9f459ff7432f5e9809191a9fed6edcd02f215593"}, "closed": true, "closedAt": "2020-03-15T23:40:49Z", "author": {"login": "jonn-smith"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMXo31AH2gAyMzg2MzcxNjg0OjE3NjUzNjMxMGEwMTU0YzE1ZTE4NjVjYmEwOWRlYWU4NTQ4MWEzYjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOCSFTgFqTM3NDg0NzQ2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "176536310a0154c15e1865cba09deae85481a3b4", "author": {"user": {"login": "jonn-smith", "name": "Jonn Smith"}}, "url": "https://github.com/broadinstitute/gatk/commit/176536310a0154c15e1865cba09deae85481a3b4", "committedDate": "2020-03-10T19:25:38Z", "message": "Making the EnsemblGtfCodec match the ENSEMBL GTF Spec.\n\nThis required making a lot of changes for GTF files because of how\nstrict the parsing was and how permissive the ENSEMBL GTF spec actually\nis.\n\nStill a work in progress, but almost complete.\n\nFixes #6488"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "331b0e30b8ea0c93bc1da88acd4f17f51e3b373a", "author": {"user": {"login": "jonn-smith", "name": "Jonn Smith"}}, "url": "https://github.com/broadinstitute/gatk/commit/331b0e30b8ea0c93bc1da88acd4f17f51e3b373a", "committedDate": "2020-03-10T20:31:55Z", "message": "Fixing unit test issue."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNjkxMDA4", "url": "https://github.com/broadinstitute/gatk/pull/6492#pullrequestreview-373691008", "createdAt": "2020-03-12T16:03:35Z", "commit": {"oid": "331b0e30b8ea0c93bc1da88acd4f17f51e3b373a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNjowMzozNVrOF1k-3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNjoxNDoxM1rOF1lZbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNDc2NA==", "bodyText": "Seems like some duplicated code with isLineCommented but maybe complexity of sharing it makes it not worthwhile to refactor.", "url": "https://github.com/broadinstitute/gatk/pull/6492#discussion_r391724764", "createdAt": "2020-03-12T16:03:35Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/utils/codecs/gtf/AbstractGtfCodec.java", "diffHunk": "@@ -474,26 +474,53 @@ boolean checkHeaderLineStartsWith(final List<String> header, final int lineNum,\n \n     /**\n      * Checks that the given header line number starts with the given text.\n+     * Uses {@link #getAllLineComments()} to check for comments at the line starts.\n      * @param header A {@link List<String>} containing a header to validate.\n      * @param lineNum Line number in the header to check.\n      * @param startingText {@link String} containing text that the line should start with\n      * @param throwIfInvalid If {@code true} will throw a {@link UserException} instead of returning false.\n      * @return {@code true} IFF the header line number {@code lineNum} starts with {@code startingText}; {@code false} otherwise.\n      */\n     boolean checkHeaderLineStartsWith(final List<String> header, final int lineNum, final String startingText, final boolean throwIfInvalid ) {\n-        if ( !header.get(lineNum).startsWith(getLineComment() + startingText) ) {\n+        boolean foundGoodLine = false;\n+        for ( final String commentPrefix : getAllLineComments() ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331b0e30b8ea0c93bc1da88acd4f17f51e3b373a"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNTU1Mw==", "bodyText": "COMMENT_PREFIXES and group it with the other statics", "url": "https://github.com/broadinstitute/gatk/pull/6492#discussion_r391725553", "createdAt": "2020-03-12T16:04:48Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/utils/codecs/gtf/EnsemblGtfCodec.java", "diffHunk": "@@ -29,12 +28,16 @@\n     //==================================================================================================================\n     // Private Static Members:\n \n+    private static String VERSION_FIELD = \"genome-version\";\n+    private static String DEFAULT_VERSION = \"ENSEMBL_DEFAULT_VERSION\";\n+\n     //==================================================================================================================\n     // Private Members:\n \n-    private final List<String> header         = new ArrayList<>();\n-    private       int          currentLineNum = 1;\n-    private       String       version        = \"\";\n+    private final        List<String> header          = new ArrayList<>();\n+    private              int          currentLineNum  = 1;\n+    private              String       version         = null;\n+    private static final Set<String>  commentPrefixes = Collections.unmodifiableSet(new LinkedHashSet<>(Arrays.asList(\"#!\", \"##\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331b0e30b8ea0c93bc1da88acd4f17f51e3b373a"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNjA3Nw==", "bodyText": "Oh, I didn't realize that.  Does that imply that the ensemble codec should extend GencodecodeGtfCodec instead of being a parallel class to it?  Maybe something to think about in the future.", "url": "https://github.com/broadinstitute/gatk/pull/6492#discussion_r391726077", "createdAt": "2020-03-12T16:05:43Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/utils/codecs/gtf/EnsemblGtfCodec.java", "diffHunk": "@@ -120,7 +121,28 @@ void incrementLineNumber() {\n \n     @Override\n     String getUcscVersionNumber() {\n-        return getVersionFromHeader();\n+        return version;\n+    }\n+\n+    @Override\n+    /**\n+     * {@inheritDoc}\n+     *\n+     * Because ENSEMBL GTF files are strictly a superset of GENCODE GTF files, we need to do some extra checks here to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331b0e30b8ea0c93bc1da88acd4f17f51e3b373a"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyOTk5Ng==", "bodyText": "disgusting", "url": "https://github.com/broadinstitute/gatk/pull/6492#discussion_r391729996", "createdAt": "2020-03-12T16:11:49Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/utils/codecs/gtf/EnsemblGtfCodec.java", "diffHunk": "@@ -162,23 +203,27 @@ static boolean validateEnsemblGtfFeature(final GencodeGtfFeature feature) {\n      */\n     @VisibleForTesting\n     boolean validateHeader(final List<String> header, final boolean throwIfInvalid) {\n-        if ( header.size() != HEADER_NUM_LINES) {\n-            if ( throwIfInvalid ) {\n-                throw new UserException.MalformedFile(\n-                        \"ENSEMBL GTF Header is of unexpected length: \" +\n-                                header.size() + \" != \" + HEADER_NUM_LINES);\n-            }\n-            else {\n-                return false;\n+        // As it turns out, the ENSEMBL GTF header is pretty loosy-goosy.\n+        // No fields are required, and therefore it could actually be empty.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331b0e30b8ea0c93bc1da88acd4f17f51e3b373a"}, "originalPosition": 148}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTczMDg4Ng==", "bodyText": "Are there fields that YOU require even if ENSEMBLE doesn't?  It might be a good idea to warn if things like the version are missing.", "url": "https://github.com/broadinstitute/gatk/pull/6492#discussion_r391730886", "createdAt": "2020-03-12T16:13:19Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/utils/codecs/gtf/EnsemblGtfCodec.java", "diffHunk": "@@ -162,23 +203,27 @@ static boolean validateEnsemblGtfFeature(final GencodeGtfFeature feature) {\n      */\n     @VisibleForTesting\n     boolean validateHeader(final List<String> header, final boolean throwIfInvalid) {\n-        if ( header.size() != HEADER_NUM_LINES) {\n-            if ( throwIfInvalid ) {\n-                throw new UserException.MalformedFile(\n-                        \"ENSEMBL GTF Header is of unexpected length: \" +\n-                                header.size() + \" != \" + HEADER_NUM_LINES);\n-            }\n-            else {\n-                return false;\n+        // As it turns out, the ENSEMBL GTF header is pretty loosy-goosy.\n+        // No fields are required, and therefore it could actually be empty.\n+\n+        // Rather than attempting to validate the file, here we just\n+        // assert that all header lines begin with a comment (they should already).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331b0e30b8ea0c93bc1da88acd4f17f51e3b373a"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTczMTU2NA==", "bodyText": "static", "url": "https://github.com/broadinstitute/gatk/pull/6492#discussion_r391731564", "createdAt": "2020-03-12T16:14:13Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/utils/codecs/gtf/GencodeGtfFeature.java", "diffHunk": "@@ -44,6 +44,15 @@\n \n     private static final Logger logger = LogManager.getLogger(GencodeGtfFeature.class);\n \n+    // ===========================================================================\n+\n+\n+    public static final String ANNOTATION_SOURCE_ENSEMBL = \"ENSEMBL\";\n+    public static final String ANNOTATION_SOURCE_HAVANA = \"HAVANA\";\n+    public static String ANNOTATION_SOURCE_ENA = \"ena\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331b0e30b8ea0c93bc1da88acd4f17f51e3b373a"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39bdddf1e8e7a0df63af56722250605299a75abe", "author": {"user": {"login": "jonn-smith", "name": "Jonn Smith"}}, "url": "https://github.com/broadinstitute/gatk/commit/39bdddf1e8e7a0df63af56722250605299a75abe", "committedDate": "2020-03-12T17:42:34Z", "message": "Addressing review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczODg5NDQy", "url": "https://github.com/broadinstitute/gatk/pull/6492#pullrequestreview-373889442", "createdAt": "2020-03-12T20:47:27Z", "commit": {"oid": "39bdddf1e8e7a0df63af56722250605299a75abe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMDo0NzoyN1rOF1uyEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMDo0NzoyN1rOF1uyEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg4NTMyOQ==", "bodyText": "shouldn't the other other implementation make use of this one now?", "url": "https://github.com/broadinstitute/gatk/pull/6492#discussion_r391885329", "createdAt": "2020-03-12T20:47:27Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/utils/codecs/gtf/AbstractGtfCodec.java", "diffHunk": "@@ -521,6 +515,25 @@ boolean isLineCommented(final String line) {\n         return isCommented;\n     }\n \n+    /**\n+     * Checks whether the given line is commented out or not and if the content of the line begins with the given", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39bdddf1e8e7a0df63af56722250605299a75abe"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "383e3c501b4f12592f749373d0cc4d032869a028", "author": {"user": {"login": "jonn-smith", "name": "Jonn Smith"}}, "url": "https://github.com/broadinstitute/gatk/commit/383e3c501b4f12592f749373d0cc4d032869a028", "committedDate": "2020-03-12T20:59:35Z", "message": "Fixed another code review comment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0ODQ3NDY2", "url": "https://github.com/broadinstitute/gatk/pull/6492#pullrequestreview-374847466", "createdAt": "2020-03-15T23:40:35Z", "commit": {"oid": "383e3c501b4f12592f749373d0cc4d032869a028"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2795, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}