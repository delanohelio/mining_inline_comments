{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNjM1Njcz", "number": 6764, "title": "Using Docker Stages to support no-argument docker bulding ", "bodyText": "Running just \"docker build .\" in a gatk clone works with this branch. Unfortunately unless you then run a prune command you will end up with a 9 GB \"waste\" docker image from the first stage leftover. The build.docker script handles this situation by deleting the intermediate stage using tags...\nFixes #6747", "createdAt": "2020-08-24T16:37:23Z", "url": "https://github.com/broadinstitute/gatk/pull/6764", "merged": true, "mergeCommit": {"oid": "d8588cc4410375edc6052097ff25c825186eeed2"}, "closed": true, "closedAt": "2020-08-31T20:23:30Z", "author": {"login": "jamesemery"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDAhryAH2gAyNDcyNjM1NjczOmZkOWZhNGRhODgyMzU2ZTZhOGM0ZDEyNzRiYmZlYTBkODI2N2M1Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEXw_0AFqTQ3ODg4NDI2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fd9fa4da882356e6a8c4d1274bbfea0d8267c527", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/fd9fa4da882356e6a8c4d1274bbfea0d8267c527", "committedDate": "2020-08-27T13:35:48Z", "message": "changing the build docker image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e92687e5c8b5992faca20277e2b9c91a57bfecdc", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/e92687e5c8b5992faca20277e2b9c91a57bfecdc", "committedDate": "2020-08-27T13:35:51Z", "message": "updated the build docker script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e7d451f808d6c26d05828e2297b873407887e46", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/1e7d451f808d6c26d05828e2297b873407887e46", "committedDate": "2020-08-27T13:36:12Z", "message": "repairing the issue with the docker images for travis tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "982144786e27d96a7bb4018e9ce60dd1ca196a44", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/982144786e27d96a7bb4018e9ce60dd1ca196a44", "committedDate": "2020-08-27T13:36:12Z", "message": "oh right... travis... my favorite..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c2c733fcef935173a90e2e40e7905854585f4fd", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/1c2c733fcef935173a90e2e40e7905854585f4fd", "committedDate": "2020-08-27T13:36:12Z", "message": "exotic problems call for exotic solutions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90d19f533e473389ca226182c68c853d2731b735", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/90d19f533e473389ca226182c68c853d2731b735", "committedDate": "2020-08-27T13:36:12Z", "message": "even more flailing arround"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2868ddc82547bca5a190954a3d50567c84ce4014", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/2868ddc82547bca5a190954a3d50567c84ce4014", "committedDate": "2020-08-27T13:36:12Z", "message": "order matters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "019cb3cf309c5585190166892140b887152e0237", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/019cb3cf309c5585190166892140b887152e0237", "committedDate": "2020-08-27T13:36:12Z", "message": "perhaps not?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce5106f3f51b50af2a9d139716b4a5d2c46e40b4", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/ce5106f3f51b50af2a9d139716b4a5d2c46e40b4", "committedDate": "2020-08-27T13:36:12Z", "message": "permissions pain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92b9489a3dc35cd1300ad51168f8ac5c92fcdd56", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/92b9489a3dc35cd1300ad51168f8ac5c92fcdd56", "committedDate": "2020-08-27T13:36:13Z", "message": "permissions pain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b56d829fb2b9edcfd43fb164d5f1d5488b07ac4e", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/b56d829fb2b9edcfd43fb164d5f1d5488b07ac4e", "committedDate": "2020-08-27T13:36:13Z", "message": "more ghasping at straws"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90ed8703fa4ac9ba3393b601be9162f12e22327c", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/90ed8703fa4ac9ba3393b601be9162f12e22327c", "committedDate": "2020-08-27T13:36:13Z", "message": "repairing the test for travis..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c88c2d548ca0ac48904deefd22d49ed127e2e6b5", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/c88c2d548ca0ac48904deefd22d49ed127e2e6b5", "committedDate": "2020-08-27T13:36:13Z", "message": "more witchcraft"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dadc7e312a8f6825e95a50c26345dd9cfdfae58b", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/dadc7e312a8f6825e95a50c26345dd9cfdfae58b", "committedDate": "2020-08-27T13:36:13Z", "message": "duct tape and bubbblegum"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "374b0cd4db8585cda02f1cc5ac9178704118a4e8", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/374b0cd4db8585cda02f1cc5ac9178704118a4e8", "committedDate": "2020-08-26T20:45:47Z", "message": "duct tape and bubbblegum"}, "afterCommit": {"oid": "dadc7e312a8f6825e95a50c26345dd9cfdfae58b", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/dadc7e312a8f6825e95a50c26345dd9cfdfae58b", "committedDate": "2020-08-27T13:36:13Z", "message": "duct tape and bubbblegum"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c80e1d8b776352a4072034294e8bc925197303b5", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/c80e1d8b776352a4072034294e8bc925197303b5", "committedDate": "2020-08-27T14:49:12Z", "message": "testing permissions..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94d1361a2740fe08d386930348503c9c07b0c209", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/94d1361a2740fe08d386930348503c9c07b0c209", "committedDate": "2020-08-27T14:53:41Z", "message": "fixing a bash bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58c3aeb2b56ec328bc18f23403116a0d94ec2a07", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/58c3aeb2b56ec328bc18f23403116a0d94ec2a07", "committedDate": "2020-08-27T16:27:27Z", "message": "simple is simplest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aae1ebb1908f88e9bd222bf123cb3ea78c5d9140", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/aae1ebb1908f88e9bd222bf123cb3ea78c5d9140", "committedDate": "2020-08-28T15:12:41Z", "message": ";"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3ODkyMTk3", "url": "https://github.com/broadinstitute/gatk/pull/6764#pullrequestreview-477892197", "createdAt": "2020-08-28T17:06:04Z", "commit": {"oid": "aae1ebb1908f88e9bd222bf123cb3ea78c5d9140"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNzowNjowNFrOHJOHGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNzoxOTowN1rOHJOgAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzMDQyNQ==", "bodyText": "Why was this necessary?  Just precautionary?", "url": "https://github.com/broadinstitute/gatk/pull/6764#discussion_r479430425", "createdAt": "2020-08-28T17:06:04Z", "author": {"login": "lbergelson"}, "path": ".travis.yml", "diffHunk": "@@ -158,15 +158,22 @@ script:\n     fi;\n     sudo docker images;\n     echo ${TEST_TYPE};\n-    sudo mkdir -p build/reports/;\n-    sudo chmod -R a+w build/reports/;\n+    sudo rm -r ./build;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aae1ebb1908f88e9bd222bf123cb3ea78c5d9140"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzNDc1NA==", "bodyText": "Could you add a comment or echo here to say what this is for?", "url": "https://github.com/broadinstitute/gatk/pull/6764#discussion_r479434754", "createdAt": "2020-08-28T17:14:48Z", "author": {"login": "lbergelson"}, "path": "build_docker.sh", "diffHunk": "@@ -112,22 +112,14 @@ if [ -n \"${IS_PUSH}\" ]; then\n else\n     RELEASE=false\n fi\n-./gradlew clean collectBundleIntoDir shadowTestClassJar shadowTestJar -Drelease=$RELEASE\n-ZIPPATHGATK=$( find ./build -name \"*bundle-files-collected\" )\n-mv ${ZIPPATHGATK} ./unzippedJar\n-ZIPPATHPYTHON=$( find ./unzippedJar -name \"gatkPython*.zip\" )\n-unzip -o -j ${ZIPPATHPYTHON} -d ./unzippedJar/scripts\n-\n-mkdir ${STAGING_ABSOLUTE_PATH:-.}/testJars\n-mv $( find ./build/libs/ -name \"gatk*test.jar\" ) ${STAGING_ABSOLUTE_PATH:-.}/testJars\n-mv $( find ./build/libs/ -name \"gatk*testDependencies.jar\" ) ${STAGING_ABSOLUTE_PATH:-.}/testJars\n \n echo \"Building image to tag ${REPO_PRJ}:${GITHUB_TAG}...\"\n if [ -n \"${IS_PUSH}\" ]; then\n-    docker build -t ${REPO_PRJ}:${GITHUB_TAG} --squash --build-arg ZIPPATH=./unzippedJar .\n+    docker build -t ${REPO_PRJ}:${GITHUB_TAG} --squash .\n else\n-    docker build -t ${REPO_PRJ}:${GITHUB_TAG} --build-arg ZIPPATH=./unzippedJar .\n+    docker build -t ${REPO_PRJ}:${GITHUB_TAG} .\n fi\n+docker image prune -f --filter label=stage=gatkIntermediateBuildImage", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aae1ebb1908f88e9bd222bf123cb3ea78c5d9140"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzNTc2NA==", "bodyText": "Could you add some comments here explaining what this is for?", "url": "https://github.com/broadinstitute/gatk/pull/6764#discussion_r479435764", "createdAt": "2020-08-28T17:16:57Z", "author": {"login": "lbergelson"}, "path": ".travis.yml", "diffHunk": "@@ -158,15 +158,22 @@ script:\n     fi;\n     sudo docker images;\n     echo ${TEST_TYPE};\n-    sudo mkdir -p build/reports/;\n-    sudo chmod -R a+w build/reports/;\n+    sudo rm -r ./build;\n+    ./gradlew clean shadowTestClassJar shadowTestJar;\n+    mkdir ./testJars;\n+    echo $( find ./build/libs/ -name \"gatk*test.jar\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aae1ebb1908f88e9bd222bf123cb3ea78c5d9140"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzNjYyOA==", "bodyText": "We should be careful about this substitution.  Can you have it default to ./gatk if it doesn't exist?", "url": "https://github.com/broadinstitute/gatk/pull/6764#discussion_r479436628", "createdAt": "2020-08-28T17:18:46Z", "author": {"login": "lbergelson"}, "path": "src/test/java/org/broadinstitute/hellbender/engine/PipelineSupportIntegrationTest.java", "diffHunk": "@@ -16,8 +16,8 @@\n     // Asserting that Picard programs are able to pipe their output without errors\n     public void testPipeForPicardTools() {\n         File output = createTempFile(\"testOutput\",\".bam\");\n-        BaseTest.runProcess(ProcessController.getThreadLocal(), new String[]{\"/bin/sh\",\"-c\",\" ./gatk SortSam -I \"+INPUT_BAM+\" -O /dev/stdout -SO coordinate \" +\n-                \"| ./gatk SetNmMdAndUqTags -I /dev/stdin -O \"+ output.getAbsolutePath()+ \" --CREATE_INDEX true -R \"+b37_reference_20_21});//.split(\" \"));\n+        BaseTest.runProcess(ProcessController.getThreadLocal(), new String[]{\"/bin/sh\",\"-c\",\" ${GATK_LAUNCH_SCRIPT} SortSam -I \"+INPUT_BAM+\" -O /dev/stdout -SO coordinate \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aae1ebb1908f88e9bd222bf123cb3ea78c5d9140"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzNjgwMg==", "bodyText": "comments about the test jar would be useful to explain that it's necessary plumbing for tests but not for the build itself", "url": "https://github.com/broadinstitute/gatk/pull/6764#discussion_r479436802", "createdAt": "2020-08-28T17:19:07Z", "author": {"login": "lbergelson"}, "path": "Dockerfile", "diffHunk": "@@ -1,13 +1,28 @@\n-# Using OpenJDK 8\n-FROM broadinstitute/gatk:gatkbase-2.3.0\n+# stage 1 for constructing the GATK zip\n+FROM broadinstitute/gatk:gatkbase-2.3.0 AS gradleBuild\n+LABEL stage=gatkIntermediateBuildImage\n \n-# Location of the unzipped gatk bundle files\n-ARG ZIPPATH\n+RUN ls .\n+ADD . /gatk\n+WORKDIR /gatk\n+\n+RUN export GRADLE_OPTS=\"-Xmx4048m -Dorg.gradle.daemon=false\" && /gatk/gradlew clean collectBundleIntoDir shadowTestClassJar shadowTestJar -Drelease=$RELEASE\n+RUN cp -r $( find /gatk/build -name \"*bundle-files-collected\" )/ /gatk/unzippedJar/\n+RUN unzip -o -j $( find /gatk/unzippedJar -name \"gatkPython*.zip\" ) -d /gatk/unzippedJar/scripts", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aae1ebb1908f88e9bd222bf123cb3ea78c5d9140"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7004be410252eeb0fa7acdec973e0c20daf1d53e", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/7004be410252eeb0fa7acdec973e0c20daf1d53e", "committedDate": "2020-08-31T14:11:58Z", "message": "remove the sudo rm -rf build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3f4e424a101754d5cef1e48a8c4256a62a52d18", "author": {"user": {"login": "jamesemery", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/d3f4e424a101754d5cef1e48a8c4256a62a52d18", "committedDate": "2020-08-31T14:22:46Z", "message": "responding to review comments... god help us"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4ODg0MjY3", "url": "https://github.com/broadinstitute/gatk/pull/6764#pullrequestreview-478884267", "createdAt": "2020-08-31T19:14:16Z", "commit": {"oid": "d3f4e424a101754d5cef1e48a8c4256a62a52d18"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2703, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}