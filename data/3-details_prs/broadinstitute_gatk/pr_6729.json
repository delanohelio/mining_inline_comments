{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3ODg4MzQz", "number": 6729, "title": "Fix a performance regression in SelectVariants", "bodyText": "There was an \"optimization\" put in place in SelectVariants which accidentally added a quadraticly scaling check on the genotypes.\nThis keeps the optimization but makes it linear instead of quadratic on the number of samples.\nOn one example with several thousand samples there was a speed up from ~5 minutes to .1 minutes.", "createdAt": "2020-07-28T15:32:04Z", "url": "https://github.com/broadinstitute/gatk/pull/6729", "merged": true, "mergeCommit": {"oid": "22460dafe45fda48b23c629200cc94dbdcfca7ca"}, "closed": true, "closedAt": "2020-08-06T15:00:22Z", "author": {"login": "lbergelson"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5Yg4SAFqTQ1Njc3NTk1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8APlxAFqTQ2MTk1MzYyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2Nzc1OTU0", "url": "https://github.com/broadinstitute/gatk/pull/6729#pullrequestreview-456775954", "createdAt": "2020-07-28T15:53:14Z", "commit": {"oid": "a53d3210074424cdfac215f28276613c3f9fa41a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTo1MzoxNFrOG4TVMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTo1MzoxNFrOG4TVMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY5MDE2MQ==", "bodyText": "If you want to exactly match the previous behavior while still getting rid of the O(n^2) complexity, you could cache the result of vc.getGenotypes().stream().anyMatch(Genotype::hasLikelihoods) before entering the enclosing for loop, and check it here.", "url": "https://github.com/broadinstitute/gatk/pull/6729#discussion_r461690161", "createdAt": "2020-07-28T15:53:14Z", "author": {"login": "droazen"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/variantutils/SelectVariants.java", "diffHunk": "@@ -714,11 +714,13 @@ private void initalizeAlleleAnyploidIndicesCache(final VariantContext vc) {\n                 // Make a new entry if the we have not yet cached a PL to allele indices map for this ploidy and allele count\n                 // skip if there are no PLs -- this avoids hanging on high-allelic somatic samples, for example, where\n                 // there's no need for the PL indices since they don't exist\n-                if (g.getPloidy() != 0 && (!ploidyToNumberOfAlleles.containsKey(g.getPloidy()) || ploidyToNumberOfAlleles.get(g.getPloidy()) < vc.getNAlleles())) {\n-                    if (vc.getGenotypes().stream().anyMatch(Genotype::hasLikelihoods)) {\n-                        GenotypeLikelihoods.initializeAnyploidPLIndexToAlleleIndices(vc.getNAlleles() - 1, g.getPloidy());\n-                        ploidyToNumberOfAlleles.put(g.getPloidy(), vc.getNAlleles());\n-                    }\n+                final int genotypePloidy = g.getPloidy();\n+                final int nAlleles = vc.getNAlleles();\n+                if (genotypePloidy != 0\n+                        && (!ploidyToNumberOfAlleles.containsKey(genotypePloidy) || ploidyToNumberOfAlleles.get(genotypePloidy) < nAlleles)\n+                        && g.hasLikelihoods()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a53d3210074424cdfac215f28276613c3f9fa41a"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2ODcxOTIz", "url": "https://github.com/broadinstitute/gatk/pull/6729#pullrequestreview-456871923", "createdAt": "2020-07-28T17:51:44Z", "commit": {"oid": "a53d3210074424cdfac215f28276613c3f9fa41a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a53d3210074424cdfac215f28276613c3f9fa41a", "author": {"user": {"login": "lbergelson", "name": "Louis Bergelson"}}, "url": "https://github.com/broadinstitute/gatk/commit/a53d3210074424cdfac215f28276613c3f9fa41a", "committedDate": "2020-07-28T15:26:45Z", "message": "Fix a performance regression in SelectVariants\n\n* There was an \"optimization\" put in place in SelectVariants which accidentally added a quadraticly scaling check on the genotypes.\n* This keeps the optimization but makes it linear instead of quadratic on the number of samples.\n* On one example with several thousand samples there was a speed up from ~5 minutes to .1 minutes."}, "afterCommit": {"oid": "0eaa1cd88abb783b9b16f9bc6edb85d21eb0118d", "author": {"user": {"login": "lbergelson", "name": "Louis Bergelson"}}, "url": "https://github.com/broadinstitute/gatk/commit/0eaa1cd88abb783b9b16f9bc6edb85d21eb0118d", "committedDate": "2020-08-05T18:11:20Z", "message": "fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8392400ba8f8cef9a6546fd320fcf3399b74ae18", "author": {"user": {"login": "lbergelson", "name": "Louis Bergelson"}}, "url": "https://github.com/broadinstitute/gatk/commit/8392400ba8f8cef9a6546fd320fcf3399b74ae18", "committedDate": "2020-08-05T18:20:59Z", "message": "fixup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0eaa1cd88abb783b9b16f9bc6edb85d21eb0118d", "author": {"user": {"login": "lbergelson", "name": "Louis Bergelson"}}, "url": "https://github.com/broadinstitute/gatk/commit/0eaa1cd88abb783b9b16f9bc6edb85d21eb0118d", "committedDate": "2020-08-05T18:11:20Z", "message": "fixup"}, "afterCommit": {"oid": "8392400ba8f8cef9a6546fd320fcf3399b74ae18", "author": {"user": {"login": "lbergelson", "name": "Louis Bergelson"}}, "url": "https://github.com/broadinstitute/gatk/commit/8392400ba8f8cef9a6546fd320fcf3399b74ae18", "committedDate": "2020-08-05T18:20:59Z", "message": "fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxOTUzNjI0", "url": "https://github.com/broadinstitute/gatk/pull/6729#pullrequestreview-461953624", "createdAt": "2020-08-05T19:18:34Z", "commit": {"oid": "8392400ba8f8cef9a6546fd320fcf3399b74ae18"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2680, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}