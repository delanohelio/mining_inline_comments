{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMzY2NDIy", "number": 6517, "title": "Fix ReadsSparkSource CRAM code paths.", "bodyText": "This fixes two issues discovered while testing my URI migration branch:\n\nReadsSourceSpark.getHeader doesn't propagate the reference at all when a CRAM file input resides on GCS, so it always results in a \"no reference was provided\" error, even when a reference was provided.\nReadsSourceSpark.checkCramReference always tried to create a Hadoop Path object for the reference no matter what file system it lives on, which fails when using a reference on GCS.", "createdAt": "2020-03-23T12:52:05Z", "url": "https://github.com/broadinstitute/gatk/pull/6517", "merged": true, "mergeCommit": {"oid": "87a8c4539ce1feb90998bb65784661361e28928f"}, "closed": true, "closedAt": "2020-05-27T14:30:41Z", "author": {"login": "cmnbroad"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceF_8pgBqjMzMDE3MDI3NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclYhbjgH2gAyMzkyMzY2NDIyOmRkYjM1YzAyMDk4N2Q0NTkxOWM0ZGM3MTc0ZGU5ZGM3OGU1N2I4N2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c61722b51ad3ae94eb7227b250f0191c00385a5", "author": {"user": {"login": "cmnbroad", "name": "Chris Norman"}}, "url": "https://github.com/broadinstitute/gatk/commit/6c61722b51ad3ae94eb7227b250f0191c00385a5", "committedDate": "2020-03-23T12:43:12Z", "message": "Fix ReadsSparkSource CRAM code paths."}, "afterCommit": {"oid": "b408d9ec40d8d5932688acdc81a4f6e5c300cdf7", "author": {"user": {"login": "cmnbroad", "name": "Chris Norman"}}, "url": "https://github.com/broadinstitute/gatk/commit/b408d9ec40d8d5932688acdc81a4f6e5c300cdf7", "committedDate": "2020-05-04T21:04:54Z", "message": "Fix ReadsSparkSource CRAM code paths."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b408d9ec40d8d5932688acdc81a4f6e5c300cdf7", "author": {"user": {"login": "cmnbroad", "name": "Chris Norman"}}, "url": "https://github.com/broadinstitute/gatk/commit/b408d9ec40d8d5932688acdc81a4f6e5c300cdf7", "committedDate": "2020-05-04T21:04:54Z", "message": "Fix ReadsSparkSource CRAM code paths."}, "afterCommit": {"oid": "39e83fc7052c1e48635e6d20fe29c42474a2bd6d", "author": {"user": {"login": "cmnbroad", "name": "Chris Norman"}}, "url": "https://github.com/broadinstitute/gatk/commit/39e83fc7052c1e48635e6d20fe29c42474a2bd6d", "committedDate": "2020-05-04T22:44:33Z", "message": "Fix ReadsSparkSource CRAM code paths."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NjkwNTA2", "url": "https://github.com/broadinstitute/gatk/pull/6517#pullrequestreview-418690506", "createdAt": "2020-05-26T21:25:09Z", "commit": {"oid": "39e83fc7052c1e48635e6d20fe29c42474a2bd6d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToyNTowOVrOGaw3IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToyNTowOVrOGaw3IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxNjcwNQ==", "bodyText": "this is super nitpicky, but why not do this set or not as part of the factory initialization and then just always pass in factory?  it moves the ternary out of the new object declaration which seems preferable.", "url": "https://github.com/broadinstitute/gatk/pull/6517#discussion_r430716705", "createdAt": "2020-05-26T21:25:09Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/engine/spark/datasources/ReadsSparkSource.java", "diffHunk": "@@ -164,16 +167,22 @@ public ReadsSparkSource(final JavaSparkContext ctx, final ValidationStringency v\n      * @return the header for the bam.\n      */\n     public SAMFileHeader getHeader(final String filePath, final GATKPathSpecifier referencePathSpecifier) {\n+        final GATKPathSpecifier cramReferencePathSpec = checkCramReference(ctx, filePath, referencePathSpecifier);\n+\n         // GCS case\n         if (BucketUtils.isGcsUrl(filePath)) {\n-            try (ReadsDataSource readsDataSource = new ReadsDataSource(IOUtils.getPath(filePath))) {\n-                return readsDataSource.getHeader();\n+            final SamReaderFactory factory = SamReaderFactory.makeDefault().validationStringency(validationStringency);\n+            try (ReadsDataSource readsDataSource = new ReadsDataSource(\n+                    Collections.singletonList(IOUtils.getPath(filePath)),\n+                    cramReferencePathSpec == null ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39e83fc7052c1e48635e6d20fe29c42474a2bd6d"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39e83fc7052c1e48635e6d20fe29c42474a2bd6d", "author": {"user": {"login": "cmnbroad", "name": "Chris Norman"}}, "url": "https://github.com/broadinstitute/gatk/commit/39e83fc7052c1e48635e6d20fe29c42474a2bd6d", "committedDate": "2020-05-04T22:44:33Z", "message": "Fix ReadsSparkSource CRAM code paths."}, "afterCommit": {"oid": "ddb35c020987d45919c4dc7174de9dc78e57b87b", "author": {"user": {"login": "cmnbroad", "name": "Chris Norman"}}, "url": "https://github.com/broadinstitute/gatk/commit/ddb35c020987d45919c4dc7174de9dc78e57b87b", "committedDate": "2020-05-27T12:35:31Z", "message": "Code review comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9165f8b1405c4d2ef7f8a6b1f3d9e953e9f738c3", "author": {"user": {"login": "cmnbroad", "name": "Chris Norman"}}, "url": "https://github.com/broadinstitute/gatk/commit/9165f8b1405c4d2ef7f8a6b1f3d9e953e9f738c3", "committedDate": "2020-05-27T12:35:31Z", "message": "Fix ReadsSparkSource CRAM code paths."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddb35c020987d45919c4dc7174de9dc78e57b87b", "author": {"user": {"login": "cmnbroad", "name": "Chris Norman"}}, "url": "https://github.com/broadinstitute/gatk/commit/ddb35c020987d45919c4dc7174de9dc78e57b87b", "committedDate": "2020-05-27T12:35:31Z", "message": "Code review comments."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2822, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}