{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMTcyMzk0", "number": 6934, "title": "Making ingest work on gvcfs without allele specific annotations", "bodyText": "This is a first pass, but at the very least hopefully won't blow up on older data (that has been reblocked). I'm currently leaving the raw rank sum values blank if they don't exist in the input. This means the data will look smaller than a real allele specific gvcf, but I didn't know how to fake those values from the data we have in the non-allele specific gvcf.", "createdAt": "2020-10-30T17:36:23Z", "url": "https://github.com/broadinstitute/gatk/pull/6934", "merged": true, "mergeCommit": {"oid": "5ec48b5c0b234e5b85ff0f14efdb4e5c26ec34bc"}, "closed": true, "closedAt": "2020-11-03T20:26:52Z", "author": {"login": "meganshand"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY7VGmAH2gAyNTEzMTcyMzk0OmM0YTc0MGE2YmVkNmZkOWRiNDliNTM4MzQ3YmE2NTA0OTkzZmQ0NDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY81kbAH2gAyNTEzMTcyMzk0OmE0YjY3NTI2NDQ5ODlhY2YzMjY3OGY5ODUxY2NlNGUxOGQ2MjgzM2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c4a740a6bed6fd9db49b538347ba6504993fd443", "author": {"user": {"login": "meganshand", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/c4a740a6bed6fd9db49b538347ba6504993fd443", "committedDate": "2020-11-03T15:58:52Z", "message": "changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff0868ca32c38be8a552f09d69c0b8b0530a2651", "author": {"user": {"login": "meganshand", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/ff0868ca32c38be8a552f09d69c0b8b0530a2651", "committedDate": "2020-10-30T17:28:07Z", "message": "chages"}, "afterCommit": {"oid": "c4a740a6bed6fd9db49b538347ba6504993fd443", "author": {"user": {"login": "meganshand", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/c4a740a6bed6fd9db49b538347ba6504993fd443", "committedDate": "2020-11-03T15:58:52Z", "message": "changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNjgyODEy", "url": "https://github.com/broadinstitute/gatk/pull/6934#pullrequestreview-522682812", "createdAt": "2020-11-03T16:40:28Z", "commit": {"oid": "c4a740a6bed6fd9db49b538347ba6504993fd443"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjo0MDoyOFrOHs3TcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjo1MDoxM1rOHs3uiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwNTQ4OA==", "bodyText": "we need to replace the line above with this since we might have actual data in the last field:\nout = out.substring(0, out.lastIndexOf(\"|\"));", "url": "https://github.com/broadinstitute/gatk/pull/6934#discussion_r516805488", "createdAt": "2020-11-03T16:40:28Z", "author": {"login": "ahaessly"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/variantdb/nextgen/VetFieldEnum.java", "diffHunk": "@@ -75,30 +73,55 @@ public String getColumnValue(final VariantContext variant) {\n         // TODO sci notation?\n         public String getColumnValue(final VariantContext variant) {\n             String out = getAttribute(variant, GATKVCFConstants.AS_RAW_RMS_MAPPING_QUALITY_KEY, null);\n-            if (out == null) {\n-                throw new UserException(\"Cannot be missing required value for alternate_bases.AS_RAW_MQ\");\n+            String outNotAlleleSpecific = getAttribute(variant, GATKVCFConstants.RAW_MAPPING_QUALITY_WITH_DEPTH_KEY, null);\n+            String outNotAlleleSpecificAndOld = getAttribute(variant, GATKVCFConstants.RAW_RMS_MAPPING_QUALITY_DEPRECATED, null);\n+            if (out == null && outNotAlleleSpecific == null && outNotAlleleSpecificAndOld == null) {\n+                throw new UserException(\"Cannot be missing required value for alternate_bases.AS_RAW_MQ, RAW_MQandDP or RAW_MQ.\");\n             }\n-            if (!out.endsWith(\"|0.00\")) {\n-                logger.warn(\"Expected AS_RAW_MQ value to end in |0.00. value is: \" + out + \" for variant \" + variant.toString());\n+            if (out != null) {\n+                if(!out.endsWith(\"|0.00\")) {\n+                    logger.warn(\"Expected AS_RAW_MQ value to end in |0.00. value is: \" + out + \" for variant \" + variant.toString());\n+                }\n+                    out = out.substring(0, out.length() - 5);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4a740a6bed6fd9db49b538347ba6504993fd443"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgxMjQyNA==", "bodyText": "I didn't notice before that we were setting this to a space (here and for MQRankSum). for PTG and PID we use the empty string if we don't have a value. can we change these to the empty string too?", "url": "https://github.com/broadinstitute/gatk/pull/6934#discussion_r516812424", "createdAt": "2020-11-03T16:50:13Z", "author": {"login": "ahaessly"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/variantdb/nextgen/VetFieldEnum.java", "diffHunk": "@@ -148,8 +171,8 @@ public String getColumnValue(final VariantContext variant) {\n \n     AS_RAW_ReadPosRankSum {  // TODO -- maybe rely on 1/1 for call_GT\n         public String getColumnValue(final VariantContext variant) {\n-            String out =  getAttribute(variant, GATKVCFConstants.AS_RAW_READ_POS_RANK_SUM_KEY, \"\");\n-            if (out.contentEquals(\"||\") || out.contentEquals(\"|||\") ) {\n+            String out =  getAttribute(variant, GATKVCFConstants.AS_RAW_READ_POS_RANK_SUM_KEY, null);\n+            if (out == null || out.contentEquals(\"||\") || out.contentEquals(\"|||\") ) {\n                 out = \" \"; // TODO is this better than null?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4a740a6bed6fd9db49b538347ba6504993fd443"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dfe90713fb3eacff8938426961b4def6aa2aabe", "author": {"user": {"login": "meganshand", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/5dfe90713fb3eacff8938426961b4def6aa2aabe", "committedDate": "2020-11-03T16:56:22Z", "message": "addressing comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNzA2NzQy", "url": "https://github.com/broadinstitute/gatk/pull/6934#pullrequestreview-522706742", "createdAt": "2020-11-03T17:06:10Z", "commit": {"oid": "5dfe90713fb3eacff8938426961b4def6aa2aabe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNzowNjoxMVrOHs4aBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNzowNjoxMVrOHs4aBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgyMzU1Ng==", "bodyText": "formatting nit - the 5 lines above should be tabbed out one level", "url": "https://github.com/broadinstitute/gatk/pull/6934#discussion_r516823556", "createdAt": "2020-11-03T17:06:11Z", "author": {"login": "ahaessly"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/variantdb/nextgen/VetFieldEnum.java", "diffHunk": "@@ -75,31 +73,56 @@ public String getColumnValue(final VariantContext variant) {\n         // TODO sci notation?\n         public String getColumnValue(final VariantContext variant) {\n             String out = getAttribute(variant, GATKVCFConstants.AS_RAW_RMS_MAPPING_QUALITY_KEY, null);\n-            if (out == null) {\n-                throw new UserException(\"Cannot be missing required value for alternate_bases.AS_RAW_MQ\");\n+            String outNotAlleleSpecific = getAttribute(variant, GATKVCFConstants.RAW_MAPPING_QUALITY_WITH_DEPTH_KEY, null);\n+            String outNotAlleleSpecificAndOld = getAttribute(variant, GATKVCFConstants.RAW_RMS_MAPPING_QUALITY_DEPRECATED, null);\n+            if (out == null && outNotAlleleSpecific == null && outNotAlleleSpecificAndOld == null) {\n+                throw new UserException(\"Cannot be missing required value for alternate_bases.AS_RAW_MQ, RAW_MQandDP or RAW_MQ.\");\n             }\n-            if (!out.endsWith(\"|0.00\")) {\n-                logger.warn(\"Expected AS_RAW_MQ value to end in |0.00. value is: \" + out + \" for variant \" + variant.toString());\n+            if (out != null) {\n+                if(!out.endsWith(\"|0.00\")) {\n+                    logger.warn(\"Expected AS_RAW_MQ value to end in |0.00. value is: \" + out + \" for variant \" + variant.toString());\n+                }\n+                    out = out.substring(0, out.lastIndexOf(\"|\"));\n+                    String[] outValues = out.split(\"\\\\|\");\n+                    out = Arrays\n+                            .stream(outValues)\n+                            .map(val -> val.endsWith(\".00\") ? val.substring(0, val.length() - 3) : val)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5dfe90713fb3eacff8938426961b4def6aa2aabe"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4b6752644989acf32678f9851cce4e18d62833e", "author": {"user": {"login": "meganshand", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/a4b6752644989acf32678f9851cce4e18d62833e", "committedDate": "2020-11-03T17:44:14Z", "message": "tabs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2529, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}