{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NzY4NDE0", "number": 6461, "title": "realigning to best haplotype handles indels better", "bodyText": "@takutosato If you look at the previous code for realignment to a read's best haplotype it assumes that the read start within the reference haplotype byte array is the same as its start within the best haplotype byte array (see the coordinate passed to leftAlignIndels).  This means that left alignment would effectively be deactivated (since the bases didn't line up correctly) whenever the best haplotype contained indels before the read start.\nThis also creates a rare but possible edge case bug where if a read cigar ends in an indel and we miscalculated the read's start in the reference we might get an array out of bounds exception within leftAlignIndels.  The recent PR #6427, which fixed some bugs involving left alignment, actually exposed this bug, because the previous code simply skipped left alignment when it encountered an out of bounds index.\nThe fix is in the line final int readStartOnReferenceHaplotype = readStartOnReferenceHaplotype(rightPaddedHaplotypeVsRefCigar, readToHaplotypeSWAlignment.getAlignmentOffset());  The idea is that we know where the read starts on its best haplotype from the SW alignment.  In order to find the corresponding reference base, we follow the haplotype-to-reference cigar up to the read start and count the number of reference bases consumed.\nFor example, suppose the haplotype-to-reference cigar is 30M5D100M and the read starts at (0-indexed) position 50 on the haplotype.  We want to know how many reference bases are consumed in order to consume 50 alt haplotype bases in this cigar.  That is, we count the reference bases in the 30M5D20M leading sub-cigar, which is 55.  Thus the reference start is 55.  Conversely, if the haplotype-to-reference cigar were 30M5I100M the read would start after 30M5I15M, with 45 reference bases consumed.", "createdAt": "2020-02-20T13:52:28Z", "url": "https://github.com/broadinstitute/gatk/pull/6461", "merged": true, "mergeCommit": {"oid": "031c40773d2aefd289005319d6880dbeb3c1dec9"}, "closed": true, "closedAt": "2020-02-26T02:05:04Z", "author": {"login": "davidbenjamin"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcF8jurAH2gAyMzc3NzY4NDE0OmQ3OTMwMWExOTcxZjQyNDVhMmRmMmMwMTQwMTM0NThkNWVlMzI1ZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcH4xwbgH2gAyMzc3NzY4NDE0OjRlYWY2OGYwNjBmNjExMzM1NTdkMjQ0MmExMjFmYjhiYjhiOTIwNDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d79301a1971f4245a2df2c014013458d5ee325f2", "author": {"user": {"login": "davidbenjamin", "name": "David Benjamin"}}, "url": "https://github.com/broadinstitute/gatk/commit/d79301a1971f4245a2df2c014013458d5ee325f2", "committedDate": "2020-02-19T20:29:02Z", "message": "realigning read to best haplotype now handles indels in best haplotype before read start better"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzAxMDE2", "url": "https://github.com/broadinstitute/gatk/pull/6461#pullrequestreview-363701016", "createdAt": "2020-02-24T21:07:43Z", "commit": {"oid": "d79301a1971f4245a2df2c014013458d5ee325f2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMTowNzo0M1rOFtv4GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMTowNzo0M1rOFtv4GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxNDY0OA==", "bodyText": "Great variable name improvements!", "url": "https://github.com/broadinstitute/gatk/pull/6461#discussion_r383514648", "createdAt": "2020-02-24T21:07:43Z", "author": {"login": "takutosato"}, "path": "src/main/java/org/broadinstitute/hellbender/utils/read/AlignmentUtils.java", "diffHunk": "@@ -93,18 +93,33 @@ public static GATKRead createReadAlignedToRef(final GATKRead originalRead,\n         }\n \n         // compute here the read starts w.r.t. the reference from the SW result and the hap -> ref cigar\n-        final Cigar extendedHaplotypeCigar = haplotype.getConsolidatedPaddedCigar(1000);\n-        final int readStartOnHaplotype = calcFirstBaseMatchingReferenceInCigar(extendedHaplotypeCigar, swPairwiseAlignment.getAlignmentOffset());\n-        final int readStartOnReference = referenceStart + haplotype.getAlignmentStartHapwrtRef() + readStartOnHaplotype;\n+        final Cigar rightPaddedHaplotypeVsRefCigar = haplotype.getConsolidatedPaddedCigar(1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d79301a1971f4245a2df2c014013458d5ee325f2"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eaf68f060f61133557d2442a121fb8bb8b92042", "author": {"user": {"login": "davidbenjamin", "name": "David Benjamin"}}, "url": "https://github.com/broadinstitute/gatk/commit/4eaf68f060f61133557d2442a121fb8bb8b92042", "committedDate": "2020-02-25T21:12:35Z", "message": "unit test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2768, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}