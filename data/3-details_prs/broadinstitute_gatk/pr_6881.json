{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNzg1MzI4", "number": 6881, "title": "Moving and testing ingest scripts from variantstore", "bodyText": "", "createdAt": "2020-10-09T19:40:58Z", "url": "https://github.com/broadinstitute/gatk/pull/6881", "merged": true, "mergeCommit": {"oid": "390badf5ab92b5ecdd2648133b10584610c736db"}, "closed": true, "closedAt": "2020-10-20T17:59:42Z", "author": {"login": "meganshand"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP8ScegH2gAyNTAwNzg1MzI4Ojc4MDA2MDFlZjgyNjI2NzNlMTExZjc2ZDgzZDY3MjljNzZjN2JhMmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUamewgH2gAyNTAwNzg1MzI4OmM5NDAwNGMzMWZmYzM1Njg5NWZhNDY0MjBlZDM2YjI0M2YzZGI2Yjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7800601ef8262673e111f76d83d6729c76c7ba2f", "author": {"user": {"login": "meganshand", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/7800601ef8262673e111f76d83d6729c76c7ba2f", "committedDate": "2020-10-06T18:00:33Z", "message": "Copying files over from variantstore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6345769746452a63b38f708c8e9d3abaa9957daf", "author": {"user": {"login": "meganshand", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/6345769746452a63b38f708c8e9d3abaa9957daf", "committedDate": "2020-10-09T19:38:22Z", "message": "some changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab476e37c0d2e4474c79520e4abf49cacb45005b", "author": {"user": {"login": "meganshand", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/ab476e37c0d2e4474c79520e4abf49cacb45005b", "committedDate": "2020-10-09T19:41:26Z", "message": "forgot to turn the test back on"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9d4f77bf68040a568c938e1a976ac4b3e050a78", "author": {"user": {"login": "meganshand", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/f9d4f77bf68040a568c938e1a976ac4b3e050a78", "committedDate": "2020-10-13T13:37:17Z", "message": "fixing test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNzEwMTAw", "url": "https://github.com/broadinstitute/gatk/pull/6881#pullrequestreview-512710100", "createdAt": "2020-10-20T13:29:25Z", "commit": {"oid": "f9d4f77bf68040a568c938e1a976ac4b3e050a78"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyOToyNVrOHk8iew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDo1NDowNVrOHlBOqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUwMjY1MQ==", "bodyText": "i changed the name of the file from metadata_.tsv to sample_.tsv. it might make it more clear to update this output param. (if you do, also change it in the inputs to LoadArrays)", "url": "https://github.com/broadinstitute/gatk/pull/6881#discussion_r508502651", "createdAt": "2020-10-20T13:29:25Z", "author": {"login": "ahaessly"}, "path": "scripts/variantstore_wdl/ImportArrays.wdl", "diffHunk": "@@ -0,0 +1,222 @@\n+version 1.0\n+\n+workflow ImportArrays {\n+\n+  input {\n+    Array[File] input_vcfs\n+    Array[File]? input_metrics\n+    String? probe_info_table\n+    File? probe_info_file\n+    String output_directory\n+    File sample_map\n+    String project_id\n+    String dataset_name\n+    File raw_schema\n+    File sample_list_schema\n+    #TODO: determine table_id from input sample_map (including looping over multiple table_ids)\n+    Int table_id\n+\n+    Int? preemptible_tries\n+    File? gatk_override\n+    String? docker\n+  }\n+\n+  String docker_final = select_first([docker, \"us.gcr.io/broad-gatk/gatk:4.1.7.0\"])\n+\n+  scatter (i in range(length(input_vcfs))) {\n+    if (defined(input_metrics)) {\n+      File input_metric = select_first([input_metrics])[i]\n+    }\n+\n+    call CreateImportTsvs {\n+      input:\n+        input_vcf = input_vcfs[i],\n+        input_metrics = input_metric,\n+        probe_info_table = probe_info_table,\n+        probe_info_file = probe_info_file,\n+        sample_map = sample_map,\n+        output_directory = output_directory,\n+        gatk_override = gatk_override,\n+        docker = docker_final,\n+        preemptible_tries = preemptible_tries\n+    }\n+  }\n+\n+  call LoadArrays {\n+    input:\n+      metadata_tsvs = CreateImportTsvs.metadata_tsv,\n+      project_id = project_id,\n+      dataset_name = dataset_name,\n+      storage_location = output_directory,\n+      table_id = table_id,\n+      raw_schema = raw_schema,\n+      sample_list_schema = sample_list_schema,\n+      preemptible_tries = preemptible_tries,\n+      docker = docker_final\n+  }\n+}\n+\n+\n+task CreateImportTsvs {\n+  input {\n+    File input_vcf\n+    File? input_metrics\n+    String? probe_info_table\n+    File? probe_info_file\n+    String output_directory\n+    File sample_map\n+\n+    # runtime\n+    Int? preemptible_tries\n+    File? gatk_override\n+    String docker\n+\n+    String? for_testing_only\n+  }\n+\n+  Int disk_size = ceil(size(input_vcf, \"GB\") * 2.5) + 20\n+\n+  meta {\n+    description: \"Creates a tsv file for imort into BigQuery\"\n+  }\n+  parameter_meta {\n+    input_vcf: {\n+      localization_optional: true\n+    }\n+  }\n+  command <<<\n+      set -e\n+\n+      #workaround for https://github.com/broadinstitute/cromwell/issues/3647\n+      export TMPDIR=/tmp\n+      export GATK_LOCAL_JAR=~{default=\"/root/gatk.jar\" gatk_override}\n+      ~{for_testing_only}\n+\n+      gatk --java-options \"-Xmx2500m\" CreateArrayIngestFiles \\\n+        -V ~{input_vcf} \\\n+        ~{\"-QCF \" + input_metrics} \\\n+        ~{\"--probe-info-file \" + probe_info_file} \\\n+        ~{\"--probe-info-table \" + probe_info_table} \\\n+        -SNM ~{sample_map} \\\n+        --ref-version 37\n+        \n+      gsutil cp sample_*.tsv ~{output_directory}/sample_tsvs/\n+      gsutil cp raw_*.tsv ~{output_directory}/raw_tsvs/\n+  >>>\n+  runtime {\n+      docker: docker\n+      memory: \"4 GB\"\n+      disks: \"local-disk \" + disk_size + \" HDD\"\n+      preemptible: select_first([preemptible_tries, 5])\n+      cpu: 2\n+  }\n+  output {\n+      File metadata_tsv = glob(\"sample_*.tsv\")[0]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d4f77bf68040a568c938e1a976ac4b3e050a78"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUxNzU0NA==", "bodyText": "is false the right default?", "url": "https://github.com/broadinstitute/gatk/pull/6881#discussion_r508517544", "createdAt": "2020-10-20T13:46:00Z", "author": {"login": "ahaessly"}, "path": "scripts/variantstore_wdl/ImportArrays.wdl", "diffHunk": "@@ -0,0 +1,222 @@\n+version 1.0\n+\n+workflow ImportArrays {\n+\n+  input {\n+    Array[File] input_vcfs\n+    Array[File]? input_metrics\n+    String? probe_info_table\n+    File? probe_info_file\n+    String output_directory\n+    File sample_map\n+    String project_id\n+    String dataset_name\n+    File raw_schema\n+    File sample_list_schema\n+    #TODO: determine table_id from input sample_map (including looping over multiple table_ids)\n+    Int table_id\n+\n+    Int? preemptible_tries\n+    File? gatk_override\n+    String? docker\n+  }\n+\n+  String docker_final = select_first([docker, \"us.gcr.io/broad-gatk/gatk:4.1.7.0\"])\n+\n+  scatter (i in range(length(input_vcfs))) {\n+    if (defined(input_metrics)) {\n+      File input_metric = select_first([input_metrics])[i]\n+    }\n+\n+    call CreateImportTsvs {\n+      input:\n+        input_vcf = input_vcfs[i],\n+        input_metrics = input_metric,\n+        probe_info_table = probe_info_table,\n+        probe_info_file = probe_info_file,\n+        sample_map = sample_map,\n+        output_directory = output_directory,\n+        gatk_override = gatk_override,\n+        docker = docker_final,\n+        preemptible_tries = preemptible_tries\n+    }\n+  }\n+\n+  call LoadArrays {\n+    input:\n+      metadata_tsvs = CreateImportTsvs.metadata_tsv,\n+      project_id = project_id,\n+      dataset_name = dataset_name,\n+      storage_location = output_directory,\n+      table_id = table_id,\n+      raw_schema = raw_schema,\n+      sample_list_schema = sample_list_schema,\n+      preemptible_tries = preemptible_tries,\n+      docker = docker_final\n+  }\n+}\n+\n+\n+task CreateImportTsvs {\n+  input {\n+    File input_vcf\n+    File? input_metrics\n+    String? probe_info_table\n+    File? probe_info_file\n+    String output_directory\n+    File sample_map\n+\n+    # runtime\n+    Int? preemptible_tries\n+    File? gatk_override\n+    String docker\n+\n+    String? for_testing_only\n+  }\n+\n+  Int disk_size = ceil(size(input_vcf, \"GB\") * 2.5) + 20\n+\n+  meta {\n+    description: \"Creates a tsv file for imort into BigQuery\"\n+  }\n+  parameter_meta {\n+    input_vcf: {\n+      localization_optional: true\n+    }\n+  }\n+  command <<<\n+      set -e\n+\n+      #workaround for https://github.com/broadinstitute/cromwell/issues/3647\n+      export TMPDIR=/tmp\n+      export GATK_LOCAL_JAR=~{default=\"/root/gatk.jar\" gatk_override}\n+      ~{for_testing_only}\n+\n+      gatk --java-options \"-Xmx2500m\" CreateArrayIngestFiles \\\n+        -V ~{input_vcf} \\\n+        ~{\"-QCF \" + input_metrics} \\\n+        ~{\"--probe-info-file \" + probe_info_file} \\\n+        ~{\"--probe-info-table \" + probe_info_table} \\\n+        -SNM ~{sample_map} \\\n+        --ref-version 37\n+        \n+      gsutil cp sample_*.tsv ~{output_directory}/sample_tsvs/\n+      gsutil cp raw_*.tsv ~{output_directory}/raw_tsvs/\n+  >>>\n+  runtime {\n+      docker: docker\n+      memory: \"4 GB\"\n+      disks: \"local-disk \" + disk_size + \" HDD\"\n+      preemptible: select_first([preemptible_tries, 5])\n+      cpu: 2\n+  }\n+  output {\n+      File metadata_tsv = glob(\"sample_*.tsv\")[0]\n+      File arraydata_tsv = glob(\"raw_*.tsv\")[0] \n+  }\n+}\n+\n+task LoadArrays {\n+  input {\n+    String project_id\n+    String dataset_name\n+    String storage_location\n+    Int table_id\n+    File raw_schema\n+    File sample_list_schema\n+    String load = \"false\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d4f77bf68040a568c938e1a976ac4b3e050a78"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3OTQ5OQ==", "bodyText": "when do you not want to load?", "url": "https://github.com/broadinstitute/gatk/pull/6881#discussion_r508579499", "createdAt": "2020-10-20T14:54:05Z", "author": {"login": "ahaessly"}, "path": "scripts/variantstore_wdl/bq_ingest_arrays.sh", "diffHunk": "@@ -0,0 +1,97 @@\n+#!/usr/bin/env bash\n+set -e\n+\n+if [ $# -lt 5 ]; then\n+  echo \"usage: $0 <project-id> <dataset-name> <storage-location> <table-id> <load> <uuid>\"\n+  exit 1\n+fi\n+\n+PROJECT_ID=$1\n+DATASET_NAME=$2\n+STORAGE_LOCATION=$3\n+TABLE_ID=$4\n+if [ $5 == \"true\" ]; then\n+  LOAD=true\n+else\n+  LOAD=false\n+fi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d4f77bf68040a568c938e1a976ac4b3e050a78"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c94004c31ffc356895fa46420ed36b243f3db6b7", "author": {"user": {"login": "meganshand", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/c94004c31ffc356895fa46420ed36b243f3db6b7", "committedDate": "2020-10-20T15:35:17Z", "message": "addressing comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2511, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}