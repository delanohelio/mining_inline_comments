{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNjUxNjIy", "number": 6681, "title": "Merge contigs into fewer GenomicsDB partitions", "bodyText": "This introduces a feature for GenomicsDBImport that allows merging multiple contigs into fewer genomicsdb partitions. This should give a huge boost for cases where users have a very large number of contigs (see here , for instance). Currently, GenomicsDB would create a separate folder/partition for each contig and this slows down import to a crawl with a large number of contigs.\nTo use this feature, users should set the flag --merge-contigs-into-num-partitions to the number of partitions. Using the feature requires that entire contigs be passed as input intervals -- we don't support merging together an interval list that contains partial contigs.\nThere's no magic threshold where this would start to be useful - we currently warn users when they specify more than 100 intervals, and I think the same threshold makes sense for when they should consider using this flag. Choosing the right value for --merge-contigs-into-num-partitions would be dependent on amount of parallelism users want to use (for example, do they want to want to import using max-num-intervals-to-import-in-parallel). If no parallelism is envisioned either on import or query, setting --merge-contigs-into-num-partitions to 1 should work as well -- though the user may find it more reassuring to break up the work into more partitions just so you can see some progress being made....", "createdAt": "2020-06-29T21:10:15Z", "url": "https://github.com/broadinstitute/gatk/pull/6681", "merged": true, "mergeCommit": {"oid": "2b949f0dda49f495ce8fc7e3b8528cbc534e4819"}, "closed": true, "closedAt": "2020-11-09T17:36:47Z", "author": {"login": "mlathara"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuRnABgH2gAyNDQxNjUxNjIyOmQ3ODQwYjkzYjMxMzE0OThjMmQxNzY5MTE4ZmExZDNkZDAyYjdiNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXX6WxgH2gAyNDQxNjUxNjIyOjFhNzA5MTllY2M2ZjFiYmNkNjdjNDg3MGRmMDA4ZmQ1OTkyMTRmYjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d7840b93b3131498c2d1769118fa1d3dd02b7b56", "author": {"user": {"login": "nalinigans", "name": "Nalini Ganapati"}}, "url": "https://github.com/broadinstitute/gatk/commit/d7840b93b3131498c2d1769118fa1d3dd02b7b56", "committedDate": "2020-06-24T03:37:35Z", "message": "Make VCFCodec the default for query streams from GenomicsDB and other minor changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da9fa9b2264677668a232fd5f67fa955a09365f4", "author": {"user": {"login": "mlathara", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/da9fa9b2264677668a232fd5f67fa955a09365f4", "committedDate": "2020-06-29T04:59:04Z", "message": "merge contigs feature and tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45", "author": {"user": {"login": "mlathara", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/2bef7c9b7869c6b42d58ae54700d078881f95e45", "committedDate": "2020-06-29T05:08:24Z", "message": "fixing merge conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Nzc4Mjg2", "url": "https://github.com/broadinstitute/gatk/pull/6681#pullrequestreview-457778286", "createdAt": "2020-07-29T18:23:42Z", "commit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxODoyMzo0MlrOG5Etkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxOToyMDowMFrOG5GqvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ5OTIxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new UserException(MERGE_CONTIGS_INTO_NUM_PARTITIONS+\" requires that entire contigs \" +\n          \n          \n            \n                            throw new UserException(\"--\" + MERGE_CONTIGS_INTO_NUM_PARTITIONS + \" requires that entire contigs \" +", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462499218", "createdAt": "2020-07-29T18:23:42Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -447,6 +462,29 @@ private void assertVariantPathsOrSampleNameFileWasSpecified(){\n         }\n     }\n \n+    private void assertIntervalsCoverEntireContigs(GenomicsDBImporter importer,\n+                                                   List<SimpleInterval> intervals) {\n+        GenomicsDBVidMapProto.VidMappingPB vidMapPB = importer.getProtobufVidMapping();\n+        if (vidMapPB == null) {\n+            throw new UserException(\"Could not get protobuf vid mappping object from GenomicsDBImporter\");\n+        }\n+        Map<String,GenomicsDBVidMapProto.Chromosome> vidContigs =\n+                vidMapPB.getContigsList().stream().collect(Collectors.toMap(item->item.getName(), item->item));\n+        for (SimpleInterval interval: intervals) {\n+            GenomicsDBVidMapProto.Chromosome vidContig = vidContigs.get(interval.getContig());\n+            long contigLength = vidContig.getLength();\n+            if (interval.getStart() != 1 || interval.getEnd() < contigLength) {\n+                String inputInterval = String.format(\"Contig:%s, Start:%d, End:%d\",\n+                        interval.getContig(), interval.getStart(), interval.getEnd());\n+                String vidInterval = String.format(\"Contig:%s, Start:%d, End:%d\",\n+                        vidContig.getName(), 1, vidContig.getLength());\n+                throw new UserException(MERGE_CONTIGS_INTO_NUM_PARTITIONS+\" requires that entire contigs \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ5OTg1NQ==", "bodyText": "I think this can be static\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void assertIntervalsCoverEntireContigs(GenomicsDBImporter importer,\n          \n          \n            \n                private static void assertIntervalsCoverEntireContigs(GenomicsDBImporter importer,", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462499855", "createdAt": "2020-07-29T18:24:45Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -447,6 +462,29 @@ private void assertVariantPathsOrSampleNameFileWasSpecified(){\n         }\n     }\n \n+    private void assertIntervalsCoverEntireContigs(GenomicsDBImporter importer,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUwMTc2Mw==", "bodyText": "You can use the Locatable constructor here\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    intervals.forEach(i -> outputList.add(new Interval(i.getContig(), i.getStart(), i.getEnd())));\n          \n          \n            \n                    intervals.forEach(i -> outputList.add(new Interval(i)));", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462501763", "createdAt": "2020-07-29T18:28:10Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -602,23 +640,31 @@ private static void assertGVCFHasOnlyOneSample(final String variantPath, final V\n         return new TreeMap<>(loadSampleNameMapFile(sampleToFileMapPath));\n     }\n \n+    /**\n+     * write out interval list to file\n+     */\n+    private void writeIntervalListToFile() {\n+        final IntervalList outputList = new IntervalList(getBestAvailableSequenceDictionary());\n+        intervals.forEach(i -> outputList.add(new Interval(i.getContig(), i.getStart(), i.getEnd())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUwMjIzMQ==", "bodyText": "I know this is just moving but there a few minor things that can be updated here.", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462502231", "createdAt": "2020-07-29T18:29:03Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -602,23 +640,31 @@ private static void assertGVCFHasOnlyOneSample(final String variantPath, final V\n         return new TreeMap<>(loadSampleNameMapFile(sampleToFileMapPath));\n     }\n \n+    /**\n+     * write out interval list to file\n+     */\n+    private void writeIntervalListToFile() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUwMzg3OQ==", "bodyText": "Write takes a path directly now.  I would just inline the path creation as well.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final Path intervalListOutputPath = IOUtils.getPath(intervalListOutputPathString);\n          \n          \n            \n                    outputList.write(intervalListOutputPath.toFile());\n          \n          \n            \n                    outputList.write(IOUtils.getPath(intervalListOutputPathString));", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462503879", "createdAt": "2020-07-29T18:31:41Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -602,23 +640,31 @@ private static void assertGVCFHasOnlyOneSample(final String variantPath, final V\n         return new TreeMap<>(loadSampleNameMapFile(sampleToFileMapPath));\n     }\n \n+    /**\n+     * write out interval list to file\n+     */\n+    private void writeIntervalListToFile() {\n+        final IntervalList outputList = new IntervalList(getBestAvailableSequenceDictionary());\n+        intervals.forEach(i -> outputList.add(new Interval(i.getContig(), i.getStart(), i.getEnd())));\n+        final Path intervalListOutputPath = IOUtils.getPath(intervalListOutputPathString);\n+        outputList.write(intervalListOutputPath.toFile());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUwODE1Nw==", "bodyText": "The most nitpicky comment possible: I think it reads better with 'the'\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // intervals may be null if merge-contigs-into-num-partitions was used to create workspace\n          \n          \n            \n                        // if so, we need to wait for vid to be generated before writing out interval list\n          \n          \n            \n                        // intervals may be null if merge-contigs-into-num-partitions was used to create the workspace\n          \n          \n            \n                        // if so, we need to wait for vid to be generated before writing out the interval list", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462508157", "createdAt": "2020-07-29T18:39:18Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -602,23 +640,31 @@ private static void assertGVCFHasOnlyOneSample(final String variantPath, final V\n         return new TreeMap<>(loadSampleNameMapFile(sampleToFileMapPath));\n     }\n \n+    /**\n+     * write out interval list to file\n+     */\n+    private void writeIntervalListToFile() {\n+        final IntervalList outputList = new IntervalList(getBestAvailableSequenceDictionary());\n+        intervals.forEach(i -> outputList.add(new Interval(i.getContig(), i.getStart(), i.getEnd())));\n+        final Path intervalListOutputPath = IOUtils.getPath(intervalListOutputPathString);\n+        outputList.write(intervalListOutputPath.toFile());\n+    }\n+\n     /**\n      * Before traversal, fix configuration parameters and initialize\n      * GenomicsDB. Hard-coded to handle only VCF files and headers\n      */\n     @Override\n     public void onTraversalStart() {\n-        if (getIntervalsFromExistingWorkspace) {\n-            final IntervalList outputList = new IntervalList(getBestAvailableSequenceDictionary());\n-            intervals.forEach(i -> outputList.add(new Interval(i.getContig(), i.getStart(), i.getEnd())));\n-            final Path intervalListOutputPath = IOUtils.getPath(intervalListOutputPathString);\n-            outputList.write(intervalListOutputPath.toFile());\n-            return;\n-        }\n         String workspaceDir = BucketUtils.makeFilePathAbsolute(overwriteCreateOrCheckWorkspace());\n         vidMapJSONFile = IOUtils.appendPathToDir(workspaceDir, GenomicsDBConstants.DEFAULT_VIDMAP_FILE_NAME);\n         callsetMapJSONFile = IOUtils.appendPathToDir(workspaceDir, GenomicsDBConstants.DEFAULT_CALLSETMAP_FILE_NAME);\n         vcfHeaderFile = IOUtils.appendPathToDir(workspaceDir, GenomicsDBConstants.DEFAULT_VCFHEADER_FILE_NAME);\n+        if (getIntervalsFromExistingWorkspace) {\n+            // intervals may be null if merge-contigs-into-num-partitions was used to create workspace\n+            // if so, we need to wait for vid to be generated before writing out interval list", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUwOTg3Ng==", "bodyText": "It's weird that the workspace is passed into here, but then the createParitionWithBeginAndEnd uses the workspace field to get it.  I would make both static and pass workspace through to createPartitionWithBeginAndEnd, otherwise someone will be very confused when they try pass a different workspace value into this function I think.", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462509876", "createdAt": "2020-07-29T18:42:08Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -660,41 +706,84 @@ private void initializeInputPreloadExecutorService() {\n     }\n \n     private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionArgument arg) {\n-        progressMeter.update(intervals.get(0));\n+        progressMeter.update(null);\n         logger.info(\"Done importing batch \" + arg.batchCount + \"/\" + arg.totalBatchCount);\n         this.batchCount = arg.batchCount + 1;\n         return null;\n     }\n \n+    private GenomicsDBImportConfiguration.Partition createPartitionWithBeginAndEnd(\n+            Coordinates.GenomicsDBColumn begin, Coordinates.GenomicsDBColumn end) {\n+        GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n+        partitionBuilder.setBegin(begin);\n+        partitionBuilder.setEnd(end);\n+        partitionBuilder.setWorkspace(workspace);\n+        partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n+        return partitionBuilder.build();\n+    }\n+\n+    private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromWorkspace(final String workspace) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxMjIxMg==", "bodyText": "this would probably be clearer with a foreach instead of an indexed loop since the indexes are unimportant", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462512212", "createdAt": "2020-07-29T18:46:24Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -660,41 +706,84 @@ private void initializeInputPreloadExecutorService() {\n     }\n \n     private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionArgument arg) {\n-        progressMeter.update(intervals.get(0));\n+        progressMeter.update(null);\n         logger.info(\"Done importing batch \" + arg.batchCount + \"/\" + arg.totalBatchCount);\n         this.batchCount = arg.batchCount + 1;\n         return null;\n     }\n \n+    private GenomicsDBImportConfiguration.Partition createPartitionWithBeginAndEnd(\n+            Coordinates.GenomicsDBColumn begin, Coordinates.GenomicsDBColumn end) {\n+        GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n+        partitionBuilder.setBegin(begin);\n+        partitionBuilder.setEnd(end);\n+        partitionBuilder.setWorkspace(workspace);\n+        partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n+        return partitionBuilder.build();\n+    }\n+\n+    private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromWorkspace(final String workspace) {\n+        String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+        List<GenomicsDBImportConfiguration.Partition> configPartitions = new ArrayList<>();\n+        for (int i=0; i<partitions.length; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxMzg2MQ==", "bodyText": "It could also be a single streaming expression like the method below but that's really a stylistic choice and I don't care much either way...", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462513861", "createdAt": "2020-07-29T18:49:29Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -660,41 +706,84 @@ private void initializeInputPreloadExecutorService() {\n     }\n \n     private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionArgument arg) {\n-        progressMeter.update(intervals.get(0));\n+        progressMeter.update(null);\n         logger.info(\"Done importing batch \" + arg.batchCount + \"/\" + arg.totalBatchCount);\n         this.batchCount = arg.batchCount + 1;\n         return null;\n     }\n \n+    private GenomicsDBImportConfiguration.Partition createPartitionWithBeginAndEnd(\n+            Coordinates.GenomicsDBColumn begin, Coordinates.GenomicsDBColumn end) {\n+        GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n+        partitionBuilder.setBegin(begin);\n+        partitionBuilder.setEnd(end);\n+        partitionBuilder.setWorkspace(workspace);\n+        partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n+        return partitionBuilder.build();\n+    }\n+\n+    private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromWorkspace(final String workspace) {\n+        String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+        List<GenomicsDBImportConfiguration.Partition> configPartitions = new ArrayList<>();\n+        for (int i=0; i<partitions.length; i++) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxMjIxMg=="}, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxNTQzNg==", "bodyText": "Alternatively remove the workspace parameter from this method so it's consistent.", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462515436", "createdAt": "2020-07-29T18:52:16Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -660,41 +706,84 @@ private void initializeInputPreloadExecutorService() {\n     }\n \n     private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionArgument arg) {\n-        progressMeter.update(intervals.get(0));\n+        progressMeter.update(null);\n         logger.info(\"Done importing batch \" + arg.batchCount + \"/\" + arg.totalBatchCount);\n         this.batchCount = arg.batchCount + 1;\n         return null;\n     }\n \n+    private GenomicsDBImportConfiguration.Partition createPartitionWithBeginAndEnd(\n+            Coordinates.GenomicsDBColumn begin, Coordinates.GenomicsDBColumn end) {\n+        GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n+        partitionBuilder.setBegin(begin);\n+        partitionBuilder.setEnd(end);\n+        partitionBuilder.setWorkspace(workspace);\n+        partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n+        return partitionBuilder.build();\n+    }\n+\n+    private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromWorkspace(final String workspace) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUwOTg3Ng=="}, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxNjc2Nw==", "bodyText": "While we're here could we move the \"setContig\" call from here, up to where contigPositionBuilder is initialized?  I think it would make it clearer.", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462516767", "createdAt": "2020-07-29T18:54:34Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -660,41 +706,84 @@ private void initializeInputPreloadExecutorService() {\n     }\n \n     private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionArgument arg) {\n-        progressMeter.update(intervals.get(0));\n+        progressMeter.update(null);\n         logger.info(\"Done importing batch \" + arg.batchCount + \"/\" + arg.totalBatchCount);\n         this.batchCount = arg.batchCount + 1;\n         return null;\n     }\n \n+    private GenomicsDBImportConfiguration.Partition createPartitionWithBeginAndEnd(\n+            Coordinates.GenomicsDBColumn begin, Coordinates.GenomicsDBColumn end) {\n+        GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n+        partitionBuilder.setBegin(begin);\n+        partitionBuilder.setEnd(end);\n+        partitionBuilder.setWorkspace(workspace);\n+        partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n+        return partitionBuilder.build();\n+    }\n+\n+    private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromWorkspace(final String workspace) {\n+        String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+        List<GenomicsDBImportConfiguration.Partition> configPartitions = new ArrayList<>();\n+        for (int i=0; i<partitions.length; i++) {\n+            long[] bounds = GenomicsDBUtils.getArrayColumnBounds(workspace, partitions[i]);\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            beginBuilder.setTiledbColumn(bounds[0]);\n+            endBuilder.setTiledbColumn(bounds[1]);\n+            configPartitions.add(createPartitionWithBeginAndEnd(beginBuilder.build(), endBuilder.build()));\n+        }\n+        return configPartitions;\n+    }\n+\n     private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromIntervals(List<SimpleInterval> chromosomeIntervals) {\n         return chromosomeIntervals.stream().map(interval -> {\n-            GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n             Coordinates.ContigPosition.Builder contigPositionBuilder = Coordinates.ContigPosition.newBuilder();\n-            Coordinates.GenomicsDBColumn.Builder columnBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n             //begin\n             contigPositionBuilder.setContig(interval.getContig()).setPosition(interval.getStart());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxNzE0NQ==", "bodyText": "This method uses the workspace field, lets make them all consistent 1 way or another.  (I always like static methods but most of the existing methods are non-static and use the workspace field directly.)", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462517145", "createdAt": "2020-07-29T18:55:10Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -660,41 +706,84 @@ private void initializeInputPreloadExecutorService() {\n     }\n \n     private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionArgument arg) {\n-        progressMeter.update(intervals.get(0));\n+        progressMeter.update(null);\n         logger.info(\"Done importing batch \" + arg.batchCount + \"/\" + arg.totalBatchCount);\n         this.batchCount = arg.batchCount + 1;\n         return null;\n     }\n \n+    private GenomicsDBImportConfiguration.Partition createPartitionWithBeginAndEnd(\n+            Coordinates.GenomicsDBColumn begin, Coordinates.GenomicsDBColumn end) {\n+        GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n+        partitionBuilder.setBegin(begin);\n+        partitionBuilder.setEnd(end);\n+        partitionBuilder.setWorkspace(workspace);\n+        partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n+        return partitionBuilder.build();\n+    }\n+\n+    private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromWorkspace(final String workspace) {\n+        String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+        List<GenomicsDBImportConfiguration.Partition> configPartitions = new ArrayList<>();\n+        for (int i=0; i<partitions.length; i++) {\n+            long[] bounds = GenomicsDBUtils.getArrayColumnBounds(workspace, partitions[i]);\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            beginBuilder.setTiledbColumn(bounds[0]);\n+            endBuilder.setTiledbColumn(bounds[1]);\n+            configPartitions.add(createPartitionWithBeginAndEnd(beginBuilder.build(), endBuilder.build()));\n+        }\n+        return configPartitions;\n+    }\n+\n     private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromIntervals(List<SimpleInterval> chromosomeIntervals) {\n         return chromosomeIntervals.stream().map(interval -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 168}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTAxMA==", "bodyText": "Maybe we should pull out a constant BOUNDS_START and BOUNDS_END for these to make it clear the array is always structured the same way?  A pair of some sort might be a clearer api for returning these values.", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462519010", "createdAt": "2020-07-29T18:58:45Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -660,41 +706,84 @@ private void initializeInputPreloadExecutorService() {\n     }\n \n     private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionArgument arg) {\n-        progressMeter.update(intervals.get(0));\n+        progressMeter.update(null);\n         logger.info(\"Done importing batch \" + arg.batchCount + \"/\" + arg.totalBatchCount);\n         this.batchCount = arg.batchCount + 1;\n         return null;\n     }\n \n+    private GenomicsDBImportConfiguration.Partition createPartitionWithBeginAndEnd(\n+            Coordinates.GenomicsDBColumn begin, Coordinates.GenomicsDBColumn end) {\n+        GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n+        partitionBuilder.setBegin(begin);\n+        partitionBuilder.setEnd(end);\n+        partitionBuilder.setWorkspace(workspace);\n+        partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n+        return partitionBuilder.build();\n+    }\n+\n+    private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromWorkspace(final String workspace) {\n+        String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+        List<GenomicsDBImportConfiguration.Partition> configPartitions = new ArrayList<>();\n+        for (int i=0; i<partitions.length; i++) {\n+            long[] bounds = GenomicsDBUtils.getArrayColumnBounds(workspace, partitions[i]);\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            beginBuilder.setTiledbColumn(bounds[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 160}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyMDMwNA==", "bodyText": "Always attach the underlying exception as the cause.  It makes debugging way easier.", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462520304", "createdAt": "2020-07-29T19:00:54Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -660,41 +706,84 @@ private void initializeInputPreloadExecutorService() {\n     }\n \n     private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionArgument arg) {\n-        progressMeter.update(intervals.get(0));\n+        progressMeter.update(null);\n         logger.info(\"Done importing batch \" + arg.batchCount + \"/\" + arg.totalBatchCount);\n         this.batchCount = arg.batchCount + 1;\n         return null;\n     }\n \n+    private GenomicsDBImportConfiguration.Partition createPartitionWithBeginAndEnd(\n+            Coordinates.GenomicsDBColumn begin, Coordinates.GenomicsDBColumn end) {\n+        GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n+        partitionBuilder.setBegin(begin);\n+        partitionBuilder.setEnd(end);\n+        partitionBuilder.setWorkspace(workspace);\n+        partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n+        return partitionBuilder.build();\n+    }\n+\n+    private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromWorkspace(final String workspace) {\n+        String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+        List<GenomicsDBImportConfiguration.Partition> configPartitions = new ArrayList<>();\n+        for (int i=0; i<partitions.length; i++) {\n+            long[] bounds = GenomicsDBUtils.getArrayColumnBounds(workspace, partitions[i]);\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            beginBuilder.setTiledbColumn(bounds[0]);\n+            endBuilder.setTiledbColumn(bounds[1]);\n+            configPartitions.add(createPartitionWithBeginAndEnd(beginBuilder.build(), endBuilder.build()));\n+        }\n+        return configPartitions;\n+    }\n+\n     private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromIntervals(List<SimpleInterval> chromosomeIntervals) {\n         return chromosomeIntervals.stream().map(interval -> {\n-            GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n             Coordinates.ContigPosition.Builder contigPositionBuilder = Coordinates.ContigPosition.newBuilder();\n-            Coordinates.GenomicsDBColumn.Builder columnBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n             //begin\n             contigPositionBuilder.setContig(interval.getContig()).setPosition(interval.getStart());\n-            columnBuilder.setContigPosition(contigPositionBuilder.build());\n-            partitionBuilder.setBegin(columnBuilder.build());\n+            beginBuilder.setContigPosition(contigPositionBuilder.build());\n             //end\n             contigPositionBuilder.setPosition(interval.getEnd());\n-            columnBuilder.setContigPosition(contigPositionBuilder.build());\n-            partitionBuilder.setEnd(columnBuilder.build());\n-            partitionBuilder.setWorkspace(workspace);\n-            partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n-            return partitionBuilder.build();\n+            endBuilder.setContigPosition(contigPositionBuilder.build());\n+            return createPartitionWithBeginAndEnd(beginBuilder.build(), endBuilder.build());\n         }).collect(Collectors.toList());\n     }\n \n+    private void generateIntervalListFromVidMap() {\n+        try {\n+            GenomicsDBVidMapProto.VidMappingPB vidMapPB = \n+                org.broadinstitute.hellbender.tools.genomicsdb.GenomicsDBUtils.getProtobufVidMappingFromJsonFile(vidMapJSONFile);\n+    \n+            String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+            intervals = new ArrayList<>();\n+            for (int i=0; i<partitions.length; i++) {\n+                long[] bounds = GenomicsDBUtils.getArrayColumnBounds(workspace, partitions[i]);\n+                // merge-contigs-into-num-partitions ensures entire contigs are within a given partition\n+                // so we just check here that contig starts within the given bounds\n+                intervals.addAll(vidMapPB.getContigsList().stream()\n+                        .filter(x -> x.getTiledbColumnOffset() >= bounds[0] &&  \n+                        x.getTiledbColumnOffset() <= bounds[1])\n+                        .map(x -> new SimpleInterval(x.getName(), 1, Math.toIntExact(x.getLength())))\n+                        .collect(Collectors.toList()));\n+            }\n+        } catch (final IOException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 208}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyNTA3MQ==", "bodyText": "I always like foreach when index is irrelevant.", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462525071", "createdAt": "2020-07-29T19:09:16Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -660,41 +706,84 @@ private void initializeInputPreloadExecutorService() {\n     }\n \n     private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionArgument arg) {\n-        progressMeter.update(intervals.get(0));\n+        progressMeter.update(null);\n         logger.info(\"Done importing batch \" + arg.batchCount + \"/\" + arg.totalBatchCount);\n         this.batchCount = arg.batchCount + 1;\n         return null;\n     }\n \n+    private GenomicsDBImportConfiguration.Partition createPartitionWithBeginAndEnd(\n+            Coordinates.GenomicsDBColumn begin, Coordinates.GenomicsDBColumn end) {\n+        GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n+        partitionBuilder.setBegin(begin);\n+        partitionBuilder.setEnd(end);\n+        partitionBuilder.setWorkspace(workspace);\n+        partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n+        return partitionBuilder.build();\n+    }\n+\n+    private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromWorkspace(final String workspace) {\n+        String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+        List<GenomicsDBImportConfiguration.Partition> configPartitions = new ArrayList<>();\n+        for (int i=0; i<partitions.length; i++) {\n+            long[] bounds = GenomicsDBUtils.getArrayColumnBounds(workspace, partitions[i]);\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            beginBuilder.setTiledbColumn(bounds[0]);\n+            endBuilder.setTiledbColumn(bounds[1]);\n+            configPartitions.add(createPartitionWithBeginAndEnd(beginBuilder.build(), endBuilder.build()));\n+        }\n+        return configPartitions;\n+    }\n+\n     private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromIntervals(List<SimpleInterval> chromosomeIntervals) {\n         return chromosomeIntervals.stream().map(interval -> {\n-            GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n             Coordinates.ContigPosition.Builder contigPositionBuilder = Coordinates.ContigPosition.newBuilder();\n-            Coordinates.GenomicsDBColumn.Builder columnBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n             //begin\n             contigPositionBuilder.setContig(interval.getContig()).setPosition(interval.getStart());\n-            columnBuilder.setContigPosition(contigPositionBuilder.build());\n-            partitionBuilder.setBegin(columnBuilder.build());\n+            beginBuilder.setContigPosition(contigPositionBuilder.build());\n             //end\n             contigPositionBuilder.setPosition(interval.getEnd());\n-            columnBuilder.setContigPosition(contigPositionBuilder.build());\n-            partitionBuilder.setEnd(columnBuilder.build());\n-            partitionBuilder.setWorkspace(workspace);\n-            partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n-            return partitionBuilder.build();\n+            endBuilder.setContigPosition(contigPositionBuilder.build());\n+            return createPartitionWithBeginAndEnd(beginBuilder.build(), endBuilder.build());\n         }).collect(Collectors.toList());\n     }\n \n+    private void generateIntervalListFromVidMap() {\n+        try {\n+            GenomicsDBVidMapProto.VidMappingPB vidMapPB = \n+                org.broadinstitute.hellbender.tools.genomicsdb.GenomicsDBUtils.getProtobufVidMappingFromJsonFile(vidMapJSONFile);\n+    \n+            String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+            intervals = new ArrayList<>();\n+            for (int i=0; i<partitions.length; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 198}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyOTY2OA==", "bodyText": "Don't we still want to output the log messages even if we're getting intervals from an existing workspace?  Why does this need to short circuit here?  It seems like we could drop this whole condition because the initializeInputPreloadExecutorService method now guards against null intervals as well.", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462529668", "createdAt": "2020-07-29T19:17:03Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -602,23 +640,31 @@ private static void assertGVCFHasOnlyOneSample(final String variantPath, final V\n         return new TreeMap<>(loadSampleNameMapFile(sampleToFileMapPath));\n     }\n \n+    /**\n+     * write out interval list to file\n+     */\n+    private void writeIntervalListToFile() {\n+        final IntervalList outputList = new IntervalList(getBestAvailableSequenceDictionary());\n+        intervals.forEach(i -> outputList.add(new Interval(i.getContig(), i.getStart(), i.getEnd())));\n+        final Path intervalListOutputPath = IOUtils.getPath(intervalListOutputPathString);\n+        outputList.write(intervalListOutputPath.toFile());\n+    }\n+\n     /**\n      * Before traversal, fix configuration parameters and initialize\n      * GenomicsDB. Hard-coded to handle only VCF files and headers\n      */\n     @Override\n     public void onTraversalStart() {\n-        if (getIntervalsFromExistingWorkspace) {\n-            final IntervalList outputList = new IntervalList(getBestAvailableSequenceDictionary());\n-            intervals.forEach(i -> outputList.add(new Interval(i.getContig(), i.getStart(), i.getEnd())));\n-            final Path intervalListOutputPath = IOUtils.getPath(intervalListOutputPathString);\n-            outputList.write(intervalListOutputPath.toFile());\n-            return;\n-        }\n         String workspaceDir = BucketUtils.makeFilePathAbsolute(overwriteCreateOrCheckWorkspace());\n         vidMapJSONFile = IOUtils.appendPathToDir(workspaceDir, GenomicsDBConstants.DEFAULT_VIDMAP_FILE_NAME);\n         callsetMapJSONFile = IOUtils.appendPathToDir(workspaceDir, GenomicsDBConstants.DEFAULT_CALLSETMAP_FILE_NAME);\n         vcfHeaderFile = IOUtils.appendPathToDir(workspaceDir, GenomicsDBConstants.DEFAULT_VCFHEADER_FILE_NAME);\n+        if (getIntervalsFromExistingWorkspace) {\n+            // intervals may be null if merge-contigs-into-num-partitions was used to create workspace\n+            // if so, we need to wait for vid to be generated before writing out interval list\n+            return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUzMTA3OQ==", "bodyText": "I would make these less stateful by returning the list of intervals instead of modifying it in place.", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462531079", "createdAt": "2020-07-29T19:19:41Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -660,41 +706,84 @@ private void initializeInputPreloadExecutorService() {\n     }\n \n     private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionArgument arg) {\n-        progressMeter.update(intervals.get(0));\n+        progressMeter.update(null);\n         logger.info(\"Done importing batch \" + arg.batchCount + \"/\" + arg.totalBatchCount);\n         this.batchCount = arg.batchCount + 1;\n         return null;\n     }\n \n+    private GenomicsDBImportConfiguration.Partition createPartitionWithBeginAndEnd(\n+            Coordinates.GenomicsDBColumn begin, Coordinates.GenomicsDBColumn end) {\n+        GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n+        partitionBuilder.setBegin(begin);\n+        partitionBuilder.setEnd(end);\n+        partitionBuilder.setWorkspace(workspace);\n+        partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n+        return partitionBuilder.build();\n+    }\n+\n+    private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromWorkspace(final String workspace) {\n+        String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+        List<GenomicsDBImportConfiguration.Partition> configPartitions = new ArrayList<>();\n+        for (int i=0; i<partitions.length; i++) {\n+            long[] bounds = GenomicsDBUtils.getArrayColumnBounds(workspace, partitions[i]);\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            beginBuilder.setTiledbColumn(bounds[0]);\n+            endBuilder.setTiledbColumn(bounds[1]);\n+            configPartitions.add(createPartitionWithBeginAndEnd(beginBuilder.build(), endBuilder.build()));\n+        }\n+        return configPartitions;\n+    }\n+\n     private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromIntervals(List<SimpleInterval> chromosomeIntervals) {\n         return chromosomeIntervals.stream().map(interval -> {\n-            GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n             Coordinates.ContigPosition.Builder contigPositionBuilder = Coordinates.ContigPosition.newBuilder();\n-            Coordinates.GenomicsDBColumn.Builder columnBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n             //begin\n             contigPositionBuilder.setContig(interval.getContig()).setPosition(interval.getStart());\n-            columnBuilder.setContigPosition(contigPositionBuilder.build());\n-            partitionBuilder.setBegin(columnBuilder.build());\n+            beginBuilder.setContigPosition(contigPositionBuilder.build());\n             //end\n             contigPositionBuilder.setPosition(interval.getEnd());\n-            columnBuilder.setContigPosition(contigPositionBuilder.build());\n-            partitionBuilder.setEnd(columnBuilder.build());\n-            partitionBuilder.setWorkspace(workspace);\n-            partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n-            return partitionBuilder.build();\n+            endBuilder.setContigPosition(contigPositionBuilder.build());\n+            return createPartitionWithBeginAndEnd(beginBuilder.build(), endBuilder.build());\n         }).collect(Collectors.toList());\n     }\n \n+    private void generateIntervalListFromVidMap() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 191}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUzMTI2MQ==", "bodyText": "Similarly, this seems like it could return the value instead of modifying the field.", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r462531261", "createdAt": "2020-07-29T19:20:00Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -660,41 +706,84 @@ private void initializeInputPreloadExecutorService() {\n     }\n \n     private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionArgument arg) {\n-        progressMeter.update(intervals.get(0));\n+        progressMeter.update(null);\n         logger.info(\"Done importing batch \" + arg.batchCount + \"/\" + arg.totalBatchCount);\n         this.batchCount = arg.batchCount + 1;\n         return null;\n     }\n \n+    private GenomicsDBImportConfiguration.Partition createPartitionWithBeginAndEnd(\n+            Coordinates.GenomicsDBColumn begin, Coordinates.GenomicsDBColumn end) {\n+        GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n+        partitionBuilder.setBegin(begin);\n+        partitionBuilder.setEnd(end);\n+        partitionBuilder.setWorkspace(workspace);\n+        partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n+        return partitionBuilder.build();\n+    }\n+\n+    private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromWorkspace(final String workspace) {\n+        String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+        List<GenomicsDBImportConfiguration.Partition> configPartitions = new ArrayList<>();\n+        for (int i=0; i<partitions.length; i++) {\n+            long[] bounds = GenomicsDBUtils.getArrayColumnBounds(workspace, partitions[i]);\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            beginBuilder.setTiledbColumn(bounds[0]);\n+            endBuilder.setTiledbColumn(bounds[1]);\n+            configPartitions.add(createPartitionWithBeginAndEnd(beginBuilder.build(), endBuilder.build()));\n+        }\n+        return configPartitions;\n+    }\n+\n     private List<GenomicsDBImportConfiguration.Partition> generatePartitionListFromIntervals(List<SimpleInterval> chromosomeIntervals) {\n         return chromosomeIntervals.stream().map(interval -> {\n-            GenomicsDBImportConfiguration.Partition.Builder partitionBuilder = GenomicsDBImportConfiguration.Partition.newBuilder();\n             Coordinates.ContigPosition.Builder contigPositionBuilder = Coordinates.ContigPosition.newBuilder();\n-            Coordinates.GenomicsDBColumn.Builder columnBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder beginBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n+            Coordinates.GenomicsDBColumn.Builder endBuilder = Coordinates.GenomicsDBColumn.newBuilder();\n             //begin\n             contigPositionBuilder.setContig(interval.getContig()).setPosition(interval.getStart());\n-            columnBuilder.setContigPosition(contigPositionBuilder.build());\n-            partitionBuilder.setBegin(columnBuilder.build());\n+            beginBuilder.setContigPosition(contigPositionBuilder.build());\n             //end\n             contigPositionBuilder.setPosition(interval.getEnd());\n-            columnBuilder.setContigPosition(contigPositionBuilder.build());\n-            partitionBuilder.setEnd(columnBuilder.build());\n-            partitionBuilder.setWorkspace(workspace);\n-            partitionBuilder.setGenerateArrayNameFromPartitionBounds(true);\n-            return partitionBuilder.build();\n+            endBuilder.setContigPosition(contigPositionBuilder.build());\n+            return createPartitionWithBeginAndEnd(beginBuilder.build(), endBuilder.build());\n         }).collect(Collectors.toList());\n     }\n \n+    private void generateIntervalListFromVidMap() {\n+        try {\n+            GenomicsDBVidMapProto.VidMappingPB vidMapPB = \n+                org.broadinstitute.hellbender.tools.genomicsdb.GenomicsDBUtils.getProtobufVidMappingFromJsonFile(vidMapJSONFile);\n+    \n+            String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n+            intervals = new ArrayList<>();\n+            for (int i=0; i<partitions.length; i++) {\n+                long[] bounds = GenomicsDBUtils.getArrayColumnBounds(workspace, partitions[i]);\n+                // merge-contigs-into-num-partitions ensures entire contigs are within a given partition\n+                // so we just check here that contig starts within the given bounds\n+                intervals.addAll(vidMapPB.getContigsList().stream()\n+                        .filter(x -> x.getTiledbColumnOffset() >= bounds[0] &&  \n+                        x.getTiledbColumnOffset() <= bounds[1])\n+                        .map(x -> new SimpleInterval(x.getName(), 1, Math.toIntExact(x.getLength())))\n+                        .collect(Collectors.toList()));\n+            }\n+        } catch (final IOException e) {\n+            throw new UserException(\"Could not get vid map protobuf from file:\" + vidMapJSONFile + \n+                    \". Is the workspace corrupted?\");\n+        }\n+    }\n+\n     private void generateIntervalListFromWorkspace() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bef7c9b7869c6b42d58ae54700d078881f95e45"}, "originalPosition": 214}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "899dd40a2c8a622893c14afa1a973a574601330a", "author": {"user": {"login": "mlathara", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/899dd40a2c8a622893c14afa1a973a574601330a", "committedDate": "2020-07-31T21:54:06Z", "message": "address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNjA1NTI4", "url": "https://github.com/broadinstitute/gatk/pull/6681#pullrequestreview-463605528", "createdAt": "2020-08-07T20:54:52Z", "commit": {"oid": "899dd40a2c8a622893c14afa1a973a574601330a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMDo1NDo1MlrOG9njpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMDo1NDo1MlrOG9njpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI2NDQyMQ==", "bodyText": "I think you can avoid this funky collect -> stream if you use flat map above instead of map.", "url": "https://github.com/broadinstitute/gatk/pull/6681#discussion_r467264421", "createdAt": "2020-08-07T20:54:52Z", "author": {"login": "lbergelson"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/genomicsdb/GenomicsDBImport.java", "diffHunk": "@@ -751,50 +753,47 @@ private Void logMessageOnBatchCompletion(final BatchCompletionCallbackFunctionAr\n         }).collect(Collectors.toList());\n     }\n \n-    private void generateIntervalListFromVidMap() {\n+    private List<SimpleInterval> generateIntervalListFromVidMap() {\n         try {\n             GenomicsDBVidMapProto.VidMappingPB vidMapPB = \n                 org.broadinstitute.hellbender.tools.genomicsdb.GenomicsDBUtils.getProtobufVidMappingFromJsonFile(vidMapJSONFile);\n     \n-            String[] partitions = GenomicsDBUtils.listGenomicsDBArrays(workspace);\n-            intervals = new ArrayList<>();\n-            for (int i=0; i<partitions.length; i++) {\n-                long[] bounds = GenomicsDBUtils.getArrayColumnBounds(workspace, partitions[i]);\n+            List<String> partitions = Arrays.asList(GenomicsDBUtils.listGenomicsDBArrays(workspace));\n+            return partitions.stream().map(partition -> {\n+                long[] bounds = GenomicsDBUtils.getArrayColumnBounds(workspace, partition);\n                 // merge-contigs-into-num-partitions ensures entire contigs are within a given partition\n                 // so we just check here that contig starts within the given bounds\n-                intervals.addAll(vidMapPB.getContigsList().stream()\n-                        .filter(x -> x.getTiledbColumnOffset() >= bounds[0] &&  \n-                        x.getTiledbColumnOffset() <= bounds[1])\n+                return vidMapPB.getContigsList().stream()\n+                        .filter(x -> x.getTiledbColumnOffset() >= bounds[ARRAY_COLUMN_BOUNDS_START] &&  \n+                        x.getTiledbColumnOffset() <= bounds[ARRAY_COLUMN_BOUNDS_END])\n                         .map(x -> new SimpleInterval(x.getName(), 1, Math.toIntExact(x.getLength())))\n-                        .collect(Collectors.toList()));\n-            }\n+                        .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "899dd40a2c8a622893c14afa1a973a574601330a"}, "originalPosition": 131}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56f1c3137eddf3f4d8760c1e84136c53b13dd676", "author": {"user": {"login": "mlathara", "name": null}}, "url": "https://github.com/broadinstitute/gatk/commit/56f1c3137eddf3f4d8760c1e84136c53b13dd676", "committedDate": "2020-09-15T00:01:40Z", "message": "adding tests with many contigs to several where some contigs are empty, interval list nonadjacent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5OTk1MTYw", "url": "https://github.com/broadinstitute/gatk/pull/6681#pullrequestreview-519995160", "createdAt": "2020-10-29T19:16:04Z", "commit": {"oid": "56f1c3137eddf3f4d8760c1e84136c53b13dd676"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a70919ecc6f1bbcd67c4870df008fd599214fb2", "author": {"user": {"login": "nalinigans", "name": "Nalini Ganapati"}}, "url": "https://github.com/broadinstitute/gatk/commit/1a70919ecc6f1bbcd67c4870df008fd599214fb2", "committedDate": "2020-10-29T20:09:03Z", "message": "Merge genomicsdb_merge_contigs1 with master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2661, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}