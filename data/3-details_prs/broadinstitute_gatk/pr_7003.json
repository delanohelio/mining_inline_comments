{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxMjkyMjY2", "number": 7003, "title": "Better error bars for samples with small contamination in CalculateContamination", "bodyText": "@fleharty this is for you.", "createdAt": "2020-12-16T16:34:54Z", "url": "https://github.com/broadinstitute/gatk/pull/7003", "merged": true, "mergeCommit": {"oid": "f4082704f983969cae1333208f7055c7ea9ea1b7"}, "closed": true, "closedAt": "2021-05-12T17:31:10Z", "author": {"login": "davidbenjamin"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABd0pIimAFqTU3ODYyNDAxMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABeWEyKaAFqTY1ODAzMzQ5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc4NjI0MDEw", "url": "https://github.com/broadinstitute/gatk/pull/7003#pullrequestreview-578624010", "createdAt": "2021-01-28T18:29:06Z", "commit": {"oid": "c442c900bbda61ea215574f56e7a3e417e6b860a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOFQxODoyOTowNlrOIcFOHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOFQxODozNDowMFrOIcFaNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjMxNjU3Mg==", "bodyText": "Could you specify what equation this is constructing by putting the tex in javadoc?", "url": "https://github.com/broadinstitute/gatk/pull/7003#discussion_r566316572", "createdAt": "2021-01-28T18:29:06Z", "author": {"login": "fleharty"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/contamination/ContaminationModel.java", "diffHunk": "@@ -160,15 +162,49 @@ public ContaminationModel(List<PileupSummary> sites) {\n                 .mapToDouble(ps -> ps.getTotalCount() * oppositeAlleleFrequency.applyAsDouble(ps))\n                 .sum();\n \n-        final double contamination = contaminationOppositeDepth / totalDepthWeightedByOppositeFrequency;\n+        final double contaminationEstimate = contaminationOppositeDepth / totalDepthWeightedByOppositeFrequency;\n+\n+        final double coeff1 = homs.stream().mapToDouble(ps -> oppositeAlleleFrequency.applyAsDouble(ps) * ps.getTotalCount()).sum();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c442c900bbda61ea215574f56e7a3e417e6b860a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjMxODA2MA==", "bodyText": "standard error of 0.05\nCould you make this clearer?", "url": "https://github.com/broadinstitute/gatk/pull/7003#discussion_r566318060", "createdAt": "2021-01-28T18:31:19Z", "author": {"login": "fleharty"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/contamination/ContaminationModel.java", "diffHunk": "@@ -160,15 +162,49 @@ public ContaminationModel(List<PileupSummary> sites) {\n                 .mapToDouble(ps -> ps.getTotalCount() * oppositeAlleleFrequency.applyAsDouble(ps))\n                 .sum();\n \n-        final double contamination = contaminationOppositeDepth / totalDepthWeightedByOppositeFrequency;\n+        final double contaminationEstimate = contaminationOppositeDepth / totalDepthWeightedByOppositeFrequency;\n+\n+        final double coeff1 = homs.stream().mapToDouble(ps -> oppositeAlleleFrequency.applyAsDouble(ps) * ps.getTotalCount()).sum();\n+        final double coeff2 = homs.stream().mapToDouble(ps ->\n+                oppositeAlleleFrequency.applyAsDouble(ps)*(1 - oppositeAlleleFrequency.applyAsDouble(ps)) * MathUtils.square(ps.getTotalCount())\n+        ).sum();\n+\n+        final DoubleUnaryOperator errorFunc = c -> homs.isEmpty() ? 1 : Math.sqrt(coeff1*c*(1-c) + coeff2*c*c) / totalDepthWeightedByOppositeFrequency;\n+\n+        // we're going to binary search to find the largest contamination whose expected standard error brings it within range of\n+        // our estimate.  That is, suppose we estimate a contamination of 0.03 and the standard error of 0.05 is 0.02.  Then 0.05 is", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c442c900bbda61ea215574f56e7a3e417e6b860a"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjMxOTY2OA==", "bodyText": "Could you either find a standard binary search, or generalize this in MathUtils?\nIf you add it in MathUtils, create a simple test for it.", "url": "https://github.com/broadinstitute/gatk/pull/7003#discussion_r566319668", "createdAt": "2021-01-28T18:34:00Z", "author": {"login": "fleharty"}, "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/contamination/ContaminationModel.java", "diffHunk": "@@ -160,15 +162,49 @@ public ContaminationModel(List<PileupSummary> sites) {\n                 .mapToDouble(ps -> ps.getTotalCount() * oppositeAlleleFrequency.applyAsDouble(ps))\n                 .sum();\n \n-        final double contamination = contaminationOppositeDepth / totalDepthWeightedByOppositeFrequency;\n+        final double contaminationEstimate = contaminationOppositeDepth / totalDepthWeightedByOppositeFrequency;\n+\n+        final double coeff1 = homs.stream().mapToDouble(ps -> oppositeAlleleFrequency.applyAsDouble(ps) * ps.getTotalCount()).sum();\n+        final double coeff2 = homs.stream().mapToDouble(ps ->\n+                oppositeAlleleFrequency.applyAsDouble(ps)*(1 - oppositeAlleleFrequency.applyAsDouble(ps)) * MathUtils.square(ps.getTotalCount())\n+        ).sum();\n+\n+        final DoubleUnaryOperator errorFunc = c -> homs.isEmpty() ? 1 : Math.sqrt(coeff1*c*(1-c) + coeff2*c*c) / totalDepthWeightedByOppositeFrequency;\n+\n+        // we're going to binary search to find the largest contamination whose expected standard error brings it within range of\n+        // our estimate.  That is, suppose we estimate a contamination of 0.03 and the standard error of 0.05 is 0.02.  Then 0.05 is\n+        // the upper end of our 1-sigma confidence interval.\n+        // this binary search is far from optimized (in fact we could solve this explicitly with a messy closed-form solution)\n+        // but it converges to a precision of 1e-6 in 20 iterations of the square root of a linear function.  This is fast enough.\n+        double top = 1.0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c442c900bbda61ea215574f56e7a3e417e6b860a"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59c214735a3324099183f1e937fb19e21c35e4e1", "author": {"user": {"login": "davidbenjamin", "name": "David Benjamin"}}, "url": "https://github.com/broadinstitute/gatk/commit/59c214735a3324099183f1e937fb19e21c35e4e1", "committedDate": "2021-02-24T05:00:46Z", "message": "improved error bars in CalculateContamination when contamination is very small"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d03758853b98caa86dbdd7069187fba99036c0dd", "author": {"user": {"login": "davidbenjamin", "name": "David Benjamin"}}, "url": "https://github.com/broadinstitute/gatk/commit/d03758853b98caa86dbdd7069187fba99036c0dd", "committedDate": "2021-02-24T05:00:49Z", "message": "integration tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c442c900bbda61ea215574f56e7a3e417e6b860a", "author": {"user": {"login": "davidbenjamin", "name": "David Benjamin"}}, "url": "https://github.com/broadinstitute/gatk/commit/c442c900bbda61ea215574f56e7a3e417e6b860a", "committedDate": "2020-12-16T16:32:27Z", "message": "integration tests"}, "afterCommit": {"oid": "3b5fd8ae42b9087e4dbc20192a989884d521d0b4", "author": {"user": {"login": "davidbenjamin", "name": "David Benjamin"}}, "url": "https://github.com/broadinstitute/gatk/commit/3b5fd8ae42b9087e4dbc20192a989884d521d0b4", "committedDate": "2021-02-24T05:00:49Z", "message": "edits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dc863899da2f3e7cb7abb06dd16ebebf51419f7", "author": {"user": {"login": "davidbenjamin", "name": "David Benjamin"}}, "url": "https://github.com/broadinstitute/gatk/commit/6dc863899da2f3e7cb7abb06dd16ebebf51419f7", "committedDate": "2021-02-24T05:03:01Z", "message": "edits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b5fd8ae42b9087e4dbc20192a989884d521d0b4", "author": {"user": {"login": "davidbenjamin", "name": "David Benjamin"}}, "url": "https://github.com/broadinstitute/gatk/commit/3b5fd8ae42b9087e4dbc20192a989884d521d0b4", "committedDate": "2021-02-24T05:00:49Z", "message": "edits"}, "afterCommit": {"oid": "6dc863899da2f3e7cb7abb06dd16ebebf51419f7", "author": {"user": {"login": "davidbenjamin", "name": "David Benjamin"}}, "url": "https://github.com/broadinstitute/gatk/commit/6dc863899da2f3e7cb7abb06dd16ebebf51419f7", "committedDate": "2021-02-24T05:03:01Z", "message": "edits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjU4MDMzNDkw", "url": "https://github.com/broadinstitute/gatk/pull/7003#pullrequestreview-658033490", "createdAt": "2021-05-12T15:29:08Z", "commit": {"oid": "6dc863899da2f3e7cb7abb06dd16ebebf51419f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2460, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}