{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4OTY5MDU3", "number": 870, "title": "Ps provider init fix", "bodyText": "", "createdAt": "2020-02-24T12:41:04Z", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/870", "merged": true, "mergeCommit": {"oid": "3b3b91ba84b8ce2efa39d0102c44f73932270553"}, "closed": true, "closedAt": "2020-02-24T13:52:35Z", "author": {"login": "psantos1113"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGmXuWAH2gAyMzc4OTY5MDU3OmFlZmM5MDBiZWNmOGE1NmM3ZmM1MmYxZjc3MTgyNGUwNmZhOGQ5ODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHd2OxAH2gAyMzc4OTY5MDU3OjE5M2EyZjQxMzU0ZTc2MDc3YTM5YjJhYzcyNDUzNWY0ZWY2YmMzZDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aefc900becf8a56c7fc52f1f771824e06fa8d984", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/aefc900becf8a56c7fc52f1f771824e06fa8d984", "committedDate": "2020-02-21T21:11:56Z", "message": "refactor: Initialize providers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1767fec0df8ec97a18a0068ea40c480a89984953", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/1767fec0df8ec97a18a0068ea40c480a89984953", "committedDate": "2020-02-24T12:14:14Z", "message": "refactor(provider): Get the tasks by their class then compare names."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79ff2a790c93f72c8d5a1b9dc67859aba117aa20", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/79ff2a790c93f72c8d5a1b9dc67859aba117aa20", "committedDate": "2020-02-24T12:40:20Z", "message": "refactor: Remove check if task was running."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bab31cce7d8e06e1b3ac77d89903087e3430752", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/6bab31cce7d8e06e1b3ac77d89903087e3430752", "committedDate": "2020-02-24T12:47:01Z", "message": "Merge remote-tracking branch 'origin/feat_provider_lifecycle_management' into ps_provider_init_fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzgyMzA1", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/870#pullrequestreview-363382305", "createdAt": "2020-02-24T13:20:57Z", "commit": {"oid": "6bab31cce7d8e06e1b3ac77d89903087e3430752"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d686df7d7805cbf7c779acdd767b36cd581de25f", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/d686df7d7805cbf7c779acdd767b36cd581de25f", "committedDate": "2020-02-24T13:43:04Z", "message": "Merge remote-tracking branch 'origin/feat_provider_lifecycle_management' into ps_provider_init_fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzk3Nzg1", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/870#pullrequestreview-363397785", "createdAt": "2020-02-24T13:46:03Z", "commit": {"oid": "d686df7d7805cbf7c779acdd767b36cd581de25f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzo0NjowM1rOFthGCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzo0NjowM1rOFthGCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3MjQ1Ng==", "bodyText": "This should say \"tasks\".", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/870#discussion_r383272456", "createdAt": "2020-02-24T13:46:03Z", "author": {"login": "gkillough"}, "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/provider/lifecycle/ProviderLifecycleManager.java", "diffHunk": "@@ -81,29 +80,28 @@ public ProviderLifecycleManager(List<Provider> providers, TaskManager taskManage\n         }\n \n         List<ProviderTask> providerTasks = provider.createProviderTasks(providerProperties);\n+        unscheduleTasksForProviderConfig(provider, providerProperties.getConfigId());\n         for (ProviderTask task : providerTasks) {\n             if (taskManager.getNextRunTime(task.getTaskName()).isEmpty()) {\n                 scheduleTask(task);\n                 acceptedTasks.add(task);\n             }\n         }\n+        logger.debug(\"Finished scheduling task for config with id {} and descriptor id {}\", providerConfig.getConfigurationId(), providerConfig.getDescriptorId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d686df7d7805cbf7c779acdd767b36cd581de25f"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzk3OTAy", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/870#pullrequestreview-363397902", "createdAt": "2020-02-24T13:46:14Z", "commit": {"oid": "d686df7d7805cbf7c779acdd767b36cd581de25f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzo0NjoxNVrOFthGaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzo0NjoxNVrOFthGaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3MjU1Mw==", "bodyText": "\"tasks\"", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/870#discussion_r383272553", "createdAt": "2020-02-24T13:46:15Z", "author": {"login": "gkillough"}, "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/provider/lifecycle/ProviderLifecycleManager.java", "diffHunk": "@@ -81,29 +80,28 @@ public ProviderLifecycleManager(List<Provider> providers, TaskManager taskManage\n         }\n \n         List<ProviderTask> providerTasks = provider.createProviderTasks(providerProperties);\n+        unscheduleTasksForProviderConfig(provider, providerProperties.getConfigId());\n         for (ProviderTask task : providerTasks) {\n             if (taskManager.getNextRunTime(task.getTaskName()).isEmpty()) {\n                 scheduleTask(task);\n                 acceptedTasks.add(task);\n             }\n         }\n+        logger.debug(\"Finished scheduling task for config with id {} and descriptor id {}\", providerConfig.getConfigurationId(), providerConfig.getDescriptorId());\n         return acceptedTasks;\n     }\n \n     public void unscheduleTasksForProviderConfig(Provider provider, Long providerConfigId) {\n         logger.debug(\"Performing unscheduling task for provider config: id={}\", providerConfigId);\n \n-        // TODO find a better way to get the task names\n-        Set<String> runningTasksForProviderConfig = taskManager.getRunningTaskNames()\n-                                                        .stream()\n-                                                        .filter(name -> name.contains(provider.getKey().getUniversalKey()))\n-                                                        .filter(name -> name.contains(\"id:\" + providerConfigId))\n-                                                        .collect(Collectors.toSet());\n-        for (String taskName : runningTasksForProviderConfig) {\n-            if (taskManager.getNextRunTime(taskName).isPresent()) {\n-                unscheduleTask(taskName);\n-            }\n+        List<ProviderTask> tasks = taskManager.getTasksByClass(ProviderTask.class).stream()\n+                                       .filter(task -> task.getProviderProperties().getConfigId().equals(providerConfigId))\n+                                       .collect(Collectors.toList());\n+\n+        for (ProviderTask task : tasks) {\n+            unscheduleTask(task.getTaskName());\n         }\n+        logger.debug(\"Finished unscheduling task for provider config: id={}\", providerConfigId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d686df7d7805cbf7c779acdd767b36cd581de25f"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "193a2f41354e76077a39b2ac724535f4ef6bc3d9", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/193a2f41354e76077a39b2ac724535f4ef6bc3d9", "committedDate": "2020-02-24T13:50:02Z", "message": "refactor: Fix typo in log message."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2837, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}