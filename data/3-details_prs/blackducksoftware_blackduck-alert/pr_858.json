{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NDg1NTA1", "number": 858, "title": "Add provider config id to data tables", "bodyText": "", "createdAt": "2020-02-14T17:03:42Z", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858", "merged": true, "mergeCommit": {"oid": "1ec88e3be46f95e03c5bba975b4893690cb5bf1b"}, "closed": true, "closedAt": "2020-02-18T17:09:55Z", "author": {"login": "gkillough"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcESMWzAH2gAyMzc1NDg1NTA1OjNkOGY2ZWNlOTA1NTcwOTg4OTQxNDQ0NGNjZDUxZWY0Y2MwN2QwZWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFlC1MgH2gAyMzc1NDg1NTA1OjFlYzg4ZTNiZTQ2Zjk1ZTAzYzViYmE5NzViNDg5MzY5MGNiNWJmMWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3d8f6ece9055709889414444ccd51ef4cc07d0ea", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/3d8f6ece9055709889414444ccd51ef4cc07d0ea", "committedDate": "2020-02-14T16:33:34Z", "message": "Fix(Java): Begin updating the database API for ProviderData to handle multiple configs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68ece05d7f9209fc093f254a062bfbbba8d2f33d", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/68ece05d7f9209fc093f254a062bfbbba8d2f33d", "committedDate": "2020-02-14T16:46:45Z", "message": "Feat(Liquibase): Add column to provider_projects and provider_users for config id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d85892ad101f9a3ebd43298ebed271254999f88", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/6d85892ad101f9a3ebd43298ebed271254999f88", "committedDate": "2020-02-14T16:55:02Z", "message": "Merge branch 'feat_provider_lifecycle_management' into gk_add_provider_config_id_to_data_tables"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MTcwNDM1", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#pullrequestreview-359170435", "createdAt": "2020-02-14T19:30:41Z", "commit": {"oid": "6d85892ad101f9a3ebd43298ebed271254999f88"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxOTozMDo0MVrOFqBWWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxOTozMDo0MVrOFqBWWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwNjYxNw==", "bodyText": "Why are we ignoring this exception?", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#discussion_r379606617", "createdAt": "2020-02-14T19:30:41Z", "author": {"login": "jamesrichard91"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultProviderDataAccessor.java", "diffHunk": "@@ -58,56 +54,52 @@\n @Component\n @Transactional\n public class DefaultProviderDataAccessor implements ProviderDataAccessor {\n-    public static final Integer DEFAULT_OFFSET = 0;\n-    public static final Integer DEFAULT_LIMIT = 100;\n-\n     public static final int MAX_DESCRIPTION_LENGTH = 250;\n     public static final int MAX_PROJECT_NAME_LENGTH = 507;\n \n     private final Logger logger = LoggerFactory.getLogger(DefaultProviderDataAccessor.class);\n     private final ProviderProjectRepository providerProjectRepository;\n     private final ProviderUserProjectRelationRepository providerUserProjectRelationRepository;\n     private final ProviderUserRepository providerUserRepository;\n+    private final ConfigurationAccessor configurationAccessor;\n \n     @Autowired\n-    public DefaultProviderDataAccessor(ProviderProjectRepository providerProjectRepository, ProviderUserProjectRelationRepository providerUserProjectRelationRepository, ProviderUserRepository providerUserRepository) {\n+    public DefaultProviderDataAccessor(ProviderProjectRepository providerProjectRepository, ProviderUserProjectRelationRepository providerUserProjectRelationRepository, ProviderUserRepository providerUserRepository,\n+        ConfigurationAccessor configurationAccessor) {\n         this.providerProjectRepository = providerProjectRepository;\n         this.providerUserProjectRelationRepository = providerUserProjectRelationRepository;\n         this.providerUserRepository = providerUserRepository;\n+        this.configurationAccessor = configurationAccessor;\n     }\n \n     @Override\n     @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public Optional<ProviderProject> findFirstByHref(String href) {\n-        return providerProjectRepository.findFirstByHref(href).map(this::convertToProjectModel);\n-    }\n-\n-    @Override\n-    @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public Optional<ProviderProject> findFirstByName(String name) {\n-        return providerProjectRepository.findFirstByName(name).map(this::convertToProjectModel);\n-    }\n-\n-    @Override\n-    @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public List<ProviderProject> findByProviderName(String providerName) {\n-        return providerProjectRepository.findByProvider(providerName)\n-                   .stream()\n-                   .map(this::convertToProjectModel)\n-                   .collect(Collectors.toList());\n+    public List<ProviderProject> findByProviderConfigName(String providerConfigName) {\n+        try {\n+            Optional<Long> optionalConfigId = configurationAccessor.getProviderConfigurationByName(providerConfigName)\n+                                                  .map(ConfigurationModel::getConfigurationId);\n+            if (optionalConfigId.isPresent()) {\n+                return providerProjectRepository.findByProviderConfigId(optionalConfigId.get())\n+                           .stream()\n+                           .map(this::convertToProjectModel)\n+                           .collect(Collectors.toList());\n+            }\n+        } catch (AlertDatabaseConstraintException ignored) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d85892ad101f9a3ebd43298ebed271254999f88"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzY0Mjk2", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#pullrequestreview-360364296", "createdAt": "2020-02-18T14:08:00Z", "commit": {"oid": "6d85892ad101f9a3ebd43298ebed271254999f88"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDowODowMFrOFrDoVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDowODowMFrOFrDoVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY5MjU2NQ==", "bodyText": "This was never used in production.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#discussion_r380692565", "createdAt": "2020-02-18T14:08:00Z", "author": {"login": "gkillough"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultProviderDataAccessor.java", "diffHunk": "@@ -130,78 +122,51 @@ public void deleteProjects(ProviderKey providerKey, Collection<ProviderProject>\n \n     @Override\n     @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public List<ProviderUserModel> getAllUsers(String providerName) {\n-        return providerUserRepository.findByProvider(providerName)\n+    public List<ProviderUserModel> getAllUsers(Long providerConfigId) {\n+        return providerUserRepository.findByProviderConfigId(providerConfigId)\n                    .stream()\n                    .map(this::convertToUserModel)\n                    .collect(Collectors.toList());\n     }\n \n     @Override\n-    @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public AlertPagedModel<ProviderUserModel> getPageOfUsers(String providerName, Integer pageNumber, Integer pageSize, String q) throws AlertDatabaseConstraintException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d85892ad101f9a3ebd43298ebed271254999f88"}, "originalPosition": 115}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7df40f2fd5aaa0a514e5e697f7a7fa7dbe896e9", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/d7df40f2fd5aaa0a514e5e697f7a7fa7dbe896e9", "committedDate": "2020-02-18T14:14:57Z", "message": "Fix(Liquibase): Drop provider column from provider data tables"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzgyNTc4", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#pullrequestreview-360382578", "createdAt": "2020-02-18T14:30:21Z", "commit": {"oid": "d7df40f2fd5aaa0a514e5e697f7a7fa7dbe896e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDozMDoyMVrOFrEe4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDozMDoyMVrOFrEe4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcwNjUzMA==", "bodyText": "Are we missing @Transactional on this method?", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#discussion_r380706530", "createdAt": "2020-02-18T14:30:21Z", "author": {"login": "psantos1113"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultProviderDataAccessor.java", "diffHunk": "@@ -58,56 +54,52 @@\n @Component\n @Transactional\n public class DefaultProviderDataAccessor implements ProviderDataAccessor {\n-    public static final Integer DEFAULT_OFFSET = 0;\n-    public static final Integer DEFAULT_LIMIT = 100;\n-\n     public static final int MAX_DESCRIPTION_LENGTH = 250;\n     public static final int MAX_PROJECT_NAME_LENGTH = 507;\n \n     private final Logger logger = LoggerFactory.getLogger(DefaultProviderDataAccessor.class);\n     private final ProviderProjectRepository providerProjectRepository;\n     private final ProviderUserProjectRelationRepository providerUserProjectRelationRepository;\n     private final ProviderUserRepository providerUserRepository;\n+    private final ConfigurationAccessor configurationAccessor;\n \n     @Autowired\n-    public DefaultProviderDataAccessor(ProviderProjectRepository providerProjectRepository, ProviderUserProjectRelationRepository providerUserProjectRelationRepository, ProviderUserRepository providerUserRepository) {\n+    public DefaultProviderDataAccessor(ProviderProjectRepository providerProjectRepository, ProviderUserProjectRelationRepository providerUserProjectRelationRepository, ProviderUserRepository providerUserRepository,\n+        ConfigurationAccessor configurationAccessor) {\n         this.providerProjectRepository = providerProjectRepository;\n         this.providerUserProjectRelationRepository = providerUserProjectRelationRepository;\n         this.providerUserRepository = providerUserRepository;\n+        this.configurationAccessor = configurationAccessor;\n     }\n \n     @Override\n     @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public Optional<ProviderProject> findFirstByHref(String href) {\n-        return providerProjectRepository.findFirstByHref(href).map(this::convertToProjectModel);\n-    }\n-\n-    @Override\n-    @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public Optional<ProviderProject> findFirstByName(String name) {\n-        return providerProjectRepository.findFirstByName(name).map(this::convertToProjectModel);\n-    }\n-\n-    @Override\n-    @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public List<ProviderProject> findByProviderName(String providerName) {\n-        return providerProjectRepository.findByProvider(providerName)\n-                   .stream()\n-                   .map(this::convertToProjectModel)\n-                   .collect(Collectors.toList());\n+    public List<ProviderProject> findByProviderConfigName(String providerConfigName) {\n+        try {\n+            Optional<Long> optionalConfigId = configurationAccessor.getProviderConfigurationByName(providerConfigName)\n+                                                  .map(ConfigurationModel::getConfigurationId);\n+            if (optionalConfigId.isPresent()) {\n+                return providerProjectRepository.findByProviderConfigId(optionalConfigId.get())\n+                           .stream()\n+                           .map(this::convertToProjectModel)\n+                           .collect(Collectors.toList());\n+            }\n+        } catch (AlertDatabaseConstraintException ignored) {\n+        }\n+        return List.of();\n     }\n \n     @Override\n     @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public List<ProviderProject> findByProviderKey(ProviderKey providerKey) {\n-        return providerProjectRepository.findByProvider(providerKey.getUniversalKey())\n+    public List<ProviderProject> findByProviderConfigId(Long providerConfigId) {\n+        return providerProjectRepository.findByProviderConfigId(providerConfigId)\n                    .stream()\n                    .map(this::convertToProjectModel)\n                    .collect(Collectors.toList());\n     }\n \n     @Override\n-    public void deleteProjects(ProviderKey providerKey, Collection<ProviderProject> providerProjects) {\n+    public void deleteProjects(Collection<ProviderProject> providerProjects) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7df40f2fd5aaa0a514e5e697f7a7fa7dbe896e9"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1db0ed330fb1c13f439c220ba6d51ee0322a7bc", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/f1db0ed330fb1c13f439c220ba6d51ee0322a7bc", "committedDate": "2020-02-18T15:05:51Z", "message": "Fix(Java): Resolve FIXMEs within the scope of this issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDQ1MDA2", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#pullrequestreview-360445006", "createdAt": "2020-02-18T15:42:05Z", "commit": {"oid": "f1db0ed330fb1c13f439c220ba6d51ee0322a7bc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ec88e3be46f95e03c5bba975b4893690cb5bf1b", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/1ec88e3be46f95e03c5bba975b4893690cb5bf1b", "committedDate": "2020-02-18T17:05:17Z", "message": "Fix(Liquibase): Add column type to new columns in provider data"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2817, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}