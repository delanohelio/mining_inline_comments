{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMzk2NDk0", "number": 993, "title": "duplicate email fix", "bodyText": "Need to remove old user and project relations.  We were never removing old relations only adding new relations.  Using similar logic to updating the projects where we determine what to add and what to remove.", "createdAt": "2020-05-26T19:04:01Z", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/993", "merged": true, "mergeCommit": {"oid": "f435503835e741d201e180869372b3c4e3dd7786"}, "closed": true, "closedAt": "2020-05-27T16:46:18Z", "author": {"login": "psantos1113"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclIdiZgH2gAyNDIzMzk2NDk0OjM1Mzc4NjNjYzEzY2M0YzdhZGYwZWUxZThkNjI3NTFjMDE0NzY1NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclZiW1AFqTQxOTIyMzI1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3537863cc13cc4c7adf0ee1e8d62751c01476541", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/3537863cc13cc4c7adf0ee1e8d62751c01476541", "committedDate": "2020-05-26T17:52:47Z", "message": "fix: Update project email relations to remove old relations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f033bb7295fd199aa93a5983509b538ec3ae7e2", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/5f033bb7295fd199aa93a5983509b538ec3ae7e2", "committedDate": "2020-05-26T18:14:59Z", "message": "Merge remote-tracking branch 'origin/6.0.0' into ps_duplicate_email_fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e311962aded6b5b296ce9c0297b3d1cef92ccf7", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/8e311962aded6b5b296ce9c0297b3d1cef92ccf7", "committedDate": "2020-05-26T18:15:23Z", "message": "Merge remote-tracking branch 'origin/ps_real_time_fix' into ps_duplicate_email_fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22c5cbf4641668f96332e683f381718ccd766134", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/22c5cbf4641668f96332e683f381718ccd766134", "committedDate": "2020-05-26T19:00:23Z", "message": "fix: Update project and user relations in the database."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NTk5NDU3", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/993#pullrequestreview-418599457", "createdAt": "2020-05-26T19:14:54Z", "commit": {"oid": "22c5cbf4641668f96332e683f381718ccd766134"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxOToxNDo1NFrOGasmIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxOToxNDo1NFrOGasmIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY0NjgxOA==", "bodyText": "Why does findByEmailAddressAndProviderConfigId(...) return a List? Shouldn't it be an optional?\nI think what we want is a findByEmailAddressInAndProviderConfigId(Collection<String> emailAddresses, Long providerConfigId). (Note the \"In\" in the method name; this will allow us to get all of the relevant relations in a single query).", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/993#discussion_r430646818", "createdAt": "2020-05-26T19:14:54Z", "author": {"login": "gkillough"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultProviderDataAccessor.java", "diffHunk": "@@ -163,12 +164,21 @@ private void mapUsersToProjectByEmail(Long providerConfigId, String projectHref,\n         ProviderProjectEntity project = providerProjectRepository.findFirstByHref(projectHref)\n                                             .orElseThrow(() -> new AlertDatabaseConstraintException(\"A project with the following href did not exist: \" + projectHref));\n         Long projectId = project.getId();\n+        List<ProviderUserProjectRelation> userRelationsToRemove = providerUserProjectRelationRepository.findByProviderProjectId(projectId);\n+        List<ProviderUserProjectRelation> userRelationsToAdd = new LinkedList<>();\n         for (String emailAddress : emailAddresses) {\n-            providerUserRepository.findByEmailAddressAndProviderConfigId(emailAddress, providerConfigId)\n-                .stream()\n-                .map(ProviderUserEntity::getId)\n-                .forEach(userId -> providerUserProjectRelationRepository.save(new ProviderUserProjectRelation(userId, projectId)));\n+            List<ProviderUserEntity> providerUserEntities = providerUserRepository.findByEmailAddressAndProviderConfigId(emailAddress, providerConfigId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22c5cbf4641668f96332e683f381718ccd766134"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NjAwMTE3", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/993#pullrequestreview-418600117", "createdAt": "2020-05-26T19:15:52Z", "commit": {"oid": "22c5cbf4641668f96332e683f381718ccd766134"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "227ee1763c26818fc6bf6f3c859760f48d1e382d", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/227ee1763c26818fc6bf6f3c859760f48d1e382d", "committedDate": "2020-05-27T12:10:13Z", "message": "refactor: Remove a for loop using a JPA query."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33d098a4bcd63bef5e857aad17b62f3518cbfa36", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/33d098a4bcd63bef5e857aad17b62f3518cbfa36", "committedDate": "2020-05-27T12:10:37Z", "message": "Merge remote-tracking branch 'origin/6.0.0' into ps_duplicate_email_fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MjIzMjU5", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/993#pullrequestreview-419223259", "createdAt": "2020-05-27T13:46:26Z", "commit": {"oid": "33d098a4bcd63bef5e857aad17b62f3518cbfa36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2744, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}