{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMjEzNzk5", "number": 924, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMDoxMzoyN1rODpqXdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozOTo0MVrODp5NbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDEyMzQyOnYy", "diffSide": "RIGHT", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMDoxMzoyN1rOF4-xXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTozNzo0N1rOF5Y1KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5MzAyMQ==", "bodyText": "Here's where the change really is.  try catch block for the old code that was failing.  Attempt to delete from the audit relation by notification id.  Otherwise if it fails log it and move on to deleting the notifications.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395293021", "createdAt": "2020-03-19T20:13:27Z", "author": {"login": "psantos1113"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3OTU2Nw==", "bodyText": "Does this have to do with foreign keys?", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395679567", "createdAt": "2020-03-20T14:37:46Z", "author": {"login": "gkillough"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5MzAyMQ=="}, "originalCommit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcxOTk3Nw==", "bodyText": "Yes I believe it has to do with the foreign key constraints between the audit_notification_relation, audit_entry, and raw_notification_content tables.  Currently the customer is in a state\nI can't produce the problem in 5.1.0 and 5.3.0. Because the database is in this odd state in 5.0.0 this change will be able to allow notifications to be purged to clean up the database. Alert may have been missing some delete on cascade constraints.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395719977", "createdAt": "2020-03-20T15:37:47Z", "author": {"login": "psantos1113"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5MzAyMQ=="}, "originalCommit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "originalPosition": 159}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MjU1MzE5OnYy", "diffSide": "RIGHT", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozOTowN1rOF5Waiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTozODozM1rOF5Y3Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4MDM5NQ==", "bodyText": "Why bother saving this as a variable? A method reference itself is stateless, so I don't think there is a benefit.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395680395", "createdAt": "2020-03-20T14:39:07Z", "author": {"login": "gkillough"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {\n+            foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n+            Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcyMDQ5MA==", "bodyText": "I think I had a different solution in mind when I first wrote the change.  I will look to clean up.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395720490", "createdAt": "2020-03-20T15:38:33Z", "author": {"login": "psantos1113"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {\n+            foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n+            Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4MDM5NQ=="}, "originalCommit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "originalPosition": 161}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MjU1NTMyOnYy", "diffSide": "RIGHT", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozOTo0MVrOF5Wb8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozOTo0MVrOF5Wb8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4MDc1Mw==", "bodyText": "Each method that returns a Stream should be on its own line.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395680753", "createdAt": "2020-03-20T14:39:41Z", "author": {"login": "gkillough"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {\n+            foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n+            Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n+            List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "originalPosition": 162}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1937, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}