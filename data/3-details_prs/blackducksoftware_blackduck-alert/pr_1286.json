{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNjYxNjky", "number": 1286, "title": "Update NotificationProcessor and DistributionEvents to use new Accessor", "bodyText": "DistribuionEvents are used in a lot of places\nOur previous API was terrible because rather than asking for the fields it required to run, all fields were stuffed into a FieldUtility and then passed around", "createdAt": "2020-12-04T17:03:12Z", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286", "merged": true, "mergeCommit": {"oid": "a11dd1e3bcbe9d5739c895f28b3aca0d14089e02"}, "closed": true, "closedAt": "2020-12-08T20:17:53Z", "author": {"login": "gkillough"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdip0SmgH2gAyNTMyNjYxNjkyOjVlOTBjNGZiZTU4ODJhY2YwMTViMDRmNDk3MGNlNTczOGM2NDk2MWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkPzd3AH2gAyNTMyNjYxNjkyOmU1MTE4NDY1MmM2NjYzMmFlZjY5ZTFmMTQ0ZjQzYWRjZTFjNjE1ZjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5e90c4fbe5882acf015b04f4970ce5738c64961c", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/5e90c4fbe5882acf015b04f4970ce5738c64961c", "committedDate": "2020-12-03T21:13:53Z", "message": "Feat: Begin refactoring NotificationProcessor and its dependencies to use DistributionJobModel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efcdd9e7d3f332e4d0017e327f333f49e97973aa", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/efcdd9e7d3f332e4d0017e327f333f49e97973aa", "committedDate": "2020-12-04T13:58:32Z", "message": "Feat(TestAction): Continue refactoring dependencies of NotificationProcessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9e30c1641e513a04270039bdb6cf31ea533a317", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a9e30c1641e513a04270039bdb6cf31ea533a317", "committedDate": "2020-12-04T14:10:27Z", "message": "Feat(Channel): Update channels to use DistributionJobModel rather than FieldUtility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99cba6b0819c54cb1dc4ae2941e1d6ae70f94653", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/99cba6b0819c54cb1dc4ae2941e1d6ae70f94653", "committedDate": "2020-12-04T14:35:32Z", "message": "Fix(DescriptorProcessor): Add temporary distinction of distribution channel test actions from other TestActions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8be2d56dc607c83d4df8b96d2cee109d2310de35", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/8be2d56dc607c83d4df8b96d2cee109d2310de35", "committedDate": "2020-12-04T17:00:09Z", "message": "Fix(Test): Fix test compile errors and bugs discovered by unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/7cfac286e5ab424db9ad5047e04af2879607566c", "committedDate": "2020-12-04T17:00:30Z", "message": "Merge branch 'master' into gk_update_notification_processor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MTM5MDU5", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-545139059", "createdAt": "2020-12-04T17:04:44Z", "commit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNzowNDo0NFrOH_Z1fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNzowNDo0NFrOH_Z1fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI0NTYyOA==", "bodyText": "Moved to ChannelDistributionTestEventCreationUtils", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536245628", "createdAt": "2020-12-04T17:04:44Z", "author": {"login": "gkillough"}, "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/action/TestAction.java", "diffHunk": "@@ -39,25 +34,4 @@\n \n     public abstract MessageResult testConfig(String configId, FieldModel fieldModel, FieldUtility registeredFieldValues) throws IntegrationException;\n \n-    public ProviderMessageContent createTestNotificationContent(FieldUtility fieldUtility, ItemOperation operation, String messageId) throws AlertException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MTM5NDg3", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-545139487", "createdAt": "2020-12-04T17:05:22Z", "commit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNzowNToyMlrOH_Z2og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNzowNToyMlrOH_Z2og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI0NTkyMg==", "bodyText": "A Jira issue was created against 6.5.0 for this.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536245922", "createdAt": "2020-12-04T17:05:22Z", "author": {"login": "gkillough"}, "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/action/ConfigurationAction.java", "diffHunk": "@@ -24,14 +24,20 @@\n \n import java.util.EnumMap;\n import java.util.Map;\n+import java.util.Optional;\n \n+import com.synopsys.integration.alert.common.channel.ChannelDistributionTestAction;\n import com.synopsys.integration.alert.common.enumeration.ConfigContextEnum;\n import com.synopsys.integration.alert.descriptor.api.model.DescriptorKey;\n \n public abstract class ConfigurationAction {\n     private final DescriptorKey descriptorKey;\n-    private final Map<ConfigContextEnum, ApiAction> apiActionMap = new EnumMap(ConfigContextEnum.class);\n-    private final Map<ConfigContextEnum, TestAction> testActionMap = new EnumMap(ConfigContextEnum.class);\n+    private final Map<ConfigContextEnum, ApiAction> apiActionMap = new EnumMap<>(ConfigContextEnum.class);\n+    private final Map<ConfigContextEnum, TestAction> testActionMap = new EnumMap<>(ConfigContextEnum.class);\n+\n+    // FIXME there needs to be a better distinction between a global TestAction and a distribution TestAction\n+    //  for 6.4.0, this will have to suffice to avoid additional scope-creep of re-architecting TestActions\n+    private ChannelDistributionTestAction channelDistributionTestAction;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MTQ3MTM1", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-545147135", "createdAt": "2020-12-04T17:16:09Z", "commit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNzoxNjowOVrOH_aL0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNzoxNjowOVrOH_aL0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1MTM0NA==", "bodyText": "I would love to know if this is required, or if we can remove it.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536251344", "createdAt": "2020-12-04T17:16:09Z", "author": {"login": "gkillough"}, "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/event/DistributionEvent.java", "diffHunk": "@@ -24,30 +24,43 @@\n \n import java.util.Map;\n import java.util.Objects;\n+import java.util.Optional;\n import java.util.Set;\n import java.util.stream.Collectors;\n \n+import org.jetbrains.annotations.Nullable;\n+\n import com.synopsys.integration.alert.common.message.model.MessageContentGroup;\n-import com.synopsys.integration.alert.common.persistence.accessor.FieldUtility;\n+import com.synopsys.integration.alert.common.persistence.model.ConfigurationModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.DistributionJobModel;\n \n public class DistributionEvent extends ContentEvent {\n-    private static final long serialVersionUID = -2067819359358348281L;\n-    private final FieldUtility fieldUtility;\n-    private final String configId;\n+    private static final long serialVersionUID = -7858733753649257748L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MjExMTY0", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-545211164", "createdAt": "2020-12-04T18:46:33Z", "commit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxODo0NjozNFrOH_ddhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxODo0NjozNFrOH_ddhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNTAyOA==", "bodyText": "Why do we have the 2 exceptions here, rather than just the AlertRuntimeException?", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536305028", "createdAt": "2020-12-04T18:46:34Z", "author": {"login": "jamesrichard91"}, "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/server/JiraServerChannel.java", "diffHunk": "@@ -55,8 +57,9 @@ public JiraServerChannel(Gson gson, JiraServerChannelKey descriptorKey, AuditAcc\n \n     @Override\n     protected IssueTrackerContext getIssueTrackerContext(DistributionEvent event) {\n-        FieldUtility fieldUtility = event.getFieldUtility();\n-        return jiraServerContextBuilder.build(fieldUtility);\n+        ConfigurationModel globalConfig = event.getChannelGlobalConfig()\n+                                              .orElseThrow(() -> new AlertRuntimeException(new AlertConfigurationException(\"Missing Jira Server global configuration\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MjA1NDY3", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-545205467", "createdAt": "2020-12-04T18:37:51Z", "commit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxODozNzo1MVrOH_dKbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxODo0MDozOFrOH_dQQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwMDE0Mg==", "bodyText": "Do we prefer a constructor for this over a static method?", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536300142", "createdAt": "2020-12-04T18:37:51Z", "author": {"login": "JakeMathews"}, "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/common/JiraTestIssueRequestCreator.java", "diffHunk": "@@ -51,20 +52,29 @@\n \n public class JiraTestIssueRequestCreator implements TestIssueRequestCreator {\n     private final Logger logger = LoggerFactory.getLogger(JiraTestIssueRequestCreator.class);\n-    private final FieldUtility fieldUtility;\n+\n+    private final String customTopic;\n+    private final String customMessage;\n     private final JiraMessageParser jiraMessageParser;\n \n     public JiraTestIssueRequestCreator(FieldUtility fieldUtility, JiraMessageParser jiraMessageParser) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwMTYzNQ==", "bodyText": "Is including the properties from FieldUtlity for temporary compatibility, or are there fields the context needs that aren't in the JiraCloudJobDetailsModel?", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536301635", "createdAt": "2020-12-04T18:40:38Z", "author": {"login": "JakeMathews"}, "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/cloud/JiraCloudContextBuilder.java", "diffHunk": "@@ -78,4 +83,23 @@ public JiraCloudContext build(FieldUtility fieldUtility) {\n         return new JiraCloudContext(jiraCloudPropertiesFactory.createJiraProperties(fieldUtility), createIssueConfig(fieldUtility));\n     }\n \n+    @Override\n+    public JiraCloudContext build(ConfigurationModel globalConfig, DistributionJobModel jobModel) {\n+        FieldUtility globalFieldUtility = new FieldUtility(globalConfig.getCopyOfKeyToFieldMap());\n+        JiraCloudProperties jiraProperties = jiraCloudPropertiesFactory.createJiraProperties(globalFieldUtility);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MjIwODU2", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-545220856", "createdAt": "2020-12-04T19:01:11Z", "commit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxOTowMToxMVrOH_d-gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxOTowMToxMVrOH_d-gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMxMzQ3NA==", "bodyText": "It looks like you are missing the Mockito.when for the oldJobAccessor.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r536313474", "createdAt": "2020-12-04T19:01:11Z", "author": {"login": "JakeMathews"}, "path": "src/test/java/com/synopsys/integration/alert/component/audit/web/AuditEntryActionsTest.java", "diffHunk": "@@ -152,20 +157,26 @@ public void testPagedRequest() throws AlertDatabaseConstraintException {\n \n         NotificationContentRepository notificationRepository = Mockito.mock(NotificationContentRepository.class);\n         AuditNotificationRepository auditNotificationRepository = Mockito.mock(AuditNotificationRepository.class);\n-        JobAccessor jobAccessor = Mockito.mock(JobAccessor.class);\n+        JobAccessor oldJobAccessor = Mockito.mock(JobAccessor.class);\n+        JobAccessorV2 jobAccessor = Mockito.mock(JobAccessorV2.class);\n+        Mockito.when(jobAccessor.getJobById(Mockito.any())).thenReturn(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cfac286e5ab424db9ad5047e04af2879607566c"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2c3d6c0e455f78ba673b3427fb436cdc0558a9f", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a2c3d6c0e455f78ba673b3427fb436cdc0558a9f", "committedDate": "2020-12-04T20:57:48Z", "message": "Fix(EmailAddressHandler): Re-add EmailAddressHandler to email distribution test action and continue fixing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79828621c2a192fca4614f531ae166d9c15f7555", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/79828621c2a192fca4614f531ae166d9c15f7555", "committedDate": "2020-12-07T14:44:01Z", "message": "Fix(Test): Pass the correct field models for distribution validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "415e8246df11dabea5c189a7fee32d1fde37f64b", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/415e8246df11dabea5c189a7fee32d1fde37f64b", "committedDate": "2020-12-07T15:15:48Z", "message": "Fix(Test): Add missing email image directory property"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MzY1NDgz", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546365483", "createdAt": "2020-12-07T17:20:20Z", "commit": {"oid": "415e8246df11dabea5c189a7fee32d1fde37f64b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af5c5ed808f73ab1b3ce2a11e5c96fa8ab3da5ba", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/af5c5ed808f73ab1b3ce2a11e5c96fa8ab3da5ba", "committedDate": "2020-12-07T19:06:13Z", "message": "Fix(Test): Update test properties and resource loading to get project owner email test working"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70b2f15f023aa1cec2dcadc4dab39b7d8fa945c4", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/70b2f15f023aa1cec2dcadc4dab39b7d8fa945c4", "committedDate": "2020-12-07T19:17:34Z", "message": "Fix(Email): Update test action to just use \"additional email addresses\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NDU4OTI2", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546458926", "createdAt": "2020-12-07T19:19:04Z", "commit": {"oid": "af5c5ed808f73ab1b3ce2a11e5c96fa8ab3da5ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxOToxOTowNFrOIA2hmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxOToxOTowNFrOIA2hmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc2NDI1MA==", "bodyText": "This does not seem correct, why are we only using the additional email addresses? Part of the email distribution test is to verify the email recipients. So we should be using the configuration as specified in the test.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537764250", "createdAt": "2020-12-07T19:19:04Z", "author": {"login": "jamesrichard91"}, "path": "channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailDistributionTestAction.java", "diffHunk": "@@ -62,10 +62,12 @@ public MessageResult testConfig(\n     private DistributionJobModel creatUpdatedJobModelWithEmailAddresses(DistributionJobModel originalJobModel, @Nullable String destination) throws IntegrationException {\n         Set<String> updateEmailAddresses = emailActionHelper.createUpdatedEmailAddresses(originalJobModel, destination);\n         EmailJobDetailsModel originalEmailJobDetails = originalJobModel.getDistributionJobDetails().getAsEmailJobDetails();\n+\n+        // For testing configuration, just use additional email addresses field", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af5c5ed808f73ab1b3ce2a11e5c96fa8ab3da5ba"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "384de74d887e5ada76f7caefe1de9b3092cb61b0", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/384de74d887e5ada76f7caefe1de9b3092cb61b0", "committedDate": "2020-12-07T19:24:52Z", "message": "Fix(Test): Autowire DescriptorMap for event converter test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/57dd1b17667a4b95b0f8fa56e16678428ef8da42", "committedDate": "2020-12-07T20:53:44Z", "message": "Fix(Job): Add null check for provider projects before streaming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTM2ODQ3", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546536847", "createdAt": "2020-12-07T21:07:22Z", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMTowNzoyM1rOIA6vIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMTowODo1N1rOIA6yfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzMzI1MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (null != providerProjects && !providerProjects.isEmpty()) {\n          \n          \n            \n                        if (CollectionUtils.isNotEmpty(providerProjects)) {", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537833250", "createdAt": "2020-12-07T21:07:23Z", "author": {"login": "JakeMathews"}, "path": "channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java", "diffHunk": "@@ -24,72 +24,68 @@\n \n import java.util.HashSet;\n import java.util.List;\n-import java.util.Map;\n-import java.util.Optional;\n import java.util.Set;\n import java.util.stream.Collectors;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.jetbrains.annotations.Nullable;\n import org.springframework.stereotype.Component;\n \n import com.synopsys.integration.alert.channel.email.EmailAddressHandler;\n-import com.synopsys.integration.alert.channel.email.descriptor.EmailDescriptor;\n-import com.synopsys.integration.alert.common.descriptor.ProviderDescriptor;\n import com.synopsys.integration.alert.common.descriptor.config.ui.ProviderDistributionUIConfig;\n import com.synopsys.integration.alert.common.exception.AlertFieldException;\n-import com.synopsys.integration.alert.common.persistence.accessor.FieldUtility;\n import com.synopsys.integration.alert.common.persistence.accessor.ProviderDataAccessor;\n-import com.synopsys.integration.alert.common.persistence.model.ConfigurationFieldModel;\n import com.synopsys.integration.alert.common.persistence.model.ProviderProject;\n+import com.synopsys.integration.alert.common.persistence.model.job.BlackDuckProjectDetailsModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.DistributionJobModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.details.DistributionJobDetailsModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.details.EmailJobDetailsModel;\n import com.synopsys.integration.exception.IntegrationException;\n \n @Component\n-public class EmailActionHelper {\n+public class EmailTestActionHelper {\n     private final EmailAddressHandler emailAddressHandler;\n     private final ProviderDataAccessor providerDataAccessor;\n \n-    public EmailActionHelper(EmailAddressHandler emailAddressHandler, ProviderDataAccessor providerDataAccessor) {\n+    public EmailTestActionHelper(EmailAddressHandler emailAddressHandler, ProviderDataAccessor providerDataAccessor) {\n         this.emailAddressHandler = emailAddressHandler;\n         this.providerDataAccessor = providerDataAccessor;\n     }\n \n-    public FieldUtility createUpdatedFieldAccessor(FieldUtility fieldUtility, String destination) throws IntegrationException {\n+    public Set<String> createUpdatedEmailAddresses(DistributionJobModel distributionJobModel, @Nullable String destination) throws IntegrationException {\n         Set<String> emailAddresses = new HashSet<>();\n         if (StringUtils.isNotBlank(destination)) {\n             emailAddresses.add(destination);\n         }\n \n-        boolean filterByProject = fieldUtility.getBooleanOrFalse(ProviderDistributionUIConfig.KEY_FILTER_BY_PROJECT);\n-        Long providerConfigId = fieldUtility.getLong(ProviderDescriptor.KEY_PROVIDER_CONFIG_ID).orElse(null);\n-        boolean onlyAdditionalEmails = fieldUtility.getBooleanOrFalse(EmailDescriptor.KEY_EMAIL_ADDITIONAL_ADDRESSES_ONLY);\n+        DistributionJobDetailsModel distributionJobDetails = distributionJobModel.getDistributionJobDetails();\n+        EmailJobDetailsModel emailJobDetails = distributionJobDetails.getAsEmailJobDetails();\n+\n+        Long providerConfigId = distributionJobModel.getBlackDuckGlobalConfigId();\n+        boolean onlyAdditionalEmails = emailJobDetails.isAdditionalEmailAddressesOnly();\n \n         if (null != providerConfigId && !onlyAdditionalEmails) {\n-            Set<ProviderProject> providerProjects = retrieveProviderProjects(fieldUtility, filterByProject, providerConfigId);\n-            if (null != providerProjects) {\n-                Set<String> providerEmailAddresses = addEmailAddresses(providerConfigId, providerProjects, fieldUtility);\n+            Set<ProviderProject> providerProjects = retrieveProviderProjects(distributionJobModel, providerConfigId);\n+            if (null != providerProjects && !providerProjects.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNDExMA==", "bodyText": "Why would the optional be null?", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537834110", "createdAt": "2020-12-07T21:08:57Z", "author": {"login": "JakeMathews"}, "path": "src/test/java/com/synopsys/integration/alert/channel/ChannelDescriptorTestIT.java", "diffHunk": "@@ -53,43 +63,54 @@\n     protected DistributionEvent channelEvent;\n \n     protected ContentConverter contentConverter;\n-    protected TestProperties properties;\n+    protected TestProperties testProperties;\n \n+    @Autowired\n+    protected ProviderKey providerKey;\n+    @Autowired\n+    protected JobAccessorV2 jobAccessor;\n     @Autowired\n     protected DefaultConfigurationAccessor configurationAccessor;\n     @Autowired\n     protected DefaultDescriptorAccessor descriptorAccessor;\n     @Autowired\n+    protected DescriptorProcessor descriptorProcessor;\n+    @Autowired\n     protected RegisteredDescriptorRepository registeredDescriptorRepository;\n \n-    protected ConfigurationModel provider_global;\n-    protected Optional<ConfigurationModel> global_config;\n-    protected ConfigurationModel distribution_config;\n-    protected String destinationName;\n+    protected ConfigurationModel providerGlobalConfig;\n+    protected Optional<ConfigurationModel> optionalChannelGlobalConfig;\n+    protected DistributionJobModel distributionJobModel;\n+    protected String eventDestinationName;\n \n     @BeforeEach\n     public void init() throws Exception {\n         gson = new Gson();\n         contentConverter = new ContentConverter(gson, new DefaultConversionService());\n-        properties = new TestProperties();\n-        global_config = saveGlobalConfiguration();\n-        distribution_config = saveDistributionConfiguration();\n+        testProperties = new TestProperties();\n+        providerGlobalConfig = saveProviderGlobalConfig();\n+        optionalChannelGlobalConfig = saveGlobalConfiguration();\n+        eventDestinationName = getEventDestinationName();\n         channelEvent = createChannelEvent();\n-        destinationName = getDestinationName();\n+        distributionJobModel = saveDistributionJob();\n     }\n \n     @AfterEach\n     public void cleanupTest() {\n-        if (null != global_config && global_config.isPresent()) {\n-            configurationAccessor.deleteConfiguration(global_config.get());\n+        if (null != optionalChannelGlobalConfig && optionalChannelGlobalConfig.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTY3ODQz", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546567843", "createdAt": "2020-12-07T21:53:16Z", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMTo1MzoxNlrOIA8ZJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMTo1MzoxNlrOIA8ZJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2MDM4OA==", "bodyText": "Isn't this an example of a way to not use an optional? Instead of being passed a null list, we should be passing an empty list which we then check for content and modify/use as needed.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537860388", "createdAt": "2020-12-07T21:53:16Z", "author": {"login": "bamandel"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/job/JobConfigurationModelFieldExtractorUtils.java", "diffHunk": "@@ -66,10 +81,12 @@ public static DistributionJobModel convertToDistributionJobModel(UUID jobId, Map\n                                                   .policyFilterPolicyNames(extractFieldValues(\"blackduck.policy.notification.filter\", configuredFieldsMap))\n                                                   .vulnerabilityFilterSeverityNames(extractFieldValues(\"blackduck.vulnerability.notification.filter\", configuredFieldsMap));\n \n-        List<BlackDuckProjectDetailsModel> blackDuckProjectDetails = extractFieldValues(\"channel.common.configured.project\", configuredFieldsMap)\n-                                                                         .stream()\n-                                                                         .map(projectName -> new BlackDuckProjectDetailsModel(projectName, projectName))\n-                                                                         .collect(Collectors.toList());\n+        List<BlackDuckProjectDetailsModel> blackDuckProjectDetails = Optional.ofNullable(projectFilterDetails)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTc2MTc2", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546576176", "createdAt": "2020-12-07T22:04:47Z", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjowNDo0N1rOIA81OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjowNDo0N1rOIA81OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2NzU3Ng==", "bodyText": "Instead of nesting exceptions, we should make a runtime configuration exception.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537867576", "createdAt": "2020-12-07T22:04:47Z", "author": {"login": "bamandel"}, "path": "channel/src/main/java/com/synopsys/integration/alert/channel/jira/cloud/JiraCloudChannel.java", "diffHunk": "@@ -55,8 +57,9 @@ public JiraCloudChannel(JiraCloudChannelKey jiraChannelKey, Gson gson, AuditAcce\n \n     @Override\n     protected IssueTrackerContext getIssueTrackerContext(DistributionEvent event) {\n-        FieldUtility fieldUtility = event.getFieldUtility();\n-        return jiraCloudContextBuilder.build(fieldUtility);\n+        ConfigurationModel globalConfig = event.getChannelGlobalConfig()\n+                                              .orElseThrow(() -> new AlertRuntimeException(new AlertConfigurationException(\"Missing Jira Cloud global configuration\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTgzMjUy", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546583252", "createdAt": "2020-12-07T22:15:01Z", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjoxNTowMVrOIA9NSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjoxNTowMVrOIA9NSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MzczNg==", "bodyText": "We shouldn't be creating this inline optional object to act as our if statement. I believe an if statement here would be much clearer", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537873736", "createdAt": "2020-12-07T22:15:01Z", "author": {"login": "bamandel"}, "path": "channel/src/main/java/com/synopsys/integration/alert/channel/msteams/MsTeamsChannel.java", "diffHunk": "@@ -59,8 +63,11 @@ public MsTeamsChannel(MsTeamsKey msTeamsKey, Gson gson, AuditAccessor auditAcces\n \n     @Override\n     public void distributeMessage(DistributionEvent event) throws IntegrationException {\n-        FieldUtility fields = event.getFieldUtility();\n-        String webhook = fields.getString(MsTeamsDescriptor.KEY_WEBHOOK)\n+        DistributionJobModel distributionJobModel = event.getDistributionJobModel();\n+        DistributionJobDetailsModel distributionJobDetails = distributionJobModel.getDistributionJobDetails();\n+        MSTeamsJobDetailsModel asMSTeamsJobDetails = distributionJobDetails.getAsMSTeamsJobDetails();\n+        String webhook = Optional.ofNullable(asMSTeamsJobDetails.getWebhook())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTg0Mzgx", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546584381", "createdAt": "2020-12-07T22:16:40Z", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjoxNjo0MFrOIA9Q4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjoxNjo0MFrOIA9Q4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3NDY1Ng==", "bodyText": "This optional should be a ternary operator or an if statement.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537874656", "createdAt": "2020-12-07T22:16:40Z", "author": {"login": "bamandel"}, "path": "channel/src/main/java/com/synopsys/integration/alert/channel/slack/parser/SlackChannelEventParser.java", "diffHunk": "@@ -76,7 +81,9 @@ public SlackChannelEventParser(SlackChannelMessageParser slackChannelMessagePars\n             throw new AlertFieldException(fieldErrors);\n         }\n \n-        String channelUsername = fields.getString(SlackDescriptor.KEY_CHANNEL_USERNAME).orElse(SLACK_DEFAULT_USERNAME);\n+        String channelUsername = Optional.ofNullable(slackJobDetails.getChannelUsername())\n+                                     .filter(StringUtils::isNotBlank)\n+                                     .orElse(SLACK_DEFAULT_USERNAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTg3MzYy", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546587362", "createdAt": "2020-12-07T22:21:24Z", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjoyMToyNFrOIA9akA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjoyMToyNFrOIA9akA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3NzEzNg==", "bodyText": "This should be an if statement", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537877136", "createdAt": "2020-12-07T22:21:24Z", "author": {"login": "bamandel"}, "path": "web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java", "diffHunk": "@@ -324,33 +325,56 @@ protected ValidationActionResponse validateWithoutChecks(JobFieldModel resource)\n     @Override\n     protected ValidationActionResponse testWithoutChecks(JobFieldModel resource) {\n         ValidationResponseModel responseModel;\n-        String id = resource.getJobId();\n+        String jobIdString = resource.getJobId();\n+        UUID jobId = Optional.ofNullable(jobIdString)\n+                         .filter(StringUtils::isNotBlank)\n+                         .map(UUID::fromString)\n+                         .orElse(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTkwOTk5", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546590999", "createdAt": "2020-12-07T22:26:58Z", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjoyNjo1OFrOIA9n6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjoyNjo1OFrOIA9n6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg4MDU1NQ==", "bodyText": "Resource should return an empty list instead of null so we can process without checking for anything.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537880555", "createdAt": "2020-12-07T22:26:58Z", "author": {"login": "bamandel"}, "path": "web/src/main/java/com/synopsys/integration/alert/web/api/job/JobConfigActions.java", "diffHunk": "@@ -324,33 +325,56 @@ protected ValidationActionResponse validateWithoutChecks(JobFieldModel resource)\n     @Override\n     protected ValidationActionResponse testWithoutChecks(JobFieldModel resource) {\n         ValidationResponseModel responseModel;\n-        String id = resource.getJobId();\n+        String jobIdString = resource.getJobId();\n+        UUID jobId = Optional.ofNullable(jobIdString)\n+                         .filter(StringUtils::isNotBlank)\n+                         .map(UUID::fromString)\n+                         .orElse(null);\n+\n         try {\n \n             Collection<FieldModel> otherJobModels = new LinkedList<>();\n             FieldModel channelFieldModel = getChannelFieldModelAndPopulateOtherJobModels(resource, otherJobModels);\n \n             if (null != channelFieldModel) {\n-                Optional<TestAction> testActionOptional = descriptorProcessor.retrieveTestAction(channelFieldModel);\n-                if (testActionOptional.isPresent()) {\n+                Optional<ChannelDistributionTestAction> optionalChannelDistributionTestAction = descriptorProcessor.retrieveChannelDistributionTestAction(channelFieldModel.getDescriptorName());\n+                if (optionalChannelDistributionTestAction.isPresent()) {\n+                    ChannelDistributionTestAction channelDistributionTestAction = optionalChannelDistributionTestAction.get();\n                     Map<String, ConfigurationFieldModel> fields = createFieldsMap(channelFieldModel, otherJobModels);\n                     // The custom message fields are not written to the database or defined fields in the database.  Need to manually add them.\n                     // TODO Create a mechanism to create the field accessor with a combination of fields in the database and fields that are not.\n                     Optional<ConfigurationFieldModel> topicField = convertFieldToConfigurationField(channelFieldModel, TestAction.KEY_CUSTOM_TOPIC);\n                     Optional<ConfigurationFieldModel> messageField = convertFieldToConfigurationField(channelFieldModel, TestAction.KEY_CUSTOM_MESSAGE);\n+                    Optional<ConfigurationFieldModel> destinationField = convertFieldToConfigurationField(channelFieldModel, TestAction.KEY_DESTINATION_NAME);\n                     topicField.ifPresent(model -> fields.put(TestAction.KEY_CUSTOM_TOPIC, model));\n                     messageField.ifPresent(model -> fields.put(TestAction.KEY_CUSTOM_MESSAGE, model));\n-                    TestAction testAction = testActionOptional.get();\n-                    FieldUtility fieldUtility = new FieldUtility(fields);\n-                    String jobId = channelFieldModel.getId();\n+                    destinationField.ifPresent(model -> fields.put(TestAction.KEY_DESTINATION_NAME, model));\n \n-                    MessageResult providerTestResult = testProviderConfig(fieldUtility, jobId, channelFieldModel);\n+                    MessageResult providerTestResult = testProviderConfig(new FieldUtility(fields), jobIdString, channelFieldModel);\n                     if (providerTestResult.hasErrors()) {\n                         responseModel = ValidationResponseModel.fromStatusCollection(providerTestResult.getStatusMessage(), providerTestResult.getFieldStatuses());\n                         return new ValidationActionResponse(HttpStatus.OK, responseModel);\n                     }\n \n-                    MessageResult testActionResult = testAction.testConfig(jobId, channelFieldModel, fieldUtility);\n+                    // Not all channels have a global config\n+                    ConfigurationModel nullableChannelGlobalConfig = configurationAccessor.getConfigurationsByDescriptorNameAndContext(channelFieldModel.getDescriptorName(), ConfigContextEnum.GLOBAL)\n+                                                                         .stream()\n+                                                                         .findFirst()\n+                                                                         .orElse(null);\n+\n+                    List<BlackDuckProjectDetailsModel> projectFilterDetails = Optional.ofNullable(resource.getConfiguredProviderProjects()).orElse(List.of())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTkyMTk1", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546592195", "createdAt": "2020-12-07T22:28:52Z", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NjA2NjU2", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546606656", "createdAt": "2020-12-07T22:53:59Z", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjo1Mzo1OVrOIA-gWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjo1Mzo1OVrOIA-gWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NTAwMg==", "bodyText": "Im not sure what this comment means, I found an issue with 6.3.0 where the test discovers a certificate error but it does not make it to the UI because this is changing the response to an OK status. Please refer to #1289 to see the changes I would like to make in this area.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537895002", "createdAt": "2020-12-07T22:53:59Z", "author": {"login": "jamesrichard91"}, "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/action/api/AbstractJobResourceActions.java", "diffHunk": "@@ -194,6 +194,8 @@ public final ValidationActionResponse test(JobFieldModel resource) {\n             return ValidationActionResponse.createOKResponseWithContent(validationResponse);\n         }\n         ValidationActionResponse response = testWithoutChecks(resource);\n+        // FIXME this should only return OK if validation COMPLETED successfully (even\n+        //  if there are field errors), not if there were other types of errors unrelated to validation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NjA3NTEw", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546607510", "createdAt": "2020-12-07T22:55:32Z", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjo1NTozMlrOIA-jeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjo1NTozMlrOIA-jeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NTgwMA==", "bodyText": "Is this going to be done in this PR? or is there a Jira ticket to track this?", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537895800", "createdAt": "2020-12-07T22:55:32Z", "author": {"login": "jamesrichard91"}, "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/persistence/model/job/DistributionJobModelBuilder.java", "diffHunk": "@@ -53,6 +53,7 @@\n     private DistributionJobDetailsModel distributionJobDetails;\n \n     public DistributionJobModel build() {\n+        // TODO validate required fields are present", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NjExMTE0", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-546611114", "createdAt": "2020-12-07T23:02:34Z", "commit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzowMjozNFrOIA-wvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMzowMjozNFrOIA-wvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5OTE5OA==", "bodyText": "I don't think the ProviderProject's are database entities anymore, this should be updated to reflect that.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#discussion_r537899198", "createdAt": "2020-12-07T23:02:34Z", "author": {"login": "jamesrichard91"}, "path": "channel/src/main/java/com/synopsys/integration/alert/channel/email/actions/EmailTestActionHelper.java", "diffHunk": "@@ -24,72 +24,68 @@\n \n import java.util.HashSet;\n import java.util.List;\n-import java.util.Map;\n-import java.util.Optional;\n import java.util.Set;\n import java.util.stream.Collectors;\n \n import org.apache.commons.lang3.StringUtils;\n+import org.jetbrains.annotations.Nullable;\n import org.springframework.stereotype.Component;\n \n import com.synopsys.integration.alert.channel.email.EmailAddressHandler;\n-import com.synopsys.integration.alert.channel.email.descriptor.EmailDescriptor;\n-import com.synopsys.integration.alert.common.descriptor.ProviderDescriptor;\n import com.synopsys.integration.alert.common.descriptor.config.ui.ProviderDistributionUIConfig;\n import com.synopsys.integration.alert.common.exception.AlertFieldException;\n-import com.synopsys.integration.alert.common.persistence.accessor.FieldUtility;\n import com.synopsys.integration.alert.common.persistence.accessor.ProviderDataAccessor;\n-import com.synopsys.integration.alert.common.persistence.model.ConfigurationFieldModel;\n import com.synopsys.integration.alert.common.persistence.model.ProviderProject;\n+import com.synopsys.integration.alert.common.persistence.model.job.BlackDuckProjectDetailsModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.DistributionJobModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.details.DistributionJobDetailsModel;\n+import com.synopsys.integration.alert.common.persistence.model.job.details.EmailJobDetailsModel;\n import com.synopsys.integration.exception.IntegrationException;\n \n @Component\n-public class EmailActionHelper {\n+public class EmailTestActionHelper {\n     private final EmailAddressHandler emailAddressHandler;\n     private final ProviderDataAccessor providerDataAccessor;\n \n-    public EmailActionHelper(EmailAddressHandler emailAddressHandler, ProviderDataAccessor providerDataAccessor) {\n+    public EmailTestActionHelper(EmailAddressHandler emailAddressHandler, ProviderDataAccessor providerDataAccessor) {\n         this.emailAddressHandler = emailAddressHandler;\n         this.providerDataAccessor = providerDataAccessor;\n     }\n \n-    public FieldUtility createUpdatedFieldAccessor(FieldUtility fieldUtility, String destination) throws IntegrationException {\n+    public Set<String> createUpdatedEmailAddresses(DistributionJobModel distributionJobModel, @Nullable String destination) throws IntegrationException {\n         Set<String> emailAddresses = new HashSet<>();\n         if (StringUtils.isNotBlank(destination)) {\n             emailAddresses.add(destination);\n         }\n \n-        boolean filterByProject = fieldUtility.getBooleanOrFalse(ProviderDistributionUIConfig.KEY_FILTER_BY_PROJECT);\n-        Long providerConfigId = fieldUtility.getLong(ProviderDescriptor.KEY_PROVIDER_CONFIG_ID).orElse(null);\n-        boolean onlyAdditionalEmails = fieldUtility.getBooleanOrFalse(EmailDescriptor.KEY_EMAIL_ADDITIONAL_ADDRESSES_ONLY);\n+        DistributionJobDetailsModel distributionJobDetails = distributionJobModel.getDistributionJobDetails();\n+        EmailJobDetailsModel emailJobDetails = distributionJobDetails.getAsEmailJobDetails();\n+\n+        Long providerConfigId = distributionJobModel.getBlackDuckGlobalConfigId();\n+        boolean onlyAdditionalEmails = emailJobDetails.isAdditionalEmailAddressesOnly();\n \n         if (null != providerConfigId && !onlyAdditionalEmails) {\n-            Set<ProviderProject> providerProjects = retrieveProviderProjects(fieldUtility, filterByProject, providerConfigId);\n-            if (null != providerProjects) {\n-                Set<String> providerEmailAddresses = addEmailAddresses(providerConfigId, providerProjects, fieldUtility);\n+            Set<ProviderProject> providerProjects = retrieveProviderProjects(distributionJobModel, providerConfigId);\n+            if (null != providerProjects && !providerProjects.isEmpty()) {\n+                Set<String> providerEmailAddresses = addEmailAddresses(providerConfigId, providerProjects, distributionJobModel, emailJobDetails);\n                 emailAddresses.addAll(providerEmailAddresses);\n             }\n         }\n-\n-        ConfigurationFieldModel configurationFieldModel = ConfigurationFieldModel.create(EmailDescriptor.KEY_EMAIL_ADDRESSES);\n-        configurationFieldModel.setFieldValues(emailAddresses);\n-\n-        Map<String, ConfigurationFieldModel> fields = fieldUtility.getFields();\n-        fields.put(EmailDescriptor.KEY_EMAIL_ADDRESSES, configurationFieldModel);\n-\n-        return new FieldUtility(fields);\n+        return emailAddresses;\n     }\n \n     private boolean doesProjectMatchConfiguration(String currentProjectName, String projectNamePattern, Set<String> configuredProjectNames) {\n         return currentProjectName.matches(projectNamePattern) || configuredProjectNames.contains(currentProjectName);\n     }\n \n-    private Set<ProviderProject> retrieveProviderProjects(FieldUtility fieldUtility, boolean filterByProject, Long providerConfigId) {\n+    private Set<ProviderProject> retrieveProviderProjects(DistributionJobModel distributionJobModel, Long providerConfigId) {\n         List<ProviderProject> providerProjects = providerDataAccessor.getProjectsByProviderConfigId(providerConfigId);\n-        if (filterByProject) {\n-            Optional<ConfigurationFieldModel> projectField = fieldUtility.getField(ProviderDistributionUIConfig.KEY_CONFIGURED_PROJECT);\n-            Set<String> configuredProjects = new HashSet<>(projectField.map(ConfigurationFieldModel::getFieldValues).orElse(Set.of()));\n-            String projectNamePattern = fieldUtility.getStringOrEmpty(ProviderDistributionUIConfig.KEY_PROJECT_NAME_PATTERN);\n+        if (distributionJobModel.isFilterByProject()) {\n+            Set<String> configuredProjects = distributionJobModel.getProjectFilterDetails()\n+                                                 .stream()\n+                                                 .map(BlackDuckProjectDetailsModel::getName)\n+                                                 .collect(Collectors.toSet());\n+            String projectNamePattern = distributionJobModel.getProjectNamePattern().orElse(\"\");\n             return providerProjects\n                        .stream()\n                        .filter(databaseEntity -> doesProjectMatchConfiguration(databaseEntity.getName(), projectNamePattern, configuredProjects))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dd1b17667a4b95b0f8fa56e16678428ef8da42"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b180418e25f4d95d095be8509e86a0c1afb79df", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/5b180418e25f4d95d095be8509e86a0c1afb79df", "committedDate": "2020-12-08T13:59:49Z", "message": "Fix: Clean up null-checks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MjY2NDMw", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-547266430", "createdAt": "2020-12-08T14:08:22Z", "commit": {"oid": "5b180418e25f4d95d095be8509e86a0c1afb79df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b35875ce36afe030474263481158dc2d30d7786", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/4b35875ce36afe030474263481158dc2d30d7786", "committedDate": "2020-12-08T15:41:41Z", "message": "Merge branch 'master' into gk_update_notification_processor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDYzNTMx", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1286#pullrequestreview-547463531", "createdAt": "2020-12-08T17:29:04Z", "commit": {"oid": "4b35875ce36afe030474263481158dc2d30d7786"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7c031e0efe7211261fb3ea2d80ca9bcf1be8e53", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/c7c031e0efe7211261fb3ea2d80ca9bcf1be8e53", "committedDate": "2020-12-08T18:40:35Z", "message": "Merge branch 'master' into gk_update_notification_processor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cb85ef04ee6407486187a64fbf0236436c39f1e", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/8cb85ef04ee6407486187a64fbf0236436c39f1e", "committedDate": "2020-12-08T18:41:03Z", "message": "Merge branch 'master' into gk_update_notification_processor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e51184652c66632aef69e1f144f43adce1c615f5", "author": {"user": {"login": "gkillough", "name": "Gavin Killough"}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/e51184652c66632aef69e1f144f43adce1c615f5", "committedDate": "2020-12-08T20:03:18Z", "message": "Merge branch 'master' into gk_update_notification_processor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2938, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}