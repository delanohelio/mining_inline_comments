{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMjEzNzk5", "number": 924, "title": "purge fix", "bodyText": "The audit entry table had a row deleted from it.  The audit_notification_relation table has an entry for the notification id with the missing audit entry.  This causes an issue when purging.  It doesn't appear to be an issue in 5.3.0 at all. The changes here are to resolve a particular customer issue where they are in the state where an audit entry is missing from the database.  The purge data tries to run and cannot complete due to a database constraint failure.\nThe solution is to log the error message and try to delete the audit relation by notification id.", "createdAt": "2020-03-19T20:11:54Z", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924", "merged": true, "mergeCommit": {"oid": "28ed0c0bc715af8b516d02cbad8926c1bce68d00"}, "closed": true, "closedAt": "2020-03-20T18:44:22Z", "author": {"login": "psantos1113"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPRCbVgH2gAyMzkxMjEzNzk5OmI3OGI4MGQ4MGZkNmM5NzUwYTQ5MGU5NmJjZjJhOTc1NmRhNzc2OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPk34dAFqTM3ODcyMzE1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b78b80d80fd6c9750a490e96bcf2a9756da77693", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/b78b80d80fd6c9750a490e96bcf2a9756da77693", "committedDate": "2020-03-19T19:25:59Z", "message": "fix: Delete audit entries by notification id and log errors."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9", "committedDate": "2020-03-19T19:28:57Z", "message": "Merge remote-tracking branch 'origin/5.0.3' into ps_purge_fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MDU5NDMz", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#pullrequestreview-378059433", "createdAt": "2020-03-19T20:13:27Z", "commit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMDoxMzoyN1rOF4-xXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMDoxMzoyN1rOF4-xXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5MzAyMQ==", "bodyText": "Here's where the change really is.  try catch block for the old code that was failing.  Attempt to delete from the audit relation by notification id.  Otherwise if it fails log it and move on to deleting the notifications.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395293021", "createdAt": "2020-03-19T20:13:27Z", "author": {"login": "psantos1113"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "originalPosition": 159}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NDkyNDUy", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#pullrequestreview-378492452", "createdAt": "2020-03-20T13:42:54Z", "commit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTQwMTY1", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#pullrequestreview-378540165", "createdAt": "2020-03-20T14:39:07Z", "commit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozOTowN1rOF5Waiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozOTowN1rOF5Waiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4MDM5NQ==", "bodyText": "Why bother saving this as a variable? A method reference itself is stateless, so I don't think there is a benefit.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395680395", "createdAt": "2020-03-20T14:39:07Z", "author": {"login": "gkillough"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {\n+            foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n+            Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "originalPosition": 161}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTQwNjM5", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#pullrequestreview-378540639", "createdAt": "2020-03-20T14:39:41Z", "commit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozOTo0MVrOF5Wb8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDozOTo0MVrOF5Wb8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4MDc1Mw==", "bodyText": "Each method that returns a Stream should be on its own line.", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#discussion_r395680753", "createdAt": "2020-03-20T14:39:41Z", "author": {"login": "gkillough"}, "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultNotificationManager.java", "diffHunk": "@@ -175,25 +179,35 @@ public PageRequest getPageRequestForNotifications(final Integer pageNumber, fina\n         return PageRequest.of(page, size, new Sort(sortingOrder, sortingField));\n     }\n \n-    private void deleteAuditEntries(final Long notificationId) {\n-        final List<AuditNotificationRelation> foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n-        final Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n-        final List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());\n-        auditNotificationRepository.deleteAll(foundRelations);\n-        final List<AuditEntryEntity> auditEntryList = auditEntryRepository.findAllById(auditIdList);\n-        auditEntryRepository.deleteAll(auditEntryList);\n+    private void deleteAuditEntries(Long notificationId) {\n+        List<AuditNotificationRelation> foundRelations;\n+        try {\n+            foundRelations = auditNotificationRepository.findByNotificationId(notificationId);\n+            Function<AuditNotificationRelation, Long> transform = AuditNotificationRelation::getAuditEntryId;\n+            List<Long> auditIdList = foundRelations.stream().map(transform).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae5fc781bd36fa39e5111f1b6abc38084ebb4aa9"}, "originalPosition": 162}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "874f88401feb1d987cf091fd5647bbbea7bd7429", "author": {"user": {"login": "psantos1113", "name": null}}, "url": "https://github.com/blackducksoftware/blackduck-alert/commit/874f88401feb1d987cf091fd5647bbbea7bd7429", "committedDate": "2020-03-20T18:23:04Z", "message": "refactor: Clean up based on PR feedback."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NzIzMTUx", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/924#pullrequestreview-378723151", "createdAt": "2020-03-20T18:32:34Z", "commit": {"oid": "874f88401feb1d987cf091fd5647bbbea7bd7429"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2644, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}