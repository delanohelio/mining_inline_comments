{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MTYxMjkz", "number": 2567, "title": "Fix reachability checks in the presence of @GenerateUncached.", "bodyText": "Fixes a behavior of the Truffle specialization DSL, where uncached specializations would be marked unreachable, even if they are reachable in the node generated with @GenerateUncached.\nThe logic implemented here is: if @GenerateUncached is present, an uncached specialization cannot be shadowed by a cached one.", "createdAt": "2020-06-14T15:31:26Z", "url": "https://github.com/oracle/graal/pull/2567", "merged": true, "mergeCommit": {"oid": "9b67e8af12ae5a7de7e6b15b31d10de638e3cda6"}, "closed": true, "closedAt": "2020-06-24T16:05:29Z", "author": {"login": "kustosz"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqXMBdgH2gAyNDM0MTYxMjkzOjE3YTdiOTExZmIzMzBkNDk2OGIyMTliMzkzNmUwNjQwZjQyOWVmNGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsGnARgFqTQzMjIzMjEwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "17a7b911fb330d4968b219b3936e0640f429ef4e", "author": {"user": {"login": "kustosz", "name": "Marcin Kostrzewa"}}, "url": "https://github.com/oracle/graal/commit/17a7b911fb330d4968b219b3936e0640f429ef4e", "committedDate": "2020-06-11T23:51:51Z", "message": "take uncached specializations into account for reachability analysis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b", "author": {"user": {"login": "kustosz", "name": "Marcin Kostrzewa"}}, "url": "https://github.com/oracle/graal/commit/a2de7cf0854ce46fd91f9e87fd4be46fb212917b", "committedDate": "2020-06-14T15:21:04Z", "message": "code format fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzIzMTM1", "url": "https://github.com/oracle/graal/pull/2567#pullrequestreview-431723135", "createdAt": "2020-06-16T17:13:57Z", "commit": {"oid": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzoxMzo1N1rOGklR9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzoxNjoxOFrOGklXNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxMjcyNw==", "bodyText": "Maybe rename this field reachableUncached to makle it clearer what it means.\nA specialization is not uncached by itself.\nAt the same time it would make sense to rename SpecializationData#reachable to reachableCached.", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441012727", "createdAt": "2020-06-16T17:13:57Z", "author": {"login": "chumer"}, "path": "truffle/src/com.oracle.truffle.dsl.processor/src/com/oracle/truffle/dsl/processor/model/SpecializationData.java", "diffHunk": "@@ -353,10 +355,18 @@ public void setReachable(boolean reachable) {\n         this.reachable = reachable;\n     }\n \n+    public void setUncached(boolean uncached) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxNDA2OQ==", "bodyText": "I think this could be merged into initializeReachability. It is fine if this one computes cached and uncached reachability.", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441014069", "createdAt": "2020-06-16T17:16:18Z", "author": {"login": "chumer"}, "path": "truffle/src/com.oracle.truffle.dsl.processor/src/com/oracle/truffle/dsl/processor/parser/NodeParser.java", "diffHunk": "@@ -1748,6 +1749,13 @@ private void collectIncludes(SpecializationData specialization, Set<Specializati\n         }\n     }\n \n+    private static void initializeUncached(final NodeData node) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzc3NTE3", "url": "https://github.com/oracle/graal/pull/2567#pullrequestreview-431777517", "createdAt": "2020-06-16T18:19:59Z", "commit": {"oid": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoxOTo1OVrOGkntiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoyMTowNlrOGknxiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1MjU1Mg==", "bodyText": "initializeUncached uses SpecializationData.getReplaces indirectly that gets initialized in resolveReplaces later.\nHow about we merge initializeUncached with resolveReplaces. And rename SpecializationData#uncached to Specialization#replaced. This probably needs to be a flattened set again in order to fix the failing test.", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441052552", "createdAt": "2020-06-16T18:19:59Z", "author": {"login": "chumer"}, "path": "truffle/src/com.oracle.truffle.dsl.processor/src/com/oracle/truffle/dsl/processor/parser/NodeParser.java", "diffHunk": "@@ -1576,6 +1576,7 @@ private void initializeSpecializations(List<? extends Element> elements, final N\n         initializeUninitialized(node);\n         initializeOrder(node);\n         initializePolymorphism(node); // requires specializations\n+        initializeUncached(node);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1MzU3OQ==", "bodyText": "Here is a failing test.\n\n @GenerateUncached\n    abstract static class ReachabilityUncached4 extends ReachabilityUncached {\n\n        @Specialization\n        int s0(@Cached(\"foo()\") int cached) {\n            return cached;\n        }\n\n        @Specialization(replaces = \"s0\")\n        int s1() {\n            return 1;\n        }\n\n        @Specialization(replaces = \"s1\")\n        int s2() {\n            return 1;\n        }\n    }\n\n\nI think that one should work too but doesn't.", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441053579", "createdAt": "2020-06-16T18:21:06Z", "author": {"login": "chumer"}, "path": "truffle/src/com.oracle.truffle.api.dsl.test/src/com/oracle/truffle/api/dsl/test/ReachabilityTest.java", "diffHunk": "@@ -301,4 +304,62 @@ int do1() throws RuntimeException {\n \n     }\n \n+    abstract static class ReachabilityUncached extends Node {\n+        abstract int execute();\n+\n+        int foo() {\n+            return 0;\n+        }\n+    }\n+\n+    @GenerateUncached\n+    abstract static class ReachabilityUncached1 extends ReachabilityUncached {\n+        @Specialization\n+        int doCached(@Cached(\"foo()\") int cached) {\n+            return cached;\n+        }\n+\n+        @Specialization(replaces = \"doCached\")\n+        int doUncached() {\n+            return 1;\n+        }\n+    }\n+\n+    @GenerateUncached\n+    abstract static class ReachabilityUncached2 extends ReachabilityUncached {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b95aef79e4108b8604cc22269125d24a6017bc7", "author": {"user": {"login": "kustosz", "name": "Marcin Kostrzewa"}}, "url": "https://github.com/oracle/graal/commit/6b95aef79e4108b8604cc22269125d24a6017bc7", "committedDate": "2020-06-16T18:57:50Z", "message": "rename uncached to replaced, unify logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMjMyMTA2", "url": "https://github.com/oracle/graal/pull/2567#pullrequestreview-432232106", "createdAt": "2020-06-17T09:40:47Z", "commit": {"oid": "6b95aef79e4108b8604cc22269125d24a6017bc7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1026, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}