{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MTM5MjQ5", "number": 2442, "title": "Support dynamic class loading", "bodyText": "Overview\nThis patch supports java.lang.ClassLoader.defineClass(String name, byte[] b, int off, int len) based dynamic class loading in native image. It is separated from the previous PR (#2323).\nThe basic idea for supporting dynamic class loading is dumping classes generated at run time in a beforehand run with native-image-agent to a specified directory which is added to the classpath for building native image.\nThis is implemented in 3 steps:\n\nIntercept java.lang.ClassLoader.postDefineClass by native-image-agent to dump the dynamically generated class to file system.\nUser should make sure the generated classes' names are fixed through Hotspot version runtime and native-image version runtime.\nSubstitute relevant classes in SubstrateVM to load the previously dumped classes at native image runtime.\n\nFeatures:\n\nAdd new agent option -agentlib:native-image-agent=dynamic-class-dump-dir= to specify where to dump the dynamically generated classes, the default value is \"dynClass\" if not specified.\nBoth dynamically generated class and its stack trace are dumped.\nDynamically generated class's name could be decided at runtime (e.g. runtime sequence number as post-fix) or null when java.lang.ClassLoader.defineClass is invoked. It is the user's job to make sure the dynamic generated class' name is constant through Agent runtime and native image runtime. The patch has supported the null name scenario.\nDifferent classloaders can dynamically define same name class at runtime. SubstrateVM doesn't support multiple classloaders yet. This patch will report error at Agent runtime if same name classes  are defined by multiple classloaders.\nAll unsupported dynamic class loading usages shall be reported at the end of Agent run.\n\nLimitations:\n\n\nThis patch does not support defineClass with specified ProtectionDomain.\n\n\nIt is possible the jar on classpath has a different signature file from dynamically generated class and fail the check in java.lang.ClassLoader.checkCerts(String name, CodeSource cs) at native-image build time. Current solution is to manually delete jar's signature file before building. This limitation can be shown by test: testWithSignedJar.zip\n\n\nIt is possible the dynamically generated class contents are changing from run to run. We make a class contents check at runtime based on the byte array's hash code to assure the runtime defined class is the same as the previously prepared one. But this check excludes SourceFile attribute because it often varies from runs but doesn't affect runtime behavior. This limitation can be shown by test: testChangedClass.zip\n\n\nTests:\nThis patch can be tested by\ntestDynamicLoading.zip", "createdAt": "2020-05-08T09:23:58Z", "url": "https://github.com/oracle/graal/pull/2442", "merged": true, "mergeCommit": {"oid": "a13778c14da682910b87ad1d64fe12b2aec4c56c"}, "closed": true, "closedAt": "2021-06-08T21:21:24Z", "author": {"login": "ziyilin"}, "timelineItems": {"totalCount": 59, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfihcPABqjMzMTkxNTE2OTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeM60sqABqjQ1OTEzODIxNjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ae810658282adf63b35abecdb31758719b47b65", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/2ae810658282adf63b35abecdb31758719b47b65", "committedDate": "2020-05-08T08:41:03Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "695acccc3f381bbbcf5285a7bc7cc4833f18df2c", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/695acccc3f381bbbcf5285a7bc7cc4833f18df2c", "committedDate": "2020-05-09T08:50:18Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "695acccc3f381bbbcf5285a7bc7cc4833f18df2c", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/695acccc3f381bbbcf5285a7bc7cc4833f18df2c", "committedDate": "2020-05-09T08:50:18Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "7ac0218db0f61a9585aded6aaead7d3772d6c7e4", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/7ac0218db0f61a9585aded6aaead7d3772d6c7e4", "committedDate": "2020-05-11T03:33:59Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ac0218db0f61a9585aded6aaead7d3772d6c7e4", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/7ac0218db0f61a9585aded6aaead7d3772d6c7e4", "committedDate": "2020-05-11T03:33:59Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "74108cb682088b02853f9e8b148fb294540c6475", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/74108cb682088b02853f9e8b148fb294540c6475", "committedDate": "2020-05-11T07:16:25Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74108cb682088b02853f9e8b148fb294540c6475", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/74108cb682088b02853f9e8b148fb294540c6475", "committedDate": "2020-05-11T07:16:25Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "ea993d5dc4c23c8ae0166ab6e3362c84e0fad488", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/ea993d5dc4c23c8ae0166ab6e3362c84e0fad488", "committedDate": "2020-05-11T07:22:41Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea993d5dc4c23c8ae0166ab6e3362c84e0fad488", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/ea993d5dc4c23c8ae0166ab6e3362c84e0fad488", "committedDate": "2020-05-11T07:22:41Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "4819ed448689f8558d5a0543e1d030738bc0ba41", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/4819ed448689f8558d5a0543e1d030738bc0ba41", "committedDate": "2020-05-11T07:59:22Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4819ed448689f8558d5a0543e1d030738bc0ba41", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/4819ed448689f8558d5a0543e1d030738bc0ba41", "committedDate": "2020-05-11T07:59:22Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "084ad5423654f30bc81aac9eeaa53b9117f63097", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/084ad5423654f30bc81aac9eeaa53b9117f63097", "committedDate": "2020-05-11T09:45:49Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "084ad5423654f30bc81aac9eeaa53b9117f63097", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/084ad5423654f30bc81aac9eeaa53b9117f63097", "committedDate": "2020-05-11T09:45:49Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "61af582ca35d9081f794373c126feb347513dc1b", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/61af582ca35d9081f794373c126feb347513dc1b", "committedDate": "2020-05-14T06:30:26Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61af582ca35d9081f794373c126feb347513dc1b", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/61af582ca35d9081f794373c126feb347513dc1b", "committedDate": "2020-05-14T06:30:26Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "397df00fcb9750df08c4a8d29c08bb39de15a3e4", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/397df00fcb9750df08c4a8d29c08bb39de15a3e4", "committedDate": "2020-05-15T06:07:05Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "397df00fcb9750df08c4a8d29c08bb39de15a3e4", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/397df00fcb9750df08c4a8d29c08bb39de15a3e4", "committedDate": "2020-05-15T06:07:05Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "1b2203d9ef0c985a446c3844c4befb3c12754b25", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/1b2203d9ef0c985a446c3844c4befb3c12754b25", "committedDate": "2020-05-18T12:29:04Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b2203d9ef0c985a446c3844c4befb3c12754b25", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/1b2203d9ef0c985a446c3844c4befb3c12754b25", "committedDate": "2020-05-18T12:29:04Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "b86745cbb2ced7d6ba8386d377ea6895feee1998", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/b86745cbb2ced7d6ba8386d377ea6895feee1998", "committedDate": "2020-06-12T02:37:03Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b86745cbb2ced7d6ba8386d377ea6895feee1998", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/b86745cbb2ced7d6ba8386d377ea6895feee1998", "committedDate": "2020-06-12T02:37:03Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "b0b9a0dba8cf8f3d93ae8879860ee744569b32b7", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/b0b9a0dba8cf8f3d93ae8879860ee744569b32b7", "committedDate": "2020-06-12T13:52:33Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0b9a0dba8cf8f3d93ae8879860ee744569b32b7", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/b0b9a0dba8cf8f3d93ae8879860ee744569b32b7", "committedDate": "2020-06-12T13:52:33Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "1add200d89be51c9bd6b26a982f7773e54168658", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/1add200d89be51c9bd6b26a982f7773e54168658", "committedDate": "2020-06-16T05:31:38Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1add200d89be51c9bd6b26a982f7773e54168658", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/1add200d89be51c9bd6b26a982f7773e54168658", "committedDate": "2020-06-16T05:31:38Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "e2eb02e4d3a69cc98de5b3c3aabb3a27644d1240", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/e2eb02e4d3a69cc98de5b3c3aabb3a27644d1240", "committedDate": "2020-06-17T06:42:02Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2eb02e4d3a69cc98de5b3c3aabb3a27644d1240", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/e2eb02e4d3a69cc98de5b3c3aabb3a27644d1240", "committedDate": "2020-06-17T06:42:02Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "5026216c99af1a01e8b7f5ece94dbd108e64b096", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/5026216c99af1a01e8b7f5ece94dbd108e64b096", "committedDate": "2020-06-17T06:59:39Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5026216c99af1a01e8b7f5ece94dbd108e64b096", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/5026216c99af1a01e8b7f5ece94dbd108e64b096", "committedDate": "2020-06-17T06:59:39Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "40eeed907bf9e5c85e47d2ad54072c89283a9fc7", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/40eeed907bf9e5c85e47d2ad54072c89283a9fc7", "committedDate": "2020-06-17T08:56:39Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40eeed907bf9e5c85e47d2ad54072c89283a9fc7", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/40eeed907bf9e5c85e47d2ad54072c89283a9fc7", "committedDate": "2020-06-17T08:56:39Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "c9b96ff5eadaabd98b1556a0a94e1b832681b5a9", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/c9b96ff5eadaabd98b1556a0a94e1b832681b5a9", "committedDate": "2020-06-17T11:37:06Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9b96ff5eadaabd98b1556a0a94e1b832681b5a9", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/c9b96ff5eadaabd98b1556a0a94e1b832681b5a9", "committedDate": "2020-06-17T11:37:06Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "b3acc3e2dd0af35ae64973d81bd48732044f9efb", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/b3acc3e2dd0af35ae64973d81bd48732044f9efb", "committedDate": "2020-06-19T11:24:45Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3acc3e2dd0af35ae64973d81bd48732044f9efb", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/b3acc3e2dd0af35ae64973d81bd48732044f9efb", "committedDate": "2020-06-19T11:24:45Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "621458baacc4bac0253f386e9c025069ca269b7c", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/621458baacc4bac0253f386e9c025069ca269b7c", "committedDate": "2020-06-19T13:18:39Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "621458baacc4bac0253f386e9c025069ca269b7c", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/621458baacc4bac0253f386e9c025069ca269b7c", "committedDate": "2020-06-19T13:18:39Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "8c088b733bfcba6a772512acbdce560ca5bd2f69", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/8c088b733bfcba6a772512acbdce560ca5bd2f69", "committedDate": "2020-06-19T13:22:46Z", "message": "Support dynamic class loading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c088b733bfcba6a772512acbdce560ca5bd2f69", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/8c088b733bfcba6a772512acbdce560ca5bd2f69", "committedDate": "2020-06-19T13:22:46Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/5371bc88f3f8a289f8b2cc23c2dad5608ee22297", "committedDate": "2020-06-22T06:47:16Z", "message": "Support dynamic class loading"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjk5OTI4", "url": "https://github.com/oracle/graal/pull/2442#pullrequestreview-533299928", "createdAt": "2020-11-18T10:24:19Z", "commit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDoyNDoxOVrOH1m5CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDoyNDoxOVrOH1m5CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk3Mzc2OA==", "bodyText": "How can this be non-null?", "url": "https://github.com/oracle/graal/pull/2442#discussion_r525973768", "createdAt": "2020-11-18T10:24:19Z", "author": {"login": "vjovanov"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/AbstractDynamicClassGenerationSupport.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright (c) 2019, 2019, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020 Alibaba Group Holding Limited. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.agent;\n+\n+import com.oracle.svm.core.util.JavaClassUtil;\n+import static com.oracle.svm.jvmtiagentbase.Support.jniFunctions;\n+import static com.oracle.svm.jvmtiagentbase.Support.getMethodFullNameAtFrame;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import com.oracle.svm.jni.nativeapi.JNIMethodId;\n+import org.graalvm.nativeimage.c.type.CCharPointer;\n+import org.graalvm.nativeimage.c.type.CTypeConversion;\n+import org.graalvm.nativeimage.c.type.VoidPointer;\n+import org.graalvm.word.WordFactory;\n+\n+import com.oracle.svm.jni.nativeapi.JNIEnvironment;\n+import com.oracle.svm.jni.nativeapi.JNIObjectHandle;\n+\n+public abstract class AbstractDynamicClassGenerationSupport {\n+\n+    protected JNIEnvironment jni;\n+    protected JNIObjectHandle callerClass;\n+    protected final String generatedClassName;\n+    protected TraceWriter traceWriter;\n+    protected NativeImageAgent agent;\n+    protected int generatedClassHashCode = 0;\n+    protected byte[] values = null;\n+\n+    private static Path dynclassDumpDir = null;\n+    private static final Path DEFAULT_DUMP = Paths.get(\"dynClass\");\n+    protected String callerMethod;\n+\n+    public static void initDynClassDumpDir(String dir) {\n+        dynclassDumpDir = Paths.get(dir);\n+    }\n+\n+    public static AbstractDynamicClassGenerationSupport getClassLoaderDefineClassSupport(JNIEnvironment jni, JNIObjectHandle callerClass,\n+                    String generatedClassName, TraceWriter traceWriter, NativeImageAgent agent) throws IOException {\n+        return new ClassLoaderDefineClassSupport(jni, callerClass, generatedClassName, traceWriter, agent);\n+    }\n+\n+    protected AbstractDynamicClassGenerationSupport(JNIEnvironment jni, JNIObjectHandle callerClass,\n+                    String generatedClassName, TraceWriter traceWriter, NativeImageAgent agent) throws IOException {\n+        if (dynclassDumpDir == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMzA5NDEw", "url": "https://github.com/oracle/graal/pull/2442#pullrequestreview-533309410", "createdAt": "2020-11-18T10:35:32Z", "commit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDozNTozMlrOH1nV8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDozNTozMlrOH1nV8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk4MTE2OQ==", "bodyText": "I would avoid printing in the agent as this could alter the behavior of the program. In other places the agent uses System.err.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r525981169", "createdAt": "2020-11-18T10:35:32Z", "author": {"login": "vjovanov"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/AbstractDynamicClassGenerationSupport.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright (c) 2019, 2019, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020 Alibaba Group Holding Limited. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.agent;\n+\n+import com.oracle.svm.core.util.JavaClassUtil;\n+import static com.oracle.svm.jvmtiagentbase.Support.jniFunctions;\n+import static com.oracle.svm.jvmtiagentbase.Support.getMethodFullNameAtFrame;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import com.oracle.svm.jni.nativeapi.JNIMethodId;\n+import org.graalvm.nativeimage.c.type.CCharPointer;\n+import org.graalvm.nativeimage.c.type.CTypeConversion;\n+import org.graalvm.nativeimage.c.type.VoidPointer;\n+import org.graalvm.word.WordFactory;\n+\n+import com.oracle.svm.jni.nativeapi.JNIEnvironment;\n+import com.oracle.svm.jni.nativeapi.JNIObjectHandle;\n+\n+public abstract class AbstractDynamicClassGenerationSupport {\n+\n+    protected JNIEnvironment jni;\n+    protected JNIObjectHandle callerClass;\n+    protected final String generatedClassName;\n+    protected TraceWriter traceWriter;\n+    protected NativeImageAgent agent;\n+    protected int generatedClassHashCode = 0;\n+    protected byte[] values = null;\n+\n+    private static Path dynclassDumpDir = null;\n+    private static final Path DEFAULT_DUMP = Paths.get(\"dynClass\");\n+    protected String callerMethod;\n+\n+    public static void initDynClassDumpDir(String dir) {\n+        dynclassDumpDir = Paths.get(dir);\n+    }\n+\n+    public static AbstractDynamicClassGenerationSupport getClassLoaderDefineClassSupport(JNIEnvironment jni, JNIObjectHandle callerClass,\n+                    String generatedClassName, TraceWriter traceWriter, NativeImageAgent agent) throws IOException {\n+        return new ClassLoaderDefineClassSupport(jni, callerClass, generatedClassName, traceWriter, agent);\n+    }\n+\n+    protected AbstractDynamicClassGenerationSupport(JNIEnvironment jni, JNIObjectHandle callerClass,\n+                    String generatedClassName, TraceWriter traceWriter, NativeImageAgent agent) throws IOException {\n+        if (dynclassDumpDir == null) {\n+            System.out.println(\"Warning: dynamic-class-dump-dir= was not set in -agentlib:native-image-agent=. Dynamically generated classes will be dumped to the default location:\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMzEwOTE5", "url": "https://github.com/oracle/graal/pull/2442#pullrequestreview-533310919", "createdAt": "2020-11-18T10:37:25Z", "commit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDozNzoyNlrOH1nakg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDozNzoyNlrOH1nakg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk4MjM1NA==", "bodyText": "I would mention here that the file in place is a file and that we want to create a dir there.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r525982354", "createdAt": "2020-11-18T10:37:26Z", "author": {"login": "vjovanov"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/AbstractDynamicClassGenerationSupport.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright (c) 2019, 2019, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020 Alibaba Group Holding Limited. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.agent;\n+\n+import com.oracle.svm.core.util.JavaClassUtil;\n+import static com.oracle.svm.jvmtiagentbase.Support.jniFunctions;\n+import static com.oracle.svm.jvmtiagentbase.Support.getMethodFullNameAtFrame;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import com.oracle.svm.jni.nativeapi.JNIMethodId;\n+import org.graalvm.nativeimage.c.type.CCharPointer;\n+import org.graalvm.nativeimage.c.type.CTypeConversion;\n+import org.graalvm.nativeimage.c.type.VoidPointer;\n+import org.graalvm.word.WordFactory;\n+\n+import com.oracle.svm.jni.nativeapi.JNIEnvironment;\n+import com.oracle.svm.jni.nativeapi.JNIObjectHandle;\n+\n+public abstract class AbstractDynamicClassGenerationSupport {\n+\n+    protected JNIEnvironment jni;\n+    protected JNIObjectHandle callerClass;\n+    protected final String generatedClassName;\n+    protected TraceWriter traceWriter;\n+    protected NativeImageAgent agent;\n+    protected int generatedClassHashCode = 0;\n+    protected byte[] values = null;\n+\n+    private static Path dynclassDumpDir = null;\n+    private static final Path DEFAULT_DUMP = Paths.get(\"dynClass\");\n+    protected String callerMethod;\n+\n+    public static void initDynClassDumpDir(String dir) {\n+        dynclassDumpDir = Paths.get(dir);\n+    }\n+\n+    public static AbstractDynamicClassGenerationSupport getClassLoaderDefineClassSupport(JNIEnvironment jni, JNIObjectHandle callerClass,\n+                    String generatedClassName, TraceWriter traceWriter, NativeImageAgent agent) throws IOException {\n+        return new ClassLoaderDefineClassSupport(jni, callerClass, generatedClassName, traceWriter, agent);\n+    }\n+\n+    protected AbstractDynamicClassGenerationSupport(JNIEnvironment jni, JNIObjectHandle callerClass,\n+                    String generatedClassName, TraceWriter traceWriter, NativeImageAgent agent) throws IOException {\n+        if (dynclassDumpDir == null) {\n+            System.out.println(\"Warning: dynamic-class-dump-dir= was not set in -agentlib:native-image-agent=. Dynamically generated classes will be dumped to the default location:\" +\n+                            DEFAULT_DUMP.toAbsolutePath().toString());\n+            dynclassDumpDir = DEFAULT_DUMP;\n+        }\n+\n+        if (!Files.exists(dynclassDumpDir)) {\n+            Files.createDirectories(dynclassDumpDir);\n+        } else if (!Files.isDirectory(dynclassDumpDir)) {\n+            throw new IOException(\"File \" + dynclassDumpDir + \" already exists! Cannot create the same directory for class file dumping.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "originalPosition": 83}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMzk4NzU5", "url": "https://github.com/oracle/graal/pull/2442#pullrequestreview-533398759", "createdAt": "2020-11-18T12:32:59Z", "commit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMjozMjo1OVrOH1rm_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMjozMjo1OVrOH1rm_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA1MTA3MA==", "bodyText": "In the new version of the code we need to pass an extra argument here. I am working with @d-kozak to see how to do that best.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r526051070", "createdAt": "2020-11-18T12:32:59Z", "author": {"login": "vjovanov"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/BreakpointInterceptor.java", "diffHunk": "@@ -678,6 +699,124 @@ private static boolean handleGetSystemResources(JNIEnvironment jni, Breakpoint b\n         return allowed;\n     }\n \n+    /**\n+     * java.lang.ClassLoader.postDefineClass is always called in java.lang.ClassLoader.defineClass,\n+     * so intercepting postDefineClass is equivalent to intercepting defineClass but with extra\n+     * benefit of being always able to get defined class' name even if defineClass' classname\n+     * parameter is null.\n+     */\n+    @SuppressWarnings(\"unused\")\n+    private static boolean postDefineClass(JNIEnvironment jni, Breakpoint bp) {\n+        boolean isDynamicallyGenerated = false;\n+\n+        // Get class name from the argument \"name\" of\n+        // defineClass(String name, byte[] b, int off, int len)\n+        // The first argument is implicitly \"this\", so \"name\" is the 2nd parameter.\n+        String nameFromDefineClassParam = fromJniString(jni, getObjectArgument(1, 1));\n+        final String definedClassName;\n+        JNIObjectHandle self = getObjectArgument(0);\n+        // 1. Don't have a name for class before defining.\n+        // The class is dynamically generated.\n+        if (nameFromDefineClassParam == null) {\n+            isDynamicallyGenerated = true;\n+            // Get name from parameter \"c\" of method postDefineClass(Class<?> c, ProtectionDomain\n+            // pd)\n+            definedClassName = getClassNameOrNull(jni, getObjectArgument(1));\n+        } else {\n+            definedClassName = nameFromDefineClassParam;\n+            // Filter out internal classes which are definitely not dynamically generated\n+            // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+            AccessAdvisor postDefineCLassAccessAdvisor = new AccessAdvisor();\n+            postDefineCLassAccessAdvisor.setInLivePhase(true);\n+            if (postDefineCLassAccessAdvisor.shouldIgnore(new LazyValue<>(() -> definedClassName), new LazyValue<>(() -> null))) {\n+                isDynamicallyGenerated = false;\n+            }\n+\n+            // 2. Class with name starts with $ or contains $$ is usually dynamically generated\n+            String className = definedClassName.substring(definedClassName.lastIndexOf('.') + 1);\n+            if (className.startsWith(\"$\") || className.contains(\"$$\")) {\n+                isDynamicallyGenerated = true;\n+            } else {\n+                // 3. A dynamically defined class always return null\n+                // when call java.lang.ClassLoader.getResource(classname)\n+                // This is the accurate but slow way.\n+                String asResourceName = definedClassName.replace('.', '/') + \".class\";\n+                try (CCharPointerHolder resourceNameHolder = toCString(asResourceName);) {\n+                    JNIObjectHandle resourceNameJString = jniFunctions().getNewStringUTF().invoke(jni, resourceNameHolder.get());\n+                    JNIObjectHandle returnValue = callObjectMethodL(jni, self, agent.handles().javaLangClassLoaderGetResource, resourceNameJString);\n+                    isDynamicallyGenerated = returnValue.equal(nullHandle());\n+                }\n+            }\n+        }\n+\n+        // Reuse verifyForName\n+        // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+        boolean allowed = (accessVerifier == null || accessVerifier.verifyForName(jni, nullHandle(), definedClassName));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "originalPosition": 125}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNTg1MDgz", "url": "https://github.com/oracle/graal/pull/2442#pullrequestreview-533585083", "createdAt": "2020-11-18T15:48:57Z", "commit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNTo0ODo1N1rOH10U9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNTo0ODo1N1rOH10U9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE5MzkxMA==", "bodyText": "I think it would be necessary to use com.oracle.svm.agent.NativeImageAgent#tryAtomicMove as a guarantee that the file will always be complete.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r526193910", "createdAt": "2020-11-18T15:48:57Z", "author": {"login": "vjovanov"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/AbstractDynamicClassGenerationSupport.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright (c) 2019, 2019, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020 Alibaba Group Holding Limited. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.agent;\n+\n+import com.oracle.svm.core.util.JavaClassUtil;\n+import static com.oracle.svm.jvmtiagentbase.Support.jniFunctions;\n+import static com.oracle.svm.jvmtiagentbase.Support.getMethodFullNameAtFrame;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import com.oracle.svm.jni.nativeapi.JNIMethodId;\n+import org.graalvm.nativeimage.c.type.CCharPointer;\n+import org.graalvm.nativeimage.c.type.CTypeConversion;\n+import org.graalvm.nativeimage.c.type.VoidPointer;\n+import org.graalvm.word.WordFactory;\n+\n+import com.oracle.svm.jni.nativeapi.JNIEnvironment;\n+import com.oracle.svm.jni.nativeapi.JNIObjectHandle;\n+\n+public abstract class AbstractDynamicClassGenerationSupport {\n+\n+    protected JNIEnvironment jni;\n+    protected JNIObjectHandle callerClass;\n+    protected final String generatedClassName;\n+    protected TraceWriter traceWriter;\n+    protected NativeImageAgent agent;\n+    protected int generatedClassHashCode = 0;\n+    protected byte[] values = null;\n+\n+    private static Path dynclassDumpDir = null;\n+    private static final Path DEFAULT_DUMP = Paths.get(\"dynClass\");\n+    protected String callerMethod;\n+\n+    public static void initDynClassDumpDir(String dir) {\n+        dynclassDumpDir = Paths.get(dir);\n+    }\n+\n+    public static AbstractDynamicClassGenerationSupport getClassLoaderDefineClassSupport(JNIEnvironment jni, JNIObjectHandle callerClass,\n+                    String generatedClassName, TraceWriter traceWriter, NativeImageAgent agent) throws IOException {\n+        return new ClassLoaderDefineClassSupport(jni, callerClass, generatedClassName, traceWriter, agent);\n+    }\n+\n+    protected AbstractDynamicClassGenerationSupport(JNIEnvironment jni, JNIObjectHandle callerClass,\n+                    String generatedClassName, TraceWriter traceWriter, NativeImageAgent agent) throws IOException {\n+        if (dynclassDumpDir == null) {\n+            System.out.println(\"Warning: dynamic-class-dump-dir= was not set in -agentlib:native-image-agent=. Dynamically generated classes will be dumped to the default location:\" +\n+                            DEFAULT_DUMP.toAbsolutePath().toString());\n+            dynclassDumpDir = DEFAULT_DUMP;\n+        }\n+\n+        if (!Files.exists(dynclassDumpDir)) {\n+            Files.createDirectories(dynclassDumpDir);\n+        } else if (!Files.isDirectory(dynclassDumpDir)) {\n+            throw new IOException(\"File \" + dynclassDumpDir + \" already exists! Cannot create the same directory for class file dumping.\");\n+        }\n+\n+        this.jni = jni;\n+        this.callerClass = callerClass;\n+        // Make sure use qualified name for generatedClassName\n+        this.generatedClassName = generatedClassName.replace('/', '.');\n+        this.traceWriter = traceWriter;\n+        this.agent = agent;\n+    }\n+\n+    public abstract void traceReflects(Object result) throws IOException;\n+\n+    /**\n+     * Get class definition contents from passed in function parameter.\n+     * \n+     * @return JObject represents byte array or ByteBuffer\n+     */\n+    protected abstract JNIObjectHandle getClassDefinition();\n+\n+    public abstract boolean checkSupported();\n+\n+    protected abstract int getClassDefinitionBytesLength();\n+\n+    public abstract byte[] getClassContents();\n+\n+    protected byte[] getClassContentsFromByteArray() {\n+        // bytes parameter of defineClass method\n+        JNIObjectHandle bytes = getClassDefinition();\n+        // len parameter of defineClass method\n+        int length = getClassDefinitionBytesLength();\n+        // Get generated class' byte array\n+        CCharPointer byteArray = jniFunctions().getGetByteArrayElements().invoke(jni, bytes, WordFactory.nullPointer());\n+        byte[] contents = new byte[length];\n+        try {\n+            CTypeConversion.asByteBuffer(byteArray, length).get(contents);\n+        } finally {\n+            jniFunctions().getReleaseByteArrayElements().invoke(jni, bytes, byteArray, 0);\n+        }\n+        return contents;\n+    }\n+\n+    protected byte[] getClassContentsFromDirectBuffer() {\n+        // DirectBuffer parameter of defineClass\n+        JNIObjectHandle directbuffer = getClassDefinition();\n+\n+        // Get byte array from DirectBuffer\n+        VoidPointer baseAddr = jniFunctions().getGetDirectBufferAddress().invoke(jni, directbuffer);\n+        JNIMethodId limitMId = agent.handles().getMethodId(jni, agent.handles().javaNioByteBuffer, \"limit\", \"()I\", false);\n+        int limit = jniFunctions().getCallIntMethod().invoke(jni, directbuffer, limitMId);\n+        ByteBuffer classContentsAsByteBuffer = CTypeConversion.asByteBuffer(baseAddr, limit);\n+        byte[] contents = new byte[classContentsAsByteBuffer.limit()];\n+        classContentsAsByteBuffer.get(contents);\n+        classContentsAsByteBuffer.position(0);\n+        return contents;\n+    }\n+\n+    public int calculateGeneratedClassHashcode() throws IOException {\n+        if (generatedClassHashCode == 0) {\n+            generatedClassHashCode = JavaClassUtil.getHashCodeWithoutSourceFileInfo(getClassContents());\n+        }\n+        return generatedClassHashCode;\n+    }\n+\n+    /**\n+     * Save dynamically defined class to file system.\n+     *\n+     */\n+    public void dumpDefinedClass() throws IOException {\n+        if (values == null) {\n+            values = getClassContents();\n+        }\n+\n+        // Get name for generated class\n+        String internalName = generatedClassName.replace('.', File.separatorChar);\n+        Path dumpFile = dynclassDumpDir.resolve(internalName + \".class\");\n+\n+        // Get directory from package\n+        Path dumpDirs = dumpFile.getParent();\n+        if (!Files.exists(dumpDirs)) {\n+            Files.createDirectories(dumpDirs);\n+        } else if (!Files.isDirectory(dumpDirs)) {\n+            throw new IOException(\"File \" + dumpDirs + \" already exists! Cannot create the same name directory for dumping class file.\");\n+        }\n+        try (FileOutputStream stream = new FileOutputStream(dumpFile.toFile());) {\n+            stream.write(values);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "originalPosition": 168}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNTk2MDAz", "url": "https://github.com/oracle/graal/pull/2442#pullrequestreview-533596003", "createdAt": "2020-11-18T15:57:35Z", "commit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNTo1NzozNVrOH100HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNTo1NzozNVrOH100HA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjIwMTg4NA==", "bodyText": "I don't see why we would fail here. I think we should simply not collect those classes ATM. Actually, we could even collect them because in the future we definitely want to support the calls with the protection domain.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r526201884", "createdAt": "2020-11-18T15:57:35Z", "author": {"login": "vjovanov"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/BreakpointInterceptor.java", "diffHunk": "@@ -678,6 +699,124 @@ private static boolean handleGetSystemResources(JNIEnvironment jni, Breakpoint b\n         return allowed;\n     }\n \n+    /**\n+     * java.lang.ClassLoader.postDefineClass is always called in java.lang.ClassLoader.defineClass,\n+     * so intercepting postDefineClass is equivalent to intercepting defineClass but with extra\n+     * benefit of being always able to get defined class' name even if defineClass' classname\n+     * parameter is null.\n+     */\n+    @SuppressWarnings(\"unused\")\n+    private static boolean postDefineClass(JNIEnvironment jni, Breakpoint bp) {\n+        boolean isDynamicallyGenerated = false;\n+\n+        // Get class name from the argument \"name\" of\n+        // defineClass(String name, byte[] b, int off, int len)\n+        // The first argument is implicitly \"this\", so \"name\" is the 2nd parameter.\n+        String nameFromDefineClassParam = fromJniString(jni, getObjectArgument(1, 1));\n+        final String definedClassName;\n+        JNIObjectHandle self = getObjectArgument(0);\n+        // 1. Don't have a name for class before defining.\n+        // The class is dynamically generated.\n+        if (nameFromDefineClassParam == null) {\n+            isDynamicallyGenerated = true;\n+            // Get name from parameter \"c\" of method postDefineClass(Class<?> c, ProtectionDomain\n+            // pd)\n+            definedClassName = getClassNameOrNull(jni, getObjectArgument(1));\n+        } else {\n+            definedClassName = nameFromDefineClassParam;\n+            // Filter out internal classes which are definitely not dynamically generated\n+            // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+            AccessAdvisor postDefineCLassAccessAdvisor = new AccessAdvisor();\n+            postDefineCLassAccessAdvisor.setInLivePhase(true);\n+            if (postDefineCLassAccessAdvisor.shouldIgnore(new LazyValue<>(() -> definedClassName), new LazyValue<>(() -> null))) {\n+                isDynamicallyGenerated = false;\n+            }\n+\n+            // 2. Class with name starts with $ or contains $$ is usually dynamically generated\n+            String className = definedClassName.substring(definedClassName.lastIndexOf('.') + 1);\n+            if (className.startsWith(\"$\") || className.contains(\"$$\")) {\n+                isDynamicallyGenerated = true;\n+            } else {\n+                // 3. A dynamically defined class always return null\n+                // when call java.lang.ClassLoader.getResource(classname)\n+                // This is the accurate but slow way.\n+                String asResourceName = definedClassName.replace('.', '/') + \".class\";\n+                try (CCharPointerHolder resourceNameHolder = toCString(asResourceName);) {\n+                    JNIObjectHandle resourceNameJString = jniFunctions().getNewStringUTF().invoke(jni, resourceNameHolder.get());\n+                    JNIObjectHandle returnValue = callObjectMethodL(jni, self, agent.handles().javaLangClassLoaderGetResource, resourceNameJString);\n+                    isDynamicallyGenerated = returnValue.equal(nullHandle());\n+                }\n+            }\n+        }\n+\n+        // Reuse verifyForName\n+        // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+        boolean allowed = (accessVerifier == null || accessVerifier.verifyForName(jni, nullHandle(), definedClassName));\n+        Object result = false;\n+        boolean justAdded = definedClasses.add(definedClassName);\n+        if (isDynamicallyGenerated) {\n+            if (!justAdded) {\n+                unsupportedExceptions.add(\"Class \" + definedClassName + \" has been defined before. Multiple definitions are not supported.\\n\" +\n+                                AbstractDynamicClassGenerationSupport.getStackTrace(jni).toString());\n+                return allowed;\n+            }\n+            // Check the caller's protectionDomain is null, otherwise don't support\n+            String caller = getMethodFullNameAtFrame(jni, 1);\n+            if (\"java.lang.ClassLoader.defineClass(Ljava/lang/String;[BIILjava/security/ProtectionDomain;)Ljava/lang/Class;\".equals(caller)) {\n+                caller = getMethodFullNameAtFrame(jni, 2);\n+                if (!\"java.lang.ClassLoader.defineClass(Ljava/lang/String;[BII)Ljava/lang/Class;\".equals(caller)) {\n+                    // Reflections are supported in another way, no need to track dynamic class\n+                    // loading\n+                    // used by reflection.\n+                    if (!caller.startsWith(\"sun.reflect\")) {\n+                        unsupportedExceptions.add(\"Don't support defineClass with ProtectionDomain parameter in native image. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "originalPosition": 143}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTg2Mjgy", "url": "https://github.com/oracle/graal/pull/2442#pullrequestreview-534186282", "createdAt": "2020-11-19T08:38:16Z", "commit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwODozODoxN1rOH2SDjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwODozODoxN1rOH2SDjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY4MDk3Mw==", "bodyText": "I think this data structure needs to handle concurrent updates?", "url": "https://github.com/oracle/graal/pull/2442#discussion_r526680973", "createdAt": "2020-11-19T08:38:17Z", "author": {"login": "vjovanov"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/BreakpointInterceptor.java", "diffHunk": "@@ -132,7 +140,8 @@\n     private static NativeImageAgent agent;\n \n     private static Map<Long, Breakpoint> installedBreakpoints;\n-\n+    private static Set<String> definedClasses = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTg4Mzg0", "url": "https://github.com/oracle/graal/pull/2442#pullrequestreview-534188384", "createdAt": "2020-11-19T08:40:59Z", "commit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwODo0MDo1OVrOH2SKMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwODo0MDo1OVrOH2SKMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY4MjY3NQ==", "bodyText": "Why not use SHA-256 or SHA-512 that are standard and can be used from any other language/tool?", "url": "https://github.com/oracle/graal/pull/2442#discussion_r526682675", "createdAt": "2020-11-19T08:40:59Z", "author": {"login": "vjovanov"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/util/JavaClassUtil.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright (c) 2019, 2019, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020 Alibaba Group Holding Limited. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.core.util;\n+\n+import com.sun.org.apache.bcel.internal.classfile.Attribute;\n+import com.sun.org.apache.bcel.internal.classfile.ClassParser;\n+import com.sun.org.apache.bcel.internal.classfile.ConstantUtf8;\n+import com.sun.org.apache.bcel.internal.classfile.JavaClass;\n+import com.sun.org.apache.bcel.internal.classfile.SourceFile;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+public class JavaClassUtil {\n+\n+    private static final String CONSTANT_PLACE_HOLDER = \"CONSTANT_PLACE_HOLDER\";\n+\n+    /**\n+     * Get hashcode of the class for verification usage. But the name of SourceFile attribute is set\n+     * to empty, because it might get changed from run to run and it's not really used in the class.\n+     *\n+     * @return byte array hashcode without SourceFile name\n+     * @throws IOException\n+     */\n+    public static int getHashCodeWithoutSourceFileInfo(byte[] classDefinition) throws IOException {\n+        ClassParser cp = new ClassParser(new ByteArrayInputStream(classDefinition), \"\");\n+        JavaClass jc = cp.parse();\n+        // Set SourceFile name's indexed utf8 value to empty\n+        List<Attribute> sourceFileAttr = Arrays.stream(jc.getAttributes()).filter(attr -> (attr instanceof SourceFile)).collect(Collectors.toList());\n+        // There should be exactly one SourceFile attribute\n+        if (sourceFileAttr.size() == 1) {\n+            SourceFile sourFile = (SourceFile) sourceFileAttr.get(0);\n+            int nameIndex = sourFile.getSourceFileIndex();\n+            String originalSourceFile = ((ConstantUtf8) (jc.getConstantPool().getConstant(nameIndex))).getBytes();\n+            if (originalSourceFile != null && originalSourceFile.length() > 0) {\n+                jc.getConstantPool().setConstant(nameIndex, new ConstantUtf8(CONSTANT_PLACE_HOLDER));\n+                return Arrays.hashCode(jc.getBytes());\n+            }\n+        }\n+        return Arrays.hashCode(classDefinition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTkxNDE0", "url": "https://github.com/oracle/graal/pull/2442#pullrequestreview-534191414", "createdAt": "2020-11-19T08:44:53Z", "commit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwODo0NDo1M1rOH2STTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwODo0NDo1M1rOH2STTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY4NTAwNQ==", "bodyText": "I think it would be better to keep the dynamic classes in the same folder as other configs. This way it will be easier to use native image with -H:ConfigurationFileDirectories=. This is, for example, the case in our benchmarks.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r526685005", "createdAt": "2020-11-19T08:44:53Z", "author": {"login": "vjovanov"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/AbstractDynamicClassGenerationSupport.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright (c) 2019, 2019, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020 Alibaba Group Holding Limited. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.agent;\n+\n+import com.oracle.svm.core.util.JavaClassUtil;\n+import static com.oracle.svm.jvmtiagentbase.Support.jniFunctions;\n+import static com.oracle.svm.jvmtiagentbase.Support.getMethodFullNameAtFrame;\n+\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import com.oracle.svm.jni.nativeapi.JNIMethodId;\n+import org.graalvm.nativeimage.c.type.CCharPointer;\n+import org.graalvm.nativeimage.c.type.CTypeConversion;\n+import org.graalvm.nativeimage.c.type.VoidPointer;\n+import org.graalvm.word.WordFactory;\n+\n+import com.oracle.svm.jni.nativeapi.JNIEnvironment;\n+import com.oracle.svm.jni.nativeapi.JNIObjectHandle;\n+\n+public abstract class AbstractDynamicClassGenerationSupport {\n+\n+    protected JNIEnvironment jni;\n+    protected JNIObjectHandle callerClass;\n+    protected final String generatedClassName;\n+    protected TraceWriter traceWriter;\n+    protected NativeImageAgent agent;\n+    protected int generatedClassHashCode = 0;\n+    protected byte[] values = null;\n+\n+    private static Path dynclassDumpDir = null;\n+    private static final Path DEFAULT_DUMP = Paths.get(\"dynClass\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297"}, "originalPosition": 60}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5371bc88f3f8a289f8b2cc23c2dad5608ee22297", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/5371bc88f3f8a289f8b2cc23c2dad5608ee22297", "committedDate": "2020-06-22T06:47:16Z", "message": "Support dynamic class loading"}, "afterCommit": {"oid": "c85500e2f8e6bfe83dc443aa48fb75ad8a8dcf5d", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/c85500e2f8e6bfe83dc443aa48fb75ad8a8dcf5d", "committedDate": "2020-12-17T14:34:15Z", "message": "Support dynamic class loading\n\nPost rebase fixup\n\nUse separated config for dynamic class cloading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c85500e2f8e6bfe83dc443aa48fb75ad8a8dcf5d", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/c85500e2f8e6bfe83dc443aa48fb75ad8a8dcf5d", "committedDate": "2020-12-17T14:34:15Z", "message": "Support dynamic class loading\n\nPost rebase fixup\n\nUse separated config for dynamic class cloading"}, "afterCommit": {"oid": "622d19d0481b1e614a6ca6fc85852cae50cbffc3", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/622d19d0481b1e614a6ca6fc85852cae50cbffc3", "committedDate": "2020-12-17T14:45:51Z", "message": "Support dynamic class loading\n\nPost rebase fixup\n\nUse separated config for dynamic class cloading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "622d19d0481b1e614a6ca6fc85852cae50cbffc3", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/622d19d0481b1e614a6ca6fc85852cae50cbffc3", "committedDate": "2020-12-17T14:45:51Z", "message": "Support dynamic class loading\n\nPost rebase fixup\n\nUse separated config for dynamic class cloading"}, "afterCommit": {"oid": "eae1c361a2a74547f380fa4c69c32a7fe08af26f", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/eae1c361a2a74547f380fa4c69c32a7fe08af26f", "committedDate": "2020-12-18T02:15:26Z", "message": "Support dynamic class loading\n\nPost rebase fixup\n\nUse separated config for dynamic class cloading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eae1c361a2a74547f380fa4c69c32a7fe08af26f", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/eae1c361a2a74547f380fa4c69c32a7fe08af26f", "committedDate": "2020-12-18T02:15:26Z", "message": "Support dynamic class loading\n\nPost rebase fixup\n\nUse separated config for dynamic class cloading"}, "afterCommit": {"oid": "10b527c17f7bcc2c747183e6d5e79688b84e06c1", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/10b527c17f7bcc2c747183e6d5e79688b84e06c1", "committedDate": "2020-12-21T07:04:13Z", "message": "Support dynamic class loading\n\nPost rebase fixup\n\nUse separated config for dynamic class cloading"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10b527c17f7bcc2c747183e6d5e79688b84e06c1", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/10b527c17f7bcc2c747183e6d5e79688b84e06c1", "committedDate": "2020-12-21T07:04:13Z", "message": "Support dynamic class loading\n\nPost rebase fixup\n\nUse separated config for dynamic class cloading"}, "afterCommit": {"oid": "8cd48dde92c48eaedeccbff8955025e77f838e25", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/8cd48dde92c48eaedeccbff8955025e77f838e25", "committedDate": "2021-03-08T13:19:52Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cd48dde92c48eaedeccbff8955025e77f838e25", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/8cd48dde92c48eaedeccbff8955025e77f838e25", "committedDate": "2021-03-08T13:19:52Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "cc4555fe4ac2b053fa5071ee1b2dc3f4799eb147", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/cc4555fe4ac2b053fa5071ee1b2dc3f4799eb147", "committedDate": "2021-03-19T15:58:29Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc4555fe4ac2b053fa5071ee1b2dc3f4799eb147", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/cc4555fe4ac2b053fa5071ee1b2dc3f4799eb147", "committedDate": "2021-03-19T15:58:29Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "dba07cc54eea99e3719919e022e68a2c7b86a1e2", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/dba07cc54eea99e3719919e022e68a2c7b86a1e2", "committedDate": "2021-03-19T16:09:22Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dba07cc54eea99e3719919e022e68a2c7b86a1e2", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/dba07cc54eea99e3719919e022e68a2c7b86a1e2", "committedDate": "2021-03-19T16:09:22Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "67814e49510c57be5b2bfeb755f5e39f484b3ac1", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/67814e49510c57be5b2bfeb755f5e39f484b3ac1", "committedDate": "2021-03-19T17:11:14Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67814e49510c57be5b2bfeb755f5e39f484b3ac1", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/67814e49510c57be5b2bfeb755f5e39f484b3ac1", "committedDate": "2021-03-19T17:11:14Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "714886bbc73726afe9040beecee24b7564e2dff5", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/714886bbc73726afe9040beecee24b7564e2dff5", "committedDate": "2021-03-19T17:12:58Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "714886bbc73726afe9040beecee24b7564e2dff5", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/714886bbc73726afe9040beecee24b7564e2dff5", "committedDate": "2021-03-19T17:12:58Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "1d63863f369e30392f43e9b77f6b40384a3110da", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/1d63863f369e30392f43e9b77f6b40384a3110da", "committedDate": "2021-03-19T17:21:24Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d63863f369e30392f43e9b77f6b40384a3110da", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/1d63863f369e30392f43e9b77f6b40384a3110da", "committedDate": "2021-03-19T17:21:24Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "e5b9ad7aa228890c070ea31e9b9e2968b9dccefd", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/e5b9ad7aa228890c070ea31e9b9e2968b9dccefd", "committedDate": "2021-03-22T02:07:28Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e5b9ad7aa228890c070ea31e9b9e2968b9dccefd", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/e5b9ad7aa228890c070ea31e9b9e2968b9dccefd", "committedDate": "2021-03-22T02:07:28Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "e3f43a05ae7fc4be1cbe339a2d0ee3ea80af3b12", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/e3f43a05ae7fc4be1cbe339a2d0ee3ea80af3b12", "committedDate": "2021-03-22T02:20:40Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e3f43a05ae7fc4be1cbe339a2d0ee3ea80af3b12", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/e3f43a05ae7fc4be1cbe339a2d0ee3ea80af3b12", "committedDate": "2021-03-22T02:20:40Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "0ae0876624ac68737d6ab3e0fe3e920625260d5d", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/0ae0876624ac68737d6ab3e0fe3e920625260d5d", "committedDate": "2021-03-22T02:41:57Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ae0876624ac68737d6ab3e0fe3e920625260d5d", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/0ae0876624ac68737d6ab3e0fe3e920625260d5d", "committedDate": "2021-03-22T02:41:57Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "2f9073f2aa4b7ab3472b455573892e6fea3ff813", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/2f9073f2aa4b7ab3472b455573892e6fea3ff813", "committedDate": "2021-03-22T11:35:30Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f9073f2aa4b7ab3472b455573892e6fea3ff813", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/2f9073f2aa4b7ab3472b455573892e6fea3ff813", "committedDate": "2021-03-22T11:35:30Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "8231d6520420b4cf12e6567cd87dbd2bad9a8898", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/8231d6520420b4cf12e6567cd87dbd2bad9a8898", "committedDate": "2021-03-22T11:47:23Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8231d6520420b4cf12e6567cd87dbd2bad9a8898", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/8231d6520420b4cf12e6567cd87dbd2bad9a8898", "committedDate": "2021-03-22T11:47:23Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "b18ecdb8e6f780d65ecb086562a80f5411127a64", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/b18ecdb8e6f780d65ecb086562a80f5411127a64", "committedDate": "2021-03-23T02:41:42Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b18ecdb8e6f780d65ecb086562a80f5411127a64", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/b18ecdb8e6f780d65ecb086562a80f5411127a64", "committedDate": "2021-03-23T02:41:42Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "479fe5d4fdcb4f643edbf7b1ac8023ca52a64d27", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/479fe5d4fdcb4f643edbf7b1ac8023ca52a64d27", "committedDate": "2021-03-23T09:51:22Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "479fe5d4fdcb4f643edbf7b1ac8023ca52a64d27", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/479fe5d4fdcb4f643edbf7b1ac8023ca52a64d27", "committedDate": "2021-03-23T09:51:22Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "c59ce596166213eecc44de5bd554c52986280376", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/c59ce596166213eecc44de5bd554c52986280376", "committedDate": "2021-03-23T11:36:08Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c59ce596166213eecc44de5bd554c52986280376", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/c59ce596166213eecc44de5bd554c52986280376", "committedDate": "2021-03-23T11:36:08Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "e696dcdb14958683dde0ec4c8930b20eeb9b6285", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/e696dcdb14958683dde0ec4c8930b20eeb9b6285", "committedDate": "2021-03-23T11:42:58Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e696dcdb14958683dde0ec4c8930b20eeb9b6285", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/e696dcdb14958683dde0ec4c8930b20eeb9b6285", "committedDate": "2021-03-23T11:42:58Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "fefa1fe8f9d8125f456c6244e5ac84958035fa54", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/fefa1fe8f9d8125f456c6244e5ac84958035fa54", "committedDate": "2021-03-26T02:15:39Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fefa1fe8f9d8125f456c6244e5ac84958035fa54", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/fefa1fe8f9d8125f456c6244e5ac84958035fa54", "committedDate": "2021-03-26T02:15:39Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/98f80147901082a822f76dde76af757036aad82d", "committedDate": "2021-03-26T05:06:55Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjMwMTk5NzUz", "url": "https://github.com/oracle/graal/pull/2442#pullrequestreview-630199753", "createdAt": "2021-04-07T16:09:53Z", "commit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0wN1QxNjowOTo1M1rOJEmA_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0wOFQxNjoyNzoxOFrOJFoJTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODc5NjkyNA==", "bodyText": "This seems unused now, please remove if that is the case.\nPlease check the entire PR for unused code and unnecessary whitespace changes.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r608796924", "createdAt": "2021-04-07T16:09:53Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/BreakpointInterceptor.java", "diffHunk": "@@ -169,6 +177,18 @@ private static void traceBreakpoint(JNIEnvironment env, JNIObjectHandle clazz, J\n         }\n     }\n \n+    static void traceBreakpoint(JNIEnvironment env, JNIObjectHandle clazz, JNIObjectHandle declaringClass,\n+                    JNIObjectHandle callerClass, String function, boolean allowWrite, boolean unsafeAccess, Object result,\n+                    String fieldName) {\n+        if (traceWriter != null) {\n+            traceWriter.traceCall(\"reflect\", function, getClassNameOr(env, clazz, null, TraceWriter.UNKNOWN_VALUE),\n+                            getClassNameOr(env, declaringClass, null, TraceWriter.UNKNOWN_VALUE),\n+                            getClassNameOr(env, callerClass, null, TraceWriter.UNKNOWN_VALUE), result, allowWrite, unsafeAccess,\n+                            fieldName);\n+            guarantee(!testException(env));\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODgwMDk3NA==", "bodyText": "This is not an issue that needs to be handled or reported in the agent, but should be reported during the image build or at image runtime.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r608800974", "createdAt": "2021-04-07T16:15:12Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/BreakpointInterceptor.java", "diffHunk": "@@ -573,6 +593,96 @@ private static boolean handleGetSystemResources(JNIEnvironment jni, Breakpoint b\n         return true;\n     }\n \n+    /**\n+     * java.lang.ClassLoader.postDefineClass is always called in java.lang.ClassLoader.defineClass,\n+     * so intercepting postDefineClass is equivalent to intercepting defineClass but with extra\n+     * benefit of being always able to get defined class' name even if defineClass' classname\n+     * parameter is null.\n+     */\n+    @SuppressWarnings(\"unused\")\n+    private static boolean postDefineClass(JNIEnvironment jni, Breakpoint bp) {\n+        boolean isDynamicallyGenerated = false;\n+\n+        // Get class name from the argument \"name\" of\n+        // defineClass(String name, byte[] b, int off, int len)\n+        // The first argument is implicitly \"this\", so \"name\" is the 2nd parameter.\n+        String nameFromDefineClassParam = fromJniString(jni, getObjectArgument(1, 1));\n+        final String definedClassName;\n+        JNIObjectHandle self = getObjectArgument(0);\n+        // 1. Don't have a name for class before defining.\n+        // The class is dynamically generated.\n+        if (nameFromDefineClassParam == null) {\n+            isDynamicallyGenerated = true;\n+            // Get name from parameter \"c\" of method postDefineClass(Class<?> c, ProtectionDomain\n+            // pd)\n+            definedClassName = getClassNameOrNull(jni, getObjectArgument(1));\n+        } else {\n+            definedClassName = nameFromDefineClassParam;\n+            // Filter out internal classes which are definitely not dynamically generated\n+            // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+            AccessAdvisor postDefineCLassAccessAdvisor = new AccessAdvisor();\n+            postDefineCLassAccessAdvisor.setInLivePhase(true);\n+            if (postDefineCLassAccessAdvisor.shouldIgnore(new LazyValue<>(() -> definedClassName), new LazyValue<>(() -> null))) {\n+                isDynamicallyGenerated = false;\n+            }\n+\n+            // 2. Class with name starts with $ or contains $$ is usually dynamically generated\n+            String className = definedClassName.substring(definedClassName.lastIndexOf('.') + 1);\n+            if (className.startsWith(\"$\") || className.contains(\"$$\")) {\n+                isDynamicallyGenerated = true;\n+            } else {\n+                // 3. A dynamically defined class always return null\n+                // when call java.lang.ClassLoader.getResource(classname)\n+                // This is the accurate but slow way.\n+                String asResourceName = definedClassName.replace('.', '/') + \".class\";\n+                try (CCharPointerHolder resourceNameHolder = toCString(asResourceName);) {\n+                    JNIObjectHandle resourceNameJString = jniFunctions().getNewStringUTF().invoke(jni, resourceNameHolder.get());\n+                    JNIObjectHandle returnValue = callObjectMethodL(jni, self, agent.handles().javaLangClassLoaderGetResource, resourceNameJString);\n+                    isDynamicallyGenerated = returnValue.equal(nullHandle());\n+                }\n+            }\n+        }\n+\n+        // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+        Object result = false;\n+        boolean justAdded = definedClasses.add(definedClassName);\n+        if (isDynamicallyGenerated) {\n+            if (!justAdded) {\n+                unsupportedExceptions.add(\"Class \" + definedClassName + \" has been defined before. Multiple definitions are not supported.\\n\" +\n+                                ClassLoaderDefineClassSupport.getStackTrace(jni).toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODgxNzgyMw==", "bodyText": "This will execute postDefineClass twice because we are currently inside it in the breakpoint and will continue executing there after returning. It also seems unnecessary because the class is already loaded and postDefineClass does nothing of significance and is private, so it cannot be overridden in subclasses.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r608817823", "createdAt": "2021-04-07T16:37:07Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/BreakpointInterceptor.java", "diffHunk": "@@ -573,6 +593,96 @@ private static boolean handleGetSystemResources(JNIEnvironment jni, Breakpoint b\n         return true;\n     }\n \n+    /**\n+     * java.lang.ClassLoader.postDefineClass is always called in java.lang.ClassLoader.defineClass,\n+     * so intercepting postDefineClass is equivalent to intercepting defineClass but with extra\n+     * benefit of being always able to get defined class' name even if defineClass' classname\n+     * parameter is null.\n+     */\n+    @SuppressWarnings(\"unused\")\n+    private static boolean postDefineClass(JNIEnvironment jni, Breakpoint bp) {\n+        boolean isDynamicallyGenerated = false;\n+\n+        // Get class name from the argument \"name\" of\n+        // defineClass(String name, byte[] b, int off, int len)\n+        // The first argument is implicitly \"this\", so \"name\" is the 2nd parameter.\n+        String nameFromDefineClassParam = fromJniString(jni, getObjectArgument(1, 1));\n+        final String definedClassName;\n+        JNIObjectHandle self = getObjectArgument(0);\n+        // 1. Don't have a name for class before defining.\n+        // The class is dynamically generated.\n+        if (nameFromDefineClassParam == null) {\n+            isDynamicallyGenerated = true;\n+            // Get name from parameter \"c\" of method postDefineClass(Class<?> c, ProtectionDomain\n+            // pd)\n+            definedClassName = getClassNameOrNull(jni, getObjectArgument(1));\n+        } else {\n+            definedClassName = nameFromDefineClassParam;\n+            // Filter out internal classes which are definitely not dynamically generated\n+            // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+            AccessAdvisor postDefineCLassAccessAdvisor = new AccessAdvisor();\n+            postDefineCLassAccessAdvisor.setInLivePhase(true);\n+            if (postDefineCLassAccessAdvisor.shouldIgnore(new LazyValue<>(() -> definedClassName), new LazyValue<>(() -> null))) {\n+                isDynamicallyGenerated = false;\n+            }\n+\n+            // 2. Class with name starts with $ or contains $$ is usually dynamically generated\n+            String className = definedClassName.substring(definedClassName.lastIndexOf('.') + 1);\n+            if (className.startsWith(\"$\") || className.contains(\"$$\")) {\n+                isDynamicallyGenerated = true;\n+            } else {\n+                // 3. A dynamically defined class always return null\n+                // when call java.lang.ClassLoader.getResource(classname)\n+                // This is the accurate but slow way.\n+                String asResourceName = definedClassName.replace('.', '/') + \".class\";\n+                try (CCharPointerHolder resourceNameHolder = toCString(asResourceName);) {\n+                    JNIObjectHandle resourceNameJString = jniFunctions().getNewStringUTF().invoke(jni, resourceNameHolder.get());\n+                    JNIObjectHandle returnValue = callObjectMethodL(jni, self, agent.handles().javaLangClassLoaderGetResource, resourceNameJString);\n+                    isDynamicallyGenerated = returnValue.equal(nullHandle());\n+                }\n+            }\n+        }\n+\n+        // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+        Object result = false;\n+        boolean justAdded = definedClasses.add(definedClassName);\n+        if (isDynamicallyGenerated) {\n+            if (!justAdded) {\n+                unsupportedExceptions.add(\"Class \" + definedClassName + \" has been defined before. Multiple definitions are not supported.\\n\" +\n+                                ClassLoaderDefineClassSupport.getStackTrace(jni).toString());\n+                return true;\n+            }\n+            // Check the caller is using byte array or directedBuffer\n+            String caller = getMethodFullNameAtFrame(jni, 1);\n+            boolean isByteArray = \"java.lang.ClassLoader.defineClass(Ljava/lang/String;[BIILjava/security/ProtectionDomain;)Ljava/lang/Class;\".equals(caller);\n+            // Verify if defineClass succeeds\n+            // As we hook on postDefineClass method which is the last step of defineClass, so if\n+            // it can execute successfully, the whole defineClass method can execute\n+            // successfully\n+            JNIValue args = StackValue.get(2, JNIValue.class);\n+            args.addressOf(0).setObject(getObjectArgument(1));\n+            args.addressOf(1).setObject(getObjectArgument(2));\n+            jniFunctions().getCallVoidMethodA().invoke(jni, self, bp.method, args);\n+            if (clearException(jni)) {\n+                // No need to proceed if any exception happens\n+                result = false;\n+            } else {\n+                result = true;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODgxODg0NQ==", "bodyText": "Please undo this and instead wrap the exception in an unchecked (runtime) exception where it is thrown.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r608818845", "createdAt": "2021-04-07T16:38:26Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/BreakpointInterceptor.java", "diffHunk": "@@ -1269,15 +1379,29 @@ private static void bindNativeBreakpoint(JNIEnvironment jni, NativeBreakpoint bp\n         }\n     }\n \n+    public static void reportExceptions() {\n+        if (!unsupportedExceptions.isEmpty()) {\n+            System.err.println(unsupportedExceptions.size() + \" unsupported features are detected \");\n+            StringBuilder errorMsg = new StringBuilder();\n+            for (int i = 0; i < unsupportedExceptions.size(); i++) {\n+                errorMsg.append(unsupportedExceptions.get(i)).append(\"\\n\");\n+            }\n+            throw new UnsupportedOperationException(errorMsg.toString());\n+        } else {\n+            unsupportedExceptions = null;\n+        }\n+    }\n+\n     public static void onUnload() {\n         installedBreakpoints = null;\n         nativeBreakpoints = null;\n         observedExplicitLoadClassCallSites = null;\n         traceWriter = null;\n+        definedClasses = null;\n     }\n \n     private interface BreakpointHandler {\n-        boolean dispatch(JNIEnvironment jni, Breakpoint bp);\n+        boolean dispatch(JNIEnvironment jni, Breakpoint bp) throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 200}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODgyNzY3Mg==", "bodyText": "Why not use the ClassFileLoadHook event instead? It provides the class name and bytes directly without having to extract them from parameters and locals.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r608827672", "createdAt": "2021-04-07T16:50:41Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/BreakpointInterceptor.java", "diffHunk": "@@ -573,6 +593,96 @@ private static boolean handleGetSystemResources(JNIEnvironment jni, Breakpoint b\n         return true;\n     }\n \n+    /**\n+     * java.lang.ClassLoader.postDefineClass is always called in java.lang.ClassLoader.defineClass,\n+     * so intercepting postDefineClass is equivalent to intercepting defineClass but with extra\n+     * benefit of being always able to get defined class' name even if defineClass' classname\n+     * parameter is null.\n+     */\n+    @SuppressWarnings(\"unused\")\n+    private static boolean postDefineClass(JNIEnvironment jni, Breakpoint bp) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODgyODUzNA==", "bodyText": "Please reuse the existing AccessAdvisor object and for brevity also the LazyValueUtils methods (with static imports).", "url": "https://github.com/oracle/graal/pull/2442#discussion_r608828534", "createdAt": "2021-04-07T16:51:55Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/BreakpointInterceptor.java", "diffHunk": "@@ -573,6 +593,96 @@ private static boolean handleGetSystemResources(JNIEnvironment jni, Breakpoint b\n         return true;\n     }\n \n+    /**\n+     * java.lang.ClassLoader.postDefineClass is always called in java.lang.ClassLoader.defineClass,\n+     * so intercepting postDefineClass is equivalent to intercepting defineClass but with extra\n+     * benefit of being always able to get defined class' name even if defineClass' classname\n+     * parameter is null.\n+     */\n+    @SuppressWarnings(\"unused\")\n+    private static boolean postDefineClass(JNIEnvironment jni, Breakpoint bp) {\n+        boolean isDynamicallyGenerated = false;\n+\n+        // Get class name from the argument \"name\" of\n+        // defineClass(String name, byte[] b, int off, int len)\n+        // The first argument is implicitly \"this\", so \"name\" is the 2nd parameter.\n+        String nameFromDefineClassParam = fromJniString(jni, getObjectArgument(1, 1));\n+        final String definedClassName;\n+        JNIObjectHandle self = getObjectArgument(0);\n+        // 1. Don't have a name for class before defining.\n+        // The class is dynamically generated.\n+        if (nameFromDefineClassParam == null) {\n+            isDynamicallyGenerated = true;\n+            // Get name from parameter \"c\" of method postDefineClass(Class<?> c, ProtectionDomain\n+            // pd)\n+            definedClassName = getClassNameOrNull(jni, getObjectArgument(1));\n+        } else {\n+            definedClassName = nameFromDefineClassParam;\n+            // Filter out internal classes which are definitely not dynamically generated\n+            // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+            AccessAdvisor postDefineCLassAccessAdvisor = new AccessAdvisor();\n+            postDefineCLassAccessAdvisor.setInLivePhase(true);\n+            if (postDefineCLassAccessAdvisor.shouldIgnore(new LazyValue<>(() -> definedClassName), new LazyValue<>(() -> null))) {\n+                isDynamicallyGenerated = false;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODgzMDM0Nw==", "bodyText": "I don't think it's necessary to instantiate this class, it should be fine to pass everything as arguments to trace and pass needed values on to other methods at that point.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r608830347", "createdAt": "2021-04-07T16:54:28Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/ClassLoaderDefineClassSupport.java", "diffHunk": "@@ -0,0 +1,175 @@\n+/*\n+ * Copyright (c) 2020, 2021, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Alibaba Group Holding Limited. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.agent;\n+\n+import com.oracle.svm.core.util.JavaClassUtil;\n+import com.oracle.svm.jni.nativeapi.JNIEnvironment;\n+import com.oracle.svm.jni.nativeapi.JNIMethodId;\n+import com.oracle.svm.jni.nativeapi.JNIObjectHandle;\n+import org.graalvm.nativeimage.c.type.CCharPointer;\n+import org.graalvm.nativeimage.c.type.CTypeConversion;\n+import org.graalvm.nativeimage.c.type.VoidPointer;\n+import org.graalvm.word.WordFactory;\n+\n+import java.nio.ByteBuffer;\n+import java.security.NoSuchAlgorithmException;\n+\n+import static com.oracle.svm.jvmtiagentbase.Support.getIntArgument;\n+import static com.oracle.svm.jvmtiagentbase.Support.getMethodFullNameAtFrame;\n+import static com.oracle.svm.jvmtiagentbase.Support.getObjectArgument;\n+import static com.oracle.svm.jvmtiagentbase.Support.jniFunctions;\n+\n+/**\n+ * Support dynamic class loading that is implemented by java.lang.ClassLoader.defineClass.\n+ */\n+public class ClassLoaderDefineClassSupport {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODgzMTM1OQ==", "bodyText": "Please clean up visibilities and modifiers in the entire PR: none of the members in this class need to be protected as far as I can tell and should be either private or package-visible and potentially final.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r608831359", "createdAt": "2021-04-07T16:55:52Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/ClassLoaderDefineClassSupport.java", "diffHunk": "@@ -0,0 +1,175 @@\n+/*\n+ * Copyright (c) 2020, 2021, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Alibaba Group Holding Limited. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.agent;\n+\n+import com.oracle.svm.core.util.JavaClassUtil;\n+import com.oracle.svm.jni.nativeapi.JNIEnvironment;\n+import com.oracle.svm.jni.nativeapi.JNIMethodId;\n+import com.oracle.svm.jni.nativeapi.JNIObjectHandle;\n+import org.graalvm.nativeimage.c.type.CCharPointer;\n+import org.graalvm.nativeimage.c.type.CTypeConversion;\n+import org.graalvm.nativeimage.c.type.VoidPointer;\n+import org.graalvm.word.WordFactory;\n+\n+import java.nio.ByteBuffer;\n+import java.security.NoSuchAlgorithmException;\n+\n+import static com.oracle.svm.jvmtiagentbase.Support.getIntArgument;\n+import static com.oracle.svm.jvmtiagentbase.Support.getMethodFullNameAtFrame;\n+import static com.oracle.svm.jvmtiagentbase.Support.getObjectArgument;\n+import static com.oracle.svm.jvmtiagentbase.Support.jniFunctions;\n+\n+/**\n+ * Support dynamic class loading that is implemented by java.lang.ClassLoader.defineClass.\n+ */\n+public class ClassLoaderDefineClassSupport {\n+\n+    private static final String DEFINE_CLASS_BYTEARRAY_SIG = \"java.lang.ClassLoader.defineClass(Ljava/lang/String;[BII)Ljava/lang/Class;\";\n+    protected JNIEnvironment jni;\n+    protected JNIObjectHandle callerClass;\n+    protected final String generatedClassName;\n+    protected TraceWriter traceWriter;\n+    protected NativeImageAgent agent;\n+    protected String generatedClassHashCode = null;\n+    protected byte[] values = null;\n+    private boolean isByteArray;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODgzMzAwNg==", "bodyText": "I don't think any of these have to be public.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r608833006", "createdAt": "2021-04-07T16:57:58Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/NativeImageAgentJNIHandleSet.java", "diffHunk": "@@ -39,17 +39,27 @@\n     final JNIObjectHandle javaLangClass;\n     final JNIMethodId javaLangClassForName3;\n     final JNIMethodId javaUtilEnumerationNextElement;\n-    final JNIMethodId javaLangClassGetDeclaredMethod;\n-    final JNIMethodId javaLangClassGetDeclaredConstructor;\n-    final JNIMethodId javaLangClassGetDeclaredField;\n-    final JNIMethodId javaLangClassGetName;\n-\n     final JNIMethodId javaLangReflectMemberGetName;\n     final JNIMethodId javaLangReflectMemberGetDeclaringClass;\n-\n     final JNIMethodId javaUtilEnumerationHasMoreElements;\n-\n+    final JNIMethodId javaUtilMissingResourceExceptionCtor3;\n+    public final JNIMethodId javaLangClassLoaderGetResource;\n     final JNIObjectHandle javaLangClassLoader;\n+    public final JNIObjectHandle javaNioByteBuffer;\n+    public final JNIObjectHandle javaLangSecurityException;\n+    public final JNIObjectHandle javaLangNoClassDefFoundError;\n+    public final JNIObjectHandle javaLangNoSuchMethodError;\n+    public final JNIObjectHandle javaLangIncompatibleClassChangeError;\n+    final JNIObjectHandle javaLangNoSuchMethodException;\n+    public final JNIObjectHandle javaLangNoSuchFieldError;\n+    final JNIObjectHandle javaLangNoSuchFieldException;\n+    final JNIObjectHandle javaLangClassNotFoundException;\n+    final JNIObjectHandle javaLangRuntimeException;\n+    final JNIObjectHandle javaUtilMissingResourceException;\n+    final JNIMethodId javaLangClassGetDeclaredMethod;\n+    final JNIMethodId javaLangClassGetDeclaredConstructor;\n+    final JNIMethodId javaLangClassGetDeclaredField;\n+    final JNIMethodId javaLangClassGetName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODgzNTQxMw==", "bodyText": "This is slow. If checks like this cannot be avoided, compare against a jmethodID from the handle set.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r608835413", "createdAt": "2021-04-07T17:01:14Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/BreakpointInterceptor.java", "diffHunk": "@@ -573,6 +593,96 @@ private static boolean handleGetSystemResources(JNIEnvironment jni, Breakpoint b\n         return true;\n     }\n \n+    /**\n+     * java.lang.ClassLoader.postDefineClass is always called in java.lang.ClassLoader.defineClass,\n+     * so intercepting postDefineClass is equivalent to intercepting defineClass but with extra\n+     * benefit of being always able to get defined class' name even if defineClass' classname\n+     * parameter is null.\n+     */\n+    @SuppressWarnings(\"unused\")\n+    private static boolean postDefineClass(JNIEnvironment jni, Breakpoint bp) {\n+        boolean isDynamicallyGenerated = false;\n+\n+        // Get class name from the argument \"name\" of\n+        // defineClass(String name, byte[] b, int off, int len)\n+        // The first argument is implicitly \"this\", so \"name\" is the 2nd parameter.\n+        String nameFromDefineClassParam = fromJniString(jni, getObjectArgument(1, 1));\n+        final String definedClassName;\n+        JNIObjectHandle self = getObjectArgument(0);\n+        // 1. Don't have a name for class before defining.\n+        // The class is dynamically generated.\n+        if (nameFromDefineClassParam == null) {\n+            isDynamicallyGenerated = true;\n+            // Get name from parameter \"c\" of method postDefineClass(Class<?> c, ProtectionDomain\n+            // pd)\n+            definedClassName = getClassNameOrNull(jni, getObjectArgument(1));\n+        } else {\n+            definedClassName = nameFromDefineClassParam;\n+            // Filter out internal classes which are definitely not dynamically generated\n+            // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+            AccessAdvisor postDefineCLassAccessAdvisor = new AccessAdvisor();\n+            postDefineCLassAccessAdvisor.setInLivePhase(true);\n+            if (postDefineCLassAccessAdvisor.shouldIgnore(new LazyValue<>(() -> definedClassName), new LazyValue<>(() -> null))) {\n+                isDynamicallyGenerated = false;\n+            }\n+\n+            // 2. Class with name starts with $ or contains $$ is usually dynamically generated\n+            String className = definedClassName.substring(definedClassName.lastIndexOf('.') + 1);\n+            if (className.startsWith(\"$\") || className.contains(\"$$\")) {\n+                isDynamicallyGenerated = true;\n+            } else {\n+                // 3. A dynamically defined class always return null\n+                // when call java.lang.ClassLoader.getResource(classname)\n+                // This is the accurate but slow way.\n+                String asResourceName = definedClassName.replace('.', '/') + \".class\";\n+                try (CCharPointerHolder resourceNameHolder = toCString(asResourceName);) {\n+                    JNIObjectHandle resourceNameJString = jniFunctions().getNewStringUTF().invoke(jni, resourceNameHolder.get());\n+                    JNIObjectHandle returnValue = callObjectMethodL(jni, self, agent.handles().javaLangClassLoaderGetResource, resourceNameJString);\n+                    isDynamicallyGenerated = returnValue.equal(nullHandle());\n+                }\n+            }\n+        }\n+\n+        // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+        Object result = false;\n+        boolean justAdded = definedClasses.add(definedClassName);\n+        if (isDynamicallyGenerated) {\n+            if (!justAdded) {\n+                unsupportedExceptions.add(\"Class \" + definedClassName + \" has been defined before. Multiple definitions are not supported.\\n\" +\n+                                ClassLoaderDefineClassSupport.getStackTrace(jni).toString());\n+                return true;\n+            }\n+            // Check the caller is using byte array or directedBuffer\n+            String caller = getMethodFullNameAtFrame(jni, 1);\n+            boolean isByteArray = \"java.lang.ClassLoader.defineClass(Ljava/lang/String;[BIILjava/security/ProtectionDomain;)Ljava/lang/Class;\".equals(caller);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTcyNjU1Ng==", "bodyText": "This seems expensive and I am not convinced of the $/$$ heuristic either. But there is no single perfect way to determine whether a class was generated.\nHowever, have you looked into the supplied ProtectionDomain object and its CodeSource object? It seems like an equally good indicator whether that object or its return value for getLocation are null and querying them is cheap.\n(The question of where to draw the line here is tricky. For example, we probably want to capture classes from the network or from nested JARs which do have a valid URL. I suppose we will have to improve this for cases like that over time.)", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609726556", "createdAt": "2021-04-08T13:53:41Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/BreakpointInterceptor.java", "diffHunk": "@@ -573,6 +593,96 @@ private static boolean handleGetSystemResources(JNIEnvironment jni, Breakpoint b\n         return true;\n     }\n \n+    /**\n+     * java.lang.ClassLoader.postDefineClass is always called in java.lang.ClassLoader.defineClass,\n+     * so intercepting postDefineClass is equivalent to intercepting defineClass but with extra\n+     * benefit of being always able to get defined class' name even if defineClass' classname\n+     * parameter is null.\n+     */\n+    @SuppressWarnings(\"unused\")\n+    private static boolean postDefineClass(JNIEnvironment jni, Breakpoint bp) {\n+        boolean isDynamicallyGenerated = false;\n+\n+        // Get class name from the argument \"name\" of\n+        // defineClass(String name, byte[] b, int off, int len)\n+        // The first argument is implicitly \"this\", so \"name\" is the 2nd parameter.\n+        String nameFromDefineClassParam = fromJniString(jni, getObjectArgument(1, 1));\n+        final String definedClassName;\n+        JNIObjectHandle self = getObjectArgument(0);\n+        // 1. Don't have a name for class before defining.\n+        // The class is dynamically generated.\n+        if (nameFromDefineClassParam == null) {\n+            isDynamicallyGenerated = true;\n+            // Get name from parameter \"c\" of method postDefineClass(Class<?> c, ProtectionDomain\n+            // pd)\n+            definedClassName = getClassNameOrNull(jni, getObjectArgument(1));\n+        } else {\n+            definedClassName = nameFromDefineClassParam;\n+            // Filter out internal classes which are definitely not dynamically generated\n+            // CallerClass is always java.lang.ClassLoader, we only check the defined class\n+            AccessAdvisor postDefineCLassAccessAdvisor = new AccessAdvisor();\n+            postDefineCLassAccessAdvisor.setInLivePhase(true);\n+            if (postDefineCLassAccessAdvisor.shouldIgnore(new LazyValue<>(() -> definedClassName), new LazyValue<>(() -> null))) {\n+                isDynamicallyGenerated = false;\n+            }\n+\n+            // 2. Class with name starts with $ or contains $$ is usually dynamically generated\n+            String className = definedClassName.substring(definedClassName.lastIndexOf('.') + 1);\n+            if (className.startsWith(\"$\") || className.contains(\"$$\")) {\n+                isDynamicallyGenerated = true;\n+            } else {\n+                // 3. A dynamically defined class always return null\n+                // when call java.lang.ClassLoader.getResource(classname)\n+                // This is the accurate but slow way.\n+                String asResourceName = definedClassName.replace('.', '/') + \".class\";\n+                try (CCharPointerHolder resourceNameHolder = toCString(asResourceName);) {\n+                    JNIObjectHandle resourceNameJString = jniFunctions().getNewStringUTF().invoke(jni, resourceNameHolder.get());\n+                    JNIObjectHandle returnValue = callObjectMethodL(jni, self, agent.handles().javaLangClassLoaderGetResource, resourceNameJString);\n+                    isDynamicallyGenerated = returnValue.equal(nullHandle());\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTczMzgxNA==", "bodyText": "Why p.getResourceConfiguration()? Is this even necessary?", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609733814", "createdAt": "2021-04-08T14:00:31Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.configure/src/com/oracle/svm/configure/ConfigurationTool.java", "diffHunk": "@@ -299,6 +306,11 @@ private static void generate(Iterator<String> argsIter, boolean acceptTraceFileA\n                 p.getSerializationConfiguration().printJson(writer);\n             }\n         }\n+        for (URI uri : outputSet.getDynamicClassLoadingConfigPaths()) {\n+            try (JsonWriter writer = new JsonWriter(Paths.get(uri))) {\n+                p.getResourceConfiguration().printJson(writer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTgxNTEwOQ==", "bodyText": "Why not use traceCall? Everything can be put in args.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609815109", "createdAt": "2021-04-08T15:19:15Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.agent/src/com/oracle/svm/agent/TraceWriter.java", "diffHunk": "@@ -110,6 +110,19 @@ public void traceCall(String tracer, String function, Object clazz, Object decla\n         traceEntry(entry);\n     }\n \n+    public void traceDefineClass(String definedClassName, String checksum, byte[] classContents, Object result) {\n+        Map<String, Object> entry = new HashMap<>();\n+        entry.put(\"tracer\", \"classDefiner\");\n+        entry.put(\"definedClassName\", definedClassName);\n+        entry.put(\"checksum\", checksum);\n+        // classContents will be dumped to file and then set dumpedFileName\n+        // at the end of tracing process\n+        entry.put(\"dumpedFileName\", null);\n+        entry.put(\"classContents\", classContents);\n+        entry.put(\"result\", result);\n+        traceEntry(entry);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTgxNzU3NA==", "bodyText": "This should be inconsistent with the other styles and a bit shorter perhaps, how about --dynamic-classes-input/-output? In fact, I think we should drop the extra loading in other places too.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609817574", "createdAt": "2021-04-08T15:21:42Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.configure/src/com/oracle/svm/configure/ConfigurationTool.java", "diffHunk": "@@ -195,6 +195,12 @@ private static void generate(Iterator<String> argsIter, boolean acceptTraceFileA\n                     set.getSerializationConfigPaths().add(requirePathUri(current, value));\n                     break;\n \n+                case \"--dynamicClassLoading-input\":\n+                    set = inputSet; // fall through\n+                case \"--dynamicClassLoading-output\":\n+                    set.getDynamicClassLoadingConfigPaths().add(requirePathUri(current, value));\n+                    break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTgyNTcyNg==", "bodyText": "Dead code?", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609825726", "createdAt": "2021-04-08T15:29:57Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/configure/ConfigurationParser.java", "diffHunk": "@@ -82,4 +82,11 @@ protected static long asLong(Object value, String propertyName) {\n         }\n         throw new JSONParserException(\"Invalid long value '\" + value + \"' for element '\" + propertyName + \"'\");\n     }\n+\n+    static int asInteger(Object value, String propertyName) {\n+        if (value instanceof Integer) {\n+            return (int) value;\n+        }\n+        throw new JSONParserException(\"Invalid int value '\" + value + \"' for element '\" + propertyName + \"'\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTgyOTU0NA==", "bodyText": "Why are the changes in this class needed when there is ConfigurationDynamicClass?", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609829544", "createdAt": "2021-04-08T15:33:46Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.configure/src/com/oracle/svm/configure/config/ConfigurationType.java", "diffHunk": "@@ -49,6 +49,8 @@\n     private boolean allDeclaredConstructors;\n     private boolean allPublicConstructors;\n \n+    private int dynamicClassChecksum = 0;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTgzMjYxOA==", "bodyText": "Misses checks for extraneous items.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609832618", "createdAt": "2021-04-08T15:36:40Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/configure/DynamicClassLoadingConfigurationParser.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright (c) 2020, 2020, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2020, Alibaba Group Holding Limited. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.core.configure;\n+\n+import com.oracle.svm.core.util.json.JSONParser;\n+\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.util.Map;\n+\n+public class DynamicClassLoadingConfigurationParser extends ConfigurationParser {\n+\n+    DynamicClassLoadingParserFunction function;\n+\n+    public DynamicClassLoadingConfigurationParser(DynamicClassLoadingParserFunction function) {\n+        this.function = function;\n+    }\n+\n+    @Override\n+    public void parseAndRegister(Reader reader) throws IOException {\n+        JSONParser parser = new JSONParser(reader);\n+        Object json = parser.parse();\n+        for (Object dynamicDefinedClass : asList(json, \"first level of document must be an array of dynamic defined classes\")) {\n+            Map<String, Object> data = asMap(dynamicDefinedClass, \"second level of document must be dynamic defined class descriptor objects \");\n+            String definedClassName = asString(data.get(\"name\"));\n+            String dumpedFileName = asString(data.get(\"classFile\"));\n+            String checksum = asString(data.get(\"checksum\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTg0Njc0NQ==", "bodyText": "What about other characters that are valid in a class name, but not in the file system, or limits for file name or path lengths? This should be more defensive and handle having more than one class with the same name.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609846745", "createdAt": "2021-04-08T15:51:30Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.configure/src/com/oracle/svm/configure/config/ConfigurationDynamicClass.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright (c) 2020, 2020, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2020, Alibaba Group Holding Limited. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.configure.config;\n+\n+import com.oracle.svm.configure.json.JsonPrintable;\n+import com.oracle.svm.configure.json.JsonWriter;\n+import com.oracle.svm.core.configure.ConfigurationFiles;\n+\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+public final class ConfigurationDynamicClass implements JsonPrintable {\n+\n+    private final String qualifiedJavaName;\n+    private final String checksum;\n+    private final String classFile;\n+    private final byte[] classContents;\n+\n+    public static ConfigurationDynamicClass newTraceTimeConfig(String qualifiedJavaName, String checksum, byte[] classContents) {\n+        return new ConfigurationDynamicClass(qualifiedJavaName, checksum, null, classContents);\n+    }\n+\n+    public static ConfigurationDynamicClass newBuildTImeConfig(String qualifiedJavaName, String checksum, String classFile) {\n+        return new ConfigurationDynamicClass(qualifiedJavaName, checksum, classFile, null);\n+    }\n+\n+    private ConfigurationDynamicClass(String qualifiedJavaName, String checksum, String classFile, byte[] classContents) {\n+        assert qualifiedJavaName.indexOf('/') == -1 : \"Requires qualified Java name, not internal representation\";\n+        assert !qualifiedJavaName.startsWith(\"[\") : \"Requires Java source array syntax, for example java.lang.String[]\";\n+        this.qualifiedJavaName = qualifiedJavaName;\n+        this.checksum = checksum;\n+        this.classContents = classContents;\n+        this.classFile = classFile;\n+    }\n+\n+    public boolean contains(String definedClassName, String checksum2Match) {\n+        return definedClassName != null && definedClassName.equals(qualifiedJavaName) && checksum2Match.equals(this.checksum);\n+    }\n+\n+    @Override\n+    public void printJson(JsonWriter writer) throws IOException {\n+        // Mangle class' qualified name into a system independent format\n+        String internalName = qualifiedJavaName.replace(\".\", ConfigurationFiles.MANGLE_SLASH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTg0OTExNw==", "bodyText": "Dead code?", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609849117", "createdAt": "2021-04-08T15:53:56Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.configure/src/com/oracle/svm/configure/trace/ReflectionProcessor.java", "diffHunk": "@@ -247,6 +247,11 @@ public void processEntry(Map<String, ?> entry) {\n                 resourceConfiguration.addBundle((String) args.get(2));\n                 break;\n             }\n+            case \"checksum\": {\n+                expectSize(args, 1);\n+                configuration.getOrCreateType(clazzOrDeclaringClass).setDynamicClassChecksum((Integer) args.get(0));\n+                break;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTg1MDEyOQ==", "bodyText": "Why not simply static methods?", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609850129", "createdAt": "2021-04-08T15:55:09Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/jdk/Target_java_lang_ClassLoader.java", "diffHunk": "@@ -526,3 +539,47 @@ public Object transform(MetaAccessProvider metaAccess, ResolvedJavaField origina\n         }\n     }\n }\n+\n+final class ClassLoaderHelper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTg1MzI5Nw==", "bodyText": "What's the reason behind not supporting this? Can't we set the protection domain on the class object (e.g. indirectly through a map), or ignore it? Or is this some esoteric case?", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609853297", "createdAt": "2021-04-08T15:58:23Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/jdk/Target_java_lang_ClassLoader.java", "diffHunk": "@@ -414,21 +416,32 @@ private void clearAssertionStatus() {\n     private static native void registerNatives();\n \n     @Substitute\n-    @SuppressWarnings({\"unused\", \"static-method\"})\n-    private Class<?> defineClass(String name, byte[] b, int off, int len) {\n-        throw VMError.unsupportedFeature(\"Defining classes from new bytecodes run time.\");\n+    @SuppressWarnings(\"unused\")\n+    Class<?> defineClass(String name, byte[] b, int off, int len)\n+                    throws ClassFormatError {\n+        try {\n+            ClassLoaderHelper helper = new ClassLoaderHelper(b, name);\n+            // Verify the runtime class is the same as previously prepared by byte array hashcode\n+            helper.verifyClassUnchanged();\n+            return helper.doDefineClass();\n+        } catch (IOException e) {\n+            ClassFormatError error = new ClassFormatError(\"Can't get class info \" +\n+                            \"from provided byte array.\");\n+            error.initCause(e);\n+            throw error;\n+        }\n     }\n \n     @Substitute\n-    @SuppressWarnings({\"unused\", \"static-method\"})\n+    @SuppressWarnings(\"unused\")\n     private Class<?> defineClass(String name, byte[] b, int off, int len, ProtectionDomain protectionDomain) {\n-        throw VMError.unsupportedFeature(\"Defining classes from new bytecodes run time.\");\n+        throw VMError.unsupportedFeature(\"Define class with protection domain is not supported\");\n     }\n \n     @Substitute\n-    @SuppressWarnings({\"unused\", \"static-method\"})\n+    @SuppressWarnings(\"unused\")\n     private Class<?> defineClass(String name, java.nio.ByteBuffer b, ProtectionDomain protectionDomain) {\n-        throw VMError.unsupportedFeature(\"Defining classes from new bytecodes run time.\");\n+        throw VMError.unsupportedFeature(\"Define class with protection domain is not supported\");\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTg1ODI0NA==", "bodyText": "The hash code should be kept in a compact byte array (should be converted during parsing).", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609858244", "createdAt": "2021-04-08T16:03:44Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/hub/ClassForNameSupport.java", "diffHunk": "@@ -41,12 +41,19 @@ static ClassForNameSupport singleton() {\n \n     /** The map used to collect registered classes. */\n     private final EconomicMap<String, Class<?>> knownClasses = ImageHeapMap.create();\n+    private final EconomicMap<String, String> dynamicGeneratedClasses = ImageHeapMap.create();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTg2NDA5Nw==", "bodyText": "Needs proper rethrowing.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609864097", "createdAt": "2021-04-08T16:09:39Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.reflect/src/com/oracle/svm/reflect/dynamicclassloading/hosted/DynamicClassLoadingFeature.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ * Copyright (c) 2020, 2020, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Alibaba Group Holding Limited. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.reflect.dynamicclassloading.hosted;\n+\n+// Checkstyle: allow reflection\n+\n+import com.oracle.svm.core.annotate.AutomaticFeature;\n+import com.oracle.svm.core.c.libc.TemporaryBuildDirectoryProvider;\n+import com.oracle.svm.core.configure.ConfigurationFiles;\n+import com.oracle.svm.core.configure.DynamicClassLoadingConfigurationParser;\n+import com.oracle.svm.core.hub.ClassForNameSupport;\n+import com.oracle.svm.core.util.UserError;\n+import com.oracle.svm.hosted.FeatureImpl;\n+import com.oracle.svm.hosted.ImageClassLoader;\n+import com.oracle.svm.hosted.config.ConfigurationParserUtils;\n+import com.oracle.svm.reflect.MultiClassLoaderReporter;\n+import com.oracle.svm.util.ReflectionUtil;\n+import org.graalvm.nativeimage.ImageSingletons;\n+import org.graalvm.nativeimage.hosted.Feature;\n+\n+import java.io.IOException;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@AutomaticFeature\n+public class DynamicClassLoadingFeature implements Feature {\n+\n+    class DynamicClassContainer {\n+        Class<?> clazz;\n+        String name;\n+        String checksum;\n+\n+        DynamicClassContainer(Class<?> clazz, String name, String checksum) {\n+            this.clazz = clazz;\n+            this.name = name;\n+            this.checksum = checksum;\n+        }\n+    }\n+\n+    private Map<String, DynamicClassContainer> dynamicClassContainers = new HashMap<>();\n+    private List<StringBuilder> errMsgs = new ArrayList<>();\n+\n+    /**\n+     * Reflectively call protected method URLClassLoader.addURL.\n+     *\n+     * @param url url to add into the URLClassLoader\n+     * @param classLoader URLClassLoader instance\n+     */\n+    private static void addURL2URLClassLoader(URL url, URLClassLoader classLoader) {\n+        Method addURL = ReflectionUtil.lookupMethod(URLClassLoader.class, \"addURL\", URL.class);\n+        try {\n+            addURL.invoke(classLoader, url);\n+        } catch (IllegalAccessException e) {\n+            e.printStackTrace();\n+        } catch (InvocationTargetException e) {\n+            e.printStackTrace();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTg2NjY1Mg==", "bodyText": "Not clean and the static field will not work when there is more than one image build in the process (server mode). You might need to add a method to collect the locations and return them so you can use them in the feature's afterRegistration method.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609866652", "createdAt": "2021-04-08T16:12:11Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.hosted/src/com/oracle/svm/hosted/config/ConfigurationParserUtils.java", "diffHunk": "@@ -124,12 +131,14 @@ public boolean tryAdvance(Consumer<? super URL> action) {\n                 throw UserError.abort(\"Could not open %s: %s\", url, e.getMessage());\n             }\n         }).sum();\n-\n         return parsedCount;\n     }\n \n     private static void doParseAndRegister(ConfigurationParser parser, Reader reader, String featureName, Object location, HostedOptionKey<LocatableMultiOptionValue.Strings> option) {\n         try {\n+            if (featureName.equals(\"dynamicClassLoading\") && location instanceof URL) {\n+                dynamicClassLoadingDirs.add((URL) location);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTg4MDM5Ng==", "bodyText": "Assuming that the image class loader is a URLClassLoader and manipulating it through reflection does not seem like a good idea at all (especially with the module system). These steps need proper support in ImageClassLoader and AbstractNativeImageClassLoaderSupport and its subclasses and that probably entail creating a ClassLoader subclass for these purposes.\nMoreover it seems very roundabout and not safe to reconstruct a class directory hierarchy, add it to the loader's class path (which potentially) and load the class from there. Is it not possible to just load the class from a byte array with the file's contents (other than that we need to call defineClass somehow)?\nThis really needs fixing.", "url": "https://github.com/oracle/graal/pull/2442#discussion_r609880396", "createdAt": "2021-04-08T16:27:18Z", "author": {"login": "peter-hofer"}, "path": "substratevm/src/com.oracle.svm.reflect/src/com/oracle/svm/reflect/dynamicclassloading/hosted/DynamicClassLoadingFeature.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ * Copyright (c) 2020, 2020, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Alibaba Group Holding Limited. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package com.oracle.svm.reflect.dynamicclassloading.hosted;\n+\n+// Checkstyle: allow reflection\n+\n+import com.oracle.svm.core.annotate.AutomaticFeature;\n+import com.oracle.svm.core.c.libc.TemporaryBuildDirectoryProvider;\n+import com.oracle.svm.core.configure.ConfigurationFiles;\n+import com.oracle.svm.core.configure.DynamicClassLoadingConfigurationParser;\n+import com.oracle.svm.core.hub.ClassForNameSupport;\n+import com.oracle.svm.core.util.UserError;\n+import com.oracle.svm.hosted.FeatureImpl;\n+import com.oracle.svm.hosted.ImageClassLoader;\n+import com.oracle.svm.hosted.config.ConfigurationParserUtils;\n+import com.oracle.svm.reflect.MultiClassLoaderReporter;\n+import com.oracle.svm.util.ReflectionUtil;\n+import org.graalvm.nativeimage.ImageSingletons;\n+import org.graalvm.nativeimage.hosted.Feature;\n+\n+import java.io.IOException;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+@AutomaticFeature\n+public class DynamicClassLoadingFeature implements Feature {\n+\n+    class DynamicClassContainer {\n+        Class<?> clazz;\n+        String name;\n+        String checksum;\n+\n+        DynamicClassContainer(Class<?> clazz, String name, String checksum) {\n+            this.clazz = clazz;\n+            this.name = name;\n+            this.checksum = checksum;\n+        }\n+    }\n+\n+    private Map<String, DynamicClassContainer> dynamicClassContainers = new HashMap<>();\n+    private List<StringBuilder> errMsgs = new ArrayList<>();\n+\n+    /**\n+     * Reflectively call protected method URLClassLoader.addURL.\n+     *\n+     * @param url url to add into the URLClassLoader\n+     * @param classLoader URLClassLoader instance\n+     */\n+    private static void addURL2URLClassLoader(URL url, URLClassLoader classLoader) {\n+        Method addURL = ReflectionUtil.lookupMethod(URLClassLoader.class, \"addURL\", URL.class);\n+        try {\n+            addURL.invoke(classLoader, url);\n+        } catch (IllegalAccessException e) {\n+            e.printStackTrace();\n+        } catch (InvocationTargetException e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    /**\n+     * Reflectively call protected method URLClassLoader.findClass.\n+     *\n+     * @param name target class name\n+     * @param classLoader\n+     * @return the class found with the given name\n+     * @throws ClassNotFoundException\n+     */\n+    private static Class<?> callFindClass(String name, URLClassLoader classLoader) throws ClassNotFoundException {\n+        Method findClass = ReflectionUtil.lookupMethod(URLClassLoader.class, \"findClass\", String.class);\n+        try {\n+            return (Class<?>) findClass.invoke(classLoader, name);\n+        } catch (IllegalAccessException | InvocationTargetException e) {\n+            throw new ClassNotFoundException(name);\n+        }\n+    }\n+\n+    @Override\n+    public void afterRegistration(AfterRegistrationAccess a) {\n+        FeatureImpl.AfterRegistrationAccessImpl access = (FeatureImpl.AfterRegistrationAccessImpl) a;\n+        ImageClassLoader imageClassLoader = access.getImageClassLoader();\n+        URLClassLoader cl = (URLClassLoader) imageClassLoader.getClassLoader();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d"}, "originalPosition": 113}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98f80147901082a822f76dde76af757036aad82d", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/98f80147901082a822f76dde76af757036aad82d", "committedDate": "2021-03-26T05:06:55Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "2630b3fbf35e32d79fb7e95c7139b33a23cd627f", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/2630b3fbf35e32d79fb7e95c7139b33a23cd627f", "committedDate": "2021-04-12T13:01:07Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2630b3fbf35e32d79fb7e95c7139b33a23cd627f", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/2630b3fbf35e32d79fb7e95c7139b33a23cd627f", "committedDate": "2021-04-12T13:01:07Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "1fdbdb6a38fb769a6df61ddf0ab89785c65749f4", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/1fdbdb6a38fb769a6df61ddf0ab89785c65749f4", "committedDate": "2021-04-13T04:06:26Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fdbdb6a38fb769a6df61ddf0ab89785c65749f4", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/1fdbdb6a38fb769a6df61ddf0ab89785c65749f4", "committedDate": "2021-04-13T04:06:26Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "411191cb052afe6d3636d92a3bf77d5437cf6d01", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/411191cb052afe6d3636d92a3bf77d5437cf6d01", "committedDate": "2021-04-13T12:00:18Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "411191cb052afe6d3636d92a3bf77d5437cf6d01", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/411191cb052afe6d3636d92a3bf77d5437cf6d01", "committedDate": "2021-04-13T12:00:18Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "a062142e38b1df96eb2a6275815b048fdc442fb6", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/a062142e38b1df96eb2a6275815b048fdc442fb6", "committedDate": "2021-04-13T12:52:40Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a062142e38b1df96eb2a6275815b048fdc442fb6", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/a062142e38b1df96eb2a6275815b048fdc442fb6", "committedDate": "2021-04-13T12:52:40Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "132bac9be8dc02b044a6f3f59bbd539b98365e37", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/132bac9be8dc02b044a6f3f59bbd539b98365e37", "committedDate": "2021-04-14T02:34:36Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "132bac9be8dc02b044a6f3f59bbd539b98365e37", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/132bac9be8dc02b044a6f3f59bbd539b98365e37", "committedDate": "2021-04-14T02:34:36Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "74f64421fbb065fc73b718066112d0becb826b10", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/74f64421fbb065fc73b718066112d0becb826b10", "committedDate": "2021-04-14T03:26:35Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a13778c14da682910b87ad1d64fe12b2aec4c56c", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/a13778c14da682910b87ad1d64fe12b2aec4c56c", "committedDate": "2021-04-14T04:08:47Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74f64421fbb065fc73b718066112d0becb826b10", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/74f64421fbb065fc73b718066112d0becb826b10", "committedDate": "2021-04-14T03:26:35Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}, "afterCommit": {"oid": "a13778c14da682910b87ad1d64fe12b2aec4c56c", "author": {"user": {"login": "ziyilin", "name": null}}, "url": "https://github.com/oracle/graal/commit/a13778c14da682910b87ad1d64fe12b2aec4c56c", "committedDate": "2021-04-14T04:08:47Z", "message": "Support dynamic class loading\n\nSupport dynamic class loading for native image"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 996, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}