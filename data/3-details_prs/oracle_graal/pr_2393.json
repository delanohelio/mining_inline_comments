{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NjQxMTc5", "number": 2393, "title": "Provide java.lang.Terminator.setup() via --install-exit-handlers", "bodyText": "This PR provides a fix for #1592\nTesting with\npublic class Main {\n    public static void main(String[] args) {\n        Runtime.getRuntime().addShutdownHook(new Thread(() -> {\n            System.out.println(\"Shutdown happens!\");\n        }));\n        \n        try {\n            System.out.println(\"Zzzzzzz.....\");\n            Thread.sleep(Long.MAX_VALUE);\n        } catch (InterruptedException e) {\n            System.out.println(\"Good morning!\");\n            e.printStackTrace();\n        }\n    }\n}\nshows an image size increase of 48Kb when native-image --install-exit-handlers is used (from 6,802,048 bytes to 6,850,976 bytes)", "createdAt": "2020-04-24T16:12:30Z", "url": "https://github.com/oracle/graal/pull/2393", "merged": true, "mergeCommit": {"oid": "2cd8551d7b885257d671f60438e015193c7bd1a0"}, "closed": true, "closedAt": "2020-04-27T20:49:43Z", "author": {"login": "olpaw"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABca0kZgAFqTQwMDEyMDI4OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbxhSugFqTQwMTEwMDgwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMTIwMjg4", "url": "https://github.com/oracle/graal/pull/2393#pullrequestreview-400120288", "createdAt": "2020-04-24T17:02:10Z", "commit": {"oid": "0d3abfb616196f32cbe5d93fbd359541a4ea5ee8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzowMjoxMFrOGLg5yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzowMjo0M1rOGLg7KA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyNjYwMg==", "bodyText": "Why does that not work the same way on Windows too?", "url": "https://github.com/oracle/graal/pull/2393#discussion_r414726602", "createdAt": "2020-04-24T17:02:10Z", "author": {"login": "christianwimmer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -133,6 +135,12 @@ public static int runCore(int paramArgc, CCharPointerPointer paramArgv) {\n         int exitCode;\n         try {\n             if (SubstrateOptions.ParseRuntimeOptions.getValue()) {\n+                if (SubstrateUtil.isPosix()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3abfb616196f32cbe5d93fbd359541a4ea5ee8"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyNjc2Ng==", "bodyText": "but the check for || (SubstrateUtil.isLinux() && ProcessProperties.getProcessId() == 1) is missing here? Otherwise how do we get out-of-the-box correct handling for the Docker init process?", "url": "https://github.com/oracle/graal/pull/2393#discussion_r414726766", "createdAt": "2020-04-24T17:02:25Z", "author": {"login": "christianwimmer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -133,6 +135,12 @@ public static int runCore(int paramArgc, CCharPointerPointer paramArgv) {\n         int exitCode;\n         try {\n             if (SubstrateOptions.ParseRuntimeOptions.getValue()) {\n+                if (SubstrateUtil.isPosix()) {\n+                    if (SubstrateOptions.InstallExitHandlers.getValue()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3abfb616196f32cbe5d93fbd359541a4ea5ee8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyNjk1Mg==", "bodyText": "Having a platform specific API option complicates all sorts of build scripts, so I think we should avoid that in general.", "url": "https://github.com/oracle/graal/pull/2393#discussion_r414726952", "createdAt": "2020-04-24T17:02:43Z", "author": {"login": "christianwimmer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/SubstrateOptions.java", "diffHunk": "@@ -425,6 +425,11 @@ public static boolean useLLVMBackend() {\n     @Option(help = \"Show native-toolchain information and image-build settings\", type = User)//\n     public static final HostedOptionKey<Boolean> DumpTargetInfo = new HostedOptionKey<>(false);\n \n+    @Platforms({Platform.LINUX.class, Platform.DARWIN.class})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3abfb616196f32cbe5d93fbd359541a4ea5ee8"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3957f15546164430a8656b0607903e6170d1d40b", "author": {"user": {"login": "olpaw", "name": "Paul Woegerer"}}, "url": "https://github.com/oracle/graal/commit/3957f15546164430a8656b0607903e6170d1d40b", "committedDate": "2020-04-27T12:42:01Z", "message": "Provide java.lang.Terminator.setup() as --install-exit-handlers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwOTU3Mjk1", "url": "https://github.com/oracle/graal/pull/2393#pullrequestreview-400957295", "createdAt": "2020-04-27T13:35:49Z", "commit": {"oid": "3957f15546164430a8656b0607903e6170d1d40b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzozNTo1MFrOGMjgfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzozNjoxN1rOGMjhtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgxNzg1Mg==", "bodyText": "For this to work on JDK 11 (handler field changed type) you could declare it as:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static Target_jdk_internal_misc_Signal_Handler handler;\n          \n          \n            \n                private static Object handler;", "url": "https://github.com/oracle/graal/pull/2393#discussion_r415817852", "createdAt": "2020-04-27T13:35:50Z", "author": {"login": "pejovica"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -287,3 +295,16 @@ public static void enter(int paramArgc, CCharPointerPointer paramArgv) {\n         void setArgv(CCharPointerPointer value);\n     }\n }\n+\n+@TargetClass(className = \"java.lang.Terminator\")\n+final class Target_java_lang_Terminator {\n+    @Alias @RecomputeFieldValue(kind = RecomputeFieldValue.Kind.Reset) //\n+    private static Target_jdk_internal_misc_Signal_Handler handler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3957f15546164430a8656b0607903e6170d1d40b"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgxODE2NA==", "bodyText": "Maybe you should register a startup hook instead.", "url": "https://github.com/oracle/graal/pull/2393#discussion_r415818164", "createdAt": "2020-04-27T13:36:17Z", "author": {"login": "pejovica"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -133,6 +137,10 @@ public static int runCore(int paramArgc, CCharPointerPointer paramArgv) {\n         int exitCode;\n         try {\n             if (SubstrateOptions.ParseRuntimeOptions.getValue()) {\n+                if (SubstrateOptions.InstallExitHandlers.getValue()) {\n+                    Target_java_lang_Terminator.setup();\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3957f15546164430a8656b0607903e6170d1d40b"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bebeb45724956f33357ff14caf63fec5757f0ce", "author": {"user": {"login": "olpaw", "name": "Paul Woegerer"}}, "url": "https://github.com/oracle/graal/commit/6bebeb45724956f33357ff14caf63fec5757f0ce", "committedDate": "2020-04-27T14:26:17Z", "message": "Use rerunClassInit for java.lang.Terminator instead of @RecomputeFieldValue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec15571605e2cf13390133e908dea82b7884654e", "author": {"user": {"login": "olpaw", "name": "Paul Woegerer"}}, "url": "https://github.com/oracle/graal/commit/ec15571605e2cf13390133e908dea82b7884654e", "committedDate": "2020-04-27T14:46:30Z", "message": "Use StartupHook for running java.lang.Terminator.setup()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMDY0OTI2", "url": "https://github.com/oracle/graal/pull/2393#pullrequestreview-401064926", "createdAt": "2020-04-27T15:26:54Z", "commit": {"oid": "ec15571605e2cf13390133e908dea82b7884654e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTAwODAw", "url": "https://github.com/oracle/graal/pull/2393#pullrequestreview-401100800", "createdAt": "2020-04-27T16:03:45Z", "commit": {"oid": "ec15571605e2cf13390133e908dea82b7884654e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1154, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}