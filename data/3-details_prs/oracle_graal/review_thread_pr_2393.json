{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NjQxMTc5", "number": 2393, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzowMjoxMFrOD13nQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzozNjoxN1rOD2r8vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3ODEyMjkwOnYy", "diffSide": "RIGHT", "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzowMjoxMFrOGLg5yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwODo0MDoyOFrOGMXnJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyNjYwMg==", "bodyText": "Why does that not work the same way on Windows too?", "url": "https://github.com/oracle/graal/pull/2393#discussion_r414726602", "createdAt": "2020-04-24T17:02:10Z", "author": {"login": "christianwimmer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -133,6 +135,12 @@ public static int runCore(int paramArgc, CCharPointerPointer paramArgv) {\n         int exitCode;\n         try {\n             if (SubstrateOptions.ParseRuntimeOptions.getValue()) {\n+                if (SubstrateUtil.isPosix()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3abfb616196f32cbe5d93fbd359541a4ea5ee8"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYyMjk0OA==", "bodyText": "I will have a look what the JVM does on Windows and make --install-exit-handlers behave the same. Then this is no more posix-only.", "url": "https://github.com/oracle/graal/pull/2393#discussion_r415622948", "createdAt": "2020-04-27T08:40:28Z", "author": {"login": "olpaw"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -133,6 +135,12 @@ public static int runCore(int paramArgc, CCharPointerPointer paramArgv) {\n         int exitCode;\n         try {\n             if (SubstrateOptions.ParseRuntimeOptions.getValue()) {\n+                if (SubstrateUtil.isPosix()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyNjYwMg=="}, "originalCommit": {"oid": "0d3abfb616196f32cbe5d93fbd359541a4ea5ee8"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3ODEyMzg1OnYy", "diffSide": "RIGHT", "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzowMjoyNVrOGLg6bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoxMzo1NVrOGMrqNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyNjc2Ng==", "bodyText": "but the check for || (SubstrateUtil.isLinux() && ProcessProperties.getProcessId() == 1) is missing here? Otherwise how do we get out-of-the-box correct handling for the Docker init process?", "url": "https://github.com/oracle/graal/pull/2393#discussion_r414726766", "createdAt": "2020-04-24T17:02:25Z", "author": {"login": "christianwimmer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -133,6 +135,12 @@ public static int runCore(int paramArgc, CCharPointerPointer paramArgv) {\n         int exitCode;\n         try {\n             if (SubstrateOptions.ParseRuntimeOptions.getValue()) {\n+                if (SubstrateUtil.isPosix()) {\n+                    if (SubstrateOptions.InstallExitHandlers.getValue()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3abfb616196f32cbe5d93fbd359541a4ea5ee8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYyMTIxNg==", "bodyText": "I decided against making the installation of the handlers dependent on  ProcessProperties.getProcessId() == 1.\nI tested what the JVM does when running in docker and without. Regarding signal handling the JVM makes no distinction whatsoever. So to be as close as possible to the behaviour of the JVM I do not predicate on PID1. Also since we require the user to opt-in via --install-exit-handlers there should be no regressions for anyone not interested in having this JVM-like behaviour for SIGHUP/SIGINT/SIGTERM exit handling.", "url": "https://github.com/oracle/graal/pull/2393#discussion_r415621216", "createdAt": "2020-04-27T08:37:56Z", "author": {"login": "olpaw"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -133,6 +135,12 @@ public static int runCore(int paramArgc, CCharPointerPointer paramArgv) {\n         int exitCode;\n         try {\n             if (SubstrateOptions.ParseRuntimeOptions.getValue()) {\n+                if (SubstrateUtil.isPosix()) {\n+                    if (SubstrateOptions.InstallExitHandlers.getValue()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyNjc2Ng=="}, "originalCommit": {"oid": "0d3abfb616196f32cbe5d93fbd359541a4ea5ee8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1MTQxNA==", "bodyText": "OK. Having a different automatic behavior when running as Docker pid 1 is probably a bad idea.", "url": "https://github.com/oracle/graal/pull/2393#discussion_r415951414", "createdAt": "2020-04-27T16:13:55Z", "author": {"login": "christianwimmer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -133,6 +135,12 @@ public static int runCore(int paramArgc, CCharPointerPointer paramArgv) {\n         int exitCode;\n         try {\n             if (SubstrateOptions.ParseRuntimeOptions.getValue()) {\n+                if (SubstrateUtil.isPosix()) {\n+                    if (SubstrateOptions.InstallExitHandlers.getValue()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyNjc2Ng=="}, "originalCommit": {"oid": "0d3abfb616196f32cbe5d93fbd359541a4ea5ee8"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3ODEyNTAzOnYy", "diffSide": "RIGHT", "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/SubstrateOptions.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzowMjo0M1rOGLg7KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwODo0MTo1M1rOGMXrSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyNjk1Mg==", "bodyText": "Having a platform specific API option complicates all sorts of build scripts, so I think we should avoid that in general.", "url": "https://github.com/oracle/graal/pull/2393#discussion_r414726952", "createdAt": "2020-04-24T17:02:43Z", "author": {"login": "christianwimmer"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/SubstrateOptions.java", "diffHunk": "@@ -425,6 +425,11 @@ public static boolean useLLVMBackend() {\n     @Option(help = \"Show native-toolchain information and image-build settings\", type = User)//\n     public static final HostedOptionKey<Boolean> DumpTargetInfo = new HostedOptionKey<>(false);\n \n+    @Platforms({Platform.LINUX.class, Platform.DARWIN.class})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3abfb616196f32cbe5d93fbd359541a4ea5ee8"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYyNDAwOQ==", "bodyText": "I agree. Also providing proper behaviour for Windows will make this use of @Platforms obsolete. See #2393 (comment)", "url": "https://github.com/oracle/graal/pull/2393#discussion_r415624009", "createdAt": "2020-04-27T08:41:53Z", "author": {"login": "olpaw"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/SubstrateOptions.java", "diffHunk": "@@ -425,6 +425,11 @@ public static boolean useLLVMBackend() {\n     @Option(help = \"Show native-toolchain information and image-build settings\", type = User)//\n     public static final HostedOptionKey<Boolean> DumpTargetInfo = new HostedOptionKey<>(false);\n \n+    @Platforms({Platform.LINUX.class, Platform.DARWIN.class})", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcyNjk1Mg=="}, "originalCommit": {"oid": "0d3abfb616196f32cbe5d93fbd359541a4ea5ee8"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4NjY5NTUyOnYy", "diffSide": "RIGHT", "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzozNTo1MFrOGMjgfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNDoyNzozNFrOGMmEng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgxNzg1Mg==", "bodyText": "For this to work on JDK 11 (handler field changed type) you could declare it as:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static Target_jdk_internal_misc_Signal_Handler handler;\n          \n          \n            \n                private static Object handler;", "url": "https://github.com/oracle/graal/pull/2393#discussion_r415817852", "createdAt": "2020-04-27T13:35:50Z", "author": {"login": "pejovica"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -287,3 +295,16 @@ public static void enter(int paramArgc, CCharPointerPointer paramArgv) {\n         void setArgv(CCharPointerPointer value);\n     }\n }\n+\n+@TargetClass(className = \"java.lang.Terminator\")\n+final class Target_java_lang_Terminator {\n+    @Alias @RecomputeFieldValue(kind = RecomputeFieldValue.Kind.Reset) //\n+    private static Target_jdk_internal_misc_Signal_Handler handler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3957f15546164430a8656b0607903e6170d1d40b"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg1OTg3MA==", "bodyText": "Nahh, that doesn't work.\nError: Type mismatch:\n    class java.lang.Object private static java.lang.Object com.oracle.svm.core.Target_java_lang_Terminator.handler\n    interface jdk.internal.misc.Signal$Handler private static jdk.internal.misc.Signal$Handler java.lang.Terminator.handler\n\nInstead it's much easier to use: 6bebeb4", "url": "https://github.com/oracle/graal/pull/2393#discussion_r415859870", "createdAt": "2020-04-27T14:27:34Z", "author": {"login": "olpaw"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -287,3 +295,16 @@ public static void enter(int paramArgc, CCharPointerPointer paramArgv) {\n         void setArgv(CCharPointerPointer value);\n     }\n }\n+\n+@TargetClass(className = \"java.lang.Terminator\")\n+final class Target_java_lang_Terminator {\n+    @Alias @RecomputeFieldValue(kind = RecomputeFieldValue.Kind.Reset) //\n+    private static Target_jdk_internal_misc_Signal_Handler handler;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgxNzg1Mg=="}, "originalCommit": {"oid": "3957f15546164430a8656b0607903e6170d1d40b"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4NjY5NzU5OnYy", "diffSide": "RIGHT", "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMzozNjoxN1rOGMjhtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNDo1MDoxN1rOGMnRXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgxODE2NA==", "bodyText": "Maybe you should register a startup hook instead.", "url": "https://github.com/oracle/graal/pull/2393#discussion_r415818164", "createdAt": "2020-04-27T13:36:17Z", "author": {"login": "pejovica"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -133,6 +137,10 @@ public static int runCore(int paramArgc, CCharPointerPointer paramArgv) {\n         int exitCode;\n         try {\n             if (SubstrateOptions.ParseRuntimeOptions.getValue()) {\n+                if (SubstrateOptions.InstallExitHandlers.getValue()) {\n+                    Target_java_lang_Terminator.setup();\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3957f15546164430a8656b0607903e6170d1d40b"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg3OTUxNw==", "bodyText": "I agree: ec15571", "url": "https://github.com/oracle/graal/pull/2393#discussion_r415879517", "createdAt": "2020-04-27T14:50:17Z", "author": {"login": "olpaw"}, "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/JavaMainWrapper.java", "diffHunk": "@@ -133,6 +137,10 @@ public static int runCore(int paramArgc, CCharPointerPointer paramArgv) {\n         int exitCode;\n         try {\n             if (SubstrateOptions.ParseRuntimeOptions.getValue()) {\n+                if (SubstrateOptions.InstallExitHandlers.getValue()) {\n+                    Target_java_lang_Terminator.setup();\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgxODE2NA=="}, "originalCommit": {"oid": "3957f15546164430a8656b0607903e6170d1d40b"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 874, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}