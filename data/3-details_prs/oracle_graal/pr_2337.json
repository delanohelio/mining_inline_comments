{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxOTcwMTkz", "number": 2337, "title": "Allow building with OpenJDK 11u and vendor jlink plugins", "bodyText": "With JDK-8232080 in progress of being backported to OpenJDK 11u the graal CE build with native image support is bound to fail. Failure looks like:\n[Creating JDK image in /disk/graal/upstream-sources/graal/sdk/mxbuild/linux-amd64/graalvm-jimage]\n/disk/openjdk/upstream-sources/openjdk-11-dev/build/linux-x86_64-normal-server-release/images/graal-builder-jdk/bin/jlink --add-modules=com.oracle.graal.graal_enterprise,java.base,java.compiler,java.datatransfer,java.desktop,java.instrument,java.logging,java.management,java.management.rmi,java.naming,java.net.http,java.prefs,java.rmi,java.scripting,java.se,java.security.jgss,java.security.sasl,java.smartcardio,java.sql,java.sql.rowset,java.transaction.xa,java.xml,java.xml.crypto,jdk.accessibility,jdk.aot,jdk.attach,jdk.charsets,jdk.compiler,jdk.crypto.cryptoki,jdk.crypto.ec,jdk.dynalink,jdk.editpad,jdk.hotspot.agent,jdk.httpserver,jdk.internal.ed,jdk.internal.jvmstat,jdk.internal.le,jdk.internal.opt,jdk.internal.vm.ci,jdk.internal.vm.compiler,jdk.internal.vm.compiler.management,jdk.internal.vm.compiler.truffle.jfr,jdk.jartool,jdk.javadoc,jdk.jcmd,jdk.jconsole,jdk.jdeps,jdk.jdi,jdk.jdwp.agent,jdk.jfr,jdk.jlink,jdk.jshell,jdk.jsobject,jdk.jstatd,jdk.localedata,jdk.management,jdk.management.agent,jdk.management.jfr,jdk.naming.dns,jdk.naming.rmi,jdk.net,jdk.pack,jdk.rmic,jdk.scripting.nashorn,jdk.scripting.nashorn.shell,jdk.sctp,jdk.security.auth,jdk.security.jgss,jdk.unsupported,jdk.unsupported.desktop,jdk.xml.dom,jdk.zipfs,org.graalvm.locator,org.graalvm.sdk,org.graalvm.truffle --module-path=/disk/graal/upstream-sources/graal/compiler/mxbuild/dists/jdk11/jdk.internal.vm.compiler.truffle.jfr.jmod:/disk/graal/upstream-sources/graal/sdk/mxbuild/dists/jdk11/org.graalvm.sdk.jmod:/disk/graal/upstream-sources/graal/truffle/mxbuild/dists/jdk11/org.graalvm.truffle.jmod:/disk/graal/upstream-sources/graal/compiler/mxbuild/dists/jdk11/jdk.internal.vm.compiler.jmod:/disk/graal/upstream-sources/graal/truffle/mxbuild/dists/jdk11/org.graalvm.locator.jmod:/disk/graal/upstream-sources/graal/compiler/mxbuild/dists/jdk11/jdk.aot.jmod:/disk/graal/upstream-sources/graal/compiler/mxbuild/dists/jdk11/jdk.internal.vm.compiler.management.jmod:/disk/graal/upstream-sources/graal/sdk/mxbuild/linux-amd64/graalvm-jimage.build/com.oracle.graal.graal_enterprise.jmod:/disk/graal/upstream-sources/graal/sdk/mxbuild/linux-amd64/graalvm-jimage.build/java.base.jmod:/disk/openjdk/upstream-sources/openjdk-11-dev/build/linux-x86_64-normal-server-release/images/graal-builder-jdk/jmods --output=/disk/graal/upstream-sources/graal/sdk/mxbuild/linux-amd64/graalvm-jimage -J-XX:+UseSerialGC -J-Xms32M -J-Xmx512M -J-XX:TieredStopAtLevel=1 -J-Dlink.debug=true --dedup-legal-notices=error-if-not-same-content --keep-packaged-modules=/disk/graal/upstream-sources/graal/sdk/mxbuild/linux-amd64/graalvm-jimage/jmods '--add-options=-XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCIProduct -XX:-UnlockExperimentalVMOptions' '--vendor-version=GraalVM 20.1.0-dev'\n[Creating /disk/graal/upstream-sources/graal/sdk/mxbuild/linux-amd64/graalvm-jimage/lib/src.zip]\n[Copying static libraries]\n[Creating CDS shared archive]\n/disk/graal/upstream-sources/graal/sdk/mxbuild/linux-amd64/graalvm-jimage/bin/java -Xshare:dump -Xmx128M -Xms128M\nUnrecognized VM option 'EnableJVMCIProduct'\nError: Could not create the Java Virtual Machine.\nError: A fatal exception has occurred. Program will exit.\n\nCurrently the build implies JDK-8232080 present => -XX:+EnableJVMCIProduct being present too which isn't the case for jdk11u-dev (upcoming 11.0.8).\nI propose to fix this by adding a check whether this JVM option is indeed present, and only use it if so. Thoughts?", "createdAt": "2020-04-10T16:09:42Z", "url": "https://github.com/oracle/graal/pull/2337", "merged": true, "mergeCommit": {"oid": "042f7c0dff6f610130a3c3e2b9599c01c29c8d27"}, "closed": true, "closedAt": "2020-04-15T02:15:06Z", "author": {"login": "jerboaa"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWkNafgFqTM5MTc1OTQ3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXjZyVgBqjMyMzExMDUzMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzU5NDcw", "url": "https://github.com/oracle/graal/pull/2337#pullrequestreview-391759470", "createdAt": "2020-04-11T11:43:38Z", "commit": {"oid": "623e6733604ea8b364704fd1f1583721057cceaf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMTo0MzozOFrOGEMmEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMTo0MzozOFrOGEMmEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA1Mzg0MQ==", "bodyText": "I don't think -XX:ThreadPriorityPolicy is related to -XX:+EnableJVMCIProduct is it?", "url": "https://github.com/oracle/graal/pull/2337#discussion_r407053841", "createdAt": "2020-04-11T11:43:38Z", "author": {"login": "dougxc"}, "path": "sdk/mx.sdk/mx_sdk_vm.py", "diffHunk": "@@ -649,19 +661,22 @@ def jlink_new_jdk(jdk, dst_jdk_dir, module_dists,\n         jlink.append('--keep-packaged-modules=' + join(dst_jdk_dir, 'jmods'))\n \n         if jdk_has_new_jlink_options(jdk):\n-            if jdk_omits_warning_for_jlink_set_ThreadPriorityPolicy(jdk):\n-                thread_priority_policy_option = ' -XX:ThreadPriorityPolicy=1'\n-            else:\n-                mx.logv('[Creating JDK without -XX:ThreadPriorityPolicy=1]')\n-                thread_priority_policy_option = ''\n-\n-            if any((m.name == 'jdk.internal.vm.compiler' for m in modules)):\n-                jlink.append('--add-options=-XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCIProduct -XX:-UnlockExperimentalVMOptions' + thread_priority_policy_option)\n+            if jdk_supports_enablejvmciproduct(jdk):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "623e6733604ea8b364704fd1f1583721057cceaf"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "623e6733604ea8b364704fd1f1583721057cceaf", "author": {"user": {"login": "jerboaa", "name": "Severin Gehwolf"}}, "url": "https://github.com/oracle/graal/commit/623e6733604ea8b364704fd1f1583721057cceaf", "committedDate": "2020-04-10T15:44:46Z", "message": "Allow building with OpenJDK 11u and vendor plugins"}, "afterCommit": {"oid": "5f3f57eec95587494c93744abbbf2c268e2042e4", "author": {"user": {"login": "jerboaa", "name": "Severin Gehwolf"}}, "url": "https://github.com/oracle/graal/commit/5f3f57eec95587494c93744abbbf2c268e2042e4", "committedDate": "2020-04-14T11:46:14Z", "message": "Allow building with OpenJDK 11u and vendor plugins"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyODYyMDg1", "url": "https://github.com/oracle/graal/pull/2337#pullrequestreview-392862085", "createdAt": "2020-04-14T12:07:00Z", "commit": {"oid": "5f3f57eec95587494c93744abbbf2c268e2042e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMjowNzowMVrOGFLd-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMjowNzowMVrOGFLd-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA4Mzk2MA==", "bodyText": "You need the following to make ThreadPriorityPolicy still be applied when EnableJVMCIProduct is not supported :\nif thread_priority_policy_option:\n    jlink.append('--add-options=' + thread_priority_policy_option.strip())", "url": "https://github.com/oracle/graal/pull/2337#discussion_r408083960", "createdAt": "2020-04-14T12:07:01Z", "author": {"login": "dougxc"}, "path": "sdk/mx.sdk/mx_sdk_vm.py", "diffHunk": "@@ -655,13 +667,16 @@ def jlink_new_jdk(jdk, dst_jdk_dir, module_dists,\n                 mx.logv('[Creating JDK without -XX:ThreadPriorityPolicy=1]')\n                 thread_priority_policy_option = ''\n \n-            if any((m.name == 'jdk.internal.vm.compiler' for m in modules)):\n-                jlink.append('--add-options=-XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCIProduct -XX:-UnlockExperimentalVMOptions' + thread_priority_policy_option)\n+            if jdk_supports_enablejvmciproduct(jdk):\n+                if any((m.name == 'jdk.internal.vm.compiler' for m in modules)):\n+                    jlink.append('--add-options=-XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCIProduct -XX:-UnlockExperimentalVMOptions' + thread_priority_policy_option)\n+                else:\n+                    # Don't default to using JVMCI as JIT unless Graal is being updated in the image.\n+                    # This avoids unexpected issues with using the out-of-date Graal compiler in\n+                    # the JDK itself.\n+                    jlink.append('--add-options=-XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCIProduct -XX:-UseJVMCICompiler -XX:-UnlockExperimentalVMOptions' + thread_priority_policy_option)\n             else:\n-                # Don't default to using JVMCI as JIT unless Graal is being updated in the image.\n-                # This avoids unexpected issues with using the out-of-date Graal compiler in\n-                # the JDK itself.\n-                jlink.append('--add-options=-XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCIProduct -XX:-UseJVMCICompiler -XX:-UnlockExperimentalVMOptions' + thread_priority_policy_option)\n+                mx.logv('[Creating JDK without -XX:+EnableJVMCIProduct]')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f3f57eec95587494c93744abbbf2c268e2042e4"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b5486779de863c5b153408b8cf923436f75c6e4", "author": {"user": {"login": "jerboaa", "name": "Severin Gehwolf"}}, "url": "https://github.com/oracle/graal/commit/5b5486779de863c5b153408b8cf923436f75c6e4", "committedDate": "2020-04-14T13:20:25Z", "message": "Allow building with OpenJDK 11u and vendor plugins"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f3f57eec95587494c93744abbbf2c268e2042e4", "author": {"user": {"login": "jerboaa", "name": "Severin Gehwolf"}}, "url": "https://github.com/oracle/graal/commit/5f3f57eec95587494c93744abbbf2c268e2042e4", "committedDate": "2020-04-14T11:46:14Z", "message": "Allow building with OpenJDK 11u and vendor plugins"}, "afterCommit": {"oid": "5b5486779de863c5b153408b8cf923436f75c6e4", "author": {"user": {"login": "jerboaa", "name": "Severin Gehwolf"}}, "url": "https://github.com/oracle/graal/commit/5b5486779de863c5b153408b8cf923436f75c6e4", "committedDate": "2020-04-14T13:20:25Z", "message": "Allow building with OpenJDK 11u and vendor plugins"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1131, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}