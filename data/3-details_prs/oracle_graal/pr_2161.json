{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2OTU0NDI2", "number": 2161, "title": "optimize hash switch generation", "bodyText": "Problem\nThe hash function generation introduced by #895 has a few problems:\n\nThe function generation is slow and doesn't scale well when there are many hash switches\nThe cardinality of the functions is normally too high so the hash switch is very rarely selected\nIt often returns empty if the keys don't follow a pattern\n\nSolution\nI started optimizing the hash function generation and observed a pattern. The most successful functions were the ones that involved multiplication by a prime number. That led me to a simpler approach using just a prime factor and a shift.\nThe new hash function generation returns very fast and covers many more cases than the previous implementation. It can't handle well sets with larger cardinalities but that shouldn't be a problem since the function generation is fast and it would be discarded by LIRGenerator.emitStrategySwitch because of the low density of the table.\nNotes\n\nI removed the test code generation since it was based on the previous functions. I left the test cases because they cover scenarios that are still valid for the new implementation.\nI fixed the JumpTable annotation to reflect the correct size of the entries\nI'm working on a separate change to compile TypeSwitches using the hash table approach. I'm using a LongHasher very similar to the IntHasher and it also works well with memory addresses.", "createdAt": "2020-02-19T04:15:48Z", "url": "https://github.com/oracle/graal/pull/2161", "merged": true, "mergeCommit": {"oid": "161197a67e3725ffeb69121f84d1f6c0b12288f8"}, "closed": true, "closedAt": "2020-03-19T09:05:03Z", "author": {"login": "fwbrasil"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFvOp_gBqjMwNTAyNTc1ODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO60cgABqjMxNDI0ODE0NDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2cf3e615e96294ee01cc259eab43680ed59bde06", "author": {"user": {"login": "fwbrasil", "name": "Flavio W. Brasil"}}, "url": "https://github.com/oracle/graal/commit/2cf3e615e96294ee01cc259eab43680ed59bde06", "committedDate": "2020-02-19T03:58:13Z", "message": "optimize hash switch generation"}, "afterCommit": {"oid": "b3eca4c3446531fe225985119b816017347481f9", "author": {"user": {"login": "fwbrasil", "name": "Flavio W. Brasil"}}, "url": "https://github.com/oracle/graal/commit/b3eca4c3446531fe225985119b816017347481f9", "committedDate": "2020-02-19T04:57:09Z", "message": "optimize hash switch generation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3eca4c3446531fe225985119b816017347481f9", "author": {"user": {"login": "fwbrasil", "name": "Flavio W. Brasil"}}, "url": "https://github.com/oracle/graal/commit/b3eca4c3446531fe225985119b816017347481f9", "committedDate": "2020-02-19T04:57:09Z", "message": "optimize hash switch generation"}, "afterCommit": {"oid": "e839d91d813cc62b089b361504360b5c98697947", "author": {"user": {"login": "fwbrasil", "name": "Flavio W. Brasil"}}, "url": "https://github.com/oracle/graal/commit/e839d91d813cc62b089b361504360b5c98697947", "committedDate": "2020-02-19T16:43:34Z", "message": "optimize hash switch generation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e839d91d813cc62b089b361504360b5c98697947", "author": {"user": {"login": "fwbrasil", "name": "Flavio W. Brasil"}}, "url": "https://github.com/oracle/graal/commit/e839d91d813cc62b089b361504360b5c98697947", "committedDate": "2020-02-19T16:43:34Z", "message": "optimize hash switch generation"}, "afterCommit": {"oid": "122f45eaa12ca4ee1bb115fc96066d9ffe03a2bc", "author": {"user": {"login": "fwbrasil", "name": "Flavio W. Brasil"}}, "url": "https://github.com/oracle/graal/commit/122f45eaa12ca4ee1bb115fc96066d9ffe03a2bc", "committedDate": "2020-02-19T18:36:04Z", "message": "optimize hash switch generation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzI3MjUy", "url": "https://github.com/oracle/graal/pull/2161#pullrequestreview-362327252", "createdAt": "2020-02-21T00:19:02Z", "commit": {"oid": "122f45eaa12ca4ee1bb115fc96066d9ffe03a2bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMDoxOTowMlrOFsnv6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMDoxOTowMlrOFsnv6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMzMjkwNw==", "bodyText": "2020", "url": "https://github.com/oracle/graal/pull/2161#discussion_r382332907", "createdAt": "2020-02-21T00:19:02Z", "author": {"login": "theRealELiu"}, "path": "compiler/src/org.graalvm.compiler.lir/src/org/graalvm/compiler/lir/hashing/IntHasher.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "122f45eaa12ca4ee1bb115fc96066d9ffe03a2bc"}, "originalPosition": 2}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "122f45eaa12ca4ee1bb115fc96066d9ffe03a2bc", "author": {"user": {"login": "fwbrasil", "name": "Flavio W. Brasil"}}, "url": "https://github.com/oracle/graal/commit/122f45eaa12ca4ee1bb115fc96066d9ffe03a2bc", "committedDate": "2020-02-19T18:36:04Z", "message": "optimize hash switch generation"}, "afterCommit": {"oid": "367720c25278eb77995852523e72d336453a2069", "author": {"user": {"login": "fwbrasil", "name": "Flavio W. Brasil"}}, "url": "https://github.com/oracle/graal/commit/367720c25278eb77995852523e72d336453a2069", "committedDate": "2020-03-18T01:01:38Z", "message": "optimize hash switch generation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb15e916ab51d11d774f8ca1d7145539551d1954", "author": {"user": {"login": "fwbrasil", "name": "Flavio W. Brasil"}}, "url": "https://github.com/oracle/graal/commit/bb15e916ab51d11d774f8ca1d7145539551d1954", "committedDate": "2020-03-18T17:32:35Z", "message": "optimize hash switch generation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "367720c25278eb77995852523e72d336453a2069", "author": {"user": {"login": "fwbrasil", "name": "Flavio W. Brasil"}}, "url": "https://github.com/oracle/graal/commit/367720c25278eb77995852523e72d336453a2069", "committedDate": "2020-03-18T01:01:38Z", "message": "optimize hash switch generation"}, "afterCommit": {"oid": "bb15e916ab51d11d774f8ca1d7145539551d1954", "author": {"user": {"login": "fwbrasil", "name": "Flavio W. Brasil"}}, "url": "https://github.com/oracle/graal/commit/bb15e916ab51d11d774f8ca1d7145539551d1954", "committedDate": "2020-03-18T17:32:35Z", "message": "optimize hash switch generation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1089, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}