{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3OTgzMTI5", "number": 3149, "title": "Added a reroute call when updating the maxLatency flow field.", "bodyText": "", "createdAt": "2020-01-28T12:20:45Z", "url": "https://github.com/telstra/open-kilda/pull/3149", "merged": true, "mergeCommit": {"oid": "1e7404e3ce797ad85a03d80b7b4016e4d99c766a"}, "closed": true, "closedAt": "2020-03-02T11:18:50Z", "author": {"login": "dpoltavets"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-wdNhgBqjI5ODU0Mjk0OTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJnnsJgBqjMwODY1NjMwODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a33c30d1dee351487e736782aa7ee904572bb124", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/a33c30d1dee351487e736782aa7ee904572bb124", "committedDate": "2020-01-28T12:18:05Z", "message": "Added a reroute call when updating the maxLatency flow field."}, "afterCommit": {"oid": "d1e8ae7680a707a64051ddc634f12f8bd25f0d94", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/d1e8ae7680a707a64051ddc634f12f8bd25f0d94", "committedDate": "2020-01-28T12:25:14Z", "message": "Added a reroute call when updating the maxLatency flow field."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MzQyMzE3", "url": "https://github.com/telstra/open-kilda/pull/3149#pullrequestreview-349342317", "createdAt": "2020-01-28T12:40:01Z", "commit": {"oid": "d1e8ae7680a707a64051ddc634f12f8bd25f0d94"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMjo0MDowMVrOFijgQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMzoxMTozOFrOFikZfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc3NzYwMQ==", "bodyText": "strategyIsLMaxLatency", "url": "https://github.com/telstra/open-kilda/pull/3149#discussion_r371777601", "createdAt": "2020-01-28T12:40:01Z", "author": {"login": "niksv"}, "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/nbworker/services/FlowOperationsService.java", "diffHunk": "@@ -279,9 +288,43 @@ public UnidirectionalFlow updateFlow(FlowDto flow) throws FlowNotFoundException\n \n             flowRepository.createOrUpdate(currentFlow);\n \n-            return Optional.of(forwardFlow);\n+            return Optional.of(result.updatedFlow(forwardFlow).build());\n \n         }).orElseThrow(() -> new FlowNotFoundException(flow.getFlowId()));\n+\n+        if (updateFlowResult.isNeedRerouteFlow()) {\n+            Flow updatedFlow = updateFlowResult.getUpdatedFlow().getFlow();\n+            Set<PathId> pathIds = new HashSet<>(updatedFlow.getFlowPathIds());\n+            carrier.sendRerouteRequest(Collections.singletonMap(updatedFlow.getFlowId(), pathIds),\n+                    updateFlowResult.getRerouteReason());\n+        }\n+\n+        return updateFlowResult.getUpdatedFlow();\n+    }\n+\n+    @VisibleForTesting\n+    UpdateFlowResult.UpdateFlowResultBuilder prepareFlowUpdateResult(FlowDto flowDto, Flow flow) {\n+        boolean changedStrategy = flowDto.getPathComputationStrategy() != null\n+                && !flowDto.getPathComputationStrategy().equals(flow.getPathComputationStrategy());\n+        boolean changedMaxLatency = flowDto.getMaxLatency() != null\n+                && !flowDto.getMaxLatency().equals(flow.getMaxLatency());\n+        boolean strategyIsMaxLatency = flowDto.getPathComputationStrategy() != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1e8ae7680a707a64051ddc634f12f8bd25f0d94"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc4NDQ1NA==", "bodyText": "it could be simplified\n boolean strategyIsMaxLatency = \n    PathComputationStrategy.MAX_LATENCY.equals(flowDto.getPathComputationStrategy())\n    || flowDto.getPathComputationStrategy() == null \n    && PathComputationStrategy.MAX_LATENCY.equals(flow.getPathComputationStrategy())", "url": "https://github.com/telstra/open-kilda/pull/3149#discussion_r371784454", "createdAt": "2020-01-28T12:55:10Z", "author": {"login": "niksv"}, "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/nbworker/services/FlowOperationsService.java", "diffHunk": "@@ -279,9 +288,43 @@ public UnidirectionalFlow updateFlow(FlowDto flow) throws FlowNotFoundException\n \n             flowRepository.createOrUpdate(currentFlow);\n \n-            return Optional.of(forwardFlow);\n+            return Optional.of(result.updatedFlow(forwardFlow).build());\n \n         }).orElseThrow(() -> new FlowNotFoundException(flow.getFlowId()));\n+\n+        if (updateFlowResult.isNeedRerouteFlow()) {\n+            Flow updatedFlow = updateFlowResult.getUpdatedFlow().getFlow();\n+            Set<PathId> pathIds = new HashSet<>(updatedFlow.getFlowPathIds());\n+            carrier.sendRerouteRequest(Collections.singletonMap(updatedFlow.getFlowId(), pathIds),\n+                    updateFlowResult.getRerouteReason());\n+        }\n+\n+        return updateFlowResult.getUpdatedFlow();\n+    }\n+\n+    @VisibleForTesting\n+    UpdateFlowResult.UpdateFlowResultBuilder prepareFlowUpdateResult(FlowDto flowDto, Flow flow) {\n+        boolean changedStrategy = flowDto.getPathComputationStrategy() != null\n+                && !flowDto.getPathComputationStrategy().equals(flow.getPathComputationStrategy());\n+        boolean changedMaxLatency = flowDto.getMaxLatency() != null\n+                && !flowDto.getMaxLatency().equals(flow.getMaxLatency());\n+        boolean strategyIsMaxLatency = flowDto.getPathComputationStrategy() != null\n+                && flowDto.getPathComputationStrategy().equals(PathComputationStrategy.MAX_LATENCY)\n+                || flowDto.getPathComputationStrategy() == null && flow.getPathComputationStrategy() != null\n+                && flow.getPathComputationStrategy().equals(PathComputationStrategy.MAX_LATENCY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1e8ae7680a707a64051ddc634f12f8bd25f0d94"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc5MjI1NA==", "bodyText": "I'm not sure about pathIds. I guess we must get pathIds for reroute from original flow.", "url": "https://github.com/telstra/open-kilda/pull/3149#discussion_r371792254", "createdAt": "2020-01-28T13:11:38Z", "author": {"login": "niksv"}, "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/nbworker/services/FlowOperationsService.java", "diffHunk": "@@ -279,9 +288,43 @@ public UnidirectionalFlow updateFlow(FlowDto flow) throws FlowNotFoundException\n \n             flowRepository.createOrUpdate(currentFlow);\n \n-            return Optional.of(forwardFlow);\n+            return Optional.of(result.updatedFlow(forwardFlow).build());\n \n         }).orElseThrow(() -> new FlowNotFoundException(flow.getFlowId()));\n+\n+        if (updateFlowResult.isNeedRerouteFlow()) {\n+            Flow updatedFlow = updateFlowResult.getUpdatedFlow().getFlow();\n+            Set<PathId> pathIds = new HashSet<>(updatedFlow.getFlowPathIds());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1e8ae7680a707a64051ddc634f12f8bd25f0d94"}, "originalPosition": 66}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1e8ae7680a707a64051ddc634f12f8bd25f0d94", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/d1e8ae7680a707a64051ddc634f12f8bd25f0d94", "committedDate": "2020-01-28T12:25:14Z", "message": "Added a reroute call when updating the maxLatency flow field."}, "afterCommit": {"oid": "b95ad6d4dc28b6a768c7700bcece82efc59c59ee", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/b95ad6d4dc28b6a768c7700bcece82efc59c59ee", "committedDate": "2020-01-29T06:42:08Z", "message": "Added a reroute call when updating the maxLatency flow field."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMDM2MzI0", "url": "https://github.com/telstra/open-kilda/pull/3149#pullrequestreview-352036324", "createdAt": "2020-02-03T06:11:13Z", "commit": {"oid": "b95ad6d4dc28b6a768c7700bcece82efc59c59ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNjoxMToxM1rOFknKwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNjoxMToxM1rOFknKwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzNDc4NQ==", "bodyText": "I think you need to add saving of getPathComputationStrategy() into currentFlow. like in lines 20 and 283", "url": "https://github.com/telstra/open-kilda/pull/3149#discussion_r373934785", "createdAt": "2020-02-03T06:11:13Z", "author": {"login": "niksv"}, "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/nbworker/services/FlowOperationsService.java", "diffHunk": "@@ -279,9 +288,42 @@ public UnidirectionalFlow updateFlow(FlowDto flow) throws FlowNotFoundException\n \n             flowRepository.createOrUpdate(currentFlow);\n \n-            return Optional.of(forwardFlow);\n+            return Optional.of(result.updatedFlow(forwardFlow).build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b95ad6d4dc28b6a768c7700bcece82efc59c59ee"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMDQwNjA4", "url": "https://github.com/telstra/open-kilda/pull/3149#pullrequestreview-352040608", "createdAt": "2020-02-03T06:28:06Z", "commit": {"oid": "b95ad6d4dc28b6a768c7700bcece82efc59c59ee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b95ad6d4dc28b6a768c7700bcece82efc59c59ee", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/b95ad6d4dc28b6a768c7700bcece82efc59c59ee", "committedDate": "2020-01-29T06:42:08Z", "message": "Added a reroute call when updating the maxLatency flow field."}, "afterCommit": {"oid": "d72513da4a6f363bf24031c75b6cf5ef86d08261", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/d72513da4a6f363bf24031c75b6cf5ef86d08261", "committedDate": "2020-02-10T11:02:43Z", "message": "Added a reroute call when updating the maxLatency flow field."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d72513da4a6f363bf24031c75b6cf5ef86d08261", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/d72513da4a6f363bf24031c75b6cf5ef86d08261", "committedDate": "2020-02-10T11:02:43Z", "message": "Added a reroute call when updating the maxLatency flow field."}, "afterCommit": {"oid": "1585a0754ece5dca5fa0246a7d762f8416707508", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/1585a0754ece5dca5fa0246a7d762f8416707508", "committedDate": "2020-02-10T12:38:46Z", "message": "Added a reroute call when updating the maxLatency flow field."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MjExNzE2", "url": "https://github.com/telstra/open-kilda/pull/3149#pullrequestreview-357211716", "createdAt": "2020-02-12T06:22:16Z", "commit": {"oid": "1585a0754ece5dca5fa0246a7d762f8416707508"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1585a0754ece5dca5fa0246a7d762f8416707508", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/1585a0754ece5dca5fa0246a7d762f8416707508", "committedDate": "2020-02-10T12:38:46Z", "message": "Added a reroute call when updating the maxLatency flow field."}, "afterCommit": {"oid": "8a4754256b4253bb2ad7c0c7e2015d112e65d3a0", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/8a4754256b4253bb2ad7c0c7e2015d112e65d3a0", "committedDate": "2020-02-18T11:27:55Z", "message": "Added a reroute call when updating the maxLatency flow field."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b8cb181f2ab7b3110af33ad96a8daa3e82ab101", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/6b8cb181f2ab7b3110af33ad96a8daa3e82ab101", "committedDate": "2020-03-02T06:20:40Z", "message": "Added a reroute call when updating the maxLatency flow field."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a4754256b4253bb2ad7c0c7e2015d112e65d3a0", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/8a4754256b4253bb2ad7c0c7e2015d112e65d3a0", "committedDate": "2020-02-18T11:27:55Z", "message": "Added a reroute call when updating the maxLatency flow field."}, "afterCommit": {"oid": "6b8cb181f2ab7b3110af33ad96a8daa3e82ab101", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/6b8cb181f2ab7b3110af33ad96a8daa3e82ab101", "committedDate": "2020-03-02T06:20:40Z", "message": "Added a reroute call when updating the maxLatency flow field."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3698, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}