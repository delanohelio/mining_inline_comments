{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MzI5NTIw", "number": 3635, "title": "refactor tests for smart discovery", "bodyText": "", "createdAt": "2020-07-15T08:29:38Z", "url": "https://github.com/telstra/open-kilda/pull/3635", "merged": true, "mergeCommit": {"oid": "b11d92f5d148dd5ab5653eefa0aa1119e5aac388"}, "closed": true, "closedAt": "2020-07-30T11:47:14Z", "author": {"login": "andriidovhan"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1G8XXAFqTQ0ODc2MzUxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc59K14gFqTQ1ODI4MjY1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzYzNTE0", "url": "https://github.com/telstra/open-kilda/pull/3635#pullrequestreview-448763514", "createdAt": "2020-07-15T09:01:56Z", "commit": {"oid": "e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwOTowMTo1NlrOGx1CBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwOTowOToxN1rOGx1Sgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwMjI3OA==", "bodyText": "Wait inside wait? I don't really get it. Either change how waitForIslStatus works or remove it and do a common wait for isls without islUtils.waitForIslStatus", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r454902278", "createdAt": "2020-07-15T09:01:56Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowCrudSpec.groovy", "diffHunk": "@@ -730,7 +730,9 @@ class FlowCrudSpec extends HealthCheckSpecification {\n         def newIsl = islUtils.replug(isl, false, notConnectedIsl, true, true)\n \n         islUtils.waitForIslStatus([isl, isl.reversed], MOVED)\n-        islUtils.waitForIslStatus([newIsl, newIsl.reversed], DISCOVERED)\n+        Wrappers.wait(discoveryFailedInterval + WAIT_OFFSET) {\n+            islUtils.waitForIslStatus([newIsl, newIsl.reversed], DISCOVERED)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwMzU3Mg==", "bodyText": "Default traffgen port may change, it is configurable. Instead of doing such an assumption you should get switch ports and find a port without isl", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r454903572", "createdAt": "2020-07-15T09:04:13Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/logging/CheckLoggingSpec.groovy", "diffHunk": "@@ -86,4 +88,26 @@ class CheckLoggingSpec extends HealthCheckSpecification {\n                     \"Storm should generate a warning message about not being able to find the flow\"\n         }\n     }\n+\n+    def \"Check push discovery package logging\"() {\n+        given: \"Two port(with/without ISL)\"\n+        def sw = topology.activeTraffGens*.switchConnected.first()\n+        def portWithIsl = topology.getRelatedIsls(sw).first().srcPort\n+        def portWithoutIsl = 10 //default port for traffgen", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwNTI5Ng==", "bodyText": "the '60' number should be bind to the actual config", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r454905296", "createdAt": "2020-07-15T09:07:16Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/logging/CheckLoggingSpec.groovy", "diffHunk": "@@ -86,4 +88,26 @@ class CheckLoggingSpec extends HealthCheckSpecification {\n                     \"Storm should generate a warning message about not being able to find the flow\"\n         }\n     }\n+\n+    def \"Check push discovery package logging\"() {\n+        given: \"Two port(with/without ISL)\"\n+        def sw = topology.activeTraffGens*.switchConnected.first()\n+        def portWithIsl = topology.getRelatedIsls(sw).first().srcPort\n+        def portWithoutIsl = 10 //default port for traffgen\n+\n+        when: \"Retrieve logs for port with ISL for last 1 minute\"\n+        def result\n+\n+        then: \"There should be 1 message of push discovery for port without ISL and more than 1 for port with ISL\"\n+        Wrappers.wait(discoveryFailedInterval + WAIT_OFFSET) {\n+            result = elastic.getLogs(new ElasticQueryBuilder().setTags(KildaTags.FLOODLIGHT)\n+                    .setLevel(\"INFO\").setTimeRange(60).build())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwNjQ5OQ==", "bodyText": "can this number be calculated based of discovery interval and requested timerange?", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r454906499", "createdAt": "2020-07-15T09:09:17Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/logging/CheckLoggingSpec.groovy", "diffHunk": "@@ -86,4 +88,26 @@ class CheckLoggingSpec extends HealthCheckSpecification {\n                     \"Storm should generate a warning message about not being able to find the flow\"\n         }\n     }\n+\n+    def \"Check push discovery package logging\"() {\n+        given: \"Two port(with/without ISL)\"\n+        def sw = topology.activeTraffGens*.switchConnected.first()\n+        def portWithIsl = topology.getRelatedIsls(sw).first().srcPort\n+        def portWithoutIsl = 10 //default port for traffgen\n+\n+        when: \"Retrieve logs for port with ISL for last 1 minute\"\n+        def result\n+\n+        then: \"There should be 1 message of push discovery for port without ISL and more than 1 for port with ISL\"\n+        Wrappers.wait(discoveryFailedInterval + WAIT_OFFSET) {\n+            result = elastic.getLogs(new ElasticQueryBuilder().setTags(KildaTags.FLOODLIGHT)\n+                    .setLevel(\"INFO\").setTimeRange(60).build())\n+            assert result.hits.hits.findAll { hit ->\n+                hit.source.message.toLowerCase().contains(pushDiscoveryMsg(\"$sw.dpId-$portWithoutIsl\"))\n+            }.size() == 1\n+            assert result.hits.hits.findAll { hit ->\n+                hit.source.message.toLowerCase().contains(pushDiscoveryMsg(\"$sw.dpId-$portWithIsl\"))\n+            }.size() > 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22", "committedDate": "2020-07-15T08:28:20Z", "message": "add/refactor tests for smart discovery"}, "afterCommit": {"oid": "a0f0f2d1ffaba5e1596fd1c9f90ca279e27409dc", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/a0f0f2d1ffaba5e1596fd1c9f90ca279e27409dc", "committedDate": "2020-07-15T14:25:26Z", "message": "add/refactor tests for smart discovery"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NjM0NTQ5", "url": "https://github.com/telstra/open-kilda/pull/3635#pullrequestreview-449634549", "createdAt": "2020-07-16T08:33:24Z", "commit": {"oid": "a0f0f2d1ffaba5e1596fd1c9f90ca279e27409dc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODozMzoyNFrOGygtuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODozODoyOVrOGyg5RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxNzk3OQ==", "bodyText": "it is cleaner to use northbound.getLink here to ask for 1 certain isl. islUtils.getIslInfo(it) will dump all isls twice", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r455617979", "createdAt": "2020-07-16T08:33:24Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/links/IslMinPortSpeedSpec.groovy", "diffHunk": "@@ -38,7 +38,9 @@ class IslMinPortSpeedSpec extends HealthCheckSpecification {\n         when: \"Replug one end of the connected link to the destination switch(isl.srcSwitchId -> newDst.srcSwitchId)\"\n         def newIsl = islUtils.replug(isl, false, newDst, true, true)\n \n-        islUtils.waitForIslStatus([newIsl, newIsl.reversed], DISCOVERED)\n+        Wrappers.wait(discoverySlowPollInterval + WAIT_OFFSET) {\n+            [newIsl, newIsl.reversed].each { assert islUtils.getIslInfo(it).get().state == DISCOVERED }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0f0f2d1ffaba5e1596fd1c9f90ca279e27409dc"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyMDkzMw==", "bodyText": "if discovery.slow.poll.interval is changed to 59 instead of 60, then you can potentially see 2 push discovery messages for down port in the last 60 seconds", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r455620933", "createdAt": "2020-07-16T08:38:29Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/logging/CheckLoggingSpec.groovy", "diffHunk": "@@ -86,4 +88,26 @@ class CheckLoggingSpec extends HealthCheckSpecification {\n                     \"Storm should generate a warning message about not being able to find the flow\"\n         }\n     }\n+\n+    def \"Check push discovery package logging\"() {\n+        given: \"Two port(with/without ISL)\"\n+        def sw = topology.activeTraffGens*.switchConnected.first()\n+        def portWithIsl = topology.getRelatedIsls(sw).first().srcPort\n+        def portWithoutIsl = 10 //default port for traffgen\n+\n+        when: \"Retrieve logs for port with ISL for last 1 minute\"\n+        def result\n+\n+        then: \"There should be 1 message of push discovery for port without ISL and more than 1 for port with ISL\"\n+        Wrappers.wait(discoveryFailedInterval + WAIT_OFFSET) {\n+            result = elastic.getLogs(new ElasticQueryBuilder().setTags(KildaTags.FLOODLIGHT)\n+                    .setLevel(\"INFO\").setTimeRange(60).build())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwNTI5Ng=="}, "originalCommit": {"oid": "e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0f0f2d1ffaba5e1596fd1c9f90ca279e27409dc", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/a0f0f2d1ffaba5e1596fd1c9f90ca279e27409dc", "committedDate": "2020-07-15T14:25:26Z", "message": "add/refactor tests for smart discovery"}, "afterCommit": {"oid": "39bb2a0817831f25e2d630b7651a170e9eb38558", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/39bb2a0817831f25e2d630b7651a170e9eb38558", "committedDate": "2020-07-17T10:07:54Z", "message": "add/refactor tests for smart discovery"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39bb2a0817831f25e2d630b7651a170e9eb38558", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/39bb2a0817831f25e2d630b7651a170e9eb38558", "committedDate": "2020-07-17T10:07:54Z", "message": "add/refactor tests for smart discovery"}, "afterCommit": {"oid": "50f1156edbef9c4c62825f750e74b216fa1bbe4b", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/50f1156edbef9c4c62825f750e74b216fa1bbe4b", "committedDate": "2020-07-17T10:14:36Z", "message": "add/refactor tests for smart discovery"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50f1156edbef9c4c62825f750e74b216fa1bbe4b", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/50f1156edbef9c4c62825f750e74b216fa1bbe4b", "committedDate": "2020-07-17T10:14:36Z", "message": "add/refactor tests for smart discovery"}, "afterCommit": {"oid": "0924e69d725a5ccce9c9e33d6d5029550e985a9e", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/0924e69d725a5ccce9c9e33d6d5029550e985a9e", "committedDate": "2020-07-23T07:40:12Z", "message": "add/refactor tests for smart discovery"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0924e69d725a5ccce9c9e33d6d5029550e985a9e", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/0924e69d725a5ccce9c9e33d6d5029550e985a9e", "committedDate": "2020-07-23T07:40:12Z", "message": "add/refactor tests for smart discovery"}, "afterCommit": {"oid": "79e74233ddc0da8971ebe954e3378ea9c142e503", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/79e74233ddc0da8971ebe954e3378ea9c142e503", "committedDate": "2020-07-23T07:46:04Z", "message": "add/refactor tests for smart discovery"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79e74233ddc0da8971ebe954e3378ea9c142e503", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/79e74233ddc0da8971ebe954e3378ea9c142e503", "committedDate": "2020-07-23T07:46:04Z", "message": "add/refactor tests for smart discovery"}, "afterCommit": {"oid": "76e42f6b7c0eb1b2eba935e26273baf5284e77e2", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/76e42f6b7c0eb1b2eba935e26273baf5284e77e2", "committedDate": "2020-07-23T09:42:37Z", "message": "add/refactor tests for smart discovery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a47cdebd82e18513878dd334c64f9505020b7f4", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/7a47cdebd82e18513878dd334c64f9505020b7f4", "committedDate": "2020-07-24T13:38:44Z", "message": "add/refactor tests for smart discovery"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76e42f6b7c0eb1b2eba935e26273baf5284e77e2", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/76e42f6b7c0eb1b2eba935e26273baf5284e77e2", "committedDate": "2020-07-23T09:42:37Z", "message": "add/refactor tests for smart discovery"}, "afterCommit": {"oid": "7a47cdebd82e18513878dd334c64f9505020b7f4", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/7a47cdebd82e18513878dd334c64f9505020b7f4", "committedDate": "2020-07-24T13:38:44Z", "message": "add/refactor tests for smart discovery"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MjgyNjU5", "url": "https://github.com/telstra/open-kilda/pull/3635#pullrequestreview-458282659", "createdAt": "2020-07-30T10:35:49Z", "commit": {"oid": "7a47cdebd82e18513878dd334c64f9505020b7f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3537, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}