{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NzgyNDE5", "number": 3892, "title": "Fix swap endpoints for looped flows", "bodyText": "Close #3846", "createdAt": "2020-11-30T20:08:57Z", "url": "https://github.com/telstra/open-kilda/pull/3892", "merged": true, "mergeCommit": {"oid": "85df827e4e07145b236b747961adc14cab8053f8"}, "closed": true, "closedAt": "2020-12-21T12:44:14Z", "author": {"login": "rozdy"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh0gszgFqTU0MTUzNzY1MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmKfSdgFqTU1MTgwMTUwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNTM3NjUx", "url": "https://github.com/telstra/open-kilda/pull/3892#pullrequestreview-541537651", "createdAt": "2020-12-01T07:07:31Z", "commit": {"oid": "80ea120bea582c36326c28f6b79f87b680783c16"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80ea120bea582c36326c28f6b79f87b680783c16", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/80ea120bea582c36326c28f6b79f87b680783c16", "committedDate": "2020-11-30T20:07:02Z", "message": "Fix swap endpoints for looped flows"}, "afterCommit": {"oid": "e52ac7e073ced106aec3b38a5ebf3ddca0fc9dc8", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/e52ac7e073ced106aec3b38a5ebf3ddca0fc9dc8", "committedDate": "2020-12-01T08:46:55Z", "message": "Fix swap endpoints for looped flows"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e52ac7e073ced106aec3b38a5ebf3ddca0fc9dc8", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/e52ac7e073ced106aec3b38a5ebf3ddca0fc9dc8", "committedDate": "2020-12-01T08:46:55Z", "message": "Fix swap endpoints for looped flows"}, "afterCommit": {"oid": "0470f3e182a0d178c4269040f772600160d75870", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/0470f3e182a0d178c4269040f772600160d75870", "committedDate": "2020-12-01T11:46:15Z", "message": "Fix swap endpoints for looped flows"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0470f3e182a0d178c4269040f772600160d75870", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/0470f3e182a0d178c4269040f772600160d75870", "committedDate": "2020-12-01T11:46:15Z", "message": "Fix swap endpoints for looped flows"}, "afterCommit": {"oid": "429db1b4dfa857e6cbafe1947af8f16b3a68d2b6", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/429db1b4dfa857e6cbafe1947af8f16b3a68d2b6", "committedDate": "2020-12-03T14:42:23Z", "message": "Fix swap endpoints for looped flows"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MTUzNTk4", "url": "https://github.com/telstra/open-kilda/pull/3892#pullrequestreview-544153598", "createdAt": "2020-12-03T16:36:12Z", "commit": {"oid": "429db1b4dfa857e6cbafe1947af8f16b3a68d2b6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "429db1b4dfa857e6cbafe1947af8f16b3a68d2b6", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/429db1b4dfa857e6cbafe1947af8f16b3a68d2b6", "committedDate": "2020-12-03T14:42:23Z", "message": "Fix swap endpoints for looped flows"}, "afterCommit": {"oid": "808e6fcd8033577b6fc039555dc147e44039e51b", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/808e6fcd8033577b6fc039555dc147e44039e51b", "committedDate": "2020-12-03T16:47:42Z", "message": "Fix swap endpoints for looped flows"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "808e6fcd8033577b6fc039555dc147e44039e51b", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/808e6fcd8033577b6fc039555dc147e44039e51b", "committedDate": "2020-12-03T16:47:42Z", "message": "Fix swap endpoints for looped flows"}, "afterCommit": {"oid": "c04433426fb2e1b9e21908a1f873235cfb8c9569", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/c04433426fb2e1b9e21908a1f873235cfb8c9569", "committedDate": "2020-12-03T18:18:58Z", "message": "Fix swap endpoints for looped flows"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c04433426fb2e1b9e21908a1f873235cfb8c9569", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/c04433426fb2e1b9e21908a1f873235cfb8c9569", "committedDate": "2020-12-03T18:18:58Z", "message": "Fix swap endpoints for looped flows"}, "afterCommit": {"oid": "35064b28af8f262182196c34f6ab0571e178ccd0", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/35064b28af8f262182196c34f6ab0571e178ccd0", "committedDate": "2020-12-04T14:17:36Z", "message": "Fix swap endpoints for looped flows"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35064b28af8f262182196c34f6ab0571e178ccd0", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/35064b28af8f262182196c34f6ab0571e178ccd0", "committedDate": "2020-12-04T14:17:36Z", "message": "Fix swap endpoints for looped flows"}, "afterCommit": {"oid": "c493520917997e22c7ffa77e4ba01219bda7b8a2", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/c493520917997e22c7ffa77e4ba01219bda7b8a2", "committedDate": "2020-12-04T15:11:24Z", "message": "Fix swap endpoints for looped flows"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4Mzg1NTA3", "url": "https://github.com/telstra/open-kilda/pull/3892#pullrequestreview-548385507", "createdAt": "2020-12-09T16:47:44Z", "commit": {"oid": "c493520917997e22c7ffa77e4ba01219bda7b8a2"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjo0Nzo0NFrOICesCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjo1Njo0N1rOICfIGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3MDg1OQ==", "bodyText": "em... can we just use flowRequest.setLoopSwitchId(flow.getLoopSwitchId()) ?\nPS In current shape it will produce unexpected issues if/when we will try to make loops on transit switches.", "url": "https://github.com/telstra/open-kilda/pull/3892#discussion_r539470859", "createdAt": "2020-12-09T16:47:44Z", "author": {"login": "surabujin"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/swapendpoints/actions/UpdateRequestAction.java", "diffHunk": "@@ -54,6 +54,12 @@ private void sendUpdateCommand(Flow flow, RequestedFlow targetFlow, String anoth\n         flowRequest.setDestination(\n                 new FlowEndpoint(targetFlow.getDestSwitch(), targetFlow.getDestPort(), targetFlow.getDestVlan()));\n \n+        if (flow.getLoopSwitchId() != null) {\n+            boolean flowLoopedOnSrc = flow.getLoopSwitchId().equals(flow.getSrcSwitchId());\n+            flowRequest.setLoopSwitchId(flowLoopedOnSrc ? flowRequest.getSource().getSwitchId()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c493520917997e22c7ffa77e4ba01219bda7b8a2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3MjQ5NA==", "bodyText": "mapstruct is able to create mapping by itself if field names match.", "url": "https://github.com/telstra/open-kilda/pull/3892#discussion_r539472494", "createdAt": "2020-12-09T16:49:49Z", "author": {"login": "surabujin"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/mapper/RequestedFlowMapper.java", "diffHunk": "@@ -167,6 +167,7 @@ public PathComputationStrategy mapComputationStrategy(String raw) {\n     @Mapping(target = \"priority\", source = \"priority\")\n     @Mapping(target = \"pinned\", source = \"pinned\")\n     @Mapping(target = \"detectConnectedDevices\", source = \"detectConnectedDevices\")\n+    @Mapping(target = \"loopSwitchId\", source = \"loopSwitchId\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c493520917997e22c7ffa77e4ba01219bda7b8a2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NTA4OQ==", "bodyText": "We should not emit errors if the loop already exists on requested now flow + endpoint.", "url": "https://github.com/telstra/open-kilda/pull/3892#discussion_r539475089", "createdAt": "2020-12-09T16:53:06Z", "author": {"login": "surabujin"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/service/FlowUpdateService.java", "diffHunk": "@@ -143,8 +141,12 @@ public void handleCreateFlowLoopRequest(String key, CommandContext commandContex\n         Optional<Flow> flow = flowRepository.findById(request.getFlowId());\n         if (flow.isPresent()) {\n             FlowRequest flowRequest = RequestedFlowMapper.INSTANCE.toFlowRequest(flow.get());\n-            flowRequest.setLoopSwitchId(request.getSwitchId());\n-            handleRequest(key, commandContext, flowRequest);\n+            if (flowRequest.getLoopSwitchId() == null) {\n+                flowRequest.setLoopSwitchId(request.getSwitchId());\n+                handleRequest(key, commandContext, flowRequest);\n+            } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c493520917997e22c7ffa77e4ba01219bda7b8a2"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NTkxMA==", "bodyText": "\"found\"?", "url": "https://github.com/telstra/open-kilda/pull/3892#discussion_r539475910", "createdAt": "2020-12-09T16:54:10Z", "author": {"login": "surabujin"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/service/FlowUpdateService.java", "diffHunk": "@@ -205,6 +207,13 @@ private Message buildFlowNotFoundErrorMessage(String flowId, CommandContext comm\n         return new ErrorMessage(error, commandContext.getCreateTime(), commandContext.getCorrelationId());\n     }\n \n+    private Message buildFlowAlreadyLoopedErrorMessage(FlowRequest flow, CommandContext commandContext) {\n+        String description = String.format(\"Flow is already looped on switch '%s'\", flow.getLoopSwitchId());\n+        ErrorData error = new ErrorData(ErrorType.UNPROCESSABLE_REQUEST,\n+                String.format(\"Can't create flow loop on '%s' found\", flow.getFlowId()), description);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c493520917997e22c7ffa77e4ba01219bda7b8a2"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3ODA0Mg==", "bodyText": "flow is not used anymore.", "url": "https://github.com/telstra/open-kilda/pull/3892#discussion_r539478042", "createdAt": "2020-12-09T16:56:47Z", "author": {"login": "surabujin"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/validation/FlowValidator.java", "diffHunk": "@@ -105,22 +105,18 @@ public void validate(RequestedFlow flow, Set<String> bulkUpdateFlowIds)\n     public void validate(Flow flow, RequestedFlow requestedFlow, Set<String> bulkUpdateFlowIds)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c493520917997e22c7ffa77e4ba01219bda7b8a2"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2fd37a1b28496b037f2ecdb10acec728c5db41e", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/d2fd37a1b28496b037f2ecdb10acec728c5db41e", "committedDate": "2020-12-11T08:43:33Z", "message": "Fix flow loops for single switch flows"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9a7e326595937954ada73e73999ad9e9a7330e9", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/e9a7e326595937954ada73e73999ad9e9a7330e9", "committedDate": "2020-12-11T07:54:47Z", "message": "add swapEndpoint test for flowLoop (#3894)"}, "afterCommit": {"oid": "e1182ad8581f9aa7f1c7886f589001dc04cfdc5a", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/e1182ad8581f9aa7f1c7886f589001dc04cfdc5a", "committedDate": "2020-12-11T08:48:14Z", "message": "add swapEndpoint test for flowLoop (#3894)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dfb7128012c4e03bf2b5e7e562fac52d1be7c40", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/2dfb7128012c4e03bf2b5e7e562fac52d1be7c40", "committedDate": "2020-12-14T14:38:30Z", "message": "Fix swap endpoints for looped flows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a80c859b84d6bf077491536b5d36fc93325c6a95", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/a80c859b84d6bf077491536b5d36fc93325c6a95", "committedDate": "2020-12-14T14:38:42Z", "message": "add swapEndpoint test for flowLoop (#3894)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1182ad8581f9aa7f1c7886f589001dc04cfdc5a", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/e1182ad8581f9aa7f1c7886f589001dc04cfdc5a", "committedDate": "2020-12-11T08:48:14Z", "message": "add swapEndpoint test for flowLoop (#3894)"}, "afterCommit": {"oid": "a80c859b84d6bf077491536b5d36fc93325c6a95", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/a80c859b84d6bf077491536b5d36fc93325c6a95", "committedDate": "2020-12-14T14:38:42Z", "message": "add swapEndpoint test for flowLoop (#3894)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODAwOTA0", "url": "https://github.com/telstra/open-kilda/pull/3892#pullrequestreview-551800904", "createdAt": "2020-12-14T18:58:49Z", "commit": {"oid": "a80c859b84d6bf077491536b5d36fc93325c6a95"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODo1ODo1MFrOIFgolA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODo1ODo1MFrOIFgolA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY0ODQ2OA==", "bodyText": "ugly look", "url": "https://github.com/telstra/open-kilda/pull/3892#discussion_r542648468", "createdAt": "2020-12-14T18:58:50Z", "author": {"login": "nikitamarchenko"}, "path": "src-java/stats-topology/stats-storm-topology/src/main/java/org/openkilda/wfm/topology/stats/metrics/FlowMetricGenBolt.java", "diffHunk": "@@ -64,7 +65,8 @@ protected void handleInput(Tuple input) throws Exception {\n \n     private void emit(FlowStatsEntry entry, long timestamp, @Nonnull SwitchId switchId,\n                       @Nullable CacheFlowEntry flowEntry) throws FlowCookieException {\n-        boolean isFlowSegmentEntry = new Cookie(entry.getCookie()).getType() == CookieType.SERVICE_OR_FLOW_SEGMENT;\n+        boolean isFlowSegmentEntry = new Cookie(entry.getCookie()).getType() == CookieType.SERVICE_OR_FLOW_SEGMENT\n+                && !new FlowSegmentCookie(entry.getCookie()).isLooped();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a80c859b84d6bf077491536b5d36fc93325c6a95"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODAxNTA5", "url": "https://github.com/telstra/open-kilda/pull/3892#pullrequestreview-551801509", "createdAt": "2020-12-14T18:59:35Z", "commit": {"oid": "a80c859b84d6bf077491536b5d36fc93325c6a95"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3782, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}