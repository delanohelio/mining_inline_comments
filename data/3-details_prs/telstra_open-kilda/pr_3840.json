{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4MzAzNzI4", "number": 3840, "title": "Add test for round-trip isl discovery in special cases", "bodyText": "", "createdAt": "2020-11-10T08:08:41Z", "url": "https://github.com/telstra/open-kilda/pull/3840", "merged": true, "mergeCommit": {"oid": "2e3f531be6fa1102b81a6c4262a3131219a223ad"}, "closed": true, "closedAt": "2020-11-13T14:59:21Z", "author": {"login": "rtretyak"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbE0xTgBqjM5Nzc1NTk5MzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbv9POgBqjM5ODc5MzI1NTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9dfc697ed04846f201381f0254962ccbdf6bd8c", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/d9dfc697ed04846f201381f0254962ccbdf6bd8c", "committedDate": "2020-11-09T13:23:31Z", "message": "Add test for round-trip isl discovery in special cases"}, "afterCommit": {"oid": "f1a1f5512e8f6235e7fb12c5f9c86af17b3ce293", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/f1a1f5512e8f6235e7fb12c5f9c86af17b3ce293", "committedDate": "2020-11-10T08:09:49Z", "message": "Add test for round-trip isl discovery in special cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MjkyNjAz", "url": "https://github.com/telstra/open-kilda/pull/3840#pullrequestreview-527292603", "createdAt": "2020-11-10T15:01:54Z", "commit": {"oid": "f1a1f5512e8f6235e7fb12c5f9c86af17b3ce293"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNTowMTo1NFrOHwgwfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNTowMzo1MFrOHwg2DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzMDM5Ng==", "bodyText": "Do we really need to wait WAIT_OFFSET * 2?", "url": "https://github.com/telstra/open-kilda/pull/3840#discussion_r520630396", "createdAt": "2020-11-10T15:01:54Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/links/RoundTripIslSpec.groovy", "diffHunk": "@@ -33,6 +37,62 @@ class RoundTripIslSpec extends HealthCheckSpecification {\n     via the 'knockoutSwitch' method on the stage env*/\n     Integer customWaitOffset = WAIT_OFFSET * 4\n \n+    @Unroll\n+    @Tidy\n+    def \"Isl with round-trip properly changes status after port events(#descr)\"() {\n+        given: \"Round-trip ISL with a-switch\"\n+        def cleanupActions = []\n+        def isl = topology.islsForActiveSwitches.find { it.aswitch?.inPort && it.aswitch?.outPort &&\n+                [it.srcSwitch, it.dstSwitch].every { it.features.contains(SwitchFeature.NOVIFLOW_COPY_FIELD) }\n+        }\n+        assumeTrue(\"Wasn't able to find round-trip ISL with a-switch\", isl != null)\n+        bfd && northboundV2.setLinkBfd(isl)\n+\n+        when: \"Port down event happens\"\n+        antiflap.portDown(isl.srcSwitch.dpId, isl.srcPort)\n+        cleanupActions << { antiflap.portUp(isl.srcSwitch.dpId, isl.srcPort) }\n+\n+        then: \"ISL changed status to FAILED\"\n+        Wrappers.wait(WAIT_OFFSET * 2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1a1f5512e8f6235e7fb12c5f9c86af17b3ce293"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYzMTgyMQ==", "bodyText": "wait is needless here, I guess\nThe isl is already failed (L57-58)", "url": "https://github.com/telstra/open-kilda/pull/3840#discussion_r520631821", "createdAt": "2020-11-10T15:03:50Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/links/RoundTripIslSpec.groovy", "diffHunk": "@@ -33,6 +37,62 @@ class RoundTripIslSpec extends HealthCheckSpecification {\n     via the 'knockoutSwitch' method on the stage env*/\n     Integer customWaitOffset = WAIT_OFFSET * 4\n \n+    @Unroll\n+    @Tidy\n+    def \"Isl with round-trip properly changes status after port events(#descr)\"() {\n+        given: \"Round-trip ISL with a-switch\"\n+        def cleanupActions = []\n+        def isl = topology.islsForActiveSwitches.find { it.aswitch?.inPort && it.aswitch?.outPort &&\n+                [it.srcSwitch, it.dstSwitch].every { it.features.contains(SwitchFeature.NOVIFLOW_COPY_FIELD) }\n+        }\n+        assumeTrue(\"Wasn't able to find round-trip ISL with a-switch\", isl != null)\n+        bfd && northboundV2.setLinkBfd(isl)\n+\n+        when: \"Port down event happens\"\n+        antiflap.portDown(isl.srcSwitch.dpId, isl.srcPort)\n+        cleanupActions << { antiflap.portUp(isl.srcSwitch.dpId, isl.srcPort) }\n+\n+        then: \"ISL changed status to FAILED\"\n+        Wrappers.wait(WAIT_OFFSET * 2) {\n+            assert northbound.getLink(isl).state == FAILED\n+            assert northbound.getLink(isl.reversed).state == FAILED\n+        }\n+\n+        when: \"Port up event happens, but traffic goes only in one direction\"\n+        lockKeeper.removeFlows([isl.aswitch])\n+        cleanupActions << { lockKeeper.addFlows([isl.aswitch]) }\n+        cleanupActions.pop().call() //antiflap.portUp(isl.srcSwitch.dpId, isl.srcPort)\n+\n+        then: \"ISL is not getting discovered\"\n+        TimeUnit.SECONDS.sleep(discoveryInterval + 2)\n+        Wrappers.wait(WAIT_OFFSET) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1a1f5512e8f6235e7fb12c5f9c86af17b3ce293"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a8decc7ddeda06fdcc32318e37d67af22a3bed0", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/3a8decc7ddeda06fdcc32318e37d67af22a3bed0", "committedDate": "2020-11-12T10:25:14Z", "message": "Add test for round-trip isl discovery in special cases"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1a1f5512e8f6235e7fb12c5f9c86af17b3ce293", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/f1a1f5512e8f6235e7fb12c5f9c86af17b3ce293", "committedDate": "2020-11-10T08:09:49Z", "message": "Add test for round-trip isl discovery in special cases"}, "afterCommit": {"oid": "3a8decc7ddeda06fdcc32318e37d67af22a3bed0", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/3a8decc7ddeda06fdcc32318e37d67af22a3bed0", "committedDate": "2020-11-12T10:25:14Z", "message": "Add test for round-trip isl discovery in special cases"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3762, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}