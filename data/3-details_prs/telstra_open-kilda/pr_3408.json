{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3NzAzNDYw", "number": 3408, "title": "Server 42 RTT: Added Output rules", "bodyText": "", "createdAt": "2020-04-23T06:13:28Z", "url": "https://github.com/telstra/open-kilda/pull/3408", "merged": true, "mergeCommit": {"oid": "16b00d82e911e1a5864a109271ad6866b2f7afdf"}, "closed": true, "closedAt": "2020-04-27T12:55:11Z", "author": {"login": "niksv"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaWzx_gFqTM5ODc5MDAxOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbud35ABqjMyNzU1MjkyODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NzkwMDE4", "url": "https://github.com/telstra/open-kilda/pull/3408#pullrequestreview-398790018", "createdAt": "2020-04-23T06:22:35Z", "commit": {"oid": "c17c7c16be9c6fafff9e7199dc98537fc61b7c75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNjoyMjozNVrOGKYgZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNjoyMjozNVrOGKYgZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU0MDQ1NA==", "bodyText": ".outputPort(properties.getServer42Port()) could not be moved above because if() else section will be extended in next patch PRs", "url": "https://github.com/telstra/open-kilda/pull/3408#discussion_r413540454", "createdAt": "2020-04-23T06:22:35Z", "author": {"login": "niksv"}, "path": "src-java/swmanager-topology/swmanager-storm-topology/src/main/java/org/openkilda/wfm/topology/switchmanager/service/impl/CommandBuilderImpl.java", "diffHunk": "@@ -121,10 +129,60 @@ public CommandBuilderImpl(PersistenceManager persistenceManager, FlowResourcesCo\n         return commands;\n     }\n \n-    private List<BaseInstallFlow> buildInstallDefaultRuleCommands(SwitchId switchId, List<Long> switchRules) {\n+    /**\n+     * Some default rules require additional properties to be installed. This method filters such rules.\n+     */\n+    private static boolean isDefaultRuleWithSpecialRequirements(long cookie) {\n+        return cookie == SERVER_42_OUTPUT_VLAN_COOKIE\n+                || cookie == SERVER_42_OUTPUT_VXLAN_COOKIE;\n+    }\n+\n+    /**\n+     * Some default rules require additional properties to be installed. This method creates commands for such rules.\n+     */\n+    private List<BaseInstallFlow> buildInstallSpecialDefaultRuleCommands(SwitchId switchId, List<Long> switchRules) {\n+        SwitchProperties properties = switchPropertiesRepository.findBySwitchId(switchId).orElseThrow(\n+                () -> new IllegalStateException(format(\"Switch properties not found for switch %s\", switchId)));\n+\n         List<BaseInstallFlow> commands = new ArrayList<>();\n+        for (Long cookie : switchRules) {\n+            InstallServer42FlowBuilder command = InstallServer42Flow.builder()\n+                    .transactionId(transactionIdGenerator.generate())\n+                    .cookie(cookie)\n+                    .switchId(switchId)\n+                    .multiTable(properties.isMultiTable())\n+                    .inputPort(0)\n+                    .outputPort(0)\n+                    .server42MacAddress(properties.getServer42MacAddress());\n+\n+            if (cookie == SERVER_42_OUTPUT_VLAN_COOKIE) {\n+                commands.add(command\n+                        .id(\"SWMANAGER_SERVER_42_OUTPUT_VLAN_RULE_INSTALL\")\n+                        .outputPort(properties.getServer42Port())\n+                        .build());\n+            } else if (cookie == SERVER_42_OUTPUT_VXLAN_COOKIE) {\n+                commands.add(command\n+                        .id(\"SWMANAGER_SERVER_42_OUTPUT_VXLAN_RULE_INSTALL\")\n+                        .outputPort(properties.getServer42Port())\n+                        .build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c17c7c16be9c6fafff9e7199dc98537fc61b7c75"}, "originalPosition": 80}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c17c7c16be9c6fafff9e7199dc98537fc61b7c75", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/c17c7c16be9c6fafff9e7199dc98537fc61b7c75", "committedDate": "2020-04-23T06:11:57Z", "message": "Server 42 RTT: Added Output rules"}, "afterCommit": {"oid": "864f69b810dacc08dd1cbc1c2bd4c95dfcc23d55", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/864f69b810dacc08dd1cbc1c2bd4c95dfcc23d55", "committedDate": "2020-04-23T08:29:23Z", "message": "Server 42 RTT: Added Output rules"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "864f69b810dacc08dd1cbc1c2bd4c95dfcc23d55", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/864f69b810dacc08dd1cbc1c2bd4c95dfcc23d55", "committedDate": "2020-04-23T08:29:23Z", "message": "Server 42 RTT: Added Output rules"}, "afterCommit": {"oid": "0b8d7e603819ed5eb9c489f5018de77d0ef6c777", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/0b8d7e603819ed5eb9c489f5018de77d0ef6c777", "committedDate": "2020-04-23T17:13:26Z", "message": "Server 42 RTT: Added Output rules"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODYxNzEx", "url": "https://github.com/telstra/open-kilda/pull/3408#pullrequestreview-399861711", "createdAt": "2020-04-24T11:25:19Z", "commit": {"oid": "0b8d7e603819ed5eb9c489f5018de77d0ef6c777"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMToyNToyMFrOGLTIvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMToyNToyMFrOGLTIvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUwMTA1Mg==", "bodyText": "nit: fieldActions", "url": "https://github.com/telstra/open-kilda/pull/3408#discussion_r414501052", "createdAt": "2020-04-24T11:25:20Z", "author": {"login": "dpoltavets"}, "path": "src-java/base-topology/base-messaging/src/main/java/org/openkilda/messaging/info/rule/FlowApplyActions.java", "diffHunk": "@@ -47,12 +48,12 @@\n \n     @JsonCreator\n     public FlowApplyActions(\n-            @JsonProperty(\"output\") String flowOutput, @JsonProperty(\"set_field\") FlowSetFieldAction fieldAction,\n+            @JsonProperty(\"output\") String flowOutput, @JsonProperty(\"set_fields\") List<FlowSetFieldAction> fieldAction,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b8d7e603819ed5eb9c489f5018de77d0ef6c777"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5OTc0MTkz", "url": "https://github.com/telstra/open-kilda/pull/3408#pullrequestreview-399974193", "createdAt": "2020-04-24T14:01:57Z", "commit": {"oid": "0b8d7e603819ed5eb9c489f5018de77d0ef6c777"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDowMTo1N1rOGLZL6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNDowOToyNFrOGLZgFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYwMDE2OQ==", "bodyText": "why not setFieldActions?", "url": "https://github.com/telstra/open-kilda/pull/3408#discussion_r414600169", "createdAt": "2020-04-24T14:01:57Z", "author": {"login": "timofei-durakov"}, "path": "src-java/base-topology/base-messaging/src/main/java/org/openkilda/messaging/info/rule/FlowApplyActions.java", "diffHunk": "@@ -30,8 +31,8 @@\n \n     @JsonProperty(\"output\")\n     private String flowOutput;\n-    @JsonProperty(\"set_field\")\n-    private FlowSetFieldAction fieldAction;\n+    @JsonProperty(\"set_fields\")\n+    private List<FlowSetFieldAction> fieldActions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b8d7e603819ed5eb9c489f5018de77d0ef6c777"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYwMjU1Mg==", "bodyText": "why this method is removed?", "url": "https://github.com/telstra/open-kilda/pull/3408#discussion_r414602552", "createdAt": "2020-04-24T14:05:27Z", "author": {"login": "timofei-durakov"}, "path": "src-java/floodlight-service/floodlight-api/src/main/java/org/openkilda/messaging/command/switches/SwitchRulesInstallRequest.java", "diffHunk": "@@ -124,13 +131,4 @@ public void setIslPorts(List<Integer> islPorts) {\n     public void setFlowPorts(List<Integer> flowPorts) {\n         this.flowPorts = flowPorts;\n     }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b8d7e603819ed5eb9c489f5018de77d0ef6c777"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYwMzc4Nw==", "bodyText": "potential npe?", "url": "https://github.com/telstra/open-kilda/pull/3408#discussion_r414603787", "createdAt": "2020-04-24T14:07:14Z", "author": {"login": "timofei-durakov"}, "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/kafka/RecordHandler.java", "diffHunk": "@@ -787,6 +808,8 @@ private void doInstallSwitchRules(final CommandMessage message) {\n \n         final IKafkaProducerService producerService = getKafkaProducer();\n         final String replyToTopic = context.getKafkaSwitchManagerTopic();\n+        Integer server42Port = request.getServer42Port();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b8d7e603819ed5eb9c489f5018de77d0ef6c777"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYwNDMzNA==", "bodyText": "the same", "url": "https://github.com/telstra/open-kilda/pull/3408#discussion_r414604334", "createdAt": "2020-04-24T14:08:01Z", "author": {"login": "timofei-durakov"}, "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/kafka/RecordHandler.java", "diffHunk": "@@ -1103,6 +1147,13 @@ private void doDeleteSwitchRules(final CommandMessage message) {\n                         processInstallDefaultFlowByCookie(request.getSwitchId(), ARP_TRANSIT_COOKIE);\n                         processInstallDefaultFlowByCookie(request.getSwitchId(), ARP_INGRESS_COOKIE);\n                     }\n+                    if (request.isServer42FlowRtt()) {\n+                        Integer server42Port = request.getServer42Port();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b8d7e603819ed5eb9c489f5018de77d0ef6c777"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDYwNTMzNQ==", "bodyText": "max_len of what? please lead a comment", "url": "https://github.com/telstra/open-kilda/pull/3408#discussion_r414605335", "createdAt": "2020-04-24T14:09:24Z", "author": {"login": "timofei-durakov"}, "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/switchmanager/SwitchFlowUtils.java", "diffHunk": "@@ -48,6 +50,7 @@\n      * OVS software switch manufacturer constant value.\n      */\n     public static final String OVS_MANUFACTURER = \"Nicira, Inc.\";\n+    private static final int MAX_LEN = 0xFFFFFFFF;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b8d7e603819ed5eb9c489f5018de77d0ef6c777"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b8d7e603819ed5eb9c489f5018de77d0ef6c777", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/0b8d7e603819ed5eb9c489f5018de77d0ef6c777", "committedDate": "2020-04-23T17:13:26Z", "message": "Server 42 RTT: Added Output rules"}, "afterCommit": {"oid": "a746ad7ef229610a57cd0cd747e79cc14a5df9cb", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/a746ad7ef229610a57cd0cd747e79cc14a5df9cb", "committedDate": "2020-04-24T15:05:32Z", "message": "Server 42 RTT: Added Output rules"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a746ad7ef229610a57cd0cd747e79cc14a5df9cb", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/a746ad7ef229610a57cd0cd747e79cc14a5df9cb", "committedDate": "2020-04-24T15:05:32Z", "message": "Server 42 RTT: Added Output rules"}, "afterCommit": {"oid": "98e7b54b0982ce90689a2a3875a91ff8b099974a", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/98e7b54b0982ce90689a2a3875a91ff8b099974a", "committedDate": "2020-04-24T15:22:06Z", "message": "Server 42 RTT: Added Output rules"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMDU0MjQ0", "url": "https://github.com/telstra/open-kilda/pull/3408#pullrequestreview-400054244", "createdAt": "2020-04-24T15:34:02Z", "commit": {"oid": "98e7b54b0982ce90689a2a3875a91ff8b099974a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4259ef1ab8b0f5a8730c1b7a19eb20cfbaf597f7", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/4259ef1ab8b0f5a8730c1b7a19eb20cfbaf597f7", "committedDate": "2020-04-27T12:29:54Z", "message": "Server 42 RTT: Added Output rules"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98e7b54b0982ce90689a2a3875a91ff8b099974a", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/98e7b54b0982ce90689a2a3875a91ff8b099974a", "committedDate": "2020-04-24T15:22:06Z", "message": "Server 42 RTT: Added Output rules"}, "afterCommit": {"oid": "4259ef1ab8b0f5a8730c1b7a19eb20cfbaf597f7", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/4259ef1ab8b0f5a8730c1b7a19eb20cfbaf597f7", "committedDate": "2020-04-27T12:29:54Z", "message": "Server 42 RTT: Added Output rules"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3628, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}