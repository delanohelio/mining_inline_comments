{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3ODExMTI0", "number": 3525, "title": "In functional tests where possible remove the VIRTUAL tag", "bodyText": "", "createdAt": "2020-06-04T12:47:15Z", "url": "https://github.com/telstra/open-kilda/pull/3525", "merged": true, "mergeCommit": {"oid": "ee37ae34607db5c3523fb92efe2546f8154b3165"}, "closed": true, "closedAt": "2020-07-03T09:33:22Z", "author": {"login": "rtretyak"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoO9r1ABqjM0MTA0MDgwMDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwnobPABqjM1MDE3ODU1OTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca66b0dd4a51657778b7110a5aad3c32810c628e", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/ca66b0dd4a51657778b7110a5aad3c32810c628e", "committedDate": "2020-06-04T12:45:49Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "94f50774138ec30b9815266f3bbafdfd1212fbb7", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/94f50774138ec30b9815266f3bbafdfd1212fbb7", "committedDate": "2020-06-05T09:08:35Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94f50774138ec30b9815266f3bbafdfd1212fbb7", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/94f50774138ec30b9815266f3bbafdfd1212fbb7", "committedDate": "2020-06-05T09:08:35Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "0603f4ffb2ace41dcaba332646272dc33b5978db", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/0603f4ffb2ace41dcaba332646272dc33b5978db", "committedDate": "2020-06-10T07:38:23Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0603f4ffb2ace41dcaba332646272dc33b5978db", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/0603f4ffb2ace41dcaba332646272dc33b5978db", "committedDate": "2020-06-10T07:38:23Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "a9bd96efa290a0155a4ea43828e193082094d203", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/a9bd96efa290a0155a4ea43828e193082094d203", "committedDate": "2020-06-10T12:17:43Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9bd96efa290a0155a4ea43828e193082094d203", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/a9bd96efa290a0155a4ea43828e193082094d203", "committedDate": "2020-06-10T12:17:43Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "f6fd9906bd0ec1678c69ecc4b4d8ebdfa862db17", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/f6fd9906bd0ec1678c69ecc4b4d8ebdfa862db17", "committedDate": "2020-06-11T09:26:42Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6fd9906bd0ec1678c69ecc4b4d8ebdfa862db17", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/f6fd9906bd0ec1678c69ecc4b4d8ebdfa862db17", "committedDate": "2020-06-11T09:26:42Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "4a5f7d2abf0bc25c4002880db610700c4fa2fced", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/4a5f7d2abf0bc25c4002880db610700c4fa2fced", "committedDate": "2020-06-12T14:24:49Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a5f7d2abf0bc25c4002880db610700c4fa2fced", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/4a5f7d2abf0bc25c4002880db610700c4fa2fced", "committedDate": "2020-06-12T14:24:49Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "5fc97eef07a89e5e5a980e66663d4e02af515867", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/5fc97eef07a89e5e5a980e66663d4e02af515867", "committedDate": "2020-06-15T10:13:22Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5fc97eef07a89e5e5a980e66663d4e02af515867", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/5fc97eef07a89e5e5a980e66663d4e02af515867", "committedDate": "2020-06-15T10:13:22Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "6938335e9b84662a52fac92de61633b467187deb", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/6938335e9b84662a52fac92de61633b467187deb", "committedDate": "2020-06-17T08:27:49Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6938335e9b84662a52fac92de61633b467187deb", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/6938335e9b84662a52fac92de61633b467187deb", "committedDate": "2020-06-17T08:27:49Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "65fa5a5c54d72b1c02e41f0c385ddb417cc5a341", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/65fa5a5c54d72b1c02e41f0c385ddb417cc5a341", "committedDate": "2020-06-23T08:32:21Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65fa5a5c54d72b1c02e41f0c385ddb417cc5a341", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/65fa5a5c54d72b1c02e41f0c385ddb417cc5a341", "committedDate": "2020-06-23T08:32:21Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "9a47837719c784b1b01ca3f5d22814da95596e66", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/9a47837719c784b1b01ca3f5d22814da95596e66", "committedDate": "2020-06-23T10:45:16Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MzgzNDY2", "url": "https://github.com/telstra/open-kilda/pull/3525#pullrequestreview-436383466", "createdAt": "2020-06-24T07:16:00Z", "commit": {"oid": "9a47837719c784b1b01ca3f5d22814da95596e66"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNzoxNjowMVrOGoF1xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNzo1NToyMFrOGoHC2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5MTkxMA==", "bodyText": "why?", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444691910", "createdAt": "2020-06-24T07:16:01Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -114,49 +117,13 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n         cleanup: \"Restore topology to the original state, remove the flow\"\n         flowHelperV2.deleteFlow(flow.flowId)\n         portDown && !portUp && antiflap.portUp(isl.dstSwitch.dpId, isl.dstPort)\n-        broughtDownPorts.every { antiflap.portUp(it.switchId, it.portNo) }\n-        Wrappers.wait(discoveryInterval + WAIT_OFFSET) {\n+        broughtDownIsls.each { antiflap.portUp(it.srcSwitch.dpId, it.srcPort) }\n+        wait(discoveryInterval + WAIT_OFFSET) {\n             assert northbound.getActiveLinks().size() == topology.islsForActiveSwitches.size() * 2\n         }\n         database.resetCosts()\n     }\n \n-    @Tags([VIRTUAL, LOW_PRIORITY])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a47837719c784b1b01ca3f5d22814da95596e66"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5NzA5Mg==", "bodyText": "I am afraid it can be unstable\nfor example:\n\nwe will have original reroute + 3 retries and move on to the next step\nin the next step(\"Flows are 'Down'\") we will get 'isl timeout'\nsystem will try to reroute the flow, flowStatus will be changed to IN_PROGRESS, but we expect that flowStatus is DOWN", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444697092", "createdAt": "2020-06-24T07:26:51Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -455,17 +421,9 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n             assert !firstFlowHistory.find { it.taskId =~ /.+ : retry #1/ }\n             def secondFlowHistory = northbound.getFlowHistory(secondFlow.flowId).findAll { it.action == REROUTE_ACTION }\n             assert secondFlowHistory.findAll { it.taskId =~ /.+ : retry #2/ }.size() >= 1\n-            // reroute caused by failed ISL on backup path\n-            assert secondFlowHistory.findAll {\n-                it.details =~ /Reason: ISL (.*) become INACTIVE because of FAIL TIMEOUT (.*)/\n-            }.size() == 1\n-            /* NOTE: retry is available for a flow when switchUp event appears on a transit switch\n-            We can't check that 3 attempts of reroute are available in flow history, system can't guarantee it.\n-            Reason: during retrying ISL on backup path can fail -> new reroute event(e.g. REROUTE_FAIL_ISL)\n-            will be triggered and put in the queue of reroute -> for instance: in the queue we have 3rd attempt\n-            and REROUTE_FAIL_ISL -> these two reroutes will be merged based on some algorithm ->\n-            system execute one reroute only.\n-            (System doesn't merge reason of reroute, it just pick any reason from queue) */\n+            /*there should be original reroute + 3 retries. We are not checking the #3 retry directly, since it may\n+            have its reason changed to 'isl timeout' because ISL is about to fail due to a disconnected switch*/\n+            assert secondFlowHistory.size() == 4", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a47837719c784b1b01ca3f5d22814da95596e66"}, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMDUxNg==", "bodyText": "rtIsls -> nonRtIsls ?", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444700516", "createdAt": "2020-06-24T07:33:51Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -474,11 +432,20 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n         }\n \n         and: \"Flows are 'Down'\"\n+        def rtIsls = topology.getRelatedIsls(switchPair1.src).findAll {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a47837719c784b1b01ca3f5d22814da95596e66"}, "originalPosition": 173}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMDcwNg==", "bodyText": "why do we need to verify non rtIsls in this test? It is already tested in RoundTripIslSpec", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444700706", "createdAt": "2020-06-24T07:34:17Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -474,11 +432,20 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n         }\n \n         and: \"Flows are 'Down'\"\n+        def rtIsls = topology.getRelatedIsls(switchPair1.src).findAll {\n+            !it.srcSwitch.features.contains(SwitchFeature.NOVIFLOW_COPY_FIELD) ||\n+                !it.dstSwitch.features.contains(SwitchFeature.NOVIFLOW_COPY_FIELD)\n+        }\n+        Wrappers.wait(discoveryTimeout) {\n+            def allLinks = northbound.getAllLinks()\n+            rtIsls.forEach { assert islUtils.getIslInfo(allLinks, it).get().state == FAILED }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a47837719c784b1b01ca3f5d22814da95596e66"}, "originalPosition": 179}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwNDIxMw==", "bodyText": "is it obsolete?", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444704213", "createdAt": "2020-06-24T07:41:22Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/switches/FlowRulesSpec.groovy", "diffHunk": "@@ -67,34 +66,6 @@ class FlowRulesSpec extends HealthCheckSpecification {\n         dstSwDefaultRules = northbound.getSwitchRules(dstSwitch.dpId).flowEntries\n     }\n \n-    @Tags([VIRTUAL, SMOKE])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a47837719c784b1b01ca3f5d22814da95596e66"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwOTMyMw==", "bodyText": "are you sure that you want to delete isl with force option ?", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444709323", "createdAt": "2020-06-24T07:51:10Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/switches/SwitchDeleteSpec.groovy", "diffHunk": "@@ -127,24 +125,18 @@ class SwitchDeleteSpec extends HealthCheckSpecification {\n         \"casual\"        | getFlowHelperV2().randomFlow(*getTopology().getActiveSwitches()[0..1])\n     }\n \n-    @Tags(VIRTUAL)\n+    @Tidy\n     def \"Able to delete an inactive switch without any ISLs\"() {\n         given: \"An inactive switch without any ISLs\"\n         def sw = topology.getActiveSwitches()[0]\n         def swIsls = topology.getRelatedIsls(sw)\n-\n-        // deactivate all active ISLs on switch\n+        // port down on all active ISLs on switch\n         swIsls.each { antiflap.portDown(sw.dpId, it.srcPort) }\n         TimeUnit.SECONDS.sleep(2) //receive any in-progress disco packets\n-        Wrappers.wait(WAIT_OFFSET) {\n-            swIsls.each { assert islUtils.getIslInfo(it).get().state == IslChangeType.FAILED }\n-        }\n-\n         // delete all ISLs on switch\n         swIsls.each {\n-            northbound.deleteLink(islUtils.toLinkParameters(it))\n+            northbound.deleteLink(islUtils.toLinkParameters(it), true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a47837719c784b1b01ca3f5d22814da95596e66"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxMTY0Mw==", "bodyText": "do we really need this verification?\non the one hand we know that switch was deleted on the other hand switch was deleted with the force option and switch is still connected to FL\nlet it be, I don't have strict opinion here", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444711643", "createdAt": "2020-06-24T07:55:20Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/switches/SwitchDeleteSpec.groovy", "diffHunk": "@@ -189,12 +178,13 @@ class SwitchDeleteSpec extends HealthCheckSpecification {\n             }\n         }\n \n-        and: \"Cleanup: restore the switch, ISLs and reset costs\"\n+        cleanup: \"Restore the switch, ISLs and reset costs\"\n         // restore switch\n         def blockData = lockKeeper.knockoutSwitch(sw, mgmtFlManager)\n-        lockKeeper.reviveSwitch(sw, blockData)\n-        Wrappers.wait(WAIT_OFFSET) { assert northbound.activeSwitches.any { it.switchId == sw.dpId } }\n-\n+        Wrappers.wait(WAIT_OFFSET) {\n+            mgmtFlManager.getFloodlightService(sw.getRegion()).getSwitches().every { it.switchId != sw.dpId }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a47837719c784b1b01ca3f5d22814da95596e66"}, "originalPosition": 149}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a47837719c784b1b01ca3f5d22814da95596e66", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/9a47837719c784b1b01ca3f5d22814da95596e66", "committedDate": "2020-06-23T10:45:16Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "cc1893883895dbdc7aa60a6fbf53ff6764633662", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/cc1893883895dbdc7aa60a6fbf53ff6764633662", "committedDate": "2020-06-25T10:38:09Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NDA2NDk0", "url": "https://github.com/telstra/open-kilda/pull/3525#pullrequestreview-437406494", "createdAt": "2020-06-25T11:33:59Z", "commit": {"oid": "cc1893883895dbdc7aa60a6fbf53ff6764633662"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc1893883895dbdc7aa60a6fbf53ff6764633662", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/cc1893883895dbdc7aa60a6fbf53ff6764633662", "committedDate": "2020-06-25T10:38:09Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "1dff8094a90a7e0a6e3c8eaad5605967ead6d4d6", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/1dff8094a90a7e0a6e3c8eaad5605967ead6d4d6", "committedDate": "2020-07-01T09:53:53Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7025be38908269b991c39395581de375bb165d09", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/7025be38908269b991c39395581de375bb165d09", "committedDate": "2020-07-01T10:24:30Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1dff8094a90a7e0a6e3c8eaad5605967ead6d4d6", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/1dff8094a90a7e0a6e3c8eaad5605967ead6d4d6", "committedDate": "2020-07-01T09:53:53Z", "message": "In functional tests where possible remove the VIRTUAL tag"}, "afterCommit": {"oid": "7025be38908269b991c39395581de375bb165d09", "author": {"user": {"login": "rtretyak", "name": "Roman Tretiak"}}, "url": "https://github.com/telstra/open-kilda/commit/7025be38908269b991c39395581de375bb165d09", "committedDate": "2020-07-01T10:24:30Z", "message": "In functional tests where possible remove the VIRTUAL tag"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3581, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}