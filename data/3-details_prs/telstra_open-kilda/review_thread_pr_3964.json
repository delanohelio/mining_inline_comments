{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2OTQzODQ2", "number": 3964, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQxNTo1MToyMVrOFSq-IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQxMDowNToyOFrOFmZWDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU1MTIyNzIwOnYy", "diffSide": "RIGHT", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQxNTo1MToyMVrOIZteZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wNVQxMDowMDo1M1rOIgaITQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgzMDM3NQ==", "bodyText": "Will only work if the ISL is non-rtl. For rtl ISLs the flow will remain UP. You can try to bring the port down on the other end of ISL to make this faster and work regardless of rtl", "url": "https://github.com/telstra/open-kilda/pull/3964#discussion_r563830375", "createdAt": "2021-01-25T15:51:21Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "diffHunk": "@@ -298,6 +306,42 @@ class FlowHistoryV2Spec extends HealthCheckSpecification {\n         ]\n     }\n \n+    @Tidy\n+    @Tags(LOW_PRIORITY)\n+    def \"Info about a terminating switch is registered in flow history while rerouting\"() {\n+        given: \"An active flow\"\n+        def (Switch srcSwitch, Switch dstSwitch) = topology.activeSwitches\n+        def flow = flowHelperV2.randomFlow(srcSwitch, dstSwitch)\n+        flowHelperV2.addFlow(flow)\n+\n+        when: \"Deactivate the src switch\"\n+        def blockData = lockKeeper.knockoutSwitch(srcSwitch, RW)\n+        def swIsActive = false\n+        Wrappers.wait(WAIT_OFFSET) {\n+            assert northbound.getSwitch(srcSwitch.dpId).state == SwitchChangeType.DEACTIVATED\n+        }\n+\n+        then: \"Flow goes DOWN\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "177d98662a2b6ddb0fe104731b7dbd66cbda2ec6"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg1MzQ1Mw==", "bodyText": "good catch\nI set the VIRTUAL tag.", "url": "https://github.com/telstra/open-kilda/pull/3964#discussion_r570853453", "createdAt": "2021-02-05T10:00:53Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "diffHunk": "@@ -298,6 +306,42 @@ class FlowHistoryV2Spec extends HealthCheckSpecification {\n         ]\n     }\n \n+    @Tidy\n+    @Tags(LOW_PRIORITY)\n+    def \"Info about a terminating switch is registered in flow history while rerouting\"() {\n+        given: \"An active flow\"\n+        def (Switch srcSwitch, Switch dstSwitch) = topology.activeSwitches\n+        def flow = flowHelperV2.randomFlow(srcSwitch, dstSwitch)\n+        flowHelperV2.addFlow(flow)\n+\n+        when: \"Deactivate the src switch\"\n+        def blockData = lockKeeper.knockoutSwitch(srcSwitch, RW)\n+        def swIsActive = false\n+        Wrappers.wait(WAIT_OFFSET) {\n+            assert northbound.getSwitch(srcSwitch.dpId).state == SwitchChangeType.DEACTIVATED\n+        }\n+\n+        then: \"Flow goes DOWN\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgzMDM3NQ=="}, "originalCommit": {"oid": "177d98662a2b6ddb0fe104731b7dbd66cbda2ec6"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU1NTM4NzQwOnYy", "diffSide": "RIGHT", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQxMjozNjowMVrOIaU-jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wNVQwODo1ODo1M1rOIgXv6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDQ3NzU4MA==", "bodyText": "This is a bit misleading description. We should not really try to reroute a flow when terminating switch is down. We just change its status to DOWN without attempting to find a new path. Technically it's a part of 'reroute' process, but practically we are not even trying to find a new 'route'", "url": "https://github.com/telstra/open-kilda/pull/3964#discussion_r564477580", "createdAt": "2021-01-26T12:36:01Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "diffHunk": "@@ -298,6 +306,42 @@ class FlowHistoryV2Spec extends HealthCheckSpecification {\n         ]\n     }\n \n+    @Tidy\n+    @Tags(LOW_PRIORITY)\n+    def \"Info about a terminating switch is registered in flow history while rerouting\"() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "177d98662a2b6ddb0fe104731b7dbd66cbda2ec6"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDgxNDQ0Mg==", "bodyText": "changed to \"Root cause is registered in flow history while rerouting\"", "url": "https://github.com/telstra/open-kilda/pull/3964#discussion_r570814442", "createdAt": "2021-02-05T08:58:53Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "diffHunk": "@@ -298,6 +306,42 @@ class FlowHistoryV2Spec extends HealthCheckSpecification {\n         ]\n     }\n \n+    @Tidy\n+    @Tags(LOW_PRIORITY)\n+    def \"Info about a terminating switch is registered in flow history while rerouting\"() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDQ3NzU4MA=="}, "originalCommit": {"oid": "177d98662a2b6ddb0fe104731b7dbd66cbda2ec6"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU1NTM5MjM5OnYy", "diffSide": "RIGHT", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQxMjozNzozMFrOIaVBhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wNVQxMDowMTo1MlrOIgaKlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDQ3ODM0MQ==", "bodyText": "when: \"Deactivate the src switch\"\nthen: \"Flow goes DOWN\"\n\nThis currently looks like the fact of switch deactivation has brought the flow down, which is not true. Only ISL failure can change the flow status", "url": "https://github.com/telstra/open-kilda/pull/3964#discussion_r564478341", "createdAt": "2021-01-26T12:37:30Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "diffHunk": "@@ -298,6 +306,42 @@ class FlowHistoryV2Spec extends HealthCheckSpecification {\n         ]\n     }\n \n+    @Tidy\n+    @Tags(LOW_PRIORITY)\n+    def \"Info about a terminating switch is registered in flow history while rerouting\"() {\n+        given: \"An active flow\"\n+        def (Switch srcSwitch, Switch dstSwitch) = topology.activeSwitches\n+        def flow = flowHelperV2.randomFlow(srcSwitch, dstSwitch)\n+        flowHelperV2.addFlow(flow)\n+\n+        when: \"Deactivate the src switch\"\n+        def blockData = lockKeeper.knockoutSwitch(srcSwitch, RW)\n+        def swIsActive = false\n+        Wrappers.wait(WAIT_OFFSET) {\n+            assert northbound.getSwitch(srcSwitch.dpId).state == SwitchChangeType.DEACTIVATED\n+        }\n+\n+        then: \"Flow goes DOWN\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "177d98662a2b6ddb0fe104731b7dbd66cbda2ec6"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg1NDAzNg==", "bodyText": "refactored\nwhen: \"Deactivate the src switch\"\nand: \"Related ISLs are FAILED\"\nthen: \"Flow goes DOWN\"", "url": "https://github.com/telstra/open-kilda/pull/3964#discussion_r570854036", "createdAt": "2021-02-05T10:01:52Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "diffHunk": "@@ -298,6 +306,42 @@ class FlowHistoryV2Spec extends HealthCheckSpecification {\n         ]\n     }\n \n+    @Tidy\n+    @Tags(LOW_PRIORITY)\n+    def \"Info about a terminating switch is registered in flow history while rerouting\"() {\n+        given: \"An active flow\"\n+        def (Switch srcSwitch, Switch dstSwitch) = topology.activeSwitches\n+        def flow = flowHelperV2.randomFlow(srcSwitch, dstSwitch)\n+        flowHelperV2.addFlow(flow)\n+\n+        when: \"Deactivate the src switch\"\n+        def blockData = lockKeeper.knockoutSwitch(srcSwitch, RW)\n+        def swIsActive = false\n+        Wrappers.wait(WAIT_OFFSET) {\n+            assert northbound.getSwitch(srcSwitch.dpId).state == SwitchChangeType.DEACTIVATED\n+        }\n+\n+        then: \"Flow goes DOWN\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDQ3ODM0MQ=="}, "originalCommit": {"oid": "177d98662a2b6ddb0fe104731b7dbd66cbda2ec6"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU1NTQxMTQ1OnYy", "diffSide": "RIGHT", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQxMjo0MjozMlrOIaVMzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wNVQxMDowNToyN1rOIgaSoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDQ4MTIyOA==", "bodyText": "It's better to use switchHelper.reviveSwitch instead", "url": "https://github.com/telstra/open-kilda/pull/3964#discussion_r564481228", "createdAt": "2021-01-26T12:42:32Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "diffHunk": "@@ -298,6 +306,42 @@ class FlowHistoryV2Spec extends HealthCheckSpecification {\n         ]\n     }\n \n+    @Tidy\n+    @Tags(LOW_PRIORITY)\n+    def \"Info about a terminating switch is registered in flow history while rerouting\"() {\n+        given: \"An active flow\"\n+        def (Switch srcSwitch, Switch dstSwitch) = topology.activeSwitches\n+        def flow = flowHelperV2.randomFlow(srcSwitch, dstSwitch)\n+        flowHelperV2.addFlow(flow)\n+\n+        when: \"Deactivate the src switch\"\n+        def blockData = lockKeeper.knockoutSwitch(srcSwitch, RW)\n+        def swIsActive = false\n+        Wrappers.wait(WAIT_OFFSET) {\n+            assert northbound.getSwitch(srcSwitch.dpId).state == SwitchChangeType.DEACTIVATED\n+        }\n+\n+        then: \"Flow goes DOWN\"\n+        Wrappers.wait(discoveryTimeout + WAIT_OFFSET) {\n+            def flowInfo = northboundV2.getFlow(flow.flowId)\n+            assert flowInfo.status == FlowState.DOWN.toString()\n+            assert flowInfo.statusInfo == \"ValidateFlowAction failed: Flow's $flow.flowId src switch is not active\"\n+        }\n+\n+        and: \"The 'Switch is not active' message is registered in flow history\"\n+        def flowHistory = northbound.getFlowHistory(flow.flowId).find { it.action == REROUTE_ACTION }\n+        assert flowHistory.payload[0].action == \"Started flow validation\"\n+        assert flowHistory.payload[1].action == \"ValidateFlowAction failed: Flow's $flow.flowId src switch is not active\"\n+        assert flowHistory.payload[2].action == REROUTE_FAIL\n+\n+        cleanup:\n+        if (!swIsActive) {\n+            lockKeeper.reviveSwitch(srcSwitch, blockData)\n+            Wrappers.wait(WAIT_OFFSET) { northbound.getSwitch(srcSwitch.dpId).state == SwitchChangeType.ACTIVATED }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "177d98662a2b6ddb0fe104731b7dbd66cbda2ec6"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDg1NjA5Ng==", "bodyText": "fixed", "url": "https://github.com/telstra/open-kilda/pull/3964#discussion_r570856096", "createdAt": "2021-02-05T10:05:27Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "diffHunk": "@@ -298,6 +306,42 @@ class FlowHistoryV2Spec extends HealthCheckSpecification {\n         ]\n     }\n \n+    @Tidy\n+    @Tags(LOW_PRIORITY)\n+    def \"Info about a terminating switch is registered in flow history while rerouting\"() {\n+        given: \"An active flow\"\n+        def (Switch srcSwitch, Switch dstSwitch) = topology.activeSwitches\n+        def flow = flowHelperV2.randomFlow(srcSwitch, dstSwitch)\n+        flowHelperV2.addFlow(flow)\n+\n+        when: \"Deactivate the src switch\"\n+        def blockData = lockKeeper.knockoutSwitch(srcSwitch, RW)\n+        def swIsActive = false\n+        Wrappers.wait(WAIT_OFFSET) {\n+            assert northbound.getSwitch(srcSwitch.dpId).state == SwitchChangeType.DEACTIVATED\n+        }\n+\n+        then: \"Flow goes DOWN\"\n+        Wrappers.wait(discoveryTimeout + WAIT_OFFSET) {\n+            def flowInfo = northboundV2.getFlow(flow.flowId)\n+            assert flowInfo.status == FlowState.DOWN.toString()\n+            assert flowInfo.statusInfo == \"ValidateFlowAction failed: Flow's $flow.flowId src switch is not active\"\n+        }\n+\n+        and: \"The 'Switch is not active' message is registered in flow history\"\n+        def flowHistory = northbound.getFlowHistory(flow.flowId).find { it.action == REROUTE_ACTION }\n+        assert flowHistory.payload[0].action == \"Started flow validation\"\n+        assert flowHistory.payload[1].action == \"ValidateFlowAction failed: Flow's $flow.flowId src switch is not active\"\n+        assert flowHistory.payload[2].action == REROUTE_FAIL\n+\n+        cleanup:\n+        if (!swIsActive) {\n+            lockKeeper.reviveSwitch(srcSwitch, blockData)\n+            Wrappers.wait(WAIT_OFFSET) { northbound.getSwitch(srcSwitch.dpId).state == SwitchChangeType.ACTIVATED }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDQ4MTIyOA=="}, "originalCommit": {"oid": "177d98662a2b6ddb0fe104731b7dbd66cbda2ec6"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzc1ODA1NDU0OnYy", "diffSide": "RIGHT", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQxMDowNToyOFrOI3dTkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQxMToyNTo0MFrOI3gy1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTAyMjczOA==", "bodyText": "It will work as it is now, but it's only because of our current setup.\n\nYou can explicitly pick switches that do not support rtl, so that this behavior is strictly defined\nor You can force a flow reroute by bringing some port down on the path. This way you will no longer be dependent on whether isls are rtl or not", "url": "https://github.com/telstra/open-kilda/pull/3964#discussion_r595022738", "createdAt": "2021-03-16T10:05:28Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "diffHunk": "@@ -298,6 +307,46 @@ class FlowHistoryV2Spec extends HealthCheckSpecification {\n         ]\n     }\n \n+    @Tidy\n+    @Tags([VIRTUAL, LOW_PRIORITY])\n+    //it doesn't work on the hardware env due to the 'round trip latency' feature", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3d4482af08be33f70ea87be392b925c060964bb"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTA3OTg5Mw==", "bodyText": "agree, refactored.\nthe first option was implemented", "url": "https://github.com/telstra/open-kilda/pull/3964#discussion_r595079893", "createdAt": "2021-03-16T11:25:40Z", "author": {"login": "andriidovhan"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowHistoryV2Spec.groovy", "diffHunk": "@@ -298,6 +307,46 @@ class FlowHistoryV2Spec extends HealthCheckSpecification {\n         ]\n     }\n \n+    @Tidy\n+    @Tags([VIRTUAL, LOW_PRIORITY])\n+    //it doesn't work on the hardware env due to the 'round trip latency' feature", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTAyMjczOA=="}, "originalCommit": {"oid": "e3d4482af08be33f70ea87be392b925c060964bb"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2219, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}