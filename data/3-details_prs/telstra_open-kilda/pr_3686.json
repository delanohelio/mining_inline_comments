{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2OTMxMjUy", "number": 3686, "title": "refactor tests(make sure that flowReroute is finished)", "bodyText": "From time to time some tests can be unstable on jenkins due to Flow is IN_PROGRESS state\nThis PR should reduce the risk of the mentioned issue.", "createdAt": "2020-08-12T18:18:22Z", "url": "https://github.com/telstra/open-kilda/pull/3686", "merged": true, "mergeCommit": {"oid": "e79852912eb904f7685ec61f0467497b5700151a"}, "closed": true, "closedAt": "2020-08-28T07:52:05Z", "author": {"login": "andriidovhan"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-PuTIABqjM2NDg5MzYyMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCmSvogBqjM2OTMyOTcyOTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d0903ca0af67320abac578bd2299c851cc423e3", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/3d0903ca0af67320abac578bd2299c851cc423e3", "committedDate": "2020-08-12T18:13:25Z", "message": "refactor tests(make sure that flowReroute is finished)"}, "afterCommit": {"oid": "357361bc2076acaf1109da5562a42c97aaa90256", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/357361bc2076acaf1109da5562a42c97aaa90256", "committedDate": "2020-08-12T18:28:20Z", "message": "refactor tests(make sure that flowReroute is finished)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "357361bc2076acaf1109da5562a42c97aaa90256", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/357361bc2076acaf1109da5562a42c97aaa90256", "committedDate": "2020-08-12T18:28:20Z", "message": "refactor tests(make sure that flowReroute is finished)"}, "afterCommit": {"oid": "8d0eb2d6504f1ab633c37c56a56cf8b564506373", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/8d0eb2d6504f1ab633c37c56a56cf8b564506373", "committedDate": "2020-08-12T18:31:04Z", "message": "refactor tests(make sure that flowReroute is finished)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d0eb2d6504f1ab633c37c56a56cf8b564506373", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/8d0eb2d6504f1ab633c37c56a56cf8b564506373", "committedDate": "2020-08-12T18:31:04Z", "message": "refactor tests(make sure that flowReroute is finished)"}, "afterCommit": {"oid": "ee2726bab74b156b36e2d48d4dd17333f806cd2d", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/ee2726bab74b156b36e2d48d4dd17333f806cd2d", "committedDate": "2020-08-13T13:28:07Z", "message": "refactor tests(make sure that flowReroute is finished)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODMwNDY1", "url": "https://github.com/telstra/open-kilda/pull/3686#pullrequestreview-466830465", "createdAt": "2020-08-13T14:42:30Z", "commit": {"oid": "ee2726bab74b156b36e2d48d4dd17333f806cd2d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNDo0MjozMFrOHAOziw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNDo0NjowN1rOHAO9vA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwNDYxOQ==", "bodyText": "I don't understand this. Test is about update, not reroute. Moreover, it is questionable whether this retry even has to happen at all", "url": "https://github.com/telstra/open-kilda/pull/3686#discussion_r470004619", "createdAt": "2020-08-13T14:42:30Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/BandwidthV2Spec.groovy", "diffHunk": "@@ -295,6 +295,13 @@ class BandwidthV2Spec extends HealthCheckSpecification {\n         flowPathAfterUpdate == flowPath\n         checkBandwidth(flowPathAfterUpdate, linksBeforeFlowCreate, linksAfterFlowUpdate)\n \n+        and: \"System retries to reroute the flow with ignored bandwidth\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee2726bab74b156b36e2d48d4dd17333f806cd2d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwNzIyOA==", "bodyText": "This is a questionable solution, since we are not checking that the reroute operation has finished. You only check that flow is down (can be the result of original reroute or initial status change before reroute) and that the reroute retry has happened. You are not checking that reroute action has finished. Previous implementation did check the final 'REROUTE_FAIL' status of the operation.\nsame about other similar places in this pr", "url": "https://github.com/telstra/open-kilda/pull/3686#discussion_r470007228", "createdAt": "2020-08-13T14:46:07Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/ProtectedPathSpec.groovy", "diffHunk": "@@ -970,7 +971,9 @@ class ProtectedPathSpec extends HealthCheckSpecification {\n         then: \"Flow state is changed to DOWN\"\n         Wrappers.wait(WAIT_OFFSET) {\n             assert northbound.getFlowStatus(flow.id).status == FlowState.DOWN\n-            assert northbound.getFlowHistory(flow.id).last().payload.find { it.action == REROUTE_FAIL }\n+            assert northbound.getFlowHistory(flow.id).find {\n+                it.action == REROUTE_ACTION && it.taskId =~ (/.+ : retry #1 ignore_bw true/)\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee2726bab74b156b36e2d48d4dd17333f806cd2d"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee2726bab74b156b36e2d48d4dd17333f806cd2d", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/ee2726bab74b156b36e2d48d4dd17333f806cd2d", "committedDate": "2020-08-13T13:28:07Z", "message": "refactor tests(make sure that flowReroute is finished)"}, "afterCommit": {"oid": "25d5ed984341464fa890b5a8a7f1960ca1a1dafc", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/25d5ed984341464fa890b5a8a7f1960ca1a1dafc", "committedDate": "2020-08-14T14:07:01Z", "message": "refactor tests(make sure that flowReroute is finished)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "25d5ed984341464fa890b5a8a7f1960ca1a1dafc", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/25d5ed984341464fa890b5a8a7f1960ca1a1dafc", "committedDate": "2020-08-14T14:07:01Z", "message": "refactor tests(make sure that flowReroute is finished)"}, "afterCommit": {"oid": "8a94f8263bba4f410eba5ceeb3dd753cf218338a", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/8a94f8263bba4f410eba5ceeb3dd753cf218338a", "committedDate": "2020-08-25T05:46:54Z", "message": "refactor tests(make sure that flowReroute is finished)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MjE5NTgx", "url": "https://github.com/telstra/open-kilda/pull/3686#pullrequestreview-474219581", "createdAt": "2020-08-25T07:48:30Z", "commit": {"oid": "8a94f8263bba4f410eba5ceeb3dd753cf218338a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwNzo0ODozMFrOHGLwLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwNzo0ODozMFrOHGLwLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0NjA2Mg==", "bodyText": "should be either }?.payload?.last()?.action or just don't use safe navigation at all", "url": "https://github.com/telstra/open-kilda/pull/3686#discussion_r476246062", "createdAt": "2020-08-25T07:48:30Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteSpec.groovy", "diffHunk": "@@ -80,7 +82,12 @@ class AutoRerouteSpec extends HealthCheckSpecification {\n         def portDown = antiflap.portDown(isl.dstSwitch.dpId, isl.dstPort)\n \n         then: \"The flow becomes 'Down'\"\n-        Wrappers.wait(rerouteDelay + WAIT_OFFSET) { assert northbound.getFlowStatus(flow.id).status == FlowState.DOWN }\n+        Wrappers.wait(rerouteDelay + WAIT_OFFSET) {\n+            assert northbound.getFlowStatus(flow.id).status == FlowState.DOWN\n+            assert northbound.getFlowHistory(flow.id).find {\n+                it.action == REROUTE_ACTION && it.taskId =~ (/.+ : retry #1 ignore_bw true/)\n+            }?.payload.last().action == REROUTE_FAIL", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a94f8263bba4f410eba5ceeb3dd753cf218338a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MjE5NjE3", "url": "https://github.com/telstra/open-kilda/pull/3686#pullrequestreview-474219617", "createdAt": "2020-08-25T07:48:33Z", "commit": {"oid": "8a94f8263bba4f410eba5ceeb3dd753cf218338a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a94f8263bba4f410eba5ceeb3dd753cf218338a", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/8a94f8263bba4f410eba5ceeb3dd753cf218338a", "committedDate": "2020-08-25T05:46:54Z", "message": "refactor tests(make sure that flowReroute is finished)"}, "afterCommit": {"oid": "6c951ea251aca31c394597559a60cce7dc321c82", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/6c951ea251aca31c394597559a60cce7dc321c82", "committedDate": "2020-08-25T13:20:52Z", "message": "refactor tests(make sure that flowReroute is finished)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8371fef803cc5470531cf9065f7b6fd667b9b3df", "author": {"user": {"login": "rozdy", "name": "Ievgen Rozdymakha"}}, "url": "https://github.com/telstra/open-kilda/commit/8371fef803cc5470531cf9065f7b6fd667b9b3df", "committedDate": "2020-08-25T14:03:08Z", "message": "Fix reroutes for max_latency path computation strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b121a74421ea3057f1e8105a545b39764eca1cc", "author": {"user": {"login": "timofei-durakov", "name": "Timofey Durakov"}}, "url": "https://github.com/telstra/open-kilda/commit/0b121a74421ea3057f1e8105a545b39764eca1cc", "committedDate": "2020-08-25T18:56:13Z", "message": "Merge pull request #3696 from telstra/fix-reroutes-for-max-latency\n\nFix reroutes for max_latency path computation strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64111f7a7150119f82905cf2cd067185c95cedbd", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/64111f7a7150119f82905cf2cd067185c95cedbd", "committedDate": "2020-08-26T07:01:41Z", "message": "refactor tests(make sure that flowReroute is finished)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c951ea251aca31c394597559a60cce7dc321c82", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/6c951ea251aca31c394597559a60cce7dc321c82", "committedDate": "2020-08-25T13:20:52Z", "message": "refactor tests(make sure that flowReroute is finished)"}, "afterCommit": {"oid": "64111f7a7150119f82905cf2cd067185c95cedbd", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/64111f7a7150119f82905cf2cd067185c95cedbd", "committedDate": "2020-08-26T07:01:41Z", "message": "refactor tests(make sure that flowReroute is finished)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3553, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}