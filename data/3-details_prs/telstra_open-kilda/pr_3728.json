{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMTYwMzYy", "number": 3728, "title": "update port/vlan should not cause reroute", "bodyText": "", "createdAt": "2020-09-21T09:26:18Z", "url": "https://github.com/telstra/open-kilda/pull/3728", "merged": true, "mergeCommit": {"oid": "f65a343b36a697d2dc6b4fa182e18db0ae2417e4"}, "closed": true, "closedAt": "2020-09-28T07:27:13Z", "author": {"login": "timofei-durakov"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLwOSVgBqjM3OTkzMDY5NTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdM9ofrAFqTQ5NzA3NjA1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "698e7dcb2122fdd90c4a6a5b2ed9cf6f26280ee3", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/698e7dcb2122fdd90c4a6a5b2ed9cf6f26280ee3", "committedDate": "2020-09-21T09:25:34Z", "message": "update port/vlan should not cause reroute"}, "afterCommit": {"oid": "9c33eaae53bf16c92eb7ae5a0e8c9d01f049803d", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/9c33eaae53bf16c92eb7ae5a0e8c9d01f049803d", "committedDate": "2020-09-23T17:41:06Z", "message": "update port/vlan should not cause reroute"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c33eaae53bf16c92eb7ae5a0e8c9d01f049803d", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/9c33eaae53bf16c92eb7ae5a0e8c9d01f049803d", "committedDate": "2020-09-23T17:41:06Z", "message": "update port/vlan should not cause reroute"}, "afterCommit": {"oid": "143363279802b3288787476b082285ac22d481ab", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/143363279802b3288787476b082285ac22d481ab", "committedDate": "2020-09-23T19:34:41Z", "message": "update port/vlan should not cause reroute"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "143363279802b3288787476b082285ac22d481ab", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/143363279802b3288787476b082285ac22d481ab", "committedDate": "2020-09-23T19:34:41Z", "message": "update port/vlan should not cause reroute"}, "afterCommit": {"oid": "332f335944e73c553cc506f6ba22fa843721d0a1", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/332f335944e73c553cc506f6ba22fa843721d0a1", "committedDate": "2020-09-23T20:12:43Z", "message": "update port/vlan should not cause reroute"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "332f335944e73c553cc506f6ba22fa843721d0a1", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/332f335944e73c553cc506f6ba22fa843721d0a1", "committedDate": "2020-09-23T20:12:43Z", "message": "update port/vlan should not cause reroute"}, "afterCommit": {"oid": "b3c63f1dd21e465be4d5dc62fb90f37064356e52", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/b3c63f1dd21e465be4d5dc62fb90f37064356e52", "committedDate": "2020-09-24T08:33:54Z", "message": "update port/vlan should not cause reroute"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3c63f1dd21e465be4d5dc62fb90f37064356e52", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/b3c63f1dd21e465be4d5dc62fb90f37064356e52", "committedDate": "2020-09-24T08:33:54Z", "message": "update port/vlan should not cause reroute"}, "afterCommit": {"oid": "830cb64f0e5d069e2fe2dab710ef5cbb9fe9a3ce", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/830cb64f0e5d069e2fe2dab710ef5cbb9fe9a3ce", "committedDate": "2020-09-24T08:49:41Z", "message": "update port/vlan should not cause reroute"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "830cb64f0e5d069e2fe2dab710ef5cbb9fe9a3ce", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/830cb64f0e5d069e2fe2dab710ef5cbb9fe9a3ce", "committedDate": "2020-09-24T08:49:41Z", "message": "update port/vlan should not cause reroute"}, "afterCommit": {"oid": "d4f906cce5aa8061e5520a472183ef0116516289", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/d4f906cce5aa8061e5520a472183ef0116516289", "committedDate": "2020-09-24T09:23:32Z", "message": "update port/vlan should not cause reroute"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjI1NDU1", "url": "https://github.com/telstra/open-kilda/pull/3728#pullrequestreview-495625455", "createdAt": "2020-09-24T14:20:29Z", "commit": {"oid": "a2355e48a1316b46dcec2cfbb3d3e1bff282ea7c"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDoyMDoyOVrOHXdTQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNzo0MDoxMVrOHXlr0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1OTM2Mw==", "bodyText": "nit: add new line", "url": "https://github.com/telstra/open-kilda/pull/3728#discussion_r494359363", "createdAt": "2020-09-24T14:20:29Z", "author": {"login": "niksv"}, "path": "docs/design/hub-and-spoke/crud/update/flow-update-fsm.puml", "diffHunk": "@@ -0,0 +1,143 @@\n+flow-update-fsm.png was created with draw.io to make the diagram easier to read.\n+\n+The current file was created so that in the case of a FSM design change we have the textual difference of what was\n+changed. This file exactly describes all the transitions in the implemented FSM.\n+\n+@startuml\n+title Flow Update FSM\n+hide empty description\n+\n+[*] --> FLOW_VALIDATED : next\n+[*] --> FINISHED_WITH_ERROR : error\n+\n+FLOW_VALIDATED --> FLOW_UPDATED : next\n+FLOW_VALIDATED --> REVERTING_FLOW_STATUS : timeout\n+FLOW_VALIDATED --> REVERTING_FLOW_STATUS : error\n+\n+FLOW_UPDATED --> PRIMARY_RESOURCES_ALLOCATED : next\n+FLOW_UPDATED --> RESOURCE_ALLOCATION_COMPLETED : update-endpoint-rules-only\n+FLOW_UPDATED --> REVERTING_FLOW: timeout\n+FLOW_UPDATED --> REVERTING_FLOW: error\n+\n+PRIMARY_RESOURCES_ALLOCATED --> PROTECTED_RESOURCES_ALLOCATED : next\n+PRIMARY_RESOURCES_ALLOCATED --> NEW_RULES_REVERTED : timeout\n+PRIMARY_RESOURCES_ALLOCATED --> NEW_RULES_REVERTED : error\n+PRIMARY_RESOURCES_ALLOCATED --> REVERTING_ALLOCATED_RESOURCES : no-path-found\n+\n+PROTECTED_RESOURCES_ALLOCATED --> RESOURCE_ALLOCATION_COMPLETED : next\n+PROTECTED_RESOURCES_ALLOCATED --> NEW_RULES_REVERTED : timeout\n+PROTECTED_RESOURCES_ALLOCATED --> NEW_RULES_REVERTED : error\n+PROTECTED_RESOURCES_ALLOCATED --> REVERTING_ALLOCATED_RESOURCES : no-path-found\n+\n+RESOURCE_ALLOCATION_COMPLETED --> INSTALLING_NON_INGRESS_RULES : next\n+RESOURCE_ALLOCATION_COMPLETED --> NEW_RULES_REVERTED : timeout\n+RESOURCE_ALLOCATION_COMPLETED --> NEW_RULES_REVERTED : error\n+\n+INSTALLING_NON_INGRESS_RULES : response-received / remove pending command\n+INSTALLING_NON_INGRESS_RULES : error-received / put failed command\n+INSTALLING_NON_INGRESS_RULES --> NON_INGRESS_RULES_INSTALLED : rules-installed\n+INSTALLING_NON_INGRESS_RULES --> PATHS_SWAP_REVERTED : timeout\n+INSTALLING_NON_INGRESS_RULES --> PATHS_SWAP_REVERTED : error\n+\n+NON_INGRESS_RULES_INSTALLED --> VALIDATING_NON_INGRESS_RULES : next\n+NON_INGRESS_RULES_INSTALLED --> PATHS_SWAP_REVERTED : timeout\n+NON_INGRESS_RULES_INSTALLED --> PATHS_SWAP_REVERTED : error\n+\n+VALIDATING_NON_INGRESS_RULES : response-received / remove pending command\n+VALIDATING_NON_INGRESS_RULES : error-received / put failed command\n+VALIDATING_NON_INGRESS_RULES --> NON_INGRESS_RULES_VALIDATED : rules-validated\n+VALIDATING_NON_INGRESS_RULES --> PATHS_SWAP_REVERTED : timeout\n+VALIDATING_NON_INGRESS_RULES --> PATHS_SWAP_REVERTED : error\n+VALIDATING_NON_INGRESS_RULES --> PATHS_SWAP_REVERTED : missing-rule-found\n+\n+NON_INGRESS_RULES_VALIDATED --> PATHS_SWAPPED : next\n+NON_INGRESS_RULES_VALIDATED --> REVERTING_PATHS_SWAP : timeout\n+NON_INGRESS_RULES_VALIDATED --> REVERTING_PATHS_SWAP : error\n+\n+PATHS_SWAPPED --> INSTALLING_INGRESS_RULES : next\n+PATHS_SWAPPED --> REVERTING_PATHS_SWAP : timeout\n+PATHS_SWAPPED --> REVERTING_PATHS_SWAP : error\n+\n+INSTALLING_INGRESS_RULES : response-received / remove pending command\n+INSTALLING_INGRESS_RULES : error-received / put failed command\n+INSTALLING_INGRESS_RULES --> INGRESS_RULES_INSTALLED : rules-installed\n+INSTALLING_INGRESS_RULES --> INGRESS_RULES_INSTALLED : ingress-is-skipped\n+INSTALLING_INGRESS_RULES --> REVERTING_PATHS_SWAP : timeout\n+INSTALLING_INGRESS_RULES --> REVERTING_PATHS_SWAP : error\n+\n+INGRESS_RULES_INSTALLED --> VALIDATING_INGRESS_RULES : next\n+INGRESS_RULES_INSTALLED --> REVERTING_PATHS_SWAP : timeout\n+INGRESS_RULES_INSTALLED --> REVERTING_PATHS_SWAP : error\n+\n+VALIDATING_INGRESS_RULES : response-received / remove pending command\n+VALIDATING_INGRESS_RULES : error-received / put failed command\n+VALIDATING_INGRESS_RULES --> INGRESS_RULES_VALIDATED : rules-validated\n+VALIDATING_INGRESS_RULES --> REVERTING_PATHS_SWAP : timeout\n+VALIDATING_INGRESS_RULES --> REVERTING_PATHS_SWAP : error\n+VALIDATING_INGRESS_RULES --> REVERTING_PATHS_SWAP : missing-rule-found\n+\n+INGRESS_RULES_VALIDATED --> NEW_PATHS_INSTALLATION_COMPLETED : next\n+INGRESS_RULES_VALIDATED --> REVERTING_PATHS_SWAP : timeout\n+INGRESS_RULES_VALIDATED --> REVERTING_PATHS_SWAP : error\n+\n+NEW_PATHS_INSTALLATION_COMPLETED --> REMOVING_OLD_RULES : next\n+NEW_PATHS_INSTALLATION_COMPLETED --> REVERTING_PATHS_SWAP : timeout\n+NEW_PATHS_INSTALLATION_COMPLETED --> REVERTING_PATHS_SWAP : error\n+\n+REMOVING_OLD_RULES : response-received / remove pending command\n+REMOVING_OLD_RULES : error-received / put failed command\n+REMOVING_OLD_RULES --> OLD_RULES_REMOVED : rules-removed\n+REMOVING_OLD_RULES --> OLD_RULES_REMOVED : error\n+\n+OLD_RULES_REMOVED --> OLD_PATHS_REMOVAL_COMPLETED : next\n+OLD_RULES_REMOVED --> UPDATING_FLOW_STATUS : update-endpoint-rules-only\n+\n+OLD_PATHS_REMOVAL_COMPLETED --> DEALLOCATING_OLD_RESOURCES : next\n+OLD_PATHS_REMOVAL_COMPLETED --> DEALLOCATING_OLD_RESOURCES : error\n+\n+DEALLOCATING_OLD_RESOURCES --> OLD_RESOURCES_DEALLOCATED : next\n+\n+OLD_RESOURCES_DEALLOCATED --> UPDATING_FLOW_STATUS : next\n+OLD_RESOURCES_DEALLOCATED --> UPDATING_FLOW_STATUS : error\n+\n+UPDATING_FLOW_STATUS --> FLOW_STATUS_UPDATED : next\n+\n+FLOW_STATUS_UPDATED --> FINISHED : next\n+FLOW_STATUS_UPDATED --> FINISHED_WITH_ERROR : error\n+\n+FINISHED --> [*]\n+\n+FINISHED_WITH_ERROR : enter / report error\n+FINISHED_WITH_ERROR --> [*]\n+\n+REVERTING_PATHS_SWAP : enter / report error\n+REVERTING_PATHS_SWAP --> PATHS_SWAP_REVERTED : next\n+\n+PATHS_SWAP_REVERTED : enter / report error\n+PATHS_SWAP_REVERTED --> REVERTING_NEW_RULES : next\n+PATHS_SWAP_REVERTED --> REVERTING_NEW_RULES : error\n+\n+REVERTING_NEW_RULES : response-received / remove pending command\n+REVERTING_NEW_RULES : error-received / put failed command\n+REVERTING_NEW_RULES --> NEW_RULES_REVERTED : rules-removed\n+REVERTING_NEW_RULES --> NEW_RULES_REVERTED : error\n+\n+NEW_RULES_REVERTED --> REVERTING_ALLOCATED_RESOURCES : next\n+NEW_RULES_REVERTED --> REVERTING_ALLOCATED_RESOURCES : error\n+NEW_RULES_REVERTED --> REVERTING_FLOW : update-endpoint-rules-only\n+\n+REVERTING_ALLOCATED_RESOURCES : enter / report error\n+REVERTING_ALLOCATED_RESOURCES --> RESOURCES_ALLOCATION_REVERTED : next\n+REVERTING_ALLOCATED_RESOURCES --> RESOURCES_ALLOCATION_REVERTED : error\n+\n+RESOURCES_ALLOCATION_REVERTED --> REVERTING_FLOW : next\n+RESOURCES_ALLOCATION_REVERTED --> REVERTING_FLOW : error\n+\n+REVERTING_FLOW : enter / report error\n+REVERTING_FLOW --> REVERTING_FLOW_STATUS : next\n+REVERTING_FLOW --> REVERTING_FLOW_STATUS : error\n+\n+REVERTING_FLOW_STATUS --> FINISHED_WITH_ERROR : next\n+REVERTING_FLOW_STATUS --> FINISHED_WITH_ERROR : error\n+\n+@enduml", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2355e48a1316b46dcec2cfbb3d3e1bff282ea7c"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ5NjcyMA==", "bodyText": "It should be fine but I'll ask just  in case. Did you checked that enabling/disabling of connected devices on flow endpoint works correct if we change connected devices flag and src_port (for example)? I'm worried about situation when we install Ingress/egress rules and adds some new rules (like connected devices) in one command.", "url": "https://github.com/telstra/open-kilda/pull/3728#discussion_r494496720", "createdAt": "2020-09-24T17:40:11Z", "author": {"login": "niksv"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/update/actions/UpdateFlowAction.java", "diffHunk": "@@ -159,6 +185,44 @@ private String getOrCreateFlowGroupId(String flowId) throws FlowProcessingExcept\n                         format(\"Flow %s not found\", flowId)));\n     }\n \n+    private FlowUpdateFsm.EndpointUpdate updateEndpointRulesOnly(RequestedFlow originalFlow, RequestedFlow targetFlow,\n+                                                                 String originalGroupId, String targetGroupId) {\n+        boolean updateEndpointOnly = originalFlow.getSrcSwitch().equals(targetFlow.getSrcSwitch());\n+        updateEndpointOnly &= originalFlow.getDestSwitch().equals(targetFlow.getDestSwitch());\n+\n+        updateEndpointOnly &= originalFlow.isAllocateProtectedPath() == targetFlow.isAllocateProtectedPath();\n+        updateEndpointOnly &= originalFlow.getBandwidth() == targetFlow.getBandwidth();\n+        updateEndpointOnly &= originalFlow.isIgnoreBandwidth() == targetFlow.isIgnoreBandwidth();\n+\n+        updateEndpointOnly &= Objects.equal(originalFlow.getMaxLatency(), targetFlow.getMaxLatency());\n+        updateEndpointOnly &= Objects.equal(originalFlow.getFlowEncapsulationType(),\n+                targetFlow.getFlowEncapsulationType());\n+        updateEndpointOnly &= Objects.equal(originalFlow.getPathComputationStrategy(),\n+                targetFlow.getPathComputationStrategy());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2355e48a1316b46dcec2cfbb3d3e1bff282ea7c"}, "originalPosition": 112}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2355e48a1316b46dcec2cfbb3d3e1bff282ea7c", "author": {"user": {"login": "timofei-durakov", "name": "Timofey Durakov"}}, "url": "https://github.com/telstra/open-kilda/commit/a2355e48a1316b46dcec2cfbb3d3e1bff282ea7c", "committedDate": "2020-09-24T10:56:03Z", "message": "Get rid of Direction enum in command builder"}, "afterCommit": {"oid": "440011d73162a65b8028ecc88b0effd2fbec7b0f", "author": {"user": {"login": "timofei-durakov", "name": "Timofey Durakov"}}, "url": "https://github.com/telstra/open-kilda/commit/440011d73162a65b8028ecc88b0effd2fbec7b0f", "committedDate": "2020-09-25T06:11:20Z", "message": "Get rid of Direction enum in command builder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "440011d73162a65b8028ecc88b0effd2fbec7b0f", "author": {"user": {"login": "timofei-durakov", "name": "Timofey Durakov"}}, "url": "https://github.com/telstra/open-kilda/commit/440011d73162a65b8028ecc88b0effd2fbec7b0f", "committedDate": "2020-09-25T06:11:20Z", "message": "Get rid of Direction enum in command builder"}, "afterCommit": {"oid": "f893bec4ff7f72f69a48051db4fe749416dc345d", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/f893bec4ff7f72f69a48051db4fe749416dc345d", "committedDate": "2020-09-25T06:13:38Z", "message": "update port/vlan should not cause reroute"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "committedDate": "2020-09-25T11:22:04Z", "message": "update port/vlan should not cause reroute"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f893bec4ff7f72f69a48051db4fe749416dc345d", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/f893bec4ff7f72f69a48051db4fe749416dc345d", "committedDate": "2020-09-25T06:13:38Z", "message": "update port/vlan should not cause reroute"}, "afterCommit": {"oid": "955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "committedDate": "2020-09-25T11:22:04Z", "message": "update port/vlan should not cause reroute"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDc2MDUx", "url": "https://github.com/telstra/open-kilda/pull/3728#pullrequestreview-497076051", "createdAt": "2020-09-27T11:52:46Z", "commit": {"oid": "955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3564, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}