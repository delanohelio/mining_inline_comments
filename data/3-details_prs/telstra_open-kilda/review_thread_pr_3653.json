{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MTU2OTQz", "number": 3653, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNjo1MToxMlrOERtxgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNjo1MToxMlrOERtxgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MDExMjAxOnYy", "diffSide": "RIGHT", "path": "src-java/nbworker-topology/nbworker-storm-topology/src/main/java/org/openkilda/wfm/topology/nbworker/services/FlowOperationsService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNjo1MToxMlrOG2k1pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNjo1MToxMlrOG2k1pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg3OTg0Ng==", "bodyText": "please remove duplicate code, updateRequiredBySource and updateRequiredByDestination are almost the same", "url": "https://github.com/telstra/open-kilda/pull/3653#discussion_r459879846", "createdAt": "2020-07-24T06:51:12Z", "author": {"login": "timofei-durakov"}, "path": "src-java/nbworker-topology/nbworker-storm-topology/src/main/java/org/openkilda/wfm/topology/nbworker/services/FlowOperationsService.java", "diffHunk": "@@ -357,77 +354,140 @@ public Flow updateFlow(FlowOperationsCarrier carrier, FlowPatch flowPatch) throw\n \n     @VisibleForTesting\n     UpdateFlowResult.UpdateFlowResultBuilder prepareFlowUpdateResult(FlowPatch flowPatch, Flow flow) {\n-        boolean updateRequired = flowPatch.getPathComputationStrategy() != null\n+        boolean updateRequired = updateRequiredByPathComputationStrategy(flowPatch, flow);\n+\n+        updateRequired |= updateRequiredBySource(flowPatch, flow);\n+        updateRequired |= updateRequiredByDestination(flowPatch, flow);\n+\n+        updateRequired |= flowPatch.getBandwidth() != null && flow.getBandwidth() != flowPatch.getBandwidth();\n+        updateRequired |= flowPatch.getAllocateProtectedPath() != null\n+                && !flowPatch.getAllocateProtectedPath().equals(flow.isAllocateProtectedPath());\n+\n+        updateRequired |= updateRequiredByDiverseFlowIdField(flowPatch, flow);\n+\n+        updateRequired |= flowPatch.getIgnoreBandwidth() != null\n+                && flow.isIgnoreBandwidth() != flowPatch.getIgnoreBandwidth();\n+\n+        updateRequired |= flowPatch.getEncapsulationType() != null\n+                && !flow.getEncapsulationType().equals(flowPatch.getEncapsulationType());\n+\n+        return UpdateFlowResult.builder()\n+                .needUpdateFlow(updateRequired);\n+    }\n+\n+    private boolean updateRequiredByPathComputationStrategy(FlowPatch flowPatch, Flow flow) {\n+        boolean changedStrategy = flowPatch.getPathComputationStrategy() != null\n                 && !flowPatch.getPathComputationStrategy().equals(flow.getPathComputationStrategy());\n         boolean changedMaxLatency = flowPatch.getMaxLatency() != null\n                 && !flowPatch.getMaxLatency().equals(flow.getMaxLatency());\n         boolean strategyIsMaxLatency =\n                 PathComputationStrategy.MAX_LATENCY.equals(flowPatch.getPathComputationStrategy())\n-                || flowPatch.getPathComputationStrategy() == null\n-                && PathComputationStrategy.MAX_LATENCY.equals(flow.getPathComputationStrategy());\n-        updateRequired |= changedMaxLatency && strategyIsMaxLatency;\n-\n-        // source endpoint\n-        updateRequired |= flowPatch.getSourceSwitch() != null\n-                && !flow.getSrcSwitch().getSwitchId().equals(flowPatch.getSourceSwitch());\n-        updateRequired |= flowPatch.getSourcePort() != null\n-                && flow.getSrcPort() != flowPatch.getSourcePort();\n-        updateRequired |= flowPatch.getSourceVlan() != null\n-                && flow.getSrcVlan() != flowPatch.getSourceVlan();\n-\n-        // destination endpoint\n-        updateRequired |= flowPatch.getDestinationSwitch() != null\n-                && !flow.getDestSwitch().getSwitchId().equals(flowPatch.getDestinationSwitch());\n-        updateRequired |= flowPatch.getDestinationPort() != null\n-                && flow.getDestPort() != flowPatch.getDestinationPort();\n-        updateRequired |= flowPatch.getDestinationVlan() != null\n-                && flow.getDestVlan() != flowPatch.getDestinationVlan();\n+                        || flowPatch.getPathComputationStrategy() == null\n+                        && PathComputationStrategy.MAX_LATENCY.equals(flow.getPathComputationStrategy());\n+        return changedStrategy || changedMaxLatency && strategyIsMaxLatency;\n+    }\n \n-        updateRequired |= flowPatch.getBandwidth() != null && flow.getBandwidth() != flowPatch.getBandwidth();\n-        updateRequired |= flowPatch.getAllocateProtectedPath() != null\n-                && !flowPatch.getAllocateProtectedPath().equals(flow.isAllocateProtectedPath());\n+    private boolean updateRequiredBySource(FlowPatch flowPatch, Flow flow) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7ce9dbf8e75d55561fe2f7433a68d0afe38e115"}, "originalPosition": 118}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1782, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}