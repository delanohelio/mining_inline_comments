{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMDc5MTQx", "number": 3579, "title": "Add `status_info` field to Flow", "bodyText": "Closes: #3570", "createdAt": "2020-06-30T14:41:56Z", "url": "https://github.com/telstra/open-kilda/pull/3579", "merged": true, "mergeCommit": {"oid": "9ecff89c60fec539c889ecb1fcb60b98ecdbf3f3"}, "closed": true, "closedAt": "2020-07-03T08:26:05Z", "author": {"login": "dpoltavets"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwmfmGgBqjM1MDE0NTQ2MDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxNs8vAFqTQ0MjE3MTE4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9d95834f3f23895e451721a8b23a2a98b84fdb2", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/e9d95834f3f23895e451721a8b23a2a98b84fdb2", "committedDate": "2020-06-30T14:38:57Z", "message": "Added `status_info` field to Flow"}, "afterCommit": {"oid": "75d4f0e037123451bd1cdd7cc266f00b99e72c8f", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/75d4f0e037123451bd1cdd7cc266f00b99e72c8f", "committedDate": "2020-07-01T09:05:00Z", "message": "Added `status_info` field to Flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75d4f0e037123451bd1cdd7cc266f00b99e72c8f", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/75d4f0e037123451bd1cdd7cc266f00b99e72c8f", "committedDate": "2020-07-01T09:05:00Z", "message": "Added `status_info` field to Flow"}, "afterCommit": {"oid": "81cd0596cc0e9899eeddba8f5253832cdcad65fa", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/81cd0596cc0e9899eeddba8f5253832cdcad65fa", "committedDate": "2020-07-01T12:11:45Z", "message": "Added `status_info` field to Flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81cd0596cc0e9899eeddba8f5253832cdcad65fa", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/81cd0596cc0e9899eeddba8f5253832cdcad65fa", "committedDate": "2020-07-01T12:11:45Z", "message": "Added `status_info` field to Flow"}, "afterCommit": {"oid": "8f12ea2308fe6816d50438b9dacc1b91a4d3c84a", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/8f12ea2308fe6816d50438b9dacc1b91a4d3c84a", "committedDate": "2020-07-02T08:59:58Z", "message": "Added `status_info` field to Flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f12ea2308fe6816d50438b9dacc1b91a4d3c84a", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/8f12ea2308fe6816d50438b9dacc1b91a4d3c84a", "committedDate": "2020-07-02T08:59:58Z", "message": "Added `status_info` field to Flow"}, "afterCommit": {"oid": "2ddb0a4a2e69763b43a2dd25f22c02ae75e17e73", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/2ddb0a4a2e69763b43a2dd25f22c02ae75e17e73", "committedDate": "2020-07-02T11:07:04Z", "message": "Added `status_info` field to Flow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "138dfdc593c286bd669e86546d4b6515789cad44", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/138dfdc593c286bd669e86546d4b6515789cad44", "committedDate": "2020-07-02T11:26:33Z", "message": "Added `status_info` field to Flow"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ddb0a4a2e69763b43a2dd25f22c02ae75e17e73", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/2ddb0a4a2e69763b43a2dd25f22c02ae75e17e73", "committedDate": "2020-07-02T11:07:04Z", "message": "Added `status_info` field to Flow"}, "afterCommit": {"oid": "138dfdc593c286bd669e86546d4b6515789cad44", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/138dfdc593c286bd669e86546d4b6515789cad44", "committedDate": "2020-07-02T11:26:33Z", "message": "Added `status_info` field to Flow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxOTMxMDcw", "url": "https://github.com/telstra/open-kilda/pull/3579#pullrequestreview-441931070", "createdAt": "2020-07-02T18:28:04Z", "commit": {"oid": "138dfdc593c286bd669e86546d4b6515789cad44"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMTc4ODMw", "url": "https://github.com/telstra/open-kilda/pull/3579#pullrequestreview-442178830", "createdAt": "2020-07-03T06:40:25Z", "commit": {"oid": "138dfdc593c286bd669e86546d4b6515789cad44"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMTcxMTg0", "url": "https://github.com/telstra/open-kilda/pull/3579#pullrequestreview-442171184", "createdAt": "2020-07-03T06:21:35Z", "commit": {"oid": "138dfdc593c286bd669e86546d4b6515789cad44"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwNjoyMTozNVrOGsk_Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwNjo0NToyMVrOGslfbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM5NjUyMw==", "bodyText": "Is the statusInfo supposed to bring light on \"what goes wrong?\"? There is 0 info about what goes wrong.", "url": "https://github.com/telstra/open-kilda/pull/3579#discussion_r449396523", "createdAt": "2020-07-03T06:21:35Z", "author": {"login": "surabujin"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/create/action/HandleNotCreatedFlowAction.java", "diffHunk": "@@ -43,7 +45,7 @@ public HandleNotCreatedFlowAction(PersistenceManager persistenceManager,\n     public void perform(State from, State to, Event event, FlowCreateContext context, FlowCreateFsm stateMachine) {\n         String flowId = stateMachine.getFlowId();\n         dashboardLogger.onFlowStatusUpdate(flowId, FlowStatus.DOWN);\n-        flowRepository.updateStatus(flowId, FlowStatus.DOWN);\n+        flowRepository.updateStatus(flowId, FlowStatus.DOWN, format(\"Failed to create flow %s\", flowId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "138dfdc593c286bd669e86546d4b6515789cad44"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM5OTExNA==", "bodyText": "Can't understand. I have doubts about this approach.", "url": "https://github.com/telstra/open-kilda/pull/3579#discussion_r449399114", "createdAt": "2020-07-03T06:29:39Z", "author": {"login": "surabujin"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/reroute/actions/RevertFlowStatusAction.java", "diffHunk": "@@ -36,13 +36,20 @@ public RevertFlowStatusAction(PersistenceManager persistenceManager) {\n     @Override\n     protected void perform(State from, State to, Event event, FlowRerouteContext context, FlowRerouteFsm stateMachine) {\n         String flowId = stateMachine.getFlowId();\n-        FlowStatus originalStatus = stateMachine.getOriginalFlowStatus();\n-        if (originalStatus != null) {\n-            log.debug(\"Reverting the flow status of {} to {}\", flowId, originalStatus);\n+        FlowStatus originalFlowStatus = stateMachine.getOriginalFlowStatus();\n+        FlowStatus newFlowStatus = stateMachine.getNewFlowStatus();\n+        if (originalFlowStatus != null) {\n+            log.debug(\"Reverting the flow status of {} to {}\", flowId, originalFlowStatus);\n \n-            flowRepository.updateStatus(flowId, originalStatus);\n+            String flowStatusInfo = FlowStatus.DEGRADED.equals(originalFlowStatus)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "138dfdc593c286bd669e86546d4b6515789cad44"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwMDc3MA==", "bodyText": "Why do we need to update statusInfo in cases when there where no actual status update? Why we calculate statusInfo separately from status itself? I.e. the code wich set some status to the flow, know why it has decided to set exactly this status... so it should set statusInfo field too.", "url": "https://github.com/telstra/open-kilda/pull/3579#discussion_r449400770", "createdAt": "2020-07-03T06:34:33Z", "author": {"login": "surabujin"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/reroute/actions/UpdateFlowStatusAction.java", "diffHunk": "@@ -49,12 +50,25 @@ protected void perform(State from, State to, Event event, FlowRerouteContext con\n             FlowStatus flowStatus = flow.computeFlowStatus();\n             if (flowStatus != flow.getStatus()) {\n                 dashboardLogger.onFlowStatusUpdate(flowId, flowStatus);\n-                flowRepository.updateStatus(flowId, flowStatus);\n+                flowRepository.updateStatus(flowId, flowStatus, getFlowStatusInfo(flowStatus, stateMachine));\n+            } else if (FlowStatus.DEGRADED.equals(flowStatus)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "138dfdc593c286bd669e86546d4b6515789cad44"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNDc4Mg==", "bodyText": "How it is possible? If the flow is the \"target\" for rerouting, how it can be in UP state?", "url": "https://github.com/telstra/open-kilda/pull/3579#discussion_r449404782", "createdAt": "2020-07-03T06:45:21Z", "author": {"login": "surabujin"}, "path": "src-java/reroute-topology/reroute-storm-topology/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java", "diffHunk": "@@ -102,7 +102,12 @@ public void rerouteAffectedFlows(MessageSender sender, String correlationId, Rer\n             Flow flow = entry.getFlow();\n             Boolean sendRerouteRequest = transactionManager.doInTransaction(() -> {\n                 boolean flowPathFound = updateFlowPathsStateForFlow(switchId, port, entry.getAffectedPaths());\n-                flowRepository.updateStatusSafe(flow.getFlowId(), flow.computeFlowStatus());\n+                FlowStatus flowStatus = flow.computeFlowStatus();\n+                String flowStatusInfo = null;\n+                if (!FlowStatus.UP.equals(flowStatus)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "138dfdc593c286bd669e86546d4b6515789cad44"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3600, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}