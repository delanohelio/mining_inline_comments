{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0ODExNTM5", "number": 3124, "title": "ARP Part 2: Update Switch Properties", "bodyText": "Part of #3118", "createdAt": "2020-01-20T12:34:12Z", "url": "https://github.com/telstra/open-kilda/pull/3124", "merged": true, "mergeCommit": {"oid": "904a64e8b8ba0356722133d1bd92bb52aff87e8e"}, "closed": true, "closedAt": "2020-03-04T11:51:26Z", "author": {"login": "niksv"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8LzYoABqjI5NjI3ODk0MDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJsjHpgBqjMwODc2NjYwNTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "153ab02508d5df3ea18fd94f22d2d73f993eddc7", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/153ab02508d5df3ea18fd94f22d2d73f993eddc7", "committedDate": "2020-01-20T12:31:13Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "a2c8e587c223ed4599e00ceb46461b7006d0027d", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/a2c8e587c223ed4599e00ceb46461b7006d0027d", "committedDate": "2020-01-20T12:35:15Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2c8e587c223ed4599e00ceb46461b7006d0027d", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/a2c8e587c223ed4599e00ceb46461b7006d0027d", "committedDate": "2020-01-20T12:35:15Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "ef2f66cb3938d05be196284bca9e22a7e53cc8c8", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/ef2f66cb3938d05be196284bca9e22a7e53cc8c8", "committedDate": "2020-01-21T11:27:10Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NDA3ODQy", "url": "https://github.com/telstra/open-kilda/pull/3124#pullrequestreview-346407842", "createdAt": "2020-01-22T08:22:12Z", "commit": {"oid": "ef2f66cb3938d05be196284bca9e22a7e53cc8c8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwODoyMjoxMlrOFgTohA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwODoyMjoxMlrOFgTohA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQyMDQyMA==", "bodyText": "Can we combine this condition and the condition above?", "url": "https://github.com/telstra/open-kilda/pull/3124#discussion_r369420420", "createdAt": "2020-01-22T08:22:12Z", "author": {"login": "dpoltavets"}, "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/nbworker/services/SwitchOperationsService.java", "diffHunk": "@@ -287,28 +287,61 @@ public SwitchPropertiesDto updateSwitchProperties(SwitchId switchId, SwitchPrope\n             SwitchProperties switchProperties = switchPropertiesRepository.findBySwitchId(switchId)\n                     .orElseThrow(() -> new SwitchPropertiesNotFoundException(switchId));\n \n-            if (!update.isMultiTable() && update.isSwitchLldp()) {\n-                throw new IllegalSwitchPropertiesException(\n-                        String.format(\"Illegal switch properties combination for switch %s. 'switchLldp' property \"\n-                                + \"can be set to 'true' only if 'multiTable' property is 'true'.\", switchId));\n-            }\n+            validateSwitchProperties(switchId, update);\n \n-            final boolean previousMultiTableFlag = switchProperties.isMultiTable();\n-            final boolean previousLldpFlag = switchProperties.isSwitchLldp();\n+            // must be called before updating of switchProperties object\n+            final boolean isSwitchSyncNeeded = isSwitchSyncNeeded(switchProperties, update);\n \n             switchProperties.setMultiTable(update.isMultiTable());\n             switchProperties.setSwitchLldp(update.isSwitchLldp());\n+            switchProperties.setSwitchArp(update.isSwitchArp());\n             switchProperties.setSupportedTransitEncapsulation(update.getSupportedTransitEncapsulation());\n \n             switchPropertiesRepository.createOrUpdate(switchProperties);\n-            if (previousMultiTableFlag != update.isMultiTable() || previousLldpFlag != update.isSwitchLldp()) {\n+            if (isSwitchSyncNeeded) {\n                 carrier.requestSwitchSync(switchId);\n             }\n \n             return SwitchPropertiesMapper.INSTANCE.map(switchProperties);\n         });\n     }\n \n+    private boolean isSwitchSyncNeeded(SwitchProperties current, SwitchProperties updated) {\n+        return current.isMultiTable() != updated.isMultiTable()\n+                || current.isSwitchLldp() != updated.isSwitchLldp()\n+                || current.isSwitchArp() != updated.isSwitchArp();\n+    }\n+\n+    private void validateSwitchProperties(SwitchId switchId, SwitchProperties updatedSwitchProperties) {\n+        if (!updatedSwitchProperties.isMultiTable()) {\n+            if (updatedSwitchProperties.isSwitchLldp()) {\n+                throw new IllegalSwitchPropertiesException(\n+                        String.format(\"Illegal switch properties combination for switch %s. 'switchLldp' property \"\n+                                + \"can be set to 'true' only if 'multiTable' property is 'true'.\", switchId));\n+            }\n+\n+            if (updatedSwitchProperties.isSwitchArp()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef2f66cb3938d05be196284bca9e22a7e53cc8c8"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef2f66cb3938d05be196284bca9e22a7e53cc8c8", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/ef2f66cb3938d05be196284bca9e22a7e53cc8c8", "committedDate": "2020-01-21T11:27:10Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "8ccb3def2b4b83df88dee65daf58bee77f471b15", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/8ccb3def2b4b83df88dee65daf58bee77f471b15", "committedDate": "2020-01-22T08:36:36Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ccb3def2b4b83df88dee65daf58bee77f471b15", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/8ccb3def2b4b83df88dee65daf58bee77f471b15", "committedDate": "2020-01-22T08:36:36Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "98e5fb28d573b30e3b4ab686cfc0e3e83ef84ac9", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/98e5fb28d573b30e3b4ab686cfc0e3e83ef84ac9", "committedDate": "2020-02-06T05:45:58Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98e5fb28d573b30e3b4ab686cfc0e3e83ef84ac9", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/98e5fb28d573b30e3b4ab686cfc0e3e83ef84ac9", "committedDate": "2020-02-06T05:45:58Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "56a8a73bd4b73d4ed9699ea3b7566080d45f9a7d", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/56a8a73bd4b73d4ed9699ea3b7566080d45f9a7d", "committedDate": "2020-02-10T10:02:47Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56a8a73bd4b73d4ed9699ea3b7566080d45f9a7d", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/56a8a73bd4b73d4ed9699ea3b7566080d45f9a7d", "committedDate": "2020-02-10T10:02:47Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "511a2d4635e25b8a394cb644e768d41793b3ea34", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/511a2d4635e25b8a394cb644e768d41793b3ea34", "committedDate": "2020-02-10T11:37:23Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "511a2d4635e25b8a394cb644e768d41793b3ea34", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/511a2d4635e25b8a394cb644e768d41793b3ea34", "committedDate": "2020-02-10T11:37:23Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "4f7fb59989250e1fe5daf8cc5ad305312c2a641e", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/4f7fb59989250e1fe5daf8cc5ad305312c2a641e", "committedDate": "2020-02-11T09:13:53Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MzYzMDE5", "url": "https://github.com/telstra/open-kilda/pull/3124#pullrequestreview-357363019", "createdAt": "2020-02-12T11:01:20Z", "commit": {"oid": "4f7fb59989250e1fe5daf8cc5ad305312c2a641e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMTowMToyMFrOFoqUXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMTowMToyMFrOFoqUXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE4MDcwMA==", "bodyText": "witch -> which or with", "url": "https://github.com/telstra/open-kilda/pull/3124#discussion_r378180700", "createdAt": "2020-02-12T11:01:20Z", "author": {"login": "rozdy"}, "path": "src-java/nbworker-topology/nbworker-storm-topology/src/main/java/org/openkilda/wfm/topology/nbworker/services/SwitchOperationsService.java", "diffHunk": "@@ -288,28 +288,59 @@ public SwitchPropertiesDto updateSwitchProperties(SwitchId switchId, SwitchPrope\n             SwitchProperties switchProperties = switchPropertiesRepository.findBySwitchId(switchId)\n                     .orElseThrow(() -> new SwitchPropertiesNotFoundException(switchId));\n \n-            if (!update.isMultiTable() && update.isSwitchLldp()) {\n-                throw new IllegalSwitchPropertiesException(\n-                        String.format(\"Illegal switch properties combination for switch %s. 'switchLldp' property \"\n-                                + \"can be set to 'true' only if 'multiTable' property is 'true'.\", switchId));\n-            }\n+            validateSwitchProperties(switchId, update);\n \n-            final boolean previousMultiTableFlag = switchProperties.isMultiTable();\n-            final boolean previousLldpFlag = switchProperties.isSwitchLldp();\n+            // must be called before updating of switchProperties object\n+            final boolean isSwitchSyncNeeded = isSwitchSyncNeeded(switchProperties, update);\n \n             switchProperties.setMultiTable(update.isMultiTable());\n             switchProperties.setSwitchLldp(update.isSwitchLldp());\n+            switchProperties.setSwitchArp(update.isSwitchArp());\n             switchProperties.setSupportedTransitEncapsulation(update.getSupportedTransitEncapsulation());\n \n             switchPropertiesRepository.createOrUpdate(switchProperties);\n-            if (previousMultiTableFlag != update.isMultiTable() || previousLldpFlag != update.isSwitchLldp()) {\n+            if (isSwitchSyncNeeded) {\n                 carrier.requestSwitchSync(switchId);\n             }\n \n             return SwitchPropertiesMapper.INSTANCE.map(switchProperties);\n         });\n     }\n \n+    private boolean isSwitchSyncNeeded(SwitchProperties current, SwitchProperties updated) {\n+        return current.isMultiTable() != updated.isMultiTable()\n+                || current.isSwitchLldp() != updated.isSwitchLldp()\n+                || current.isSwitchArp() != updated.isSwitchArp();\n+    }\n+\n+    private void validateSwitchProperties(SwitchId switchId, SwitchProperties updatedSwitchProperties) {\n+        if (!updatedSwitchProperties.isMultiTable()) {\n+            String propertyErrorMessage = \"Illegal switch properties combination for switch %s. '%s' property \"\n+                    + \"can be set to 'true' only if 'multiTable' property is 'true'.\";\n+            if (updatedSwitchProperties.isSwitchLldp()) {\n+                throw new IllegalSwitchPropertiesException(String.format(propertyErrorMessage, switchId, \"switchLldp\"));\n+            }\n+\n+            if (updatedSwitchProperties.isSwitchArp()) {\n+                throw new IllegalSwitchPropertiesException(String.format(propertyErrorMessage, switchId, \"switchArp\"));\n+            }\n+\n+            List<String> flowsWitchEnabledArp = flowRepository.findByEndpointSwitchWithEnabledArp(switchId).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f7fb59989250e1fe5daf8cc5ad305312c2a641e"}, "originalPosition": 49}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f7fb59989250e1fe5daf8cc5ad305312c2a641e", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/4f7fb59989250e1fe5daf8cc5ad305312c2a641e", "committedDate": "2020-02-11T09:13:53Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "72d953156b75cf42710ffdd218d70fb3933e3999", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/72d953156b75cf42710ffdd218d70fb3933e3999", "committedDate": "2020-02-12T11:17:00Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72d953156b75cf42710ffdd218d70fb3933e3999", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/72d953156b75cf42710ffdd218d70fb3933e3999", "committedDate": "2020-02-12T11:17:00Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "aba1c93257f0f5dab3f41f53fad1b0dbc0590658", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/aba1c93257f0f5dab3f41f53fad1b0dbc0590658", "committedDate": "2020-02-18T17:46:09Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aba1c93257f0f5dab3f41f53fad1b0dbc0590658", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/aba1c93257f0f5dab3f41f53fad1b0dbc0590658", "committedDate": "2020-02-18T17:46:09Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "eea9e675867512bfea10e85e9713a8143b4b4bd2", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/eea9e675867512bfea10e85e9713a8143b4b4bd2", "committedDate": "2020-02-19T11:57:21Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eea9e675867512bfea10e85e9713a8143b4b4bd2", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/eea9e675867512bfea10e85e9713a8143b4b4bd2", "committedDate": "2020-02-19T11:57:21Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "9fe2169a03bae529627e17bf195301297dffd8b4", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/9fe2169a03bae529627e17bf195301297dffd8b4", "committedDate": "2020-02-21T11:20:33Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fe2169a03bae529627e17bf195301297dffd8b4", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/9fe2169a03bae529627e17bf195301297dffd8b4", "committedDate": "2020-02-21T11:20:33Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "02663adba7532e3ba62fcce595a87dd8caafc4fc", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/02663adba7532e3ba62fcce595a87dd8caafc4fc", "committedDate": "2020-03-02T11:26:52Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48d22e02e164dfa01f2c68c411c49eb76db92532", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/48d22e02e164dfa01f2c68c411c49eb76db92532", "committedDate": "2020-03-02T12:05:21Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02663adba7532e3ba62fcce595a87dd8caafc4fc", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/02663adba7532e3ba62fcce595a87dd8caafc4fc", "committedDate": "2020-03-02T11:26:52Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}, "afterCommit": {"oid": "48d22e02e164dfa01f2c68c411c49eb76db92532", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/48d22e02e164dfa01f2c68c411c49eb76db92532", "committedDate": "2020-03-02T12:05:21Z", "message": "ARP Part 2: Update Switch Properties\n\nPart of #3118"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3686, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}