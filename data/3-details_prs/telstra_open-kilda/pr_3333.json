{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNTIwMDIy", "number": 3333, "title": "GRPC speaker messaging refactor", "bodyText": "moved hardcoded response topic to config\nrenamed response topic from grpc.response to kilda.grpc.response.priv\nchanged message handling from CommandData to Message", "createdAt": "2020-03-25T10:59:12Z", "url": "https://github.com/telstra/open-kilda/pull/3333", "merged": true, "mergeCommit": {"oid": "fb8f5bdbfa2c174fd2867f257d2bd9b60bfab08a"}, "closed": true, "closedAt": "2020-03-30T14:35:49Z", "author": {"login": "niksv"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRFfWpABqjMxNjM0OTEzNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSvemkgFqTM4MzkxOTEwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2df3ab09cff59912432af20914391cea31135286", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/2df3ab09cff59912432af20914391cea31135286", "committedDate": "2020-03-25T10:56:52Z", "message": "GRPC speaker messaging refactor\n\n* moved hardcoded response topic to config\n* renamed response topic from 'grpc.response' to 'kilda.grpc.response.priv'\n* changed message handling from CommandData to Message"}, "afterCommit": {"oid": "24a577a8de399138719596c577e9b6ac5655cf88", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/24a577a8de399138719596c577e9b6ac5655cf88", "committedDate": "2020-03-25T11:06:20Z", "message": "GRPC speaker messaging refactor\n\n* moved hardcoded response topic to config\n* renamed response topic from 'grpc.response' to 'kilda.grpc.response.priv'\n* changed message handling from CommandData to Message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "24a577a8de399138719596c577e9b6ac5655cf88", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/24a577a8de399138719596c577e9b6ac5655cf88", "committedDate": "2020-03-25T11:06:20Z", "message": "GRPC speaker messaging refactor\n\n* moved hardcoded response topic to config\n* renamed response topic from 'grpc.response' to 'kilda.grpc.response.priv'\n* changed message handling from CommandData to Message"}, "afterCommit": {"oid": "c26b9adc3786c99ecbf7c7069cae0a3cbcca22a5", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/c26b9adc3786c99ecbf7c7069cae0a3cbcca22a5", "committedDate": "2020-03-26T10:00:24Z", "message": "GRPC speaker messaging refactor\n\n* moved hardcoded response topic to config\n* renamed response topic from 'grpc.response' to 'kilda.grpc.response.priv'\n* changed message handling from CommandData to Message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTUzNzg2", "url": "https://github.com/telstra/open-kilda/pull/3333#pullrequestreview-381953786", "createdAt": "2020-03-26T12:20:53Z", "commit": {"oid": "c26b9adc3786c99ecbf7c7069cae0a3cbcca22a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTYxNjU1", "url": "https://github.com/telstra/open-kilda/pull/3333#pullrequestreview-381961655", "createdAt": "2020-03-26T12:32:01Z", "commit": {"oid": "c26b9adc3786c99ecbf7c7069cae0a3cbcca22a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODQwODU5", "url": "https://github.com/telstra/open-kilda/pull/3333#pullrequestreview-382840859", "createdAt": "2020-03-27T13:09:49Z", "commit": {"oid": "c26b9adc3786c99ecbf7c7069cae0a3cbcca22a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzowOTo0OVrOF8wYow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzowOTo0OVrOF8wYow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1MTYxOQ==", "bodyText": "Do we really want INFO log message for dump and get operations?", "url": "https://github.com/telstra/open-kilda/pull/3333#discussion_r399251619", "createdAt": "2020-03-27T13:09:49Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/grpc-speaker/grpc-service/src/main/java/org/openkilda/grpc/speaker/messaging/MessageProcessor.java", "diffHunk": "@@ -41,34 +47,66 @@\n     @Autowired\n     RequestMapper requestMapper;\n \n+    @Value(\"#{kafkaTopicsConfig.getGrpcResponseTopic()}\")\n+    private String grpcResponseTopic;\n+\n     // TODO error handling\n \n     /**\n      * Process request.\n      *\n-     * @param command a command data.\n+     * @param message a message to be processed\n      */\n-    public void processRequest(CommandData command) {\n-        if (command instanceof CreateLogicalPortRequest) {\n-            CreateLogicalPortRequest req = (CreateLogicalPortRequest) command;\n-            service.createLogicalPort(req.getAddress(), requestMapper.toLogicalPort(req))\n-                    .thenAccept(e -> sendResponse(new CreateLogicalPortResponse(req.getAddress(), e, true)));\n-\n-        } else if (command instanceof DumpLogicalPortsRequest) {\n-            DumpLogicalPortsRequest req = (DumpLogicalPortsRequest) command;\n-            service.dumpLogicalPorts(req.getAddress())\n-                    .thenAccept(e -> sendResponse(new DumpLogicalPortsResponse(req.getAddress(), e)));\n-\n-        } else if (command instanceof GetSwitchInfoRequest) {\n-            GetSwitchInfoRequest req = (GetSwitchInfoRequest) command;\n-            service.getSwitchStatus(req.getAddress())\n-                    .thenAccept(e -> sendResponse(new GetSwitchInfoResponse(req.getAddress(), e)));\n+    public void processRequest(Message message) {\n+        if (message instanceof CommandMessage) {\n+            handleCommandMessage((CommandMessage) message);\n+        } else {\n+            unhandledMessage(message);\n+        }\n+    }\n \n+    private void handleCommandMessage(CommandMessage command) {\n+        CommandData data = command.getData();\n+        String correlationId = command.getCorrelationId();\n+\n+        if (data instanceof CreateLogicalPortRequest) {\n+            handleCreateLogicalPortRequest((CreateLogicalPortRequest) data, correlationId);\n+        } else if (data instanceof DumpLogicalPortsRequest) {\n+            handleDumpLogicalPortsRequest((DumpLogicalPortsRequest) data, correlationId);\n+        } else if (data instanceof GetSwitchInfoRequest) {\n+            handleGetSwitchInfoRequest((GetSwitchInfoRequest) data, correlationId);\n+        } else {\n+            unhandledMessage(command);\n         }\n     }\n \n-    private void sendResponse(InfoData message) {\n-        // TODO topic hardcode\n-        messageProducer.send(\"grpc.response\", message);\n+    private void handleCreateLogicalPortRequest(CreateLogicalPortRequest request, String correlationId) {\n+        log.info(\"Creating logical port {} on switch {}\", request.getLogicalPortNumber(), request.getAddress());\n+        service.createLogicalPort(request.getAddress(), requestMapper.toLogicalPort(request))\n+                .thenAccept(port -> sendResponse(\n+                        new CreateLogicalPortResponse(request.getAddress(), port, true), correlationId));\n+    }\n+\n+    private void handleDumpLogicalPortsRequest(DumpLogicalPortsRequest request, String correlationId) {\n+        log.info(\"Dumping logical ports on switch {}\", request.getAddress());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c26b9adc3786c99ecbf7c7069cae0a3cbcca22a5"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b17191b327a4853cda90136280890659069945c4", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/b17191b327a4853cda90136280890659069945c4", "committedDate": "2020-03-27T14:07:07Z", "message": "GRPC speaker messaging refactor\n\n* moved hardcoded response topic to config\n* renamed response topic from 'grpc.response' to 'kilda.grpc.response.priv'\n* changed message handling from CommandData to Message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c26b9adc3786c99ecbf7c7069cae0a3cbcca22a5", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/c26b9adc3786c99ecbf7c7069cae0a3cbcca22a5", "committedDate": "2020-03-26T10:00:24Z", "message": "GRPC speaker messaging refactor\n\n* moved hardcoded response topic to config\n* renamed response topic from 'grpc.response' to 'kilda.grpc.response.priv'\n* changed message handling from CommandData to Message"}, "afterCommit": {"oid": "b17191b327a4853cda90136280890659069945c4", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/b17191b327a4853cda90136280890659069945c4", "committedDate": "2020-03-27T14:07:07Z", "message": "GRPC speaker messaging refactor\n\n* moved hardcoded response topic to config\n* renamed response topic from 'grpc.response' to 'kilda.grpc.response.priv'\n* changed message handling from CommandData to Message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzOTE5MTA5", "url": "https://github.com/telstra/open-kilda/pull/3333#pullrequestreview-383919109", "createdAt": "2020-03-30T14:35:41Z", "commit": {"oid": "b17191b327a4853cda90136280890659069945c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3677, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}