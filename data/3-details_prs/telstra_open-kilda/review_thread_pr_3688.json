{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NDc1NzU5", "number": 3688, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMToxMTowNVrOEZAG4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMToxNzozNFrOEZAOqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NjUxNjE3OnYy", "diffSide": "RIGHT", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMToxMTowNVrOHBkbWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwODo1NDoyOFrOHCKBpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQwNzQ0OA==", "bodyText": "nit: Is it really related to the issue?", "url": "https://github.com/telstra/open-kilda/pull/3688#discussion_r471407448", "createdAt": "2020-08-17T11:11:05Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -563,7 +563,7 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n                 }\n                 sleep(500)\n             }\n-            assert northboundV2.getFlow(firstFlow.flowId).statusInfo =~ /ISL (.*) become INACTIVE because of FAIL TIMEOUT (.*)/\n+            assert northboundV2.getFlow(firstFlow.flowId).statusInfo =~ /ISL (.*) become INACTIVE(.*)/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "398efd4604845d7c2252a39733cdccb5b62bb868"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQyNDQ4MQ==", "bodyText": "yes... this is fix from @rtretyak. Without this fix, this test fails.", "url": "https://github.com/telstra/open-kilda/pull/3688#discussion_r471424481", "createdAt": "2020-08-17T11:47:19Z", "author": {"login": "surabujin"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -563,7 +563,7 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n                 }\n                 sleep(500)\n             }\n-            assert northboundV2.getFlow(firstFlow.flowId).statusInfo =~ /ISL (.*) become INACTIVE because of FAIL TIMEOUT (.*)/\n+            assert northboundV2.getFlow(firstFlow.flowId).statusInfo =~ /ISL (.*) become INACTIVE(.*)/", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQwNzQ0OA=="}, "originalCommit": {"oid": "398efd4604845d7c2252a39733cdccb5b62bb868"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAyMzQ2MQ==", "bodyText": "Ok", "url": "https://github.com/telstra/open-kilda/pull/3688#discussion_r472023461", "createdAt": "2020-08-18T08:54:28Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -563,7 +563,7 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n                 }\n                 sleep(500)\n             }\n-            assert northboundV2.getFlow(firstFlow.flowId).statusInfo =~ /ISL (.*) become INACTIVE because of FAIL TIMEOUT (.*)/\n+            assert northboundV2.getFlow(firstFlow.flowId).statusInfo =~ /ISL (.*) become INACTIVE(.*)/", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQwNzQ0OA=="}, "originalCommit": {"oid": "398efd4604845d7c2252a39733cdccb5b62bb868"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NjUzNjExOnYy", "diffSide": "RIGHT", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/mappers/FlowPathMapper.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMToxNzozNFrOHBknMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwODo1NTo1MVrOHCKFJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQxMDQ4MQ==", "bodyText": "2 questions:\n\nHow are the changes in this file related to the title \"NPE during producting flow dump\"?\nWhat benefits do these changes bring? IMHO, 2 iterators instead of an index are neither shorter nor clearer.", "url": "https://github.com/telstra/open-kilda/pull/3688#discussion_r471410481", "createdAt": "2020-08-17T11:17:34Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/mappers/FlowPathMapper.java", "diffHunk": "@@ -65,28 +68,27 @@ public PathInfoData map(FlowPath path) {\n         List<PathNodePayload> resultList = new ArrayList<>();\n \n         Flow flow = flowPath.getFlow();\n-        int srcPort = flow.isForward(flowPath) ? flow.getSrcPort() : flow.getDestPort();\n-        int destPort = flow.isForward(flowPath) ? flow.getDestPort() : flow.getSrcPort();\n-\n-        if (flowPath.getSegments().isEmpty()) {\n-            resultList.add(\n-                    new PathNodePayload(flowPath.getSrcSwitch().getSwitchId(), srcPort, destPort));\n+        FlowEndpoint ingress = FlowSideAdapter.makeIngressAdapter(flow, flowPath).getEndpoint();\n+        FlowEndpoint egress = FlowSideAdapter.makeEgressAdapter(flow, flowPath).getEndpoint();\n+\n+        List<PathSegment> pathSegments = flowPath.getSegments();\n+        Iterator<PathSegment> leftIter = pathSegments.iterator();\n+        Iterator<PathSegment> rightIter = pathSegments.iterator();\n+        if (! rightIter.hasNext()) {\n+            resultList.add(new PathNodePayload(\n+                    flowPath.getSrcSwitch().getSwitchId(), ingress.getPortNumber(), egress.getPortNumber()));\n         } else {\n-            List<PathSegment> pathSegments = flowPath.getSegments();\n-\n-            resultList.add(new PathNodePayload(flowPath.getSrcSwitch().getSwitchId(), srcPort,\n-                    pathSegments.get(0).getSrcPort()));\n-\n-            for (int i = 1; i < pathSegments.size(); i++) {\n-                PathSegment inputNode = pathSegments.get(i - 1);\n-                PathSegment outputNode = pathSegments.get(i);\n-\n-                resultList.add(new PathNodePayload(inputNode.getDestSwitch().getSwitchId(), inputNode.getDestPort(),\n-                        outputNode.getSrcPort()));\n+            PathSegment left;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "398efd4604845d7c2252a39733cdccb5b62bb868"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQyNzI2Mg==", "bodyText": "The only reason I touch this code is to remove call flow.isForward(flowPath) because this call produces an incorrect answer for \"extra/detached\" paths (we inject such path now into RevertResourceAllocationAction). All other changes related to this one... I have tried to make it simpler, looks like I have failed this target.\nIf you insist I will revert iteration by indexes.", "url": "https://github.com/telstra/open-kilda/pull/3688#discussion_r471427262", "createdAt": "2020-08-17T11:53:14Z", "author": {"login": "surabujin"}, "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/mappers/FlowPathMapper.java", "diffHunk": "@@ -65,28 +68,27 @@ public PathInfoData map(FlowPath path) {\n         List<PathNodePayload> resultList = new ArrayList<>();\n \n         Flow flow = flowPath.getFlow();\n-        int srcPort = flow.isForward(flowPath) ? flow.getSrcPort() : flow.getDestPort();\n-        int destPort = flow.isForward(flowPath) ? flow.getDestPort() : flow.getSrcPort();\n-\n-        if (flowPath.getSegments().isEmpty()) {\n-            resultList.add(\n-                    new PathNodePayload(flowPath.getSrcSwitch().getSwitchId(), srcPort, destPort));\n+        FlowEndpoint ingress = FlowSideAdapter.makeIngressAdapter(flow, flowPath).getEndpoint();\n+        FlowEndpoint egress = FlowSideAdapter.makeEgressAdapter(flow, flowPath).getEndpoint();\n+\n+        List<PathSegment> pathSegments = flowPath.getSegments();\n+        Iterator<PathSegment> leftIter = pathSegments.iterator();\n+        Iterator<PathSegment> rightIter = pathSegments.iterator();\n+        if (! rightIter.hasNext()) {\n+            resultList.add(new PathNodePayload(\n+                    flowPath.getSrcSwitch().getSwitchId(), ingress.getPortNumber(), egress.getPortNumber()));\n         } else {\n-            List<PathSegment> pathSegments = flowPath.getSegments();\n-\n-            resultList.add(new PathNodePayload(flowPath.getSrcSwitch().getSwitchId(), srcPort,\n-                    pathSegments.get(0).getSrcPort()));\n-\n-            for (int i = 1; i < pathSegments.size(); i++) {\n-                PathSegment inputNode = pathSegments.get(i - 1);\n-                PathSegment outputNode = pathSegments.get(i);\n-\n-                resultList.add(new PathNodePayload(inputNode.getDestSwitch().getSwitchId(), inputNode.getDestPort(),\n-                        outputNode.getSrcPort()));\n+            PathSegment left;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQxMDQ4MQ=="}, "originalCommit": {"oid": "398efd4604845d7c2252a39733cdccb5b62bb868"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAyNDM1OA==", "bodyText": "Got it.", "url": "https://github.com/telstra/open-kilda/pull/3688#discussion_r472024358", "createdAt": "2020-08-18T08:55:51Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/share/mappers/FlowPathMapper.java", "diffHunk": "@@ -65,28 +68,27 @@ public PathInfoData map(FlowPath path) {\n         List<PathNodePayload> resultList = new ArrayList<>();\n \n         Flow flow = flowPath.getFlow();\n-        int srcPort = flow.isForward(flowPath) ? flow.getSrcPort() : flow.getDestPort();\n-        int destPort = flow.isForward(flowPath) ? flow.getDestPort() : flow.getSrcPort();\n-\n-        if (flowPath.getSegments().isEmpty()) {\n-            resultList.add(\n-                    new PathNodePayload(flowPath.getSrcSwitch().getSwitchId(), srcPort, destPort));\n+        FlowEndpoint ingress = FlowSideAdapter.makeIngressAdapter(flow, flowPath).getEndpoint();\n+        FlowEndpoint egress = FlowSideAdapter.makeEgressAdapter(flow, flowPath).getEndpoint();\n+\n+        List<PathSegment> pathSegments = flowPath.getSegments();\n+        Iterator<PathSegment> leftIter = pathSegments.iterator();\n+        Iterator<PathSegment> rightIter = pathSegments.iterator();\n+        if (! rightIter.hasNext()) {\n+            resultList.add(new PathNodePayload(\n+                    flowPath.getSrcSwitch().getSwitchId(), ingress.getPortNumber(), egress.getPortNumber()));\n         } else {\n-            List<PathSegment> pathSegments = flowPath.getSegments();\n-\n-            resultList.add(new PathNodePayload(flowPath.getSrcSwitch().getSwitchId(), srcPort,\n-                    pathSegments.get(0).getSrcPort()));\n-\n-            for (int i = 1; i < pathSegments.size(); i++) {\n-                PathSegment inputNode = pathSegments.get(i - 1);\n-                PathSegment outputNode = pathSegments.get(i);\n-\n-                resultList.add(new PathNodePayload(inputNode.getDestSwitch().getSwitchId(), inputNode.getDestPort(),\n-                        outputNode.getSrcPort()));\n+            PathSegment left;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQxMDQ4MQ=="}, "originalCommit": {"oid": "398efd4604845d7c2252a39733cdccb5b62bb868"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1807, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}