{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNDIxNjY2", "number": 3587, "title": "Added max_count parameter into flow history API", "bodyText": "", "createdAt": "2020-07-02T10:21:12Z", "url": "https://github.com/telstra/open-kilda/pull/3587", "merged": true, "mergeCommit": {"oid": "0028890d8ed6d64184ef54c2f8629427edce8f60"}, "closed": true, "closedAt": "2020-07-13T06:00:38Z", "author": {"login": "niksv"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcySH4sABqjM1MTYyMjA4ODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczoijlABqjM1MzUwOTM2NzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e98d802ce0ec38c888aa8c86aaa61cde0f92bb84", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/e98d802ce0ec38c888aa8c86aaa61cde0f92bb84", "committedDate": "2020-07-02T10:20:12Z", "message": "Added max_count paramater into flow history API"}, "afterCommit": {"oid": "4aaf9aefca4aae6c0092f44de51d88306b5d3708", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/4aaf9aefca4aae6c0092f44de51d88306b5d3708", "committedDate": "2020-07-06T14:29:00Z", "message": "Added max_count paramater into flow history API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4aaf9aefca4aae6c0092f44de51d88306b5d3708", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/4aaf9aefca4aae6c0092f44de51d88306b5d3708", "committedDate": "2020-07-06T14:29:00Z", "message": "Added max_count paramater into flow history API"}, "afterCommit": {"oid": "982ec6e7ac70d5db3317ca5aa050e6d3431168b9", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/982ec6e7ac70d5db3317ca5aa050e6d3431168b9", "committedDate": "2020-07-06T14:54:14Z", "message": "Added max_count paramater into flow history API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "982ec6e7ac70d5db3317ca5aa050e6d3431168b9", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/982ec6e7ac70d5db3317ca5aa050e6d3431168b9", "committedDate": "2020-07-06T14:54:14Z", "message": "Added max_count paramater into flow history API"}, "afterCommit": {"oid": "ddcf023f5e0f147c1cb0cb9851896ca9bc5513f5", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/ddcf023f5e0f147c1cb0cb9851896ca9bc5513f5", "committedDate": "2020-07-07T09:52:20Z", "message": "Added max_count paramater into flow history API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ddcf023f5e0f147c1cb0cb9851896ca9bc5513f5", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/ddcf023f5e0f147c1cb0cb9851896ca9bc5513f5", "committedDate": "2020-07-07T09:52:20Z", "message": "Added max_count paramater into flow history API"}, "afterCommit": {"oid": "042664d6bfb5b23cea65dc636ec3dd52cfe6e1d9", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/042664d6bfb5b23cea65dc636ec3dd52cfe6e1d9", "committedDate": "2020-07-07T10:18:18Z", "message": "Added max_count paramater into flow history API"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MDk4NDky", "url": "https://github.com/telstra/open-kilda/pull/3587#pullrequestreview-444098492", "createdAt": "2020-07-07T17:19:58Z", "commit": {"oid": "042664d6bfb5b23cea65dc636ec3dd52cfe6e1d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzoxOTo1OFrOGuIR5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzoxOTo1OFrOGuIR5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyMzMzMw==", "bodyText": "excess single quote at the end of the sentence -.-", "url": "https://github.com/telstra/open-kilda/pull/3587#discussion_r451023333", "createdAt": "2020-07-07T17:19:58Z", "author": {"login": "rtretyak"}, "path": "src-java/northbound-service/northbound/src/main/java/org/openkilda/northbound/service/impl/FlowServiceImpl.java", "diffHunk": "@@ -647,12 +647,18 @@ private FlowPathPayload buildFlowPathPayload(List<FlowPathDto> paths, String flo\n     @Override\n     public CompletableFuture<List<FlowEventPayload>> listFlowEvents(String flowId,\n                                                                     long timestampFrom,\n-                                                                    long timestampTo) {\n+                                                                    long timestampTo, int maxCount) {\n+        if (maxCount < 1) {\n+            throw new MessageException(RequestCorrelationId.getId(), System.currentTimeMillis(),\n+                    ErrorType.PARAMETERS_INVALID, format(\"Invalid `max_count` argument '%s'.\", maxCount),\n+                    \"`max_count` argument must be positive.'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "042664d6bfb5b23cea65dc636ec3dd52cfe6e1d9"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "042664d6bfb5b23cea65dc636ec3dd52cfe6e1d9", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/042664d6bfb5b23cea65dc636ec3dd52cfe6e1d9", "committedDate": "2020-07-07T10:18:18Z", "message": "Added max_count paramater into flow history API"}, "afterCommit": {"oid": "9f20ff3dc4c43eb7f67279f391edf45dda157194", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/9f20ff3dc4c43eb7f67279f391edf45dda157194", "committedDate": "2020-07-08T06:54:10Z", "message": "Added max_count paramater into flow history API"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTQ5MTc2", "url": "https://github.com/telstra/open-kilda/pull/3587#pullrequestreview-444549176", "createdAt": "2020-07-08T09:01:27Z", "commit": {"oid": "9f20ff3dc4c43eb7f67279f391edf45dda157194"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NTM2NzUw", "url": "https://github.com/telstra/open-kilda/pull/3587#pullrequestreview-445536750", "createdAt": "2020-07-09T11:42:45Z", "commit": {"oid": "9f20ff3dc4c43eb7f67279f391edf45dda157194"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMTo0Mjo0NVrOGvNbwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMTo0Mjo0NVrOGvNbwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1NjM1Mw==", "bodyText": "Per RFC, HttpStatus.PARTIAL_CONTENT is returned only if Range header is passed. In out case we should return 200 OK.", "url": "https://github.com/telstra/open-kilda/pull/3587#discussion_r452156353", "createdAt": "2020-07-09T11:42:45Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/northbound-service/northbound/src/main/java/org/openkilda/northbound/controller/v1/FlowController.java", "diffHunk": "@@ -328,18 +332,42 @@ public void invalidateFlowCache() {\n      */\n     @ApiOperation(value = \"Gets history for flow\", response = FlowEventPayload.class, responseContainer = \"List\")\n     @GetMapping(path = \"/{flow_id}/history\")\n-    @ResponseStatus(HttpStatus.OK)\n-    public CompletableFuture<List<FlowEventPayload>> getHistory(\n+    public ResponseEntity<List<FlowEventPayload>> getHistory(\n             @PathVariable(\"flow_id\") String flowId,\n-            @ApiParam(value = \"default: the day before timeTo.\", required = false)\n+            @ApiParam(value = \"default: 0 (1 January 1970 00:00:00).\", required = false)\n             @RequestParam(value = \"timeFrom\", required = false) Optional<Long> optionalTimeFrom,\n             @ApiParam(value = \"default: now.\", required = false)\n-            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo) {\n+            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo,\n+            @ApiParam(value = \"Return at most N latest records. \"\n+                    + \"Default: if `timeFrom` or/and `timeTo` parameters are presented default value of \"\n+                    + \"`maxCount` is infinite (all records in time interval will be returned). \"\n+                    + \"Otherwise default value of `maxCount` will be equal to 100. In This case response will contain \"\n+                    + \"header 'Content-Range' and have status 206 (Partial Content).\")\n+            @RequestParam(value = \"max_count\", required = false) Optional<Integer> optionalMaxCount) {\n+        int maxCount = optionalMaxCount.orElseGet(() -> {\n+            if (optionalTimeFrom.isPresent() || optionalTimeTo.isPresent()) {\n+                return Integer.MAX_VALUE;\n+            } else {\n+                return DEFAULT_MAX_HISTORY_RECORD_COUNT;\n+            }\n+        });\n+\n         Long timeTo = optionalTimeTo.orElseGet(() -> Instant.now().getEpochSecond());\n-        Long timeFrom = optionalTimeFrom.orElseGet(\n-                () -> Instant.ofEpochSecond(timeTo).minus(1, ChronoUnit.DAYS).getEpochSecond()\n-        );\n-        return flowService.listFlowEvents(flowId, timeFrom, timeTo);\n+        Long timeFrom = optionalTimeFrom.orElse(0L);\n+        List<FlowEventPayload> events = flowService.listFlowEvents(flowId, timeFrom, timeTo, maxCount).join();\n+\n+        HttpStatus responseStatus = HttpStatus.OK;\n+        HttpHeaders headers = new HttpHeaders();\n+\n+        if (!optionalMaxCount.isPresent() && !optionalTimeFrom.isPresent() && !optionalTimeTo.isPresent()) {\n+            // if request has no parameters we assume that default value of `maxCount` is 100. To indicate that response\n+            // may contain not all of history records \"Content-Range\" header will be added to response.\n+            // Also Response status will be set to 206 (Partial Content)\n+            int count = Math.min(DEFAULT_MAX_HISTORY_RECORD_COUNT, events.size()) - 1;\n+            headers.add(HttpHeaders.CONTENT_RANGE, format(\"event 0-%d/*\", count));\n+            responseStatus = HttpStatus.PARTIAL_CONTENT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f20ff3dc4c43eb7f67279f391edf45dda157194"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1Njc4ODIy", "url": "https://github.com/telstra/open-kilda/pull/3587#pullrequestreview-445678822", "createdAt": "2020-07-09T14:35:54Z", "commit": {"oid": "3580dcb1e5b782984bfa536724e05692c3a38b94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDozNTo1NFrOGvUEQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDozNTo1NFrOGvUEQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NTAyNQ==", "bodyText": "Let's use more generic units - \"items\" (instead of \"event\")", "url": "https://github.com/telstra/open-kilda/pull/3587#discussion_r452265025", "createdAt": "2020-07-09T14:35:54Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/northbound-service/northbound/src/main/java/org/openkilda/northbound/controller/v1/FlowController.java", "diffHunk": "@@ -328,18 +332,39 @@ public void invalidateFlowCache() {\n      */\n     @ApiOperation(value = \"Gets history for flow\", response = FlowEventPayload.class, responseContainer = \"List\")\n     @GetMapping(path = \"/{flow_id}/history\")\n-    @ResponseStatus(HttpStatus.OK)\n-    public CompletableFuture<List<FlowEventPayload>> getHistory(\n+    public ResponseEntity<List<FlowEventPayload>> getHistory(\n             @PathVariable(\"flow_id\") String flowId,\n-            @ApiParam(value = \"default: the day before timeTo.\", required = false)\n+            @ApiParam(value = \"default: 0 (1 January 1970 00:00:00).\", required = false)\n             @RequestParam(value = \"timeFrom\", required = false) Optional<Long> optionalTimeFrom,\n             @ApiParam(value = \"default: now.\", required = false)\n-            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo) {\n+            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo,\n+            @ApiParam(value = \"Return at most N latest records. \"\n+                    + \"Default: if `timeFrom` or/and `timeTo` parameters are presented default value of \"\n+                    + \"`maxCount` is infinite (all records in time interval will be returned). \"\n+                    + \"Otherwise default value of `maxCount` will be equal to 100. In This case response will contain \"\n+                    + \"header 'Content-Range'.\")\n+            @RequestParam(value = \"max_count\", required = false) Optional<Integer> optionalMaxCount) {\n+        int maxCount = optionalMaxCount.orElseGet(() -> {\n+            if (optionalTimeFrom.isPresent() || optionalTimeTo.isPresent()) {\n+                return Integer.MAX_VALUE;\n+            } else {\n+                return DEFAULT_MAX_HISTORY_RECORD_COUNT;\n+            }\n+        });\n+\n         Long timeTo = optionalTimeTo.orElseGet(() -> Instant.now().getEpochSecond());\n-        Long timeFrom = optionalTimeFrom.orElseGet(\n-                () -> Instant.ofEpochSecond(timeTo).minus(1, ChronoUnit.DAYS).getEpochSecond()\n-        );\n-        return flowService.listFlowEvents(flowId, timeFrom, timeTo);\n+        Long timeFrom = optionalTimeFrom.orElse(0L);\n+        List<FlowEventPayload> events = flowService.listFlowEvents(flowId, timeFrom, timeTo, maxCount).join();\n+\n+        HttpHeaders headers = new HttpHeaders();\n+\n+        if (!optionalMaxCount.isPresent() && !optionalTimeFrom.isPresent() && !optionalTimeTo.isPresent()) {\n+            // if request has no parameters we assume that default value of `maxCount` is 100. To indicate that response\n+            // may contain not all of history records \"Content-Range\" header will be added to response.\n+            int count = Math.min(DEFAULT_MAX_HISTORY_RECORD_COUNT, events.size()) - 1;\n+            headers.add(HttpHeaders.CONTENT_RANGE, format(\"event 0-%d/*\", count));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3580dcb1e5b782984bfa536724e05692c3a38b94"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1Njk3ODEy", "url": "https://github.com/telstra/open-kilda/pull/3587#pullrequestreview-445697812", "createdAt": "2020-07-09T14:55:09Z", "commit": {"oid": "24fbc11a834de040f92bbae1ed3d6b53d6d2185c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDo1NTowOVrOGvU9aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDo1NTowOVrOGvU9aA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI3OTY1Ng==", "bodyText": "I'd return this header ONLY in cases when we have in database more records than DEFAULT_MAX_HISTORY_RECORD_COUNT.", "url": "https://github.com/telstra/open-kilda/pull/3587#discussion_r452279656", "createdAt": "2020-07-09T14:55:09Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/northbound-service/northbound/src/main/java/org/openkilda/northbound/controller/v1/FlowController.java", "diffHunk": "@@ -328,18 +332,39 @@ public void invalidateFlowCache() {\n      */\n     @ApiOperation(value = \"Gets history for flow\", response = FlowEventPayload.class, responseContainer = \"List\")\n     @GetMapping(path = \"/{flow_id}/history\")\n-    @ResponseStatus(HttpStatus.OK)\n-    public CompletableFuture<List<FlowEventPayload>> getHistory(\n+    public ResponseEntity<List<FlowEventPayload>> getHistory(\n             @PathVariable(\"flow_id\") String flowId,\n-            @ApiParam(value = \"default: the day before timeTo.\", required = false)\n+            @ApiParam(value = \"default: 0 (1 January 1970 00:00:00).\", required = false)\n             @RequestParam(value = \"timeFrom\", required = false) Optional<Long> optionalTimeFrom,\n             @ApiParam(value = \"default: now.\", required = false)\n-            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo) {\n+            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo,\n+            @ApiParam(value = \"Return at most N latest records. \"\n+                    + \"Default: if `timeFrom` or/and `timeTo` parameters are presented default value of \"\n+                    + \"`maxCount` is infinite (all records in time interval will be returned). \"\n+                    + \"Otherwise default value of `maxCount` will be equal to 100. In This case response will contain \"\n+                    + \"header 'Content-Range'.\")\n+            @RequestParam(value = \"max_count\", required = false) Optional<Integer> optionalMaxCount) {\n+        int maxCount = optionalMaxCount.orElseGet(() -> {\n+            if (optionalTimeFrom.isPresent() || optionalTimeTo.isPresent()) {\n+                return Integer.MAX_VALUE;\n+            } else {\n+                return DEFAULT_MAX_HISTORY_RECORD_COUNT;\n+            }\n+        });\n+\n         Long timeTo = optionalTimeTo.orElseGet(() -> Instant.now().getEpochSecond());\n-        Long timeFrom = optionalTimeFrom.orElseGet(\n-                () -> Instant.ofEpochSecond(timeTo).minus(1, ChronoUnit.DAYS).getEpochSecond()\n-        );\n-        return flowService.listFlowEvents(flowId, timeFrom, timeTo);\n+        Long timeFrom = optionalTimeFrom.orElse(0L);\n+        List<FlowEventPayload> events = flowService.listFlowEvents(flowId, timeFrom, timeTo, maxCount).join();\n+\n+        HttpHeaders headers = new HttpHeaders();\n+\n+        if (!optionalMaxCount.isPresent() && !optionalTimeFrom.isPresent() && !optionalTimeTo.isPresent()) {\n+            // if request has no parameters we assume that default value of `maxCount` is 100. To indicate that response\n+            // may contain not all of history records \"Content-Range\" header will be added to response.\n+            int count = Math.min(DEFAULT_MAX_HISTORY_RECORD_COUNT, events.size()) - 1;\n+            headers.add(HttpHeaders.CONTENT_RANGE, format(\"items 0-%d/*\", count));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24fbc11a834de040f92bbae1ed3d6b53d6d2185c"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c47b9ed30321a253ac12edd9ee2958e20b9178c", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/5c47b9ed30321a253ac12edd9ee2958e20b9178c", "committedDate": "2020-07-10T19:09:45Z", "message": "Added max_count paramater into flow history API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d591b119ca60eb312ea0b8f0115c7f58fd5e56c", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/6d591b119ca60eb312ea0b8f0115c7f58fd5e56c", "committedDate": "2020-07-09T19:33:50Z", "message": "fix chechstyle"}, "afterCommit": {"oid": "5c47b9ed30321a253ac12edd9ee2958e20b9178c", "author": {"user": {"login": "niksv", "name": "Sergey Nikitin"}}, "url": "https://github.com/telstra/open-kilda/commit/5c47b9ed30321a253ac12edd9ee2958e20b9178c", "committedDate": "2020-07-10T19:09:45Z", "message": "Added max_count paramater into flow history API"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3602, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}