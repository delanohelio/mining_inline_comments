{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NTUyNDY5", "number": 3874, "title": "extend connected\u0412evices spec", "bodyText": "", "createdAt": "2020-11-24T15:09:03Z", "url": "https://github.com/telstra/open-kilda/pull/3874", "merged": true, "mergeCommit": {"oid": "9c35f921c98fd4d85c5721982a0152e0ee4005ee"}, "closed": true, "closedAt": "2020-12-03T15:36:01Z", "author": {"login": "andriidovhan"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfoWLhgH2gAyNTI2NTUyNDY5OjIwYWIwNTQ2ODE1ODRjZTkyNzMzODQyNmJiODkzZGJlNzBlNWM5Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgkGH8gFqTUzOTgyNDQ0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "20ab054681584ce927338426bb893dbe70e5c927", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/20ab054681584ce927338426bb893dbe70e5c927", "committedDate": "2020-11-24T11:49:19Z", "message": "improve \"Able to detect devices on free switch port (no flow or isl)\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31e535a1a3e97131d6ad52f7020976e706ae348f", "author": {"user": {"login": "andriidovhan", "name": "AndriiDovhan"}}, "url": "https://github.com/telstra/open-kilda/commit/31e535a1a3e97131d6ad52f7020976e706ae348f", "committedDate": "2020-11-24T15:00:46Z", "message": "extend ConnectedDevicesSpec"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5ODI0NDQ5", "url": "https://github.com/telstra/open-kilda/pull/3874#pullrequestreview-539824449", "createdAt": "2020-11-27T09:25:58Z", "commit": {"oid": "31e535a1a3e97131d6ad52f7020976e706ae348f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOToyNTo1OFrOH624Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwOToyNTo1OFrOH624Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ3ODU3MA==", "bodyText": "this is fine I guess, but the only thing that actually changes between iterations is encapsulationType", "url": "https://github.com/telstra/open-kilda/pull/3874#discussion_r531478570", "createdAt": "2020-11-27T09:25:58Z", "author": {"login": "rtretyak"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/ConnectedDevicesSpec.groovy", "diffHunk": "@@ -1264,6 +1304,85 @@ srcDevices=#newSrcEnabled, dstDevices=#newDstEnabled\"() {\n         100    | 200         | FlowEncapsulationType.VXLAN\n     }\n \n+    @Unroll\n+    @Tags([SMOKE_SWITCHES])\n+    def \"Able to detect devices when two qinq single-switch different-port flows exist with the same outerVlanId\"() {\n+        given: \"Two flows between different ports on the same switch with the same outerVlanId\"\n+        assumeTrue(\"Require at least 1 switch with connected traffgen\", topology.activeTraffGens.size() > 0)\n+        def sw = topology.activeTraffGens*.switchConnected.first()\n+        def initialProps = enableMultiTableIfNeeded(true, sw.dpId)\n+\n+        def flow1 = flowHelperV2.singleSwitchFlow(sw, true)\n+        flow1.source.detectConnectedDevices.lldp = true\n+        flow1.source.detectConnectedDevices.arp = true\n+        flow1.source.vlanId = commonOuterVlanId\n+        flow1.source.innerVlanId = innerVlanIdFlow1\n+        flow1.encapsulationType = encapsulationType\n+        flowHelperV2.addFlow(flow1)\n+\n+        def flow2 = flowHelperV2.singleSwitchFlow(sw, true, [flow1])\n+        flow2.source.detectConnectedDevices.lldp = true\n+        flow2.source.detectConnectedDevices.arp = true\n+        flow2.source.vlanId = commonOuterVlanId\n+        flow2.source.innerVlanId = innerVlanIdFlow2\n+        flow2.encapsulationType = encapsulationType\n+        flowHelperV2.addFlow(flow2)\n+\n+        when: \"Device connects to src endpoint and send lldp and arp packets for flow1 only\"\n+        def lldpData = LldpData.buildRandom()\n+        def arpData = ArpData.buildRandom()\n+        new ConnectedDevice(traffExamProvider.get(), topology.getTraffGen(sw.dpId),\n+                [flow1.source.vlanId, flow1.source.innerVlanId]).withCloseable {\n+            it.sendLldp(lldpData)\n+            it.sendArp(arpData)\n+        }\n+\n+        then: \"LLDP and ARP connected devices are recognized for flow1\"\n+        Wrappers.wait(WAIT_OFFSET) { //need some time for devices to appear\n+            verifyAll(northbound.getFlowConnectedDevices(flow1.flowId)) {\n+                it.source.lldp.size() == 1\n+                it.source.arp.size() == 1\n+                it.destination.lldp.empty\n+                it.destination.arp.empty\n+                verifyEquals(it.source.lldp[0], lldpData)\n+                verifyEquals(it.source.arp[0], arpData)\n+            }\n+        }\n+\n+        and: \"LLDP and ARP connected devices are not recognized for flow2\"\n+        verifyAll(northbound.getFlowConnectedDevices(flow2.flowId)) {\n+            it.source.lldp.empty\n+            it.source.arp.empty\n+            it.destination.lldp.empty\n+            it.destination.arp.empty\n+        }\n+\n+        and: \"Devices are registered on the switch\"\n+        verifyAll(northboundV2.getConnectedDevices(flow1.source.switchId).ports) {\n+            it.size() == 1\n+            it[0].portNumber == flow1.source.portNumber\n+            it[0].lldp.size() == 1\n+            it[0].lldp.first().flowId == flow1.flowId\n+            it[0].lldp.first().vlan == commonOuterVlanId //due to issue 3475\n+            verifyEquals(it[0].lldp.first(), lldpData)\n+            it[0].arp.size() == 1\n+            it[0].arp.first().flowId == flow1.flowId\n+            it[0].arp.first().vlan == commonOuterVlanId //due to issue 3475\n+            verifyEquals(it[0].arp.first(), arpData)\n+        }\n+\n+        cleanup: \"Restore initial switch properties\"\n+        flow1 && flowHelperV2.deleteFlow(flow1.flowId)\n+        flow2 && flowHelperV2.deleteFlow(flow2.flowId)\n+        initialProps && restoreSwitchProperties(sw.dpId, initialProps)\n+        sw && database.removeConnectedDevices(sw.dpId)\n+\n+        where:\n+        commonOuterVlanId | innerVlanIdFlow1 | innerVlanIdFlow2 | encapsulationType", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31e535a1a3e97131d6ad52f7020976e706ae348f"}, "originalPosition": 153}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3775, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}