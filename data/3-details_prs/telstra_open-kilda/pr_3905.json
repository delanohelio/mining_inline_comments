{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNDYxODg1", "number": 3905, "title": "Stats topology zero-downtime upgrade", "bodyText": "", "createdAt": "2020-12-04T11:07:51Z", "url": "https://github.com/telstra/open-kilda/pull/3905", "merged": true, "mergeCommit": {"oid": "ee363a41dd00dc0da8fb8d1a0712407ccdf185af"}, "closed": true, "closedAt": "2021-02-05T09:32:02Z", "author": {"login": "dpoltavets"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm-v7GgBqjQxMjM3NTM5NTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd3GGWPAFqTU4NDE2MTc1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f9f2f659819721814a7f6876449aa8187c4a84b", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/0f9f2f659819721814a7f6876449aa8187c4a84b", "committedDate": "2020-12-04T11:06:25Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "b3f71af725745851ac3d45bb3e723b4c04e7fe62", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/b3f71af725745851ac3d45bb3e723b4c04e7fe62", "committedDate": "2020-12-17T07:52:19Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3f71af725745851ac3d45bb3e723b4c04e7fe62", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/b3f71af725745851ac3d45bb3e723b4c04e7fe62", "committedDate": "2020-12-17T07:52:19Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "e788be7a617f7d5f653bf5c11b0ade425be8d0cc", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/e788be7a617f7d5f653bf5c11b0ade425be8d0cc", "committedDate": "2020-12-18T05:23:10Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e788be7a617f7d5f653bf5c11b0ade425be8d0cc", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/e788be7a617f7d5f653bf5c11b0ade425be8d0cc", "committedDate": "2020-12-18T05:23:10Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "68d2c520ca5642e710347bb69fa8b2140823c63a", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/68d2c520ca5642e710347bb69fa8b2140823c63a", "committedDate": "2020-12-23T12:53:25Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68d2c520ca5642e710347bb69fa8b2140823c63a", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/68d2c520ca5642e710347bb69fa8b2140823c63a", "committedDate": "2020-12-23T12:53:25Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "e22506d9e1087c58094d732d3bbbabda130c4457", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/e22506d9e1087c58094d732d3bbbabda130c4457", "committedDate": "2020-12-28T11:05:01Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e22506d9e1087c58094d732d3bbbabda130c4457", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/e22506d9e1087c58094d732d3bbbabda130c4457", "committedDate": "2020-12-28T11:05:01Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "6f9c845753aca5f0bfb05822344820cdf6e8d30d", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/6f9c845753aca5f0bfb05822344820cdf6e8d30d", "committedDate": "2020-12-30T11:23:38Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f9c845753aca5f0bfb05822344820cdf6e8d30d", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/6f9c845753aca5f0bfb05822344820cdf6e8d30d", "committedDate": "2020-12-30T11:23:38Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "e8afdbed29eef288f1ae81d21ef8f569c717648c", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/e8afdbed29eef288f1ae81d21ef8f569c717648c", "committedDate": "2021-01-14T10:35:24Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8afdbed29eef288f1ae81d21ef8f569c717648c", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/e8afdbed29eef288f1ae81d21ef8f569c717648c", "committedDate": "2021-01-14T10:35:24Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "4f2e9c463ddd59701ca66aa7b285cdef421707d0", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/4f2e9c463ddd59701ca66aa7b285cdef421707d0", "committedDate": "2021-01-14T11:56:28Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f2e9c463ddd59701ca66aa7b285cdef421707d0", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/4f2e9c463ddd59701ca66aa7b285cdef421707d0", "committedDate": "2021-01-14T11:56:28Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "86ba819d4489c924acdf5feb7e9166d28c1e7465", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/86ba819d4489c924acdf5feb7e9166d28c1e7465", "committedDate": "2021-01-20T13:11:10Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86ba819d4489c924acdf5feb7e9166d28c1e7465", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/86ba819d4489c924acdf5feb7e9166d28c1e7465", "committedDate": "2021-01-20T13:11:10Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "5cd87cf678e62bdcba0f44e68393409854e384f0", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/5cd87cf678e62bdcba0f44e68393409854e384f0", "committedDate": "2021-01-25T20:38:22Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5cd87cf678e62bdcba0f44e68393409854e384f0", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/5cd87cf678e62bdcba0f44e68393409854e384f0", "committedDate": "2021-01-25T20:38:22Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "96404499cb38fe74ec413b8674ff1c891547d048", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/96404499cb38fe74ec413b8674ff1c891547d048", "committedDate": "2021-01-27T08:21:17Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96404499cb38fe74ec413b8674ff1c891547d048", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/96404499cb38fe74ec413b8674ff1c891547d048", "committedDate": "2021-01-27T08:21:17Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "a0cfd321270798f842576a146f8ed5513c926fd1", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/a0cfd321270798f842576a146f8ed5513c926fd1", "committedDate": "2021-01-29T06:09:21Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc5OTUzNzUw", "url": "https://github.com/telstra/open-kilda/pull/3905#pullrequestreview-579953750", "createdAt": "2021-02-01T00:22:52Z", "commit": {"oid": "a0cfd321270798f842576a146f8ed5513c926fd1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMVQwMDoyMjo1MlrOIdOA5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMVQwMDoyNjo1MVrOIdOC6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwOTIyMg==", "bodyText": "Does it make sense to introduce a dedicated \"build\" method instead of repeating \"getZkTopoName(), getConfig().getBlueGreenMode()\" each time?", "url": "https://github.com/telstra/open-kilda/pull/3905#discussion_r567509222", "createdAt": "2021-02-01T00:22:52Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/stats-topology/stats-storm-topology/src/main/java/org/openkilda/wfm/topology/stats/StatsTopology.java", "diffHunk": "@@ -139,23 +146,30 @@ public StormTopology createTopology() {\n         declareBolt(builder,\n                 new TickBolt(topologyConfig.getStatisticsRequestInterval()), TICK_BOLT.name());\n \n-        declareBolt(builder, new StatsRequesterBolt(persistenceManager), STATS_REQUESTER_BOLT.name())\n-                .shuffleGrouping(TICK_BOLT.name());\n+        declareBolt(builder, new StatsRequesterBolt(persistenceManager, ZooKeeperSpout.SPOUT_ID),\n+                STATS_REQUESTER_BOLT.name())\n+                .shuffleGrouping(TICK_BOLT.name())\n+                .allGrouping(ZooKeeperSpout.SPOUT_ID);\n \n-        declareBolt(builder, buildKafkaBolt(topologyConfig.getSpeakerTopic()), STATS_KILDA_SPEAKER_BOLT.name())\n+        declareBolt(builder, buildKafkaBolt(topologyConfig.getSpeakerTopic(), getZkTopoName(),\n+                getConfig().getBlueGreenMode()), STATS_KILDA_SPEAKER_BOLT.name())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0cfd321270798f842576a146f8ed5513c926fd1"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwOTQxMw==", "bodyText": "Why not write \"if (!active) { return; }\"? This will improve readability.", "url": "https://github.com/telstra/open-kilda/pull/3905#discussion_r567509413", "createdAt": "2021-02-01T00:24:26Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/stats-topology/stats-storm-topology/src/main/java/org/openkilda/wfm/topology/stats/bolts/SpeakerBolt.java", "diffHunk": "@@ -52,41 +56,48 @@\n     private static final String TABLE_STATS_STREAM = StatsStreamType.TABLE_STATS.toString();\n     private static final String PACKET_IN_OUT_STATS_STREAM = StatsStreamType.PACKET_IN_OUT_STATS.toString();\n \n+    public SpeakerBolt(String lifeCycleEventSourceComponent) {\n+        super(lifeCycleEventSourceComponent);\n+    }\n+\n     @Override\n     protected void handleInput(Tuple tuple) throws Exception {\n         logger.debug(\"Ingoing tuple: {}\", tuple);\n \n-        Message message = pullValue(tuple, MessageKafkaTranslator.FIELD_ID_PAYLOAD, Message.class);\n-        if (!(message instanceof InfoMessage)) {\n-            return;\n-        }\n-        InfoMessage infoMessage = (InfoMessage) message;\n-        final InfoData data = infoMessage.getData();\n-        if (data instanceof PortStatsData) {\n-            logger.debug(\"Port stats message: {}\", infoMessage);\n-            emitWithContext(PORT_STATS_STREAM, tuple, new Values(infoMessage));\n-        } else if (data instanceof MeterConfigStatsData) {\n-            logger.debug(\"Meter config stats message: {}\", infoMessage);\n-            emitWithContext(METER_CFG_STATS_STREAM, tuple, new Values(infoMessage));\n-        } else if (data instanceof MeterStatsData) {\n-            logger.debug(\"Meter stats message: {}\", infoMessage);\n-            emitWithContext(CACHE_STREAM, tuple, new Values(data));\n-        } else if (data instanceof FlowStatsData) {\n-            logger.debug(\"Flow stats message: {}\", infoMessage);\n-            ImmutablePair<FlowStatsData, FlowStatsData> splitData =\n-                    splitSystemRuleStatsAndFlowStats((FlowStatsData) data);\n-\n-            emitWithContext(SYSTEM_RULES_STATS_STREAM, tuple, new Values(splitData.getKey()));\n-            emitWithContext(CACHE_STREAM, tuple, new Values(splitData.getValue()));\n-        } else if (data instanceof SwitchTableStatsData) {\n-            logger.debug(\"Table stats message: {}\", infoMessage);\n-            emitWithContext(TABLE_STATS_STREAM, tuple, new Values(data));\n-        } else if (data instanceof GetPacketInOutStatsResponse) {\n-            logger.debug(\"Packet in out stats message: {}\", infoMessage);\n-            emitWithContext(PACKET_IN_OUT_STATS_STREAM, tuple, new Values(data));\n-        } else {\n-            //FIXME (ncherevko): we might receive few unexpected messages here, need to fix it and uncomment below line\n-            //unhandledInput(tuple);\n+        if (active) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0cfd321270798f842576a146f8ed5513c926fd1"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzUwOTczOA==", "bodyText": "Can such logic of building ZK node names be shared and reusable?", "url": "https://github.com/telstra/open-kilda/pull/3905#discussion_r567509738", "createdAt": "2021-02-01T00:26:51Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/stats-topology/stats-storm-topology/src/test/java/org/openkilda/wfm/topology/stats/StatsTopologyTest.java", "diffHunk": "@@ -163,6 +172,16 @@ public static void setupOnce() throws Exception {\n         sleep(TOPOLOGY_START_TIMEOUT);\n     }\n \n+    private static void setStartSignal() throws IOException, KeeperException, InterruptedException {\n+        ZooKeeper zooKeeper = new ZooKeeper(\"localhost\", 3000, event -> { });\n+\n+        setNode(zooKeeper, \"/kilda\", \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0cfd321270798f842576a146f8ed5513c926fd1"}, "originalPosition": 65}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0cfd321270798f842576a146f8ed5513c926fd1", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/a0cfd321270798f842576a146f8ed5513c926fd1", "committedDate": "2021-01-29T06:09:21Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "20001b1cda98d115d58681e71d121a2e8a6749ea", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/20001b1cda98d115d58681e71d121a2e8a6749ea", "committedDate": "2021-02-03T13:04:11Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgzNTA2Nzcw", "url": "https://github.com/telstra/open-kilda/pull/3905#pullrequestreview-583506770", "createdAt": "2021-02-04T15:21:36Z", "commit": {"oid": "20001b1cda98d115d58681e71d121a2e8a6749ea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88c7db4624018bf2583ac287cdbb022b256d82f0", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/88c7db4624018bf2583ac287cdbb022b256d82f0", "committedDate": "2021-02-05T09:16:00Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20001b1cda98d115d58681e71d121a2e8a6749ea", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/20001b1cda98d115d58681e71d121a2e8a6749ea", "committedDate": "2021-02-03T13:04:11Z", "message": "Stats topology zero-downtime upgrade"}, "afterCommit": {"oid": "88c7db4624018bf2583ac287cdbb022b256d82f0", "author": {"user": {"login": "dpoltavets", "name": "Dmitriy Poltavets"}}, "url": "https://github.com/telstra/open-kilda/commit/88c7db4624018bf2583ac287cdbb022b256d82f0", "committedDate": "2021-02-05T09:16:00Z", "message": "Stats topology zero-downtime upgrade"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg0MTYxNzU5", "url": "https://github.com/telstra/open-kilda/pull/3905#pullrequestreview-584161759", "createdAt": "2021-02-05T09:29:26Z", "commit": {"oid": "88c7db4624018bf2583ac287cdbb022b256d82f0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3786, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}