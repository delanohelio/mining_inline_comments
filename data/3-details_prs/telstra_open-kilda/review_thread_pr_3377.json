{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwOTIxOTQ2", "number": 3377, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzoyMTo1NFrOD78K0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1MDo1MVrOD-Ok-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MTc4Mzg1OnYy", "diffSide": "RIGHT", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/swapendpoints/FlowSwapEndpointsFsm.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzoyMTo1NFrOGUkkhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzoyMTo1NFrOGUkkhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIyMzg3Ng==", "bodyText": "id remove -", "url": "https://github.com/telstra/open-kilda/pull/3377#discussion_r424223876", "createdAt": "2020-05-13T07:21:54Z", "author": {"login": "timofei-durakov"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/swapendpoints/FlowSwapEndpointsFsm.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.topology.flowhs.fsm.swapendpoints;\n+\n+import static java.lang.String.format;\n+\n+import org.openkilda.messaging.Message;\n+import org.openkilda.messaging.command.flow.FlowRequest;\n+import org.openkilda.messaging.error.ErrorData;\n+import org.openkilda.messaging.error.ErrorType;\n+import org.openkilda.messaging.info.flow.FlowResponse;\n+import org.openkilda.model.Flow;\n+import org.openkilda.persistence.PersistenceManager;\n+import org.openkilda.wfm.CommandContext;\n+import org.openkilda.wfm.topology.flowhs.fsm.common.NbTrackableFsm;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.Event;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.State;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.actions.OnFinishedAction;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.actions.OnFinishedWithErrorAction;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.actions.OnReceivedUpdateResponseAction;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.actions.RevertUpdateRequestAction;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.actions.UpdateRequestAction;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.actions.ValidateFlowsAction;\n+import org.openkilda.wfm.topology.flowhs.model.RequestedFlow;\n+import org.openkilda.wfm.topology.flowhs.service.FlowSwapEndpointsHubCarrier;\n+\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.squirrelframework.foundation.fsm.StateMachineBuilder;\n+import org.squirrelframework.foundation.fsm.StateMachineBuilderFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Getter\n+@Setter\n+@Slf4j\n+public class FlowSwapEndpointsFsm extends NbTrackableFsm<FlowSwapEndpointsFsm, State, Event, FlowSwapEndpointsContext> {\n+    public static final int REQUEST_COUNT = 2;\n+\n+    public static final String GENERIC_ERROR_MESSAGE = \"Could not swap endpoints\";\n+\n+    private final FlowSwapEndpointsHubCarrier carrier;\n+\n+    private RequestedFlow firstTargetFlow;\n+    private RequestedFlow secondTargetFlow;\n+    private String firstFlowId;\n+    private String secondFlowId;\n+\n+    private int awaitingResponses = REQUEST_COUNT;\n+    private List<FlowResponse> flowResponses = new ArrayList<>();\n+    private List<ErrorData> errors = new ArrayList<>();\n+    private Flow firstOriginalFlow;\n+    private Flow secondOriginalFlow;\n+\n+    public FlowSwapEndpointsFsm(CommandContext commandContext, FlowSwapEndpointsHubCarrier carrier,\n+                                RequestedFlow firstTargetFlow, RequestedFlow secondTargetFlow) {\n+        super(commandContext);\n+        this.carrier = carrier;\n+        this.firstTargetFlow = firstTargetFlow;\n+        this.secondTargetFlow = secondTargetFlow;\n+        this.firstFlowId = firstTargetFlow.getFlowId();\n+        this.secondFlowId = secondTargetFlow.getFlowId();\n+    }\n+\n+    @Override\n+    public String getFlowId() {\n+        throw new UnsupportedOperationException(\"Not implemented for swap flow endpoints operation. Skipping\");\n+    }\n+\n+    @Override\n+    public void reportError(Event event) {\n+        if (Event.TIMEOUT == event) {\n+            reportGlobalTimeout();\n+        }\n+        // other errors reported inside actions and can be ignored here\n+    }\n+\n+    @Override\n+    protected String getCrudActionName() {\n+        return \"swap-endpoints\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f5bb604f39a1776461b3f6a93c7f1974a6b9179"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MTgwNjc1OnYy", "diffSide": "RIGHT", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/SwapEndpointSpec.groovy", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzoyODo0NFrOGUky_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzoyODo0NFrOGUky_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIyNzU4Mg==", "bodyText": "why is it 500?", "url": "https://github.com/telstra/open-kilda/pull/3377#discussion_r424227582", "createdAt": "2020-05-13T07:28:44Z", "author": {"login": "timofei-durakov"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/SwapEndpointSpec.groovy", "diffHunk": "@@ -820,12 +827,12 @@ switches\"() {\n                 new SwapFlowPayload(flow2.id, flowHelper.toFlowEndpointV2(flow2Src),\n                         flowHelper.toFlowEndpointV2(flow2Dst)))\n \n-        then: \"An error is received (400 code)\"\n-        def exc = thrown(HttpClientErrorException)\n-        exc.rawStatusCode == 400\n-        exc.responseBodyAsString.to(MessageError).errorMessage == \"Can not swap endpoints for flows: \" +\n-                \"Failed to find path with requested bandwidth=${flow1.maximumBandwidth}: \" +\n-                \"Switch ${flow2SwitchPair.src.dpId} doesn't have links with enough bandwidth\"\n+        then: \"An error is received (500 code)\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f5bb604f39a1776461b3f6a93c7f1974a6b9179"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MTgwNzQwOnYy", "diffSide": "RIGHT", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/SwapEndpointSpec.groovy", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzoyODo1NFrOGUkzYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzoyODo1NFrOGUkzYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIyNzY4Mg==", "bodyText": "the same", "url": "https://github.com/telstra/open-kilda/pull/3377#discussion_r424227682", "createdAt": "2020-05-13T07:28:54Z", "author": {"login": "timofei-durakov"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/SwapEndpointSpec.groovy", "diffHunk": "@@ -965,12 +972,12 @@ switches\"() {\n                 new SwapFlowPayload(flow2.id, flowHelper.toFlowEndpointV2(flow1.source),\n                         flowHelper.toFlowEndpointV2(flow2.destination)))\n \n-        then: \"An error is received (400 code)\"\n-        def exc = thrown(HttpClientErrorException)\n-        exc.rawStatusCode == 400\n-        exc.responseBodyAsString.to(MessageError).errorMessage == \"Can not swap endpoints for flows: \" +\n-                \"Failed to find path with requested bandwidth=${flow2.maximumBandwidth}: \" +\n-                \"Switch ${flow1SwitchPair.src.dpId} doesn't have links with enough bandwidth\"\n+        then: \"An error is received (500 code)\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f5bb604f39a1776461b3f6a93c7f1974a6b9179"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MTgwNzk1OnYy", "diffSide": "RIGHT", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/SwapEndpointSpec.groovy", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzoyOTowNlrOGUkzwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzoyOTowNlrOGUkzwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIyNzc3Ng==", "bodyText": "and here too", "url": "https://github.com/telstra/open-kilda/pull/3377#discussion_r424227776", "createdAt": "2020-05-13T07:29:06Z", "author": {"login": "timofei-durakov"}, "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/SwapEndpointSpec.groovy", "diffHunk": "@@ -1137,6 +1144,76 @@ switches\"() {\n         ]\n     }\n \n+    @Tidy\n+    def \"System reverts both flows if fails during rule installation when swapping endpoints\"() {\n+        given: \"Two flows with different src switches and same dst\"\n+        def swPair1\n+        def swPair2 = topologyHelper.switchPairs.find { second ->\n+            swPair1 = topologyHelper.switchPairs.find { first ->\n+                first.src != second.src && first.dst == second.dst\n+            }\n+        }\n+        assumeTrue(\"Unable to find 2 switch pairs with different src and same dst switches\", swPair1 && swPair2)\n+        def flow1 = flowHelperV2.randomFlow(swPair1).tap {\n+            it.source.portNumber = getFreePort(swPair1.src, [swPair2.src])\n+        }\n+        def flow2 = flowHelperV2.randomFlow(swPair2).tap {\n+            it.source.portNumber = getFreePort(swPair2.src, [swPair1.src])\n+        }\n+        flowHelperV2.addFlow(flow1)\n+        flowHelperV2.addFlow(flow2)\n+\n+        when: \"Try to swap flow src endoints, but flow1 src switch does not respond\"\n+        def blockData = switchHelper.knockoutSwitch(swPair1.src, mgmtFlManager)\n+        database.setSwitchStatus(swPair1.src.dpId, SwitchStatus.ACTIVE)\n+        northbound.swapFlowEndpoint(new SwapFlowPayload(flow1.flowId, flow2.source, flow1.destination),\n+                new SwapFlowPayload(flow2.flowId, flow1.source, flow2.destination))\n+\n+        then: \"Receive error response\"\n+        def exc = thrown(HttpServerErrorException)\n+        exc.rawStatusCode == 500", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f5bb604f39a1776461b3f6a93c7f1974a6b9179"}, "originalPosition": 141}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NjY1NjAwOnYy", "diffSide": "RIGHT", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/swapendpoints/actions/RevertUpdateRequestAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMTo0NjoyN1rOGWzh-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMTo0NjoyN1rOGWzh-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU2NjEzOQ==", "bodyText": "What if one of the flows has \"in-progress\" status (like network changes trigger a reroute)? Will this leave the changes not reverted?", "url": "https://github.com/telstra/open-kilda/pull/3377#discussion_r426566139", "createdAt": "2020-05-18T11:46:27Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/swapendpoints/actions/RevertUpdateRequestAction.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.actions;\n+\n+import org.openkilda.messaging.command.flow.FlowRequest;\n+import org.openkilda.messaging.command.flow.FlowRequest.Type;\n+import org.openkilda.model.Flow;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsContext;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.Event;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.State;\n+import org.openkilda.wfm.topology.flowhs.mapper.RequestedFlowMapper;\n+\n+import com.google.common.collect.Sets;\n+import lombok.extern.slf4j.Slf4j;\n+import org.squirrelframework.foundation.fsm.AnonymousAction;\n+\n+import java.util.ArrayList;\n+\n+@Slf4j\n+public class RevertUpdateRequestAction\n+        extends AnonymousAction<FlowSwapEndpointsFsm, State, Event, FlowSwapEndpointsContext> {\n+\n+    @Override\n+    public void execute(State from, State to, Event event, FlowSwapEndpointsContext context,\n+                        FlowSwapEndpointsFsm stateMachine) {\n+        stateMachine.setAwaitingResponses(FlowSwapEndpointsFsm.REQUEST_COUNT);\n+        stateMachine.setFlowResponses(new ArrayList<>());\n+\n+        Flow firstOriginalFlow = stateMachine.getFirstOriginalFlow();\n+        Flow secondOriginalFlow = stateMachine.getSecondOriginalFlow();\n+\n+        sendRevertUpdateCommand(firstOriginalFlow, secondOriginalFlow.getFlowId(), stateMachine);\n+        sendRevertUpdateCommand(secondOriginalFlow, firstOriginalFlow.getFlowId(), stateMachine);\n+    }\n+\n+    private void sendRevertUpdateCommand(Flow flow, String anotherFlowId, FlowSwapEndpointsFsm stateMachine) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f5bb604f39a1776461b3f6a93c7f1974a6b9179"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTc2NjY3OnYy", "diffSide": "RIGHT", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/swapendpoints/actions/OnFinishedAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1MDowMVrOGYMsYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNToyMjozM1rOGYmjHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyNjk3Ng==", "bodyText": "Shoudn't 2 updates be in the same transaction?", "url": "https://github.com/telstra/open-kilda/pull/3377#discussion_r428026976", "createdAt": "2020-05-20T13:50:01Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/swapendpoints/actions/OnFinishedAction.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.actions;\n+\n+import static java.lang.String.format;\n+\n+import org.openkilda.messaging.Message;\n+import org.openkilda.messaging.info.InfoMessage;\n+import org.openkilda.messaging.info.flow.FlowResponse;\n+import org.openkilda.messaging.info.flow.SwapFlowResponse;\n+import org.openkilda.persistence.PersistenceManager;\n+import org.openkilda.wfm.CommandContext;\n+import org.openkilda.wfm.share.logger.FlowOperationsDashboardLogger;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsContext;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.Event;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.State;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+@Slf4j\n+public class OnFinishedAction extends OnFinishedNbTrackableAction {\n+\n+    public OnFinishedAction(PersistenceManager persistenceManager, FlowOperationsDashboardLogger dashboardLogger) {\n+        super(persistenceManager, dashboardLogger);\n+    }\n+\n+    @Override\n+    protected Optional<Message> performWithResponse(State from, State to, Event event, FlowSwapEndpointsContext context,\n+                                                    FlowSwapEndpointsFsm stateMachine) {\n+        log.info(\"Swap endpoints operation completed successfully.\");\n+\n+        updateFlowStatus(stateMachine.getFirstFlowId(), stateMachine);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ef76080f67386db596acbef2855b30930cfffbc"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ1MDU4OA==", "bodyText": "Yes, it should be. Fixed.", "url": "https://github.com/telstra/open-kilda/pull/3377#discussion_r428450588", "createdAt": "2020-05-21T05:22:33Z", "author": {"login": "dpoltavets"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/swapendpoints/actions/OnFinishedAction.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.actions;\n+\n+import static java.lang.String.format;\n+\n+import org.openkilda.messaging.Message;\n+import org.openkilda.messaging.info.InfoMessage;\n+import org.openkilda.messaging.info.flow.FlowResponse;\n+import org.openkilda.messaging.info.flow.SwapFlowResponse;\n+import org.openkilda.persistence.PersistenceManager;\n+import org.openkilda.wfm.CommandContext;\n+import org.openkilda.wfm.share.logger.FlowOperationsDashboardLogger;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsContext;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.Event;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.State;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+@Slf4j\n+public class OnFinishedAction extends OnFinishedNbTrackableAction {\n+\n+    public OnFinishedAction(PersistenceManager persistenceManager, FlowOperationsDashboardLogger dashboardLogger) {\n+        super(persistenceManager, dashboardLogger);\n+    }\n+\n+    @Override\n+    protected Optional<Message> performWithResponse(State from, State to, Event event, FlowSwapEndpointsContext context,\n+                                                    FlowSwapEndpointsFsm stateMachine) {\n+        log.info(\"Swap endpoints operation completed successfully.\");\n+\n+        updateFlowStatus(stateMachine.getFirstFlowId(), stateMachine);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyNjk3Ng=="}, "originalCommit": {"oid": "4ef76080f67386db596acbef2855b30930cfffbc"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTc3MTQ1OnYy", "diffSide": "RIGHT", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/swapendpoints/actions/OnFinishedWithErrorAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1MDo1MVrOGYMvKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNToyMjozOVrOGYmjMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyNzY5MQ==", "bodyText": "Shoudn't 2 updates be in the same transaction?", "url": "https://github.com/telstra/open-kilda/pull/3377#discussion_r428027691", "createdAt": "2020-05-20T13:50:51Z", "author": {"login": "sergii-iakovenko"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/swapendpoints/actions/OnFinishedWithErrorAction.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.actions;\n+\n+import static java.lang.String.format;\n+\n+import org.openkilda.messaging.Message;\n+import org.openkilda.messaging.error.ErrorData;\n+import org.openkilda.messaging.error.ErrorMessage;\n+import org.openkilda.messaging.error.ErrorType;\n+import org.openkilda.messaging.info.flow.FlowResponse;\n+import org.openkilda.messaging.model.FlowDto;\n+import org.openkilda.persistence.PersistenceManager;\n+import org.openkilda.wfm.CommandContext;\n+import org.openkilda.wfm.share.logger.FlowOperationsDashboardLogger;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsContext;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.Event;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.State;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+public class OnFinishedWithErrorAction extends OnFinishedNbTrackableAction {\n+\n+    public OnFinishedWithErrorAction(PersistenceManager persistenceManager,\n+                                     FlowOperationsDashboardLogger dashboardLogger) {\n+        super(persistenceManager, dashboardLogger);\n+    }\n+\n+    @Override\n+    protected Optional<Message> performWithResponse(State from, State to, Event event, FlowSwapEndpointsContext context,\n+                                                    FlowSwapEndpointsFsm stateMachine) {\n+\n+        ErrorData data;\n+        if (Event.TIMEOUT.equals(event)) {\n+            data = new ErrorData(ErrorType.OPERATION_TIMED_OUT, getGenericErrorMessage(),\n+                    \"Flow swap endpoints failed by timeout\");\n+        } else if (Event.NEXT.equals(event)) {\n+            List<String> flows = stateMachine.getFlowResponses().stream()\n+                    .map(FlowResponse::getPayload)\n+                    .map(FlowDto::getFlowId)\n+                    .collect(Collectors.toList());\n+            data = new ErrorData(ErrorType.UPDATE_FAILURE, getGenericErrorMessage(),\n+                    format(\"Reverted flows: %s\", flows));\n+        } else {\n+            data = (ErrorData) context.getResponse();\n+        }\n+\n+        if (!Event.VALIDATION_ERROR.equals(event)) {\n+            saveActionToHistory(stateMachine,\n+                    stateMachine.getFirstFlowId(), stateMachine.getSecondFlowId(), data.getErrorDescription());\n+            saveActionToHistory(stateMachine,\n+                    stateMachine.getSecondFlowId(), stateMachine.getFirstFlowId(), data.getErrorDescription());\n+        }\n+\n+        updateFlowStatus(stateMachine.getFirstFlowId(), stateMachine);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ef76080f67386db596acbef2855b30930cfffbc"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ1MDYwOQ==", "bodyText": "Yes, it should be. Fixed.", "url": "https://github.com/telstra/open-kilda/pull/3377#discussion_r428450609", "createdAt": "2020-05-21T05:22:39Z", "author": {"login": "dpoltavets"}, "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/swapendpoints/actions/OnFinishedWithErrorAction.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.actions;\n+\n+import static java.lang.String.format;\n+\n+import org.openkilda.messaging.Message;\n+import org.openkilda.messaging.error.ErrorData;\n+import org.openkilda.messaging.error.ErrorMessage;\n+import org.openkilda.messaging.error.ErrorType;\n+import org.openkilda.messaging.info.flow.FlowResponse;\n+import org.openkilda.messaging.model.FlowDto;\n+import org.openkilda.persistence.PersistenceManager;\n+import org.openkilda.wfm.CommandContext;\n+import org.openkilda.wfm.share.logger.FlowOperationsDashboardLogger;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsContext;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.Event;\n+import org.openkilda.wfm.topology.flowhs.fsm.swapendpoints.FlowSwapEndpointsFsm.State;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+@Slf4j\n+public class OnFinishedWithErrorAction extends OnFinishedNbTrackableAction {\n+\n+    public OnFinishedWithErrorAction(PersistenceManager persistenceManager,\n+                                     FlowOperationsDashboardLogger dashboardLogger) {\n+        super(persistenceManager, dashboardLogger);\n+    }\n+\n+    @Override\n+    protected Optional<Message> performWithResponse(State from, State to, Event event, FlowSwapEndpointsContext context,\n+                                                    FlowSwapEndpointsFsm stateMachine) {\n+\n+        ErrorData data;\n+        if (Event.TIMEOUT.equals(event)) {\n+            data = new ErrorData(ErrorType.OPERATION_TIMED_OUT, getGenericErrorMessage(),\n+                    \"Flow swap endpoints failed by timeout\");\n+        } else if (Event.NEXT.equals(event)) {\n+            List<String> flows = stateMachine.getFlowResponses().stream()\n+                    .map(FlowResponse::getPayload)\n+                    .map(FlowDto::getFlowId)\n+                    .collect(Collectors.toList());\n+            data = new ErrorData(ErrorType.UPDATE_FAILURE, getGenericErrorMessage(),\n+                    format(\"Reverted flows: %s\", flows));\n+        } else {\n+            data = (ErrorData) context.getResponse();\n+        }\n+\n+        if (!Event.VALIDATION_ERROR.equals(event)) {\n+            saveActionToHistory(stateMachine,\n+                    stateMachine.getFirstFlowId(), stateMachine.getSecondFlowId(), data.getErrorDescription());\n+            saveActionToHistory(stateMachine,\n+                    stateMachine.getSecondFlowId(), stateMachine.getFirstFlowId(), data.getErrorDescription());\n+        }\n+\n+        updateFlowStatus(stateMachine.getFirstFlowId(), stateMachine);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyNzY5MQ=="}, "originalCommit": {"oid": "4ef76080f67386db596acbef2855b30930cfffbc"}, "originalPosition": 74}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1926, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}