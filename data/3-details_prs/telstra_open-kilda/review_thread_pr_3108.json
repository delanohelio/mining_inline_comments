{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNDY1NjY5", "number": 3108, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTowMzo1NFrODXfA1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTowNjozNVrODXfDXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1OTUxOTU3OnYy", "diffSide": "RIGHT", "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTowMzo1NFrOFcza3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTowMzo1NFrOFcza3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0NjkxMA==", "bodyText": "what's the purpose of such aggregation?", "url": "https://github.com/telstra/open-kilda/pull/3108#discussion_r365746910", "createdAt": "2020-01-13T11:03:54Z", "author": {"login": "timofei-durakov"}, "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java", "diffHunk": "@@ -67,33 +72,51 @@ public RerouteService(PersistenceManager persistenceManager) {\n      * @param command origin command\n      */\n     public void rerouteAffectedFlows(MessageSender sender, String correlationId, RerouteAffectedFlows command) {\n+        // TODO(surabujin): need better/more detailed representation of failed ISL\n         PathNode pathNode = command.getPathNode();\n         int port = pathNode.getPortNo();\n         SwitchId switchId = pathNode.getSwitchId();\n+        final IslEndpoint affectedIsl = new IslEndpoint(switchId, port);\n+\n         Collection<FlowPath> affectedFlowPaths\n                 = getAffectedFlowPaths(pathNode.getSwitchId(), pathNode.getPortNo());\n+        Map<String, Flow> flowById = collectAffectedFlows(affectedFlowPaths);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e2dc1197fe27f979feecefd85307e76f2547fa6"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1OTUyMDgzOnYy", "diffSide": "RIGHT", "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTowNDoyNFrOFczbpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTowNDoyNFrOFczbpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0NzExMQ==", "bodyText": "could you please comment out a scenario for this", "url": "https://github.com/telstra/open-kilda/pull/3108#discussion_r365747111", "createdAt": "2020-01-13T11:04:24Z", "author": {"login": "timofei-durakov"}, "path": "services/wfm/src/main/java/org/openkilda/wfm/topology/reroute/service/RerouteService.java", "diffHunk": "@@ -67,33 +72,51 @@ public RerouteService(PersistenceManager persistenceManager) {\n      * @param command origin command\n      */\n     public void rerouteAffectedFlows(MessageSender sender, String correlationId, RerouteAffectedFlows command) {\n+        // TODO(surabujin): need better/more detailed representation of failed ISL\n         PathNode pathNode = command.getPathNode();\n         int port = pathNode.getPortNo();\n         SwitchId switchId = pathNode.getSwitchId();\n+        final IslEndpoint affectedIsl = new IslEndpoint(switchId, port);\n+\n         Collection<FlowPath> affectedFlowPaths\n                 = getAffectedFlowPaths(pathNode.getSwitchId(), pathNode.getPortNo());\n+        Map<String, Flow> flowById = collectAffectedFlows(affectedFlowPaths);\n \n         // swapping affected primary paths with available protected\n         List<FlowPath> pathsForSwapping = getPathsForSwapping(affectedFlowPaths);\n         for (FlowPath path : pathsForSwapping) {\n             sender.emitPathSwapCommand(correlationId, path, command.getReason());\n         }\n-        Map<Flow, Set<PathId>> flowsForRerouting = groupFlowsForRerouting(affectedFlowPaths);\n-        for (Entry<Flow, Set<PathId>> entry : flowsForRerouting.entrySet()) {\n-            Flow flow = entry.getKey();\n+\n+        Map<String, List<FlowPath>> flowsForRerouting = groupPathsForRerouting(affectedFlowPaths);\n+        for (Entry<String, List<FlowPath>> entry : flowsForRerouting.entrySet()) {\n+            String flowId = entry.getKey();\n+            List<FlowPath> flowPaths = entry.getValue();\n+\n+            Flow flow = flowById.get(flowId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e2dc1197fe27f979feecefd85307e76f2547fa6"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1OTUyNjA1OnYy", "diffSide": "RIGHT", "path": "services/src/messaging/src/main/java/org/openkilda/messaging/command/flow/FlowRerouteRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTowNjozNVrOFczexg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTowNjozNVrOFczexg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc0NzkxMA==", "bodyText": "what does it mean? leave a doc", "url": "https://github.com/telstra/open-kilda/pull/3108#discussion_r365747910", "createdAt": "2020-01-13T11:06:35Z", "author": {"login": "timofei-durakov"}, "path": "services/src/messaging/src/main/java/org/openkilda/messaging/command/flow/FlowRerouteRequest.java", "diffHunk": "@@ -41,29 +41,37 @@\n     protected String flowId;\n \n     @JsonProperty(\"path_ids\")\n-    protected Set<PathId> pathIds;\n+    protected Set<IslEndpoint> affectedIsl;\n \n     /**\n      * Update flow even if path will not be changed.\n      */\n     @JsonProperty(\"force\")\n     private boolean force;\n \n+    @JsonProperty(\"effectively_down\")\n+    private boolean effectivelyDown;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e2dc1197fe27f979feecefd85307e76f2547fa6"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2050, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}