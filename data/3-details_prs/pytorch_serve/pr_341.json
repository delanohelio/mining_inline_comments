{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MTc2NzA3", "number": 341, "title": "fixed code for build failure in python virtual environment", "bodyText": "Description\nThe UT for reading config properties from the system environment variable and the metric collector in the frontend layer were polluting system environment and thereby removing the python virtual environment-related system variables. Due to which the python virtual environment frameworks like pyenv/virtualenv/venv etc. used to fall back to system python and hence failed to find the required packages like psutil.\nFixes #340\nType of change\nPlease delete options that are not relevant.\n\n Bug fix (non-breaking change which fixes an issue)\n\nFeature/Issue validation/testing\n\nCreate and activate a python virtual environment.\nClone serve repo\nswitch to issue_340 branch\nRun install from source scripts as per OS (Ubuntu/Mac)\n\nChecklist:\n\n Have you added tests that prove your fix is effective or that this feature works?\n New and existing unit tests pass locally with these changes?", "createdAt": "2020-05-13T07:38:34Z", "url": "https://github.com/pytorch/serve/pull/341", "merged": true, "mergeCommit": {"oid": "f08d6a84ef1661f60f30df670961f1f3d6725220"}, "closed": true, "closedAt": "2020-05-22T19:13:08Z", "author": {"login": "harshbafna"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgz38DgH2gAyNDE3MTc2NzA3OjUzZjY4NmNjYTQzYTE2NDA4ODVkYjEyYjgzNmQ1NjNmMzE1MmQ2MTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcj2Fw2AH2gAyNDE3MTc2NzA3OjM3NWVlMTk3MTU4MzM4MzAxZWVlYjExN2UxMDUzMDc2YzQ0MGY4MTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "53f686cca43a1640885db12b836d563f3152d618", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/53f686cca43a1640885db12b836d563f3152d618", "committedDate": "2020-05-13T07:37:55Z", "message": "fixed code for build failure in python virtual environment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2958bc07a52018b57e9866dd1471b5ae1e342a8", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/a2958bc07a52018b57e9866dd1471b5ae1e342a8", "committedDate": "2020-05-17T13:49:26Z", "message": "Merge branch 'staging_0_1_1' into issue_340"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11adf0e0d4ce8a4f681f6ff3152c596dcb74e250", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/11adf0e0d4ce8a4f681f6ff3152c596dcb74e250", "committedDate": "2020-05-19T04:00:45Z", "message": "Merge branch 'staging_0_1_1' into issue_340"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6a7b2593ac04239d3adce9f03a2ea2b148d1a44", "author": {"user": {"login": "maaquib", "name": "Aaqib"}}, "url": "https://github.com/pytorch/serve/commit/b6a7b2593ac04239d3adce9f03a2ea2b148d1a44", "committedDate": "2020-05-20T19:36:41Z", "message": "Merge branch 'staging_0_1_1' into issue_340"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1ODA2Mjg4", "url": "https://github.com/pytorch/serve/pull/341#pullrequestreview-415806288", "createdAt": "2020-05-21T00:39:31Z", "commit": {"oid": "b6a7b2593ac04239d3adce9f03a2ea2b148d1a44"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NDMzODQ2", "url": "https://github.com/pytorch/serve/pull/341#pullrequestreview-416433846", "createdAt": "2020-05-21T19:36:26Z", "commit": {"oid": "b6a7b2593ac04239d3adce9f03a2ea2b148d1a44"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "095ebd482f1f1b7c8353ef1531ba75cddb909b1d", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/095ebd482f1f1b7c8353ef1531ba75cddb909b1d", "committedDate": "2020-05-22T04:33:03Z", "message": "Merge branch 'staging_0_1_1' into issue_340"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41b1b58fa37aa6536b79fc6e4cd879dd843c9f36", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/41b1b58fa37aa6536b79fc6e4cd879dd843c9f36", "committedDate": "2020-05-22T04:38:53Z", "message": "added exception missed on resolving conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60340d6340bc19e742d8c349de81f8df9c2b534a", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/60340d6340bc19e742d8c349de81f8df9c2b534a", "committedDate": "2020-05-22T04:39:09Z", "message": "Merge branch 'issue_340' of https://github.com/pytorch/serve into issue_340"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDc2NzA5", "url": "https://github.com/pytorch/serve/pull/341#pullrequestreview-417076709", "createdAt": "2020-05-22T17:30:55Z", "commit": {"oid": "60340d6340bc19e742d8c349de81f8df9c2b534a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzozMDo1NVrOGZeuQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzozMDo1NVrOGZeuQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MDk0Nw==", "bodyText": "Seems like we are repeating this code. This logic exists in WorkerLifeCycle.java as well. We could probably pull this logic of pulling environtment variables and filtering out blacklisted environment variables into a util file and use the methods here and in workerlifecycle.", "url": "https://github.com/pytorch/serve/pull/341#discussion_r429370947", "createdAt": "2020-05-22T17:30:55Z", "author": {"login": "vdantu"}, "path": "frontend/server/src/main/java/org/pytorch/serve/metrics/MetricCollector.java", "diffHunk": "@@ -40,23 +42,37 @@ public void run() {\n             String pythonEnv;\n             if ((pythonPath == null || pythonPath.isEmpty())\n                     && (!workingDir.getAbsolutePath().contains(\"site-package\"))) {\n-                pythonEnv = \"PYTHONPATH=\" + workingDir.getAbsolutePath();\n+                pythonEnv = workingDir.getAbsolutePath();\n             } else {\n-                pythonEnv = \"PYTHONPATH=\" + pythonPath;\n+                pythonEnv = pythonPath;\n                 if (!workingDir.getAbsolutePath().contains(\"site-package\")) {\n                     pythonEnv += File.pathSeparatorChar + workingDir.getAbsolutePath(); // NOPMD\n                 }\n             }\n             // sbin added for macs for python sysctl pythonpath\n+            HashMap<String, String> environment = new HashMap<>(System.getenv());\n+            environment.put(\"PYTHONPATH\", pythonEnv);\n+\n             StringBuilder path = new StringBuilder();\n-            path.append(\"PATH=\").append(System.getenv(\"PATH\"));\n+            path.append(System.getenv(\"PATH\"));\n             String osName = System.getProperty(\"os.name\");\n             if (osName.startsWith(\"Mac OS X\")) {\n                 path.append(File.pathSeparatorChar).append(\"/sbin/\");\n             }\n-            String[] env = {pythonEnv, path.toString()};\n-            final Process p = Runtime.getRuntime().exec(args, env, workingDir);\n \n+            environment.put(\"PATH\", path.toString());\n+            ArrayList<String> envList = new ArrayList<>();\n+            Pattern blackList = configManager.getBlacklistPattern();\n+\n+            for (Map.Entry<String, String> entry : environment.entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60340d6340bc19e742d8c349de81f8df9c2b534a"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "375ee197158338301eeeb117e1053076c440f818", "author": {"user": {"login": "vdantu", "name": "Vamshidhar Dantu"}}, "url": "https://github.com/pytorch/serve/commit/375ee197158338301eeeb117e1053076c440f818", "committedDate": "2020-05-22T17:54:36Z", "message": "Merge branch 'staging_0_1_1' into issue_340"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2404, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}