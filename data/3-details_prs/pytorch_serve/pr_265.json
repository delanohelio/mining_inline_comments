{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4Mzc1NjU2", "number": 265, "title": "updated object detector handler to use only default cuda device for torchvision version less then 0.6", "bodyText": "Description\nThere was bug in torchvision \"0.5.0\" due to which the object detector models like faster-rcnn, mask-rcnn etc. did not work on multiple GPU devices. Thus the object detector default handler used \"cuda:0\" device for execution on GPU instances.\nWith torchvision \"0.6.0\" release this issue has been fixed. This PR makes the device selection logic conditional for version \"0.5.0\" and below. Also made changes to use default cuda device instead of \"cuda:0\"\nAlso enhanced sanity script to validate all default handlers.\nFixes #104\nType of change\n\n Bug fix (non-breaking change which fixes an issue)\n This change requires a documentation update\n\nFeature/Issue validation/testing\n\n\nInstall torchvision 0.5.0\n\n\nregister fastrcnn model with 4 workers [should be successful]\n\n\nrun inference 4 times [should be successful]\n\n\ncheck nvidi-smi output, all workers should be created on default cuda device.\n\n\nupgrade torchvision to 0.6.0\n\n\nregister fastrcnn model with 4 workers [should be successful]\n\n\nrun inference 4 times [should be successful]\n\n\ncheck nvidi-smi output, all workers should be created on different cuda device.\n\n\nLogs :\nInstall from source :\ninstall_from_src_104.txt\nTest Object detector on multiple GPUs (p3.8xlarge) :\ntest_object_detector_gpu_104.log\nChecklist:\n\n Have you added tests that prove your fix is effective or that this feature works?\n New and existing unit tests pass locally with these changes?\n Has code been commented, particularly in hard-to-understand areas?\n Have you made corresponding changes to the documentation?", "createdAt": "2020-04-24T07:19:28Z", "url": "https://github.com/pytorch/serve/pull/265", "merged": true, "mergeCommit": {"oid": "ca9d97ace6e0610b9a43cc5d4428fddd65e1dd0d"}, "closed": true, "closedAt": "2020-05-22T20:37:55Z", "author": {"login": "harshbafna"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcasDuIAH2gAyNDA4Mzc1NjU2OjNjNGE0M2NkNWJjMDYyMWE1OGM2YzdiYTI4OGViYzI5YTc2NzJkMWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcj2wTgAFqTQxNzExNTU2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3c4a43cd5bc0621a58c6c7ba288ebc29a7672d1a", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/3c4a43cd5bc0621a58c6c7ba288ebc29a7672d1a", "committedDate": "2020-04-24T07:08:00Z", "message": "updated object detector handler to use default cuda device for torchvision version 0.5.0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMjkyMzU4", "url": "https://github.com/pytorch/serve/pull/265#pullrequestreview-400292358", "createdAt": "2020-04-24T21:52:16Z", "commit": {"oid": "3c4a43cd5bc0621a58c6c7ba288ebc29a7672d1a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTo1MjoxN1rOGLqh2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTo1MjoxN1rOGLqh2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4NDMxNA==", "bodyText": "My understanding is that this bug will also strike users on TorchVision 0.4. Could we change this condition to demand a version < 0.6?\nThoughts:\n\nWe don't want to do a string comparison, because that would fail if we get to version 0.10.0.\nI've done some digging, and PyTorch & TorchVision version strings are consistently three integers separated by periods. So if we were to split the version string on the periods, and treat the components like ints, that would look something like:\n\nif major_version <= 0 and minor_version < 6:\n    ...", "url": "https://github.com/pytorch/serve/pull/265#discussion_r414884314", "createdAt": "2020-04-24T21:52:17Z", "author": {"login": "fbbradheintz"}, "path": "ts/torch_handler/object_detector.py", "diffHunk": "@@ -17,11 +18,12 @@ def __init__(self):\n \n     def initialize(self, ctx):\n         super(VisionHandler, self).initialize(ctx)\n-        self.initialized = False\n-        self.device = torch.device(\"cuda:0\" if torch.cuda.is_available() else \"cpu\")\n-        self.model.to(self.device)\n-        self.model.eval()\n-        self.initialized = True\n+        if torchvision_version == \"0.5.0\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c4a43cd5bc0621a58c6c7ba288ebc29a7672d1a"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc84e4e614548eadf497260e01ea3ca27de5c73", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/4fc84e4e614548eadf497260e01ea3ca27de5c73", "committedDate": "2020-04-27T09:22:52Z", "message": "updated version check logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e07ca3a812bfd5969cb7cecaf729b9db959ddaf", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/1e07ca3a812bfd5969cb7cecaf729b9db959ddaf", "committedDate": "2020-05-01T05:49:38Z", "message": "Merge branch 'staging_0_1_1' into issue_104"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1dccf983786dbef39a2fbbe83b5afe8b55fd815", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/d1dccf983786dbef39a2fbbe83b5afe8b55fd815", "committedDate": "2020-05-02T13:15:29Z", "message": "Updated documentation for torchvision version dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00179a546014f89fc6efcdff05d3abed663fd89d", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/00179a546014f89fc6efcdff05d3abed663fd89d", "committedDate": "2020-05-02T13:17:45Z", "message": "enhanced sanity script to validate all default handlers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da19bc9e0ae3e663fa61954275da00524571fd6f", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/da19bc9e0ae3e663fa61954275da00524571fd6f", "committedDate": "2020-05-02T14:05:24Z", "message": "fixed sanity script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1371dcdffe4c11ff87d76dcab2eabde41cdcb33b", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/1371dcdffe4c11ff87d76dcab2eabde41cdcb33b", "committedDate": "2020-05-02T14:07:25Z", "message": "Merge branch 'staging_0_1_1' into issue_104"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85ae7ebb9baa97951db4721628e4dcf6e849abaf", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/85ae7ebb9baa97951db4721628e4dcf6e849abaf", "committedDate": "2020-05-02T16:27:18Z", "message": "added torchtext install step in sanity script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43870c505fa82c29ec18e33ec916e86b35e0b1df", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/43870c505fa82c29ec18e33ec916e86b35e0b1df", "committedDate": "2020-05-02T16:38:46Z", "message": "fixed issue related to inference after restart with snapshot."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2887399ff26625c9a611c1888d8c79b0c0f644a4", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/2887399ff26625c9a611c1888d8c79b0c0f644a4", "committedDate": "2020-05-04T17:35:10Z", "message": "moved torchtext to codebuild docker files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1625a6c29beaf97afd0151c740e6e8cd2d2d7c2d", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/1625a6c29beaf97afd0151c740e6e8cd2d2d7c2d", "committedDate": "2020-05-07T02:58:21Z", "message": "Merge branch 'staging_0_1_1' into issue_104"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1d816d46c696149cb0be727edfe61628c2a40a5", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/f1d816d46c696149cb0be727edfe61628c2a40a5", "committedDate": "2020-05-08T07:33:24Z", "message": "added more log statements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODAxNTI4", "url": "https://github.com/pytorch/serve/pull/265#pullrequestreview-413801528", "createdAt": "2020-05-18T17:33:32Z", "commit": {"oid": "f1d816d46c696149cb0be727edfe61628c2a40a5"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNzozMzozM1rOGXBD7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNzo0NDo0M1rOGXBawQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NzgyMg==", "bodyText": "curious, why is this change here?", "url": "https://github.com/pytorch/serve/pull/265#discussion_r426787822", "createdAt": "2020-05-18T17:33:33Z", "author": {"login": "mycpuorg"}, "path": "codebuild/Dockerfile.cpu", "diffHunk": "@@ -20,7 +20,7 @@\n   RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 1\n   RUN update-alternatives --install /usr/local/bin/pip pip /usr/local/bin/pip3 1\n   \n-  RUN pip install torch torchvision -f https://download.pytorch.org/whl/torch_stable.html\n+  RUN pip install torch torchvision torchtext -f https://download.pytorch.org/whl/torch_stable.html", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1d816d46c696149cb0be727edfe61628c2a40a5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4ODAzNg==", "bodyText": "Same comment. Docker file changes should not come with this.", "url": "https://github.com/pytorch/serve/pull/265#discussion_r426788036", "createdAt": "2020-05-18T17:33:57Z", "author": {"login": "mycpuorg"}, "path": "codebuild/Dockerfile.gpu", "diffHunk": "@@ -20,7 +20,7 @@\n   RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 1\n   RUN update-alternatives --install /usr/local/bin/pip pip /usr/local/bin/pip3 1\n   \n-  RUN pip install torch torchvision \n+  RUN pip install torch torchvision torchtext", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1d816d46c696149cb0be727edfe61628c2a40a5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5MzY2NQ==", "bodyText": "# models\nmodels=(\"fastrcnn\" \"vgg11\" \"resnet18\" \"waveglow\")\n\n# inputs - ensure length matches models\nmodel_inputs=(\"persons.jpg\" \"television.jpg\" \"kitten.jpg\" \"voice.wav\")\n\nfor i in ${!models[@]};\ndo\n  m=${models[$i]}\n  i=${model_inputs[$i]}\n  register_model \"$m\"\n  run_inference \"$m\" \"$i\"\n  unregister_model \"$m\"\ndone", "url": "https://github.com/pytorch/serve/pull/265#discussion_r426793665", "createdAt": "2020-05-18T17:44:43Z", "author": {"login": "mycpuorg"}, "path": "torchserve_sanity.sh", "diffHunk": "@@ -135,7 +154,43 @@ mkdir -p model_store\n \n start_torchserve\n \n-register_model\n+# run object detection example\n+\n+register_model \"fastrcnn\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1d816d46c696149cb0be727edfe61628c2a40a5"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8157973aac55dc69c444980a9915f65663998067", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/8157973aac55dc69c444980a9915f65663998067", "committedDate": "2020-05-19T03:48:51Z", "message": "merged staging branch and resolved conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfb38d8153034f525297de3bf06c95b56c4795ce", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/cfb38d8153034f525297de3bf06c95b56c4795ce", "committedDate": "2020-05-19T03:49:40Z", "message": "enhanced run inference function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47bc7241f3863d4066081b0813bd324efa2321bc", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/47bc7241f3863d4066081b0813bd324efa2321bc", "committedDate": "2020-05-19T03:57:40Z", "message": "Merge branch 'staging_0_1_1' into issue_104"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "005f395150d34546c07c9729d0d8bf27db26bc6a", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/005f395150d34546c07c9729d0d8bf27db26bc6a", "committedDate": "2020-05-19T04:00:09Z", "message": "fixed register model function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35405e9055548ea3d33179aa9f2314d9c7eea550", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/35405e9055548ea3d33179aa9f2314d9c7eea550", "committedDate": "2020-05-19T04:04:05Z", "message": "Merge branch 'issue_104' of https://github.com/pytorch/serve into issue_104"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a90bc413880d77a7a9298caf526f37e1b38c87b9", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/a90bc413880d77a7a9298caf526f37e1b38c87b9", "committedDate": "2020-05-19T04:26:43Z", "message": "added unregister model function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71c950a215188e97124e61a6915bc906d33566fc", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/71c950a215188e97124e61a6915bc906d33566fc", "committedDate": "2020-05-19T13:40:04Z", "message": "incorporated code review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db723c331e9ee6c7b0254a9e9041c348fda5d110", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/db723c331e9ee6c7b0254a9e9041c348fda5d110", "committedDate": "2020-05-20T05:27:53Z", "message": "Merge branch 'staging_0_1_1' into issue_104"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTM5ODU4", "url": "https://github.com/pytorch/serve/pull/265#pullrequestreview-416539858", "createdAt": "2020-05-21T22:39:09Z", "commit": {"oid": "db723c331e9ee6c7b0254a9e9041c348fda5d110"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMjozOTowOVrOGZFOIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMjozOTowOVrOGZFOIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk1MzEyMA==", "bodyText": "do you really want to remove this?\nWasn't this to verify snapshot resume? Noticed that you are not unregistering resnet for this specific reason, right?", "url": "https://github.com/pytorch/serve/pull/265#discussion_r428953120", "createdAt": "2020-05-21T22:39:09Z", "author": {"login": "mycpuorg"}, "path": "torchserve_sanity.sh", "diffHunk": "@@ -35,7 +53,7 @@ stop_torchserve\n \n start_torchserve\n \n-run_inference resnet-18 examples/image_classifier/kitten.jpg", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db723c331e9ee6c7b0254a9e9041c348fda5d110"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTQwNzA5", "url": "https://github.com/pytorch/serve/pull/265#pullrequestreview-416540709", "createdAt": "2020-05-21T22:41:16Z", "commit": {"oid": "db723c331e9ee6c7b0254a9e9041c348fda5d110"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb2bd2fd659fd4d5d639c169f48681b74840df01", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/fb2bd2fd659fd4d5d639c169f48681b74840df01", "committedDate": "2020-05-22T03:08:57Z", "message": "Merge branch 'staging_0_1_1' into issue_104"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c2e087f866995e655c62279b824689b0a11722d", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/5c2e087f866995e655c62279b824689b0a11722d", "committedDate": "2020-05-22T03:41:35Z", "message": "added back inference call for snapshot test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c945778e52916e3ed64aae1d9bdc49612466c407", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/c945778e52916e3ed64aae1d9bdc49612466c407", "committedDate": "2020-05-22T04:22:39Z", "message": "fixed if block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07247f7a855e5cd5757fc856261f2fbc31419c17", "author": {"user": {"login": "maaquib", "name": "Aaqib"}}, "url": "https://github.com/pytorch/serve/commit/07247f7a855e5cd5757fc856261f2fbc31419c17", "committedDate": "2020-05-22T18:38:30Z", "message": "Merge branch 'staging_0_1_1' into issue_104"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTE1NTYz", "url": "https://github.com/pytorch/serve/pull/265#pullrequestreview-417115563", "createdAt": "2020-05-22T18:41:04Z", "commit": {"oid": "07247f7a855e5cd5757fc856261f2fbc31419c17"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2338, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}