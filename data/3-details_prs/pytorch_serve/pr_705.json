{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MjA0NzE3", "number": 705, "title": "Treat application/x-www-form-urlencoded as binary data", "bodyText": "Description\nThe frontend currently decodes an application/x-www-form-urlencoded parameter as UTF-8 string, then re-encodes it immediately. This results in some binary data being mangled (e.g. b'\\x80' becomes b'\\xef\\xbf\\xbd').\nThe current line uses attribute.getValue(), which implicitly decodes the underlying bytes as a UTF-8 string. However InputParameter's constructor immediately re-encodes the String again.\nTo illustrate, here is some Java code which does the same thing:\nimport java.nio.ByteBuffer;\n\n// byte[4] { 65, -96, 0, 0 }\nbyte[] data = ByteBuffer.allocate(4).putFloat(20).array();\n\n// byte[6] { 65, -17, -65, -67, 0, 0 }\ndata = (new String(data)).getBytes();\nThe first commit is equivalent to removing the last line, which fixes the issue, and as a bonus removes an unnecessary computation.\nThe most recent commit fixes a similar issue (with a different cause) by bumping Netty to the latest stable version. Feel free to revert this if you'd prefer not to update it for whatever reason. But when you do bump the version, this workaround can be removed from the tests.\nThe second most recent commit adds some tests. I added a new model archive to facilitate this. It has a custom handler which just returns the contents of the data parameter. For convenience here is the code:\ndef handle(data, context):\n    if data:\n    \treturn [entry[\"data\"] for entry in data]\nThe first test is just a sanity check for the handler, it should pass without my fix. The second test does require the fix though. Since the testing code is quite verbose here is a rough python equivalent:\nimport requests\nimport struct\n\n# b'\\x00\\x01\\x02...'\ndata = struct.pack('256B', *range(256))\n\ndef testPredictionsEchoMultipart():\n    response = requests.post(\"http://localhost:8080/predictions/echo\", files={\"data\": data})\n    assert response.ok\n    assert response.content == data\n\ndef testPredictionsEchoNoMultipart():\n    response = requests.post(\"http://localhost:8080/predictions/echo\", data={\"data\": data})\n    assert response.ok\n    assert response.content == data\nFixes #(issue) - Not an existing issue\nType of change\n\n Bug fix (non-breaking change which fixes an issue)\n\nFeature/Issue validation/testing\nI ran torchserve_sanity.sh and also tested that the issue was fixed for my own models (by replacing requests.post(..., files=...) by requests.post(..., data=...)).", "createdAt": "2020-09-30T01:53:48Z", "url": "https://github.com/pytorch/serve/pull/705", "merged": true, "mergeCommit": {"oid": "fa8d9016d2bbd6bb7359f69ed42ef2fdbf9566ab"}, "closed": true, "closedAt": "2020-10-29T18:41:04Z", "author": {"login": "jonathan-conder-sm"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNwatWAH2gAyNDk1MjA0NzE3OjAyNzY1OTI3NmJjYWJjYzY2YThkMWJkYmY5ZTc5MzQwMDQzZDViNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXWAtngH2gAyNDk1MjA0NzE3OjM3NjY3NzAzNDQ2MTkxYWViNDgyZmM0NmVhYTY5NGIzNTAxOGIzMWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "027659276bcabcc66a8d1bdbf9e79340043d5b42", "author": {"user": {"login": "jonathan-conder-sm", "name": null}}, "url": "https://github.com/pytorch/serve/commit/027659276bcabcc66a8d1bdbf9e79340043d5b42", "committedDate": "2020-09-29T23:02:52Z", "message": "Treat application/x-www-form-urlencoded as binary data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9933d81c76f6eb0331910f5dd9369db80c7a5f4a", "author": {"user": {"login": "maaquib", "name": "Aaqib"}}, "url": "https://github.com/pytorch/serve/commit/9933d81c76f6eb0331910f5dd9369db80c7a5f4a", "committedDate": "2020-10-06T23:33:34Z", "message": "Merge branch 'master' into urlencoded_bytes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNDIzNDc1", "url": "https://github.com/pytorch/serve/pull/705#pullrequestreview-511423475", "createdAt": "2020-10-19T05:38:02Z", "commit": {"oid": "9933d81c76f6eb0331910f5dd9369db80c7a5f4a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNTozODowMlrOHj-CwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNTozODowMlrOHj-CwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ3ODcyMA==", "bodyText": "@jonathan-conder-sm: Please add a test case in ModelServerTest.java and also provide a detailed example in the PR comment about how this fix works.", "url": "https://github.com/pytorch/serve/pull/705#discussion_r507478720", "createdAt": "2020-10-19T05:38:02Z", "author": {"login": "harshbafna"}, "path": "frontend/server/src/main/java/org/pytorch/serve/util/NettyUtils.java", "diffHunk": "@@ -240,7 +240,7 @@ public static InputParameter getFormData(InterfaceHttpData data) {\n             case Attribute:\n                 Attribute attribute = (Attribute) data;\n                 try {\n-                    return new InputParameter(name, attribute.getValue());\n+                    return new InputParameter(name, getBytes(attribute.getByteBuf()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9933d81c76f6eb0331910f5dd9369db80c7a5f4a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3529e69facd742d4fea5b7540b5921f76f9c455", "author": {"user": {"login": "maaquib", "name": "Aaqib"}}, "url": "https://github.com/pytorch/serve/commit/a3529e69facd742d4fea5b7540b5921f76f9c455", "committedDate": "2020-10-19T21:27:20Z", "message": "Merge branch 'master' into urlencoded_bytes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c84d3309159844b1c071136a03b9bef257a7bf2e", "author": {"user": {"login": "jonathan-conder-sm", "name": null}}, "url": "https://github.com/pytorch/serve/commit/c84d3309159844b1c071136a03b9bef257a7bf2e", "committedDate": "2020-10-22T02:43:59Z", "message": "Test whether form data (multipart and urlencoded) is decoded correctly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6de42bfd05d1181400a1ac714388bb3f4a3eec0", "author": {"user": {"login": "jonathan-conder-sm", "name": null}}, "url": "https://github.com/pytorch/serve/commit/f6de42bfd05d1181400a1ac714388bb3f4a3eec0", "committedDate": "2020-10-22T03:00:48Z", "message": "Bump netty version to fix URL decoding issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08e1cd2de64d9a1becec03f828a1838d2742cc52", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/08e1cd2de64d9a1becec03f828a1838d2742cc52", "committedDate": "2020-10-28T04:42:32Z", "message": "Merge branch 'master' into urlencoded_bytes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MzIwMDc2", "url": "https://github.com/pytorch/serve/pull/705#pullrequestreview-518320076", "createdAt": "2020-10-28T04:43:47Z", "commit": {"oid": "08e1cd2de64d9a1becec03f828a1838d2742cc52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5OTExODE5", "url": "https://github.com/pytorch/serve/pull/705#pullrequestreview-519911819", "createdAt": "2020-10-29T17:31:26Z", "commit": {"oid": "08e1cd2de64d9a1becec03f828a1838d2742cc52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37667703446191aeb482fc46eaa694b35018b31e", "author": {"user": {"login": "lxning", "name": null}}, "url": "https://github.com/pytorch/serve/commit/37667703446191aeb482fc46eaa694b35018b31e", "committedDate": "2020-10-29T17:56:11Z", "message": "Merge branch 'master' into urlencoded_bytes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2093, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}