{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyOTA4NTkx", "number": 646, "title": "Add support for file:// url for copying .mar files into model store", "bodyText": "Description\nCurrent version of torchserve only supports http/https urls. Adding support for file:// in url for copying .mar files into model store locally\nFixes #(issue)\nType of change\nPlease delete options that are not relevant.\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Breaking change (fix or feature that would cause existing functionality to not work as expected)\n This change requires a documentation update\n\nFeature/Issue validation/testing\nPlease describe the tests [UT/IT] that you ran to verify your changes and relevent result summary. Provide instructions so it can be reproduced.\nPlease also list any relevant details for your test configuration.\n\n\n Test A\n\n\n Test B\n\n\nUT/IT execution results\n\n\nLogs\n\n\nChecklist:\n\n Have you added tests that prove your fix is effective or that this feature works?\n New and existing unit tests pass locally with these changes?\n Has code been commented, particularly in hard-to-understand areas?\n Have you made corresponding changes to the documentation?", "createdAt": "2020-08-25T03:13:19Z", "url": "https://github.com/pytorch/serve/pull/646", "merged": true, "mergeCommit": {"oid": "f75e54e2f59e6146987343feff2e3d6ee282757f"}, "closed": true, "closedAt": "2020-09-11T17:24:17Z", "author": {"login": "shrinath-suresh"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBJbz-gH2gAyNDcyOTA4NTkxOjFmZWJjNWJiZjEyMWMzYWZhN2ZiNTA3MTZkNTU5YTUxMzljNjI3ZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH1QOqAH2gAyNDcyOTA4NTkxOjI5OGQ0OTllODhjZDQ0NzI4ZDIzYzM5MTRmMTcwZDRlMzY5NzdiMTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1febc5bbf121c3afa7fb50716d559a5139c627f4", "author": {"user": {"login": "shrinath-suresh", "name": null}}, "url": "https://github.com/pytorch/serve/commit/1febc5bbf121c3afa7fb50716d559a5139c627f4", "committedDate": "2020-08-21T18:50:41Z", "message": "Add support for file:// url for copying .mar files into model store"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70077597fe003a5c38f96cb4383f00da9a1b7d31", "author": {"user": {"login": "shrinath-suresh", "name": null}}, "url": "https://github.com/pytorch/serve/commit/70077597fe003a5c38f96cb4383f00da9a1b7d31", "committedDate": "2020-08-24T08:43:19Z", "message": "Fixing Spacing and Style issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d07c19d7e4fca28ce3f12da03afb91f5e993ccf", "author": {"user": {"login": "shrinath-suresh", "name": null}}, "url": "https://github.com/pytorch/serve/commit/1d07c19d7e4fca28ce3f12da03afb91f5e993ccf", "committedDate": "2020-08-25T11:03:46Z", "message": "Adding UT for local model file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d1016d47987acd8db1e27cb0967a70bb3882c5", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/98d1016d47987acd8db1e27cb0967a70bb3882c5", "committedDate": "2020-08-27T12:30:56Z", "message": "Merge branch 'master' into issue_643"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2OTk0MTAw", "url": "https://github.com/pytorch/serve/pull/646#pullrequestreview-476994100", "createdAt": "2020-08-27T18:52:59Z", "commit": {"oid": "98d1016d47987acd8db1e27cb0967a70bb3882c5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3Mjc3Nzcz", "url": "https://github.com/pytorch/serve/pull/646#pullrequestreview-477277773", "createdAt": "2020-08-28T06:37:57Z", "commit": {"oid": "98d1016d47987acd8db1e27cb0967a70bb3882c5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNjozNzo1N1rOHIrXcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNjozNzo1N1rOHIrXcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg2MTE3MQ==", "bodyText": "This test case only tests the \"mar file already exists\" scenario. Please add test cases for the following use cases:\n\nValid local mar file URL, validate that the mar file correctly gets copied to the model-store.\nURL path does not exist", "url": "https://github.com/pytorch/serve/pull/646#discussion_r478861171", "createdAt": "2020-08-28T06:37:57Z", "author": {"login": "harshbafna"}, "path": "frontend/modelarchive/src/test/java/org/pytorch/serve/archive/ModelArchiveTest.java", "diffHunk": "@@ -91,4 +91,10 @@ public void testMalformURL() throws ModelException, IOException, InterruptedExce\n         ModelArchive.downloadModel(\n                 modelStore, \"https://../model-server/models/squeezenet_v1.1/squeezenet_v1.1.mod\");\n     }\n+\n+    @Test(expectedExceptions = DownloadModelException.class)\n+    public void testMalformLocalURL() throws ModelException, IOException, InterruptedException {\n+        String modelStore = \"src/test/resources/models\";\n+        ModelArchive.downloadModel(modelStore, \"file://\" + modelStore + \"/mnist1.mar\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98d1016d47987acd8db1e27cb0967a70bb3882c5"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "116dd3539f12a9a31a72fcd38e05e4763ab3a73e", "author": {"user": {"login": "shrinath-suresh", "name": null}}, "url": "https://github.com/pytorch/serve/commit/116dd3539f12a9a31a72fcd38e05e4763ab3a73e", "committedDate": "2020-08-31T09:39:17Z", "message": "Adding test to check if mar file is getting copied locally when file:// is used"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea7c6bda242099afdb7739393ecf1c31ff235998", "author": {"user": {"login": "shrinath-suresh", "name": null}}, "url": "https://github.com/pytorch/serve/commit/ea7c6bda242099afdb7739393ecf1c31ff235998", "committedDate": "2020-08-31T10:26:03Z", "message": "Adding test cases for local mar file register and un-registration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15c11a021bd730819d38f97191c4596094769fec", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/15c11a021bd730819d38f97191c4596094769fec", "committedDate": "2020-09-04T04:44:30Z", "message": "Merge branch 'master' into issue_643"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzU1MDg5", "url": "https://github.com/pytorch/serve/pull/646#pullrequestreview-482355089", "createdAt": "2020-09-04T04:47:51Z", "commit": {"oid": "15c11a021bd730819d38f97191c4596094769fec"}, "state": "DISMISSED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNDo0Nzo1MVrOHM_aLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNDo1NDoyN1rOHM_grw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM4Mzg1Mg==", "bodyText": "Make the test cases sequential.", "url": "https://github.com/pytorch/serve/pull/646#discussion_r483383852", "createdAt": "2020-09-04T04:47:51Z", "author": {"login": "harshbafna"}, "path": "frontend/server/src/test/java/org/pytorch/serve/ModelServerTest.java", "diffHunk": "@@ -710,6 +710,38 @@ public void testLoadModelFromURL() throws InterruptedException {\n         Assert.assertTrue(new File(configManager.getModelStore(), \"squeezenet1_1.mar\").exists());\n     }\n \n+    @Test(\n+            alwaysRun = true,\n+            dependsOnMethods = {\"testModelRegisterWithDefaultWorkers\"})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15c11a021bd730819d38f97191c4596094769fec"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM4NTA4MQ==", "bodyText": "Ideally, we should never encounter this exception. If we do, that means something went wrong. It would be better to add the exception with throws.", "url": "https://github.com/pytorch/serve/pull/646#discussion_r483385081", "createdAt": "2020-09-04T04:52:47Z", "author": {"login": "harshbafna"}, "path": "frontend/server/src/test/java/org/pytorch/serve/ModelServerTest.java", "diffHunk": "@@ -710,6 +710,38 @@ public void testLoadModelFromURL() throws InterruptedException {\n         Assert.assertTrue(new File(configManager.getModelStore(), \"squeezenet1_1.mar\").exists());\n     }\n \n+    @Test(\n+            alwaysRun = true,\n+            dependsOnMethods = {\"testModelRegisterWithDefaultWorkers\"})\n+    public void testLoadModelFromFileURI() throws InterruptedException {\n+        String curDir = System.getProperty(\"user.dir\");\n+        File curDirFile = new File(curDir);\n+        String parent = curDirFile.getParent();\n+\n+        String source = configManager.getModelStore() + \"/mnist.mar\";\n+        String destination = parent + \"/modelarchive/mnist1.mar\";\n+        File sourceFile = new File(source);\n+        File destinationFile = new File(destination);\n+        String fileUrl = \"\";\n+        try {\n+            FileUtils.copyFile(sourceFile, destinationFile);\n+            fileUrl = \"file://\" + parent + \"/modelarchive/mnist1.mar\";\n+        } catch (Exception e) {\n+            Assert.assertEquals(e.getClass(), IOException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15c11a021bd730819d38f97191c4596094769fec"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM4NTIzMQ==", "bodyText": "clean up the fileUrl as well.", "url": "https://github.com/pytorch/serve/pull/646#discussion_r483385231", "createdAt": "2020-09-04T04:53:26Z", "author": {"login": "harshbafna"}, "path": "frontend/server/src/test/java/org/pytorch/serve/ModelServerTest.java", "diffHunk": "@@ -710,6 +710,38 @@ public void testLoadModelFromURL() throws InterruptedException {\n         Assert.assertTrue(new File(configManager.getModelStore(), \"squeezenet1_1.mar\").exists());\n     }\n \n+    @Test(\n+            alwaysRun = true,\n+            dependsOnMethods = {\"testModelRegisterWithDefaultWorkers\"})\n+    public void testLoadModelFromFileURI() throws InterruptedException {\n+        String curDir = System.getProperty(\"user.dir\");\n+        File curDirFile = new File(curDir);\n+        String parent = curDirFile.getParent();\n+\n+        String source = configManager.getModelStore() + \"/mnist.mar\";\n+        String destination = parent + \"/modelarchive/mnist1.mar\";\n+        File sourceFile = new File(source);\n+        File destinationFile = new File(destination);\n+        String fileUrl = \"\";\n+        try {\n+            FileUtils.copyFile(sourceFile, destinationFile);\n+            fileUrl = \"file://\" + parent + \"/modelarchive/mnist1.mar\";\n+        } catch (Exception e) {\n+            Assert.assertEquals(e.getClass(), IOException.class);\n+        }\n+        testLoadModel(fileUrl, \"mnist1\", \"1.0\");\n+        Assert.assertTrue(new File(configManager.getModelStore(), \"mnist1.mar\").exists());\n+        FileUtils.deleteQuietly(destinationFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15c11a021bd730819d38f97191c4596094769fec"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzM4NTUxOQ==", "bodyText": "make this test case dependent on testLoadModelFromFileURI.", "url": "https://github.com/pytorch/serve/pull/646#discussion_r483385519", "createdAt": "2020-09-04T04:54:27Z", "author": {"login": "harshbafna"}, "path": "frontend/server/src/test/java/org/pytorch/serve/ModelServerTest.java", "diffHunk": "@@ -710,6 +710,38 @@ public void testLoadModelFromURL() throws InterruptedException {\n         Assert.assertTrue(new File(configManager.getModelStore(), \"squeezenet1_1.mar\").exists());\n     }\n \n+    @Test(\n+            alwaysRun = true,\n+            dependsOnMethods = {\"testModelRegisterWithDefaultWorkers\"})\n+    public void testLoadModelFromFileURI() throws InterruptedException {\n+        String curDir = System.getProperty(\"user.dir\");\n+        File curDirFile = new File(curDir);\n+        String parent = curDirFile.getParent();\n+\n+        String source = configManager.getModelStore() + \"/mnist.mar\";\n+        String destination = parent + \"/modelarchive/mnist1.mar\";\n+        File sourceFile = new File(source);\n+        File destinationFile = new File(destination);\n+        String fileUrl = \"\";\n+        try {\n+            FileUtils.copyFile(sourceFile, destinationFile);\n+            fileUrl = \"file://\" + parent + \"/modelarchive/mnist1.mar\";\n+        } catch (Exception e) {\n+            Assert.assertEquals(e.getClass(), IOException.class);\n+        }\n+        testLoadModel(fileUrl, \"mnist1\", \"1.0\");\n+        Assert.assertTrue(new File(configManager.getModelStore(), \"mnist1.mar\").exists());\n+        FileUtils.deleteQuietly(destinationFile);\n+    }\n+\n+    @Test(\n+            alwaysRun = true,\n+            dependsOnMethods = {\"testModelWithInvalidCustomPythonDependency\"})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15c11a021bd730819d38f97191c4596094769fec"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c38aa10e478966cde1bf2fb1b7b4b8a449ddf94d", "author": {"user": {"login": "shrinath-suresh", "name": null}}, "url": "https://github.com/pytorch/serve/commit/c38aa10e478966cde1bf2fb1b7b4b8a449ddf94d", "committedDate": "2020-09-07T08:25:06Z", "message": "Addressing review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0cb4e764456d654cc0fac34b050d67c611d5ab1", "author": {"user": {"login": "shrinath-suresh", "name": null}}, "url": "https://github.com/pytorch/serve/commit/f0cb4e764456d654cc0fac34b050d67c611d5ab1", "committedDate": "2020-09-07T10:19:36Z", "message": "Adding invalid url test - ModelServerTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNzg1OTI2", "url": "https://github.com/pytorch/serve/pull/646#pullrequestreview-483785926", "createdAt": "2020-09-08T04:23:59Z", "commit": {"oid": "f0cb4e764456d654cc0fac34b050d67c611d5ab1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1Mjk4Mjgx", "url": "https://github.com/pytorch/serve/pull/646#pullrequestreview-485298281", "createdAt": "2020-09-09T18:42:59Z", "commit": {"oid": "f0cb4e764456d654cc0fac34b050d67c611d5ab1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxODo0Mjo1OVrOHPVCzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxODo0Mjo1OVrOHPVCzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgzNTQ2OA==", "bodyText": "NIT: Can't we just use file:///<path> as the url and remove the if-else here?", "url": "https://github.com/pytorch/serve/pull/646#discussion_r485835468", "createdAt": "2020-09-09T18:42:59Z", "author": {"login": "maaquib"}, "path": "frontend/modelarchive/src/main/java/org/pytorch/serve/archive/ModelArchive.java", "diffHunk": "@@ -59,7 +59,14 @@ public static ModelArchive downloadModel(String modelStore, String url)\n                 throw new FileAlreadyExistsException(marFileName);\n             }\n             try {\n-                FileUtils.copyURLToFile(new URL(url), modelLocation);\n+                if (url.indexOf(\"file://\") != -1) {\n+                    String originalPath = url.replace(\"file://\", \"\");\n+                    String path = FilenameUtils.getFullPath(originalPath);\n+                    File source = new File(path, marFileName);\n+                    FileUtils.copyFile(source, modelLocation);\n+                } else {\n+                    FileUtils.copyURLToFile(new URL(url), modelLocation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0cb4e764456d654cc0fac34b050d67c611d5ab1"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4e401e2e8cedf742432ed4726e3fa403fb86ddf", "author": {"user": {"login": "maaquib", "name": "Aaqib"}}, "url": "https://github.com/pytorch/serve/commit/b4e401e2e8cedf742432ed4726e3fa403fb86ddf", "committedDate": "2020-09-09T18:50:48Z", "message": "Merge branch 'master' into issue_643"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "812d902d1aa16b2d4bc3a413078a56ff74ea88c6", "author": {"user": {"login": "shrinath-suresh", "name": null}}, "url": "https://github.com/pytorch/serve/commit/812d902d1aa16b2d4bc3a413078a56ff74ea88c6", "committedDate": "2020-09-11T13:17:01Z", "message": "Using FileUtils.copyURLToFile for file:// url as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "298d499e88cd44728d23c3914f170d4e36977b10", "author": {"user": {"login": "shrinath-suresh", "name": null}}, "url": "https://github.com/pytorch/serve/commit/298d499e88cd44728d23c3914f170d4e36977b10", "committedDate": "2020-09-11T13:17:24Z", "message": "Merge branch 'issue_643' of github.com:shrinath-suresh/serve into issue_643"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2048, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}