{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMzU0MDQ3", "number": 172, "title": "Updated exception handling for worker threads shutdown.", "bodyText": "Description\nFixes #155 , #82\nThe worker threads are stopped in case of model unregister or workers are scaled down. In this case log trace for \"InterruptedException\" or \"IllegalMonitorStateException\" were observed. These were logged as part of DEBUG logs.\n\nAdded fix to handle IllegalMonitorException.\nUpdated exception handling for worker scale down / shutdown/\n\nType of change\nPlease delete options that are not relevant.\n\n New feature (non-breaking change which adds functionality)\n\nFeature/Issue validation/testing\n\n\nstart torchserve\n\n\nregister resnet-18 model\n\n\nscale up resnet-18 model.\n\n\nstop torchserve\n\n\nObserve that no exception trace is observed and torchserve stops gracefully.\n\n\nUT/IT execution results\nfrontend_build_log_issue_155.txt\n\n\nChecklist:\n\n New and existing unit tests pass locally with these changes?", "createdAt": "2020-04-09T10:53:50Z", "url": "https://github.com/pytorch/serve/pull/172", "merged": true, "mergeCommit": {"oid": "286a284ad1345edb6cdec78ced38476425e68fd8"}, "closed": true, "closedAt": "2020-05-02T01:21:35Z", "author": {"login": "harshbafna"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV5hgsgH2gAyNDAxMzU0MDQ3OjQwN2UyZDgxZjg5MjQzNGUxMTM1OTI3NzAwMWE5MmE5NGE3MmFkNWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcf4FN5gFqTQwODcyODI2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "407e2d81f892434e11359277001a92a94a72ad5e", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/407e2d81f892434e11359277001a92a94a72ad5e", "committedDate": "2020-04-09T09:59:41Z", "message": "updated code to now log errors only in case when exception is not genreated by unregister api call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "708929833d70bd78f7a3c8b7174b067320528bf1", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/708929833d70bd78f7a3c8b7174b067320528bf1", "committedDate": "2020-04-09T11:03:06Z", "message": "java formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fd2241998a19eea2a3d9b0dd7ecf2c0ae3c6f58", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/7fd2241998a19eea2a3d9b0dd7ecf2c0ae3c6f58", "committedDate": "2020-04-24T08:37:11Z", "message": "Merge branch 'master' into issue_155"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzAwMTE3", "url": "https://github.com/pytorch/serve/pull/172#pullrequestreview-400300117", "createdAt": "2020-04-24T22:12:52Z", "commit": {"oid": "7fd2241998a19eea2a3d9b0dd7ecf2c0ae3c6f58"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fc6be017c4050504d93b11a8470233c5e710b1b", "author": {"user": {"login": "dhaniram-kshirsagar", "name": null}}, "url": "https://github.com/pytorch/serve/commit/2fc6be017c4050504d93b11a8470233c5e710b1b", "committedDate": "2020-04-28T07:41:47Z", "message": "fixed illigalstateexception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNjk5NDk2", "url": "https://github.com/pytorch/serve/pull/172#pullrequestreview-403699496", "createdAt": "2020-04-30T16:47:58Z", "commit": {"oid": "2fc6be017c4050504d93b11a8470233c5e710b1b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNzU4MTE0", "url": "https://github.com/pytorch/serve/pull/172#pullrequestreview-403758114", "createdAt": "2020-04-30T18:06:33Z", "commit": {"oid": "2fc6be017c4050504d93b11a8470233c5e710b1b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzODE0MjIz", "url": "https://github.com/pytorch/serve/pull/172#pullrequestreview-403814223", "createdAt": "2020-04-30T19:27:32Z", "commit": {"oid": "2fc6be017c4050504d93b11a8470233c5e710b1b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxOToyNzozMlrOGO3Row==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxOTozNTozNVrOGO3hIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIzODg4Mw==", "bodyText": "nice", "url": "https://github.com/pytorch/serve/pull/172#discussion_r418238883", "createdAt": "2020-04-30T19:27:32Z", "author": {"login": "mycpuorg"}, "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/Model.java", "diffHunk": "@@ -172,7 +172,9 @@ public void pollBatch(String threadId, long waitTime, Map<String, Job> jobsRepo)\n             }\n             logger.trace(\"sending jobs, size: {}\", jobsRepo.size());\n         } finally {\n-            lock.unlock();\n+            if (lock.isHeldByCurrentThread()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc6be017c4050504d93b11a8470233c5e710b1b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0Mjg1MQ==", "bodyText": "you mentioned this in the commit text but can you explain a bit more? I just want to make sure there are no race conditions hidden here", "url": "https://github.com/pytorch/serve/pull/172#discussion_r418242851", "createdAt": "2020-04-30T19:35:35Z", "author": {"login": "mycpuorg"}, "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/WorkerThread.java", "diffHunk": "@@ -174,7 +175,11 @@ public void run() {\n             logger.error(\"Out of memory error when creating workers\", oom);\n             status = HttpResponseStatus.INSUFFICIENT_STORAGE;\n         } catch (Throwable t) {\n-            logger.warn(\"Backend worker thread exception.\", t);\n+            if (state == WorkerState.WORKER_SCALED_DOWN || state == WorkerState.WORKER_STOPPED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc6be017c4050504d93b11a8470233c5e710b1b"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzODIwNzQ4", "url": "https://github.com/pytorch/serve/pull/172#pullrequestreview-403820748", "createdAt": "2020-04-30T19:37:34Z", "commit": {"oid": "2fc6be017c4050504d93b11a8470233c5e710b1b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfa804dec91c95771bc3dd9e1b0f7f9bf7df1a4a", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/cfa804dec91c95771bc3dd9e1b0f7f9bf7df1a4a", "committedDate": "2020-05-01T05:29:47Z", "message": "Merge branch 'staging_0_1_1' into issue_155"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1416573984874315f3ff243c66768e02c4bfc994", "author": {"user": {"login": "harshbafna", "name": "Harsh Bafna"}}, "url": "https://github.com/pytorch/serve/commit/1416573984874315f3ff243c66768e02c4bfc994", "committedDate": "2020-05-01T15:30:41Z", "message": "removed the unrequired handling for illegal monitor state exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NDEyMTEx", "url": "https://github.com/pytorch/serve/pull/172#pullrequestreview-404412111", "createdAt": "2020-05-01T21:33:30Z", "commit": {"oid": "1416573984874315f3ff243c66768e02c4bfc994"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0ebc868cfb6ae644a3a717a5c45ee3d41247599", "author": {"user": {"login": "maaquib", "name": "Aaqib"}}, "url": "https://github.com/pytorch/serve/commit/f0ebc868cfb6ae644a3a717a5c45ee3d41247599", "committedDate": "2020-05-02T00:47:22Z", "message": "Merge branch 'staging_0_1_1' into issue_155"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef8793e2463b0d71a9d636bca16a776edd87fdf1", "author": {"user": {"login": "maaquib", "name": "Aaqib"}}, "url": "https://github.com/pytorch/serve/commit/ef8793e2463b0d71a9d636bca16a776edd87fdf1", "committedDate": "2020-05-02T01:08:05Z", "message": "Merge branch 'staging_0_1_1' into issue_155"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzI4MjYw", "url": "https://github.com/pytorch/serve/pull/172#pullrequestreview-408728260", "createdAt": "2020-05-10T09:57:52Z", "commit": {"oid": "ef8793e2463b0d71a9d636bca16a776edd87fdf1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwOTo1Nzo1MlrOGTCtUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwOTo1Nzo1MlrOGTCtUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYyMDQ5OA==", "bodyText": "@maaquib Have you verified that removing the code for terminating child processes does not have any other side effects?", "url": "https://github.com/pytorch/serve/pull/172#discussion_r422620498", "createdAt": "2020-05-10T09:57:52Z", "author": {"login": "chauhang"}, "path": "ts/model_server.py", "diffHunk": "@@ -36,8 +36,6 @@ def start():\n         else:\n             try:\n                 parent = psutil.Process(pid)\n-                for child in parent.children(recursive=True):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef8793e2463b0d71a9d636bca16a776edd87fdf1"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2475, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}