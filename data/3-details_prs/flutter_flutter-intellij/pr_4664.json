{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNzg0NzA4", "number": 4664, "title": "Add JxBrowser dependencies and show in panel", "bodyText": "This change allows the plugin to download jxbrowser files and load them onto the class path dynamically. If installed correctly, running a project will open the devtools inspector page in the 'Fluter Inspector' tab:\n\nThis change is gated so nothing related to JxBrowser will run unless we change ENABLE_JXBROWSER to true in JxBrowserManager in development. Gating can be opened once all of the pieces are merged.", "createdAt": "2020-06-26T20:59:53Z", "url": "https://github.com/flutter/flutter-intellij/pull/4664", "merged": true, "mergeCommit": {"oid": "54c4e405ea8f2524cb459c75ccf4a8a43c52a4e4"}, "closed": true, "closedAt": "2020-07-21T18:20:28Z", "author": {"login": "helin24"}, "timelineItems": {"totalCount": 76, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvK_UWAFqTQzODYyNjY2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3KGVOgFqTQ1MjcwMDAzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjI2NjYw", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-438626660", "createdAt": "2020-06-26T22:21:49Z", "commit": {"oid": "b4546cb938f0ebaa85e41408f7208cd08bb94fc2"}, "state": "DISMISSED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMjoyMTo1MFrOGpwP2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMjoyNjo0NFrOGpwVQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNTI4OA==", "bodyText": "Delete this class.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r446435288", "createdAt": "2020-06-26T22:21:50Z", "author": {"login": "stevemessick"}, "path": "src/io/flutter/actions/TestJxBrowserAction.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package io.flutter.actions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4546cb938f0ebaa85e41408f7208cd08bb94fc2"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNTYyNQ==", "bodyText": "Get this key from an environment variable. And document it :)", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r446435625", "createdAt": "2020-06-26T22:23:08Z", "author": {"login": "stevemessick"}, "path": "src/io/flutter/view/FlutterView.java", "diffHunk": "@@ -182,11 +177,11 @@ private PerAppState getOrCreateStateForApp(FlutterApp app) {\n   }\n \n   private void addInspectorViewContent(FlutterApp app, @Nullable InspectorService inspectorService, ToolWindow toolWindow) {\n+    String browserUrl = app.getConnector().getBrowserUrl();\n+\n+    System.setProperty(\"jxbrowser.license.key\", \"6P830J66YAO1XQRI1FNEXP8ZTHUOQTY2YUJRCN9RTARQ58QFAP63GRRH20B3P5PB7PC8\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4546cb938f0ebaa85e41408f7208cd08bb94fc2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNjU5NQ==", "bodyText": "Delete this.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r446436595", "createdAt": "2020-06-26T22:26:27Z", "author": {"login": "stevemessick"}, "path": "resources/META-INF/plugin.xml", "diffHunk": "@@ -1075,6 +1075,9 @@\n       <action id=\"flutter.submitFeedback\" class=\"io.flutter.actions.FlutterSubmitFeedback\"\n               text=\"Submit Feedback...\"\n               description=\"Provide feedback for the Flutter plugin\"/>\n+      <action id=\"flutter.testJxBrowser\" class=\"io.flutter.actions.TestJxBrowserAction\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4546cb938f0ebaa85e41408f7208cd08bb94fc2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNjY3NQ==", "bodyText": "Delete this.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r446436675", "createdAt": "2020-06-26T22:26:44Z", "author": {"login": "stevemessick"}, "path": "resources/META-INF/plugin_template.xml", "diffHunk": "@@ -101,6 +101,9 @@\n       <action id=\"flutter.submitFeedback\" class=\"io.flutter.actions.FlutterSubmitFeedback\"\n               text=\"Submit Feedback...\"\n               description=\"Provide feedback for the Flutter plugin\"/>\n+      <action id=\"flutter.testJxBrowser\" class=\"io.flutter.actions.TestJxBrowserAction\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4546cb938f0ebaa85e41408f7208cd08bb94fc2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjUxMzcy", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-438651372", "createdAt": "2020-06-27T00:07:19Z", "commit": {"oid": "08bc36fe38b69df2f14086a422b0c38468b4f890"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwMDowNzoxOVrOGpxlzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwMDowNzoxOVrOGpxlzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ1NzI5Mw==", "bodyText": "This should be rolled back. I'm pretty sure we settled on enumerating all imports.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r446457293", "createdAt": "2020-06-27T00:07:19Z", "author": {"login": "stevemessick"}, "path": "src/io/flutter/run/FlutterDebugProcess.java", "diffHunk": "@@ -17,10 +17,7 @@\n import com.intellij.xdebugger.XDebugSession;\n import com.jetbrains.lang.dart.util.DartUrlResolver;\n import io.flutter.FlutterUtils;\n-import io.flutter.actions.ReloadAllFlutterApps;\n-import io.flutter.actions.ReloadFlutterApp;\n-import io.flutter.actions.RestartAllFlutterApps;\n-import io.flutter.actions.RestartFlutterApp;\n+import io.flutter.actions.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08bc36fe38b69df2f14086a422b0c38468b4f890"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDAwNTY2", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-440400566", "createdAt": "2020-06-30T21:30:37Z", "commit": {"oid": "08bc36fe38b69df2f14086a422b0c38468b4f890"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ae17912e82e76e2e263625e3ace8dc49deeab9b", "author": {"user": {"login": "stevemessick", "name": null}}, "url": "https://github.com/flutter/flutter-intellij/commit/5ae17912e82e76e2e263625e3ace8dc49deeab9b", "committedDate": "2020-07-01T22:28:12Z", "message": "Add JxBrowser dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d35905b7834b0ac80b958f5186a9c13b2d812511", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/d35905b7834b0ac80b958f5186a9c13b2d812511", "committedDate": "2020-07-01T22:28:19Z", "message": "Add JxBrowser dependencies and show in panel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc5ef996e1e623435857ee5eb9d2c38c0492d8bf", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/cc5ef996e1e623435857ee5eb9d2c38c0492d8bf", "committedDate": "2020-07-01T22:37:45Z", "message": "Remove test action"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08bc36fe38b69df2f14086a422b0c38468b4f890", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/08bc36fe38b69df2f14086a422b0c38468b4f890", "committedDate": "2020-06-26T23:07:13Z", "message": "Add jxbrowser API files"}, "afterCommit": {"oid": "cc5ef996e1e623435857ee5eb9d2c38c0492d8bf", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/cc5ef996e1e623435857ee5eb9d2c38c0492d8bf", "committedDate": "2020-07-01T22:37:45Z", "message": "Remove test action"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e57d95444ee7af15c8b54712a8902e52e85cf623", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/e57d95444ee7af15c8b54712a8902e52e85cf623", "committedDate": "2020-07-01T22:57:01Z", "message": "Fix imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbf49a15c4aee3dedf3e52b0fe7fa27336f4b375", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/dbf49a15c4aee3dedf3e52b0fe7fa27336f4b375", "committedDate": "2020-07-02T01:43:34Z", "message": "Revert configuration changes after gradle commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7660293f4ccb8cd90f308419739653f343190d6", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/c7660293f4ccb8cd90f308419739653f343190d6", "committedDate": "2020-07-06T17:52:55Z", "message": "Add jxbrowser api files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f39ab4fdd413fb2eed06625bba5a334c3b9200b", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/4f39ab4fdd413fb2eed06625bba5a334c3b9200b", "committedDate": "2020-07-06T21:02:29Z", "message": "Add function for getting download path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fafb9671f2b1da71b8e66c084218adbf9567a3d", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/3fafb9671f2b1da71b8e66c084218adbf9567a3d", "committedDate": "2020-07-07T03:40:31Z", "message": "Download jxbrowser file for platform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1918d71355d4d120ee0e9c0d50812fc5f4fb3370", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/1918d71355d4d120ee0e9c0d50812fc5f4fb3370", "committedDate": "2020-07-07T17:42:38Z", "message": "Use classloader to load jxbrowser"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTIzOTY5", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-444123969", "createdAt": "2020-07-07T17:55:54Z", "commit": {"oid": "1918d71355d4d120ee0e9c0d50812fc5f4fb3370"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo1NTo1NVrOGuJi7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo1NTo1NVrOGuJi7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0NDA3Nw==", "bodyText": "I think we should do a little refactoring. See AddToAppUtils.getStaticFieldValue(). If you move that method to, say, SystemUtils then you can just use it here. Unfortunately, I defined it in a class that's part of flutter-studio so you can't use it directly.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r451044077", "createdAt": "2020-07-07T17:55:55Z", "author": {"login": "stevemessick"}, "path": "src/io/flutter/ProjectOpenActivity.java", "diffHunk": "@@ -35,12 +54,73 @@\n public class ProjectOpenActivity implements StartupActivity, DumbAware {\n   public static final ProjectType FLUTTER_PROJECT_TYPE = new ProjectType(\"io.flutter\");\n   private static final Logger LOG = Logger.getInstance(ProjectOpenActivity.class);\n+  private static final String DOWNLOAD_PATH = FileUtils.platformPath();\n \n   public ProjectOpenActivity() {\n   }\n \n+  private void verifyJxBrowser(Project project) {\n+    final File directory = new File(DOWNLOAD_PATH);\n+    if (!directory.exists()) {\n+      //noinspection ResultOfMethodCallIgnored\n+      directory.mkdirs();\n+    }\n+\n+    String jxbrowserFileName = JxBrowserUtils.getPlatformFileName();\n+    final File jxbrowserPlatformFile = new File(DOWNLOAD_PATH + File.separator + jxbrowserFileName);\n+    if (jxbrowserPlatformFile.exists()) {\n+      // Skip downloading\n+      System.out.println(\"JxBrowser platform file already exists\");\n+      loadClasses(jxbrowserPlatformFile);\n+      return;\n+    }\n+\n+    DownloadableFileService service = DownloadableFileService.getInstance();\n+    DownloadableFileDescription description = service.createFileDescription(JxBrowserUtils.getDistributionLink(jxbrowserFileName), jxbrowserFileName);\n+    FileDownloader downloader = service.createDownloader(Collections.singletonList(description), jxbrowserFileName);\n+\n+    Task.Backgroundable task = new Task.Backgroundable(project, \"Downloading jxbrowser\") {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          List<Pair<File, DownloadableFileDescription>> pairs = downloader.download(new File(DOWNLOAD_PATH));\n+          Pair<File, DownloadableFileDescription> first = ContainerUtil.getFirstItem(pairs);\n+          File file = first != null ? first.first : null;\n+          if (file != null) {\n+            System.out.println(\"File downloaded: \" + file.getAbsolutePath());\n+          }\n+          loadClasses(file);\n+        }\n+        catch (IOException e) {\n+          System.out.println(\"Unable to download file\");\n+        }\n+      }\n+    };\n+    BackgroundableProcessIndicator processIndicator = new BackgroundableProcessIndicator(task);\n+    processIndicator.setIndeterminate(false);\n+    ProgressManager.getInstance().runProcessWithProgressAsynchronously(task, processIndicator);\n+  }\n+\n+  private void loadClasses(File file) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1918d71355d4d120ee0e9c0d50812fc5f4fb3370"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTI4MDY4", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-444128068", "createdAt": "2020-07-07T18:01:23Z", "commit": {"oid": "1918d71355d4d120ee0e9c0d50812fc5f4fb3370"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxODowMToyM1rOGuJwAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxODowMToyM1rOGuJwAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0NzQyNA==", "bodyText": "I'm not sure JetBrains approves of outsiders (like us) modifying their internal data. If we make this \"Google\" then it can be shared with all IDEs, and the file will be only downloaded once.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r451047424", "createdAt": "2020-07-07T18:01:23Z", "author": {"login": "stevemessick"}, "path": "src/io/flutter/utils/FileUtils.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.utils;\n+\n+import com.intellij.openapi.util.SystemInfoRt;\n+import com.intellij.util.SystemProperties;\n+\n+public class FileUtils {\n+  private static final String IDE_VENDOR_NAME = System.getProperty(\"idea.vendor.name\", \"JetBrains\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1918d71355d4d120ee0e9c0d50812fc5f4fb3370"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3991f409800afdf03761a638bd65b857338a6791", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/3991f409800afdf03761a638bd65b857338a6791", "committedDate": "2020-07-07T18:50:46Z", "message": "Change directory to google for storing jxbrowser file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ecc0253cbf31ecc0f5045d2f4f27f40024e1aba", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/6ecc0253cbf31ecc0f5045d2f4f27f40024e1aba", "committedDate": "2020-07-07T23:23:51Z", "message": "Use reflection util to get method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9679bc877eedeb95f958b5a2c6272f1c6ab50a22", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/9679bc877eedeb95f958b5a2c6272f1c6ab50a22", "committedDate": "2020-07-07T23:30:12Z", "message": "Move jxbrowser setup to separate class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a3a0656d211b24f60004a39cb4e2c386c1f7a8b", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/6a3a0656d211b24f60004a39cb4e2c386c1f7a8b", "committedDate": "2020-07-08T00:26:07Z", "message": "Manage one download between projects\n\nThis adds a loading file indicating that the JxBrowser platform file is\nbeing downloaded so that we can avoid multiple downloads.\n\nMaybe there's a better way to do this?"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa9797e0a81978decaec48441ea44c6f69543944", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/fa9797e0a81978decaec48441ea44c6f69543944", "committedDate": "2020-07-07T22:24:41Z", "message": "Use reflection util to get method"}, "afterCommit": {"oid": "6a3a0656d211b24f60004a39cb4e2c386c1f7a8b", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/6a3a0656d211b24f60004a39cb4e2c386c1f7a8b", "committedDate": "2020-07-08T00:26:07Z", "message": "Manage one download between projects\n\nThis adds a loading file indicating that the JxBrowser platform file is\nbeing downloaded so that we can avoid multiple downloads.\n\nMaybe there's a better way to do this?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ec21967a7eacd830f5c875fce21a41b0a21fba3", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/5ec21967a7eacd830f5c875fce21a41b0a21fba3", "committedDate": "2020-07-08T17:17:54Z", "message": "Use static var to track loading across projects\n\nCan test this by opening workbench with two projects, verify that\nloading only occurs once (for whichever project opens first), then\nverify that devtools panel opens in the other project"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7af1cc89ab73474af6106666c5a5a39ce2900868", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/7af1cc89ab73474af6106666c5a5a39ce2900868", "committedDate": "2020-07-08T18:35:38Z", "message": "Use logger and better comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54506e3d859fffe29ec66486c42bea2d34e39a01", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/54506e3d859fffe29ec66486c42bea2d34e39a01", "committedDate": "2020-07-08T23:46:35Z", "message": "Download api and swing files dynamically as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f15db7120df36311dbd650757ca637c15d38debf", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/f15db7120df36311dbd650757ca637c15d38debf", "committedDate": "2020-07-09T19:08:15Z", "message": "Match size of container when inserting browser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d9e7d03fcca518c41bdf707eb21db66c51a2b5a", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/4d9e7d03fcca518c41bdf707eb21db66c51a2b5a", "committedDate": "2020-07-09T21:42:55Z", "message": "Remove unused function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzM2ODQy", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-446736842", "createdAt": "2020-07-10T22:42:26Z", "commit": {"oid": "54506e3d859fffe29ec66486c42bea2d34e39a01"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMjo0MjoyNlrOGwHjMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMjo0Nzo0MlrOGwHoYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwODUyOA==", "bodyText": "I think we only want to start this if we know this is a flutter project; I'd move this down somewhere below the declaresFlutter check.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r453108528", "createdAt": "2020-07-10T22:42:26Z", "author": {"login": "devoncarew"}, "path": "src/io/flutter/ProjectOpenActivity.java", "diffHunk": "@@ -41,6 +42,8 @@ public ProjectOpenActivity() {\n \n   @Override\n   public void runActivity(@NotNull Project project) {\n+    JxBrowserManager.get().setUp(project);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54506e3d859fffe29ec66486c42bea2d34e39a01"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwOTQzNQ==", "bodyText": "Consider doing something like reading the key from a properties file, having a demo / mock key checked in for that file, and overwriting the file with the real key as part of the build process.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r453109435", "createdAt": "2020-07-10T22:45:49Z", "author": {"login": "devoncarew"}, "path": "src/io/flutter/view/FlutterView.java", "diffHunk": "@@ -182,11 +177,11 @@ private PerAppState getOrCreateStateForApp(FlutterApp app) {\n   }\n \n   private void addInspectorViewContent(FlutterApp app, @Nullable InspectorService inspectorService, ToolWindow toolWindow) {\n+    String browserUrl = app.getConnector().getBrowserUrl();\n+\n+    System.setProperty(\"jxbrowser.license.key\", \"6P830J66YAO1XQRI1FNEXP8ZTHUOQTY2YUJRCN9RTARQ58QFAP63GRRH20B3P5PB7PC8\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNTYyNQ=="}, "originalCommit": {"oid": "b4546cb938f0ebaa85e41408f7208cd08bb94fc2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwOTg1Nw==", "bodyText": "How confident are we with the process here (downloading, jsbrowser, ...)? We should probably do something like have an experimental setting in our preferences, and let people opt into trying this out for release or two. That would allow us to iron out any issues.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r453109857", "createdAt": "2020-07-10T22:47:42Z", "author": {"login": "devoncarew"}, "path": "src/io/flutter/view/FlutterView.java", "diffHunk": "@@ -201,58 +196,12 @@ private void addInspectorViewContent(FlutterApp app, @Nullable InspectorService\n       tabName = device.getUniqueName(existingDevices);\n     }\n \n-    final Content content = contentManager.getFactory().createContent(null, tabName, false);\n-    tabContainer.add(runnerTabs.getComponent(), BorderLayout.CENTER);\n-    content.setComponent(tabContainer);\n-    content.putUserData(ToolWindow.SHOW_CONTENT_ICON, Boolean.TRUE);\n-    content.setIcon(FlutterIcons.Phone);\n-    contentManager.addContent(content);\n+    DevToolsManager.getInstance(app.getProject()).openBrowserIntoPanel(browserUrl, contentManager, tabName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54506e3d859fffe29ec66486c42bea2d34e39a01"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9871cf8835480aeac21e3dda92377ecabd5c89d5", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/9871cf8835480aeac21e3dda92377ecabd5c89d5", "committedDate": "2020-07-14T16:56:44Z", "message": "Use class loader from class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dde43f18b8109841cbe1d70014ef794c2e032f68", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/dde43f18b8109841cbe1d70014ef794c2e032f68", "committedDate": "2020-07-14T18:27:01Z", "message": "Move key to environment variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1056bdca26e9b3f926af1e919e6ff5c17b75cf5a", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/1056bdca26e9b3f926af1e919e6ff5c17b75cf5a", "committedDate": "2020-07-14T23:50:29Z", "message": "Fix resizing issue by removing scroll pane"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTU0NzM0", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-448554734", "createdAt": "2020-07-15T00:37:53Z", "commit": {"oid": "1056bdca26e9b3f926af1e919e6ff5c17b75cf5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDozNzo1M1rOGxqErg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDozNzo1M1rOGxqErg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyMjczNA==", "bodyText": "nit: todos should use the name of the cl author.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r454722734", "createdAt": "2020-07-15T00:37:53Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -217,6 +229,36 @@ private boolean isBazel(Project project) {\n     return WorkspaceCache.getInstance(project).isBazel();\n   }\n \n+  public void openBrowserIntoPanel(String uri, ContentManager contentManager, String tabName) {\n+    String screen = null;\n+\n+    if (devToolsInstance != null) {\n+      devToolsInstance.openPanel(uri, contentManager, tabName);\n+    }\n+    else {\n+      @Nullable final OSProcessHandler handler =\n+        isBazel(project) ? getProcessHandlerForBazel() : getProcessHandlerForPub();\n+\n+      if (handler != null) {\n+        // TODO(devoncarew) Add a Task.Backgroundable here; \"Starting devtools...\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1056bdca26e9b3f926af1e919e6ff5c17b75cf5a"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTU1MDc3", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-448555077", "createdAt": "2020-07-15T00:39:12Z", "commit": {"oid": "1056bdca26e9b3f926af1e919e6ff5c17b75cf5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDozOToxM1rOGxqF4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDozOToxM1rOGxqF4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyMzA0MQ==", "bodyText": "why the invoke later? I would have thought this code was already running on the ui thread.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r454723041", "createdAt": "2020-07-15T00:39:13Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -311,6 +353,31 @@ public void openBrowserAndConnect(String serviceProtocolUri, String page) {\n       null\n     );\n   }\n+\n+  public void openPanel(String serviceProtocolUri, ContentManager contentManager, String tabName) {\n+    String address = DevToolsUtils.generateDevToolsUrl(devtoolsHost, devtoolsPort, serviceProtocolUri, null) + \"&embed=true&page=inspector\";\n+\n+    EngineOptions options =\n+      EngineOptions.newBuilder(HARDWARE_ACCELERATED).build();\n+    Engine engine = Engine.newInstance(options);\n+    Browser browser = engine.newBrowser();\n+\n+    final Content content = contentManager.getFactory().createContent(null, tabName, false);\n+\n+    SwingUtilities.invokeLater(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1056bdca26e9b3f926af1e919e6ff5c17b75cf5a"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93f05d47c72f06da18a257f44da8c6d6a72a1249", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/93f05d47c72f06da18a257f44da8c6d6a72a1249", "committedDate": "2020-07-15T16:41:34Z", "message": "Move jxbrowser initialization after flutter checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c0f2fa78ff06cff7b2f8bfe9adcc77c54d226a6", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/4c0f2fa78ff06cff7b2f8bfe9adcc77c54d226a6", "committedDate": "2020-07-15T17:04:50Z", "message": "Gate jxbrowser changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52cd407bb3917e2420d58918a33c0a7a6391ca15", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/52cd407bb3917e2420d58918a33c0a7a6391ca15", "committedDate": "2020-07-15T18:31:58Z", "message": "Start devtools panel conditioned on install status"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53e25795376bcf287d15555d1ed54b0fa9aa5bf1", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/53e25795376bcf287d15555d1ed54b0fa9aa5bf1", "committedDate": "2020-07-15T18:08:24Z", "message": "Start devtools panel conditioned on install status"}, "afterCommit": {"oid": "52cd407bb3917e2420d58918a33c0a7a6391ca15", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/52cd407bb3917e2420d58918a33c0a7a6391ca15", "committedDate": "2020-07-15T18:31:58Z", "message": "Start devtools panel conditioned on install status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fea2d08422e809c6b00a1d90e2099c3709cd30a2", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/fea2d08422e809c6b00a1d90e2099c3709cd30a2", "committedDate": "2020-07-15T20:51:43Z", "message": "Remove jxbrowser API files"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c15acadc6942d62cff5d9bf00f023451f11a13f3", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/c15acadc6942d62cff5d9bf00f023451f11a13f3", "committedDate": "2020-07-15T20:30:21Z", "message": "Remove jxbrowser API files"}, "afterCommit": {"oid": "fea2d08422e809c6b00a1d90e2099c3709cd30a2", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/fea2d08422e809c6b00a1d90e2099c3709cd30a2", "committedDate": "2020-07-15T20:51:43Z", "message": "Remove jxbrowser API files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MzMwMjQ1", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-449330245", "createdAt": "2020-07-15T21:05:49Z", "commit": {"oid": "fea2d08422e809c6b00a1d90e2099c3709cd30a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMTowNTo0OVrOGyQCbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMTowNTo0OVrOGyQCbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM0NDc1MQ==", "bodyText": "Should be ENABLE_JX_BROWSER not ENABLE_JXBROWSER. Also move this check to outside this class to where setup is called. That way it is obvious by looking at that code that we aren't doing anything unless the flag is set.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r455344751", "createdAt": "2020-07-15T21:05:49Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/jxbrowser/JxBrowserManager.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.jxbrowser;\n+\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.progress.impl.BackgroundableProcessIndicator;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.util.Pair;\n+import com.intellij.util.containers.ContainerUtil;\n+import com.intellij.util.download.DownloadableFileDescription;\n+import com.intellij.util.download.DownloadableFileService;\n+import com.intellij.util.download.FileDownloader;\n+import com.intellij.util.lang.UrlClassLoader;\n+import io.flutter.utils.FileUtils;\n+import io.flutter.utils.JxBrowserUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+enum JxBrowserStatus {\n+  NOT_INSTALLED,\n+  INSTALLATION_IN_PROGRESS,\n+  INSTALLED,\n+  INSTALLATION_FAILED,\n+}\n+\n+// JxBrowser provides Chromium to display web pages within IntelliJ. This class manages downloading the required files and adding them to\n+// the class path.\n+public class JxBrowserManager {\n+  private static JxBrowserManager manager;\n+  private static final String DOWNLOAD_PATH = FileUtils.platformPath();\n+  private static final AtomicReference<JxBrowserStatus> status = new AtomicReference<>(JxBrowserStatus.NOT_INSTALLED);\n+  private static final Logger LOG = Logger.getInstance(JxBrowserManager.class);\n+  // We will be gating JxBrowser features until all of the features are landed.\n+  private static final boolean ENABLE_JXBROWSER = false;\n+\n+  private JxBrowserManager() {}\n+\n+  public static JxBrowserManager get() {\n+    if (manager == null) {\n+      return new JxBrowserManager();\n+    }\n+    return manager;\n+  }\n+\n+  public boolean isInstalled() {\n+    return status.get().equals(JxBrowserStatus.INSTALLED);\n+  }\n+\n+  public void setUp(Project project) {\n+    if (!ENABLE_JXBROWSER) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fea2d08422e809c6b00a1d90e2099c3709cd30a2"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MzMxNjUz", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-449331653", "createdAt": "2020-07-15T21:08:09Z", "commit": {"oid": "fea2d08422e809c6b00a1d90e2099c3709cd30a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMTowODowOVrOGyQKhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMTowODowOVrOGyQKhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM0NjgyMw==", "bodyText": "log something if making the directory fails and abort.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r455346823", "createdAt": "2020-07-15T21:08:09Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/jxbrowser/JxBrowserManager.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.jxbrowser;\n+\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.progress.impl.BackgroundableProcessIndicator;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.util.Pair;\n+import com.intellij.util.containers.ContainerUtil;\n+import com.intellij.util.download.DownloadableFileDescription;\n+import com.intellij.util.download.DownloadableFileService;\n+import com.intellij.util.download.FileDownloader;\n+import com.intellij.util.lang.UrlClassLoader;\n+import io.flutter.utils.FileUtils;\n+import io.flutter.utils.JxBrowserUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+enum JxBrowserStatus {\n+  NOT_INSTALLED,\n+  INSTALLATION_IN_PROGRESS,\n+  INSTALLED,\n+  INSTALLATION_FAILED,\n+}\n+\n+// JxBrowser provides Chromium to display web pages within IntelliJ. This class manages downloading the required files and adding them to\n+// the class path.\n+public class JxBrowserManager {\n+  private static JxBrowserManager manager;\n+  private static final String DOWNLOAD_PATH = FileUtils.platformPath();\n+  private static final AtomicReference<JxBrowserStatus> status = new AtomicReference<>(JxBrowserStatus.NOT_INSTALLED);\n+  private static final Logger LOG = Logger.getInstance(JxBrowserManager.class);\n+  // We will be gating JxBrowser features until all of the features are landed.\n+  private static final boolean ENABLE_JXBROWSER = false;\n+\n+  private JxBrowserManager() {}\n+\n+  public static JxBrowserManager get() {\n+    if (manager == null) {\n+      return new JxBrowserManager();\n+    }\n+    return manager;\n+  }\n+\n+  public boolean isInstalled() {\n+    return status.get().equals(JxBrowserStatus.INSTALLED);\n+  }\n+\n+  public void setUp(Project project) {\n+    if (!ENABLE_JXBROWSER) {\n+      return;\n+    }\n+\n+    if (!status.compareAndSet(JxBrowserStatus.NOT_INSTALLED, JxBrowserStatus.INSTALLATION_IN_PROGRESS)) {\n+      // This check ensures that an IDE only downloads and installs JxBrowser once, even if multiple projects are open.\n+      // If already in progress, let calling point wait until success or failure (it may make sense to call setUp but proceed).\n+      // If already succeeded or failed, no need to continue.\n+      return;\n+    }\n+\n+    LOG.info(project.getName() + \": Installing JxBrowser\");\n+\n+    final File directory = new File(DOWNLOAD_PATH);\n+    if (!directory.exists()) {\n+      //noinspection ResultOfMethodCallIgnored", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fea2d08422e809c6b00a1d90e2099c3709cd30a2"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a39918ff382c7bf2c0bc65f24afc760e3c61895", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/2a39918ff382c7bf2c0bc65f24afc760e3c61895", "committedDate": "2020-07-15T21:08:12Z", "message": "Revert \"Remove jxbrowser API files\"\n\nThis reverts commit fea2d08422e809c6b00a1d90e2099c3709cd30a2.\nWe need the files in lib for the bots, but these won't get into the\nbuild."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f294ea253ef97ba8c790f8886316ed29ada95ba5", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/f294ea253ef97ba8c790f8886316ed29ada95ba5", "committedDate": "2020-07-15T21:16:44Z", "message": "Move gating check to project open"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81", "committedDate": "2020-07-15T21:29:00Z", "message": "Add failure handling for directory not created"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MzkwNjc3", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-449390677", "createdAt": "2020-07-15T22:37:01Z", "commit": {"oid": "1056bdca26e9b3f926af1e919e6ff5c17b75cf5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjozNzowMlrOGyTsXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjozNzowMlrOGyTsXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwNDYzOA==", "bodyText": "Are these blocking calls that take over 10ms to initialize the Engine + browser? If so this work should be done on a background thread.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r455404638", "createdAt": "2020-07-15T22:37:02Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -311,6 +353,31 @@ public void openBrowserAndConnect(String serviceProtocolUri, String page) {\n       null\n     );\n   }\n+\n+  public void openPanel(String serviceProtocolUri, ContentManager contentManager, String tabName) {\n+    String address = DevToolsUtils.generateDevToolsUrl(devtoolsHost, devtoolsPort, serviceProtocolUri, null) + \"&embed=true&page=inspector\";\n+\n+    EngineOptions options =\n+      EngineOptions.newBuilder(HARDWARE_ACCELERATED).build();\n+    Engine engine = Engine.newInstance(options);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1056bdca26e9b3f926af1e919e6ff5c17b75cf5a"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MzkxNDM5", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-449391439", "createdAt": "2020-07-15T22:38:50Z", "commit": {"oid": "1056bdca26e9b3f926af1e919e6ff5c17b75cf5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjozODo1MFrOGyTuxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjozODo1MFrOGyTuxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwNTI1NA==", "bodyText": "you should use exponential backoff and we should display a user visible message if the download fails.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r455405254", "createdAt": "2020-07-15T22:38:50Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/jxbrowser/JxBrowserManager.java", "diffHunk": "@@ -0,0 +1,198 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.jxbrowser;\n+\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.progress.impl.BackgroundableProcessIndicator;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.util.Pair;\n+import com.intellij.util.containers.ContainerUtil;\n+import com.intellij.util.download.DownloadableFileDescription;\n+import com.intellij.util.download.DownloadableFileService;\n+import com.intellij.util.download.FileDownloader;\n+import com.intellij.util.lang.UrlClassLoader;\n+import io.flutter.utils.FileUtils;\n+import io.flutter.utils.JxBrowserUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+enum JxBrowserStatus {\n+  NOT_INSTALLED,\n+  INSTALLATION_IN_PROGRESS,\n+  INSTALLED,\n+  INSTALLATION_FAILED,\n+}\n+\n+\n+public class JxBrowserManager {\n+  private static JxBrowserManager manager;\n+  private static final String DOWNLOAD_PATH = FileUtils.platformPath();\n+  private static final AtomicReference<JxBrowserStatus> status = new AtomicReference<>(JxBrowserStatus.NOT_INSTALLED);\n+  private static final Logger LOG = Logger.getInstance(JxBrowserManager.class);\n+\n+  private JxBrowserManager() {}\n+\n+  public static JxBrowserManager get() {\n+    if (manager == null) {\n+      return new JxBrowserManager();\n+    }\n+    return manager;\n+  }\n+\n+  public void setUp(Project project) {\n+    if (!status.compareAndSet(JxBrowserStatus.NOT_INSTALLED, JxBrowserStatus.INSTALLATION_IN_PROGRESS)) {\n+      // This check ensures that an IDE only downloads and installs JxBrowser once, even if multiple projects are open.\n+      // If already in progress, let calling point wait until success or failure (it may make sense to call setUp but proceed).\n+      // If already succeeded or failed, no need to continue.\n+      return;\n+    }\n+\n+    LOG.info(project.getName() + \": Installing JxBrowser\");\n+\n+    final File directory = new File(DOWNLOAD_PATH);\n+    if (!directory.exists()) {\n+      //noinspection ResultOfMethodCallIgnored\n+      directory.mkdirs();\n+    }\n+\n+    // Check for file or loading file\n+    final String[] fileNames = {JxBrowserUtils.getPlatformFileName(), JxBrowserUtils.getApiFileName(), JxBrowserUtils.getSwingFileName()};\n+    boolean allDownloaded = true;\n+    final List<File> files = new ArrayList<>();\n+    for (String fileName : fileNames) {\n+      final File file = new File(DOWNLOAD_PATH + File.separator + fileName);\n+      files.add(file);\n+      if (!file.exists()) {\n+        allDownloaded = false;\n+        break;\n+      }\n+    }\n+\n+    if (allDownloaded) {\n+      LOG.info(project.getName() + \": JxBrowser platform file already exists, skipping download\");\n+      loadClasses(files);\n+      return;\n+    }\n+\n+    final File tempLoadingFile = new File(DOWNLOAD_PATH + File.separator + JxBrowserUtils.getLoadingFileName());\n+    boolean created = false;\n+    try {\n+      created = tempLoadingFile.createNewFile();\n+    }\n+    catch (IOException e) {\n+      e.printStackTrace();\n+    }\n+\n+    if (!created) {\n+      // This means another IDE already created this file and has started downloading.\n+      // Wait for download to finish and then try loading again.\n+      LOG.info(project.getName() + \": Waiting for JxBrowser file to download\");\n+      int attempts = 0;\n+      while (attempts < 100) {\n+        if (tempLoadingFile.exists()) {\n+          try {\n+            Thread.sleep(1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1056bdca26e9b3f926af1e919e6ff5c17b75cf5a"}, "originalPosition": 107}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5Mzk2MjE0", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-449396214", "createdAt": "2020-07-15T22:51:06Z", "commit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1MTowN1rOGyT_zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1MTowN1rOGyT_zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwOTYxNQ==", "bodyText": "nit: address -> url", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r455409615", "createdAt": "2020-07-15T22:51:07Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -311,6 +351,31 @@ public void openBrowserAndConnect(String serviceProtocolUri, String page) {\n       null\n     );\n   }\n+\n+  public void openPanel(String serviceProtocolUri, ContentManager contentManager, String tabName) {\n+    String address = DevToolsUtils.generateDevToolsUrl(devtoolsHost, devtoolsPort, serviceProtocolUri, null) + \"&embed=true&page=inspector\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5Mzk2Njcw", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-449396670", "createdAt": "2020-07-15T22:52:15Z", "commit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1MjoxNVrOGyUBcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1MjoxNVrOGyUBcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMDAzNQ==", "bodyText": "update DevToolsUtils to accept passing in embed=true and pass in the tabName instead of hardcoding to the inspector.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r455410035", "createdAt": "2020-07-15T22:52:15Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -311,6 +351,31 @@ public void openBrowserAndConnect(String serviceProtocolUri, String page) {\n       null\n     );\n   }\n+\n+  public void openPanel(String serviceProtocolUri, ContentManager contentManager, String tabName) {\n+    String address = DevToolsUtils.generateDevToolsUrl(devtoolsHost, devtoolsPort, serviceProtocolUri, null) + \"&embed=true&page=inspector\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5Mzk2OTU0", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-449396954", "createdAt": "2020-07-15T22:53:03Z", "commit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1MzowM1rOGyUCfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1MzowM1rOGyUCfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMDMwMw==", "bodyText": "add a todo: we should use a different icon based on the tab and we should copy the icons from the inspector toolbar rather than using the Phone icon.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r455410303", "createdAt": "2020-07-15T22:53:03Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -311,6 +351,31 @@ public void openBrowserAndConnect(String serviceProtocolUri, String page) {\n       null\n     );\n   }\n+\n+  public void openPanel(String serviceProtocolUri, ContentManager contentManager, String tabName) {\n+    String address = DevToolsUtils.generateDevToolsUrl(devtoolsHost, devtoolsPort, serviceProtocolUri, null) + \"&embed=true&page=inspector\";\n+\n+    EngineOptions options =\n+      EngineOptions.newBuilder(HARDWARE_ACCELERATED).build();\n+    Engine engine = Engine.newInstance(options);\n+    Browser browser = engine.newBrowser();\n+\n+    final Content content = contentManager.getFactory().createContent(null, tabName, false);\n+\n+    SwingUtilities.invokeLater(() -> {\n+      // Creating Swing component for rendering web content\n+      // loaded in the given Browser instance.\n+      BrowserView view = BrowserView.newInstance(browser);\n+      view.setPreferredSize(new Dimension(contentManager.getComponent().getWidth(), contentManager.getComponent().getHeight()));\n+\n+      content.setComponent(view);\n+      content.putUserData(ToolWindow.SHOW_CONTENT_ICON, Boolean.TRUE);\n+      content.setIcon(FlutterIcons.Phone);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5Mzk4MjMw", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-449398230", "createdAt": "2020-07-15T22:56:29Z", "commit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1NjoyOVrOGyUGzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1NjoyOVrOGyUGzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTQwNg==", "bodyText": "Nit: for consistency with singletons in the rest of the code base call this getInstance() instead of get().", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r455411406", "createdAt": "2020-07-15T22:56:29Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/jxbrowser/JxBrowserManager.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.jxbrowser;\n+\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.progress.impl.BackgroundableProcessIndicator;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.util.Pair;\n+import com.intellij.util.containers.ContainerUtil;\n+import com.intellij.util.download.DownloadableFileDescription;\n+import com.intellij.util.download.DownloadableFileService;\n+import com.intellij.util.download.FileDownloader;\n+import com.intellij.util.lang.UrlClassLoader;\n+import io.flutter.utils.FileUtils;\n+import io.flutter.utils.JxBrowserUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+enum JxBrowserStatus {\n+  NOT_INSTALLED,\n+  INSTALLATION_IN_PROGRESS,\n+  INSTALLED,\n+  INSTALLATION_FAILED,\n+}\n+\n+// JxBrowser provides Chromium to display web pages within IntelliJ. This class manages downloading the required files and adding them to\n+// the class path.\n+public class JxBrowserManager {\n+  private static JxBrowserManager manager;\n+  private static final String DOWNLOAD_PATH = FileUtils.platformPath();\n+  private static final AtomicReference<JxBrowserStatus> status = new AtomicReference<>(JxBrowserStatus.NOT_INSTALLED);\n+  private static final Logger LOG = Logger.getInstance(JxBrowserManager.class);\n+  // We will be gating JxBrowser features until all of the features are landed.\n+  // To test JxBrowser, set this to true and also add license key to VM options (-Djxbrowser.license.key=<key>).\n+  public static final boolean ENABLE_JX_BROWSER = false;\n+\n+  private JxBrowserManager() {}\n+\n+  public static JxBrowserManager get() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5Mzk4NTI3", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-449398527", "createdAt": "2020-07-15T22:57:19Z", "commit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1NzoyMFrOGyUH5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMjo1NzoyMFrOGyUH5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMTY4NA==", "bodyText": "make 100 a constant and consider removing if using exponential backoff.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r455411684", "createdAt": "2020-07-15T22:57:20Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/jxbrowser/JxBrowserManager.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.jxbrowser;\n+\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.progress.impl.BackgroundableProcessIndicator;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.util.Pair;\n+import com.intellij.util.containers.ContainerUtil;\n+import com.intellij.util.download.DownloadableFileDescription;\n+import com.intellij.util.download.DownloadableFileService;\n+import com.intellij.util.download.FileDownloader;\n+import com.intellij.util.lang.UrlClassLoader;\n+import io.flutter.utils.FileUtils;\n+import io.flutter.utils.JxBrowserUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+enum JxBrowserStatus {\n+  NOT_INSTALLED,\n+  INSTALLATION_IN_PROGRESS,\n+  INSTALLED,\n+  INSTALLATION_FAILED,\n+}\n+\n+// JxBrowser provides Chromium to display web pages within IntelliJ. This class manages downloading the required files and adding them to\n+// the class path.\n+public class JxBrowserManager {\n+  private static JxBrowserManager manager;\n+  private static final String DOWNLOAD_PATH = FileUtils.platformPath();\n+  private static final AtomicReference<JxBrowserStatus> status = new AtomicReference<>(JxBrowserStatus.NOT_INSTALLED);\n+  private static final Logger LOG = Logger.getInstance(JxBrowserManager.class);\n+  // We will be gating JxBrowser features until all of the features are landed.\n+  // To test JxBrowser, set this to true and also add license key to VM options (-Djxbrowser.license.key=<key>).\n+  public static final boolean ENABLE_JX_BROWSER = false;\n+\n+  private JxBrowserManager() {}\n+\n+  public static JxBrowserManager get() {\n+    if (manager == null) {\n+      return new JxBrowserManager();\n+    }\n+    return manager;\n+  }\n+\n+  public boolean isInstalled() {\n+    return status.get().equals(JxBrowserStatus.INSTALLED);\n+  }\n+\n+  public void setUp(Project project) {\n+    if (!status.compareAndSet(JxBrowserStatus.NOT_INSTALLED, JxBrowserStatus.INSTALLATION_IN_PROGRESS)) {\n+      // This check ensures that an IDE only downloads and installs JxBrowser once, even if multiple projects are open.\n+      // If already in progress, let calling point wait until success or failure (it may make sense to call setUp but proceed).\n+      // If already succeeded or failed, no need to continue.\n+      return;\n+    }\n+\n+    LOG.info(project.getName() + \": Installing JxBrowser\");\n+\n+    final File directory = new File(DOWNLOAD_PATH);\n+    if (!directory.exists()) {\n+      if (!directory.mkdirs()) {\n+        LOG.info(project.getName() + \": Unable to create directory for JxBrowser files\");\n+        status.set(JxBrowserStatus.INSTALLATION_FAILED);\n+        return;\n+      }\n+    }\n+\n+    // Check for file or loading file\n+    final String[] fileNames = {JxBrowserUtils.getPlatformFileName(), JxBrowserUtils.getApiFileName(), JxBrowserUtils.getSwingFileName()};\n+    boolean allDownloaded = true;\n+    final List<File> files = new ArrayList<>();\n+    for (String fileName : fileNames) {\n+      final File file = new File(DOWNLOAD_PATH + File.separator + fileName);\n+      files.add(file);\n+      if (!file.exists()) {\n+        allDownloaded = false;\n+        break;\n+      }\n+    }\n+\n+    if (allDownloaded) {\n+      LOG.info(project.getName() + \": JxBrowser platform file already exists, skipping download\");\n+      loadClasses(files);\n+      return;\n+    }\n+\n+    final File tempLoadingFile = new File(DOWNLOAD_PATH + File.separator + JxBrowserUtils.getLoadingFileName());\n+    boolean created = false;\n+    try {\n+      created = tempLoadingFile.createNewFile();\n+    }\n+    catch (IOException e) {\n+      e.printStackTrace();\n+    }\n+\n+    if (!created) {\n+      // This means another IDE already created this file and has started downloading.\n+      // Wait for download to finish and then try loading again.\n+      LOG.info(project.getName() + \": Waiting for JxBrowser file to download\");\n+      int attempts = 0;\n+      while (attempts < 100) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "originalPosition": 115}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5Mzk5NzM3", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-449399737", "createdAt": "2020-07-15T23:00:28Z", "commit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMzowMDoyOFrOGyUMdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMzowMDoyOFrOGyUMdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxMjg1Mg==", "bodyText": "this break seems wrong. The list of files will sometimes be missing a file.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r455412852", "createdAt": "2020-07-15T23:00:28Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/jxbrowser/JxBrowserManager.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.jxbrowser;\n+\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.progress.impl.BackgroundableProcessIndicator;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.util.Pair;\n+import com.intellij.util.containers.ContainerUtil;\n+import com.intellij.util.download.DownloadableFileDescription;\n+import com.intellij.util.download.DownloadableFileService;\n+import com.intellij.util.download.FileDownloader;\n+import com.intellij.util.lang.UrlClassLoader;\n+import io.flutter.utils.FileUtils;\n+import io.flutter.utils.JxBrowserUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+enum JxBrowserStatus {\n+  NOT_INSTALLED,\n+  INSTALLATION_IN_PROGRESS,\n+  INSTALLED,\n+  INSTALLATION_FAILED,\n+}\n+\n+// JxBrowser provides Chromium to display web pages within IntelliJ. This class manages downloading the required files and adding them to\n+// the class path.\n+public class JxBrowserManager {\n+  private static JxBrowserManager manager;\n+  private static final String DOWNLOAD_PATH = FileUtils.platformPath();\n+  private static final AtomicReference<JxBrowserStatus> status = new AtomicReference<>(JxBrowserStatus.NOT_INSTALLED);\n+  private static final Logger LOG = Logger.getInstance(JxBrowserManager.class);\n+  // We will be gating JxBrowser features until all of the features are landed.\n+  // To test JxBrowser, set this to true and also add license key to VM options (-Djxbrowser.license.key=<key>).\n+  public static final boolean ENABLE_JX_BROWSER = false;\n+\n+  private JxBrowserManager() {}\n+\n+  public static JxBrowserManager get() {\n+    if (manager == null) {\n+      return new JxBrowserManager();\n+    }\n+    return manager;\n+  }\n+\n+  public boolean isInstalled() {\n+    return status.get().equals(JxBrowserStatus.INSTALLED);\n+  }\n+\n+  public void setUp(Project project) {\n+    if (!status.compareAndSet(JxBrowserStatus.NOT_INSTALLED, JxBrowserStatus.INSTALLATION_IN_PROGRESS)) {\n+      // This check ensures that an IDE only downloads and installs JxBrowser once, even if multiple projects are open.\n+      // If already in progress, let calling point wait until success or failure (it may make sense to call setUp but proceed).\n+      // If already succeeded or failed, no need to continue.\n+      return;\n+    }\n+\n+    LOG.info(project.getName() + \": Installing JxBrowser\");\n+\n+    final File directory = new File(DOWNLOAD_PATH);\n+    if (!directory.exists()) {\n+      if (!directory.mkdirs()) {\n+        LOG.info(project.getName() + \": Unable to create directory for JxBrowser files\");\n+        status.set(JxBrowserStatus.INSTALLATION_FAILED);\n+        return;\n+      }\n+    }\n+\n+    // Check for file or loading file\n+    final String[] fileNames = {JxBrowserUtils.getPlatformFileName(), JxBrowserUtils.getApiFileName(), JxBrowserUtils.getSwingFileName()};\n+    boolean allDownloaded = true;\n+    final List<File> files = new ArrayList<>();\n+    for (String fileName : fileNames) {\n+      final File file = new File(DOWNLOAD_PATH + File.separator + fileName);\n+      files.add(file);\n+      if (!file.exists()) {\n+        allDownloaded = false;\n+        break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cba5c3a42ac4ced2af1b86cbd5f3bcafd5adb81"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4753505198aa620f3681dd7ac5ec7b90395f10e2", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/4753505198aa620f3681dd7ac5ec7b90395f10e2", "committedDate": "2020-07-16T01:51:39Z", "message": "Update devtools url generation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b65f0367805a8888248814943817a609bd750218", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/b65f0367805a8888248814943817a609bd750218", "committedDate": "2020-07-16T17:14:04Z", "message": "Fix jxbrowser manager break"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32f8a8bac76ce133a23d09976a43f220e4882a5d", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/32f8a8bac76ce133a23d09976a43f220e4882a5d", "committedDate": "2020-07-16T17:30:20Z", "message": "Fix ordering of params in test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a421957d39d7cbd26176bf07493110dded758b5e", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/a421957d39d7cbd26176bf07493110dded758b5e", "committedDate": "2020-07-16T17:53:14Z", "message": "Use exponential backoff to wait for download"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7863f3938b0f501561cb7c4730f6f9c45b7d788", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/c7863f3938b0f501561cb7c4730f6f9c45b7d788", "committedDate": "2020-07-16T18:28:52Z", "message": "Add notification for failed download"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzYxMDkz", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-450361093", "createdAt": "2020-07-17T04:13:48Z", "commit": {"oid": "c7863f3938b0f501561cb7c4730f6f9c45b7d788"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNDoxMzo0OFrOGzEvyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNDoxMzo0OFrOGzEvyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwODMyOQ==", "bodyText": "because it could have been some time from when the action was requested until we are ready to launch, we need to make sure the contentManager has not been disposed or perhaps that the project is still valid.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r456208329", "createdAt": "2020-07-17T04:13:48Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -307,10 +347,36 @@ public void processTerminated(@NotNull ProcessEvent event) {\n \n   public void openBrowserAndConnect(String serviceProtocolUri, String page) {\n     BrowserLauncher.getInstance().browse(\n-      DevToolsUtils.generateDevToolsUrl(devtoolsHost, devtoolsPort, serviceProtocolUri, page),\n+      DevToolsUtils.generateDevToolsUrl(devtoolsHost, devtoolsPort, serviceProtocolUri, page, false, null),\n       null\n     );\n   }\n+\n+  public void openPanel(String serviceProtocolUri, ContentManager contentManager, String tabName, String pageName) {\n+    String url = DevToolsUtils.generateDevToolsUrl(devtoolsHost, devtoolsPort, serviceProtocolUri, null, true, pageName);\n+\n+    EngineOptions options =\n+      EngineOptions.newBuilder(HARDWARE_ACCELERATED).build();\n+    Engine engine = Engine.newInstance(options);\n+    Browser browser = engine.newBrowser();\n+\n+    final Content content = contentManager.getFactory().createContent(null, tabName, false);\n+\n+    SwingUtilities.invokeLater(() -> {\n+      // Creating Swing component for rendering web content\n+      // loaded in the given Browser instance.\n+      BrowserView view = BrowserView.newInstance(browser);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7863f3938b0f501561cb7c4730f6f9c45b7d788"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzYyODcz", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-450362873", "createdAt": "2020-07-17T04:21:13Z", "commit": {"oid": "c7863f3938b0f501561cb7c4730f6f9c45b7d788"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNDoyMToxM1rOGzE14Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNDoyMToxM1rOGzE14Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIwOTg4OQ==", "bodyText": "what if the other ide was killed while the file was being downloaded? Now JXBrowser will never work. We need a generally more robust way to do this or we will get a lot of hard to track down bugs. I would suggest we err on the side of a simpler solution than a more efficient one. It is preferable if it wasn't possible for multiple IDEs to be trying to download files to the same locations.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r456209889", "createdAt": "2020-07-17T04:21:13Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/jxbrowser/JxBrowserManager.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.jxbrowser;\n+\n+import com.intellij.notification.Notification;\n+import com.intellij.notification.NotificationType;\n+import com.intellij.notification.Notifications;\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.progress.impl.BackgroundableProcessIndicator;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.util.Pair;\n+import com.intellij.util.containers.ContainerUtil;\n+import com.intellij.util.download.DownloadableFileDescription;\n+import com.intellij.util.download.DownloadableFileService;\n+import com.intellij.util.download.FileDownloader;\n+import com.intellij.util.lang.UrlClassLoader;\n+import icons.FlutterIcons;\n+import io.flutter.FlutterMessages;\n+import io.flutter.utils.FileUtils;\n+import io.flutter.utils.JxBrowserUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+enum JxBrowserStatus {\n+  NOT_INSTALLED,\n+  INSTALLATION_IN_PROGRESS,\n+  INSTALLED,\n+  INSTALLATION_FAILED,\n+}\n+\n+// JxBrowser provides Chromium to display web pages within IntelliJ. This class manages downloading the required files and adding them to\n+// the class path.\n+public class JxBrowserManager {\n+  private static JxBrowserManager manager;\n+  private static final String DOWNLOAD_PATH = FileUtils.platformPath();\n+  private static final AtomicReference<JxBrowserStatus> status = new AtomicReference<>(JxBrowserStatus.NOT_INSTALLED);\n+  private static final Logger LOG = Logger.getInstance(JxBrowserManager.class);\n+  // We will be gating JxBrowser features until all of the features are landed.\n+  // To test JxBrowser, set this to true and also add license key to VM options (-Djxbrowser.license.key=<key>).\n+  public static final boolean ENABLE_JX_BROWSER = false;\n+\n+  private JxBrowserManager() {}\n+\n+  public static JxBrowserManager getInstance() {\n+    if (manager == null) {\n+      return new JxBrowserManager();\n+    }\n+    return manager;\n+  }\n+\n+  public boolean isInstalled() {\n+    return status.get().equals(JxBrowserStatus.INSTALLED);\n+  }\n+\n+  public void setUp(Project project) {\n+    if (!status.compareAndSet(JxBrowserStatus.NOT_INSTALLED, JxBrowserStatus.INSTALLATION_IN_PROGRESS)) {\n+      // This check ensures that an IDE only downloads and installs JxBrowser once, even if multiple projects are open.\n+      // If already in progress, let calling point wait until success or failure (it may make sense to call setUp but proceed).\n+      // If already succeeded or failed, no need to continue.\n+      return;\n+    }\n+\n+    LOG.info(project.getName() + \": Installing JxBrowser\");\n+\n+    final File directory = new File(DOWNLOAD_PATH);\n+    if (!directory.exists()) {\n+      if (!directory.mkdirs()) {\n+        LOG.info(project.getName() + \": Unable to create directory for JxBrowser files\");\n+        status.set(JxBrowserStatus.INSTALLATION_FAILED);\n+        return;\n+      }\n+    }\n+\n+    // Check for file or loading file\n+    final String[] fileNames = {JxBrowserUtils.getPlatformFileName(), JxBrowserUtils.getApiFileName(), JxBrowserUtils.getSwingFileName()};\n+    boolean allDownloaded = true;\n+    final List<File> files = new ArrayList<>();\n+    for (String fileName : fileNames) {\n+      final File file = new File(DOWNLOAD_PATH + File.separator + fileName);\n+      files.add(file);\n+      if (!file.exists()) {\n+        allDownloaded = false;\n+      }\n+    }\n+\n+    if (allDownloaded) {\n+      LOG.info(project.getName() + \": JxBrowser platform file already exists, skipping download\");\n+      loadClasses(files);\n+      return;\n+    }\n+\n+    final File tempLoadingFile = new File(DOWNLOAD_PATH + File.separator + JxBrowserUtils.getLoadingFileName());\n+    boolean created = false;\n+    try {\n+      created = tempLoadingFile.createNewFile();\n+    }\n+    catch (IOException e) {\n+      e.printStackTrace();\n+    }\n+\n+    if (!created) {\n+      // This means another IDE already created this file and has started downloading.\n+      // Wait for download to finish and then try loading again.\n+      LOG.info(project.getName() + \": Waiting for JxBrowser file to download\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7863f3938b0f501561cb7c4730f6f9c45b7d788"}, "originalPosition": 117}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzYzNDY4", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-450363468", "createdAt": "2020-07-17T04:23:36Z", "commit": {"oid": "c7863f3938b0f501561cb7c4730f6f9c45b7d788"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNDoyMzozNlrOGzE35A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNDoyMzozNlrOGzE35A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIxMDQwNA==", "bodyText": "keep in mind if the IDE is killed you may not get a chance to delete this file. Likely a file lock that is released if the IDE is killed or similar would be more robust.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r456210404", "createdAt": "2020-07-17T04:23:36Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/jxbrowser/JxBrowserManager.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.jxbrowser;\n+\n+import com.intellij.notification.Notification;\n+import com.intellij.notification.NotificationType;\n+import com.intellij.notification.Notifications;\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.progress.impl.BackgroundableProcessIndicator;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.util.Pair;\n+import com.intellij.util.containers.ContainerUtil;\n+import com.intellij.util.download.DownloadableFileDescription;\n+import com.intellij.util.download.DownloadableFileService;\n+import com.intellij.util.download.FileDownloader;\n+import com.intellij.util.lang.UrlClassLoader;\n+import icons.FlutterIcons;\n+import io.flutter.FlutterMessages;\n+import io.flutter.utils.FileUtils;\n+import io.flutter.utils.JxBrowserUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+enum JxBrowserStatus {\n+  NOT_INSTALLED,\n+  INSTALLATION_IN_PROGRESS,\n+  INSTALLED,\n+  INSTALLATION_FAILED,\n+}\n+\n+// JxBrowser provides Chromium to display web pages within IntelliJ. This class manages downloading the required files and adding them to\n+// the class path.\n+public class JxBrowserManager {\n+  private static JxBrowserManager manager;\n+  private static final String DOWNLOAD_PATH = FileUtils.platformPath();\n+  private static final AtomicReference<JxBrowserStatus> status = new AtomicReference<>(JxBrowserStatus.NOT_INSTALLED);\n+  private static final Logger LOG = Logger.getInstance(JxBrowserManager.class);\n+  // We will be gating JxBrowser features until all of the features are landed.\n+  // To test JxBrowser, set this to true and also add license key to VM options (-Djxbrowser.license.key=<key>).\n+  public static final boolean ENABLE_JX_BROWSER = false;\n+\n+  private JxBrowserManager() {}\n+\n+  public static JxBrowserManager getInstance() {\n+    if (manager == null) {\n+      return new JxBrowserManager();\n+    }\n+    return manager;\n+  }\n+\n+  public boolean isInstalled() {\n+    return status.get().equals(JxBrowserStatus.INSTALLED);\n+  }\n+\n+  public void setUp(Project project) {\n+    if (!status.compareAndSet(JxBrowserStatus.NOT_INSTALLED, JxBrowserStatus.INSTALLATION_IN_PROGRESS)) {\n+      // This check ensures that an IDE only downloads and installs JxBrowser once, even if multiple projects are open.\n+      // If already in progress, let calling point wait until success or failure (it may make sense to call setUp but proceed).\n+      // If already succeeded or failed, no need to continue.\n+      return;\n+    }\n+\n+    LOG.info(project.getName() + \": Installing JxBrowser\");\n+\n+    final File directory = new File(DOWNLOAD_PATH);\n+    if (!directory.exists()) {\n+      if (!directory.mkdirs()) {\n+        LOG.info(project.getName() + \": Unable to create directory for JxBrowser files\");\n+        status.set(JxBrowserStatus.INSTALLATION_FAILED);\n+        return;\n+      }\n+    }\n+\n+    // Check for file or loading file\n+    final String[] fileNames = {JxBrowserUtils.getPlatformFileName(), JxBrowserUtils.getApiFileName(), JxBrowserUtils.getSwingFileName()};\n+    boolean allDownloaded = true;\n+    final List<File> files = new ArrayList<>();\n+    for (String fileName : fileNames) {\n+      final File file = new File(DOWNLOAD_PATH + File.separator + fileName);\n+      files.add(file);\n+      if (!file.exists()) {\n+        allDownloaded = false;\n+      }\n+    }\n+\n+    if (allDownloaded) {\n+      LOG.info(project.getName() + \": JxBrowser platform file already exists, skipping download\");\n+      loadClasses(files);\n+      return;\n+    }\n+\n+    final File tempLoadingFile = new File(DOWNLOAD_PATH + File.separator + JxBrowserUtils.getLoadingFileName());\n+    boolean created = false;\n+    try {\n+      created = tempLoadingFile.createNewFile();\n+    }\n+    catch (IOException e) {\n+      e.printStackTrace();\n+    }\n+\n+    if (!created) {\n+      // This means another IDE already created this file and has started downloading.\n+      // Wait for download to finish and then try loading again.\n+      LOG.info(project.getName() + \": Waiting for JxBrowser file to download\");\n+      int waitSeconds = 1;\n+      while (waitSeconds <= 128) {\n+        if (tempLoadingFile.exists()) {\n+          try {\n+            Thread.sleep(waitSeconds * 1000);\n+          }\n+          catch (InterruptedException e) {\n+            e.printStackTrace();\n+            break;\n+          }\n+          waitSeconds = waitSeconds * 2;\n+        }\n+        else {\n+          LOG.info(project.getName() + \": JxBrowser file downloaded, attempting to load\");\n+          loadClasses(files);\n+          return;\n+        }\n+      }\n+      // If jxbrowser was not downloaded within allowed time.\n+      LOG.info(project.getName() + \": JxBrowser download timed out\");\n+      Notifications.Bus.notify(\n+        new Notification(\n+          FlutterMessages.FLUTTER_NOTIFICATION_GROUP_ID,\n+          FlutterIcons.Flutter,\n+          \"JxBrowser download timed out\",\n+          null,\n+          // TODO(helin24): Replace with better message or retry download action.\n+          String.format(\"Retry by deleting files in %s and restarting IntelliJ\", DOWNLOAD_PATH),\n+          NotificationType.INFORMATION,\n+          null\n+        )\n+      );\n+      status.set(JxBrowserStatus.INSTALLATION_FAILED);\n+      return;\n+    }\n+\n+    // Delete any already existing files.\n+    // TODO: Handle if files cannot be deleted.\n+    for (File file : files) {\n+      if (file.exists()) {\n+        if (!file.delete()) {\n+          LOG.info(project.getName() + \": Existing file could not be deleted - \" + file.getAbsolutePath());\n+        }\n+      }\n+    }\n+\n+    downloadJxBrowser(project, fileNames, tempLoadingFile);\n+  }\n+\n+  private void downloadJxBrowser(Project project, String[] fileNames, File tempLoadingFile) {\n+    final List<FileDownloader> fileDownloaders = new ArrayList<>();\n+    final DownloadableFileService service = DownloadableFileService.getInstance();\n+    for (String fileName : fileNames) {\n+      final DownloadableFileDescription\n+        description = service.createFileDescription(JxBrowserUtils.getDistributionLink(fileName), fileName);\n+      fileDownloaders.add(service.createDownloader(Collections.singletonList(description), fileName));\n+    }\n+\n+    final Task.Backgroundable task = new Task.Backgroundable(project, \"Downloading jxbrowser\") {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        String currentFileName = null;\n+        try {\n+          final List<File> files = new ArrayList<>();\n+          for (int i = 0; i < fileDownloaders.size(); i++) {\n+            final FileDownloader downloader = fileDownloaders.get(i);\n+            currentFileName = fileNames[i];\n+            final Pair<File, DownloadableFileDescription> download =\n+              ContainerUtil.getFirstItem(downloader.download(new File(DOWNLOAD_PATH)));\n+            final File file = download != null ? download.first : null;\n+            if (file != null) {\n+              files.add(file);\n+              LOG.info(project.getName() + \": JxBrowser file downloaded: \" + file.getAbsolutePath());\n+            }\n+          }\n+\n+          tempLoadingFile.delete();\n+          loadClasses(files);\n+        }\n+        catch (IOException e) {\n+          LOG.info(project.getName() + \": JxBrowser file downloaded failed: \" + currentFileName);\n+          e.printStackTrace();\n+          status.set(JxBrowserStatus.INSTALLATION_FAILED);\n+          tempLoadingFile.delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7863f3938b0f501561cb7c4730f6f9c45b7d788"}, "originalPosition": 201}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62a35a175ee590a15bd5d6b751109f3ba11e09c4", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/62a35a175ee590a15bd5d6b751109f3ba11e09c4", "committedDate": "2020-07-20T17:20:18Z", "message": "Move browser to a new directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9c7ce55998098967d8c25096387af5dc5db800a", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/b9c7ce55998098967d8c25096387af5dc5db800a", "committedDate": "2020-07-20T21:19:11Z", "message": "Use plugins path for storing files\n\nThis means jxbrowser files will be downloaded once for each plugin\ninstall/update, but this makes delete easier since the entire plugins\nfolder is cleared at those times."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4843b31739b9a33b5801a51bbbfaebd381f72c4f", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/4843b31739b9a33b5801a51bbbfaebd381f72c4f", "committedDate": "2020-07-20T21:27:50Z", "message": "Remove code for managing download across IDEs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30b207d55eb353f8ba2a4bfd4287172d3fb56ea5", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/30b207d55eb353f8ba2a4bfd4287172d3fb56ea5", "committedDate": "2020-07-20T22:09:59Z", "message": "Use file separator char and disable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dc4e7587cd3399c9b066d879066316da0d6d872", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/1dc4e7587cd3399c9b066d879066316da0d6d872", "committedDate": "2020-07-20T22:27:07Z", "message": "Check if contentManager is disposed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/2d861cb1377e9f281b69ae35c92d4df32d21b95d", "committedDate": "2020-07-20T22:35:21Z", "message": "Clarify comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMTQzMjgz", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-452143283", "createdAt": "2020-07-21T05:49:07Z", "commit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo0OTowN1rOG0pCeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo0OTowN1rOG0pCeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MTUxMg==", "bodyText": "nit:\nAdd message to panel to communicate --> add a message to communicate", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r457851512", "createdAt": "2020-07-21T05:49:07Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/view/FlutterView.java", "diffHunk": "@@ -181,6 +182,33 @@ private PerAppState getOrCreateStateForApp(FlutterApp app) {\n     return perAppViewState.computeIfAbsent(app, k -> new PerAppState());\n   }\n \n+  private void addBrowserInspectorViewContent(FlutterApp app, @Nullable InspectorService inspectorService, ToolWindow toolWindow) {\n+    final ContentManager contentManager = toolWindow.getContentManager();\n+\n+    final String tabName;\n+    final FlutterDevice device = app.device();\n+    if (device == null) {\n+      tabName = app.getProject().getName();\n+    }\n+    else {\n+      final List<FlutterDevice> existingDevices = new ArrayList<>();\n+      for (FlutterApp otherApp : perAppViewState.keySet()) {\n+        existingDevices.add(otherApp.device());\n+      }\n+      tabName = device.getUniqueName(existingDevices);\n+    }\n+\n+    if (emptyContent != null) {\n+      contentManager.removeContent(emptyContent, true);\n+      emptyContent = null;\n+    }\n+\n+    // TODO(helin24): Add message to panel to communicate that opening devtools is in progress.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMTQ0MTI4", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-452144128", "createdAt": "2020-07-21T05:51:20Z", "commit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1MToyMFrOG0pFZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1MToyMFrOG0pFZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MjI2MQ==", "bodyText": "do we need to handle if devtools failed to install?", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r457852261", "createdAt": "2020-07-21T05:51:20Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/view/FlutterView.java", "diffHunk": "@@ -373,6 +401,37 @@ private void debugActiveHelper(FlutterApp app, @Nullable InspectorService inspec\n \n     toolWindow.setIcon(ExecutionUtil.getLiveIndicator(FlutterIcons.Flutter_13));\n \n+    if (JxBrowserManager.getInstance().isInstalled()) {\n+      final DevToolsManager devToolsManager = DevToolsManager.getInstance(app.getProject());\n+\n+      if (devToolsManager.hasInstalledDevTools()) {\n+        addBrowserInspectorViewContent(app, inspectorService, toolWindow);\n+      }\n+      else {\n+        final CompletableFuture<Boolean> result = devToolsManager.installDevTools();\n+        result.thenAccept(o -> addBrowserInspectorViewContent(app, inspectorService, toolWindow));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMTQ0NDYz", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-452144463", "createdAt": "2020-07-21T05:52:09Z", "commit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1MjowOVrOG0pGiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1MjowOVrOG0pGiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MjU1NQ==", "bodyText": "why is this code needed here? this seems copied from somewhere and not clearly relevant.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r457852555", "createdAt": "2020-07-21T05:52:09Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/view/FlutterView.java", "diffHunk": "@@ -373,6 +401,37 @@ private void debugActiveHelper(FlutterApp app, @Nullable InspectorService inspec\n \n     toolWindow.setIcon(ExecutionUtil.getLiveIndicator(FlutterIcons.Flutter_13));\n \n+    if (JxBrowserManager.getInstance().isInstalled()) {\n+      final DevToolsManager devToolsManager = DevToolsManager.getInstance(app.getProject());\n+\n+      if (devToolsManager.hasInstalledDevTools()) {\n+        addBrowserInspectorViewContent(app, inspectorService, toolWindow);\n+      }\n+      else {\n+        final CompletableFuture<Boolean> result = devToolsManager.installDevTools();\n+        result.thenAccept(o -> addBrowserInspectorViewContent(app, inspectorService, toolWindow));\n+      }\n+\n+      onAppChanged(app);\n+\n+      app.addStateListener(new FlutterApp.FlutterAppListener() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMTQ1NDYz", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-452145463", "createdAt": "2020-07-21T05:54:45Z", "commit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1NDo0NlrOG0pJ4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1NDo0NlrOG0pJ4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1MzQwOQ==", "bodyText": "add your username to the TODO", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r457853409", "createdAt": "2020-07-21T05:54:46Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/jxbrowser/JxBrowserManager.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.jxbrowser;\n+\n+import com.intellij.openapi.application.PathManager;\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.progress.impl.BackgroundableProcessIndicator;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.util.Pair;\n+import com.intellij.util.containers.ContainerUtil;\n+import com.intellij.util.download.DownloadableFileDescription;\n+import com.intellij.util.download.DownloadableFileService;\n+import com.intellij.util.download.FileDownloader;\n+import com.intellij.util.lang.UrlClassLoader;\n+import io.flutter.utils.JxBrowserUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+enum JxBrowserStatus {\n+  NOT_INSTALLED,\n+  INSTALLATION_IN_PROGRESS,\n+  INSTALLED,\n+  INSTALLATION_FAILED,\n+}\n+\n+// JxBrowser provides Chromium to display web pages within IntelliJ. This class manages downloading the required files and adding them to\n+// the class path.\n+public class JxBrowserManager {\n+  private static JxBrowserManager manager;\n+  private static final String DOWNLOAD_PATH = PathManager.getPluginsPath() + File.separatorChar + \"flutter-intellij\" + File.separatorChar + \"jxbrowser\";\n+  private static final AtomicReference<JxBrowserStatus> status = new AtomicReference<>(JxBrowserStatus.NOT_INSTALLED);\n+  private static final Logger LOG = Logger.getInstance(JxBrowserManager.class);\n+  // We will be gating JxBrowser features until all of the features are landed.\n+  // To test JxBrowser, set this to true and also add license key to VM options (-Djxbrowser.license.key=<key>).\n+  public static final boolean ENABLE_JX_BROWSER = false;\n+\n+  private JxBrowserManager() {}\n+\n+  public static JxBrowserManager getInstance() {\n+    if (manager == null) {\n+      return new JxBrowserManager();\n+    }\n+    return manager;\n+  }\n+\n+  public boolean isInstalled() {\n+    return status.get().equals(JxBrowserStatus.INSTALLED);\n+  }\n+\n+  public void setUp(Project project) {\n+    if (!status.compareAndSet(JxBrowserStatus.NOT_INSTALLED, JxBrowserStatus.INSTALLATION_IN_PROGRESS)) {\n+      // This check ensures that an IDE only downloads and installs JxBrowser once, even if multiple projects are open.\n+      // If already in progress, let calling point wait until success or failure (it may make sense to call setUp but proceed).\n+      // If already succeeded or failed, no need to continue.\n+      return;\n+    }\n+\n+    LOG.info(project.getName() + \": Installing JxBrowser\");\n+\n+    final File directory = new File(DOWNLOAD_PATH);\n+    if (!directory.exists()) {\n+      if (!directory.mkdirs()) {\n+        LOG.info(project.getName() + \": Unable to create directory for JxBrowser files\");\n+        status.set(JxBrowserStatus.INSTALLATION_FAILED);\n+        return;\n+      }\n+    }\n+\n+    // Check whether the files already exist.\n+    final String[] fileNames = {JxBrowserUtils.getPlatformFileName(), JxBrowserUtils.getApiFileName(), JxBrowserUtils.getSwingFileName()};\n+    boolean allDownloaded = true;\n+    final List<File> files = new ArrayList<>();\n+    for (String fileName : fileNames) {\n+      final File file = new File(DOWNLOAD_PATH + File.separator + fileName);\n+      files.add(file);\n+      if (!file.exists()) {\n+        allDownloaded = false;\n+      }\n+    }\n+\n+    if (allDownloaded) {\n+      LOG.info(project.getName() + \": JxBrowser platform file already exists, skipping download\");\n+      loadClasses(files);\n+      return;\n+    }\n+\n+    // Delete any already existing files.\n+    // TODO: Handle if files cannot be deleted.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMTQ2MDc3", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-452146077", "createdAt": "2020-07-21T05:56:21Z", "commit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1NjoyMVrOG0pMLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1NjoyMVrOG0pMLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1Mzk5OQ==", "bodyText": "what exception are you expecting? should we delete the cached browser files in this case?", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r457853999", "createdAt": "2020-07-21T05:56:21Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/jxbrowser/JxBrowserManager.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.jxbrowser;\n+\n+import com.intellij.openapi.application.PathManager;\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.progress.impl.BackgroundableProcessIndicator;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.util.Pair;\n+import com.intellij.util.containers.ContainerUtil;\n+import com.intellij.util.download.DownloadableFileDescription;\n+import com.intellij.util.download.DownloadableFileService;\n+import com.intellij.util.download.FileDownloader;\n+import com.intellij.util.lang.UrlClassLoader;\n+import io.flutter.utils.JxBrowserUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+enum JxBrowserStatus {\n+  NOT_INSTALLED,\n+  INSTALLATION_IN_PROGRESS,\n+  INSTALLED,\n+  INSTALLATION_FAILED,\n+}\n+\n+// JxBrowser provides Chromium to display web pages within IntelliJ. This class manages downloading the required files and adding them to\n+// the class path.\n+public class JxBrowserManager {\n+  private static JxBrowserManager manager;\n+  private static final String DOWNLOAD_PATH = PathManager.getPluginsPath() + File.separatorChar + \"flutter-intellij\" + File.separatorChar + \"jxbrowser\";\n+  private static final AtomicReference<JxBrowserStatus> status = new AtomicReference<>(JxBrowserStatus.NOT_INSTALLED);\n+  private static final Logger LOG = Logger.getInstance(JxBrowserManager.class);\n+  // We will be gating JxBrowser features until all of the features are landed.\n+  // To test JxBrowser, set this to true and also add license key to VM options (-Djxbrowser.license.key=<key>).\n+  public static final boolean ENABLE_JX_BROWSER = false;\n+\n+  private JxBrowserManager() {}\n+\n+  public static JxBrowserManager getInstance() {\n+    if (manager == null) {\n+      return new JxBrowserManager();\n+    }\n+    return manager;\n+  }\n+\n+  public boolean isInstalled() {\n+    return status.get().equals(JxBrowserStatus.INSTALLED);\n+  }\n+\n+  public void setUp(Project project) {\n+    if (!status.compareAndSet(JxBrowserStatus.NOT_INSTALLED, JxBrowserStatus.INSTALLATION_IN_PROGRESS)) {\n+      // This check ensures that an IDE only downloads and installs JxBrowser once, even if multiple projects are open.\n+      // If already in progress, let calling point wait until success or failure (it may make sense to call setUp but proceed).\n+      // If already succeeded or failed, no need to continue.\n+      return;\n+    }\n+\n+    LOG.info(project.getName() + \": Installing JxBrowser\");\n+\n+    final File directory = new File(DOWNLOAD_PATH);\n+    if (!directory.exists()) {\n+      if (!directory.mkdirs()) {\n+        LOG.info(project.getName() + \": Unable to create directory for JxBrowser files\");\n+        status.set(JxBrowserStatus.INSTALLATION_FAILED);\n+        return;\n+      }\n+    }\n+\n+    // Check whether the files already exist.\n+    final String[] fileNames = {JxBrowserUtils.getPlatformFileName(), JxBrowserUtils.getApiFileName(), JxBrowserUtils.getSwingFileName()};\n+    boolean allDownloaded = true;\n+    final List<File> files = new ArrayList<>();\n+    for (String fileName : fileNames) {\n+      final File file = new File(DOWNLOAD_PATH + File.separator + fileName);\n+      files.add(file);\n+      if (!file.exists()) {\n+        allDownloaded = false;\n+      }\n+    }\n+\n+    if (allDownloaded) {\n+      LOG.info(project.getName() + \": JxBrowser platform file already exists, skipping download\");\n+      loadClasses(files);\n+      return;\n+    }\n+\n+    // Delete any already existing files.\n+    // TODO: Handle if files cannot be deleted.\n+    for (File file : files) {\n+      if (file.exists()) {\n+        if (!file.delete()) {\n+          LOG.info(project.getName() + \": Existing file could not be deleted - \" + file.getAbsolutePath());\n+        }\n+      }\n+    }\n+\n+    downloadJxBrowser(project, fileNames);\n+  }\n+\n+  private void downloadJxBrowser(Project project, String[] fileNames) {\n+    // The FileDownloader API is used by other plugins - e.g.\n+    // https://github.com/JetBrains/intellij-community/blob/b09f8151e0d189d70363266c3bb6edb5f6bfeca4/plugins/markdown/src/org/intellij/plugins/markdown/ui/preview/javafx/JavaFXInstallator.java#L48\n+    final List<FileDownloader> fileDownloaders = new ArrayList<>();\n+    final DownloadableFileService service = DownloadableFileService.getInstance();\n+    for (String fileName : fileNames) {\n+      final DownloadableFileDescription\n+        description = service.createFileDescription(JxBrowserUtils.getDistributionLink(fileName), fileName);\n+      fileDownloaders.add(service.createDownloader(Collections.singletonList(description), fileName));\n+    }\n+\n+    final Task.Backgroundable task = new Task.Backgroundable(project, \"Downloading jxbrowser\") {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        String currentFileName = null;\n+        try {\n+          final List<File> files = new ArrayList<>();\n+          for (int i = 0; i < fileDownloaders.size(); i++) {\n+            final FileDownloader downloader = fileDownloaders.get(i);\n+            currentFileName = fileNames[i];\n+            final Pair<File, DownloadableFileDescription> download =\n+              ContainerUtil.getFirstItem(downloader.download(new File(DOWNLOAD_PATH)));\n+            final File file = download != null ? download.first : null;\n+            if (file != null) {\n+              files.add(file);\n+              LOG.info(project.getName() + \": JxBrowser file downloaded: \" + file.getAbsolutePath());\n+            }\n+          }\n+\n+          loadClasses(files);\n+        }\n+        catch (IOException e) {\n+          LOG.info(project.getName() + \": JxBrowser file downloaded failed: \" + currentFileName);\n+          e.printStackTrace();\n+          status.set(JxBrowserStatus.INSTALLATION_FAILED);\n+        }\n+      }\n+    };\n+    BackgroundableProcessIndicator processIndicator = new BackgroundableProcessIndicator(task);\n+    processIndicator.setIndeterminate(false);\n+    ProgressManager.getInstance().runProcessWithProgressAsynchronously(task, processIndicator);\n+  }\n+\n+  private void loadClasses(List<File> files) {\n+    final UrlClassLoader classLoader = (UrlClassLoader) this.getClass().getClassLoader();\n+    try {\n+      for (File file : files) {\n+        final URL url = file.toURI().toURL();\n+        classLoader.addURL(url);\n+        LOG.info(\"Loaded JxBrowser file successfully: \" + url.toString());\n+      }\n+\n+      status.set(JxBrowserStatus.INSTALLED);\n+    }\n+    catch (Exception e) {\n+      LOG.info(\"Failed to load JxBrowser files\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "originalPosition": 168}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMTQ2NTc2", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-452146576", "createdAt": "2020-07-21T05:57:35Z", "commit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1NzozNVrOG0pN0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1NzozNVrOG0pN0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1NDQxNw==", "bodyText": "are we catching this exception? It would be nice to just fail gracefully if a platform we don't support is used.", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r457854417", "createdAt": "2020-07-21T05:57:35Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/utils/JxBrowserUtils.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.utils;\n+\n+import com.intellij.openapi.util.SystemInfo;\n+\n+public class JxBrowserUtils {\n+  private static final String JXBROWSER_FILE_PREFIX = \"jxbrowser\";\n+  private static final String JXBROWSER_FILE_VERSION = \"7.8\";\n+  private static final String JXBROWSER_FILE_SUFFIX = \"jar\";\n+\n+  public static String getPlatformFileName() {\n+    String name = \"\";\n+    if (SystemInfo.isMac) {\n+      name = \"mac\";\n+    } else if (SystemInfo.isWindows) {\n+      if (SystemInfo.is32Bit) {\n+        name = \"win32\";\n+      } else if (SystemInfo.is64Bit) {\n+        name = \"win64\";\n+      }\n+    } else if (SystemInfo.isLinux && SystemInfo.is64Bit) {\n+      name = \"linux64\";\n+    }\n+\n+    if (name.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMTQ2NzM5", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-452146739", "createdAt": "2020-07-21T05:58:01Z", "commit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1ODowMVrOG0pOWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNTo1ODowMVrOG0pOWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1NDU1NQ==", "bodyText": "should this be removed?", "url": "https://github.com/flutter/flutter-intellij/pull/4664#discussion_r457854555", "createdAt": "2020-07-21T05:58:01Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/utils/JxBrowserUtils.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.utils;\n+\n+import com.intellij.openapi.util.SystemInfo;\n+\n+public class JxBrowserUtils {\n+  private static final String JXBROWSER_FILE_PREFIX = \"jxbrowser\";\n+  private static final String JXBROWSER_FILE_VERSION = \"7.8\";\n+  private static final String JXBROWSER_FILE_SUFFIX = \"jar\";\n+\n+  public static String getPlatformFileName() {\n+    String name = \"\";\n+    if (SystemInfo.isMac) {\n+      name = \"mac\";\n+    } else if (SystemInfo.isWindows) {\n+      if (SystemInfo.is32Bit) {\n+        name = \"win32\";\n+      } else if (SystemInfo.is64Bit) {\n+        name = \"win64\";\n+      }\n+    } else if (SystemInfo.isLinux && SystemInfo.is64Bit) {\n+      name = \"linux64\";\n+    }\n+\n+    if (name.isEmpty()) {\n+      throw new UnsupportedOperationException(\"Unable to find matching JxBrowser platform file for: \" + SystemInfo.getOsNameAndVersion());\n+    }\n+\n+    return String.format(\"%s-%s-%s.%s\", JXBROWSER_FILE_PREFIX, name, JXBROWSER_FILE_VERSION, JXBROWSER_FILE_SUFFIX);\n+  }\n+\n+  public static String getApiFileName() {\n+    return String.format(\"%s-%s.%s\", JXBROWSER_FILE_PREFIX, JXBROWSER_FILE_VERSION, JXBROWSER_FILE_SUFFIX);\n+  }\n+\n+  public static String getSwingFileName() {\n+    return String.format(\"%s-swing-%s.%s\", JXBROWSER_FILE_PREFIX, JXBROWSER_FILE_VERSION, JXBROWSER_FILE_SUFFIX);\n+  }\n+\n+  public static String getLoadingFileName() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMTQ3NTg4", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-452147588", "createdAt": "2020-07-21T06:00:08Z", "commit": {"oid": "2d861cb1377e9f281b69ae35c92d4df32d21b95d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f26225b0f70bfb66e880c20f3b28c0dadca19109", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/f26225b0f70bfb66e880c20f3b28c0dadca19109", "committedDate": "2020-07-21T17:05:15Z", "message": "Address comments in jxbrowser manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "899c7705223c0d2e1653abee65a09557169a56c3", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/899c7705223c0d2e1653abee65a09557169a56c3", "committedDate": "2020-07-21T17:29:18Z", "message": "Remove unneeded code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2512ab309779e9acd821fc0c11785f5a187c3369", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/2512ab309779e9acd821fc0c11785f5a187c3369", "committedDate": "2020-07-21T17:43:42Z", "message": "Remove print stack trace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNzAwMDM3", "url": "https://github.com/flutter/flutter-intellij/pull/4664#pullrequestreview-452700037", "createdAt": "2020-07-21T17:57:53Z", "commit": {"oid": "899c7705223c0d2e1653abee65a09557169a56c3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3130, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}