{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMjk3NTc2", "number": 4733, "title": "Use daemon API to get devtools host and port for internal use", "bodyText": "Instead of building and serving devtools independently, we want to make a request to flutter daemon to start serving devtools which should already be built.\nThis change requires flutter/flutter#62702 to be merged internally.", "createdAt": "2020-08-03T17:14:39Z", "url": "https://github.com/flutter/flutter-intellij/pull/4733", "merged": true, "mergeCommit": {"oid": "dcc6c5c01400423c3175f8a6de85082cb26619e8"}, "closed": true, "closedAt": "2020-08-20T22:42:35Z", "author": {"login": "helin24"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAdPpDAH2gAyNDYyMjk3NTc2OmE3NjNjODIxYjJkYWI0ZTMzNDM3NjE0YTBiZDk3Mjg2NjYwYTU3YWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA3vo_gH2gAyNDYyMjk3NTc2Ojg0YzYzMGZhMWI3MWI1M2RjNGY2YWVhMTMwNDljYmZlZjg3ZDlkM2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a763c821b2dab4e33437614a0bd97286660a57ad", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/a763c821b2dab4e33437614a0bd97286660a57ad", "committedDate": "2020-08-19T15:21:34Z", "message": "Use daemon API to start devtools internally WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfcc3ba9fda45ac228ae193b01e10b55e33e8384", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/cfcc3ba9fda45ac228ae193b01e10b55e33e8384", "committedDate": "2020-08-19T15:21:34Z", "message": "Create new DevToolsInstance from result"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cabfbf1f64b3c875a515f121147faf5d8eb1a7c", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/5cabfbf1f64b3c875a515f121147faf5d8eb1a7c", "committedDate": "2020-08-19T15:21:34Z", "message": "Remove changes to getProcessHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5140bae3f1b296b53e1ce8c35ebc9e8a55250ab9", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/5140bae3f1b296b53e1ce8c35ebc9e8a55250ab9", "committedDate": "2020-08-19T15:21:34Z", "message": "Remove comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afc8722ec879fc24afb8731dbfe285c97673b9bb", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/afc8722ec879fc24afb8731dbfe285c97673b9bb", "committedDate": "2020-08-19T15:21:34Z", "message": "Use isPresent check instead of isEmpty"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e765661ad344a69903108de2b10b2fb0d2167cf", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/6e765661ad344a69903108de2b10b2fb0d2167cf", "committedDate": "2020-08-03T18:04:12Z", "message": "Remove return that causes error"}, "afterCommit": {"oid": "afc8722ec879fc24afb8731dbfe285c97673b9bb", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/afc8722ec879fc24afb8731dbfe285c97673b9bb", "committedDate": "2020-08-19T15:21:34Z", "message": "Use isPresent check instead of isEmpty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d701273bf35830e62db0d94ebb9643c0e2de3355", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/d701273bf35830e62db0d94ebb9643c0e2de3355", "committedDate": "2020-08-19T15:31:20Z", "message": "Handle if devtools host and port are null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNzgzNjE2", "url": "https://github.com/flutter/flutter-intellij/pull/4733#pullrequestreview-471783616", "createdAt": "2020-08-20T16:25:49Z", "commit": {"oid": "d701273bf35830e62db0d94ebb9643c0e2de3355"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjoyNTo0OVrOHEJfyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjoyNTo0OVrOHEJfyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDExMTk0Ng==", "bodyText": "comment why we do this for Bazel only for now (non-bazel projects currently have a flutter daemon with an older version of devtools).", "url": "https://github.com/flutter/flutter-intellij/pull/4733#discussion_r474111946", "createdAt": "2020-08-20T16:25:49Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -259,26 +260,47 @@ private void openBrowserImpl(String uri, String screen) {\n       devToolsInstance.openBrowserAndConnect(uri, screen);\n     }\n     else {\n-      @Nullable final OSProcessHandler handler =\n-        isBazel(project) ? getProcessHandlerForBazel() : getProcessHandlerForPub();\n+      if (isBazel(project)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d701273bf35830e62db0d94ebb9643c0e2de3355"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "794ae358c34c8132beee9c38292dba01d7e45473", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/794ae358c34c8132beee9c38292dba01d7e45473", "committedDate": "2020-08-20T17:54:12Z", "message": "Add comment explaining why only bazel projects uses daemon"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODc0MTI2", "url": "https://github.com/flutter/flutter-intellij/pull/4733#pullrequestreview-471874126", "createdAt": "2020-08-20T18:24:57Z", "commit": {"oid": "794ae358c34c8132beee9c38292dba01d7e45473"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoyNDo1OFrOHEN_yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoyNDo1OFrOHEN_yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NTY3NA==", "bodyText": "should we report an error here? We weren't able to open devtools as the app closed.", "url": "https://github.com/flutter/flutter-intellij/pull/4733#discussion_r474185674", "createdAt": "2020-08-20T18:24:58Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -259,26 +260,49 @@ private void openBrowserImpl(String uri, String screen) {\n       devToolsInstance.openBrowserAndConnect(uri, screen);\n     }\n     else {\n-      @Nullable final OSProcessHandler handler =\n-        isBazel(project) ? getProcessHandlerForBazel() : getProcessHandlerForPub();\n-\n-      if (handler != null) {\n-        // TODO(devoncarew) Add a Task.Backgroundable here; \"Starting devtools...\"\n-\n-        // start the server\n-        DevToolsInstance.startServer(handler, instance -> {\n-          devToolsInstance = instance;\n+      // For internal users, we can connect to the DevTools server started by flutter daemon. For external users, the flutter daemon has an\n+      // older version of DevTools, so we launch the server using `pub global run` instead.\n+      if (isBazel(project)) {\n+        final Optional<FlutterApp> first =\n+          FlutterApp.allFromProjectProcess(project).stream().filter((FlutterApp app) -> app.getProject() == project).findFirst();\n+\n+        if (!first.isPresent()) {\n+          return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "794ae358c34c8132beee9c38292dba01d7e45473"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODc0NzAz", "url": "https://github.com/flutter/flutter-intellij/pull/4733#pullrequestreview-471874703", "createdAt": "2020-08-20T18:25:47Z", "commit": {"oid": "794ae358c34c8132beee9c38292dba01d7e45473"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoyNTo0OFrOHEOBqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoyNTo0OFrOHEOBqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NjE1Mg==", "bodyText": "at each async boundary we probably need to make sure the project hasn't been closed in whcih case we should quietly cancel the request.", "url": "https://github.com/flutter/flutter-intellij/pull/4733#discussion_r474186152", "createdAt": "2020-08-20T18:25:48Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -259,26 +260,49 @@ private void openBrowserImpl(String uri, String screen) {\n       devToolsInstance.openBrowserAndConnect(uri, screen);\n     }\n     else {\n-      @Nullable final OSProcessHandler handler =\n-        isBazel(project) ? getProcessHandlerForBazel() : getProcessHandlerForPub();\n-\n-      if (handler != null) {\n-        // TODO(devoncarew) Add a Task.Backgroundable here; \"Starting devtools...\"\n-\n-        // start the server\n-        DevToolsInstance.startServer(handler, instance -> {\n-          devToolsInstance = instance;\n+      // For internal users, we can connect to the DevTools server started by flutter daemon. For external users, the flutter daemon has an\n+      // older version of DevTools, so we launch the server using `pub global run` instead.\n+      if (isBazel(project)) {\n+        final Optional<FlutterApp> first =\n+          FlutterApp.allFromProjectProcess(project).stream().filter((FlutterApp app) -> app.getProject() == project).findFirst();\n+\n+        if (!first.isPresent()) {\n+          return;\n+        }\n \n-          devToolsInstance.openBrowserAndConnect(uri, screen);\n-        }, () -> {\n-          // Listen for closing; null out the devToolsInstance.\n-          devToolsInstance = null;\n+        first.get().serveDevTools().thenAccept((Pair<String, Integer> hostAndPort) -> {\n+          if (hostAndPort == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "794ae358c34c8132beee9c38292dba01d7e45473"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODc1NTY3", "url": "https://github.com/flutter/flutter-intellij/pull/4733#pullrequestreview-471875567", "createdAt": "2020-08-20T18:26:57Z", "commit": {"oid": "794ae358c34c8132beee9c38292dba01d7e45473"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoyNjo1N1rOHEOEVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoyNjo1N1rOHEOEVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NjgzOQ==", "bodyText": "use your username for new TODOs", "url": "https://github.com/flutter/flutter-intellij/pull/4733#discussion_r474186839", "createdAt": "2020-08-20T18:26:57Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -259,26 +260,49 @@ private void openBrowserImpl(String uri, String screen) {\n       devToolsInstance.openBrowserAndConnect(uri, screen);\n     }\n     else {\n-      @Nullable final OSProcessHandler handler =\n-        isBazel(project) ? getProcessHandlerForBazel() : getProcessHandlerForPub();\n-\n-      if (handler != null) {\n-        // TODO(devoncarew) Add a Task.Backgroundable here; \"Starting devtools...\"\n-\n-        // start the server\n-        DevToolsInstance.startServer(handler, instance -> {\n-          devToolsInstance = instance;\n+      // For internal users, we can connect to the DevTools server started by flutter daemon. For external users, the flutter daemon has an\n+      // older version of DevTools, so we launch the server using `pub global run` instead.\n+      if (isBazel(project)) {\n+        final Optional<FlutterApp> first =\n+          FlutterApp.allFromProjectProcess(project).stream().filter((FlutterApp app) -> app.getProject() == project).findFirst();\n+\n+        if (!first.isPresent()) {\n+          return;\n+        }\n \n-          devToolsInstance.openBrowserAndConnect(uri, screen);\n-        }, () -> {\n-          // Listen for closing; null out the devToolsInstance.\n-          devToolsInstance = null;\n+        first.get().serveDevTools().thenAccept((Pair<String, Integer> hostAndPort) -> {\n+          if (hostAndPort == null) {\n+            @Nullable final OSProcessHandler handler = getProcessHandlerForBazel();\n+            startDevToolsServerAndConnect(handler, uri, screen);\n+          } else {\n+            devToolsInstance = new DevToolsInstance(hostAndPort.first, hostAndPort.second);\n+            devToolsInstance.openBrowserAndConnect(uri, screen);\n+          }\n         });\n+      } else {\n+        @Nullable final OSProcessHandler handler = getProcessHandlerForPub();\n+        startDevToolsServerAndConnect(handler, uri, screen);\n       }\n-      else {\n-        // TODO(devoncarew): We should provide feedback to callers that the open browser call failed.\n+    }\n+  }\n+\n+  private void startDevToolsServerAndConnect(OSProcessHandler handler, String uri, String screen) {\n+    if (handler != null) {\n+      // TODO(devoncarew) Add a Task.Backgroundable here; \"Starting devtools...\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "794ae358c34c8132beee9c38292dba01d7e45473"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODc3NzQz", "url": "https://github.com/flutter/flutter-intellij/pull/4733#pullrequestreview-471877743", "createdAt": "2020-08-20T18:29:54Z", "commit": {"oid": "794ae358c34c8132beee9c38292dba01d7e45473"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoyOTo1NFrOHEOK8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoyOTo1NFrOHEOK8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4ODUzMA==", "bodyText": "nit: create a little Value class for this instead of using Pair.\nWith Pair it isn't obvious what the two fields are but it would be really obvious with a simple data class with a host and port field.", "url": "https://github.com/flutter/flutter-intellij/pull/4733#discussion_r474188530", "createdAt": "2020-08-20T18:29:54Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/run/daemon/DaemonApi.java", "diffHunk": "@@ -80,6 +81,10 @@\n     return send(\"app.stop\", new AppStop(appId));\n   }\n \n+  CompletableFuture<Pair<String, Integer>> devToolsServe() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "794ae358c34c8132beee9c38292dba01d7e45473"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODc3ODUz", "url": "https://github.com/flutter/flutter-intellij/pull/4733#pullrequestreview-471877853", "createdAt": "2020-08-20T18:30:03Z", "commit": {"oid": "794ae358c34c8132beee9c38292dba01d7e45473"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f19ca33b270c26287342e4b5f03a323c6c995e93", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/f19ca33b270c26287342e4b5f03a323c6c995e93", "committedDate": "2020-08-20T21:01:13Z", "message": "Use value class for address and add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMDAxMTQw", "url": "https://github.com/flutter/flutter-intellij/pull/4733#pullrequestreview-472001140", "createdAt": "2020-08-20T21:32:49Z", "commit": {"oid": "f19ca33b270c26287342e4b5f03a323c6c995e93"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84c630fa1b71b53dc4f6aea13049cbfef87d9d3b", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/84c630fa1b71b53dc4f6aea13049cbfef87d9d3b", "committedDate": "2020-08-20T22:14:03Z", "message": "Remove check for app connection since DevTools can handle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3162, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}