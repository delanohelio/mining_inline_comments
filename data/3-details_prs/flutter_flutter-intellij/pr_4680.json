{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyOTg3NTk4", "number": 4680, "title": "Flutter news", "bodyText": "See #4658 for full description.\nThe action that would display the news panel is currently disabled. Once we get real content we can re-enable it.", "createdAt": "2020-07-01T21:01:42Z", "url": "https://github.com/flutter/flutter-intellij/pull/4680", "merged": true, "mergeCommit": {"oid": "5e91382ae14662a2567fa81edb12781110639d39"}, "closed": true, "closedAt": "2020-07-06T21:15:22Z", "author": {"login": "stevemessick"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwwRV9AH2gAyNDQyOTg3NTk4OmE3ODk0NzAxZTFhODkzZGQxYmIzNzFhMmM1ODUwM2E5NzNlZmZkNzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyXzkFAH2gAyNDQyOTg3NTk4OjRhMzdiNzc5ZjIwMjgyNTI5ZGQ1NjIzZjZkZjI5NmE0ZjY2OTNkY2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7894701e1a893dd1bb371a2c58503a973effd76", "author": {"user": {"login": "stevemessick", "name": null}}, "url": "https://github.com/flutter/flutter-intellij/commit/a7894701e1a893dd1bb371a2c58503a973effd76", "committedDate": "2020-07-01T20:28:50Z", "message": "Android hacks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8efd52115efffda466af95d015b4508ff64b006c", "author": {"user": {"login": "stevemessick", "name": null}}, "url": "https://github.com/flutter/flutter-intellij/commit/8efd52115efffda466af95d015b4508ff64b006c", "committedDate": "2020-07-01T20:28:50Z", "message": "Add Flutter News panel for release notes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f88f32f085ec8fccc169b42de80ad3c015d8477", "author": {"user": {"login": "stevemessick", "name": null}}, "url": "https://github.com/flutter/flutter-intellij/commit/5f88f32f085ec8fccc169b42de80ad3c015d8477", "committedDate": "2020-07-01T20:54:26Z", "message": "Clean up for review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjIxMDk4", "url": "https://github.com/flutter/flutter-intellij/pull/4680#pullrequestreview-441221098", "createdAt": "2020-07-01T21:54:16Z", "commit": {"oid": "5f88f32f085ec8fccc169b42de80ad3c015d8477"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo1NDoxN1rOGr2lcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo1NDoxN1rOGr2lcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNjI3Mg==", "bodyText": "Is the argument toolWindowManager the same as what's retrieved here?", "url": "https://github.com/flutter/flutter-intellij/pull/4680#discussion_r448636272", "createdAt": "2020-07-01T21:54:17Z", "author": {"login": "helin24"}, "path": "src/io/flutter/actions/OpenFlutterNewsSidePanelAction.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Copyright 2020 The Chromium Authors. All rights reserved.\n+ * Use of this source code is governed by a BSD-style license that can be\n+ * found in the LICENSE file.\n+ */\n+package io.flutter.actions;\n+\n+import com.android.tools.idea.assistant.AssistantBundleCreator;\n+import com.android.tools.idea.assistant.OpenAssistSidePanelAction;\n+import com.intellij.ide.actions.WhatsNewAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.actionSystem.Presentation;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.project.ProjectManager;\n+import com.intellij.openapi.project.ProjectManagerListener;\n+import com.intellij.openapi.wm.ToolWindow;\n+import com.intellij.openapi.wm.ToolWindowManager;\n+import com.intellij.openapi.wm.ex.ToolWindowManagerListener;\n+import io.flutter.FlutterInitializer;\n+import io.flutter.assistant.whatsnew.FlutterNewsBundleCreator;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Set;\n+import org.jetbrains.annotations.NotNull;\n+\n+// Adapted from com.android.tools.idea.whatsnew.assistant.WhatsNewSidePanelAction.\n+public class OpenFlutterNewsSidePanelAction extends OpenAssistSidePanelAction {\n+  @NotNull\n+  private static final WhatsNewAction action = new WhatsNewAction();\n+  @NotNull\n+  private static final Set<Project> openProjectTools = new HashSet<>();\n+\n+  @NotNull\n+  private final Map<Project, FlutterNewsToolWindowListener> myProjectToListenerMap;\n+\n+  public OpenFlutterNewsSidePanelAction() {\n+    myProjectToListenerMap = new HashMap<>();\n+  }\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    // Project being null can happen when Studio first starts and doesn't have window focus\n+    Presentation presentation = e.getPresentation();\n+    if (e.getProject() == null) {\n+      presentation.setEnabled(false);\n+    }\n+    else if (!presentation.isEnabled()) {\n+      presentation.setEnabled(true);\n+    }\n+\n+    action.update(e);\n+    presentation.setText(\"What's New in Flutter\");\n+    presentation.setDescription(\"See the recent updates to Flutter and the plugin.\");\n+  }\n+\n+  @Override\n+  public void actionPerformed(@NotNull AnActionEvent event) {\n+    openWhatsNewSidePanel(Objects.requireNonNull(event.getProject()), false);\n+  }\n+\n+  public void openWhatsNewSidePanel(@NotNull Project project, boolean isAutoOpened) {\n+    FlutterNewsBundleCreator bundleCreator = AssistantBundleCreator.EP_NAME.findExtension(FlutterNewsBundleCreator.class);\n+    if (bundleCreator == null) {\n+      return;\n+    }\n+\n+    FlutterNewsToolWindowListener.fireOpenEvent(project, isAutoOpened);\n+    openWindow(FlutterNewsBundleCreator.BUNDLE_ID, project);\n+\n+    // Only register a new listener if there isn't already one, to avoid multiple OPEN/CLOSE events\n+    myProjectToListenerMap.computeIfAbsent(project, this::newFlutterNewsToolWindowListener);\n+  }\n+\n+  @NotNull\n+  private OpenFlutterNewsSidePanelAction.FlutterNewsToolWindowListener newFlutterNewsToolWindowListener(@NotNull Project project) {\n+    FlutterNewsToolWindowListener listener = new FlutterNewsToolWindowListener(project, myProjectToListenerMap);\n+    project.getMessageBus().connect(project).subscribe(ToolWindowManagerListener.TOPIC, listener);\n+    return listener;\n+  }\n+\n+  static class FlutterNewsToolWindowListener implements ToolWindowManagerListener {\n+    @NotNull private final Project myProject;\n+    @NotNull Map<Project, FlutterNewsToolWindowListener> myProjectToListenerMap;\n+    private boolean isOpen;\n+\n+    private FlutterNewsToolWindowListener(@NotNull Project project,\n+                                          @NotNull Map<Project, FlutterNewsToolWindowListener> projectToListenerMap) {\n+      myProject = project;\n+      myProjectToListenerMap = projectToListenerMap;\n+      isOpen = true; // Start off as opened so we don't fire an extra opened event\n+\n+      // Need an additional listener for project close, because the below invokeLater isn't fired in time before closing\n+      project.getMessageBus().connect(project).subscribe(ProjectManager.TOPIC, new ProjectManagerListener() {\n+        @Override\n+        public void projectClosed(@NotNull Project project) {\n+          if (!project.equals(myProject)) {\n+            return;\n+          }\n+          if (isOpen) {\n+            fireClosedEvent(myProject);\n+            isOpen = false;\n+          }\n+          myProjectToListenerMap.remove(project);\n+        }\n+      });\n+    }\n+\n+    @Override\n+    public void toolWindowRegistered(@NotNull String id) {\n+    }\n+\n+    @Override\n+    public void toolWindowUnregistered(@NotNull String id, @NotNull ToolWindow toolWindow) {\n+      if (id.equals(OpenAssistSidePanelAction.TOOL_WINDOW_TITLE)) {\n+        myProjectToListenerMap.remove(myProject);\n+      }\n+    }\n+\n+    /**\n+     * Fire metrics and update the actual state after a state change is received.\n+     * The logic is wrapped in invokeLater because dragging and dropping the StripeButton temporarily\n+     * hides and then shows the window. Otherwise, the handler would think the window was closed,\n+     * even though it was only dragged.\n+     */\n+    @Override\n+    public void stateChanged(@NotNull ToolWindowManager toolWindowManager) {\n+      ApplicationManager.getApplication().invokeLater(() -> {\n+        if (myProject.isDisposed()) {\n+          myProjectToListenerMap.remove(myProject);\n+          return;\n+        }\n+\n+        ToolWindow window = ToolWindowManager.getInstance(myProject).getToolWindow(OpenAssistSidePanelAction.TOOL_WINDOW_TITLE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f88f32f085ec8fccc169b42de80ad3c015d8477"}, "originalPosition": 136}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a37b779f20282529dd5623f6df296a4f6693dcd", "author": {"user": {"login": "stevemessick", "name": null}}, "url": "https://github.com/flutter/flutter-intellij/commit/4a37b779f20282529dd5623f6df296a4f6693dcd", "committedDate": "2020-07-06T21:06:26Z", "message": "Move to flutter-studio"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3139, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}