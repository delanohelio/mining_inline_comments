{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNTY5ODQx", "number": 5085, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1OToxMVrOE_w95w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowOTozMlrOE_xOUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1Mjk4MDIzOnYy", "diffSide": "RIGHT", "path": "src/io/flutter/devtools/DevToolsManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1OToxMVrOH9ptsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1OToxMVrOH9ptsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwODYyNQ==", "bodyText": "make sure project is still valid as soon as you get here.", "url": "https://github.com/flutter/flutter-intellij/pull/5085#discussion_r534408625", "createdAt": "2020-12-02T18:59:11Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -187,58 +187,62 @@ private boolean isBazel(Project project) {\n   }\n \n   public void openBrowserIntoPanel(FlutterApp app, String uri, ContentManager contentManager, String tabName, String pageName) {\n-    final String screen = null;\n+    ApplicationManager.getApplication().executeOnPooledThread(() -> {\n+      final String screen = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1Mjk4MjAwOnYy", "diffSide": "RIGHT", "path": "src/io/flutter/devtools/DevToolsManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1OTozN1rOH9puwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1OTozN1rOH9puwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwODg5OA==", "bodyText": "make sure project is still valid after waiting.", "url": "https://github.com/flutter/flutter-intellij/pull/5085#discussion_r534408898", "createdAt": "2020-12-02T18:59:37Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -187,58 +187,62 @@ private boolean isBazel(Project project) {\n   }\n \n   public void openBrowserIntoPanel(FlutterApp app, String uri, ContentManager contentManager, String tabName, String pageName) {\n-    final String screen = null;\n+    ApplicationManager.getApplication().executeOnPooledThread(() -> {\n+      final String screen = null;\n \n-    if (isBazel(project)) {\n-      try {\n-        getDevToolsInstance(app).get(15, TimeUnit.SECONDS).openPanel(project, uri, contentManager, tabName, pageName);\n-      }\n-      catch (Exception e) {\n-        LOG.info(\"Failed to get existing devToolsInstance\");\n-      }\n-    }\n-    else {\n-      if (devToolsInstance != null) {\n-        devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n+      if (isBazel(project)) {\n+        try {\n+          getDevToolsInstance(app).get(15, TimeUnit.SECONDS).openPanel(project, uri, contentManager, tabName, pageName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1Mjk4NTQwOnYy", "diffSide": "RIGHT", "path": "src/io/flutter/devtools/DevToolsManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowMDoxNlrOH9pwkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowMDoxNlrOH9pwkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwOTM2Mg==", "bodyText": "another time gap. Make sure the project is still valid before we open the panel.", "url": "https://github.com/flutter/flutter-intellij/pull/5085#discussion_r534409362", "createdAt": "2020-12-02T19:00:16Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -187,58 +187,62 @@ private boolean isBazel(Project project) {\n   }\n \n   public void openBrowserIntoPanel(FlutterApp app, String uri, ContentManager contentManager, String tabName, String pageName) {\n-    final String screen = null;\n+    ApplicationManager.getApplication().executeOnPooledThread(() -> {\n+      final String screen = null;\n \n-    if (isBazel(project)) {\n-      try {\n-        getDevToolsInstance(app).get(15, TimeUnit.SECONDS).openPanel(project, uri, contentManager, tabName, pageName);\n-      }\n-      catch (Exception e) {\n-        LOG.info(\"Failed to get existing devToolsInstance\");\n-      }\n-    }\n-    else {\n-      if (devToolsInstance != null) {\n-        devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n+      if (isBazel(project)) {\n+        try {\n+          getDevToolsInstance(app).get(15, TimeUnit.SECONDS).openPanel(project, uri, contentManager, tabName, pageName);\n+        }\n+        catch (Exception e) {\n+          LOG.info(\"Failed to get existing devToolsInstance\");\n+        }\n       }\n       else {\n-        @Nullable final OSProcessHandler handler = getProcessHandlerForPub();\n-\n-        if (handler != null) {\n-          // start the server\n-          DevToolsInstance.startServer(handler, instance -> {\n-            devToolsInstance = instance;\n-\n-            devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n-          }, () -> {\n-            // Listen for closing; null out the devToolsInstance.\n-            devToolsInstance = null;\n-          }, project);\n+        if (devToolsInstance != null) {\n+          devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n+        }\n+        else {\n+          @Nullable final OSProcessHandler handler = getProcessHandlerForPub();\n+\n+          if (handler != null) {\n+            // start the server\n+            DevToolsInstance.startServer(handler, instance -> {\n+              devToolsInstance = instance;\n+\n+              devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1Mjk5MjA4OnYy", "diffSide": "RIGHT", "path": "src/io/flutter/view/FlutterView.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowMTo0N1rOH9p0cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTo1ODozMVrOH9r2bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxMDM1Mg==", "bodyText": "shouldn't this method instead be asserting that we are on the UI thread? seems on to have it start on some random thread.", "url": "https://github.com/flutter/flutter-intellij/pull/5085#discussion_r534410352", "createdAt": "2020-12-02T19:01:47Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/view/FlutterView.java", "diffHunk": "@@ -430,24 +430,29 @@ private void presentDevTools(FlutterApp app, InspectorService inspectorService,\n     final DevToolsManager devToolsManager = DevToolsManager.getInstance(app.getProject());\n \n     if (devToolsManager.hasInstalledDevTools()) {\n-      addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded);\n+      AsyncUtils.invokeLater(() -> addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0MzYzMQ==", "bodyText": "Do you mean addBrowserInspectorViewContent should assert that we're on the UI thread? I can add that as well, but I think I have to use invokeLater here since presentDevTools isn't running on the UI thread.", "url": "https://github.com/flutter/flutter-intellij/pull/5085#discussion_r534443631", "createdAt": "2020-12-02T19:58:31Z", "author": {"login": "helin24"}, "path": "src/io/flutter/view/FlutterView.java", "diffHunk": "@@ -430,24 +430,29 @@ private void presentDevTools(FlutterApp app, InspectorService inspectorService,\n     final DevToolsManager devToolsManager = DevToolsManager.getInstance(app.getProject());\n \n     if (devToolsManager.hasInstalledDevTools()) {\n-      addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded);\n+      AsyncUtils.invokeLater(() -> addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxMDM1Mg=="}, "originalCommit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzAyMjI2OnYy", "diffSide": "RIGHT", "path": "src/io/flutter/view/FlutterView.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowOTozMlrOH9qGqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowOTozMlrOH9qGqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxNTAxOQ==", "bodyText": "watch out! succeeded is a Boolean so it can be null (when the throwable != null).\nThat is why I use the pattern of checking whether the throwable is null first in these callbacks to avoid bugs.\nYou could also use something like\nhttps://commons.apache.org/proper/commons-lang/javadocs/api-2.4/org/apache/commons/lang/BooleanUtils.html#isTrue(java.lang.Boolean)\nor\nif (succeeded != null && succeeded)", "url": "https://github.com/flutter/flutter-intellij/pull/5085#discussion_r534415019", "createdAt": "2020-12-02T19:09:32Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/view/FlutterView.java", "diffHunk": "@@ -430,24 +430,29 @@ private void presentDevTools(FlutterApp app, InspectorService inspectorService,\n     final DevToolsManager devToolsManager = DevToolsManager.getInstance(app.getProject());\n \n     if (devToolsManager.hasInstalledDevTools()) {\n-      addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded);\n+      AsyncUtils.invokeLater(() -> addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded));\n     }\n     else {\n       presentLabel(toolWindow, INSTALLING_DEVTOOLS_LABEL);\n-\n       final CompletableFuture<Boolean> result = devToolsManager.installDevTools();\n-      result.thenAccept(succeeded -> {\n-        if (succeeded) {\n-          addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded);\n-        }\n-        else {\n-          // TODO(helin24): Handle with alternative instructions if devtools fails.\n-          presentLabel(toolWindow, DEVTOOLS_FAILED_LABEL);\n-        }\n-      });\n+      awaitDevToolsInstall(app, inspectorService, toolWindow, isEmbedded, result);\n     }\n   }\n \n+  protected void awaitDevToolsInstall(FlutterApp app, InspectorService inspectorService, ToolWindow toolWindow, boolean isEmbedded, CompletableFuture<Boolean> installResult) {\n+    AsyncUtils.whenCompleteUiThread(installResult, (succeeded, throwable) -> {\n+      if (succeeded) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 399, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}