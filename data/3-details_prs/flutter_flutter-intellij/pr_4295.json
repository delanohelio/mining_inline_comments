{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzODQ4Njk4", "number": 4295, "title": "Switch to using WorkspaceCache", "bodyText": "Fix race condition in workspace cache and simplify WorkspaceCache to stop\ntrying to do work in the background.", "createdAt": "2020-01-16T21:14:54Z", "url": "https://github.com/flutter/flutter-intellij/pull/4295", "merged": true, "mergeCommit": {"oid": "8a80864c3008de3978e70710bdc87cb5b426b836"}, "closed": true, "closedAt": "2020-01-17T23:16:11Z", "author": {"login": "jacob314"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7CzKKgH2gAyMzYzODQ4Njk4OjEyZDY1ZDY1YjZmNzhmZGI5Y2I0NjYyNDFiN2EzYmZiNGYyZWFhZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7RmTWgFqTM0NDY5NTE0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "12d65d65b6f78fdb9cb466241b7a3bfb4f2eaad8", "author": {"user": {"login": "jacob314", "name": "Jacob Richman"}}, "url": "https://github.com/flutter/flutter-intellij/commit/12d65d65b6f78fdb9cb466241b7a3bfb4f2eaad8", "committedDate": "2020-01-16T23:32:09Z", "message": "Switch to using WorkspaceCache\n\nFix race condition in workspace cache and simplify WorkspaceCache to stop\ntrying to do work in the background."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b7609ada5fe9710b3706ead218996e84d697865", "author": {"user": {"login": "jacob314", "name": "Jacob Richman"}}, "url": "https://github.com/flutter/flutter-intellij/commit/7b7609ada5fe9710b3706ead218996e84d697865", "committedDate": "2020-01-16T21:12:08Z", "message": "Switch to using WorkspaceCache\n\nFix race condition in workspace cache and simplify WorkspaceCache to stop\ntrying to do work in the background."}, "afterCommit": {"oid": "12d65d65b6f78fdb9cb466241b7a3bfb4f2eaad8", "author": {"user": {"login": "jacob314", "name": "Jacob Richman"}}, "url": "https://github.com/flutter/flutter-intellij/commit/12d65d65b6f78fdb9cb466241b7a3bfb4f2eaad8", "committedDate": "2020-01-16T23:32:09Z", "message": "Switch to using WorkspaceCache\n\nFix race condition in workspace cache and simplify WorkspaceCache to stop\ntrying to do work in the background."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NjczNjg1", "url": "https://github.com/flutter/flutter-intellij/pull/4295#pullrequestreview-344673685", "createdAt": "2020-01-17T15:56:10Z", "commit": {"oid": "12d65d65b6f78fdb9cb466241b7a3bfb4f2eaad8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNTo1NjoxMVrOFe9a7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNTo1NjoxMVrOFe9a7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAwNzkxNg==", "bodyText": "Does this indicate to the Dart plugin that all projects are bazel projects? Or that the current one might be?\nWe should probably push some version of bazel Workspace / WorkspaceCache knowledge down to the Dart plugin; it'll then have unify behavior with the Flutter plugin and the analysis server. cc @jwren", "url": "https://github.com/flutter/flutter-intellij/pull/4295#discussion_r368007916", "createdAt": "2020-01-17T15:56:11Z", "author": {"login": "devoncarew"}, "path": "src/io/flutter/bazel/WorkspaceCache.java", "diffHunk": "@@ -64,46 +82,82 @@ public static WorkspaceCache getInstance(@NotNull final Project project) {\n    * Returns the Workspace in the cache.\n    * <p>\n    * <p>Returning a null means there is no current workspace for this project.\n-   * <p>\n-   * <p>If the cache hasn't loaded yet, blocks until it's ready.\n-   * Otherwise doesn't block.\n    */\n   @Nullable\n-  public Workspace getNow() {\n-    return cache.getNow();\n+  public Workspace get() {\n+    return cache;\n   }\n \n   /**\n-   * Waits for any refreshes to finish, then returns the new workspace (or null).\n-   *\n-   * @throws IllegalStateException if called on the Swing dispatch thread.\n+   * Returns whether the  project is a bazel project.\n    */\n-  @Nullable\n-  public Workspace getWhenReady() {\n-    return cache.getWhenReady();\n+  public boolean isBazel() {\n+    return cache != null;\n   }\n \n   /**\n    * Runs a callback each time the current Workspace changes.\n    */\n   public void subscribe(Runnable callback) {\n-    cache.subscribe(callback);\n+    synchronized (subscribers) {\n+      subscribers.add(callback);\n+    }\n   }\n \n   /**\n    * Stops notifications to a callback passed to {@link #subscribe}.\n    */\n   public void unsubscribe(Runnable callback) {\n-    cache.unsubscribe(callback);\n+    synchronized (subscribers) {\n+      subscribers.remove(callback);\n+    }\n   }\n \n   /**\n-   * Triggers a cache refresh.\n+   * The Dart plugin uses this registry key to avoid bazel users getting their settings overridden on projects that include a\n+   * pubspec.yaml.\n    * <p>\n-   * If a refresh is already in progress, schedules another one.\n+   * In other words, this key tells the plugin to configure dart projects without pubspec.yaml.\n+   */\n+  private static final String dartProjectsWithoutPubspecRegistryKey = \"dart.projects.without.pubspec\";\n+\n+  /**\n+   * Executes a cache refresh.\n    */\n-  private void refreshAsync() {\n-    cache.refresh(() -> Workspace.load(project));\n+  private void refresh() {\n+    final Workspace workspace = Workspace.loadUncached(project);\n+    if (workspace == cache) return;\n+    cache = workspace;\n+\n+    // If the current workspace is a bazel workspace, update the Dart plugin\n+    // registry key to indicate that there are dart projects without pubspec\n+    // registry keys. TODO(jacobr): it would be nice if the Dart plugin was\n+    // instead smarter about handling Bazel projects.\n+    if (cache != null) {\n+      if (!Registry.is(dartProjectsWithoutPubspecRegistryKey, false)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12d65d65b6f78fdb9cb466241b7a3bfb4f2eaad8"}, "originalPosition": 153}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0Njc1MjI5", "url": "https://github.com/flutter/flutter-intellij/pull/4295#pullrequestreview-344675229", "createdAt": "2020-01-17T15:58:17Z", "commit": {"oid": "12d65d65b6f78fdb9cb466241b7a3bfb4f2eaad8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNTo1ODoxOFrOFe9fvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNTo1ODoxOFrOFe9fvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAwOTE0OQ==", "bodyText": "I haven't looked at the parent impl, but is this method override necessary now?", "url": "https://github.com/flutter/flutter-intellij/pull/4295#discussion_r368009149", "createdAt": "2020-01-17T15:58:18Z", "author": {"login": "devoncarew"}, "path": "src/io/flutter/run/bazelTest/FlutterBazelTestLineMarkerContributor.java", "diffHunk": "@@ -23,7 +23,6 @@ public FlutterBazelTestLineMarkerContributor() {\n   @Nullable\n   @Override\n   public Info getInfo(@NotNull PsiElement element) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12d65d65b6f78fdb9cb466241b7a3bfb4f2eaad8"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0Njk1MTQ3", "url": "https://github.com/flutter/flutter-intellij/pull/4295#pullrequestreview-344695147", "createdAt": "2020-01-17T16:28:47Z", "commit": {"oid": "12d65d65b6f78fdb9cb466241b7a3bfb4f2eaad8"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNjoyODo0N1rOFe-akw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNjo0NTo0OFrOFe-7Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAyNDIxMQ==", "bodyText": "I don't have context with FlutterBazelTestLineMarkerContributor, did I add this, or someone else, @DaveShuckerow?", "url": "https://github.com/flutter/flutter-intellij/pull/4295#discussion_r368024211", "createdAt": "2020-01-17T16:28:47Z", "author": {"login": "jwren"}, "path": "src/io/flutter/run/bazelTest/FlutterBazelTestLineMarkerContributor.java", "diffHunk": "@@ -23,7 +23,6 @@ public FlutterBazelTestLineMarkerContributor() {\n   @Nullable\n   @Override\n   public Info getInfo(@NotNull PsiElement element) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAwOTE0OQ=="}, "originalCommit": {"oid": "12d65d65b6f78fdb9cb466241b7a3bfb4f2eaad8"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzMjUzMA==", "bodyText": "Changing this registry changes it for all projects. This registry disables features such as notifications around pubspec files themselves and disabling notifications around new available Dart SDK versions.\nFrom my perspective having Flutter set this registry, is unifying the behavior between the Dart and Flutter plugin.  We considered the idea of moving a bunch of the Workspace data down to the Dart plugin but  Jacob made the point that the in the Flutter plugin, Workspace manages Flutter specific bazel data, mainly changes in executing flutter applications, i.e. the json file knowledge", "url": "https://github.com/flutter/flutter-intellij/pull/4295#discussion_r368032530", "createdAt": "2020-01-17T16:45:48Z", "author": {"login": "jwren"}, "path": "src/io/flutter/bazel/WorkspaceCache.java", "diffHunk": "@@ -64,46 +82,82 @@ public static WorkspaceCache getInstance(@NotNull final Project project) {\n    * Returns the Workspace in the cache.\n    * <p>\n    * <p>Returning a null means there is no current workspace for this project.\n-   * <p>\n-   * <p>If the cache hasn't loaded yet, blocks until it's ready.\n-   * Otherwise doesn't block.\n    */\n   @Nullable\n-  public Workspace getNow() {\n-    return cache.getNow();\n+  public Workspace get() {\n+    return cache;\n   }\n \n   /**\n-   * Waits for any refreshes to finish, then returns the new workspace (or null).\n-   *\n-   * @throws IllegalStateException if called on the Swing dispatch thread.\n+   * Returns whether the  project is a bazel project.\n    */\n-  @Nullable\n-  public Workspace getWhenReady() {\n-    return cache.getWhenReady();\n+  public boolean isBazel() {\n+    return cache != null;\n   }\n \n   /**\n    * Runs a callback each time the current Workspace changes.\n    */\n   public void subscribe(Runnable callback) {\n-    cache.subscribe(callback);\n+    synchronized (subscribers) {\n+      subscribers.add(callback);\n+    }\n   }\n \n   /**\n    * Stops notifications to a callback passed to {@link #subscribe}.\n    */\n   public void unsubscribe(Runnable callback) {\n-    cache.unsubscribe(callback);\n+    synchronized (subscribers) {\n+      subscribers.remove(callback);\n+    }\n   }\n \n   /**\n-   * Triggers a cache refresh.\n+   * The Dart plugin uses this registry key to avoid bazel users getting their settings overridden on projects that include a\n+   * pubspec.yaml.\n    * <p>\n-   * If a refresh is already in progress, schedules another one.\n+   * In other words, this key tells the plugin to configure dart projects without pubspec.yaml.\n+   */\n+  private static final String dartProjectsWithoutPubspecRegistryKey = \"dart.projects.without.pubspec\";\n+\n+  /**\n+   * Executes a cache refresh.\n    */\n-  private void refreshAsync() {\n-    cache.refresh(() -> Workspace.load(project));\n+  private void refresh() {\n+    final Workspace workspace = Workspace.loadUncached(project);\n+    if (workspace == cache) return;\n+    cache = workspace;\n+\n+    // If the current workspace is a bazel workspace, update the Dart plugin\n+    // registry key to indicate that there are dart projects without pubspec\n+    // registry keys. TODO(jacobr): it would be nice if the Dart plugin was\n+    // instead smarter about handling Bazel projects.\n+    if (cache != null) {\n+      if (!Registry.is(dartProjectsWithoutPubspecRegistryKey, false)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAwNzkxNg=="}, "originalCommit": {"oid": "12d65d65b6f78fdb9cb466241b7a3bfb4f2eaad8"}, "originalPosition": 153}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1734, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}