{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNTY5ODQx", "number": 5085, "title": "Run devtools panel actions on UI thread", "bodyText": "May fix #5032\naddBrowserInspectorViewContent should be run on the UI thread since it removes content from the panel and app.getConnector().getBrowserUrl() may be inaccurate when not run on the UI thread.\nHowever, DevToolsManager::openBrowserIntoPanel has some actions that should be run on a non-UI thread since we have to wait for the devtools server to start.", "createdAt": "2020-12-01T20:56:10Z", "url": "https://github.com/flutter/flutter-intellij/pull/5085", "merged": true, "mergeCommit": {"oid": "5b41ef06e7a8f2eccd0ac8ef6ca026f1c942231e"}, "closed": true, "closedAt": "2020-12-08T04:54:00Z", "author": {"login": "helin24"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiTSnBgFqTU0MzE0NjMyMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkCmmkgH2gAyNTMwNTY5ODQxOjM3MzA5NDU3NWJlODE0YmM5YTdkMTVmMzkxZGUwYTk5Y2RhMjI0ZGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTQ2MzIw", "url": "https://github.com/flutter/flutter-intellij/pull/5085#pullrequestreview-543146320", "createdAt": "2020-12-02T18:59:11Z", "commit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1OToxMVrOH9ptsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1OToxMVrOH9ptsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwODYyNQ==", "bodyText": "make sure project is still valid as soon as you get here.", "url": "https://github.com/flutter/flutter-intellij/pull/5085#discussion_r534408625", "createdAt": "2020-12-02T18:59:11Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -187,58 +187,62 @@ private boolean isBazel(Project project) {\n   }\n \n   public void openBrowserIntoPanel(FlutterApp app, String uri, ContentManager contentManager, String tabName, String pageName) {\n-    final String screen = null;\n+    ApplicationManager.getApplication().executeOnPooledThread(() -> {\n+      final String screen = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTQ2NjU4", "url": "https://github.com/flutter/flutter-intellij/pull/5085#pullrequestreview-543146658", "createdAt": "2020-12-02T18:59:37Z", "commit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1OTozN1rOH9puwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1OTozN1rOH9puwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwODg5OA==", "bodyText": "make sure project is still valid after waiting.", "url": "https://github.com/flutter/flutter-intellij/pull/5085#discussion_r534408898", "createdAt": "2020-12-02T18:59:37Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -187,58 +187,62 @@ private boolean isBazel(Project project) {\n   }\n \n   public void openBrowserIntoPanel(FlutterApp app, String uri, ContentManager contentManager, String tabName, String pageName) {\n-    final String screen = null;\n+    ApplicationManager.getApplication().executeOnPooledThread(() -> {\n+      final String screen = null;\n \n-    if (isBazel(project)) {\n-      try {\n-        getDevToolsInstance(app).get(15, TimeUnit.SECONDS).openPanel(project, uri, contentManager, tabName, pageName);\n-      }\n-      catch (Exception e) {\n-        LOG.info(\"Failed to get existing devToolsInstance\");\n-      }\n-    }\n-    else {\n-      if (devToolsInstance != null) {\n-        devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n+      if (isBazel(project)) {\n+        try {\n+          getDevToolsInstance(app).get(15, TimeUnit.SECONDS).openPanel(project, uri, contentManager, tabName, pageName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTQ3MTM4", "url": "https://github.com/flutter/flutter-intellij/pull/5085#pullrequestreview-543147138", "createdAt": "2020-12-02T19:00:16Z", "commit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowMDoxNlrOH9pwkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowMDoxNlrOH9pwkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwOTM2Mg==", "bodyText": "another time gap. Make sure the project is still valid before we open the panel.", "url": "https://github.com/flutter/flutter-intellij/pull/5085#discussion_r534409362", "createdAt": "2020-12-02T19:00:16Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -187,58 +187,62 @@ private boolean isBazel(Project project) {\n   }\n \n   public void openBrowserIntoPanel(FlutterApp app, String uri, ContentManager contentManager, String tabName, String pageName) {\n-    final String screen = null;\n+    ApplicationManager.getApplication().executeOnPooledThread(() -> {\n+      final String screen = null;\n \n-    if (isBazel(project)) {\n-      try {\n-        getDevToolsInstance(app).get(15, TimeUnit.SECONDS).openPanel(project, uri, contentManager, tabName, pageName);\n-      }\n-      catch (Exception e) {\n-        LOG.info(\"Failed to get existing devToolsInstance\");\n-      }\n-    }\n-    else {\n-      if (devToolsInstance != null) {\n-        devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n+      if (isBazel(project)) {\n+        try {\n+          getDevToolsInstance(app).get(15, TimeUnit.SECONDS).openPanel(project, uri, contentManager, tabName, pageName);\n+        }\n+        catch (Exception e) {\n+          LOG.info(\"Failed to get existing devToolsInstance\");\n+        }\n       }\n       else {\n-        @Nullable final OSProcessHandler handler = getProcessHandlerForPub();\n-\n-        if (handler != null) {\n-          // start the server\n-          DevToolsInstance.startServer(handler, instance -> {\n-            devToolsInstance = instance;\n-\n-            devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n-          }, () -> {\n-            // Listen for closing; null out the devToolsInstance.\n-            devToolsInstance = null;\n-          }, project);\n+        if (devToolsInstance != null) {\n+          devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n+        }\n+        else {\n+          @Nullable final OSProcessHandler handler = getProcessHandlerForPub();\n+\n+          if (handler != null) {\n+            // start the server\n+            DevToolsInstance.startServer(handler, instance -> {\n+              devToolsInstance = instance;\n+\n+              devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTQ4Mjk2", "url": "https://github.com/flutter/flutter-intellij/pull/5085#pullrequestreview-543148296", "createdAt": "2020-12-02T19:01:47Z", "commit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowMTo0N1rOH9p0cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowMTo0N1rOH9p0cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxMDM1Mg==", "bodyText": "shouldn't this method instead be asserting that we are on the UI thread? seems on to have it start on some random thread.", "url": "https://github.com/flutter/flutter-intellij/pull/5085#discussion_r534410352", "createdAt": "2020-12-02T19:01:47Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/view/FlutterView.java", "diffHunk": "@@ -430,24 +430,29 @@ private void presentDevTools(FlutterApp app, InspectorService inspectorService,\n     final DevToolsManager devToolsManager = DevToolsManager.getInstance(app.getProject());\n \n     if (devToolsManager.hasInstalledDevTools()) {\n-      addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded);\n+      AsyncUtils.invokeLater(() -> addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTU0MDg3", "url": "https://github.com/flutter/flutter-intellij/pull/5085#pullrequestreview-543154087", "createdAt": "2020-12-02T19:09:32Z", "commit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowOTozMlrOH9qGqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOTowOTozMlrOH9qGqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxNTAxOQ==", "bodyText": "watch out! succeeded is a Boolean so it can be null (when the throwable != null).\nThat is why I use the pattern of checking whether the throwable is null first in these callbacks to avoid bugs.\nYou could also use something like\nhttps://commons.apache.org/proper/commons-lang/javadocs/api-2.4/org/apache/commons/lang/BooleanUtils.html#isTrue(java.lang.Boolean)\nor\nif (succeeded != null && succeeded)", "url": "https://github.com/flutter/flutter-intellij/pull/5085#discussion_r534415019", "createdAt": "2020-12-02T19:09:32Z", "author": {"login": "jacob314"}, "path": "src/io/flutter/view/FlutterView.java", "diffHunk": "@@ -430,24 +430,29 @@ private void presentDevTools(FlutterApp app, InspectorService inspectorService,\n     final DevToolsManager devToolsManager = DevToolsManager.getInstance(app.getProject());\n \n     if (devToolsManager.hasInstalledDevTools()) {\n-      addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded);\n+      AsyncUtils.invokeLater(() -> addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded));\n     }\n     else {\n       presentLabel(toolWindow, INSTALLING_DEVTOOLS_LABEL);\n-\n       final CompletableFuture<Boolean> result = devToolsManager.installDevTools();\n-      result.thenAccept(succeeded -> {\n-        if (succeeded) {\n-          addBrowserInspectorViewContent(app, inspectorService, toolWindow, isEmbedded);\n-        }\n-        else {\n-          // TODO(helin24): Handle with alternative instructions if devtools fails.\n-          presentLabel(toolWindow, DEVTOOLS_FAILED_LABEL);\n-        }\n-      });\n+      awaitDevToolsInstall(app, inspectorService, toolWindow, isEmbedded, result);\n     }\n   }\n \n+  protected void awaitDevToolsInstall(FlutterApp app, InspectorService inspectorService, ToolWindow toolWindow, boolean isEmbedded, CompletableFuture<Boolean> installResult) {\n+    AsyncUtils.whenCompleteUiThread(installResult, (succeeded, throwable) -> {\n+      if (succeeded) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e45e08130ac66a9f4ee47c55eafe86efe4db6e1"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2Njk1MjQ0", "url": "https://github.com/flutter/flutter-intellij/pull/5085#pullrequestreview-546695244", "createdAt": "2020-12-08T02:22:03Z", "commit": {"oid": "782ffeac58820e2e12edbbeba65659fac918146c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "956c9bbdd9f98de1daec73d7796b067bcd8820c3", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/956c9bbdd9f98de1daec73d7796b067bcd8820c3", "committedDate": "2020-12-08T04:30:26Z", "message": "Run devtools panel actions on UI thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c2cb0bf8c9c5aa90029d793d25abaf19ebf51e5", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/4c2cb0bf8c9c5aa90029d793d25abaf19ebf51e5", "committedDate": "2020-12-08T04:33:48Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a67f46fd50e4b92f4e7b985158312d5d7b8e0830", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/a67f46fd50e4b92f4e7b985158312d5d7b8e0830", "committedDate": "2020-12-08T04:34:48Z", "message": "Check project status and throwable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2c7c67f6f6bdc281ed01521cbbb1eaf49f14ca5", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/a2c7c67f6f6bdc281ed01521cbbb1eaf49f14ca5", "committedDate": "2020-12-08T04:34:49Z", "message": "Assert running on UI thread and run install on background"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5b3488f92bdc3c2cb7027208854e7085d8dccff", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/c5b3488f92bdc3c2cb7027208854e7085d8dccff", "committedDate": "2020-12-08T04:34:49Z", "message": "Fix tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4d6feeaf3e3c2d478931b02e599c1aceeff45ab", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/d4d6feeaf3e3c2d478931b02e599c1aceeff45ab", "committedDate": "2020-12-08T04:28:32Z", "message": "Fix tests"}, "afterCommit": {"oid": "c5b3488f92bdc3c2cb7027208854e7085d8dccff", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/c5b3488f92bdc3c2cb7027208854e7085d8dccff", "committedDate": "2020-12-08T04:34:49Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "373094575be814bc9a7d15f391de0a99cda224dc", "author": {"user": {"login": "helin24", "name": "Helin Shiah"}}, "url": "https://github.com/flutter/flutter-intellij/commit/373094575be814bc9a7d15f391de0a99cda224dc", "committedDate": "2020-12-08T04:40:29Z", "message": "Fix merge conflict"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3031, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}