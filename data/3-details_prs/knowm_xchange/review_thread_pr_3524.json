{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNTAwNTgy", "number": 3524, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1Mjo1MVrOD-Xozg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDoxMToxNVrOD-YAlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzI1NTgyOnYy", "diffSide": "RIGHT", "path": "xchange-stream-btcmarkets/src/test/resources/log4j2.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1Mjo1MVrOGYbhEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMDozNzozOVrOGYieTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2OTg0MQ==", "bodyText": "XChange uses logback rather than log4j, so this won't do anything.", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428269841", "createdAt": "2020-05-20T19:52:51Z", "author": {"login": "badgerwithagun"}, "path": "xchange-stream-btcmarkets/src/test/resources/log4j2.xml", "diffHunk": "@@ -0,0 +1,15 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4MzgyMg==", "bodyText": "Removed that.", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428383822", "createdAt": "2020-05-21T00:37:39Z", "author": {"login": "nielsdraaisma"}, "path": "xchange-stream-btcmarkets/src/test/resources/log4j2.xml", "diffHunk": "@@ -0,0 +1,15 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2OTg0MQ=="}, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzI3MjQyOnYy", "diffSide": "RIGHT", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/dto/BTCMarketsWebSocketOrderbookMessage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1Nzo1OFrOGYbrrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMDozNzo1MFrOGYiefw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3MjU1OQ==", "bodyText": "Could you make these List<List<BigDecimal>>?", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428272559", "createdAt": "2020-05-20T19:57:58Z", "author": {"login": "badgerwithagun"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/dto/BTCMarketsWebSocketOrderbookMessage.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package info.bitrich.xchangestream.btcmarkets.dto;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import java.util.List;\n+\n+public class BTCMarketsWebSocketOrderbookMessage {\n+  public final String marketId;\n+\n+  public final String timestamp;\n+\n+  public final List<List<String>> bids;\n+  public final List<List<String>> asks;\n+\n+  public final String messageType;\n+\n+  public BTCMarketsWebSocketOrderbookMessage(\n+      @JsonProperty(\"marketId\") String marketId,\n+      @JsonProperty(\"timestamp\") String timestamp,\n+      @JsonProperty(\"bids\") List<List<String>> bids,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4Mzg3MQ==", "bodyText": "Done", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428383871", "createdAt": "2020-05-21T00:37:50Z", "author": {"login": "nielsdraaisma"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/dto/BTCMarketsWebSocketOrderbookMessage.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package info.bitrich.xchangestream.btcmarkets.dto;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import java.util.List;\n+\n+public class BTCMarketsWebSocketOrderbookMessage {\n+  public final String marketId;\n+\n+  public final String timestamp;\n+\n+  public final List<List<String>> bids;\n+  public final List<List<String>> asks;\n+\n+  public final String messageType;\n+\n+  public BTCMarketsWebSocketOrderbookMessage(\n+      @JsonProperty(\"marketId\") String marketId,\n+      @JsonProperty(\"timestamp\") String timestamp,\n+      @JsonProperty(\"bids\") List<List<String>> bids,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3MjU1OQ=="}, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzI3NDMwOnYy", "diffSide": "RIGHT", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingDigest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1ODozMVrOGYbs3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMDo0MjozNFrOGYii_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3Mjg2Mw==", "bodyText": "Does this need to be public?", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428272863", "createdAt": "2020-05-20T19:58:31Z", "author": {"login": "badgerwithagun"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingDigest.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Base64;\n+import javax.crypto.Mac;\n+import javax.crypto.spec.SecretKeySpec;\n+import org.knowm.xchange.utils.Assert;\n+\n+public class BTCMarketsStreamingDigest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4NTAyMg==", "bodyText": "I've removed that class entirely, i'll raise a new PR later with working private channels, that's not currently used at all.", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428385022", "createdAt": "2020-05-21T00:42:34Z", "author": {"login": "nielsdraaisma"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingDigest.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Base64;\n+import javax.crypto.Mac;\n+import javax.crypto.spec.SecretKeySpec;\n+import org.knowm.xchange.utils.Assert;\n+\n+public class BTCMarketsStreamingDigest {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3Mjg2Mw=="}, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzI3NjM4OnYy", "diffSide": "RIGHT", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/BTCMarketsStreamingAdapters.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1OToxNlrOGYbuQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMDozODowN1rOGYie0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3MzIxOA==", "bodyText": "Could this be co-located with the services and lowered to default visibility?", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428273218", "createdAt": "2020-05-20T19:59:16Z", "author": {"login": "badgerwithagun"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/BTCMarketsStreamingAdapters.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package info.bitrich.xchangestream.btcmarkets;\n+\n+import com.fasterxml.jackson.databind.exc.InvalidFormatException;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketOrderbookMessage;\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.function.BiFunction;\n+import java.util.stream.Collectors;\n+import org.knowm.xchange.currency.CurrencyPair;\n+import org.knowm.xchange.dto.Order;\n+import org.knowm.xchange.dto.marketdata.OrderBook;\n+import org.knowm.xchange.dto.trade.LimitOrder;\n+import org.knowm.xchange.utils.DateUtils;\n+\n+public class BTCMarketsStreamingAdapters {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4Mzk1NQ==", "bodyText": "Done", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428383955", "createdAt": "2020-05-21T00:38:07Z", "author": {"login": "nielsdraaisma"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/BTCMarketsStreamingAdapters.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package info.bitrich.xchangestream.btcmarkets;\n+\n+import com.fasterxml.jackson.databind.exc.InvalidFormatException;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketOrderbookMessage;\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.function.BiFunction;\n+import java.util.stream.Collectors;\n+import org.knowm.xchange.currency.CurrencyPair;\n+import org.knowm.xchange.dto.Order;\n+import org.knowm.xchange.dto.marketdata.OrderBook;\n+import org.knowm.xchange.dto.trade.LimitOrder;\n+import org.knowm.xchange.utils.DateUtils;\n+\n+public class BTCMarketsStreamingAdapters {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3MzIxOA=="}, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzI4Mjc3OnYy", "diffSide": "RIGHT", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingMarketDataService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDowMToyN1rOGYbybg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMDozODoxNVrOGYie-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NDI4Ng==", "bodyText": "could simplify this to marketId.equals(orderEvent.marketId) and lose the null check", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428274286", "createdAt": "2020-05-20T20:01:27Z", "author": {"login": "badgerwithagun"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingMarketDataService.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import static info.bitrich.xchangestream.btcmarkets.service.BTCMarketsStreamingService.CHANNEL_ORDERBOOK;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.exc.InvalidFormatException;\n+import info.bitrich.xchangestream.btcmarkets.BTCMarketsStreamingAdapters;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketOrderbookMessage;\n+import info.bitrich.xchangestream.core.StreamingMarketDataService;\n+import info.bitrich.xchangestream.service.netty.StreamingObjectMapperHelper;\n+import io.reactivex.Observable;\n+import org.knowm.xchange.currency.CurrencyPair;\n+import org.knowm.xchange.dto.marketdata.OrderBook;\n+import org.knowm.xchange.dto.marketdata.Ticker;\n+import org.knowm.xchange.dto.marketdata.Trade;\n+import org.knowm.xchange.exceptions.NotAvailableFromExchangeException;\n+\n+public class BTCMarketsStreamingMarketDataService implements StreamingMarketDataService {\n+\n+  private final ObjectMapper mapper = StreamingObjectMapperHelper.getObjectMapper();\n+\n+  private final BTCMarketsStreamingService service;\n+\n+  public BTCMarketsStreamingMarketDataService(BTCMarketsStreamingService service) {\n+    this.service = service;\n+  }\n+\n+  private OrderBook handleOrderbookMessage(BTCMarketsWebSocketOrderbookMessage message)\n+      throws InvalidFormatException {\n+    return BTCMarketsStreamingAdapters.adaptOrderbookMessageToOrderbook(message);\n+  }\n+\n+  @Override\n+  public Observable<OrderBook> getOrderBook(CurrencyPair currencyPair, Object... args) {\n+    String marketId = BTCMarketsStreamingAdapters.adaptCurrencyPairToMarketId(currencyPair);\n+    return service\n+        .subscribeChannel(CHANNEL_ORDERBOOK, marketId)\n+        .map(node -> mapper.treeToValue(node, BTCMarketsWebSocketOrderbookMessage.class))\n+        .filter(orderEvent -> orderEvent.marketId != null && orderEvent.marketId.equals(marketId))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4Mzk5Mg==", "bodyText": "Done", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428383992", "createdAt": "2020-05-21T00:38:15Z", "author": {"login": "nielsdraaisma"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingMarketDataService.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import static info.bitrich.xchangestream.btcmarkets.service.BTCMarketsStreamingService.CHANNEL_ORDERBOOK;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.exc.InvalidFormatException;\n+import info.bitrich.xchangestream.btcmarkets.BTCMarketsStreamingAdapters;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketOrderbookMessage;\n+import info.bitrich.xchangestream.core.StreamingMarketDataService;\n+import info.bitrich.xchangestream.service.netty.StreamingObjectMapperHelper;\n+import io.reactivex.Observable;\n+import org.knowm.xchange.currency.CurrencyPair;\n+import org.knowm.xchange.dto.marketdata.OrderBook;\n+import org.knowm.xchange.dto.marketdata.Ticker;\n+import org.knowm.xchange.dto.marketdata.Trade;\n+import org.knowm.xchange.exceptions.NotAvailableFromExchangeException;\n+\n+public class BTCMarketsStreamingMarketDataService implements StreamingMarketDataService {\n+\n+  private final ObjectMapper mapper = StreamingObjectMapperHelper.getObjectMapper();\n+\n+  private final BTCMarketsStreamingService service;\n+\n+  public BTCMarketsStreamingMarketDataService(BTCMarketsStreamingService service) {\n+    this.service = service;\n+  }\n+\n+  private OrderBook handleOrderbookMessage(BTCMarketsWebSocketOrderbookMessage message)\n+      throws InvalidFormatException {\n+    return BTCMarketsStreamingAdapters.adaptOrderbookMessageToOrderbook(message);\n+  }\n+\n+  @Override\n+  public Observable<OrderBook> getOrderBook(CurrencyPair currencyPair, Object... args) {\n+    String marketId = BTCMarketsStreamingAdapters.adaptCurrencyPairToMarketId(currencyPair);\n+    return service\n+        .subscribeChannel(CHANNEL_ORDERBOOK, marketId)\n+        .map(node -> mapper.treeToValue(node, BTCMarketsWebSocketOrderbookMessage.class))\n+        .filter(orderEvent -> orderEvent.marketId != null && orderEvent.marketId.equals(marketId))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NDI4Ng=="}, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzI5NjgxOnYy", "diffSide": "RIGHT", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDowNToyM1rOGYb63Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMToyODo1MFrOGYjQMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NjQ0NQ==", "bodyText": "Do these need to be public?", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428276445", "createdAt": "2020-05-20T20:05:23Z", "author": {"login": "badgerwithagun"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketSubscribeMessage;\n+import info.bitrich.xchangestream.service.netty.JsonNettyStreamingService;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class BTCMarketsStreamingService extends JsonNettyStreamingService {\n+  public static final String CHANNEL_ORDERBOOK = \"orderbook\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NjU5NA==", "bodyText": "I've moved things out of the packages and removed  public.", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428396594", "createdAt": "2020-05-21T01:28:50Z", "author": {"login": "nielsdraaisma"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketSubscribeMessage;\n+import info.bitrich.xchangestream.service.netty.JsonNettyStreamingService;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class BTCMarketsStreamingService extends JsonNettyStreamingService {\n+  public static final String CHANNEL_ORDERBOOK = \"orderbook\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NjQ0NQ=="}, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzI5NzU2OnYy", "diffSide": "RIGHT", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDowNTozOFrOGYb7YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMToyODo1NVrOGYjQRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NjU3Nw==", "bodyText": "Does this class itself need to be public?", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428276577", "createdAt": "2020-05-20T20:05:38Z", "author": {"login": "badgerwithagun"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketSubscribeMessage;\n+import info.bitrich.xchangestream.service.netty.JsonNettyStreamingService;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class BTCMarketsStreamingService extends JsonNettyStreamingService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NjYxMg==", "bodyText": "I've moved things out of the packages and removed  public.", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428396612", "createdAt": "2020-05-21T01:28:55Z", "author": {"login": "nielsdraaisma"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketSubscribeMessage;\n+import info.bitrich.xchangestream.service.netty.JsonNettyStreamingService;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class BTCMarketsStreamingService extends JsonNettyStreamingService {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NjU3Nw=="}, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzMxNjY5OnYy", "diffSide": "RIGHT", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDoxMToxNVrOGYcHWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMDo0MDoxNVrOGYig0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3OTY0MQ==", "bodyText": "Looks like there should be a subscribedOrderbooks.remove() here.\nnit: Setting up subscribedOrderbooks in the get...Message methods seems unsafe, but I can't see an obvious cleaner way. It's not the ideal websocket API, so I'm not too bothered.", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428279641", "createdAt": "2020-05-20T20:11:15Z", "author": {"login": "badgerwithagun"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketSubscribeMessage;\n+import info.bitrich.xchangestream.service.netty.JsonNettyStreamingService;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class BTCMarketsStreamingService extends JsonNettyStreamingService {\n+  public static final String CHANNEL_ORDERBOOK = \"orderbook\";\n+  public static final String CHANNEL_HEARTBEAT = \"heartbeat\";\n+  private static final Logger LOG = LoggerFactory.getLogger(BTCMarketsStreamingService.class);\n+  private final Set<String> subscribedOrderbooks = Sets.newConcurrentHashSet();\n+\n+  public BTCMarketsStreamingService(String apiUrl) {\n+    super(apiUrl);\n+  }\n+\n+  private BTCMarketsWebSocketSubscribeMessage buildSubscribeMessage() {\n+    return new BTCMarketsWebSocketSubscribeMessage(\n+        new ArrayList<>(subscribedOrderbooks),\n+        Lists.newArrayList(CHANNEL_ORDERBOOK, CHANNEL_HEARTBEAT),\n+        null,\n+        null,\n+        null);\n+  }\n+\n+  @Override\n+  protected String getChannelNameFromMessage(JsonNode message) {\n+    final String messageType = message.get(\"messageType\").asText();\n+    if (messageType.startsWith(CHANNEL_ORDERBOOK)) {\n+      return messageType + \":\" + message.get(\"marketId\").asText();\n+    }\n+    return messageType;\n+  }\n+\n+  @Override\n+  public String getSubscribeMessage(String channelName, Object... args) throws IOException {\n+    if (CHANNEL_ORDERBOOK.equals(channelName)) {\n+      subscribedOrderbooks.add(args[0].toString());\n+      LOG.debug(\"Now subscribed to orderbooks {}\", subscribedOrderbooks);\n+      return objectMapper.writeValueAsString(buildSubscribeMessage());\n+    } else {\n+      throw new IllegalArgumentException(\n+          \"Can't create subscribe messsage for channel \" + channelName);\n+    }\n+  }\n+\n+  public String getSubscriptionUniqueId(String channelName, Object... args) {\n+    if (CHANNEL_ORDERBOOK.equals(channelName)) {\n+      return channelName + \":\" + args[0].toString();\n+    }\n+    return channelName;\n+  }\n+\n+  @Override\n+  public String getUnsubscribeMessage(String channelName) throws IOException {\n+    if (channelName.startsWith(CHANNEL_ORDERBOOK)) {\n+      final String[] parts = channelName.split(\":\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4NDQ2NA==", "bodyText": "Done, there's no clean way of working around that, an unsubscribe is basically subscribing again without that channel.", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428384464", "createdAt": "2020-05-21T00:40:15Z", "author": {"login": "nielsdraaisma"}, "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketSubscribeMessage;\n+import info.bitrich.xchangestream.service.netty.JsonNettyStreamingService;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class BTCMarketsStreamingService extends JsonNettyStreamingService {\n+  public static final String CHANNEL_ORDERBOOK = \"orderbook\";\n+  public static final String CHANNEL_HEARTBEAT = \"heartbeat\";\n+  private static final Logger LOG = LoggerFactory.getLogger(BTCMarketsStreamingService.class);\n+  private final Set<String> subscribedOrderbooks = Sets.newConcurrentHashSet();\n+\n+  public BTCMarketsStreamingService(String apiUrl) {\n+    super(apiUrl);\n+  }\n+\n+  private BTCMarketsWebSocketSubscribeMessage buildSubscribeMessage() {\n+    return new BTCMarketsWebSocketSubscribeMessage(\n+        new ArrayList<>(subscribedOrderbooks),\n+        Lists.newArrayList(CHANNEL_ORDERBOOK, CHANNEL_HEARTBEAT),\n+        null,\n+        null,\n+        null);\n+  }\n+\n+  @Override\n+  protected String getChannelNameFromMessage(JsonNode message) {\n+    final String messageType = message.get(\"messageType\").asText();\n+    if (messageType.startsWith(CHANNEL_ORDERBOOK)) {\n+      return messageType + \":\" + message.get(\"marketId\").asText();\n+    }\n+    return messageType;\n+  }\n+\n+  @Override\n+  public String getSubscribeMessage(String channelName, Object... args) throws IOException {\n+    if (CHANNEL_ORDERBOOK.equals(channelName)) {\n+      subscribedOrderbooks.add(args[0].toString());\n+      LOG.debug(\"Now subscribed to orderbooks {}\", subscribedOrderbooks);\n+      return objectMapper.writeValueAsString(buildSubscribeMessage());\n+    } else {\n+      throw new IllegalArgumentException(\n+          \"Can't create subscribe messsage for channel \" + channelName);\n+    }\n+  }\n+\n+  public String getSubscriptionUniqueId(String channelName, Object... args) {\n+    if (CHANNEL_ORDERBOOK.equals(channelName)) {\n+      return channelName + \":\" + args[0].toString();\n+    }\n+    return channelName;\n+  }\n+\n+  @Override\n+  public String getUnsubscribeMessage(String channelName) throws IOException {\n+    if (channelName.startsWith(CHANNEL_ORDERBOOK)) {\n+      final String[] parts = channelName.split(\":\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3OTY0MQ=="}, "originalCommit": {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc"}, "originalPosition": 64}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3829, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}