{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5MDc3MzQ5", "number": 5657, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOTo1NToxOFrODi1MZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOTo1ODozOVrODi1Q0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3ODQ5NzAwOnYy", "diffSide": "RIGHT", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoDbManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOTo1NToxOFrOFuTGhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDowNzo0NVrOFuTe2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5MTc4MQ==", "bodyText": "I think this should be \"obtain\"?", "url": "https://github.com/sleuthkit/autopsy/pull/5657#discussion_r384091781", "createdAt": "2020-02-25T19:55:18Z", "author": {"login": "APriestman"}, "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoDbManager.java", "diffHunk": "@@ -0,0 +1,383 @@\n+/*\n+ * Central Repository\n+ *\n+ * Copyright 2015-2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.centralrepository.datamodel;\n+\n+import java.io.File;\n+import java.sql.SQLException;\n+import java.util.logging.Level;\n+import org.openide.util.NbBundle;\n+import org.sleuthkit.autopsy.coordinationservice.CoordinationService;\n+import org.sleuthkit.autopsy.coreutils.Logger;\n+\n+/**\n+ * Contains business logic for saving and validating settings for central repo\n+ */\n+public class CentralRepoDbManager {\n+\n+    private static final Logger logger = Logger.getLogger(CentralRepoDbManager.class.getName());\n+\n+    private static final String CENTRAL_REPO_DB_NAME = \"central_repository\";\n+\n+    /**\n+     * attains the database connectivity for central repository\n+     *\n+     * @return the CentralRepository object to connect to\n+     * @throws CentralRepoException\n+     */\n+    private static CentralRepository attainCentralRepository() throws CentralRepoException {\n+        //get connection\n+        try {\n+            return CentralRepository.getInstance();\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository, unable to make connection\", ex);\n+            onUpgradeError(\"Error updating central repository, unable to make connection\",\n+                    Bundle.EamDbUtil_centralRepoConnectionFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        }\n+\n+        // will never be reached\n+        return null;\n+    }\n+\n+    /**\n+     * attains central repository lock\n+     *\n+     * @param db the database connection\n+     * @return the lock if acquired\n+     * @throws CentralRepoException\n+     */\n+    private static CoordinationService.Lock attainCentralRepoLock(CentralRepository db) throws CentralRepoException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86285c071c659a865743e68655a5ca0eb02e3a8e"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5ODAwOQ==", "bodyText": "oops.  will do.", "url": "https://github.com/sleuthkit/autopsy/pull/5657#discussion_r384098009", "createdAt": "2020-02-25T20:07:45Z", "author": {"login": "gdicristofaro"}, "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoDbManager.java", "diffHunk": "@@ -0,0 +1,383 @@\n+/*\n+ * Central Repository\n+ *\n+ * Copyright 2015-2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.centralrepository.datamodel;\n+\n+import java.io.File;\n+import java.sql.SQLException;\n+import java.util.logging.Level;\n+import org.openide.util.NbBundle;\n+import org.sleuthkit.autopsy.coordinationservice.CoordinationService;\n+import org.sleuthkit.autopsy.coreutils.Logger;\n+\n+/**\n+ * Contains business logic for saving and validating settings for central repo\n+ */\n+public class CentralRepoDbManager {\n+\n+    private static final Logger logger = Logger.getLogger(CentralRepoDbManager.class.getName());\n+\n+    private static final String CENTRAL_REPO_DB_NAME = \"central_repository\";\n+\n+    /**\n+     * attains the database connectivity for central repository\n+     *\n+     * @return the CentralRepository object to connect to\n+     * @throws CentralRepoException\n+     */\n+    private static CentralRepository attainCentralRepository() throws CentralRepoException {\n+        //get connection\n+        try {\n+            return CentralRepository.getInstance();\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository, unable to make connection\", ex);\n+            onUpgradeError(\"Error updating central repository, unable to make connection\",\n+                    Bundle.EamDbUtil_centralRepoConnectionFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        }\n+\n+        // will never be reached\n+        return null;\n+    }\n+\n+    /**\n+     * attains central repository lock\n+     *\n+     * @param db the database connection\n+     * @return the lock if acquired\n+     * @throws CentralRepoException\n+     */\n+    private static CoordinationService.Lock attainCentralRepoLock(CentralRepository db) throws CentralRepoException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5MTc4MQ=="}, "originalCommit": {"oid": "86285c071c659a865743e68655a5ca0eb02e3a8e"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3ODUwMDU0OnYy", "diffSide": "RIGHT", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoDbManager.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOTo1NjoxOVrOFuTIww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMzoyMTozOFrOFurOQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5MjM1NQ==", "bodyText": "If this logic is correct there needs to be a comment explaining why it's defaulting to postgresql.", "url": "https://github.com/sleuthkit/autopsy/pull/5657#discussion_r384092355", "createdAt": "2020-02-25T19:56:19Z", "author": {"login": "APriestman"}, "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoDbManager.java", "diffHunk": "@@ -0,0 +1,383 @@\n+/*\n+ * Central Repository\n+ *\n+ * Copyright 2015-2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.centralrepository.datamodel;\n+\n+import java.io.File;\n+import java.sql.SQLException;\n+import java.util.logging.Level;\n+import org.openide.util.NbBundle;\n+import org.sleuthkit.autopsy.coordinationservice.CoordinationService;\n+import org.sleuthkit.autopsy.coreutils.Logger;\n+\n+/**\n+ * Contains business logic for saving and validating settings for central repo\n+ */\n+public class CentralRepoDbManager {\n+\n+    private static final Logger logger = Logger.getLogger(CentralRepoDbManager.class.getName());\n+\n+    private static final String CENTRAL_REPO_DB_NAME = \"central_repository\";\n+\n+    /**\n+     * attains the database connectivity for central repository\n+     *\n+     * @return the CentralRepository object to connect to\n+     * @throws CentralRepoException\n+     */\n+    private static CentralRepository attainCentralRepository() throws CentralRepoException {\n+        //get connection\n+        try {\n+            return CentralRepository.getInstance();\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository, unable to make connection\", ex);\n+            onUpgradeError(\"Error updating central repository, unable to make connection\",\n+                    Bundle.EamDbUtil_centralRepoConnectionFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        }\n+\n+        // will never be reached\n+        return null;\n+    }\n+\n+    /**\n+     * attains central repository lock\n+     *\n+     * @param db the database connection\n+     * @return the lock if acquired\n+     * @throws CentralRepoException\n+     */\n+    private static CoordinationService.Lock attainCentralRepoLock(CentralRepository db) throws CentralRepoException {\n+        try {\n+            // This may return null if locking isn't supported, which is fine. It will\n+            // throw an exception if locking is supported but we can't get the lock\n+            // (meaning the database is in use by another user)\n+            return db.getExclusiveMultiUserDbLock();\n+            //perform upgrade\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository, unable to acquire exclusive lock\", ex);\n+            onUpgradeError(\"Error updating central repository, unable to acquire exclusive lock\",\n+                    Bundle.EamDbUtil_exclusiveLockAquisitionFailure_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        }\n+\n+        // will never be reached\n+        return null;\n+    }\n+\n+    /**\n+     * updates central repository schema if necessary\n+     *\n+     * @param db the database connectivity\n+     * @param lock the acquired lock\n+     * @throws CentralRepoException\n+     */\n+    private static void updatedDbSchema(CentralRepository db, CoordinationService.Lock lock) throws CentralRepoException {\n+        try {\n+            db.upgradeSchema();\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\", ex.getUserMessage() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } catch (SQLException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\",\n+                    Bundle.EamDbUtil_centralRepoUpgradeFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } catch (IncompatibleCentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\",\n+                    ex.getMessage() + \"\\n\\n\" + Bundle.EamDbUtil_centralRepoUpgradeFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } finally {\n+            if (lock != null) {\n+                try {\n+                    lock.release();\n+                } catch (CoordinationService.CoordinationServiceException ex) {\n+                    logger.log(Level.SEVERE, \"Error releasing database lock\", ex);\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Upgrade the current Central Reposity schema to the newest version. If the\n+     * upgrade fails, the Central Repository will be disabled and the current\n+     * settings will be cleared.\n+     */\n+    @NbBundle.Messages(value = {\"EamDbUtil.centralRepoDisabled.message= The Central Repository has been disabled.\", \"EamDbUtil.centralRepoUpgradeFailed.message=Failed to upgrade Central Repository.\", \"EamDbUtil.centralRepoConnectionFailed.message=Unable to connect to Central Repository.\", \"EamDbUtil.exclusiveLockAquisitionFailure.message=Unable to acquire exclusive lock for Central Repository.\"})\n+    public static void upgradeDatabase() throws CentralRepoException {\n+        if (!CentralRepository.isEnabled()) {\n+            return;\n+        }\n+\n+        CentralRepository db = attainCentralRepository();\n+\n+        //get lock necessary for upgrade\n+        if (db != null) {\n+            CoordinationService.Lock lock = attainCentralRepoLock(db);\n+            updatedDbSchema(db, lock);\n+        } else {\n+            onUpgradeError(\"Unable to connect to database\",\n+                    Bundle.EamDbUtil_centralRepoConnectionFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), null);\n+        }\n+    }\n+\n+    private static void onUpgradeError(String message, String desc, Exception innerException) throws CentralRepoException {\n+        // Disable the central repo and clear the current settings.\n+        try {\n+            if (null != CentralRepository.getInstance()) {\n+                CentralRepository.getInstance().shutdownConnections();\n+            }\n+        } catch (CentralRepoException ex2) {\n+            logger.log(Level.SEVERE, \"Error shutting down central repo connection pool\", ex2);\n+        }\n+        CentralRepoPlatforms.setSelectedPlatform(CentralRepoPlatforms.DISABLED.name());\n+        CentralRepoPlatforms.saveSelectedPlatform();\n+        if (innerException == null) {\n+            throw new CentralRepoException(message, desc);\n+        } else {\n+            throw new CentralRepoException(message, desc, innerException);\n+        }\n+    }\n+\n+    private DatabaseTestResult testingStatus;\n+    private CentralRepoPlatforms selectedPlatform;\n+\n+    private final PostgresCentralRepoSettings dbSettingsPostgres;\n+    private final SqliteCentralRepoSettings dbSettingsSqlite;\n+\n+    private boolean configurationChanged = false;\n+\n+    public CentralRepoDbManager() {\n+        dbSettingsPostgres = new PostgresCentralRepoSettings();\n+        dbSettingsSqlite = new SqliteCentralRepoSettings();\n+        selectedPlatform = CentralRepoPlatforms.getSelectedPlatform();\n+        if (selectedPlatform == null || selectedPlatform.equals(CentralRepoPlatforms.DISABLED)) {\n+            selectedPlatform = CentralRepoPlatforms.POSTGRESQL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86285c071c659a865743e68655a5ca0eb02e3a8e"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEwNDcwMA==", "bodyText": "This originally came from the EamDbSettingsDialog constructor before I divided up the code.  https://github.com/sleuthkit/autopsy/blob/b805d2a1ec3f4bc16229a900a8d3859ba3355758/Core/src/org/sleuthkit/autopsy/centralrepository/optionspanel/EamDbSettingsDialog.java\nI think it is so the drop down populates with something if no choice is selected.  Is this something that needs to change all together?", "url": "https://github.com/sleuthkit/autopsy/pull/5657#discussion_r384104700", "createdAt": "2020-02-25T20:21:13Z", "author": {"login": "gdicristofaro"}, "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoDbManager.java", "diffHunk": "@@ -0,0 +1,383 @@\n+/*\n+ * Central Repository\n+ *\n+ * Copyright 2015-2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.centralrepository.datamodel;\n+\n+import java.io.File;\n+import java.sql.SQLException;\n+import java.util.logging.Level;\n+import org.openide.util.NbBundle;\n+import org.sleuthkit.autopsy.coordinationservice.CoordinationService;\n+import org.sleuthkit.autopsy.coreutils.Logger;\n+\n+/**\n+ * Contains business logic for saving and validating settings for central repo\n+ */\n+public class CentralRepoDbManager {\n+\n+    private static final Logger logger = Logger.getLogger(CentralRepoDbManager.class.getName());\n+\n+    private static final String CENTRAL_REPO_DB_NAME = \"central_repository\";\n+\n+    /**\n+     * attains the database connectivity for central repository\n+     *\n+     * @return the CentralRepository object to connect to\n+     * @throws CentralRepoException\n+     */\n+    private static CentralRepository attainCentralRepository() throws CentralRepoException {\n+        //get connection\n+        try {\n+            return CentralRepository.getInstance();\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository, unable to make connection\", ex);\n+            onUpgradeError(\"Error updating central repository, unable to make connection\",\n+                    Bundle.EamDbUtil_centralRepoConnectionFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        }\n+\n+        // will never be reached\n+        return null;\n+    }\n+\n+    /**\n+     * attains central repository lock\n+     *\n+     * @param db the database connection\n+     * @return the lock if acquired\n+     * @throws CentralRepoException\n+     */\n+    private static CoordinationService.Lock attainCentralRepoLock(CentralRepository db) throws CentralRepoException {\n+        try {\n+            // This may return null if locking isn't supported, which is fine. It will\n+            // throw an exception if locking is supported but we can't get the lock\n+            // (meaning the database is in use by another user)\n+            return db.getExclusiveMultiUserDbLock();\n+            //perform upgrade\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository, unable to acquire exclusive lock\", ex);\n+            onUpgradeError(\"Error updating central repository, unable to acquire exclusive lock\",\n+                    Bundle.EamDbUtil_exclusiveLockAquisitionFailure_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        }\n+\n+        // will never be reached\n+        return null;\n+    }\n+\n+    /**\n+     * updates central repository schema if necessary\n+     *\n+     * @param db the database connectivity\n+     * @param lock the acquired lock\n+     * @throws CentralRepoException\n+     */\n+    private static void updatedDbSchema(CentralRepository db, CoordinationService.Lock lock) throws CentralRepoException {\n+        try {\n+            db.upgradeSchema();\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\", ex.getUserMessage() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } catch (SQLException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\",\n+                    Bundle.EamDbUtil_centralRepoUpgradeFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } catch (IncompatibleCentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\",\n+                    ex.getMessage() + \"\\n\\n\" + Bundle.EamDbUtil_centralRepoUpgradeFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } finally {\n+            if (lock != null) {\n+                try {\n+                    lock.release();\n+                } catch (CoordinationService.CoordinationServiceException ex) {\n+                    logger.log(Level.SEVERE, \"Error releasing database lock\", ex);\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Upgrade the current Central Reposity schema to the newest version. If the\n+     * upgrade fails, the Central Repository will be disabled and the current\n+     * settings will be cleared.\n+     */\n+    @NbBundle.Messages(value = {\"EamDbUtil.centralRepoDisabled.message= The Central Repository has been disabled.\", \"EamDbUtil.centralRepoUpgradeFailed.message=Failed to upgrade Central Repository.\", \"EamDbUtil.centralRepoConnectionFailed.message=Unable to connect to Central Repository.\", \"EamDbUtil.exclusiveLockAquisitionFailure.message=Unable to acquire exclusive lock for Central Repository.\"})\n+    public static void upgradeDatabase() throws CentralRepoException {\n+        if (!CentralRepository.isEnabled()) {\n+            return;\n+        }\n+\n+        CentralRepository db = attainCentralRepository();\n+\n+        //get lock necessary for upgrade\n+        if (db != null) {\n+            CoordinationService.Lock lock = attainCentralRepoLock(db);\n+            updatedDbSchema(db, lock);\n+        } else {\n+            onUpgradeError(\"Unable to connect to database\",\n+                    Bundle.EamDbUtil_centralRepoConnectionFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), null);\n+        }\n+    }\n+\n+    private static void onUpgradeError(String message, String desc, Exception innerException) throws CentralRepoException {\n+        // Disable the central repo and clear the current settings.\n+        try {\n+            if (null != CentralRepository.getInstance()) {\n+                CentralRepository.getInstance().shutdownConnections();\n+            }\n+        } catch (CentralRepoException ex2) {\n+            logger.log(Level.SEVERE, \"Error shutting down central repo connection pool\", ex2);\n+        }\n+        CentralRepoPlatforms.setSelectedPlatform(CentralRepoPlatforms.DISABLED.name());\n+        CentralRepoPlatforms.saveSelectedPlatform();\n+        if (innerException == null) {\n+            throw new CentralRepoException(message, desc);\n+        } else {\n+            throw new CentralRepoException(message, desc, innerException);\n+        }\n+    }\n+\n+    private DatabaseTestResult testingStatus;\n+    private CentralRepoPlatforms selectedPlatform;\n+\n+    private final PostgresCentralRepoSettings dbSettingsPostgres;\n+    private final SqliteCentralRepoSettings dbSettingsSqlite;\n+\n+    private boolean configurationChanged = false;\n+\n+    public CentralRepoDbManager() {\n+        dbSettingsPostgres = new PostgresCentralRepoSettings();\n+        dbSettingsSqlite = new SqliteCentralRepoSettings();\n+        selectedPlatform = CentralRepoPlatforms.getSelectedPlatform();\n+        if (selectedPlatform == null || selectedPlatform.equals(CentralRepoPlatforms.DISABLED)) {\n+            selectedPlatform = CentralRepoPlatforms.POSTGRESQL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5MjM1NQ=="}, "originalCommit": {"oid": "86285c071c659a865743e68655a5ca0eb02e3a8e"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ2OTAxMA==", "bodyText": "Ok it's probably fine but please add a comment about what's going on.", "url": "https://github.com/sleuthkit/autopsy/pull/5657#discussion_r384469010", "createdAt": "2020-02-26T12:46:12Z", "author": {"login": "APriestman"}, "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoDbManager.java", "diffHunk": "@@ -0,0 +1,383 @@\n+/*\n+ * Central Repository\n+ *\n+ * Copyright 2015-2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.centralrepository.datamodel;\n+\n+import java.io.File;\n+import java.sql.SQLException;\n+import java.util.logging.Level;\n+import org.openide.util.NbBundle;\n+import org.sleuthkit.autopsy.coordinationservice.CoordinationService;\n+import org.sleuthkit.autopsy.coreutils.Logger;\n+\n+/**\n+ * Contains business logic for saving and validating settings for central repo\n+ */\n+public class CentralRepoDbManager {\n+\n+    private static final Logger logger = Logger.getLogger(CentralRepoDbManager.class.getName());\n+\n+    private static final String CENTRAL_REPO_DB_NAME = \"central_repository\";\n+\n+    /**\n+     * attains the database connectivity for central repository\n+     *\n+     * @return the CentralRepository object to connect to\n+     * @throws CentralRepoException\n+     */\n+    private static CentralRepository attainCentralRepository() throws CentralRepoException {\n+        //get connection\n+        try {\n+            return CentralRepository.getInstance();\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository, unable to make connection\", ex);\n+            onUpgradeError(\"Error updating central repository, unable to make connection\",\n+                    Bundle.EamDbUtil_centralRepoConnectionFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        }\n+\n+        // will never be reached\n+        return null;\n+    }\n+\n+    /**\n+     * attains central repository lock\n+     *\n+     * @param db the database connection\n+     * @return the lock if acquired\n+     * @throws CentralRepoException\n+     */\n+    private static CoordinationService.Lock attainCentralRepoLock(CentralRepository db) throws CentralRepoException {\n+        try {\n+            // This may return null if locking isn't supported, which is fine. It will\n+            // throw an exception if locking is supported but we can't get the lock\n+            // (meaning the database is in use by another user)\n+            return db.getExclusiveMultiUserDbLock();\n+            //perform upgrade\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository, unable to acquire exclusive lock\", ex);\n+            onUpgradeError(\"Error updating central repository, unable to acquire exclusive lock\",\n+                    Bundle.EamDbUtil_exclusiveLockAquisitionFailure_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        }\n+\n+        // will never be reached\n+        return null;\n+    }\n+\n+    /**\n+     * updates central repository schema if necessary\n+     *\n+     * @param db the database connectivity\n+     * @param lock the acquired lock\n+     * @throws CentralRepoException\n+     */\n+    private static void updatedDbSchema(CentralRepository db, CoordinationService.Lock lock) throws CentralRepoException {\n+        try {\n+            db.upgradeSchema();\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\", ex.getUserMessage() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } catch (SQLException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\",\n+                    Bundle.EamDbUtil_centralRepoUpgradeFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } catch (IncompatibleCentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\",\n+                    ex.getMessage() + \"\\n\\n\" + Bundle.EamDbUtil_centralRepoUpgradeFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } finally {\n+            if (lock != null) {\n+                try {\n+                    lock.release();\n+                } catch (CoordinationService.CoordinationServiceException ex) {\n+                    logger.log(Level.SEVERE, \"Error releasing database lock\", ex);\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Upgrade the current Central Reposity schema to the newest version. If the\n+     * upgrade fails, the Central Repository will be disabled and the current\n+     * settings will be cleared.\n+     */\n+    @NbBundle.Messages(value = {\"EamDbUtil.centralRepoDisabled.message= The Central Repository has been disabled.\", \"EamDbUtil.centralRepoUpgradeFailed.message=Failed to upgrade Central Repository.\", \"EamDbUtil.centralRepoConnectionFailed.message=Unable to connect to Central Repository.\", \"EamDbUtil.exclusiveLockAquisitionFailure.message=Unable to acquire exclusive lock for Central Repository.\"})\n+    public static void upgradeDatabase() throws CentralRepoException {\n+        if (!CentralRepository.isEnabled()) {\n+            return;\n+        }\n+\n+        CentralRepository db = attainCentralRepository();\n+\n+        //get lock necessary for upgrade\n+        if (db != null) {\n+            CoordinationService.Lock lock = attainCentralRepoLock(db);\n+            updatedDbSchema(db, lock);\n+        } else {\n+            onUpgradeError(\"Unable to connect to database\",\n+                    Bundle.EamDbUtil_centralRepoConnectionFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), null);\n+        }\n+    }\n+\n+    private static void onUpgradeError(String message, String desc, Exception innerException) throws CentralRepoException {\n+        // Disable the central repo and clear the current settings.\n+        try {\n+            if (null != CentralRepository.getInstance()) {\n+                CentralRepository.getInstance().shutdownConnections();\n+            }\n+        } catch (CentralRepoException ex2) {\n+            logger.log(Level.SEVERE, \"Error shutting down central repo connection pool\", ex2);\n+        }\n+        CentralRepoPlatforms.setSelectedPlatform(CentralRepoPlatforms.DISABLED.name());\n+        CentralRepoPlatforms.saveSelectedPlatform();\n+        if (innerException == null) {\n+            throw new CentralRepoException(message, desc);\n+        } else {\n+            throw new CentralRepoException(message, desc, innerException);\n+        }\n+    }\n+\n+    private DatabaseTestResult testingStatus;\n+    private CentralRepoPlatforms selectedPlatform;\n+\n+    private final PostgresCentralRepoSettings dbSettingsPostgres;\n+    private final SqliteCentralRepoSettings dbSettingsSqlite;\n+\n+    private boolean configurationChanged = false;\n+\n+    public CentralRepoDbManager() {\n+        dbSettingsPostgres = new PostgresCentralRepoSettings();\n+        dbSettingsSqlite = new SqliteCentralRepoSettings();\n+        selectedPlatform = CentralRepoPlatforms.getSelectedPlatform();\n+        if (selectedPlatform == null || selectedPlatform.equals(CentralRepoPlatforms.DISABLED)) {\n+            selectedPlatform = CentralRepoPlatforms.POSTGRESQL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5MjM1NQ=="}, "originalCommit": {"oid": "86285c071c659a865743e68655a5ca0eb02e3a8e"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4Njk3Nw==", "bodyText": "Ok.  It should be in the PR now.", "url": "https://github.com/sleuthkit/autopsy/pull/5657#discussion_r384486977", "createdAt": "2020-02-26T13:21:38Z", "author": {"login": "gdicristofaro"}, "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoDbManager.java", "diffHunk": "@@ -0,0 +1,383 @@\n+/*\n+ * Central Repository\n+ *\n+ * Copyright 2015-2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.centralrepository.datamodel;\n+\n+import java.io.File;\n+import java.sql.SQLException;\n+import java.util.logging.Level;\n+import org.openide.util.NbBundle;\n+import org.sleuthkit.autopsy.coordinationservice.CoordinationService;\n+import org.sleuthkit.autopsy.coreutils.Logger;\n+\n+/**\n+ * Contains business logic for saving and validating settings for central repo\n+ */\n+public class CentralRepoDbManager {\n+\n+    private static final Logger logger = Logger.getLogger(CentralRepoDbManager.class.getName());\n+\n+    private static final String CENTRAL_REPO_DB_NAME = \"central_repository\";\n+\n+    /**\n+     * attains the database connectivity for central repository\n+     *\n+     * @return the CentralRepository object to connect to\n+     * @throws CentralRepoException\n+     */\n+    private static CentralRepository attainCentralRepository() throws CentralRepoException {\n+        //get connection\n+        try {\n+            return CentralRepository.getInstance();\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository, unable to make connection\", ex);\n+            onUpgradeError(\"Error updating central repository, unable to make connection\",\n+                    Bundle.EamDbUtil_centralRepoConnectionFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        }\n+\n+        // will never be reached\n+        return null;\n+    }\n+\n+    /**\n+     * attains central repository lock\n+     *\n+     * @param db the database connection\n+     * @return the lock if acquired\n+     * @throws CentralRepoException\n+     */\n+    private static CoordinationService.Lock attainCentralRepoLock(CentralRepository db) throws CentralRepoException {\n+        try {\n+            // This may return null if locking isn't supported, which is fine. It will\n+            // throw an exception if locking is supported but we can't get the lock\n+            // (meaning the database is in use by another user)\n+            return db.getExclusiveMultiUserDbLock();\n+            //perform upgrade\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository, unable to acquire exclusive lock\", ex);\n+            onUpgradeError(\"Error updating central repository, unable to acquire exclusive lock\",\n+                    Bundle.EamDbUtil_exclusiveLockAquisitionFailure_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        }\n+\n+        // will never be reached\n+        return null;\n+    }\n+\n+    /**\n+     * updates central repository schema if necessary\n+     *\n+     * @param db the database connectivity\n+     * @param lock the acquired lock\n+     * @throws CentralRepoException\n+     */\n+    private static void updatedDbSchema(CentralRepository db, CoordinationService.Lock lock) throws CentralRepoException {\n+        try {\n+            db.upgradeSchema();\n+        } catch (CentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\", ex.getUserMessage() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } catch (SQLException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\",\n+                    Bundle.EamDbUtil_centralRepoUpgradeFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } catch (IncompatibleCentralRepoException ex) {\n+            logger.log(Level.SEVERE, \"Error updating central repository\", ex);\n+            onUpgradeError(\"Error updating central repository\",\n+                    ex.getMessage() + \"\\n\\n\" + Bundle.EamDbUtil_centralRepoUpgradeFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), ex);\n+        } finally {\n+            if (lock != null) {\n+                try {\n+                    lock.release();\n+                } catch (CoordinationService.CoordinationServiceException ex) {\n+                    logger.log(Level.SEVERE, \"Error releasing database lock\", ex);\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Upgrade the current Central Reposity schema to the newest version. If the\n+     * upgrade fails, the Central Repository will be disabled and the current\n+     * settings will be cleared.\n+     */\n+    @NbBundle.Messages(value = {\"EamDbUtil.centralRepoDisabled.message= The Central Repository has been disabled.\", \"EamDbUtil.centralRepoUpgradeFailed.message=Failed to upgrade Central Repository.\", \"EamDbUtil.centralRepoConnectionFailed.message=Unable to connect to Central Repository.\", \"EamDbUtil.exclusiveLockAquisitionFailure.message=Unable to acquire exclusive lock for Central Repository.\"})\n+    public static void upgradeDatabase() throws CentralRepoException {\n+        if (!CentralRepository.isEnabled()) {\n+            return;\n+        }\n+\n+        CentralRepository db = attainCentralRepository();\n+\n+        //get lock necessary for upgrade\n+        if (db != null) {\n+            CoordinationService.Lock lock = attainCentralRepoLock(db);\n+            updatedDbSchema(db, lock);\n+        } else {\n+            onUpgradeError(\"Unable to connect to database\",\n+                    Bundle.EamDbUtil_centralRepoConnectionFailed_message() + Bundle.EamDbUtil_centralRepoDisabled_message(), null);\n+        }\n+    }\n+\n+    private static void onUpgradeError(String message, String desc, Exception innerException) throws CentralRepoException {\n+        // Disable the central repo and clear the current settings.\n+        try {\n+            if (null != CentralRepository.getInstance()) {\n+                CentralRepository.getInstance().shutdownConnections();\n+            }\n+        } catch (CentralRepoException ex2) {\n+            logger.log(Level.SEVERE, \"Error shutting down central repo connection pool\", ex2);\n+        }\n+        CentralRepoPlatforms.setSelectedPlatform(CentralRepoPlatforms.DISABLED.name());\n+        CentralRepoPlatforms.saveSelectedPlatform();\n+        if (innerException == null) {\n+            throw new CentralRepoException(message, desc);\n+        } else {\n+            throw new CentralRepoException(message, desc, innerException);\n+        }\n+    }\n+\n+    private DatabaseTestResult testingStatus;\n+    private CentralRepoPlatforms selectedPlatform;\n+\n+    private final PostgresCentralRepoSettings dbSettingsPostgres;\n+    private final SqliteCentralRepoSettings dbSettingsSqlite;\n+\n+    private boolean configurationChanged = false;\n+\n+    public CentralRepoDbManager() {\n+        dbSettingsPostgres = new PostgresCentralRepoSettings();\n+        dbSettingsSqlite = new SqliteCentralRepoSettings();\n+        selectedPlatform = CentralRepoPlatforms.getSelectedPlatform();\n+        if (selectedPlatform == null || selectedPlatform.equals(CentralRepoPlatforms.DISABLED)) {\n+            selectedPlatform = CentralRepoPlatforms.POSTGRESQL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5MjM1NQ=="}, "originalCommit": {"oid": "86285c071c659a865743e68655a5ca0eb02e3a8e"}, "originalPosition": 167}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3ODUwNDEwOnYy", "diffSide": "RIGHT", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoDbSettings.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOTo1NzoyMlrOFuTK-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOTo1NzoyMlrOFuTK-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5MjkyMA==", "bodyText": "Replace with quick description", "url": "https://github.com/sleuthkit/autopsy/pull/5657#discussion_r384092920", "createdAt": "2020-02-25T19:57:22Z", "author": {"login": "APriestman"}, "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoDbSettings.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Central Repository\n+ *\n+ * Copyright 2015-2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.centralrepository.datamodel;\n+\n+/**\n+ *\n+ * @author gregd", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86285c071c659a865743e68655a5ca0eb02e3a8e"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3ODUwODMzOnYy", "diffSide": "RIGHT", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/eventlisteners/Installer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOTo1ODozOVrOFuTNqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOTo1ODozOVrOFuTNqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA5MzYxMQ==", "bodyText": "Can this not just be LOGGER.warning(\"msg...\", e) ?\nAlso I think we nearly always use \"ex\" so that would be a bit better for consistency.", "url": "https://github.com/sleuthkit/autopsy/pull/5657#discussion_r384093611", "createdAt": "2020-02-25T19:58:39Z", "author": {"login": "APriestman"}, "path": "Core/src/org/sleuthkit/autopsy/centralrepository/eventlisteners/Installer.java", "diffHunk": "@@ -51,28 +56,101 @@ private Installer() {\n         super();\n     }\n \n-    @NbBundle.Messages({\"Installer.centralRepoUpgradeFailed.title=Central repository disabled\"})\n+    @NbBundle.Messages({\n+        \"Installer.centralRepoUpgradeFailed.title=Central repository disabled\",\n+        \"Installer.initialCreateSqlite.title=Enable Central Repository?\",\n+        \"Installer.initialCreateSqlite.messageHeader=The Central Repository is not enabled. Would you like to?\",\n+        \"Installer.initialCreateSqlite.messageDesc=It will store information about all hashes and identifiers that you process. \" +\n+            \"You can use this to ignore previously seen files and make connections between cases.\"\n+    })\n     @Override\n     public void restored() {\n         Case.addPropertyChangeListener(pcl);\n         ieListener.installListeners();\n \n-        // Perform the database upgrade and inform the user if it fails\n+        String initialized = ModuleSettings.getConfigSetting(\"CentralRepository\", \"initialized\");\n+\n+        // if central repository hasn't been previously initialized, initialize it\n+        if (!Boolean.parseBoolean(initialized)) {\n+            // if running with a GUI, prompt the user\n+            if (RuntimeProperties.runningWithGUI()) {\n+                try {\n+                    SwingUtilities.invokeAndWait(() -> {\n+                        try {\n+                            String dialogText = \n+                                \"<html><body>\" + \n+                                    \"<div style='width: 400px;'>\" +\n+                                        \"<p>\" + NbBundle.getMessage(this.getClass(), \"Installer.initialCreateSqlite.messageHeader\") + \"</p>\" +\n+                                        \"<p style='margin-top: 10px'>\" + NbBundle.getMessage(this.getClass(), \"Installer.initialCreateSqlite.messageDesc\") + \"</p>\" +\n+                                    \"</div>\" +\n+                                \"</body></html>\";\n+\n+                            if (JOptionPane.YES_OPTION == JOptionPane.showConfirmDialog(WindowManager.getDefault().getMainWindow(),\n+                                    dialogText,\n+                                    NbBundle.getMessage(this.getClass(), \"Installer.initialCreateSqlite.title\"),\n+                                    JOptionPane.YES_NO_OPTION)) {\n+\n+                                setupDefaultSqlite();\n+                            }\n+                        } catch (CentralRepoException ex) {\n+                            LOGGER.log(Level.SEVERE, \"There was an error while initializing the central repository database\", ex);\n+\n+                            reportUpgradeError(ex);\n+                        }\n+                    });\n+                } catch (InterruptedException | InvocationTargetException ex) {\n+                    LOGGER.log(Level.SEVERE, \"There was an error while running the swing utility invoke later while creating the central repository database\", ex);\n+                }\n+            } // if no GUI, just initialize\n+            else {\n+                try {\n+                    setupDefaultSqlite();\n+                } catch (CentralRepoException ex) {\n+                     LOGGER.log(Level.SEVERE, \"There was an error while initializing the central repository database\", ex);\n+\n+                    reportUpgradeError(ex);\n+                }\n+            }\n+\n+            ModuleSettings.setConfigSetting(\"CentralRepository\", \"initialized\", \"true\");\n+        } \n+        \n+        // now run regular module startup code\n         try {\n-            CentralRepoDbUtil.upgradeDatabase();\n+            CentralRepoDbManager.upgradeDatabase();\n         } catch (CentralRepoException ex) {\n+            LOGGER.log(Level.SEVERE, \"There was an error while upgrading the central repository database\", ex);\n             if (RuntimeProperties.runningWithGUI()) {\n-                WindowManager.getDefault().invokeWhenUIReady(() -> {\n-                    JOptionPane.showMessageDialog(null,\n-                            ex.getUserMessage(),\n-                            NbBundle.getMessage(this.getClass(),\n-                                    \"Installer.centralRepoUpgradeFailed.title\"),\n-                            JOptionPane.ERROR_MESSAGE);\n-                });\n+                reportUpgradeError(ex);\n             }\n         }\n     }\n \n+    private void setupDefaultSqlite() throws CentralRepoException {\n+        CentralRepoDbUtil.setUseCentralRepo(true);\n+        CentralRepoDbManager manager = new CentralRepoDbManager();\n+        manager.setupDefaultSqliteSettings();\n+        manager.createDb();\n+        manager.saveNewCentralRepo();\n+    }\n+\n+    private void reportUpgradeError(CentralRepoException ex) {\n+        try {\n+            SwingUtilities.invokeAndWait(() -> {\n+                JOptionPane.showMessageDialog(null,\n+                        ex.getUserMessage(),\n+                        NbBundle.getMessage(this.getClass(),\n+                                \"Installer.centralRepoUpgradeFailed.title\"),\n+                        JOptionPane.ERROR_MESSAGE);\n+            });\n+        } catch (InterruptedException | InvocationTargetException e) {\n+            LOGGER.warning(\"There was an error while running the swing utility invoke later while displaying an error \" + \n+                \"for creating the central repository database: \"\n+                + e.getMessage() + System.lineSeparator() + e.getStackTrace());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86285c071c659a865743e68655a5ca0eb02e3a8e"}, "originalPosition": 125}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 740, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}