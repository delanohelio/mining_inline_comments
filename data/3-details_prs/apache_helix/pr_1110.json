{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MDk5ODEw", "number": 1110, "title": "Use dedicated ZkClient in HelixPropertyFactory", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nFixes #1106\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nIt's been observed that sometimes using a shared Zk connection could cause issues when we write in-memory tests that shut down ZK server and restart it. This is because with a shared Zkconnection, we may see the client's zxid be higher than that of the server, which is an invalid state in ZooKeeper. Since HelixManager is a single-realm dedicated concept, it is okay to use a dedicated zk connection to pull CloudConfig in getHelixManagerProperty() method. This will solve issues caused by zxid mismatches.\nTests\n\n The following tests are written for this issue:\n\nNo tests needed.\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n[ERROR] Failures: \n[ERROR]   TestCustomizedViewAggregation.testCustomizedViewAggregation:389->validateAggregationSnapshot:233 expected:<true> but was:<false>\n[ERROR]   TestEnableCompression.testEnableCompressionResource:116 \u00bb ThreadTimeout Method...\n[ERROR]   TestDeleteJobFromJobQueue.testForceDeleteJobFromJobQueue:75 \u00bb Helix Failed to ...\n[ERROR]   TestRebalanceRunningTask.testFixedTargetTaskAndEnabledRebalanceAndNodeAdded:330 expected:<true> but was:<false>\n[INFO] \n[ERROR] Tests run: 1145, Failures: 4, Errors: 0, Skipped: 0\n\n\nThe failed 4 tests were run individually:\n[INFO] Tests run: 8, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 52.745 s - in TestSuite\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 8, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\nCommits\n\n My commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nDocumentation (Optional)\n\n In case of new functionality, my PR adds documentation in the following wiki page:\n\n(Link the GitHub wiki you added)\nCode Quality\n\n My diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-06-22T18:08:33Z", "url": "https://github.com/apache/helix/pull/1110", "merged": true, "mergeCommit": {"oid": "88766c2221530cdc52a354d784a922ed7c10b7b1"}, "closed": true, "closedAt": "2020-06-26T00:07:11Z", "author": {"login": "narendly"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABct2CrCAH2gAyNDM4MDk5ODEwOjUxZjM2YTM0NWMzNGQ5NDZkYjJhNTI0NTY4OGVjMjQ5N2EyZDZhMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuihI3AFqTQzNzA2OTc4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "51f36a345c34d946db2a5245688ec2497a2d6a19", "author": {"user": {"login": "narendly", "name": "Hunter Lee"}}, "url": "https://github.com/apache/helix/commit/51f36a345c34d946db2a5245688ec2497a2d6a19", "committedDate": "2020-06-22T19:30:28Z", "message": "Use dedicated ZkClient in HelixPropertyFactory\n\nIt's been observed that sometimes using a shared Zk connection could cause issues when we write in-memory tests that shut down ZK server and restart it. This is because with a shared Zkconnection, we may see the client's zxid be higher than that of the server, which is an invalid state in ZooKeeper. Since HelixManager is a single-realm dedicated concept, it is okay to use a dedicated zk connection to pull CloudConfig in getHelixManagerProperty() method. This will solve issues caused by zxid mismatches."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1Mjg4NTM1", "url": "https://github.com/apache/helix/pull/1110#pullrequestreview-435288535", "createdAt": "2020-06-22T21:31:23Z", "commit": {"oid": "131ccd24b28155bb9ef0d802767c7c53ed9693cd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMTozMToyM1rOGnRt9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMTozMToyM1rOGnRt9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgzNzk0MA==", "bodyText": "Let's move this to the block, since it will be closed in finally block anyway.", "url": "https://github.com/apache/helix/pull/1110#discussion_r443837940", "createdAt": "2020-06-22T21:31:23Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/HelixPropertyFactory.java", "diffHunk": "@@ -47,17 +49,30 @@ public static HelixPropertyFactory getInstance() {\n    * Clients may override these values.\n    */\n   public HelixManagerProperty getHelixManagerProperty(String zkAddress, String clusterName) {\n-    ConfigAccessor configAccessor = new ConfigAccessor(zkAddress);\n     CloudConfig cloudConfig;\n-    // The try-catch logic is for backward compatibility reason only. Even if the cluster is not set\n-    // up yet, constructing a new ZKHelixManager should not throw an exception\n+    HelixZkClient zkClient = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "131ccd24b28155bb9ef0d802767c7c53ed9693cd"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MzYzMjYy", "url": "https://github.com/apache/helix/pull/1110#pullrequestreview-435363262", "createdAt": "2020-06-23T00:38:31Z", "commit": {"oid": "131ccd24b28155bb9ef0d802767c7c53ed9693cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMDozODozMVrOGnVY2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMDozODozMVrOGnVY2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5ODA3Mw==", "bodyText": "Let's mention another reason we want a dedicated client instead of shared client here is for the isolation level that we need.", "url": "https://github.com/apache/helix/pull/1110#discussion_r443898073", "createdAt": "2020-06-23T00:38:31Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/HelixPropertyFactory.java", "diffHunk": "@@ -47,17 +49,30 @@ public static HelixPropertyFactory getInstance() {\n    * Clients may override these values.\n    */\n   public HelixManagerProperty getHelixManagerProperty(String zkAddress, String clusterName) {\n-    ConfigAccessor configAccessor = new ConfigAccessor(zkAddress);\n     CloudConfig cloudConfig;\n-    // The try-catch logic is for backward compatibility reason only. Even if the cluster is not set\n-    // up yet, constructing a new ZKHelixManager should not throw an exception\n+    HelixZkClient zkClient = null;\n     try {\n-      cloudConfig =\n-          configAccessor.getCloudConfig(clusterName) == null ? buildEmptyCloudConfig(clusterName)\n-              : configAccessor.getCloudConfig(clusterName);\n-    } catch (HelixException e) {\n-      cloudConfig = buildEmptyCloudConfig(clusterName);\n+      // This configAccessor is a dedicated zkclient because HelixManager is single realm", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "131ccd24b28155bb9ef0d802767c7c53ed9693cd"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35da5431238591f063f54bcb88c48abdea07d6e7", "author": {"user": {"login": "narendly", "name": "Hunter Lee"}}, "url": "https://github.com/apache/helix/commit/35da5431238591f063f54bcb88c48abdea07d6e7", "committedDate": "2020-06-23T04:10:41Z", "message": "Update"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "131ccd24b28155bb9ef0d802767c7c53ed9693cd", "author": {"user": {"login": "narendly", "name": "Hunter Lee"}}, "url": "https://github.com/apache/helix/commit/131ccd24b28155bb9ef0d802767c7c53ed9693cd", "committedDate": "2020-06-22T18:06:52Z", "message": "Use dedicated ZkClient in HelixPropertyFactory\n\nIt's been observed that sometimes using a shared Zk connection could cause issues when we write in-memory tests that shut down ZK server and restart it. This is because with a shared Zkconnection, we may see the client's zxid be higher than that of the server, which is an invalid state in ZooKeeper. Since HelixManager is a single-realm dedicated concept, it is okay to use a dedicated zk connection to pull CloudConfig in getHelixManagerProperty() method. This will solve issues caused by zxid mismatches."}, "afterCommit": {"oid": "35da5431238591f063f54bcb88c48abdea07d6e7", "author": {"user": {"login": "narendly", "name": "Hunter Lee"}}, "url": "https://github.com/apache/helix/commit/35da5431238591f063f54bcb88c48abdea07d6e7", "committedDate": "2020-06-23T04:10:41Z", "message": "Update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "813118d6187eb19aaa4a8959601ba3418ead7068", "author": {"user": {"login": "narendly", "name": "Hunter Lee"}}, "url": "https://github.com/apache/helix/commit/813118d6187eb19aaa4a8959601ba3418ead7068", "committedDate": "2020-06-23T06:08:43Z", "message": "asdf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a055e7b48be9bd9a01ca6af1c7a63b8b99930c7", "author": {"user": {"login": "narendly", "name": "Hunter Lee"}}, "url": "https://github.com/apache/helix/commit/0a055e7b48be9bd9a01ca6af1c7a63b8b99930c7", "committedDate": "2020-06-23T06:11:59Z", "message": "sadf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92937c364d5ac2dc173b768d4266be29612280ed", "author": {"user": {"login": "narendly", "name": "Hunter Lee"}}, "url": "https://github.com/apache/helix/commit/92937c364d5ac2dc173b768d4266be29612280ed", "committedDate": "2020-06-23T06:40:31Z", "message": "asdf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "772c654ec65a66e17eaabf80816d75d72829e495", "author": {"user": {"login": "narendly", "name": "Hunter Lee"}}, "url": "https://github.com/apache/helix/commit/772c654ec65a66e17eaabf80816d75d72829e495", "committedDate": "2020-06-23T06:42:24Z", "message": "sadf"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDY5Nzgx", "url": "https://github.com/apache/helix/pull/1110#pullrequestreview-437069781", "createdAt": "2020-06-24T23:19:34Z", "commit": {"oid": "772c654ec65a66e17eaabf80816d75d72829e495"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4510, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}