{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUyOTA1NjAz", "number": 1157, "title": "fix TestRebalancePipeline test", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nFixes #1156\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\nIn the test testDuplicateMsg from TestRebalancePipeline, currently an invalid session id is used. Here's the detail:\nsetCurrentState(clusterName, \"localhost_0\", resourceName, resourceName + \"_0\", \"session_1\", \"SLAVE\");\nThe wrong session id makes the following test and assertion meaningless. This PR uses the correct session id  liveInstances.get(0).getEphemeralOwner() instead. Meanwhile, we found a NPE thrown out during the pipeline and cause the pipeline to stop, which is due to the missing of setAsyncTasksThreadPool action. This PR also fixed the issue.\n\nTests\nhelix-core\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n[ERROR] Failures:\n[ERROR]   TestClusterInMaintenanceModeWhenReachingMaxPartition.testDisableCluster:119 expected: but was:\n[ERROR]   TestRebalanceRunningTask.testFixedTargetTaskAndEnabledRebalanceAndNodeAdded:330 expected: but was:\n[INFO]\n[ERROR] Tests run: 1153, Failures: 2, Errors: 0, Skipped: 1\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD FAILURE\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  01:14 h\n[INFO] Finished at: 2020-07-19T22:08:21-07:00\n\nhelix-rest:\n[INFO] Tests run: 163, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 30.642 s - in TestSuite\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 163, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  35.801 s\n[INFO] Finished at: 2020-07-19T23:40:27-07:00\nCommits\n\n My commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\n My diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-07-20T00:33:13Z", "url": "https://github.com/apache/helix/pull/1157", "merged": true, "mergeCommit": {"oid": "380d51919b587e56c3c44be557121cff83cd64f7"}, "closed": true, "closedAt": "2020-07-21T17:16:32Z", "author": {"login": "zhangmeng916"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc2mfsOAH2gAyNDUyOTA1NjAzOjQxNmY2OTM1MmU0MDExMjk0NDIzNTgxZjM1MWU4YWU0MDVlMjVmMmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3JgF9gFqTQ1MjY2ODU5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "416f69352e4011294423581f351e8ae405e25f2a", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/416f69352e4011294423581f351e8ae405e25f2a", "committedDate": "2020-07-20T00:29:00Z", "message": "fix TestRebalancePipeline test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMjUxMzQ5", "url": "https://github.com/apache/helix/pull/1157#pullrequestreview-451251349", "createdAt": "2020-07-20T02:30:46Z", "commit": {"oid": "416f69352e4011294423581f351e8ae405e25f2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMjozMDo0NlrOGz03_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMjozMDo0NlrOGz03_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk5Njg2Mw==", "bodyText": "Could you add a comment here stating why we need to set async tasks thread pool? What happens if we don't? I ask because it doesn't seem like we do this in the previous version.", "url": "https://github.com/apache/helix/pull/1157#discussion_r456996863", "createdAt": "2020-07-20T02:30:46Z", "author": {"login": "narendly"}, "path": "helix-core/src/test/java/org/apache/helix/controller/stages/TestRebalancePipeline.java", "diffHunk": "@@ -61,8 +62,9 @@ public void testDuplicateMsg() {\n     HelixManager manager = new DummyClusterManager(clusterName, accessor);\n     ClusterEvent event = new ClusterEvent(ClusterEventType.Unknown);\n     event.addAttribute(AttributeName.helixmanager.name(), manager);\n-    event.addAttribute(AttributeName.ControllerDataProvider.name(),\n-        new ResourceControllerDataProvider());\n+    ResourceControllerDataProvider dataCache = new ResourceControllerDataProvider();\n+    dataCache.setAsyncTasksThreadPool(Executors.newSingleThreadExecutor());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "416f69352e4011294423581f351e8ae405e25f2a"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd859e4d7e9316e46843cef9114a68c3bda15839", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/bd859e4d7e9316e46843cef9114a68c3bda15839", "committedDate": "2020-07-20T03:50:34Z", "message": "add comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMzU0NDEz", "url": "https://github.com/apache/helix/pull/1157#pullrequestreview-451354413", "createdAt": "2020-07-20T07:22:28Z", "commit": {"oid": "bd859e4d7e9316e46843cef9114a68c3bda15839"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwNzoyMjoyOFrOGz8v9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwNzoyMjoyOFrOGz8v9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzEyNTg3Nw==", "bodyText": "Once we create an issue, you could link that issue number in the comment so we could track it better.", "url": "https://github.com/apache/helix/pull/1157#discussion_r457125877", "createdAt": "2020-07-20T07:22:28Z", "author": {"login": "narendly"}, "path": "helix-core/src/test/java/org/apache/helix/controller/stages/TestRebalancePipeline.java", "diffHunk": "@@ -61,8 +62,11 @@ public void testDuplicateMsg() {\n     HelixManager manager = new DummyClusterManager(clusterName, accessor);\n     ClusterEvent event = new ClusterEvent(ClusterEventType.Unknown);\n     event.addAttribute(AttributeName.helixmanager.name(), manager);\n-    event.addAttribute(AttributeName.ControllerDataProvider.name(),\n-        new ResourceControllerDataProvider());\n+    ResourceControllerDataProvider dataCache = new ResourceControllerDataProvider();\n+    // The AsyncTasksThreadPool needs to be set, otherwise to start pending message cleanup job\n+    // will throw NPE and stop the pipeline.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd859e4d7e9316e46843cef9114a68c3bda15839"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMzU0NTMx", "url": "https://github.com/apache/helix/pull/1157#pullrequestreview-451354531", "createdAt": "2020-07-20T07:22:39Z", "commit": {"oid": "bd859e4d7e9316e46843cef9114a68c3bda15839"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d47b7afd53d634cf7b9d163a06bae54c022aa12", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/7d47b7afd53d634cf7b9d163a06bae54c022aa12", "committedDate": "2020-07-20T16:04:10Z", "message": "refer issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba9d614ff757debf3354fc8758f22217d9e6552a", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/ba9d614ff757debf3354fc8758f22217d9e6552a", "committedDate": "2020-07-20T19:02:53Z", "message": "add tracking issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxODgwOTAy", "url": "https://github.com/apache/helix/pull/1157#pullrequestreview-451880902", "createdAt": "2020-07-20T19:05:17Z", "commit": {"oid": "ba9d614ff757debf3354fc8758f22217d9e6552a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxODgzNjU4", "url": "https://github.com/apache/helix/pull/1157#pullrequestreview-451883658", "createdAt": "2020-07-20T19:09:13Z", "commit": {"oid": "ba9d614ff757debf3354fc8758f22217d9e6552a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxOTowOToxM1rOG0bmVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxOTowOToxM1rOG0bmVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYzMTMxNw==", "bodyText": "Another important thing we should do here is to shut down the threads/thread pool. Otherwise, there will be a thread pool/thread leak throughout the test suite. This has been a real pain for Helix's test suite, so let's make sure we don't leak it here.\nWe could pull out this single thread executor to create a reference and shut it down at the end of the test.", "url": "https://github.com/apache/helix/pull/1157#discussion_r457631317", "createdAt": "2020-07-20T19:09:13Z", "author": {"login": "narendly"}, "path": "helix-core/src/test/java/org/apache/helix/controller/stages/TestRebalancePipeline.java", "diffHunk": "@@ -61,8 +62,11 @@ public void testDuplicateMsg() {\n     HelixManager manager = new DummyClusterManager(clusterName, accessor);\n     ClusterEvent event = new ClusterEvent(ClusterEventType.Unknown);\n     event.addAttribute(AttributeName.helixmanager.name(), manager);\n-    event.addAttribute(AttributeName.ControllerDataProvider.name(),\n-        new ResourceControllerDataProvider());\n+    ResourceControllerDataProvider dataCache = new ResourceControllerDataProvider();\n+    // The AsyncTasksThreadPool needs to be set, otherwise to start pending message cleanup job\n+    // will throw NPE and stop the pipeline. TODO: https://github.com/apache/helix/issues/1158\n+    dataCache.setAsyncTasksThreadPool(Executors.newSingleThreadExecutor());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba9d614ff757debf3354fc8758f22217d9e6552a"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f6cdf2497706a6f287a468561075c1638661750", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/3f6cdf2497706a6f287a468561075c1638661750", "committedDate": "2020-07-20T19:30:29Z", "message": "add thread shut down"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTQ1MTM4", "url": "https://github.com/apache/helix/pull/1157#pullrequestreview-451945138", "createdAt": "2020-07-20T20:43:52Z", "commit": {"oid": "3f6cdf2497706a6f287a468561075c1638661750"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDo0Mzo1MlrOG0eliA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDo0Mzo1MlrOG0eliA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MDI2NA==", "bodyText": "Should we not have this variable in the scope of the class? Since this isn't being used throughout the class, we could just create the reference in the test method and shut down at the very end of the method. That way, we don't need to add the afterClass() method.", "url": "https://github.com/apache/helix/pull/1157#discussion_r457680264", "createdAt": "2020-07-20T20:43:52Z", "author": {"login": "narendly"}, "path": "helix-core/src/test/java/org/apache/helix/controller/stages/TestRebalancePipeline.java", "diffHunk": "@@ -45,10 +47,17 @@\n import org.apache.helix.model.Message;\n import org.apache.helix.model.Partition;\n import org.testng.Assert;\n+import org.testng.annotations.AfterClass;\n import org.testng.annotations.Test;\n \n public class TestRebalancePipeline extends ZkUnitTestBase {\n   private final String _className = getShortClassName();\n+  private ExecutorService _executorService;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f6cdf2497706a6f287a468561075c1638661750"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTQ1NTM2", "url": "https://github.com/apache/helix/pull/1157#pullrequestreview-451945536", "createdAt": "2020-07-20T20:44:26Z", "commit": {"oid": "3f6cdf2497706a6f287a468561075c1638661750"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDo0NDoyN1rOG0emqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDo0NDoyN1rOG0emqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4MDU1Mg==", "bodyText": "_executorService  does not have to be a private variable. We could probably just use a local reference, and shut down at the end of the method.", "url": "https://github.com/apache/helix/pull/1157#discussion_r457680552", "createdAt": "2020-07-20T20:44:27Z", "author": {"login": "narendly"}, "path": "helix-core/src/test/java/org/apache/helix/controller/stages/TestRebalancePipeline.java", "diffHunk": "@@ -61,8 +70,12 @@ public void testDuplicateMsg() {\n     HelixManager manager = new DummyClusterManager(clusterName, accessor);\n     ClusterEvent event = new ClusterEvent(ClusterEventType.Unknown);\n     event.addAttribute(AttributeName.helixmanager.name(), manager);\n-    event.addAttribute(AttributeName.ControllerDataProvider.name(),\n-        new ResourceControllerDataProvider());\n+    ResourceControllerDataProvider dataCache = new ResourceControllerDataProvider();\n+    // The AsyncTasksThreadPool needs to be set, otherwise to start pending message cleanup job\n+    // will throw NPE and stop the pipeline. TODO: https://github.com/apache/helix/issues/1158\n+    _executorService = Executors.newSingleThreadExecutor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f6cdf2497706a6f287a468561075c1638661750"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa2c2554ddea1572a39f7cdb3a04f802194126ca", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/aa2c2554ddea1572a39f7cdb3a04f802194126ca", "committedDate": "2020-07-20T21:44:38Z", "message": "move shut down to test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNjY4NTk4", "url": "https://github.com/apache/helix/pull/1157#pullrequestreview-452668598", "createdAt": "2020-07-21T17:16:07Z", "commit": {"oid": "aa2c2554ddea1572a39f7cdb3a04f802194126ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4566, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}