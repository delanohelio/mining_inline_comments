{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2MTI2NzE2", "number": 696, "title": "Add WAGED rebalancer reset method to clean up cached status.", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\n#660\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nThe reset method is for allowing to clean up any in-memory records within the rebalancer without recreating it.\nDetailed change list:\n1. Add reset methods to all the stateful objects that are used in the WAGED rebalancer.\n2. Refine some of the potential race condition in the WAGED rebalancer components.\n3. Adjust the tests accordingly. Also adding new tests to cover the components reset / the WAGED rebalancer reset logic.\nTests\n\n The following tests are written for this issue:\n\nTestResourceChagneDetector.testResetSnapshot\nTestAssignmentMetadataStore.testAssignmentCache\nTestWagedRebalancer.testReset\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n[ERROR] Failures:\n[ERROR]   TestAutoRebalance.testAutoRebalance:177 expected: but was:\n[ERROR]   TestJobQueueCleanUp.testJobQueueAutoCleanUp \u00bb ThreadTimeout Method org.testng....\n[ERROR]   TestZKUtil.testChildrenOperations:80 expected:<2> but was:<4>\n[INFO]\n[ERROR] Tests run: 1066, Failures: 3, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD FAILURE\n[INFO] ------------------------------------------------------------------------\nRerun failed test\n[INFO] Tests run: 13, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 20.161 s - in TestSuite\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 13, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\nCommits\n\n My commits all reference appropriate Apache Helix GitHub issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nDocumentation\n\n In case of new functionality, my PR adds documentation in the following wiki page:\n\n(Link the GitHub wiki you added)\nCode Quality\n\n My diff has been formatted using helix-style.xml", "createdAt": "2020-01-23T00:20:14Z", "url": "https://github.com/apache/helix/pull/696", "merged": true, "mergeCommit": {"oid": "938ab9dadea509a22b46d3db8a3504c11770fc38"}, "closed": true, "closedAt": "2020-01-23T19:30:47Z", "author": {"login": "jiajunwang"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8_BDIgH2gAyMzY2MTI2NzE2OmIyN2ZhOTU2MDIzMTI1NTg2ZGM1YjE4YmE1YjQ2ODZiMWVhZjBkOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9PgAtgH2gAyMzY2MTI2NzE2OjU1NTk4YjYxY2JjZDVkMjc4YWViN2E5ZmE4NDJlODExZjkxZWE5NzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b27fa956023125586dc5b18ba5b4686b1eaf0d93", "author": {"user": {"login": "jiajunwang", "name": "Jiajun Wang"}}, "url": "https://github.com/apache/helix/commit/b27fa956023125586dc5b18ba5b4686b1eaf0d93", "committedDate": "2020-01-23T00:15:33Z", "message": "Add WAGED rebalancer reset method to clean up cached status.\n\nThe reset method is for allowing to clean up any in-memory records within the rebalancer without recreating it.\n\nDetailed change list:\n1. Add reset methods to all the stateful objects that are used in the WAGED rebalancer.\n2. Refine some of the potential race condition in the WAGED rebalancer components.\n3. Adjust the tests accordingly. Also adding new tests to cover the components reset / the WAGED rebalancer reset logic."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b15bbd10381ad24fb8f6c89160210b723bd0415e", "author": {"user": {"login": "jiajunwang", "name": "Jiajun Wang"}}, "url": "https://github.com/apache/helix/commit/b15bbd10381ad24fb8f6c89160210b723bd0415e", "committedDate": "2020-01-23T01:16:38Z", "message": "Additional change to clean up the WAGED rebalancer's constructors."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "438a30a045810500444a4a4c8b57daf92edf0e38", "author": {"user": {"login": "jiajunwang", "name": "Jiajun Wang"}}, "url": "https://github.com/apache/helix/commit/438a30a045810500444a4a4c8b57daf92edf0e38", "committedDate": "2020-01-23T01:06:33Z", "message": "Additional change to clean up the WAGED rebalancer's constructors."}, "afterCommit": {"oid": "b15bbd10381ad24fb8f6c89160210b723bd0415e", "author": {"user": {"login": "jiajunwang", "name": "Jiajun Wang"}}, "url": "https://github.com/apache/helix/commit/b15bbd10381ad24fb8f6c89160210b723bd0415e", "committedDate": "2020-01-23T01:16:38Z", "message": "Additional change to clean up the WAGED rebalancer's constructors."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MDE4MDY4", "url": "https://github.com/apache/helix/pull/696#pullrequestreview-347018068", "createdAt": "2020-01-23T01:45:47Z", "commit": {"oid": "b15bbd10381ad24fb8f6c89160210b723bd0415e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwMTo0NTo0N1rOFgwvUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwMjoyNjo1MlrOFgxTpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg5NzI5Ng==", "bodyText": "Whether HelixManager is null or not is not and should not be a flag for DelayedRebalance. Why does the log specifically mention delayed rebalance here?", "url": "https://github.com/apache/helix/pull/696#discussion_r369897296", "createdAt": "2020-01-23T01:45:47Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/controller/rebalancer/waged/WagedRebalancer.java", "diffHunk": "@@ -177,12 +172,13 @@ private WagedRebalancer(AssignmentMetadataStore assignmentMetadataStore,\n     _assignmentMetadataStore = assignmentMetadataStore;\n     _rebalanceAlgorithm = algorithm;\n     _mappingCalculator = mappingCalculator;\n+    if (manager == null) {\n+      LOG.warn(\"HelixManager is not provided. The rebalancer is not going to schedule for a future \"\n+          + \"rebalance even when delayed rebalance is enabled.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b15bbd10381ad24fb8f6c89160210b723bd0415e"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkwNjU5Ng==", "bodyText": "Nit: I think clearMetadataStore() might be a better name for this method because caching isn't really an explicit feature? Or resetMetadataStore()?", "url": "https://github.com/apache/helix/pull/696#discussion_r369906596", "createdAt": "2020-01-23T02:26:52Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/controller/rebalancer/waged/AssignmentMetadataStore.java", "diffHunk": "@@ -146,6 +146,17 @@ public boolean persistBestPossibleAssignment(\n     return true;\n   }\n \n+  protected synchronized void resetCache() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b15bbd10381ad24fb8f6c89160210b723bd0415e"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55598b61cbcd5d278aeb7a9fa842e811f91ea975", "author": {"user": {"login": "jiajunwang", "name": "Jiajun Wang"}}, "url": "https://github.com/apache/helix/commit/55598b61cbcd5d278aeb7a9fa842e811f91ea975", "committedDate": "2020-01-23T19:27:51Z", "message": "Rename method."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4880, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}