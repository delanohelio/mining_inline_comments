{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MzA2MzQ3", "number": 1439, "title": "Implement addTask API", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\nFixes #1437\n\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\nIn this PR, addTask API has been implemented which adds a new task to running (IN-PROGRESS) jobs.\n\nTests\n\n\n The following tests are written for this issue:\nTestAddTask\n\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n\n[INFO] Tests run: 1222, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 4,263.589 s - in TestSuite\n[INFO] \n[INFO] Results:\n[INFO] \n[INFO] Tests run: 1222, Failures: 0, Errors: 0, Skipped: 0\n[INFO] \n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  01:11 h\n[INFO] Finished at: 2020-10-07T17:44:08-07:00\n[INFO] ------------------------------------------------------------------------\n\nCommits\n\nMy commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\nMy diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-10-06T06:37:20Z", "url": "https://github.com/apache/helix/pull/1439", "merged": true, "mergeCommit": {"oid": "1f046fb13708d4c55abd8dd65504bb0b749b5564"}, "closed": true, "closedAt": "2020-10-13T20:22:02Z", "author": {"login": "alirezazamani"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP7v6hAFqTUwMzE5NDY3Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSNTokgH2gAyNDk4MzA2MzQ3OmJmOTY1NDA3ZDc5Yzg5NzQwNjI2M2MyYjZmOTM2YTM4MjQ2NmFiODE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTk0Njcy", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-503194672", "createdAt": "2020-10-06T17:22:49Z", "commit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoyMjo0OVrOHdSOSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoyMjo0OVrOHdSOSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2OTMyMA==", "bodyText": "Not necessarily a running job, people can add task to NOT_STARTED jobs too, right?", "url": "https://github.com/apache/helix/pull/1439#discussion_r500469320", "createdAt": "2020-10-06T17:22:49Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTk2ODM4", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-503196838", "createdAt": "2020-10-06T17:25:27Z", "commit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoyNToyN1rOHdSUxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoyNToyN1rOHdSUxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MDk4MQ==", "bodyText": "I would suggest  to change the parameters order to this (String workflowName, String jobName, TaskConfig, timeout), just to follow the conventions in other methods in the TaskDriver.", "url": "https://github.com/apache/helix/pull/1439#discussion_r500470981", "createdAt": "2020-10-06T17:25:27Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTk3OTM3", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-503197937", "createdAt": "2020-10-06T17:26:42Z", "commit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoyNjo0MlrOHdSYJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoyNjo0MlrOHdSYJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MTg0NA==", "bodyText": "If the workflow has not started, the context does not exist, right?  But do we allow them to add a task to newly created workflow/job?", "url": "https://github.com/apache/helix/pull/1439#discussion_r500471844", "createdAt": "2020-10-06T17:26:42Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTk5NDcx", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-503199471", "createdAt": "2020-10-06T17:28:35Z", "commit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoyODozNVrOHdSc2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoyODozNVrOHdSc2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MzA0OA==", "bodyText": "Can we wrap this logic to a separate (private) method, such as validateTaskConfig(). Also, you may want to put this check at the beginning of the method (to avoid non-necessary ZK read if the input itself is not valid).", "url": "https://github.com/apache/helix/pull/1439#discussion_r500473048", "createdAt": "2020-10-06T17:28:35Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjAwNzM4", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-503200738", "createdAt": "2020-10-06T17:30:08Z", "commit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozMDowOFrOHdSgzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozMDowOFrOHdSgzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NDA2Mg==", "bodyText": "Could the JobState be null when the job was just created (has not be scheduled by the controller)?", "url": "https://github.com/apache/helix/pull/1439#discussion_r500474062", "createdAt": "2020-10-06T17:30:08Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =\n+        new HashSet<>(Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING,\n+            TaskState.FAILED, TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPED,\n+            TaskState.STOPPING));\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjAxMTgz", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-503201183", "createdAt": "2020-10-06T17:30:41Z", "commit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozMDo0MlrOHdSiLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozMDo0MlrOHdSiLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NDQxNQ==", "bodyText": "LOG.ERROR?", "url": "https://github.com/apache/helix/pull/1439#discussion_r500474415", "createdAt": "2020-10-06T17:30:42Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =\n+        new HashSet<>(Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING,\n+            TaskState.FAILED, TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPED,\n+            TaskState.STOPPING));\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because JobState \" + nameSpaceJobName + \" is null!\");\n+    }\n+\n+    if (illegalJobStateForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n+    }\n+\n+    DataUpdater<ZNRecord> updater = currentData -> {\n+      if (currentData != null) {\n+        currentData.setMapField(taskConfig.getId(), taskConfig.getConfigMap());\n+      } else {\n+        LOG.warn(\"JobConfig DataUpdater: Fails to update JobConfig. CurrentData is null.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 107}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjA0MjE3", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-503204217", "createdAt": "2020-10-06T17:34:35Z", "commit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozNDozNVrOHdSrjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozNDozNVrOHdSrjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NjgxMw==", "bodyText": "What will happen if timeout is less than 1000ms?  You may want to adjust the sleep time here based on the given timeout?", "url": "https://github.com/apache/helix/pull/1439#discussion_r500476813", "createdAt": "2020-10-06T17:34:35Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =\n+        new HashSet<>(Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING,\n+            TaskState.FAILED, TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPED,\n+            TaskState.STOPPING));\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because JobState \" + nameSpaceJobName + \" is null!\");\n+    }\n+\n+    if (illegalJobStateForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n+    }\n+\n+    DataUpdater<ZNRecord> updater = currentData -> {\n+      if (currentData != null) {\n+        currentData.setMapField(taskConfig.getId(), taskConfig.getConfigMap());\n+      } else {\n+        LOG.warn(\"JobConfig DataUpdater: Fails to update JobConfig. CurrentData is null.\");\n+      }\n+      return currentData;\n+    };\n+\n+    String path = _accessor.keyBuilder().resourceConfig(nameSpaceJobName).getPath();\n+    boolean status = _accessor.getBaseDataAccessor().update(path, updater, AccessOption.PERSISTENT);\n+    if (!status) {\n+      LOG.error(\"Failed to add task to the job {}\", nameSpaceJobName);\n+      throw new HelixException(\"Failed to add task to the job\");\n+    }\n+\n+    String taskID = taskConfig.getId();\n+    while (System.currentTimeMillis() <= endTime) {\n+      JobContext jobContext = getJobContext(nameSpaceJobName);\n+      for (Map.Entry<String, Integer> entry : jobContext.getTaskIdPartitionMap().entrySet()) {\n+        if (entry.getKey().equals(taskID) && getWorkflowContext(workflowName)\n+            .getJobState(nameSpaceJobName) == TaskState.IN_PROGRESS) {\n+          return;\n+        }\n+      }\n+      Thread.sleep(1000L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 128}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjA1NTM5", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-503205539", "createdAt": "2020-10-06T17:36:20Z", "commit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozNjoyMVrOHdSvhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozNjoyMVrOHdSvhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NzgzMQ==", "bodyText": "Please add more javaDoc here to describe 1) the behaviors and expectations (task may not be added in different senarios), 2) what does the timeout here mean? and what the caller should do if it is timeout? 3) The possible Exceptions (and what does each mean) could be thrown.", "url": "https://github.com/apache/helix/pull/1439#discussion_r500477831", "createdAt": "2020-10-06T17:36:21Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjA3NzM4", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-503207738", "createdAt": "2020-10-06T17:39:15Z", "commit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozOToxNVrOHdS2EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzozOToxNVrOHdS2EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3OTUwNQ==", "bodyText": "Should we throw a specific TimeoutException instead of a general exception. What is the caller expected to do if it is timeout, call another method to verify whether the task has been successfully added, or retry the addTask()?", "url": "https://github.com/apache/helix/pull/1439#discussion_r500479505", "createdAt": "2020-10-06T17:39:15Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =\n+        new HashSet<>(Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING,\n+            TaskState.FAILED, TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPED,\n+            TaskState.STOPPING));\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because JobState \" + nameSpaceJobName + \" is null!\");\n+    }\n+\n+    if (illegalJobStateForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n+    }\n+\n+    DataUpdater<ZNRecord> updater = currentData -> {\n+      if (currentData != null) {\n+        currentData.setMapField(taskConfig.getId(), taskConfig.getConfigMap());\n+      } else {\n+        LOG.warn(\"JobConfig DataUpdater: Fails to update JobConfig. CurrentData is null.\");\n+      }\n+      return currentData;\n+    };\n+\n+    String path = _accessor.keyBuilder().resourceConfig(nameSpaceJobName).getPath();\n+    boolean status = _accessor.getBaseDataAccessor().update(path, updater, AccessOption.PERSISTENT);\n+    if (!status) {\n+      LOG.error(\"Failed to add task to the job {}\", nameSpaceJobName);\n+      throw new HelixException(\"Failed to add task to the job\");\n+    }\n+\n+    String taskID = taskConfig.getId();\n+    while (System.currentTimeMillis() <= endTime) {\n+      JobContext jobContext = getJobContext(nameSpaceJobName);\n+      for (Map.Entry<String, Integer> entry : jobContext.getTaskIdPartitionMap().entrySet()) {\n+        if (entry.getKey().equals(taskID) && getWorkflowContext(workflowName)\n+            .getJobState(nameSpaceJobName) == TaskState.IN_PROGRESS) {\n+          return;\n+        }\n+      }\n+      Thread.sleep(1000L);\n+    }\n+    throw new HelixException(\"An unexpected issue happened while task being added to the job!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 130}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMzMxNTg3", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-503331587", "createdAt": "2020-10-06T20:26:35Z", "commit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoyNjozNVrOHdYrFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDozNTo1M1rOHdY-PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NDk5OA==", "bodyText": "The default timeout is 5 mins. It is pretty long. Shall we just provide one method that returns immediately and one that waits for a timeout?", "url": "https://github.com/apache/helix/pull/1439#discussion_r500574998", "createdAt": "2020-10-06T20:26:35Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NTk3MA==", "bodyText": "Please define this as a private static field of the class.", "url": "https://github.com/apache/helix/pull/1439#discussion_r500575970", "createdAt": "2020-10-06T20:28:22Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3OTkwMA==", "bodyText": "It could be a trick issue, please verify.\nIt is possible that the caller pass accessor and propertyStore backed by different ZkClient. In this case, the accessor is used to update and the propertyStore is used to get context here. Given there might be a propagation latency on ZK server-side, this check here might be invalid. We need to set and read using the same ZkClient.", "url": "https://github.com/apache/helix/pull/1439#discussion_r500579900", "createdAt": "2020-10-06T20:35:53Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =\n+        new HashSet<>(Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING,\n+            TaskState.FAILED, TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPED,\n+            TaskState.STOPPING));\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because JobState \" + nameSpaceJobName + \" is null!\");\n+    }\n+\n+    if (illegalJobStateForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n+    }\n+\n+    DataUpdater<ZNRecord> updater = currentData -> {\n+      if (currentData != null) {\n+        currentData.setMapField(taskConfig.getId(), taskConfig.getConfigMap());\n+      } else {\n+        LOG.warn(\"JobConfig DataUpdater: Fails to update JobConfig. CurrentData is null.\");\n+      }\n+      return currentData;\n+    };\n+\n+    String path = _accessor.keyBuilder().resourceConfig(nameSpaceJobName).getPath();\n+    boolean status = _accessor.getBaseDataAccessor().update(path, updater, AccessOption.PERSISTENT);\n+    if (!status) {\n+      LOG.error(\"Failed to add task to the job {}\", nameSpaceJobName);\n+      throw new HelixException(\"Failed to add task to the job\");\n+    }\n+\n+    String taskID = taskConfig.getId();\n+    while (System.currentTimeMillis() <= endTime) {\n+      JobContext jobContext = getJobContext(nameSpaceJobName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 121}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eed4a2cd2c8b59482e1d94b778bf47fb3d7451f", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/4eed4a2cd2c8b59482e1d94b778bf47fb3d7451f", "committedDate": "2020-10-07T17:41:10Z", "message": "Implement addTask API\n\nIn this commit, addTask API has been implemented which\nadd new task to running (IN-PROGRESS) jobs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7388475382f2740511c508845823658dbf9986cd", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/7388475382f2740511c508845823658dbf9986cd", "committedDate": "2020-10-07T20:35:57Z", "message": "Addressing the comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/0c0782b90de1593cb72a3ad515fc6190e5088c11", "committedDate": "2020-10-05T23:00:57Z", "message": "Implement addTask API\n\nIn this commit, addTask API has been implemented which\nadd new task to running (IN-PROGRESS) jobs."}, "afterCommit": {"oid": "7388475382f2740511c508845823658dbf9986cd", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/7388475382f2740511c508845823658dbf9986cd", "committedDate": "2020-10-07T20:35:57Z", "message": "Addressing the comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1OTU2NjQ5", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-505956649", "createdAt": "2020-10-09T20:02:49Z", "commit": {"oid": "7388475382f2740511c508845823658dbf9986cd"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDowMjo0OVrOHfXFpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDowNzoyMFrOHfXM6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NjE4MQ==", "bodyText": "nit, private final static... please\nAlso, in this case, the var name should be ILLEGAL_JOB_STATES_FOR_TASK_ADDITION (or TASKS_MODIFICATION?)", "url": "https://github.com/apache/helix/pull/1439#discussion_r502646181", "createdAt": "2020-10-09T20:02:49Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -77,6 +76,11 @@\n   /** Default time out for monitoring workflow or job state */\n   private final static int DEFAULT_TIMEOUT = 5 * 60 * 1000; /* 5 mins */\n \n+  /** The illegal job states for the jobs to accept new task */\n+  private static Set<TaskState> illegalJobStatesForTaskAddition = new HashSet<>(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7388475382f2740511c508845823658dbf9986cd"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0Njk3OA==", "bodyText": "\"default timeout\" is not clear enough.\nPlease mention the real timeout here. Maybe use java doc feature to link with the variable would be a good idea. But I'm not sure if it works fine. please have a try.", "url": "https://github.com/apache/helix/pull/1439#discussion_r502646978", "createdAt": "2020-10-09T20:04:52Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +530,163 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7388475382f2740511c508845823658dbf9986cd"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NzA3MA==", "bodyText": "unit", "url": "https://github.com/apache/helix/pull/1439#discussion_r502647070", "createdAt": "2020-10-09T20:05:05Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +530,163 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @throws Exception\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @param timeout", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7388475382f2740511c508845823658dbf9986cd"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0ODA0MQ==", "bodyText": "If there are other places, then please don't hardcode the time.\nIn addition, IMO, the timeout less than 1000ms does not make sense, so we shall reject the request. Obviously, we shall mention in the public API that timeout less than 1000ms means no wait, or just being rejected.", "url": "https://github.com/apache/helix/pull/1439#discussion_r502648041", "createdAt": "2020-10-09T20:07:20Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =\n+        new HashSet<>(Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING,\n+            TaskState.FAILED, TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPED,\n+            TaskState.STOPPING));\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because JobState \" + nameSpaceJobName + \" is null!\");\n+    }\n+\n+    if (illegalJobStateForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n+    }\n+\n+    DataUpdater<ZNRecord> updater = currentData -> {\n+      if (currentData != null) {\n+        currentData.setMapField(taskConfig.getId(), taskConfig.getConfigMap());\n+      } else {\n+        LOG.warn(\"JobConfig DataUpdater: Fails to update JobConfig. CurrentData is null.\");\n+      }\n+      return currentData;\n+    };\n+\n+    String path = _accessor.keyBuilder().resourceConfig(nameSpaceJobName).getPath();\n+    boolean status = _accessor.getBaseDataAccessor().update(path, updater, AccessOption.PERSISTENT);\n+    if (!status) {\n+      LOG.error(\"Failed to add task to the job {}\", nameSpaceJobName);\n+      throw new HelixException(\"Failed to add task to the job\");\n+    }\n+\n+    String taskID = taskConfig.getId();\n+    while (System.currentTimeMillis() <= endTime) {\n+      JobContext jobContext = getJobContext(nameSpaceJobName);\n+      for (Map.Entry<String, Integer> entry : jobContext.getTaskIdPartitionMap().entrySet()) {\n+        if (entry.getKey().equals(taskID) && getWorkflowContext(workflowName)\n+            .getJobState(nameSpaceJobName) == TaskState.IN_PROGRESS) {\n+          return;\n+        }\n+      }\n+      Thread.sleep(1000L);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NjgxMw=="}, "originalCommit": {"oid": "0c0782b90de1593cb72a3ad515fc6190e5088c11"}, "originalPosition": 128}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1OTU5NDMy", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-505959432", "createdAt": "2020-10-09T20:07:58Z", "commit": {"oid": "7388475382f2740511c508845823658dbf9986cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDowNzo1OFrOHfXOBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDowNzo1OFrOHfXOBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0ODMyNg==", "bodyText": "nit, format the imports?", "url": "https://github.com/apache/helix/pull/1439#discussion_r502648326", "createdAt": "2020-10-09T20:07:58Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -28,6 +28,7 @@\n import java.util.Map;\n import java.util.Set;\n \n+import java.util.concurrent.TimeoutException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7388475382f2740511c508845823658dbf9986cd"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc5463281da78118ed1a1c30c6d1ed55cd159e50", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/dc5463281da78118ed1a1c30c6d1ed55cd159e50", "committedDate": "2020-10-10T21:55:55Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c06ab414f39b6b26a644b943d164e18a5c34504", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/4c06ab414f39b6b26a644b943d164e18a5c34504", "committedDate": "2020-10-09T21:41:22Z", "message": "Address comments"}, "afterCommit": {"oid": "dc5463281da78118ed1a1c30c6d1ed55cd159e50", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/dc5463281da78118ed1a1c30c6d1ed55cd159e50", "committedDate": "2020-10-10T21:55:55Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDY0ODM3", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-507064837", "createdAt": "2020-10-13T04:42:53Z", "commit": {"oid": "dc5463281da78118ed1a1c30c6d1ed55cd159e50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MjE5NjA2", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-507219606", "createdAt": "2020-10-13T09:01:51Z", "commit": {"oid": "dc5463281da78118ed1a1c30c6d1ed55cd159e50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwOTowMTo1MVrOHgcrdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwOTowMTo1MVrOHgcrdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc4NjM1Ng==", "bodyText": "Since Exception is pretty generic, I don't see a clear clue where it is from. Can you clarify in what case this Exception is thrown?", "url": "https://github.com/apache/helix/pull/1439#discussion_r503786356", "createdAt": "2020-10-13T09:01:51Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +533,177 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet. Timeout for this\n+   * operation is default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added or not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @throws Exception\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added or not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @param timeoutMs\n+   * @throws Exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc5463281da78118ed1a1c30c6d1ed55cd159e50"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b805011f2835226efdd9205896bc1c8fa36700c", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/9b805011f2835226efdd9205896bc1c8fa36700c", "committedDate": "2020-10-13T16:45:54Z", "message": "Add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NjUwODI3", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-507650827", "createdAt": "2020-10-13T16:58:52Z", "commit": {"oid": "9b805011f2835226efdd9205896bc1c8fa36700c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNjo1ODo1MlrOHgwxyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzowMDo0NFrOHgw2IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDExNTY1OA==", "bodyText": "This if condition is already covered by the one below.", "url": "https://github.com/apache/helix/pull/1439#discussion_r504115658", "createdAt": "2020-10-13T16:58:52Z", "author": {"login": "NealSun96"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +533,185 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet. Timeout for this\n+   * operation is the default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @throws Exception if there is an issue with the request or the operation. 1-\n+   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n+   *           will be thrown if the job is not in the states to accept a new task or if there is\n+   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n+   *           the task addition is unknown and cannot be verified.\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @param timeoutMs\n+   * @throws Exception if there is an issue with the request or the operation. 1-\n+   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n+   *           will be thrown if the job is not in the states to accept a new task or if there is\n+   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n+   *           the task addition is unknown and cannot be verified.\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeoutMs)\n+      throws Exception {\n+\n+    if (timeoutMs < DEFAULT_SLEEP) {\n+      throw new IllegalArgumentException(\n+          String.format(\"Timeout is less than the minimum acceptable timeout value which is %s ms\",\n+              DEFAULT_SLEEP));\n+    }\n+\n+    long endTime = System.currentTimeMillis() + timeoutMs;\n+\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b805011f2835226efdd9205896bc1c8fa36700c"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDExNjc2OQ==", "bodyText": "nit: could combine into (taskConfig.getCommand() == null != jobConfig.getCommand() == null) and say \"Command must exist in either job or task, not both\".", "url": "https://github.com/apache/helix/pull/1439#discussion_r504116769", "createdAt": "2020-10-13T17:00:44Z", "author": {"login": "NealSun96"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +533,185 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet. Timeout for this\n+   * operation is the default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @throws Exception if there is an issue with the request or the operation. 1-\n+   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n+   *           will be thrown if the job is not in the states to accept a new task or if there is\n+   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n+   *           the task addition is unknown and cannot be verified.\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @param timeoutMs\n+   * @throws Exception if there is an issue with the request or the operation. 1-\n+   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n+   *           will be thrown if the job is not in the states to accept a new task or if there is\n+   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n+   *           the task addition is unknown and cannot be verified.\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeoutMs)\n+      throws Exception {\n+\n+    if (timeoutMs < DEFAULT_SLEEP) {\n+      throw new IllegalArgumentException(\n+          String.format(\"Timeout is less than the minimum acceptable timeout value which is %s ms\",\n+              DEFAULT_SLEEP));\n+    }\n+\n+    long endTime = System.currentTimeMillis() + timeoutMs;\n+\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (ILLEGAL_JOB_STATES_FOR_TASK_MODIFICATION.contains(jobState)) {\n+      throw new HelixException(\n+          String.format(\"Job %s is in illegal state to accept new task. Job State is %s\",\n+              nameSpaceJobName, jobState));\n+    }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n+\n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\n+          String.format(\"Workflow config for workflow %s does not exist!\", workflowName));\n+    }\n+\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\n+          String.format(\"Job config for job %s does not exist!\", nameSpaceJobName));\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(String.format(\n+          \"Job %s is a targeted job. New task cannot be added to this job!\", nameSpaceJobName));\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b805011f2835226efdd9205896bc1c8fa36700c"}, "originalPosition": 160}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3Njk5NzUz", "url": "https://github.com/apache/helix/pull/1439#pullrequestreview-507699753", "createdAt": "2020-10-13T18:03:46Z", "commit": {"oid": "9b805011f2835226efdd9205896bc1c8fa36700c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODowMzo0NlrOHgzHQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODowMzo0NlrOHgzHQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE1MzkyMg==", "bodyText": "It doesn't seem a general Exception is thrown, right? Since this is an API, to make the API signature clearer for users to use, instead of throwing a general Exception, shall we just throw an accurate exception that may be thrown: TimeoutException? Then it looks much clearer and easy to understand. RuntimeException doesn't need to be in a method signature.", "url": "https://github.com/apache/helix/pull/1439#discussion_r504153922", "createdAt": "2020-10-13T18:03:46Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +533,185 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet. Timeout for this\n+   * operation is the default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @throws Exception if there is an issue with the request or the operation. 1-\n+   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n+   *           will be thrown if the job is not in the states to accept a new task or if there is\n+   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n+   *           the task addition is unknown and cannot be verified.\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @param timeoutMs\n+   * @throws Exception if there is an issue with the request or the operation. 1-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b805011f2835226efdd9205896bc1c8fa36700c"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf965407d79c897406263c2b6f936a382466ab81", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/bf965407d79c897406263c2b6f936a382466ab81", "committedDate": "2020-10-13T18:58:05Z", "message": "Further comments being addressed"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4323, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}