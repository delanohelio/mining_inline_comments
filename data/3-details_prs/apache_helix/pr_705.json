{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NjI0ODU3", "number": 705, "title": "Add workflow context garbage collection ", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR title:\nFixes #704\n\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\nThis PR contains the implementation of workflow context garbage collection which is added to scan all of the workflow context, and delete them if workflow config does not exists.\nTest is added which checks the functionality of workflow garbage collection.\n\nTests\n\n The following is the result of the \"mvn test\" command on the appropriate module:\nNew tests have been added.\nTestWorkflowContextWithoutConfig.TestWorkflowContextGarbageCollection\n\nTest Result 1: helix-core: mvn test\n[INFO] Tests run: 898, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 3,572.315 s - in TestSuite\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 898, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  59:37 min\n[INFO] Finished at: 2020-01-23T12:47:31-08:00\n[INFO] ------------------------------------------------------------------------\nCommits\n\n My commits all reference appropriate Apache Helix GitHub issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\n My diff has been formatted using helix-style.xml", "createdAt": "2020-01-24T00:03:17Z", "url": "https://github.com/apache/helix/pull/705", "merged": true, "mergeCommit": {"oid": "ecf6bb8c2a40a7af92043060ff095328181842ae"}, "closed": true, "closedAt": "2020-02-04T02:06:42Z", "author": {"login": "alirezazamani"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9TeWDgBqjI5NzU3MTIzNTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcA27rAAFqTM1MjY2ODIyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "92a958925ccbb95b465a5ac417fca2d239ff9393", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/92a958925ccbb95b465a5ac417fca2d239ff9393", "committedDate": "2020-01-23T21:34:59Z", "message": "The workflow garbage collection is added\n\nThe workflow garbage collection is added which scans all the workflow context,\nand delete them is workflow config does not exists.\nTest is added which checks the functionality of workflow garbage collection."}, "afterCommit": {"oid": "034cdaf551f316716019d17aa2f1bf7e3a8c6280", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/034cdaf551f316716019d17aa2f1bf7e3a8c6280", "committedDate": "2020-01-24T00:05:05Z", "message": "The workflow garbage collection is added\n\nThe workflow garbage collection is added which scans all the workflow context,\nand delete them if workflow config does not exists.\nTest is added which checks the functionality of workflow garbage collection."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ae41a96394af3ef6213d7d64727f44b434a5639", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/6ae41a96394af3ef6213d7d64727f44b434a5639", "committedDate": "2020-01-24T00:33:54Z", "message": "The workflow garbage collection is added\n\nThe workflow garbage collection is added which scans all the workflow context,\nand delete them if workflow config does not exists.\nTest is added which checks the functionality of workflow garbage collection."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "034cdaf551f316716019d17aa2f1bf7e3a8c6280", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/034cdaf551f316716019d17aa2f1bf7e3a8c6280", "committedDate": "2020-01-24T00:05:05Z", "message": "The workflow garbage collection is added\n\nThe workflow garbage collection is added which scans all the workflow context,\nand delete them if workflow config does not exists.\nTest is added which checks the functionality of workflow garbage collection."}, "afterCommit": {"oid": "6ae41a96394af3ef6213d7d64727f44b434a5639", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/6ae41a96394af3ef6213d7d64727f44b434a5639", "committedDate": "2020-01-24T00:33:54Z", "message": "The workflow garbage collection is added\n\nThe workflow garbage collection is added which scans all the workflow context,\nand delete them if workflow config does not exists.\nTest is added which checks the functionality of workflow garbage collection."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NzgzNDg4", "url": "https://github.com/apache/helix/pull/705#pullrequestreview-347783488", "createdAt": "2020-01-24T07:28:03Z", "commit": {"oid": "6ae41a96394af3ef6213d7d64727f44b434a5639"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwNzoyODowNFrOFhVm5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwNzoyODozOFrOFhVnew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTM1MA==", "bodyText": "existed -> existing", "url": "https://github.com/apache/helix/pull/705#discussion_r370501350", "createdAt": "2020-01-24T07:28:04Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1036,6 +1037,46 @@ public static void purgeExpiredJobs(String workflow, WorkflowConfig workflowConf\n     setNextJobPurgeTime(workflow, currentTime, purgeInterval, rebalanceScheduler, manager);\n   }\n \n+  /**\n+   * The function that loops through the all existed workflow contexts and removes IdealState and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae41a96394af3ef6213d7d64727f44b434a5639"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTM4MQ==", "bodyText": "\"workflow context of the workflow whose workflow config does not exist\"", "url": "https://github.com/apache/helix/pull/705#discussion_r370501381", "createdAt": "2020-01-24T07:28:12Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1036,6 +1037,46 @@ public static void purgeExpiredJobs(String workflow, WorkflowConfig workflowConf\n     setNextJobPurgeTime(workflow, currentTime, purgeInterval, rebalanceScheduler, manager);\n   }\n \n+  /**\n+   * The function that loops through the all existed workflow contexts and removes IdealState and\n+   * Workflow Context if Workflow Config is missing.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae41a96394af3ef6213d7d64727f44b434a5639"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTQyNA==", "bodyText": "Here we are doing a loop based on workflow contexts. Could there be cases where IdealStates exist but contexts/configs do not?", "url": "https://github.com/apache/helix/pull/705#discussion_r370501424", "createdAt": "2020-01-24T07:28:21Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1036,6 +1037,46 @@ public static void purgeExpiredJobs(String workflow, WorkflowConfig workflowConf\n     setNextJobPurgeTime(workflow, currentTime, purgeInterval, rebalanceScheduler, manager);\n   }\n \n+  /**\n+   * The function that loops through the all existed workflow contexts and removes IdealState and\n+   * Workflow Context if Workflow Config is missing.\n+   * @param dataProvider\n+   * @param manager\n+   */\n+  public static void workflowGarbageCollection(WorkflowControllerDataProvider dataProvider,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae41a96394af3ef6213d7d64727f44b434a5639"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTQ2NA==", "bodyText": "is existed -> exists", "url": "https://github.com/apache/helix/pull/705#discussion_r370501464", "createdAt": "2020-01-24T07:28:30Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1036,6 +1037,46 @@ public static void purgeExpiredJobs(String workflow, WorkflowConfig workflowConf\n     setNextJobPurgeTime(workflow, currentTime, purgeInterval, rebalanceScheduler, manager);\n   }\n \n+  /**\n+   * The function that loops through the all existed workflow contexts and removes IdealState and\n+   * Workflow Context if Workflow Config is missing.\n+   * @param dataProvider\n+   * @param manager\n+   */\n+  public static void workflowGarbageCollection(WorkflowControllerDataProvider dataProvider,\n+      final HelixManager manager) {\n+    // Garbage collections for conditions where workflow context is existed but config is missing.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae41a96394af3ef6213d7d64727f44b434a5639"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUwMTQ5OQ==", "bodyText": "When you do this, you'd want to take a snapshot of the entries because this might cause a ConcurrentModificationException.", "url": "https://github.com/apache/helix/pull/705#discussion_r370501499", "createdAt": "2020-01-24T07:28:38Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1036,6 +1037,46 @@ public static void purgeExpiredJobs(String workflow, WorkflowConfig workflowConf\n     setNextJobPurgeTime(workflow, currentTime, purgeInterval, rebalanceScheduler, manager);\n   }\n \n+  /**\n+   * The function that loops through the all existed workflow contexts and removes IdealState and\n+   * Workflow Context if Workflow Config is missing.\n+   * @param dataProvider\n+   * @param manager\n+   */\n+  public static void workflowGarbageCollection(WorkflowControllerDataProvider dataProvider,\n+      final HelixManager manager) {\n+    // Garbage collections for conditions where workflow context is existed but config is missing.\n+    Map<String, ZNRecord> contexts = dataProvider.getContexts();\n+    for (Map.Entry<String, ZNRecord> entry : contexts.entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae41a96394af3ef6213d7d64727f44b434a5639"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d46f0f326a4970c3d2ec985b5aa0f99d9a1bdcc8", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/d46f0f326a4970c3d2ec985b5aa0f99d9a1bdcc8", "committedDate": "2020-01-25T03:11:19Z", "message": "Address reviewer comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNjY4MjI2", "url": "https://github.com/apache/helix/pull/705#pullrequestreview-352668226", "createdAt": "2020-02-04T01:06:08Z", "commit": {"oid": "d46f0f326a4970c3d2ec985b5aa0f99d9a1bdcc8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4894, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}