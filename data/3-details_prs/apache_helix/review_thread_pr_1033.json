{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MTQ4NTM1", "number": 1033, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMjo0Mjo0OFrOEATLsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo0NToxNVrOEDBm_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzQ5NzQ0OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMjo0Mjo0OFrOGbfrjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMzowOTo0NFrOGbgQDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ4Mzc4OQ==", "bodyText": "You're creating a PropertyKey object with the given instance name and checking whether it's null? How would it be null if you've just created the path? In other words, when would this condition ever evaluate to false?\nDid you mean to check whether the path exists in ZooKeeper? If so, shouldn't you do an exist() check with a ZkClient-based API?\nUnless I'm mistaken and we actually somehow pre-populate the KeyBuilder with a whitelist of instances for the Customized State feature and returns null if the instance doesn't show up in the list?", "url": "https://github.com/apache/helix/pull/1033#discussion_r431483789", "createdAt": "2020-05-27T22:42:48Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -1256,14 +1256,18 @@ protected void checkLiveInstancesObservation(List<LiveInstance> liveInstances,\n \n         for (String instance : curInstances.keySet()) {\n           if (lastInstances == null || !lastInstances.containsKey(instance)) {\n-            try {\n-              manager.addCustomizedStateRootChangeListener(this, instance);\n-              logger.info(manager.getInstanceName() + \" added customized root change listener for\"\n-                  + \" \" + instance\n-                  + \", listener: \" + this);\n-            } catch (Exception e) {\n-              logger.error(\"Fail to add customized root change listener for instance: \" + instance,\n-                  e);\n+            PropertyKey propertyKey =\n+                keyBuilder.customizedStatesRoot(instance);\n+            if (propertyKey.getPath() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "768ec8090b9b27888d140abdd9b47ba8c52c9545"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ4NzI4Mw==", "bodyText": "oh..I was thinking to use exist checking, but put the wrong check, let me update it.\nThis is just for backward incompatibility check. We're totally fine without this check, but the participant would need to be on the latest version to have customized state path created. If they don't, there can be some error logs when adding listener to customized state path. It's still fine, but might cause confusion.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431487283", "createdAt": "2020-05-27T22:52:55Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -1256,14 +1256,18 @@ protected void checkLiveInstancesObservation(List<LiveInstance> liveInstances,\n \n         for (String instance : curInstances.keySet()) {\n           if (lastInstances == null || !lastInstances.containsKey(instance)) {\n-            try {\n-              manager.addCustomizedStateRootChangeListener(this, instance);\n-              logger.info(manager.getInstanceName() + \" added customized root change listener for\"\n-                  + \" \" + instance\n-                  + \", listener: \" + this);\n-            } catch (Exception e) {\n-              logger.error(\"Fail to add customized root change listener for instance: \" + instance,\n-                  e);\n+            PropertyKey propertyKey =\n+                keyBuilder.customizedStatesRoot(instance);\n+            if (propertyKey.getPath() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ4Mzc4OQ=="}, "originalCommit": {"oid": "768ec8090b9b27888d140abdd9b47ba8c52c9545"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5MzEzNA==", "bodyText": "Yes, for backward compatibility, you need to check the root path existence in ZK. This check is not very meaningful. You're basically doing if (\"~~/instanceName\" != null), which always evaluates to true.\nYou can use the data accessor from the HelixManager instance here for an exist check.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431493134", "createdAt": "2020-05-27T23:09:44Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -1256,14 +1256,18 @@ protected void checkLiveInstancesObservation(List<LiveInstance> liveInstances,\n \n         for (String instance : curInstances.keySet()) {\n           if (lastInstances == null || !lastInstances.containsKey(instance)) {\n-            try {\n-              manager.addCustomizedStateRootChangeListener(this, instance);\n-              logger.info(manager.getInstanceName() + \" added customized root change listener for\"\n-                  + \" \" + instance\n-                  + \", listener: \" + this);\n-            } catch (Exception e) {\n-              logger.error(\"Fail to add customized root change listener for instance: \" + instance,\n-                  e);\n+            PropertyKey propertyKey =\n+                keyBuilder.customizedStatesRoot(instance);\n+            if (propertyKey.getPath() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ4Mzc4OQ=="}, "originalCommit": {"oid": "768ec8090b9b27888d140abdd9b47ba8c52c9545"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzUwMzU3OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMjo0NToyM1rOGbfvLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMzoxNDo0MFrOGbgWTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ4NDcxNw==", "bodyText": "\"customized root change\" is confusing. Could we explicitly state what it is? For example,\n\"Added (or Failed to add) the root path for Customized State ...\"\nAlso, this log doesn't seem entirely necessary. Don't need to log every time we add a listener - I'd make this a debug log so as not to pollute the log.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431484717", "createdAt": "2020-05-27T22:45:23Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -1256,14 +1256,18 @@ protected void checkLiveInstancesObservation(List<LiveInstance> liveInstances,\n \n         for (String instance : curInstances.keySet()) {\n           if (lastInstances == null || !lastInstances.containsKey(instance)) {\n-            try {\n-              manager.addCustomizedStateRootChangeListener(this, instance);\n-              logger.info(manager.getInstanceName() + \" added customized root change listener for\"\n-                  + \" \" + instance\n-                  + \", listener: \" + this);\n-            } catch (Exception e) {\n-              logger.error(\"Fail to add customized root change listener for instance: \" + instance,\n-                  e);\n+            PropertyKey propertyKey =\n+                keyBuilder.customizedStatesRoot(instance);\n+            if (propertyKey.getPath() != null) {\n+              try {\n+                manager.addCustomizedStateRootChangeListener(this, instance);\n+                logger.info(\n+                    manager.getInstanceName() + \" added customized root change listener for\" + \" \" + instance\n+                        + \", listener: \" + this);\n+              } catch (Exception e) {\n+                logger.error(\"Fail to add customized root change listener for instance: \" + instance,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "768ec8090b9b27888d140abdd9b47ba8c52c9545"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5NDczNA==", "bodyText": "I updated the log information. For log.info or log.debug, in the controller, all other listeners are added with log.info. I think this is for easy debug purpose. Please let me know if the previous convention should be changed.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431494734", "createdAt": "2020-05-27T23:14:40Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -1256,14 +1256,18 @@ protected void checkLiveInstancesObservation(List<LiveInstance> liveInstances,\n \n         for (String instance : curInstances.keySet()) {\n           if (lastInstances == null || !lastInstances.containsKey(instance)) {\n-            try {\n-              manager.addCustomizedStateRootChangeListener(this, instance);\n-              logger.info(manager.getInstanceName() + \" added customized root change listener for\"\n-                  + \" \" + instance\n-                  + \", listener: \" + this);\n-            } catch (Exception e) {\n-              logger.error(\"Fail to add customized root change listener for instance: \" + instance,\n-                  e);\n+            PropertyKey propertyKey =\n+                keyBuilder.customizedStatesRoot(instance);\n+            if (propertyKey.getPath() != null) {\n+              try {\n+                manager.addCustomizedStateRootChangeListener(this, instance);\n+                logger.info(\n+                    manager.getInstanceName() + \" added customized root change listener for\" + \" \" + instance\n+                        + \", listener: \" + this);\n+              } catch (Exception e) {\n+                logger.error(\"Fail to add customized root change listener for instance: \" + instance,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ4NDcxNw=="}, "originalCommit": {"oid": "768ec8090b9b27888d140abdd9b47ba8c52c9545"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzU4NjAxOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMzoyMjoyN1rOGbggMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzoxMzoxNlrOGb-5eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5NzI2Nw==", "bodyText": "Do you think it would be useful to log (warn) if this evaluates to false?", "url": "https://github.com/apache/helix/pull/1033#discussion_r431497267", "createdAt": "2020-05-27T23:22:27Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {\n+      addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n+          ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5NTI1Ng==", "bodyText": "I remember we say that if participant's version is older than the controller version, it's fine? If so then I think we may not need to log it.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431995256", "createdAt": "2020-05-28T17:13:16Z", "author": {"login": "mgao0"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {\n+      addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n+          ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5NzI2Nw=="}, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzYxMzYxOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "isResolved": true, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMzozNTozOFrOGbgwqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMzoyNDo0NVrOGew0rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTQ4Mw==", "bodyText": "I am concerned about the performance. This check adds more time for adding listeners because of network latency. I wonder if there is a better way so this check could be avoided.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431501483", "createdAt": "2020-05-27T23:35:38Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMjYyMA==", "bodyText": "If we don't check path, the only way I can think of is to check participant side version.  Doesn't sounds a clean way though.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431502620", "createdAt": "2020-05-27T23:39:17Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTQ4Mw=="}, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMzA5MA==", "bodyText": "Maybe we could just change the the log in callback handler not to log the exception stack trace.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431503090", "createdAt": "2020-05-27T23:40:47Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTQ4Mw=="}, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwNTQ1OQ==", "bodyText": "That would impact all the exceptions right? Then it's not good for debugging purpose.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431505459", "createdAt": "2020-05-27T23:48:21Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTQ4Mw=="}, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzNTYxNQ==", "bodyText": "It is just a warn log. I think it is OK not to print the stack trace. And if the stack trace is necessary, we could keep the stack trace for the other paths, but for this customized state path, just log the message.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431535615", "createdAt": "2020-05-28T01:41:07Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTQ4Mw=="}, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0MTIwNw==", "bodyText": "exists() check is not a heavyweight ZK operation and considering we only call this when there's a LiveInstance change (or periodic rebalance), I don't think performance is a concern here.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431541207", "createdAt": "2020-05-28T02:03:00Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTQ4Mw=="}, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3NTk5Mw==", "bodyText": "Dummy question, why participant needs to listen on customized view changes? Only controller needs to listen on the change, not?", "url": "https://github.com/apache/helix/pull/1033#discussion_r431975993", "createdAt": "2020-05-28T16:41:36Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTQ4Mw=="}, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3ODgxNw==", "bodyText": "Participant does not need to listen on customized view change. The backward compatibility issue happens when we have a new version controller, while the client is on an old version participant. The new path INSTANCES/CUSTOMIZED_STATES does not exist, but controller will try to add listener to that path during live instance change. Then zkclient will have a no node exception. It's fine, just a warn, but kind of pollute client's log and make them confused.", "url": "https://github.com/apache/helix/pull/1033#discussion_r431978817", "createdAt": "2020-05-28T16:46:29Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTQ4Mw=="}, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjczNDkzMQ==", "bodyText": "Shall we have some logs to indicate it is not able to subscribe? Maybe warning or something? Because after adding this check, it will be silently ignore the subscription.", "url": "https://github.com/apache/helix/pull/1033#discussion_r432734931", "createdAt": "2020-05-29T21:05:27Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTQ4Mw=="}, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDkxMDM4Mw==", "bodyText": "I updated this rb with a solution to avoid stack trace in our customers who have not updated their helix-lib version. As discussed before, this is the simplest while robust way to solve the issue without performance penalty. For further improvement on customized state listener, we track in this issue: #1046 and tackle it later.", "url": "https://github.com/apache/helix/pull/1033#discussion_r434910383", "createdAt": "2020-06-03T23:24:45Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -591,8 +591,11 @@ public void addCurrentStateChangeListener(org.apache.helix.CurrentStateChangeLis\n   @Override\n   public void addCustomizedStateRootChangeListener(CustomizedStateRootChangeListener listener,\n       String instanceName) throws Exception {\n-    addListener(listener, new Builder(_clusterName).customizedStatesRoot(instanceName),\n-        ChangeType.CUSTOMIZED_STATE_ROOT, new EventType[]{EventType.NodeChildrenChanged});\n+    PropertyKey propertyKey = _dataAccessor.keyBuilder().customizedStatesRoot(instanceName);\n+    if (_zkclient.exists(propertyKey.getPath())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTQ4Mw=="}, "originalCommit": {"oid": "c6704924cc97d3d86dff8105b7299d744bae44ab"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMDQ4MTg3OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjo0Nzo1NVrOGdch9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMToyMzoxMFrOGeuGiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyOTMzNA==", "bodyText": "I understand you may want to keep logging as original. But since you are changing the logging code here, I suggest changing it to use parameterized logging: logger.info(\"Hello {}\", world);. This parameterized logging has benefits of reduce string concatenation overhead when logging level info is not enabled, and easier to read in the code. Same as the other places in this PR.\nNit, I realized this for loop needs unindent.", "url": "https://github.com/apache/helix/pull/1033#discussion_r433529334", "createdAt": "2020-06-01T22:47:55Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -1258,12 +1258,12 @@ protected void checkLiveInstancesObservation(List<LiveInstance> liveInstances,\n           if (lastInstances == null || !lastInstances.containsKey(instance)) {\n             try {\n               manager.addCustomizedStateRootChangeListener(this, instance);\n-              logger.info(manager.getInstanceName() + \" added customized root change listener for\"\n-                  + \" \" + instance\n-                  + \", listener: \" + this);\n+              logger.info(manager.getInstanceName() + \" added root path listener for customized \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24cb974cb548df3a4906da625743ba9c9e920438"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg2NTgwMw==", "bodyText": "+ \"state change for\" + \" \"\nCan we please refine the format as well.", "url": "https://github.com/apache/helix/pull/1033#discussion_r434865803", "createdAt": "2020-06-03T21:23:10Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -1258,12 +1258,12 @@ protected void checkLiveInstancesObservation(List<LiveInstance> liveInstances,\n           if (lastInstances == null || !lastInstances.containsKey(instance)) {\n             try {\n               manager.addCustomizedStateRootChangeListener(this, instance);\n-              logger.info(manager.getInstanceName() + \" added customized root change listener for\"\n-                  + \" \" + instance\n-                  + \", listener: \" + this);\n+              logger.info(manager.getInstanceName() + \" added root path listener for customized \"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyOTMzNA=="}, "originalCommit": {"oid": "24cb974cb548df3a4906da625743ba9c9e920438"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMDQ4NDY5OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjo0OTozNFrOGdcj2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjo0OTozNFrOGdcj2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyOTgxOA==", "bodyText": "fail to -> Failed to ? Same for the others.", "url": "https://github.com/apache/helix/pull/1033#discussion_r433529818", "createdAt": "2020-06-01T22:49:34Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -639,8 +638,13 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n             }\n           }\n         } catch (ZkNoNodeException | HelixMetaDataAccessException e) {\n-          logger.warn(\n-              \"fail to subscribe child/data change. path: \" + path + \", listener: \" + _listener, e);\n+          if (_changeType == CUSTOMIZED_STATE_ROOT) {\n+            logger.warn(\n+                \"fail to subscribe child/data change. path: \" + path + \", listener: \" + _listener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24cb974cb548df3a4906da625743ba9c9e920438"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODc2ODM2OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMToyMzo1MVrOGeuHwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMToyMzo1MVrOGeuHwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg2NjExNA==", "bodyText": "Why use 2 separate sections for the constant string contents?", "url": "https://github.com/apache/helix/pull/1033#discussion_r434866114", "createdAt": "2020-06-03T21:23:51Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -1258,12 +1258,12 @@ protected void checkLiveInstancesObservation(List<LiveInstance> liveInstances,\n           if (lastInstances == null || !lastInstances.containsKey(instance)) {\n             try {\n               manager.addCustomizedStateRootChangeListener(this, instance);\n-              logger.info(manager.getInstanceName() + \" added customized root change listener for\"\n-                  + \" \" + instance\n-                  + \", listener: \" + this);\n+              logger.info(manager.getInstanceName() + \" added root path listener for customized \"\n+                  + \"state change for\" + \" \" + instance + \", listener: \" + this);\n             } catch (Exception e) {\n-              logger.error(\"Fail to add customized root change listener for instance: \" + instance,\n-                  e);\n+              logger.error(\n+                  \"Fail to add root path listener for customized state change\" + \"for instance: \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c62b51133b4cf0d48cb00ac5094c1cfa2a68f10"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwOTQwNTM0OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwMzowMzoyMVrOGe0NcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxODoxNjoyM1rOGfSEWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk2NTg3Mw==", "bodyText": "Can we just merge these two conditions? There's practically no difference. Or catch exceptions separately and log an appropriate, differentiated log message. Otherwise, this just looks like duplicate code.", "url": "https://github.com/apache/helix/pull/1033#discussion_r434965873", "createdAt": "2020-06-04T03:03:21Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -639,14 +639,20 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n             }\n           }\n         } catch (ZkNoNodeException | HelixMetaDataAccessException e) {\n-          logger.warn(\n-              \"fail to subscribe child/data change. path: \" + path + \", listener: \" + _listener, e);\n+          // TODO: avoid calling getChildren for path that does not exist\n+          if (_changeType == CUSTOMIZED_STATE_ROOT) {\n+            logger.warn(\"Failed to subscribe child/data change. path: {}, listener: {}\", path,\n+                _listener);\n+          } else {\n+            logger.warn(\"Failed to subscribe child/data change. path: {}, listener: {}\", path,\n+                _listener, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "401ae6f679b5d6c3071e298616c8bbe84b7092c8"}, "originalPosition": 178}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ1NTA2Ng==", "bodyText": "@narendly tried to remove duplicates. However, this will make the log and stacktrace to be in two entries. Won't look good.", "url": "https://github.com/apache/helix/pull/1033#discussion_r435455066", "createdAt": "2020-06-04T18:16:23Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -639,14 +639,20 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n             }\n           }\n         } catch (ZkNoNodeException | HelixMetaDataAccessException e) {\n-          logger.warn(\n-              \"fail to subscribe child/data change. path: \" + path + \", listener: \" + _listener, e);\n+          // TODO: avoid calling getChildren for path that does not exist\n+          if (_changeType == CUSTOMIZED_STATE_ROOT) {\n+            logger.warn(\"Failed to subscribe child/data change. path: {}, listener: {}\", path,\n+                _listener);\n+          } else {\n+            logger.warn(\"Failed to subscribe child/data change. path: {}, listener: {}\", path,\n+                _listener, e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk2NTg3Mw=="}, "originalCommit": {"oid": "401ae6f679b5d6c3071e298616c8bbe84b7092c8"}, "originalPosition": 178}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjA3NTUwOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo0NToxNVrOGf1xVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo0NToxNVrOGf1xVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA0MDAyMw==", "bodyText": "if (_changeType != CUSTOMIZED_STATE_ROOT) {\n  LOG.warn(\"Failed to subscribe .... Instance doesn't support Customized State!, path, _listerner);\n} else {\n  LOG.warn(\"Failed to.... \");\n}\n\nHow about this? this way you don't print all the exceptions stack trace, and it doesn't look like it's duplicate code, and the message is clear.", "url": "https://github.com/apache/helix/pull/1033#discussion_r436040023", "createdAt": "2020-06-05T16:45:15Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -639,14 +639,18 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n             }\n           }\n         } catch (ZkNoNodeException | HelixMetaDataAccessException e) {\n-          logger.warn(\n-              \"fail to subscribe child/data change. path: \" + path + \", listener: \" + _listener, e);\n+          logger.warn(\"Failed to subscribe child/data change. path: {}, listener: {}\", path,\n+              _listener);\n+          // TODO: avoid calling getChildren for path that does not exist\n+          if (_changeType != CUSTOMIZED_STATE_ROOT) {\n+            logger.warn(\"\", e);\n+          }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d41a8ac5009770739f635a386e85e5ddf7423a7"}, "originalPosition": 177}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1079, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}