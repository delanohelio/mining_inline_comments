{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMDU4NDEw", "number": 829, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMjoyMDozNFrODjobcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMDozNTowNVrODjqMGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4Njg5MTM5OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMjoyMDozNFrOFvjQyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMDowMjoxNVrOFvlZiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQwNTEzMA==", "bodyText": "After making the fix, handleChildChange and handleDataDeleted are completely equal now. I added a comment on line 127 based on what you told me to justify the duplication - sometimes the callbacks may go missing. Should we consider calling handleDataDeleted from handleChildChange, for example, to reduce duplication? @narendly", "url": "https://github.com/apache/helix/pull/829#discussion_r385405130", "createdAt": "2020-02-27T22:20:34Z", "author": {"login": "NealSun96"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "diffHunk": "@@ -134,6 +147,7 @@ public synchronized void handleChildChange(String s, List<String> list) {\n \n     // Subscribe data changes again because some children might have been deleted or added\n     _zkClient.unsubscribeAll();\n+    _zkClient.subscribeChildChanges(MetadataStoreRoutingConstants.ROUTING_DATA_PATH, this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7650dcadf314ea517989259fecb19be7b6739b8c"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MDEzNg==", "bodyText": "Resolved offline.", "url": "https://github.com/apache/helix/pull/829#discussion_r385440136", "createdAt": "2020-02-28T00:02:15Z", "author": {"login": "NealSun96"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "diffHunk": "@@ -134,6 +147,7 @@ public synchronized void handleChildChange(String s, List<String> list) {\n \n     // Subscribe data changes again because some children might have been deleted or added\n     _zkClient.unsubscribeAll();\n+    _zkClient.subscribeChildChanges(MetadataStoreRoutingConstants.ROUTING_DATA_PATH, this);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQwNTEzMA=="}, "originalCommit": {"oid": "7650dcadf314ea517989259fecb19be7b6739b8c"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NzEyMjI2OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/common/HttpConstants.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMDowMzo0MVrOFvlbEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMDoxNDoxOVrOFvlnbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MDUyOQ==", "bodyText": "Nit: How about something like HTTP_PREFIX?", "url": "https://github.com/apache/helix/pull/829#discussion_r385440529", "createdAt": "2020-02-28T00:03:41Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/common/HttpConstants.java", "diffHunk": "@@ -26,4 +26,6 @@\n     PUT,\n     DELETE\n   }\n+\n+  public static final String HTTP_PROTOCOL = \"http://\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38278be73231ca5ec1f71d61957a41a5386720fb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MzY5NA==", "bodyText": "Good point, I'll opt for HTTP_PROTOCAL_PREFIX. It is a protocol and it is also a prefix.", "url": "https://github.com/apache/helix/pull/829#discussion_r385443694", "createdAt": "2020-02-28T00:14:19Z", "author": {"login": "NealSun96"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/common/HttpConstants.java", "diffHunk": "@@ -26,4 +26,6 @@\n     PUT,\n     DELETE\n   }\n+\n+  public static final String HTTP_PROTOCOL = \"http://\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MDUyOQ=="}, "originalCommit": {"oid": "38278be73231ca5ec1f71d61957a41a5386720fb"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NzEyNzc4OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMDowNjozM1rOFvlebQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMDoxNjoxNVrOFvlpyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MTM4OQ==", "bodyText": "Null check on allRealmAddress just in case?", "url": "https://github.com/apache/helix/pull/829#discussion_r385441389", "createdAt": "2020-02-28T00:06:33Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "diffHunk": "@@ -90,10 +99,12 @@ public ZkRoutingDataReader(String namespace, String zkAddress,\n     for (String realmAddress : allRealmAddresses) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38278be73231ca5ec1f71d61957a41a5386720fb"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0NDI5OA==", "bodyText": "I'll add it, but is that case actually possible?", "url": "https://github.com/apache/helix/pull/829#discussion_r385444298", "createdAt": "2020-02-28T00:16:15Z", "author": {"login": "NealSun96"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "diffHunk": "@@ -90,10 +99,12 @@ public ZkRoutingDataReader(String namespace, String zkAddress,\n     for (String realmAddress : allRealmAddresses) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MTM4OQ=="}, "originalCommit": {"oid": "38278be73231ca5ec1f71d61957a41a5386720fb"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NzEzMDQ5OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMDowNzo0OFrOFvlf_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMDoxNjozNVrOFvlqOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MTc4OA==", "bodyText": "Please refactor the logic out into a private method and call it handleResubscription() and call it in both of these methods.", "url": "https://github.com/apache/helix/pull/829#discussion_r385441788", "createdAt": "2020-02-28T00:07:48Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "diffHunk": "@@ -128,17 +142,7 @@ public synchronized void handleDataDeleted(String s) {\n \n   @Override\n   public synchronized void handleChildChange(String s, List<String> list) {\n-    if (_zkClient.isClosed()) {\n-      return;\n-    }\n-\n-    // Subscribe data changes again because some children might have been deleted or added\n-    _zkClient.unsubscribeAll();\n-    for (String child : _zkClient.getChildren(MetadataStoreRoutingConstants.ROUTING_DATA_PATH)) {\n-      _zkClient.subscribeDataChanges(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + child,\n-          this);\n-    }\n-    _routingDataListener.refreshRoutingData(_namespace);\n+    handleDataDeleted(s);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38278be73231ca5ec1f71d61957a41a5386720fb"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0NDQxMQ==", "bodyText": "Ack.", "url": "https://github.com/apache/helix/pull/829#discussion_r385444411", "createdAt": "2020-02-28T00:16:35Z", "author": {"login": "NealSun96"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "diffHunk": "@@ -128,17 +142,7 @@ public synchronized void handleDataDeleted(String s) {\n \n   @Override\n   public synchronized void handleChildChange(String s, List<String> list) {\n-    if (_zkClient.isClosed()) {\n-      return;\n-    }\n-\n-    // Subscribe data changes again because some children might have been deleted or added\n-    _zkClient.unsubscribeAll();\n-    for (String child : _zkClient.getChildren(MetadataStoreRoutingConstants.ROUTING_DATA_PATH)) {\n-      _zkClient.subscribeDataChanges(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + child,\n-          this);\n-    }\n-    _routingDataListener.refreshRoutingData(_namespace);\n+    handleDataDeleted(s);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MTc4OA=="}, "originalCommit": {"oid": "38278be73231ca5ec1f71d61957a41a5386720fb"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NzE3OTc5OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMDozNTowNVrOFvl-DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMDozNTowNVrOFvl-DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0OTQ4NA==", "bodyText": "format", "url": "https://github.com/apache/helix/pull/829#discussion_r385449484", "createdAt": "2020-02-28T00:35:05Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "diffHunk": "@@ -87,13 +96,18 @@ public ZkRoutingDataReader(String namespace, String zkAddress,\n           \"Routing data directory ZNode \" + MetadataStoreRoutingConstants.ROUTING_DATA_PATH\n               + \" does not exist. Routing ZooKeeper address: \" + _zkAddress);\n     }\n-    for (String realmAddress : allRealmAddresses) {\n-      ZNRecord record =\n-          _zkClient.readData(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + realmAddress);\n-      List<String> shardingKeys =\n-          record.getListField(MetadataStoreRoutingConstants.ZNRECORD_LIST_FIELD_KEY);\n-      routingData\n-          .put(realmAddress, shardingKeys != null ? shardingKeys : Collections.emptyList());\n+    if (allRealmAddresses != null)\n+    {\n+      for (String realmAddress : allRealmAddresses) {\n+        ZNRecord record =\n+            _zkClient.readData(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + realmAddress);\n+        if (record != null) {\n+          List<String> shardingKeys =\n+              record.getListField(MetadataStoreRoutingConstants.ZNRECORD_LIST_FIELD_KEY);\n+          routingData\n+              .put(realmAddress, shardingKeys != null ? shardingKeys : Collections.emptyList());\n+        }\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cc4d9452019577604928dfc8c8d374b1c49dbbd"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1701, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}