{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMzY3NDA5", "number": 1485, "title": "Add offline node purge timeout in cluster config", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nFixed #1484\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nHelix plans to support the purge of offline nodes that have passed the timeout defined by users. As a prerequisite, we need to provide a simple field in cluster config for users to define the default timeout. This PR add one more field in cluster config for offline nodes timeout to be purged.\nTests\n\n The following tests are written for this issue:\n\nTestClusterConfig\n\n The following is the result of the \"mvn test\" command on the appropriate module:\nhelix-core:\n[ERROR] Failures:\n[ERROR]   TestRoutingTableProviderPeriodicRefresh.testPeriodicRefresh:214 expected:<4> but was:<3>\n[ERROR]   TestDeleteJobFromJobQueue.testForceDeleteJobFromJobQueue:73 \u00bb Helix Failed to ...\n[INFO]\n[ERROR] Tests run: 1236, Failures: 2, Errors: 0, Skipped: 1\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD FAILURE\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  01:22 h\n[INFO] Finished at: 2020-10-27T13:12:36-07:00\n\nDocumentation (Optional)\n\nIn case of new functionality, my PR adds documentation in the following wiki page:\n\n(Link the GitHub wiki you added)\nCommits\n\nMy commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\nMy diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-10-26T23:32:50Z", "url": "https://github.com/apache/helix/pull/1485", "merged": true, "mergeCommit": {"oid": "e391119f82b1fe4e182c753fc48782224389bebc"}, "closed": true, "closedAt": "2020-10-27T21:02:08Z", "author": {"login": "zhangmeng916"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWdAYdAH2gAyNTEwMzY3NDA5OmNjOWIyMjA5ZDU3OTY2NjE0YTMxZjllOTE0NTU1NDQxZDE5ZTUyMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWtbd_AH2gAyNTEwMzY3NDA5OmM3OGM3ZWIyNjdiMzE5NDc0ZDE0OTRiYTAyNzQ1MjQ5MTJjNzQwZjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cc9b2209d57966614a31f9e914555441d19e5204", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/cc9b2209d57966614a31f9e914555441d19e5204", "committedDate": "2020-10-26T23:31:14Z", "message": "Add offline node purge timeout in cluster config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTg5OTY4", "url": "https://github.com/apache/helix/pull/1485#pullrequestreview-517989968", "createdAt": "2020-10-27T17:53:03Z", "commit": {"oid": "cc9b2209d57966614a31f9e914555441d19e5204"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDAyMzI2", "url": "https://github.com/apache/helix/pull/1485#pullrequestreview-518002326", "createdAt": "2020-10-27T18:07:32Z", "commit": {"oid": "cc9b2209d57966614a31f9e914555441d19e5204"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowNzozMlrOHpKC_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowNzozMlrOHpKC_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxODI3MQ==", "bodyText": "nit, additional \"I\" at end of this line.", "url": "https://github.com/apache/helix/pull/1485#discussion_r512918271", "createdAt": "2020-10-27T18:07:32Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/model/ClusterConfig.java", "diffHunk": "@@ -937,6 +940,27 @@ public long getOfflineNodeTimeOutForMaintenanceMode() {\n             OFFLINE_NODE_TIME_OUT_FOR_MAINTENANCE_MODE_NOT_SET);\n   }\n \n+  /**\n+   * Set the default time out window for offline nodes to be purged. If an offline node has been\n+   * offline for more than this specified time period, when users call purge participants API,\n+   * the node will be dropped.\n+   * @param timeOut timeout window in milliseconds.\n+   */\n+  public void setOfflineNodeTimeOutForPurge(long timeOut) {\n+    _record.setLongField(ClusterConfigProperty.OFFLINE_NODE_TIME_OUT_FOR_PURGE.name(),\n+        timeOut);\n+  }\n+\n+  /**\n+   * Get the default time out window for offline nodes to be purged. I", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc9b2209d57966614a31f9e914555441d19e5204"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDA0Mjg2", "url": "https://github.com/apache/helix/pull/1485#pullrequestreview-518004286", "createdAt": "2020-10-27T18:09:58Z", "commit": {"oid": "cc9b2209d57966614a31f9e914555441d19e5204"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowOTo1OFrOHpKKlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowOTo1OFrOHpKKlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkyMDIxMg==", "bodyText": "This test really is not necessary. All the logic seems tested in testGetOfflineNodeTimeOutForPurge() anyway.", "url": "https://github.com/apache/helix/pull/1485#discussion_r512920212", "createdAt": "2020-10-27T18:09:58Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/test/java/org/apache/helix/model/TestClusterConfig.java", "diffHunk": "@@ -320,6 +320,29 @@ public void testSetOfflineNodeTimeOutForMaintenanceMode() {\n             -1), 10000L);\n   }\n \n+\n+  @Test\n+  public void testGetOfflineNodeTimeOutForPurge() {\n+    ClusterConfig testConfig = new ClusterConfig(\"testId\");\n+    Assert.assertEquals(testConfig.getOfflineNodeTimeOutForPurge(), -1);\n+\n+    testConfig.getRecord()\n+        .setLongField(ClusterConfig.ClusterConfigProperty.OFFLINE_NODE_TIME_OUT_FOR_PURGE\n+                .name(),\n+            10000L);\n+    Assert.assertEquals(testConfig.getOfflineNodeTimeOutForPurge(), 10000L);\n+  }\n+\n+  @Test\n+  public void testSetOfflineNodeTimeOutForPurge() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc9b2209d57966614a31f9e914555441d19e5204"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDA0NDI0", "url": "https://github.com/apache/helix/pull/1485#pullrequestreview-518004424", "createdAt": "2020-10-27T18:10:07Z", "commit": {"oid": "cc9b2209d57966614a31f9e914555441d19e5204"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDE5MDYz", "url": "https://github.com/apache/helix/pull/1485#pullrequestreview-518019063", "createdAt": "2020-10-27T18:28:23Z", "commit": {"oid": "cc9b2209d57966614a31f9e914555441d19e5204"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODoyODoyNFrOHpK7aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODoyODoyNFrOHpK7aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzMjcxMw==", "bodyText": "nit, comment to explain the option please", "url": "https://github.com/apache/helix/pull/1485#discussion_r512932713", "createdAt": "2020-10-27T18:28:24Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/model/ClusterConfig.java", "diffHunk": "@@ -128,7 +128,9 @@\n     // offline for more than this specified time period, it's treated as offline for the rest of\n     // the maintenance mode's duration even when it comes online.\n     // The unit is milliseconds.\n-    OFFLINE_NODE_TIME_OUT_FOR_MAINTENANCE_MODE\n+    OFFLINE_NODE_TIME_OUT_FOR_MAINTENANCE_MODE,\n+\n+    OFFLINE_NODE_TIME_OUT_FOR_PURGE", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc9b2209d57966614a31f9e914555441d19e5204"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDIxNjI0", "url": "https://github.com/apache/helix/pull/1485#pullrequestreview-518021624", "createdAt": "2020-10-27T18:31:28Z", "commit": {"oid": "cc9b2209d57966614a31f9e914555441d19e5204"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODozMToyOVrOHpLDKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODozMToyOVrOHpLDKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzNDY5OQ==", "bodyText": "not necessarily to be changed here, but maybe we want to have one single static var VALUE_NOT_SET = -1.", "url": "https://github.com/apache/helix/pull/1485#discussion_r512934699", "createdAt": "2020-10-27T18:31:29Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/model/ClusterConfig.java", "diffHunk": "@@ -158,6 +160,7 @@\n   public final static boolean DEFAULT_GLOBAL_REBALANCE_ASYNC_MODE_ENABLED = true;\n   private static final int GLOBAL_TARGET_TASK_THREAD_POOL_SIZE_NOT_SET = -1;\n   private static final long OFFLINE_NODE_TIME_OUT_FOR_MAINTENANCE_MODE_NOT_SET = -1;\n+  private static final long OFFLINE_NODE_TIME_OUT_FOR_PURGE_NOT_SET = -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc9b2209d57966614a31f9e914555441d19e5204"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c78c7eb267b319474d1494ba0274524912c740f6", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/c78c7eb267b319474d1494ba0274524912c740f6", "committedDate": "2020-10-27T18:39:18Z", "message": "fix comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4372, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}