{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3OTg3MTc5", "number": 1520, "title": "Implement job context garbage collection", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\nFixes #1519\n\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\nPreviously, the workflow context garbage collection has been implemented. In this PR, new methods have been added to remove the job contexts that do not have corresponding job config.\n\nTests\n\n\n The following tests are written for this issue:\ntestJobContextGarbageCollection\n\n\n The following is the result of the \"mvn test\" command on the appropriate module:\nHelix-core:\n\n\n[INFO] Tests run: 1246, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 5,202.964 s - in TestSuite\n[INFO] \n[INFO] Results:\n[INFO] \n[INFO] Tests run: 1246, Failures: 0, Errors: 0, Skipped: 0\n[INFO] \n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  01:26 h\n[INFO] Finished at: 2020-11-09T11:09:53-08:00\n[INFO] ------------------------------------------------------------------------\n\nHelix-rest:\n[INFO] Tests run: 171, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 242.915 s - in TestSuite\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 171, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  04:06 min\n[INFO] Finished at: 2020-11-09T11:24:06-08:00\n[INFO] ------------------------------------------------------------------------\n\nCommits\n\nMy commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\nMy diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-11-09T19:24:39Z", "url": "https://github.com/apache/helix/pull/1520", "merged": true, "mergeCommit": {"oid": "56161ecdbf8c1b55529e79ab720232a7b08328bc"}, "closed": true, "closedAt": "2020-11-13T22:21:26Z", "author": {"login": "alirezazamani"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdan-XYgH2gAyNTE3OTg3MTc5OmY3NGJhMjRkMTlhN2U4NWM1ZmNkNjllMGJiNDA1MzMyN2M3ZDI2NzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdb-EWDgBqjM5OTE1NTQ1MzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f74ba24d19a7e85c5fcd69e0bb4053327c7d2675", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/f74ba24d19a7e85c5fcd69e0bb4053327c7d2675", "committedDate": "2020-11-08T22:33:41Z", "message": "Add garbage collection for the job context\n\nPreviously, workflow context garbage collection has been added.\nIn this commit, new methods have been added to remove the job\nconetxts that does not have corresponding job config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/3f7ce747e97a1a05eb40e820d1972805fc6855bf", "committedDate": "2020-11-09T18:36:22Z", "message": "Fix rest related tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjgzMjcx", "url": "https://github.com/apache/helix/pull/1520#pullrequestreview-526683271", "createdAt": "2020-11-09T21:50:50Z", "commit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1MDo1MFrOHwDArA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1MDo1MFrOHwDArA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0MzAyMA==", "bodyText": "This is necessary to have due to #1391. Previously we were relying on the ideal state. Now once the config is added, the controller will process the job. If the job config does not have an ID field, TaskData cache does not see the config and the job will not get processed.", "url": "https://github.com/apache/helix/pull/1520#discussion_r520143020", "createdAt": "2020-11-09T21:50:50Z", "author": {"login": "alirezazamani"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/server/AbstractTestClass.java", "diffHunk": "@@ -451,7 +451,7 @@ protected ClusterControllerManager startController(String cluster) {\n     for (int i = 0; i < numJobs; i++) {\n       JobConfig.Builder job =\n           new JobConfig.Builder().setCommand(\"DummyCommand\").setTargetResource(\"RESOURCE\")\n-              .setWorkflow(workflowName);\n+              .setWorkflow(workflowName).setJobId(workflowName + \"_\" + JOB_PREFIX + i);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjgzNzcy", "url": "https://github.com/apache/helix/pull/1520#pullrequestreview-526683772", "createdAt": "2020-11-09T21:51:35Z", "commit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1MTozNVrOHwDCOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1MTozNVrOHwDCOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0MzQxOA==", "bodyText": "This change is necessary. This was not correct from the beginning of the change.", "url": "https://github.com/apache/helix/pull/1520#discussion_r520143418", "createdAt": "2020-11-09T21:51:35Z", "author": {"login": "alirezazamani"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/server/AbstractTestClass.java", "diffHunk": "@@ -105,7 +105,7 @@\n   // For a single-ZK/Helix environment\n   protected static final String ZK_ADDR = \"localhost:2123\";\n   protected static final String WORKFLOW_PREFIX = \"Workflow_\";\n-  protected static final String JOB_PREFIX = \"Job_\";\n+  protected static final String JOB_PREFIX = \"JOB\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Njg0NzY1", "url": "https://github.com/apache/helix/pull/1520#pullrequestreview-526684765", "createdAt": "2020-11-09T21:53:09Z", "commit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1MzoxMFrOHwDFVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1MzoxMFrOHwDFVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0NDIxMw==", "bodyText": "Since the test we are checking the accessor, this has been changed to FAILED. In this case, the status of the workflow will be unchanged and the controller does not change it. Hence, the job accessor test would work correctly.", "url": "https://github.com/apache/helix/pull/1520#discussion_r520144213", "createdAt": "2020-11-09T21:53:10Z", "author": {"login": "alirezazamani"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/server/AbstractTestClass.java", "diffHunk": "@@ -426,9 +426,9 @@ protected ClusterControllerManager startController(String cluster) {\n       }\n       workflows.put(WORKFLOW_PREFIX + i, workflow.build());\n       WorkflowContext workflowContext = TaskTestUtil\n-          .buildWorkflowContext(WORKFLOW_PREFIX + i, TaskState.IN_PROGRESS,\n+          .buildWorkflowContext(WORKFLOW_PREFIX + i, TaskState.FAILED,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Njg1MDkx", "url": "https://github.com/apache/helix/pull/1520#pullrequestreview-526685091", "createdAt": "2020-11-09T21:53:44Z", "commit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1Mzo0NFrOHwDGWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1Mzo0NFrOHwDGWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0NDQ3Mg==", "bodyText": "See the comments above for an explanation of this change.", "url": "https://github.com/apache/helix/pull/1520#discussion_r520144472", "createdAt": "2020-11-09T21:53:44Z", "author": {"login": "alirezazamani"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestWorkflowAccessor.java", "diffHunk": "@@ -112,7 +112,7 @@ public void testGetWorkflowContext() throws IOException {\n         Response.Status.OK.getStatusCode(), true);\n     JsonNode node = OBJECT_MAPPER.readTree(body);\n     Assert.assertEquals(node.get(\"STATE\").textValue(),\n-        TaskState.IN_PROGRESS.name());\n+        TaskState.FAILED.name());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Njg1MjIy", "url": "https://github.com/apache/helix/pull/1520#pullrequestreview-526685222", "createdAt": "2020-11-09T21:53:57Z", "commit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1Mzo1N1rOHwDGtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1Mzo1N1rOHwDGtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0NDU2NQ==", "bodyText": "See the comments above for an explanation of this change.", "url": "https://github.com/apache/helix/pull/1520#discussion_r520144565", "createdAt": "2020-11-09T21:53:57Z", "author": {"login": "alirezazamani"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestJobAccessor.java", "diffHunk": "@@ -178,8 +178,8 @@ public void testGetAddJobContent() throws IOException {\n   @Test(dependsOnMethods = \"testGetAddJobContent\")\n   public void testInvalidGetAndUpdateJobContentStore() {\n     System.out.println(\"Start test :\" + TestHelper.getTestMethodName());\n-    String validURI = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/Job_0/userContent\";\n-    String invalidURI1 = \"clusters/\" + CLUSTER_NAME + \"/workflows/xxx/jobs/Job_0/userContent\"; // workflow not exist\n+    String validURI = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/JOB0/userContent\";\n+    String invalidURI1 = \"clusters/\" + CLUSTER_NAME + \"/workflows/xxx/jobs/JOB0/userContent\"; // workflow not exist", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Njg1MjYw", "url": "https://github.com/apache/helix/pull/1520#pullrequestreview-526685260", "createdAt": "2020-11-09T21:54:00Z", "commit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1NDowMVrOHwDG2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1NDowMVrOHwDG2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0NDYwMA==", "bodyText": "See the comments above for an explanation of this change.", "url": "https://github.com/apache/helix/pull/1520#discussion_r520144600", "createdAt": "2020-11-09T21:54:01Z", "author": {"login": "alirezazamani"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestTaskAccessor.java", "diffHunk": "@@ -38,8 +38,8 @@\n   @Test\n   public void testGetAddTaskUserContent() throws IOException {\n     System.out.println(\"Start test :\" + TestHelper.getTestMethodName());\n-    String uri = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/Job_0/tasks/0/userContent\";\n-    String uriTaskDoesNotExist = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/Job_0/tasks/xxx/userContent\";\n+    String uri = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/JOB0/tasks/0/userContent\";\n+    String uriTaskDoesNotExist = \"clusters/\" + CLUSTER_NAME + \"/workflows/Workflow_0/jobs/JOB0/tasks/xxx/userContent\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTE3MjY1", "url": "https://github.com/apache/helix/pull/1520#pullrequestreview-527517265", "createdAt": "2020-11-10T18:59:43Z", "commit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODo1OTo0M1rOHwrRWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOTowMjo1OFrOHwrc_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwMjY1MA==", "bodyText": "We may differentiate the names. Otherwise, it could be confusing.", "url": "https://github.com/apache/helix/pull/1520#discussion_r520802650", "createdAt": "2020-11-10T18:59:43Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/controller/stages/AttributeName.java", "diffHunk": "@@ -48,5 +48,7 @@\n   // This attribute should only be used in TaskGarbageCollectionStage, misuse could cause race conditions.\n   TO_BE_PURGED_WORKFLOWS,\n   // This attribute should only be used in TaskGarbageCollectionStage, misuse could cause race conditions.\n+  TO_BE_PURGED_JOBS,\n+  // This attribute should only be used in TaskGarbageCollectionStage, misuse could cause race conditions.\n   TO_BE_PURGED_JOBS_MAP", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwNTYzMA==", "bodyText": "Could this job still exist in WF context? Do we need to scan WF context and clean them up?", "url": "https://github.com/apache/helix/pull/1520#discussion_r520805630", "createdAt": "2020-11-10T19:02:58Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/controller/stages/TaskGarbageCollectionStage.java", "diffHunk": "@@ -93,12 +97,18 @@ public void process(ClusterEvent event) throws Exception {\n           .equals(TaskUtil.WORKFLOW_CONTEXT_KW)) {\n         // Find workflows that need to be purged\n         workflowsToBePurged.add(entry.getKey());\n+      } else if (jobConfig == null && entry.getValue() != null && entry.getValue().getId()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7ce747e97a1a05eb40e820d1972805fc6855bf"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85ddf61bc33780d40fb593b3399397f5fd7b611e", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/85ddf61bc33780d40fb593b3399397f5fd7b611e", "committedDate": "2020-11-10T23:48:03Z", "message": "Address commments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MzY0NjU4", "url": "https://github.com/apache/helix/pull/1520#pullrequestreview-529364658", "createdAt": "2020-11-12T18:18:40Z", "commit": {"oid": "85ddf61bc33780d40fb593b3399397f5fd7b611e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDA5MDI2", "url": "https://github.com/apache/helix/pull/1520#pullrequestreview-529409026", "createdAt": "2020-11-12T19:12:59Z", "commit": {"oid": "85ddf61bc33780d40fb593b3399397f5fd7b611e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOToxMjo1OVrOHyJ28A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOToyMDo0N1rOHyKHsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1MjM2OA==", "bodyText": "One minor question, why not call it TO_BE_PURGED_JOB directly?", "url": "https://github.com/apache/helix/pull/1520#discussion_r522352368", "createdAt": "2020-11-12T19:12:59Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/stages/AttributeName.java", "diffHunk": "@@ -48,5 +48,7 @@\n   // This attribute should only be used in TaskGarbageCollectionStage, misuse could cause race conditions.\n   TO_BE_PURGED_WORKFLOWS,\n   // This attribute should only be used in TaskGarbageCollectionStage, misuse could cause race conditions.\n+  JOBS_WITHOUT_CONFIG,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85ddf61bc33780d40fb593b3399397f5fd7b611e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NTQ3Mg==", "bodyText": "This section is almost identical as removeJob(), could you please merge?", "url": "https://github.com/apache/helix/pull/1520#discussion_r522355472", "createdAt": "2020-11-12T19:18:40Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1142,6 +1142,35 @@ public static void workflowGarbageCollection(final Set<String> toBePurgedWorkflo\n     }\n   }\n \n+  /**\n+   * The function that removes IdealStates and job contexts of the jobs that need to be\n+   * deleted.\n+   * @param toBePurgedJobs\n+   * @param manager\n+   */\n+  public static void jobGarbageCollection(final Set<String> toBePurgedJobs,\n+      final HelixManager manager) {\n+    HelixDataAccessor accessor = manager.getHelixDataAccessor();\n+    HelixPropertyStore<ZNRecord> propertyStore = manager.getHelixPropertyStore();\n+\n+    for (String jobName : toBePurgedJobs) {\n+      LOG.warn(\n+          \"JobContext exists for job {}. However, job Config is missing! Deleting the JobContext and IdealState!!\",\n+          jobName);\n+\n+      // TODO: We dont need this in the future when TF is not relying on IS/EV anymore.\n+      if (!cleanupJobIdealStateExtView(accessor, jobName)) {\n+        LOG.warn(\"Error occurred while trying to remove job idealstate/externalview for {}.\",\n+            jobName);\n+        continue;\n+      }\n+\n+      if (!removeJobContext(propertyStore, jobName)) {\n+        LOG.warn(\"Error occurred while trying to remove job context for {}.\", jobName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85ddf61bc33780d40fb593b3399397f5fd7b611e"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NjY1OQ==", "bodyText": "I feel purgeExpiredJobs has a more complete logic to process if the removal fails. Why not using it directly. In this case, you won't need 2 lists in the event object. You can merge the job with no config to the expired job for purging.\nOr is there any conflict logic there?", "url": "https://github.com/apache/helix/pull/1520#discussion_r522356659", "createdAt": "2020-11-12T19:20:47Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -1142,6 +1142,35 @@ public static void workflowGarbageCollection(final Set<String> toBePurgedWorkflo\n     }\n   }\n \n+  /**\n+   * The function that removes IdealStates and job contexts of the jobs that need to be\n+   * deleted.\n+   * @param toBePurgedJobs\n+   * @param manager\n+   */\n+  public static void jobGarbageCollection(final Set<String> toBePurgedJobs,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85ddf61bc33780d40fb593b3399397f5fd7b611e"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b9f8123b286fae072c98326b4f147958911bc4c", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/9b9f8123b286fae072c98326b4f147958911bc4c", "committedDate": "2020-11-13T02:51:42Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2582242361be78efb44da987fb4857658f3396da", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/2582242361be78efb44da987fb4857658f3396da", "committedDate": "2020-11-12T20:51:18Z", "message": "Address comments"}, "afterCommit": {"oid": "9b9f8123b286fae072c98326b4f147958911bc4c", "author": {"user": {"login": "alirezazamani", "name": "Ali Reza Zamani Zadeh Najari"}}, "url": "https://github.com/apache/helix/commit/9b9f8123b286fae072c98326b4f147958911bc4c", "committedDate": "2020-11-13T02:51:42Z", "message": "Address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4109, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}