{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDM2MjUy", "number": 876, "title": "Add construction of domain in Helix participant logic", "bodyText": "Issues\n\n[X ] My PR addresses the following Helix issues and references them in the PR description:\n\n(#875 )\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nHelix has a topology defined in cluster config, e.g., \"TOPOLOGY\": \"/zone/host\", and it will be used to construct the \"domain\" field in participant config, e.g. \"\"DOMAIN\": \"zone=0,host=host1\". In Azure, Helix will provide a default topology value for the cluster, and the format is /faultDomain/hostName. In this pR, we add the construction function in Participant manager to construct the domain field based on this topology.\nTests\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\nCommits\n\n[X ] My commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\n[X ] My diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-03-06T21:48:52Z", "url": "https://github.com/apache/helix/pull/876", "merged": true, "mergeCommit": {"oid": "89c60fe9ed8e5430f8db0c67266ae544f4c3fccd"}, "closed": true, "closedAt": "2020-03-10T18:10:40Z", "author": {"login": "zhangmeng916"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLHUJ-ABqjMxMDY5ODkzNDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMFfTAgFqTM3MTU2NjA1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85314f89d36fafa664aa5e6b89a99bf9d4e3c687", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/85314f89d36fafa664aa5e6b89a99bf9d4e3c687", "committedDate": "2020-03-06T21:29:41Z", "message": "Add fault domain construction function to participant manager"}, "afterCommit": {"oid": "c59bc5e6e26f79a9441fcb76438ce9b2ab380b21", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/c59bc5e6e26f79a9441fcb76438ce9b2ab380b21", "committedDate": "2020-03-06T21:50:20Z", "message": "add domain construction in Helix participant manager"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjU3Nzgx", "url": "https://github.com/apache/helix/pull/876#pullrequestreview-370657781", "createdAt": "2020-03-06T22:11:01Z", "commit": {"oid": "c59bc5e6e26f79a9441fcb76438ce9b2ab380b21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMjoxMTowMVrOFzI-hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMjoxMTowMVrOFzI-hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2ODc3NA==", "bodyText": "Do we need this? If we know the environment is Azure, then we can directly get the topology from AzureConstants instead of reading from ClusterConfig.", "url": "https://github.com/apache/helix/pull/876#discussion_r389168774", "createdAt": "2020-03-06T22:11:01Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ParticipantManager.java", "diffHunk": "@@ -200,6 +201,22 @@ private void joinCluster() {\n     }\n   }\n \n+  private String ConstructDomainField(String faultDomain) {\n+    Boolean topologyEnabled = _configAccessor.getClusterConfig(_clusterName).isTopologyAwareEnabled();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c59bc5e6e26f79a9441fcb76438ce9b2ab380b21"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bebadf1358eaf481a9736c776c07228f6603933a", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/bebadf1358eaf481a9736c776c07228f6603933a", "committedDate": "2020-03-07T01:43:40Z", "message": "add domain construction in Helix participant manager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c59bc5e6e26f79a9441fcb76438ce9b2ab380b21", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/c59bc5e6e26f79a9441fcb76438ce9b2ab380b21", "committedDate": "2020-03-06T21:50:20Z", "message": "add domain construction in Helix participant manager"}, "afterCommit": {"oid": "bebadf1358eaf481a9736c776c07228f6603933a", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/bebadf1358eaf481a9736c776c07228f6603933a", "committedDate": "2020-03-07T01:43:40Z", "message": "add domain construction in Helix participant manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d31b6e48fba009e8c7a52611952c753eae51a253", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/d31b6e48fba009e8c7a52611952c753eae51a253", "committedDate": "2020-03-07T01:58:41Z", "message": "move domain construction to cloud information processor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDI0NTI2", "url": "https://github.com/apache/helix/pull/876#pullrequestreview-371424526", "createdAt": "2020-03-09T18:24:24Z", "commit": {"oid": "d31b6e48fba009e8c7a52611952c753eae51a253"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDU0OTE2", "url": "https://github.com/apache/helix/pull/876#pullrequestreview-371454916", "createdAt": "2020-03-09T19:09:09Z", "commit": {"oid": "d31b6e48fba009e8c7a52611952c753eae51a253"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTowOTowOVrOFz1wOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOToxMToxN1rOFz10lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwMjM5Mw==", "bodyText": "This is not necessary, right? Unless we offer flexibility for user to customize it.", "url": "https://github.com/apache/helix/pull/876#discussion_r389902393", "createdAt": "2020-03-09T19:09:09Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/cloud/azure/AzureCloudInstanceInformationProcessor.java", "diffHunk": "@@ -142,8 +142,16 @@ public AzureCloudInstanceInformation parseCloudInstanceInformation(List<String>\n         String vmName = computeNode.path(INSTANCE_NAME).getTextValue();\n         String platformFaultDomain = computeNode.path(DOMAIN).getTextValue();\n         String vmssName = computeNode.path(INSTANCE_SET_NAME).getValueAsText();\n+        String azureTopology = AzureConstants.AZURE_TOPOLOGY;\n+        String[] parts = azureTopology.trim().split(\"/\");\n+        if (parts.length != 2) {\n+          throw new HelixException(\"Invalid Azure topology definition: \" + azureTopology);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d31b6e48fba009e8c7a52611952c753eae51a253"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwMzUxMA==", "bodyText": "This is domain string right? Then it should looked like \"FD=xxx, InstanceName=xxxx\". But the code is adding them together?", "url": "https://github.com/apache/helix/pull/876#discussion_r389903510", "createdAt": "2020-03-09T19:11:17Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ParticipantManager.java", "diffHunk": "@@ -178,7 +178,7 @@ private void joinCluster() {\n           LOG.info(_instanceName + \" is auto-registering cluster: \" + _clusterName);\n           CloudInstanceInformation cloudInstanceInformation = getCloudInstanceInformation();\n           String domain = cloudInstanceInformation\n-              .get(CloudInstanceInformation.CloudInstanceField.FAULT_DOMAIN.name());\n+              .get(CloudInstanceInformation.CloudInstanceField.FAULT_DOMAIN.name()) + _instanceName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d31b6e48fba009e8c7a52611952c753eae51a253"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f171fe64c78f297bd743793342b8daa7e833fd8", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/7f171fe64c78f297bd743793342b8daa7e833fd8", "committedDate": "2020-03-09T21:34:56Z", "message": "minor fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNTY2MDU4", "url": "https://github.com/apache/helix/pull/876#pullrequestreview-371566058", "createdAt": "2020-03-09T22:16:53Z", "commit": {"oid": "7f171fe64c78f297bd743793342b8daa7e833fd8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4682, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}