{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMTU0NTcy", "number": 902, "title": "Fix setRoutingData boolean handling; fix leader forwarding url construction", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nFixes #901\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\n3 issues were uncovered by the second round of MetadataStoreDirectory Service manual testing:\n\nSetRoutingData does not respect the return value of the underlying function.\u00a0\nThe port of each instance is not considered when forwarding requests, therefore failing all the forwarded requests.\n\"/admin/v2\" is not added when forwarding requests, therefore (would be) failing the forwarded requests.\nFixes: return 500 when false; add mechanism to read ports from system configs (just like hostname); add mechanism to read url prefixes from system configs (just like hostname).\n\nTests\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n[ERROR] Tests run: 143, Failures: 1, Errors: 0, Skipped: 7, Time elapsed: 26.41 s <<< FAILURE! - in TestSuite\n[ERROR] testResourceHealth(org.apache.helix.rest.server.TestResourceAccessor)  Time elapsed: 0.266 s  <<< FAILURE!\njava.lang.AssertionError: expected:<HEALTHY> but was:<UNHEALTHY>\n\tat org.apache.helix.rest.server.TestResourceAccessor.testResourceHealth(TestResourceAccessor.java:289)\n\n[INFO] \n[INFO] Results:\n[INFO] \n[ERROR] Failures: \n[ERROR]   TestResourceAccessor.testResourceHealth:289 expected:<HEALTHY> but was:<UNHEALTHY>\n[INFO] \n[ERROR] Tests run: 143, Failures: 1, Errors: 0, Skipped: 7\n\nCommits\n\n My commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\n My diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-03-18T00:55:53Z", "url": "https://github.com/apache/helix/pull/902", "merged": true, "mergeCommit": {"oid": "f92b5a55b99d6d4e31e1ce513218276ff8c135d8"}, "closed": true, "closedAt": "2020-03-18T17:01:48Z", "author": {"login": "NealSun96"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOq6bLgH2gAyMzkwMTU0NTcyOjFhMDZjMDQ2YmM1YzUyYzFjMTA5YmQ3NmE5YzUyNTZjOTM5NGZlZDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO6U_zgFqTM3NzA1OTg5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a06c046bc5c52c1c109bd76a9c5256c9394fed6", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/1a06c046bc5c52c1c109bd76a9c5256c9394fed6", "committedDate": "2020-03-17T23:00:51Z", "message": "Bug fixees"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a8cce482598020222e685a87a5bb71bb232d5fa", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/6a8cce482598020222e685a87a5bb71bb232d5fa", "committedDate": "2020-03-18T00:35:32Z", "message": "Modify the way url prefixes work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/605d2a8e365c5a683efb5e4ef6a90b3f04cf408f", "committedDate": "2020-03-18T00:43:33Z", "message": "Work with the new port keys"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NDk5OTEz", "url": "https://github.com/apache/helix/pull/902#pullrequestreview-376499913", "createdAt": "2020-03-18T00:59:14Z", "commit": {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMDo1OToxNFrOF3zBug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMDo1OToxNFrOF3zBug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1MjAyNg==", "bodyText": "http://webreference.com/html/tutorial2/2.html\nUsually port is an optional concept in a URL. Let's not throw an exception. If it's null or empty, we simply don't append it.", "url": "https://github.com/apache/helix/pull/902#discussion_r394052026", "createdAt": "2020-03-18T00:59:14Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataWriter.java", "diffHunk": "@@ -87,16 +87,18 @@ public ZkRoutingDataWriter(String namespace, String zkAddress) {\n \n     // Get the hostname (REST endpoint) from System property\n     String hostName = System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY);\n+    String port = System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_PORT_KEY);\n     if (hostName == null || hostName.isEmpty()) {\n       throw new IllegalStateException(\n-          \"Unable to get the hostname of this server instance. System.getProperty fails to fetch \"\n+          \"Unable to get the hostname of this server instance or the hostname is empty. System.getProperty fails to fetch \"\n               + MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY + \".\");\n     }\n-    // remove trailing slash\n-    if (hostName.charAt(hostName.length() - 1) == '/') {\n-      hostName = hostName.substring(0, hostName.length() - 1);\n+    if (port == null || port.isEmpty()) {\n+      throw new IllegalStateException(\n+          \"Unable to get the port of this server instance or the port is empty. System.getProperty fails to fetch \"\n+              + MetadataStoreRoutingConstants.MSDS_SERVER_PORT_KEY + \".\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTAyNjk3", "url": "https://github.com/apache/helix/pull/902#pullrequestreview-376502697", "createdAt": "2020-03-18T01:09:14Z", "commit": {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTowOToxNFrOF3zKxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTowOToxNFrOF3zKxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NDM0MA==", "bodyText": "Using a vanilla hostname would be enough here. Let's create a ZNRecord with two simple fields added: hostname and port?", "url": "https://github.com/apache/helix/pull/902#discussion_r394054340", "createdAt": "2020-03-18T01:09:14Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataWriter.java", "diffHunk": "@@ -87,16 +87,18 @@ public ZkRoutingDataWriter(String namespace, String zkAddress) {\n \n     // Get the hostname (REST endpoint) from System property\n     String hostName = System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY);\n+    String port = System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_PORT_KEY);\n     if (hostName == null || hostName.isEmpty()) {\n       throw new IllegalStateException(\n-          \"Unable to get the hostname of this server instance. System.getProperty fails to fetch \"\n+          \"Unable to get the hostname of this server instance or the hostname is empty. System.getProperty fails to fetch \"\n               + MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY + \".\");\n     }\n-    // remove trailing slash\n-    if (hostName.charAt(hostName.length() - 1) == '/') {\n-      hostName = hostName.substring(0, hostName.length() - 1);\n+    if (port == null || port.isEmpty()) {\n+      throw new IllegalStateException(\n+          \"Unable to get the port of this server instance or the port is empty. System.getProperty fails to fetch \"\n+              + MetadataStoreRoutingConstants.MSDS_SERVER_PORT_KEY + \".\");\n     }\n-    _myHostName = HttpConstants.HTTP_PROTOCOL_PREFIX + hostName;\n+    _myHostName = HttpConstants.HTTP_PROTOCOL_PREFIX + hostName + \":\" + port;\n     ZNRecord myServerInfo = new ZNRecord(_myHostName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTAzODEw", "url": "https://github.com/apache/helix/pull/902#pullrequestreview-376503810", "createdAt": "2020-03-18T01:13:19Z", "commit": {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToxMzoxOVrOF3zOdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToxMzoxOVrOF3zOdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTI4Ng==", "bodyText": "Add some JavaDoc explaining what you're doing with examples please? This is one of the things that when you look back at it 6 months from now, you'll have to do some digging around to understand what youre doing. Having a comment with an example would help :)", "url": "https://github.com/apache/helix/pull/902#discussion_r394055286", "createdAt": "2020-03-18T01:13:19Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataWriter.java", "diffHunk": "@@ -344,6 +346,11 @@ protected boolean deleteZkShardingKey(String realm, String shardingKey) {\n   private String constructUrlSuffix(String... urlParams) {\n     List<String> allUrlParameters = new ArrayList<>(\n         Arrays.asList(MetadataStoreRoutingConstants.MSDS_NAMESPACES_URL_PREFIX, \"/\", _namespace));\n+    String contextUrlPrefix =\n+        System.getProperty(MetadataStoreRoutingConstants.MSDS_CONTEXT_URL_PREFIX_KEY);\n+    if (contextUrlPrefix != null && !contextUrlPrefix.isEmpty()) {\n+      allUrlParameters.add(0, contextUrlPrefix);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTAzOTI5", "url": "https://github.com/apache/helix/pull/902#pullrequestreview-376503929", "createdAt": "2020-03-18T01:13:47Z", "commit": {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToxMzo0N1rOF3zO4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToxMzo0N1rOF3zO4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTM5NQ==", "bodyText": "Why was this change needed?", "url": "https://github.com/apache/helix/pull/902#discussion_r394055395", "createdAt": "2020-03-18T01:13:47Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/metadatastore/MetadataStoreDirectoryAccessor.java", "diffHunk": "@@ -235,7 +235,9 @@ public Response setRoutingData(String jsonContent) {\n       Map<String, List<String>> routingData =\n           OBJECT_MAPPER.readValue(jsonContent, new TypeReference<HashMap<String, List<String>>>() {\n           });\n-      _metadataStoreDirectory.setNamespaceRoutingData(_namespace, routingData);\n+      if (!_metadataStoreDirectory.setNamespaceRoutingData(_namespace, routingData)) {\n+        return serverError();\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTA0MTU2", "url": "https://github.com/apache/helix/pull/902#pullrequestreview-376504156", "createdAt": "2020-03-18T01:14:36Z", "commit": {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToxNDozNlrOF3zPlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToxNDozNlrOF3zPlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTU3Mw==", "bodyText": "Do these not need to be cleared after the test?", "url": "https://github.com/apache/helix/pull/902#discussion_r394055573", "createdAt": "2020-03-18T01:14:36Z", "author": {"login": "narendly"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestMSDAccessorLeaderElection.java", "diffHunk": "@@ -99,7 +99,9 @@ public void beforeClass() throws Exception {\n \n     // Set the new uri to be used in leader election\n     System.setProperty(MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY,\n-        getBaseUri().getHost() + \":\" + newPort);\n+        getBaseUri().getHost());\n+    System\n+        .setProperty(MetadataStoreRoutingConstants.MSDS_SERVER_PORT_KEY, Integer.toString(newPort));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "605d2a8e365c5a683efb5e4ef6a90b3f04cf408f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c06980a9a9fcadbedd4162724bf0d2e6bda7056", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/1c06980a9a9fcadbedd4162724bf0d2e6bda7056", "committedDate": "2020-03-18T01:53:52Z", "message": "LeaderElection node contains more info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50c7601d1f8cf34d355bb5152f11d3eb577afbe9", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/50c7601d1f8cf34d355bb5152f11d3eb577afbe9", "committedDate": "2020-03-18T02:08:45Z", "message": "Signature modify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70018701baddb1f8088f7bbd2705845261d37769", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/70018701baddb1f8088f7bbd2705845261d37769", "committedDate": "2020-03-18T02:21:27Z", "message": "Fix related test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTc4NDQz", "url": "https://github.com/apache/helix/pull/902#pullrequestreview-376578443", "createdAt": "2020-03-18T05:47:09Z", "commit": {"oid": "70018701baddb1f8088f7bbd2705845261d37769"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNTo0NzowOVrOF33DzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNTo0NzowOVrOF33DzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExODA5Mg==", "bodyText": "Why is leader's host name removed? This was very useful information in debugging.", "url": "https://github.com/apache/helix/pull/902#discussion_r394118092", "createdAt": "2020-03-18T05:47:09Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataWriter.java", "diffHunk": "@@ -391,8 +422,8 @@ protected boolean sendRequestToLeader(HttpUriRequest request, int expectedRespon\n       }\n     } catch (IOException e) {\n       LOG.error(\n-          \"The forwarded request to leader raised an exception. Uri: {} Current hostname: {} Leader hostname: {}\",\n-          request.getURI(), _myHostName, leaderHostName, e);\n+          \"The forwarded request to leader raised an exception. Uri: {} Current hostname: {} \",\n+          request.getURI(), _myHostName, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70018701baddb1f8088f7bbd2705845261d37769"}, "originalPosition": 138}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTc4OTE5", "url": "https://github.com/apache/helix/pull/902#pullrequestreview-376578919", "createdAt": "2020-03-18T05:48:44Z", "commit": {"oid": "70018701baddb1f8088f7bbd2705845261d37769"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNTo0ODo0NFrOF33Feg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNTo0ODo0NFrOF33Feg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExODUyMg==", "bodyText": "\"Host name is not set or is empty\" would be better.", "url": "https://github.com/apache/helix/pull/902#discussion_r394118522", "createdAt": "2020-03-18T05:48:44Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataWriter.java", "diffHunk": "@@ -89,15 +94,27 @@ public ZkRoutingDataWriter(String namespace, String zkAddress) {\n     String hostName = System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_HOSTNAME_KEY);\n     if (hostName == null || hostName.isEmpty()) {\n       throw new IllegalStateException(\n-          \"Unable to get the hostname of this server instance. System.getProperty fails to fetch \"\n+          \"Unable to get the hostname of this server instance or the hostname is empty. System.getProperty fails to fetch \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70018701baddb1f8088f7bbd2705845261d37769"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66e9ec316577688b7ae06c29e9f30d51662b6c3f", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/66e9ec316577688b7ae06c29e9f30d51662b6c3f", "committedDate": "2020-03-18T15:53:07Z", "message": "Exception message nit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MDU5ODk3", "url": "https://github.com/apache/helix/pull/902#pullrequestreview-377059897", "createdAt": "2020-03-18T16:58:27Z", "commit": {"oid": "66e9ec316577688b7ae06c29e9f30d51662b6c3f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4715, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}