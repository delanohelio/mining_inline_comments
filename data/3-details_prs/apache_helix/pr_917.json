{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NTYyNDI5", "number": 917, "title": "minor fix for customized view aggregation", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\n(#885 )\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\nThis PR fixed a few of minor issues in customized aggregation view and add one more test. The main change is to change lastSeenCustomizedStateType to a map and a few logic change that handle corner cases.\n\nTests\n\n\n The following tests are written for this issue:\nTestComputeAndCleanupCustomizedView\n\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n\nCommits\n\n[X ] My commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\n My diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-03-27T05:40:04Z", "url": "https://github.com/apache/helix/pull/917", "merged": true, "mergeCommit": {"oid": "b7faf39530fac3cd8d83729d6f3e04e5d9f87393"}, "closed": true, "closedAt": "2020-03-30T21:26:58Z", "author": {"login": "zhangmeng916"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcR4GUlgBqjMxNzQyMzU0Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSzW4OAFqTM4NDE0ODQ2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f08887c56f41bcc1a7a367b4dd883168ce51808", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/3f08887c56f41bcc1a7a367b4dd883168ce51808", "committedDate": "2020-03-27T05:36:51Z", "message": "minor fix for customized view"}, "afterCommit": {"oid": "2a0b3270216bf6c7cac29755b8e454fa1b537218", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/2a0b3270216bf6c7cac29755b8e454fa1b537218", "committedDate": "2020-03-27T22:02:17Z", "message": "minor fix for customized view"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/00dfffc34e8656cc181d02ec7b87495b7917ada2", "committedDate": "2020-03-27T22:05:39Z", "message": "minor fix for customized view"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a0b3270216bf6c7cac29755b8e454fa1b537218", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/2a0b3270216bf6c7cac29755b8e454fa1b537218", "committedDate": "2020-03-27T22:02:17Z", "message": "minor fix for customized view"}, "afterCommit": {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/00dfffc34e8656cc181d02ec7b87495b7917ada2", "committedDate": "2020-03-27T22:05:39Z", "message": "minor fix for customized view"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjI3OTU1", "url": "https://github.com/apache/helix/pull/917#pullrequestreview-383227955", "createdAt": "2020-03-27T22:10:29Z", "commit": {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMjoxMDoyOVrOF9DRcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMjoyMTowNlrOF9Dd7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MTA3Mg==", "bodyText": "More comments about the content of the map, please.", "url": "https://github.com/apache/helix/pull/917#discussion_r399561072", "createdAt": "2020-03-27T22:10:29Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -139,7 +139,7 @@\n   final AtomicReference<Map<String, LiveInstance>> _lastSeenInstances;\n   final AtomicReference<Map<String, LiveInstance>> _lastSeenSessions;\n \n-  final AtomicReference<Set<String>> _lastSeenCustomizedStateTypes;\n+  final AtomicReference<Map<String, Set<String>>> _lastSeenCustomizedStateTypesMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MTI2OA==", "bodyText": "nit Collections.emtpySet()", "url": "https://github.com/apache/helix/pull/917#discussion_r399561268", "createdAt": "2020-03-27T22:11:06Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -828,8 +828,14 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n     }\n \n     // TODO: remove the synchronization here once we move this update into dataCache.\n-    synchronized (_lastSeenCustomizedStateTypes) {\n-      Set<String> lastSeenCustomizedStateTypes = _lastSeenCustomizedStateTypes.get();\n+    synchronized (_lastSeenCustomizedStateTypesMap) {\n+      Map<String, Set<String>> lastSeenCustomizedStateTypesMap =\n+          _lastSeenCustomizedStateTypesMap.get();\n+      Set<String> lastSeenCustomizedStateTypes = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MTY3Ng==", "bodyText": "lastSeenCustomizedStateTypes won't be null, right?", "url": "https://github.com/apache/helix/pull/917#discussion_r399561676", "createdAt": "2020-03-27T22:12:35Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -828,8 +828,14 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n     }\n \n     // TODO: remove the synchronization here once we move this update into dataCache.\n-    synchronized (_lastSeenCustomizedStateTypes) {\n-      Set<String> lastSeenCustomizedStateTypes = _lastSeenCustomizedStateTypes.get();\n+    synchronized (_lastSeenCustomizedStateTypesMap) {\n+      Map<String, Set<String>> lastSeenCustomizedStateTypesMap =\n+          _lastSeenCustomizedStateTypesMap.get();\n+      Set<String> lastSeenCustomizedStateTypes = new HashSet<>();\n+      if (lastSeenCustomizedStateTypesMap != null && lastSeenCustomizedStateTypesMap\n+          .containsKey(instanceName)) {\n+        lastSeenCustomizedStateTypes = lastSeenCustomizedStateTypesMap.get(instanceName);\n+      }\n       for (String customizedState : customizedStateTypes) {\n         try {\n           if (lastSeenCustomizedStateTypes == null || !lastSeenCustomizedStateTypes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MTc1MA==", "bodyText": "Same here, do we really need to check this?", "url": "https://github.com/apache/helix/pull/917#discussion_r399561750", "createdAt": "2020-03-27T22:12:52Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -844,14 +850,24 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n         }\n       }\n \n-      for (String previousCustomizedState : lastSeenCustomizedStateTypes) {\n-        if (!customizedStateTypes.contains(previousCustomizedState)) {\n-          manager.removeListener(keyBuilder.customizedStates(instanceName, previousCustomizedState),\n-              this);\n+      if (lastSeenCustomizedStateTypes != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MzE0Ng==", "bodyText": "This does not look right. If the config types have been changed just before the refresh with fewer items, we won't remove the extra types, right?", "url": "https://github.com/apache/helix/pull/917#discussion_r399563146", "createdAt": "2020-03-27T22:17:25Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java", "diffHunk": "@@ -197,18 +197,17 @@ private void refreshTargetExternalViews(final HelixDataAccessor accessor) {\n   public void refreshCustomizedViewMap(final HelixDataAccessor accessor) {\n     // As we are not listening on customized view change, customized view will be\n     // refreshed once during the cache's first refresh() call, or when full refresh is required\n-    List<String> newStateTypes = accessor.getChildNames(accessor.keyBuilder().customizedViews());\n     if (_propertyDataChangedMap.get(HelixConstants.ChangeType.CUSTOMIZED_VIEW).getAndSet(false)) {\n-      for (String stateType : newStateTypes) {\n+      for (String stateType : _aggregationEnabledTypes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MzY3Mw==", "bodyText": "The previous change is a good catch. But I don't think we need this converting if we just make removeCustomizedViewTypes receives a set.", "url": "https://github.com/apache/helix/pull/917#discussion_r399563673", "createdAt": "2020-03-27T22:19:00Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java", "diffHunk": "@@ -197,18 +197,17 @@ private void refreshTargetExternalViews(final HelixDataAccessor accessor) {\n   public void refreshCustomizedViewMap(final HelixDataAccessor accessor) {\n     // As we are not listening on customized view change, customized view will be\n     // refreshed once during the cache's first refresh() call, or when full refresh is required\n-    List<String> newStateTypes = accessor.getChildNames(accessor.keyBuilder().customizedViews());\n     if (_propertyDataChangedMap.get(HelixConstants.ChangeType.CUSTOMIZED_VIEW).getAndSet(false)) {\n-      for (String stateType : newStateTypes) {\n+      for (String stateType : _aggregationEnabledTypes) {\n         if (!_customizedViewCacheMap.containsKey(stateType)) {\n           CustomizedViewCache newCustomizedViewCache =\n               new CustomizedViewCache(getClusterName(), stateType);\n           _customizedViewCacheMap.put(stateType, newCustomizedViewCache);\n         }\n         _customizedViewCacheMap.get(stateType).refresh(accessor);\n       }\n-      Set<String> previousCachedStateTypes = _customizedViewCacheMap.keySet();\n-      previousCachedStateTypes.removeAll(newStateTypes);\n+      Set<String> previousCachedStateTypes = new HashSet<>(_customizedViewCacheMap.keySet());\n+      previousCachedStateTypes.removeAll(_aggregationEnabledTypes);\n       logger.info(\"Remove customizedView for state: \" + previousCachedStateTypes);\n       removeCustomizedViewTypes(new ArrayList<>(previousCachedStateTypes));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2NDI2OQ==", "bodyText": "Why? This list is a local variable, right?", "url": "https://github.com/apache/helix/pull/917#discussion_r399564269", "createdAt": "2020-03-27T22:21:06Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/stages/CustomizedViewAggregationStage.java", "diffHunk": "@@ -119,6 +117,7 @@ public void execute(final ClusterEvent event) throws Exception {\n               \"Failed to calculate customized view for resource \" + resource.getResourceName(), ex);\n         }\n       }\n+      updatedCustomizedViews.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dfffc34e8656cc181d02ec7b87495b7917ada2"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21c79525a2390113e9c9e4d5945fb6a7c72a9ff5", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/21c79525a2390113e9c9e4d5945fb6a7c72a9ff5", "committedDate": "2020-03-27T22:54:33Z", "message": "fix comment"}, "afterCommit": {"oid": "86bba3da7c9d84bbd677bdb522acb4ac6d9d4b98", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/86bba3da7c9d84bbd677bdb522acb4ac6d9d4b98", "committedDate": "2020-03-27T22:56:33Z", "message": "ix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdb0997aabdeaa5b20cf9353175f353db4fac10f", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/bdb0997aabdeaa5b20cf9353175f353db4fac10f", "committedDate": "2020-03-27T22:57:03Z", "message": "fix comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86bba3da7c9d84bbd677bdb522acb4ac6d9d4b98", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/86bba3da7c9d84bbd677bdb522acb4ac6d9d4b98", "committedDate": "2020-03-27T22:56:33Z", "message": "ix comment"}, "afterCommit": {"oid": "bdb0997aabdeaa5b20cf9353175f353db4fac10f", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/bdb0997aabdeaa5b20cf9353175f353db4fac10f", "committedDate": "2020-03-27T22:57:03Z", "message": "fix comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjgzMjM4", "url": "https://github.com/apache/helix/pull/917#pullrequestreview-383283238", "createdAt": "2020-03-28T04:44:09Z", "commit": {"oid": "bdb0997aabdeaa5b20cf9353175f353db4fac10f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQwNDo0NDowOVrOF9Gz3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQwNDo0NDowOVrOF9Gz3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxOTAzOQ==", "bodyText": "nit, since I am confused again while reviewing the code related to this field, shall we rename it to _lastSeenCustomizedStateTypesRef Or _lastSeenCustomizedStateTypesMapRef?", "url": "https://github.com/apache/helix/pull/917#discussion_r399619039", "createdAt": "2020-03-28T04:44:09Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -139,7 +139,9 @@\n   final AtomicReference<Map<String, LiveInstance>> _lastSeenInstances;\n   final AtomicReference<Map<String, LiveInstance>> _lastSeenSessions;\n \n-  final AtomicReference<Set<String>> _lastSeenCustomizedStateTypes;\n+  // map that stores the mapping between instance and the customized state types available on that\n+  //instance\n+  final AtomicReference<Map<String, Set<String>>> _lastSeenCustomizedStateTypesMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdb0997aabdeaa5b20cf9353175f353db4fac10f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjgzMzYx", "url": "https://github.com/apache/helix/pull/917#pullrequestreview-383283361", "createdAt": "2020-03-28T04:47:30Z", "commit": {"oid": "bdb0997aabdeaa5b20cf9353175f353db4fac10f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQwNDo0NzozMFrOF9G0jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQwNDo1MTozMlrOF9G1uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxOTIxMw==", "bodyText": "nit, if addCustomizedStateChangeListener already logs inside, we don't need this info log. Please confirm.", "url": "https://github.com/apache/helix/pull/917#discussion_r399619213", "createdAt": "2020-03-28T04:47:30Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -828,12 +830,17 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n     }\n \n     // TODO: remove the synchronization here once we move this update into dataCache.\n-    synchronized (_lastSeenCustomizedStateTypes) {\n-      Set<String> lastSeenCustomizedStateTypes = _lastSeenCustomizedStateTypes.get();\n+    synchronized (_lastSeenCustomizedStateTypesMap) {\n+      Map<String, Set<String>> lastSeenCustomizedStateTypesMap =\n+          _lastSeenCustomizedStateTypesMap.get();\n+      Set<String> lastSeenCustomizedStateTypes = Collections.emptySet();\n+      if (lastSeenCustomizedStateTypesMap != null && lastSeenCustomizedStateTypesMap\n+          .containsKey(instanceName)) {\n+        lastSeenCustomizedStateTypes = lastSeenCustomizedStateTypesMap.get(instanceName);\n+      }\n       for (String customizedState : customizedStateTypes) {\n         try {\n-          if (lastSeenCustomizedStateTypes == null || !lastSeenCustomizedStateTypes\n-              .contains(customizedState)) {\n+          if (!lastSeenCustomizedStateTypes.contains(customizedState)) {\n             manager.addCustomizedStateChangeListener(this, instanceName, customizedState);\n             logger.info(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdb0997aabdeaa5b20cf9353175f353db4fac10f"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxOTUxMg==", "bodyText": "Might help to simplify the code.\nMap<String, Set> lastSeenCustomizedStateTypesMap =\n_lastSeenCustomizedStateTypesMap.get();\nif (null == lastSeenCustomizedStateTypesMap) {\nlastSeenCustomizedStateTypesMap = new HashMap();\n// lazy init the AtomicReference\n_lastSeenCustomizedStateTypesMapRef.set(lastSeenCustomizedStateTypesMap);\n}\nif (!lastSeenCustomizedStateTypesMap.containsKey(instanceName)) {\nlastSeenCustomizedStateTypesMap.put(instanceName, Collections.emptySet());\n}\nSet lastSeenCustomizedStateTypes = lastSeenCustomizedStateTypesMap.get(instanceName);\nThen you don't need to check null later.", "url": "https://github.com/apache/helix/pull/917#discussion_r399619512", "createdAt": "2020-03-28T04:51:32Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -828,12 +830,17 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n     }\n \n     // TODO: remove the synchronization here once we move this update into dataCache.\n-    synchronized (_lastSeenCustomizedStateTypes) {\n-      Set<String> lastSeenCustomizedStateTypes = _lastSeenCustomizedStateTypes.get();\n+    synchronized (_lastSeenCustomizedStateTypesMap) {\n+      Map<String, Set<String>> lastSeenCustomizedStateTypesMap =\n+          _lastSeenCustomizedStateTypesMap.get();\n+      Set<String> lastSeenCustomizedStateTypes = Collections.emptySet();\n+      if (lastSeenCustomizedStateTypesMap != null && lastSeenCustomizedStateTypesMap", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdb0997aabdeaa5b20cf9353175f353db4fac10f"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36d3ea1682493ad2676f9cbde08269729f87e8cd", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/36d3ea1682493ad2676f9cbde08269729f87e8cd", "committedDate": "2020-03-28T06:42:42Z", "message": "fix comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjg5Nzg2", "url": "https://github.com/apache/helix/pull/917#pullrequestreview-383289786", "createdAt": "2020-03-28T06:56:42Z", "commit": {"oid": "36d3ea1682493ad2676f9cbde08269729f87e8cd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQwNjo1Njo0MlrOF9HbTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQwNjo1OTo0NVrOF9HcSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyOTEzMg==", "bodyText": "The only additional information we get by printing this log is manager.getInstanceName(), I guess. I don't have a strong preference. But do whatever the other similar code does might cause redundant code. Please only keep this log if you think the extra helixmanager name can help us to debug in the future.", "url": "https://github.com/apache/helix/pull/917#discussion_r399629132", "createdAt": "2020-03-28T06:56:42Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -828,12 +830,17 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n     }\n \n     // TODO: remove the synchronization here once we move this update into dataCache.\n-    synchronized (_lastSeenCustomizedStateTypes) {\n-      Set<String> lastSeenCustomizedStateTypes = _lastSeenCustomizedStateTypes.get();\n+    synchronized (_lastSeenCustomizedStateTypesMap) {\n+      Map<String, Set<String>> lastSeenCustomizedStateTypesMap =\n+          _lastSeenCustomizedStateTypesMap.get();\n+      Set<String> lastSeenCustomizedStateTypes = Collections.emptySet();\n+      if (lastSeenCustomizedStateTypesMap != null && lastSeenCustomizedStateTypesMap\n+          .containsKey(instanceName)) {\n+        lastSeenCustomizedStateTypes = lastSeenCustomizedStateTypesMap.get(instanceName);\n+      }\n       for (String customizedState : customizedStateTypes) {\n         try {\n-          if (lastSeenCustomizedStateTypes == null || !lastSeenCustomizedStateTypes\n-              .contains(customizedState)) {\n+          if (!lastSeenCustomizedStateTypes.contains(customizedState)) {\n             manager.addCustomizedStateChangeListener(this, instanceName, customizedState);\n             logger.info(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYxOTIxMw=="}, "originalCommit": {"oid": "bdb0997aabdeaa5b20cf9353175f353db4fac10f"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyOTM4Nw==", "bodyText": "Are you trying to do the following logic?\n// Update the last seen types cache\nlastSeenCustomizedStateTypes.clear()\nlastSeenCustomizedStateTypes.addAll(customizedStateTypes)", "url": "https://github.com/apache/helix/pull/917#discussion_r399629387", "createdAt": "2020-03-28T06:59:45Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -851,7 +865,7 @@ public void onCustomizedStateRootChange(String instanceName, List<String> custom\n         }\n       }\n \n-      _lastSeenCustomizedStateTypes.set(new HashSet<>(customizedStateTypes));\n+      lastSeenCustomizedStateTypes = new HashSet<>(customizedStateTypes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d3ea1682493ad2676f9cbde08269729f87e8cd"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eca1b3909755491f85d9d90121615c5d91f51af1", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/eca1b3909755491f85d9d90121615c5d91f51af1", "committedDate": "2020-03-29T00:45:33Z", "message": "fix wrong set"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd32244c15f0f8538be02c280fece0d1e976a282", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/bd32244c15f0f8538be02c280fece0d1e976a282", "committedDate": "2020-03-28T07:36:13Z", "message": "fix wrong set"}, "afterCommit": {"oid": "eca1b3909755491f85d9d90121615c5d91f51af1", "author": {"user": {"login": "zhangmeng916", "name": "Meng Zhang"}}, "url": "https://github.com/apache/helix/commit/eca1b3909755491f85d9d90121615c5d91f51af1", "committedDate": "2020-03-29T00:45:33Z", "message": "fix wrong set"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MTQ4NDYy", "url": "https://github.com/apache/helix/pull/917#pullrequestreview-384148462", "createdAt": "2020-03-30T19:06:52Z", "commit": {"oid": "eca1b3909755491f85d9d90121615c5d91f51af1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4735, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}