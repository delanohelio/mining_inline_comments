{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMDg4MDc4", "number": 1401, "title": "Mark AutoRebalancer as deprecated and convert the default test logic to not use AutoRebalancer.", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nResolves #1392, #1393, #1374.\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nMark AutoRebalancer as deprecated and convert the default test logic to not use AutoRebalancer.\nThe only remaining AutoRebalancer tests should be the ones that are specifically testing the AutoRebalancer class.\nTests\n\n The following tests are written for this issue:\n\nThis PR is a pure test change.\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n[ERROR]   TestDeleteJobFromJobQueue.testForceDeleteJobFromJobQueue:73 \u00bb Helix Failed to ...\n[INFO]\n[ERROR] Tests run: 1200, Failures: 1, Errors: 0, Skipped: 0\nRerun\n[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 9.284 s - in org.apache.helix.integration.task.TestDeleteJobFromJobQueue\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\nDocumentation (Optional)\n\nIn case of new functionality, my PR adds documentation in the following wiki page:\n\n(Link the GitHub wiki you added)\nCommits\n\nMy commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\nMy diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-09-23T23:09:46Z", "url": "https://github.com/apache/helix/pull/1401", "merged": true, "mergeCommit": {"oid": "be91eff5c3543ebc427e64ffcf8fc5f5dc25d0f7"}, "closed": true, "closedAt": "2020-09-24T04:18:38Z", "author": {"login": "jiajunwang"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdL03MSgH2gAyNDkyMDg4MDc4OmE4YmJhMjgxYjBmN2JjYWEyMTNmYzM5MGE2NWQ3MjY4MTRjZTNlZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdL2MmHAH2gAyNDkyMDg4MDc4OjIwYjA3MmUzZGI2YWJmNDk2YTRiYjE0ZDA2NzcwMTZkZGM3YTBhMjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a8bba281b0f7bcaa213fc390a65d726814ce3ee7", "author": {"user": {"login": "jiajunwang", "name": "Jiajun Wang"}}, "url": "https://github.com/apache/helix/commit/a8bba281b0f7bcaa213fc390a65d726814ce3ee7", "committedDate": "2020-09-23T23:05:45Z", "message": "Mark AutoRebalancer as deprecated and convert the default test logic to not using AutoRebalancer by default.\n\nThe only remaining AutoRebalancer tests should be the ones that are specifically testing the AutoRebalancer class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e", "author": {"user": {"login": "jiajunwang", "name": "Jiajun Wang"}}, "url": "https://github.com/apache/helix/commit/941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e", "committedDate": "2020-09-23T23:12:21Z", "message": "Minor code refine."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTMyMzEy", "url": "https://github.com/apache/helix/pull/1401#pullrequestreview-495132312", "createdAt": "2020-09-23T23:54:46Z", "commit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzo1NDo0NlrOHXFCug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzo1NDo0NlrOHXFCug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2MTkxNA==", "bodyText": "Here, RebalanceMode.FULL_AUTO, we will always use crushED, which means delayAutoRebalancer with CrushED\nBefore this change, it is AutoRebalancer with AutoRebalanceStrategy, both takes current state into consideration. They bestPossibleVerifier may still work, but the state mapping can be different from one run to another run", "url": "https://github.com/apache/helix/pull/1401#discussion_r493961914", "createdAt": "2020-09-23T23:54:46Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/test/java/org/apache/helix/TestHelper.java", "diffHunk": "@@ -287,7 +289,10 @@ public static void setupCluster(String clusterName, String zkAddr, int startPort\n \n       for (int i = 0; i < resourceNb; i++) {\n         String resourceName = resourceNamePrefix + i;\n-        setupTool.addResourceToCluster(clusterName, resourceName, partitionNb, stateModelDef, mode.toString());\n+        setupTool.addResourceToCluster(clusterName, resourceName, partitionNb, stateModelDef,\n+            mode.name(),\n+            mode == RebalanceMode.FULL_AUTO ? CrushEdRebalanceStrategy.class.getName()\n+                : RebalanceStrategy.DEFAULT_REBALANCE_STRATEGY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTM4ODE4", "url": "https://github.com/apache/helix/pull/1401#pullrequestreview-495138818", "createdAt": "2020-09-24T00:14:40Z", "commit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxNDo0MFrOHXFZcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxNDo0MFrOHXFZcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NzcyOA==", "bodyText": "This actually relies on the fact that\n _gSetupTool.addResourceToCluster(CLUSTER_NAME, \"MyDB2\", _PARTITIONS, \"MasterSlave\",\n        RebalanceMode.FULL_AUTO + \"\");\n\nwould add  idea state using DelayedAutoRebalancer + AutoRebalance strategy\nhere, we change the idea state to use autoRebalancer, thus eventually we end up with autoRebalancer + autoRebalance strategy.\nThe thing is that if later people change the gSetupTool.addResourceToCluster() similar to testhelper to have DelayedAutoRebalancer + crushEd, this test won't work.\nShall we add a comment that we depends on  _gSetupTool.addResourceToCluster to use default AutoRebalanceStrategy, or just note here we need autoRebalancer + autoRebalance strategy.", "url": "https://github.com/apache/helix/pull/1401#discussion_r493967728", "createdAt": "2020-09-24T00:14:40Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalance.java", "diffHunk": "@@ -229,6 +236,16 @@ static boolean verifyBalanceExternalView(ZNRecord externalView, int partitionCou\n     return partitionCount == totalCount;\n   }\n \n+  private void setupAutoRebalancer() {\n+    HelixAdmin admin = _gSetupTool.getClusterManagementTool();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTM5ODI4", "url": "https://github.com/apache/helix/pull/1401#pullrequestreview-495139828", "createdAt": "2020-09-24T00:17:57Z", "commit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxNzo1N1rOHXFdVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoxNzo1N1rOHXFdVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2ODcyNg==", "bodyText": "add a comment, we need autoRebalancer + autoRebalance strategy. here as this is testing autoRebalancer.", "url": "https://github.com/apache/helix/pull/1401#discussion_r493968726", "createdAt": "2020-09-24T00:17:57Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java", "diffHunk": "@@ -54,7 +56,13 @@ public void beforeClass() throws Exception {\n     _gSetupTool.addCluster(CLUSTER_NAME, true);\n \n     _gSetupTool.addResourceToCluster(CLUSTER_NAME, TEST_DB, 100, \"OnlineOffline\",\n-        RebalanceMode.FULL_AUTO + \"\", 0, 25);\n+        RebalanceMode.FULL_AUTO.name(), 0, 25);\n+\n+    IdealState idealState =\n+        _gSetupTool.getClusterManagementTool().getResourceIdealState(CLUSTER_NAME, TEST_DB);\n+    idealState.setRebalancerClassName(AutoRebalancer.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTQwNDk0", "url": "https://github.com/apache/helix/pull/1401#pullrequestreview-495140494", "createdAt": "2020-09-24T00:20:03Z", "commit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoyMDowM1rOHXFfsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoyMDowM1rOHXFfsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2OTMyOA==", "bodyText": "add a log.error please. It is better with stack trace. This would be tremendous helpful if the test fails.", "url": "https://github.com/apache/helix/pull/1401#discussion_r493969328", "createdAt": "2020-09-24T00:20:03Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java", "diffHunk": "@@ -204,10 +215,14 @@ public boolean verify() {\n           cache.getStateModelDef(cache.getIdealState(_resourceName).getStateModelDefRef())\n               .getStatesPriorityList().get(0);\n       int replicas = Integer.parseInt(cache.getIdealState(_resourceName).getReplicas());\n-      return verifyBalanceExternalView(\n-          accessor.getProperty(keyBuilder.externalView(_resourceName)).getRecord(),\n-          numberOfPartitions, masterValue, replicas, cache.getLiveInstances().size(),\n-          cache.getIdealState(_resourceName).getMaxPartitionsPerInstance());\n+      try {\n+        return verifyBalanceExternalView(\n+            accessor.getProperty(keyBuilder.externalView(_resourceName)).getRecord(),\n+            numberOfPartitions, masterValue, replicas, cache.getLiveInstances().size(),\n+            cache.getIdealState(_resourceName).getMaxPartitionsPerInstance());\n+      } catch (Exception e) {\n+        return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTQwNzU0", "url": "https://github.com/apache/helix/pull/1401#pullrequestreview-495140754", "createdAt": "2020-09-24T00:20:50Z", "commit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoyMDo1MVrOHXFgpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoyMDo1MVrOHXFgpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2OTU3NA==", "bodyText": "Again add the comment that we need autoRebalancer + autoRebalance strategy as this is autoRebalance test", "url": "https://github.com/apache/helix/pull/1401#discussion_r493969574", "createdAt": "2020-09-24T00:20:51Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalanceWithDisabledInstance.java", "diffHunk": "@@ -43,6 +45,7 @@ public void beforeClass() throws Exception {\n     super.beforeClass();\n     _gSetupTool.addResourceToCluster(CLUSTER_NAME, TEST_DB_2, _PARTITIONS, STATE_MODEL,\n         RebalanceMode.FULL_AUTO.name(), CrushEdRebalanceStrategy.class.getName());\n+    setupAutoRebalancer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTQwOTgx", "url": "https://github.com/apache/helix/pull/1401#pullrequestreview-495140981", "createdAt": "2020-09-24T00:21:32Z", "commit": {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20b072e3db6abf496a4bb14d0677016ddc7a0a25", "author": {"user": {"login": "jiajunwang", "name": "Jiajun Wang"}}, "url": "https://github.com/apache/helix/commit/20b072e3db6abf496a4bb14d0677016ddc7a0a25", "committedDate": "2020-09-24T00:39:02Z", "message": "Address comments."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4289, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}