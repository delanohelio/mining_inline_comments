{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMzMwNTQ2", "number": 1409, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMTozNDo0MVrOEoxATQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMTozNTo0MVrOEoxBkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMTgxMzg5OnYy", "diffSide": "RIGHT", "path": "helix-lock/src/main/java/org/apache/helix/lock/helix/ZKDistributedNonblockingLock.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMTozNDo0MVrOHaC-tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMzoxNzoyOFrOHaGZPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3Mzg0NA==", "bodyText": "I'm not sure the purpose of this comment. Is this targeting whoever changes this class? what about non zooscalablity use case?", "url": "https://github.com/apache/helix/pull/1409#discussion_r497073844", "createdAt": "2020-09-29T21:34:41Z", "author": {"login": "zhangmeng916"}, "path": "helix-lock/src/main/java/org/apache/helix/lock/helix/ZKDistributedNonblockingLock.java", "diffHunk": "@@ -24,17 +24,21 @@\n import org.apache.helix.AccessOption;\n import org.apache.helix.BaseDataAccessor;\n import org.apache.helix.HelixException;\n+import org.apache.helix.SystemPropertyKeys;\n import org.apache.helix.lock.DistributedLock;\n import org.apache.helix.lock.LockInfo;\n import org.apache.helix.lock.LockScope;\n+import org.apache.helix.manager.zk.GenericZkHelixApiBuilder;\n import org.apache.helix.manager.zk.ZkBaseDataAccessor;\n import org.apache.helix.zookeeper.datamodel.ZNRecord;\n import org.apache.helix.zookeeper.zkclient.DataUpdater;\n import org.apache.log4j.Logger;\n \n \n /**\n- * Helix nonblocking lock implementation based on Zookeeper\n+ * Helix nonblocking lock implementation based on Zookeeper.\n+ * NOTE: do NOT use ephemeral nodes in this implementation because ephemeral mode is not supported", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fb23deeb79a09cb101a8578244332d627e783c4"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzEyOTc4OQ==", "bodyText": "Yes, in order to keep things compatible, we shouldn't be using ephemeral nodes for the implementation of this class. If ephemeral nodes are needed, that would have to be a separate class with a different metadata store or mode of access.\nOne can say - what about on single-zk mode? Then the behavior of this class becomes harder to understand. So it's easier to say no ephemeral node use for this class (which is the case right now).", "url": "https://github.com/apache/helix/pull/1409#discussion_r497129789", "createdAt": "2020-09-29T23:17:28Z", "author": {"login": "narendly"}, "path": "helix-lock/src/main/java/org/apache/helix/lock/helix/ZKDistributedNonblockingLock.java", "diffHunk": "@@ -24,17 +24,21 @@\n import org.apache.helix.AccessOption;\n import org.apache.helix.BaseDataAccessor;\n import org.apache.helix.HelixException;\n+import org.apache.helix.SystemPropertyKeys;\n import org.apache.helix.lock.DistributedLock;\n import org.apache.helix.lock.LockInfo;\n import org.apache.helix.lock.LockScope;\n+import org.apache.helix.manager.zk.GenericZkHelixApiBuilder;\n import org.apache.helix.manager.zk.ZkBaseDataAccessor;\n import org.apache.helix.zookeeper.datamodel.ZNRecord;\n import org.apache.helix.zookeeper.zkclient.DataUpdater;\n import org.apache.log4j.Logger;\n \n \n /**\n- * Helix nonblocking lock implementation based on Zookeeper\n+ * Helix nonblocking lock implementation based on Zookeeper.\n+ * NOTE: do NOT use ephemeral nodes in this implementation because ephemeral mode is not supported", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3Mzg0NA=="}, "originalCommit": {"oid": "9fb23deeb79a09cb101a8578244332d627e783c4"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMTgxNzEyOnYy", "diffSide": "RIGHT", "path": "helix-lock/src/main/java/org/apache/helix/lock/helix/ZKDistributedNonblockingLock.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMTozNTo0MVrOHaDAng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMTozNTo0MVrOHaDAng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3NDMzNA==", "bodyText": "This line can be put together with the following comments.", "url": "https://github.com/apache/helix/pull/1409#discussion_r497074334", "createdAt": "2020-09-29T21:35:41Z", "author": {"login": "zhangmeng916"}, "path": "helix-lock/src/main/java/org/apache/helix/lock/helix/ZKDistributedNonblockingLock.java", "diffHunk": "@@ -143,11 +147,65 @@ public ZNRecord update(ZNRecord current) {\n       if (!(System.currentTimeMillis() < curLockInfo.getTimeout()) || isCurrentOwner()) {\n         return _record;\n       }\n-      // For users who are not the lock owner and try to do an update on a lock that is held by someone else, exception thrown is to be caught by data accessor, and return false for the update\n+      // For users who are not the lock owner and try to do an update on a lock that is held by\n+      // someone else, exception thrown is to be caught by data accessor, and return false for\n+      // the update\n       LOG.error(\n           \"User \" + _userId + \" tried to update the lock at \" + new Date(System.currentTimeMillis())\n               + \". Lock path: \" + _lockPath);\n       throw new HelixException(\"User is not authorized to perform this operation.\");\n     }\n   }\n+\n+  /**\n+   * Builder class to use with ZKDistributedNonblockingLock.\n+   */\n+  public static class Builder extends GenericZkHelixApiBuilder<Builder> {\n+    private LockScope _lockScope;\n+    private String _userId;\n+    private long _timeout;\n+    private String _lockMsg;\n+\n+    public Builder() {\n+    }\n+\n+    public Builder setLockScope(LockScope lockScope) {\n+      _lockScope = lockScope;\n+      return this;\n+    }\n+\n+    public Builder setUserId(String userId) {\n+      _userId = userId;\n+      return this;\n+    }\n+\n+    public Builder setTimeout(long timeout) {\n+      _timeout = timeout;\n+      return this;\n+    }\n+\n+    public Builder setLockMsg(String lockMsg) {\n+      _lockMsg = lockMsg;\n+      return this;\n+    }\n+\n+    public ZKDistributedNonblockingLock build() {\n+      // Resolve which way we want to create BaseDataAccessor instance", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fb23deeb79a09cb101a8578244332d627e783c4"}, "originalPosition": 104}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 966, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}