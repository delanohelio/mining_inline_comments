{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NTExMjc3", "number": 1256, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNzowMDo1N1rOEXfz6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzoxNjo1MFrOEXuM8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMDczODk5OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/controller/changedetector/trimmer/HelixPropertyTrimmer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNzowMDo1N1rOG_UUuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzoxNzo1NFrOG_q9GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NjQ1OQ==", "bodyText": "This is a high-level comment:\nSince this is causing an issue for the admin.rebalance method (which essentially just populates the mapFields in the IdealState), my immediate instinct would be that this change could be contained in IdealStateTrimmer.\nThis way, we contain the scope of changes for IdealStates only - and it should fix the problem we're seeing with resources not being rebalanced. Is there any difficulty with overriding doTrim() in IdealStateTrimmer instead of making the change and applying it generally in HelixPropertyTrimmer?", "url": "https://github.com/apache/helix/pull/1256#discussion_r469046459", "createdAt": "2020-08-12T07:00:57Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/controller/changedetector/trimmer/HelixPropertyTrimmer.java", "diffHunk": "@@ -57,38 +57,49 @@\n    * @param originalProperty\n    */\n   protected ZNRecord doTrim(T originalProperty) {\n+    ZNRecord originalZNRecord = originalProperty.getRecord();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a49fa3be60afb35f13ee9b7f04d1173b37ee15f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA3MDk5OA==", "bodyText": "Good point. So this is also my first try. FYI, I also tried to extend the field type to include LIST_FIELD_KEY_ONLY. But then I find these 2 solutions are too complicated.\nIt is correct that putting this logic into the IdealStateTrimmer will immediately fix the problem without too much change. The complex is that in this way, it would be hard to reason the overall logic of all trimmers. Some of them care about values, the others do not. Of course, we can add comments. But gradually, it will become harder to understand and maintain.\nSo I go back and think about why we need these trimmers. Do we need to trim soo much information? I think we don't. The rebalancer will perform well even we detect all keys change (no value, just key's change) for all the properties. And the logic is very clean and concentrate:\n\nKeys are not ignored\nValues are ignored accordingly and this is specified by the getNonTrimmableFields() method.\n\nThen I firstly tried to not trim all keys (including the simple fields). But then I realize it is not optimal, since the simple fields' keys are tightly bounded with the values. And finally, I have the current proposal.\nOverall, the main reason for this trade-off is to make the trim logic less diverse and easier to maintain.", "url": "https://github.com/apache/helix/pull/1256#discussion_r469070998", "createdAt": "2020-08-12T07:49:19Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/changedetector/trimmer/HelixPropertyTrimmer.java", "diffHunk": "@@ -57,38 +57,49 @@\n    * @param originalProperty\n    */\n   protected ZNRecord doTrim(T originalProperty) {\n+    ZNRecord originalZNRecord = originalProperty.getRecord();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NjQ1OQ=="}, "originalCommit": {"oid": "7a49fa3be60afb35f13ee9b7f04d1173b37ee15f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxNzI0MA==", "bodyText": "BTW, the ideal solution is to separate the ZK paths for input and output. Then we can simplify or even remove the trim logic as desired.", "url": "https://github.com/apache/helix/pull/1256#discussion_r469417240", "createdAt": "2020-08-12T17:17:54Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/changedetector/trimmer/HelixPropertyTrimmer.java", "diffHunk": "@@ -57,38 +57,49 @@\n    * @param originalProperty\n    */\n   protected ZNRecord doTrim(T originalProperty) {\n+    ZNRecord originalZNRecord = originalProperty.getRecord();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NjQ1OQ=="}, "originalCommit": {"oid": "7a49fa3be60afb35f13ee9b7f04d1173b37ee15f"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMzA5NjgxOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/controller/changedetector/trimmer/HelixPropertyTrimmer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzoxNjo1MFrOG_q6aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzozNTo1NlrOG_rmtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxNjU1Mg==", "bodyText": "This part of code may come as a surprise to future developers that extend this class. When getNonTrimmableFields() is provided for overriding, it's natural to think getNonTrimmableFields() provides full control on \"what fields to keep\". This logic here, while necessary, may become debug overhead. It's also hard to change this behavior in the future if it stays in doTrim() like so.\nI suggest creating another function such as getNonTrimmableKeysOnly() and implement it under HelixPropertyTrimmer.java to preserve MapField and ListField keys by default; in doTrim(), we call that function and preserve keys only. The extended classes may choose to override it (and for now, they shouldn't). This is a clearer approach to creating this abstract class.", "url": "https://github.com/apache/helix/pull/1256#discussion_r469416552", "createdAt": "2020-08-12T17:16:50Z", "author": {"login": "NealSun96"}, "path": "helix-core/src/main/java/org/apache/helix/controller/changedetector/trimmer/HelixPropertyTrimmer.java", "diffHunk": "@@ -57,38 +57,49 @@\n    * @param originalProperty\n    */\n   protected ZNRecord doTrim(T originalProperty) {\n+    ZNRecord originalZNRecord = originalProperty.getRecord();\n     ZNRecord trimmedZNRecord = new ZNRecord(originalProperty.getId());\n-    for (Map.Entry<FieldType, Set<String>> fieldEntry : getNonTrimmableFields(\n-        originalProperty).entrySet()) {\n+    Map<FieldType, Set<String>> nonTrimmableFields = getNonTrimmableFields(originalProperty);\n+\n+    // Ensure the keys of all map fields and list fields are preserved even after the trim.\n+    // The keys of list and map fields are relatively stable and contain important information. So\n+    // they should not be trimmed.\n+    originalZNRecord.getMapFields().keySet().stream()\n+        .forEach(key -> trimmedZNRecord.setMapField(key, Collections.EMPTY_MAP));\n+    originalZNRecord.getListFields().keySet().stream()\n+        .forEach(key -> trimmedZNRecord.setListField(key, Collections.EMPTY_LIST));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a49fa3be60afb35f13ee9b7f04d1173b37ee15f"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQyNzg5NQ==", "bodyText": "Good idea. It helps to clean up the code.", "url": "https://github.com/apache/helix/pull/1256#discussion_r469427895", "createdAt": "2020-08-12T17:35:56Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/changedetector/trimmer/HelixPropertyTrimmer.java", "diffHunk": "@@ -57,38 +57,49 @@\n    * @param originalProperty\n    */\n   protected ZNRecord doTrim(T originalProperty) {\n+    ZNRecord originalZNRecord = originalProperty.getRecord();\n     ZNRecord trimmedZNRecord = new ZNRecord(originalProperty.getId());\n-    for (Map.Entry<FieldType, Set<String>> fieldEntry : getNonTrimmableFields(\n-        originalProperty).entrySet()) {\n+    Map<FieldType, Set<String>> nonTrimmableFields = getNonTrimmableFields(originalProperty);\n+\n+    // Ensure the keys of all map fields and list fields are preserved even after the trim.\n+    // The keys of list and map fields are relatively stable and contain important information. So\n+    // they should not be trimmed.\n+    originalZNRecord.getMapFields().keySet().stream()\n+        .forEach(key -> trimmedZNRecord.setMapField(key, Collections.EMPTY_MAP));\n+    originalZNRecord.getListFields().keySet().stream()\n+        .forEach(key -> trimmedZNRecord.setListField(key, Collections.EMPTY_LIST));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxNjU1Mg=="}, "originalCommit": {"oid": "7a49fa3be60afb35f13ee9b7f04d1173b37ee15f"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 886, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}