{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNjk4NjU0", "number": 846, "title": "Make ZKHelixAdmin and ZKHelixManager Realm-aware", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nImplements #847\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nTo make Helix Java APIs realm-aware, we need to make ZKHelixAdmin and ZKHelixManager realm-aware.\nTests\n\n The following tests are written for this issue:\nCurrent TestZkHelixAdmin, TestHandleNewSession  cover the tests\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n[INFO] Results:\n[INFO]\n[ERROR] Failures:\n[ERROR]   TestJobQueueCleanUp.testJobQueueAutoCleanUp \u00bb ThreadTimeout Method org.testng....\n[ERROR]   TestRebalanceRunningTask.testFixedTargetTaskAndDisabledRebalanceAndNodeAdded:265 expected:<true> but was:<false>\n[INFO]\n[ERROR] Tests run: 1083, Failures: 2, Errors: 0, Skipped: 1\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD FAILURE\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  01:13 h\n[INFO] Finished at: 2020-03-11T23:49:26-07:00\n[INFO] ------------------------------------------------------------------------\n\n[INFO] Tests run: 5, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 19.945 s - in org.apache.helix.integration.task.TestRebalanceRunningTask\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 5, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n\n[INFO] Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 13.597 s - in org.apache.helix.integration.task.TestJobQueueCleanUp\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 3, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n\nCommits\n\n My commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nDocumentation (Optional)\n\n In case of new functionality, my PR adds documentation in the following wiki page:\n\n(Link the GitHub wiki you added)\nCode Quality\n\n My diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-03-03T01:40:03Z", "url": "https://github.com/apache/helix/pull/846", "merged": true, "mergeCommit": {"oid": "74b220d467f0a3c976f299d616fe143e3ca662d1"}, "closed": true, "closedAt": "2020-03-12T16:44:39Z", "author": {"login": "huizhilu"}, "timelineItems": {"totalCount": 47, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJ9He7gBqjMwOTA5NDM1NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcM0w-kAFqTM3MzI4NDg4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ced3a6c577e0bc893c6581e35e2fa65ad67ce89b", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/ced3a6c577e0bc893c6581e35e2fa65ad67ce89b", "committedDate": "2020-03-03T01:38:39Z", "message": "Make HelixAdmin realm aware"}, "afterCommit": {"oid": "feee54df993660b704835897d4a5c819290ab269", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/feee54df993660b704835897d4a5c819290ab269", "committedDate": "2020-03-03T07:22:59Z", "message": "Make ZKHelixAdmin realm-aware"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "feee54df993660b704835897d4a5c819290ab269", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/feee54df993660b704835897d4a5c819290ab269", "committedDate": "2020-03-03T07:22:59Z", "message": "Make ZKHelixAdmin realm-aware"}, "afterCommit": {"oid": "d747bc31d5188a28f25630f20a80bd0b7cdc501d", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/d747bc31d5188a28f25630f20a80bd0b7cdc501d", "committedDate": "2020-03-03T17:51:26Z", "message": "Make ZKHelixAdmin realm-aware"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d747bc31d5188a28f25630f20a80bd0b7cdc501d", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/d747bc31d5188a28f25630f20a80bd0b7cdc501d", "committedDate": "2020-03-03T17:51:26Z", "message": "Make ZKHelixAdmin realm-aware"}, "afterCommit": {"oid": "e8d0c033d80ebcbfa14a4fc4b1f821e90bc1d027", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/e8d0c033d80ebcbfa14a4fc4b1f821e90bc1d027", "committedDate": "2020-03-03T17:53:49Z", "message": "Make ZKHelixAdmin realm-aware"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8d0c033d80ebcbfa14a4fc4b1f821e90bc1d027", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/e8d0c033d80ebcbfa14a4fc4b1f821e90bc1d027", "committedDate": "2020-03-03T17:53:49Z", "message": "Make ZKHelixAdmin realm-aware"}, "afterCommit": {"oid": "75ce6e168c44a6cea1cc90e153a80541c8088a27", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/75ce6e168c44a6cea1cc90e153a80541c8088a27", "committedDate": "2020-03-03T17:55:54Z", "message": "Make ZKHelixAdmin realm-aware"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75ce6e168c44a6cea1cc90e153a80541c8088a27", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/75ce6e168c44a6cea1cc90e153a80541c8088a27", "committedDate": "2020-03-03T17:55:54Z", "message": "Make ZKHelixAdmin realm-aware"}, "afterCommit": {"oid": "08e9b7d61bc0e5856b720db82d9e65fb6d87daf9", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/08e9b7d61bc0e5856b720db82d9e65fb6d87daf9", "committedDate": "2020-03-03T18:17:30Z", "message": "Make ZKHelixAdmin realm-aware"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08e9b7d61bc0e5856b720db82d9e65fb6d87daf9", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/08e9b7d61bc0e5856b720db82d9e65fb6d87daf9", "committedDate": "2020-03-03T18:17:30Z", "message": "Make ZKHelixAdmin realm-aware"}, "afterCommit": {"oid": "fd0282158b519a7514559d8bafd8cfc2598ba490", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/fd0282158b519a7514559d8bafd8cfc2598ba490", "committedDate": "2020-03-04T04:10:02Z", "message": "Make ZKHelixAdmin and ZKHelixManager realm-aware"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd0282158b519a7514559d8bafd8cfc2598ba490", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/fd0282158b519a7514559d8bafd8cfc2598ba490", "committedDate": "2020-03-04T04:10:02Z", "message": "Make ZKHelixAdmin and ZKHelixManager realm-aware"}, "afterCommit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/039f735ce85ffc5f3e0af10a3a9109547f7cbfb3", "committedDate": "2020-03-04T06:13:44Z", "message": "Make ZKHelixAdmin and ZKHelixManager realm-aware"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTU4NzUz", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-368558753", "createdAt": "2020-03-04T07:43:21Z", "commit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzo0MzoyMVrOFxiupw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzo0MzoyMVrOFxiupw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ5MzU0Mw==", "bodyText": "The new ConfigAccessor should be created with a Builder. I'm going to assume that this is just a placeholder? :)", "url": "https://github.com/apache/helix/pull/846#discussion_r387493543", "createdAt": "2020-03-04T07:43:21Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/ConfigAccessor.java", "diffHunk": "@@ -118,6 +118,11 @@ public ConfigAccessor(HelixZkClient zkClient) {\n     _usesExternalZkClient = true;\n   }\n \n+  public ConfigAccessor(RealmAwareZkClient zkClient) {\n+    _zkClient = zkClient;\n+    _usesExternalZkClient = true;\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTYwNDA0", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-368560404", "createdAt": "2020-03-04T07:46:58Z", "commit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzo0Njo1OFrOFxiztg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzo0Njo1OFrOFxiztg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ5NDgzOA==", "bodyText": "We should use a Builder pattern for HelixAdmin here. This is because we need to allow users to provide connection and client configs.\nFor example, users should be able to set operationRetry time. If we just provide a constructor that doesn't take in any parameters, it won't be very flexible.\n#819 for a reference.", "url": "https://github.com/apache/helix/pull/846#discussion_r387494838", "createdAt": "2020-03-04T07:46:58Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -89,33 +91,55 @@\n \n \n public class ZKHelixAdmin implements HelixAdmin {\n+  private static final Logger LOG = LoggerFactory.getLogger(ZKHelixAdmin.class);\n+\n+\n   public static final String CONNECTION_TIMEOUT = \"helixAdmin.timeOutInSec\";\n   private static final String MAINTENANCE_ZNODE_ID = \"maintenance\";\n   private static final int DEFAULT_SUPERCLUSTER_REPLICA = 3;\n \n-  private final HelixZkClient _zkClient;\n+  private final RealmAwareZkClient _zkClient;\n   private final ConfigAccessor _configAccessor;\n   // true if ZKHelixAdmin was instantiated with a HelixZkClient, false otherwise\n   // This is used for close() to determine how ZKHelixAdmin should close the underlying ZkClient\n   private final boolean _usesExternalZkClient;\n \n   private static Logger logger = LoggerFactory.getLogger(ZKHelixAdmin.class);\n \n-  @Deprecated\n-  public ZKHelixAdmin(HelixZkClient zkClient) {\n+  public ZKHelixAdmin() {\n+    _zkClient = new FederatedZkClient();\n+    _configAccessor = new ConfigAccessor(_zkClient);\n+    _usesExternalZkClient = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTYyMzU1", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-368562355", "createdAt": "2020-03-04T07:51:25Z", "commit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzo1MToyNVrOFxi6Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzo1MToyNVrOFxi6Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ5NjQ5OQ==", "bodyText": "I just realized I forgot to add this logic for ConfigAccessor. Let me open another PR :)", "url": "https://github.com/apache/helix/pull/846#discussion_r387496499", "createdAt": "2020-03-04T07:51:25Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -89,33 +91,55 @@\n \n \n public class ZKHelixAdmin implements HelixAdmin {\n+  private static final Logger LOG = LoggerFactory.getLogger(ZKHelixAdmin.class);\n+\n+\n   public static final String CONNECTION_TIMEOUT = \"helixAdmin.timeOutInSec\";\n   private static final String MAINTENANCE_ZNODE_ID = \"maintenance\";\n   private static final int DEFAULT_SUPERCLUSTER_REPLICA = 3;\n \n-  private final HelixZkClient _zkClient;\n+  private final RealmAwareZkClient _zkClient;\n   private final ConfigAccessor _configAccessor;\n   // true if ZKHelixAdmin was instantiated with a HelixZkClient, false otherwise\n   // This is used for close() to determine how ZKHelixAdmin should close the underlying ZkClient\n   private final boolean _usesExternalZkClient;\n \n   private static Logger logger = LoggerFactory.getLogger(ZKHelixAdmin.class);\n \n-  @Deprecated\n-  public ZKHelixAdmin(HelixZkClient zkClient) {\n+  public ZKHelixAdmin() {\n+    _zkClient = new FederatedZkClient();\n+    _configAccessor = new ConfigAccessor(_zkClient);\n+    _usesExternalZkClient = false;\n+  }\n+\n+  public ZKHelixAdmin(RealmAwareZkClient zkClient) {\n     _zkClient = zkClient;\n     _configAccessor = new ConfigAccessor(zkClient);\n     _usesExternalZkClient = true;\n   }\n \n   public ZKHelixAdmin(String zkAddress) {\n     int timeOutInSec = Integer.parseInt(System.getProperty(CONNECTION_TIMEOUT, \"30\"));\n-    HelixZkClient.ZkClientConfig clientConfig = new HelixZkClient.ZkClientConfig();\n-    clientConfig.setZkSerializer(new ZNRecordSerializer())\n-        .setConnectInitTimeout(timeOutInSec * 1000);\n-    _zkClient = SharedZkClientFactory.getInstance()\n-        .buildZkClient(new HelixZkClient.ZkConnectionConfig(zkAddress), clientConfig);\n-    _zkClient.waitUntilConnected(timeOutInSec, TimeUnit.SECONDS);\n+    RealmAwareZkClient.RealmAwareZkClientConfig clientConfig =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTY0NTMx", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-368564531", "createdAt": "2020-03-04T07:56:18Z", "commit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzo1NjoxOFrOFxjBVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzo1NjoxOFrOFxjBVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ5ODMyNA==", "bodyText": "Do you think we could refactor these two methods to reduce duplicate logic? You could take in the factory in the parameter and switch back and forth between dedicated and shared that way.", "url": "https://github.com/apache/helix/pull/846#discussion_r387498324", "createdAt": "2020-03-04T07:56:18Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -1285,4 +1264,87 @@ public void handleSessionEstablishmentError(Throwable error) throws Exception {\n   public Long getSessionStartTime() {\n     return _sessionStartTime;\n   }\n+\n+  private RealmAwareZkClient buildRealmAwareZkClient() {\n+    final String shardingKey = buildShardingKey();\n+    PathBasedZkSerializer zkSerializer =\n+        ChainedPathZkSerializer.builder(new ZNRecordSerializer()).build();\n+\n+    RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig =\n+        new RealmAwareZkClient.RealmAwareZkConnectionConfig.Builder()\n+            .setRealmMode(RealmAwareZkClient.RealmMode.SINGLE_REALM)\n+            .setZkRealmShardingKey(shardingKey)\n+            .setSessionTimeout(_sessionTimeout).build();\n+\n+    RealmAwareZkClient.RealmAwareZkClientConfig clientConfig =\n+        new RealmAwareZkClient.RealmAwareZkClientConfig();\n+\n+    clientConfig.setZkSerializer(zkSerializer)\n+        .setConnectInitTimeout(_connectionInitTimeout)\n+        .setMonitorType(_instanceType.name())\n+        .setMonitorKey(_clusterName)\n+        .setMonitorInstanceName(_instanceName)\n+        .setMonitorRootPathOnly(isMonitorRootPathOnly());\n+\n+    RealmAwareZkClient newClient;\n+    if (_instanceType == InstanceType.ADMINISTRATOR) {\n+      newClient = buildSharedZkClient(connectionConfig, clientConfig);\n+    } else {\n+      newClient = buildDedicatedZkClient(connectionConfig, clientConfig);\n+    }\n+\n+    return newClient;\n+  }\n+\n+  private RealmAwareZkClient buildSharedZkClient(\n+      RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig,\n+      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig) {\n+    RealmAwareZkClient zkClient;\n+    // TODO: change exception type\n+    try {\n+      zkClient =\n+          SharedZkClientFactory.getInstance().buildZkClient(connectionConfig, clientConfig);\n+    } catch (IllegalArgumentException e) {\n+      LOG.warn(\"Not able to build realm-aware shared ZK client for sharding key: {}, caused by: {}\"\n+              + \" Fallback to HelixZkClient.\", connectionConfig.getZkRealmShardingKey(),\n+          e.getMessage());\n+\n+      // Fallback to HelixZkClient\n+      HelixZkClient.ZkConnectionConfig helixZkConnectionConfig =\n+          new HelixZkClient.ZkConnectionConfig(_zkAddress);\n+      helixZkConnectionConfig.setSessionTimeout(connectionConfig.getSessionTimeout());\n+      zkClient = SharedZkClientFactory.getInstance()\n+          .buildZkClient(helixZkConnectionConfig, clientConfig.createHelixZkClientConfig());\n+    }\n+\n+    return zkClient;\n+  }\n+\n+  private RealmAwareZkClient buildDedicatedZkClient(\n+      RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig,\n+      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig) {\n+    RealmAwareZkClient zkClient;\n+    // TODO: change exception type\n+    try {\n+      zkClient =\n+          DedicatedZkClientFactory.getInstance().buildZkClient(connectionConfig, clientConfig);\n+    } catch (IllegalArgumentException e) {\n+      LOG.warn(\"Not able to build realm-aware Dedicated ZK client for sharding key: {}, caused by: {}\"\n+              + \" Fallback to HelixZkClient.\", connectionConfig.getZkRealmShardingKey(),\n+          e.getMessage());\n+\n+      // Fallback to HelixZkClient\n+      HelixZkClient.ZkConnectionConfig helixZkConnectionConfig =\n+          new HelixZkClient.ZkConnectionConfig(_zkAddress);\n+      helixZkConnectionConfig.setSessionTimeout(connectionConfig.getSessionTimeout());\n+      zkClient = DedicatedZkClientFactory.getInstance()\n+          .buildZkClient(helixZkConnectionConfig, clientConfig.createHelixZkClientConfig());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3"}, "originalPosition": 136}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTY1OTA1", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-368565905", "createdAt": "2020-03-04T07:59:14Z", "commit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzo1OToxNFrOFxjFyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNzo1OToxNFrOFxjFyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ5OTQ2Nw==", "bodyText": "FederatedZkClient should take in connectionConfig and clientConfig. I'll just assume this is a placeholder.", "url": "https://github.com/apache/helix/pull/846#discussion_r387499467", "createdAt": "2020-03-04T07:59:14Z", "author": {"login": "narendly"}, "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/FederatedZkClient.java", "diffHunk": "@@ -79,7 +83,31 @@\n   private volatile boolean _isClosed;\n   private PathBasedZkSerializer _pathBasedZkSerializer;\n \n+  public FederatedZkClient() {\n+    this(new RealmAwareZkClient.RealmAwareZkClientConfig()\n+        .setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n   // TODO: support capacity of ZkClient number in one FederatedZkClient and do garbage collection.\n+  public FederatedZkClient(RealmAwareZkClient.RealmAwareZkClientConfig clientConfig) {\n+    try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "039f735ce85ffc5f3e0af10a3a9109547f7cbfb3", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/039f735ce85ffc5f3e0af10a3a9109547f7cbfb3", "committedDate": "2020-03-04T06:13:44Z", "message": "Make ZKHelixAdmin and ZKHelixManager realm-aware"}, "afterCommit": {"oid": "29386bf1c066a36b47fa50ad75cf8e31f907e9a2", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/29386bf1c066a36b47fa50ad75cf8e31f907e9a2", "committedDate": "2020-03-04T22:44:44Z", "message": "Make ZKHelixAdmin and ZKHelixManager Realm-aware"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MjQwNDk3", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-369240497", "createdAt": "2020-03-05T01:27:15Z", "commit": {"oid": "29386bf1c066a36b47fa50ad75cf8e31f907e9a2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwMToyNzoxNlrOFyDi1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwMToyODoxNVrOFyDj4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzMTE5MQ==", "bodyText": "Is it possible to combine buildSharedZkClient and buildDedicatedZkClient to reduce duplication? Both instances of the factories extend HelixZkClientFactory.", "url": "https://github.com/apache/helix/pull/846#discussion_r388031191", "createdAt": "2020-03-05T01:27:16Z", "author": {"login": "NealSun96"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -1285,4 +1266,85 @@ public void handleSessionEstablishmentError(Throwable error) throws Exception {\n   public Long getSessionStartTime() {\n     return _sessionStartTime;\n   }\n+\n+  private RealmAwareZkClient buildRealmAwareZkClient() {\n+    final String shardingKey = buildShardingKey();\n+    PathBasedZkSerializer zkSerializer =\n+        ChainedPathZkSerializer.builder(new ZNRecordSerializer()).build();\n+\n+    RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig =\n+        new RealmAwareZkClient.RealmAwareZkConnectionConfig.Builder()\n+            .setRealmMode(RealmAwareZkClient.RealmMode.SINGLE_REALM)\n+            .setZkRealmShardingKey(shardingKey)\n+            .setSessionTimeout(_sessionTimeout).build();\n+\n+    RealmAwareZkClient.RealmAwareZkClientConfig clientConfig =\n+        new RealmAwareZkClient.RealmAwareZkClientConfig();\n+\n+    clientConfig.setZkSerializer(zkSerializer)\n+        .setConnectInitTimeout(_connectionInitTimeout)\n+        .setMonitorType(_instanceType.name())\n+        .setMonitorKey(_clusterName)\n+        .setMonitorInstanceName(_instanceName)\n+        .setMonitorRootPathOnly(isMonitorRootPathOnly());\n+\n+    RealmAwareZkClient newClient;\n+    if (_instanceType == InstanceType.ADMINISTRATOR) {\n+      newClient = buildSharedZkClient(connectionConfig, clientConfig);\n+    } else {\n+      newClient = buildDedicatedZkClient(connectionConfig, clientConfig);\n+    }\n+\n+    return newClient;\n+  }\n+\n+  private RealmAwareZkClient buildSharedZkClient(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29386bf1c066a36b47fa50ad75cf8e31f907e9a2"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzMTQ1OQ==", "bodyText": "Nit: not much point declaring SLASH if it's character counter-part is a local variable.", "url": "https://github.com/apache/helix/pull/846#discussion_r388031459", "createdAt": "2020-03-05T01:28:15Z", "author": {"login": "NealSun96"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -1285,4 +1266,85 @@ public void handleSessionEstablishmentError(Throwable error) throws Exception {\n   public Long getSessionStartTime() {\n     return _sessionStartTime;\n   }\n+\n+  private RealmAwareZkClient buildRealmAwareZkClient() {\n+    final String shardingKey = buildShardingKey();\n+    PathBasedZkSerializer zkSerializer =\n+        ChainedPathZkSerializer.builder(new ZNRecordSerializer()).build();\n+\n+    RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig =\n+        new RealmAwareZkClient.RealmAwareZkConnectionConfig.Builder()\n+            .setRealmMode(RealmAwareZkClient.RealmMode.SINGLE_REALM)\n+            .setZkRealmShardingKey(shardingKey)\n+            .setSessionTimeout(_sessionTimeout).build();\n+\n+    RealmAwareZkClient.RealmAwareZkClientConfig clientConfig =\n+        new RealmAwareZkClient.RealmAwareZkClientConfig();\n+\n+    clientConfig.setZkSerializer(zkSerializer)\n+        .setConnectInitTimeout(_connectionInitTimeout)\n+        .setMonitorType(_instanceType.name())\n+        .setMonitorKey(_clusterName)\n+        .setMonitorInstanceName(_instanceName)\n+        .setMonitorRootPathOnly(isMonitorRootPathOnly());\n+\n+    RealmAwareZkClient newClient;\n+    if (_instanceType == InstanceType.ADMINISTRATOR) {\n+      newClient = buildSharedZkClient(connectionConfig, clientConfig);\n+    } else {\n+      newClient = buildDedicatedZkClient(connectionConfig, clientConfig);\n+    }\n+\n+    return newClient;\n+  }\n+\n+  private RealmAwareZkClient buildSharedZkClient(\n+      RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig,\n+      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig) {\n+    RealmAwareZkClient zkClient;\n+    try {\n+      zkClient =\n+          SharedZkClientFactory.getInstance().buildZkClient(connectionConfig, clientConfig);\n+    } catch (IllegalArgumentException | IOException | InvalidRoutingDataException e) {\n+      LOG.warn(\"Not able to build realm-aware shared ZK client for sharding key: {}, caused by: {}\"\n+              + \" Fallback to HelixZkClient.\", connectionConfig.getZkRealmShardingKey(),\n+          e.getMessage());\n+\n+      // Fallback to HelixZkClient\n+      HelixZkClient.ZkConnectionConfig helixZkConnectionConfig =\n+          new HelixZkClient.ZkConnectionConfig(_zkAddress);\n+      helixZkConnectionConfig.setSessionTimeout(connectionConfig.getSessionTimeout());\n+      zkClient = SharedZkClientFactory.getInstance()\n+          .buildZkClient(helixZkConnectionConfig, clientConfig.createHelixZkClientConfig());\n+    }\n+\n+    return zkClient;\n+  }\n+\n+  private RealmAwareZkClient buildDedicatedZkClient(\n+      RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig,\n+      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig) {\n+    RealmAwareZkClient zkClient;\n+    try {\n+      zkClient =\n+          DedicatedZkClientFactory.getInstance().buildZkClient(connectionConfig, clientConfig);\n+    } catch (IllegalArgumentException | IOException | InvalidRoutingDataException e) {\n+      LOG.warn(\"Not able to build realm-aware Dedicated ZK client for sharding key: {}, caused by: {}\"\n+              + \" Fall back to HelixZkClient.\", connectionConfig.getZkRealmShardingKey(),\n+          e.getMessage());\n+\n+      // Fallback to HelixZkClient\n+      HelixZkClient.ZkConnectionConfig helixZkConnectionConfig =\n+          new HelixZkClient.ZkConnectionConfig(_zkAddress);\n+      helixZkConnectionConfig.setSessionTimeout(connectionConfig.getSessionTimeout());\n+      zkClient = DedicatedZkClientFactory.getInstance()\n+          .buildZkClient(helixZkConnectionConfig, clientConfig.createHelixZkClientConfig());\n+    }\n+\n+    return zkClient;\n+  }\n+\n+  private String buildShardingKey() {\n+    return _clusterName.charAt(0) == '/' ? _clusterName : SLASH + _clusterName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29386bf1c066a36b47fa50ad75cf8e31f907e9a2"}, "originalPosition": 155}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29386bf1c066a36b47fa50ad75cf8e31f907e9a2", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/29386bf1c066a36b47fa50ad75cf8e31f907e9a2", "committedDate": "2020-03-04T22:44:44Z", "message": "Make ZKHelixAdmin and ZKHelixManager Realm-aware"}, "afterCommit": {"oid": "ca0e0cba1b7bbc223053d333c3e3033b50d3a703", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/ca0e0cba1b7bbc223053d333c3e3033b50d3a703", "committedDate": "2020-03-05T18:47:55Z", "message": "Make ZKHelixAdmin and ZKHelixManager Realm-aware"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODUxMjI4", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-369851228", "createdAt": "2020-03-05T19:28:38Z", "commit": {"oid": "ca0e0cba1b7bbc223053d333c3e3033b50d3a703"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOToyODozOFrOFyg_dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOToyODozOFrOFyg_dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUxMzY1NQ==", "bodyText": "Why is the constructor throwing all sorts of exceptions? As we discussed, this is where we catch checked exceptions.", "url": "https://github.com/apache/helix/pull/846#discussion_r388513655", "createdAt": "2020-03-05T19:28:38Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -89,33 +91,77 @@\n \n \n public class ZKHelixAdmin implements HelixAdmin {\n+  private static final Logger LOG = LoggerFactory.getLogger(ZKHelixAdmin.class);\n+\n+\n   public static final String CONNECTION_TIMEOUT = \"helixAdmin.timeOutInSec\";\n   private static final String MAINTENANCE_ZNODE_ID = \"maintenance\";\n   private static final int DEFAULT_SUPERCLUSTER_REPLICA = 3;\n \n-  private final HelixZkClient _zkClient;\n+  private final RealmAwareZkClient _zkClient;\n   private final ConfigAccessor _configAccessor;\n-  // true if ZKHelixAdmin was instantiated with a HelixZkClient, false otherwise\n+  // true if ZKHelixAdmin was instantiated with a RealmAwareZkClient, false otherwise\n   // This is used for close() to determine how ZKHelixAdmin should close the underlying ZkClient\n   private final boolean _usesExternalZkClient;\n \n   private static Logger logger = LoggerFactory.getLogger(ZKHelixAdmin.class);\n \n+  /**\n+   * @deprecated it is recommended to use the other constructors instead to avoid having to manually\n+   * create and maintain a RealmAwareZkClient outside of ZkBaseDataAccessor.\n+   *\n+   * @param zkClient A created RealmAwareZkClient\n+   */\n   @Deprecated\n-  public ZKHelixAdmin(HelixZkClient zkClient) {\n+  public ZKHelixAdmin(RealmAwareZkClient zkClient) {\n     _zkClient = zkClient;\n     _configAccessor = new ConfigAccessor(zkClient);\n     _usesExternalZkClient = true;\n   }\n \n   public ZKHelixAdmin(String zkAddress) {\n     int timeOutInSec = Integer.parseInt(System.getProperty(CONNECTION_TIMEOUT, \"30\"));\n-    HelixZkClient.ZkClientConfig clientConfig = new HelixZkClient.ZkClientConfig();\n-    clientConfig.setZkSerializer(new ZNRecordSerializer())\n-        .setConnectInitTimeout(timeOutInSec * 1000);\n-    _zkClient = SharedZkClientFactory.getInstance()\n-        .buildZkClient(new HelixZkClient.ZkConnectionConfig(zkAddress), clientConfig);\n-    _zkClient.waitUntilConnected(timeOutInSec, TimeUnit.SECONDS);\n+    RealmAwareZkClient.RealmAwareZkClientConfig clientConfig =\n+        new RealmAwareZkClient.RealmAwareZkClientConfig()\n+            .setConnectInitTimeout(timeOutInSec * 1000L)\n+            .setZkSerializer(new ZNRecordSerializer());\n+\n+    RealmAwareZkClient zkClient;\n+    try {\n+      zkClient = new FederatedZkClient(\n+          new RealmAwareZkClient.RealmAwareZkConnectionConfig.Builder().build(), clientConfig);\n+    } catch (IllegalStateException | IOException | InvalidRoutingDataException e) {\n+      LOG.info(\"Not able to connect on multi-realm mode. \"\n+          + \"Connecting on single-realm mode to ZK: {}\", zkAddress);\n+\n+      zkClient = SharedZkClientFactory.getInstance()\n+          .buildZkClient(new HelixZkClient.ZkConnectionConfig(zkAddress),\n+              clientConfig.createHelixZkClientConfig());\n+      zkClient.waitUntilConnected(timeOutInSec, TimeUnit.SECONDS);\n+    }\n+\n+    _zkClient = zkClient;\n+    _configAccessor = new ConfigAccessor(_zkClient);\n+    _usesExternalZkClient = false;\n+  }\n+\n+  private ZKHelixAdmin(Builder builder) throws IOException, InvalidRoutingDataException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca0e0cba1b7bbc223053d333c3e3033b50d3a703"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODUxMzk2", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-369851396", "createdAt": "2020-03-05T19:28:54Z", "commit": {"oid": "ca0e0cba1b7bbc223053d333c3e3033b50d3a703"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOToyODo1NFrOFyhADQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOToyODo1NFrOFyhADQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUxMzgwNQ==", "bodyText": "This should be a try-catch.", "url": "https://github.com/apache/helix/pull/846#discussion_r388513805", "createdAt": "2020-03-05T19:28:54Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -89,33 +91,77 @@\n \n \n public class ZKHelixAdmin implements HelixAdmin {\n+  private static final Logger LOG = LoggerFactory.getLogger(ZKHelixAdmin.class);\n+\n+\n   public static final String CONNECTION_TIMEOUT = \"helixAdmin.timeOutInSec\";\n   private static final String MAINTENANCE_ZNODE_ID = \"maintenance\";\n   private static final int DEFAULT_SUPERCLUSTER_REPLICA = 3;\n \n-  private final HelixZkClient _zkClient;\n+  private final RealmAwareZkClient _zkClient;\n   private final ConfigAccessor _configAccessor;\n-  // true if ZKHelixAdmin was instantiated with a HelixZkClient, false otherwise\n+  // true if ZKHelixAdmin was instantiated with a RealmAwareZkClient, false otherwise\n   // This is used for close() to determine how ZKHelixAdmin should close the underlying ZkClient\n   private final boolean _usesExternalZkClient;\n \n   private static Logger logger = LoggerFactory.getLogger(ZKHelixAdmin.class);\n \n+  /**\n+   * @deprecated it is recommended to use the other constructors instead to avoid having to manually\n+   * create and maintain a RealmAwareZkClient outside of ZkBaseDataAccessor.\n+   *\n+   * @param zkClient A created RealmAwareZkClient\n+   */\n   @Deprecated\n-  public ZKHelixAdmin(HelixZkClient zkClient) {\n+  public ZKHelixAdmin(RealmAwareZkClient zkClient) {\n     _zkClient = zkClient;\n     _configAccessor = new ConfigAccessor(zkClient);\n     _usesExternalZkClient = true;\n   }\n \n   public ZKHelixAdmin(String zkAddress) {\n     int timeOutInSec = Integer.parseInt(System.getProperty(CONNECTION_TIMEOUT, \"30\"));\n-    HelixZkClient.ZkClientConfig clientConfig = new HelixZkClient.ZkClientConfig();\n-    clientConfig.setZkSerializer(new ZNRecordSerializer())\n-        .setConnectInitTimeout(timeOutInSec * 1000);\n-    _zkClient = SharedZkClientFactory.getInstance()\n-        .buildZkClient(new HelixZkClient.ZkConnectionConfig(zkAddress), clientConfig);\n-    _zkClient.waitUntilConnected(timeOutInSec, TimeUnit.SECONDS);\n+    RealmAwareZkClient.RealmAwareZkClientConfig clientConfig =\n+        new RealmAwareZkClient.RealmAwareZkClientConfig()\n+            .setConnectInitTimeout(timeOutInSec * 1000L)\n+            .setZkSerializer(new ZNRecordSerializer());\n+\n+    RealmAwareZkClient zkClient;\n+    try {\n+      zkClient = new FederatedZkClient(\n+          new RealmAwareZkClient.RealmAwareZkConnectionConfig.Builder().build(), clientConfig);\n+    } catch (IllegalStateException | IOException | InvalidRoutingDataException e) {\n+      LOG.info(\"Not able to connect on multi-realm mode. \"\n+          + \"Connecting on single-realm mode to ZK: {}\", zkAddress);\n+\n+      zkClient = SharedZkClientFactory.getInstance()\n+          .buildZkClient(new HelixZkClient.ZkConnectionConfig(zkAddress),\n+              clientConfig.createHelixZkClientConfig());\n+      zkClient.waitUntilConnected(timeOutInSec, TimeUnit.SECONDS);\n+    }\n+\n+    _zkClient = zkClient;\n+    _configAccessor = new ConfigAccessor(_zkClient);\n+    _usesExternalZkClient = false;\n+  }\n+\n+  private ZKHelixAdmin(Builder builder) throws IOException, InvalidRoutingDataException {\n+    switch (builder.realmMode) {\n+      case MULTI_REALM:\n+        _zkClient = new FederatedZkClient(builder.realmAwareZkConnectionConfig,\n+            builder.realmAwareZkClientConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca0e0cba1b7bbc223053d333c3e3033b50d3a703"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODUyODE2", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-369852816", "createdAt": "2020-03-05T19:30:58Z", "commit": {"oid": "ca0e0cba1b7bbc223053d333c3e3033b50d3a703"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTozMDo1OFrOFyhEQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTozMDo1OFrOFyhEQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUxNDg4MA==", "bodyText": "This could actually be simplified to\n      // Resolve RealmAwareZkClientConfig\n      if (_realmAwareZkClientConfig == null) {\n        _realmAwareZkClientConfig = new RealmAwareZkClient.RealmAwareZkClientConfig();\n      }", "url": "https://github.com/apache/helix/pull/846#discussion_r388514880", "createdAt": "2020-03-05T19:30:58Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -1799,4 +1845,71 @@ private boolean validateWeightForResourceConfig(ClusterConfig clusterConfig,\n             clusterConfig));\n     return true;\n   }\n+\n+  public static class Builder {\n+    private String zkAddress;\n+    private RealmAwareZkClient.RealmMode realmMode;\n+    private RealmAwareZkClient.RealmAwareZkConnectionConfig realmAwareZkConnectionConfig;\n+    private RealmAwareZkClient.RealmAwareZkClientConfig realmAwareZkClientConfig;\n+\n+    public Builder() {\n+    }\n+\n+    public ZKHelixAdmin.Builder setZkAddress(String zkAddress) {\n+      this.zkAddress = zkAddress;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmMode(RealmAwareZkClient.RealmMode realmMode) {\n+      this.realmMode = realmMode;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmAwareZkConnectionConfig(\n+        RealmAwareZkClient.RealmAwareZkConnectionConfig realmAwareZkConnectionConfig) {\n+      realmAwareZkConnectionConfig = realmAwareZkConnectionConfig;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmAwareZkClientConfig(\n+        RealmAwareZkClient.RealmAwareZkClientConfig realmAwareZkClientConfig) {\n+      realmAwareZkClientConfig = realmAwareZkClientConfig;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin build() throws Exception {\n+      validate();\n+      return new ZKHelixAdmin(this);\n+    }\n+\n+    /**\n+     * Validate the given parameters before creating an instance of ConfigAccessor.\n+     */\n+    private void validate() {\n+      // Resolve RealmMode based on other parameters\n+      boolean isZkAddressSet = zkAddress != null && !zkAddress.isEmpty();\n+      if (realmMode == RealmAwareZkClient.RealmMode.SINGLE_REALM && !isZkAddressSet) {\n+        throw new HelixException(\n+            \"ConfigAccessor: RealmMode cannot be single-realm without a valid ZkAddress set!\");\n+      }\n+      if (realmMode == null) {\n+        realmMode = isZkAddressSet ? RealmAwareZkClient.RealmMode.SINGLE_REALM\n+            : RealmAwareZkClient.RealmMode.MULTI_REALM;\n+      }\n+\n+      // Resolve RealmAwareZkClientConfig\n+      boolean isZkClientConfigSet = realmAwareZkClientConfig != null;\n+      // Resolve which clientConfig to use\n+      realmAwareZkClientConfig =\n+          isZkClientConfigSet ? realmAwareZkClientConfig.createHelixZkClientConfig()\n+              : new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca0e0cba1b7bbc223053d333c3e3033b50d3a703"}, "originalPosition": 396}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ddd2e340f0c6a3dfa4f5b04b65846d20d82fca9e", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/ddd2e340f0c6a3dfa4f5b04b65846d20d82fca9e", "committedDate": "2020-03-06T02:36:57Z", "message": "Catch exception for HelixAdmin."}, "afterCommit": {"oid": "f76e522b5252eb0aba5a5367ec5427cfd4e5039a", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/f76e522b5252eb0aba5a5367ec5427cfd4e5039a", "committedDate": "2020-03-06T02:41:59Z", "message": "Catch exception for HelixAdmin."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMTMyNTU1", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-370132555", "createdAt": "2020-03-06T07:46:58Z", "commit": {"oid": "f76e522b5252eb0aba5a5367ec5427cfd4e5039a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNzo0Njo1OFrOFyvq5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNzo0Njo1OFrOFyvq5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc1NDE1MQ==", "bodyText": "ConfigAccessor -> ZkHelixAdmin?", "url": "https://github.com/apache/helix/pull/846#discussion_r388754151", "createdAt": "2020-03-06T07:46:58Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -1799,4 +1856,69 @@ private boolean validateWeightForResourceConfig(ClusterConfig clusterConfig,\n             clusterConfig));\n     return true;\n   }\n+\n+  public static class Builder {\n+    private String zkAddress;\n+    private RealmAwareZkClient.RealmMode realmMode;\n+    private RealmAwareZkClient.RealmAwareZkConnectionConfig realmAwareZkConnectionConfig;\n+    private RealmAwareZkClient.RealmAwareZkClientConfig realmAwareZkClientConfig;\n+\n+    public Builder() {\n+    }\n+\n+    public ZKHelixAdmin.Builder setZkAddress(String zkAddress) {\n+      this.zkAddress = zkAddress;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmMode(RealmAwareZkClient.RealmMode realmMode) {\n+      this.realmMode = realmMode;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmAwareZkConnectionConfig(\n+        RealmAwareZkClient.RealmAwareZkConnectionConfig realmAwareZkConnectionConfig) {\n+      realmAwareZkConnectionConfig = realmAwareZkConnectionConfig;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmAwareZkClientConfig(\n+        RealmAwareZkClient.RealmAwareZkClientConfig realmAwareZkClientConfig) {\n+      realmAwareZkClientConfig = realmAwareZkClientConfig;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin build() throws Exception {\n+      validate();\n+      return new ZKHelixAdmin(this);\n+    }\n+\n+    /**\n+     * Validate the given parameters before creating an instance of ConfigAccessor.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f76e522b5252eb0aba5a5367ec5427cfd4e5039a"}, "originalPosition": 388}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMTMzMjcx", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-370133271", "createdAt": "2020-03-06T07:48:42Z", "commit": {"oid": "f76e522b5252eb0aba5a5367ec5427cfd4e5039a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNzo0ODo0MlrOFyvtCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNzo0ODo0MlrOFyvtCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc1NDY5OQ==", "bodyText": "Nit: remove extra line", "url": "https://github.com/apache/helix/pull/846#discussion_r388754699", "createdAt": "2020-03-06T07:48:42Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -1285,4 +1266,62 @@ public void handleSessionEstablishmentError(Throwable error) throws Exception {\n   public Long getSessionStartTime() {\n     return _sessionStartTime;\n   }\n+\n+  private RealmAwareZkClient buildRealmAwareZkClient() {\n+    final String shardingKey = buildShardingKey();\n+    PathBasedZkSerializer zkSerializer =\n+        ChainedPathZkSerializer.builder(new ZNRecordSerializer()).build();\n+\n+    RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig =\n+        new RealmAwareZkClient.RealmAwareZkConnectionConfig.Builder()\n+            .setRealmMode(RealmAwareZkClient.RealmMode.SINGLE_REALM)\n+            .setZkRealmShardingKey(shardingKey)\n+            .setSessionTimeout(_sessionTimeout).build();\n+\n+    RealmAwareZkClient.RealmAwareZkClientConfig clientConfig =\n+        new RealmAwareZkClient.RealmAwareZkClientConfig();\n+\n+    clientConfig.setZkSerializer(zkSerializer)\n+        .setConnectInitTimeout(_connectionInitTimeout)\n+        .setMonitorType(_instanceType.name())\n+        .setMonitorKey(_clusterName)\n+        .setMonitorInstanceName(_instanceName)\n+        .setMonitorRootPathOnly(isMonitorRootPathOnly());\n+\n+    RealmAwareZkClient newClient;\n+    if (_instanceType == InstanceType.ADMINISTRATOR) {\n+      newClient = buildHelixZkClient(SharedZkClientFactory.getInstance(), connectionConfig,\n+          clientConfig);\n+    } else {\n+      newClient = buildHelixZkClient(DedicatedZkClientFactory.getInstance(), connectionConfig,\n+          clientConfig);\n+    }\n+\n+    return newClient;\n+  }\n+\n+  private RealmAwareZkClient buildHelixZkClient(HelixZkClientFactory zkClientFactory,\n+      RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig,\n+      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig) {\n+    try {\n+      return zkClientFactory.buildZkClient(connectionConfig, clientConfig);\n+    } catch (IllegalArgumentException | IOException | InvalidRoutingDataException e) {\n+      LOG.info(\"Not able to connect on realm-aware mode for sharding key: {}, caused by: {} .\"\n+              + \"Trying to connect to ZK: {}.\", connectionConfig.getZkRealmShardingKey(),\n+          e.getMessage(), _zkAddress);\n+    }\n+\n+    // Fall back to HelixZkClient\n+    HelixZkClient.ZkClientConfig helixZkClientConfig = clientConfig.createHelixZkClientConfig();\n+    HelixZkClient.ZkConnectionConfig helixZkConnectionConfig =\n+        new HelixZkClient.ZkConnectionConfig(_zkAddress)\n+            .setSessionTimeout(connectionConfig.getSessionTimeout());\n+\n+    return zkClientFactory.buildZkClient(helixZkConnectionConfig, helixZkClientConfig);\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f76e522b5252eb0aba5a5367ec5427cfd4e5039a"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMTM2NzE4", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-370136718", "createdAt": "2020-03-06T07:56:48Z", "commit": {"oid": "f76e522b5252eb0aba5a5367ec5427cfd4e5039a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzAwOTI4", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-370700928", "createdAt": "2020-03-07T00:33:50Z", "commit": {"oid": "c989ccc20408c6a7bd47613bc266568d37a4a145"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDozMzo1MFrOFzLNtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDozMzo1MFrOFzLNtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNTQzMQ==", "bodyText": "@pkuwm\nPlease throw a HelixException here and propagate the exception.\nAlso note that per our offline discussion, there will no longer be a fallback to single realm mode. If multi-realm fails, we fail the creation.", "url": "https://github.com/apache/helix/pull/846#discussion_r389205431", "createdAt": "2020-03-07T00:33:50Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -89,33 +91,88 @@\n \n \n public class ZKHelixAdmin implements HelixAdmin {\n+  private static final Logger LOG = LoggerFactory.getLogger(ZKHelixAdmin.class);\n+\n+\n   public static final String CONNECTION_TIMEOUT = \"helixAdmin.timeOutInSec\";\n   private static final String MAINTENANCE_ZNODE_ID = \"maintenance\";\n   private static final int DEFAULT_SUPERCLUSTER_REPLICA = 3;\n \n-  private final HelixZkClient _zkClient;\n+  private final RealmAwareZkClient _zkClient;\n   private final ConfigAccessor _configAccessor;\n-  // true if ZKHelixAdmin was instantiated with a HelixZkClient, false otherwise\n+  // true if ZKHelixAdmin was instantiated with a RealmAwareZkClient, false otherwise\n   // This is used for close() to determine how ZKHelixAdmin should close the underlying ZkClient\n   private final boolean _usesExternalZkClient;\n \n   private static Logger logger = LoggerFactory.getLogger(ZKHelixAdmin.class);\n \n+  /**\n+   * @deprecated it is recommended to use the other constructors instead to avoid having to manually\n+   * create and maintain a RealmAwareZkClient outside of ZkBaseDataAccessor.\n+   *\n+   * @param zkClient A created RealmAwareZkClient\n+   */\n   @Deprecated\n-  public ZKHelixAdmin(HelixZkClient zkClient) {\n+  public ZKHelixAdmin(RealmAwareZkClient zkClient) {\n     _zkClient = zkClient;\n     _configAccessor = new ConfigAccessor(zkClient);\n     _usesExternalZkClient = true;\n   }\n \n   public ZKHelixAdmin(String zkAddress) {\n     int timeOutInSec = Integer.parseInt(System.getProperty(CONNECTION_TIMEOUT, \"30\"));\n-    HelixZkClient.ZkClientConfig clientConfig = new HelixZkClient.ZkClientConfig();\n-    clientConfig.setZkSerializer(new ZNRecordSerializer())\n-        .setConnectInitTimeout(timeOutInSec * 1000);\n-    _zkClient = SharedZkClientFactory.getInstance()\n-        .buildZkClient(new HelixZkClient.ZkConnectionConfig(zkAddress), clientConfig);\n-    _zkClient.waitUntilConnected(timeOutInSec, TimeUnit.SECONDS);\n+    RealmAwareZkClient.RealmAwareZkClientConfig clientConfig =\n+        new RealmAwareZkClient.RealmAwareZkClientConfig()\n+            .setConnectInitTimeout(timeOutInSec * 1000L)\n+            .setZkSerializer(new ZNRecordSerializer());\n+\n+    RealmAwareZkClient zkClient;\n+    try {\n+      zkClient = new FederatedZkClient(\n+          new RealmAwareZkClient.RealmAwareZkConnectionConfig.Builder().build(), clientConfig);\n+    } catch (IllegalStateException | IOException | InvalidRoutingDataException e) {\n+      LOG.info(\"Not able to connect on multi-realm mode. \"\n+          + \"Connecting on single-realm mode to ZK: {}\", zkAddress);\n+\n+      zkClient = SharedZkClientFactory.getInstance()\n+          .buildZkClient(new HelixZkClient.ZkConnectionConfig(zkAddress),\n+              clientConfig.createHelixZkClientConfig());\n+      zkClient.waitUntilConnected(timeOutInSec, TimeUnit.SECONDS);\n+    }\n+\n+    _zkClient = zkClient;\n+    _configAccessor = new ConfigAccessor(_zkClient);\n+    _usesExternalZkClient = false;\n+  }\n+\n+  private ZKHelixAdmin(Builder builder) {\n+    RealmAwareZkClient zkClient;\n+    switch (builder.realmMode) {\n+      case MULTI_REALM:\n+        try {\n+          zkClient = new FederatedZkClient(builder.realmAwareZkConnectionConfig,\n+              builder.realmAwareZkClientConfig);\n+          break;\n+        } catch (IOException | InvalidRoutingDataException | IllegalStateException e) {\n+          if (builder.zkAddress == null || builder.zkAddress.isEmpty()) {\n+            throw new IllegalStateException(\"Not able to connect on multi-realm mode.\", e);\n+          }\n+          LOG.info(\"Not able to connect on multi-realm mode. \"\n+              + \"Connecting on single-realm mode to ZK: {}\", builder.zkAddress);\n+          builder.setRealmMode(RealmAwareZkClient.RealmMode.SINGLE_REALM);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c989ccc20408c6a7bd47613bc266568d37a4a145"}, "originalPosition": 104}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzk1NDcx", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-370795471", "createdAt": "2020-03-07T23:55:29Z", "commit": {"oid": "58e0214a73af8924c45857f49ac4231fb399ce2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QyMzo1NToyOVrOFzSS3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QyMzo1NToyOVrOFzSS3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyMTQzNw==", "bodyText": "This is not configAccessor... lets fix the log? :)", "url": "https://github.com/apache/helix/pull/846#discussion_r389321437", "createdAt": "2020-03-07T23:55:29Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -1799,4 +1851,69 @@ private boolean validateWeightForResourceConfig(ClusterConfig clusterConfig,\n             clusterConfig));\n     return true;\n   }\n+\n+  public static class Builder {\n+    private String zkAddress;\n+    private RealmAwareZkClient.RealmMode realmMode;\n+    private RealmAwareZkClient.RealmAwareZkConnectionConfig realmAwareZkConnectionConfig;\n+    private RealmAwareZkClient.RealmAwareZkClientConfig realmAwareZkClientConfig;\n+\n+    public Builder() {\n+    }\n+\n+    public ZKHelixAdmin.Builder setZkAddress(String zkAddress) {\n+      this.zkAddress = zkAddress;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmMode(RealmAwareZkClient.RealmMode realmMode) {\n+      this.realmMode = realmMode;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmAwareZkConnectionConfig(\n+        RealmAwareZkClient.RealmAwareZkConnectionConfig realmAwareZkConnectionConfig) {\n+      realmAwareZkConnectionConfig = realmAwareZkConnectionConfig;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmAwareZkClientConfig(\n+        RealmAwareZkClient.RealmAwareZkClientConfig realmAwareZkClientConfig) {\n+      realmAwareZkClientConfig = realmAwareZkClientConfig;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin build() throws Exception {\n+      validate();\n+      return new ZKHelixAdmin(this);\n+    }\n+\n+    /*\n+     * Validates the given parameters before creating an instance of ZKHelixAdmin.\n+     */\n+    private void validate() {\n+      // Resolve RealmMode based on other parameters\n+      boolean isZkAddressSet = zkAddress != null && !zkAddress.isEmpty();\n+      if (realmMode == RealmAwareZkClient.RealmMode.SINGLE_REALM && !isZkAddressSet) {\n+        throw new HelixException(\n+            \"ConfigAccessor: RealmMode cannot be single-realm without a valid ZkAddress set!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58e0214a73af8924c45857f49ac4231fb399ce2a"}, "originalPosition": 390}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzk1NTI0", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-370795524", "createdAt": "2020-03-07T23:57:00Z", "commit": {"oid": "58e0214a73af8924c45857f49ac4231fb399ce2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QyMzo1NzowMFrOFzSTYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QyMzo1NzowMFrOFzSTYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyMTU2OQ==", "bodyText": "Also we need to throw exception when zkaddr is set on multi-realm mode.", "url": "https://github.com/apache/helix/pull/846#discussion_r389321569", "createdAt": "2020-03-07T23:57:00Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -1799,4 +1851,69 @@ private boolean validateWeightForResourceConfig(ClusterConfig clusterConfig,\n             clusterConfig));\n     return true;\n   }\n+\n+  public static class Builder {\n+    private String zkAddress;\n+    private RealmAwareZkClient.RealmMode realmMode;\n+    private RealmAwareZkClient.RealmAwareZkConnectionConfig realmAwareZkConnectionConfig;\n+    private RealmAwareZkClient.RealmAwareZkClientConfig realmAwareZkClientConfig;\n+\n+    public Builder() {\n+    }\n+\n+    public ZKHelixAdmin.Builder setZkAddress(String zkAddress) {\n+      this.zkAddress = zkAddress;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmMode(RealmAwareZkClient.RealmMode realmMode) {\n+      this.realmMode = realmMode;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmAwareZkConnectionConfig(\n+        RealmAwareZkClient.RealmAwareZkConnectionConfig realmAwareZkConnectionConfig) {\n+      realmAwareZkConnectionConfig = realmAwareZkConnectionConfig;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin.Builder setRealmAwareZkClientConfig(\n+        RealmAwareZkClient.RealmAwareZkClientConfig realmAwareZkClientConfig) {\n+      realmAwareZkClientConfig = realmAwareZkClientConfig;\n+      return this;\n+    }\n+\n+    public ZKHelixAdmin build() throws Exception {\n+      validate();\n+      return new ZKHelixAdmin(this);\n+    }\n+\n+    /*\n+     * Validates the given parameters before creating an instance of ZKHelixAdmin.\n+     */\n+    private void validate() {\n+      // Resolve RealmMode based on other parameters\n+      boolean isZkAddressSet = zkAddress != null && !zkAddress.isEmpty();\n+      if (realmMode == RealmAwareZkClient.RealmMode.SINGLE_REALM && !isZkAddressSet) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58e0214a73af8924c45857f49ac4231fb399ce2a"}, "originalPosition": 388}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "699839599b6ad3d20f187a9e3be7fa736cc6e927", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/699839599b6ad3d20f187a9e3be7fa736cc6e927", "committedDate": "2020-03-07T23:57:07Z", "message": "Remove ConfigAccessor"}, "afterCommit": {"oid": "cbb0fa29a60b9bd8fafd665c677434d1ad6716c5", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/cbb0fa29a60b9bd8fafd665c677434d1ad6716c5", "committedDate": "2020-03-07T23:59:14Z", "message": "Check zkAddress"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzk5Mzg4", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-370799388", "createdAt": "2020-03-08T01:59:07Z", "commit": {"oid": "cbb0fa29a60b9bd8fafd665c677434d1ad6716c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNTMyNjMx", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-372532631", "createdAt": "2020-03-11T07:50:00Z", "commit": {"oid": "8aa70c05552bd344c705c47a2d0adc87a7109f49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwNzo1MDowMFrOF0sFVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwNzo1MDowMFrOF0sFVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc5MjUzMw==", "bodyText": "These method names are very confusing. You're creating HelixZkClient in buildRealmAwareZkClient() and creating RealmAwareZkClient in buildHelixZkClient()? Could we try to improve the naming for these methods so that it's easier to read? I think this could be refactored for readability. Thoughts?", "url": "https://github.com/apache/helix/pull/846#discussion_r390792533", "createdAt": "2020-03-11T07:50:00Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -1285,4 +1266,63 @@ public void handleSessionEstablishmentError(Throwable error) throws Exception {\n   public Long getSessionStartTime() {\n     return _sessionStartTime;\n   }\n+\n+  private RealmAwareZkClient buildRealmAwareZkClient() {\n+    final String shardingKey = buildShardingKey();\n+    PathBasedZkSerializer zkSerializer =\n+        ChainedPathZkSerializer.builder(new ZNRecordSerializer()).build();\n+\n+    RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig =\n+        new RealmAwareZkClient.RealmAwareZkConnectionConfig.Builder()\n+            .setRealmMode(RealmAwareZkClient.RealmMode.SINGLE_REALM)\n+            .setZkRealmShardingKey(shardingKey)\n+            .setSessionTimeout(_sessionTimeout).build();\n+\n+    RealmAwareZkClient.RealmAwareZkClientConfig clientConfig =\n+        new RealmAwareZkClient.RealmAwareZkClientConfig();\n+\n+    clientConfig.setZkSerializer(zkSerializer)\n+        .setConnectInitTimeout(_connectionInitTimeout)\n+        .setMonitorType(_instanceType.name())\n+        .setMonitorKey(_clusterName)\n+        .setMonitorInstanceName(_instanceName)\n+        .setMonitorRootPathOnly(isMonitorRootPathOnly());\n+\n+    RealmAwareZkClient newClient;\n+    if (_instanceType == InstanceType.ADMINISTRATOR) {\n+      newClient = buildHelixZkClient(SharedZkClientFactory.getInstance(), connectionConfig,\n+          clientConfig);\n+    } else {\n+      newClient = buildHelixZkClient(DedicatedZkClientFactory.getInstance(), connectionConfig,\n+          clientConfig);\n+    }\n+\n+    return newClient;\n+  }\n+\n+  private RealmAwareZkClient buildHelixZkClient(HelixZkClientFactory zkClientFactory,\n+      RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig,\n+      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig) {\n+    if (Boolean.getBoolean(SystemPropertyKeys.MULTI_ZK_ENABLED)) {\n+      try {\n+        // Create realm-aware ZkClient.\n+        return zkClientFactory.buildZkClient(connectionConfig, clientConfig);\n+      } catch (IllegalArgumentException | IOException | InvalidRoutingDataException e) {\n+        throw new HelixException(\"Not able to connect on realm-aware mode for sharding key: \"\n+            + connectionConfig.getZkRealmShardingKey(), e);\n+      }\n+    }\n+\n+    // If multi-zk mode is not enabled, create HelixZkClient with the provided zk address.\n+    HelixZkClient.ZkClientConfig helixZkClientConfig = clientConfig.createHelixZkClientConfig();\n+    HelixZkClient.ZkConnectionConfig helixZkConnectionConfig =\n+        new HelixZkClient.ZkConnectionConfig(_zkAddress)\n+            .setSessionTimeout(connectionConfig.getSessionTimeout());\n+\n+    return zkClientFactory.buildZkClient(helixZkConnectionConfig, helixZkClientConfig);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa70c05552bd344c705c47a2d0adc87a7109f49"}, "originalPosition": 125}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNTMyOTY5", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-372532969", "createdAt": "2020-03-11T07:50:44Z", "commit": {"oid": "8aa70c05552bd344c705c47a2d0adc87a7109f49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwNzo1MDo0NFrOF0sGcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwNzo1MDo0NFrOF0sGcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc5MjgxOA==", "bodyText": "Shouldn't this be deprecated?", "url": "https://github.com/apache/helix/pull/846#discussion_r390792818", "createdAt": "2020-03-11T07:50:44Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZkBaseDataAccessor.java", "diffHunk": "@@ -102,14 +103,13 @@ public AccessResult() {\n \n   private static Logger LOG = LoggerFactory.getLogger(ZkBaseDataAccessor.class);\n \n-  private final HelixZkClient _zkClient;\n+  private final RealmAwareZkClient _zkClient;\n   // true if ZkBaseDataAccessor was instantiated with a HelixZkClient, false otherwise\n   // This is used for close() to determine how ZkBaseDataAccessor should close the underlying\n   // ZkClient\n   private final boolean _usesExternalZkClient;\n \n-  @Deprecated\n-  public ZkBaseDataAccessor(HelixZkClient zkClient) {\n+  public ZkBaseDataAccessor(RealmAwareZkClient zkClient) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa70c05552bd344c705c47a2d0adc87a7109f49"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTc5MTc1", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-373179175", "createdAt": "2020-03-11T22:51:24Z", "commit": {"oid": "294015f5607962e2659cdc1d92f04533f933cc51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMjo1MToyNFrOF1L82A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMjo1MToyNFrOF1L82A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNDY0OA==", "bodyText": "Add TODO here. We need to refactor all the builders before merging to the master.", "url": "https://github.com/apache/helix/pull/846#discussion_r391314648", "createdAt": "2020-03-11T22:51:24Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -1799,4 +1867,73 @@ private boolean validateWeightForResourceConfig(ClusterConfig clusterConfig,\n             clusterConfig));\n     return true;\n   }\n+\n+  public static class Builder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "294015f5607962e2659cdc1d92f04533f933cc51"}, "originalPosition": 364}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9b78230b38f525a0baab121bb817ec0f810e448", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/c9b78230b38f525a0baab121bb817ec0f810e448", "committedDate": "2020-03-12T04:03:38Z", "message": "Make ZKHelixAdmin and ZKHelixManager Realm-aware"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47ffd730677d4a23b8a5e3f41abddaffeb150a74", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/47ffd730677d4a23b8a5e3f41abddaffeb150a74", "committedDate": "2020-03-12T04:03:38Z", "message": "Catch exception for HelixAdmin."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4694e5fdd53a4f38534fd94417c5cc2da721bab2", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/4694e5fdd53a4f38534fd94417c5cc2da721bab2", "committedDate": "2020-03-12T04:03:38Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81215a063bbcf701935a6dd979ed49fa3d8bcc0a", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/81215a063bbcf701935a6dd979ed49fa3d8bcc0a", "committedDate": "2020-03-12T04:03:38Z", "message": "Throw HelixException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4acef6ff897dc64662ef5132bfeca911a7d1a6db", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/4acef6ff897dc64662ef5132bfeca911a7d1a6db", "committedDate": "2020-03-12T04:03:38Z", "message": "Check zkAddress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fa156c1bd462747ae90288fe4f2ce3f8543114a", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/4fa156c1bd462747ae90288fe4f2ce3f8543114a", "committedDate": "2020-03-12T04:03:38Z", "message": "Remove fallback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7308a6d011e51aac461a6179f37eee96e0ae14a1", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/7308a6d011e51aac461a6179f37eee96e0ae14a1", "committedDate": "2020-03-12T04:22:26Z", "message": "Uname methods"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "294015f5607962e2659cdc1d92f04533f933cc51", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/294015f5607962e2659cdc1d92f04533f933cc51", "committedDate": "2020-03-11T15:01:48Z", "message": "Deprecate ZkBaseDataAccessor constructor that accpets RealmAwareZkClient"}, "afterCommit": {"oid": "7308a6d011e51aac461a6179f37eee96e0ae14a1", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/7308a6d011e51aac461a6179f37eee96e0ae14a1", "committedDate": "2020-03-12T04:22:26Z", "message": "Uname methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d55153ff1318afc1aeedf7b237cd5f406bb0c3b3", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/d55153ff1318afc1aeedf7b237cd5f406bb0c3b3", "committedDate": "2020-03-12T04:25:00Z", "message": "Add TODO"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjc2MzAy", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-373276302", "createdAt": "2020-03-12T04:47:46Z", "commit": {"oid": "d55153ff1318afc1aeedf7b237cd5f406bb0c3b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo0Nzo0NlrOF1RH7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo0Nzo0NlrOF1RH7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5OTQwNA==", "bodyText": "Nit: one empty line would suffice?", "url": "https://github.com/apache/helix/pull/846#discussion_r391399404", "createdAt": "2020-03-12T04:47:46Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -90,33 +92,98 @@\n \n \n public class ZKHelixAdmin implements HelixAdmin {\n+  private static final Logger LOG = LoggerFactory.getLogger(ZKHelixAdmin.class);\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d55153ff1318afc1aeedf7b237cd5f406bb0c3b3"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjc3NzU5", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-373277759", "createdAt": "2020-03-12T04:53:38Z", "commit": {"oid": "d55153ff1318afc1aeedf7b237cd5f406bb0c3b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo1MzozOFrOF1RNGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo1MzozOFrOF1RNGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMDczMA==", "bodyText": "Nit: I know we don't have to change this, but initializing to null is redundant.", "url": "https://github.com/apache/helix/pull/846#discussion_r391400730", "createdAt": "2020-03-12T04:53:38Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -117,7 +121,7 @@\n   private final String _version;\n   private int _reportLatency;\n \n-  protected HelixZkClient _zkclient = null;\n+  protected RealmAwareZkClient _zkclient = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d55153ff1318afc1aeedf7b237cd5f406bb0c3b3"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjc5MzM1", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-373279335", "createdAt": "2020-03-12T05:00:04Z", "commit": {"oid": "d55153ff1318afc1aeedf7b237cd5f406bb0c3b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTowMDowNVrOF1RSRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTowMDowNVrOF1RSRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMjA1NA==", "bodyText": "My suggestion is\n\nJavaDoc:\n\nResolves what type of ZkClient this HelixManager should use based on whether MULTI_ZK_ENABLED System config is set or not. Two types of ZkClients are available: 1) If MULTI_ZK_ENABLED is set to true, we create a dedicated RealmAwareZkClient that provides full ZkClient functionalities and connects to the correct ZK by querying MetadataStoreDirectoryService. 2) Otherwise, we create a dedicated HelixZkClient which plainly connects to the ZK address given.\n\nRename the method to resolveZkClient()\n\nI think this will make our intention more clear.", "url": "https://github.com/apache/helix/pull/846#discussion_r391402054", "createdAt": "2020-03-12T05:00:05Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -1285,4 +1266,60 @@ public void handleSessionEstablishmentError(Throwable error) throws Exception {\n   public Long getSessionStartTime() {\n     return _sessionStartTime;\n   }\n+\n+  private RealmAwareZkClient createSingleRealmZkClient() {\n+    final String shardingKey = buildShardingKey();\n+    PathBasedZkSerializer zkSerializer =\n+        ChainedPathZkSerializer.builder(new ZNRecordSerializer()).build();\n+\n+    RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig =\n+        new RealmAwareZkClient.RealmAwareZkConnectionConfig.Builder()\n+            .setRealmMode(RealmAwareZkClient.RealmMode.SINGLE_REALM)\n+            .setZkRealmShardingKey(shardingKey)\n+            .setSessionTimeout(_sessionTimeout).build();\n+\n+    RealmAwareZkClient.RealmAwareZkClientConfig clientConfig =\n+        new RealmAwareZkClient.RealmAwareZkClientConfig();\n+\n+    clientConfig.setZkSerializer(zkSerializer)\n+        .setConnectInitTimeout(_connectionInitTimeout)\n+        .setMonitorType(_instanceType.name())\n+        .setMonitorKey(_clusterName)\n+        .setMonitorInstanceName(_instanceName)\n+        .setMonitorRootPathOnly(isMonitorRootPathOnly());\n+\n+    if (_instanceType == InstanceType.ADMINISTRATOR) {\n+      return buildSelectiveZkClient(SharedZkClientFactory.getInstance(), connectionConfig,\n+          clientConfig);\n+    }\n+\n+    return buildSelectiveZkClient(DedicatedZkClientFactory.getInstance(), connectionConfig,\n+        clientConfig);\n+  }\n+\n+  private RealmAwareZkClient buildSelectiveZkClient(HelixZkClientFactory zkClientFactory,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d55153ff1318afc1aeedf7b237cd5f406bb0c3b3"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjgwMzc2", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-373280376", "createdAt": "2020-03-12T05:04:05Z", "commit": {"oid": "d55153ff1318afc1aeedf7b237cd5f406bb0c3b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTowNDowNlrOF1RVjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTowNDowNlrOF1RVjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMjg5NQ==", "bodyText": "Rename the method to prepareAndGetZkClient()\n\n\nJavadoc:\n\n\nPrepares connection config and client config based on the internal parameters given to HelixManager in order to create a ZkClient instance to use. Note that a shared ZkClient instance will be created if connecting as an ADMINISTRATOR to minimize the cost of creating ZkConnections.", "url": "https://github.com/apache/helix/pull/846#discussion_r391402895", "createdAt": "2020-03-12T05:04:06Z", "author": {"login": "narendly"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -1285,4 +1266,60 @@ public void handleSessionEstablishmentError(Throwable error) throws Exception {\n   public Long getSessionStartTime() {\n     return _sessionStartTime;\n   }\n+\n+  private RealmAwareZkClient createSingleRealmZkClient() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d55153ff1318afc1aeedf7b237cd5f406bb0c3b3"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e10ff6e5e13f1c0ccd2c33416ce5833c1b46651d", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/e10ff6e5e13f1c0ccd2c33416ce5833c1b46651d", "committedDate": "2020-03-12T05:06:15Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9aaec45d2366d18dc43a11598b1a044fd02bb16", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/d9aaec45d2366d18dc43a11598b1a044fd02bb16", "committedDate": "2020-03-12T05:02:36Z", "message": "Address comments"}, "afterCommit": {"oid": "e10ff6e5e13f1c0ccd2c33416ce5833c1b46651d", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/e10ff6e5e13f1c0ccd2c33416ce5833c1b46651d", "committedDate": "2020-03-12T05:06:15Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc7efd9d89656f5049f697c0a29edf1a6711ebbb", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/dc7efd9d89656f5049f697c0a29edf1a6711ebbb", "committedDate": "2020-03-12T05:18:53Z", "message": "Add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjg0ODgw", "url": "https://github.com/apache/helix/pull/846#pullrequestreview-373284880", "createdAt": "2020-03-12T05:21:44Z", "commit": {"oid": "dc7efd9d89656f5049f697c0a29edf1a6711ebbb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4640, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}