{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxOTg0NDA0", "number": 1077, "title": "Add close method to Helix lock", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nCurrently there is no close method to close the lock and the underlying zk client connection. It could result to zk client leak.\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nAdded a close() method to the interface and implementation of the lock, where the zk client will be closed. User will need to call this when they don't need to use the lock any more to avoid zk connection leakage.\nTests\n\n\n The following tests are written for this issue:\nTestZKHelixNonblockingLock.testCloseLockedLock\nTestZKHelixNonblockingLock.testCloseUnlockedLock\n\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 6, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  53.817 s\n[INFO] Finished at: 2020-06-09T16:09:54-07:00\n[INFO] ------------------------------------------------------------------------\nCommits\n\n My commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\n My diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-06-09T18:21:09Z", "url": "https://github.com/apache/helix/pull/1077", "merged": true, "mergeCommit": {"oid": "f54c684e97ed9a2234c1f980b5d81c2f387f3f1a"}, "closed": true, "closedAt": "2020-06-10T22:06:57Z", "author": {"login": "mgao0"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcppRsugH2gAyNDMxOTg0NDA0OmY2ZTRjOTU2NGZjYTVkOWE2MDM5OTk4MTg2Yzg3ZTRlYjY0Y2I3ZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcptndGAFqTQyNzYxMjAxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f6e4c9564fca5d9a6039998186c87e4eb64cb7eb", "author": {"user": {"login": "mgao0", "name": "Molly Gao"}}, "url": "https://github.com/apache/helix/commit/f6e4c9564fca5d9a6039998186c87e4eb64cb7eb", "committedDate": "2020-06-09T18:22:25Z", "message": "Add close method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a97db7350e974ade8718dba06270be1ab816d96", "author": {"user": {"login": "mgao0", "name": "Molly Gao"}}, "url": "https://github.com/apache/helix/commit/0a97db7350e974ade8718dba06270be1ab816d96", "committedDate": "2020-06-09T18:13:18Z", "message": "Add close method"}, "afterCommit": {"oid": "f6e4c9564fca5d9a6039998186c87e4eb64cb7eb", "author": {"user": {"login": "mgao0", "name": "Molly Gao"}}, "url": "https://github.com/apache/helix/commit/f6e4c9564fca5d9a6039998186c87e4eb64cb7eb", "committedDate": "2020-06-09T18:22:25Z", "message": "Add close method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDQ5NjU0", "url": "https://github.com/apache/helix/pull/1077#pullrequestreview-427449654", "createdAt": "2020-06-09T18:53:09Z", "commit": {"oid": "f6e4c9564fca5d9a6039998186c87e4eb64cb7eb"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODo1MzowOVrOGhX6BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODo1NTozMVrOGhX_UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY0Nzg3Nw==", "bodyText": "I suggest making this interface AutoClosable, then you implement close() naturally.", "url": "https://github.com/apache/helix/pull/1077#discussion_r437647877", "createdAt": "2020-06-09T18:53:09Z", "author": {"login": "jiajunwang"}, "path": "helix-lock/src/main/java/org/apache/helix/lock/DistributedLock.java", "diffHunk": "@@ -49,4 +49,9 @@\n    * false if the user is not the lock owner or the lock doesn't have a owner\n    */\n   boolean isCurrentOwner();\n+\n+  /**\n+   * Close the lock and release resources\n+   */\n+  void close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6e4c9564fca5d9a6039998186c87e4eb64cb7eb"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY0ODYzNQ==", "bodyText": "You don't call unlock() here?", "url": "https://github.com/apache/helix/pull/1077#discussion_r437648635", "createdAt": "2020-06-09T18:54:36Z", "author": {"login": "jiajunwang"}, "path": "helix-lock/src/main/java/org/apache/helix/lock/helix/ZKDistributedNonblockingLock.java", "diffHunk": "@@ -115,6 +113,11 @@ public boolean isCurrentOwner() {\n         .getTimeout());\n   }\n \n+  @Override\n+  public void close() {\n+    _baseDataAccessor.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6e4c9564fca5d9a6039998186c87e4eb64cb7eb"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY0OTIzMw==", "bodyText": "Add a test case about close() to validate:\n\nlock released properly. The releases information should be right (if we have any).\nthe connection has been ended.", "url": "https://github.com/apache/helix/pull/1077#discussion_r437649233", "createdAt": "2020-06-09T18:55:31Z", "author": {"login": "jiajunwang"}, "path": "helix-lock/src/test/java/org/apache/helix/lock/helix/TestZKHelixNonblockingLock.java", "diffHunk": "@@ -71,9 +73,14 @@ public void beforeMethod() {\n     Assert.assertFalse(_gZkClient.exists(_lockPath));\n   }\n \n+  @AfterSuite\n+  public void afterSuite() throws IOException {\n+    _lock.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6e4c9564fca5d9a6039998186c87e4eb64cb7eb"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDUyMjAy", "url": "https://github.com/apache/helix/pull/1077#pullrequestreview-427452202", "createdAt": "2020-06-09T18:56:30Z", "commit": {"oid": "f6e4c9564fca5d9a6039998186c87e4eb64cb7eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODo1NjozMFrOGhYBuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODo1NjozMFrOGhYBuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY0OTg1MQ==", "bodyText": "So we would expect lock users to explicitly call this one? This is a bit unintuitive, when put together with the other APIs that are intended for lock purpose only.", "url": "https://github.com/apache/helix/pull/1077#discussion_r437649851", "createdAt": "2020-06-09T18:56:30Z", "author": {"login": "zhangmeng916"}, "path": "helix-lock/src/main/java/org/apache/helix/lock/DistributedLock.java", "diffHunk": "@@ -49,4 +49,9 @@\n    * false if the user is not the lock owner or the lock doesn't have a owner\n    */\n   boolean isCurrentOwner();\n+\n+  /**\n+   * Close the lock and release resources\n+   */\n+  void close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6e4c9564fca5d9a6039998186c87e4eb64cb7eb"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NTUwOTQ5", "url": "https://github.com/apache/helix/pull/1077#pullrequestreview-427550949", "createdAt": "2020-06-09T21:15:24Z", "commit": {"oid": "f6e4c9564fca5d9a6039998186c87e4eb64cb7eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMToxNToyNFrOGhcvFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMToxNToyNFrOGhcvFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcyNjk5OQ==", "bodyText": "Can you fix the typo \"lcok\" in this file?", "url": "https://github.com/apache/helix/pull/1077#discussion_r437726999", "createdAt": "2020-06-09T21:15:24Z", "author": {"login": "zhangmeng916"}, "path": "helix-lock/src/main/java/org/apache/helix/lock/helix/ZKDistributedNonblockingLock.java", "diffHunk": "@@ -54,8 +53,8 @@\n    * @param lockMsg the reason for having this lock", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6e4c9564fca5d9a6039998186c87e4eb64cb7eb"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e21b4bc96786c508ff0c14b6e10f81f430546afa", "author": {"user": {"login": "mgao0", "name": "Molly Gao"}}, "url": "https://github.com/apache/helix/commit/e21b4bc96786c508ff0c14b6e10f81f430546afa", "committedDate": "2020-06-09T22:42:43Z", "message": "Update close method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7ddc05379c5ffa4d6f58f85c9739282bf3eb2bd", "author": {"user": {"login": "mgao0", "name": "Molly Gao"}}, "url": "https://github.com/apache/helix/commit/c7ddc05379c5ffa4d6f58f85c9739282bf3eb2bd", "committedDate": "2020-06-09T23:10:04Z", "message": "Add tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee4f778d943ba7efdc9382139f1bb9a822dd7add", "author": {"user": {"login": "mgao0", "name": "Molly Gao"}}, "url": "https://github.com/apache/helix/commit/ee4f778d943ba7efdc9382139f1bb9a822dd7add", "committedDate": "2020-06-09T23:00:21Z", "message": "Add tests"}, "afterCommit": {"oid": "c7ddc05379c5ffa4d6f58f85c9739282bf3eb2bd", "author": {"user": {"login": "mgao0", "name": "Molly Gao"}}, "url": "https://github.com/apache/helix/commit/c7ddc05379c5ffa4d6f58f85c9739282bf3eb2bd", "committedDate": "2020-06-09T23:10:04Z", "message": "Add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NjEyMDEz", "url": "https://github.com/apache/helix/pull/1077#pullrequestreview-427612013", "createdAt": "2020-06-09T23:25:48Z", "commit": {"oid": "c7ddc05379c5ffa4d6f58f85c9739282bf3eb2bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4472, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}