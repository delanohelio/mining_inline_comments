{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4ODcwODcx", "number": 1190, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNzo1OToyNlrOETkm4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQwNDo1MjozM1rOEUQeZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4OTU4MTc3OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNzo1OToyNlrOG5YO_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxODo1ODo0MVrOG5v4jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgxOTA3MA==", "bodyText": "Missing %s?", "url": "https://github.com/apache/helix/pull/1190#discussion_r462819070", "createdAt": "2020-07-30T07:59:26Z", "author": {"login": "huizhilu"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -192,7 +196,29 @@ private Response getStat(BaseDataAccessor<byte[]> zkBaseDataAccessor, String pat\n           .entity(String.format(\"The ZNode at path %s does not exist!\", path)).build());\n     }\n     Map<String, String> result = ZKUtil.fromStatToMap(stat);\n-    result.put(\"path\", path);\n+    result.put(PATH_STR, path);\n+    return JSONRepresentation(result);\n+  }\n+\n+  /**\n+   * Delete the ZNode at the given path if exists.\n+   * @param zkBaseDataAccessor\n+   * @param path\n+   * @return The delete result and the operated path.\n+   */\n+  private Response delete(BaseDataAccessor zkBaseDataAccessor, String path) {\n+    // TODO: Remove this restriction once we have audit and ACL for the API calls.\n+    // TODO: This method is added pre-maturely to support removing the live instance of a zombie\n+    // TODO: instance. It is risky to allow all deleting requests before audit and ACL are done.\n+    Stat stat = zkBaseDataAccessor.getStat(path, AccessOption.PERSISTENT);\n+    if (stat != null && stat.getEphemeralOwner() <= 0) {\n+      throw new WebApplicationException(Response.status(Response.Status.FORBIDDEN)\n+          .entity(String.format(\"Deleting a non ephemeral node is not allowed\", path)).build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIwNjU0MA==", "bodyText": "good catch!", "url": "https://github.com/apache/helix/pull/1190#discussion_r463206540", "createdAt": "2020-07-30T18:58:41Z", "author": {"login": "jiajunwang"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -192,7 +196,29 @@ private Response getStat(BaseDataAccessor<byte[]> zkBaseDataAccessor, String pat\n           .entity(String.format(\"The ZNode at path %s does not exist!\", path)).build());\n     }\n     Map<String, String> result = ZKUtil.fromStatToMap(stat);\n-    result.put(\"path\", path);\n+    result.put(PATH_STR, path);\n+    return JSONRepresentation(result);\n+  }\n+\n+  /**\n+   * Delete the ZNode at the given path if exists.\n+   * @param zkBaseDataAccessor\n+   * @param path\n+   * @return The delete result and the operated path.\n+   */\n+  private Response delete(BaseDataAccessor zkBaseDataAccessor, String path) {\n+    // TODO: Remove this restriction once we have audit and ACL for the API calls.\n+    // TODO: This method is added pre-maturely to support removing the live instance of a zombie\n+    // TODO: instance. It is risky to allow all deleting requests before audit and ACL are done.\n+    Stat stat = zkBaseDataAccessor.getStat(path, AccessOption.PERSISTENT);\n+    if (stat != null && stat.getEphemeralOwner() <= 0) {\n+      throw new WebApplicationException(Response.status(Response.Status.FORBIDDEN)\n+          .entity(String.format(\"Deleting a non ephemeral node is not allowed\", path)).build());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgxOTA3MA=="}, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4OTY0NDk2OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODoxNzo1NVrOG5Y2tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxOTozNjoxNVrOG5xD1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyOTIzOA==", "bodyText": "Would this go to a \"DELETE\" HTTP verb?", "url": "https://github.com/apache/helix/pull/1190#discussion_r462829238", "createdAt": "2020-07-30T08:17:55Z", "author": {"login": "huizhilu"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -94,6 +96,8 @@ public Response get(@PathParam(\"path\") String path, @QueryParam(\"command\") Strin\n         return getChildren(_zkBaseDataAccessor, path);\n       case getStat:\n         return getStat(_zkBaseDataAccessor, path);\n+      case delete:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyNTgxNA==", "bodyText": "That makes more sense, let me have a try.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463225814", "createdAt": "2020-07-30T19:36:15Z", "author": {"login": "jiajunwang"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -94,6 +96,8 @@ public Response get(@PathParam(\"path\") String path, @QueryParam(\"command\") Strin\n         return getChildren(_zkBaseDataAccessor, path);\n       case getStat:\n         return getStat(_zkBaseDataAccessor, path);\n+      case delete:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgyOTIzOA=="}, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MTU1NDg0OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNjo0MzozOVrOG5rP5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNzo1NTo1MVrOG6RGCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMDU5OA==", "bodyText": "I think it would be smarter to use deleteEphemeral and rename your methods accordingly because it seems that it's  not the general delete you're trying to support.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463130598", "createdAt": "2020-07-30T16:43:39Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -52,12 +51,15 @@\n   private static final Logger LOG = LoggerFactory.getLogger(ZooKeeperAccessor.class.getName());\n   private BaseDataAccessor<byte[]> _zkBaseDataAccessor;\n \n+  private static final String PATH_STR = \"path\";\n+\n   public enum ZooKeeperCommand {\n     exists,\n     getBinaryData,\n     getStringData,\n     getChildren,\n-    getStat\n+    getStat,\n+    delete", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyNzU0NQ==", "bodyText": "I don't think we want \"deleteEphemeral\" eventually. As mentioned in the description, this is a premature feature that we add now for unblocking our users.\nAlternatively, I tried to allow deleting live instance only. But that will pollute the ZookeeperAccessor API with Helix logics. So I discarded that idea.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463227545", "createdAt": "2020-07-30T19:39:48Z", "author": {"login": "jiajunwang"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -52,12 +51,15 @@\n   private static final Logger LOG = LoggerFactory.getLogger(ZooKeeperAccessor.class.getName());\n   private BaseDataAccessor<byte[]> _zkBaseDataAccessor;\n \n+  private static final String PATH_STR = \"path\";\n+\n   public enum ZooKeeperCommand {\n     exists,\n     getBinaryData,\n     getStringData,\n     getChildren,\n-    getStat\n+    getStat,\n+    delete", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMDU5OA=="}, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMDY1Mg==", "bodyText": "It seems that you are suggesting adding and using delete, expecting its behavior to change in the future. Adding an endpoint and changing its behavior will bring about backward-compatibility issues and make the meaning of \"delete\" murky. Moreover, there's no harm in having deleteEphemeral - it does what it does, and if the user no longer wishes to use it, then there's no harm in having it.\nA good API design I believe is something that is 1) easy to use and 2) doing exactly what it's advertising to do. Do you see why I think it might be less desirable to add hidden assumptions to delete?", "url": "https://github.com/apache/helix/pull/1190#discussion_r463230652", "createdAt": "2020-07-30T19:45:48Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -52,12 +51,15 @@\n   private static final Logger LOG = LoggerFactory.getLogger(ZooKeeperAccessor.class.getName());\n   private BaseDataAccessor<byte[]> _zkBaseDataAccessor;\n \n+  private static final String PATH_STR = \"path\";\n+\n   public enum ZooKeeperCommand {\n     exists,\n     getBinaryData,\n     getStringData,\n     getChildren,\n-    getStat\n+    getStat,\n+    delete", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMDU5OA=="}, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzODc3Ng==", "bodyText": "I can see where you are coming from. Could you check the latest change that I have modified the method to use DELETE verb according to what Huizhi suggested? I think it is cleaner. However, in this case, we need some more parameters to separate the cases. And I think it might be overcomplicated.\n@dasahcc and @pkuwm please also share your opinion since you also contributed to the Helix rest.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463338776", "createdAt": "2020-07-31T00:13:29Z", "author": {"login": "jiajunwang"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -52,12 +51,15 @@\n   private static final Logger LOG = LoggerFactory.getLogger(ZooKeeperAccessor.class.getName());\n   private BaseDataAccessor<byte[]> _zkBaseDataAccessor;\n \n+  private static final String PATH_STR = \"path\";\n+\n   public enum ZooKeeperCommand {\n     exists,\n     getBinaryData,\n     getStringData,\n     getChildren,\n-    getStat\n+    getStat,\n+    delete", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMDU5OA=="}, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ3NzQ5MA==", "bodyText": "My opinion is,\n\nuse DELETE verb that is designed for the REST delete operation.\nif we only want to support deleting ephemeral, document it well and return a clear response like:\n\n    HTTP/1.1  404\n    Content-Type: application/json\n \n    {\n      \"message\": \"Deleting a non-ephemeral node is not supported/allowed\",\n      \"path\": \"/a/b/c\"\n    }\n\nAnd it is extensible if we want to support deleting persistent node in the future.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463477490", "createdAt": "2020-07-31T08:30:37Z", "author": {"login": "huizhilu"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -52,12 +51,15 @@\n   private static final Logger LOG = LoggerFactory.getLogger(ZooKeeperAccessor.class.getName());\n   private BaseDataAccessor<byte[]> _zkBaseDataAccessor;\n \n+  private static final String PATH_STR = \"path\";\n+\n   public enum ZooKeeperCommand {\n     exists,\n     getBinaryData,\n     getStringData,\n     getChildren,\n-    getStat\n+    getStat,\n+    delete", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMDU5OA=="}, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc1MDY2NQ==", "bodyText": "This information is carried in the response entity as a string for now. I don't think we need to make it too structural (complicated) given it is a temporary restriction. And eventually, we do not have a clear standard for the response format now. So I would prefer holding on any more complex idea.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463750665", "createdAt": "2020-07-31T17:55:51Z", "author": {"login": "jiajunwang"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -52,12 +51,15 @@\n   private static final Logger LOG = LoggerFactory.getLogger(ZooKeeperAccessor.class.getName());\n   private BaseDataAccessor<byte[]> _zkBaseDataAccessor;\n \n+  private static final String PATH_STR = \"path\";\n+\n   public enum ZooKeeperCommand {\n     exists,\n     getBinaryData,\n     getStringData,\n     getChildren,\n-    getStat\n+    getStat,\n+    delete", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMDU5OA=="}, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MTU1Nzk5OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNjo0NDoyM1rOG5rR1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDoxNDoyNlrOG53-Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMTA5Mw==", "bodyText": "Would zkBaseDataAccessor.remove(path, AccessOption.EPHEMERAL) be an option?", "url": "https://github.com/apache/helix/pull/1190#discussion_r463131093", "createdAt": "2020-07-30T16:44:23Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -192,7 +196,29 @@ private Response getStat(BaseDataAccessor<byte[]> zkBaseDataAccessor, String pat\n           .entity(String.format(\"The ZNode at path %s does not exist!\", path)).build());\n     }\n     Map<String, String> result = ZKUtil.fromStatToMap(stat);\n-    result.put(\"path\", path);\n+    result.put(PATH_STR, path);\n+    return JSONRepresentation(result);\n+  }\n+\n+  /**\n+   * Delete the ZNode at the given path if exists.\n+   * @param zkBaseDataAccessor\n+   * @param path\n+   * @return The delete result and the operated path.\n+   */\n+  private Response delete(BaseDataAccessor zkBaseDataAccessor, String path) {\n+    // TODO: Remove this restriction once we have audit and ACL for the API calls.\n+    // TODO: This method is added pre-maturely to support removing the live instance of a zombie\n+    // TODO: instance. It is risky to allow all deleting requests before audit and ACL are done.\n+    Stat stat = zkBaseDataAccessor.getStat(path, AccessOption.PERSISTENT);\n+    if (stat != null && stat.getEphemeralOwner() <= 0) {\n+      throw new WebApplicationException(Response.status(Response.Status.FORBIDDEN)\n+          .entity(String.format(\"Deleting a non ephemeral node is not allowed\", path)).build());\n+    }\n+\n+    Boolean ret = zkBaseDataAccessor.remove(path, AccessOption.PERSISTENT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyODcwOQ==", "bodyText": "The latter parameter is not used. Put EPHEMERAL or PERSISTENT is equally confusing. So let me just put the first enum item for now. I actually intend to avoid using EPHEMERAL since it indicates this parameter has some usage inside (but it is not true).\nI think we need to discard this interesting API for good.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463228709", "createdAt": "2020-07-30T19:42:00Z", "author": {"login": "jiajunwang"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -192,7 +196,29 @@ private Response getStat(BaseDataAccessor<byte[]> zkBaseDataAccessor, String pat\n           .entity(String.format(\"The ZNode at path %s does not exist!\", path)).build());\n     }\n     Map<String, String> result = ZKUtil.fromStatToMap(stat);\n-    result.put(\"path\", path);\n+    result.put(PATH_STR, path);\n+    return JSONRepresentation(result);\n+  }\n+\n+  /**\n+   * Delete the ZNode at the given path if exists.\n+   * @param zkBaseDataAccessor\n+   * @param path\n+   * @return The delete result and the operated path.\n+   */\n+  private Response delete(BaseDataAccessor zkBaseDataAccessor, String path) {\n+    // TODO: Remove this restriction once we have audit and ACL for the API calls.\n+    // TODO: This method is added pre-maturely to support removing the live instance of a zombie\n+    // TODO: instance. It is risky to allow all deleting requests before audit and ACL are done.\n+    Stat stat = zkBaseDataAccessor.getStat(path, AccessOption.PERSISTENT);\n+    if (stat != null && stat.getEphemeralOwner() <= 0) {\n+      throw new WebApplicationException(Response.status(Response.Status.FORBIDDEN)\n+          .entity(String.format(\"Deleting a non ephemeral node is not allowed\", path)).build());\n+    }\n+\n+    Boolean ret = zkBaseDataAccessor.remove(path, AccessOption.PERSISTENT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMTA5Mw=="}, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzOTAzMA==", "bodyText": "Let's don't touch the option for this PR. Let me create an issue for the unnecessary AccessOption.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463339030", "createdAt": "2020-07-31T00:14:26Z", "author": {"login": "jiajunwang"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -192,7 +196,29 @@ private Response getStat(BaseDataAccessor<byte[]> zkBaseDataAccessor, String pat\n           .entity(String.format(\"The ZNode at path %s does not exist!\", path)).build());\n     }\n     Map<String, String> result = ZKUtil.fromStatToMap(stat);\n-    result.put(\"path\", path);\n+    result.put(PATH_STR, path);\n+    return JSONRepresentation(result);\n+  }\n+\n+  /**\n+   * Delete the ZNode at the given path if exists.\n+   * @param zkBaseDataAccessor\n+   * @param path\n+   * @return The delete result and the operated path.\n+   */\n+  private Response delete(BaseDataAccessor zkBaseDataAccessor, String path) {\n+    // TODO: Remove this restriction once we have audit and ACL for the API calls.\n+    // TODO: This method is added pre-maturely to support removing the live instance of a zombie\n+    // TODO: instance. It is risky to allow all deleting requests before audit and ACL are done.\n+    Stat stat = zkBaseDataAccessor.getStat(path, AccessOption.PERSISTENT);\n+    if (stat != null && stat.getEphemeralOwner() <= 0) {\n+      throw new WebApplicationException(Response.status(Response.Status.FORBIDDEN)\n+          .entity(String.format(\"Deleting a non ephemeral node is not allowed\", path)).build());\n+    }\n+\n+    Boolean ret = zkBaseDataAccessor.remove(path, AccessOption.PERSISTENT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzMTA5Mw=="}, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjEzNTQ4OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestZooKeeperAccessor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxOTozMToxMFrOG5w5uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxOTo1NzoyNlrOG5xuxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyMzIyNA==", "bodyText": "Question here (may not related to your change).\nIs the second param here in exists(String path, int options) useful? I did not find it being considered in any implementation of BaseDataAccessor.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463223224", "createdAt": "2020-07-30T19:31:10Z", "author": {"login": "xyuanlu"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestZooKeeperAccessor.java", "diffHunk": "@@ -192,4 +191,33 @@ public void testGetStat() throws IOException {\n     // Clean up\n     _testBaseDataAccessor.remove(path, AccessOption.PERSISTENT);\n   }\n+\n+  @Test\n+  public void testDelete() throws IOException {\n+    String path = \"/path\";\n+    String deletePath = path + \"/delete\";\n+\n+    try {\n+      // 1. Create a persistent node. Delete shall fail.\n+      _testBaseDataAccessor.create(deletePath, null, AccessOption.PERSISTENT);\n+      // Verify with the REST endpoint\n+      new JerseyUriRequestBuilder(\"zookeeper{}?command=delete\").format(deletePath)\n+          .expectedReturnStatusCode(Response.Status.FORBIDDEN.getStatusCode());\n+      Assert.assertTrue(_testBaseDataAccessor.exists(deletePath, AccessOption.PERSISTENT));\n+\n+      // 2. Create a ephemeral node. Delete shall be done successfully.\n+      _testBaseDataAccessor.remove(deletePath, AccessOption.PERSISTENT);\n+      _testBaseDataAccessor.create(deletePath, null, AccessOption.EPHEMERAL);\n+      // Verify with the REST endpoint\n+      String data = new JerseyUriRequestBuilder(\"zookeeper{}?command=delete\").format(deletePath)\n+          .isBodyReturnExpected(true).get(this);\n+      Map<String, String> result = OBJECT_MAPPER.readValue(data, HashMap.class);\n+      Assert.assertEquals(result.get(\"path\"), deletePath);\n+      Assert.assertEquals(result.get(\"delete\"), new Boolean(true).toString());\n+      Assert.assertFalse(_testBaseDataAccessor.exists(deletePath, AccessOption.PERSISTENT));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyOTY0Ng==", "bodyText": "No use at all. There seems to be no such an exist or getStat method which takes the option in ZK lib, either. I think we shall clean them up in a separate PR.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463229646", "createdAt": "2020-07-30T19:43:46Z", "author": {"login": "jiajunwang"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestZooKeeperAccessor.java", "diffHunk": "@@ -192,4 +191,33 @@ public void testGetStat() throws IOException {\n     // Clean up\n     _testBaseDataAccessor.remove(path, AccessOption.PERSISTENT);\n   }\n+\n+  @Test\n+  public void testDelete() throws IOException {\n+    String path = \"/path\";\n+    String deletePath = path + \"/delete\";\n+\n+    try {\n+      // 1. Create a persistent node. Delete shall fail.\n+      _testBaseDataAccessor.create(deletePath, null, AccessOption.PERSISTENT);\n+      // Verify with the REST endpoint\n+      new JerseyUriRequestBuilder(\"zookeeper{}?command=delete\").format(deletePath)\n+          .expectedReturnStatusCode(Response.Status.FORBIDDEN.getStatusCode());\n+      Assert.assertTrue(_testBaseDataAccessor.exists(deletePath, AccessOption.PERSISTENT));\n+\n+      // 2. Create a ephemeral node. Delete shall be done successfully.\n+      _testBaseDataAccessor.remove(deletePath, AccessOption.PERSISTENT);\n+      _testBaseDataAccessor.create(deletePath, null, AccessOption.EPHEMERAL);\n+      // Verify with the REST endpoint\n+      String data = new JerseyUriRequestBuilder(\"zookeeper{}?command=delete\").format(deletePath)\n+          .isBodyReturnExpected(true).get(this);\n+      Map<String, String> result = OBJECT_MAPPER.readValue(data, HashMap.class);\n+      Assert.assertEquals(result.get(\"path\"), deletePath);\n+      Assert.assertEquals(result.get(\"delete\"), new Boolean(true).toString());\n+      Assert.assertFalse(_testBaseDataAccessor.exists(deletePath, AccessOption.PERSISTENT));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyMzIyNA=="}, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzNjgwNA==", "bodyText": "Yea. That confuses me as well. It seems many functions has a not-used 'int option' as input in BaseDataAccessor. May I suggest using a value consist with the node type as input? For example, we want to check if the newly created EPHEMERAL node is deleted, let use EPHEMERAL here to avoid further confusion.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463236804", "createdAt": "2020-07-30T19:57:26Z", "author": {"login": "xyuanlu"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/server/TestZooKeeperAccessor.java", "diffHunk": "@@ -192,4 +191,33 @@ public void testGetStat() throws IOException {\n     // Clean up\n     _testBaseDataAccessor.remove(path, AccessOption.PERSISTENT);\n   }\n+\n+  @Test\n+  public void testDelete() throws IOException {\n+    String path = \"/path\";\n+    String deletePath = path + \"/delete\";\n+\n+    try {\n+      // 1. Create a persistent node. Delete shall fail.\n+      _testBaseDataAccessor.create(deletePath, null, AccessOption.PERSISTENT);\n+      // Verify with the REST endpoint\n+      new JerseyUriRequestBuilder(\"zookeeper{}?command=delete\").format(deletePath)\n+          .expectedReturnStatusCode(Response.Status.FORBIDDEN.getStatusCode());\n+      Assert.assertTrue(_testBaseDataAccessor.exists(deletePath, AccessOption.PERSISTENT));\n+\n+      // 2. Create a ephemeral node. Delete shall be done successfully.\n+      _testBaseDataAccessor.remove(deletePath, AccessOption.PERSISTENT);\n+      _testBaseDataAccessor.create(deletePath, null, AccessOption.EPHEMERAL);\n+      // Verify with the REST endpoint\n+      String data = new JerseyUriRequestBuilder(\"zookeeper{}?command=delete\").format(deletePath)\n+          .isBodyReturnExpected(true).get(this);\n+      Map<String, String> result = OBJECT_MAPPER.readValue(data, HashMap.class);\n+      Assert.assertEquals(result.get(\"path\"), deletePath);\n+      Assert.assertEquals(result.get(\"delete\"), new Boolean(true).toString());\n+      Assert.assertFalse(_testBaseDataAccessor.exists(deletePath, AccessOption.PERSISTENT));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyMzIyNA=="}, "originalCommit": {"oid": "b6e19fde7aff92f92bb8a5d4c907529174d9d144"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5Mzc2NzI3OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODoxNzoyNFrOG6ACCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNzo1NjozNFrOG6RHcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ3MTExMg==", "bodyText": "Actually if we set the root path as below, we don't need to prepend the root slash, which is not that clean.\n@Path(\"/zookeeper{path: /.+}\")\npublic class ZooKeeperAccessor extends AbstractResource {", "url": "https://github.com/apache/helix/pull/1190#discussion_r463471112", "createdAt": "2020-07-31T08:17:24Z", "author": {"login": "huizhilu"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -101,6 +100,26 @@ public Response get(@PathParam(\"path\") String path, @QueryParam(\"command\") Strin\n     }\n   }\n \n+  @DELETE\n+  @Path(\"{path: .+}\")\n+  public Response delete(@PathParam(\"path\") String path) {\n+    // Lazily initialize ZkBaseDataAccessor\n+    ServerContext _serverContext =\n+        (ServerContext) _application.getProperties().get(ContextPropertyKeys.SERVER_CONTEXT.name());\n+    _zkBaseDataAccessor = _serverContext.getByteArrayZkBaseDataAccessor();\n+\n+    path = prependPath(path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6857c1786c35c314a7a442413ebdb99e122e5d1b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc1MTAyNw==", "bodyText": "Neat, changed the code accordingly. There is more code like that. But I would not change them in this PR.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463751027", "createdAt": "2020-07-31T17:56:34Z", "author": {"login": "jiajunwang"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -101,6 +100,26 @@ public Response get(@PathParam(\"path\") String path, @QueryParam(\"command\") Strin\n     }\n   }\n \n+  @DELETE\n+  @Path(\"{path: .+}\")\n+  public Response delete(@PathParam(\"path\") String path) {\n+    // Lazily initialize ZkBaseDataAccessor\n+    ServerContext _serverContext =\n+        (ServerContext) _application.getProperties().get(ContextPropertyKeys.SERVER_CONTEXT.name());\n+    _zkBaseDataAccessor = _serverContext.getByteArrayZkBaseDataAccessor();\n+\n+    path = prependPath(path);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ3MTExMg=="}, "originalCommit": {"oid": "6857c1786c35c314a7a442413ebdb99e122e5d1b"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NjU5NDQ1OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQwMToxMTozMlrOG6aT0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQwMToxMTozMlrOG6aT0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwMTY0OA==", "bodyText": "Could we add a msg to this as well: (\"Path %s does not exist\", path)? I think it gives a user a better idea. Otherwise the msg returned is unfriendly if we use curl endpoint in terminal.\n<html>\n<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html;charset=ISO-8859-1\"/>\n<title>Error 404 </title>\n</head>\n<body>\n<h2>HTTP ERROR: 404</h2>\n<p>Problem accessing /admin/v2/zookeeper/aa. Reason:\n<pre>    Not Found</pre></p>\n<hr /><a href=\"http://eclipse.org/jetty\">Powered by Jetty:// 9.4.12.v20180830</a><hr/>\n</body>\n</html>\n\nVS\n{\n  \"message\" : \"Path /aa does not exist\",\n  \"status\": 404\n}", "url": "https://github.com/apache/helix/pull/1190#discussion_r463901648", "createdAt": "2020-08-01T01:11:32Z", "author": {"login": "huizhilu"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -196,6 +209,32 @@ private Response getStat(BaseDataAccessor<byte[]> zkBaseDataAccessor, String pat\n     return JSONRepresentation(result);\n   }\n \n+  /**\n+   * Delete the ZNode at the given path if exists.\n+   * @param zkBaseDataAccessor\n+   * @param path\n+   * @return The delete result and the operated path.\n+   */\n+  private Response delete(BaseDataAccessor zkBaseDataAccessor, String path) {\n+    Stat stat = zkBaseDataAccessor.getStat(path, AccessOption.PERSISTENT);\n+    if (stat == null) {\n+      return notFound();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a189bef7dd6d68aeef68ef497086b1ee6f8df2c"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NjYwMDk0OnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQwMToxOToxOFrOG6aXGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQwMToxOToxOFrOG6aXGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkwMjQ5MQ==", "bodyText": "At least add a message OK(\"Success\")?", "url": "https://github.com/apache/helix/pull/1190#discussion_r463902491", "createdAt": "2020-08-01T01:19:18Z", "author": {"login": "huizhilu"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -196,6 +209,32 @@ private Response getStat(BaseDataAccessor<byte[]> zkBaseDataAccessor, String pat\n     return JSONRepresentation(result);\n   }\n \n+  /**\n+   * Delete the ZNode at the given path if exists.\n+   * @param zkBaseDataAccessor\n+   * @param path\n+   * @return The delete result and the operated path.\n+   */\n+  private Response delete(BaseDataAccessor zkBaseDataAccessor, String path) {\n+    Stat stat = zkBaseDataAccessor.getStat(path, AccessOption.PERSISTENT);\n+    if (stat == null) {\n+      return notFound();\n+    } else if (stat.getEphemeralOwner() <= 0) {\n+      // TODO: Remove this restriction once we have audit and ACL for the API calls.\n+      // TODO: This method is added pre-maturely to support removing the live instance of a zombie\n+      // TODO: instance. It is risky to allow all deleting requests before audit and ACL are done.\n+      throw new WebApplicationException(Response.status(Response.Status.FORBIDDEN)\n+          .entity(String.format(\"Deleting a non-ephemeral node is not allowed.\")).build());\n+    }\n+\n+    if (zkBaseDataAccessor.remove(path, AccessOption.PERSISTENT)) {\n+      return OK();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a189bef7dd6d68aeef68ef497086b1ee6f8df2c"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5Njc2OTAzOnYy", "diffSide": "RIGHT", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQwNDo1MjozM1rOG6blPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMDowOTozMlrOG7MmZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyMjQ5Mg==", "bodyText": "I'm not seeing how this is any different from using delete. This is no better than using delete for two different types of delete's - delete and deleteEphemeral.\nPerhaps you could add a commandStr here to differentiate two different types of deletes, and when you want to add an endpoint for regular delete backed by ACL checks, then just implement that if that becomes necessary? I don't think this adds any more work/difficulty for the purposes of this PR? (If any, it saves you the work of adding a TODO)\nMy point was not about what kind of REST verb we should use - it's pretty clear we should use DELETE in this case. But it's more about following a good API design which, again, is something that is hard to misuse by not embedding hidden assumptions or TODOs that may cause a behavior change down the road. Also, seen from another angle, supporting it as deleteEphemeral gives the user a clear meaning to the command string as opposed to just calling it a HTTP verb DELETE, which might leave the user confused and question the meaning of the API when it fails to delete regular ZNodes.\nYou could add two commands, delete and deleteEphemeral, and make the default commandStr delete, and throw a not authorized or not supported, and only let deleteEphemeral go through. This way, when we do decide to support delete operation with ACL, there's no confusion or change in behavior.", "url": "https://github.com/apache/helix/pull/1190#discussion_r463922492", "createdAt": "2020-08-01T04:52:33Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -196,6 +209,32 @@ private Response getStat(BaseDataAccessor<byte[]> zkBaseDataAccessor, String pat\n     return JSONRepresentation(result);\n   }\n \n+  /**\n+   * Delete the ZNode at the given path if exists.\n+   * @param zkBaseDataAccessor\n+   * @param path\n+   * @return The delete result and the operated path.\n+   */\n+  private Response delete(BaseDataAccessor zkBaseDataAccessor, String path) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a189bef7dd6d68aeef68ef497086b1ee6f8df2c"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyNTYwNw==", "bodyText": "Discussed with Junkai in slack, his point is that we don't need the additional cmd layer for now.", "url": "https://github.com/apache/helix/pull/1190#discussion_r464725607", "createdAt": "2020-08-04T00:09:32Z", "author": {"login": "jiajunwang"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/resources/zookeeper/ZooKeeperAccessor.java", "diffHunk": "@@ -196,6 +209,32 @@ private Response getStat(BaseDataAccessor<byte[]> zkBaseDataAccessor, String pat\n     return JSONRepresentation(result);\n   }\n \n+  /**\n+   * Delete the ZNode at the given path if exists.\n+   * @param zkBaseDataAccessor\n+   * @param path\n+   * @return The delete result and the operated path.\n+   */\n+  private Response delete(BaseDataAccessor zkBaseDataAccessor, String path) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzkyMjQ5Mg=="}, "originalCommit": {"oid": "0a189bef7dd6d68aeef68ef497086b1ee6f8df2c"}, "originalPosition": 70}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1282, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}