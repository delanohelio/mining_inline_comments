{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3OTAyNzYz", "number": 1181, "title": "Recover Workflow GC Logic", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nFixes #1075\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nPreviously, the workflow garbage collection logic was removed in fear of race conditions (PR: #803 ). As we see value in bringing back workflow garbage collection, we are getting rid of the race conditions and bringing back the logic.\nSpecifically, two items need to be completed:\n\nAvoid direct dependency of garbage collection stage on the cache. We can instead deliver the relevant content of the cache into the stage during sync time, and use it during async time. This way the race condition with cache is no longer an issue.\nWe are getting rid of an unnecessary JobConfig write that serves no purpose to avoid possible race conditions.\n\nTests\n\n The following tests are written for this issue:\n\ntestGetExpiredJobsFromCache, testWorkflowContextGarbageCollection(recovered from old PR), testWorkflowGarbageCollection\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n[ERROR] Tests run: 1155, Failures: 3, Errors: 0, Skipped: 1, Time elapsed: 4,495.443 s <<< FAILURE! - in TestSuite\n[ERROR] testEnableCompressionResource(org.apache.helix.integration.TestEnableCompression)  Time elapsed: 160.699 s  <<< FAILURE!\njava.lang.AssertionError: expected:<true> but was:<false>\n        at org.apache.helix.integration.TestEnableCompression.testEnableCompressionResource(TestEnableCompression.java:117)\n\n[ERROR] testDisablingTopStateReplicaByDisablingInstance(org.apache.helix.integration.TestNoThrottleDisabledPartitions)  Time elapsed: 2.3 s  <<< FAILURE!\njava.lang.AssertionError: expected:<false> but was:<true>\n        at org.apache.helix.integration.TestNoThrottleDisabledPartitions.testDisablingTopStateReplicaByDisablingInstance(TestNoThrottleDisabledPartitions.java:97)\n\n[ERROR] testDisableFullAuto(org.apache.helix.integration.TestDisablePartition)  Time elapsed: 5.599 s  <<< FAILURE!\njava.lang.AssertionError: expected:<OFFLINE> but was:<LEADER>\n        at org.apache.helix.integration.TestDisablePartition.testDisableFullAuto(TestDisablePartition.java:202)\n\n[INFO] \n[INFO] Results:\n[INFO] \n[ERROR] Failures: \n[ERROR] org.apache.helix.integration.TestDisablePartition.testDisableFullAuto(org.apache.helix.integration.TestDisablePartition)\n[ERROR]   Run 1: TestDisablePartition.testDisableFullAuto:202 expected:<OFFLINE> but was:<LEADER>\n[INFO]   Run 2: PASS\n[INFO] \n[ERROR]   TestEnableCompression.testEnableCompressionResource:117 expected:<true> but was:<false>\n[ERROR]   TestNoThrottleDisabledPartitions.testDisablingTopStateReplicaByDisablingInstance:97 expected:<false> but was:<true>\n[INFO] \n[ERROR] Tests run: 1154, Failures: 3, Errors: 0, Skipped: 1\n[INFO] \n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD FAILURE\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  01:15 h\n[INFO] Finished at: 2020-07-29T01:25:06-07:00\n[INFO] ------------------------------------------------------------------------\n\nRerun\n[INFO] Tests run: 6, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 37.825 s - in TestSuite\n[INFO] \n[INFO] Results:\n[INFO] \n[INFO] Tests run: 6, Failures: 0, Errors: 0, Skipped: 0\n[INFO] \n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  43.271 s\n[INFO] Finished at: 2020-07-29T09:37:30-07:00\n[INFO] ------------------------------------------------------------------------\n\nCommits\n\n My commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\n My diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-07-28T15:56:09Z", "url": "https://github.com/apache/helix/pull/1181", "merged": true, "mergeCommit": {"oid": "ddde2f084ed2f6c0a0fe89f2c412c0fa4e2a36c1"}, "closed": true, "closedAt": "2020-07-29T17:33:00Z", "author": {"login": "NealSun96"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5IKqRgH2gAyNDU3OTAyNzYzOmUwNWQwZTgyOGZmZTMyOGQ1Zjc4MDY1ZmU0NDU5ODc1NTQzYWM1NGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5txz5AFqTQ1NzY5OTk5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e05d0e828ffe328d5f78065fe4459875543ac54e", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/e05d0e828ffe328d5f78065fe4459875543ac54e", "committedDate": "2020-07-27T20:50:39Z", "message": "Fix broken test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b89eb7defb97f5c1d1eb8d310c9c709da9ca53d", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/0b89eb7defb97f5c1d1eb8d310c9c709da9ca53d", "committedDate": "2020-07-27T20:52:20Z", "message": "Address some comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ea5fb2626af2e87b8332b1470ca5fa62689a8a7", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/3ea5fb2626af2e87b8332b1470ca5fa62689a8a7", "committedDate": "2020-07-27T21:09:34Z", "message": "Temporary changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87a2097ba9fa23ddac57417ac4221b287828a651", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/87a2097ba9fa23ddac57417ac4221b287828a651", "committedDate": "2020-07-27T21:10:23Z", "message": "New direction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3925f399ada8e922f355986138d71cc25b2ad70e", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/3925f399ada8e922f355986138d71cc25b2ad70e", "committedDate": "2020-07-27T21:10:23Z", "message": "Add comments etc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00aeafc478233af7903478ebb1a74c9a1db60789", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/00aeafc478233af7903478ebb1a74c9a1db60789", "committedDate": "2020-07-27T21:10:23Z", "message": "New test and nits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12233c30f3684638f9ea29ca0ff047f122d045fe", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/12233c30f3684638f9ea29ca0ff047f122d045fe", "committedDate": "2020-07-27T21:10:23Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80fa8e7e61c6c95269bcd3fcbc04f563a1c788be", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/80fa8e7e61c6c95269bcd3fcbc04f563a1c788be", "committedDate": "2020-07-27T21:10:23Z", "message": "Renaming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70f2ccdd5f6963ea3ae7226a27c9939ed77f0bd6", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/70f2ccdd5f6963ea3ae7226a27c9939ed77f0bd6", "committedDate": "2020-07-27T21:10:23Z", "message": "Fix NPE and broken tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4928ab998c0dbdd773f5bc83111a06511c91afa8", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/4928ab998c0dbdd773f5bc83111a06511c91afa8", "committedDate": "2020-07-27T21:22:03Z", "message": "Fix patch issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9c1f7430ad9d8f1cd444c6b363bde4222bf8697", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/c9c1f7430ad9d8f1cd444c6b363bde4222bf8697", "committedDate": "2020-07-27T21:37:09Z", "message": "better scheduling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a149766b337705130013fb7ca805fc9af7bcee85", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/a149766b337705130013fb7ca805fc9af7bcee85", "committedDate": "2020-07-27T23:59:33Z", "message": "Logic update for true case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2Nzk1ODAx", "url": "https://github.com/apache/helix/pull/1181#pullrequestreview-456795801", "createdAt": "2020-07-28T16:15:32Z", "commit": {"oid": "70f2ccdd5f6963ea3ae7226a27c9939ed77f0bd6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoxNTozM1rOG4UQew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoxNTozOVrOG4UQvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNTMzOQ==", "bodyText": "Can you change this to TestHeper.WAIT_DURATION?", "url": "https://github.com/apache/helix/pull/1181#discussion_r461705339", "createdAt": "2020-07-28T16:15:33Z", "author": {"login": "alirezazamani"}, "path": "helix-core/src/test/java/org/apache/helix/integration/task/TestJobQueueCleanUp.java", "diffHunk": "@@ -105,14 +105,19 @@ public void testJobQueueAutoCleanUp() throws InterruptedException {\n     }\n     _driver.start(builder.build());\n     _driver.pollForJobState(queueName, TaskUtil.getNamespacedJobName(queueName, \"JOB\" + (capacity - 1)), TaskState.FAILED);\n-    Thread.sleep(2000);\n \n-    WorkflowConfig config = _driver.getWorkflowConfig(queueName);\n-    Assert.assertEquals(config.getJobDag().getAllNodes(), remainJobs);\n+    Assert\n+        .assertTrue(TestHelper.verify(() -> {\n+          WorkflowConfig config = _driver.getWorkflowConfig(queueName);\n+          System.out.println(\"|Current time: \" + System.currentTimeMillis() +\" **TEST: \" + config.getJobDag().getAllNodes());\n+          return config.getJobDag().getAllNodes().equals(remainJobs);\n+        }, 10000));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f2ccdd5f6963ea3ae7226a27c9939ed77f0bd6"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNTQwNA==", "bodyText": "Can you change this to TestHeper.WAIT_DURATION?", "url": "https://github.com/apache/helix/pull/1181#discussion_r461705404", "createdAt": "2020-07-28T16:15:39Z", "author": {"login": "alirezazamani"}, "path": "helix-core/src/test/java/org/apache/helix/integration/task/TestJobQueueCleanUp.java", "diffHunk": "@@ -105,14 +105,19 @@ public void testJobQueueAutoCleanUp() throws InterruptedException {\n     }\n     _driver.start(builder.build());\n     _driver.pollForJobState(queueName, TaskUtil.getNamespacedJobName(queueName, \"JOB\" + (capacity - 1)), TaskState.FAILED);\n-    Thread.sleep(2000);\n \n-    WorkflowConfig config = _driver.getWorkflowConfig(queueName);\n-    Assert.assertEquals(config.getJobDag().getAllNodes(), remainJobs);\n+    Assert\n+        .assertTrue(TestHelper.verify(() -> {\n+          WorkflowConfig config = _driver.getWorkflowConfig(queueName);\n+          System.out.println(\"|Current time: \" + System.currentTimeMillis() +\" **TEST: \" + config.getJobDag().getAllNodes());\n+          return config.getJobDag().getAllNodes().equals(remainJobs);\n+        }, 10000));\n \n-    WorkflowContext context = _driver.getWorkflowContext(queueName);\n-    Assert.assertEquals(context.getJobStates().keySet(), remainJobs);\n-    Assert.assertTrue(remainJobs.containsAll(context.getJobStartTimes().keySet()));\n+    Assert.assertTrue(TestHelper.verify(() -> {\n+      WorkflowContext context = _driver.getWorkflowContext(queueName);\n+      return context.getJobStates().keySet().equals(remainJobs) && remainJobs\n+          .containsAll(context.getJobStartTimes().keySet());\n+    }, 10000));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f2ccdd5f6963ea3ae7226a27c9939ed77f0bd6"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fd6de493ef8ea016f28eafb83634ce2030a2ded", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/0fd6de493ef8ea016f28eafb83634ce2030a2ded", "committedDate": "2020-07-28T16:52:45Z", "message": "variable name change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Njk5OTk3", "url": "https://github.com/apache/helix/pull/1181#pullrequestreview-457699997", "createdAt": "2020-07-29T16:39:54Z", "commit": {"oid": "0fd6de493ef8ea016f28eafb83634ce2030a2ded"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4590, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}