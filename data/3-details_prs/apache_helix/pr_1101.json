{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2MTA3Njcy", "number": 1101, "title": "Add metrics for expired session count", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n#1100\n\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nHaving a metric for number of expired session in zk client side will help user debugging cases that has frequent session expiration.\nThis PR adds a \"ExpiredSessionCounter\" metrics in ZkClientMonitor.\nTests\n\n The following tests are written for this issue:\n\nTestRawZkClient.testSessionExpireCount\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n\n[ERROR] org.apache.helix.integration.TestDisablePartition.testDisableFullAuto(org.apache.helix.integration.TestDisablePartition)\n[ERROR]   Run 1: TestDisablePartition.testDisableFullAuto:202 expected:<OFFLINE> but was:<STANDBY>\n[INFO]   Run 2: PASS\n[INFO]\n[ERROR]   TestControllerLeadershipChange.testMissingTopStateDurationMonitoring:262 expected:<true> but was:<false>\n[ERROR]   TestStateTransitionTimeout.testStateTransitionTimeOut:166 expected:<true> but was:<false>\n[ERROR]   TestStateTransitionTimeoutWithResource.testStateTransitionTimeOut:171 expected:<true> but was:<false>\n[ERROR]   TestJobFailureDependence.testWorkflowFailureJobThreshold \u00bb ThreadTimeout Metho...\n\nRerun\uff1a\n[INFO] Tests run: 4, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 12.536 s - in org.apache.helix.integration.controller.TestControllerLeadershipChange\n[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 5.018 s - in org.apache.helix.integration.paticipant.TestStateTransitionTimeout\n[INFO] Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 19.774 s - in org.apache.helix.integration.paticipant.TestStateTransitionTimeoutWithResource\n[INFO] Tests run: 4, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 48.617 s - in org.apache.helix.integration.task.TestJobFailureDependence\n\n\nCommits\n\n My commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nDocumentation (Optional)\n\n In case of new functionality, my PR adds documentation in the following wiki page:\n\nCode Quality\n\n My diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-06-17T21:33:21Z", "url": "https://github.com/apache/helix/pull/1101", "merged": true, "mergeCommit": {"oid": "92c860d80e8f7d2b044d9531d4de65d0ddcc5d98"}, "closed": true, "closedAt": "2020-06-23T18:03:30Z", "author": {"login": "xyuanlu"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcs9c5FgFqTQzMzcyNzU4Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABct5UyTAFqTQzNTMzNzk0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzI3NTg3", "url": "https://github.com/apache/helix/pull/1101#pullrequestreview-433727587", "createdAt": "2020-06-19T00:21:10Z", "commit": {"oid": "e2606680f59d667b969d91765cf567cb2df758dc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMDoyMToxMFrOGmEMzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMDoyNDozNFrOGmEQVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2Nzg4Ng==", "bodyText": "I think it would be simpler that we let the caller checking this dependency but not the record method.\nSo just do\nif (stateChange) {}\nif (dataChange) {}\nif (sessionExpired) {}", "url": "https://github.com/apache/helix/pull/1101#discussion_r442567886", "createdAt": "2020-06-19T00:21:10Z", "author": {"login": "jiajunwang"}, "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -2138,11 +2139,14 @@ private void recordFailure(String path, ZkClientMonitor.AccessType accessType) {\n     }\n   }\n \n-  private void recordStateChange(boolean stateChanged, boolean dataChanged) {\n+  private void recordStateChange(boolean stateChanged, boolean dataChanged, boolean sessionExpired) {\n     // update state change counter.\n     if (_monitor != null) {\n       if (stateChanged) {\n         _monitor.increaseStateChangeEventCounter();\n+        if (sessionExpired) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2606680f59d667b969d91765cf567cb2df758dc"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2ODc5MA==", "bodyText": "This looks duplicate to the testSessionExpiry method. Could you please merge the test logic if possible?", "url": "https://github.com/apache/helix/pull/1101#discussion_r442568790", "createdAt": "2020-06-19T00:24:34Z", "author": {"login": "jiajunwang"}, "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/client/TestRawZkClient.java", "diffHunk": "@@ -487,6 +488,50 @@ void testPendingRequestGauge()\n     }\n   }\n \n+  @Test(dependsOnMethods = \"testZkClientMonitor\")\n+  void testSessionExpireCount() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2606680f59d667b969d91765cf567cb2df758dc"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b07f4bfa59c1069f6eb6d2fe922599e5bd09f0c", "author": {"user": {"login": "xyuanlu", "name": null}}, "url": "https://github.com/apache/helix/commit/5b07f4bfa59c1069f6eb6d2fe922599e5bd09f0c", "committedDate": "2020-06-22T18:55:00Z", "message": "Add metrics for expired session count"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78c0bedda81294e56a904cd5cc11dae7c25a0f7b", "author": {"user": {"login": "xyuanlu", "name": null}}, "url": "https://github.com/apache/helix/commit/78c0bedda81294e56a904cd5cc11dae7c25a0f7b", "committedDate": "2020-06-22T18:55:00Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2606680f59d667b969d91765cf567cb2df758dc", "author": {"user": {"login": "xyuanlu", "name": null}}, "url": "https://github.com/apache/helix/commit/e2606680f59d667b969d91765cf567cb2df758dc", "committedDate": "2020-06-17T17:56:23Z", "message": "Add metrics for expired session count"}, "afterCommit": {"oid": "78c0bedda81294e56a904cd5cc11dae7c25a0f7b", "author": {"user": {"login": "xyuanlu", "name": null}}, "url": "https://github.com/apache/helix/commit/78c0bedda81294e56a904cd5cc11dae7c25a0f7b", "committedDate": "2020-06-22T18:55:00Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MzM3OTQz", "url": "https://github.com/apache/helix/pull/1101#pullrequestreview-435337943", "createdAt": "2020-06-22T23:19:58Z", "commit": {"oid": "78c0bedda81294e56a904cd5cc11dae7c25a0f7b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4496, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}