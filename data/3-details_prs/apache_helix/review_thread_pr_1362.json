{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2ODExMjAy", "number": 1362, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMDozNzoyOVrOEjTeyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwODowMDoyOVrOEnuUXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NDU0Nzk0OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMDozNzoyOVrOHRlr6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMToyODozNVrOHRnOpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwNTI5MA==", "bodyText": "minor: change isMessageStaled to isMessageStale. We didn't on purpose stale the message.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488205290", "createdAt": "2020-09-14T20:37:29Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,35 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  public Exception isMessageStaled(boolean inSchedulerCheck) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIzMDU2NQ==", "bodyText": "TFTR. Updated.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488230565", "createdAt": "2020-09-14T21:28:35Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,35 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  public Exception isMessageStaled(boolean inSchedulerCheck) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwNTI5MA=="}, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NDU1MzMxOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMDozOToxMFrOHRlvJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNDo0MjowNFrOHWWIkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwNjExOQ==", "bodyText": "Besides the current_state equals to_state case, is this also a case that we can move to scheduling phase instead of execution phase? That could help reduce even more threads usage.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488206119", "createdAt": "2020-09-14T20:39:10Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,35 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  public Exception isMessageStaled(boolean inSchedulerCheck) {\n+    String fromState = _message.getFromState();\n+    String toState = _message.getToState();\n+    String partitionName = _message.getPartitionName();\n+\n+    // state in _currentStateDelta uses current state from state model. It has the\n+    // most up-to-date. current state. In case currentState in stateModel is null,\n+    // partition is in initial state and we using it as current state.\n+    // Defined in HelixStateMachineEngine.\n+    String state = _currentStateDelta.getState(partitionName);\n+\n+    Exception err = null;\n+    if (toState.equalsIgnoreCase(state)) {\n+      // To state equals current state, we can just ignore the message\n+      err = new HelixDuplicatedStateTransitionException(String\n+          .format(\"Partition %s current state is same as toState (%s->%s) from message.\",\n+              partitionName, fromState, toState));\n+    } else if (!inSchedulerCheck && fromState != null && !fromState.equals(\"*\") && !fromState", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIyMTAzMw==", "bodyText": "TFTR. This case is a bit different than the above one. The handling for these two cases are different.\nFor the first case when toState == currentState, we just treat the task as succeeded and finish task. There is no difference between doing the no-op when executing and bypass the task at scheduling phase.\nIn the second case when currentState != fromState, executor will set the task as failed and report state transition error. Ir will also update ZK.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488221033", "createdAt": "2020-09-14T21:08:42Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,35 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  public Exception isMessageStaled(boolean inSchedulerCheck) {\n+    String fromState = _message.getFromState();\n+    String toState = _message.getToState();\n+    String partitionName = _message.getPartitionName();\n+\n+    // state in _currentStateDelta uses current state from state model. It has the\n+    // most up-to-date. current state. In case currentState in stateModel is null,\n+    // partition is in initial state and we using it as current state.\n+    // Defined in HelixStateMachineEngine.\n+    String state = _currentStateDelta.getState(partitionName);\n+\n+    Exception err = null;\n+    if (toState.equalsIgnoreCase(state)) {\n+      // To state equals current state, we can just ignore the message\n+      err = new HelixDuplicatedStateTransitionException(String\n+          .format(\"Partition %s current state is same as toState (%s->%s) from message.\",\n+              partitionName, fromState, toState));\n+    } else if (!inSchedulerCheck && fromState != null && !fromState.equals(\"*\") && !fromState", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwNjExOQ=="}, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE5MzM2MQ==", "bodyText": "I had an offline sync with Ali. He has submit a PR to fix this issue (#1390). I changed my PR accordingly. We now do the same validation for scheduling stage and execution stage.\nCurrently my PR contains his patch. Will rebase after his PR merged.", "url": "https://github.com/apache/helix/pull/1362#discussion_r493193361", "createdAt": "2020-09-23T04:42:04Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,35 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  public Exception isMessageStaled(boolean inSchedulerCheck) {\n+    String fromState = _message.getFromState();\n+    String toState = _message.getToState();\n+    String partitionName = _message.getPartitionName();\n+\n+    // state in _currentStateDelta uses current state from state model. It has the\n+    // most up-to-date. current state. In case currentState in stateModel is null,\n+    // partition is in initial state and we using it as current state.\n+    // Defined in HelixStateMachineEngine.\n+    String state = _currentStateDelta.getState(partitionName);\n+\n+    Exception err = null;\n+    if (toState.equalsIgnoreCase(state)) {\n+      // To state equals current state, we can just ignore the message\n+      err = new HelixDuplicatedStateTransitionException(String\n+          .format(\"Partition %s current state is same as toState (%s->%s) from message.\",\n+              partitionName, fromState, toState));\n+    } else if (!inSchedulerCheck && fromState != null && !fromState.equals(\"*\") && !fromState", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwNjExOQ=="}, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NDU2NTU0OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMDo0Mjo1OFrOHRl23Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMDo0Mjo1OFrOHRl23Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwODA5Mw==", "bodyText": "The return type is confusing. isMessageStaled implies a boolean value as return. You can change the function name to something like validateStaleMessage, etc, or change the return type.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488208093", "createdAt": "2020-09-14T20:42:58Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).isMessageStaled(true /*inSchedulerCheck*/);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NDU2ODg4OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMDo0NDowMlrOHRl4_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMTowMToyOFrOHRmbnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwODYzOQ==", "bodyText": "Is this just a log improvement? The logic is not impacted by this PR's change, right?", "url": "https://github.com/apache/helix/pull/1362#discussion_r488208639", "createdAt": "2020-09-14T20:44:02Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -980,9 +980,10 @@ public TaskState pollForJobState(String workflowName, String jobName, long timeo\n         && System.currentTimeMillis() < st + timeout);\n \n     if (ctx == null || !allowedStates.contains(ctx.getJobState(jobName))) {\n-      throw new HelixException(\n-          String.format(\"Workflow \\\"%s\\\" context is null or job \\\"%s\\\" is not in states: %s\",\n-              workflowName, jobName, allowedStates));\n+      String cur = ctx == null ? \"null\" : ctx.getJobState(jobName).toString();\n+      throw new HelixException(String.format(\n+          \"Workflow \\\"%s\\\" context is null or job \\\"%s\\\" is not in states: %s, cur state is: %s\",\n+          workflowName, jobName, allowedStates, cur));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIxNzUwMw==", "bodyText": "Yes it is a log improvement. I personally find the new log more helpful when debugging. Since we are comparing two states, printing out the expected state and actually state could be more useful.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488217503", "createdAt": "2020-09-14T21:01:28Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -980,9 +980,10 @@ public TaskState pollForJobState(String workflowName, String jobName, long timeo\n         && System.currentTimeMillis() < st + timeout);\n \n     if (ctx == null || !allowedStates.contains(ctx.getJobState(jobName))) {\n-      throw new HelixException(\n-          String.format(\"Workflow \\\"%s\\\" context is null or job \\\"%s\\\" is not in states: %s\",\n-              workflowName, jobName, allowedStates));\n+      String cur = ctx == null ? \"null\" : ctx.getJobState(jobName).toString();\n+      throw new HelixException(String.format(\n+          \"Workflow \\\"%s\\\" context is null or job \\\"%s\\\" is not in states: %s, cur state is: %s\",\n+          workflowName, jobName, allowedStates, cur));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwODYzOQ=="}, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NDU4OTE4OnYy", "diffSide": "RIGHT", "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMDo1MDozMVrOHRmFqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMDo1MDozMVrOHRmFqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIxMTg4MA==", "bodyText": "The test name is wrong here.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488211880", "createdAt": "2020-09-14T20:50:31Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "diffHunk": "@@ -377,6 +414,55 @@ public void testDuplicatedMessage() throws InterruptedException {\n     System.out.println(\"END TestHelixTaskExecutor.testDuplicatedMessage()\");\n   }\n \n+  @Test()\n+  public void testStaledMessage() throws InterruptedException {\n+    System.out.println(\"START TestHelixTaskExecutor.testStaledMessage()\");\n+    HelixTaskExecutor executor = new HelixTaskExecutor();\n+    HelixManager manager = new MockClusterManager();\n+    HelixDataAccessor dataAccessor = manager.getHelixDataAccessor();\n+    PropertyKey.Builder keyBuilder = dataAccessor.keyBuilder();\n+\n+    TestStateTransitionHandlerFactory stateTransitionFactory =\n+        new TestStateTransitionHandlerFactory(Message.MessageType.STATE_TRANSITION.name(), 1000);\n+    executor.registerMessageHandlerFactory(Message.MessageType.STATE_TRANSITION.name(),\n+        stateTransitionFactory);\n+\n+    NotificationContext changeContext = new NotificationContext(manager);\n+    List<Message> msgList = new ArrayList<Message>();\n+\n+    int nMsgs = 1;\n+    String instanceName = manager.getInstanceName();\n+    for (int i = 0; i < nMsgs; i++) {\n+      Message msg =\n+          new Message(Message.MessageType.STATE_TRANSITION.name(), UUID.randomUUID().toString());\n+      msg.setTgtSessionId(manager.getSessionId());\n+      msg.setCreateTimeStamp((long) i);\n+      msg.setTgtName(\"Localhost_1123\");\n+      msg.setSrcName(\"127.101.1.23_2234\");\n+      msg.setPartitionName(\"Partition\");\n+      msg.setResourceName(\"testStaledMessageResource\");\n+      msg.setStateModelDef(\"DummyMasterSlave\");\n+      msg.setFromState(\"SLAVE\");\n+      msg.setToState(\"MASTER\");\n+      dataAccessor.setProperty(msg.getKey(keyBuilder, instanceName), msg);\n+      msgList.add(msg);\n+    }\n+\n+    Assert.assertEquals(dataAccessor.getChildValues(keyBuilder.messages(instanceName), true).size(),\n+            nMsgs);\n+\n+    changeContext.setChangeType(HelixConstants.ChangeType.MESSAGE);\n+    executor.onMessage(instanceName, msgList, changeContext);\n+\n+    Thread.sleep(200);\n+\n+    // The message should be ignored since toState is the same as current state.\n+    Assert.assertEquals(dataAccessor.getChildValues(keyBuilder.messages(instanceName), true).size(),\n+        0);\n+\n+    System.out.println(\"END TestHelixTaskExecutor.testDuplicatedMessage()\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 130}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NDYwMjQ2OnYy", "diffSide": "RIGHT", "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMDo1NDozMVrOHRmNtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMToyNjo0N1rOHRnLbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIxMzk0MA==", "bodyText": "How soon is the message gets deleted from instance?", "url": "https://github.com/apache/helix/pull/1362#discussion_r488213940", "createdAt": "2020-09-14T20:54:31Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "diffHunk": "@@ -377,6 +414,55 @@ public void testDuplicatedMessage() throws InterruptedException {\n     System.out.println(\"END TestHelixTaskExecutor.testDuplicatedMessage()\");\n   }\n \n+  @Test()\n+  public void testStaledMessage() throws InterruptedException {\n+    System.out.println(\"START TestHelixTaskExecutor.testStaledMessage()\");\n+    HelixTaskExecutor executor = new HelixTaskExecutor();\n+    HelixManager manager = new MockClusterManager();\n+    HelixDataAccessor dataAccessor = manager.getHelixDataAccessor();\n+    PropertyKey.Builder keyBuilder = dataAccessor.keyBuilder();\n+\n+    TestStateTransitionHandlerFactory stateTransitionFactory =\n+        new TestStateTransitionHandlerFactory(Message.MessageType.STATE_TRANSITION.name(), 1000);\n+    executor.registerMessageHandlerFactory(Message.MessageType.STATE_TRANSITION.name(),\n+        stateTransitionFactory);\n+\n+    NotificationContext changeContext = new NotificationContext(manager);\n+    List<Message> msgList = new ArrayList<Message>();\n+\n+    int nMsgs = 1;\n+    String instanceName = manager.getInstanceName();\n+    for (int i = 0; i < nMsgs; i++) {\n+      Message msg =\n+          new Message(Message.MessageType.STATE_TRANSITION.name(), UUID.randomUUID().toString());\n+      msg.setTgtSessionId(manager.getSessionId());\n+      msg.setCreateTimeStamp((long) i);\n+      msg.setTgtName(\"Localhost_1123\");\n+      msg.setSrcName(\"127.101.1.23_2234\");\n+      msg.setPartitionName(\"Partition\");\n+      msg.setResourceName(\"testStaledMessageResource\");\n+      msg.setStateModelDef(\"DummyMasterSlave\");\n+      msg.setFromState(\"SLAVE\");\n+      msg.setToState(\"MASTER\");\n+      dataAccessor.setProperty(msg.getKey(keyBuilder, instanceName), msg);\n+      msgList.add(msg);\n+    }\n+\n+    Assert.assertEquals(dataAccessor.getChildValues(keyBuilder.messages(instanceName), true).size(),\n+            nMsgs);\n+\n+    changeContext.setChangeType(HelixConstants.ChangeType.MESSAGE);\n+    executor.onMessage(instanceName, msgList, changeContext);\n+\n+    Thread.sleep(200);\n+\n+    // The message should be ignored since toState is the same as current state.\n+    Assert.assertEquals(dataAccessor.getChildValues(keyBuilder.messages(instanceName), true).size(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIyNTUxNg==", "bodyText": "In scheduling phase, HelixUtil.removeMessageFromZK will be called as soon as we hit the HelixDuplicatedStateTransitionException exception. There is no thread queueing in between. So I think it should be the IO delay time.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488225516", "createdAt": "2020-09-14T21:17:48Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "diffHunk": "@@ -377,6 +414,55 @@ public void testDuplicatedMessage() throws InterruptedException {\n     System.out.println(\"END TestHelixTaskExecutor.testDuplicatedMessage()\");\n   }\n \n+  @Test()\n+  public void testStaledMessage() throws InterruptedException {\n+    System.out.println(\"START TestHelixTaskExecutor.testStaledMessage()\");\n+    HelixTaskExecutor executor = new HelixTaskExecutor();\n+    HelixManager manager = new MockClusterManager();\n+    HelixDataAccessor dataAccessor = manager.getHelixDataAccessor();\n+    PropertyKey.Builder keyBuilder = dataAccessor.keyBuilder();\n+\n+    TestStateTransitionHandlerFactory stateTransitionFactory =\n+        new TestStateTransitionHandlerFactory(Message.MessageType.STATE_TRANSITION.name(), 1000);\n+    executor.registerMessageHandlerFactory(Message.MessageType.STATE_TRANSITION.name(),\n+        stateTransitionFactory);\n+\n+    NotificationContext changeContext = new NotificationContext(manager);\n+    List<Message> msgList = new ArrayList<Message>();\n+\n+    int nMsgs = 1;\n+    String instanceName = manager.getInstanceName();\n+    for (int i = 0; i < nMsgs; i++) {\n+      Message msg =\n+          new Message(Message.MessageType.STATE_TRANSITION.name(), UUID.randomUUID().toString());\n+      msg.setTgtSessionId(manager.getSessionId());\n+      msg.setCreateTimeStamp((long) i);\n+      msg.setTgtName(\"Localhost_1123\");\n+      msg.setSrcName(\"127.101.1.23_2234\");\n+      msg.setPartitionName(\"Partition\");\n+      msg.setResourceName(\"testStaledMessageResource\");\n+      msg.setStateModelDef(\"DummyMasterSlave\");\n+      msg.setFromState(\"SLAVE\");\n+      msg.setToState(\"MASTER\");\n+      dataAccessor.setProperty(msg.getKey(keyBuilder, instanceName), msg);\n+      msgList.add(msg);\n+    }\n+\n+    Assert.assertEquals(dataAccessor.getChildValues(keyBuilder.messages(instanceName), true).size(),\n+            nMsgs);\n+\n+    changeContext.setChangeType(HelixConstants.ChangeType.MESSAGE);\n+    executor.onMessage(instanceName, msgList, changeContext);\n+\n+    Thread.sleep(200);\n+\n+    // The message should be ignored since toState is the same as current state.\n+    Assert.assertEquals(dataAccessor.getChildValues(keyBuilder.messages(instanceName), true).size(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIxMzk0MA=="}, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIyOTc0MA==", "bodyText": "ok, that's fine. Asked cause I saw the 200ms sleep, just to confirm it immediately happens.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488229740", "createdAt": "2020-09-14T21:26:47Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "diffHunk": "@@ -377,6 +414,55 @@ public void testDuplicatedMessage() throws InterruptedException {\n     System.out.println(\"END TestHelixTaskExecutor.testDuplicatedMessage()\");\n   }\n \n+  @Test()\n+  public void testStaledMessage() throws InterruptedException {\n+    System.out.println(\"START TestHelixTaskExecutor.testStaledMessage()\");\n+    HelixTaskExecutor executor = new HelixTaskExecutor();\n+    HelixManager manager = new MockClusterManager();\n+    HelixDataAccessor dataAccessor = manager.getHelixDataAccessor();\n+    PropertyKey.Builder keyBuilder = dataAccessor.keyBuilder();\n+\n+    TestStateTransitionHandlerFactory stateTransitionFactory =\n+        new TestStateTransitionHandlerFactory(Message.MessageType.STATE_TRANSITION.name(), 1000);\n+    executor.registerMessageHandlerFactory(Message.MessageType.STATE_TRANSITION.name(),\n+        stateTransitionFactory);\n+\n+    NotificationContext changeContext = new NotificationContext(manager);\n+    List<Message> msgList = new ArrayList<Message>();\n+\n+    int nMsgs = 1;\n+    String instanceName = manager.getInstanceName();\n+    for (int i = 0; i < nMsgs; i++) {\n+      Message msg =\n+          new Message(Message.MessageType.STATE_TRANSITION.name(), UUID.randomUUID().toString());\n+      msg.setTgtSessionId(manager.getSessionId());\n+      msg.setCreateTimeStamp((long) i);\n+      msg.setTgtName(\"Localhost_1123\");\n+      msg.setSrcName(\"127.101.1.23_2234\");\n+      msg.setPartitionName(\"Partition\");\n+      msg.setResourceName(\"testStaledMessageResource\");\n+      msg.setStateModelDef(\"DummyMasterSlave\");\n+      msg.setFromState(\"SLAVE\");\n+      msg.setToState(\"MASTER\");\n+      dataAccessor.setProperty(msg.getKey(keyBuilder, instanceName), msg);\n+      msgList.add(msg);\n+    }\n+\n+    Assert.assertEquals(dataAccessor.getChildValues(keyBuilder.messages(instanceName), true).size(),\n+            nMsgs);\n+\n+    changeContext.setChangeType(HelixConstants.ChangeType.MESSAGE);\n+    executor.onMessage(instanceName, msgList, changeContext);\n+\n+    Thread.sleep(200);\n+\n+    // The message should be ignored since toState is the same as current state.\n+    Assert.assertEquals(dataAccessor.getChildValues(keyBuilder.messages(instanceName), true).size(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIxMzk0MA=="}, "originalCommit": {"oid": "54cc5c1bf937942dafb113ff4f76f44f4253688e"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NTIwOTEzOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMzo1ODo0MVrOHRrmdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMToxNDo0M1rOHRs62w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMjE5OQ==", "bodyText": "Usually, our validate method follows the same convention. It either returns boolean or void (in this case, throw an exception if invalid). I suggest we follow the same logic here.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488302199", "createdAt": "2020-09-14T23:58:41Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,35 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  public Exception validateStaleMessage(boolean inSchedulerCheck) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxOTUzNQ==", "bodyText": "Passing an additional boolean parameter is hard for the user to call. I suggest doing the following,\n\ncreate a private method \"private void validateStaleMessage(boolean checkFromState) {...}\"\ncreate a public method \"public void precheckForStaleMessage() {validateStaleMessage(true)}\"", "url": "https://github.com/apache/helix/pull/1362#discussion_r488319535", "createdAt": "2020-09-15T00:59:02Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,35 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  public Exception validateStaleMessage(boolean inSchedulerCheck) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMjE5OQ=="}, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyMzgwMw==", "bodyText": "TFTR. Will update.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488323803", "createdAt": "2020-09-15T01:14:43Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,35 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  public Exception validateStaleMessage(boolean inSchedulerCheck) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMjE5OQ=="}, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NTI5MzU0OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDo0MTo1MFrOHRsWwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMjowMzowMVrOHaDxqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNDU2MQ==", "bodyText": "I think we want to \"continue\" instead of throwing the Exception for more graceful handling.\nWe can do this:\n\"reportAndRemoveMessage(message, accessor, instanceName, ProcessedMessageState.DISCARDED);\"", "url": "https://github.com/apache/helix/pull/1362#discussion_r488314561", "createdAt": "2020-09-15T00:41:50Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);\n+            if (err != null) {\n+              throw err;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyMjQ0MA==", "bodyText": "We do continue when catch the exception (line 957). We could change the message if I think if the wording is not accurate in the catch block.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488322440", "createdAt": "2020-09-15T01:09:22Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);\n+            if (err != null) {\n+              throw err;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNDU2MQ=="}, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA0MzAwNw==", "bodyText": "try-catch is relatively expensive. And it might be misused if the caught exception is too wildly defined. So my suggestion is to handle the error case with regular logic as long as it is possible.", "url": "https://github.com/apache/helix/pull/1362#discussion_r494043007", "createdAt": "2020-09-24T05:13:53Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);\n+            if (err != null) {\n+              throw err;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNDU2MQ=="}, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA4Njg4OQ==", "bodyText": "Updated.", "url": "https://github.com/apache/helix/pull/1362#discussion_r497086889", "createdAt": "2020-09-29T22:03:01Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);\n+            if (err != null) {\n+              throw err;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNDU2MQ=="}, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NTI5ODQ4OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDo0NDoxOFrOHRsZng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNDo0MjoxNVrOHWWIww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNTI5NA==", "bodyText": "Same for this one. It is the existing logic, but this exception will be processed by the following catch, which records the error as \"Failed to create message handler...\". This seems to be inaccurate.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488315294", "createdAt": "2020-09-15T00:44:18Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);\n+            if (err != null) {\n+              throw err;\n+            }\n+          }\n+          if (stateTransitionHandlers.containsKey(messageTarget)) {\n+            // If there are 2 messages in same batch about same partition's state transition,\n+            // the later one is discarded\n+            Message duplicatedMessage = stateTransitionHandlers.get(messageTarget)._message;\n+            throw new HelixException(String.format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE5MzQxMQ==", "bodyText": "Updated.", "url": "https://github.com/apache/helix/pull/1362#discussion_r493193411", "createdAt": "2020-09-23T04:42:15Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);\n+            if (err != null) {\n+              throw err;\n+            }\n+          }\n+          if (stateTransitionHandlers.containsKey(messageTarget)) {\n+            // If there are 2 messages in same batch about same partition's state transition,\n+            // the later one is discarded\n+            Message duplicatedMessage = stateTransitionHandlers.get(messageTarget)._message;\n+            throw new HelixException(String.format(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNTI5NA=="}, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NTMwNzI5OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDo0ODo1MVrOHRsewA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDoyNjo0OFrOHVhM9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNjYwOA==", "bodyText": "Just curious, why we want this to happen later than the other 2?", "url": "https://github.com/apache/helix/pull/1362#discussion_r488316608", "createdAt": "2020-09-15T00:48:51Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);\n+            if (err != null) {\n+              throw err;\n+            }\n+          }\n+          if (stateTransitionHandlers.containsKey(messageTarget)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyMzc0NA==", "bodyText": "Please correct me if I am wrong. I think if we have an old O->S and a new S->M with current state is S. We do want to ignore the O->S and continue with S->M.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488323744", "createdAt": "2020-09-15T01:14:28Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);\n+            if (err != null) {\n+              throw err;\n+            }\n+          }\n+          if (stateTransitionHandlers.containsKey(messageTarget)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNjYwOA=="}, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgwNjE4Mw==", "bodyText": "So I think the logic changed here. Previously we always discard the later one (so it's possible we choose the stale one, which is the earlier one). But now we do a filtering first based on current state, and if the message is stale, we will directly delete it, and there won't be duplicated message exception at all. Is this the logic you think?", "url": "https://github.com/apache/helix/pull/1362#discussion_r491806183", "createdAt": "2020-09-21T05:57:11Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);\n+            if (err != null) {\n+              throw err;\n+            }\n+          }\n+          if (stateTransitionHandlers.containsKey(messageTarget)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNjYwOA=="}, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMyNjEzNA==", "bodyText": "Yes. We do a filtering first based on current state, and if the message is stale, we will directly delete it. (and we will throw exception as well, but not at the execution stage as before)\nAlthough there is no existing bug complaining 2 valid new messages at the same time, I think we should not assume there will be no duplicated messages so we should still keep the 3rd check.", "url": "https://github.com/apache/helix/pull/1362#discussion_r492326134", "createdAt": "2020-09-21T20:26:48Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);\n+            if (err != null) {\n+              throw err;\n+            }\n+          }\n+          if (stateTransitionHandlers.containsKey(messageTarget)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxNjYwOA=="}, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NTMzNDI5OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMTowMjozOVrOHRsuRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNDo0Mjo1MlrOHWWJVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyMDU4MQ==", "bodyText": "What will be wrong if we do validateStaleMessage(false) here? If it works, then we can have a common logic, right?", "url": "https://github.com/apache/helix/pull/1362#discussion_r488320581", "createdAt": "2020-09-15T01:02:39Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyNTYxNw==", "bodyText": "The handling for these two cases are different.\nFor the first case when toState == currentState, we just treat the task as succeeded and finish task. There is no difference between doing the no-op when executing and bypass the task at scheduling phase.\nIn the second case when currentState != fromState, executor will set the task as failed and report state transition error. Ir will also update ZK.\nHaving same logic causes a test fail. Controller keeps sending many 'INIT->RUNNING' message when currentState is TASK_ERROR if we don't report task error. Currently task error is reported in HelixStateTransitionHandler.", "url": "https://github.com/apache/helix/pull/1362#discussion_r488325617", "createdAt": "2020-09-15T01:21:07Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyMDU4MQ=="}, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE5MzU1OA==", "bodyText": "I had an offline sync with Ali. He has submit a PR to fix this issue (#1390). I changed my PR accordingly. We now do the same validation for scheduling stage and execution stage.\nCurrently my PR contains his patch. Will rebase after his PR merged.", "url": "https://github.com/apache/helix/pull/1362#discussion_r493193558", "createdAt": "2020-09-23T04:42:52Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixTaskExecutor.java", "diffHunk": "@@ -919,9 +912,25 @@ public void onMessage(String instanceName, List<Message> messages,\n             // discard the message. Controller will resend if this is a valid message\n             throw new HelixException(String.format(\n                 \"Another state transition for %s:%s is in progress with msg: %s, p2p: %s, read: %d, current:%d. Discarding %s->%s message\",\n-                message.getResourceName(), message.getPartitionName(), msg.getMsgId(), String.valueOf(msg.isRelayMessage()),\n-                msg.getReadTimeStamp(), System.currentTimeMillis(), message.getFromState(),\n-                message.getToState()));\n+                message.getResourceName(), message.getPartitionName(), msg.getMsgId(),\n+                String.valueOf(msg.isRelayMessage()), msg.getReadTimeStamp(),\n+                System.currentTimeMillis(), message.getFromState(), message.getToState()));\n+          }\n+          if (createHandler instanceof HelixStateTransitionHandler) {\n+            // We only check to state if there is no ST task scheduled/executing.\n+            Exception err = ((HelixStateTransitionHandler) createHandler).validateStaleMessage(true /*inSchedulerCheck*/);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyMDU4MQ=="}, "originalCommit": {"oid": "fcaa9c8f5ad166f6c6d9a01b530dc156fc9c3bc0"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDM4ODExOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMToxNTowOFrOHTEfNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNDo0MDoxNVrOHWWGqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1ODUxOA==", "bodyText": "Why we need this precheck flag? Two checks in onMessage and HelixTask execution validation logic should be same", "url": "https://github.com/apache/helix/pull/1362#discussion_r489758518", "createdAt": "2020-09-16T21:15:08Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,36 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  private void validateStaleMessage (boolean isPreCheck) throws Exception {\n+    String fromState = _message.getFromState();\n+    String toState = _message.getToState();\n+    String partitionName = _message.getPartitionName();\n+\n+    // state in _currentStateDelta uses current state from state model. It has the\n+    // most up-to-date. current state. In case currentState in stateModel is null,\n+    // partition is in initial state and we using it as current state.\n+    // Defined in HelixStateMachineEngine.\n+    String state = _currentStateDelta.getState(partitionName);\n+\n+    if (toState.equalsIgnoreCase(state)) {\n+      // To state equals current state, we can just ignore the message\n+      throw new HelixDuplicatedStateTransitionException(String\n+          .format(\"Partition %s current state is same as toState (%s->%s) from message.\",\n+              partitionName, fromState, toState));\n+    } else if (!isPreCheck && fromState != null && !fromState.equals(\"*\") && !fromState", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxMjI3OQ==", "bodyText": "TFTR.\nOriginally in HelixStateTransitionHandler, handling for these two cases are different.\nFor the first case when toState == currentState, we just treat the task as succeeded and finish task. There is no difference between doing the no-op when executing and bypass the task at scheduling phase.\nIn the second case when currentState != fromState, executor will set the task as failed and report state transition error. Ir will also update ZK.\nHaving same logic causes a test fail. Controller keeps sending many 'INIT->RUNNING' message when currentState is TASK_ERROR if we don't report task error. Currently task error is reported in HelixStateTransitionHandler.", "url": "https://github.com/apache/helix/pull/1362#discussion_r490412279", "createdAt": "2020-09-17T16:50:49Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,36 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  private void validateStaleMessage (boolean isPreCheck) throws Exception {\n+    String fromState = _message.getFromState();\n+    String toState = _message.getToState();\n+    String partitionName = _message.getPartitionName();\n+\n+    // state in _currentStateDelta uses current state from state model. It has the\n+    // most up-to-date. current state. In case currentState in stateModel is null,\n+    // partition is in initial state and we using it as current state.\n+    // Defined in HelixStateMachineEngine.\n+    String state = _currentStateDelta.getState(partitionName);\n+\n+    if (toState.equalsIgnoreCase(state)) {\n+      // To state equals current state, we can just ignore the message\n+      throw new HelixDuplicatedStateTransitionException(String\n+          .format(\"Partition %s current state is same as toState (%s->%s) from message.\",\n+              partitionName, fromState, toState));\n+    } else if (!isPreCheck && fromState != null && !fromState.equals(\"*\") && !fromState", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1ODUxOA=="}, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0ODk2NQ==", "bodyText": "For the test you talked about, I think we may need to understand why we keep sending message INIT -> RUNNING. Because once the message has been DROPPED, controller should refresh current state and get the TASK_ERROR state. Then we should have some message like TASK_ERROR -> INIT or something, if we miss it, we should fix the logic to make it more robust. And I am OK to not fix it in this PR. But if that's the case, let's propose another PR for that. Otherwise, this is not a complete scenario. For regular resource management, it is not a complete filtering logic.", "url": "https://github.com/apache/helix/pull/1362#discussion_r492248965", "createdAt": "2020-09-21T18:03:23Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,36 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  private void validateStaleMessage (boolean isPreCheck) throws Exception {\n+    String fromState = _message.getFromState();\n+    String toState = _message.getToState();\n+    String partitionName = _message.getPartitionName();\n+\n+    // state in _currentStateDelta uses current state from state model. It has the\n+    // most up-to-date. current state. In case currentState in stateModel is null,\n+    // partition is in initial state and we using it as current state.\n+    // Defined in HelixStateMachineEngine.\n+    String state = _currentStateDelta.getState(partitionName);\n+\n+    if (toState.equalsIgnoreCase(state)) {\n+      // To state equals current state, we can just ignore the message\n+      throw new HelixDuplicatedStateTransitionException(String\n+          .format(\"Partition %s current state is same as toState (%s->%s) from message.\",\n+              partitionName, fromState, toState));\n+    } else if (!isPreCheck && fromState != null && !fromState.equals(\"*\") && !fromState", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1ODUxOA=="}, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE5Mjg3NQ==", "bodyText": "I had an offline sync with Ali. He has submit a PR to fix this issue (#1390). I changed my PR accordingly. We now do the same validation for scheduling stage and execution stage.\nCurrently my PR contains his patch. Will rebase after his PR merged.", "url": "https://github.com/apache/helix/pull/1362#discussion_r493192875", "createdAt": "2020-09-23T04:40:15Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,36 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  private void validateStaleMessage (boolean isPreCheck) throws Exception {\n+    String fromState = _message.getFromState();\n+    String toState = _message.getToState();\n+    String partitionName = _message.getPartitionName();\n+\n+    // state in _currentStateDelta uses current state from state model. It has the\n+    // most up-to-date. current state. In case currentState in stateModel is null,\n+    // partition is in initial state and we using it as current state.\n+    // Defined in HelixStateMachineEngine.\n+    String state = _currentStateDelta.getState(partitionName);\n+\n+    if (toState.equalsIgnoreCase(state)) {\n+      // To state equals current state, we can just ignore the message\n+      throw new HelixDuplicatedStateTransitionException(String\n+          .format(\"Partition %s current state is same as toState (%s->%s) from message.\",\n+              partitionName, fromState, toState));\n+    } else if (!isPreCheck && fromState != null && !fromState.equals(\"*\") && !fromState", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1ODUxOA=="}, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDM5MTgwOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMToxNjoxMlrOHTEhVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxODo0MjoxNVrOHTwVVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1OTA2Mg==", "bodyText": "This is not duplicate state transition. Could be some STs are old in pending queue just not match what target state we have now.", "url": "https://github.com/apache/helix/pull/1362#discussion_r489759062", "createdAt": "2020-09-16T21:16:12Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,36 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  private void validateStaleMessage (boolean isPreCheck) throws Exception {\n+    String fromState = _message.getFromState();\n+    String toState = _message.getToState();\n+    String partitionName = _message.getPartitionName();\n+\n+    // state in _currentStateDelta uses current state from state model. It has the\n+    // most up-to-date. current state. In case currentState in stateModel is null,\n+    // partition is in initial state and we using it as current state.\n+    // Defined in HelixStateMachineEngine.\n+    String state = _currentStateDelta.getState(partitionName);\n+\n+    if (toState.equalsIgnoreCase(state)) {\n+      // To state equals current state, we can just ignore the message\n+      throw new HelixDuplicatedStateTransitionException(String", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQwNzA1MA==", "bodyText": "If it already been processed (in READ or UNPROCESSABLE state) then we would ignore the ST message before this check. (line 856 in HelixTaskExecutor)", "url": "https://github.com/apache/helix/pull/1362#discussion_r490407050", "createdAt": "2020-09-17T16:42:55Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,36 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  private void validateStaleMessage (boolean isPreCheck) throws Exception {\n+    String fromState = _message.getFromState();\n+    String toState = _message.getToState();\n+    String partitionName = _message.getPartitionName();\n+\n+    // state in _currentStateDelta uses current state from state model. It has the\n+    // most up-to-date. current state. In case currentState in stateModel is null,\n+    // partition is in initial state and we using it as current state.\n+    // Defined in HelixStateMachineEngine.\n+    String state = _currentStateDelta.getState(partitionName);\n+\n+    if (toState.equalsIgnoreCase(state)) {\n+      // To state equals current state, we can just ignore the message\n+      throw new HelixDuplicatedStateTransitionException(String", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1OTA2Mg=="}, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ3MDQxNg==", "bodyText": "What I am trying to say is not use HelixDuplicatedStateTransitionException, because there could be other cases for this scenario. If we check log, we may get confused for new check logic.", "url": "https://github.com/apache/helix/pull/1362#discussion_r490470416", "createdAt": "2020-09-17T18:30:18Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,36 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  private void validateStaleMessage (boolean isPreCheck) throws Exception {\n+    String fromState = _message.getFromState();\n+    String toState = _message.getToState();\n+    String partitionName = _message.getPartitionName();\n+\n+    // state in _currentStateDelta uses current state from state model. It has the\n+    // most up-to-date. current state. In case currentState in stateModel is null,\n+    // partition is in initial state and we using it as current state.\n+    // Defined in HelixStateMachineEngine.\n+    String state = _currentStateDelta.getState(partitionName);\n+\n+    if (toState.equalsIgnoreCase(state)) {\n+      // To state equals current state, we can just ignore the message\n+      throw new HelixDuplicatedStateTransitionException(String", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1OTA2Mg=="}, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ3Njg4NQ==", "bodyText": "Thanks for the follow up.\nIn my understanding, this message must be a new message generated by controller, maybe caused by reading the old currentState etc.\nSince this is a new message, doesn't this count as DuplicatedStateTransition?", "url": "https://github.com/apache/helix/pull/1362#discussion_r490476885", "createdAt": "2020-09-17T18:42:15Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -463,6 +442,36 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n \n   }\n \n+  // Verify the fromState and current state of the stateModel.\n+  private void validateStaleMessage (boolean isPreCheck) throws Exception {\n+    String fromState = _message.getFromState();\n+    String toState = _message.getToState();\n+    String partitionName = _message.getPartitionName();\n+\n+    // state in _currentStateDelta uses current state from state model. It has the\n+    // most up-to-date. current state. In case currentState in stateModel is null,\n+    // partition is in initial state and we using it as current state.\n+    // Defined in HelixStateMachineEngine.\n+    String state = _currentStateDelta.getState(partitionName);\n+\n+    if (toState.equalsIgnoreCase(state)) {\n+      // To state equals current state, we can just ignore the message\n+      throw new HelixDuplicatedStateTransitionException(String", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1OTA2Mg=="}, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDc1MjcyOnYy", "diffSide": "RIGHT", "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNzoyNzoxNlrOHUBSBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDoxODozM1rOHVg8kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc1NDU2NA==", "bodyText": "equals() should be used to check the string names are the same.\n!= checks if they are the same object: same memory address, etc..", "url": "https://github.com/apache/helix/pull/1362#discussion_r490754564", "createdAt": "2020-09-18T07:27:16Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "diffHunk": "@@ -232,11 +248,29 @@ public HelixTaskResult handleMessage() throws InterruptedException {\n       @Override\n       public void onError(Exception e, ErrorCode code, ErrorType type) {\n       }\n+\n+      @Override\n+      public void precheckForStaleMessage() throws Exception {\n+        if (_testIsMessageStaled) {\n+          super.precheckForStaleMessage();\n+        }\n+      }\n     }\n \n     @Override\n     public MessageHandler createHandler(Message message, NotificationContext context) {\n-      return new TestStateTransitionMessageHandler(message, context);\n+      if (message.getResourceName()!=\"testStaledMessageResource\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMyMTkzOA==", "bodyText": "TFTR. Updated.", "url": "https://github.com/apache/helix/pull/1362#discussion_r492321938", "createdAt": "2020-09-21T20:18:33Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "diffHunk": "@@ -232,11 +248,29 @@ public HelixTaskResult handleMessage() throws InterruptedException {\n       @Override\n       public void onError(Exception e, ErrorCode code, ErrorType type) {\n       }\n+\n+      @Override\n+      public void precheckForStaleMessage() throws Exception {\n+        if (_testIsMessageStaled) {\n+          super.precheckForStaleMessage();\n+        }\n+      }\n     }\n \n     @Override\n     public MessageHandler createHandler(Message message, NotificationContext context) {\n-      return new TestStateTransitionMessageHandler(message, context);\n+      if (message.getResourceName()!=\"testStaledMessageResource\") {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc1NDU2NA=="}, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDc2NDUxOnYy", "diffSide": "RIGHT", "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNzozMToxMlrOHUBZKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMDozMzowM1rOHZOk-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc1NjM5NQ==", "bodyText": "Can you help understand why we need to assert instead of throwing an InterruptedException?", "url": "https://github.com/apache/helix/pull/1362#discussion_r490756395", "createdAt": "2020-09-18T07:31:12Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "diffHunk": "@@ -212,18 +213,33 @@ public TestStateTransitionHandlerFactory(String msgType, long delay) {\n       _delay = delay;\n     }\n \n-    class TestStateTransitionMessageHandler extends MessageHandler {\n+    class TestStateTransitionMessageHandler extends HelixStateTransitionHandler {\n+      boolean _testIsMessageStaled;\n+\n       public TestStateTransitionMessageHandler(Message message, NotificationContext context) {\n-        super(message, context);\n+        super(null, null, message, context, null);\n+        _testIsMessageStaled = false;\n+      }\n+\n+      public TestStateTransitionMessageHandler(Message message, NotificationContext context,\n+          CurrentState currentStateDelta) {\n+        super(null, null, message, context, currentStateDelta);\n+        _testIsMessageStaled = true;\n+\n+\n       }\n \n       @Override\n-      public HelixTaskResult handleMessage() throws InterruptedException {\n+      public HelixTaskResult handleMessage() {\n         HelixTaskResult result = new HelixTaskResult();\n         _processedMsgIds.put(_message.getMsgId(), _message.getMsgId());\n         if (_delay > 0) {\n           System.out.println(\"Sleeping...\" + _delay);\n-          Thread.sleep(_delay);\n+          try{\n+            Thread.sleep(_delay);\n+          } catch (Exception e) {\n+            assert (false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMyMDg5Mw==", "bodyText": "I think the reason is that the base handleMessage does not throw exception. The try-catch block here is only for handle exceptions in test.", "url": "https://github.com/apache/helix/pull/1362#discussion_r492320893", "createdAt": "2020-09-21T20:16:30Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "diffHunk": "@@ -212,18 +213,33 @@ public TestStateTransitionHandlerFactory(String msgType, long delay) {\n       _delay = delay;\n     }\n \n-    class TestStateTransitionMessageHandler extends MessageHandler {\n+    class TestStateTransitionMessageHandler extends HelixStateTransitionHandler {\n+      boolean _testIsMessageStaled;\n+\n       public TestStateTransitionMessageHandler(Message message, NotificationContext context) {\n-        super(message, context);\n+        super(null, null, message, context, null);\n+        _testIsMessageStaled = false;\n+      }\n+\n+      public TestStateTransitionMessageHandler(Message message, NotificationContext context,\n+          CurrentState currentStateDelta) {\n+        super(null, null, message, context, currentStateDelta);\n+        _testIsMessageStaled = true;\n+\n+\n       }\n \n       @Override\n-      public HelixTaskResult handleMessage() throws InterruptedException {\n+      public HelixTaskResult handleMessage() {\n         HelixTaskResult result = new HelixTaskResult();\n         _processedMsgIds.put(_message.getMsgId(), _message.getMsgId());\n         if (_delay > 0) {\n           System.out.println(\"Sleeping...\" + _delay);\n-          Thread.sleep(_delay);\n+          try{\n+            Thread.sleep(_delay);\n+          } catch (Exception e) {\n+            assert (false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc1NjM5NQ=="}, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyOTEwNQ==", "bodyText": "I don't think we need this change, as throwing an InterruptedException is good enough and cleaner to fail the test, unless the upstream caller catches and swallows the InterruptedException", "url": "https://github.com/apache/helix/pull/1362#discussion_r495429105", "createdAt": "2020-09-26T07:52:14Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "diffHunk": "@@ -212,18 +213,33 @@ public TestStateTransitionHandlerFactory(String msgType, long delay) {\n       _delay = delay;\n     }\n \n-    class TestStateTransitionMessageHandler extends MessageHandler {\n+    class TestStateTransitionMessageHandler extends HelixStateTransitionHandler {\n+      boolean _testIsMessageStaled;\n+\n       public TestStateTransitionMessageHandler(Message message, NotificationContext context) {\n-        super(message, context);\n+        super(null, null, message, context, null);\n+        _testIsMessageStaled = false;\n+      }\n+\n+      public TestStateTransitionMessageHandler(Message message, NotificationContext context,\n+          CurrentState currentStateDelta) {\n+        super(null, null, message, context, currentStateDelta);\n+        _testIsMessageStaled = true;\n+\n+\n       }\n \n       @Override\n-      public HelixTaskResult handleMessage() throws InterruptedException {\n+      public HelixTaskResult handleMessage() {\n         HelixTaskResult result = new HelixTaskResult();\n         _processedMsgIds.put(_message.getMsgId(), _message.getMsgId());\n         if (_delay > 0) {\n           System.out.println(\"Sleeping...\" + _delay);\n-          Thread.sleep(_delay);\n+          try{\n+            Thread.sleep(_delay);\n+          } catch (Exception e) {\n+            assert (false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc1NjM5NQ=="}, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjIxNTI4OQ==", "bodyText": "Please correct me if I am wrong.\nFor the InterruptedException, we need to either catch it or add a declaration in method signature. Since the HelixStateTransitionHandler.handleMessage() does not throw exception, we could only do a try-catch here.", "url": "https://github.com/apache/helix/pull/1362#discussion_r496215289", "createdAt": "2020-09-28T20:33:03Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/test/java/org/apache/helix/messaging/handling/TestHelixTaskExecutor.java", "diffHunk": "@@ -212,18 +213,33 @@ public TestStateTransitionHandlerFactory(String msgType, long delay) {\n       _delay = delay;\n     }\n \n-    class TestStateTransitionMessageHandler extends MessageHandler {\n+    class TestStateTransitionMessageHandler extends HelixStateTransitionHandler {\n+      boolean _testIsMessageStaled;\n+\n       public TestStateTransitionMessageHandler(Message message, NotificationContext context) {\n-        super(message, context);\n+        super(null, null, message, context, null);\n+        _testIsMessageStaled = false;\n+      }\n+\n+      public TestStateTransitionMessageHandler(Message message, NotificationContext context,\n+          CurrentState currentStateDelta) {\n+        super(null, null, message, context, currentStateDelta);\n+        _testIsMessageStaled = true;\n+\n+\n       }\n \n       @Override\n-      public HelixTaskResult handleMessage() throws InterruptedException {\n+      public HelixTaskResult handleMessage() {\n         HelixTaskResult result = new HelixTaskResult();\n         _processedMsgIds.put(_message.getMsgId(), _message.getMsgId());\n         if (_delay > 0) {\n           System.out.println(\"Sleeping...\" + _delay);\n-          Thread.sleep(_delay);\n+          try{\n+            Thread.sleep(_delay);\n+          } catch (Exception e) {\n+            assert (false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc1NjM5NQ=="}, "originalCommit": {"oid": "911cce77470432229c4997dd5bac878985bdc5fc"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMDg4Nzk3OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwODowMDoyOVrOHYeoZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMDoxMjoyNVrOHeDxYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyOTczNA==", "bodyText": "staleMessageValidator sounds more like a class/variable name. How about changing the method name to a verb style: validateStaleMessage() (it does something)?", "url": "https://github.com/apache/helix/pull/1362#discussion_r495429734", "createdAt": "2020-09-26T08:00:29Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -460,7 +438,33 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n       StateTransitionError error = new StateTransitionError(type, code, e);\n       _stateModel.rollbackOnError(_message, _notificationContext, error);\n     }\n+  }\n+\n+  // Verify the fromState and current state of the stateModel.\n+  public Exception staleMessageValidator() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25fb5ce8eb474e1c6701a1d4838044c30875d147"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQxMjczOA==", "bodyText": "In my understanding, validateXXX is a function throws exception and returns void or boolean. Since I have a function that returns an exception, I am not sure about the name validateXXX.", "url": "https://github.com/apache/helix/pull/1362#discussion_r498412738", "createdAt": "2020-10-01T17:40:47Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -460,7 +438,33 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n       StateTransitionError error = new StateTransitionError(type, code, e);\n       _stateModel.rollbackOnError(_message, _notificationContext, error);\n     }\n+  }\n+\n+  // Verify the fromState and current state of the stateModel.\n+  public Exception staleMessageValidator() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyOTczNA=="}, "originalCommit": {"oid": "25fb5ce8eb474e1c6701a1d4838044c30875d147"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU0OTMyNw==", "bodyText": "nit, it would be more graceful to define a ValidationResult class and contain a boolean (pass or not) and an optional Exception. Especially as a public method. Is there a chance we can make it protected or package private?", "url": "https://github.com/apache/helix/pull/1362#discussion_r498549327", "createdAt": "2020-10-01T22:49:59Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -460,7 +438,33 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n       StateTransitionError error = new StateTransitionError(type, code, e);\n       _stateModel.rollbackOnError(_message, _notificationContext, error);\n     }\n+  }\n+\n+  // Verify the fromState and current state of the stateModel.\n+  public Exception staleMessageValidator() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyOTczNA=="}, "originalCommit": {"oid": "25fb5ce8eb474e1c6701a1d4838044c30875d147"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MDI4NA==", "bodyText": "We are not using the boolean return value. May I ask is this for a cleaner interface purpose for further usage?", "url": "https://github.com/apache/helix/pull/1362#discussion_r499050284", "createdAt": "2020-10-02T21:05:49Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -460,7 +438,33 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n       StateTransitionError error = new StateTransitionError(type, code, e);\n       _stateModel.rollbackOnError(_message, _notificationContext, error);\n     }\n+  }\n+\n+  // Verify the fromState and current state of the stateModel.\n+  public Exception staleMessageValidator() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyOTczNA=="}, "originalCommit": {"oid": "25fb5ce8eb474e1c6701a1d4838044c30875d147"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI4MTEyMQ==", "bodyText": "Updated.", "url": "https://github.com/apache/helix/pull/1362#discussion_r501281121", "createdAt": "2020-10-07T20:12:25Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -460,7 +438,33 @@ public void onError(Exception e, ErrorCode code, ErrorType type) {\n       StateTransitionError error = new StateTransitionError(type, code, e);\n       _stateModel.rollbackOnError(_message, _notificationContext, error);\n     }\n+  }\n+\n+  // Verify the fromState and current state of the stateModel.\n+  public Exception staleMessageValidator() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyOTczNA=="}, "originalCommit": {"oid": "25fb5ce8eb474e1c6701a1d4838044c30875d147"}, "originalPosition": 70}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 957, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}