{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0NzIwNzE1", "number": 1231, "title": "Terminal State Job Purging", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nFixes #1230\nDescription\n\n\n Here are some details about my PR, including screenshots of any UI changes:\n\n\nA new field is added to JobConfig in order to support terminal state job purging: TerminalStateExpiry. Necessary functions are implemented to support the new field.\n\n\nA new set of logic is added to TaskGarbageCollectionStage. When purging jobs, terminal state jobs will be considered based on the new expiry value. In addition, a \"failed job propagation\" logic is put in place. This accounts for the jobs that fail due to parental job failures, because these jobs would not have JobContexts, preventing them to be purged through normal means; with the propagation logic they can be purged along with the failed parental jobs.\n\n\nModify scheduleJobCleanUp usage to correctly reflect the expiry used. The previous code wasn't necessary as FAILED jobs were not cleaned up anyways, but now it has a meaning.\n\n\nModify jobDispatcher to honor TIMED_OUT job states.\n\n\nTests\n\n The following tests are written for this issue:\n\ntestJobQueueFailedCleanUp, testJobQueueTimedOutCleanUp, testGetExpiredJobsFromCacheFailPropagation\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n[ERROR] Tests run: 1169, Failures: 5, Errors: 0, Skipped: 1, Time elapsed: 4,517.039 s <<< FAILURE! - in TestSuite\n[ERROR] testResourceSubset(org.apache.helix.tools.TestClusterStateVerifier)  Time elapsed: 1.028 s  <<< FAILURE!\norg.apache.helix.HelixException: Failed to create pause signal\n        at org.apache.helix.tools.TestClusterStateVerifier.testResourceSubset(TestClusterStateVerifier.java:115)\n\n[ERROR] afterMethod(org.apache.helix.tools.TestClusterStateVerifier)  Time elapsed: 1.064 s  <<< FAILURE!\njava.lang.IllegalStateException: ZkClient already closed!\n        at org.apache.helix.tools.TestClusterStateVerifier.afterMethod(TestClusterStateVerifier.java:98)\n\n[ERROR] TestMessageSimpleSendReceiveAsync(org.apache.helix.integration.messaging.TestCrossClusterMessagingService)  Time elapsed: 2.118 s  <<< FAILURE!\njava.lang.AssertionError: \n        at org.apache.helix.integration.messaging.TestCrossClusterMessagingService.TestMessageSimpleSendReceiveAsync(TestCrossClusterMessagingService.java:145)\n\n[ERROR] testEnableCompressionResource(org.apache.helix.integration.TestEnableCompression)  Time elapsed: 168.201 s  <<< FAILURE!\njava.lang.AssertionError: expected:<true> but was:<false>\n        at org.apache.helix.integration.TestEnableCompression.testEnableCompressionResource(TestEnableCompression.java:117)\n\n[ERROR] testStateTransitionTimeOut(org.apache.helix.integration.paticipant.TestStateTransitionTimeoutWithResource)  Time elapsed: 36.072 s  <<< FAILURE!\njava.lang.AssertionError: expected:<true> but was:<false>\n        at org.apache.helix.integration.paticipant.TestStateTransitionTimeoutWithResource.testStateTransitionTimeOut(TestStateTransitionTimeoutWithResource.java:171)\n\n[INFO] \n[INFO] Results:\n[INFO] \n[ERROR] Failures: \n[ERROR]   TestEnableCompression.testEnableCompressionResource:117 expected:<true> but was:<false>\n[ERROR]   TestCrossClusterMessagingService.TestMessageSimpleSendReceiveAsync:145\n[ERROR]   TestStateTransitionTimeoutWithResource.testStateTransitionTimeOut:171 expected:<true> but was:<false>\n[ERROR]   TestClusterStateVerifier.afterMethod:98 \u00bb IllegalState ZkClient already closed...\n[ERROR]   TestClusterStateVerifier.testResourceSubset:115 \u00bb Helix Failed to create pause...\n[INFO] \n[ERROR] Tests run: 1169, Failures: 5, Errors: 0, Skipped: 1\n[INFO] \n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD FAILURE\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  01:15 h\n[INFO] Finished at: 2020-08-13T13:11:21-07:00\n[INFO] ------------------------------------------------------------------------\n\nRerun\n[ERROR] Tests run: 11, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 77.624 s <<< FAILURE! - in TestSuite\n[ERROR] afterMethod(org.apache.helix.tools.TestClusterStateVerifier)  Time elapsed: 1.13 s  <<< FAILURE!\njava.lang.IllegalStateException: ZkClient already closed!\n        at org.apache.helix.tools.TestClusterStateVerifier.afterMethod(TestClusterStateVerifier.java:98)\n\n[INFO] \n[INFO] Results:\n[INFO] \n[ERROR] Failures: \n[ERROR]   TestClusterStateVerifier.afterMethod:98 \u00bb IllegalState ZkClient already closed...\n[INFO] \n[ERROR] Tests run: 11, Failures: 1, Errors: 0, Skipped: 0\n[INFO] \n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD FAILURE\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  01:22 min\n[INFO] Finished at: 2020-08-13T14:10:06-07:00\n[INFO] ------------------------------------------------------------------------\n\nRerun\n[INFO] Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 9.392 s - in org.apache.helix.tools.TestClusterStateVerifier\n[INFO] \n[INFO] Results:\n[INFO] \n[INFO] Tests run: 2, Failures: 0, Errors: 0, Skipped: 0\n[INFO] \n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  14.566 s\n[INFO] Finished at: 2020-08-13T14:12:20-07:00\n[INFO] ------------------------------------------------------------------------\n\nCommits\n\nMy commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\nMy diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-08-07T17:07:45Z", "url": "https://github.com/apache/helix/pull/1231", "merged": true, "mergeCommit": {"oid": "e163efc4de07a67069fdbd4effd19729158fa832"}, "closed": true, "closedAt": "2020-08-13T23:45:33Z", "author": {"login": "NealSun96"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8FhvXgH2gAyNDY0NzIwNzE1OjU5NGZkYzEzNDE0NjBmMjEwNWFiMzMzN2U0MDg4NWUwOWE3YWZlMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-oeVDgFqTQ2NzE5MjE5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "594fdc1341460f2105ab3337e40885e09a7afe32", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/594fdc1341460f2105ab3337e40885e09a7afe32", "committedDate": "2020-08-06T01:27:55Z", "message": "Add purging logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dab99125126f8ad611a7f176b44d5d415df71b75", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/dab99125126f8ad611a7f176b44d5d415df71b75", "committedDate": "2020-08-06T06:24:43Z", "message": "modify rebalance schedule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c13b9e14584a997dec86b3ca4c4974e266780d0", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/5c13b9e14584a997dec86b3ca4c4974e266780d0", "committedDate": "2020-08-06T22:31:31Z", "message": "added test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNTIxMDMw", "url": "https://github.com/apache/helix/pull/1231#pullrequestreview-463521030", "createdAt": "2020-08-07T18:31:37Z", "commit": {"oid": "5c13b9e14584a997dec86b3ca4c4974e266780d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxODozMTozOFrOG9j44w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxODozMTozOFrOG9j44w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIwNDMyMw==", "bodyText": "This may not be a good idea for that. It means user has to add a new config for each their job. And the existing running jobs and tasks are not benefiting from that.\nIf we really want to support that, my suggestion is to have a global TASK config similar to cluster config. Let them enable for failed/timeout job purge. That would be much easier for user.", "url": "https://github.com/apache/helix/pull/1231#discussion_r467204323", "createdAt": "2020-08-07T18:31:38Z", "author": {"login": "junkaixue"}, "path": "helix-core/src/main/java/org/apache/helix/task/JobConfig.java", "diffHunk": "@@ -147,10 +147,17 @@\n     StartTime,\n \n     /**\n-     * The expiration time for the job\n+     * The expiration time for the job if it's completed; once the expiry is reached and the job is\n+     * completed, the job will be purged\n      */\n     Expiry,\n \n+    /**\n+     * The expiration time for the job if it's failed or timed out; once the expiry is reached and\n+     * the job has failed or timed out, the job will be purged\n+     */\n+    TerminalStateExpiry,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c13b9e14584a997dec86b3ca4c4974e266780d0"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c21e30fb8a600c49d5ca07c8a4da07fec75f2cf2", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/c21e30fb8a600c49d5ca07c8a4da07fec75f2cf2", "committedDate": "2020-08-07T19:08:26Z", "message": "Flaky tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNjcyNTcy", "url": "https://github.com/apache/helix/pull/1231#pullrequestreview-463672572", "createdAt": "2020-08-07T22:33:12Z", "commit": {"oid": "c21e30fb8a600c49d5ca07c8a4da07fec75f2cf2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMjozMzoxMlrOG9qj3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMjozNTo1OVrOG9qmsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMzYzMA==", "bodyText": "maybe it is better to change this comment to failed, complete and time_out. Because there are other terminal states as well.", "url": "https://github.com/apache/helix/pull/1231#discussion_r467313630", "createdAt": "2020-08-07T22:33:12Z", "author": {"login": "alirezazamani"}, "path": "helix-core/src/main/java/org/apache/helix/task/JobDispatcher.java", "diffHunk": "@@ -87,9 +87,10 @@ public ResourceAssignment processJobStatusUpdateAndAssignment(String jobName,\n     TaskState jobState = workflowCtx.getJobState(jobName);\n     // The job is already in a final state (completed/failed).\n     if (workflowState == TaskState.FAILED || workflowState == TaskState.COMPLETED\n-        || jobState == TaskState.FAILED || jobState == TaskState.COMPLETED) {\n+        || jobState == TaskState.FAILED || jobState == TaskState.COMPLETED\n+        || jobState == TaskState.TIMED_OUT) {\n       LOG.info(String.format(\n-          \"Workflow %s or job %s is already failed or completed, workflow state (%s), job state (%s), clean up job IS.\",\n+          \"Workflow %s or job %s is already in final state, workflow state (%s), job state (%s), clean up job IS.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c21e30fb8a600c49d5ca07c8a4da07fec75f2cf2"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxNDM1NA==", "bodyText": "Can you confirm if jobState here is not null always?", "url": "https://github.com/apache/helix/pull/1231#discussion_r467314354", "createdAt": "2020-08-07T22:35:59Z", "author": {"login": "alirezazamani"}, "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -733,10 +734,29 @@ protected static boolean removeJobsFromWorkflow(final HelixDataAccessor dataAcce\n     if (workflowContext != null) {\n       Map<String, TaskState> jobStates = workflowContext.getJobStates();\n       for (String job : workflowConfig.getJobDag().getAllNodes()) {\n+        if (expiredJobs.contains(job)) {\n+          continue;\n+        }\n         JobConfig jobConfig = TaskUtil.getJobConfig(dataAccessor, job);\n         JobContext jobContext = TaskUtil.getJobContext(propertyStore, job);\n-        if (isJobExpired(job, jobConfig, jobContext, jobStates.get(job))) {\n+        TaskState jobState = jobStates.get(job);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c21e30fb8a600c49d5ca07c8a4da07fec75f2cf2"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60f08cf84baf4d10abe573b7644820494b7d7ed9", "author": {"user": null}, "url": "https://github.com/apache/helix/commit/60f08cf84baf4d10abe573b7644820494b7d7ed9", "committedDate": "2020-08-13T18:53:56Z", "message": "Nit change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTkxNjE5", "url": "https://github.com/apache/helix/pull/1231#pullrequestreview-467191619", "createdAt": "2020-08-13T23:16:58Z", "commit": {"oid": "60f08cf84baf4d10abe573b7644820494b7d7ed9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTkyMTkw", "url": "https://github.com/apache/helix/pull/1231#pullrequestreview-467192190", "createdAt": "2020-08-13T23:18:43Z", "commit": {"oid": "60f08cf84baf4d10abe573b7644820494b7d7ed9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4204, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}