{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNjc2MDMx", "number": 836, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo0NDozOFrODligSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo1MToxNFrODlio5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNjg5MjI3OnYy", "diffSide": "RIGHT", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo0NDozOFrOFyfctg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOToyMjoxNFrOFygxcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ4ODM3NA==", "bodyText": "This should be concurrentHashMap()", "url": "https://github.com/apache/helix/pull/836#discussion_r388488374", "createdAt": "2020-03-05T18:44:38Z", "author": {"login": "kaisun2000"}, "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java", "diffHunk": "@@ -41,13 +42,17 @@\n \n \n public class HttpRoutingDataReader {\n-  private static final String MSDS_ENDPOINT =\n+  private static final String SYSTEM_MSDS_ENDPOINT =\n       System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_ENDPOINT_KEY);\n   private static final int HTTP_TIMEOUT_IN_MS = 5000;\n \n   /** Double-checked locking requires that the following fields be volatile */\n-  private static volatile Map<String, List<String>> _rawRoutingData;\n-  private static volatile MetadataStoreRoutingData _metadataStoreRoutingData;\n+  // The following map stands for (MSDS endpoint, Raw Routing Data)\n+  private static volatile Map<String, Map<String, List<String>>> _rawRoutingDataMap =\n+      new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "099d11f3fb9bfe182f7e56607fdbc24f18c1cf8a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUxMDA2NQ==", "bodyText": "Will change in another PR.", "url": "https://github.com/apache/helix/pull/836#discussion_r388510065", "createdAt": "2020-03-05T19:22:14Z", "author": {"login": "narendly"}, "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java", "diffHunk": "@@ -41,13 +42,17 @@\n \n \n public class HttpRoutingDataReader {\n-  private static final String MSDS_ENDPOINT =\n+  private static final String SYSTEM_MSDS_ENDPOINT =\n       System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_ENDPOINT_KEY);\n   private static final int HTTP_TIMEOUT_IN_MS = 5000;\n \n   /** Double-checked locking requires that the following fields be volatile */\n-  private static volatile Map<String, List<String>> _rawRoutingData;\n-  private static volatile MetadataStoreRoutingData _metadataStoreRoutingData;\n+  // The following map stands for (MSDS endpoint, Raw Routing Data)\n+  private static volatile Map<String, Map<String, List<String>>> _rawRoutingDataMap =\n+      new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ4ODM3NA=="}, "originalCommit": {"oid": "099d11f3fb9bfe182f7e56607fdbc24f18c1cf8a"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNjg5MzE5OnYy", "diffSide": "RIGHT", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo0NDo1OFrOFyfdXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo0NDo1OFrOFyfdXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ4ODU0Mg==", "bodyText": "concurrentHashMap()", "url": "https://github.com/apache/helix/pull/836#discussion_r388488542", "createdAt": "2020-03-05T18:44:58Z", "author": {"login": "kaisun2000"}, "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java", "diffHunk": "@@ -41,13 +42,17 @@\n \n \n public class HttpRoutingDataReader {\n-  private static final String MSDS_ENDPOINT =\n+  private static final String SYSTEM_MSDS_ENDPOINT =\n       System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_ENDPOINT_KEY);\n   private static final int HTTP_TIMEOUT_IN_MS = 5000;\n \n   /** Double-checked locking requires that the following fields be volatile */\n-  private static volatile Map<String, List<String>> _rawRoutingData;\n-  private static volatile MetadataStoreRoutingData _metadataStoreRoutingData;\n+  // The following map stands for (MSDS endpoint, Raw Routing Data)\n+  private static volatile Map<String, Map<String, List<String>>> _rawRoutingDataMap =\n+      new HashMap<>();\n+  // The following map stands for (MSDS endpoint, MetadataStoreRoutingData)\n+  private static volatile Map<String, MetadataStoreRoutingData> _metadataStoreRoutingDataMap =\n+      new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "099d11f3fb9bfe182f7e56607fdbc24f18c1cf8a"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNjg5OTcwOnYy", "diffSide": "RIGHT", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo0Njo1NlrOFyfhbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo0Njo1NlrOFyfhbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ4OTU4Mg==", "bodyText": "Here, multiple thread can reach this get and thus we should use concurrentHashmap. Declaring it to volatile is not enough.\nSee my previous discussion with @pkuwm in the federatedZkClient.", "url": "https://github.com/apache/helix/pull/836#discussion_r388489582", "createdAt": "2020-03-05T18:46:56Z", "author": {"login": "kaisun2000"}, "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java", "diffHunk": "@@ -56,44 +61,78 @@ private HttpRoutingDataReader() {\n   }\n \n   /**\n-   * Fetches routing data from the data source via HTTP.\n-   * @return a mapping from \"metadata store realm addresses\" to lists of\n-   * \"metadata store sharding keys\", where the sharding keys in a value list all route to\n-   * the realm address in the key disallows a meaningful mapping to be returned\n+   * Fetches routing data from the data source via HTTP by querying the MSDS configured in the JVM config.\n+   * @return\n+   * @throws IOException\n    */\n   public static Map<String, List<String>> getRawRoutingData() throws IOException {\n-    if (MSDS_ENDPOINT == null || MSDS_ENDPOINT.isEmpty()) {\n+    if (SYSTEM_MSDS_ENDPOINT == null || SYSTEM_MSDS_ENDPOINT.isEmpty()) {\n       throw new IllegalStateException(\n           \"HttpRoutingDataReader was unable to find a valid MSDS endpoint String in System Properties!\");\n     }\n-    if (_rawRoutingData == null) {\n+    return getRawRoutingData(SYSTEM_MSDS_ENDPOINT);\n+  }\n+\n+  /**\n+   * Fetches routing data from the data source via HTTP.\n+   * @return a mapping from \"metadata store realm addresses\" to lists of\n+   * \"metadata store sharding keys\", where the sharding keys in a value list all route to\n+   * the realm address in the key disallows a meaningful mapping to be returned.\n+   * @param msdsEndpoint Metadata Store Directory Store endpoint to query from\n+   */\n+  public static Map<String, List<String>> getRawRoutingData(String msdsEndpoint)\n+      throws IOException {\n+    Map<String, List<String>> rawRoutingData = _rawRoutingDataMap.get(msdsEndpoint);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "099d11f3fb9bfe182f7e56607fdbc24f18c1cf8a"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNjkxNDI5OnYy", "diffSide": "RIGHT", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo1MToxNFrOFyfqfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOToyMTozOFrOFygv7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MTkwMA==", "bodyText": "In fact, if my understanding is correct, we people use this one, for one product, there is only one SYSTEM_MSDS_ENDPOINT would be defined. Say storagesystem1, or storagesystem2. They can't co-exist. Put it another way, this map the first key field would alway have only one value, right?\nI guess the intention is that to make this httproutingdatareader servering multiple namespaces (storagesystem1, storagesysgtem2). In reality, they would still serve only one.\nOr am I missing something here?", "url": "https://github.com/apache/helix/pull/836#discussion_r388491900", "createdAt": "2020-03-05T18:51:14Z", "author": {"login": "kaisun2000"}, "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java", "diffHunk": "@@ -41,13 +42,17 @@\n \n \n public class HttpRoutingDataReader {\n-  private static final String MSDS_ENDPOINT =\n+  private static final String SYSTEM_MSDS_ENDPOINT =\n       System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_ENDPOINT_KEY);\n   private static final int HTTP_TIMEOUT_IN_MS = 5000;\n \n   /** Double-checked locking requires that the following fields be volatile */\n-  private static volatile Map<String, List<String>> _rawRoutingData;\n-  private static volatile MetadataStoreRoutingData _metadataStoreRoutingData;\n+  // The following map stands for (MSDS endpoint, Raw Routing Data)\n+  private static volatile Map<String, Map<String, List<String>>> _rawRoutingDataMap =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "099d11f3fb9bfe182f7e56607fdbc24f18c1cf8a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUwOTY3OA==", "bodyText": "Serves a single namespace. However, this is done this way to allow HttpRoutingDataReader to support multiple regions.", "url": "https://github.com/apache/helix/pull/836#discussion_r388509678", "createdAt": "2020-03-05T19:21:38Z", "author": {"login": "narendly"}, "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java", "diffHunk": "@@ -41,13 +42,17 @@\n \n \n public class HttpRoutingDataReader {\n-  private static final String MSDS_ENDPOINT =\n+  private static final String SYSTEM_MSDS_ENDPOINT =\n       System.getProperty(MetadataStoreRoutingConstants.MSDS_SERVER_ENDPOINT_KEY);\n   private static final int HTTP_TIMEOUT_IN_MS = 5000;\n \n   /** Double-checked locking requires that the following fields be volatile */\n-  private static volatile Map<String, List<String>> _rawRoutingData;\n-  private static volatile MetadataStoreRoutingData _metadataStoreRoutingData;\n+  // The following map stands for (MSDS endpoint, Raw Routing Data)\n+  private static volatile Map<String, Map<String, List<String>>> _rawRoutingDataMap =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MTkwMA=="}, "originalCommit": {"oid": "099d11f3fb9bfe182f7e56607fdbc24f18c1cf8a"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1715, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}