{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0ODM1NjY0", "number": 1580, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMjoyOToxNVrOFDK2qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxOTo0MDo0OFrOFDpoOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4ODY3ODgwOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMjoyOToxNVrOICscdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMjo1ODoyOFrOICtW9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY5NjI0Nw==", "bodyText": "why here we use getClusterConfig() while later in setClusterConfig we use _clusterConfig?\nIn fact,\n  public ClusterConfig getClusterConfig() {\n    return _clusterConfig;\n  }\n\nany specific reason?", "url": "https://github.com/apache/helix/pull/1580#discussion_r539696247", "createdAt": "2020-12-09T22:29:15Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "diffHunk": "@@ -384,8 +384,8 @@ public synchronized void refresh(HelixDataAccessor accessor) {\n     _instanceMessagesCache.updateRelayMessages(_liveInstanceCache.getPropertyMap(),\n         _currentStateCache.getParticipantStatesMap());\n \n-    updateIdealRuleMap();\n-    updateDisabledInstances();\n+    updateIdealRuleMap(getClusterConfig());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b941a3c65dcae92990d0aa52bb00523801733250"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY5ODU5NA==", "bodyText": "This seems to be a non-essential change?", "url": "https://github.com/apache/helix/pull/1580#discussion_r539698594", "createdAt": "2020-12-09T22:33:07Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "diffHunk": "@@ -384,8 +384,8 @@ public synchronized void refresh(HelixDataAccessor accessor) {\n     _instanceMessagesCache.updateRelayMessages(_liveInstanceCache.getPropertyMap(),\n         _currentStateCache.getParticipantStatesMap());\n \n-    updateIdealRuleMap();\n-    updateDisabledInstances();\n+    updateIdealRuleMap(getClusterConfig());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY5NjI0Nw=="}, "originalCommit": {"oid": "b941a3c65dcae92990d0aa52bb00523801733250"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcxMTIyMw==", "bodyText": "Because setClusterConfig() is where you update _clusterConfig. And here, it is using it as an input.\nIt is a good practice that we don't refer to a private field directly in a private method. Note that the main reason no one calls this method to update for now is that we hide it too deep, so no one remembers. If the parameters are explicitly passed, meaning input and output are clearly divided, then we avoid potential bugs.\nSo, IMO this is tightly related to this change.", "url": "https://github.com/apache/helix/pull/1580#discussion_r539711223", "createdAt": "2020-12-09T22:58:28Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "diffHunk": "@@ -384,8 +384,8 @@ public synchronized void refresh(HelixDataAccessor accessor) {\n     _instanceMessagesCache.updateRelayMessages(_liveInstanceCache.getPropertyMap(),\n         _currentStateCache.getParticipantStatesMap());\n \n-    updateIdealRuleMap();\n-    updateDisabledInstances();\n+    updateIdealRuleMap(getClusterConfig());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY5NjI0Nw=="}, "originalCommit": {"oid": "b941a3c65dcae92990d0aa52bb00523801733250"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4ODczMzk0OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMjo0NDozNFrOICs8bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMjo1ODo1OFrOICtX7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcwNDQzMQ==", "bodyText": "again, is clusterConfig passed in would always to the same as _clusterConfig?", "url": "https://github.com/apache/helix/pull/1580#discussion_r539704431", "createdAt": "2020-12-09T22:44:34Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "diffHunk": "@@ -744,30 +747,31 @@ private void updateOfflineInstanceHistory(HelixDataAccessor accessor) {\n     _updateInstanceOfflineTime = false;\n   }\n \n-  private void updateDisabledInstances() {\n+  private void updateDisabledInstances(Collection<InstanceConfig> instanceConfigs,\n+      ClusterConfig clusterConfig) {\n     // Move the calculating disabled instances to refresh\n     _disabledInstanceForPartitionMap.clear();\n     _disabledInstanceSet.clear();\n-    for (InstanceConfig config : _instanceConfigCache.getPropertyMap().values()) {\n+    for (InstanceConfig config : instanceConfigs) {\n       Map<String, List<String>> disabledPartitionMap = config.getDisabledPartitionsMap();\n       if (!config.getInstanceEnabled()) {\n         _disabledInstanceSet.add(config.getInstanceName());\n       }\n       for (String resource : disabledPartitionMap.keySet()) {\n         if (!_disabledInstanceForPartitionMap.containsKey(resource)) {\n-          _disabledInstanceForPartitionMap.put(resource, new HashMap<String, Set<String>>());\n+          _disabledInstanceForPartitionMap.put(resource, new HashMap<>());\n         }\n         for (String partition : disabledPartitionMap.get(resource)) {\n           if (!_disabledInstanceForPartitionMap.get(resource).containsKey(partition)) {\n-            _disabledInstanceForPartitionMap.get(resource).put(partition, new HashSet<String>());\n+            _disabledInstanceForPartitionMap.get(resource).put(partition, new HashSet<>());\n           }\n           _disabledInstanceForPartitionMap.get(resource).get(partition)\n               .add(config.getInstanceName());\n         }\n       }\n     }\n-    if (_clusterConfig != null && _clusterConfig.getDisabledInstances() != null) {\n-      _disabledInstanceSet.addAll(_clusterConfig.getDisabledInstances().keySet());\n+    if (clusterConfig != null && clusterConfig.getDisabledInstances() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b941a3c65dcae92990d0aa52bb00523801733250"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcxMTQ3MA==", "bodyText": "Please refer to the previous comment.", "url": "https://github.com/apache/helix/pull/1580#discussion_r539711470", "createdAt": "2020-12-09T22:58:58Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "diffHunk": "@@ -744,30 +747,31 @@ private void updateOfflineInstanceHistory(HelixDataAccessor accessor) {\n     _updateInstanceOfflineTime = false;\n   }\n \n-  private void updateDisabledInstances() {\n+  private void updateDisabledInstances(Collection<InstanceConfig> instanceConfigs,\n+      ClusterConfig clusterConfig) {\n     // Move the calculating disabled instances to refresh\n     _disabledInstanceForPartitionMap.clear();\n     _disabledInstanceSet.clear();\n-    for (InstanceConfig config : _instanceConfigCache.getPropertyMap().values()) {\n+    for (InstanceConfig config : instanceConfigs) {\n       Map<String, List<String>> disabledPartitionMap = config.getDisabledPartitionsMap();\n       if (!config.getInstanceEnabled()) {\n         _disabledInstanceSet.add(config.getInstanceName());\n       }\n       for (String resource : disabledPartitionMap.keySet()) {\n         if (!_disabledInstanceForPartitionMap.containsKey(resource)) {\n-          _disabledInstanceForPartitionMap.put(resource, new HashMap<String, Set<String>>());\n+          _disabledInstanceForPartitionMap.put(resource, new HashMap<>());\n         }\n         for (String partition : disabledPartitionMap.get(resource)) {\n           if (!_disabledInstanceForPartitionMap.get(resource).containsKey(partition)) {\n-            _disabledInstanceForPartitionMap.get(resource).put(partition, new HashSet<String>());\n+            _disabledInstanceForPartitionMap.get(resource).put(partition, new HashSet<>());\n           }\n           _disabledInstanceForPartitionMap.get(resource).get(partition)\n               .add(config.getInstanceName());\n         }\n       }\n     }\n-    if (_clusterConfig != null && _clusterConfig.getDisabledInstances() != null) {\n-      _disabledInstanceSet.addAll(_clusterConfig.getDisabledInstances().keySet());\n+    if (clusterConfig != null && clusterConfig.getDisabledInstances() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcwNDQzMQ=="}, "originalCommit": {"oid": "b941a3c65dcae92990d0aa52bb00523801733250"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4ODc1NTY3OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMjo1MDo1NVrOICtItg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMjo1OToyMFrOICtYlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcwNzU3NA==", "bodyText": "This seems to be non-essential too, right? The problem is in the setClusterConfig and setInstanceConfig", "url": "https://github.com/apache/helix/pull/1580#discussion_r539707574", "createdAt": "2020-12-09T22:50:55Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "diffHunk": "@@ -384,8 +384,8 @@ public synchronized void refresh(HelixDataAccessor accessor) {\n     _instanceMessagesCache.updateRelayMessages(_liveInstanceCache.getPropertyMap(),\n         _currentStateCache.getParticipantStatesMap());\n \n-    updateIdealRuleMap();\n-    updateDisabledInstances();\n+    updateIdealRuleMap(getClusterConfig());\n+    updateDisabledInstances(getInstanceConfigMap().values(), getClusterConfig());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b941a3c65dcae92990d0aa52bb00523801733250"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcxMTYzNw==", "bodyText": "This is to improve the style so we lower the chance of making such a mistake again.", "url": "https://github.com/apache/helix/pull/1580#discussion_r539711637", "createdAt": "2020-12-09T22:59:20Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "diffHunk": "@@ -384,8 +384,8 @@ public synchronized void refresh(HelixDataAccessor accessor) {\n     _instanceMessagesCache.updateRelayMessages(_liveInstanceCache.getPropertyMap(),\n         _currentStateCache.getParticipantStatesMap());\n \n-    updateIdealRuleMap();\n-    updateDisabledInstances();\n+    updateIdealRuleMap(getClusterConfig());\n+    updateDisabledInstances(getInstanceConfigMap().values(), getClusterConfig());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcwNzU3NA=="}, "originalCommit": {"oid": "b941a3c65dcae92990d0aa52bb00523801733250"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5MzcyMDkxOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxOTo0MDo0OFrOIDaNGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMDoyNDozMlrOIGeeXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ0NTk3Nw==", "bodyText": "Then why this place we don't use getClusterConfig().\nEither way it is find to me. But please do use one approach.", "url": "https://github.com/apache/helix/pull/1580#discussion_r540445977", "createdAt": "2020-12-10T19:40:48Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "diffHunk": "@@ -418,6 +418,8 @@ public ClusterConfig getClusterConfig() {\n   public void setClusterConfig(ClusterConfig clusterConfig) {\n     _clusterConfig = clusterConfig;\n     refreshAbnormalStateResolverMap(_clusterConfig);\n+    updateIdealRuleMap(_clusterConfig);\n+    updateDisabledInstances(getInstanceConfigMap().values(), _clusterConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b941a3c65dcae92990d0aa52bb00523801733250"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY4ODk2OQ==", "bodyText": "I can change to \"clusterConfig\" instead of \"_clusterConfig\". But it makes very little difference.\ngetClusterConfig() is a different story. It is in set method, we should not call get method in a set method. It is just confusing.\nLet's don't make it too complicated. My target is just to remove all the unnecessary private field references. And this specific method is a set method. It is necessary.", "url": "https://github.com/apache/helix/pull/1580#discussion_r540688969", "createdAt": "2020-12-11T04:50:56Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "diffHunk": "@@ -418,6 +418,8 @@ public ClusterConfig getClusterConfig() {\n   public void setClusterConfig(ClusterConfig clusterConfig) {\n     _clusterConfig = clusterConfig;\n     refreshAbnormalStateResolverMap(_clusterConfig);\n+    updateIdealRuleMap(_clusterConfig);\n+    updateDisabledInstances(getInstanceConfigMap().values(), _clusterConfig);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ0NTk3Nw=="}, "originalCommit": {"oid": "b941a3c65dcae92990d0aa52bb00523801733250"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NjI5OQ==", "bodyText": "I think I might need to clarify it a little bit more. Since you seem to be confused by the style things...\nI'm not sure what is the \"approach\" that you refer to... Calling the method or referring to the private fields are both OK. They are actually the same thing, right? Unless the method has some concurrent control or so.\nI don't see any reason why we have to use getClusterConfig() or _clusterConfig or clusterConfig in this context. They make a minor difference. If I have to compare getClusterConfig() is the worst, since it triggers one more method call.\nThe difference is whether you pass the INPUT as the method parameters or directly refer to the private fields. This makes a difference. The latter introduces hidden dependencies between different private things. So this style is not good.\nThis is the small improvement that I'm trying to do here.\nAnd obviously, this rule is not applicable in the set methods. Because they have to refer to the private fields, right?", "url": "https://github.com/apache/helix/pull/1580#discussion_r540696299", "createdAt": "2020-12-11T05:15:55Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "diffHunk": "@@ -418,6 +418,8 @@ public ClusterConfig getClusterConfig() {\n   public void setClusterConfig(ClusterConfig clusterConfig) {\n     _clusterConfig = clusterConfig;\n     refreshAbnormalStateResolverMap(_clusterConfig);\n+    updateIdealRuleMap(_clusterConfig);\n+    updateDisabledInstances(getInstanceConfigMap().values(), _clusterConfig);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ0NTk3Nw=="}, "originalCommit": {"oid": "b941a3c65dcae92990d0aa52bb00523801733250"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2MTY2Mw==", "bodyText": "Feel free to resolve this comment thread. The reason I ask is not for styling. It is that initially I not sure about the intention. I thought getInstanceConfigMap() had some tricks inside and that was why we did not use _configMap. If it is styling, no such intention, then either way is fine to me. Making them same style would also be good, but up to you.", "url": "https://github.com/apache/helix/pull/1580#discussion_r543661663", "createdAt": "2020-12-15T20:24:32Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/BaseControllerDataProvider.java", "diffHunk": "@@ -418,6 +418,8 @@ public ClusterConfig getClusterConfig() {\n   public void setClusterConfig(ClusterConfig clusterConfig) {\n     _clusterConfig = clusterConfig;\n     refreshAbnormalStateResolverMap(_clusterConfig);\n+    updateIdealRuleMap(_clusterConfig);\n+    updateDisabledInstances(getInstanceConfigMap().values(), _clusterConfig);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ0NTk3Nw=="}, "originalCommit": {"oid": "b941a3c65dcae92990d0aa52bb00523801733250"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 846, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}