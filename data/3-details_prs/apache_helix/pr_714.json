{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5ODM3NzM5", "number": 714, "title": "Create data accessor interface and ZkRoutingDataAccessor", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nFixes #713\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nThis PR adds an interface and an implementation for metadata store routing data accessing. The interface works directly with MetadataStoreRoutingData, acting as an abstract layer that allows the data to be accessed from different sources. The implementation focuses on accessing data from ZooKeeper.\nTests\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n[INFO] Tests run: 100, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 20.581 s - in TestSuite\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 100, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  25.231 s\n[INFO] Finished at: 2020-01-31T17:53:37-08:00\n[INFO] ------------------------------------------------------------------------\nCommits\n\n My commits all reference appropriate Apache Helix GitHub issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\n My diff has been formatted using helix-style.xml", "createdAt": "2020-02-01T01:57:39Z", "url": "https://github.com/apache/helix/pull/714", "merged": true, "mergeCommit": {"oid": "14afdbe1262a2c33c327a8ee715f1eac168e5a7a"}, "closed": true, "closedAt": "2020-02-05T01:53:17Z", "author": {"login": "NealSun96"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_5ybvAH2gAyMzY5ODM3NzM5OjMxY2EwYzM1NDY2OTE5YjE4MDZjNzUyYjI2ZmUyYzllOTM4M2I4ZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBMDtRgFqTM1MzQyMDM0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "31ca0c35466919b1806c752b26fe2c9e9383b8e5", "author": {"user": {"login": "NealSun96", "name": "Neal Sun"}}, "url": "https://github.com/apache/helix/commit/31ca0c35466919b1806c752b26fe2c9e9383b8e5", "committedDate": "2020-02-01T01:51:50Z", "message": "create data accessor interface and impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a2a8f472f4f74752f8eed6df14268ad61fab2cb", "author": {"user": {"login": "NealSun96", "name": "Neal Sun"}}, "url": "https://github.com/apache/helix/commit/7a2a8f472f4f74752f8eed6df14268ad61fab2cb", "committedDate": "2020-02-01T01:57:59Z", "message": "remove placeholder test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTEwODg4", "url": "https://github.com/apache/helix/pull/714#pullrequestreview-351910888", "createdAt": "2020-02-01T23:58:47Z", "commit": {"oid": "7a2a8f472f4f74752f8eed6df14268ad61fab2cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQyMzo1ODo0OFrOFkfhBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQyMzo1ODo0OFrOFkfhBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwOTQxNA==", "bodyText": "This class can extend AbstractTestClass and you could use one of its ZKs instantiated in that class.", "url": "https://github.com/apache/helix/pull/714#discussion_r373809414", "createdAt": "2020-02-01T23:58:48Z", "author": {"login": "narendly"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/metadatastore/TestZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+\n+public class TestZkRoutingDataAccessor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a2a8f472f4f74752f8eed6df14268ad61fab2cb"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTEwOTMy", "url": "https://github.com/apache/helix/pull/714#pullrequestreview-351910932", "createdAt": "2020-02-02T00:00:34Z", "commit": {"oid": "7a2a8f472f4f74752f8eed6df14268ad61fab2cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQwMDowMDozNFrOFkfhNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQwMDowMDozNFrOFkfhNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwOTQ2MQ==", "bodyText": "Shouldn't it be something like \"ZK_PATH_SHARDING_KEYS\" instead of \"addresses\"? Also, let's make \"ZK_PATH_SHARDING_KEYS\" a constant.", "url": "https://github.com/apache/helix/pull/714#discussion_r373809461", "createdAt": "2020-02-02T00:00:34Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+\n+public class ZkRoutingDataAccessor implements MetadataStoreRoutingDataAccessor {\n+  private static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataAccessor(String zkAddress) {\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() {\n+    Map<String, List<String>> result = new HashMap<>();\n+    List<String> children = _zkClient.getChildren(ROUTING_DATA_PATH);\n+    for (String child : children) {\n+      ZNRecord record = _zkClient.readData(ROUTING_DATA_PATH + \"/\" + child);\n+      result.put(child, record.getListField(\"addresses\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a2a8f472f4f74752f8eed6df14268ad61fab2cb"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12aae11bd120380fdc6c00ae8f4e2ac945dc2290", "author": {"user": {"login": "NealSun96", "name": "Neal Sun"}}, "url": "https://github.com/apache/helix/commit/12aae11bd120380fdc6c00ae8f4e2ac945dc2290", "committedDate": "2020-02-03T23:16:11Z", "message": "create test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNjQyODY0", "url": "https://github.com/apache/helix/pull/714#pullrequestreview-352642864", "createdAt": "2020-02-03T23:48:52Z", "commit": {"oid": "12aae11bd120380fdc6c00ae8f4e2ac945dc2290"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzo0ODo1MlrOFlD8Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMzo0ODo1MlrOFlD8Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNjIzNQ==", "bodyText": "There could be a few cases where you might have to validate the status of the routing data in the metadata store.\n\nDo we have the ROUTING_DATA_PATH path set?\nDo we have any metadata stores registered under that path?\nWhat if there are no keys registered?\n\nLet's alert the user appropriately for each scenario - by adding sanity checks.", "url": "https://github.com/apache/helix/pull/714#discussion_r374406235", "createdAt": "2020-02-03T23:48:52Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+\n+public class ZkRoutingDataAccessor implements MetadataStoreRoutingDataAccessor {\n+  private static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  private static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";\n+\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataAccessor(String zkAddress) {\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() {\n+    Map<String, List<String>> result = new HashMap<>();\n+    List<String> children = _zkClient.getChildren(ROUTING_DATA_PATH);\n+    for (String child : children) {\n+      ZNRecord record = _zkClient.readData(ROUTING_DATA_PATH + \"/\" + child);\n+      List<String> shardingKeys = record.getListField(ZNRECORD_LIST_FIELD_KEY);\n+      if (shardingKeys != null) {\n+        result.put(child, shardingKeys);\n+      }\n+    }\n+    return result;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12aae11bd120380fdc6c00ae8f4e2ac945dc2290"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNzExOTkx", "url": "https://github.com/apache/helix/pull/714#pullrequestreview-352711991", "createdAt": "2020-02-04T03:59:37Z", "commit": {"oid": "12aae11bd120380fdc6c00ae8f4e2ac945dc2290"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMzo1OTozN1rOFlHdsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMzo1OTozN1rOFlHdsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ2MzkyMg==", "bodyText": "Note that this will be implementing IZKDataListener, IZkChildListener, and IZkStateChangeListener interfaces in other PRs.", "url": "https://github.com/apache/helix/pull/714#discussion_r374463922", "createdAt": "2020-02-04T03:59:37Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+\n+public class ZkRoutingDataAccessor implements MetadataStoreRoutingDataAccessor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12aae11bd120380fdc6c00ae8f4e2ac945dc2290"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542", "author": {"user": {"login": "NealSun96", "name": "Neal Sun"}}, "url": "https://github.com/apache/helix/commit/7afdaa3b3b339b5a3e1ffaa9a4d080da30490542", "committedDate": "2020-02-04T18:36:57Z", "message": "add exception throwing behaviour"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMjc3MTc0", "url": "https://github.com/apache/helix/pull/714#pullrequestreview-353277174", "createdAt": "2020-02-04T20:26:13Z", "commit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMDoyNjoxM1rOFliUyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMDozMDo0OVrOFlicrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkwNDAwOQ==", "bodyText": "It is better to clear name it as InvalidZKRoutingDataException.", "url": "https://github.com/apache/helix/pull/714#discussion_r374904009", "createdAt": "2020-02-04T20:26:13Z", "author": {"login": "junkaixue"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/exceptions/InvalidRoutingDataException.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package org.apache.helix.rest.metadatastore.exceptions;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+/**\n+ * This exception is thrown by MetadataStoreRoutingDataAccessor when the routing data it's trying to\n+ * access is malformed and is there invalid.\n+ */\n+public class InvalidRoutingDataException extends Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkwNDYyNg==", "bodyText": "Do you see any potentials to use these constants in other classes? If yes, shall we have a separate class as ZKRoutingConstant or something to hold these constants?", "url": "https://github.com/apache/helix/pull/714#discussion_r374904626", "createdAt": "2020-02-04T20:27:39Z", "author": {"login": "junkaixue"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+public class ZkRoutingDataAccessor implements MetadataStoreRoutingDataAccessor {\n+  private static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  private static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkwNjAyOQ==", "bodyText": "What's the reason for these two different scenario? I think shardingKeys list handled by us, right? Do you see the case of shardingKeys is empty?", "url": "https://github.com/apache/helix/pull/714#discussion_r374906029", "createdAt": "2020-02-04T20:30:49Z", "author": {"login": "junkaixue"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+public class ZkRoutingDataAccessor implements MetadataStoreRoutingDataAccessor {\n+  private static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  private static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";\n+\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataAccessor(String zkAddress) {\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() throws InvalidRoutingDataException {\n+    Map<String, List<String>> result = new HashMap<>();\n+    if (!_zkClient.exists(ROUTING_DATA_PATH)) {\n+      throw new InvalidRoutingDataException(ROUTING_DATA_PATH + \" node doesn't exist.\");\n+    }\n+    List<String> children = _zkClient.getChildren(ROUTING_DATA_PATH);\n+    if (children.isEmpty()) {\n+      throw new InvalidRoutingDataException(ROUTING_DATA_PATH + \" does not have any child node.\");\n+    }\n+    for (String child : children) {\n+      ZNRecord record = _zkClient.readData(ROUTING_DATA_PATH + \"/\" + child);\n+      List<String> shardingKeys = record.getListField(ZNRECORD_LIST_FIELD_KEY);\n+      if (shardingKeys == null) {\n+        throw new InvalidRoutingDataException(ROUTING_DATA_PATH + \"/\" + child\n+            + \" does not have the key \" + ZNRECORD_LIST_FIELD_KEY + \".\");\n+      }\n+      if (shardingKeys.isEmpty()) {\n+        throw new InvalidRoutingDataException(ROUTING_DATA_PATH + \"/\" + child\n+            + \" has an empty value for the key \" + ZNRECORD_LIST_FIELD_KEY + \".\");\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMjg5MjY4", "url": "https://github.com/apache/helix/pull/714#pullrequestreview-353289268", "createdAt": "2020-02-04T20:47:04Z", "commit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMDo0NzowNFrOFli5oQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMDo0NzowNFrOFli5oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxMzQ0MQ==", "bodyText": "Let's use:\n\"Routing data directory \" + ROUTING_DATA_PATH + \" does not exist! Routing ZooKeeper: \" + zkAddress", "url": "https://github.com/apache/helix/pull/714#discussion_r374913441", "createdAt": "2020-02-04T20:47:04Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+public class ZkRoutingDataAccessor implements MetadataStoreRoutingDataAccessor {\n+  private static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  private static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";\n+\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataAccessor(String zkAddress) {\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() throws InvalidRoutingDataException {\n+    Map<String, List<String>> result = new HashMap<>();\n+    if (!_zkClient.exists(ROUTING_DATA_PATH)) {\n+      throw new InvalidRoutingDataException(ROUTING_DATA_PATH + \" node doesn't exist.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMjkwNTM3", "url": "https://github.com/apache/helix/pull/714#pullrequestreview-353290537", "createdAt": "2020-02-04T20:49:10Z", "commit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMDo0OToxMVrOFli9fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMDo1Njo0NFrOFljLdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxNDQyOQ==", "bodyText": "What about namespaces?\n\"There are no namespaces found in this routing ZooKeeper! Routing ZooKeeper: \" + zkAddress", "url": "https://github.com/apache/helix/pull/714#discussion_r374914429", "createdAt": "2020-02-04T20:49:11Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+public class ZkRoutingDataAccessor implements MetadataStoreRoutingDataAccessor {\n+  private static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  private static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";\n+\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataAccessor(String zkAddress) {\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() throws InvalidRoutingDataException {\n+    Map<String, List<String>> result = new HashMap<>();\n+    if (!_zkClient.exists(ROUTING_DATA_PATH)) {\n+      throw new InvalidRoutingDataException(ROUTING_DATA_PATH + \" node doesn't exist.\");\n+    }\n+    List<String> children = _zkClient.getChildren(ROUTING_DATA_PATH);\n+    if (children.isEmpty()) {\n+      throw new InvalidRoutingDataException(ROUTING_DATA_PATH + \" does not have any child node.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxNjEwMQ==", "bodyText": "+1. We could create a constant class.", "url": "https://github.com/apache/helix/pull/714#discussion_r374916101", "createdAt": "2020-02-04T20:52:45Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+public class ZkRoutingDataAccessor implements MetadataStoreRoutingDataAccessor {\n+  private static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  private static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkwNDYyNg=="}, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxNjk3OQ==", "bodyText": "These two cases could probably be merged.", "url": "https://github.com/apache/helix/pull/714#discussion_r374916979", "createdAt": "2020-02-04T20:54:41Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+public class ZkRoutingDataAccessor implements MetadataStoreRoutingDataAccessor {\n+  private static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  private static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";\n+\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataAccessor(String zkAddress) {\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() throws InvalidRoutingDataException {\n+    Map<String, List<String>> result = new HashMap<>();\n+    if (!_zkClient.exists(ROUTING_DATA_PATH)) {\n+      throw new InvalidRoutingDataException(ROUTING_DATA_PATH + \" node doesn't exist.\");\n+    }\n+    List<String> children = _zkClient.getChildren(ROUTING_DATA_PATH);\n+    if (children.isEmpty()) {\n+      throw new InvalidRoutingDataException(ROUTING_DATA_PATH + \" does not have any child node.\");\n+    }\n+    for (String child : children) {\n+      ZNRecord record = _zkClient.readData(ROUTING_DATA_PATH + \"/\" + child);\n+      List<String> shardingKeys = record.getListField(ZNRECORD_LIST_FIELD_KEY);\n+      if (shardingKeys == null) {\n+        throw new InvalidRoutingDataException(ROUTING_DATA_PATH + \"/\" + child\n+            + \" does not have the key \" + ZNRECORD_LIST_FIELD_KEY + \".\");\n+      }\n+      if (shardingKeys.isEmpty()) {\n+        throw new InvalidRoutingDataException(ROUTING_DATA_PATH + \"/\" + child\n+            + \" has an empty value for the key \" + ZNRECORD_LIST_FIELD_KEY + \".\");\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxNzQwMw==", "bodyText": "It'd be a good idea to add a schematic so that the reviewers/readers could understand this better.", "url": "https://github.com/apache/helix/pull/714#discussion_r374917403", "createdAt": "2020-02-04T20:55:35Z", "author": {"login": "narendly"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/metadatastore/TestZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.AccessOption;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+import org.apache.helix.rest.server.AbstractTestClass;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+public class TestZkRoutingDataAccessor extends AbstractTestClass {\n+  @Test\n+  public void testGetRoutingData() {\n+    ZNRecord testZnRecord1 = new ZNRecord(\"testZnRecord1\");\n+    List<String> testShardingKeys1 =\n+        Arrays.asList(\"/sharding/key/1/a\", \"/sharding/key/1/b\", \"/sharding/key/1/c\");\n+    testZnRecord1.setListField(\"ZK_PATH_SHARDING_KEYS\", testShardingKeys1);\n+    ZNRecord testZnRecord2 = new ZNRecord(\"testZnRecord2\");\n+    List<String> testShardingKeys2 = Arrays.asList(\"/sharding/key/2/a\", \"/sharding/key/2/b\",\n+        \"/sharding/key/2/c\", \"/sharding/key/2/d\");\n+    testZnRecord2.setListField(\"ZK_PATH_SHARDING_KEYS\", testShardingKeys2);\n+    _baseAccessor.create(\"/METADATA_STORE_ROUTING_DATA/testRealmAddress1\", testZnRecord1,\n+        AccessOption.PERSISTENT);\n+    _baseAccessor.create(\"/METADATA_STORE_ROUTING_DATA/testRealmAddress2\", testZnRecord2,\n+        AccessOption.PERSISTENT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxNzU0MA==", "bodyText": "Use the constant instead.", "url": "https://github.com/apache/helix/pull/714#discussion_r374917540", "createdAt": "2020-02-04T20:55:49Z", "author": {"login": "narendly"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/metadatastore/TestZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.AccessOption;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+import org.apache.helix.rest.server.AbstractTestClass;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+public class TestZkRoutingDataAccessor extends AbstractTestClass {\n+  @Test\n+  public void testGetRoutingData() {\n+    ZNRecord testZnRecord1 = new ZNRecord(\"testZnRecord1\");\n+    List<String> testShardingKeys1 =\n+        Arrays.asList(\"/sharding/key/1/a\", \"/sharding/key/1/b\", \"/sharding/key/1/c\");\n+    testZnRecord1.setListField(\"ZK_PATH_SHARDING_KEYS\", testShardingKeys1);\n+    ZNRecord testZnRecord2 = new ZNRecord(\"testZnRecord2\");\n+    List<String> testShardingKeys2 = Arrays.asList(\"/sharding/key/2/a\", \"/sharding/key/2/b\",\n+        \"/sharding/key/2/c\", \"/sharding/key/2/d\");\n+    testZnRecord2.setListField(\"ZK_PATH_SHARDING_KEYS\", testShardingKeys2);\n+    _baseAccessor.create(\"/METADATA_STORE_ROUTING_DATA/testRealmAddress1\", testZnRecord1,\n+        AccessOption.PERSISTENT);\n+    _baseAccessor.create(\"/METADATA_STORE_ROUTING_DATA/testRealmAddress2\", testZnRecord2,\n+        AccessOption.PERSISTENT);\n+\n+    ZkRoutingDataAccessor zkRoutingDataAccessor = new ZkRoutingDataAccessor(ZK_ADDR);\n+    try {\n+      Map<String, List<String>> routingData = zkRoutingDataAccessor.getRoutingData();\n+      Assert.assertEquals(routingData.size(), 2);\n+      Assert.assertEquals(routingData.get(\"testRealmAddress1\"), testShardingKeys1);\n+      Assert.assertEquals(routingData.get(\"testRealmAddress2\"), testShardingKeys2);\n+    } catch (InvalidRoutingDataException e) {\n+      Assert.fail(\"Not expecting InvalidRoutingDataException\");\n+    }\n+\n+    _baseAccessor.remove(\"/METADATA_STORE_ROUTING_DATA\", AccessOption.PERSISTENT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxNzg1MA==", "bodyText": "Declare using the interface, initialize using the implementation.", "url": "https://github.com/apache/helix/pull/714#discussion_r374917850", "createdAt": "2020-02-04T20:56:28Z", "author": {"login": "narendly"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/metadatastore/TestZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.AccessOption;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+import org.apache.helix.rest.server.AbstractTestClass;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+public class TestZkRoutingDataAccessor extends AbstractTestClass {\n+  @Test\n+  public void testGetRoutingData() {\n+    ZNRecord testZnRecord1 = new ZNRecord(\"testZnRecord1\");\n+    List<String> testShardingKeys1 =\n+        Arrays.asList(\"/sharding/key/1/a\", \"/sharding/key/1/b\", \"/sharding/key/1/c\");\n+    testZnRecord1.setListField(\"ZK_PATH_SHARDING_KEYS\", testShardingKeys1);\n+    ZNRecord testZnRecord2 = new ZNRecord(\"testZnRecord2\");\n+    List<String> testShardingKeys2 = Arrays.asList(\"/sharding/key/2/a\", \"/sharding/key/2/b\",\n+        \"/sharding/key/2/c\", \"/sharding/key/2/d\");\n+    testZnRecord2.setListField(\"ZK_PATH_SHARDING_KEYS\", testShardingKeys2);\n+    _baseAccessor.create(\"/METADATA_STORE_ROUTING_DATA/testRealmAddress1\", testZnRecord1,\n+        AccessOption.PERSISTENT);\n+    _baseAccessor.create(\"/METADATA_STORE_ROUTING_DATA/testRealmAddress2\", testZnRecord2,\n+        AccessOption.PERSISTENT);\n+\n+    ZkRoutingDataAccessor zkRoutingDataAccessor = new ZkRoutingDataAccessor(ZK_ADDR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxNzk2NA==", "bodyText": "Declare using the interface, initialize using the implementation.", "url": "https://github.com/apache/helix/pull/714#discussion_r374917964", "createdAt": "2020-02-04T20:56:39Z", "author": {"login": "narendly"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/metadatastore/TestZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.AccessOption;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+import org.apache.helix.rest.server.AbstractTestClass;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+public class TestZkRoutingDataAccessor extends AbstractTestClass {\n+  @Test\n+  public void testGetRoutingData() {\n+    ZNRecord testZnRecord1 = new ZNRecord(\"testZnRecord1\");\n+    List<String> testShardingKeys1 =\n+        Arrays.asList(\"/sharding/key/1/a\", \"/sharding/key/1/b\", \"/sharding/key/1/c\");\n+    testZnRecord1.setListField(\"ZK_PATH_SHARDING_KEYS\", testShardingKeys1);\n+    ZNRecord testZnRecord2 = new ZNRecord(\"testZnRecord2\");\n+    List<String> testShardingKeys2 = Arrays.asList(\"/sharding/key/2/a\", \"/sharding/key/2/b\",\n+        \"/sharding/key/2/c\", \"/sharding/key/2/d\");\n+    testZnRecord2.setListField(\"ZK_PATH_SHARDING_KEYS\", testShardingKeys2);\n+    _baseAccessor.create(\"/METADATA_STORE_ROUTING_DATA/testRealmAddress1\", testZnRecord1,\n+        AccessOption.PERSISTENT);\n+    _baseAccessor.create(\"/METADATA_STORE_ROUTING_DATA/testRealmAddress2\", testZnRecord2,\n+        AccessOption.PERSISTENT);\n+\n+    ZkRoutingDataAccessor zkRoutingDataAccessor = new ZkRoutingDataAccessor(ZK_ADDR);\n+    try {\n+      Map<String, List<String>> routingData = zkRoutingDataAccessor.getRoutingData();\n+      Assert.assertEquals(routingData.size(), 2);\n+      Assert.assertEquals(routingData.get(\"testRealmAddress1\"), testShardingKeys1);\n+      Assert.assertEquals(routingData.get(\"testRealmAddress2\"), testShardingKeys2);\n+    } catch (InvalidRoutingDataException e) {\n+      Assert.fail(\"Not expecting InvalidRoutingDataException\");\n+    }\n+\n+    _baseAccessor.remove(\"/METADATA_STORE_ROUTING_DATA\", AccessOption.PERSISTENT);\n+  }\n+\n+  @Test\n+  public void testGetRoutingDataMissingMSRD() {\n+    ZkRoutingDataAccessor zkRoutingDataAccessor = new ZkRoutingDataAccessor(ZK_ADDR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxODAwNA==", "bodyText": "Declare using the interface, initialize using the implementation.", "url": "https://github.com/apache/helix/pull/714#discussion_r374918004", "createdAt": "2020-02-04T20:56:44Z", "author": {"login": "narendly"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/metadatastore/TestZkRoutingDataAccessor.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.AccessOption;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+import org.apache.helix.rest.server.AbstractTestClass;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+public class TestZkRoutingDataAccessor extends AbstractTestClass {\n+  @Test\n+  public void testGetRoutingData() {\n+    ZNRecord testZnRecord1 = new ZNRecord(\"testZnRecord1\");\n+    List<String> testShardingKeys1 =\n+        Arrays.asList(\"/sharding/key/1/a\", \"/sharding/key/1/b\", \"/sharding/key/1/c\");\n+    testZnRecord1.setListField(\"ZK_PATH_SHARDING_KEYS\", testShardingKeys1);\n+    ZNRecord testZnRecord2 = new ZNRecord(\"testZnRecord2\");\n+    List<String> testShardingKeys2 = Arrays.asList(\"/sharding/key/2/a\", \"/sharding/key/2/b\",\n+        \"/sharding/key/2/c\", \"/sharding/key/2/d\");\n+    testZnRecord2.setListField(\"ZK_PATH_SHARDING_KEYS\", testShardingKeys2);\n+    _baseAccessor.create(\"/METADATA_STORE_ROUTING_DATA/testRealmAddress1\", testZnRecord1,\n+        AccessOption.PERSISTENT);\n+    _baseAccessor.create(\"/METADATA_STORE_ROUTING_DATA/testRealmAddress2\", testZnRecord2,\n+        AccessOption.PERSISTENT);\n+\n+    ZkRoutingDataAccessor zkRoutingDataAccessor = new ZkRoutingDataAccessor(ZK_ADDR);\n+    try {\n+      Map<String, List<String>> routingData = zkRoutingDataAccessor.getRoutingData();\n+      Assert.assertEquals(routingData.size(), 2);\n+      Assert.assertEquals(routingData.get(\"testRealmAddress1\"), testShardingKeys1);\n+      Assert.assertEquals(routingData.get(\"testRealmAddress2\"), testShardingKeys2);\n+    } catch (InvalidRoutingDataException e) {\n+      Assert.fail(\"Not expecting InvalidRoutingDataException\");\n+    }\n+\n+    _baseAccessor.remove(\"/METADATA_STORE_ROUTING_DATA\", AccessOption.PERSISTENT);\n+  }\n+\n+  @Test\n+  public void testGetRoutingDataMissingMSRD() {\n+    ZkRoutingDataAccessor zkRoutingDataAccessor = new ZkRoutingDataAccessor(ZK_ADDR);\n+    try {\n+      zkRoutingDataAccessor.getRoutingData();\n+      Assert.fail(\"Expecting InvalidRoutingDataException\");\n+    } catch (InvalidRoutingDataException e) {\n+      Assert\n+          .assertTrue(e.getMessage().contains(\"/METADATA_STORE_ROUTING_DATA node doesn't exist.\"));\n+    }\n+  }\n+\n+  @Test\n+  public void testGetRoutingDataMissingMSRDChildren() {\n+    _baseAccessor.create(\"/METADATA_STORE_ROUTING_DATA\", new ZNRecord(\"test\"),\n+        AccessOption.PERSISTENT);\n+    ZkRoutingDataAccessor zkRoutingDataAccessor = new ZkRoutingDataAccessor(ZK_ADDR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7afdaa3b3b339b5a3e1ffaa9a4d080da30490542"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b65623820084c069bc28f0cc25a46499f7a30449", "author": {"user": {"login": "NealSun96", "name": "Neal Sun"}}, "url": "https://github.com/apache/helix/commit/b65623820084c069bc28f0cc25a46499f7a30449", "committedDate": "2020-02-05T00:01:18Z", "message": "rename and address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35095696cb25fe5ca44e8640f3d5862284947385", "author": {"user": {"login": "NealSun96", "name": "Neal Sun"}}, "url": "https://github.com/apache/helix/commit/35095696cb25fe5ca44e8640f3d5862284947385", "committedDate": "2020-02-05T00:03:44Z", "message": "make up missed constant usages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDAyMDUw", "url": "https://github.com/apache/helix/pull/714#pullrequestreview-353402050", "createdAt": "2020-02-05T00:43:43Z", "commit": {"oid": "35095696cb25fe5ca44e8640f3d5862284947385"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwMDo0Mzo0M1rOFlob4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwMTowMjowM1rOFloveg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwNDEyOA==", "bodyText": "Can we avoid importing *? The file helix-style-intellij.xml should help you format the imports.", "url": "https://github.com/apache/helix/pull/714#discussion_r375004128", "createdAt": "2020-02-05T00:43:43Z", "author": {"login": "huizhilu"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/metadatastore/TestZkRoutingDataReader.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.AccessOption;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+import org.apache.helix.rest.server.AbstractTestClass;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+import static org.apache.helix.rest.metadatastore.ZkRoutingDataReader.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35095696cb25fe5ca44e8640f3d5862284947385"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwODg0Mg==", "bodyText": "You don't have to use exits to check this path as it would add one more unnecessary read request to ZK. getChildren will give you ZkNoNodeException if the path does not exit. So just catch the ZkNoNodeException and save one READ request to ZK.", "url": "https://github.com/apache/helix/pull/714#discussion_r375008842", "createdAt": "2020-02-05T01:01:06Z", "author": {"login": "huizhilu"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataReader.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+public class ZkRoutingDataReader implements MetadataStoreRoutingDataReader {\n+  static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";\n+\n+  private final String _zkAddress;\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataReader(String zkAddress) {\n+    _zkAddress = zkAddress;\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() throws InvalidRoutingDataException {\n+    Map<String, List<String>> result = new HashMap<>();\n+    if (!_zkClient.exists(ROUTING_DATA_PATH)) {\n+      throw new InvalidRoutingDataException(\"Routing data directory node \" + ROUTING_DATA_PATH\n+          + \" does not exist. Routing ZooKeeper address: \" + _zkAddress);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35095696cb25fe5ca44e8640f3d5862284947385"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwOTE0Ng==", "bodyText": "Nit, maybe you can give it a clearer name like routingData, instead of this vague one?", "url": "https://github.com/apache/helix/pull/714#discussion_r375009146", "createdAt": "2020-02-05T01:02:03Z", "author": {"login": "huizhilu"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataReader.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+public class ZkRoutingDataReader implements MetadataStoreRoutingDataReader {\n+  static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";\n+\n+  private final String _zkAddress;\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataReader(String zkAddress) {\n+    _zkAddress = zkAddress;\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() throws InvalidRoutingDataException {\n+    Map<String, List<String>> result = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35095696cb25fe5ca44e8640f3d5862284947385"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27e2cb5c4fa10086f96dfe7abcfcadee75367c70", "author": {"user": {"login": "NealSun96", "name": "Neal Sun"}}, "url": "https://github.com/apache/helix/commit/27e2cb5c4fa10086f96dfe7abcfcadee75367c70", "committedDate": "2020-02-05T01:13:10Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDEyODM4", "url": "https://github.com/apache/helix/pull/714#pullrequestreview-353412838", "createdAt": "2020-02-05T01:17:23Z", "commit": {"oid": "27e2cb5c4fa10086f96dfe7abcfcadee75367c70"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwMToxNzoyM1rOFlo--Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwMToyMjozNVrOFlpEmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxMzExMw==", "bodyText": "Fix style", "url": "https://github.com/apache/helix/pull/714#discussion_r375013113", "createdAt": "2020-02-05T01:17:23Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataReader.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.I0Itec.zkclient.exception.ZkNoNodeException;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+\n+public class ZkRoutingDataReader implements MetadataStoreRoutingDataReader {\n+  static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";\n+\n+  private final String _zkAddress;\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataReader(String zkAddress) {\n+    _zkAddress = zkAddress;\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() throws InvalidRoutingDataException {\n+    Map<String, List<String>> routingData = new HashMap<>();\n+    List<String> children;\n+    try {\n+      children = _zkClient.getChildren(ROUTING_DATA_PATH);\n+    }\n+    catch (ZkNoNodeException e) {\n+      throw new InvalidRoutingDataException(\"Routing data directory node \" + ROUTING_DATA_PATH\n+          + \" does not exist. Routing ZooKeeper address: \" + _zkAddress);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27e2cb5c4fa10086f96dfe7abcfcadee75367c70"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxMzQ0NA==", "bodyText": "Instead of calling it children, let's give a more meaningful message:\n\nThere are no metadata store realms defined in the routing zookeeper: \" + zkAddress?", "url": "https://github.com/apache/helix/pull/714#discussion_r375013444", "createdAt": "2020-02-05T01:18:39Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataReader.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.I0Itec.zkclient.exception.ZkNoNodeException;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+\n+public class ZkRoutingDataReader implements MetadataStoreRoutingDataReader {\n+  static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";\n+\n+  private final String _zkAddress;\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataReader(String zkAddress) {\n+    _zkAddress = zkAddress;\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() throws InvalidRoutingDataException {\n+    Map<String, List<String>> routingData = new HashMap<>();\n+    List<String> children;\n+    try {\n+      children = _zkClient.getChildren(ROUTING_DATA_PATH);\n+    }\n+    catch (ZkNoNodeException e) {\n+      throw new InvalidRoutingDataException(\"Routing data directory node \" + ROUTING_DATA_PATH\n+          + \" does not exist. Routing ZooKeeper address: \" + _zkAddress);\n+    }\n+    if (children.isEmpty()) {\n+      throw new InvalidRoutingDataException(\"Routing data directory node \" + ROUTING_DATA_PATH\n+          + \" does not have any child node. Routing ZooKeeper address: \" + _zkAddress);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27e2cb5c4fa10086f96dfe7abcfcadee75367c70"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxMzczNw==", "bodyText": "nit: is null check necessary on children (might not be. ignore if not)?", "url": "https://github.com/apache/helix/pull/714#discussion_r375013737", "createdAt": "2020-02-05T01:19:35Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataReader.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.I0Itec.zkclient.exception.ZkNoNodeException;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+\n+public class ZkRoutingDataReader implements MetadataStoreRoutingDataReader {\n+  static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";\n+\n+  private final String _zkAddress;\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataReader(String zkAddress) {\n+    _zkAddress = zkAddress;\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() throws InvalidRoutingDataException {\n+    Map<String, List<String>> routingData = new HashMap<>();\n+    List<String> children;\n+    try {\n+      children = _zkClient.getChildren(ROUTING_DATA_PATH);\n+    }\n+    catch (ZkNoNodeException e) {\n+      throw new InvalidRoutingDataException(\"Routing data directory node \" + ROUTING_DATA_PATH\n+          + \" does not exist. Routing ZooKeeper address: \" + _zkAddress);\n+    }\n+    if (children.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27e2cb5c4fa10086f96dfe7abcfcadee75367c70"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNDAyMw==", "bodyText": "Nit: let's call it ZNode, instead of node", "url": "https://github.com/apache/helix/pull/714#discussion_r375014023", "createdAt": "2020-02-05T01:20:36Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/ZkRoutingDataReader.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.I0Itec.zkclient.exception.ZkNoNodeException;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.manager.zk.ZNRecordSerializer;\n+import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+\n+public class ZkRoutingDataReader implements MetadataStoreRoutingDataReader {\n+  static final String ROUTING_DATA_PATH = \"/METADATA_STORE_ROUTING_DATA\";\n+  static final String ZNRECORD_LIST_FIELD_KEY = \"ZK_PATH_SHARDING_KEYS\";\n+\n+  private final String _zkAddress;\n+  private final HelixZkClient _zkClient;\n+\n+  public ZkRoutingDataReader(String zkAddress) {\n+    _zkAddress = zkAddress;\n+    _zkClient = DedicatedZkClientFactory.getInstance().buildZkClient(\n+        new HelixZkClient.ZkConnectionConfig(zkAddress),\n+        new HelixZkClient.ZkClientConfig().setZkSerializer(new ZNRecordSerializer()));\n+  }\n+\n+  public Map<String, List<String>> getRoutingData() throws InvalidRoutingDataException {\n+    Map<String, List<String>> routingData = new HashMap<>();\n+    List<String> children;\n+    try {\n+      children = _zkClient.getChildren(ROUTING_DATA_PATH);\n+    }\n+    catch (ZkNoNodeException e) {\n+      throw new InvalidRoutingDataException(\"Routing data directory node \" + ROUTING_DATA_PATH\n+          + \" does not exist. Routing ZooKeeper address: \" + _zkAddress);\n+    }\n+    if (children.isEmpty()) {\n+      throw new InvalidRoutingDataException(\"Routing data directory node \" + ROUTING_DATA_PATH\n+          + \" does not have any child node. Routing ZooKeeper address: \" + _zkAddress);\n+    }\n+    for (String child : children) {\n+      ZNRecord record = _zkClient.readData(ROUTING_DATA_PATH + \"/\" + child);\n+      List<String> shardingKeys = record.getListField(ZNRECORD_LIST_FIELD_KEY);\n+      if (shardingKeys == null || shardingKeys.isEmpty()) {\n+        throw new InvalidRoutingDataException(\"Realm address node \" + ROUTING_DATA_PATH + \"/\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27e2cb5c4fa10086f96dfe7abcfcadee75367c70"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNDQ3OQ==", "bodyText": "Can you make this a private variable and reuse it? Create a @beforeClass. Also create a @afterclass method and close all ZK connections/other connected resources (such as base data accessor)", "url": "https://github.com/apache/helix/pull/714#discussion_r375014479", "createdAt": "2020-02-05T01:22:18Z", "author": {"login": "narendly"}, "path": "helix-rest/src/test/java/org/apache/helix/rest/metadatastore/TestZkRoutingDataReader.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.AccessOption;\n+import org.apache.helix.ZNRecord;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+import org.apache.helix.rest.server.AbstractTestClass;\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+import static org.apache.helix.rest.metadatastore.ZkRoutingDataReader.ROUTING_DATA_PATH;\n+import static org.apache.helix.rest.metadatastore.ZkRoutingDataReader.ZNRECORD_LIST_FIELD_KEY;\n+\n+public class TestZkRoutingDataReader extends AbstractTestClass {\n+  @Test\n+  public void testGetRoutingData() {\n+    // Create a node that represents a realm address and add 3 sharding keys to it\n+    ZNRecord testZnRecord1 = new ZNRecord(\"testZnRecord1\");\n+    List<String> testShardingKeys1 =\n+        Arrays.asList(\"/sharding/key/1/a\", \"/sharding/key/1/b\", \"/sharding/key/1/c\");\n+    testZnRecord1.setListField(ZNRECORD_LIST_FIELD_KEY, testShardingKeys1);\n+\n+    // Create another node that represents a realm address and add 3 sharding keys to it\n+    ZNRecord testZnRecord2 = new ZNRecord(\"testZnRecord2\");\n+    List<String> testShardingKeys2 = Arrays.asList(\"/sharding/key/2/a\", \"/sharding/key/2/b\",\n+        \"/sharding/key/2/c\", \"/sharding/key/2/d\");\n+    testZnRecord2.setListField(ZNRECORD_LIST_FIELD_KEY, testShardingKeys2);\n+\n+    // Add both nodes as children nodes to ROUTING_DATA_PATH\n+    _baseAccessor.create(ROUTING_DATA_PATH + \"/testRealmAddress1\", testZnRecord1,\n+        AccessOption.PERSISTENT);\n+    _baseAccessor.create(ROUTING_DATA_PATH + \"/testRealmAddress2\", testZnRecord2,\n+        AccessOption.PERSISTENT);\n+\n+    MetadataStoreRoutingDataReader zkRoutingDataReader = new ZkRoutingDataReader(ZK_ADDR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27e2cb5c4fa10086f96dfe7abcfcadee75367c70"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAxNDU1Mg==", "bodyText": "Let's add a close() method.", "url": "https://github.com/apache/helix/pull/714#discussion_r375014552", "createdAt": "2020-02-05T01:22:35Z", "author": {"login": "narendly"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/MetadataStoreRoutingDataReader.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package org.apache.helix.rest.metadatastore;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.helix.rest.metadatastore.exceptions.InvalidRoutingDataException;\n+\n+/**\n+ * An interface for a DAO that fetches routing data from a source and return a key-value mapping\n+ * that represent the said routing data.\n+ */\n+public interface MetadataStoreRoutingDataReader {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27e2cb5c4fa10086f96dfe7abcfcadee75367c70"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ce8b9a335b01c39990aed7adc18453948317869", "author": {"user": {"login": "NealSun96", "name": "Neal Sun"}}, "url": "https://github.com/apache/helix/commit/4ce8b9a335b01c39990aed7adc18453948317869", "committedDate": "2020-02-05T01:38:33Z", "message": "address final comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDIwMzQz", "url": "https://github.com/apache/helix/pull/714#pullrequestreview-353420343", "createdAt": "2020-02-05T01:42:55Z", "commit": {"oid": "4ce8b9a335b01c39990aed7adc18453948317869"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4903, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}