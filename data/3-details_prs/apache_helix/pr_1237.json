{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0OTUwMDg4", "number": 1237, "title": "Fix empty host list for instance stoppable response", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nFixed #1232\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nHealth check stoppable responds with empty hostname.\nThis PR adds error message of instance check to API response so users have a clear idea of the reason if PERSIST_INTERMEDIATE_ASSIGNMENT is not turned on.\ncurl -XPOST http://localhost:8100/admin/v2/namespaces/namespacce/clusters/cluster/instances\\?command\\=stoppable -d ' {\"instances\": [\"instance\"], \"selection_base\": \"zone_based\", \"max_instance\": \"2\", \"customized_values\": \"{}\"}' -H \"Content-Type: application/json\"\n{\n  \"instance_stoppable_parallel\" : [ ],\n  \"instance_not_stoppable_with_reasons\" : {\n    \"instance\" : [ \"HELIX:INVALID_CONFIG\" ]\n  }\n}\n\nServer log will have the reason logged: Cluster config PERSIST_INTERMEDIATE_ASSIGNMENT is not turned on, which is required for instance stability check.\nTests\n\n\n The following tests are written for this issue:\n\n\ntestBatchGetInstancesStoppableChecksWhenException()\n\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n\n[INFO] Tests run: 166, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 163.995 s - in TestSuite\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 166, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  02:49 min\n[INFO] Finished at: 2020-08-07T21:27:36-07:00\n[INFO] ------------------------------------------------------------------------\n\nDocumentation (Optional)\n\nIn case of new functionality, my PR adds documentation in the following wiki page:\n\n(Link the GitHub wiki you added)\nCommits\n\nMy commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\nMy diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-08-08T04:19:53Z", "url": "https://github.com/apache/helix/pull/1237", "merged": true, "mergeCommit": {"oid": "54a96c038479737e813b7351a75849a2925ccc89"}, "closed": true, "closedAt": "2020-08-28T19:33:11Z", "author": {"login": "huizhilu"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8z6oKABqjM2MzU0NDc2MjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDZkWGAFqTQ3Nzk1MjM1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcb39cbc001a0d3459ad334f1516b7f9a23eebe4", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/bcb39cbc001a0d3459ad334f1516b7f9a23eebe4", "committedDate": "2020-08-08T04:15:24Z", "message": "Add error message of instance check to API response"}, "afterCommit": {"oid": "e1b5cb467a70b75d0cd7f9e695be189e537aca47", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/e1b5cb467a70b75d0cd7f9e695be189e537aca47", "committedDate": "2020-08-08T07:30:23Z", "message": "Add error message of instance check to API response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NDMzNTcw", "url": "https://github.com/apache/helix/pull/1237#pullrequestreview-464433570", "createdAt": "2020-08-10T17:32:11Z", "commit": {"oid": "e1b5cb467a70b75d0cd7f9e695be189e537aca47"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NzgzNzgw", "url": "https://github.com/apache/helix/pull/1237#pullrequestreview-469783780", "createdAt": "2020-08-18T19:59:18Z", "commit": {"oid": "e1b5cb467a70b75d0cd7f9e695be189e537aca47"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxOTo1OToxOFrOHCjzLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDowMTowMlrOHCj3CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0NTc0MQ==", "bodyText": "I find this may be misleading. Can we change it to, \"Persist assignment (%s) is not turned on in the Cluster Config. This is required to enable instance stability check.\"", "url": "https://github.com/apache/helix/pull/1237#discussion_r472445741", "createdAt": "2020-08-18T19:59:18Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/util/InstanceValidationUtil.java", "diffHunk": "@@ -261,7 +261,9 @@ public static boolean isInstanceStable(HelixDataAccessor dataAccessor, String in\n       throw new HelixException(\"Missing cluster config!\");\n     }\n     if (!clusterConfig.isPersistIntermediateAssignment()) {\n-      throw new HelixException(\"isInstanceStable needs persist assignment on!\");\n+      throw new HelixException(String.format(\n+          \"Instance stability check needs persist assignment cluster config turned on: %s = true\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1b5cb467a70b75d0cd7f9e695be189e537aca47"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0NjcyOA==", "bodyText": "Why it is a warning now?", "url": "https://github.com/apache/helix/pull/1237#discussion_r472446728", "createdAt": "2020-08-18T20:01:02Z", "author": {"login": "jiajunwang"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceServiceImpl.java", "diffHunk": "@@ -213,7 +219,12 @@ public StoppableCheck getInstanceStoppableCheck(String clusterId, String instanc\n           instancesForNextCheck.add(instance);\n         }\n       } catch (InterruptedException | ExecutionException e) {\n-        LOG.error(\"Failed to get StoppableChecks in parallel. Instance: {}\", instance, e);\n+        LOG.warn(\"Failed to get StoppableChecks in parallel. Instance: {}. Caused by {}\", instance,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1b5cb467a70b75d0cd7f9e695be189e537aca47"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a488ed753a4b83e9f28dab75dfbb2fd56e32b6fd", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/a488ed753a4b83e9f28dab75dfbb2fd56e32b6fd", "committedDate": "2020-08-22T08:23:35Z", "message": "Add error message of instance check to API response"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6b738df70846cc7bb95eeabed35851753a328fc", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/c6b738df70846cc7bb95eeabed35851753a328fc", "committedDate": "2020-08-22T08:18:21Z", "message": "Check configs in INVALID_CONFIG healthcheck"}, "afterCommit": {"oid": "184fd16ff0f0260e32b7f4a2d00ae28d6ba82ec4", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/184fd16ff0f0260e32b7f4a2d00ae28d6ba82ec4", "committedDate": "2020-08-22T08:23:37Z", "message": "Check configs in INVALID_CONFIG healthcheck"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "184fd16ff0f0260e32b7f4a2d00ae28d6ba82ec4", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/184fd16ff0f0260e32b7f4a2d00ae28d6ba82ec4", "committedDate": "2020-08-22T08:23:37Z", "message": "Check configs in INVALID_CONFIG healthcheck"}, "afterCommit": {"oid": "77e2956f5ed329fcfb71773af6ec0e067bafee21", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/77e2956f5ed329fcfb71773af6ec0e067bafee21", "committedDate": "2020-08-22T08:25:40Z", "message": "Check configs in INVALID_CONFIG healthcheck"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "77e2956f5ed329fcfb71773af6ec0e067bafee21", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/77e2956f5ed329fcfb71773af6ec0e067bafee21", "committedDate": "2020-08-22T08:25:40Z", "message": "Check configs in INVALID_CONFIG healthcheck"}, "afterCommit": {"oid": "9381e50ece3a160c4e6a3a3e692006d3d28dbc53", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/9381e50ece3a160c4e6a3a3e692006d3d28dbc53", "committedDate": "2020-08-22T08:28:13Z", "message": "Check configs in INVALID_CONFIG healthcheck"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9381e50ece3a160c4e6a3a3e692006d3d28dbc53", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/9381e50ece3a160c4e6a3a3e692006d3d28dbc53", "committedDate": "2020-08-22T08:28:13Z", "message": "Check configs in INVALID_CONFIG healthcheck"}, "afterCommit": {"oid": "d3f3ec915fc3b60df7f2d5eaac8011477d46460d", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/d3f3ec915fc3b60df7f2d5eaac8011477d46460d", "committedDate": "2020-08-22T09:16:06Z", "message": "Check configs in INVALID_CONFIG healthcheck"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTEwNDk3", "url": "https://github.com/apache/helix/pull/1237#pullrequestreview-472910497", "createdAt": "2020-08-22T09:20:11Z", "commit": {"oid": "d3f3ec915fc3b60df7f2d5eaac8011477d46460d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwOToyMDoxMlrOHFD0dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwOToyMDoxMlrOHFD0dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2NzUxMQ==", "bodyText": "@dasahcc INVALID_CONFIG should also be added to STARTED_AND_HEALTH_CHECK_LIST, right?", "url": "https://github.com/apache/helix/pull/1237#discussion_r475067511", "createdAt": "2020-08-22T09:20:12Z", "author": {"login": "huizhilu"}, "path": "helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceService.java", "diffHunk": "@@ -72,9 +72,10 @@\n         /**\n          * Pre-defined list of checks to test if an instance is in healthy running state\n          */\n-        public static List<HealthCheck> STARTED_AND_HEALTH_CHECK_LIST =\n-                ImmutableList.of(HealthCheck.INSTANCE_NOT_ALIVE, HealthCheck.INSTANCE_NOT_ENABLED,\n-                        HealthCheck.INSTANCE_NOT_STABLE, HealthCheck.EMPTY_RESOURCE_ASSIGNMENT);\n+        public static List<HealthCheck> STARTED_AND_HEALTH_CHECK_LIST = ImmutableList\n+            .of(HealthCheck.INVALID_CONFIG, HealthCheck.INSTANCE_NOT_ALIVE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3f3ec915fc3b60df7f2d5eaac8011477d46460d"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f05795d36866e27d913de3efdf45908648da25c", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/6f05795d36866e27d913de3efdf45908648da25c", "committedDate": "2020-08-22T21:39:22Z", "message": "Check configs in INVALID_CONFIG healthcheck"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3f3ec915fc3b60df7f2d5eaac8011477d46460d", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/d3f3ec915fc3b60df7f2d5eaac8011477d46460d", "committedDate": "2020-08-22T09:16:06Z", "message": "Check configs in INVALID_CONFIG healthcheck"}, "afterCommit": {"oid": "6f05795d36866e27d913de3efdf45908648da25c", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/6f05795d36866e27d913de3efdf45908648da25c", "committedDate": "2020-08-22T21:39:22Z", "message": "Check configs in INVALID_CONFIG healthcheck"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3OTUyMzU1", "url": "https://github.com/apache/helix/pull/1237#pullrequestreview-477952355", "createdAt": "2020-08-28T18:46:20Z", "commit": {"oid": "6f05795d36866e27d913de3efdf45908648da25c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4208, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}