{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NzEzNDcw", "number": 1441, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo0MDowMFrOEq2ekQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMToxMTo0MVrOEq7EoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzY4MjA5OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo0MDowMVrOHdS3sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1MDoyMlrOHdTP0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3OTkyMw==", "bodyText": "I suggest covering all the accessor related calls inside the commit(). There should be 3 as I remember.", "url": "https://github.com/apache/helix/pull/1441#discussion_r500479923", "createdAt": "2020-10-06T17:40:01Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -112,6 +112,9 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n             merged = accessor.get(mergedKey, null, options);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce95333419e6e0082b1b75938178941ff6ef49c0"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NjA5OA==", "bodyText": "What do you mean?", "url": "https://github.com/apache/helix/pull/1441#discussion_r500486098", "createdAt": "2020-10-06T17:50:22Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -112,6 +112,9 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n             merged = accessor.get(mergedKey, null, options);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3OTkyMw=="}, "originalCommit": {"oid": "ce95333419e6e0082b1b75938178941ff6ef49c0"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzcxOTY3OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1MDowOVrOHdTPRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDo0ODoyNVrOHdZXXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NTk1Nw==", "bodyText": "There are a few places that call DataAccessor.updateProperty but did not check the return results, we may want to double check whether it is appropriate (i.e, adding check there if it cares writing failure).\none example is:  HelixAdmin->addTypeToCustomizedStateConfig()", "url": "https://github.com/apache/helix/pull/1441#discussion_r500485957", "createdAt": "2020-10-06T17:50:09Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -112,6 +112,9 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n             merged = accessor.get(mergedKey, null, options);\n           } catch (ZkNoNodeException e) {\n             // OK.\n+          } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce95333419e6e0082b1b75938178941ff6ef49c0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5MjIyNQ==", "bodyText": "Yep, I'll address them together with #1436", "url": "https://github.com/apache/helix/pull/1441#discussion_r500492225", "createdAt": "2020-10-06T18:00:15Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -112,6 +112,9 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n             merged = accessor.get(mergedKey, null, options);\n           } catch (ZkNoNodeException e) {\n             // OK.\n+          } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NTk1Nw=="}, "originalCommit": {"oid": "ce95333419e6e0082b1b75938178941ff6ef49c0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5ODI4MA==", "bodyText": "Can you search all existing use cases (no related to customized state) and make sure there is no assumption on old behavior?", "url": "https://github.com/apache/helix/pull/1441#discussion_r500498280", "createdAt": "2020-10-06T18:10:16Z", "author": {"login": "lei-xia"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -112,6 +112,9 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n             merged = accessor.get(mergedKey, null, options);\n           } catch (ZkNoNodeException e) {\n             // OK.\n+          } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NTk1Nw=="}, "originalCommit": {"oid": "ce95333419e6e0082b1b75938178941ff6ef49c0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUzMTcxNQ==", "bodyText": "This change only impacts group commit. As shown in the following, only current state and customized state use group commit.\ncase CURRENTSTATES:\ncase CUSTOMIZEDSTATES:\nsuccess = _groupCommit.commit(_baseDataAccessor, options, path, value.getRecord(), true);\nHowever, as you mentioned, for normal update, there're cases that don't really check response. I'll take a look to see whether they're reasonable.", "url": "https://github.com/apache/helix/pull/1441#discussion_r500531715", "createdAt": "2020-10-06T19:05:32Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -112,6 +112,9 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n             merged = accessor.get(mergedKey, null, options);\n           } catch (ZkNoNodeException e) {\n             // OK.\n+          } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NTk1Nw=="}, "originalCommit": {"oid": "ce95333419e6e0082b1b75938178941ff6ef49c0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU4NjMzNQ==", "bodyText": "Done. Actually no impact on other function.", "url": "https://github.com/apache/helix/pull/1441#discussion_r500586335", "createdAt": "2020-10-06T20:48:25Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -112,6 +112,9 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n             merged = accessor.get(mergedKey, null, options);\n           } catch (ZkNoNodeException e) {\n             // OK.\n+          } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NTk1Nw=="}, "originalCommit": {"oid": "ce95333419e6e0082b1b75938178941ff6ef49c0"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNDQyODQzOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMTowOTo1MlrOHdaC5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMTozNDoyOFrOHdaxlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5NzQ3OQ==", "bodyText": "Let us log this exception here.", "url": "https://github.com/apache/helix/pull/1441#discussion_r500597479", "createdAt": "2020-10-06T21:09:52Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -139,14 +142,22 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n           success = false;\n           while (++retry <= MAX_RETRY && !success) {\n             if (removeIfEmpty && merged.getMapFields().isEmpty()) {\n-              success = accessor.remove(mergedKey, options);\n+              try {\n+                success = accessor.remove(mergedKey, options);\n+              } catch (Exception e) {\n+                success = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93b3d1091d74a8364325fb3cc7d4981ce5a0a2d6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwNTgzNA==", "bodyText": "if you look at the next line. It's already logged there.", "url": "https://github.com/apache/helix/pull/1441#discussion_r500605834", "createdAt": "2020-10-06T21:26:56Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -139,14 +142,22 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n           success = false;\n           while (++retry <= MAX_RETRY && !success) {\n             if (removeIfEmpty && merged.getMapFields().isEmpty()) {\n-              success = accessor.remove(mergedKey, options);\n+              try {\n+                success = accessor.remove(mergedKey, options);\n+              } catch (Exception e) {\n+                success = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5NzQ3OQ=="}, "originalCommit": {"oid": "93b3d1091d74a8364325fb3cc7d4981ce5a0a2d6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwOTQyOQ==", "bodyText": "The thing is that we did not log out the exception. At the time of investigation of production issue, you always want to know what is the exception thrown.\nCurrent code actually \"eat\" the exception from IO (zk access). This is normally not a good idea.\nhow about something like this?\n try {\n                success = accessor.remove(mergedKey, options);\n  } catch (Exception e) {\n                LOG.error (\" failed to remove {} from zk, retry it\", mergedkey, e);\n                return false;\n  }\n\n LOG.info( \"removed {}\", mergedkey);", "url": "https://github.com/apache/helix/pull/1441#discussion_r500609429", "createdAt": "2020-10-06T21:34:28Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -139,14 +142,22 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n           success = false;\n           while (++retry <= MAX_RETRY && !success) {\n             if (removeIfEmpty && merged.getMapFields().isEmpty()) {\n-              success = accessor.remove(mergedKey, options);\n+              try {\n+                success = accessor.remove(mergedKey, options);\n+              } catch (Exception e) {\n+                success = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5NzQ3OQ=="}, "originalCommit": {"oid": "93b3d1091d74a8364325fb3cc7d4981ce5a0a2d6"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNDQyOTczOnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMToxMDoxNlrOHdaDuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMToyNzowNlrOHdaj5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5NzY4OQ==", "bodyText": "log exception here.", "url": "https://github.com/apache/helix/pull/1441#discussion_r500597689", "createdAt": "2020-10-06T21:10:16Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -139,14 +142,22 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n           success = false;\n           while (++retry <= MAX_RETRY && !success) {\n             if (removeIfEmpty && merged.getMapFields().isEmpty()) {\n-              success = accessor.remove(mergedKey, options);\n+              try {\n+                success = accessor.remove(mergedKey, options);\n+              } catch (Exception e) {\n+                success = false;\n+              }\n               if (!success) {\n                 LOG.error(\"Fails to remove \" + mergedKey + \" from ZK, retry it!\");\n               } else {\n                 LOG.info(\"Removed \" + mergedKey);\n               }\n             } else {\n-              success = accessor.set(mergedKey, merged, options);\n+              try {\n+                success = accessor.set(mergedKey, merged, options);\n+              } catch (Exception e) {\n+                success = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93b3d1091d74a8364325fb3cc7d4981ce5a0a2d6"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwNTkyNA==", "bodyText": "It's logged next line.", "url": "https://github.com/apache/helix/pull/1441#discussion_r500605924", "createdAt": "2020-10-06T21:27:06Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/GroupCommit.java", "diffHunk": "@@ -139,14 +142,22 @@ public boolean commit(BaseDataAccessor<ZNRecord> accessor, int options, String k\n           success = false;\n           while (++retry <= MAX_RETRY && !success) {\n             if (removeIfEmpty && merged.getMapFields().isEmpty()) {\n-              success = accessor.remove(mergedKey, options);\n+              try {\n+                success = accessor.remove(mergedKey, options);\n+              } catch (Exception e) {\n+                success = false;\n+              }\n               if (!success) {\n                 LOG.error(\"Fails to remove \" + mergedKey + \" from ZK, retry it!\");\n               } else {\n                 LOG.info(\"Removed \" + mergedKey);\n               }\n             } else {\n-              success = accessor.set(mergedKey, merged, options);\n+              try {\n+                success = accessor.set(mergedKey, merged, options);\n+              } catch (Exception e) {\n+                success = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5NzY4OQ=="}, "originalCommit": {"oid": "93b3d1091d74a8364325fb3cc7d4981ce5a0a2d6"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNDQzNDg4OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMToxMTo0MVrOHdaGug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMToyODozNlrOHdam8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5ODQ1OA==", "bodyText": "This pull only deals with exception in group commit. How about the zkclient closed issue in callbackhandler?", "url": "https://github.com/apache/helix/pull/1441#discussion_r500598458", "createdAt": "2020-10-06T21:11:41Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -1315,8 +1315,11 @@ public void addTypeToCustomizedStateConfig(String clusterName, String type) {\n     ZKHelixDataAccessor accessor =\n         new ZKHelixDataAccessor(clusterName, new ZkBaseDataAccessor<ZNRecord>(_zkClient));\n     PropertyKey.Builder keyBuilder = accessor.keyBuilder();\n-    accessor.updateProperty(keyBuilder.customizedStateConfig(),\n-        customizedStateConfigFromBuilder);\n+    if(!accessor.updateProperty(keyBuilder.customizedStateConfig(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93b3d1091d74a8364325fb3cc7d4981ce5a0a2d6"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwNjcwNg==", "bodyText": "The reason we need this PR is that we need to make sure updateProperty with group commit or non group commit have the same behavior. Currently non group commit update return error code, while group commit throws exception. This should not impact any callbackhandler existing logic.", "url": "https://github.com/apache/helix/pull/1441#discussion_r500606706", "createdAt": "2020-10-06T21:28:36Z", "author": {"login": "zhangmeng916"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixAdmin.java", "diffHunk": "@@ -1315,8 +1315,11 @@ public void addTypeToCustomizedStateConfig(String clusterName, String type) {\n     ZKHelixDataAccessor accessor =\n         new ZKHelixDataAccessor(clusterName, new ZkBaseDataAccessor<ZNRecord>(_zkClient));\n     PropertyKey.Builder keyBuilder = accessor.keyBuilder();\n-    accessor.updateProperty(keyBuilder.customizedStateConfig(),\n-        customizedStateConfigFromBuilder);\n+    if(!accessor.updateProperty(keyBuilder.customizedStateConfig(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5ODQ1OA=="}, "originalCommit": {"oid": "93b3d1091d74a8364325fb3cc7d4981ce5a0a2d6"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1001, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}