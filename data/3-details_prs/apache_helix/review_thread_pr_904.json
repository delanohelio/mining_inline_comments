{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNzcwNzAw", "number": 904, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMzoyMzoxNFrODqCePg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDoyODowNVrODqC8SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDA3Mjk0OnYy", "diffSide": "RIGHT", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMzoyMzoxNFrOF5lpCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMzoyMzoxNFrOF5lpCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkyOTg2Ng==", "bodyText": "Nit: modify -> modifies", "url": "https://github.com/apache/helix/pull/904#discussion_r395929866", "createdAt": "2020-03-20T23:23:14Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZKHelixManager.java", "diffHunk": "@@ -1004,7 +1004,10 @@ void waitUntilConnected() {\n   void initHandlers(List<CallbackHandler> handlers) {\n     synchronized (this) {\n       if (handlers != null) {\n-        for (CallbackHandler handler : handlers) {\n+        // get a copy of the list and iterate over the copy list\n+        // in case handler.init() modify the original handler list", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "167885e38dfe2e4b541628588845f2a46d92b18a"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDE0MTE0OnYy", "diffSide": "RIGHT", "path": "helix-core/src/test/java/org/apache/helix/manager/zk/TestHandleSession.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDoxODozNVrOF5mRPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDoxODozNVrOF5mRPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MDE1Ng==", "bodyText": "testConcurrentHandlerProcessing  -> testConcurrentInitCallbackHandlers", "url": "https://github.com/apache/helix/pull/904#discussion_r395940156", "createdAt": "2020-03-21T00:18:35Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/test/java/org/apache/helix/manager/zk/TestHandleSession.java", "diffHunk": "@@ -466,6 +468,79 @@ public void testSessionExpiredWhenResetHandlers() throws Exception {\n     deleteCluster(clusterName);\n   }\n \n+  @Test\n+  public void testConcurrentInitCallbackHandlers() throws Exception {\n+    final String clusterName =\n+        CLUSTER_PREFIX + \"_\" + _className + \"_\" + TestHelper.getTestMethodName();\n+    TestHelper.setupEmptyCluster(_gZkClient, clusterName);\n+    final String spectatorName = \"testConcurrentHandlerChangeSpectator\";\n+    try {\n+      BlockingHandleNewSessionZkHelixManager helixManager =\n+          new BlockingHandleNewSessionZkHelixManager(clusterName, spectatorName,\n+              InstanceType.SPECTATOR, _gZkClient.getServers());\n+      helixManager.connect();\n+      // Add two mock listeners that will add more callback handlers while handling INIT or CALLBACK event.\n+      // Note that we have to test with 2 separate listeners so one of them has a chance to fail if\n+      // there is a concurrent modification exception.\n+      helixManager.addLiveInstanceChangeListener(\n+          (LiveInstanceChangeListener) (liveInstances, changeContext) -> {\n+            if (changeContext.getType() != NotificationContext.Type.FINALIZE) {\n+              for (LiveInstance liveInstance : liveInstances) {\n+                if (liveInstance.getInstanceName().equals(\"localhost_1\")) {\n+                  try {\n+                    helixManager.addCurrentStateChangeListener(\n+                        (CurrentStateChangeListener) (instanceName, statesInfo, currentStateChangeContext) -> {\n+                          // empty callback\n+                        }, liveInstance.getInstanceName(), liveInstance.getEphemeralOwner());\n+                  } catch (Exception e) {\n+                    throw new HelixException(\n+                        \"Unexpected exception in the testConcurrentHandlerProcessing.\", e);\n+                  }\n+                }\n+              }\n+            }\n+          });\n+      helixManager.addLiveInstanceChangeListener(\n+          (LiveInstanceChangeListener) (liveInstances, changeContext) -> {\n+            if (changeContext.getType() != NotificationContext.Type.FINALIZE) {\n+              for (LiveInstance liveInstance : liveInstances) {\n+                if (liveInstance.getInstanceName().equals(\"localhost_2\")) {\n+                  try {\n+                    helixManager.addCurrentStateChangeListener(\n+                        (CurrentStateChangeListener) (instanceName, statesInfo, currentStateChangeContext) -> {\n+                          // empty callback\n+                        }, liveInstance.getInstanceName(), liveInstance.getEphemeralOwner());\n+                  } catch (Exception e) {\n+                    throw new HelixException(\n+                        \"Unexpected exception in the testConcurrentHandlerProcessing.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "167885e38dfe2e4b541628588845f2a46d92b18a"}, "originalPosition": 104}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDE0MjYxOnYy", "diffSide": "RIGHT", "path": "helix-core/src/test/java/org/apache/helix/manager/zk/TestHandleSession.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDoyMDoxOVrOF5mSGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDoyMDoxOVrOF5mSGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MDM3OQ==", "bodyText": "testConcurrentHandlerProcessing -> testConcurrentInitCallbackHandlers.\nMay be better to just getTestMethodName().", "url": "https://github.com/apache/helix/pull/904#discussion_r395940379", "createdAt": "2020-03-21T00:20:19Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/test/java/org/apache/helix/manager/zk/TestHandleSession.java", "diffHunk": "@@ -466,6 +468,79 @@ public void testSessionExpiredWhenResetHandlers() throws Exception {\n     deleteCluster(clusterName);\n   }\n \n+  @Test\n+  public void testConcurrentInitCallbackHandlers() throws Exception {\n+    final String clusterName =\n+        CLUSTER_PREFIX + \"_\" + _className + \"_\" + TestHelper.getTestMethodName();\n+    TestHelper.setupEmptyCluster(_gZkClient, clusterName);\n+    final String spectatorName = \"testConcurrentHandlerChangeSpectator\";\n+    try {\n+      BlockingHandleNewSessionZkHelixManager helixManager =\n+          new BlockingHandleNewSessionZkHelixManager(clusterName, spectatorName,\n+              InstanceType.SPECTATOR, _gZkClient.getServers());\n+      helixManager.connect();\n+      // Add two mock listeners that will add more callback handlers while handling INIT or CALLBACK event.\n+      // Note that we have to test with 2 separate listeners so one of them has a chance to fail if\n+      // there is a concurrent modification exception.\n+      helixManager.addLiveInstanceChangeListener(\n+          (LiveInstanceChangeListener) (liveInstances, changeContext) -> {\n+            if (changeContext.getType() != NotificationContext.Type.FINALIZE) {\n+              for (LiveInstance liveInstance : liveInstances) {\n+                if (liveInstance.getInstanceName().equals(\"localhost_1\")) {\n+                  try {\n+                    helixManager.addCurrentStateChangeListener(\n+                        (CurrentStateChangeListener) (instanceName, statesInfo, currentStateChangeContext) -> {\n+                          // empty callback\n+                        }, liveInstance.getInstanceName(), liveInstance.getEphemeralOwner());\n+                  } catch (Exception e) {\n+                    throw new HelixException(\n+                        \"Unexpected exception in the testConcurrentHandlerProcessing.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "167885e38dfe2e4b541628588845f2a46d92b18a"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDE0NTkwOnYy", "diffSide": "RIGHT", "path": "helix-core/src/test/java/org/apache/helix/manager/zk/TestHandleSession.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDoyMzoyNFrOF5mT8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMToxMzo1N1rOF5mrVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MDg1MQ==", "bodyText": "Nit, wrap this long line by concatenation?", "url": "https://github.com/apache/helix/pull/904#discussion_r395940851", "createdAt": "2020-03-21T00:23:24Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/test/java/org/apache/helix/manager/zk/TestHandleSession.java", "diffHunk": "@@ -466,6 +468,79 @@ public void testSessionExpiredWhenResetHandlers() throws Exception {\n     deleteCluster(clusterName);\n   }\n \n+  @Test\n+  public void testConcurrentInitCallbackHandlers() throws Exception {\n+    final String clusterName =\n+        CLUSTER_PREFIX + \"_\" + _className + \"_\" + TestHelper.getTestMethodName();\n+    TestHelper.setupEmptyCluster(_gZkClient, clusterName);\n+    final String spectatorName = \"testConcurrentHandlerChangeSpectator\";\n+    try {\n+      BlockingHandleNewSessionZkHelixManager helixManager =\n+          new BlockingHandleNewSessionZkHelixManager(clusterName, spectatorName,\n+              InstanceType.SPECTATOR, _gZkClient.getServers());\n+      helixManager.connect();\n+      // Add two mock listeners that will add more callback handlers while handling INIT or CALLBACK event.\n+      // Note that we have to test with 2 separate listeners so one of them has a chance to fail if\n+      // there is a concurrent modification exception.\n+      helixManager.addLiveInstanceChangeListener(\n+          (LiveInstanceChangeListener) (liveInstances, changeContext) -> {\n+            if (changeContext.getType() != NotificationContext.Type.FINALIZE) {\n+              for (LiveInstance liveInstance : liveInstances) {\n+                if (liveInstance.getInstanceName().equals(\"localhost_1\")) {\n+                  try {\n+                    helixManager.addCurrentStateChangeListener(\n+                        (CurrentStateChangeListener) (instanceName, statesInfo, currentStateChangeContext) -> {\n+                          // empty callback\n+                        }, liveInstance.getInstanceName(), liveInstance.getEphemeralOwner());\n+                  } catch (Exception e) {\n+                    throw new HelixException(\n+                        \"Unexpected exception in the testConcurrentHandlerProcessing.\", e);\n+                  }\n+                }\n+              }\n+            }\n+          });\n+      helixManager.addLiveInstanceChangeListener(\n+          (LiveInstanceChangeListener) (liveInstances, changeContext) -> {\n+            if (changeContext.getType() != NotificationContext.Type.FINALIZE) {\n+              for (LiveInstance liveInstance : liveInstances) {\n+                if (liveInstance.getInstanceName().equals(\"localhost_2\")) {\n+                  try {\n+                    helixManager.addCurrentStateChangeListener(\n+                        (CurrentStateChangeListener) (instanceName, statesInfo, currentStateChangeContext) -> {\n+                          // empty callback\n+                        }, liveInstance.getInstanceName(), liveInstance.getEphemeralOwner());\n+                  } catch (Exception e) {\n+                    throw new HelixException(\n+                        \"Unexpected exception in the testConcurrentHandlerProcessing.\", e);\n+                  }\n+                }\n+              }\n+            }\n+          });\n+      // Session expire will trigger all callbacks to be init. And the injected liveInstance\n+      // listener will trigger more callbackhandlers to be registered during the init process.\n+      ZkTestHelper.asyncExpireSession(helixManager.getZkClient());\n+      // Create mock live instance znodes to trigger the internal callback handling logic which will\n+      // modify the handler list.\n+      setupLiveInstances(clusterName, new int[] { 1, 2 });\n+      // Start new session handling so the manager will call the initHandler() for initializing all\n+      // existing handlers.\n+      helixManager.proceedNewSessionHandling();\n+      // Ensure the new session has been processed.\n+      TestHelper.verify(() -> helixManager.getHandleNewSessionEndTime() != 0, 3000);\n+      // Verify that both new mock current state callback handlers have been initialized normally.\n+      // Note that if there is concurrent modification that cause errors, one of the callback will\n+      // not be initialized normally.\n+      for (CallbackHandler handler : helixManager.getHandlers()) {\n+        Assert.assertTrue(handler.isReady(),\n+            \"CallbackHandler is not initialized as expected. It might be caused by a ConcurrentModificationException\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "167885e38dfe2e4b541628588845f2a46d92b18a"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0NjgzNw==", "bodyText": "This is done by the auto format.", "url": "https://github.com/apache/helix/pull/904#discussion_r395946837", "createdAt": "2020-03-21T01:13:57Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/test/java/org/apache/helix/manager/zk/TestHandleSession.java", "diffHunk": "@@ -466,6 +468,79 @@ public void testSessionExpiredWhenResetHandlers() throws Exception {\n     deleteCluster(clusterName);\n   }\n \n+  @Test\n+  public void testConcurrentInitCallbackHandlers() throws Exception {\n+    final String clusterName =\n+        CLUSTER_PREFIX + \"_\" + _className + \"_\" + TestHelper.getTestMethodName();\n+    TestHelper.setupEmptyCluster(_gZkClient, clusterName);\n+    final String spectatorName = \"testConcurrentHandlerChangeSpectator\";\n+    try {\n+      BlockingHandleNewSessionZkHelixManager helixManager =\n+          new BlockingHandleNewSessionZkHelixManager(clusterName, spectatorName,\n+              InstanceType.SPECTATOR, _gZkClient.getServers());\n+      helixManager.connect();\n+      // Add two mock listeners that will add more callback handlers while handling INIT or CALLBACK event.\n+      // Note that we have to test with 2 separate listeners so one of them has a chance to fail if\n+      // there is a concurrent modification exception.\n+      helixManager.addLiveInstanceChangeListener(\n+          (LiveInstanceChangeListener) (liveInstances, changeContext) -> {\n+            if (changeContext.getType() != NotificationContext.Type.FINALIZE) {\n+              for (LiveInstance liveInstance : liveInstances) {\n+                if (liveInstance.getInstanceName().equals(\"localhost_1\")) {\n+                  try {\n+                    helixManager.addCurrentStateChangeListener(\n+                        (CurrentStateChangeListener) (instanceName, statesInfo, currentStateChangeContext) -> {\n+                          // empty callback\n+                        }, liveInstance.getInstanceName(), liveInstance.getEphemeralOwner());\n+                  } catch (Exception e) {\n+                    throw new HelixException(\n+                        \"Unexpected exception in the testConcurrentHandlerProcessing.\", e);\n+                  }\n+                }\n+              }\n+            }\n+          });\n+      helixManager.addLiveInstanceChangeListener(\n+          (LiveInstanceChangeListener) (liveInstances, changeContext) -> {\n+            if (changeContext.getType() != NotificationContext.Type.FINALIZE) {\n+              for (LiveInstance liveInstance : liveInstances) {\n+                if (liveInstance.getInstanceName().equals(\"localhost_2\")) {\n+                  try {\n+                    helixManager.addCurrentStateChangeListener(\n+                        (CurrentStateChangeListener) (instanceName, statesInfo, currentStateChangeContext) -> {\n+                          // empty callback\n+                        }, liveInstance.getInstanceName(), liveInstance.getEphemeralOwner());\n+                  } catch (Exception e) {\n+                    throw new HelixException(\n+                        \"Unexpected exception in the testConcurrentHandlerProcessing.\", e);\n+                  }\n+                }\n+              }\n+            }\n+          });\n+      // Session expire will trigger all callbacks to be init. And the injected liveInstance\n+      // listener will trigger more callbackhandlers to be registered during the init process.\n+      ZkTestHelper.asyncExpireSession(helixManager.getZkClient());\n+      // Create mock live instance znodes to trigger the internal callback handling logic which will\n+      // modify the handler list.\n+      setupLiveInstances(clusterName, new int[] { 1, 2 });\n+      // Start new session handling so the manager will call the initHandler() for initializing all\n+      // existing handlers.\n+      helixManager.proceedNewSessionHandling();\n+      // Ensure the new session has been processed.\n+      TestHelper.verify(() -> helixManager.getHandleNewSessionEndTime() != 0, 3000);\n+      // Verify that both new mock current state callback handlers have been initialized normally.\n+      // Note that if there is concurrent modification that cause errors, one of the callback will\n+      // not be initialized normally.\n+      for (CallbackHandler handler : helixManager.getHandlers()) {\n+        Assert.assertTrue(handler.isReady(),\n+            \"CallbackHandler is not initialized as expected. It might be caused by a ConcurrentModificationException\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MDg1MQ=="}, "originalCommit": {"oid": "167885e38dfe2e4b541628588845f2a46d92b18a"}, "originalPosition": 126}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDE0OTg1OnYy", "diffSide": "RIGHT", "path": "helix-core/src/test/java/org/apache/helix/manager/zk/TestHandleSession.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDoyODowNVrOF5mWVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDoyODowNVrOF5mWVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MTQ2Mg==", "bodyText": "Can we wrap this block into a private method to avoid the duplicate code in these 2 listeners?", "url": "https://github.com/apache/helix/pull/904#discussion_r395941462", "createdAt": "2020-03-21T00:28:05Z", "author": {"login": "huizhilu"}, "path": "helix-core/src/test/java/org/apache/helix/manager/zk/TestHandleSession.java", "diffHunk": "@@ -466,6 +468,79 @@ public void testSessionExpiredWhenResetHandlers() throws Exception {\n     deleteCluster(clusterName);\n   }\n \n+  @Test\n+  public void testConcurrentInitCallbackHandlers() throws Exception {\n+    final String clusterName =\n+        CLUSTER_PREFIX + \"_\" + _className + \"_\" + TestHelper.getTestMethodName();\n+    TestHelper.setupEmptyCluster(_gZkClient, clusterName);\n+    final String spectatorName = \"testConcurrentHandlerChangeSpectator\";\n+    try {\n+      BlockingHandleNewSessionZkHelixManager helixManager =\n+          new BlockingHandleNewSessionZkHelixManager(clusterName, spectatorName,\n+              InstanceType.SPECTATOR, _gZkClient.getServers());\n+      helixManager.connect();\n+      // Add two mock listeners that will add more callback handlers while handling INIT or CALLBACK event.\n+      // Note that we have to test with 2 separate listeners so one of them has a chance to fail if\n+      // there is a concurrent modification exception.\n+      helixManager.addLiveInstanceChangeListener(\n+          (LiveInstanceChangeListener) (liveInstances, changeContext) -> {\n+            if (changeContext.getType() != NotificationContext.Type.FINALIZE) {\n+              for (LiveInstance liveInstance : liveInstances) {\n+                if (liveInstance.getInstanceName().equals(\"localhost_1\")) {\n+                  try {\n+                    helixManager.addCurrentStateChangeListener(\n+                        (CurrentStateChangeListener) (instanceName, statesInfo, currentStateChangeContext) -> {\n+                          // empty callback\n+                        }, liveInstance.getInstanceName(), liveInstance.getEphemeralOwner());\n+                  } catch (Exception e) {\n+                    throw new HelixException(\n+                        \"Unexpected exception in the testConcurrentHandlerProcessing.\", e);\n+                  }\n+                }\n+              }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "167885e38dfe2e4b541628588845f2a46d92b18a"}, "originalPosition": 90}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1405, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}