{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4MzY1MDUx", "number": 1344, "title": "Reduce unnecessary getChildren call in subscribeForChanges", "bodyText": "Issues\n\n My PR addresses the following Helix issues and references them in the PR description:\n\nFixes #1343\nDescription\n\n Here are some details about my PR, including screenshots of any UI changes:\n\nIn CallbackHanlder's subscribeForChanges(), children names need to be fetched. subscribeChildChange(path, callbackType) does actually have the children list, but it doesn't return, and later getChildren() is called again. It wastes one zk call: not only wasting time in handling a callback, but also adds more read pressure to zk server.\nWe could use the return result from subscribeChildChange() and save one getChildren() call.\nThis PR also adds event types logging and removes two logs. When debugging, we can actually use the event types to determine the code logic. No need to print those two logs, which saves logging overhead when there are intensive callbacks.\nTests\n\n The following tests are written for this issue:\n\n(List the names of added unit/integration tests)\n\n The following is the result of the \"mvn test\" command on the appropriate module:\n\n[INFO] Results:\n[INFO]\n[ERROR] Failures:\n[ERROR]   TestCardDealingAdjustmentAlgorithmV2.testAlgorithmConstructor:127 expected:<9> but was:<6>\n[ERROR] org.apache.helix.controller.strategy.crushMapping.TestCardDealingAdjustmentAlgorithmV2.testComputeMappingForDifferentReplicas(org.apache.helix.controller.strategy.crushMapping.TestCardDealingAdjustmentAlgorithmV2)\n[ERROR]   Run 1: TestCardDealingAdjustmentAlgorithmV2.testComputeMappingForDifferentReplicas:273 Total movements: 4 != expected 8, replica: 1\n[ERROR]   Run 2: TestCardDealingAdjustmentAlgorithmV2.testComputeMappingForDifferentReplicas:273 Total movements: 4 != expected 8, replica: 2\n[ERROR]   Run 3: TestCardDealingAdjustmentAlgorithmV2.testComputeMappingForDifferentReplicas:273 Total movements: 14 != expected 21, replica: 3\n[INFO]   Run 4: PASS\n[INFO]   Run 5: PASS\n[INFO]\n[INFO]\n[ERROR] Tests run: 1204, Failures: 2, Errors: 0, Skipped: 1\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD FAILURE\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  01:12 h\n[INFO] Finished at: 2020-09-24T16:30:00-07:00\n[INFO] ------------------------------------------------------------------------\n\n\n[INFO] Tests run: 27, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.483 s - in org.apache.helix.controller.strategy.crushMapping.TestCardDealingAdjustmentAlgorithmV2\n[INFO]\n[INFO] Results:\n[INFO]\n[INFO] Tests run: 27, Failures: 0, Errors: 0, Skipped: 0\n[INFO]\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  7.198 s\n[INFO] Finished at: 2020-09-24T17:35:52-07:00\n[INFO] ------------------------------------------------------------------------\n\nDocumentation (Optional)\n\nIn case of new functionality, my PR adds documentation in the following wiki page:\n\n(Link the GitHub wiki you added)\nCommits\n\nMy commits all reference appropriate Apache Helix GitHub issues in their subject lines. In addition, my commits follow the guidelines from \"How to write a good git commit message\":\n\nSubject is separated from body by a blank line\nSubject is limited to 50 characters (not including Jira issue reference)\nSubject does not end with a period\nSubject uses the imperative mood (\"add\", not \"adding\")\nBody wraps at 72 characters\nBody explains \"what\" and \"why\", not \"how\"\n\n\n\nCode Quality\n\nMy diff has been formatted using helix-style.xml\n(helix-style-intellij.xml if IntelliJ IDE is used)", "createdAt": "2020-09-03T05:25:17Z", "url": "https://github.com/apache/helix/pull/1344", "merged": true, "mergeCommit": {"oid": "b0b9911d803227c2595d19a0c1d894f996848ce6"}, "closed": true, "closedAt": "2020-09-25T06:40:42Z", "author": {"login": "huizhilu"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFJwI7gBqjM3MjI5NDgxOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMLbAlgH2gAyNDc4MzY1MDUxOjE3M2I5MTFiNGVmZTBkZjQ5NjRjYTQzOWM0YTgyZmEzMTA4YjdmNGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d5d6bbecdc9cc1d2045cfa22479dcf99e772045", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/6d5d6bbecdc9cc1d2045cfa22479dcf99e772045", "committedDate": "2020-09-03T05:17:24Z", "message": "Reduce duplicate getChildren call in subscribeForChanges"}, "afterCommit": {"oid": "6cdc6ce5d03d8e7482830c44be1a132febe2a2aa", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/6cdc6ce5d03d8e7482830c44be1a132febe2a2aa", "committedDate": "2020-09-03T05:28:06Z", "message": "Reduce unnecessary getChildren call in subscribeForChanges"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNTA2MTE3", "url": "https://github.com/apache/helix/pull/1344#pullrequestreview-481506117", "createdAt": "2020-09-03T05:39:21Z", "commit": {"oid": "6cdc6ce5d03d8e7482830c44be1a132febe2a2aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwNTozOToyMVrOHMWoLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwNTozOToyMVrOHMWoLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcxNTY5NA==", "bodyText": "I feel like we could create an empty list here. So we won\u2019t return a null and no need to do the nullptr check later.", "url": "https://github.com/apache/helix/pull/1344#discussion_r482715694", "createdAt": "2020-09-03T05:39:21Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -533,7 +533,7 @@ public void invoke(NotificationContext changeContext) throws Exception {\n     }\n   }\n \n-  private void subscribeChildChange(String path, NotificationContext.Type callbackType) {\n+  private List<String> subscribeChildChange(String path, NotificationContext.Type callbackType) {\n     if (callbackType == NotificationContext.Type.INIT", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cdc6ce5d03d8e7482830c44be1a132febe2a2aa"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNjAxNDkw", "url": "https://github.com/apache/helix/pull/1344#pullrequestreview-481601490", "createdAt": "2020-09-03T08:14:45Z", "commit": {"oid": "6cdc6ce5d03d8e7482830c44be1a132febe2a2aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwODoxNDo0NVrOHMbVQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwODoxNDo0NVrOHMbVQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc5Mjc3MA==", "bodyText": "There is a slightly behavior difference here. Originally before this change, if type is Finalize, we still iterate trough all node and do subscribeDataChange .\nNow we do not return a children list when finalize (line 565) so we do not do subscribeDataChange for those nodes.\nI think we need to keep the getChildren when finalize. Also, This behavior difference cause unit test TestListenerCallbackBatchMode fail on my side. May I ask did you run in to this problem?\nThx.", "url": "https://github.com/apache/helix/pull/1344#discussion_r482792770", "createdAt": "2020-09-03T08:14:45Z", "author": {"login": "xyuanlu"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -646,10 +645,9 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n               break;\n             }\n             default: {\n-              List<String> childNames = _zkClient.getChildren(path);\n-              if (childNames != null) {\n-                for (String childName : childNames) {\n-                  String childPath = path + \"/\" + childName;\n+              if (children != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cdc6ce5d03d8e7482830c44be1a132febe2a2aa"}, "originalPosition": 70}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cdc6ce5d03d8e7482830c44be1a132febe2a2aa", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/6cdc6ce5d03d8e7482830c44be1a132febe2a2aa", "committedDate": "2020-09-03T05:28:06Z", "message": "Reduce unnecessary getChildren call in subscribeForChanges"}, "afterCommit": {"oid": "f45fddee6e66505621a9bcb10730a833cd7e1f92", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/f45fddee6e66505621a9bcb10730a833cd7e1f92", "committedDate": "2020-09-03T18:12:07Z", "message": "Reduce unnecessary getChildren call in subscribeForChanges"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f45fddee6e66505621a9bcb10730a833cd7e1f92", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/f45fddee6e66505621a9bcb10730a833cd7e1f92", "committedDate": "2020-09-03T18:12:07Z", "message": "Reduce unnecessary getChildren call in subscribeForChanges"}, "afterCommit": {"oid": "651ac9f2d06009398508917da73076369a5a4045", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/651ac9f2d06009398508917da73076369a5a4045", "committedDate": "2020-09-03T18:50:30Z", "message": "Reduce unnecessary getChildren call in subscribeForChanges"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "651ac9f2d06009398508917da73076369a5a4045", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/651ac9f2d06009398508917da73076369a5a4045", "committedDate": "2020-09-03T18:50:30Z", "message": "Reduce unnecessary getChildren call in subscribeForChanges"}, "afterCommit": {"oid": "c56b2ada3d7659acde4e3528eff737dbb7b97a4a", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/c56b2ada3d7659acde4e3528eff737dbb7b97a4a", "committedDate": "2020-09-03T18:51:30Z", "message": "Reduce unnecessary getChildren call in subscribeForChanges"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMDkwNzQ4", "url": "https://github.com/apache/helix/pull/1344#pullrequestreview-482090748", "createdAt": "2020-09-03T18:18:56Z", "commit": {"oid": "f45fddee6e66505621a9bcb10730a833cd7e1f92"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxODoxODo1NlrOHMyUPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxOToyNjowNlrOHM0gpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2OTM0Mw==", "bodyText": "Method comment, please.", "url": "https://github.com/apache/helix/pull/1344#discussion_r483169343", "createdAt": "2020-09-03T18:18:56Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -533,7 +533,7 @@ public void invoke(NotificationContext changeContext) throws Exception {\n     }\n   }\n \n-  private void subscribeChildChange(String path, NotificationContext.Type callbackType) {\n+  private List<String> subscribeChildChange(String path, NotificationContext.Type callbackType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f45fddee6e66505621a9bcb10730a833cd7e1f92"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwMTgxNA==", "bodyText": "Is it possible that you just return ChildrenSubscribeResult?\nThen if _isInstalled is false, no one will read the children. Otherwise, if _isInstalled, then the list should never be null.", "url": "https://github.com/apache/helix/pull/1344#discussion_r483201814", "createdAt": "2020-09-03T19:19:00Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -533,7 +533,7 @@ public void invoke(NotificationContext changeContext) throws Exception {\n     }\n   }\n \n-  private void subscribeChildChange(String path, NotificationContext.Type callbackType) {\n+  private List<String> subscribeChildChange(String path, NotificationContext.Type callbackType) {\n     if (callbackType == NotificationContext.Type.INIT", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcxNTY5NA=="}, "originalCommit": {"oid": "6cdc6ce5d03d8e7482830c44be1a132febe2a2aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwMjg2Mg==", "bodyText": "For debug, please add new fields to the end of the string. And don't change the existing content if they are not hurt too much. Otherwise, the dev needs to switch the code version back and forth to double-check before debugging the older version deployment.", "url": "https://github.com/apache/helix/pull/1344#discussion_r483202862", "createdAt": "2020-09-03T19:21:08Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -592,8 +595,8 @@ private void subscribeForChangesAsyn(NotificationContext.Type callbackType, Stri\n \n   private void subscribeForChanges(NotificationContext.Type callbackType, String path,\n       boolean watchChild) {\n-    logger.info(\"Subscribing changes listener to path: {}, type: {}, listener: {}\", path,\n-        callbackType, _listener);\n+    logger.info(\"Subscribing changes listener to path: {}, callback type: {}, event types: {}, \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c56b2ada3d7659acde4e3528eff737dbb7b97a4a"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwMzU0MQ==", "bodyText": "I personally think these 2 info logs are still desired. Especially we are changing the subscription mechanism.", "url": "https://github.com/apache/helix/pull/1344#discussion_r483203541", "createdAt": "2020-09-03T19:22:30Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -604,11 +607,8 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n     }\n \n     if (_eventTypes.contains(EventType.NodeChildrenChanged)) {\n-      logger.info(\"Subscribing child change listener to path: {}\", path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c56b2ada3d7659acde4e3528eff737dbb7b97a4a"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwNTI4Ng==", "bodyText": "As I mentioned above, if the return value is ChildrenSubscribeResult, then you just need to check \"_isInstalled\" for the following logic.", "url": "https://github.com/apache/helix/pull/1344#discussion_r483205286", "createdAt": "2020-09-03T19:26:06Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -646,10 +645,14 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n               break;\n             }\n             default: {\n-              List<String> childNames = _zkClient.getChildren(path);\n-              if (childNames != null) {\n-                for (String childName : childNames) {\n-                  String childPath = path + \"/\" + childName;\n+              // When callback type is FINALIZE or PERIODIC_REFRESH, subscribeChildChange doesn't\n+              // get children list. We need to read children to unsubscribe data change listeners.\n+              if (callbackType != Type.INIT && callbackType != Type.CALLBACK) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c56b2ada3d7659acde4e3528eff737dbb7b97a4a"}, "originalPosition": 72}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c56b2ada3d7659acde4e3528eff737dbb7b97a4a", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/c56b2ada3d7659acde4e3528eff737dbb7b97a4a", "committedDate": "2020-09-03T18:51:30Z", "message": "Reduce unnecessary getChildren call in subscribeForChanges"}, "afterCommit": {"oid": "7dd53547af981b0760d522d23012c25d99e2445f", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/7dd53547af981b0760d522d23012c25d99e2445f", "committedDate": "2020-09-03T19:36:20Z", "message": "Reduce unnecessary getChildren call in subscribeForChanges"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMTYzMjMw", "url": "https://github.com/apache/helix/pull/1344#pullrequestreview-482163230", "createdAt": "2020-09-03T20:06:25Z", "commit": {"oid": "7dd53547af981b0760d522d23012c25d99e2445f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMDowNjoyNlrOHM1rvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMDowNjoyNlrOHM1rvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyNDUwOQ==", "bodyText": "Parallel this using Asyc should bring more performance gain, right? why don't we do it here?", "url": "https://github.com/apache/helix/pull/1344#discussion_r483224509", "createdAt": "2020-09-03T20:06:26Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -646,10 +645,14 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n               break;\n             }\n             default: {\n-              List<String> childNames = _zkClient.getChildren(path);\n-              if (childNames != null) {\n-                for (String childName : childNames) {\n-                  String childPath = path + \"/\" + childName;\n+              // When callback type is FINALIZE, subscribeChildChange doesn't\n+              // get children list. We need to read children to unsubscribe data change listeners.\n+              if (callbackType == Type.FINALIZE) {\n+                children = _zkClient.getChildren(path);\n+              }\n+              if (children != null) {\n+                for (String child : children) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dd53547af981b0760d522d23012c25d99e2445f"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMTY1MzUw", "url": "https://github.com/apache/helix/pull/1344#pullrequestreview-482165350", "createdAt": "2020-09-03T20:09:43Z", "commit": {"oid": "7dd53547af981b0760d522d23012c25d99e2445f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMDowOTo0M1rOHM1x9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMDowOTo0M1rOHM1x9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIyNjEwMg==", "bodyText": "I think the main issue here is that line 551\n_zkClient.subscribeChildChanges(path, this, callbackType != Type.INIT); we have two code path.\nif callbackType is init, the parent path of callback handler may not be created. Thus, the return would be null, or empty? Please verify.\nThe potentially issue is that note later at default, we re-use the return children list from here.\nNote, original code retrieve children one more time and it may retrieve node by then. Here, it may not.\nThis is different from previous logic. Not sure if this would bring a bug or not.", "url": "https://github.com/apache/helix/pull/1344#discussion_r483226102", "createdAt": "2020-09-03T20:09:43Z", "author": {"login": "kaisun2000"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -554,12 +554,15 @@ private void subscribeChildChange(String path, NotificationContext.Type callback\n       if (!childrenSubscribeResult.isInstalled()) {\n         logger.info(\"CallbackHandler {} subscribe data path {} failed!\", this, path);\n       }\n+      return childrenSubscribeResult.getChildren();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dd53547af981b0760d522d23012c25d99e2445f"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5OTQ2NDY3", "url": "https://github.com/apache/helix/pull/1344#pullrequestreview-489946467", "createdAt": "2020-09-16T19:13:32Z", "commit": {"oid": "0eb643fb3620ea3381c5547432f13214a793ff2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOToxMzozMlrOHTAV3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOToxMzozMlrOHTAV3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5MDU4OA==", "bodyText": "As we discussed, I think this check is not necessary. The later check for children != null is good enough.\nIf the node was not created and then create during this callback processing, then we will have another callback to process the event since the watcher has been added.", "url": "https://github.com/apache/helix/pull/1344#discussion_r489690588", "createdAt": "2020-09-16T19:13:32Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -646,10 +652,14 @@ private void subscribeForChanges(NotificationContext.Type callbackType, String p\n               break;\n             }\n             default: {\n-              List<String> childNames = _zkClient.getChildren(path);\n-              if (childNames != null) {\n-                for (String childName : childNames) {\n-                  String childPath = path + \"/\" + childName;\n+              // When callback type is FINALIZE, subscribeChildChange doesn't\n+              // get children list. We need to read children to unsubscribe data change listeners.\n+              if (callbackType == Type.FINALIZE) {\n+                children = _zkClient.getChildren(path);\n+              }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0eb643fb3620ea3381c5547432f13214a793ff2a"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c5eecd19d8aeb859f91efce182ad0fdf20caf5c", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/6c5eecd19d8aeb859f91efce182ad0fdf20caf5c", "committedDate": "2020-09-24T21:59:33Z", "message": "Reduce unnecessary getChildren call in subscribeForChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e6598db2dd5c735a5a2335a543eed8183ae4bbd", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/9e6598db2dd5c735a5a2335a543eed8183ae4bbd", "committedDate": "2020-09-24T22:02:39Z", "message": "Add comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0eb643fb3620ea3381c5547432f13214a793ff2a", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/0eb643fb3620ea3381c5547432f13214a793ff2a", "committedDate": "2020-09-03T22:34:37Z", "message": "Add comments"}, "afterCommit": {"oid": "26c8b0dda05a40cc72af93b3e03ce59c797753e0", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/26c8b0dda05a40cc72af93b3e03ce59c797753e0", "committedDate": "2020-09-24T22:02:40Z", "message": "Return children for FINALIZE in subscribeChildChange"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8397ce26bb449c9bf76c995377051c05a895ed1b", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/8397ce26bb449c9bf76c995377051c05a895ed1b", "committedDate": "2020-09-24T22:10:35Z", "message": "Return children in subscribeChildChange"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26c8b0dda05a40cc72af93b3e03ce59c797753e0", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/26c8b0dda05a40cc72af93b3e03ce59c797753e0", "committedDate": "2020-09-24T22:02:40Z", "message": "Return children for FINALIZE in subscribeChildChange"}, "afterCommit": {"oid": "8397ce26bb449c9bf76c995377051c05a895ed1b", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/8397ce26bb449c9bf76c995377051c05a895ed1b", "committedDate": "2020-09-24T22:10:35Z", "message": "Return children in subscribeChildChange"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MDQ1MjY0", "url": "https://github.com/apache/helix/pull/1344#pullrequestreview-496045264", "createdAt": "2020-09-25T01:01:46Z", "commit": {"oid": "8397ce26bb449c9bf76c995377051c05a895ed1b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMTowMTo0NlrOHXxfiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMTowMTo0NlrOHXxfiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY5MDE4NQ==", "bodyText": "The current logic will return a list even the type is not INIT/CALLBACK/FINALIZE, right? Although I guess it is expected.\n\nPlease fix the comment.\nThe method name becomes misleading somehow with this change. I guess it should be called getChildrenAndSubscribeChildChange. Obviously, not a good name. But feel free to change if you have a better idea. This is just a nice to have thing.", "url": "https://github.com/apache/helix/pull/1344#discussion_r494690185", "createdAt": "2020-09-25T01:01:46Z", "author": {"login": "jiajunwang"}, "path": "helix-core/src/main/java/org/apache/helix/manager/zk/CallbackHandler.java", "diffHunk": "@@ -538,7 +538,12 @@ public void invoke(NotificationContext changeContext) throws Exception {\n     }\n   }\n \n-  private void subscribeChildChange(String path, NotificationContext.Type callbackType) {\n+  /*\n+   * If callback type is INIT or CALLBACK, subscribes child change listener to the path\n+   * and returns the path's children names. The children list might be null when the path\n+   * doesn't exist or callback type is other than INIT/CALLBACK/FINALIZE.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8397ce26bb449c9bf76c995377051c05a895ed1b"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "173b911b4efe0df4964ca439c4a82fa3108b7f4e", "author": {"user": {"login": "huizhilu", "name": "Huizhi Lu"}}, "url": "https://github.com/apache/helix/commit/173b911b4efe0df4964ca439c4a82fa3108b7f4e", "committedDate": "2020-09-25T01:22:47Z", "message": "Change comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4260, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}