{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNzk2MTI2", "number": 1558, "title": "Add code to handle legacy PTU (5.0)", "bodyText": "Fixes #1541 partly for 5.0\nThis PR is ready for review.\nRisk\nThis PR makes no API changes.\nTesting Plan\n\n I have verified that I have not introduced new warnings in this PR (or explain why below)\n I have run the unit tests with this PR\n I have tested Android, Java SE, and Java EE\n\nSummary\nSame changes present as the PR #1552\nThis PR should be reviewed and tested at the same time as it will require a Sync 2.0 TDK\nChangelog\nBug Fixes\n\nFixes issue where policy table updates wouldn't occur on older systems\n\nCLA\n\n I have signed the CLA", "createdAt": "2020-11-13T19:06:59Z", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1558", "merged": true, "mergeCommit": {"oid": "fe54f99f168e9ae5485d32211c333ecc6b064543"}, "closed": true, "closedAt": "2020-11-17T18:47:16Z", "author": {"login": "joeygrover"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcL6sngH2gAyNTIwNzk2MTI2OmEwYmZhM2JhNDcwMjVkMzQ4MTA5NzVjMTEzMjZhODUyMGFiMzg4ZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddc3MYAFqTUzMjYwNzM3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a0bfa3ba47025d34810975c11326a8520ab388f2", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/a0bfa3ba47025d34810975c11326a8520ab388f2", "committedDate": "2020-11-13T19:00:11Z", "message": "Add code to handle legacy PTU"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNzgxNTAy", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1558#pullrequestreview-531781502", "createdAt": "2020-11-16T21:09:12Z", "commit": {"oid": "a0bfa3ba47025d34810975c11326a8520ab388f2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTowOToxMlrOH0SAfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTowOToxMlrOH0SAfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU4MzAzNg==", "bodyText": "This logs a warning when we get a system request with type LOCK_SCREEN_ICON_URL", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1558#discussion_r524583036", "createdAt": "2020-11-16T21:09:12Z", "author": {"login": "bilal-alsharifi"}, "path": "base/src/main/java/com/smartdevicelink/managers/lifecycle/BaseLifecycleManager.java", "diffHunk": "@@ -387,42 +391,62 @@ public void onReceived(RPCMessage message) {\n                     case ON_HASH_CHANGE:\n                         break;\n                     case ON_SYSTEM_REQUEST:\n+                    case ON_ENCODED_SYNC_P_DATA:\n+                    case ON_SYNC_P_DATA:\n+                        if (functionID.equals(FunctionID.ON_ENCODED_SYNC_P_DATA) || functionID.equals(FunctionID.ON_SYNC_P_DATA)) {\n+                            DebugTool.logInfo(TAG, \"Received legacy SYNC_P_DATA, handling it as OnSystemRequest\");\n+                        } else {\n+                            DebugTool.logInfo(TAG, \"Received OnSystemRequest\");\n+                        }\n+\n                         final OnSystemRequest onSystemRequest = (OnSystemRequest) message;\n-                        if ((onSystemRequest.getUrl() != null) &&\n-                                (((onSystemRequest.getRequestType() == RequestType.PROPRIETARY) && (onSystemRequest.getFileType() == FileType.JSON))\n-                                        || ((onSystemRequest.getRequestType() == RequestType.HTTP) && (onSystemRequest.getFileType() == FileType.BINARY)))) {\n-                            Thread handleOffboardTransmissionThread = new Thread() {\n-                                @Override\n-                                public void run() {\n-                                    RPCRequest request = PoliciesFetcher.fetchPolicies(onSystemRequest);\n-                                    if (request != null && isConnected()) {\n-                                        sendRPCMessagePrivate(request, true);\n+                        RequestType requestType = onSystemRequest.getRequestType();\n+                        FileType fileType = onSystemRequest.getFileType();\n+\n+                        if (onSystemRequest.getUrl() != null) {\n+                            if ((requestType == RequestType.PROPRIETARY && fileType == FileType.JSON)\n+                                    || (requestType == RequestType.HTTP && fileType == FileType.BINARY)\n+                                    || functionID.equals(FunctionID.ON_ENCODED_SYNC_P_DATA)\n+                                    || functionID.equals(FunctionID.ON_SYNC_P_DATA)) {\n+                                DebugTool.logInfo(TAG, \"List of conditionals has passed\");\n+                                Thread handleOffboardTransmissionThread = new Thread() {\n+                                    @Override\n+                                    public void run() {\n+                                        DebugTool.logInfo(TAG, \"Attempting to fetch policies\");\n+                                        RPCRequest request = PoliciesFetcher.fetchPolicies(onSystemRequest);\n+                                        if (request != null && isConnected()) {\n+                                            sendRPCMessagePrivate(request, true);\n+                                        }\n                                     }\n-                                }\n-                            };\n-                            handleOffboardTransmissionThread.start();\n-                        } else if (onSystemRequest.getRequestType() == RequestType.ICON_URL && onSystemRequest.getUrl() != null) {\n-                            //Download the icon file and send SystemRequest RPC\n-                            Thread handleOffBoardTransmissionThread = new Thread() {\n-                                @Override\n-                                public void run() {\n-                                    final String urlHttps = onSystemRequest.getUrl().replaceFirst(\"http://\", \"https://\");\n-                                    byte[] file = FileUtls.downloadFile(urlHttps);\n-                                    if (file != null) {\n-                                        SystemRequest systemRequest = new SystemRequest();\n-                                        systemRequest.setFileName(onSystemRequest.getUrl());\n-                                        systemRequest.setBulkData(file);\n-                                        systemRequest.setRequestType(RequestType.ICON_URL);\n-                                        if (isConnected()) {\n-                                            sendRPCMessagePrivate(systemRequest, true);\n+                                };\n+                                handleOffboardTransmissionThread.start();\n+                                return;\n+                            } else if (requestType == RequestType.ICON_URL) {\n+                                //Download the icon file and send SystemRequest RPC\n+                                Thread handleOffBoardTransmissionThread = new Thread() {\n+                                    @Override\n+                                    public void run() {\n+                                        final String urlHttps = onSystemRequest.getUrl().replaceFirst(\"http://\", \"https://\");\n+                                        byte[] file = FileUtls.downloadFile(urlHttps);\n+                                        if (file != null) {\n+                                            SystemRequest systemRequest = new SystemRequest();\n+                                            systemRequest.setFileName(onSystemRequest.getUrl());\n+                                            systemRequest.setBulkData(file);\n+                                            systemRequest.setRequestType(RequestType.ICON_URL);\n+                                            if (isConnected()) {\n+                                                sendRPCMessagePrivate(systemRequest, true);\n+                                            }\n+                                        } else {\n+                                            DebugTool.logError(TAG, \"File was null at: \" + urlHttps);\n                                         }\n-                                    } else {\n-                                        DebugTool.logError(TAG, \"File was null at: \" + urlHttps);\n                                     }\n-                                }\n-                            };\n-                            handleOffBoardTransmissionThread.start();\n+                                };\n+                                handleOffBoardTransmissionThread.start();\n+                                return;\n+                            }\n                         }\n+\n+                        DebugTool.logWarning(TAG, \"Unable to handle OnSystemRequest\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0bfa3ba47025d34810975c11326a8520ab388f2"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e08da3b56644b938b848f489f633b281164388ef", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/e08da3b56644b938b848f489f633b281164388ef", "committedDate": "2020-11-16T21:43:52Z", "message": "Remove misleading log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNjA3Mzc5", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1558#pullrequestreview-532607379", "createdAt": "2020-11-17T17:18:40Z", "commit": {"oid": "e08da3b56644b938b848f489f633b281164388ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2111, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}