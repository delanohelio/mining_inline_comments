{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1Nzc5Nzky", "number": 1517, "title": "Correct Lockscreen start behavior", "bodyText": "Fixes #1515\nThis PR is ready for review.\nRisk\nThis PR makes no API changes.\nTesting Plan\n\n I have verified that I have not introduced new warnings in this PR (or explain why below)\n I have run the unit tests with this PR\n I have tested this PR against Core and verified behavior (if applicable, if not applicable, explain why below).\n I have tested Android\n\nCore Tests (Manticore)\nCreate app with Lockscreen config:\nLockScreenConfig lockScreenConfig = new LockScreenConfig();\nlockScreenConfig.setDisplayMode(LockScreenConfig.DISPLAY_MODE_ALWAYS);\nlockScreenConfig.enableDismissGesture(true);\nTest 1:\n\nEnsure DriverDistraction is OFF on Manticore\nDeploy app\nNotice the lockscreen appears\nEnable DriverDistraction on Manticore\nNotice there is now the option to swipe away lockscreen\nSwipe away lockscreen\nNotice no lockscreen is displayed\nTurn OFF DriverDistraction on Manticore\nNotice no lockscreen is displayed\n\nTest 2:\n\nEnsure DriverDistraction is ON on Manticore\nDeploy app\nNotice the lockscreen appears with option to swipe away\nSwipe away lockscreen\nNotice no lockscreen is displayed\nTurn off DriverDistraction on Manticore\nNotice no lockscreen is displayed\n\nTest 3:\n\nEnsure DriverDistraction is OFF on Core\nDeploy app\nNotice the lockscreen appears\nEnable DriverDistraction on Core with lockScreenDismissalEnabled= true\nNotice there is now the option to swipe away lockscreen\nTurn OFF DriverDistraction on Core\nNotice lockscreen is still viewable\nEnable DriverDistraction on Core with lockScreenDismissalEnabled= false\nNotice there is no longer an option to swipe away lockscreen and swiping does not dismiss lockscreen\nRepeat steps 4-6\n\nSummary\n\nAdded a check to prevent multiple startActivity calls with the same intent. There is a race condition when starting an app that instantly connects with Core that causes this.\nAdded a delay for a known (second call\" to start the lockscreen activity. This is due to the calls to start the activity being too close and the system will simply queue up the intent and restart the activity right after it finishes.\nRefactored logic in lockscreen activity and DD handling to allow updating of lockscreen properly past initial launch.\nRefactored some methods and variables to better adhere to coding style and more descriptive naming.\n\nChangelog\nBug Fixes\n\nPrevents a duplication startActivity call and therefore the lockscreen is not displayed again after dismissal\nFix issue where dismissible state goes from Enabled to Disabled\n\nCLA\n\n I have signed the CLA", "createdAt": "2020-09-30T20:49:12Z", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1517", "merged": true, "mergeCommit": {"oid": "1cd37116aa21df73a70a6fe48b956f9bec144b8c"}, "closed": true, "closedAt": "2020-10-05T17:31:52Z", "author": {"login": "joeygrover"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN-cfWgH2gAyNDk1Nzc5NzkyOmY4YzYxYjllYTc5Yzk3NDMyOTkzZWQ4Y2RkYmFiZDk3ZWUxODMyZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPnRH5AFqTUwMjI3MjUxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f8c61b9ea79c97432993ed8cddbabd97ee1832f5", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f8c61b9ea79c97432993ed8cddbabd97ee1832f5", "committedDate": "2020-09-30T15:23:29Z", "message": "Prevent multiple startActivity calls for same intent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdcc5ba5dc865792a1cbe7ecb86f8765d7fc3d84", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/fdcc5ba5dc865792a1cbe7ecb86f8765d7fc3d84", "committedDate": "2020-09-30T20:29:36Z", "message": "Fix case launching lockscreen too many times\n\nAlso refactored a local var according to style guide (no starting m)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4b6c396a0a7982add2971c5ac8b3dea947ecf7d", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/e4b6c396a0a7982add2971c5ac8b3dea947ecf7d", "committedDate": "2020-09-30T21:14:27Z", "message": "Fix lockscreen tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32f6ef485af63d9641dc445ee832b0db24417b13", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/32f6ef485af63d9641dc445ee832b0db24417b13", "committedDate": "2020-10-01T15:43:33Z", "message": "Combine bools for lockscreen dismiss extra"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99ca5abb4cd58b80c9518623e57815d3cd6deef3", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/99ca5abb4cd58b80c9518623e57815d3cd6deef3", "committedDate": "2020-10-01T20:45:55Z", "message": "Fix check in dismissable change for lockscreen"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bda6f5fbaa8181606ef6cdbeff2f135b5a333c8", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/1bda6f5fbaa8181606ef6cdbeff2f135b5a333c8", "committedDate": "2020-10-01T21:22:10Z", "message": "Add another case for updating lockscreen"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf88ecdcefaec6d0e24df91a3f7767b080b1e521", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/bf88ecdcefaec6d0e24df91a3f7767b080b1e521", "committedDate": "2020-10-02T15:47:30Z", "message": "Refactor lockscreen acitivity and DD code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9cca6219636e272cce1bfb2b1f33864cbef3f4c", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/a9cca6219636e272cce1bfb2b1f33864cbef3f4c", "committedDate": "2020-10-05T15:48:36Z", "message": "Fix logic handling for dismiss  \u201cnull\u201d case param"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMjQ1ODE2", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1517#pullrequestreview-502245816", "createdAt": "2020-10-05T16:54:37Z", "commit": {"oid": "a9cca6219636e272cce1bfb2b1f33864cbef3f4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjo1NDozN1rOHcltXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjo1NDozN1rOHcltXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczOTk5OA==", "bodyText": "@joeygrover The comment and the logic are mismatched here.\nshould this be:\nif(ddState.getLockscreenDismissibility() == null ) {\n    isLockscreenDismissible = previousDismissibleState;\n} else {\n    isLockscreenDismissible = ddState.getLockscreenDismissibility();\n}", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1517#discussion_r499739998", "createdAt": "2020-10-05T16:54:37Z", "author": {"login": "RHenigan"}, "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenManager.java", "diffHunk": "@@ -195,34 +198,54 @@ public void onNotified(RPCNotification notification) {\n             public void onNotified(RPCNotification notification) {\n                 // do something with the status\n                 if (notification != null) {\n-                    OnDriverDistraction ddState = (OnDriverDistraction) notification;\n-                    Boolean isDismissible = ddState.getLockscreenDismissibility();\n-                    DebugTool.logInfo(TAG, \"Lock screen dismissible: \" + isDismissible);\n-                    if (isDismissible != null) {\n-                        // both of these conditions must be met to be able to dismiss lockscreen\n-                        if (isDismissible && enableDismissGesture) {\n-                            mIsLockscreenDismissible = true;\n-\n-                            // if DisplayMode is set to ALWAYS, it will be shown before the first DD notification.\n-                            // If this is our first DD notification and we are in ALWAYS mode, send another intent to\n-                            // enable the dismissal\n-                            if (!receivedFirstDDNotification && displayMode == LockScreenConfig.DISPLAY_MODE_ALWAYS) {\n-                                launchLockScreenActivity();\n+                    synchronized (this) {\n+                        OnDriverDistraction ddState = (OnDriverDistraction) notification;\n+                        driverDistStatus = DriverDistractionState.DD_ON.equals(ddState.getState());\n+                        mLockscreenWarningMsg = ddState.getLockscreenWarningMessage();\n+                        boolean previousDismissibleState = isLockscreenDismissible;\n+                        if(ddState.getLockscreenDismissibility() == null ) {\n+                            isLockscreenDismissible = ddState.getLockscreenDismissibility();\n+                        } //If the param is null, we assume it stays as the previous value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9cca6219636e272cce1bfb2b1f33864cbef3f4c"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6b38b3060eecff77a28c7785ec0816ed4539ec9", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/a6b38b3060eecff77a28c7785ec0816ed4539ec9", "committedDate": "2020-10-05T17:06:30Z", "message": "Correct conditional logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMjcyNTE1", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1517#pullrequestreview-502272515", "createdAt": "2020-10-05T17:31:06Z", "commit": {"oid": "a6b38b3060eecff77a28c7785ec0816ed4539ec9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2095, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}