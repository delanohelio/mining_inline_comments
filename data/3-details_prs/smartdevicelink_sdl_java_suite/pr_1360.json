{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwOTg5MjI4", "number": 1360, "title": "Fix #1351", "bodyText": "Fixes #1351\nThis PR is ready for review.\nRisk\nThis PR makes no API changes.\nTesting Plan\n\n I have verified that I have not introduced new warnings in this PR (or explain why below)\n I have run the unit tests with this PR\n I have tested this PR against a TDK and verified behavior (if applicable, if not applicable, explain why below).\n I have tested Android\n\nTests\nThis issue is tricky to test since we have not found anyone who can actually reproduce the issue. Therefore we will have to simulate the issue and test around it. There are essentially two tests we can run: one to ensure the exception handler is properly triggered, and two to make sure the flag is properly saved and retrieved.\nTesting the exception handler:\nComment out line ~1514 that is notificationManager.createNotificationChannel(notificationChannel); and add a log into the exception handler. This will prevent the channel from being actually registered with the system and then the exception handler should trigger. Simply turn on the bluetooth adapter and connect to the module. The service will start up and the exception will be thrown within a few seconds.\nTesting the flag is set\nChange the previous line to\nif(getBooleanPref(KEY_AVOID_NOTIFICATION_CHANNEL_DELETE,false)){\n\tnotificationManager.createNotificationChannel(notificationChannel);\n    Log.d(TAG, \"Created channel\");\n}else{\n\tLog.d(TAG, \"Did not create channel\");\n}\n\nOn first pass this will throw the exception. The router service will shutdown. Turn off bluetooth or disconnect from the device. Then turn bluetooth back on and reconnect to the device. This time, since the flag was set, the channel will be created.\nSummary\n\nAdded an exception handler for the runtime exception caused by some poor Android implementations around the notification channel. Samsung devices don't seem to properly handle the case where we delete the notification channel after the service exits the foreground. Even though we create the channel on every foreground entrance, the OS doesn't honor that and the crashes. Therefore the handler was added and a flag will be set to prevent the channel deletion in the next run of the router service.\nIncreased the\n\nChangelog\nBug Fixes\n\nApp will no longer crash. Dynamic behavior is in place to still allow SDL to function.\n\nCLA\n\n I have signed the CLA", "createdAt": "2020-05-20T20:00:01Z", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1360", "merged": true, "mergeCommit": {"oid": "9946777469c0f58a9732cab42669c56850edb761"}, "closed": true, "closedAt": "2020-05-26T14:44:11Z", "author": {"login": "joeygrover"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjOLRigH2gAyNDIwOTg5MjI4OjlhYmNmODhhNDI1M2ZhYWU5NDA1ZDc0ZDgyYmIyMjRiYjQyNWM5YjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclFiV7gH2gAyNDIwOTg5MjI4OmI2YTBhNjI2ZTE4NjFkN2NmMzEzZjMyODFmYTljMDg2ODJmYjU0MGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9abcf88a4253faae9405d74d82bb224bb425c9b2", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/9abcf88a4253faae9405d74d82bb224bb425c9b2", "committedDate": "2020-05-20T19:24:25Z", "message": "Fix #1351"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NDE3NTIz", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1360#pullrequestreview-416417523", "createdAt": "2020-05-21T19:11:06Z", "commit": {"oid": "9abcf88a4253faae9405d74d82bb224bb425c9b2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxOToxMTowNlrOGY_W9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxOToxMTowNlrOGY_W9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1NzA3OA==", "bodyText": "I think we should call this method first thing in onCreate() because currently, the service could enter foreground before adding the exception handler", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1360#discussion_r428857078", "createdAt": "2020-05-21T19:11:06Z", "author": {"login": "bilal-alsharifi"}, "path": "android/sdl_android/src/main/java/com/smartdevicelink/transport/SdlRouterService.java", "diffHunk": "@@ -1170,6 +1178,9 @@ protected void deployNextRouterService(){\n \t}\n \t\n \tpublic void startUpSequence(){\n+\n+\t\tsetRouterServiceExceptionHandler();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9abcf88a4253faae9405d74d82bb224bb425c9b2"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1e5a2da78b4e5f13fbffcb9f873d3b5c8978c5d", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f1e5a2da78b4e5f13fbffcb9f873d3b5c8978c5d", "committedDate": "2020-05-22T18:11:55Z", "message": "Move exception handler set to start of oncreate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3622bf7bafb6aa7553ef5a08e6ea0d45eb2a7e77", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/3622bf7bafb6aa7553ef5a08e6ea0d45eb2a7e77", "committedDate": "2020-05-22T18:13:02Z", "message": "Add try/catch to setting prefs in exception handlr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTA0MDYz", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1360#pullrequestreview-417104063", "createdAt": "2020-05-22T18:19:22Z", "commit": {"oid": "f1e5a2da78b4e5f13fbffcb9f873d3b5c8978c5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxODoxOToyMlrOGZf_gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxODoxOToyMlrOGZf_gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM5MTc0NQ==", "bodyText": "Spacing seems to be strange here.", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1360#discussion_r429391745", "createdAt": "2020-05-22T18:19:22Z", "author": {"login": "bilal-alsharifi"}, "path": "android/sdl_android/src/main/java/com/smartdevicelink/transport/SdlRouterService.java", "diffHunk": "@@ -1107,7 +1107,9 @@ private boolean initCheck(){\n \t@Override\n \tpublic void onCreate() {\n \t\tsuper.onCreate();\n-\t\t//This must be done regardless of if this service shuts down or not\n+\t\t//Add this first to avoid the runtime exceptions for the entire lifecycle of the service\n+        setRouterServiceExceptionHandler();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1e5a2da78b4e5f13fbffcb9f873d3b5c8978c5d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTA0MjI0", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1360#pullrequestreview-417104224", "createdAt": "2020-05-22T18:19:41Z", "commit": {"oid": "3622bf7bafb6aa7553ef5a08e6ea0d45eb2a7e77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxODoxOTo0MVrOGZf_8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxODoxOTo0MVrOGZf_8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM5MTg1OA==", "bodyText": "Spacing seems to be strange here as well.", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1360#discussion_r429391858", "createdAt": "2020-05-22T18:19:41Z", "author": {"login": "bilal-alsharifi"}, "path": "android/sdl_android/src/main/java/com/smartdevicelink/transport/SdlRouterService.java", "diffHunk": "@@ -1229,7 +1229,11 @@ public void uncaughtException(Thread t, Throwable e) {\n \t\t\t\t\t\t\t&& e.getMessage().contains(\"invalid channel for service notification\")) { //This is the message received in the exception for notification channel issues\n \n \t\t\t\t\t\t// Set the flag to not delete the notification channel to avoid this exception in the future\n-\t\t\t\t\t\tSdlRouterService.this.setSdlRouterServicePrefs(KEY_AVOID_NOTIFICATION_CHANNEL_DELETE, true);\n+\t\t\t\t\t\ttry{\n+\t\t\t\t\t\t    SdlRouterService.this.setSdlRouterServicePrefs(KEY_AVOID_NOTIFICATION_CHANNEL_DELETE, true);\n+                        }catch (Exception exception){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3622bf7bafb6aa7553ef5a08e6ea0d45eb2a7e77"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70b159561e5eada8859580532149cbf59c955555", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/70b159561e5eada8859580532149cbf59c955555", "committedDate": "2020-05-22T18:41:57Z", "message": "Update spacing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83d53f1eaa63ea93063c5e2ba545a95af01f2715", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/83d53f1eaa63ea93063c5e2ba545a95af01f2715", "committedDate": "2020-05-22T18:42:49Z", "message": "Fix spacing for comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1fa811dda8db3c6de768501380da7858eadfd62", "author": {"user": {"login": "joeygrover", "name": "Joey Grover"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f1fa811dda8db3c6de768501380da7858eadfd62", "committedDate": "2020-05-22T18:43:56Z", "message": "Remove extra line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTE4NTE2", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1360#pullrequestreview-417118516", "createdAt": "2020-05-22T18:46:56Z", "commit": {"oid": "f1fa811dda8db3c6de768501380da7858eadfd62"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96319543277de7c3ae0ba4f645997c0fcf12e193", "author": {"user": {"login": "bilal-alsharifi", "name": "Bilal Alsharifi"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/96319543277de7c3ae0ba4f645997c0fcf12e193", "committedDate": "2020-05-26T14:27:57Z", "message": "Update version to 4.11.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6a0a626e1861d7cf313f3281fa9c08682fb540b", "author": {"user": {"login": "bilal-alsharifi", "name": "Bilal Alsharifi"}}, "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/b6a0a626e1861d7cf313f3281fa9c08682fb540b", "committedDate": "2020-05-26T14:28:19Z", "message": "Update CHANGELOG.md"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2166, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}