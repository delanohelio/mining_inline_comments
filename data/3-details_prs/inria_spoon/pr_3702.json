{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMjA3NzQ2", "number": 3702, "title": "fix: Fix Sniper printer failing to put added import statement on separate line", "bodyText": "Fix #3698\nThis is ready for review, see comments further down :)", "createdAt": "2020-11-17T07:42:03Z", "url": "https://github.com/INRIA/spoon/pull/3702", "merged": true, "mergeCommit": {"oid": "f27aa6892178481e3ac0a8902ee6b754416bc375"}, "closed": true, "closedAt": "2020-11-20T06:54:48Z", "author": {"login": "slarse"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddUlURAH2gAyNTIyMjA3NzQ2OmM3MDRhNTI1YWMyNDhmNTEwZGVkY2JkZWEzNGQ0NDJiZDlmNTA5MDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeDvCDgFqTUzNDUwNDQ1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c704a525ac248f510dedcbdea34d442bd9f50904", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/c704a525ac248f510dedcbdea34d442bd9f50904", "committedDate": "2020-11-17T07:39:54Z", "message": "Add test case to reproduce missing newline issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMDg3OTA5", "url": "https://github.com/INRIA/spoon/pull/3702#pullrequestreview-532087909", "createdAt": "2020-11-17T07:42:56Z", "commit": {"oid": "c704a525ac248f510dedcbdea34d442bd9f50904"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzo0Mjo1NlrOH0nxdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzo0Mjo1NlrOH0nxdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzOTYzNg==", "bodyText": "Removed as it interfered with my test case (removed unused imports), and no other test cases actually rely on this functionality. Very unclear why it's here.", "url": "https://github.com/INRIA/spoon/pull/3702#discussion_r524939636", "createdAt": "2020-11-17T07:42:56Z", "author": {"login": "slarse"}, "path": "src/test/java/spoon/test/prettyprinter/TestSniperPrinter.java", "diffHunk": "@@ -398,16 +418,7 @@ private void testSniper(String testClass, Consumer<CtType<?>> transformation, Bi\n \tprivate static Launcher createLauncherWithSniperPrinter() {\n \t\tLauncher launcher = new Launcher();\n \t\tlauncher.getEnvironment().setPrettyPrinterCreator(() -> {\n-\t\t\tSniperJavaPrettyPrinter printer = new SniperJavaPrettyPrinter(launcher.getEnvironment());\n-\t\t\tprinter.setPreprocessors(Collections.unmodifiableList(Arrays.<Processor<CtElement>>asList(\n-\t\t\t\t\t//remove unused imports first. Do not add new imports at time when conflicts are not resolved\n-\t\t\t\t\tnew ImportCleaner().setCanAddImports(false),\n-\t\t\t\t\t//solve conflicts, the current imports are relevant too\n-\t\t\t\t\tnew ImportConflictDetector(),\n-\t\t\t\t\t//compute final imports\n-\t\t\t\t\tnew ImportCleaner()\n-\t\t\t)));\n-\t\t\treturn printer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c704a525ac248f510dedcbdea34d442bd9f50904"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41233be4e25df6ccd4016be3eb6c9c5f0afefecc", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/41233be4e25df6ccd4016be3eb6c9c5f0afefecc", "committedDate": "2020-11-17T08:03:21Z", "message": "Fix missing newline problem with special case\n\nI'm not satisfied with this solution, there should be a more general solution"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9328914812e0c9790341d8008b655faedf45b00", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/b9328914812e0c9790341d8008b655faedf45b00", "committedDate": "2020-11-17T14:01:58Z", "message": "Replace spaces with tabs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b1a51fdc1ee2d5852f9fb9c823104e83415f992", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/2b1a51fdc1ee2d5852f9fb9c823104e83415f992", "committedDate": "2020-11-18T15:13:19Z", "message": "Add test of adding import statement in file with package statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f86367a0b705d673305635205343efa645bf2e3", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/8f86367a0b705d673305635205343efa645bf2e3", "committedDate": "2020-11-18T15:21:28Z", "message": "Strengthen tests with precondition checks on package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66ead04815ca599c1f0d8ae182518eb27de2a7af", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/66ead04815ca599c1f0d8ae182518eb27de2a7af", "committedDate": "2020-11-18T15:21:54Z", "message": "Remove redundant newline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e670936daa39bf8a5fb4dd748f66b3b36765704c", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/e670936daa39bf8a5fb4dd748f66b3b36765704c", "committedDate": "2020-11-19T13:30:06Z", "message": "Implement better fix for missing newline between import statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "889976972eaccbad74867bea8867e773222c7313", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/889976972eaccbad74867bea8867e773222c7313", "committedDate": "2020-11-19T13:47:33Z", "message": "Fix problem with missing newline after package statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84c84e16163ff18611f82c69d5246d642e3fed86", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/84c84e16163ff18611f82c69d5246d642e3fed86", "committedDate": "2020-11-19T14:06:21Z", "message": "Guard against the package being null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NTA0NDUy", "url": "https://github.com/INRIA/spoon/pull/3702#pullrequestreview-534504452", "createdAt": "2020-11-19T14:32:48Z", "commit": {"oid": "84c84e16163ff18611f82c69d5246d642e3fed86"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNDozMjo0OVrOH2hZOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNDozNTo1OVrOH2hizQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkzMjI4Mw==", "bodyText": "This is the only difference here, the rest is just indentation. In combination with the fix in visitCtPackageDeclaration, this fixes newlines after package declarations in the sniper printer.", "url": "https://github.com/INRIA/spoon/pull/3702#discussion_r526932283", "createdAt": "2020-11-19T14:32:49Z", "author": {"login": "slarse"}, "path": "src/main/java/spoon/reflect/visitor/DefaultJavaPrettyPrinter.java", "diffHunk": "@@ -1084,14 +1084,20 @@ public void visitCtCompilationUnit(CtCompilationUnit compilationUnit) {\n \t\t\t\t//note: the package-info.java may contain type declarations too\n \t\t\tbreak;\n \t\tcase TYPE_DECLARATION:\n-\t\t\t\tscan(compilationUnit.getPackageDeclaration());\n-\t\t\t\tfor (CtImport imprt : getImports(compilationUnit)) {\n-\t\t\t\t\tscan(imprt);\n-\t\t\t\t\tprinter.writeln();\n-\t\t\t\t}\n-\t\t\t\tfor (CtType<?> t : compilationUnit.getDeclaredTypes()) {\n-\t\t\t\t\tscan(t);\n-\t\t\t\t}\n+\t\t\tscan(compilationUnit.getPackageDeclaration());\n+\n+\t\t\tCtPackage pkg = compilationUnit.getDeclaredPackage();\n+\t\t\tif (pkg != null && !pkg.isUnnamedPackage()) {\n+\t\t\t\tprinter.writeln();\n+\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84c84e16163ff18611f82c69d5246d642e3fed86"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkzMjk0MA==", "bodyText": "This is the \"fix in visitCtPackageDeclaration\" I mention.", "url": "https://github.com/INRIA/spoon/pull/3702#discussion_r526932940", "createdAt": "2020-11-19T14:33:43Z", "author": {"login": "slarse"}, "path": "src/main/java/spoon/reflect/visitor/DefaultJavaPrettyPrinter.java", "diffHunk": "@@ -1111,7 +1117,7 @@ public void visitCtPackageDeclaration(CtPackageDeclaration packageDeclaration) {\n \t\tCtPackageReference ctPackage = packageDeclaration.getReference();\n \t\telementPrinterHelper.writeComment(ctPackage, CommentOffset.BEFORE);\n \t\tif (!ctPackage.isUnnamedPackage()) {\n-\t\t\telementPrinterHelper.writePackageLine(ctPackage.getQualifiedName());\n+\t\t\telementPrinterHelper.writePackageStatement(ctPackage.getQualifiedName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84c84e16163ff18611f82c69d5246d642e3fed86"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkzMzc2MA==", "bodyText": "This is the special handling of the first import statement. We may need to add more roles here as more problems crop up. Using only the condition fragmentIndex == 0 causes unwanted newlines in if/else statements, and perhaps elsewhere as well.", "url": "https://github.com/INRIA/spoon/pull/3702#discussion_r526933760", "createdAt": "2020-11-19T14:34:45Z", "author": {"login": "slarse"}, "path": "src/main/java/spoon/support/sniper/internal/AbstractSourceFragmentPrinter.java", "diffHunk": "@@ -102,6 +102,11 @@ public int update(PrinterEvent event) {\n \t\t\t//so skip printing of this comment\n \t\t\t//comment will be printed at place where it belongs to - together with spaces\n \t\t\treturn -1;\n+\t\t} else if (event.getRole() == CtRole.DECLARED_IMPORT && fragmentIndex == 0) {\n+\t\t\t// this is the first pre-existing import statement, and so we must print all newline\n+\t\t\t// events unconditionally to avoid placing it on the same line as a newly added import\n+\t\t\t// statement. See PR #3702 for details\n+\t\t\tprintStandardSpaces();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84c84e16163ff18611f82c69d5246d642e3fed86"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkzNDczMw==", "bodyText": "Here, I've added the method writePackageStatement, as I did not want to break the previous API by modifying writePackageLine.", "url": "https://github.com/INRIA/spoon/pull/3702#discussion_r526934733", "createdAt": "2020-11-19T14:35:59Z", "author": {"login": "slarse"}, "path": "src/main/java/spoon/reflect/visitor/ElementPrinterHelper.java", "diffHunk": "@@ -348,9 +348,20 @@ public void writeImports(Collection<CtImport> imports) {\n \t\t}\n \t}\n \n+\t/**\n+\t * Write a package statement and a newline.\n+\t */\n \tpublic void writePackageLine(String packageQualifiedName) {\n+\t\twritePackageStatement(packageQualifiedName);\n+\t\tprinter.writeln();\n+\t}\n+\n+\t/**\n+\t * Write a package statement.\n+\t */\n+\tpublic void writePackageStatement(String packageQualifiedName) {\n \t\tprinter.writeKeyword(\"package\").writeSpace();\n-\t\twriteQualifiedName(packageQualifiedName).writeSeparator(\";\").writeln();\n+\t\twriteQualifiedName(packageQualifiedName).writeSeparator(\";\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84c84e16163ff18611f82c69d5246d642e3fed86"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1328, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}