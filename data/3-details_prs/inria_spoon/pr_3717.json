{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxNjc5NDMy", "number": 3717, "title": "review: feat: Make sniper printer infer indentation style of compilation unit", "bodyText": "Fix #3715\nThis PR introduces indentation style inference to the sniper printer. It's simple in principle: look at the whitespace preceding the top-level type members and make a best guess as to what the indentation style is out of 1, 2 or 4 spaces/tabs. The original set of source code fragments are used to detect indentation.\nIf for any given compilation unit no top-level elements can be found, indentation detection defaults to tabs.\nWe will start using this ASAP in Sorald, preferably with the new beta release this Saturday if we can get it merged by then. Therefore, we should be able to detect any obvious issues this might introduce relatively quickly.\nNote: This will crash and burn if you try to sniper print a compilation unit that does not have an origin source (e.g. if you add a CU through the Spoon API). That appears to be the case before this addition as well. Just thought I'd make note of it.", "createdAt": "2020-12-03T10:39:04Z", "url": "https://github.com/INRIA/spoon/pull/3717", "merged": true, "mergeCommit": {"oid": "b5dbe06903e5870c9f84da1faeae4a67b8b6d0e9"}, "closed": true, "closedAt": "2020-12-04T15:18:24Z", "author": {"login": "slarse"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdid_EsAH2gAyNTMxNjc5NDMyOjkwYTY4MzZiYTBmNGZkYjZjYjg5NDMyMmU5YTg0ZTc0ZTU5NWY2NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi0EW4gH2gAyNTMxNjc5NDMyOjFkM2Q1OTIzYTRiODVkMTM3OTc5OTMwYjdmMGI0YmFiNDZkYmY4ZGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "90a6836ba0f4fdb6cb894322e9a84e74e595f666", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/90a6836ba0f4fdb6cb894322e9a84e74e595f666", "committedDate": "2020-12-03T07:26:48Z", "message": "Add indentation test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d440fcab581e3bb0d4e012f1d308f01b2ef60009", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/d440fcab581e3bb0d4e012f1d308f01b2ef60009", "committedDate": "2020-12-03T10:09:15Z", "message": "Implement indentation detection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e69e86129d35230f255de1c2c76bce192e25c99d", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/e69e86129d35230f255de1c2c76bce192e25c99d", "committedDate": "2020-12-03T10:14:26Z", "message": "Refactor indentation detection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62d8e113f35992e5e75edb9c96848ed9c3077898", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/62d8e113f35992e5e75edb9c96848ed9c3077898", "committedDate": "2020-12-03T10:19:29Z", "message": "Move indentation detection to a separate class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94950414dc53ecac49aec513f11ebbf809d147b6", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/94950414dc53ecac49aec513f11ebbf809d147b6", "committedDate": "2020-12-03T10:36:03Z", "message": "Define default to be 1 tabs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34d3ca3e6c1d355dcb03bcf6d1df49f7680aa714", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/34d3ca3e6c1d355dcb03bcf6d1df49f7680aa714", "committedDate": "2020-12-03T10:37:58Z", "message": "Fix checkstyle errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a7ab79de27d28064aedeab519e08c20d43616b3", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/1a7ab79de27d28064aedeab519e08c20d43616b3", "committedDate": "2020-12-03T10:45:58Z", "message": "Document setters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fb75311858daa6e817c520a27ab653c12810ac8", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/5fb75311858daa6e817c520a27ab653c12810ac8", "committedDate": "2020-12-03T11:57:01Z", "message": "Add a couple of blank lines for readability"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODg1OTQ3", "url": "https://github.com/INRIA/spoon/pull/3717#pullrequestreview-543885947", "createdAt": "2020-12-03T12:04:50Z", "commit": {"oid": "5fb75311858daa6e817c520a27ab653c12810ac8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjowNDo1MFrOH-YDZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjowNDo1MFrOH-YDZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2Nzg0NQ==", "bodyText": "This is the actual thing that overrides the printing of tabs with whatever indentation style is present in the source file. I'm not completely satisfied with this solution as it seems a bit hacky, but I couldn't figure out a better way to do it. Suggestions are welcome.", "url": "https://github.com/INRIA/spoon/pull/3717#discussion_r535167845", "createdAt": "2020-12-03T12:04:50Z", "author": {"login": "slarse"}, "path": "src/main/java/spoon/support/sniper/internal/MutableTokenWriter.java", "diffHunk": "@@ -22,8 +22,38 @@\n \tprivate final TokenWriter delegate;\n \tprivate boolean muted = false;\n \n+\t// indentation style to use for new elements\n+\tprivate boolean originSourceUsesTabulations;\n+\tprivate int originSourceTabulationSize;\n+\n \tpublic MutableTokenWriter(Environment env) {\n-\t\tthis.delegate = new DefaultTokenWriter(new PrinterHelper(env));\n+\t\tthis.delegate = new DefaultTokenWriter(new SniperPrinterHelper(env));\n+\t\toriginSourceUsesTabulations = true;\n+\t\toriginSourceTabulationSize = 1;\n+\t}\n+\n+\tprivate class SniperPrinterHelper extends PrinterHelper {\n+\t\tprivate final Environment env;\n+\n+\t\tSniperPrinterHelper(Environment env) {\n+\t\t\tsuper(env);\n+\t\t\tthis.env = env;\n+\t\t}\n+\n+\t\t/**\n+\t\t * We override this method to use the correct style of indentation for new elements.\n+\t\t */\n+\t\t@Override\n+\t\tprotected void autoWriteTabs() {\n+\t\t\tint setTabulationSize = env.getTabulationSize();\n+\t\t\tenv.useTabulations(originSourceUsesTabulations);\n+\t\t\tenv.setTabulationSize(originSourceTabulationSize);\n+\n+\t\t\tsuper.autoWriteTabs();\n+\n+\t\t\tenv.setTabulationSize(setTabulationSize);\n+\t\t\tenv.useTabulations(true);\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fb75311858daa6e817c520a27ab653c12810ac8"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODkzMjU1", "url": "https://github.com/INRIA/spoon/pull/3717#pullrequestreview-543893255", "createdAt": "2020-12-03T12:14:45Z", "commit": {"oid": "5fb75311858daa6e817c520a27ab653c12810ac8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjoxNDo0NVrOH-YqPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjoxNDo0NVrOH-YqPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE3Nzc4OQ==", "bodyText": "The token writer is updated with indentation style for each CU to be printed.", "url": "https://github.com/INRIA/spoon/pull/3717#discussion_r535177789", "createdAt": "2020-12-03T12:14:45Z", "author": {"login": "slarse"}, "path": "src/main/java/spoon/support/sniper/SniperJavaPrettyPrinter.java", "diffHunk": "@@ -132,6 +134,12 @@ public void calculate(CtCompilationUnit compilationUnit, List<CtType<?>> types)\n \n \t\t//use line separator of origin source file\n \t\tsetLineSeparator(detectLineSeparator(compilationUnit.getOriginalSourceCode()));\n+\n+\t\t// use indentation style of origin source file for new elements\n+\t\tPair<Integer, Boolean> indentationInfo = IndentationDetector.detectIndentation(compilationUnit);\n+\t\tmutableTokenWriter.setOriginSourceTabulationSize(indentationInfo.getLeft());\n+\t\tmutableTokenWriter.setOriginSourceUsesTabulations(indentationInfo.getRight());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fb75311858daa6e817c520a27ab653c12810ac8"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NzY0MTMz", "url": "https://github.com/INRIA/spoon/pull/3717#pullrequestreview-544764133", "createdAt": "2020-12-04T08:56:14Z", "commit": {"oid": "5fb75311858daa6e817c520a27ab653c12810ac8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODo1NjoxNFrOH_G_3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODo1NjoxNFrOH_G_3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzNjk4OQ==", "bodyText": "Could you add a comment about the strategy that you choosed? (Relying on type members).", "url": "https://github.com/INRIA/spoon/pull/3717#discussion_r535936989", "createdAt": "2020-12-04T08:56:14Z", "author": {"login": "nharrand"}, "path": "src/main/java/spoon/support/sniper/internal/IndentationDetector.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * SPDX-License-Identifier: (MIT OR CECILL-C)\n+ *\n+ * Copyright (C) 2006-2019 INRIA and contributors\n+ *\n+ * Spoon is available either under the terms of the MIT License (see LICENSE-MIT.txt) of the Cecill-C License (see LICENSE-CECILL-C.txt). You as the user are entitled to choose the terms under which to adopt Spoon.\n+ */\n+package spoon.support.sniper.internal;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import spoon.reflect.declaration.CtCompilationUnit;\n+import spoon.reflect.path.CtRole;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Utility class for detecting the indentation style used in a compilation unit.\n+ */\n+public class IndentationDetector {\n+\n+\tprivate IndentationDetector() {\n+\t}\n+\n+\t/**\n+\t * Detect the indentation style of the given compilation unit as 1, 2 or 4 spaces or tabs.\n+\t *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fb75311858daa6e817c520a27ab653c12810ac8"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d3d5923a4b85d137979930b7f0b4bab46dbf8df", "author": {"user": {"login": "slarse", "name": "Simon Lars\u00e9n"}}, "url": "https://github.com/INRIA/spoon/commit/1d3d5923a4b85d137979930b7f0b4bab46dbf8df", "committedDate": "2020-12-04T09:10:29Z", "message": "Clarify indentation detection strategy"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1334, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}