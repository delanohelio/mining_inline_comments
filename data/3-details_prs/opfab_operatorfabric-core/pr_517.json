{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwMTA4MDg0", "number": 517, "title": "[OC-1092] Delete a card from the UI", "bodyText": "Release note :\nTasks section :\nOC-1092 : Delete a card from the UI", "createdAt": "2020-10-08T18:29:12Z", "url": "https://github.com/opfab/operatorfabric-core/pull/517", "merged": true, "mergeCommit": {"oid": "de6645c3131e5170d4a6940e96895e74c8b9105d"}, "closed": true, "closedAt": "2020-10-12T14:04:51Z", "author": {"login": "vlo-rte"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ3vIegFqTUwNTQ0MDY4Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRzbuDgH2gAyNTAwMTA4MDg0OjQ1NmNlYzQ0Zjc0OGIwN2U0OTY0MjUzNjkyOTA2ZGZiMTRhY2M4MTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDQwNjgz", "url": "https://github.com/opfab/operatorfabric-core/pull/517#pullrequestreview-505440683", "createdAt": "2020-10-09T07:53:53Z", "commit": {"oid": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNzo1Mzo1NFrOHe-_HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNDowODo0M1rOHfLVNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1MTI5Mg==", "bodyText": "Generate just one card", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502251292", "createdAt": "2020-10-09T07:53:54Z", "author": {"login": "freddidierRTE"}, "path": "services/core/cards-publication/src/test/java/org/lfenergy/operatorfabric/cards/publication/controllers/CardControllerShould.java", "diffHunk": "@@ -133,6 +133,19 @@ void keepTheCardRepository_Untouched_when_ARandomId_isGiven() {\n \n     }\n \n+    @Test\n+    void deleteUserCardWithUnauthenticatedUser() throws Exception {\n+\n+        EasyRandom randomGenerator = instantiateEasyRandom();\n+\n+        int numberOfCards = 10;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1MzUzMA==", "bodyText": "Delete all the created card at the end", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502253530", "createdAt": "2020-10-09T07:58:14Z", "author": {"login": "freddidierRTE"}, "path": "src/test/api/karate/cards/deleteUserCard.feature", "diffHunk": "@@ -0,0 +1,238 @@\n+Feature: deleteUserCards tests\r\n+\r\n+  Background:\r\n+   #Getting token for admin and tso1-operator user calling getToken.feature\r\n+    * def signIn = call read('../common/getToken.feature') { username: 'admin'}\r\n+    * def authToken = signIn.authToken\r\n+    * def signInAsTSO = call read('../common/getToken.feature') { username: 'tso1-operator'}\r\n+    * def authTokenAsTSO = signInAsTSO.authToken\r\n+\r\n+    * def groupKarate =\r\n+\"\"\"\r\n+{\r\n+  \"id\" : \"groupKarateDeleteUserCards\",\r\n+  \"name\" : \"groupKarate name\",\r\n+  \"description\" : \"groupKarate description\"\r\n+}\r\n+\"\"\"\r\n+\r\n+\r\n+    * def perimeter =\r\n+\"\"\"\r\n+{\r\n+  \"id\" : \"perimeterKarateDeleteUserCards\",\r\n+  \"process\" : \"processDeleteUserCard\",\r\n+  \"stateRights\" : [\r\n+      {\r\n+        \"state\" : \"state1\",\r\n+        \"right\" : \"ReceiveAndWrite\"\r\n+      },\r\n+      {\r\n+        \"state\" : \"state2\",\r\n+        \"right\" : \"Receive\"\r\n+      }\r\n+  ]\r\n+}\r\n+\"\"\"\r\n+\r\n+    * def tso1operatorArray =\r\n+\"\"\"\r\n+[   \"tso1-operator\"\r\n+]\r\n+\"\"\"\r\n+    * def groupArray =\r\n+\"\"\"\r\n+[   \"groupKarateDeleteUserCards\"\r\n+]\r\n+\"\"\"\r\n+\r\n+  Scenario: Create groupKarate\r\n+    Given url opfabUrl + 'users/groups'\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    And request groupKarate\r\n+    When method post\r\n+    Then match response.description == groupKarate.description\r\n+    And match response.name == groupKarate.name\r\n+    And match response.id == groupKarate.id\r\n+\r\n+\r\n+  Scenario: Add tso1-operator to groupKarate\r\n+    Given url opfabUrl + 'users/groups/' + groupKarate.id + '/users'\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    And request tso1operatorArray\r\n+    When method patch\r\n+    And status 200\r\n+\r\n+\r\n+  Scenario: Create perimeter\r\n+    Given url opfabUrl + 'users/perimeters'\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    And request perimeter\r\n+    When method post\r\n+\r\n+\r\n+  Scenario: Put groupKarate for perimeter\r\n+    Given url opfabUrl + 'users/perimeters/'+ perimeter.id + '/groups'\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    And request groupArray\r\n+    When method put\r\n+    Then status 200\r\n+\r\n+\r\n+  Scenario: Push user card\r\n+    * def cardForDeleteOk =\r\n+\"\"\"\r\n+{\r\n+\t\"publisher\" : \"ENTITY1\",\r\n+\t\"publisherType\" : \"ENTITY\",\r\n+\t\"processVersion\" : \"1\",\r\n+\t\"process\"  :\"processDeleteUserCard\",\r\n+\t\"processInstanceId\" : \"processDeleteUserCardOk\",\r\n+\t\"state\": \"state1\",\r\n+\t\"severity\" : \"INFORMATION\",\r\n+\t\"startDate\" : 1553186770681,\r\n+\t\"summary\" : {\"key\" : \"defaultProcess.summary\"},\r\n+\t\"title\" : {\"key\" : \"defaultProcess.title\"},\r\n+\t\"data\" : {\"message\":\"a message\"},\r\n+\t\"entityRecipients\" : [\"ENTITY1\"]\r\n+}\r\n+\"\"\"\r\n+\r\n+    * def cardForDeleteForbidden1 =\r\n+\"\"\"\r\n+{\r\n+\t\"publisher\" : \"publisherKarate\",\r\n+\t\"publisherType\" : \"EXTERNAL\",\r\n+\t\"processVersion\" : \"1\",\r\n+\t\"process\"  :\"processDeleteUserCard\",\r\n+\t\"processInstanceId\" : \"processDeleteUserCardForbidden1\",\r\n+\t\"state\": \"state1\",\r\n+\t\"severity\" : \"INFORMATION\",\r\n+\t\"startDate\" : 1553186770681,\r\n+\t\"summary\" : {\"key\" : \"defaultProcess.summary\"},\r\n+\t\"title\" : {\"key\" : \"defaultProcess.title\"},\r\n+\t\"data\" : {\"message\":\"a message\"},\r\n+\t\"entityRecipients\" : [\"ENTITY1\"]\r\n+}\r\n+\"\"\"\r\n+\r\n+    * def cardForDeleteForbidden2 =\r\n+\"\"\"\r\n+{\r\n+\t\"publisher\" : \"ENTITY2\",\r\n+\t\"publisherType\" : \"ENTITY\",\r\n+\t\"processVersion\" : \"1\",\r\n+\t\"process\"  :\"processDeleteUserCard\",\r\n+\t\"processInstanceId\" : \"processDeleteUserCardForbidden2\",\r\n+\t\"state\": \"state1\",\r\n+\t\"severity\" : \"INFORMATION\",\r\n+\t\"startDate\" : 1553186770681,\r\n+\t\"summary\" : {\"key\" : \"defaultProcess.summary\"},\r\n+\t\"title\" : {\"key\" : \"defaultProcess.title\"},\r\n+\t\"data\" : {\"message\":\"a message\"},\r\n+\t\"entityRecipients\" : [\"ENTITY1\"]\r\n+}\r\n+\"\"\"\r\n+\r\n+    * def cardForDeleteForbidden3 =\r\n+\"\"\"\r\n+{\r\n+\t\"publisher\" : \"ENTITY1\",\r\n+\t\"publisherType\" : \"ENTITY\",\r\n+\t\"processVersion\" : \"1\",\r\n+\t\"process\"  :\"processDeleteUserCard\",\r\n+\t\"processInstanceId\" : \"processDeleteUserCardForbidden3\",\r\n+\t\"state\": \"state2\",\r\n+\t\"severity\" : \"INFORMATION\",\r\n+\t\"startDate\" : 1553186770681,\r\n+\t\"summary\" : {\"key\" : \"defaultProcess.summary\"},\r\n+\t\"title\" : {\"key\" : \"defaultProcess.title\"},\r\n+\t\"data\" : {\"message\":\"a message\"},\r\n+\t\"entityRecipients\" : [\"ENTITY1\"]\r\n+}\r\n+\"\"\"\r\n+\r\n+# Push cardForDeleteOk\r\n+  Given url opfabPublishCardUrl + 'cards'\r\n+  And request cardForDeleteOk\r\n+  When method post\r\n+  Then status 201\r\n+  And match response.count == 1\r\n+\r\n+\r\n+# Push cardForDeleteForbidden1\r\n+  Given url opfabPublishCardUrl + 'cards'\r\n+  And request cardForDeleteForbidden1\r\n+  When method post\r\n+  Then status 201\r\n+  And match response.count == 1\r\n+\r\n+# Push cardForDeleteForbidden2\r\n+   Given url opfabPublishCardUrl + 'cards'\r\n+   And request cardForDeleteForbidden2\r\n+   When method post\r\n+   Then status 201\r\n+   And match response.count == 1\r\n+\r\n+\r\n+# Push cardForDeleteForbidden3\r\n+   Given url opfabPublishCardUrl + 'cards'\r\n+   And request cardForDeleteForbidden3\r\n+   When method post\r\n+   Then status 201\r\n+   And match response.count == 1\r\n+\r\n+\r\n+  Scenario: delete user card with no authentication, expected response 401\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/processDeleteUserCard.processDeleteUserCardOk'\r\n+    When method delete\r\n+    Then status 401\r\n+\r\n+\r\n+  Scenario: Delete user card for a non-existent card, expected response 404\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/NonExistentUserCard'\r\n+    And header Authorization = 'Bearer ' + authTokenAsTSO\r\n+    When method delete\r\n+    Then status 404\r\n+\r\n+\r\n+  Scenario: delete card not published by an entity, expected response 403\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/processDeleteUserCard.processDeleteUserCardForbidden1'\r\n+    And header Authorization = 'Bearer ' + authTokenAsTSO\r\n+    When method delete\r\n+    Then status 403\r\n+\r\n+\r\n+  Scenario: delete user card not published by an entity of the user, expected response 403\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/processDeleteUserCard.processDeleteUserCardForbidden2'\r\n+    And header Authorization = 'Bearer ' + authTokenAsTSO\r\n+    When method delete\r\n+    Then status 403\r\n+\r\n+\r\n+  Scenario: delete user card with no Write access for process/state for the user, expected response 403\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/processDeleteUserCard.processDeleteUserCardForbidden3'\r\n+    And header Authorization = 'Bearer ' + authTokenAsTSO\r\n+    When method delete\r\n+    Then status 403\r\n+\r\n+\r\n+  Scenario: delete user card, expected response 200\r\n+    Given url opfabPublishCardUrl + 'cards/userCard/processDeleteUserCard.processDeleteUserCardOk'\r\n+    And header Authorization = 'Bearer ' + authTokenAsTSO\r\n+    When method delete\r\n+    Then status 200\r\n+\r\n+\r\n+  Scenario: delete the perimeter previously created\r\n+    Given url opfabUrl + 'users/perimeters/' + perimeter.id\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    When method delete\r\n+    Then status 200\r\n+\r\n+\r\n+  Scenario: delete the group previously created\r\n+    Given url opfabUrl + 'users/groups/' + groupKarate.id\r\n+    And header Authorization = 'Bearer ' + authToken\r\n+    When method delete\r\n+    Then status 200", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b"}, "originalPosition": 238}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM2ODA0Mw==", "bodyText": "Put this translation under userCard", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502368043", "createdAt": "2020-10-09T11:38:10Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/assets/i18n/en.json", "diffHunk": "@@ -144,7 +144,15 @@\n   \"button\": {\n     \"ok\": \"OK\",\n     \"cancel\": \"Cancel\",\n-    \"reset\": \"Reset\"\n+    \"reset\": \"Reset\",\n+    \"delete\": \"Delete\"\n+  },\n+  \"deleteCard\": {\n+    \"doYouReallyWant\": \"Do you really want to delete this card ?\",\n+    \"cardDeletedWithNoError\": \"Card deleted\",\n+    \"error\": {\n+      \"impossibleToDeleteCard\": \"Impossible to delete card for technical reasons\"\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3NDQ5OA==", "bodyText": "Remove this comment redundant with the code", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502374498", "createdAt": "2020-10-09T11:52:13Z", "author": {"login": "freddidierRTE"}, "path": "services/core/cards-publication/src/main/java/org/lfenergy/operatorfabric/cards/publication/services/CardProcessingService.java", "diffHunk": "@@ -245,6 +270,22 @@ public void deleteCards(List<CardPublicationData> cardPublicationData) {\n         return deletedCard;\n     }\n \n+    public boolean isUserAllowedToDeleteThisCard(CardPublicationData card, CurrentUserWithPerimeters user) {\n+        List<ComputedPerimeter> perimetersOfTheUserList = user.getComputedPerimeters();\n+        List<String>            entitiesOfTheUserList   = user.getUserData().getEntities();\n+\n+        if ((card.getPublisherType() == PublisherTypeEnum.ENTITY) &&    //1st check : card.publisherType == ENTITY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ1MzU1OQ==", "bodyText": "add here  a message in the card", "url": "https://github.com/opfab/operatorfabric-core/pull/517#discussion_r502453559", "createdAt": "2020-10-09T14:08:43Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/cards/components/detail/detail.component.ts", "diffHunk": "@@ -488,6 +532,35 @@ export class DetailComponent implements OnChanges, OnInit, OnDestroy, AfterViewC\n         }\n     }\n \n+    confirmDeleteCard(): void {\n+        this.cardService.deleteCard(this.card)\n+            .subscribe(\n+                resp => {\n+                    this.messageAfterDeletingCard = '';\n+                    const status = resp.status;\n+                    if (status === 200) {\n+                        this.messageAfterDeletingCard = 'deleteCard.cardDeletedWithNoError';\n+                    } else {\n+                        console.log('Impossible to delete card , error status from service : ', status);\n+                        this.messageAfterDeletingCard = 'deleteCard.error.impossibleToDeleteCard';\n+                    }\n+\n+                    this.modalRef.close();\n+                    this.closeDetails();\n+                    this.displayDeleteResult = true;\n+                },\n+                err => {\n+                    console.error('Error when deleting card :', err);\n+                    this.modalRef.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e02a4f88c6978206cf0803d3ed9bbdbb6784c69b"}, "originalPosition": 140}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b906daeadf634d715f95247999d4a58949fae10", "author": {"user": {"login": "vlo-rte", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/4b906daeadf634d715f95247999d4a58949fae10", "committedDate": "2020-10-12T07:50:30Z", "message": "[OC-1092] adding of 2 popups for result of deleting card"}, "afterCommit": {"oid": "ab350e28ca417fa71d50a0625933a83130137110", "author": {"user": {"login": "vlo-rte", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/ab350e28ca417fa71d50a0625933a83130137110", "committedDate": "2020-10-12T07:54:54Z", "message": "[OC-1092] adding of 2 popups for result of deleting card"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab350e28ca417fa71d50a0625933a83130137110", "author": {"user": {"login": "vlo-rte", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/ab350e28ca417fa71d50a0625933a83130137110", "committedDate": "2020-10-12T07:54:54Z", "message": "[OC-1092] adding of 2 popups for result of deleting card"}, "afterCommit": {"oid": "193520e8202436f95927dfb87c1d0e4a70006d55", "author": {"user": null}, "url": "https://github.com/opfab/operatorfabric-core/commit/193520e8202436f95927dfb87c1d0e4a70006d55", "committedDate": "2020-10-12T08:00:26Z", "message": "[OC-1092] Delete a card from the UI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a21fe31658174b59464f5ea6f40c59820edd989", "author": {"user": null}, "url": "https://github.com/opfab/operatorfabric-core/commit/5a21fe31658174b59464f5ea6f40c59820edd989", "committedDate": "2020-10-12T08:34:08Z", "message": "[OC-1092] Delete a card from the UI"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33379ad4970809a655da7a33f6adaecf6dccfb7a", "author": {"user": {"login": "vlo-rte", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/33379ad4970809a655da7a33f6adaecf6dccfb7a", "committedDate": "2020-10-12T08:15:21Z", "message": "[OC-1092] delete of unused variable"}, "afterCommit": {"oid": "5a21fe31658174b59464f5ea6f40c59820edd989", "author": {"user": null}, "url": "https://github.com/opfab/operatorfabric-core/commit/5a21fe31658174b59464f5ea6f40c59820edd989", "committedDate": "2020-10-12T08:34:08Z", "message": "[OC-1092] Delete a card from the UI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "456cec44f748b07e4964253692906dfb14acc813", "author": {"user": {"login": "freddidierRTE", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/456cec44f748b07e4964253692906dfb14acc813", "committedDate": "2020-10-12T12:49:23Z", "message": "Merge branch 'develop' into OC-1092"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1283, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}