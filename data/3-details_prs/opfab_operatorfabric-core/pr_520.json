{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNDg3MjI1", "number": 520, "title": "[OC-1126] Add field userRecipients and groupRecipients when posting a card", "bodyText": "", "createdAt": "2020-10-12T10:37:46Z", "url": "https://github.com/opfab/operatorfabric-core/pull/520", "merged": true, "mergeCommit": {"oid": "4d8cd598d894df33f2ad01ccf1666cdb2148be89"}, "closed": true, "closedAt": "2020-10-13T15:26:43Z", "author": {"login": "quinarygio"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdR1d6FgFqTUwNjY5MDUzMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSIDPRgBqjM4NzExMTk4ODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NjkwNTMy", "url": "https://github.com/opfab/operatorfabric-core/pull/520#pullrequestreview-506690532", "createdAt": "2020-10-12T14:52:25Z", "commit": {"oid": "fe803915f6ad351b996e74838df7c2223c6fcded"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDo1MjoyNVrOHgCD1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNTowODoyNVrOHgCrVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM1MDIzMA==", "bodyText": "not \"will be\" but  \"is deprecated\"", "url": "https://github.com/opfab/operatorfabric-core/pull/520#discussion_r503350230", "createdAt": "2020-10-12T14:52:25Z", "author": {"login": "freddidierRTE"}, "path": "src/docs/asciidoc/reference_doc/card_examples.adoc", "diffHunk": "@@ -124,31 +115,32 @@ If this card need to be viewed by a user who is not in the `TSO1` group, it's po\n definition of the recipient. If the `tso2-operator` needs to see also this card, the recipient definition could be(the following code details only the recipient part):\n \n ....\n-\"recipient\":{ \n-\t\"type\":\"UNION\",\n-\t\"recipients\":[\n-\t\t{ \"type\": \"GROUP\", \"identity\":\"TSO1\"},\n-\t\t{ \"type\": \"USER\", \"identity\":\"tso2-operator\"}\n-\t\t]\n-\t}\n+\"groupRecipients\": [\"TSO1\"],\n+\"userRecipients\": [\"tso2-operator\"]\n ....\n \n+\n So here, all the users of the `TSO1` group will receive the `INFORMATION` as should the `tos2-operator` user.\n \n Another example, if a card is destined to the operators of `TSO1` and `TSO2` and needs to be also seen by the `admin`, the recipient configuration looks like:\n \n ....\n-\"recipient\":{\"type\":\"UNION\",\n-\t\"recipients\":[\n-\t\t{\"type\":\"GROUP\",\"identity\":\"TSO1\"},\n-\t\t{\"type\":\"GROUP\",\"identity\":\"TSO2\"},\n-\t\t{\"type\":\"USER\",\"identity\":\"admin\"}\n-\t\t]\n-\t}\n+\"groupRecipients\": [\"TSO1\", \"TSO2\"],\n+\"userRecipients\": [\"admin\"]\n ....\n \n \n+There is and alternative way to declare recipients of card, this syntax is more complex and will be deprecated:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe803915f6ad351b996e74838df7c2223c6fcded"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM2MDM0Mw==", "bodyText": "Change the warning text to :\n\"Use of recipient field is deprecated. Please use usersRecipients and groupsRecipients fields (See documentation)\"", "url": "https://github.com/opfab/operatorfabric-core/pull/520#discussion_r503360343", "createdAt": "2020-10-12T15:08:25Z", "author": {"login": "freddidierRTE"}, "path": "services/core/cards-publication/src/main/java/org/lfenergy/operatorfabric/cards/publication/services/RecipientProcessor.java", "diffHunk": "@@ -38,8 +41,21 @@\n      * @return computed recipient that were affected to card\n      */\n     public ComputedRecipient processAll(CardPublicationData card) {\n-        Recipient recipient = card.getRecipient();\n-        ComputedRecipient computedRecipient = processAll(recipient);\n+        ComputedRecipient computedRecipient;\n+        if ((card.getUserRecipients() != null && !card.getUserRecipients().isEmpty())\n+                        || (card.getGroupRecipients() != null && !card.getGroupRecipients().isEmpty())) {\n+            ComputedRecipient.BuilderEncapsulator result = ComputedRecipient.encapsulatedBuilder();\n+            ComputedRecipient.ComputedRecipientBuilder builder = result.builder();\n+\n+            builder.users(card.getUserRecipients() == null ? Collections.emptyList() : card.getUserRecipients());\n+            builder.groups(card.getGroupRecipients() == null ? Collections.emptyList() : card.getGroupRecipients());\n+            computedRecipient = builder.build();\n+        } else {\n+            log.warn(\"Using deprecated recipient field\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe803915f6ad351b996e74838df7c2223c6fcded"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe803915f6ad351b996e74838df7c2223c6fcded", "author": {"user": {"login": "quinarygio", "name": "Giovanni Ferrari"}}, "url": "https://github.com/opfab/operatorfabric-core/commit/fe803915f6ad351b996e74838df7c2223c6fcded", "committedDate": "2020-10-12T10:18:34Z", "message": "[OC-1126] Add field userRecipients and groupRecipients when posting a card"}, "afterCommit": {"oid": "fab44f882dede33eee44bd76ad9aebb9c137f1ff", "author": {"user": {"login": "quinarygio", "name": "Giovanni Ferrari"}}, "url": "https://github.com/opfab/operatorfabric-core/commit/fab44f882dede33eee44bd76ad9aebb9c137f1ff", "committedDate": "2020-10-13T09:26:21Z", "message": "[OC-1126] Add field userRecipients and groupRecipients when posting a card"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13d069062811914a8bc52ce8bcfe8fbf982407db", "author": {"user": {"login": "quinarygio", "name": "Giovanni Ferrari"}}, "url": "https://github.com/opfab/operatorfabric-core/commit/13d069062811914a8bc52ce8bcfe8fbf982407db", "committedDate": "2020-10-13T12:49:16Z", "message": "[OC-1126] Add field userRecipients and groupRecipients when posting a card"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81fb9dfd0458b263f450e764cd0c2e7698dd1c8f", "author": {"user": {"login": "quinarygio", "name": "Giovanni Ferrari"}}, "url": "https://github.com/opfab/operatorfabric-core/commit/81fb9dfd0458b263f450e764cd0c2e7698dd1c8f", "committedDate": "2020-10-13T09:45:16Z", "message": "Merge branch 'develop' into OC-1126"}, "afterCommit": {"oid": "13d069062811914a8bc52ce8bcfe8fbf982407db", "author": {"user": {"login": "quinarygio", "name": "Giovanni Ferrari"}}, "url": "https://github.com/opfab/operatorfabric-core/commit/13d069062811914a8bc52ce8bcfe8fbf982407db", "committedDate": "2020-10-13T12:49:16Z", "message": "[OC-1126] Add field userRecipients and groupRecipients when posting a card"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1286, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}