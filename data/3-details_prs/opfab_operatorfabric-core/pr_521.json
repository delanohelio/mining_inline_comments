{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNjIwMzgw", "number": 521, "title": "[OC-1088] : complete administration module groups+entites", "bodyText": "for release notes:\n==> OC-1088 : complete administration module groups+entites", "createdAt": "2020-10-12T14:36:47Z", "url": "https://github.com/opfab/operatorfabric-core/pull/521", "merged": true, "mergeCommit": {"oid": "69c11b33af5a9113232629cb8852974444c83ea9"}, "closed": true, "closedAt": "2020-10-15T09:34:50Z", "author": {"login": "bendaoudmba"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdR1wS2ABqjM4NjcxODk1MjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSKln2gBqjM4NzIxMzgzNDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f042d7e75701baf87ed56d47c9b670b998a1633", "author": {"user": {"login": "bendaoudmba", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/3f042d7e75701baf87ed56d47c9b670b998a1633", "committedDate": "2020-10-12T14:32:56Z", "message": "[OC-1088] : complete administration module groups+entites"}, "afterCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2", "author": {"user": {"login": "bendaoudmba", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/e14841ab65afd2489646ec48c6065c7b23d4a8f2", "committedDate": "2020-10-12T15:31:23Z", "message": "[OC-1088] : complete administration module groups+entites"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2", "author": {"user": {"login": "bendaoudmba", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/e14841ab65afd2489646ec48c6065c7b23d4a8f2", "committedDate": "2020-10-12T15:31:23Z", "message": "[OC-1088] : complete administration module groups+entites"}, "afterCommit": {"oid": "3720e728d94a6103b39d604eb0fa710e736974d4", "author": {"user": {"login": "bendaoudmba", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/3720e728d94a6103b39d604eb0fa710e736974d4", "committedDate": "2020-10-12T16:27:07Z", "message": "[OC-1088] : complete administration module groups+entites"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzI1MzAz", "url": "https://github.com/opfab/operatorfabric-core/pull/521#pullrequestreview-506725303", "createdAt": "2020-10-12T15:35:27Z", "commit": {"oid": "3f042d7e75701baf87ed56d47c9b670b998a1633"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNTozNTo0NlrOHgDsRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNjo1Mjo1NlrOHgXzWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM3Njk2NA==", "bodyText": "Put it in comment #", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503376964", "createdAt": "2020-10-12T15:35:46Z", "author": {"login": "freddidierRTE"}, "path": "config/dev/users-dev.yml", "diffHunk": "@@ -66,3 +66,6 @@ operatorfabric.users.default:\n   user-settings:\n     - login: rte-operator\n       description: Da Operator Rulez\n+logging:\n+  level:\n+    ROOT: DEBUG", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM3NzM2NA==", "bodyText": "Remove console.log", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503377364", "createdAt": "2020-10-12T15:36:31Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/admin.component.ts", "diffHunk": "@@ -11,15 +12,15 @@ import { Observable } from 'rxjs';\n })\n export class AdminComponent implements OnInit {\n \n-  activeTab = 'users';\n+  activeTab: string;\n   usersLabel: string;\n   entitiesLabel: string;\n   groupsLabel: string;\n \n-  constructor( protected store: Store<AppState>, protected translate: TranslateService) {\n+  constructor( private route: ActivatedRoute, protected store: Store<AppState>, protected translate: TranslateService) {\n      this.getLocale().subscribe(locale => {\n-      console.log(locale);\n       this.translate.use(locale);\n+      console.log(translate.currentLang);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM3OTgxNQ==", "bodyText": "Add copyright header", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503379815", "createdAt": "2020-10-12T15:40:42Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/components/ngtable/entities/of-entities-table.component.ts", "diffHunk": "@@ -0,0 +1,105 @@\n+import { Component, OnInit } from '@angular/core';\n+import { NgbModal } from '@ng-bootstrap/ng-bootstrap';\n+import { Store } from '@ngrx/store';\n+import { TranslateService } from '@ngx-translate/core';\n+import { EntitiesService } from '@ofServices/entities.service';\n+import { AppState } from '@ofStore/index';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM4MDM3Mw==", "bodyText": "Add copyright header", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503380373", "createdAt": "2020-10-12T15:41:41Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/admin.component.ts", "diffHunk": "@@ -1,4 +1,5 @@\n import { Component, OnInit } from '@angular/core';\n+import { ActivatedRoute } from '@angular/router';\n import { Store } from '@ngrx/store';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM4MDY4Mw==", "bodyText": "Add copyright header", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503380683", "createdAt": "2020-10-12T15:42:13Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/components/editmodal/groups-entities/edit-entity-group-modal.component.ts", "diffHunk": "@@ -0,0 +1,92 @@\n+import { Component, Input, OnInit } from '@angular/core';\n+import { AbstractControl, FormControl, FormGroup, Validators } from '@angular/forms';\n+import { NgbActiveModal } from '@ng-bootstrap/ng-bootstrap';\n+import { EntitiesService } from '@ofServices/entities.service';\n+import { GroupsService } from '@ofServices/groups.service';\n+import { DataTableShareService } from 'app/modules/admin/services/data.service';\n+import { IdValidatorService } from 'app/modules/admin/services/id-validator.service';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM4MDg0NA==", "bodyText": "Add copyright header", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503380844", "createdAt": "2020-10-12T15:42:31Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/components/editmodal/groups-entities/edit-group-modal.component.html", "diffHunk": "@@ -0,0 +1,55 @@\n+<!-- Modal-content -->\n+<div class=\"modal-header bg-dark\">\n+  <h5 class=\"modal-title\" *ngIf=\"row\">{{row.id}}</h5>\n+  <h5 class=\"modal-title\" *ngIf=\"!row && type==='group'\" translate>admin.input.group.add</h5>\n+  <h5 class=\"modal-title\" *ngIf=\"!row && type==='entity'\" translate>admin.input.entity.add</h5>\n+  <button (click)=\"activeModal.dismiss('Cross click')\" type=\"button\" class=\"close\" data-dismiss=\"modal\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM4MDk5OA==", "bodyText": "Add copyright header", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503380998", "createdAt": "2020-10-12T15:42:48Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/components/editmodal/users/edit-user-modal.component.html", "diffHunk": "@@ -1,7 +1,7 @@\n <!-- Modal-content -->\n <div class=\"modal-header bg-dark\">\n-  <h5 class=\"modal-title\" *ngIf=\"user\">{{user.login}}</h5>\n-  <h5 class=\"modal-title\" *ngIf=\"!user\" translate>admin.input.user.add</h5>\n+  <h5 class=\"modal-title\" *ngIf=\"row\">{{row.login}}</h5>\n+  <h5 class=\"modal-title\" *ngIf=\"!row\" translate>admin.input.user.add</h5>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM4MTQwOA==", "bodyText": "Add copyright header", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503381408", "createdAt": "2020-10-12T15:43:27Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/components/ngtable/groups/of-groups-table.component.ts", "diffHunk": "@@ -0,0 +1,104 @@\n+import { Component, OnInit } from '@angular/core';\n+import { NgbModal } from '@ng-bootstrap/ng-bootstrap';\n+import { Store } from '@ngrx/store';\n+import { TranslateService } from '@ngx-translate/core';\n+import { GroupsService } from '@ofServices/groups.service';\n+import { AppState } from '@ofStore/index';\n+import { AppError } from 'app/common/error/app-error';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM4MTYwOA==", "bodyText": "Add copyright header", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503381608", "createdAt": "2020-10-12T15:43:51Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/components/ngtable/oftable/oftable.component.html", "diffHunk": "@@ -0,0 +1,48 @@\n+<div class=\"row\">\n+  <div class=\"col-md-4\">\n+    <input *ngIf=\"config.filtering\" placeholder={{filterAll}}\n+           [ngTableFiltering]=\"config.filtering\"\n+           class=\"form-control\"\n+           (tableChanged)=\"onChangeTable(config)\"/>\n+  </div>\n+  <div><a class=\"btn btn-primary\" (click)=\"createNewItem()\" id =\"addUser\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM4NjkyNA==", "bodyText": "Close the subscription when closing component .\nFor an example see file operatorfabric-core/ui/main/src/app/components/share/datetime-filter/datetime-filter.component.ts :\n this.datetimeForm.valueChanges.pipe(takeUntil(this.ngUnsubscribe$)).subscribe(fn);", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503386924", "createdAt": "2020-10-12T15:53:03Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/components/ngtable/oftable/oftable.component.ts", "diffHunk": "@@ -86,11 +107,38 @@ export class OfTableComponent implements OnInit {\n     this.length = sortedData.length;\n   }\n \n-  deleteItem(row: any) {\n-    this.crudService.deleteById(row.login).subscribe(() => {\n-      const itemIndex = this.data.findIndex((item) => item.login === row.login);\n+  deleteItem(id: string, key: string): Subscription {\n+    return this.crudService.deleteById(id).subscribe(() => {\n+      const itemIndex = this.data.findIndex((item) => item[key] === id);\n       this.data.splice(itemIndex, 1);\n       this.onChangeTable(this.config);\n+      this.dataService.changeUsers(true);\n+\n+    });\n+  }\n+\n+  getObservableRow(): Observable<any> {\n+    return null;\n+  }\n+\n+  protected subscribeTable(): void {\n+    //refresh edited row event\n+    this.getObservableRow().subscribe((row) => {\n+      if (row) {\n+        let itemIndex = -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM4NzIxOQ==", "bodyText": "Add copyright header", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503387219", "createdAt": "2020-10-12T15:53:33Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/components/ngtable/oftable/oftable.component.ts", "diffHunk": "@@ -2,14 +2,14 @@ import { Component, OnInit } from '@angular/core';\n import {\n   NgbModalOptions,\n   ModalDismissReasons,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5NzEyNA==", "bodyText": "This regular call to the service is really heavy on back , we shoud find a way of caching the information . each time we press a key the back is called", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503397124", "createdAt": "2020-10-12T16:10:44Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/services/id-validator.service.ts", "diffHunk": "@@ -0,0 +1,28 @@\n+import { AbstractControl, ValidationErrors } from '@angular/forms';\n+import { CrudService } from '@ofServices/crud-service';\n+\n+\n+export class IdValidatorService {\n+\n+  constructor(\n+    private crudService: CrudService) {\n+  }\n+\n+  isIdAvailable(control: AbstractControl): Promise<ValidationErrors> | null {\n+    return new Promise((resolve, reject) => {\n+      this.crudService.getAll().subscribe((response) => {\n+        if (response.filter(\n+          row => {\n+            let id: string;\n+            if (row.login) id = row.login;\n+            else id = row.id;\n+            return id.toLowerCase().trim() === (control.value as string).toLowerCase().trim();\n+          }).length > 0) {\n+          resolve({ shouldbeUnique: true });\n+        } else {\n+          resolve(null);\n+        }\n+      });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14841ab65afd2489646ec48c6065c7b23d4a8f2"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzcwNjQ1OA==", "bodyText": "Duplication of code with other classes .\nSee how to set stuff in the parent class  and create a method instead of repeating  this blocks :\n title: translations['admin.input.description'], name: 'description', filtering: { filterString: '', placeholder: translations['admin.input.user.filter'] + translations['admin.input.description'] }", "url": "https://github.com/opfab/operatorfabric-core/pull/521#discussion_r503706458", "createdAt": "2020-10-13T06:52:56Z", "author": {"login": "freddidierRTE"}, "path": "ui/main/src/app/modules/admin/components/ngtable/groups/of-groups-table.component.ts", "diffHunk": "@@ -0,0 +1,104 @@\n+import { Component, OnInit } from '@angular/core';\n+import { NgbModal } from '@ng-bootstrap/ng-bootstrap';\n+import { Store } from '@ngrx/store';\n+import { TranslateService } from '@ngx-translate/core';\n+import { GroupsService } from '@ofServices/groups.service';\n+import { AppState } from '@ofStore/index';\n+import { AppError } from 'app/common/error/app-error';\n+import { ConfirmationDialogService } from 'app/modules/admin/services/confirmation-dialog.service';\n+import { DataTableShareService } from 'app/modules/admin/services/data.service';\n+import { Observable, throwError } from 'rxjs';\n+import { EditEntityGroupModalComponent } from '../../editmodal/groups-entities/edit-entity-group-modal.component';\n+import { OfTableComponent } from '../oftable/oftable.component';\n+\n+@Component({\n+  selector: 'of-groups-table',\n+  templateUrl: '../oftable/oftable.component.html'\n+})\n+export class OfGroupsTableComponent extends OfTableComponent implements OnInit {\n+\n+  modalComponent = EditEntityGroupModalComponent;\n+  typeModal = 'group';\n+  constructor(\n+    protected crudService: GroupsService,\n+    protected modalService: NgbModal,\n+    protected dataService: DataTableShareService,\n+    protected translate: TranslateService,\n+    private confirmationDialogService: ConfirmationDialogService,\n+    protected store: Store<AppState>\n+  ) {\n+    super(modalService, dataService, store);\n+    this.crudService = crudService;\n+    this.config.sorting = { columns: this.columns };\n+    this.getLocale().subscribe(locale => {\n+      this.translate.use(locale);\n+      this.translate.get(['admin.input.id.label', 'admin.input.name.label', 'admin.input.description',\n+        'admin.input.user.edit', 'admin.input.user.delete', 'admin.input.user.filter', 'admin.input.user.filter',\n+        'admin.pagination.firstText', 'admin.pagination.lastText', 'admin.pagination.nextText', 'admin.pagination.prevText'\n+        , 'admin.input.group.add', 'admin.input.lines', 'admin.input.user.filter', 'admin.input.user.filterAll'])\n+        .subscribe(translations => {\n+          this.columns = [\n+            {\n+              title: translations['admin.input.id.label'],\n+              name: 'id',\n+              filtering: {\n+                filterString: '', placeholder: translations['admin.input.user.filter'] +\n+                  translations['admin.input.id.label']\n+              },\n+            },\n+            {\n+              title: translations['admin.input.name.label'],\n+              name: 'name',\n+              filtering: {\n+                filterString: '', placeholder: translations['admin.input.user.filter'] +\n+                  translations['admin.input.name.label']\n+              },\n+            },\n+            {\n+              title: translations['admin.input.description'],\n+              name: 'description',\n+              filtering: {\n+                filterString: '', placeholder: translations['admin.input.user.filter'] +\n+                  translations['admin.input.description']\n+              }\n+            },\n+            {\n+              title: translations['admin.input.user.edit'],\n+              name: 'edit'\n+            },\n+            {\n+              title: translations['admin.input.user.delete'],\n+              name: 'delete'\n+            }\n+          ];\n+          this.firstText = translations['admin.pagination.firstText'];\n+          this.lastText = translations['admin.pagination.lastText'];\n+          this.nextText = translations['admin.pagination.nextText'];\n+          this.prevText = translations['admin.pagination.prevText'];\n+          this.addLabel = translations['admin.input.group.add'];\n+          this.lineLabel = translations['admin.input.lines'];\n+          this.filterAll = translations['admin.input.user.filterAll'];\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3720e728d94a6103b39d604eb0fa710e736974d4"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a89bfe7e50284f7b44a1e25216cc006d51f267c", "author": {"user": {"login": "bendaoudmba", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/3a89bfe7e50284f7b44a1e25216cc006d51f267c", "committedDate": "2020-10-13T15:47:32Z", "message": "[OC-1088] : complete administration module groups+entites"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3720e728d94a6103b39d604eb0fa710e736974d4", "author": {"user": {"login": "bendaoudmba", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/3720e728d94a6103b39d604eb0fa710e736974d4", "committedDate": "2020-10-12T16:27:07Z", "message": "[OC-1088] : complete administration module groups+entites"}, "afterCommit": {"oid": "3a89bfe7e50284f7b44a1e25216cc006d51f267c", "author": {"user": {"login": "bendaoudmba", "name": null}}, "url": "https://github.com/opfab/operatorfabric-core/commit/3a89bfe7e50284f7b44a1e25216cc006d51f267c", "committedDate": "2020-10-13T15:47:32Z", "message": "[OC-1088] : complete administration module groups+entites"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1288, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}