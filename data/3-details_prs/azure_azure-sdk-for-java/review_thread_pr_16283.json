{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMTMyNzQz", "number": 16283, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MDo1M1rOEtngdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1NzoxNVrOEtnpyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MjY4NjYxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/DecryptableItem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MDo1M1rOHhgm6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxOTowMjozNVrOHhhBFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5OTMwNA==", "bodyText": "TODOs - are they tracked in a separate PR? or can this todo be removed due to the example provided above?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504899304", "createdAt": "2020-10-14T18:50:53Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/DecryptableItem.java", "diffHunk": "@@ -0,0 +1,97 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.encryption;\n+\n+import reactor.core.publisher.Mono;\n+\n+\n+/// <summary>\n+/// Allows for lazy decryption, which provides user a way to handle possible exceptions encountered as part of feed /\n+// query processing.\n+/// Also provides decryption operation details.\n+/// </summary>\n+/// <example>\n+/// <code language=\"c#\">\n+/// <![CDATA[\n+/// public class ToDoActivity{\n+///     public string id {get; set;}\n+///     public string status {get; set;}\n+///     public int cost {get; set;}\n+/// }\n+///\n+/// QueryDefinition queryDefinition = new QueryDefinition(\"select * from ToDos\");\n+/// using (FeedIterator<DecrytableItem> feedIterator = this.Container.GetItemQueryIterator<DecrytableItem>(\n+///     queryDefinition,\n+///     requestOptions: new QueryRequestOptions() { PartitionKey = new PartitionKey(\"Error\")}))\n+/// {\n+///     while (feedIterator.HasMoreResults)\n+///     {\n+///         FeedResponse<DecryptableItem> decryptableItems = await feedIterator.ReadNextAsync();\n+///         foreach(DecryptableItem item in decryptableItems){\n+///         {\n+///             try\n+///             {\n+///                 (ToDoActivity toDo, DecryptionContext _) = await item.GetItemAsync<ToDoActivity>();\n+///             }\n+///             catch (EncryptionException encryptionException)\n+///             {\n+///                 string dataEncryptionKeyId = encryptionException.DataEncryptionKeyId;\n+///                 string rawPayload = encryptionException.EncryptedContent;\n+///             }\n+///         }\n+///     }\n+/// }\n+/// ]]>\n+/// </code>\n+/// </example>\n+\n+// TODO: moderakh add example", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwNjAwNQ==", "bodyText": "the public APIs haven't finalized yet. For that reason I would like to leave wiring the examples for later (to avoid re-do work), once the final APIs are finalized.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504906005", "createdAt": "2020-10-14T19:02:35Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/DecryptableItem.java", "diffHunk": "@@ -0,0 +1,97 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.encryption;\n+\n+import reactor.core.publisher.Mono;\n+\n+\n+/// <summary>\n+/// Allows for lazy decryption, which provides user a way to handle possible exceptions encountered as part of feed /\n+// query processing.\n+/// Also provides decryption operation details.\n+/// </summary>\n+/// <example>\n+/// <code language=\"c#\">\n+/// <![CDATA[\n+/// public class ToDoActivity{\n+///     public string id {get; set;}\n+///     public string status {get; set;}\n+///     public int cost {get; set;}\n+/// }\n+///\n+/// QueryDefinition queryDefinition = new QueryDefinition(\"select * from ToDos\");\n+/// using (FeedIterator<DecrytableItem> feedIterator = this.Container.GetItemQueryIterator<DecrytableItem>(\n+///     queryDefinition,\n+///     requestOptions: new QueryRequestOptions() { PartitionKey = new PartitionKey(\"Error\")}))\n+/// {\n+///     while (feedIterator.HasMoreResults)\n+///     {\n+///         FeedResponse<DecryptableItem> decryptableItems = await feedIterator.ReadNextAsync();\n+///         foreach(DecryptableItem item in decryptableItems){\n+///         {\n+///             try\n+///             {\n+///                 (ToDoActivity toDo, DecryptionContext _) = await item.GetItemAsync<ToDoActivity>();\n+///             }\n+///             catch (EncryptionException encryptionException)\n+///             {\n+///                 string dataEncryptionKeyId = encryptionException.DataEncryptionKeyId;\n+///                 string rawPayload = encryptionException.EncryptedContent;\n+///             }\n+///         }\n+///     }\n+/// }\n+/// ]]>\n+/// </code>\n+/// </example>\n+\n+// TODO: moderakh add example", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5OTMwNA=="}, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MjY4OTg0OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/DecryptableItemCore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MTozOFrOHhgosw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxOTowMDo0NFrOHhg9Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5OTc2Mw==", "bodyText": "NIT remove on line", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504899763", "createdAt": "2020-10-14T18:51:38Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/DecryptableItemCore.java", "diffHunk": "@@ -0,0 +1,81 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.encryption;\n+\n+import com.azure.cosmos.implementation.ItemDeserializer;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.apachecommons.lang.tuple.Pair;\n+import com.azure.cosmos.implementation.encryption.Constants;\n+import com.azure.cosmos.implementation.encryption.EncryptionProcessor;\n+import com.azure.cosmos.implementation.guava25.base.Preconditions;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Mono;\n+\n+class DecryptableItemCore extends DecryptableItem {\n+\n+    /**\n+     * The encrypted content which is yet to be decrypted.\n+     */\n+    private final JsonNode decryptableContent;\n+    private final Encryptor encryptor;\n+    private final ItemDeserializer cosmosSerializer;\n+\n+    public DecryptableItemCore(JsonNode decryptableContent,\n+                               Encryptor encryptor,\n+                               ItemDeserializer cosmosSerializer) {\n+        Preconditions.checkNotNull(decryptableContent, \"decryptableContent\");\n+        Preconditions.checkNotNull(encryptor, \"encryptor\");\n+        Preconditions.checkNotNull(cosmosSerializer, \"cosmosSerializer\");\n+\n+        this.decryptableContent = decryptableContent;\n+        this.encryptor = encryptor;\n+        this.cosmosSerializer = cosmosSerializer;\n+    }\n+\n+    @Override\n+    public <T> Mono<DecryptionResult<T>> getDecryptionResult(final Class<T> classType) {\n+\n+        ObjectNode decryptableContentAsObjectNode = Utils.as(this.decryptableContent, ObjectNode.class);\n+        if (decryptableContentAsObjectNode == null) {\n+            // (this.cosmosSerializer.FromStream<T>(EncryptionProcessor.BaseSerializer.ToStream\n+            return Mono.just(new DecryptionResult<>(Utils.getSimpleObjectMapper().convertValue(this.decryptableContent, classType), null));\n+        }\n+\n+        Mono<Pair<ObjectNode, DecryptionContext>> decryptedItemAndContextPairMono =\n+            EncryptionProcessor.decrypt(decryptableContentAsObjectNode, this.encryptor);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwNTAwMw==", "bodyText": "thanks next commit will fix.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504905003", "createdAt": "2020-10-14T19:00:44Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/DecryptableItemCore.java", "diffHunk": "@@ -0,0 +1,81 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.encryption;\n+\n+import com.azure.cosmos.implementation.ItemDeserializer;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.apachecommons.lang.tuple.Pair;\n+import com.azure.cosmos.implementation.encryption.Constants;\n+import com.azure.cosmos.implementation.encryption.EncryptionProcessor;\n+import com.azure.cosmos.implementation.guava25.base.Preconditions;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Mono;\n+\n+class DecryptableItemCore extends DecryptableItem {\n+\n+    /**\n+     * The encrypted content which is yet to be decrypted.\n+     */\n+    private final JsonNode decryptableContent;\n+    private final Encryptor encryptor;\n+    private final ItemDeserializer cosmosSerializer;\n+\n+    public DecryptableItemCore(JsonNode decryptableContent,\n+                               Encryptor encryptor,\n+                               ItemDeserializer cosmosSerializer) {\n+        Preconditions.checkNotNull(decryptableContent, \"decryptableContent\");\n+        Preconditions.checkNotNull(encryptor, \"encryptor\");\n+        Preconditions.checkNotNull(cosmosSerializer, \"cosmosSerializer\");\n+\n+        this.decryptableContent = decryptableContent;\n+        this.encryptor = encryptor;\n+        this.cosmosSerializer = cosmosSerializer;\n+    }\n+\n+    @Override\n+    public <T> Mono<DecryptionResult<T>> getDecryptionResult(final Class<T> classType) {\n+\n+        ObjectNode decryptableContentAsObjectNode = Utils.as(this.decryptableContent, ObjectNode.class);\n+        if (decryptableContentAsObjectNode == null) {\n+            // (this.cosmosSerializer.FromStream<T>(EncryptionProcessor.BaseSerializer.ToStream\n+            return Mono.just(new DecryptionResult<>(Utils.getSimpleObjectMapper().convertValue(this.decryptableContent, classType), null));\n+        }\n+\n+        Mono<Pair<ObjectNode, DecryptionContext>> decryptedItemAndContextPairMono =\n+            EncryptionProcessor.decrypt(decryptableContentAsObjectNode, this.encryptor);\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5OTc2Mw=="}, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MjY5NTc0OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptableItem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MzowNFrOHhgsJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxOTowMDowNVrOHhg7zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMDY0NA==", "bodyText": "NIT remove one line", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504900644", "createdAt": "2020-10-14T18:53:04Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptableItem.java", "diffHunk": "@@ -0,0 +1,90 @@\n+// ------------------------------------------------------------\n+// Copyright (c) Microsoft Corporation.  All rights reserved.\n+// ------------------------------------------------------------\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwNDY1Mw==", "bodyText": "thanks next commit will fix.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504904653", "createdAt": "2020-10-14T19:00:05Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptableItem.java", "diffHunk": "@@ -0,0 +1,90 @@\n+// ------------------------------------------------------------\n+// Copyright (c) Microsoft Corporation.  All rights reserved.\n+// ------------------------------------------------------------\n+\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMDY0NA=="}, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MjY5Njk5OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptableItem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MzoyM1rOHhgs3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxOTowMjo1NlrOHhhBuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMDgyOQ==", "bodyText": "NIT remove todo", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504900829", "createdAt": "2020-10-14T18:53:23Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptableItem.java", "diffHunk": "@@ -0,0 +1,90 @@\n+// ------------------------------------------------------------\n+// Copyright (c) Microsoft Corporation.  All rights reserved.\n+// ------------------------------------------------------------\n+\n+\n+package com.azure.cosmos.encryption;\n+\n+import com.azure.cosmos.implementation.ItemDeserializer;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.encryption.EncryptionUtils;\n+import com.azure.cosmos.implementation.guava25.base.Preconditions;\n+\n+/// <summary>\n+/// Input type that can be used to allow for lazy decryption in the write path.\n+/// </summary>\n+/// <typeparam name=\"T\">Type of item.</typeparam>\n+/// <example>\n+/// This example takes in a item, encrypts it and writes to Cosmos container.\n+/// <code language=\"c#\">\n+/// <![CDATA[\n+/// public class ToDoActivity{\n+///     public string id {get; set;}\n+///     public string status {get; set;}\n+/// }\n+///\n+/// ToDoActivity test = new ToDoActivity()\n+/// {\n+///    id = Guid.NewGuid().ToString(),\n+///    status = \"InProgress\"\n+/// };\n+///\n+/// ItemResponse<EncryptableItem<ToDoActivity>> createResponse = await encryptionContainer\n+// .CreateItemAsync<EncryptableItem<ToDoActivity>>(\n+///     new EncryptableItem<ToDoActivity>(test),\n+///     new PartitionKey(test.Status),\n+///     EncryptionItemRequestOptions);\n+///\n+/// if (!createResponse.IsSuccessStatusCode)\n+/// {\n+///     //Handle and log exception\n+///     return;\n+/// }\n+///\n+/// (ToDoActivity toDo, DecryptionContext _) = await item.DecryptableItem.GetItemAsync<ToDoActivity>();\n+/// ]]>\n+/// </code>\n+/// </example>\n+\n+// TODO moderakh add example", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwNjE2OQ==", "bodyText": "the public APIs haven't finalized yet. For that reason I would like to leave wiring the examples for later (to avoid re-do work), once the final APIs are finalized.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504906169", "createdAt": "2020-10-14T19:02:56Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptableItem.java", "diffHunk": "@@ -0,0 +1,90 @@\n+// ------------------------------------------------------------\n+// Copyright (c) Microsoft Corporation.  All rights reserved.\n+// ------------------------------------------------------------\n+\n+\n+package com.azure.cosmos.encryption;\n+\n+import com.azure.cosmos.implementation.ItemDeserializer;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.encryption.EncryptionUtils;\n+import com.azure.cosmos.implementation.guava25.base.Preconditions;\n+\n+/// <summary>\n+/// Input type that can be used to allow for lazy decryption in the write path.\n+/// </summary>\n+/// <typeparam name=\"T\">Type of item.</typeparam>\n+/// <example>\n+/// This example takes in a item, encrypts it and writes to Cosmos container.\n+/// <code language=\"c#\">\n+/// <![CDATA[\n+/// public class ToDoActivity{\n+///     public string id {get; set;}\n+///     public string status {get; set;}\n+/// }\n+///\n+/// ToDoActivity test = new ToDoActivity()\n+/// {\n+///    id = Guid.NewGuid().ToString(),\n+///    status = \"InProgress\"\n+/// };\n+///\n+/// ItemResponse<EncryptableItem<ToDoActivity>> createResponse = await encryptionContainer\n+// .CreateItemAsync<EncryptableItem<ToDoActivity>>(\n+///     new EncryptableItem<ToDoActivity>(test),\n+///     new PartitionKey(test.Status),\n+///     EncryptionItemRequestOptions);\n+///\n+/// if (!createResponse.IsSuccessStatusCode)\n+/// {\n+///     //Handle and log exception\n+///     return;\n+/// }\n+///\n+/// (ToDoActivity toDo, DecryptionContext _) = await item.DecryptableItem.GetItemAsync<ToDoActivity>();\n+/// ]]>\n+/// </code>\n+/// </example>\n+\n+// TODO moderakh add example", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMDgyOQ=="}, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MjcwMjAzOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1NDo1MlrOHhgv_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1OTozN1rOHhg6kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMTYzMA==", "bodyText": "NIT remove one line - also below after the precondition check", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504901630", "createdAt": "2020-10-14T18:54:52Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -163,29 +204,66 @@\n         EncryptionItemRequestOptions encryptionItemRequestOptions = Utils.as(requestOptions,\n             EncryptionItemRequestOptions.class);\n \n-        if (encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null) {\n-            Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n-                + \"EncryptionContainer.\");\n+        if (encryptionItemRequestOptions == null || encryptionItemRequestOptions.getEncryptionOptions() == null) {\n+            return container.createItem(item, partitionKey, requestOptions);\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 233}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwNDMzOQ==", "bodyText": "thanks. next commit will fix.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504904339", "createdAt": "2020-10-14T18:59:37Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -163,29 +204,66 @@\n         EncryptionItemRequestOptions encryptionItemRequestOptions = Utils.as(requestOptions,\n             EncryptionItemRequestOptions.class);\n \n-        if (encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null) {\n-            Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n-                + \"EncryptionContainer.\");\n+        if (encryptionItemRequestOptions == null || encryptionItemRequestOptions.getEncryptionOptions() == null) {\n+            return container.createItem(item, partitionKey, requestOptions);\n+        }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMTYzMA=="}, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 233}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MjcwNDQzOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1NToyOFrOHhgxZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1ODozNVrOHhg4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMTk4OA==", "bodyText": "???", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504901988", "createdAt": "2020-10-14T18:55:28Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -163,29 +204,66 @@\n         EncryptionItemRequestOptions encryptionItemRequestOptions = Utils.as(requestOptions,\n             EncryptionItemRequestOptions.class);\n \n-        if (encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null) {\n-            Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n-                + \"EncryptionContainer.\");\n+        if (encryptionItemRequestOptions == null || encryptionItemRequestOptions.getEncryptionOptions() == null) {\n+            return container.createItem(item, partitionKey, requestOptions);\n+        }\n+\n+\n+        Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n+            + \"EncryptionContainer.\");\n+\n+\n+        EncryptableItem encryptableItem = Utils.as(item, EncryptableItem.class);\n+        if (encryptableItem != null) {\n+            byte[] streamPayload = encryptableItem.toStream(this.getItemDeserializer());\n+\n+            Mono<CosmosItemResponse<byte[]>> rspMono = this.createItemHelper(streamPayload,\n+                partitionKey,\n+                requestOptions,\n+                false);\n+\n \n-            return Mono.defer(() -> {\n-                byte[] payload = cosmosSerializerToStream(item);\n-                Mono<CosmosItemResponse<byte[]>> result = this.createItemStream(payload, partitionKey,\n-                    encryptionItemRequestOptions);\n+            return rspMono.map(\n+                rsp -> {\n+                    encryptableItem.setDecryptableItem(\n+                        // EncryptionProcessor.BaseSerializer.FromStream<JObject>(responseMessage.Content),\n+                        getItemDeserializer().parseFrom(ObjectNode.class,\n+                            EncryptionModelBridgeInternal.getByteArrayContent(rsp)),\n+                        this.encryptor,\n+                        this.getItemDeserializer()\n+                    );\n \n-                return result.map(rsp -> (CosmosItemResponse<T>) this.responseFactory.createItemResponse(rsp,\n-                    item.getClass()));\n+                    return createEncryptionItemResponse(rsp, (T) encryptableItem);\n+                }\n+            ).subscribeOn(encryptionScheduler);\n \n-            }).subscribeOn(encryptionScheduler);\n         } else {\n-            return container.createItem(item, partitionKey, requestOptions);\n+            byte[] streamPayload = cosmosSerializerToStream(item);\n+            Mono<CosmosItemResponse<byte[]>> response = createItemHelper(\n+                streamPayload,\n+                partitionKey,\n+                requestOptions,\n+                true\n+            );\n+\n+            return response\n+                .publishOn(encryptionScheduler)\n+                .map(\n+                    rsp -> {\n+                        return this.responseFactory.createItemResponse(rsp, (Class<T>) item.getClass());\n+                    }\n+                );\n+\n+            // TODO: no support for streaming", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 288}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMzczNA==", "bodyText": "we don't have support for streaming anywhere in the SDK.\nI am considering wiring up some byte[] API.\nthis TODO is only a hint to myself no actual work is remaining.\nI will reword it to make it cleaner.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504903734", "createdAt": "2020-10-14T18:58:35Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -163,29 +204,66 @@\n         EncryptionItemRequestOptions encryptionItemRequestOptions = Utils.as(requestOptions,\n             EncryptionItemRequestOptions.class);\n \n-        if (encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null) {\n-            Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n-                + \"EncryptionContainer.\");\n+        if (encryptionItemRequestOptions == null || encryptionItemRequestOptions.getEncryptionOptions() == null) {\n+            return container.createItem(item, partitionKey, requestOptions);\n+        }\n+\n+\n+        Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n+            + \"EncryptionContainer.\");\n+\n+\n+        EncryptableItem encryptableItem = Utils.as(item, EncryptableItem.class);\n+        if (encryptableItem != null) {\n+            byte[] streamPayload = encryptableItem.toStream(this.getItemDeserializer());\n+\n+            Mono<CosmosItemResponse<byte[]>> rspMono = this.createItemHelper(streamPayload,\n+                partitionKey,\n+                requestOptions,\n+                false);\n+\n \n-            return Mono.defer(() -> {\n-                byte[] payload = cosmosSerializerToStream(item);\n-                Mono<CosmosItemResponse<byte[]>> result = this.createItemStream(payload, partitionKey,\n-                    encryptionItemRequestOptions);\n+            return rspMono.map(\n+                rsp -> {\n+                    encryptableItem.setDecryptableItem(\n+                        // EncryptionProcessor.BaseSerializer.FromStream<JObject>(responseMessage.Content),\n+                        getItemDeserializer().parseFrom(ObjectNode.class,\n+                            EncryptionModelBridgeInternal.getByteArrayContent(rsp)),\n+                        this.encryptor,\n+                        this.getItemDeserializer()\n+                    );\n \n-                return result.map(rsp -> (CosmosItemResponse<T>) this.responseFactory.createItemResponse(rsp,\n-                    item.getClass()));\n+                    return createEncryptionItemResponse(rsp, (T) encryptableItem);\n+                }\n+            ).subscribeOn(encryptionScheduler);\n \n-            }).subscribeOn(encryptionScheduler);\n         } else {\n-            return container.createItem(item, partitionKey, requestOptions);\n+            byte[] streamPayload = cosmosSerializerToStream(item);\n+            Mono<CosmosItemResponse<byte[]>> response = createItemHelper(\n+                streamPayload,\n+                partitionKey,\n+                requestOptions,\n+                true\n+            );\n+\n+            return response\n+                .publishOn(encryptionScheduler)\n+                .map(\n+                    rsp -> {\n+                        return this.responseFactory.createItemResponse(rsp, (Class<T>) item.getClass());\n+                    }\n+                );\n+\n+            // TODO: no support for streaming", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMTk4OA=="}, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 288}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MjcxMDUwOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1NzoxNVrOHhg1Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxOTowNDoxMlrOHhhESg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMjk3MA==", "bodyText": "Same as above - at least to me it isn't clear what this comment means. We don't support Stream Apis at all in Java,  correct?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504902970", "createdAt": "2020-10-14T18:57:15Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -261,48 +375,85 @@\n         EncryptionItemRequestOptions encryptionItemRequestOptions = Utils.as(requestOptions,\n             EncryptionItemRequestOptions.class);\n \n-        if (encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null) {\n-            Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n-                + \"EncryptionContainer.\");\n+        if (encryptionItemRequestOptions == null || encryptionItemRequestOptions.getEncryptionOptions() == null) {\n+            return container.replaceItem(item, itemId, partitionKey, requestOptions);\n+        }\n+\n+        Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n+            + \"EncryptionContainer.\");\n \n-            return Mono.defer(() -> {\n-                byte[] payload = cosmosSerializerToStream(item);\n-                Mono<CosmosItemResponse<byte[]>> result = this.replaceItemStream(payload,\n-                    itemId,\n-                    partitionKey,\n-                    encryptionItemRequestOptions);\n \n-                return result.map(rsp -> (CosmosItemResponse<T>) this.responseFactory.createItemResponse(rsp,\n-                    item.getClass()));\n-            }).subscribeOn(encryptionScheduler);\n+        EncryptableItem encryptableItem = Utils.as(item, EncryptableItem.class);\n+        if (encryptableItem != null) {\n+\n+            // using (Stream streamPayload = encryptableItem.ToStream(this.CosmosSerializer))\n+            byte[] streamPayload = encryptableItem.toStream(this.getItemDeserializer());\n+\n+            Mono<CosmosItemResponse<byte[]>> rspMono = this.replaceItemHelper(streamPayload,\n+                itemId,\n+                partitionKey,\n+                requestOptions,\n+                false);\n+\n+\n+            return rspMono.map(\n+                rsp -> {\n+                    encryptableItem.setDecryptableItem(\n+                        //EncryptionProcessor.BaseSerializer.FromStream<JObject>(responseMessage.Content),\n+                        getItemDeserializer().parseFrom(ObjectNode.class,\n+                            EncryptionModelBridgeInternal.getByteArrayContent(rsp)),\n+                        this.encryptor,\n+                        this.getItemDeserializer()\n+                    );\n+\n+                    return createEncryptionItemResponse(rsp, (T) encryptableItem);\n+                }\n+            ).subscribeOn(encryptionScheduler);\n \n         } else {\n-            return container.replaceItem(item, itemId, partitionKey, requestOptions);\n+            byte[] streamPayload = cosmosSerializerToStream(item);\n+            Mono<CosmosItemResponse<byte[]>> response = replaceItemHelper(\n+                streamPayload,\n+                itemId,\n+                partitionKey,\n+                requestOptions,\n+                true\n+            );\n+\n+            return response\n+                .publishOn(encryptionScheduler)\n+                .map(\n+                    rsp -> {\n+                        return this.responseFactory.createItemResponse(rsp, (Class<T>) item.getClass());\n+                    }\n+                );\n+\n+            // TODO: no support for streaming", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 443}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwNjgyNg==", "bodyText": "you are right the comment is confusing.\nwe don't support streaming api in java SDK.\nwill cleanup", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504906826", "createdAt": "2020-10-14T19:04:12Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -261,48 +375,85 @@\n         EncryptionItemRequestOptions encryptionItemRequestOptions = Utils.as(requestOptions,\n             EncryptionItemRequestOptions.class);\n \n-        if (encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null) {\n-            Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n-                + \"EncryptionContainer.\");\n+        if (encryptionItemRequestOptions == null || encryptionItemRequestOptions.getEncryptionOptions() == null) {\n+            return container.replaceItem(item, itemId, partitionKey, requestOptions);\n+        }\n+\n+        Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n+            + \"EncryptionContainer.\");\n \n-            return Mono.defer(() -> {\n-                byte[] payload = cosmosSerializerToStream(item);\n-                Mono<CosmosItemResponse<byte[]>> result = this.replaceItemStream(payload,\n-                    itemId,\n-                    partitionKey,\n-                    encryptionItemRequestOptions);\n \n-                return result.map(rsp -> (CosmosItemResponse<T>) this.responseFactory.createItemResponse(rsp,\n-                    item.getClass()));\n-            }).subscribeOn(encryptionScheduler);\n+        EncryptableItem encryptableItem = Utils.as(item, EncryptableItem.class);\n+        if (encryptableItem != null) {\n+\n+            // using (Stream streamPayload = encryptableItem.ToStream(this.CosmosSerializer))\n+            byte[] streamPayload = encryptableItem.toStream(this.getItemDeserializer());\n+\n+            Mono<CosmosItemResponse<byte[]>> rspMono = this.replaceItemHelper(streamPayload,\n+                itemId,\n+                partitionKey,\n+                requestOptions,\n+                false);\n+\n+\n+            return rspMono.map(\n+                rsp -> {\n+                    encryptableItem.setDecryptableItem(\n+                        //EncryptionProcessor.BaseSerializer.FromStream<JObject>(responseMessage.Content),\n+                        getItemDeserializer().parseFrom(ObjectNode.class,\n+                            EncryptionModelBridgeInternal.getByteArrayContent(rsp)),\n+                        this.encryptor,\n+                        this.getItemDeserializer()\n+                    );\n+\n+                    return createEncryptionItemResponse(rsp, (T) encryptableItem);\n+                }\n+            ).subscribeOn(encryptionScheduler);\n \n         } else {\n-            return container.replaceItem(item, itemId, partitionKey, requestOptions);\n+            byte[] streamPayload = cosmosSerializerToStream(item);\n+            Mono<CosmosItemResponse<byte[]>> response = replaceItemHelper(\n+                streamPayload,\n+                itemId,\n+                partitionKey,\n+                requestOptions,\n+                true\n+            );\n+\n+            return response\n+                .publishOn(encryptionScheduler)\n+                .map(\n+                    rsp -> {\n+                        return this.responseFactory.createItemResponse(rsp, (Class<T>) item.getClass());\n+                    }\n+                );\n+\n+            // TODO: no support for streaming", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMjk3MA=="}, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 443}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4109, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}