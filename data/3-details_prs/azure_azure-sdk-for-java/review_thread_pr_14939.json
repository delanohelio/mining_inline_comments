{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyNDE1NjU2", "number": 14939, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjozODoxNFrOEhhvyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjo1MTowMlrOEhh_bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTkxMzY4OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/ServiceBusSharedKeyCredentialTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjozODoxNFrOHO4u2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzozMTozOFrOHPSqUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM3MTYxMQ==", "bodyText": "Can we add one more example where user give bad date time format for example 202012-31T13:37:45Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14939#discussion_r485371611", "createdAt": "2020-09-09T06:38:14Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/ServiceBusSharedKeyCredentialTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus.implementation;\n+\n+import com.azure.core.credential.TokenRequestContext;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import reactor.test.StepVerifier;\n+\n+import java.time.OffsetDateTime;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+/**\n+ * Unit tests for {@link ServiceBusSharedKeyCredential}.\n+ */\n+public class ServiceBusSharedKeyCredentialTest {\n+\n+    @ParameterizedTest\n+    @MethodSource(\"getSas\")\n+    public void testSharedAccessSignatureCredential(String sas, OffsetDateTime expectedExpirationTime) {\n+        ServiceBusSharedKeyCredential serviceBusSharedKeyCredential = new ServiceBusSharedKeyCredential(sas);\n+        StepVerifier.create(serviceBusSharedKeyCredential.getToken(new TokenRequestContext().addScopes(\"sb://test\"\n+            + \"-entity.servicebus.windows.net/.default\")))\n+            .assertNext(token -> {\n+                assertNotNull(token.getToken());\n+                assertEquals(sas, token.getToken());\n+                assertEquals(expectedExpirationTime, token.getExpiresAt());\n+            })\n+            .verifyComplete();\n+    }\n+\n+    private static Stream<Arguments> getSas() {\n+        String validSas = \"SharedAccessSignature \"\n+            + \"sr=https%3A%2F%2Fentity-name.servicebus.windows.net%2F\"\n+            + \"&sig=encodedsignature%3D\"\n+            + \"&se=1599537084\"\n+            + \"&skn=test-sas-key\";\n+        String validSasWithNoExpirationTime = \"SharedAccessSignature \"\n+            + \"sr=https%3A%2F%2Fentity-name.servicebus.windows.net%2F\"\n+            + \"&sig=encodedsignature%3D\"\n+            + \"&skn=test-sas-key\";\n+        String validSasInvalidExpirationTimeFormat = \"SharedAccessSignature \"\n+            + \"sr=https%3A%2F%2Fentity-name.servicebus.windows.net%2F\"\n+            + \"&sig=encodedsignature%3D\"\n+            + \"&se=se=2020-12-31T13:37:45Z\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa6d0e08e997a28dc0501830004fdc9fd5ec5327"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5NjQzMw==", "bodyText": "Any non-integer format will be ignored and this test is covering that.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14939#discussion_r485796433", "createdAt": "2020-09-09T17:31:38Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/ServiceBusSharedKeyCredentialTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus.implementation;\n+\n+import com.azure.core.credential.TokenRequestContext;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import reactor.test.StepVerifier;\n+\n+import java.time.OffsetDateTime;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+/**\n+ * Unit tests for {@link ServiceBusSharedKeyCredential}.\n+ */\n+public class ServiceBusSharedKeyCredentialTest {\n+\n+    @ParameterizedTest\n+    @MethodSource(\"getSas\")\n+    public void testSharedAccessSignatureCredential(String sas, OffsetDateTime expectedExpirationTime) {\n+        ServiceBusSharedKeyCredential serviceBusSharedKeyCredential = new ServiceBusSharedKeyCredential(sas);\n+        StepVerifier.create(serviceBusSharedKeyCredential.getToken(new TokenRequestContext().addScopes(\"sb://test\"\n+            + \"-entity.servicebus.windows.net/.default\")))\n+            .assertNext(token -> {\n+                assertNotNull(token.getToken());\n+                assertEquals(sas, token.getToken());\n+                assertEquals(expectedExpirationTime, token.getExpiresAt());\n+            })\n+            .verifyComplete();\n+    }\n+\n+    private static Stream<Arguments> getSas() {\n+        String validSas = \"SharedAccessSignature \"\n+            + \"sr=https%3A%2F%2Fentity-name.servicebus.windows.net%2F\"\n+            + \"&sig=encodedsignature%3D\"\n+            + \"&se=1599537084\"\n+            + \"&skn=test-sas-key\";\n+        String validSasWithNoExpirationTime = \"SharedAccessSignature \"\n+            + \"sr=https%3A%2F%2Fentity-name.servicebus.windows.net%2F\"\n+            + \"&sig=encodedsignature%3D\"\n+            + \"&skn=test-sas-key\";\n+        String validSasInvalidExpirationTimeFormat = \"SharedAccessSignature \"\n+            + \"sr=https%3A%2F%2Fentity-name.servicebus.windows.net%2F\"\n+            + \"&sig=encodedsignature%3D\"\n+            + \"&se=se=2020-12-31T13:37:45Z\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM3MTYxMQ=="}, "originalCommit": {"oid": "fa6d0e08e997a28dc0501830004fdc9fd5ec5327"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTkxNzMzOnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/ServiceBusSharedKeyCredentialTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjozOToxNlrOHO4w3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzozMDoyNVrOHPSnsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM3MjEyNg==", "bodyText": "What if user give a space, will it be valid  for example & se =1599537084 ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14939#discussion_r485372126", "createdAt": "2020-09-09T06:39:16Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/ServiceBusSharedKeyCredentialTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus.implementation;\n+\n+import com.azure.core.credential.TokenRequestContext;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import reactor.test.StepVerifier;\n+\n+import java.time.OffsetDateTime;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+/**\n+ * Unit tests for {@link ServiceBusSharedKeyCredential}.\n+ */\n+public class ServiceBusSharedKeyCredentialTest {\n+\n+    @ParameterizedTest\n+    @MethodSource(\"getSas\")\n+    public void testSharedAccessSignatureCredential(String sas, OffsetDateTime expectedExpirationTime) {\n+        ServiceBusSharedKeyCredential serviceBusSharedKeyCredential = new ServiceBusSharedKeyCredential(sas);\n+        StepVerifier.create(serviceBusSharedKeyCredential.getToken(new TokenRequestContext().addScopes(\"sb://test\"\n+            + \"-entity.servicebus.windows.net/.default\")))\n+            .assertNext(token -> {\n+                assertNotNull(token.getToken());\n+                assertEquals(sas, token.getToken());\n+                assertEquals(expectedExpirationTime, token.getExpiresAt());\n+            })\n+            .verifyComplete();\n+    }\n+\n+    private static Stream<Arguments> getSas() {\n+        String validSas = \"SharedAccessSignature \"\n+            + \"sr=https%3A%2F%2Fentity-name.servicebus.windows.net%2F\"\n+            + \"&sig=encodedsignature%3D\"\n+            + \"&se=1599537084\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa6d0e08e997a28dc0501830004fdc9fd5ec5327"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5NTc2Mg==", "bodyText": "We do not validate the contents of the SAS token. The service will throw an exception if there are unnecessary chars in the token.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14939#discussion_r485795762", "createdAt": "2020-09-09T17:30:25Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/ServiceBusSharedKeyCredentialTest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus.implementation;\n+\n+import com.azure.core.credential.TokenRequestContext;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import reactor.test.StepVerifier;\n+\n+import java.time.OffsetDateTime;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+/**\n+ * Unit tests for {@link ServiceBusSharedKeyCredential}.\n+ */\n+public class ServiceBusSharedKeyCredentialTest {\n+\n+    @ParameterizedTest\n+    @MethodSource(\"getSas\")\n+    public void testSharedAccessSignatureCredential(String sas, OffsetDateTime expectedExpirationTime) {\n+        ServiceBusSharedKeyCredential serviceBusSharedKeyCredential = new ServiceBusSharedKeyCredential(sas);\n+        StepVerifier.create(serviceBusSharedKeyCredential.getToken(new TokenRequestContext().addScopes(\"sb://test\"\n+            + \"-entity.servicebus.windows.net/.default\")))\n+            .assertNext(token -> {\n+                assertNotNull(token.getToken());\n+                assertEquals(sas, token.getToken());\n+                assertEquals(expectedExpirationTime, token.getExpiresAt());\n+            })\n+            .verifyComplete();\n+    }\n+\n+    private static Stream<Arguments> getSas() {\n+        String validSas = \"SharedAccessSignature \"\n+            + \"sr=https%3A%2F%2Fentity-name.servicebus.windows.net%2F\"\n+            + \"&sig=encodedsignature%3D\"\n+            + \"&se=1599537084\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM3MjEyNg=="}, "originalCommit": {"oid": "fa6d0e08e997a28dc0501830004fdc9fd5ec5327"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTk1MzczOnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusSharedKeyCredential.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNjo1MTowMlrOHO5G1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzozMTo0NlrOHPSqpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM3Nzc0OQ==", "bodyText": "Should we log here in case of logger.verbose(\"Could not parse .... \") to give user information that something might be wrong in their string and they have a chance to fix the formatting issue in their string?  But at same time, we do not want to fill logs.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14939#discussion_r485377749", "createdAt": "2020-09-09T06:51:02Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusSharedKeyCredential.java", "diffHunk": "@@ -155,4 +182,22 @@ private AccessToken generateSharedAccessSignature(final String resource) throws\n \n         return new AccessToken(token, expiresOn);\n     }\n+\n+    private OffsetDateTime getExpirationTime(String sharedAccessSignature) {\n+        String[] parts = sharedAccessSignature.split(\"&\");\n+        return Arrays.stream(parts)\n+            .map(part -> part.split(\"=\"))\n+            .filter(pair -> pair.length == 2 && pair[0].equalsIgnoreCase(\"se\"))\n+            .findFirst()\n+            .map(pair -> pair[1])\n+            .map(expirationTimeStr -> {\n+                try {\n+                    long epochSeconds = Long.parseLong(expirationTimeStr);\n+                    return Instant.ofEpochSecond(epochSeconds).atOffset(ZoneOffset.UTC);\n+                } catch (NumberFormatException exception) {\n+                    return OffsetDateTime.MAX;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa6d0e08e997a28dc0501830004fdc9fd5ec5327"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5NjUxOQ==", "bodyText": "Updated.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14939#discussion_r485796519", "createdAt": "2020-09-09T17:31:46Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusSharedKeyCredential.java", "diffHunk": "@@ -155,4 +182,22 @@ private AccessToken generateSharedAccessSignature(final String resource) throws\n \n         return new AccessToken(token, expiresOn);\n     }\n+\n+    private OffsetDateTime getExpirationTime(String sharedAccessSignature) {\n+        String[] parts = sharedAccessSignature.split(\"&\");\n+        return Arrays.stream(parts)\n+            .map(part -> part.split(\"=\"))\n+            .filter(pair -> pair.length == 2 && pair[0].equalsIgnoreCase(\"se\"))\n+            .findFirst()\n+            .map(pair -> pair[1])\n+            .map(expirationTimeStr -> {\n+                try {\n+                    long epochSeconds = Long.parseLong(expirationTimeStr);\n+                    return Instant.ofEpochSecond(epochSeconds).atOffset(ZoneOffset.UTC);\n+                } catch (NumberFormatException exception) {\n+                    return OffsetDateTime.MAX;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM3Nzc0OQ=="}, "originalCommit": {"oid": "fa6d0e08e997a28dc0501830004fdc9fd5ec5327"}, "originalPosition": 74}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1235, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}