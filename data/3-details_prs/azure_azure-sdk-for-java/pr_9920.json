{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNDE1OTgz", "number": 9920, "title": "Better Handling for Blob Batch Tests in Playback", "bodyText": "This PR updates the Blob Batch tests where some operations fail, but not all the operations fail. The underlying request generation system is non-deterministic as it is able to generated multiple operations at once which may result in a different operation order each time the test is ran. This work properly when running against the live service as the request and response are tied together using a Content-ID marker but running the tests in playback this is an issue as it isn't capable of handling variance in ordering.\nTests where some operations are expected to fail were updated to use an order invariant check to determine correctness. All responses are checked for either having the correct response code or throwing the expected exception, they are then aggregated to validate that the number of successful operations matched what was expected. When tests are running against the live service the tests will continue to check that the operation succeeded or failed as expected in a strict ordering.", "createdAt": "2020-04-07T17:55:30Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9920", "merged": true, "mergeCommit": {"oid": "080ce6ef3ed59d1cc403d47450d135adfc5809fc"}, "closed": true, "closedAt": "2020-04-07T20:43:04Z", "author": {"login": "alzimmermsft"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVXD5hAH2gAyNDAwNDE1OTgzOjFjOGMzNDg3NjExYmIzZjUyYjgwNmY5Njk3NTZkZjQ4NzgzMTJiNzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVZdJIgFqTM4OTQ3MTcyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1c8c3487611bb3f52b806f969756df4878312b70", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1c8c3487611bb3f52b806f969756df4878312b70", "committedDate": "2020-04-07T17:50:34Z", "message": "Update some failure tests to handle playback better"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb6ef45be3fc0dbba52732802faefeaa4c363e0e", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/eb6ef45be3fc0dbba52732802faefeaa4c363e0e", "committedDate": "2020-04-07T17:59:29Z", "message": "Load into local variable before asserting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5Mzc5MjI0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9920#pullrequestreview-389379224", "createdAt": "2020-04-07T18:25:03Z", "commit": {"oid": "eb6ef45be3fc0dbba52732802faefeaa4c363e0e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODoyNTowM1rOGCQiiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODoyNTowM1rOGCQiiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyMTMyMA==", "bodyText": "If there is definitely one will fail, it is better to check fail at &.\n!assertExpectedOrException(response1, 200) && assertExpectedOrException(response2, 200)", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9920#discussion_r405021320", "createdAt": "2020-04-07T18:25:03Z", "author": {"login": "sima-zhu"}, "path": "sdk/storage/azure-storage-blob-batch/src/test/java/com/azure/storage/blob/batch/BatchAPITest.groovy", "diffHunk": "@@ -128,14 +152,19 @@ class BatchAPITest extends APISpec {\n         batchClient.submitBatchWithResponse(batch, false, null, Context.NONE)\n \n         then:\n-        notThrown(BlobStorageException)\n-        response1.getStatusCode() == 200\n+        notThrown(BlobBatchStorageException)\n \n-        when:\n-        response2.getStatusCode()\n-\n-        then:\n-        thrown(BlobStorageException)\n+        // In PLAYBACK check responses in an order invariant fashion.\n+        if (testMode == TestMode.PLAYBACK) {\n+            assertExpectedOrException(response1, 200) || assertExpectedOrException(response2, 200)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb6ef45be3fc0dbba52732802faefeaa4c363e0e"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ecfbf3c8771fa692aa358f2ebac57aec1994f9b", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5ecfbf3c8771fa692aa358f2ebac57aec1994f9b", "committedDate": "2020-04-07T18:32:52Z", "message": "Merge branch 'master' into AzStorage_FixBlobBatchPlaybackTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e874d06b21f47a80d9568fb23fc56776ce77bad1", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e874d06b21f47a80d9568fb23fc56776ce77bad1", "committedDate": "2020-04-07T18:38:01Z", "message": "Updated playback validation to assert count of successful responses"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzkzMjY3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9920#pullrequestreview-389393267", "createdAt": "2020-04-07T18:44:19Z", "commit": {"oid": "e874d06b21f47a80d9568fb23fc56776ce77bad1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NDcxNzIy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9920#pullrequestreview-389471722", "createdAt": "2020-04-07T20:37:57Z", "commit": {"oid": "e874d06b21f47a80d9568fb23fc56776ce77bad1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1237, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}