{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0NjI0MDY0", "number": 15078, "title": "Enable Keyvault.keyVaultWithVirtualMachineMSI", "bodyText": "Update Keyvault integration test", "createdAt": "2020-09-11T04:13:17Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078", "merged": true, "mergeCommit": {"oid": "0345889402425191b7003e73b7b3d6ea3c0a5175"}, "closed": true, "closedAt": "2020-09-24T09:50:00Z", "author": {"login": "zhichengliu12581"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH5PIIgFqTQ4NzAwOTgyNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLn0eagFqTQ5NDM5MjY1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDA5ODI3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#pullrequestreview-487009827", "createdAt": "2020-09-11T17:55:49Z", "commit": {"oid": "d10b4b5236ac3f98d273b30ac4d030808ec1067f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NDUwNzUx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#pullrequestreview-487450751", "createdAt": "2020-09-14T06:34:34Z", "commit": {"oid": "d10b4b5236ac3f98d273b30ac4d030808ec1067f"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNjozNDozNVrOHRFo1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNjozNDozNVrOHRFo1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4MDIxMg==", "bodyText": "Why make such changes here?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r487680212", "createdAt": "2020-09-14T06:34:35Z", "author": {"login": "saragluna"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/microsoft/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -164,7 +155,13 @@ public void keyVaultWithVirtualMachineMSI() throws Exception {\n             AZURE_KEYVAULT_URI,\n             \"app.jar\"));\n \n-        vm.runCommand(new RunCommandInput().withCommandId(\"RunShellScript\").withScript(commands));\n+        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d10b4b5236ac3f98d273b30ac4d030808ec1067f"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7da1ed313827ae845dd742f6e05741c416bf07b3", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7da1ed313827ae845dd742f6e05741c416bf07b3", "committedDate": "2020-09-22T09:36:54Z", "message": "Keep port 8080 open"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbab4bce9a0ffde43e7710bd4749cef9e77cd71f", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/cbab4bce9a0ffde43e7710bd4749cef9e77cd71f", "committedDate": "2020-09-22T09:38:45Z", "message": "Change the way of uploading files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMjg5NjM5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#pullrequestreview-493289639", "createdAt": "2020-09-22T09:42:27Z", "commit": {"oid": "cbab4bce9a0ffde43e7710bd4749cef9e77cd71f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOTo0MjoyN1rOHVyMkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOTo0MjoyN1rOHVyMkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYwNDU2MQ==", "bodyText": "Please install java maven in this file: https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/spring/azure-spring-boot-test-keyvault/install_java.sh", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r492604561", "createdAt": "2020-09-22T09:42:27Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -131,30 +127,25 @@ public void keyVaultWithAppServiceMSI() {\n     }\n \n     @Test\n-    @Ignore\n-    public void keyVaultWithVirtualMachineMSI() throws Exception {\n+    public void keyVaultWithVirtualMachineMSI() {\n         final VirtualMachine vm = AZURE.virtualMachines().getByResourceGroup(SPRING_RESOURCE_GROUP, VM_NAME);\n \n         final String host = vm.getPrimaryPublicIPAddress().ipAddress();\n \n-        // Upload app.jar to virtual machine\n-        final MavenBasedProject app = new MavenBasedProject(\"../azure-spring-boot-test-application\");\n-        app.packageUp();\n-\n-        final File file = new File(app.artifact());\n-\n-        if (!file.exists()) {\n-            throw new FileNotFoundException(\"There's no app.jar file found.\");\n-        }\n-        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);\n-            FileInputStream fis = new FileInputStream(file)) {\n-            LOGGER.info(\"Uploading jar file...\");\n-            sshShell.upload(fis, \"app.jar\", \"\", true, \"4095\");\n-        }\n-\n-        // run java application\n         final List<String> commands = new ArrayList<>();\n         commands.add(String.format(\"cd /home/%s\", VM_USER_USERNAME));\n+        commands.add(\"apt-get install maven -y\");\n+        commands.add(\"apt-get install git\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbab4bce9a0ffde43e7710bd4749cef9e77cd71f"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6910cc8db9af1500d2df9919f08dc36b058c148", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b6910cc8db9af1500d2df9919f08dc36b058c148", "committedDate": "2020-09-23T05:49:38Z", "message": "The virtual machine has installed the software\n\nThe corresponding software has been installed when the virtual machine is created"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0Mzg4MjQz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#pullrequestreview-494388243", "createdAt": "2020-09-23T07:50:37Z", "commit": {"oid": "b6910cc8db9af1500d2df9919f08dc36b058c148"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1MDozOFrOHWa3_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1MDozOFrOHWa3_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3MTAzOQ==", "bodyText": "Can we use current branch instead of master branch?\nRefs: https://stackoverflow.com/questions/49106104/get-current-git-branch-inside-a-java-test", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r493271039", "createdAt": "2020-09-23T07:50:38Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -131,30 +127,23 @@ public void keyVaultWithAppServiceMSI() {\n     }\n \n     @Test\n-    @Ignore\n-    public void keyVaultWithVirtualMachineMSI() throws Exception {\n+    public void keyVaultWithVirtualMachineMSI() {\n         final VirtualMachine vm = AZURE.virtualMachines().getByResourceGroup(SPRING_RESOURCE_GROUP, VM_NAME);\n \n         final String host = vm.getPrimaryPublicIPAddress().ipAddress();\n \n-        // Upload app.jar to virtual machine\n-        final MavenBasedProject app = new MavenBasedProject(\"../azure-spring-boot-test-application\");\n-        app.packageUp();\n-\n-        final File file = new File(app.artifact());\n-\n-        if (!file.exists()) {\n-            throw new FileNotFoundException(\"There's no app.jar file found.\");\n-        }\n-        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);\n-            FileInputStream fis = new FileInputStream(file)) {\n-            LOGGER.info(\"Uploading jar file...\");\n-            sshShell.upload(fis, \"app.jar\", \"\", true, \"4095\");\n-        }\n-\n-        // run java application\n         final List<String> commands = new ArrayList<>();\n         commands.add(String.format(\"cd /home/%s\", VM_USER_USERNAME));\n+        commands.add(\"mkdir azure-sdk-for-java\");\n+        commands.add(\"cd azure-sdk-for-java\");\n+        commands.add(\"git init\");\n+        commands.add(\"git remote add origin https://github.com/Azure/azure-sdk-for-java.git\");\n+        commands.add(\"git config core.sparsecheckout true\");\n+        commands.add(\"echo sdk/spring > .git/info/sparse-checkout\");\n+        commands.add(\"git pull origin master\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6910cc8db9af1500d2df9919f08dc36b058c148"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MzkyNjUx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#pullrequestreview-494392651", "createdAt": "2020-09-23T07:54:00Z", "commit": {"oid": "b6910cc8db9af1500d2df9919f08dc36b058c148"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1NDowMVrOHWbCQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1NDowMVrOHWbCQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3MzY2NQ==", "bodyText": "We need update origin too.\nRefs: https://stackoverflow.com/questions/171550/find-out-which-remote-branch-a-local-branch-is-tracking", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r493273665", "createdAt": "2020-09-23T07:54:01Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -131,30 +127,23 @@ public void keyVaultWithAppServiceMSI() {\n     }\n \n     @Test\n-    @Ignore\n-    public void keyVaultWithVirtualMachineMSI() throws Exception {\n+    public void keyVaultWithVirtualMachineMSI() {\n         final VirtualMachine vm = AZURE.virtualMachines().getByResourceGroup(SPRING_RESOURCE_GROUP, VM_NAME);\n \n         final String host = vm.getPrimaryPublicIPAddress().ipAddress();\n \n-        // Upload app.jar to virtual machine\n-        final MavenBasedProject app = new MavenBasedProject(\"../azure-spring-boot-test-application\");\n-        app.packageUp();\n-\n-        final File file = new File(app.artifact());\n-\n-        if (!file.exists()) {\n-            throw new FileNotFoundException(\"There's no app.jar file found.\");\n-        }\n-        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);\n-            FileInputStream fis = new FileInputStream(file)) {\n-            LOGGER.info(\"Uploading jar file...\");\n-            sshShell.upload(fis, \"app.jar\", \"\", true, \"4095\");\n-        }\n-\n-        // run java application\n         final List<String> commands = new ArrayList<>();\n         commands.add(String.format(\"cd /home/%s\", VM_USER_USERNAME));\n+        commands.add(\"mkdir azure-sdk-for-java\");\n+        commands.add(\"cd azure-sdk-for-java\");\n+        commands.add(\"git init\");\n+        commands.add(\"git remote add origin https://github.com/Azure/azure-sdk-for-java.git\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6910cc8db9af1500d2df9919f08dc36b058c148"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3632, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}