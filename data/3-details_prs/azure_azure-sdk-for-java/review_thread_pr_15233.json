{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3NTgwNTkw", "number": 15233, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMjo1ODo0OVrOEj3g7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMzowMzozOFrOEj3kQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MDQ1MTY0OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMjo1ODo0OVrOHSePpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMjo1ODo0OVrOHSePpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEzMTk0Mg==", "bodyText": "you have repeated code here and above method and also seems similar to code block in RxGatewayStoreModel.\nfor future work consider refactor the common code if that is possible.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15233#discussion_r489131942", "createdAt": "2020-09-16T02:58:49Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "diffHunk": "@@ -493,19 +525,52 @@ public void dispose() {\n         Mono<RxDocumentServiceResponse> dsrObs = HttpClientUtils.parseResponseAsync(httpResponseMono, httpRequest);\n \n         return dsrObs.map(\n-                dsr -> {\n-                    MetadataDiagnosticsContext metadataDiagnosticsContext = BridgeInternal.getMetaDataDiagnosticContext(request.requestContext.cosmosDiagnostics);\n-                    if (metadataDiagnosticsContext != null) {\n-                        Instant addressCallEndTime = Instant.now();\n-                        MetadataDiagnostics metaDataDiagnostic = new MetadataDiagnostics(addressCallStartTime,\n-                            addressCallEndTime,\n-                            MetadataType.MASTER_ADDRESS_LOOK_UP);\n-                        metadataDiagnosticsContext.addMetaDataDiagnostic(metaDataDiagnostic);\n-                    }\n+            dsr -> {\n+                MetadataDiagnosticsContext metadataDiagnosticsContext =\n+                    BridgeInternal.getMetaDataDiagnosticContext(request.requestContext.cosmosDiagnostics);\n+                if (metadataDiagnosticsContext != null) {\n+                    Instant addressCallEndTime = Instant.now();\n+                    MetadataDiagnostics metaDataDiagnostic = new MetadataDiagnostics(addressCallStartTime,\n+                        addressCallEndTime,\n+                        MetadataType.MASTER_ADDRESS_LOOK_UP);\n+                    metadataDiagnosticsContext.addMetaDataDiagnostic(metaDataDiagnostic);\n+                }\n \n-                    logAddressResolutionEnd(request, identifier);\n-                    return dsr.getQueryResponse(Address.class);\n-                });\n+                logAddressResolutionEnd(request, identifier, null);\n+                return dsr.getQueryResponse(Address.class);\n+            }).onErrorResume(throwable -> {\n+            Throwable unwrappedException = reactor.core.Exceptions.unwrap(throwable);\n+            logAddressResolutionEnd(request, identifier, unwrappedException.toString());\n+            if (!(unwrappedException instanceof Exception)) {\n+                // fatal error\n+                logger.error(\"Unexpected failure {}\", unwrappedException.getMessage(), unwrappedException);\n+                return Mono.error(unwrappedException);\n+            }\n+\n+            Exception exception = (Exception) unwrappedException;\n+            CosmosException dce;\n+            if (!(exception instanceof CosmosException)) {\n+                // wrap in CosmosException\n+                logger.error(\"Network failure\", exception);\n+                dce = BridgeInternal.createCosmosException(0, exception);\n+                BridgeInternal.setRequestHeaders(dce, request.getHeaders());\n+            } else {\n+                dce = (CosmosException) exception;\n+            }\n+\n+            if (WebExceptionUtility.isNetworkFailure(dce)) {\n+                BridgeInternal.setSubStatusCode(dce, HttpConstants.SubStatusCodes.GATEWAY_ENDPOINT_UNAVAILABLE);\n+            }\n+\n+            if (request.requestContext.cosmosDiagnostics != null) {\n+                BridgeInternal.recordGatewayResponse(request.requestContext.cosmosDiagnostics, request, null,\n+                    dce);\n+                BridgeInternal.setCosmosDiagnostics(dce,\n+                    request.requestContext.cosmosDiagnostics);\n+            }\n+\n+            return Mono.error(dce);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79a5a97d35ff631ca7be32a220943948a8073971"}, "originalPosition": 155}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MDQ1ODM1OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/CosmosDiagnosticsTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMzowMjozMlrOHSeTiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMzowMjozMlrOHSeTiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEzMjkzOQ==", "bodyText": "I suspect this failure/assertion doesn't have any effect as this is happening on a different thread which is not joined.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15233#discussion_r489132939", "createdAt": "2020-09-16T03:02:32Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/CosmosDiagnosticsTest.java", "diffHunk": "@@ -477,6 +487,80 @@ public void serializationOnVariousScenarios() {\n         assertThat(diagnostics).contains(\"\\\"userAgent\\\":\\\"\" + Utils.getUserAgent() + \"\\\"\");\n     }\n \n+    @Test(groups = {\"emulator\"}, timeOut = TIMEOUT)\n+    public void addressResolutionStatistics() {\n+        CosmosClient client = null;\n+        try {\n+            client = new CosmosClientBuilder()\n+                .endpoint(TestConfigurations.HOST)\n+                .key(TestConfigurations.MASTER_KEY)\n+                .contentResponseOnWriteEnabled(true)\n+                .directMode()\n+                .buildClient();\n+            CosmosContainer container =\n+                client.getDatabase(cosmosAsyncContainer.getDatabase().getId()).getContainer(cosmosAsyncContainer.getId());\n+            InternalObjectNode internalObjectNode = getInternalObjectNode();\n+            CosmosItemResponse<InternalObjectNode> writeResourceResponse = container.createItem(internalObjectNode);\n+            //Success address resolution client side statistics\n+            assertThat(writeResourceResponse.getDiagnostics().toString()).contains(\"addressResolutionStatistics\");\n+            assertThat(writeResourceResponse.getDiagnostics().toString()).contains(\"\\\"inflightRequest\\\":false\");\n+            assertThat(writeResourceResponse.getDiagnostics().toString()).doesNotContain(\"endTime=\\\"null\\\"\");\n+            assertThat(writeResourceResponse.getDiagnostics().toString()).contains(\"\\\"errorMessage\\\":null\");\n+            assertThat(writeResourceResponse.getDiagnostics().toString()).doesNotContain(\"\\\"errorMessage\\\":\\\"io.netty\" +\n+                \".channel.AbstractChannel$AnnotatedConnectException: Connection refused: no further information\");\n+\n+            client.close();\n+            client = new CosmosClientBuilder()\n+                .endpoint(TestConfigurations.HOST)\n+                .key(TestConfigurations.MASTER_KEY)\n+                .contentResponseOnWriteEnabled(true)\n+                .directMode()\n+                .buildClient();\n+            container =\n+                client.getDatabase(cosmosAsyncContainer.getDatabase().getId()).getContainer(cosmosAsyncContainer.getId());\n+            AsyncDocumentClient asyncDocumentClient = client.asyncClient().getContextClient();\n+            GlobalAddressResolver addressResolver = (GlobalAddressResolver) FieldUtils.readField(asyncDocumentClient,\n+                \"addressResolver\", true);\n+\n+            @SuppressWarnings(\"rawtypes\")\n+            Map addressCacheByEndpoint = (Map) FieldUtils.readField(addressResolver,\n+                \"addressCacheByEndpoint\",\n+                true);\n+            Object endpointCache = addressCacheByEndpoint.values().toArray()[0];\n+            GatewayAddressCache addressCache = (GatewayAddressCache) FieldUtils.readField(endpointCache, \"addressCache\", true);\n+\n+            HttpClient httpClient = httpClient(true);\n+            FieldUtils.writeField(addressCache, \"httpClient\", httpClient, true);\n+            new Thread(() -> {\n+                try {\n+                    Thread.sleep(5000);\n+                    HttpClient httpClient1 = httpClient(false);\n+                    FieldUtils.writeField(addressCache, \"httpClient\", httpClient1, true);\n+                } catch (Exception e) {\n+                    fail(e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79a5a97d35ff631ca7be32a220943948a8073971"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MDQ2MDE4OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/CosmosDiagnosticsTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMzowMzozOFrOHSeUlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMzowMzozOFrOHSeUlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEzMzIwNA==", "bodyText": "you don't need to catch exception. and fail. the test will fail regardless of this. if the exception is thrown.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15233#discussion_r489133204", "createdAt": "2020-09-16T03:03:38Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/CosmosDiagnosticsTest.java", "diffHunk": "@@ -477,6 +487,80 @@ public void serializationOnVariousScenarios() {\n         assertThat(diagnostics).contains(\"\\\"userAgent\\\":\\\"\" + Utils.getUserAgent() + \"\\\"\");\n     }\n \n+    @Test(groups = {\"emulator\"}, timeOut = TIMEOUT)\n+    public void addressResolutionStatistics() {\n+        CosmosClient client = null;\n+        try {\n+            client = new CosmosClientBuilder()\n+                .endpoint(TestConfigurations.HOST)\n+                .key(TestConfigurations.MASTER_KEY)\n+                .contentResponseOnWriteEnabled(true)\n+                .directMode()\n+                .buildClient();\n+            CosmosContainer container =\n+                client.getDatabase(cosmosAsyncContainer.getDatabase().getId()).getContainer(cosmosAsyncContainer.getId());\n+            InternalObjectNode internalObjectNode = getInternalObjectNode();\n+            CosmosItemResponse<InternalObjectNode> writeResourceResponse = container.createItem(internalObjectNode);\n+            //Success address resolution client side statistics\n+            assertThat(writeResourceResponse.getDiagnostics().toString()).contains(\"addressResolutionStatistics\");\n+            assertThat(writeResourceResponse.getDiagnostics().toString()).contains(\"\\\"inflightRequest\\\":false\");\n+            assertThat(writeResourceResponse.getDiagnostics().toString()).doesNotContain(\"endTime=\\\"null\\\"\");\n+            assertThat(writeResourceResponse.getDiagnostics().toString()).contains(\"\\\"errorMessage\\\":null\");\n+            assertThat(writeResourceResponse.getDiagnostics().toString()).doesNotContain(\"\\\"errorMessage\\\":\\\"io.netty\" +\n+                \".channel.AbstractChannel$AnnotatedConnectException: Connection refused: no further information\");\n+\n+            client.close();\n+            client = new CosmosClientBuilder()\n+                .endpoint(TestConfigurations.HOST)\n+                .key(TestConfigurations.MASTER_KEY)\n+                .contentResponseOnWriteEnabled(true)\n+                .directMode()\n+                .buildClient();\n+            container =\n+                client.getDatabase(cosmosAsyncContainer.getDatabase().getId()).getContainer(cosmosAsyncContainer.getId());\n+            AsyncDocumentClient asyncDocumentClient = client.asyncClient().getContextClient();\n+            GlobalAddressResolver addressResolver = (GlobalAddressResolver) FieldUtils.readField(asyncDocumentClient,\n+                \"addressResolver\", true);\n+\n+            @SuppressWarnings(\"rawtypes\")\n+            Map addressCacheByEndpoint = (Map) FieldUtils.readField(addressResolver,\n+                \"addressCacheByEndpoint\",\n+                true);\n+            Object endpointCache = addressCacheByEndpoint.values().toArray()[0];\n+            GatewayAddressCache addressCache = (GatewayAddressCache) FieldUtils.readField(endpointCache, \"addressCache\", true);\n+\n+            HttpClient httpClient = httpClient(true);\n+            FieldUtils.writeField(addressCache, \"httpClient\", httpClient, true);\n+            new Thread(() -> {\n+                try {\n+                    Thread.sleep(5000);\n+                    HttpClient httpClient1 = httpClient(false);\n+                    FieldUtils.writeField(addressCache, \"httpClient\", httpClient1, true);\n+                } catch (Exception e) {\n+                    fail(e.getMessage());\n+                }\n+            }).start();\n+            PartitionKey partitionKey = new PartitionKey(internalObjectNode.get(\"mypk\"));\n+            CosmosItemResponse<InternalObjectNode> readResourceResponse =\n+                container.readItem(internalObjectNode.getId(), partitionKey, new CosmosItemRequestOptions(),\n+                    InternalObjectNode.class);\n+\n+            //Partial success address resolution client side statistics\n+            assertThat(readResourceResponse.getDiagnostics().toString()).contains(\"addressResolutionStatistics\");\n+            assertThat(readResourceResponse.getDiagnostics().toString()).contains(\"\\\"inflightRequest\\\":false\");\n+            assertThat(readResourceResponse.getDiagnostics().toString()).doesNotContain(\"endTime=\\\"null\\\"\");\n+            assertThat(readResourceResponse.getDiagnostics().toString()).contains(\"\\\"errorMessage\\\":null\");\n+            assertThat(readResourceResponse.getDiagnostics().toString()).contains(\"\\\"errorMessage\\\":\\\"io.netty\" +\n+                \".channel.AbstractChannel$AnnotatedConnectException: Connection refused: no further information\");\n+        } catch (Exception ex) {\n+            fail(\"This test should not throw exception\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79a5a97d35ff631ca7be32a220943948a8073971"}, "originalPosition": 114}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1020, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}