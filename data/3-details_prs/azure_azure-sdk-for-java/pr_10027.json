{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNTgyMTE3", "number": 10027, "title": "Update HttpResponse Default getBodyAsString Charset", "bodyText": "Fixes #8710 #9982\nThis PR updates how the Netty and JDK HttpClients handle encoding the byte stream to a String when a Charset isn't passed. The logic change is the following:\n\nCheck the byte stream for a byte order mark (BOM). If a BOM exists use the specified encoding and strip those leading bytes from the returned string.\nCheck for a Content-Encoding response header. If a Content-Encoding header is set use that encoding.\nDefault to using UTF-8.\n\nThe OkHttp HttpClient didn't need to be updated as OkHttp handles this when getting the body as String.", "createdAt": "2020-04-09T18:37:27Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10027", "merged": true, "mergeCommit": {"oid": "40d0ada013685ad50229c93d6f7edddee4c1c88a"}, "closed": true, "closedAt": "2020-04-10T22:58:22Z", "author": {"login": "alzimmermsft"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWA3VDgH2gAyNDAxNTgyMTE3Ojk4YTNiODg4OWEyYjNjMjI2NTU1ZmY4Njk4N2IzNjg0MTg2MDZlYjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWUJ-ogH2gAyNDAxNTgyMTE3OjQ3MjhkZDI0ZTYzZDQ4MTEyYzg3OGRmMGY2MjJlYTMwNDMxZjdhM2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "98a3b8889a2b3c226555ff86987b368418606eb2", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/98a3b8889a2b3c226555ff86987b368418606eb2", "committedDate": "2020-04-09T18:32:51Z", "message": "Updates the Netty and JDK client HttpResponses to respect response information when deciding the default String charset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDQ1MTI3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10027#pullrequestreview-391045127", "createdAt": "2020-04-09T18:47:16Z", "commit": {"oid": "98a3b8889a2b3c226555ff86987b368418606eb2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODo0NzoxNlrOGDlFxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODo0NzoxNlrOGDlFxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwNjU5Nw==", "bodyText": "Do we need this BOM stripping on already stripped-and-decoded string anymore?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10027#discussion_r406406597", "createdAt": "2020-04-09T18:47:16Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/serializer/JacksonAdapter.java", "diffHunk": "@@ -66,7 +65,7 @@\n      * BOM header from some response bodies. To be removed in deserialization.\n      */\n     private static final String BOM = \"\\uFEFF\";\n-    private static final String BOM_STRING = new String(BOM.getBytes(StandardCharsets.UTF_8), Charset.defaultCharset());\n+    private static final String BOM_STRING = new String(BOM.getBytes(StandardCharsets.UTF_8), StandardCharsets.UTF_8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98a3b8889a2b3c226555ff86987b368418606eb2"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDQ5MjIy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10027#pullrequestreview-391049222", "createdAt": "2020-04-09T18:53:25Z", "commit": {"oid": "98a3b8889a2b3c226555ff86987b368418606eb2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODo1MzoyNVrOGDlS3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODo1MzoyNVrOGDlS3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQwOTk1MQ==", "bodyText": "Any reason why we look for only these 3 charsets and not others? Adding a comment here to explain that would be good.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10027#discussion_r406409951", "createdAt": "2020-04-09T18:53:25Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-http-jdk-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -216,14 +216,36 @@ public HttpHeaders getHeaders() {\n \n         @Override\n         public Mono<String> getBodyAsString() {\n-            return getBodyAsByteArray()\n-                .map(bytes -> new String(bytes, StandardCharsets.UTF_8));\n+            return getBodyAsByteArray().map(bytes -> {\n+                if (bytes.length >= 3 && bytes[0] == (byte) 239 && bytes[1] == (byte) 187 && bytes[2] == (byte) 191) {\n+                    return new String(bytes, 3, bytes.length - 3, StandardCharsets.UTF_8);\n+                } else if (bytes.length >= 2 && bytes[0] == (byte) 254 && bytes[1] == (byte) 255) {\n+                    return new String(bytes, 2, bytes.length - 2, StandardCharsets.UTF_16BE);\n+                } else if (bytes.length >= 2 && bytes[0] == (byte) 255 && bytes[1] == (byte) 254) {\n+                    return new String(bytes, 2, bytes.length - 2, StandardCharsets.UTF_16LE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98a3b8889a2b3c226555ff86987b368418606eb2"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52d843cd6e623d0142f75898e38ca8667b08e637", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/52d843cd6e623d0142f75898e38ca8667b08e637", "committedDate": "2020-04-10T00:00:07Z", "message": "Updated to using Content-Type instead of the incorrect Content-Encoding, added tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cbcaaf1e6f91939c5286b784c91bd3d365705b8", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6cbcaaf1e6f91939c5286b784c91bd3d365705b8", "committedDate": "2020-04-10T00:00:11Z", "message": "Merge branch 'master' into AzResponse_UpdateBodyAsStringHandling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMjAzNjk3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10027#pullrequestreview-391203697", "createdAt": "2020-04-10T00:05:32Z", "commit": {"oid": "6cbcaaf1e6f91939c5286b784c91bd3d365705b8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwMDowNTozM1rOGDtPoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwMDowNTozM1rOGDtPoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0MDE5Mw==", "bodyText": "Both JDK client and Netty client have to do the same logic for converting response byte array to string. It would be better to put this in Core utils somewhere to reduce duplication and if there are any fixes or updates to this logic, we don't need to update in two places.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10027#discussion_r406540193", "createdAt": "2020-04-10T00:05:33Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-http-netty/src/main/java/com/azure/core/http/netty/NettyAsyncHttpClient.java", "diffHunk": "@@ -211,9 +214,31 @@ public HttpHeaders getHeaders() {\n \n         @Override\n         public Mono<String> getBodyAsString() {\n-            return bodyIntern().aggregate().asString().doFinally(s -> {\n-                if (!reactorNettyConnection.isDisposed()) {\n-                    reactorNettyConnection.channel().eventLoop().execute(reactorNettyConnection::dispose);\n+            return getBodyAsByteArray().map(bytes -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cbcaaf1e6f91939c5286b784c91bd3d365705b8"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23459946ed5e4f5114e2d3e69bc6b94322dcb266", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/23459946ed5e4f5114e2d3e69bc6b94322dcb266", "committedDate": "2020-04-10T00:51:09Z", "message": "Moved logic into Azure Core"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a5f01bd2176d47f0d35bfbad988337a723fa654", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5a5f01bd2176d47f0d35bfbad988337a723fa654", "committedDate": "2020-04-10T01:00:49Z", "message": "Update HttpClientTests and BufferedHttpResponse"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMjIzNDIz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10027#pullrequestreview-391223423", "createdAt": "2020-04-10T01:25:00Z", "commit": {"oid": "5a5f01bd2176d47f0d35bfbad988337a723fa654"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4728dd24e63d48112c878df0f622ea30431f7a3d", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4728dd24e63d48112c878df0f622ea30431f7a3d", "committedDate": "2020-04-10T17:01:25Z", "message": "Clean linting issue, transition OkHttp to using bomAwareToString"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1126, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}