{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2NDA1NDMw", "number": 14658, "title": "Add 2019 MSI endpoint support to Managed Identity Credential.", "bodyText": "Fixes #13459", "createdAt": "2020-08-31T16:34:35Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14658", "merged": true, "mergeCommit": {"oid": "2ebe799b72b40c9f092eb37063307b584f426a75"}, "closed": true, "closedAt": "2020-09-11T17:53:24Z", "author": {"login": "g2vinay"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdELKJJAH2gAyNDc2NDA1NDMwOmVkZTFhZmM1Zjc5MzAwOWZhODdjMDU5YWIzZWNiODQ1NDJjMDgzZDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH4tyWAH2gAyNDc2NDA1NDMwOmM0NjQ2Y2Y4MmYzZTBjYjNjYjc2N2U5NzYwZTUzMjdkMGIyYTZmMzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ede1afc5f793009fa87c059ab3ecb84542c083d3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ede1afc5f793009fa87c059ab3ecb84542c083d3", "committedDate": "2020-08-31T04:32:58Z", "message": "Add 2019 MSI endpoint support."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd2580c0d1d7854f267d093fdc9e167867721ddc", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bd2580c0d1d7854f267d093fdc9e167867721ddc", "committedDate": "2020-09-02T04:12:42Z", "message": "refactor code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b539e893aa5c6ba778a297a354d64738834f39a1", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b539e893aa5c6ba778a297a354d64738834f39a1", "committedDate": "2020-09-02T16:47:49Z", "message": "Merge remote-tracking branch 'upstream/master' into app_service_version_support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad9bcdb4cfa6aaff4c1e61e4ac26dcd09ec33b1c", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ad9bcdb4cfa6aaff4c1e61e4ac26dcd09ec33b1c", "committedDate": "2020-09-02T18:11:14Z", "message": "update e2e"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMTY5MDUy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14658#pullrequestreview-481169052", "createdAt": "2020-09-02T18:45:30Z", "commit": {"oid": "ad9bcdb4cfa6aaff4c1e61e4ac26dcd09ec33b1c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxODo0NTozMFrOHL9Inw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxODo1MjoyMlrOHL9hzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5ODAxNQ==", "bodyText": "This would be true in Cloud Shell, and AppServiceMsiCredential would fail there. Is Cloud Shell managed identity not supported? It will also be true for Azure Arc, if I remember that design correctly.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14658#discussion_r482298015", "createdAt": "2020-09-02T18:45:30Z", "author": {"login": "chlowell"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/ManagedIdentityCredential.java", "diffHunk": "@@ -35,7 +39,8 @@\n             .identityClientOptions(identityClientOptions)\n             .build();\n         Configuration configuration = Configuration.getGlobalConfiguration().clone();\n-        if (configuration.contains(Configuration.PROPERTY_MSI_ENDPOINT)) {\n+        if (configuration.contains(Configuration.PROPERTY_MSI_ENDPOINT)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad9bcdb4cfa6aaff4c1e61e4ac26dcd09ec33b1c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMwNDQ2Mg==", "bodyText": "It's \"client_id\" in 2019-08-01.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14658#discussion_r482304462", "createdAt": "2020-09-02T18:52:22Z", "author": {"login": "chlowell"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -709,33 +711,54 @@ private HttpPipeline setupPipeline(HttpClient httpClient) {\n     /**\n      * Asynchronously acquire a token from the App Service Managed Service Identity endpoint.\n      *\n-     * @param msiEndpoint the endpoint to acquire token from\n-     * @param msiSecret the secret to acquire token with\n+     * @param identityEndpoint the Identity endpoint to acquire token from\n+     * @param identityHeader the identity header to acquire token with\n+     * @param msiEndpoint the MSI endpoint to acquire token from\n+     * @param msiSecret the msi secret to acquire token with\n      * @param request the details of the token request\n      * @return a Publisher that emits an AccessToken\n      */\n-    public Mono<AccessToken> authenticateToManagedIdentityEndpoint(String msiEndpoint, String msiSecret,\n+    public Mono<AccessToken> authenticateToManagedIdentityEndpoint(String identityEndpoint, String identityHeader,\n+                                                                   String msiEndpoint, String msiSecret,\n                                                                    TokenRequestContext request) {\n         return Mono.fromCallable(() -> {\n+            String endpoint;\n+            String headerValue;\n+            String endpointVersion;\n+\n+            if (identityEndpoint != null) {\n+                endpoint = identityEndpoint;\n+                headerValue = identityHeader;\n+                endpointVersion = IDENTITY_ENDPOINT_VERSION;\n+            } else {\n+                endpoint = msiEndpoint;\n+                headerValue = msiSecret;\n+                endpointVersion = MSI_ENDPOINT_VERSION;\n+            }\n+\n             String resource = ScopeUtil.scopesToResource(request.getScopes());\n             HttpURLConnection connection = null;\n             StringBuilder payload = new StringBuilder();\n \n             payload.append(\"resource=\");\n             payload.append(URLEncoder.encode(resource, \"UTF-8\"));\n             payload.append(\"&api-version=\");\n-            payload.append(URLEncoder.encode(\"2017-09-01\", \"UTF-8\"));\n+            payload.append(URLEncoder.encode(endpointVersion, \"UTF-8\"));\n             if (clientId != null) {\n                 payload.append(\"&clientid=\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad9bcdb4cfa6aaff4c1e61e4ac26dcd09ec33b1c"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMjAzOTA5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14658#pullrequestreview-481203909", "createdAt": "2020-09-02T19:11:15Z", "commit": {"oid": "ad9bcdb4cfa6aaff4c1e61e4ac26dcd09ec33b1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMjUxNjg3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14658#pullrequestreview-481251687", "createdAt": "2020-09-02T19:54:17Z", "commit": {"oid": "ad9bcdb4cfa6aaff4c1e61e4ac26dcd09ec33b1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxOTo1NDoxN1rOHMBunA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxOTo1NDoxN1rOHMBunA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM3MzI3Ng==", "bodyText": "What happens when both identity and msi endpoints are set? Is there a priority order for which endpoint to use? Is it documented somewhere? Also, if both are set, we should validate them both.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14658#discussion_r482373276", "createdAt": "2020-09-02T19:54:17Z", "author": {"login": "srnagar"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/AppServiceMsiCredential.java", "diffHunk": "@@ -30,13 +32,24 @@\n      */\n     AppServiceMsiCredential(String clientId, IdentityClient identityClient) {\n         Configuration configuration = Configuration.getGlobalConfiguration().clone();\n+        this.identityEndpoint = configuration.get(ManagedIdentityCredential.PROPERTY_IDENTITY_ENDPOINT);\n+        this.identityHeader = configuration.get(ManagedIdentityCredential.PROPERTY_IDENTITY_HEADER);\n         this.msiEndpoint = configuration.get(Configuration.PROPERTY_MSI_ENDPOINT);\n         this.msiSecret = configuration.get(Configuration.PROPERTY_MSI_SECRET);\n         this.identityClient = identityClient;\n         this.clientId = clientId;\n-        if (!(msiEndpoint.startsWith(\"https\") || msiEndpoint.startsWith(\"http\"))) {\n+        if (identityEndpoint != null) {\n+            validateEndpointProtocol(this.identityEndpoint, \"Identity\");\n+        } else {\n+            validateEndpointProtocol(this.msiEndpoint, \"MSI\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad9bcdb4cfa6aaff4c1e61e4ac26dcd09ec33b1c"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1643e7d07d43e06c9748be7f6243e493b3e509d4", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1643e7d07d43e06c9748be7f6243e493b3e509d4", "committedDate": "2020-09-03T23:19:46Z", "message": "address feedback."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7cb212c96ce4c1d202d8aca6af9210c2dc90e7e", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e7cb212c96ce4c1d202d8aca6af9210c2dc90e7e", "committedDate": "2020-09-03T23:29:58Z", "message": "update code."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjgwNTY3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14658#pullrequestreview-482280567", "createdAt": "2020-09-04T00:16:15Z", "commit": {"oid": "e7cb212c96ce4c1d202d8aca6af9210c2dc90e7e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwMDoxNjoxNVrOHM7Z-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwMDoxNjoxNVrOHM7Z-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMxODI2NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                          + \"configured in the environment. Atleast one should be configuured\"));\n          \n          \n            \n                                                          + \"configured in the environment. At least one should be configured\"));", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14658#discussion_r483318264", "createdAt": "2020-09-04T00:16:15Z", "author": {"login": "chlowell"}, "path": "sdk/e2e/src/main/java/com/azure/endtoend/identity/WebJobsIdentityTest.java", "diffHunk": "@@ -60,12 +62,18 @@ void run() throws IllegalStateException {\n     }\n \n     private void testMSIEndpointWithSystemAssigned() {\n-        assertConfigPresence(Configuration.PROPERTY_MSI_ENDPOINT,\n-            \"testMSIEndpointWithSystemAssigned - MSIEndpoint not configured in the environment.\");\n+        if (CoreUtils.isNullOrEmpty(CONFIGURATION.get(Configuration.PROPERTY_MSI_ENDPOINT))\n+                && CoreUtils.isNullOrEmpty(CONFIGURATION.get(Configuration.PROPERTY_MSI_SECRET)))  {\n+            throw logger.logExceptionAsError(\n+                new IllegalStateException(\"testMSIEndpointWithUserAssigned - MSIEndpoint and Identity Point not\"\n+                                              + \"configured in the environment. Atleast one should be configuured\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7cb212c96ce4c1d202d8aca6af9210c2dc90e7e"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81fa3315fd276292acd15700416631dc13c31a21", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/81fa3315fd276292acd15700416631dc13c31a21", "committedDate": "2020-09-11T17:17:49Z", "message": "Merge remote-tracking branch 'upstream/master' into app_service_version_support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4646cf82f3e0cb3cb767e9760e5327d0b2a6f37", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c4646cf82f3e0cb3cb767e9760e5327d0b2a6f37", "committedDate": "2020-09-11T17:19:24Z", "message": "update changelog"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4970, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}