{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNDQ2OTU4", "number": 13762, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMTowNTozNlrOEUzrEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNDozOToxOVrOEXPknQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMjUzNTg0OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMTowNTozNlrOG7Ngwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMTowNTozNlrOG7Ngwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0MDU0Ng==", "bodyText": "I'm not sure why this is passed in as a parameter. It seems very specific to a type of algorithm.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r464740546", "createdAt": "2020-08-04T01:05:36Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java", "diffHunk": "@@ -753,7 +753,8 @@ public ServiceBusReceiverAsyncClient buildAsyncClient() {\n          *     queueName()} or {@link #topicName(String) topicName()}, respectively.\n          */\n         public ServiceBusReceiverClient buildClient() {\n-            return new ServiceBusReceiverClient(buildAsyncClient(), retryOptions.getTryTimeout());\n+            return new ServiceBusReceiverClient(buildAsyncClient(), retryOptions.getTryTimeout(),\n+                ServiceBusConstants.SHORT_TIMEOUT_BETWEEN_MESSAGES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec534b106e440e490ea14c97d7339f20f1fd96b9"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMjUzOTkwOnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousMessageSubscriber.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMTowNzo1M1rOG7Ni-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMTowNzo1M1rOG7Ni-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0MTExMg==", "bodyText": "This is not reactive. There are other operations like switch you can use.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r464741112", "createdAt": "2020-08-04T01:07:53Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousMessageSubscriber.java", "diffHunk": "@@ -205,6 +224,22 @@ private Disposable getTimeoutOperation(SynchronousReceiveWork work) {\n             });\n     }\n \n+    /**\n+     * @param work on which short timeout between message timeout thread need to start.\n+     *\n+     * @return {@link Disposable} for the timeout operation.\n+     */\n+    private Disposable getShortTimeoutBetweenMessages(SynchronousReceiveWork work) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec534b106e440e490ea14c97d7339f20f1fd96b9"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTA4NTY2OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMTo0OTozMlrOG9FaRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMTo0OTozMlrOG9FaRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcwNDk2NQ==", "bodyText": "Why not make implement Closeable rather than this private close?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r466704965", "createdAt": "2020-08-06T21:49:32Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "diffHunk": "@@ -153,4 +168,32 @@ void startedProcessing() {\n     boolean isProcessingStarted() {\n         return this.processingStarted;\n     }\n+\n+    private void close() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6953ea4c5b7c9cf8d17f242555ba7e04ae6171fa"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTA4OTEzOnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusConstants.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMTo1MDo0MVrOG9FcZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMTo1MDo0MVrOG9FcZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcwNTUxMQ==", "bodyText": "This doesn't need to be a public constant.  It can just live inside the synchronous work class.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r466705511", "createdAt": "2020-08-06T21:50:41Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusConstants.java", "diffHunk": "@@ -11,6 +11,7 @@\n public class ServiceBusConstants {\n     public static final String AZURE_ACTIVE_DIRECTORY_SCOPE = \"https://servicebus.azure.net/.default\";\n     public static final Duration OPERATION_TIMEOUT = Duration.ofSeconds(60);\n+    public static final Duration SHORT_TIMEOUT_BETWEEN_MESSAGES = Duration.ofMillis(200);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6953ea4c5b7c9cf8d17f242555ba7e04ae6171fa"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTExOTQ5OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMjowMjo1OFrOG9FvEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMjowMjo1OFrOG9FvEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxMDI4OQ==", "bodyText": "This isn't reactive to have to create a new Mono operation everytime a message come in. How about a combination of Flux.swithOnNext(publisher).takeUntil(notCancelled) where a new item is emitted from the publisher if there is a next message? And for each item emitted, delay at an interval. So if the item is emitted, then cancel the emitter.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r466710289", "createdAt": "2020-08-06T22:02:58Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "diffHunk": "@@ -96,8 +104,12 @@ boolean isTerminal() {\n      */\n     void next(ServiceBusReceivedMessageContext message) {\n         try {\n+            if (timeoutBeforeNextMessageOperation != null && !timeoutBeforeNextMessageOperation.isDisposed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6953ea4c5b7c9cf8d17f242555ba7e04ae6171fa"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTEyMTYwOnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/SynchronousMessageSubscriberTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMjowMzo1OVrOG9Fwbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMjowMzo1OVrOG9Fwbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxMDYzOQ==", "bodyText": "When is this used?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r466710639", "createdAt": "2020-08-06T22:03:59Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/SynchronousMessageSubscriberTest.java", "diffHunk": "@@ -24,7 +24,7 @@\n  * Unit test for sync subscriber.\n  */\n public class SynchronousMessageSubscriberTest {\n-\n+    public static final Duration SHORT_TIMEOUT_BETWEEN_MESSAGES = Duration.ofMillis(1000 * 15);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6953ea4c5b7c9cf8d17f242555ba7e04ae6171fa"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTEyMjE0OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverClientIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMjowNDoxNVrOG9Fwxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMjowNDoxNVrOG9Fwxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcxMDcyNw==", "bodyText": "This is commented out.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r466710727", "createdAt": "2020-08-06T22:04:15Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverClientIntegrationTest.java", "diffHunk": "@@ -809,6 +815,7 @@ private void setSenderAndReceiver(MessagingEntityType entityType, int entityInde\n                 .buildClient();\n         } else {\n             this.receiver = getReceiverBuilder(false, entityType, entityIndex, Function.identity(), sharedConnection)\n+                //.prefetchCount(5)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6953ea4c5b7c9cf8d17f242555ba7e04ae6171fa"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxOTA5ODg2OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMzoxNjo1NFrOG9rMUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMzoxNjo1NFrOG9rMUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMyMzk4Ng==", "bodyText": "You don't need any logic to be in here. In the onNext() override, is where you would call emitter.next. And wherever the flux is attached to the Emitter could be the messageReceivedEmitter. MessageReceivedEmitter shouldn't have to exist.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r467323986", "createdAt": "2020-08-07T23:16:54Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "diffHunk": "@@ -43,6 +57,20 @@\n         this.numberToReceive = numberToReceive;\n         this.timeout = timeout;\n         this.emitter = emitter;\n+\n+        nextMessageSubscriber = Flux.switchOnNext(messageReceivedEmitter\n+            .map(messageContext -> {\n+                emitter.next(messageContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76d66898d93d3bf02b48ffede57854bd8e6873f"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzQ2MDkwOnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzo1NDoxMFrOG-PjuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMzo1NDoxMFrOG-PjuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkxOTgwMA==", "bodyText": "TIMEOUT_BETWEEN_MESSAGES is sufficient.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r467919800", "createdAt": "2020-08-10T13:54:10Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "diffHunk": "@@ -4,15 +4,22 @@\n package com.azure.messaging.servicebus;\n \n import com.azure.core.util.logging.ClientLogger;\n+import reactor.core.Disposable;\n+import reactor.core.publisher.DirectProcessor;\n+import reactor.core.publisher.EmitterProcessor;\n+import reactor.core.publisher.Flux;\n import reactor.core.publisher.FluxSink;\n+import reactor.core.publisher.Mono;\n \n import java.time.Duration;\n import java.util.concurrent.atomic.AtomicInteger;\n \n /**\n  * Synchronous work for receiving messages.\n  */\n-class SynchronousReceiveWork {\n+class SynchronousReceiveWork implements AutoCloseable{\n+    private static final Duration SHORT_TIMEOUT_BETWEEN_MESSAGES = Duration.ofMillis(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47395a170520686966bbe0ea5fd905af017c193e"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyODA2OTE1OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNDozNzoxMVrOG-7ARA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNDozNzoxMVrOG-7ARA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYzMTYyMA==", "bodyText": "When it leaves the scope of the method, doesn't this get collected?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r468631620", "createdAt": "2020-08-11T14:37:11Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "diffHunk": "@@ -43,6 +54,18 @@\n         this.numberToReceive = numberToReceive;\n         this.timeout = timeout;\n         this.emitter = emitter;\n+\n+        DirectProcessor<ServiceBusReceivedMessageContext> emitterProcessor = DirectProcessor.create();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f766b5f66e9069aa925842b672a9ea3b80d7590"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyODA3NDkyOnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNDozODozMlrOG-7ELg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNDozODozMlrOG-7ELg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYzMjYyMg==", "bodyText": "is the null check necessary? Isn't this always set in the constructor. You can just call dispose.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r468632622", "createdAt": "2020-08-11T14:38:32Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "diffHunk": "@@ -153,4 +180,11 @@ void startedProcessing() {\n     boolean isProcessingStarted() {\n         return this.processingStarted;\n     }\n+\n+    @Override\n+    public void close() {\n+        if (nextMessageSubscriber != null && !nextMessageSubscriber.isDisposed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f766b5f66e9069aa925842b672a9ea3b80d7590"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyODA3ODM3OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNDozOToxOVrOG-7GRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNDozOToxOVrOG-7GRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODYzMzE1Ng==", "bodyText": "TIMEOUT_BETWEEN_MESSAGES is enough.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13762#discussion_r468633156", "createdAt": "2020-08-11T14:39:19Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/SynchronousReceiveWork.java", "diffHunk": "@@ -12,13 +15,21 @@\n /**\n  * Synchronous work for receiving messages.\n  */\n-class SynchronousReceiveWork {\n+class SynchronousReceiveWork implements AutoCloseable {\n+\n+    /* When we have received at-least one message and next message does not arrive in this time. The work will\n+    complete.*/\n+    private static final Duration SHORT_TIMEOUT_BETWEEN_MESSAGES = Duration.ofMillis(1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f766b5f66e9069aa925842b672a9ea3b80d7590"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4734, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}