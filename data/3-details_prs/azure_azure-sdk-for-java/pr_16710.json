{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NjE1Mjc5", "number": 16710, "title": "API ServiceBusErrorSource to  represent source of error", "bodyText": "Introduce ServiceBusErrorSource, to help user identify source of the error. Specially in error handler in processor model.\n/**\n\nRepresent the scenario in which user was when the error happened.\n*/\npublic enum ServiceBusErrorSource {\nSEND,\nRECEIVE,\nAPPEND,\nCOMPLETE,\nDEFER,\nDEAD_LETTER,\nPEEK;\n}\n\nAlso removing unwanted opens statements from module info as they are not needed.", "createdAt": "2020-10-22T23:44:42Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710", "merged": true, "mergeCommit": {"oid": "249ecc1fcc57b22d4e7a49108fdc58be05f29c5f"}, "closed": true, "closedAt": "2020-10-30T16:07:23Z", "author": {"login": "hemanttanwar"}, "timelineItems": {"totalCount": 50, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVGKNzAH2gAyNTA4NjE1Mjc5OmIwYzg1NjI1NDRlM2I4MGNiNmFhZDkyMDk4Zjc2YjM0NTk3MjE2NWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXjmlfgH2gAyNTA4NjE1Mjc5OjBhNmZlYTljNzFmMTJiNGU4OTU0MjEzM2NhZWNhNzlmNWU2NjRhOTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b0c8562544e3b80cb6aad92098f76b345972165c", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b0c8562544e3b80cb6aad92098f76b345972165c", "committedDate": "2020-10-22T18:20:14Z", "message": "Designing ErrorSource options"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9a83efe1d9d9b84205979e5374738782c2d2a0c", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b9a83efe1d9d9b84205979e5374738782c2d2a0c", "committedDate": "2020-10-22T18:21:12Z", "message": "Merge branch 'master' into sb-t2-errorsource-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aba06d0aa48166f4dad6d6a5852308d1fc5782eb", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/aba06d0aa48166f4dad6d6a5852308d1fc5782eb", "committedDate": "2020-10-22T23:40:36Z", "message": "Error source structure."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MDUzNTc2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-516053576", "createdAt": "2020-10-23T23:07:23Z", "commit": {"oid": "aba06d0aa48166f4dad6d6a5852308d1fc5782eb"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMzowNzoyM1rOHngp4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMzowNzo1NVrOHngqXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MTUyMw==", "bodyText": "Why do need this?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r511191523", "createdAt": "2020-10-23T23:07:23Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceivedMessageContext.java", "diffHunk": "@@ -53,6 +79,27 @@ public Throwable getThrowable() {\n         return error;\n     }\n \n+    /**\n+     * Gets the {@link ServiceBusErrorSource} of the error where it occurred.\n+     *\n+     * @return The {@link ServiceBusErrorSource} of the error or message.\n+     */\n+    public ServiceBusErrorSource getErrorSource() {\n+        return errorSource;\n+    }\n+\n+    /**\n+     * Gets the {@link ServiceBusErrorSource} of the error where it occurred.\n+     *\n+     * @param errorSource {@link ServiceBusErrorSource} where error occurred.\n+     *\n+     * @return The updated {@link ServiceBusReceivedMessageContext} of the error.\n+     */\n+    ServiceBusReceivedMessageContext setErrorSource(ServiceBusErrorSource errorSource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aba06d0aa48166f4dad6d6a5852308d1fc5782eb"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MTU1NQ==", "bodyText": "Why do need this?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r511191555", "createdAt": "2020-10-23T23:07:31Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceivedMessageContext.java", "diffHunk": "@@ -35,6 +36,31 @@\n         this.message = null;\n     }\n \n+    /**\n+     * Creates an instance where an error occurred such as session-lock-lost.\n+     *\n+     * @param sessionId Session id that the error occurred in.\n+     * @param error AMQP exception that occurred in session.\n+     * @param errorSource the source of the error.\n+     */\n+    ServiceBusReceivedMessageContext(String sessionId, Throwable error, ServiceBusErrorSource errorSource) {\n+        this(sessionId,error);\n+        this.errorSource = Objects.requireNonNull(errorSource, \"'errorSource' cannot be null.\");\n+    }\n+\n+    /**\n+     * Creates an instance where an error occurred such as session-lock-lost.\n+     *\n+     * @param error AMQP exception that occurred in session.\n+     * @param errorSource the source of the error.\n+     */\n+    ServiceBusReceivedMessageContext(Throwable error, ServiceBusErrorSource errorSource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aba06d0aa48166f4dad6d6a5852308d1fc5782eb"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MTY0Ng==", "bodyText": "We can just use the maximal overload because this is internal.\nAlso, optional arguments should be at the end, like sessionId.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r511191646", "createdAt": "2020-10-23T23:07:55Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceivedMessageContext.java", "diffHunk": "@@ -35,6 +36,31 @@\n         this.message = null;\n     }\n \n+    /**\n+     * Creates an instance where an error occurred such as session-lock-lost.\n+     *\n+     * @param sessionId Session id that the error occurred in.\n+     * @param error AMQP exception that occurred in session.\n+     * @param errorSource the source of the error.\n+     */\n+    ServiceBusReceivedMessageContext(String sessionId, Throwable error, ServiceBusErrorSource errorSource) {\n+        this(sessionId,error);\n+        this.errorSource = Objects.requireNonNull(errorSource, \"'errorSource' cannot be null.\");\n+    }\n+\n+    /**\n+     * Creates an instance where an error occurred such as session-lock-lost.\n+     *\n+     * @param error AMQP exception that occurred in session.\n+     * @param errorSource the source of the error.\n+     */\n+    ServiceBusReceivedMessageContext(Throwable error, ServiceBusErrorSource errorSource) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MTU1NQ=="}, "originalCommit": {"oid": "aba06d0aa48166f4dad6d6a5852308d1fc5782eb"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28fea7b588c690eeecd97f064f2f64aa426136ed", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/28fea7b588c690eeecd97f064f2f64aa426136ed", "committedDate": "2020-10-26T22:53:28Z", "message": "Adding error handling for Error source"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d01190a50674acfb431452c33ad261596a6e538b", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d01190a50674acfb431452c33ad261596a6e538b", "committedDate": "2020-10-26T22:56:19Z", "message": "Adding error handling for Error source"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ec13b505ab58db7d139949e3bc5ff70f1a0b4cc", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1ec13b505ab58db7d139949e3bc5ff70f1a0b4cc", "committedDate": "2020-10-26T23:01:03Z", "message": "Adding error handling for Error source"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd05bfe86aa5b0fef94ce357325eebff4c0905d6", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bd05bfe86aa5b0fef94ce357325eebff4c0905d6", "committedDate": "2020-10-26T23:02:17Z", "message": "Removed error source from SBM context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ce0cb37c6fab0872c2e6ed321ab21fff197a4b3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3ce0cb37c6fab0872c2e6ed321ab21fff197a4b3", "committedDate": "2020-10-26T23:04:42Z", "message": "Removed unwanted changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36106a31aec946eaab35f7dbd5121f920e4131b9", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/36106a31aec946eaab35f7dbd5121f920e4131b9", "committedDate": "2020-10-27T08:08:10Z", "message": "Added  test case for sending and receiving the messages."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d498aed3217a1a534419cfd998c4e91eabab985", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1d498aed3217a1a534419cfd998c4e91eabab985", "committedDate": "2020-10-27T08:20:06Z", "message": "merge master into branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46f7d2c27d235a47982b3e93367f05fea7788bca", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/46f7d2c27d235a47982b3e93367f05fea7788bca", "committedDate": "2020-10-27T08:24:38Z", "message": "Added java doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8d7e1fec2179577cf39f133b3a451dbe1a5e05a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e8d7e1fec2179577cf39f133b3a451dbe1a5e05a", "committedDate": "2020-10-27T18:08:21Z", "message": "updated module info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbc6f554059c8434a6ef29b40e6986a9d729d08c", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/cbc6f554059c8434a6ef29b40e6986a9d729d08c", "committedDate": "2020-10-27T18:15:10Z", "message": "updated code to pass error source in updateDisposition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDE2Mzcx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-518016371", "createdAt": "2020-10-27T18:24:57Z", "commit": {"oid": "cbc6f554059c8434a6ef29b40e6986a9d729d08c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODoyNDo1OFrOHpKzKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODoyNDo1OFrOHpKzKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzMDYwMQ==", "bodyText": "Needed for test ServiceBusManagementSerializerTest.deserializeNamespace\naccessible: module com.azure.messaging.servicebus does not \"exports com.azure.messaging.servicebus.implementation.models\" to module com.fasterxml.jackson.databind", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r512930601", "createdAt": "2020-10-27T18:24:58Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/module-info.java", "diffHunk": "@@ -9,12 +9,8 @@\n     exports com.azure.messaging.servicebus.administration.models;\n     exports com.azure.messaging.servicebus.models;\n \n-    opens com.azure.messaging.servicebus;\n-    opens com.azure.messaging.servicebus.administration;\n-    opens com.azure.messaging.servicebus.administration.models;\n-    opens com.azure.messaging.servicebus.implementation;\n-    opens com.azure.messaging.servicebus.implementation.models;\n-    opens com.azure.messaging.servicebus.models;\n+    opens com.azure.messaging.servicebus.administration.models to com.fasterxml.jackson.databind;\n+    opens com.azure.messaging.servicebus.implementation.models to com.fasterxml.jackson.databind;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbc6f554059c8434a6ef29b40e6986a9d729d08c"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32aae8d553d40351497524d332e28674d7176787", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/32aae8d553d40351497524d332e28674d7176787", "committedDate": "2020-10-27T19:14:53Z", "message": "module info changes will be in separate PR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MjAwNDA5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-518200409", "createdAt": "2020-10-27T22:32:15Z", "commit": {"oid": "32aae8d553d40351497524d332e28674d7176787"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjozMjoxNVrOHpTcRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjozMjoxNVrOHpTcRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3MjE5Nw==", "bodyText": "Why do we need the error source parameter? It can be inferred from the Disposition status.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r513072197", "createdAt": "2020-10-27T22:32:15Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1008,8 +1015,21 @@ private boolean isManagementToken(String lockToken) {\n \n     private Mono<Void> updateDisposition(ServiceBusReceivedMessage message, DispositionStatus dispositionStatus,\n         String deadLetterReason, String deadLetterErrorDescription, Map<String, Object> propertiesToModify,\n-        ServiceBusTransactionContext transactionContext) {\n+        ServiceBusTransactionContext transactionContext, ServiceBusErrorSource errorSource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32aae8d553d40351497524d332e28674d7176787"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MjAwNjQ3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-518200647", "createdAt": "2020-10-27T22:32:44Z", "commit": {"oid": "32aae8d553d40351497524d332e28674d7176787"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjozMjo0NFrOHpTdDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjozMjo0NFrOHpTdDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3MjM5Nw==", "bodyText": "I don't understand why we created a function here. The method itself is already private.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r513072397", "createdAt": "2020-10-27T22:32:44Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1008,8 +1015,21 @@ private boolean isManagementToken(String lockToken) {\n \n     private Mono<Void> updateDisposition(ServiceBusReceivedMessage message, DispositionStatus dispositionStatus,\n         String deadLetterReason, String deadLetterErrorDescription, Map<String, Object> propertiesToModify,\n-        ServiceBusTransactionContext transactionContext) {\n+        ServiceBusTransactionContext transactionContext, ServiceBusErrorSource errorSource) {\n+        return updateDispositionInternal(message, dispositionStatus, deadLetterReason, deadLetterErrorDescription,\n+            propertiesToModify, transactionContext)\n+            .onErrorMap(throwable -> {\n+                if (throwable instanceof AmqpException) {\n+                    return new ServiceBusException((AmqpException) throwable, errorSource);\n+                }\n+                return throwable;\n \n+            });\n+    }\n+\n+    private Mono<Void> updateDispositionInternal(ServiceBusReceivedMessage message, DispositionStatus dispositionStatus,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32aae8d553d40351497524d332e28674d7176787"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MjAxMTI4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-518201128", "createdAt": "2020-10-27T22:33:45Z", "commit": {"oid": "32aae8d553d40351497524d332e28674d7176787"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjozMzo0NVrOHpTebQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjozMzo0NVrOHpTebQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3Mjc0OQ==", "bodyText": "This mapping logic is in many places. It would be better to have a static method that this calls into which maps a throwable into the corresponding ServiceBusErrorSource.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r513072749", "createdAt": "2020-10-27T22:33:45Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java", "diffHunk": "@@ -503,6 +503,12 @@ public void close() {\n         return createMessageBatch().flatMap(messageBatch -> {\n             messages.forEach(message -> messageBatch.tryAddMessage(message));\n             return sendInternal(messageBatch, transaction);\n+        }).onErrorMap(throwable -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32aae8d553d40351497524d332e28674d7176787"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e34a23e9c5eec22e288cacaef784e7d3bb88d7c0", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e34a23e9c5eec22e288cacaef784e7d3bb88d7c0", "committedDate": "2020-10-28T08:22:19Z", "message": "Updated based on review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDEzNjIy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-519013622", "createdAt": "2020-10-28T19:28:13Z", "commit": {"oid": "e34a23e9c5eec22e288cacaef784e7d3bb88d7c0"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOToyODoxM1rOHp6I7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTo0MDo0MlrOHp6jMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcwNjIyMw==", "bodyText": "Are we using this exception for the sender client too?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r513706223", "createdAt": "2020-10-28T19:28:13Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusErrorSource.java", "diffHunk": "@@ -0,0 +1,27 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus;\n+\n+/**\n+ * Represent the operation user was performing when the error happened.\n+ */\n+public enum ServiceBusErrorSource {\n+    /** Error while sending the message(s).*/\n+    SEND,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34a23e9c5eec22e288cacaef784e7d3bb88d7c0"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcwNzMxMw==", "bodyText": "We need an enum for user code. Also, this must be ExpandableStringEnum so that we can add more sources later.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r513707313", "createdAt": "2020-10-28T19:30:11Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusErrorSource.java", "diffHunk": "@@ -0,0 +1,27 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus;\n+\n+/**\n+ * Represent the operation user was performing when the error happened.\n+ */\n+public enum ServiceBusErrorSource {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34a23e9c5eec22e288cacaef784e7d3bb88d7c0"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcwODIxMQ==", "bodyText": "There's an administration aspect to SB as well and we will want to differentiate between an exception coming from the HTTP admin client vs the exception coming from AMQP. So, we should consider naming this exception accordingly.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r513708211", "createdAt": "2020-10-28T19:31:49Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusException.java", "diffHunk": "@@ -0,0 +1,35 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus;\n+\n+import com.azure.core.amqp.exception.AmqpException;\n+\n+/**\n+ * Defines {@link ServiceBusException} which has addition properties. You can {@link ServiceBusErrorSource} to\n+ * determine source of error.\n+ *\n+ * @see ServiceBusErrorSource\n+ */\n+public class ServiceBusException extends AmqpException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34a23e9c5eec22e288cacaef784e7d3bb88d7c0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxMjk0NA==", "bodyText": "Don't need to throw another exception here. If the dispositionStatus is unknown, we should just mark that as unknown and use that as the source.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r513712944", "createdAt": "2020-10-28T19:40:42Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1060,20 +1068,49 @@ private boolean isManagementToken(String lockToken) {\n                     logger.info(\"Could not perform on session manger. Performing on management node.\");\n                     return performOnManagement;\n                 });\n-        }\n-\n-        final ServiceBusAsyncConsumer existingConsumer = consumer.get();\n-        if (isManagementToken(lockToken) || existingConsumer == null) {\n-            return performOnManagement;\n         } else {\n-            return existingConsumer.updateDisposition(lockToken, dispositionStatus, deadLetterReason,\n-                deadLetterErrorDescription, propertiesToModify, transactionContext)\n-                .then(Mono.fromRunnable(() -> {\n-                    logger.info(\"{}: Update completed. Disposition: {}. Lock: {}.\",\n-                        entityPath, dispositionStatus, lockToken);\n-                    renewalContainer.remove(lockToken);\n-                }));\n+            final ServiceBusAsyncConsumer existingConsumer = consumer.get();\n+            if (isManagementToken(lockToken) || existingConsumer == null) {\n+                updateDispositionOperation = performOnManagement;\n+            } else {\n+                updateDispositionOperation = existingConsumer.updateDisposition(lockToken, dispositionStatus,\n+                    deadLetterReason, deadLetterErrorDescription, propertiesToModify, transactionContext)\n+                    .then(Mono.fromRunnable(() -> {\n+                        logger.info(\"{}: Update completed. Disposition: {}. Lock: {}.\",\n+                            entityPath, dispositionStatus, lockToken);\n+                        renewalContainer.remove(lockToken);\n+                    }));\n+            }\n         }\n+        return updateDispositionOperation\n+            .onErrorMap(throwable -> {\n+                ServiceBusErrorSource errorSource;\n+                if (throwable instanceof AmqpException) {\n+                    switch (dispositionStatus) {\n+                        case COMPLETED:\n+                            errorSource = ServiceBusErrorSource.COMPLETE;\n+                            break;\n+                        case DEFERRED:\n+                            errorSource = ServiceBusErrorSource.DEFER;\n+                            break;\n+                        case SUSPENDED:\n+                            errorSource = ServiceBusErrorSource.DEAD_LETTER;\n+                            break;\n+                        case ABANDONED:\n+                            errorSource = ServiceBusErrorSource.ABANDONED;\n+                            break;\n+                        default:\n+                            throw logger.logExceptionAsError(new UnsupportedOperationException(String.format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34a23e9c5eec22e288cacaef784e7d3bb88d7c0"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9cd7c0afedb77ca11208e7dcc5248f9f2241ff4", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d9cd7c0afedb77ca11208e7dcc5248f9f2241ff4", "committedDate": "2020-10-28T22:05:25Z", "message": "changes based on review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fce6f5561b3a457173ad95f513a8301e1a031925", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/fce6f5561b3a457173ad95f513a8301e1a031925", "committedDate": "2020-10-28T22:18:05Z", "message": "changes based on review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f84f896eeb164cc8ffd11107995cf80fc2efb16d", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f84f896eeb164cc8ffd11107995cf80fc2efb16d", "committedDate": "2020-10-28T22:29:03Z", "message": "changes based on review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d004d8c6dafe3284970d87f3f870c9cca2f5774", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2d004d8c6dafe3284970d87f3f870c9cca2f5774", "committedDate": "2020-10-28T22:55:07Z", "message": "Removed Error source from Sender as  dotnet is also not doing it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a52a8d0121a82903c8192ba08b719bedaccc8ca", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5a52a8d0121a82903c8192ba08b719bedaccc8ca", "committedDate": "2020-10-28T22:55:33Z", "message": "Removed Error source from Sender as  dotnet is also not doing it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "578a0dde08dc04112e3a0bc39c5b560d86584f89", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/578a0dde08dc04112e3a0bc39c5b560d86584f89", "committedDate": "2020-10-28T23:12:04Z", "message": "added error source for renew lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eda86d168b8b7ffa854e7fd69413b8d5e8fa6381", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/eda86d168b8b7ffa854e7fd69413b8d5e8fa6381", "committedDate": "2020-10-28T23:12:59Z", "message": "added error source for renew lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d24f339da759943673c96c4e77e9e9d05ef02013", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d24f339da759943673c96c4e77e9e9d05ef02013", "committedDate": "2020-10-28T23:18:37Z", "message": "added error source for renew lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e3b5d8a95227bf23c24779efc79109c010aad70", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6e3b5d8a95227bf23c24779efc79109c010aad70", "committedDate": "2020-10-28T23:21:15Z", "message": "added docs for unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c90eb0ecff9e073f1fec4a1490728e425f4c1338", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c90eb0ecff9e073f1fec4a1490728e425f4c1338", "committedDate": "2020-10-29T01:27:14Z", "message": "Renamed Exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3286f4c4a0a5e407c36e08e71285e536bbe45ee1", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3286f4c4a0a5e407c36e08e71285e536bbe45ee1", "committedDate": "2020-10-29T02:03:29Z", "message": "Renamed Exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MzcyNjE3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-519372617", "createdAt": "2020-10-29T06:45:55Z", "commit": {"oid": "3286f4c4a0a5e407c36e08e71285e536bbe45ee1"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNjo0NTo1NVrOHqN1wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNjo1NjoyM1rOHqOM6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyODk5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Defines {@link ServiceBusAmqpException} which has addition properties. You can {@link ServiceBusErrorSource} to\n          \n          \n            \n             * Defines {@link ServiceBusAmqpException} which has additional information about the operation that caused the error.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514028993", "createdAt": "2020-10-29T06:45:55Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusAmqpException.java", "diffHunk": "@@ -0,0 +1,35 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus;\n+\n+import com.azure.core.amqp.exception.AmqpException;\n+\n+/**\n+ * Defines {@link ServiceBusAmqpException} which has addition properties. You can {@link ServiceBusErrorSource} to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3286f4c4a0a5e407c36e08e71285e536bbe45ee1"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAyOTk0Mg==", "bodyText": "Some of the operations may not be performed by the user. For e.g autocomplete, autorenew or even abandoning a message.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514029942", "createdAt": "2020-10-29T06:47:15Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusErrorSource.java", "diffHunk": "@@ -0,0 +1,42 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus;\n+\n+import com.azure.core.util.ExpandableStringEnum;\n+\n+import java.io.Serializable;\n+\n+/**\n+ * Represent the operation user was performing when the error happened.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3286f4c4a0a5e407c36e08e71285e536bbe45ee1"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAzMDUwMA==", "bodyText": "ServiceBusAmqpException", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514030500", "createdAt": "2020-10-29T06:48:09Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1136,4 +1172,15 @@ private String getLinkName(String sessionId) {\n             return existing != null ? existing.getLinkName() : null;\n         }\n     }\n+\n+    /**\n+     * Map the error to ServiceBusException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3286f4c4a0a5e407c36e08e71285e536bbe45ee1"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAzMDc1Nw==", "bodyText": "Make this final", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514030757", "createdAt": "2020-10-29T06:48:41Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusAmqpException.java", "diffHunk": "@@ -0,0 +1,35 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus;\n+\n+import com.azure.core.amqp.exception.AmqpException;\n+\n+/**\n+ * Defines {@link ServiceBusAmqpException} which has addition properties. You can {@link ServiceBusErrorSource} to\n+ * determine source of error.\n+ *\n+ * @see ServiceBusErrorSource\n+ */\n+public class ServiceBusAmqpException extends AmqpException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3286f4c4a0a5e407c36e08e71285e536bbe45ee1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAzMjgxOA==", "bodyText": "We'll need error sources for session-related operations too.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514032818", "createdAt": "2020-10-29T06:52:31Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusErrorSource.java", "diffHunk": "@@ -0,0 +1,42 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus;\n+\n+import com.azure.core.util.ExpandableStringEnum;\n+\n+import java.io.Serializable;\n+\n+/**\n+ * Represent the operation user was performing when the error happened.\n+ */\n+public final class ServiceBusErrorSource extends ExpandableStringEnum<ServiceBusErrorSource> implements Serializable {\n+\n+    private static final long serialVersionUID = -2819764417333954922L;\n+\n+    /** Error while abandoning the message.*/\n+    public static final ServiceBusErrorSource ABANDONED = fromString(\"ABANDONED\", ServiceBusErrorSource.class);\n+\n+    /** Error while completing the message.*/\n+    public static final ServiceBusErrorSource COMPLETE = fromString(\"COMPLETE\", ServiceBusErrorSource.class);\n+\n+    /** Error while deferring the message.*/\n+    public static final ServiceBusErrorSource DEFER = fromString(\"DEFER\", ServiceBusErrorSource.class);\n+\n+    /** Error while dead-lettering the message.*/\n+    public static final ServiceBusErrorSource DEAD_LETTER = fromString(\"DEAD_LETTER\",\n+        ServiceBusErrorSource.class);\n+\n+    /** Error while receiving the message(s).*/\n+    public static final ServiceBusErrorSource RECEIVE = fromString(\"RECEIVE\", ServiceBusErrorSource.class);\n+\n+    /** Error while renewing lock.*/\n+    public static final ServiceBusErrorSource RENEW_LOCK = fromString(\"RENEW_LOCK\", ServiceBusErrorSource.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3286f4c4a0a5e407c36e08e71285e536bbe45ee1"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAzNDYyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final String lockToken1 = UUID.randomUUID().toString();\n          \n          \n            \n                    final String lockToken = UUID.randomUUID().toString();", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514034626", "createdAt": "2020-10-29T06:55:47Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientTest.java", "diffHunk": "@@ -443,6 +448,135 @@ void deadLetterWithDescription() {\n         verify(amqpReceiveLink).updateDisposition(eq(lockToken1), isA(Rejected.class));\n     }\n \n+    /**\n+     * Verifies that error source is populated when any error happened while renewing lock.\n+     */\n+    @Test\n+    void errorSourceOnRenewMessageLock() {\n+        // Arrange\n+        final Duration maxDuration = Duration.ofSeconds(8);\n+        final String lockToken = \"some-token\";\n+\n+        when(receivedMessage.getLockToken()).thenReturn(lockToken);\n+        when(managementNode.renewMessageLock(lockToken, null))\n+            .thenReturn(Mono.error(new AmqpException(false, \"some error occurred.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(receiver.renewMessageLock(receivedMessage, maxDuration))\n+            .verifyErrorMatches(throwable -> {\n+                Assertions.assertTrue(throwable instanceof ServiceBusAmqpException);\n+                final ServiceBusErrorSource actual = ((ServiceBusAmqpException) throwable).getErrorSource();\n+                Assertions.assertEquals(ServiceBusErrorSource.RENEW_LOCK, actual);\n+                return true;\n+            });\n+\n+        verify(managementNode, times(1)).renewMessageLock(lockToken, null);\n+    }\n+\n+    /**\n+     * Verifies that error source is populated when any error happened while renewing lock.\n+     */\n+    @Test\n+    void errorSourceOnSessionLock() {\n+        // Arrange\n+        when(managementNode.renewSessionLock(SESSION_ID, null)).thenReturn(Mono.error(new AmqpException(false, \"some error occurred.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(sessionReceiver.renewSessionLock(SESSION_ID))\n+            .verifyErrorMatches(throwable -> {\n+                Assertions.assertTrue(throwable instanceof ServiceBusAmqpException);\n+                final ServiceBusErrorSource actual = ((ServiceBusAmqpException) throwable).getErrorSource();\n+                Assertions.assertEquals(ServiceBusErrorSource.RENEW_LOCK, actual);\n+                return true;\n+            });\n+    }\n+\n+    /**\n+     * Verifies that error source is populated when there is any error during message settlement.\n+     */\n+    @ParameterizedTest\n+    @MethodSource\n+    void errorSourceOnSettlement(DispositionStatus dispositionStatus, ServiceBusErrorSource expectedErrorSource,\n+        DeliveryStateType expectedDeliveryState) {\n+        final String lockToken1 = UUID.randomUUID().toString();\n+\n+        final OffsetDateTime expiration = OffsetDateTime.now().plus(Duration.ofMinutes(5));\n+\n+        final MessageWithLockToken message = mock(MessageWithLockToken.class);\n+\n+        when(messageSerializer.deserialize(message, ServiceBusReceivedMessage.class)).thenReturn(receivedMessage);\n+\n+        when(receivedMessage.getLockToken()).thenReturn(lockToken1);\n+        when(receivedMessage.getLockedUntil()).thenReturn(expiration);\n+\n+        when(amqpReceiveLink.updateDisposition(eq(lockToken1), argThat(e -> e.getType() == expectedDeliveryState)))\n+            .thenReturn(Mono.error(new AmqpException(false, \"some error occurred.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(receiver.receiveMessages().take(1)\n+            .flatMap(context -> {\n+                final Mono<Void> operation;\n+                switch (dispositionStatus) {\n+                    case DEFERRED:\n+                        operation = receiver.defer(receivedMessage);\n+                        break;\n+                    case ABANDONED:\n+                        operation = receiver.abandon(receivedMessage);\n+                        break;\n+                    case COMPLETED:\n+                        operation = receiver.complete(receivedMessage);\n+                        break;\n+                    case SUSPENDED:\n+                        operation = receiver.deadLetter(receivedMessage);\n+                        break;\n+                    default:\n+                        throw new IllegalArgumentException(\"Unrecognized operation: \" + dispositionStatus);\n+                }\n+                return operation;\n+            }))\n+            .then(() -> messageSink.next(message))\n+            .expectNext()\n+            .verifyErrorMatches(throwable -> {\n+                Assertions.assertTrue(throwable instanceof ServiceBusAmqpException);\n+                final ServiceBusErrorSource actual = ((ServiceBusAmqpException) throwable).getErrorSource();\n+                Assertions.assertEquals(expectedErrorSource, actual);\n+                return true;\n+            });\n+\n+        verify(amqpReceiveLink).updateDisposition(eq(lockToken1), any(DeliveryState.class));\n+    }\n+\n+    /**\n+     * Verifies that error source is populated when there is any error during receiving of message.\n+     */\n+    @Test\n+    void errorSourceOnReceiveMessage() {\n+        final String lockToken1 = UUID.randomUUID().toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3286f4c4a0a5e407c36e08e71285e536bbe45ee1"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDAzNDkyMw==", "bodyText": "Can we also have tests for error source UNKNOWN?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514034923", "createdAt": "2020-10-29T06:56:23Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientTest.java", "diffHunk": "@@ -443,6 +448,135 @@ void deadLetterWithDescription() {\n         verify(amqpReceiveLink).updateDisposition(eq(lockToken1), isA(Rejected.class));\n     }\n \n+    /**\n+     * Verifies that error source is populated when any error happened while renewing lock.\n+     */\n+    @Test\n+    void errorSourceOnRenewMessageLock() {\n+        // Arrange\n+        final Duration maxDuration = Duration.ofSeconds(8);\n+        final String lockToken = \"some-token\";\n+\n+        when(receivedMessage.getLockToken()).thenReturn(lockToken);\n+        when(managementNode.renewMessageLock(lockToken, null))\n+            .thenReturn(Mono.error(new AmqpException(false, \"some error occurred.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(receiver.renewMessageLock(receivedMessage, maxDuration))\n+            .verifyErrorMatches(throwable -> {\n+                Assertions.assertTrue(throwable instanceof ServiceBusAmqpException);\n+                final ServiceBusErrorSource actual = ((ServiceBusAmqpException) throwable).getErrorSource();\n+                Assertions.assertEquals(ServiceBusErrorSource.RENEW_LOCK, actual);\n+                return true;\n+            });\n+\n+        verify(managementNode, times(1)).renewMessageLock(lockToken, null);\n+    }\n+\n+    /**\n+     * Verifies that error source is populated when any error happened while renewing lock.\n+     */\n+    @Test\n+    void errorSourceOnSessionLock() {\n+        // Arrange\n+        when(managementNode.renewSessionLock(SESSION_ID, null)).thenReturn(Mono.error(new AmqpException(false, \"some error occurred.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(sessionReceiver.renewSessionLock(SESSION_ID))\n+            .verifyErrorMatches(throwable -> {\n+                Assertions.assertTrue(throwable instanceof ServiceBusAmqpException);\n+                final ServiceBusErrorSource actual = ((ServiceBusAmqpException) throwable).getErrorSource();\n+                Assertions.assertEquals(ServiceBusErrorSource.RENEW_LOCK, actual);\n+                return true;\n+            });\n+    }\n+\n+    /**\n+     * Verifies that error source is populated when there is any error during message settlement.\n+     */\n+    @ParameterizedTest\n+    @MethodSource\n+    void errorSourceOnSettlement(DispositionStatus dispositionStatus, ServiceBusErrorSource expectedErrorSource,\n+        DeliveryStateType expectedDeliveryState) {\n+        final String lockToken1 = UUID.randomUUID().toString();\n+\n+        final OffsetDateTime expiration = OffsetDateTime.now().plus(Duration.ofMinutes(5));\n+\n+        final MessageWithLockToken message = mock(MessageWithLockToken.class);\n+\n+        when(messageSerializer.deserialize(message, ServiceBusReceivedMessage.class)).thenReturn(receivedMessage);\n+\n+        when(receivedMessage.getLockToken()).thenReturn(lockToken1);\n+        when(receivedMessage.getLockedUntil()).thenReturn(expiration);\n+\n+        when(amqpReceiveLink.updateDisposition(eq(lockToken1), argThat(e -> e.getType() == expectedDeliveryState)))\n+            .thenReturn(Mono.error(new AmqpException(false, \"some error occurred.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(receiver.receiveMessages().take(1)\n+            .flatMap(context -> {\n+                final Mono<Void> operation;\n+                switch (dispositionStatus) {\n+                    case DEFERRED:\n+                        operation = receiver.defer(receivedMessage);\n+                        break;\n+                    case ABANDONED:\n+                        operation = receiver.abandon(receivedMessage);\n+                        break;\n+                    case COMPLETED:\n+                        operation = receiver.complete(receivedMessage);\n+                        break;\n+                    case SUSPENDED:\n+                        operation = receiver.deadLetter(receivedMessage);\n+                        break;\n+                    default:\n+                        throw new IllegalArgumentException(\"Unrecognized operation: \" + dispositionStatus);\n+                }\n+                return operation;\n+            }))\n+            .then(() -> messageSink.next(message))\n+            .expectNext()\n+            .verifyErrorMatches(throwable -> {\n+                Assertions.assertTrue(throwable instanceof ServiceBusAmqpException);\n+                final ServiceBusErrorSource actual = ((ServiceBusAmqpException) throwable).getErrorSource();\n+                Assertions.assertEquals(expectedErrorSource, actual);\n+                return true;\n+            });\n+\n+        verify(amqpReceiveLink).updateDisposition(eq(lockToken1), any(DeliveryState.class));\n+    }\n+\n+    /**\n+     * Verifies that error source is populated when there is any error during receiving of message.\n+     */\n+    @Test\n+    void errorSourceOnReceiveMessage() {\n+        final String lockToken1 = UUID.randomUUID().toString();\n+\n+        final OffsetDateTime expiration = OffsetDateTime.now().plus(Duration.ofMinutes(5));\n+\n+        final MessageWithLockToken message = mock(MessageWithLockToken.class);\n+\n+        when(messageSerializer.deserialize(message, ServiceBusReceivedMessage.class)).thenReturn(receivedMessage);\n+\n+        when(receivedMessage.getLockToken()).thenReturn(lockToken1);\n+        when(receivedMessage.getLockedUntil()).thenReturn(expiration);\n+\n+        when(connection.createReceiveLink(anyString(), anyString(), any(ReceiveMode.class), any(),\n+            any(MessagingEntityType.class))).thenReturn(Mono.error(new AmqpException(false, \"some receive link Error.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(receiver.receiveMessages().take(1))\n+            .verifyErrorMatches(throwable -> {\n+                Assertions.assertTrue(throwable instanceof ServiceBusAmqpException);\n+                final ServiceBusErrorSource actual = ((ServiceBusAmqpException) throwable).getErrorSource();\n+                Assertions.assertEquals(ServiceBusErrorSource.RECEIVE, actual);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3286f4c4a0a5e407c36e08e71285e536bbe45ee1"}, "originalPosition": 160}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b61551fa0443e35d8147d39ed79c9370c8adddc8", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b61551fa0443e35d8147d39ed79c9370c8adddc8", "committedDate": "2020-10-29T09:02:44Z", "message": "review comments incorporated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "204fd28389bc8417768e1c35c0a33642a670239f", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/204fd28389bc8417768e1c35c0a33642a670239f", "committedDate": "2020-10-29T15:29:29Z", "message": "Fixing checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5ODkwMTQy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-519890142", "createdAt": "2020-10-29T17:07:07Z", "commit": {"oid": "204fd28389bc8417768e1c35c0a33642a670239f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzowNzowN1rOHql-dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzoxNDoxOFrOHqmR2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyNDQzNg==", "bodyText": "This is going to mask an autocomplete/Renew exception. iirc, we pass it downstream. it would not be a receive error, it would be a complete error.\nThis should be different in that we check the exception type, if it's ServiceBusErrorSource already and if so, not map it.\nWould be nice to have a test for this.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514424436", "createdAt": "2020-10-29T17:07:07Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -611,7 +611,8 @@ public String getEntityPath() {\n             withAutoComplete = withAutoLockRenewal;\n         }\n \n-        return withAutoComplete;\n+        return withAutoComplete\n+            .onErrorMap(throwable -> mapError(throwable, ServiceBusErrorSource.RECEIVE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "204fd28389bc8417768e1c35c0a33642a670239f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyOTQwMg==", "bodyText": "verifyErrorSatisfies is the correct one. Same with the other ones.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514429402", "createdAt": "2020-10-29T17:14:18Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientTest.java", "diffHunk": "@@ -443,6 +448,135 @@ void deadLetterWithDescription() {\n         verify(amqpReceiveLink).updateDisposition(eq(lockToken1), isA(Rejected.class));\n     }\n \n+    /**\n+     * Verifies that error source is populated when any error happened while renewing lock.\n+     */\n+    @Test\n+    void errorSourceOnRenewMessageLock() {\n+        // Arrange\n+        final Duration maxDuration = Duration.ofSeconds(8);\n+        final String lockToken = \"some-token\";\n+\n+        when(receivedMessage.getLockToken()).thenReturn(lockToken);\n+        when(managementNode.renewMessageLock(lockToken, null))\n+            .thenReturn(Mono.error(new AmqpException(false, \"some error occurred.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(receiver.renewMessageLock(receivedMessage, maxDuration))\n+            .verifyErrorMatches(throwable -> {\n+                Assertions.assertTrue(throwable instanceof ServiceBusAmqpException);\n+                final ServiceBusErrorSource actual = ((ServiceBusAmqpException) throwable).getErrorSource();\n+                Assertions.assertEquals(ServiceBusErrorSource.RENEW_LOCK, actual);\n+                return true;\n+            });\n+\n+        verify(managementNode, times(1)).renewMessageLock(lockToken, null);\n+    }\n+\n+    /**\n+     * Verifies that error source is populated when any error happened while renewing lock.\n+     */\n+    @Test\n+    void errorSourceOnSessionLock() {\n+        // Arrange\n+        when(managementNode.renewSessionLock(SESSION_ID, null)).thenReturn(Mono.error(new AmqpException(false, \"some error occurred.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(sessionReceiver.renewSessionLock(SESSION_ID))\n+            .verifyErrorMatches(throwable -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "204fd28389bc8417768e1c35c0a33642a670239f"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47bfc0b5bf2c8fe71435151dd3c0c13c6165881c", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/47bfc0b5bf2c8fe71435151dd3c0c13c6165881c", "committedDate": "2020-10-29T18:59:22Z", "message": "Incorporated  review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMDM2MTMx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-520036131", "createdAt": "2020-10-29T20:01:23Z", "commit": {"oid": "47bfc0b5bf2c8fe71435151dd3c0c13c6165881c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDowMToyNFrOHqscBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDowMToyNFrOHqscBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUzMDMxMA==", "bodyText": "Is there a reason we need to implement Serializable? Is this a thing? \ud83e\udd14  @JonathanGiles", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514530310", "createdAt": "2020-10-29T20:01:24Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusErrorSource.java", "diffHunk": "@@ -0,0 +1,52 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus;\n+\n+import com.azure.core.util.ExpandableStringEnum;\n+\n+import java.io.Serializable;\n+\n+/**\n+ * Represent the operation this sdk was performing when the error happened.\n+ */\n+public final class ServiceBusErrorSource extends ExpandableStringEnum<ServiceBusErrorSource> implements Serializable {\n+\n+    private static final long serialVersionUID = -2819764417333954922L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47bfc0b5bf2c8fe71435151dd3c0c13c6165881c"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMDM3Mzc5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-520037379", "createdAt": "2020-10-29T20:03:07Z", "commit": {"oid": "47bfc0b5bf2c8fe71435151dd3c0c13c6165881c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDowMzowN1rOHqshPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDowMzowN1rOHqshPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUzMTY0Nw==", "bodyText": "This can be condensed.\nif ((throwable instanceof ServiceBusAmqpException) || !(throwable instanceof AmqpException)) {\n    return throwable;\n}\n\nreturn new ServiceBusAmqpException((AmqpException) throwable, errorSource);", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514531647", "createdAt": "2020-10-29T20:03:07Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1136,4 +1172,19 @@ private String getLinkName(String sessionId) {\n             return existing != null ? existing.getLinkName() : null;\n         }\n     }\n+\n+    /**\n+     * Map the error to {@link ServiceBusAmqpException}\n+     */\n+    private Throwable mapError(Throwable throwable, ServiceBusErrorSource errorSource) {\n+        if (throwable instanceof ServiceBusAmqpException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47bfc0b5bf2c8fe71435151dd3c0c13c6165881c"}, "originalPosition": 144}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMDQwMDA4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-520040008", "createdAt": "2020-10-29T20:06:40Z", "commit": {"oid": "47bfc0b5bf2c8fe71435151dd3c0c13c6165881c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDowNjo0MFrOHqsshA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDowNjo0MFrOHqsshA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUzNDUzMg==", "bodyText": "These should all be: verifyErrorSatisfies.  verifyErrorMatches should be taking a predicate. This predicate ALWAYS returns true because you've done assertions. So this should be a consumer.\nhttps://projectreactor.io/docs/test/release/api/reactor/test/StepVerifier.LastStep.html#verifyErrorSatisfies-java.util.function.Consumer-", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514534532", "createdAt": "2020-10-29T20:06:40Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientTest.java", "diffHunk": "@@ -443,6 +448,175 @@ void deadLetterWithDescription() {\n         verify(amqpReceiveLink).updateDisposition(eq(lockToken1), isA(Rejected.class));\n     }\n \n+    /**\n+     * Verifies that error source is populated when any error happened while renewing lock.\n+     */\n+    @Test\n+    void errorSourceOnRenewMessageLock() {\n+        // Arrange\n+        final Duration maxDuration = Duration.ofSeconds(8);\n+        final String lockToken = \"some-token\";\n+\n+        when(receivedMessage.getLockToken()).thenReturn(lockToken);\n+        when(managementNode.renewMessageLock(lockToken, null))\n+            .thenReturn(Mono.error(new AmqpException(false, \"some error occurred.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(receiver.renewMessageLock(receivedMessage, maxDuration))\n+            .verifyErrorMatches(throwable -> {\n+                Assertions.assertTrue(throwable instanceof ServiceBusAmqpException);\n+                final ServiceBusErrorSource actual = ((ServiceBusAmqpException) throwable).getErrorSource();\n+                Assertions.assertEquals(ServiceBusErrorSource.RENEW_LOCK, actual);\n+                return true;\n+            });\n+\n+        verify(managementNode, times(1)).renewMessageLock(lockToken, null);\n+    }\n+\n+    /**\n+     * Verifies that error source is populated when any error happened while renewing lock.\n+     */\n+    @Test\n+    void errorSourceOnSessionLock() {\n+        // Arrange\n+        when(managementNode.renewSessionLock(SESSION_ID, null)).thenReturn(Mono.error(new AmqpException(false, \"some error occurred.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(sessionReceiver.renewSessionLock(SESSION_ID))\n+            .verifyErrorMatches(throwable -> {\n+                Assertions.assertTrue(throwable instanceof ServiceBusAmqpException);\n+                final ServiceBusErrorSource actual = ((ServiceBusAmqpException) throwable).getErrorSource();\n+                Assertions.assertEquals(ServiceBusErrorSource.RENEW_LOCK, actual);\n+                return true;\n+            });\n+    }\n+\n+    /**\n+     * Verifies that error source is populated when there is any error during message settlement.\n+     */\n+    @ParameterizedTest\n+    @MethodSource\n+    void errorSourceOnSettlement(DispositionStatus dispositionStatus, ServiceBusErrorSource expectedErrorSource,\n+        DeliveryStateType expectedDeliveryState) {\n+        final String lockToken1 = UUID.randomUUID().toString();\n+\n+        final OffsetDateTime expiration = OffsetDateTime.now().plus(Duration.ofMinutes(5));\n+\n+        final MessageWithLockToken message = mock(MessageWithLockToken.class);\n+\n+        when(messageSerializer.deserialize(message, ServiceBusReceivedMessage.class)).thenReturn(receivedMessage);\n+\n+        when(receivedMessage.getLockToken()).thenReturn(lockToken1);\n+        when(receivedMessage.getLockedUntil()).thenReturn(expiration);\n+\n+        when(amqpReceiveLink.updateDisposition(eq(lockToken1), argThat(e -> e.getType() == expectedDeliveryState)))\n+            .thenReturn(Mono.error(new AmqpException(false, \"some error occurred.\", null)));\n+\n+        // Act & Assert\n+        StepVerifier.create(receiver.receiveMessages().take(1)\n+            .flatMap(context -> {\n+                final Mono<Void> operation;\n+                switch (dispositionStatus) {\n+                    case DEFERRED:\n+                        operation = receiver.defer(receivedMessage);\n+                        break;\n+                    case ABANDONED:\n+                        operation = receiver.abandon(receivedMessage);\n+                        break;\n+                    case COMPLETED:\n+                        operation = receiver.complete(receivedMessage);\n+                        break;\n+                    case SUSPENDED:\n+                        operation = receiver.deadLetter(receivedMessage);\n+                        break;\n+                    default:\n+                        throw new IllegalArgumentException(\"Unrecognized operation: \" + dispositionStatus);\n+                }\n+                return operation;\n+            }))\n+            .then(() -> messageSink.next(message))\n+            .expectNext()\n+            .verifyErrorMatches(throwable -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47bfc0b5bf2c8fe71435151dd3c0c13c6165881c"}, "originalPosition": 126}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e62f7f5d44c26d72ea640f4e61d6a01011e3e6d0", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e62f7f5d44c26d72ea640f4e61d6a01011e3e6d0", "committedDate": "2020-10-29T23:27:09Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c11eb445e1fa76465189c8e1ea31d3bc7a14a7a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4c11eb445e1fa76465189c8e1ea31d3bc7a14a7a", "committedDate": "2020-10-29T23:29:53Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59ff15f844981e0e3831fa897ac0800d9beb1fcf", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/59ff15f844981e0e3831fa897ac0800d9beb1fcf", "committedDate": "2020-10-29T23:59:09Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b0d16a63c7d471f44715fa57e852b59ec2da31e", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5b0d16a63c7d471f44715fa57e852b59ec2da31e", "committedDate": "2020-10-30T01:28:09Z", "message": "Removed unwanted error source types"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMzM2MDM4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-520336038", "createdAt": "2020-10-30T02:21:57Z", "commit": {"oid": "5b0d16a63c7d471f44715fa57e852b59ec2da31e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMzg1MDE2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#pullrequestreview-520385016", "createdAt": "2020-10-30T05:27:59Z", "commit": {"oid": "5b0d16a63c7d471f44715fa57e852b59ec2da31e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNToyNzo1OVrOHrBvHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNTozMDoyMlrOHrBxSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg3OTI2MQ==", "bodyText": "Why do we need MESSAGE here in this enum? Can this be named ACCEPT_SESSION and CLOSE_SESSION for the next one?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514879261", "createdAt": "2020-10-30T05:27:59Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusErrorSource.java", "diffHunk": "@@ -0,0 +1,39 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.servicebus;\n+\n+import com.azure.core.util.ExpandableStringEnum;\n+\n+/**\n+ * Represent the operation this sdk was performing when the error happened.\n+ */\n+public final class ServiceBusErrorSource extends ExpandableStringEnum<ServiceBusErrorSource> {\n+\n+    /** Error while abandoning the message.*/\n+    public static final ServiceBusErrorSource ABANDONED = fromString(\"ABANDONED\", ServiceBusErrorSource.class);\n+\n+    /** Error while completing the message.*/\n+    public static final ServiceBusErrorSource COMPLETE = fromString(\"COMPLETE\", ServiceBusErrorSource.class);\n+\n+    /** Error while receiving the message(s).*/\n+    public static final ServiceBusErrorSource RECEIVE = fromString(\"RECEIVE\", ServiceBusErrorSource.class);\n+\n+    /** Error while renewing lock.*/\n+    public static final ServiceBusErrorSource RENEW_LOCK = fromString(\"RENEW_LOCK\", ServiceBusErrorSource.class);\n+\n+    /** Error when we could not determine the source.*/\n+    public static final ServiceBusErrorSource UNKNOWN = fromString(\"UNKNOWN\", ServiceBusErrorSource.class);\n+\n+    /** Error while user's code is running for a message.*/\n+    public static final ServiceBusErrorSource USER_CALLBACK = fromString(\"USER_CALLBACK\",\n+        ServiceBusErrorSource.class);\n+\n+    /** Error while session is accepted.*/\n+    public static final ServiceBusErrorSource ACCEPT_MESSAGE_SESSION = fromString(\"ACCEPT_MESSAGE_SESSION\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b0d16a63c7d471f44715fa57e852b59ec2da31e"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg3OTYwOQ==", "bodyText": "DEFER is not in ServiceBusErrorSource", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514879609", "createdAt": "2020-10-30T05:29:35Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1060,20 +1068,48 @@ private boolean isManagementToken(String lockToken) {\n                     logger.info(\"Could not perform on session manger. Performing on management node.\");\n                     return performOnManagement;\n                 });\n-        }\n-\n-        final ServiceBusAsyncConsumer existingConsumer = consumer.get();\n-        if (isManagementToken(lockToken) || existingConsumer == null) {\n-            return performOnManagement;\n         } else {\n-            return existingConsumer.updateDisposition(lockToken, dispositionStatus, deadLetterReason,\n-                deadLetterErrorDescription, propertiesToModify, transactionContext)\n-                .then(Mono.fromRunnable(() -> {\n-                    logger.info(\"{}: Update completed. Disposition: {}. Lock: {}.\",\n-                        entityPath, dispositionStatus, lockToken);\n-                    renewalContainer.remove(lockToken);\n-                }));\n+            final ServiceBusAsyncConsumer existingConsumer = consumer.get();\n+            if (isManagementToken(lockToken) || existingConsumer == null) {\n+                updateDispositionOperation = performOnManagement;\n+            } else {\n+                updateDispositionOperation = existingConsumer.updateDisposition(lockToken, dispositionStatus,\n+                    deadLetterReason, deadLetterErrorDescription, propertiesToModify, transactionContext)\n+                    .then(Mono.fromRunnable(() -> {\n+                        logger.info(\"{}: Update completed. Disposition: {}. Lock: {}.\",\n+                            entityPath, dispositionStatus, lockToken);\n+                        renewalContainer.remove(lockToken);\n+                    }));\n+            }\n         }\n+        return updateDispositionOperation\n+            .onErrorMap(throwable -> {\n+                ServiceBusErrorSource errorSource;\n+                if (throwable instanceof AmqpException) {\n+                    switch (dispositionStatus) {\n+                        case COMPLETED:\n+                            errorSource = ServiceBusErrorSource.COMPLETE;\n+                            break;\n+                        case DEFERRED:\n+                            errorSource = ServiceBusErrorSource.DEFER;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b0d16a63c7d471f44715fa57e852b59ec2da31e"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg3OTgxOQ==", "bodyText": "DEAD_LETTER too is removed from ServiceBusErrorSource.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16710#discussion_r514879819", "createdAt": "2020-10-30T05:30:22Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1060,20 +1068,48 @@ private boolean isManagementToken(String lockToken) {\n                     logger.info(\"Could not perform on session manger. Performing on management node.\");\n                     return performOnManagement;\n                 });\n-        }\n-\n-        final ServiceBusAsyncConsumer existingConsumer = consumer.get();\n-        if (isManagementToken(lockToken) || existingConsumer == null) {\n-            return performOnManagement;\n         } else {\n-            return existingConsumer.updateDisposition(lockToken, dispositionStatus, deadLetterReason,\n-                deadLetterErrorDescription, propertiesToModify, transactionContext)\n-                .then(Mono.fromRunnable(() -> {\n-                    logger.info(\"{}: Update completed. Disposition: {}. Lock: {}.\",\n-                        entityPath, dispositionStatus, lockToken);\n-                    renewalContainer.remove(lockToken);\n-                }));\n+            final ServiceBusAsyncConsumer existingConsumer = consumer.get();\n+            if (isManagementToken(lockToken) || existingConsumer == null) {\n+                updateDispositionOperation = performOnManagement;\n+            } else {\n+                updateDispositionOperation = existingConsumer.updateDisposition(lockToken, dispositionStatus,\n+                    deadLetterReason, deadLetterErrorDescription, propertiesToModify, transactionContext)\n+                    .then(Mono.fromRunnable(() -> {\n+                        logger.info(\"{}: Update completed. Disposition: {}. Lock: {}.\",\n+                            entityPath, dispositionStatus, lockToken);\n+                        renewalContainer.remove(lockToken);\n+                    }));\n+            }\n         }\n+        return updateDispositionOperation\n+            .onErrorMap(throwable -> {\n+                ServiceBusErrorSource errorSource;\n+                if (throwable instanceof AmqpException) {\n+                    switch (dispositionStatus) {\n+                        case COMPLETED:\n+                            errorSource = ServiceBusErrorSource.COMPLETE;\n+                            break;\n+                        case DEFERRED:\n+                            errorSource = ServiceBusErrorSource.DEFER;\n+                            break;\n+                        case SUSPENDED:\n+                            errorSource = ServiceBusErrorSource.DEAD_LETTER;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b0d16a63c7d471f44715fa57e852b59ec2da31e"}, "originalPosition": 116}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "205fbfef94069c968b9b3509e08bb960e831de3c", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/205fbfef94069c968b9b3509e08bb960e831de3c", "committedDate": "2020-10-30T07:01:44Z", "message": "Fix unit test and ErrorSource only for AutoComplete on"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62510bdfeee20cbd41ec3e6a393fdaff4b75d505", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/62510bdfeee20cbd41ec3e6a393fdaff4b75d505", "committedDate": "2020-10-30T07:05:32Z", "message": "Review Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d79df0c6fd251fa8cfefcea3a52cdba716abb6b", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6d79df0c6fd251fa8cfefcea3a52cdba716abb6b", "committedDate": "2020-10-30T08:40:56Z", "message": " Fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a6fea9c71f12b4e89542133caeca79f5e664a99", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0a6fea9c71f12b4e89542133caeca79f5e664a99", "committedDate": "2020-10-30T09:46:19Z", "message": "merge conflict resolution"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1766, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}