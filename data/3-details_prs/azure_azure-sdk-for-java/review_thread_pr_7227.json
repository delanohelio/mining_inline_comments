{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5ODYyMjIx", "number": 7227, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMTozNDozOVrODWt9IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozMTo1MlrODX9rgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MTQ4MTkyOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelHealthChecker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMTozNDozOVrOFboz0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMTozNDozOVrOFboz0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyNDQ5OQ==", "bodyText": "NOTE TO REVIEWERS\nChanges to the RntbdClientChannelHealthChecker class add javadocs, simplify the code by eliminating the RntbdClientChannelHealthChecker.JsonSerializer class, and break a few lines of code for readability and compliance with Azure Central SDK code guidelines.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r364524499", "createdAt": "2020-01-09T01:34:39Z", "author": {"login": "David-Noble-at-work"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelHealthChecker.java", "diffHunk": "@@ -4,18 +4,14 @@\n package com.azure.cosmos.implementation.directconnectivity.rntbd;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1153ebe5af09a3301d73f1b14d3e8ca338baae"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzUzMjk0OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNjozNTo0OFrOFb8H7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMDozNjo1MFrOFcyuCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0MDk0Mw==", "bodyText": "are we not record cancellation triggered by reactor-stream now?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r364840943", "createdAt": "2020-01-09T16:35:48Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -117,22 +117,30 @@ public long id() {\n         URI address = addressUri.getURI();\n \n         final RntbdRequestArgs requestArgs = new RntbdRequestArgs(request, address);\n+\n         requestArgs.traceOperation(logger, null, \"invokeStoreAsync\");\n \n         final RntbdEndpoint endpoint = this.endpointProvider.get(address);\n         final RntbdRequestRecord record = endpoint.request(requestArgs);\n \n         logger.debug(\"RntbdTransportClient.invokeStoreAsync({}, {}): {}\", address, request, record);\n \n-        return Mono.fromFuture(record).doFinally(signalType -> {\n-            logger.debug(\"SignalType.{} received from reactor: {\\n  endpoint: {},\\n  record: {}\\n}\",\n-                signalType.name(),\n-                endpoint,\n-                record);\n-            if (signalType == SignalType.CANCEL) {\n-                record.stage(RntbdRequestRecord.Stage.CANCELLED_BY_CLIENT);\n+        return Mono.fromFuture(record.whenComplete((response, throwable) -> {\n+\n+            record.stage(RntbdRequestRecord.Stage.COMPLETED);\n+\n+            if (throwable == null) {\n+                response.setRequestTimeline(record.takeTimelineSnapshot());\n+            } else {\n+                checkArgument(throwable instanceof CosmosClientException, \"expected %s, not %s: %s\",\n+                    CosmosClientException.class,\n+                    throwable.getClass(),\n+                    throwable);\n+                CosmosClientException error = (CosmosClientException) throwable;\n+                error.setRequestTimeline(record.takeTimelineSnapshot());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg1NDU5NA==", "bodyText": "what happens on cancellation triggered by reactor-stream are they recorded anywhere?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r364854594", "createdAt": "2020-01-09T16:59:41Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -117,22 +117,30 @@ public long id() {\n         URI address = addressUri.getURI();\n \n         final RntbdRequestArgs requestArgs = new RntbdRequestArgs(request, address);\n+\n         requestArgs.traceOperation(logger, null, \"invokeStoreAsync\");\n \n         final RntbdEndpoint endpoint = this.endpointProvider.get(address);\n         final RntbdRequestRecord record = endpoint.request(requestArgs);\n \n         logger.debug(\"RntbdTransportClient.invokeStoreAsync({}, {}): {}\", address, request, record);\n \n-        return Mono.fromFuture(record).doFinally(signalType -> {\n-            logger.debug(\"SignalType.{} received from reactor: {\\n  endpoint: {},\\n  record: {}\\n}\",\n-                signalType.name(),\n-                endpoint,\n-                record);\n-            if (signalType == SignalType.CANCEL) {\n-                record.stage(RntbdRequestRecord.Stage.CANCELLED_BY_CLIENT);\n+        return Mono.fromFuture(record.whenComplete((response, throwable) -> {\n+\n+            record.stage(RntbdRequestRecord.Stage.COMPLETED);\n+\n+            if (throwable == null) {\n+                response.setRequestTimeline(record.takeTimelineSnapshot());\n+            } else {\n+                checkArgument(throwable instanceof CosmosClientException, \"expected %s, not %s: %s\",\n+                    CosmosClientException.class,\n+                    throwable.getClass(),\n+                    throwable);\n+                CosmosClientException error = (CosmosClientException) throwable;\n+                error.setRequestTimeline(record.takeTimelineSnapshot());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0MDk0Mw=="}, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTczNTQzMg==", "bodyText": "You found a bug, thanks. I found on my local branch that I must capture cancellations from the reactor stream. I'll add that in the morning and update issue #7250 to ensure there's test coverage when that issue is resolved.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r365735432", "createdAt": "2020-01-13T10:36:50Z", "author": {"login": "David-Noble-at-work"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -117,22 +117,30 @@ public long id() {\n         URI address = addressUri.getURI();\n \n         final RntbdRequestArgs requestArgs = new RntbdRequestArgs(request, address);\n+\n         requestArgs.traceOperation(logger, null, \"invokeStoreAsync\");\n \n         final RntbdEndpoint endpoint = this.endpointProvider.get(address);\n         final RntbdRequestRecord record = endpoint.request(requestArgs);\n \n         logger.debug(\"RntbdTransportClient.invokeStoreAsync({}, {}): {}\", address, request, record);\n \n-        return Mono.fromFuture(record).doFinally(signalType -> {\n-            logger.debug(\"SignalType.{} received from reactor: {\\n  endpoint: {},\\n  record: {}\\n}\",\n-                signalType.name(),\n-                endpoint,\n-                record);\n-            if (signalType == SignalType.CANCEL) {\n-                record.stage(RntbdRequestRecord.Stage.CANCELLED_BY_CLIENT);\n+        return Mono.fromFuture(record.whenComplete((response, throwable) -> {\n+\n+            record.stage(RntbdRequestRecord.Stage.COMPLETED);\n+\n+            if (throwable == null) {\n+                response.setRequestTimeline(record.takeTimelineSnapshot());\n+            } else {\n+                checkArgument(throwable instanceof CosmosClientException, \"expected %s, not %s: %s\",\n+                    CosmosClientException.class,\n+                    throwable.getClass(),\n+                    throwable);\n+                CosmosClientException error = (CosmosClientException) throwable;\n+                error.setRequestTimeline(record.takeTimelineSnapshot());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0MDk0Mw=="}, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzU3Nzc4OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNjo0ODoyM1rOFb8ldw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMTowNTo1M1rOFdlxdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0ODUwMw==", "bodyText": "This is public surface area change, so we need to make sure if we know this is applicable to all connection modes or RNTBD only.\na few questions.\n\nis this related to only direct stack? what about GW mode?\nis there any reason this is not added to request diagnostics CosmosResponseDiagnostics which already exists? CosmosClientException has a getter for itCosmosClientException::getCosmosResponseDiagnostics()", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r364848503", "createdAt": "2020-01-09T16:48:23Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA2OTQwNw==", "bodyText": "This should be usable in all connection modes. It is our choice. I expected it would also be used by HttpClient (Kushagra and I have talked about renaming this the HttpGatewayClient) and HttpTransportClient. I wrote a little about that here: #6580. I will log an issue to add the feature to both HTTP clients; assuming that's OK with you.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r365069407", "createdAt": "2020-01-10T04:34:29Z", "author": {"login": "David-Noble-at-work"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0ODUwMw=="}, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM1MjY4OA==", "bodyText": "Logged issue #7342, [FEATURE REQ] Add request timeline to HttpClient and HttpTransportClient", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r365352688", "createdAt": "2020-01-10T17:45:17Z", "author": {"login": "David-Noble-at-work"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0ODUwMw=="}, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzOTU2MA==", "bodyText": "David, what about the second portion of my comment?\n\nis there any reason this is not added to request diagnostics CosmosResponseDiagnostics which already exists? CosmosClientException has a getter for it CosmosClientException::getCosmosResponseDiagnostics()", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366539560", "createdAt": "2020-01-14T19:49:34Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0ODUwMw=="}, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0MjEyMg==", "bodyText": "That could easily be done and I'll plan on making the change in the next few minutes. Let me touch base with Naveen before completing the work.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366542122", "createdAt": "2020-01-14T19:55:18Z", "author": {"login": "David-Noble-at-work"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0ODUwMw=="}, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3MTIwNA==", "bodyText": "Hi Mo , the best possible solution will only come once i start integrating it in my next PR , so at this point it will be hard to find the best place for RequestTimeline. For now lets keep it as David did, and I will change in my PR which I already start working on", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366571204", "createdAt": "2020-01-14T21:04:12Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0ODUwMw=="}, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3MTg5NQ==", "bodyText": "sure. makes sense.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366571895", "createdAt": "2020-01-14T21:05:53Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0ODUwMw=="}, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzU4NTI1OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNjo1MDozOFrOFb8qFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNzoyOToxNFrOFca-oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0OTY4NQ==", "bodyText": "setter should not be public. if setter needed for internal implementation we should so similar to `CosmosClientException::setCosmosResponseDiagnostics(.)", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r364849685", "createdAt": "2020-01-09T16:50:38Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {\n+        return this.requestTimeline;\n+    }\n+\n+    public CosmosClientException setRequestTimeline(RequestTimeline requestTimeline) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM0NjQ2NA==", "bodyText": "fixed on my local branch. good catch. thanks.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r365346464", "createdAt": "2020-01-10T17:29:14Z", "author": {"login": "David-Noble-at-work"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {\n+        return this.requestTimeline;\n+    }\n+\n+    public CosmosClientException setRequestTimeline(RequestTimeline requestTimeline) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0OTY4NQ=="}, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NDIzODM2OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RequestTimeline.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNzo0NzoxN1rOFdgSzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNzo1MzozN1rOFdgeEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ4MjEyNA==", "bodyText": "Can we move this out of Direct so it wont be specific to one mode and can be use in gateway too", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366482124", "createdAt": "2020-01-14T17:47:17Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RequestTimeline.java", "diffHunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity;\n+\n+import com.azure.cosmos.implementation.directconnectivity.rntbd.RntbdObjectMapper;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import com.fasterxml.jackson.databind.ser.std.ToStringSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.time.Duration;\n+import java.time.OffsetDateTime;\n+import java.util.Iterator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+/**\n+ * Represents the time and duration of important events in the lifetime of a request.\n+ *\n+ * A {@link RequestTimeline} represents a timeline as a sequence of {@link Event} instances with name, time, and\n+ * duration properties. Hence, one might use this class to represent any timeline. Today we use it to represent\n+ * {@link RntbdTransportClient} request timelines. In the future we might also use it to represent\n+ * {@link HttpTransportClient} request timelines.\n+ *\n+ * A {@link RequestTimeline} serializes to JSON as an array of {@link Event} instances. This is the default\n+ * serialization for any class that implements {@link Iterable}.\n+ * <p>\n+ * <b>Example:</b>\n+ * <pre>{@code OffsetDateTime startTime = OffsetDateTime.parse(\"2020-01-07T11:24:12.842749-08:00\", DateTimeFormatter.ISO_OFFSET_DATE_TIME);\n+ * sys.out.println(RequestTimeline.of(\n+ *     new RequestTimeline.Event(\"foo\", startTime, startTime.plusSeconds(1)),\n+ *     new RequestTimeline.Event(\"bar\", startTime.plusSeconds(1), startTime.plusSeconds(2))));}</pre>\n+ * JSON serialization:\n+ * <pre>{@code [{\"name\":\"foo\",\"time\":\"2020-01-07T11:24:12.842749-08:00\",\"duration\":\"PT1S\"},{\"name\":\"bar\",\"time\":\"2020-01-07T11:24:13.842749-08:00\",\"duration\":\"PT1S\"}])}</pre>\n+ */\n+public final class RequestTimeline implements Iterable<RequestTimeline.Event> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ4NTAwOA==", "bodyText": "I am happy to move this out of direct for use in gateway. I'll take care of that this morning.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366485008", "createdAt": "2020-01-14T17:53:37Z", "author": {"login": "David-Noble-at-work"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RequestTimeline.java", "diffHunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity;\n+\n+import com.azure.cosmos.implementation.directconnectivity.rntbd.RntbdObjectMapper;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import com.fasterxml.jackson.databind.ser.std.ToStringSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.time.Duration;\n+import java.time.OffsetDateTime;\n+import java.util.Iterator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+/**\n+ * Represents the time and duration of important events in the lifetime of a request.\n+ *\n+ * A {@link RequestTimeline} represents a timeline as a sequence of {@link Event} instances with name, time, and\n+ * duration properties. Hence, one might use this class to represent any timeline. Today we use it to represent\n+ * {@link RntbdTransportClient} request timelines. In the future we might also use it to represent\n+ * {@link HttpTransportClient} request timelines.\n+ *\n+ * A {@link RequestTimeline} serializes to JSON as an array of {@link Event} instances. This is the default\n+ * serialization for any class that implements {@link Iterable}.\n+ * <p>\n+ * <b>Example:</b>\n+ * <pre>{@code OffsetDateTime startTime = OffsetDateTime.parse(\"2020-01-07T11:24:12.842749-08:00\", DateTimeFormatter.ISO_OFFSET_DATE_TIME);\n+ * sys.out.println(RequestTimeline.of(\n+ *     new RequestTimeline.Event(\"foo\", startTime, startTime.plusSeconds(1)),\n+ *     new RequestTimeline.Event(\"bar\", startTime.plusSeconds(1), startTime.plusSeconds(2))));}</pre>\n+ * JSON serialization:\n+ * <pre>{@code [{\"name\":\"foo\",\"time\":\"2020-01-07T11:24:12.842749-08:00\",\"duration\":\"PT1S\"},{\"name\":\"bar\",\"time\":\"2020-01-07T11:24:13.842749-08:00\",\"duration\":\"PT1S\"}])}</pre>\n+ */\n+public final class RequestTimeline implements Iterable<RequestTimeline.Event> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ4MjEyNA=="}, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NDUyNzMzOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RequestTimeline.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOToyNjoxMVrOFdjIvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo1MjoxNlrOFdj3pA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUyODcwMA==", "bodyText": "Any reason we need this in addition to empty() API above ?\nIs it okay to share the EMPTY static instance. If multiple callers get this object and modify it, the EMPTY static instance will be modified, right ?\nOr if it is singleton, then looks good.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366528700", "createdAt": "2020-01-14T19:26:11Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RequestTimeline.java", "diffHunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity;\n+\n+import com.azure.cosmos.implementation.directconnectivity.rntbd.RntbdObjectMapper;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import com.fasterxml.jackson.databind.ser.std.ToStringSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.time.Duration;\n+import java.time.OffsetDateTime;\n+import java.util.Iterator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+/**\n+ * Represents the time and duration of important events in the lifetime of a request.\n+ *\n+ * A {@link RequestTimeline} represents a timeline as a sequence of {@link Event} instances with name, time, and\n+ * duration properties. Hence, one might use this class to represent any timeline. Today we use it to represent\n+ * {@link RntbdTransportClient} request timelines. In the future we might also use it to represent\n+ * {@link HttpTransportClient} request timelines.\n+ *\n+ * A {@link RequestTimeline} serializes to JSON as an array of {@link Event} instances. This is the default\n+ * serialization for any class that implements {@link Iterable}.\n+ * <p>\n+ * <b>Example:</b>\n+ * <pre>{@code OffsetDateTime startTime = OffsetDateTime.parse(\"2020-01-07T11:24:12.842749-08:00\", DateTimeFormatter.ISO_OFFSET_DATE_TIME);\n+ * sys.out.println(RequestTimeline.of(\n+ *     new RequestTimeline.Event(\"foo\", startTime, startTime.plusSeconds(1)),\n+ *     new RequestTimeline.Event(\"bar\", startTime.plusSeconds(1), startTime.plusSeconds(2))));}</pre>\n+ * JSON serialization:\n+ * <pre>{@code [{\"name\":\"foo\",\"time\":\"2020-01-07T11:24:12.842749-08:00\",\"duration\":\"PT1S\"},{\"name\":\"bar\",\"time\":\"2020-01-07T11:24:13.842749-08:00\",\"duration\":\"PT1S\"}])}</pre>\n+ */\n+public final class RequestTimeline implements Iterable<RequestTimeline.Event> {\n+\n+    private static final RequestTimeline EMPTY = new RequestTimeline();\n+    private final ImmutableList<Event> events;\n+\n+    private RequestTimeline() {\n+        this.events = ImmutableList.of();\n+    }\n+\n+    private RequestTimeline(final ImmutableList<Event> events) {\n+        checkNotNull(events, \"expected non-null events\");\n+        this.events = events;\n+    }\n+\n+    /**\n+     * Returns an empty {@link RequestTimeline}.\n+     *\n+     * The empty time line returned is static.\n+     *\n+     * @return an empty {@link RequestTimeline}.\n+     */\n+    public static RequestTimeline empty() {\n+        return EMPTY;\n+    }\n+\n+    /**\n+     * Returns an iterator for enumerating the {@link Event} instances in this {@link RequestTimeline}.\n+     *\n+     * @return an iterator for enumerating the {@link Event} instances in this {@link RequestTimeline}.\n+     */\n+    @Override\n+    public Iterator<Event> iterator() {\n+        return this.events.iterator();\n+    }\n+\n+    /**\n+     * Returns an empty {@link RequestTimeline}.\n+     *\n+     * The empty time line returned is static and equivalent to calling {@link RequestTimeline#empty}.\n+     *\n+     * @return an empty request timeline.\n+     */\n+    public static RequestTimeline of() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0MDcwOA==", "bodyText": "EMPTY is a singleton and RequestTimeline instances are immutable. The of() method is provided for completeness and could easily be removed. I thought about removing it once or twice myself. I'll resolve this issue assuming that it's OK to leave the of() method in.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366540708", "createdAt": "2020-01-14T19:52:16Z", "author": {"login": "David-Noble-at-work"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RequestTimeline.java", "diffHunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity;\n+\n+import com.azure.cosmos.implementation.directconnectivity.rntbd.RntbdObjectMapper;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import com.fasterxml.jackson.databind.ser.std.ToStringSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.time.Duration;\n+import java.time.OffsetDateTime;\n+import java.util.Iterator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+/**\n+ * Represents the time and duration of important events in the lifetime of a request.\n+ *\n+ * A {@link RequestTimeline} represents a timeline as a sequence of {@link Event} instances with name, time, and\n+ * duration properties. Hence, one might use this class to represent any timeline. Today we use it to represent\n+ * {@link RntbdTransportClient} request timelines. In the future we might also use it to represent\n+ * {@link HttpTransportClient} request timelines.\n+ *\n+ * A {@link RequestTimeline} serializes to JSON as an array of {@link Event} instances. This is the default\n+ * serialization for any class that implements {@link Iterable}.\n+ * <p>\n+ * <b>Example:</b>\n+ * <pre>{@code OffsetDateTime startTime = OffsetDateTime.parse(\"2020-01-07T11:24:12.842749-08:00\", DateTimeFormatter.ISO_OFFSET_DATE_TIME);\n+ * sys.out.println(RequestTimeline.of(\n+ *     new RequestTimeline.Event(\"foo\", startTime, startTime.plusSeconds(1)),\n+ *     new RequestTimeline.Event(\"bar\", startTime.plusSeconds(1), startTime.plusSeconds(2))));}</pre>\n+ * JSON serialization:\n+ * <pre>{@code [{\"name\":\"foo\",\"time\":\"2020-01-07T11:24:12.842749-08:00\",\"duration\":\"PT1S\"},{\"name\":\"bar\",\"time\":\"2020-01-07T11:24:13.842749-08:00\",\"duration\":\"PT1S\"}])}</pre>\n+ */\n+public final class RequestTimeline implements Iterable<RequestTimeline.Event> {\n+\n+    private static final RequestTimeline EMPTY = new RequestTimeline();\n+    private final ImmutableList<Event> events;\n+\n+    private RequestTimeline() {\n+        this.events = ImmutableList.of();\n+    }\n+\n+    private RequestTimeline(final ImmutableList<Event> events) {\n+        checkNotNull(events, \"expected non-null events\");\n+        this.events = events;\n+    }\n+\n+    /**\n+     * Returns an empty {@link RequestTimeline}.\n+     *\n+     * The empty time line returned is static.\n+     *\n+     * @return an empty {@link RequestTimeline}.\n+     */\n+    public static RequestTimeline empty() {\n+        return EMPTY;\n+    }\n+\n+    /**\n+     * Returns an iterator for enumerating the {@link Event} instances in this {@link RequestTimeline}.\n+     *\n+     * @return an iterator for enumerating the {@link Event} instances in this {@link RequestTimeline}.\n+     */\n+    @Override\n+    public Iterator<Event> iterator() {\n+        return this.events.iterator();\n+    }\n+\n+    /**\n+     * Returns an empty {@link RequestTimeline}.\n+     *\n+     * The empty time line returned is static and equivalent to calling {@link RequestTimeline#empty}.\n+     *\n+     * @return an empty request timeline.\n+     */\n+    public static RequestTimeline of() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUyODcwMA=="}, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NDU0MjEyOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozMToxNVrOFdjR3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo1ODoyOVrOFdkC0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTAzNg==", "bodyText": "Reactor might / will wrap the exception in ReactiveException.\nThe safest way to check throwable instanceOf CosmosClientException is this.\nfinal Throwable unwrappedThrowable = reactor.core.Exceptions.unwrap(throwable);\nif (unwrappedThrowable instanceof CosmosClientException) {\n .....\n}", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366531036", "createdAt": "2020-01-14T19:31:15Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -117,21 +118,27 @@ public long id() {\n         URI address = addressUri.getURI();\n \n         final RntbdRequestArgs requestArgs = new RntbdRequestArgs(request, address);\n+\n         requestArgs.traceOperation(logger, null, \"invokeStoreAsync\");\n \n         final RntbdEndpoint endpoint = this.endpointProvider.get(address);\n         final RntbdRequestRecord record = endpoint.request(requestArgs);\n \n         logger.debug(\"RntbdTransportClient.invokeStoreAsync({}, {}): {}\", address, request, record);\n \n-        return Mono.fromFuture(record).doFinally(signalType -> {\n-            logger.debug(\"SignalType.{} received from reactor: {\\n  endpoint: {},\\n  record: {}\\n}\",\n-                signalType.name(),\n-                endpoint,\n-                record);\n-            if (signalType == SignalType.CANCEL) {\n-                record.stage(RntbdRequestRecord.Stage.CANCELLED_BY_CLIENT);\n+        return Mono.fromFuture(record.whenComplete((response, throwable) -> {\n+\n+            record.stage(RntbdRequestRecord.Stage.COMPLETED);\n+\n+            if (throwable == null) {\n+                response.setRequestTimeline(record.takeTimelineSnapshot());\n+            } else if (throwable instanceof CosmosClientException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzODU5MA==", "bodyText": "@kushagraThapar reactor.core.Exceptions.unwrap should not be needed in this layer. right?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366538590", "createdAt": "2020-01-14T19:47:23Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -117,21 +118,27 @@ public long id() {\n         URI address = addressUri.getURI();\n \n         final RntbdRequestArgs requestArgs = new RntbdRequestArgs(request, address);\n+\n         requestArgs.traceOperation(logger, null, \"invokeStoreAsync\");\n \n         final RntbdEndpoint endpoint = this.endpointProvider.get(address);\n         final RntbdRequestRecord record = endpoint.request(requestArgs);\n \n         logger.debug(\"RntbdTransportClient.invokeStoreAsync({}, {}): {}\", address, request, record);\n \n-        return Mono.fromFuture(record).doFinally(signalType -> {\n-            logger.debug(\"SignalType.{} received from reactor: {\\n  endpoint: {},\\n  record: {}\\n}\",\n-                signalType.name(),\n-                endpoint,\n-                record);\n-            if (signalType == SignalType.CANCEL) {\n-                record.stage(RntbdRequestRecord.Stage.CANCELLED_BY_CLIENT);\n+        return Mono.fromFuture(record.whenComplete((response, throwable) -> {\n+\n+            record.stage(RntbdRequestRecord.Stage.COMPLETED);\n+\n+            if (throwable == null) {\n+                response.setRequestTimeline(record.takeTimelineSnapshot());\n+            } else if (throwable instanceof CosmosClientException) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTAzNg=="}, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0MzU2OQ==", "bodyText": "Correct: The CosmosClientException originates in the Direct TCP stack and so reactor.core.Exceptions.unwrap is not needed.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366543569", "createdAt": "2020-01-14T19:58:29Z", "author": {"login": "David-Noble-at-work"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -117,21 +118,27 @@ public long id() {\n         URI address = addressUri.getURI();\n \n         final RntbdRequestArgs requestArgs = new RntbdRequestArgs(request, address);\n+\n         requestArgs.traceOperation(logger, null, \"invokeStoreAsync\");\n \n         final RntbdEndpoint endpoint = this.endpointProvider.get(address);\n         final RntbdRequestRecord record = endpoint.request(requestArgs);\n \n         logger.debug(\"RntbdTransportClient.invokeStoreAsync({}, {}): {}\", address, request, record);\n \n-        return Mono.fromFuture(record).doFinally(signalType -> {\n-            logger.debug(\"SignalType.{} received from reactor: {\\n  endpoint: {},\\n  record: {}\\n}\",\n-                signalType.name(),\n-                endpoint,\n-                record);\n-            if (signalType == SignalType.CANCEL) {\n-                record.stage(RntbdRequestRecord.Stage.CANCELLED_BY_CLIENT);\n+        return Mono.fromFuture(record.whenComplete((response, throwable) -> {\n+\n+            record.stage(RntbdRequestRecord.Stage.COMPLETED);\n+\n+            if (throwable == null) {\n+                response.setRequestTimeline(record.takeTimelineSnapshot());\n+            } else if (throwable instanceof CosmosClientException) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTAzNg=="}, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NDU0NDAyOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozMTo1MlrOFdjTFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozMTo1MlrOFdjTFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTM0OA==", "bodyText": "Good to log this \ud83d\udc4d", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366531348", "createdAt": "2020-01-14T19:31:52Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -417,7 +424,14 @@ public String toString() {\n                         }\n                     }\n                 } finally {\n-                    DEFAULT_OPTIONS = options != null ? options : new Options();\n+                    if (options == null) {\n+                        DEFAULT_OPTIONS = new Options();\n+                    } else {\n+                        logger.info(\"Updated default Direct TCP options from system property {}: {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 69}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 615, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}