{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwOTc4NTQy", "number": 10608, "title": "Fixed a bug in upload where we did not copy the buffer given to us so data could be overwritten upstream. ", "bodyText": "", "createdAt": "2020-04-29T22:06:16Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10608", "merged": true, "mergeCommit": {"oid": "cba50f26b410f5fc5254d9b191bd280979ea4af1"}, "closed": true, "closedAt": "2020-04-29T22:48:20Z", "author": {"login": "gapra-msft"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccf2wxAH2gAyNDEwOTc4NTQyOmIxY2M3MWJmNjBmYWFkMmI5MTAzY2JlNWE5MTFjNmIzMzdlNWI3Yjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccuuzbgFqTQwMzYyNTU1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b1cc71bf60faad2b9103cbe5a911c6b337e5b7b7", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b1cc71bf60faad2b9103cbe5a911c6b337e5b7b7", "committedDate": "2020-04-29T22:02:50Z", "message": "Fixed a bug in buffered upload where buffer was not deepcopied"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97e430c1b6bc56d8451639eeffe33ef5dc63ae5f", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/97e430c1b6bc56d8451639eeffe33ef5dc63ae5f", "committedDate": "2020-04-29T22:04:52Z", "message": "added commesnt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMDc2MTA1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10608#pullrequestreview-403076105", "createdAt": "2020-04-29T22:10:05Z", "commit": {"oid": "97e430c1b6bc56d8451639eeffe33ef5dc63ae5f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMjoxMDowNlrOGOS4Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMjoxMDowNlrOGOS4Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY0MjU1OQ==", "bodyText": "Can you add that the other copy is when we write it to the pool? Just so we don't forget what we mean later?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10608#discussion_r417642559", "createdAt": "2020-04-29T22:10:06Z", "author": {"login": "rickle-msft"}, "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/PayloadSizeGate.java", "diffHunk": "@@ -38,12 +38,17 @@\n      * @return Buffered data or incoming data depending on threshold condition.\n      */\n     Flux<ByteBuffer> write(ByteBuffer buf) {\n+        /* TODO (gapra): Investigate if there is way to avoid copying the data twice since this may result in lower perf. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97e430c1b6bc56d8451639eeffe33ef5dc63ae5f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMDc2MjAw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10608#pullrequestreview-403076200", "createdAt": "2020-04-29T22:10:18Z", "commit": {"oid": "97e430c1b6bc56d8451639eeffe33ef5dc63ae5f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95f2b45ca45673ad017fd771b10569083ba3857d", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/95f2b45ca45673ad017fd771b10569083ba3857d", "committedDate": "2020-04-29T22:11:10Z", "message": "Added detail to comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMDkzMjU1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10608#pullrequestreview-403093255", "createdAt": "2020-04-29T22:47:38Z", "commit": {"oid": "95f2b45ca45673ad017fd771b10569083ba3857d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNjI1NTU0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10608#pullrequestreview-403625554", "createdAt": "2020-04-30T15:20:55Z", "commit": {"oid": "95f2b45ca45673ad017fd771b10569083ba3857d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNToyMDo1NlrOGOuP_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNToyMjozN1rOGOuU2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MTAwNw==", "bodyText": "Ups. My bad.\nI think there isn't double copy now as copying was removed buffer pool - hence regression.\nFor future. Maybe it would be good to extract copying part to separate component that's inserted into Flux transform early in the process - so that it's more explicit (as we apparently quite depend on that).", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10608#discussion_r418091007", "createdAt": "2020-04-30T15:20:56Z", "author": {"login": "kasobol-msft"}, "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/PayloadSizeGate.java", "diffHunk": "@@ -38,12 +38,18 @@\n      * @return Buffered data or incoming data depending on threshold condition.\n      */\n     Flux<ByteBuffer> write(ByteBuffer buf) {\n+        /* TODO (gapra): Investigate if there is way to avoid copying the data twice since this may result in lower\n+            perf. The other copy is when we write the buffer to the pool */\n+        /* Deep copy the buffer. This is required to ensure integrity of data. */\n+        ByteBuffer cachedBuffer = ByteBuffer.allocate(buf.remaining()).put(buf);\n+        cachedBuffer.flip();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95f2b45ca45673ad017fd771b10569083ba3857d"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MjI0OA==", "bodyText": "Thanks for the test. There wasn't anything that could catch that regression.\nI'm not sure if adding larger data sizes would bring value in this test.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10608#discussion_r418092248", "createdAt": "2020-04-30T15:22:37Z", "author": {"login": "kasobol-msft"}, "path": "sdk/storage/azure-storage-blob/src/test/java/com/azure/storage/blob/BlobAPITest.groovy", "diffHunk": "@@ -80,6 +80,31 @@ class BlobAPITest extends APISpec {\n         stream.toByteArray() == randomData\n     }\n \n+\n+    /* Tests an issue found where buffered upload would not deep copy buffers while determining what upload path to take. */\n+    @Unroll\n+    def \"Upload input stream single upload\" () {\n+        setup:\n+        def randomData = getRandomByteArray(20 * Constants.KB)\n+        def input = new ByteArrayInputStream(randomData)\n+\n+        when:\n+        bc.upload(input, 20 * Constants.KB, true)\n+\n+        then:\n+        def stream = new ByteArrayOutputStream()\n+        bc.downloadWithResponse(stream, null, null, null, false, null, null)\n+        stream.toByteArray() == randomData\n+\n+        where:\n+        size                || _\n+        1 * Constants.KB    || _  /* Less than copyToOutputStream buffer size, Less than maxSingleUploadSize */\n+        8 * Constants.KB    || _  /* Equal to copyToOutputStream buffer size, Less than maxSingleUploadSize */\n+        20 * Constants.KB   || _  /* Greater than copyToOutputStream buffer size, Less than maxSingleUploadSize */\n+    }\n+\n+    /* TODO (gapra): Add more tests to test large data sizes. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95f2b45ca45673ad017fd771b10569083ba3857d"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4661, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}