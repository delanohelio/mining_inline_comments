{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5MDcyMDkx", "number": 12484, "title": "mgmt core fix and unit test for LRO", "bodyText": "It is only part of the complete fix for mgmt libs.\nLast AsyncPollResponse  will be in FAILED state with error in PollResult.\nUnlike track1 client-runtime, it will not throw CloudException during the polling. This appears to be conforming to track2 azure-core.\nIn this case, it might be appropriate for us to make a ManagementException in our code (however we do not have a HttpResponse here).\n            .flatMap(response -> {\n                if (response.getStatus() != LongRunningOperationStatus.SUCCESSFULLY_COMPLETED) {\n                    return Mono.error(new ManagementException(response.getValue().getError().getMessage(), null,\n                        new ManagementError(response.getStatus().toString(),\n                            response.getValue().getError().getMessage())));\n                } else {\n                    return response.getFinalResult();\n                }\n            });\n\nIt appears better to put HttpResponse into PollResult.", "createdAt": "2020-06-24T09:13:28Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12484", "merged": true, "mergeCommit": {"oid": "67730f85739eb3c1ade6ad4642758f5b14f8c37f"}, "closed": true, "closedAt": "2020-06-29T02:49:23Z", "author": {"login": "weidongxu-microsoft"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuVaykAH2gAyNDM5MDcyMDkxOmM2ZWIwYjYyNTUyNzZkOWM3NTZjYTNjMDU4YzkzM2E2M2U5YzI2MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcv3PB1gH2gAyNDM5MDcyMDkxOmEwNWRiMmM4NDczNTQ5ZjZjMzBhNWE0YWQ1ODdjYjM2ODA2NWIzYzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c6eb0b6255276d9c756ca3c058c933a63e9c2619", "author": {"user": {"login": "weidongxu-microsoft", "name": "Weidong Xu"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c6eb0b6255276d9c756ca3c058c933a63e9c2619", "committedDate": "2020-06-24T08:03:52Z", "message": "add unit test for AsyncOperation with success"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39896ae5ac87ab1345e25c7508c85de460e1922e", "author": {"user": {"login": "weidongxu-microsoft", "name": "Weidong Xu"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/39896ae5ac87ab1345e25c7508c85de460e1922e", "committedDate": "2020-06-24T08:30:43Z", "message": "add unit test for AsyncOperation with fail"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NDY5NTcy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12484#pullrequestreview-436469572", "createdAt": "2020-06-24T09:16:53Z", "commit": {"oid": "39896ae5ac87ab1345e25c7508c85de460e1922e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwOToxNjo1M1rOGoJ7JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwOToxNjo1M1rOGoJ7JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc1ODgyMA==", "bodyText": "Here last AsyncPollResponse  will be in FAILED state with error in PollResult. Unlike track1 client-runtime, it will not throw CloudException during the polling.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12484#discussion_r444758820", "createdAt": "2020-06-24T09:16:53Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/core/azure-core-management/src/test/java/com/azure/core/management/implementation/polling/LROPollerTests.java", "diffHunk": "@@ -126,6 +126,211 @@ public void lroBasedOnProvisioningState() {\n         }\n     }\n \n+    @Test\n+    public void lroBasedOnAsyncOperation() {\n+        ServerConfigure serverConfigure = new ServerConfigure();\n+\n+        final String resourceEndpoint = \"/resource/1\";\n+        final String operationEndpoint = \"/operations/1\";\n+        ResponseTransformer provisioningStateLroService = new ResponseTransformer() {\n+            private final int[] getCallCount = new int[1];\n+\n+            @Override\n+            public com.github.tomakehurst.wiremock.http.Response transform(Request request,\n+                                                                           com.github.tomakehurst.wiremock.http.Response response,\n+                                                                           FileSource fileSource,\n+                                                                           Parameters parameters) {\n+\n+                if (!request.getUrl().endsWith(resourceEndpoint) && !request.getUrl().endsWith(operationEndpoint)) {\n+                    return new com.github.tomakehurst.wiremock.http.Response.Builder()\n+                        .status(500)\n+                        .body(\"Unsupported path:\" + request.getUrl())\n+                        .build();\n+                }\n+                if (request.getMethod().isOneOf(RequestMethod.PUT)) {\n+                    // accept response\n+                    return new com.github.tomakehurst.wiremock.http.Response.Builder()\n+                        .headers(new HttpHeaders(\n+                            new HttpHeader(\"Azure-AsyncOperation\", request.getAbsoluteUrl().replace(resourceEndpoint, operationEndpoint))))\n+                        .body(toJson(new FooWithProvisioningState(\"Creating\")))\n+                        .status(201)\n+                        .build();\n+                }\n+                if (request.getMethod().isOneOf(RequestMethod.GET)) {\n+                    if (request.getUrl().endsWith(operationEndpoint)) {\n+                        getCallCount[0]++;\n+                        if (getCallCount[0] < serverConfigure.pollingCountTillSuccess) {\n+                            return new com.github.tomakehurst.wiremock.http.Response.Builder()\n+                                .body(\"{\\\"status\\\": \\\"InProgress\\\"}\")\n+                                .build();\n+                        } else if (getCallCount[0] == serverConfigure.pollingCountTillSuccess) {\n+                            return new com.github.tomakehurst.wiremock.http.Response.Builder()\n+                                .body(\"{\\\"status\\\": \\\"Succeeded\\\"}\")\n+                                .build();\n+                        }\n+                    } else if (request.getUrl().endsWith(resourceEndpoint) && getCallCount[0] == serverConfigure.pollingCountTillSuccess) {\n+                        // final resource\n+                        return new com.github.tomakehurst.wiremock.http.Response.Builder()\n+                            .body(toJson(new FooWithProvisioningState(\"Succeeded\", UUID.randomUUID().toString())))\n+                            .build();\n+                    } else {\n+                        return new com.github.tomakehurst.wiremock.http.Response.Builder()\n+                            .status(400)\n+                            .body(\"Invalid state:\" + request.getUrl())\n+                            .build();\n+                    }\n+                }\n+                return response;\n+            }\n+\n+            @Override\n+            public String getName() {\n+                return \"LroService\";\n+            }\n+        };\n+\n+        WireMockServer lroServer = createServer(provisioningStateLroService, resourceEndpoint, operationEndpoint);\n+        lroServer.start();\n+\n+        try {\n+            final ProvisioningStateLroServiceClient client = RestProxy.create(ProvisioningStateLroServiceClient.class,\n+                createHttpPipeline(lroServer.port()),\n+                SERIALIZER);\n+\n+            PollerFlux<PollResult<FooWithProvisioningState>, FooWithProvisioningState> lroFlux\n+                = PollerFactory.create(SERIALIZER,\n+                new HttpPipelineBuilder().build(),\n+                FooWithProvisioningState.class,\n+                FooWithProvisioningState.class,\n+                POLLING_DURATION,\n+                newLroInitFunction(client));\n+\n+            int[] onNextCallCount = new int[1];\n+            AsyncPollResponse<PollResult<FooWithProvisioningState>, FooWithProvisioningState> pollResponse = lroFlux.doOnNext(response -> {\n+                PollResult<FooWithProvisioningState> pollResult = response.getValue();\n+                Assertions.assertNotNull(pollResult);\n+                Assertions.assertNotNull(pollResult.getValue());\n+                onNextCallCount[0]++;\n+                if (onNextCallCount[0] == 1) {\n+                    Assertions.assertEquals(LongRunningOperationStatus.IN_PROGRESS,\n+                        response.getStatus());\n+                } else if (onNextCallCount[0] == 2) {\n+                    Assertions.assertEquals(LongRunningOperationStatus.SUCCESSFULLY_COMPLETED,\n+                        response.getStatus());\n+                } else {\n+                    throw new IllegalStateException(\"Poller emitted more than expected value.\");\n+                }\n+            }).blockLast();\n+\n+            FooWithProvisioningState foo = pollResponse.getFinalResult().block();\n+            Assertions.assertNotNull(foo.getResourceId());\n+            Assertions.assertEquals(\"Succeeded\", foo.getProvisioningState());\n+        } finally {\n+            if (lroServer.isRunning()) {\n+                lroServer.shutdown();\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void lroBasedOnAsyncOperationFailed() {\n+        ServerConfigure serverConfigure = new ServerConfigure();\n+\n+        final String resourceEndpoint = \"/resource/1\";\n+        final String operationEndpoint = \"/operations/1\";\n+        ResponseTransformer provisioningStateLroService = new ResponseTransformer() {\n+            private final int[] getCallCount = new int[1];\n+\n+            @Override\n+            public com.github.tomakehurst.wiremock.http.Response transform(Request request,\n+                                                                           com.github.tomakehurst.wiremock.http.Response response,\n+                                                                           FileSource fileSource,\n+                                                                           Parameters parameters) {\n+\n+                if (!request.getUrl().endsWith(resourceEndpoint) && !request.getUrl().endsWith(operationEndpoint)) {\n+                    return new com.github.tomakehurst.wiremock.http.Response.Builder()\n+                        .status(500)\n+                        .body(\"Unsupported path:\" + request.getUrl())\n+                        .build();\n+                }\n+                if (request.getMethod().isOneOf(RequestMethod.PUT)) {\n+                    // accept response\n+                    return new com.github.tomakehurst.wiremock.http.Response.Builder()\n+                        .headers(new HttpHeaders(\n+                            new HttpHeader(\"Azure-AsyncOperation\", request.getAbsoluteUrl().replace(resourceEndpoint, operationEndpoint))))\n+                        .body(toJson(new FooWithProvisioningState(\"Creating\")))\n+                        .status(201)\n+                        .build();\n+                }\n+                if (request.getMethod().isOneOf(RequestMethod.GET)) {\n+                    if (request.getUrl().endsWith(operationEndpoint)) {\n+                        getCallCount[0]++;\n+                        if (getCallCount[0] < serverConfigure.pollingCountTillSuccess) {\n+                            return new com.github.tomakehurst.wiremock.http.Response.Builder()\n+                                .body(\"{\\\"status\\\": \\\"InProgress\\\"}\")\n+                                .build();\n+                        } else if (getCallCount[0] == serverConfigure.pollingCountTillSuccess) {\n+                            return new com.github.tomakehurst.wiremock.http.Response.Builder()\n+                                .body(\"{\\\"status\\\": \\\"Failed\\\"}\")\n+                                .build();\n+                        }\n+                    } else {\n+                        return new com.github.tomakehurst.wiremock.http.Response.Builder()\n+                            .status(400)\n+                            .body(\"Invalid state:\" + request.getUrl())\n+                            .build();\n+                    }\n+                }\n+                return response;\n+            }\n+\n+            @Override\n+            public String getName() {\n+                return \"LroService\";\n+            }\n+        };\n+\n+        WireMockServer lroServer = createServer(provisioningStateLroService, resourceEndpoint, operationEndpoint);\n+        lroServer.start();\n+\n+        try {\n+            final ProvisioningStateLroServiceClient client = RestProxy.create(ProvisioningStateLroServiceClient.class,\n+                createHttpPipeline(lroServer.port()),\n+                SERIALIZER);\n+\n+            PollerFlux<PollResult<FooWithProvisioningState>, FooWithProvisioningState> lroFlux\n+                = PollerFactory.create(SERIALIZER,\n+                new HttpPipelineBuilder().build(),\n+                FooWithProvisioningState.class,\n+                FooWithProvisioningState.class,\n+                POLLING_DURATION,\n+                newLroInitFunction(client));\n+\n+            int[] onNextCallCount = new int[1];\n+            AsyncPollResponse<PollResult<FooWithProvisioningState>, FooWithProvisioningState> pollResponse = lroFlux.doOnNext(response -> {\n+                PollResult<FooWithProvisioningState> pollResult = response.getValue();\n+                Assertions.assertNotNull(pollResult);\n+                onNextCallCount[0]++;\n+                if (onNextCallCount[0] == 1) {\n+                    Assertions.assertNotNull(pollResult.getValue());\n+                    Assertions.assertEquals(LongRunningOperationStatus.IN_PROGRESS,\n+                        response.getStatus());\n+                } else if (onNextCallCount[0] == 2) {\n+                    Assertions.assertEquals(LongRunningOperationStatus.FAILED,\n+                        response.getStatus());\n+                } else {\n+                    throw new IllegalStateException(\"Poller emitted more than expected value.\");\n+                }\n+            }).blockLast();\n+\n+            Assertions.assertEquals(LongRunningOperationStatus.FAILED, pollResponse.getStatus());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39896ae5ac87ab1345e25c7508c85de460e1922e"}, "originalPosition": 201}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8f1a3609754678eb0fdd246f94ed607bde7f8f", "author": {"user": {"login": "weidongxu-microsoft", "name": "Weidong Xu"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ae8f1a3609754678eb0fdd246f94ed607bde7f8f", "committedDate": "2020-06-24T15:58:18Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NzM3Mzkw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12484#pullrequestreview-438737390", "createdAt": "2020-06-28T02:21:34Z", "commit": {"oid": "ae8f1a3609754678eb0fdd246f94ed607bde7f8f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NzgwNzg0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12484#pullrequestreview-438780784", "createdAt": "2020-06-28T13:31:26Z", "commit": {"oid": "ae8f1a3609754678eb0fdd246f94ed607bde7f8f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a05db2c8473549f6c30a5a4ad587cb368065b3c5", "author": {"user": {"login": "weidongxu-microsoft", "name": "Weidong Xu"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a05db2c8473549f6c30a5a4ad587cb368065b3c5", "committedDate": "2020-06-29T02:01:43Z", "message": "add constructor to ManagementError"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2910, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}