{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NTQ3NzA5", "number": 14163, "title": "Performance: Optimization for master-key authentication", "bodyText": "Key optimizations cover yields 0.3% CPU\n\nReusing the mac instances\nUse object == to avoid hash computation\n\nBaseline:\n\nWith optimization:", "createdAt": "2020-08-17T02:46:56Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14163", "merged": true, "mergeCommit": {"oid": "a7fa438881b2791595a5343f3be4d3cbcbaa167d"}, "closed": true, "closedAt": "2020-08-19T18:55:30Z", "author": {"login": "kirankumarkolli"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_n688AH2gAyNDY4NTQ3NzA5Ojk4ZjczZjM2ZmQwY2FlNzZmMTQ4ODI1Yzk5M2E4ZjE2ZTE3NjQyOWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAe-mnAH2gAyNDY4NTQ3NzA5OmRiZjZiOTQ1NTgyOTBlNmVkYjU2MDEwOGJhODE1MjRhOGFlMzkwMzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "98f73f36fd0cae76f148825c993a8f16e176429d", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/98f73f36fd0cae76f148825c993a8f16e176429d", "committedDate": "2020-08-17T01:14:00Z", "message": "BasuAuthorizationProvider credential update/refresh bug fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fa6e516e9b0013eaf44d172dfb127dcf2924dc2", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2fa6e516e9b0013eaf44d172dfb127dcf2924dc2", "committedDate": "2020-08-17T01:29:25Z", "message": "BaseAuthCredential authorization performance fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9575951bccac413ff3a5eb5a97e6a39efdead62a", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9575951bccac413ff3a5eb5a97e6a39efdead62a", "committedDate": "2020-08-17T01:31:30Z", "message": "Class code doc refresh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80e7385faea38c023a4ab0048de9bd0e6e6b1ccb", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/80e7385faea38c023a4ab0048de9bd0e6e6b1ccb", "committedDate": "2020-08-17T01:33:06Z", "message": "Always fall back the cached instance part."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a8acad4d05012f45c4f78c388eda34bb2a49eed", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2a8acad4d05012f45c4f78c388eda34bb2a49eed", "committedDate": "2020-08-17T02:44:27Z", "message": "Modeled as a new MacPooler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "922278a3a7d7c51dfd3ca9b6a8352ee3d16e51c4", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/922278a3a7d7c51dfd3ca9b6a8352ee3d16e51c4", "committedDate": "2020-08-17T04:37:39Z", "message": "BaseAuthCredential authorization performance fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c175551e28eebb2a57f0fadafbbb3cf8db801bae", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c175551e28eebb2a57f0fadafbbb3cf8db801bae", "committedDate": "2020-08-17T04:37:39Z", "message": "Class code doc refresh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f39b442723afb82dd6cae724409e93667c43dff7", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f39b442723afb82dd6cae724409e93667c43dff7", "committedDate": "2020-08-17T04:37:39Z", "message": "Modeled as a new MacPooler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MTYxNjg4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14163#pullrequestreview-468161688", "createdAt": "2020-08-17T04:47:39Z", "commit": {"oid": "2a8acad4d05012f45c4f78c388eda34bb2a49eed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNDo0NzozOVrOHBZkwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNDo0NzozOVrOHBZkwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIyOTYzMw==", "bodyText": "SpotBugs cribbing, @kushagraThapar, @moderakh how to suppress this warning?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14163#discussion_r471229633", "createdAt": "2020-08-17T04:47:39Z", "author": {"login": "kirankumarkolli"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/BaseAuthorizationTokenProvider.java", "diffHunk": "@@ -237,38 +239,44 @@ private String generateKeyAuthorizationSignatureNew(RequestVerb verb, String res\n \n         String authResourceId = getAuthorizationResourceIdOrFullName(resourceType, resourceIdValue);\n         String payLoad = generateMessagePayload(verb, authResourceId, resourceType, headers);\n-        Mac mac = this.getMacInstance();\n-        byte[] digest = mac.doFinal(payLoad.getBytes(StandardCharsets.UTF_8));\n-        String authorizationToken = Utils.encodeBase64String(digest);\n-        String authtoken = AUTH_PREFIX + authorizationToken;\n-        return HttpUtils.urlEncode(authtoken);\n+\n+        MacPool.ReUsableMac macInstance = this.getReUseableMacInstance();\n+\n+        try {\n+            byte[] digest = macInstance.get().doFinal(payLoad.getBytes(StandardCharsets.UTF_8));\n+            String authorizationToken = Utils.encodeBase64String(digest);\n+            String authtoken = AUTH_PREFIX + authorizationToken;\n+            return HttpUtils.urlEncode(authtoken);\n+        }\n+        finally {\n+            macInstance.close();\n+        }\n     }\n \n-    private Mac getMacInstance() {\n-        int masterKeyLatestHashCode = this.credential.getKey().hashCode();\n-\n-        //  Master key has changed, or this is the first time we are getting mac instance\n-        if (masterKeyLatestHashCode != this.masterKeyHashCode) {\n-            byte[] masterKeyBytes = this.credential.getKey().getBytes(StandardCharsets.UTF_8);\n-            byte[] masterKeyDecodedBytes = Utils.Base64Decoder.decode(masterKeyBytes);\n-            SecretKey signingKey = new SecretKeySpec(masterKeyDecodedBytes, \"HMACSHA256\");\n-            try {\n-                Mac macInstance = Mac.getInstance(\"HMACSHA256\");\n-                macInstance.init(signingKey);\n-                //  Update the master key hash code\n-                this.masterKeyHashCode = masterKeyLatestHashCode;\n-                return macInstance;\n-            } catch (NoSuchAlgorithmException | InvalidKeyException e) {\n-                throw new IllegalStateException(e);\n-            }\n-        } else {\n-            //  Master key hasn't changed, return the cloned mac instance\n-            try {\n-                return (Mac)this.macInstance.clone();\n-            } catch (CloneNotSupportedException e) {\n-                throw new IllegalStateException(e);\n+    private MacPool.ReUsableMac getReUseableMacInstance() {\n+\n+        // Java == operator is reference equals not content\n+        // leveraging reference comparison avoid hash computation\n+        if (this.currentCredentialKey != this.credential.getKey()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a8acad4d05012f45c4f78c388eda34bb2a49eed"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50c2f1c66b50127eb853e81600386db60d3ebec7", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/50c2f1c66b50127eb853e81600386db60d3ebec7", "committedDate": "2020-08-17T18:49:55Z", "message": "Merge branch 'master' into users/kirankk/credential_change_fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30ec84de60d1c1e0ce3940fd94914be7c2ed68cb", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/30ec84de60d1c1e0ce3940fd94914be7c2ed68cb", "committedDate": "2020-08-19T09:18:15Z", "message": "Little more refractoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca56f96945f53384c856c81d08519694754251c1", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ca56f96945f53384c856c81d08519694754251c1", "committedDate": "2020-08-19T09:19:01Z", "message": "Merge branch 'master' into users/kirankk/credential_change_fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bec6155818c346bd21fee62987a891e06c7c015d", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bec6155818c346bd21fee62987a891e06c7c015d", "committedDate": "2020-08-19T09:23:31Z", "message": "Merge branch 'users/kirankk/base_auth_perf_fixes' of https://github.com/Azure/azure-sdk-for-java into users/kirankk/base_auth_perf_fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a861ab08c581c1e39be2660c74943af89c349dd", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3a861ab08c581c1e39be2660c74943af89c349dd", "committedDate": "2020-08-19T09:31:08Z", "message": "Merge branch 'users/kirankk/credential_change_fix' into users/kirankk/base_auth_perf_fixes\n\n# Conflicts:\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/BaseAuthorizationTokenProvider.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjgwMzk1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14163#pullrequestreview-470680395", "createdAt": "2020-08-19T17:17:14Z", "commit": {"oid": "3a861ab08c581c1e39be2660c74943af89c349dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoxNzoxNFrOHDRqnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoxNzoxNFrOHDRqnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5NzIxNQ==", "bodyText": "Using MacPool is a very nice change.\nhowever now mac.clone() overhead is replaced by a ConcurrentLinkedQueue synchrnozation lock overhead. most likely better perf.\non the perf comparison do we know how much of perf gain we have from this?\nYou can do micro-benchmarking using jmh (just for the authorization part) I have the jmh project template here:\nhttps://github.com/moderakh/azure-cosmosdb-benchmark/tree/master/jmh", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14163#discussion_r473197215", "createdAt": "2020-08-19T17:17:14Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/MacPool.java", "diffHunk": "@@ -0,0 +1,59 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation;\n+\n+import javax.crypto.Mac;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+class MacPool {\n+    final Mac macInstance;\n+    final ConcurrentLinkedQueue<Mac> pool;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a861ab08c581c1e39be2660c74943af89c349dd"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjgxMzcz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14163#pullrequestreview-470681373", "createdAt": "2020-08-19T17:18:35Z", "commit": {"oid": "3a861ab08c581c1e39be2660c74943af89c349dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e00efe1667aea231a31f76abbec00bc17f4448c1", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e00efe1667aea231a31f76abbec00bc17f4448c1", "committedDate": "2020-08-19T17:21:28Z", "message": "Merge branch 'master' into users/kirankk/base_auth_perf_fixes\n\n# Conflicts:\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/BaseAuthorizationTokenProvider.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbf6b94558290e6edb560108ba81524a8ae39032", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/dbf6b94558290e6edb560108ba81524a8ae39032", "committedDate": "2020-08-19T17:22:46Z", "message": "Excluding spot-bug"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 406, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}