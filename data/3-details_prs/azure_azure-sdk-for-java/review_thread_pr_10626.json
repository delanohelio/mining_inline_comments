{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExMTEyNTMy", "number": 10626, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDoxNToxMVrOD34glA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNzo1NToxOVrOD37tsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5OTI0MTE2OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/rest/RestProxy.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDoxNToxMVrOGOZCtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDozNjoyNVrOGOZVXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MzU0Mg==", "bodyText": "just curious, is this issue happens due to one of these operators eagerly subscribing? or something else?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#discussion_r417743542", "createdAt": "2020-04-30T04:15:11Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/rest/RestProxy.java", "diffHunk": "@@ -135,38 +135,40 @@ public Object invoke(Object proxy, final Method method, Object[] args) {\n         }\n     }\n \n-    private Flux<ByteBuffer> validateLength(final HttpRequest request) {\n+    static Flux<ByteBuffer> validateLength(final HttpRequest request) {\n         final Flux<ByteBuffer> bbFlux = request.getBody();\n         if (bbFlux == null) {\n             return Flux.empty();\n         }\n \n         long expectedLength = Long.parseLong(request.getHeaders().getValue(\"Content-Length\"));\n-        final long[] currentTotalLength = new long[1];\n \n-        return Flux.concat(bbFlux, Flux.just(VALIDATION_BUFFER)).handle((buffer, sink) -> {\n-            if (buffer == null) {\n-                return;\n-            }\n+        return Flux.defer(() -> {\n+            final long[] currentTotalLength = new long[1];\n+            return Flux.concat(bbFlux, Flux.just(VALIDATION_BUFFER)).handle((buffer, sink) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1d7e19398317f2f1016bc9788297e28e76e8b9c"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0ODMxOQ==", "bodyText": "I see the state variables were getting shared across subscriptions on request content.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#discussion_r417748319", "createdAt": "2020-04-30T04:36:25Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/rest/RestProxy.java", "diffHunk": "@@ -135,38 +135,40 @@ public Object invoke(Object proxy, final Method method, Object[] args) {\n         }\n     }\n \n-    private Flux<ByteBuffer> validateLength(final HttpRequest request) {\n+    static Flux<ByteBuffer> validateLength(final HttpRequest request) {\n         final Flux<ByteBuffer> bbFlux = request.getBody();\n         if (bbFlux == null) {\n             return Flux.empty();\n         }\n \n         long expectedLength = Long.parseLong(request.getHeaders().getValue(\"Content-Length\"));\n-        final long[] currentTotalLength = new long[1];\n \n-        return Flux.concat(bbFlux, Flux.just(VALIDATION_BUFFER)).handle((buffer, sink) -> {\n-            if (buffer == null) {\n-                return;\n-            }\n+        return Flux.defer(() -> {\n+            final long[] currentTotalLength = new long[1];\n+            return Flux.concat(bbFlux, Flux.just(VALIDATION_BUFFER)).handle((buffer, sink) -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MzU0Mg=="}, "originalCommit": {"oid": "f1d7e19398317f2f1016bc9788297e28e76e8b9c"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5OTc2NjI2OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core/src/test/java/com/azure/core/http/rest/RestProxyTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNzo1NToxOVrOGOd8Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNjoyNjo0NFrOGOw-WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgyMzgwMw==", "bodyText": "Would be better to validate the error message as well as that is what we will use to debug issues.\n        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"4\")))\n            .verifyErrorSatisfies(throwable -> {\n                    assertTrue(throwable instanceof UnexpectedLengthException);\n                    assertTrue(throwable.getMessage().equals(\"Request body emitted 4 bytes, less than the expected 5 bytes.\"\n            });\n\n        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"6\")))\n            .verifyErrorSatisfies(throwable -> {\n                    assertTrue(throwable instanceof UnexpectedLengthException);\n                    assertTrue(throwable.getMessage().equals(\"Request body emitted 6 bytes, more than the expected 5 bytes.\"\n            });", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#discussion_r417823803", "createdAt": "2020-04-30T07:55:19Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core/src/test/java/com/azure/core/http/rest/RestProxyTests.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.rest;\n+\n+import com.azure.core.exception.UnexpectedLengthException;\n+import com.azure.core.http.HttpMethod;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.util.FluxUtil;\n+import org.junit.jupiter.api.Test;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+import reactor.test.StepVerifier;\n+\n+import java.nio.ByteBuffer;\n+\n+import static org.junit.jupiter.api.Assertions.assertArrayEquals;\n+\n+/**\n+ * Tests {@link RestProxy}.\n+ */\n+public class RestProxyTests {\n+    private static final byte[] EXPECTED = new byte[] { 0, 1, 2, 3, 4 };\n+\n+    @Test\n+    public void emptyRequestBody() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\");\n+\n+        StepVerifier.create(RestProxy.validateLength(httpRequest))\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    public void expectedBodyLength() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\")\n+            .setBody(EXPECTED)\n+            .setHeader(\"Content-Length\", \"5\");\n+\n+        StepVerifier.create(collectRequest(httpRequest))\n+            .assertNext(bytes -> assertArrayEquals(EXPECTED, bytes))\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    public void unexpectedBodyLength() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\")\n+            .setBody(EXPECTED);\n+\n+        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"4\")))\n+            .verifyError(UnexpectedLengthException.class);\n+\n+        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"6\")))\n+            .verifyError(UnexpectedLengthException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1d7e19398317f2f1016bc9788297e28e76e8b9c"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzNTY0MA==", "bodyText": "Added", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#discussion_r418135640", "createdAt": "2020-04-30T16:26:44Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core/src/test/java/com/azure/core/http/rest/RestProxyTests.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.rest;\n+\n+import com.azure.core.exception.UnexpectedLengthException;\n+import com.azure.core.http.HttpMethod;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.util.FluxUtil;\n+import org.junit.jupiter.api.Test;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+import reactor.test.StepVerifier;\n+\n+import java.nio.ByteBuffer;\n+\n+import static org.junit.jupiter.api.Assertions.assertArrayEquals;\n+\n+/**\n+ * Tests {@link RestProxy}.\n+ */\n+public class RestProxyTests {\n+    private static final byte[] EXPECTED = new byte[] { 0, 1, 2, 3, 4 };\n+\n+    @Test\n+    public void emptyRequestBody() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\");\n+\n+        StepVerifier.create(RestProxy.validateLength(httpRequest))\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    public void expectedBodyLength() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\")\n+            .setBody(EXPECTED)\n+            .setHeader(\"Content-Length\", \"5\");\n+\n+        StepVerifier.create(collectRequest(httpRequest))\n+            .assertNext(bytes -> assertArrayEquals(EXPECTED, bytes))\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    public void unexpectedBodyLength() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\")\n+            .setBody(EXPECTED);\n+\n+        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"4\")))\n+            .verifyError(UnexpectedLengthException.class);\n+\n+        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"6\")))\n+            .verifyError(UnexpectedLengthException.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgyMzgwMw=="}, "originalCommit": {"oid": "f1d7e19398317f2f1016bc9788297e28e76e8b9c"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4381, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}