{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NzYyNzkz", "number": 14237, "title": "Add user agent info to ADT client, miscellaneous builder improvements", "bodyText": "User agent looks like: \"User-Agent=azsdk-java-azure-digitaltwins-core/1.0.0-beta.1 (1.8.0_201; Windows 10; 10.0)\" when run from a windows 10 machine.\nSee inline below for my notes on the other small changes in this PR", "createdAt": "2020-08-18T21:45:04Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237", "merged": true, "mergeCommit": {"oid": "63b28896217a0dc63935b5129f16a00db93477a2"}, "closed": true, "closedAt": "2020-08-19T18:19:14Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAOHeKAH2gAyNDY5NzYyNzkzOjU4YjE1ZDA5ODc5MjBmNWMwMTY4M2I2NmQ2NjFmNzdmMjI4OWNmNzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAf5HugFqTQ3MDcyOTg1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "58b15d0987920f5c01683b66d661f77f2289cf79", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/58b15d0987920f5c01683b66d661f77f2289cf79", "committedDate": "2020-08-18T21:44:04Z", "message": "Add user agent info to ADT client, miscellaneous builder improvements\n\nUser agent looks like: \"User-Agent=azsdk-java-azure-digitaltwins-core/1.0.0-beta.1 (1.8.0_201; Windows 10; 10.0)\" when run from a windows 10 machine"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODUzMzA2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-469853306", "createdAt": "2020-08-18T21:46:15Z", "commit": {"oid": "58b15d0987920f5c01683b66d661f77f2289cf79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo0NjoxNVrOHCn0bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo0NjoxNVrOHCn0bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMTU5OQ==", "bodyText": "This works in the sync client, but not in the async client. We'll still need the java autorest team to fix their bug so that the protocol layer actually returns the expected type", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472511599", "createdAt": "2020-08-18T21:46:15Z", "author": {"login": "timtay-microsoft"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClient.java", "diffHunk": "@@ -53,7 +54,7 @@ public DigitalTwinsServiceVersion getServiceVersion() {\n     // this annotation lets users know this method makes a call to the service and whether it returns a single resource or a collection of resources\n     @ServiceMethod(returns = ReturnType.SINGLE)\n     // TODO This is just a temporary implementation for test purposes. This should be spruced up/replaced once this API is actually designed\n-    public DigitalTwinsGetByIdResponse getDigitalTwin(String digitalTwinId) {\n+    public Response<Object> getDigitalTwin(String digitalTwinId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58b15d0987920f5c01683b66d661f77f2289cf79"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODU0MDc1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-469854075", "createdAt": "2020-08-18T21:47:43Z", "commit": {"oid": "58b15d0987920f5c01683b66d661f77f2289cf79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo0Nzo0M1rOHCn3FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo0Nzo0M1rOHCn3FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMjI3Ng==", "bodyText": "Adding these explicitly even though they are default values so that if/when we add support for retry-after headers, it is easy to figure out that the Azure Core RetryPolicy class handles that for us as long as we tell it what our service sends as the header name and time unit", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472512276", "createdAt": "2020-08-18T21:47:43Z", "author": {"login": "timtay-microsoft"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the sdk's name and version for use in the user agent string\n+    private static final String SDK_NAME = \"name\";\n+    private static final String SDK_VERSION = \"version\";\n+\n+    private final List<HttpPipelinePolicy> additionalPolicies;\n+\n     // mandatory\n     private String endpoint;\n     private TokenCredential tokenCredential;\n+\n     // optional/have default values\n     private DigitalTwinsServiceVersion serviceVersion;\n     private HttpPipeline httpPipeline;\n     private HttpClient httpClient;\n-    private HttpLogOptions logOptions;\n-    private RetryPolicy retryPolicy;\n+    private HttpLogOptions httpLogOptions;\n+    private HttpPipelinePolicy retryPolicy;\n+\n+    // Right now, Azure Digital Twins does not send a retry-after header on its throttling messages. If it adds support later, then\n+    // these values should match the header name (for instance, \"x-ms-retry-after-ms\" or \"Retry-After\") and the time unit\n+    // of the header's value. These null values are equivalent to just constructing \"new RetryPolicy()\"\n+    private static final String retryAfterHeader = null;\n+    private static final ChronoUnit retryAfterTimeUnit = null;\n+    private static final RetryPolicy DEFAULT_RETRY_POLICY = new RetryPolicy(retryAfterHeader, retryAfterTimeUnit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58b15d0987920f5c01683b66d661f77f2289cf79"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODU0MjYy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-469854262", "createdAt": "2020-08-18T21:48:06Z", "commit": {"oid": "58b15d0987920f5c01683b66d661f77f2289cf79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo0ODowNlrOHCn3qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo0ODowNlrOHCn3qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMjQyNg==", "bodyText": "Adding a default constructor so that we don't forget it exists, and also to assign some default values", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472512426", "createdAt": "2020-08-18T21:48:06Z", "author": {"login": "timtay-microsoft"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the sdk's name and version for use in the user agent string\n+    private static final String SDK_NAME = \"name\";\n+    private static final String SDK_VERSION = \"version\";\n+\n+    private final List<HttpPipelinePolicy> additionalPolicies;\n+\n     // mandatory\n     private String endpoint;\n     private TokenCredential tokenCredential;\n+\n     // optional/have default values\n     private DigitalTwinsServiceVersion serviceVersion;\n     private HttpPipeline httpPipeline;\n     private HttpClient httpClient;\n-    private HttpLogOptions logOptions;\n-    private RetryPolicy retryPolicy;\n+    private HttpLogOptions httpLogOptions;\n+    private HttpPipelinePolicy retryPolicy;\n+\n+    // Right now, Azure Digital Twins does not send a retry-after header on its throttling messages. If it adds support later, then\n+    // these values should match the header name (for instance, \"x-ms-retry-after-ms\" or \"Retry-After\") and the time unit\n+    // of the header's value. These null values are equivalent to just constructing \"new RetryPolicy()\"\n+    private static final String retryAfterHeader = null;\n+    private static final ChronoUnit retryAfterTimeUnit = null;\n+    private static final RetryPolicy DEFAULT_RETRY_POLICY = new RetryPolicy(retryAfterHeader, retryAfterTimeUnit);\n+\n+    private final Map<String, String> properties;\n+\n+    private Configuration configuration;\n+\n+    public DigitalTwinsClientBuilder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58b15d0987920f5c01683b66d661f77f2289cf79"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODU0NjI2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-469854626", "createdAt": "2020-08-18T21:48:45Z", "commit": {"oid": "58b15d0987920f5c01683b66d661f77f2289cf79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo0ODo0NVrOHCn4yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo0ODo0NVrOHCn4yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMjcxNQ==", "bodyText": "These values come from azure-digital-twins.properties file that is added in this PR", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472512715", "createdAt": "2020-08-18T21:48:45Z", "author": {"login": "timtay-microsoft"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the sdk's name and version for use in the user agent string\n+    private static final String SDK_NAME = \"name\";\n+    private static final String SDK_VERSION = \"version\";\n+\n+    private final List<HttpPipelinePolicy> additionalPolicies;\n+\n     // mandatory\n     private String endpoint;\n     private TokenCredential tokenCredential;\n+\n     // optional/have default values\n     private DigitalTwinsServiceVersion serviceVersion;\n     private HttpPipeline httpPipeline;\n     private HttpClient httpClient;\n-    private HttpLogOptions logOptions;\n-    private RetryPolicy retryPolicy;\n+    private HttpLogOptions httpLogOptions;\n+    private HttpPipelinePolicy retryPolicy;\n+\n+    // Right now, Azure Digital Twins does not send a retry-after header on its throttling messages. If it adds support later, then\n+    // these values should match the header name (for instance, \"x-ms-retry-after-ms\" or \"Retry-After\") and the time unit\n+    // of the header's value. These null values are equivalent to just constructing \"new RetryPolicy()\"\n+    private static final String retryAfterHeader = null;\n+    private static final ChronoUnit retryAfterTimeUnit = null;\n+    private static final RetryPolicy DEFAULT_RETRY_POLICY = new RetryPolicy(retryAfterHeader, retryAfterTimeUnit);\n+\n+    private final Map<String, String> properties;\n+\n+    private Configuration configuration;\n+\n+    public DigitalTwinsClientBuilder()\n+    {\n+        additionalPolicies = new ArrayList<>();\n+        properties = CoreUtils.getProperties(DIGITAL_TWINS_PROPERTIES);\n+        httpLogOptions = new HttpLogOptions();\n+    }\n \n     private static HttpPipeline buildPipeline(TokenCredential tokenCredential, String endpoint,\n-                                              HttpLogOptions logOptions, HttpClient httpClient,\n-                                              List<HttpPipelinePolicy> additionalPolicies, RetryPolicy retryPolicy) {\n+                                              HttpLogOptions httpLogOptions, HttpClient httpClient,\n+                                              List<HttpPipelinePolicy> additionalPolicies, HttpPipelinePolicy retryPolicy,\n+                                              Configuration configuration, Map<String, String> properties) {\n         // Closest to API goes first, closest to wire goes last.\n         List<HttpPipelinePolicy> policies = new ArrayList<>();\n \n+        String clientName = properties.getOrDefault(SDK_NAME, \"UnknownName\");\n+        String clientVersion = properties.getOrDefault(SDK_VERSION, \"UnknownVersion\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58b15d0987920f5c01683b66d661f77f2289cf79"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6b54312f49d12decfa2b84ebd72dd529ef5845f", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d6b54312f49d12decfa2b84ebd72dd529ef5845f", "committedDate": "2020-08-18T21:49:14Z", "message": "squash"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODU1NDY4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-469855468", "createdAt": "2020-08-18T21:50:20Z", "commit": {"oid": "d6b54312f49d12decfa2b84ebd72dd529ef5845f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo1MDoyMFrOHCn7pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo1MDoyMFrOHCn7pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMzQ0NQ==", "bodyText": "In the configurations client code, their builder never overwrites the values of the instance variables in the builder. Instead it creates local copies that can be altered instead", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472513445", "createdAt": "2020-08-18T21:50:20Z", "author": {"login": "timtay-microsoft"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -106,21 +139,39 @@ public DigitalTwinsAsyncClient buildAsyncClient() {\n         Objects.requireNonNull(tokenCredential, \"'tokenCredential' cannot be null.\");\n         Objects.requireNonNull(endpoint, \"'endpoint' cannot be null\");\n \n+        Configuration buildConfiguration = this.configuration;\n+        if (buildConfiguration == null)\n+        {\n+            buildConfiguration = Configuration.getGlobalConfiguration().clone();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6b54312f49d12decfa2b84ebd72dd529ef5845f"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODU1OTIx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-469855921", "createdAt": "2020-08-18T21:51:15Z", "commit": {"oid": "d6b54312f49d12decfa2b84ebd72dd529ef5845f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo1MToxNVrOHCn9IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo1MToxNVrOHCn9IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMzgyNA==", "bodyText": "\"azure-digitaltwins-core\" and \"1.0.0-beta.1\" as defined in the pom file right now", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472513824", "createdAt": "2020-08-18T21:51:15Z", "author": {"login": "timtay-microsoft"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/resources/azure-digital-twins.properties", "diffHunk": "@@ -0,0 +1,2 @@\n+name=${project.artifactId}\n+version=${project.version}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6b54312f49d12decfa2b84ebd72dd529ef5845f"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODU3Nzk4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-469857798", "createdAt": "2020-08-18T21:54:55Z", "commit": {"oid": "d6b54312f49d12decfa2b84ebd72dd529ef5845f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo1NDo1NVrOHCoDYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo1NDo1NVrOHCoDYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxNTQyNQ==", "bodyText": "Used for user agent string, and other functionality. See here", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r472515425", "createdAt": "2020-08-18T21:54:55Z", "author": {"login": "timtay-microsoft"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the sdk's name and version for use in the user agent string\n+    private static final String SDK_NAME = \"name\";\n+    private static final String SDK_VERSION = \"version\";\n+\n+    private final List<HttpPipelinePolicy> additionalPolicies;\n+\n     // mandatory\n     private String endpoint;\n     private TokenCredential tokenCredential;\n+\n     // optional/have default values\n     private DigitalTwinsServiceVersion serviceVersion;\n     private HttpPipeline httpPipeline;\n     private HttpClient httpClient;\n-    private HttpLogOptions logOptions;\n-    private RetryPolicy retryPolicy;\n+    private HttpLogOptions httpLogOptions;\n+    private HttpPipelinePolicy retryPolicy;\n+\n+    // Right now, Azure Digital Twins does not send a retry-after header on its throttling messages. If it adds support later, then\n+    // these values should match the header name (for instance, \"x-ms-retry-after-ms\" or \"Retry-After\") and the time unit\n+    // of the header's value. These null values are equivalent to just constructing \"new RetryPolicy()\"\n+    private static final String retryAfterHeader = null;\n+    private static final ChronoUnit retryAfterTimeUnit = null;\n+    private static final RetryPolicy DEFAULT_RETRY_POLICY = new RetryPolicy(retryAfterHeader, retryAfterTimeUnit);\n+\n+    private final Map<String, String> properties;\n+\n+    private Configuration configuration;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6b54312f49d12decfa2b84ebd72dd529ef5845f"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19271b6d12aedd9d22e03eaf7235303e89bfaafd", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/19271b6d12aedd9d22e03eaf7235303e89bfaafd", "committedDate": "2020-08-18T22:20:44Z", "message": "squash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6af2a33e6bfbbbac306e1d727194a6f9f60ea278", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6af2a33e6bfbbbac306e1d727194a6f9f60ea278", "committedDate": "2020-08-18T23:44:00Z", "message": "squash"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzA1MjM5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-470705239", "createdAt": "2020-08-19T17:51:05Z", "commit": {"oid": "6af2a33e6bfbbbac306e1d727194a6f9f60ea278"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzo1MTowNVrOHDS2vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzo1MTowNVrOHDS2vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxNjcwMg==", "bodyText": "Call it 'client library'. I have heard that feedback from the SDK architects.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473216702", "createdAt": "2020-08-19T17:51:05Z", "author": {"login": "vinagesh"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the sdk's name and version for use in the user agent string", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6af2a33e6bfbbbac306e1d727194a6f9f60ea278"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzA4Mjg3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-470708287", "createdAt": "2020-08-19T17:55:17Z", "commit": {"oid": "6af2a33e6bfbbbac306e1d727194a6f9f60ea278"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzo1NToxN1rOHDTAmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzo1NToxN1rOHDTAmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxOTIyNg==", "bodyText": "I'm not a java expert but why was 'this' removed?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473219226", "createdAt": "2020-08-19T17:55:17Z", "author": {"login": "vinagesh"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -106,21 +139,39 @@ public DigitalTwinsAsyncClient buildAsyncClient() {\n         Objects.requireNonNull(tokenCredential, \"'tokenCredential' cannot be null.\");\n         Objects.requireNonNull(endpoint, \"'endpoint' cannot be null\");\n \n+        Configuration buildConfiguration = this.configuration;\n+        if (buildConfiguration == null)\n+        {\n+            buildConfiguration = Configuration.getGlobalConfiguration().clone();\n+        }\n+\n         // Set defaults for these fields if they were not set while building the client\n-        this.serviceVersion = this.serviceVersion != null ? this.serviceVersion : DigitalTwinsServiceVersion.getLatest();\n-        this.retryPolicy = this.retryPolicy != null ? this.retryPolicy : new RetryPolicy(); // Default is exponential backoff\n+        DigitalTwinsServiceVersion serviceVersion = this.serviceVersion;\n+        if (serviceVersion == null)\n+        {\n+            serviceVersion = DigitalTwinsServiceVersion.getLatest();\n+        }\n+\n+        // Default is exponential backoff\n+        HttpPipelinePolicy retryPolicy = this.retryPolicy;\n+        if (retryPolicy == null)\n+        {\n+            retryPolicy = DEFAULT_RETRY_POLICY;\n+        }\n \n         if (this.httpPipeline == null) {\n             this.httpPipeline = buildPipeline(\n                 this.tokenCredential,\n                 this.endpoint,\n-                this.logOptions,\n+                this.httpLogOptions,\n                 this.httpClient,\n                 this.additionalPolicies,\n-                this.retryPolicy);\n+                retryPolicy,\n+                buildConfiguration,\n+                this.properties);\n         }\n \n-        return new DigitalTwinsAsyncClient(this.httpPipeline, this.serviceVersion, this.endpoint);\n+        return new DigitalTwinsAsyncClient(this.httpPipeline, serviceVersion, this.endpoint);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6af2a33e6bfbbbac306e1d727194a6f9f60ea278"}, "originalPosition": 147}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzA4NjY4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-470708668", "createdAt": "2020-08-19T17:55:47Z", "commit": {"oid": "6af2a33e6bfbbbac306e1d727194a6f9f60ea278"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aefdb18f3b5dad6baa612c7525ed17cfa7424835", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/aefdb18f3b5dad6baa612c7525ed17cfa7424835", "committedDate": "2020-08-19T18:05:06Z", "message": "squash"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzI1NTA0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-470725504", "createdAt": "2020-08-19T18:20:14Z", "commit": {"oid": "aefdb18f3b5dad6baa612c7525ed17cfa7424835"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxODoyMDoxNFrOHDT2Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxODoyMDoxNFrOHDT2Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzMjkxNQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473232915", "createdAt": "2020-08-19T18:20:14Z", "author": {"login": "abhipsaMisra"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -33,27 +30,61 @@\n     private static final Pattern ADT_PUBLIC_SCOPE_VALIDATION_PATTERN = Pattern.compile(\"(ppe|azure)\\\\.net\");\n     private static final String[] ADT_PUBLIC_SCOPE = new String[]{\"https://digitaltwins.azure.net\" + \"/.default\"};\n \n-    private final List<HttpPipelinePolicy> additionalPolicies = new ArrayList<>();\n+    // This is the name of the properties file in this repo that contains the default properties\n+    private static final String DIGITAL_TWINS_PROPERTIES = \"azure-digital-twins.properties\";\n+\n+    // These are the keys to the above properties file that define the client library's name and version for use in the user agent string\n+    private static final String SDK_NAME = \"name\";\n+    private static final String SDK_VERSION = \"version\";\n+\n+    private final List<HttpPipelinePolicy> additionalPolicies;\n+\n     // mandatory\n     private String endpoint;\n     private TokenCredential tokenCredential;\n+\n     // optional/have default values\n     private DigitalTwinsServiceVersion serviceVersion;\n     private HttpPipeline httpPipeline;\n     private HttpClient httpClient;\n-    private HttpLogOptions logOptions;\n-    private RetryPolicy retryPolicy;\n+    private HttpLogOptions httpLogOptions;\n+    private HttpPipelinePolicy retryPolicy;\n+\n+    // Right now, Azure Digital Twins does not send a retry-after header on its throttling messages. If it adds support later, then\n+    // these values should match the header name (for instance, \"x-ms-retry-after-ms\" or \"Retry-After\") and the time unit\n+    // of the header's value. These null values are equivalent to just constructing \"new RetryPolicy()\"\n+    private static final String retryAfterHeader = null;\n+    private static final ChronoUnit retryAfterTimeUnit = null;\n+    private static final RetryPolicy DEFAULT_RETRY_POLICY = new RetryPolicy(retryAfterHeader, retryAfterTimeUnit);\n+\n+    private final Map<String, String> properties;\n+\n+    private Configuration configuration;\n+\n+    public DigitalTwinsClientBuilder()\n+    {\n+        additionalPolicies = new ArrayList<>();\n+        properties = CoreUtils.getProperties(DIGITAL_TWINS_PROPERTIES);\n+        httpLogOptions = new HttpLogOptions();\n+    }\n \n     private static HttpPipeline buildPipeline(TokenCredential tokenCredential, String endpoint,\n-                                              HttpLogOptions logOptions, HttpClient httpClient,\n-                                              List<HttpPipelinePolicy> additionalPolicies, RetryPolicy retryPolicy) {\n+                                              HttpLogOptions httpLogOptions, HttpClient httpClient,\n+                                              List<HttpPipelinePolicy> additionalPolicies, HttpPipelinePolicy retryPolicy,\n+                                              Configuration configuration, Map<String, String> properties) {\n         // Closest to API goes first, closest to wire goes last.\n         List<HttpPipelinePolicy> policies = new ArrayList<>();\n \n+        String clientName = properties.getOrDefault(SDK_NAME, \"UnknownName\");\n+        String clientVersion = properties.getOrDefault(SDK_VERSION, \"UnknownVersion\");\n+\n+        policies.add(new UserAgentPolicy(httpLogOptions.getApplicationId(), clientName, clientVersion, configuration));\n+\n         // Adds a \"x-ms-client-request-id\" header to each request. This header is useful for tracing requests through Azure ecosystems\n         policies.add(new RequestIdPolicy());\n \n-        // Only the RequestIdPolicy will take effect prior to the retry policy\n+        // Only the RequestIdPolicy  and UserAgentPolicy will take effect prior to the retry policy since neither of those need\n+        // to change in any way upon retry", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aefdb18f3b5dad6baa612c7525ed17cfa7424835"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzI5ODUx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#pullrequestreview-470729851", "createdAt": "2020-08-19T18:26:41Z", "commit": {"oid": "aefdb18f3b5dad6baa612c7525ed17cfa7424835"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxODoyNjo0MVrOHDUDYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxODoyNjo0MVrOHDUDYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIzNjMyMw==", "bodyText": "Q - do we know if AddDatePolicy updates the date per retry attempt, or it updates the date for each http request made?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14237#discussion_r473236323", "createdAt": "2020-08-19T18:26:41Z", "author": {"login": "abhipsaMisra"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsClientBuilder.java", "diffHunk": "@@ -67,10 +98,12 @@ private static HttpPipeline buildPipeline(TokenCredential tokenCredential, Strin\n \n         policies.addAll(additionalPolicies);\n \n-        // Custom policies, authentication policy, and add date policy all take place after the retry policy\n+        // Custom policies, authentication policy, and add date policy all take place after the retry policy which means\n+        // they will be applied once per retry. For instance, the AddDatePolicy will add a different date time header\n+        // each time the retry is attempted.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aefdb18f3b5dad6baa612c7525ed17cfa7424835"}, "originalPosition": 98}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 445, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}