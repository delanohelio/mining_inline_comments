{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NzI4MzU1", "number": 13389, "title": "Auditing support", "bodyText": "add support for Auditing entities\ni.e. Automatic management of createdBy, createdDate, lastModifiedBy, and lastModifiedDate fields on database entities using annotations", "createdAt": "2020-07-21T20:26:44Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13389", "merged": true, "mergeCommit": {"oid": "89b8cb3f1eacf19555dbcf915441c236b4d7ae40"}, "closed": true, "closedAt": "2020-07-28T20:06:10Z", "author": {"login": "Blackbaud-EricSlater"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3QUqZAFqTQ1MjkyNzYxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5ZtT4gH2gAyNDU0NzI4MzU1OjFiMmM0NDhhZDQwMGI5NmMxMTkyNTY0OTM3ZjJlNzRiNTBiYWNkNDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTI3NjEx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13389#pullrequestreview-452927611", "createdAt": "2020-07-22T01:06:21Z", "commit": {"oid": "80e4196af425e48606e7353478b8dd21b49249b2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMTowNjoyMlrOG1PEJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMTowODo1OFrOG1PGmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3NDUzMw==", "bodyText": "This should be called - CosmosMappingContextLookup", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13389#discussion_r458474533", "createdAt": "2020-07-22T01:06:22Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/config/CosmosAuditingRegistrar.java", "diffHunk": "@@ -0,0 +1,117 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.data.cosmos.config;\n+\n+import com.azure.spring.data.cosmos.Constants;\n+import com.azure.spring.data.cosmos.core.convert.MappingCosmosConverter;\n+import com.azure.spring.data.cosmos.core.mapping.CosmosPersistentEntity;\n+import com.azure.spring.data.cosmos.core.mapping.CosmosPersistentProperty;\n+import org.springframework.beans.factory.FactoryBean;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.beans.factory.support.AbstractBeanDefinition;\n+import org.springframework.beans.factory.support.BeanDefinitionBuilder;\n+import org.springframework.beans.factory.support.BeanDefinitionRegistry;\n+import org.springframework.data.auditing.IsNewAwareAuditingHandler;\n+import org.springframework.data.auditing.config.AuditingBeanDefinitionRegistrarSupport;\n+import org.springframework.data.auditing.config.AuditingConfiguration;\n+import org.springframework.data.mapping.context.MappingContext;\n+import org.springframework.util.Assert;\n+\n+import java.lang.annotation.Annotation;\n+\n+/**\n+ * Adapted from <a href=\"https://github.com/spring-projects/spring-data-mongodb/blob/master/spring-data-mongodb\n+ * /src/main/java/org/springframework/data/mongodb/config/MongoAuditingRegistrar.java\">MongoAuditingRegistrar.java</a>\n+ */\n+class CosmosAuditingRegistrar extends AuditingBeanDefinitionRegistrarSupport {\n+\n+    /*\n+     * (non-Javadoc)\n+     * @see org.springframework.data.auditing.config.AuditingBeanDefinitionRegistrarSupport#getAnnotation()\n+     */\n+    @Override\n+    protected Class<? extends Annotation> getAnnotation() {\n+        return EnableCosmosAuditing.class;\n+    }\n+\n+    /*\n+     * (non-Javadoc)\n+     * @see org.springframework.data.auditing.config.AuditingBeanDefinitionRegistrarSupport#getAuditingHandlerBeanName()\n+     */\n+    @Override\n+    protected String getAuditingHandlerBeanName() {\n+        return Constants.AUDITING_HANDLER_BEAN_NAME;\n+    }\n+\n+    /*\n+     * (non-Javadoc)\n+     * @see org.springframework.data.auditing.config.AuditingBeanDefinitionRegistrarSupport#\n+     * getAuditHandlerBeanDefinitionBuilder(org.springframework.data.auditing.config.AuditingConfiguration)\n+     */\n+    @Override\n+    protected BeanDefinitionBuilder getAuditHandlerBeanDefinitionBuilder(AuditingConfiguration configuration) {\n+        Assert.notNull(configuration, \"AuditingConfiguration must not be null!\");\n+\n+        final BeanDefinitionBuilder builder =\n+            BeanDefinitionBuilder.rootBeanDefinition(IsNewAwareAuditingHandler.class);\n+\n+        final BeanDefinitionBuilder definition =\n+            BeanDefinitionBuilder.genericBeanDefinition(DocumentDbMappingContextLookup.class);\n+        definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_CONSTRUCTOR);\n+\n+        builder.addConstructorArgValue(definition.getBeanDefinition());\n+        return configureDefaultAuditHandlerAttributes(configuration, builder);\n+    }\n+\n+    /*\n+     * (non-Javadoc)\n+     * @see org.springframework.data.auditing.config.AuditingBeanDefinitionRegistrarSupport#\n+     * registerAuditListener(org.springframework.beans.factory.config.BeanDefinition,\n+     * org.springframework.beans.factory.support.BeanDefinitionRegistry)\n+     */\n+    @Override\n+    protected void registerAuditListenerBeanDefinition(BeanDefinition auditingHandlerDefinition,\n+                                                       BeanDefinitionRegistry registry) {\n+        // TODO: consider moving to event listener for auditing rather than injecting the\n+        // IsNewAwareAuditingHandler directly - this would require integrating CosmosTemplate with\n+        // the spring eventing system which would be a chunk of work beyond the scope of this PR\n+    }\n+\n+    static class DocumentDbMappingContextLookup implements", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80e4196af425e48606e7353478b8dd21b49249b2"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3NTE2Mw==", "bodyText": "Since all the other annotations are in com/azure/spring/data/cosmos/core/mapping/ directory, I think we should also place this class in the same directory to be consistent with other Annotations.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13389#discussion_r458475163", "createdAt": "2020-07-22T01:08:58Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/config/EnableCosmosAuditing.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80e4196af425e48606e7353478b8dd21b49249b2"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86b9d0a8b398710568f0c8cf47c3a81f194b3e1f", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/86b9d0a8b398710568f0c8cf47c3a81f194b3e1f", "committedDate": "2020-07-27T17:44:11Z", "message": "port from spring-data-cosmos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ce703f276aa0b80eeecc58674eb017cc3280863", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7ce703f276aa0b80eeecc58674eb017cc3280863", "committedDate": "2020-07-27T17:45:39Z", "message": "fix various small style and java doc issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e296d21b288548cc5a2d039ee0ccebdb8c9f820", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9e296d21b288548cc5a2d039ee0ccebdb8c9f820", "committedDate": "2020-07-27T19:33:25Z", "message": "add reactive support for auditable entities"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80e4196af425e48606e7353478b8dd21b49249b2", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/80e4196af425e48606e7353478b8dd21b49249b2", "committedDate": "2020-07-21T19:14:29Z", "message": "fix various small style and java doc issues"}, "afterCommit": {"oid": "9e296d21b288548cc5a2d039ee0ccebdb8c9f820", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9e296d21b288548cc5a2d039ee0ccebdb8c9f820", "committedDate": "2020-07-27T19:33:25Z", "message": "add reactive support for auditable entities"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9a55cc0dcb22bd1f6691393d7234bd9b6d5a137", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c9a55cc0dcb22bd1f6691393d7234bd9b6d5a137", "committedDate": "2020-07-27T20:27:58Z", "message": "add documentation explaining feature to README and include sample entity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTE5Mzgw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13389#pullrequestreview-456119380", "createdAt": "2020-07-27T20:41:55Z", "commit": {"oid": "c9a55cc0dcb22bd1f6691393d7234bd9b6d5a137"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMDo0MTo1NVrOG3yzIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMDo0OToxNFrOG3zB3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE1NzE1Mw==", "bodyText": "@Blackbaud-EricSlater Any plans on updating this class package to core/mapping ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13389#discussion_r461157153", "createdAt": "2020-07-27T20:41:55Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/config/EnableCosmosAuditing.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3NTE2Mw=="}, "originalCommit": {"oid": "80e4196af425e48606e7353478b8dd21b49249b2"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE1OTAxOQ==", "bodyText": "Because of multi-database support we have now - hard coding null in this constructor will be in-correct.\nAs in that case, this auditing feature will not work in multi-database configuration.\nSee DatabaseConfiguration.java class for more information on multi-database support example.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13389#discussion_r461159019", "createdAt": "2020-07-27T20:45:30Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/core/CosmosTemplate.java", "diffHunk": "@@ -76,7 +79,7 @@\n      */\n     public CosmosTemplate(CosmosAsyncClient client, String databaseName,\n                           CosmosConfig cosmosConfig, MappingCosmosConverter mappingCosmosConverter) {\n-        this(new CosmosFactory(client, databaseName), cosmosConfig, mappingCosmosConverter);\n+        this(new CosmosFactory(client, databaseName), cosmosConfig, mappingCosmosConverter, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9a55cc0dcb22bd1f6691393d7234bd9b6d5a137"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE2MDkyNw==", "bodyText": "Same here - support for multi-database configuration. Auditing should work in that case too.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13389#discussion_r461160927", "createdAt": "2020-07-27T20:49:14Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/core/ReactiveCosmosTemplate.java", "diffHunk": "@@ -64,7 +66,7 @@\n      */\n     public ReactiveCosmosTemplate(CosmosAsyncClient client, String databaseName,\n                                   CosmosConfig cosmosConfig, MappingCosmosConverter mappingCosmosConverter) {\n-        this(new CosmosFactory(client, databaseName), cosmosConfig, mappingCosmosConverter);\n+        this(new CosmosFactory(client, databaseName), cosmosConfig, mappingCosmosConverter, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9a55cc0dcb22bd1f6691393d7234bd9b6d5a137"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5895313224b5648ab13b57ebce71098192c85e0", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e5895313224b5648ab13b57ebce71098192c85e0", "committedDate": "2020-07-27T21:11:10Z", "message": "add missing copyright header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e0ff7b9e8e93ae473c4df8df90dfb015ccdd9c7", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5e0ff7b9e8e93ae473c4df8df90dfb015ccdd9c7", "committedDate": "2020-07-27T22:38:28Z", "message": "add constructors that support multi database configurations using auditable entities. update readme and samples"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81f3c88d1c1c047ef9e6e160e04663675ec76a9e", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/81f3c88d1c1c047ef9e6e160e04663675ec76a9e", "committedDate": "2020-07-27T22:44:18Z", "message": "move @EnableCosmosAuditing annotation and registrar to mapping package"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MjE4ODYy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13389#pullrequestreview-456218862", "createdAt": "2020-07-28T00:15:16Z", "commit": {"oid": "81f3c88d1c1c047ef9e6e160e04663675ec76a9e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b2c448ad400b96c1192564937f2e74b50bacd46", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b2c448ad400b96c1192564937f2e74b50bacd46", "committedDate": "2020-07-28T17:16:53Z", "message": "fix linenum issues and missing samples in README"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1259, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}