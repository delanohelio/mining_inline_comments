{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDQ2Njky", "number": 8825, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMjoyMDowNVrODl9ZUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTo0MzowNFrODmcA1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTI5ODExOnYy", "diffSide": "RIGHT", "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobAsyncClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMjoyMDowNVrOFzJLSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMjoyMDowNVrOFzJLSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE3MjA0MQ==", "bodyText": "remove this comment", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389172041", "createdAt": "2020-03-06T22:20:05Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobAsyncClient.java", "diffHunk": "@@ -93,13 +94,17 @@\n      * @param containerName The container name.\n      * @param blobName The blob name.\n      * @param snapshot The snapshot identifier for the blob, pass {@code null} to interact with the blob directly.\n+     * @param customerProvidedKey Customer provided key used during encryption of the blob's data on the server, pass\n+     * {@code null} to allow the service to use its own encryption.\n      * @param key The key used to encrypt and decrypt data.\n      * @param keyWrapAlgorithm The algorithm used to wrap/unwrap the key during encryption.\n      */\n     EncryptedBlobAsyncClient(HttpPipeline pipeline, String url, BlobServiceVersion serviceVersion, String accountName,\n-        String containerName, String blobName, String snapshot, AsyncKeyEncryptionKey key, String keyWrapAlgorithm) {\n-        super(pipeline, url, serviceVersion, accountName, containerName, blobName, snapshot, null /*cpk*/,\n-            null /*encryption scope*/);\n+        String containerName, String blobName, String snapshot, CpkInfo customerProvidedKey,\n+        AsyncKeyEncryptionKey key, String keyWrapAlgorithm) {\n+        super(pipeline, url, serviceVersion, accountName, containerName, blobName, snapshot, customerProvidedKey,\n+            null);\n+        // Note encryption scope is always null when passed in from the client builder.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f56f1b4e75287d063b918ce6ceb50d0ae7afa926"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNjI1OTc5OnYy", "diffSide": "RIGHT", "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOToyNjowOVrOFz2RBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMToxODozMlrOFz5ucg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMDc5MQ==", "bodyText": "If one is not present", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389910791", "createdAt": "2020-03-09T19:26:09Z", "author": {"login": "rickle-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -469,19 +472,37 @@ public EncryptedBlobClientBuilder retryOptions(RequestRetryOptions retryOptions)\n     }\n \n     /**\n-     * Sets the {@link HttpPipeline} to use for the service client.\n+     * Sets the {@link HttpPipeline} to use for the service client, and adds a decryption policy.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk2NzQ3NA==", "bodyText": "done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389967474", "createdAt": "2020-03-09T21:18:32Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -469,19 +472,37 @@ public EncryptedBlobClientBuilder retryOptions(RequestRetryOptions retryOptions)\n     }\n \n     /**\n-     * Sets the {@link HttpPipeline} to use for the service client.\n+     * Sets the {@link HttpPipeline} to use for the service client, and adds a decryption policy.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMDc5MQ=="}, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNjI3ODQzOnYy", "diffSide": "RIGHT", "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTozMTo1M1rOFz2cog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMToxOToyOVrOFz5wJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMzc2Mg==", "bodyText": "cpk isn't ignored, right? Maybe for a bit of future-proofing, we should specify that any options used to configure a pipeline are ignored?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389913762", "createdAt": "2020-03-09T19:31:53Z", "author": {"login": "rickle-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -469,19 +472,37 @@ public EncryptedBlobClientBuilder retryOptions(RequestRetryOptions retryOptions)\n     }\n \n     /**\n-     * Sets the {@link HttpPipeline} to use for the service client.\n+     * Sets the {@link HttpPipeline} to use for the service client, and adds a decryption policy.\n      *\n      * If {@code pipeline} is set, all other settings are ignored, aside from {@link #endpoint(String) endpoint}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkyMDAyOQ==", "bodyText": "It's also not copied since it isn't a pipeline option. I guess it feels a little weird to stay stuff outside the pipeline won't be copied, but the pipeline is a weird concept for people, so maybe it's best to be explicit.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389920029", "createdAt": "2020-03-09T19:44:14Z", "author": {"login": "rickle-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -469,19 +472,37 @@ public EncryptedBlobClientBuilder retryOptions(RequestRetryOptions retryOptions)\n     }\n \n     /**\n-     * Sets the {@link HttpPipeline} to use for the service client.\n+     * Sets the {@link HttpPipeline} to use for the service client, and adds a decryption policy.\n      *\n      * If {@code pipeline} is set, all other settings are ignored, aside from {@link #endpoint(String) endpoint}.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMzc2Mg=="}, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk2NzkxMQ==", "bodyText": "I think they might get confused cause they dont know what options are pipeline and what arent, I'll just say except CPK", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389967911", "createdAt": "2020-03-09T21:19:29Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -469,19 +472,37 @@ public EncryptedBlobClientBuilder retryOptions(RequestRetryOptions retryOptions)\n     }\n \n     /**\n-     * Sets the {@link HttpPipeline} to use for the service client.\n+     * Sets the {@link HttpPipeline} to use for the service client, and adds a decryption policy.\n      *\n      * If {@code pipeline} is set, all other settings are ignored, aside from {@link #endpoint(String) endpoint}.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMzc2Mg=="}, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNjI4MDIxOnYy", "diffSide": "RIGHT", "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTozMjozM1rOFz2dyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMToxNzowNVrOFz5ryg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxNDA1OQ==", "bodyText": "Can we check to ensure one isn't already present? I suppose it wouldn't matter because we remove the encryption metadata, so it wouldn't double decrypt, but it's probably safer if we check.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389914059", "createdAt": "2020-03-09T19:32:33Z", "author": {"login": "rickle-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -469,19 +472,37 @@ public EncryptedBlobClientBuilder retryOptions(RequestRetryOptions retryOptions)\n     }\n \n     /**\n-     * Sets the {@link HttpPipeline} to use for the service client.\n+     * Sets the {@link HttpPipeline} to use for the service client, and adds a decryption policy.\n      *\n      * If {@code pipeline} is set, all other settings are ignored, aside from {@link #endpoint(String) endpoint}.\n      *\n+     * <p>Use this method after setting the key in {@link #key(AsyncKeyEncryptionKey, String) key} and keyResolver in\n+     * {@link #keyResolver(AsyncKeyEncryptionKeyResolver)}.</p>\n+     *\n      * @param httpPipeline HttpPipeline to use for sending service requests and receiving responses.\n      * @return the updated EncryptedBlobClientBuilder object\n      */\n     public EncryptedBlobClientBuilder pipeline(HttpPipeline httpPipeline) {\n         if (this.httpPipeline != null && httpPipeline == null) {\n             logger.info(\"HttpPipeline is being set to 'null' when it was previously configured.\");\n         }\n+        checkValidEncryptionParameters();\n+\n+        HttpPipeline pipeline = null;\n+        if (httpPipeline != null) {\n+            List<HttpPipelinePolicy> policies = new ArrayList<>();\n+            policies.add(new BlobDecryptionPolicy(keyWrapper, keyResolver));\n+            for (int i = 0; i < httpPipeline.getPolicyCount(); i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk2Njc5NA==", "bodyText": "will do", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389966794", "createdAt": "2020-03-09T21:17:05Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -469,19 +472,37 @@ public EncryptedBlobClientBuilder retryOptions(RequestRetryOptions retryOptions)\n     }\n \n     /**\n-     * Sets the {@link HttpPipeline} to use for the service client.\n+     * Sets the {@link HttpPipeline} to use for the service client, and adds a decryption policy.\n      *\n      * If {@code pipeline} is set, all other settings are ignored, aside from {@link #endpoint(String) endpoint}.\n      *\n+     * <p>Use this method after setting the key in {@link #key(AsyncKeyEncryptionKey, String) key} and keyResolver in\n+     * {@link #keyResolver(AsyncKeyEncryptionKeyResolver)}.</p>\n+     *\n      * @param httpPipeline HttpPipeline to use for sending service requests and receiving responses.\n      * @return the updated EncryptedBlobClientBuilder object\n      */\n     public EncryptedBlobClientBuilder pipeline(HttpPipeline httpPipeline) {\n         if (this.httpPipeline != null && httpPipeline == null) {\n             logger.info(\"HttpPipeline is being set to 'null' when it was previously configured.\");\n         }\n+        checkValidEncryptionParameters();\n+\n+        HttpPipeline pipeline = null;\n+        if (httpPipeline != null) {\n+            List<HttpPipelinePolicy> policies = new ArrayList<>();\n+            policies.add(new BlobDecryptionPolicy(keyWrapper, keyResolver));\n+            for (int i = 0; i < httpPipeline.getPolicyCount(); i++) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxNDA1OQ=="}, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNjMxNDQ2OnYy", "diffSide": "RIGHT", "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTo0MzowNFrOFz2ysA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMToxODoyMVrOFz5uGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxOTQwOA==", "bodyText": "Can you add \"for security reasons\" to hopefully preempt some customers who may ask for this?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389919408", "createdAt": "2020-03-09T19:43:04Z", "author": {"login": "rickle-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -512,6 +552,9 @@ public EncryptedBlobClientBuilder serviceVersion(BlobServiceVersion version) {\n      * <p>If {@code pipeline} is set, all other settings are ignored, aside from {@link #endpoint(String) endpoint} and\n      * {@link #serviceVersion(BlobServiceVersion) serviceVersion}.</p>\n      *\n+     * <p>Note that this method does not copy over the {@link CustomerProvidedKey} and encryption scope properties", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk2NzM4Nw==", "bodyText": "done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389967387", "createdAt": "2020-03-09T21:18:21Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -512,6 +552,9 @@ public EncryptedBlobClientBuilder serviceVersion(BlobServiceVersion version) {\n      * <p>If {@code pipeline} is set, all other settings are ignored, aside from {@link #endpoint(String) endpoint} and\n      * {@link #serviceVersion(BlobServiceVersion) serviceVersion}.</p>\n      *\n+     * <p>Note that this method does not copy over the {@link CustomerProvidedKey} and encryption scope properties", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxOTQwOA=="}, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 96}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 273, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}