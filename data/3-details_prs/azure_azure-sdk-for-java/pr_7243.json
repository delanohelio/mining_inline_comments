{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMTY5MjUw", "number": 7243, "title": "Don't retry on network failure on writes", "bodyText": "Direct Port of Azure/azure-cosmosdb-java#301", "createdAt": "2020-01-07T20:56:52Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243", "merged": true, "mergeCommit": {"oid": "56532da8fdd1bcd85468889327624b651fbb0256"}, "closed": true, "closedAt": "2020-01-14T02:56:54Z", "author": {"login": "kushagraThapar"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4HK09gH2gAyMzYwMTY5MjUwOjViZTZiNDA2NmFkNDJjMTYxOGI3ZTEwZjNlMzg3ZmJlZWE4ODIzZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6EuHwAFqTM0MjIwMjM4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5be6b4066ad42c1618b7e10f3e387fbeea8823f1", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5be6b4066ad42c1618b7e10f3e387fbeea8823f1", "committedDate": "2020-01-07T20:55:51Z", "message": "Don't retry on network failure on writes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NTE4MTY4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#pullrequestreview-339518168", "createdAt": "2020-01-07T21:27:55Z", "commit": {"oid": "5be6b4066ad42c1618b7e10f3e387fbeea8823f1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5OTI0NTE1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#pullrequestreview-339924515", "createdAt": "2020-01-08T15:04:52Z", "commit": {"oid": "5be6b4066ad42c1618b7e10f3e387fbeea8823f1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNTowNDo1M1rOFbZsvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNTowODo1NlrOFbZ01Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI3NjkyNg==", "bodyText": "HttpConstants.StatusCodes.FORBIDDEN, HttpConstants.SubStatusCodes.FORBIDDEN_WRITEFORBIDDEN will qualify as isWebExceptionRetriable ? If not then how does that case handled ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#discussion_r364276926", "createdAt": "2020-01-08T15:04:53Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ClientRetryPolicy.java", "diffHunk": "@@ -173,8 +173,17 @@ private ShouldRetryResult shouldRetryOnSessionNotAvailable() {\n             retryDelay = Duration.ofMillis(ClientRetryPolicy.RetryIntervalInMS);\n         }\n         this.retryContext = new RetryContext(this.failoverRetryCount, false);\n-        return this.globalEndpointManager.refreshLocationAsync(null, forceRefresh)\n-                .then(Mono.just(ShouldRetryResult.retryAfter(retryDelay)));\n+        Mono<Void> completable = this.globalEndpointManager.refreshLocationAsync(null, forceRefresh);\n+        if (isReadRequest || WebExceptionUtility.isWebExceptionRetriable(e)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5be6b4066ad42c1618b7e10f3e387fbeea8823f1"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI3ODk5Nw==", "bodyText": "Isn't heading of PR is contradicting , we are retrying on write in case of network failure ? Until I am missing something", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#discussion_r364278997", "createdAt": "2020-01-08T15:08:56Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ClientRetryPolicy.java", "diffHunk": "@@ -173,8 +173,17 @@ private ShouldRetryResult shouldRetryOnSessionNotAvailable() {\n             retryDelay = Duration.ofMillis(ClientRetryPolicy.RetryIntervalInMS);\n         }\n         this.retryContext = new RetryContext(this.failoverRetryCount, false);\n-        return this.globalEndpointManager.refreshLocationAsync(null, forceRefresh)\n-                .then(Mono.just(ShouldRetryResult.retryAfter(retryDelay)));\n+        Mono<Void> completable = this.globalEndpointManager.refreshLocationAsync(null, forceRefresh);\n+        if (isReadRequest || WebExceptionUtility.isWebExceptionRetriable(e)) {\n+            // refresh cache and\n+            // if it is a read request or if it is a write but we are sure the write\n+            // hasn't reached the service retry\n+            return completable.then(Mono.just(ShouldRetryResult.retryAfter(retryDelay)));\n+        } else {\n+            // refresh cache and\n+            // no retry for writes which we are not sure if have reached to the service or not\n+            return completable.then(Mono.just(ShouldRetryResult.noRetry()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5be6b4066ad42c1618b7e10f3e387fbeea8823f1"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMTQ3NzMy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#pullrequestreview-342147732", "createdAt": "2020-01-13T21:22:47Z", "commit": {"oid": "5be6b4066ad42c1618b7e10f3e387fbeea8823f1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdcc8e771003200e1a4ca55e2e638178391f9dca", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bdcc8e771003200e1a4ca55e2e638178391f9dca", "committedDate": "2020-01-13T22:46:15Z", "message": "Fixing the logic to retry on forbidden status code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMTkyOTkz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#pullrequestreview-342192993", "createdAt": "2020-01-13T22:49:44Z", "commit": {"oid": "bdcc8e771003200e1a4ca55e2e638178391f9dca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69552e653dd1c68872f632fd15845aa11ad0793f", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/69552e653dd1c68872f632fd15845aa11ad0793f", "committedDate": "2020-01-13T23:11:07Z", "message": "Replaced this.isReadRequest with local isReadRequest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjAyMzg1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#pullrequestreview-342202385", "createdAt": "2020-01-13T23:12:32Z", "commit": {"oid": "69552e653dd1c68872f632fd15845aa11ad0793f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 547, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}