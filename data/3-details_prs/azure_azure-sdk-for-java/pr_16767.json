{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5MTUwNTEy", "number": 16767, "title": "Sb track2 schedule multiple message validate batch size", "bodyText": "API : receiver.scheduleMessage (Iterator<SBReceivedMessage)\nThrow Exception when all the messages in Iterator can not be added into batch.\nfixes #16714", "createdAt": "2020-10-23T18:42:56Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16767", "merged": true, "mergeCommit": {"oid": "1de0f2682644086bee9f0fb01073845b0a0f0b9b"}, "closed": true, "closedAt": "2020-10-29T00:02:17Z", "author": {"login": "hemanttanwar"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVHmj9AH2gAyNTA5MTUwNTEyOmIwNDc5MzYzOTEwNDYyMDUwYWJhYTgwNjNmMzZiYTQ1NjU1ZTkzOGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXFmc0gH2gAyNTA5MTUwNTEyOjdiM2UyZjM1MDg0YzM5ZjI2ZDU4MjdiOGU5YWRkN2UwODU2MjQyODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b0479363910462050abaa8063f36ba45655e938a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b0479363910462050abaa8063f36ba45655e938a", "committedDate": "2020-10-22T20:01:06Z", "message": "testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "154af1ae961188632c4240310b3550ac17712fb8", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/154af1ae961188632c4240310b3550ac17712fb8", "committedDate": "2020-10-22T22:40:41Z", "message": "fix batch size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52be951cf7bda2cbd5bfc9427d46c8afad78b370", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/52be951cf7bda2cbd5bfc9427d46c8afad78b370", "committedDate": "2020-10-23T17:22:57Z", "message": "Merge branch 'master' into sb-t2-schedule-multiple-message-validate-batch-size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a30cc197b877b2b09ba452d649b0aa15ef0bb32f", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a30cc197b877b2b09ba452d649b0aa15ef0bb32f", "committedDate": "2020-10-23T18:37:56Z", "message": "added check for maxsize for schedule message api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0942818ba672f487441c7ece954afb8352fe996", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c0942818ba672f487441c7ece954afb8352fe996", "committedDate": "2020-10-23T18:44:31Z", "message": "added check for maxsize for schedule message api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73400c0570708d33598640d953bdbce18ad6b9b0", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/73400c0570708d33598640d953bdbce18ad6b9b0", "committedDate": "2020-10-23T19:23:46Z", "message": "Merge branch 'master' into sb-t2-schedule-multiple-message-validate-batch-size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dcea5b7c715c20eacf882db862e5ab55083a034", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8dcea5b7c715c20eacf882db862e5ab55083a034", "committedDate": "2020-10-23T19:31:27Z", "message": "added check for maxsize for schedule message api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MjQxNDc0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16767#pullrequestreview-517241474", "createdAt": "2020-10-26T23:12:48Z", "commit": {"oid": "8dcea5b7c715c20eacf882db862e5ab55083a034"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoxMjo0OFrOHolwtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoxMzowOFrOHolxEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyMzc2NA==", "bodyText": "Why did we duplicate createBatch() logic? By default it uses the default batch size.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16767#discussion_r512323764", "createdAt": "2020-10-26T23:12:48Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java", "diffHunk": "@@ -371,13 +372,36 @@ public String getEntityPath() {\n             return fluxError(logger, new NullPointerException(\"'scheduledEnqueueTime' cannot be null.\"));\n         }\n \n-        return createBatch().flatMapMany(messageBatch -> {\n-            messages.forEach(message -> messageBatch.tryAdd(message));\n-            return getSendLink().flatMapMany(link -> connectionProcessor\n-                .flatMap(connection -> connection.getManagementNode(entityName, entityType))\n-                .flatMapMany(managementNode -> managementNode.schedule(messageBatch.getMessages(), scheduledEnqueueTime,\n-                    messageBatch.getMaxSizeInBytes(), link.getLinkName(), transactionContext)));\n-        });\n+        return getSendLink().flatMapMany(link -> link.getLinkSize()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dcea5b7c715c20eacf882db862e5ab55083a034"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyMzg1OA==", "bodyText": "Why are you keeping an atomic integer? We can just use a for loop", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16767#discussion_r512323858", "createdAt": "2020-10-26T23:13:08Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java", "diffHunk": "@@ -371,13 +372,36 @@ public String getEntityPath() {\n             return fluxError(logger, new NullPointerException(\"'scheduledEnqueueTime' cannot be null.\"));\n         }\n \n-        return createBatch().flatMapMany(messageBatch -> {\n-            messages.forEach(message -> messageBatch.tryAdd(message));\n-            return getSendLink().flatMapMany(link -> connectionProcessor\n-                .flatMap(connection -> connection.getManagementNode(entityName, entityType))\n-                .flatMapMany(managementNode -> managementNode.schedule(messageBatch.getMessages(), scheduledEnqueueTime,\n-                    messageBatch.getMaxSizeInBytes(), link.getLinkName(), transactionContext)));\n-        });\n+        return getSendLink().flatMapMany(link -> link.getLinkSize()\n+            .flatMapMany(size -> {\n+                int maxSize =  size > 0\n+                    ? size\n+                    : MAX_MESSAGE_LENGTH_BYTES;\n+                final CreateBatchOptions batchOptions =  new CreateBatchOptions();\n+                batchOptions.setMaximumSizeInBytes(maxSize);\n+\n+                return createBatch(batchOptions).flatMapMany(messageBatch ->  {\n+                    AtomicInteger index = new AtomicInteger();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dcea5b7c715c20eacf882db862e5ab55083a034"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92e2dc9279f7568447e238eb3768eb4a38be3607", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/92e2dc9279f7568447e238eb3768eb4a38be3607", "committedDate": "2020-10-28T09:04:01Z", "message": "Review Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MTM4MzIz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16767#pullrequestreview-519138323", "createdAt": "2020-10-28T22:42:49Z", "commit": {"oid": "92e2dc9279f7568447e238eb3768eb4a38be3607"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMjo0Mjo0OVrOHqAK6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMjo0Mjo0OVrOHqAK6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgwNTAzMg==", "bodyText": "nitpick only:\n\nif(messageBatch.tryAddMessage(message)) is pretty readable. No need to have an additional variable if no other use.\nSuggest index=0 instead of 1 for the first message because Java uses 0-based index.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16767#discussion_r513805032", "createdAt": "2020-10-28T22:42:49Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSenderAsyncClient.java", "diffHunk": "@@ -371,13 +371,27 @@ public String getEntityPath() {\n             return fluxError(logger, new NullPointerException(\"'scheduledEnqueueTime' cannot be null.\"));\n         }\n \n-        return createMessageBatch().flatMapMany(messageBatch -> {\n-            messages.forEach(message -> messageBatch.tryAddMessage(message));\n-            return getSendLink().flatMapMany(link -> connectionProcessor\n-                .flatMap(connection -> connection.getManagementNode(entityName, entityType))\n-                .flatMapMany(managementNode -> managementNode.schedule(messageBatch.getMessages(), scheduledEnqueueTime,\n-                    messageBatch.getMaxSizeInBytes(), link.getLinkName(), transactionContext)));\n-        });\n+        return getSendLink().flatMapMany(link -> createMessageBatch()\n+            .flatMapMany(messageBatch -> {\n+                int index = 0;\n+                for (ServiceBusMessage message : messages) {\n+                    ++index;\n+                    boolean added = messageBatch.tryAddMessage(message);\n+                    if (!added) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92e2dc9279f7568447e238eb3768eb4a38be3607"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MTM4NDMx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16767#pullrequestreview-519138431", "createdAt": "2020-10-28T22:43:04Z", "commit": {"oid": "92e2dc9279f7568447e238eb3768eb4a38be3607"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b3e2f35084c39f26d5827b8e9add7e085624282", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b3e2f35084c39f26d5827b8e9add7e085624282", "committedDate": "2020-10-28T22:49:01Z", "message": "Review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1793, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}