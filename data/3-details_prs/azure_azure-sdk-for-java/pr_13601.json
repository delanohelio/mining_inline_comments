{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NjE1MTQ0", "number": 13601, "title": "Adding query plan diagnostics context in feed response", "bodyText": "Currently there is no direct way to measure query plan api execution timing for query apis.\nThis pr will add the query plan diagnostics on first feed response, which will be useful in debugging issue for query apis.\nBelow is the sample feedResponse diagnostics with newly added query plan context in bold\nuserAgent=Windows10/10.0 JRE/11.0.6 cosmosdb-java-sdk/4.3.0-beta.1\nQueryPlan Start Time (UTC)=18:41:22:3488\nQueryPlan End Time (UTC)=18:41:24:7870\nQueryPlan Duration (ms)=2438\n0=Retrieved Document Count                 :              50\nRetrieved Document Size                  :           15150 bytes\nOutput Document Count                    :              50\nOutput Document Size                     :           15249 bytes\nIndex Utilization                        :          100.00 %\nTotal Query Execution Time               :        0.590000 milliseconds\nQuery Preparation Times\nQuery Compilation Time               :        0.060000 milliseconds\nLogical Plan Build Time              :        0.040000 milliseconds\nPhysical Plan Build Time             :        0.060000 milliseconds\nQuery Optimization Time              :        0.000000 milliseconds\nIndex Lookup Time                      :        0.000000 milliseconds\nDocument Load Time                     :        0.160000 milliseconds\nRuntime Execution Times\nQuery Engine Times                   :        0.030000 milliseconds\nSystem Function Execution Time       :        0.000000 milliseconds\nUser-defined Function Execution Time :        0.000000 milliseconds\nDocument Write Time                    :        0.030000 milliseconds\nClient Side Metrics\nRetry Count                            :               0\nRequest Charge                         :            6.34 RUs\nPartition Execution Timeline\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Partition Id\u2502                         Activity Id\u2502Start Time (UTC)\u2502  End Time (UTC)\u2502Duration (ms)\u2502NUMBER of Documents\u2502Retry Count\u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502           0\u25021bbdc899-d1cb-11ea-a112-93d68726b008\u2502   18:41:26:2240\u2502   18:41:27:1850\u2502        961.0\u2502                 50\u2502          0\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nScheduling Metrics\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502Partition Id\u2502Response Time (ms)\u2502Run Time (ms)\u2502Wait Time (ms)\u2502Turnaround Time (ms)\u2502NUMBER of Preemptions\u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502           0\u2502              1318\u2502          962\u2502          1323\u2502                2285\u2502                    1\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518", "createdAt": "2020-07-29T18:41:53Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13601", "merged": true, "mergeCommit": {"oid": "cd8c37574bd138d44b03986264ca493bbac9f930"}, "closed": true, "closedAt": "2020-08-11T22:40:05Z", "author": {"login": "simplynaveen20"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5vMcrAH2gAyNDU4NjE1MTQ0OmY1YTk5MjI0MWI0YjRlZDAwNDU1MGU5NjY3OWRmYmIyMjRmZDU3YWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9-HNVgH2gAyNDU4NjE1MTQ0OjhiODAxNjQ0YTNkZjdiYzk4MDhiNTQ2OWExMDAzNDM1Y2E0YTkxNjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f5a992241b4b4ed004550e96679dfbb224fd57ab", "author": {"user": {"login": "simplynaveen20", "name": "Naveen Singh"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f5a992241b4b4ed004550e96679dfbb224fd57ab", "committedDate": "2020-07-29T18:18:54Z", "message": "Adding query plan diagnostics in feed response"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8053ef37f9c8ea7bbacc07a798b8ba1a1bfdb4f2", "author": {"user": {"login": "simplynaveen20", "name": "Naveen Singh"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8053ef37f9c8ea7bbacc07a798b8ba1a1bfdb4f2", "committedDate": "2020-07-29T18:33:04Z", "message": "Correcting the start time for query plan diagnotics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Nzk0MDY5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13601#pullrequestreview-457794069", "createdAt": "2020-07-29T18:45:38Z", "commit": {"oid": "8053ef37f9c8ea7bbacc07a798b8ba1a1bfdb4f2"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbd71395351a5dc2a7415478110114bdeea675e2", "author": {"user": {"login": "simplynaveen20", "name": "Naveen Singh"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/dbd71395351a5dc2a7415478110114bdeea675e2", "committedDate": "2020-07-29T22:16:48Z", "message": "Merge branch 'latest-master' into users/nakumars/queryPlanInQueryMetrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03394fee507c9fa8e3796eee9540d33ef4921944", "author": {"user": {"login": "simplynaveen20", "name": "Naveen Singh"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/03394fee507c9fa8e3796eee9540d33ef4921944", "committedDate": "2020-08-05T15:11:41Z", "message": "merging with master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7472a6ac33d26315dbedee46183891393018eecb", "author": {"user": {"login": "simplynaveen20", "name": "Naveen Singh"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7472a6ac33d26315dbedee46183891393018eecb", "committedDate": "2020-08-05T20:04:29Z", "message": "Merge branch 'latest-master' into users/nakumars/queryPlanInQueryMetrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyODQ2ODMz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13601#pullrequestreview-462846833", "createdAt": "2020-08-06T20:19:04Z", "commit": {"oid": "7472a6ac33d26315dbedee46183891393018eecb"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMDoxOTowNVrOG9C2UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMDoyNzo0MFrOG9DHJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2Mjk5Mg==", "bodyText": "looks weird to have the tailing space after QueryPlan constant. can we pass the space in the string builder? or define another constant for the \" \" string?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13601#discussion_r466662992", "createdAt": "2020-08-06T20:19:05Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/FeedResponseDiagnostics.java", "diffHunk": "@@ -4,15 +4,21 @@\n package com.azure.cosmos.implementation;\n \n import com.azure.cosmos.implementation.apachecommons.lang.StringUtils;\n+import com.azure.cosmos.implementation.query.QueryInfo;\n+import com.azure.cosmos.implementation.query.metrics.QueryMetricsTextWriter;\n \n+import java.time.Duration;\n import java.util.Map;\n \n /**\n  * The type Feed response diagnostics.\n  */\n public final class FeedResponseDiagnostics {\n \n+    private final static String EQUALS = \"=\";\n+    private final static String QUERY_PLAN = \"QueryPlan \";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7472a6ac33d26315dbedee46183891393018eecb"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NzA5Mw==", "bodyText": "you have a class field with the same name here and this hides the class field.\ncan this be named something like for more clarity in the test?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    CosmosClient gatewayClient = null;\n          \n          \n            \n                    CosmosClient testGatewayClient = null;", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13601#discussion_r466667093", "createdAt": "2020-08-06T20:27:17Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/CosmosDiagnosticsTest.java", "diffHunk": "@@ -76,38 +79,45 @@ public void afterClass() {\n \n     @Test(groups = {\"simple\"})\n     public void gatewayDiagnostics() {\n-        InternalObjectNode internalObjectNode = getInternalObjectNode();\n-        CosmosItemResponse<InternalObjectNode> createResponse = this.container.createItem(internalObjectNode);\n-        String diagnostics = createResponse.getDiagnostics().toString();\n-        assertThat(diagnostics).contains(\"\\\"connectionMode\\\":\\\"GATEWAY\\\"\");\n-        assertThat(diagnostics).doesNotContain((\"\\\"gatewayStatistics\\\":null\"));\n-        assertThat(diagnostics).contains(\"\\\"operationType\\\":\\\"Create\\\"\");\n-        assertThat(diagnostics).contains(\"\\\"metaDataName\\\":\\\"CONTAINER_LOOK_UP\\\"\");\n-        assertThat(diagnostics).contains(\"\\\"serializationType\\\":\\\"PARTITION_KEY_FETCH_SERIALIZATION\\\"\");\n-        assertThat(diagnostics).contains(\"\\\"userAgent\\\":\\\"\" + Utils.getUserAgent() + \"\\\"\");\n-        assertThat(createResponse.getDiagnostics().getDuration()).isNotNull();\n-        validateTransportRequestTimelineGateway(diagnostics);\n-        validateJson(diagnostics);\n+        CosmosClient gatewayClient = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7472a6ac33d26315dbedee46183891393018eecb"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NzMwMQ==", "bodyText": "you have a class field with the same name here and this hides the class field.\ncan this be named something like for more clarity in the test?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    CosmosClient directClient = null;\n          \n          \n            \n                    CosmosClient testDirectClient = null;", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13601#discussion_r466667301", "createdAt": "2020-08-06T20:27:40Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/CosmosDiagnosticsTest.java", "diffHunk": "@@ -145,22 +151,85 @@ public void systemDiagnosticsForSystemStateInformation() {\n \n     @Test(groups = {\"simple\"})\n     public void directDiagnostics() {\n+        CosmosClient directClient = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7472a6ac33d26315dbedee46183891393018eecb"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9428b5dd0b549216bb6b3a749a84039960e52df1", "author": {"user": {"login": "simplynaveen20", "name": "Naveen Singh"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9428b5dd0b549216bb6b3a749a84039960e52df1", "committedDate": "2020-08-10T14:15:10Z", "message": "Merge branch 'latest-master' into users/nakumars/queryPlanInQueryMetrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5d936838823225e231432cc5be8c15412f2ec2b", "author": {"user": {"login": "simplynaveen20", "name": "Naveen Singh"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a5d936838823225e231432cc5be8c15412f2ec2b", "committedDate": "2020-08-10T14:53:39Z", "message": "resolving comments and merging with master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MzQyMDA4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13601#pullrequestreview-465342008", "createdAt": "2020-08-11T18:54:03Z", "commit": {"oid": "a5d936838823225e231432cc5be8c15412f2ec2b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07fba2ee5dfc0646c4b0f076eb077f2b23ef6892", "author": {"user": {"login": "simplynaveen20", "name": "Naveen Singh"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/07fba2ee5dfc0646c4b0f076eb077f2b23ef6892", "committedDate": "2020-08-11T19:14:56Z", "message": "resolving merge conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "779698cd10a9f2b06db2e5d15c0d1c7eb21a8326", "author": {"user": {"login": "simplynaveen20", "name": "Naveen Singh"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/779698cd10a9f2b06db2e5d15c0d1c7eb21a8326", "committedDate": "2020-08-11T20:24:03Z", "message": "Fixing build error after merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NDAxNjU5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13601#pullrequestreview-465401659", "createdAt": "2020-08-11T20:25:31Z", "commit": {"oid": "779698cd10a9f2b06db2e5d15c0d1c7eb21a8326"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDoyNTozMlrOG_H8Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDoyNTozMlrOG_H8Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg0MzU3NA==", "bodyText": "nice. thank you.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13601#discussion_r468843574", "createdAt": "2020-08-11T20:25:32Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -433,7 +433,10 @@ ItemDeserializer getItemDeserializer() {\n                         }\n \n                     ).collectList().map(itemList ->\n-                        ModelBridgeInternal.createFeedResponseWithQueryMetrics(itemList, page.getResponseHeaders(), BridgeInternal.queryMetricsFromFeedResponse(page))\n+                        ModelBridgeInternal.createFeedResponseWithQueryMetrics(itemList,\n+                            page.getResponseHeaders(),\n+                            BridgeInternal.queryMetricsFromFeedResponse(page),\n+                            ModelBridgeInternal.getQueryPlanDiagnosticsContext(page))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "779698cd10a9f2b06db2e5d15c0d1c7eb21a8326"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b801644a3df7bc9808b5469a1003435ca4a9160", "author": {"user": {"login": "simplynaveen20", "name": "Naveen Singh"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8b801644a3df7bc9808b5469a1003435ca4a9160", "committedDate": "2020-08-11T21:57:27Z", "message": "Fixing merge conflict"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1021, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}