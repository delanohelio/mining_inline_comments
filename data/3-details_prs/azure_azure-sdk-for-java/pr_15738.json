{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNDI3NjAz", "number": 15738, "title": "Cosmos improve request diagnostics to capture ClientStatistics counts / config", "bodyText": "This PR adds the following to the cosmos request diagnostics:\n\"clientCfgs\": {\n\t\"id\": 0,\n\t\"numberOfClients\": 1,\n\t\"connCfg\": {\n\t\t\"rntbd\": \"(cto:PT5S, rto:PT5S, icto:PT0S, ieto:PT1H, mcpe:130, mrpc:30)\",\n\t\t\"gw\": \"(cps:1000, rto:PT5S, icto:null, p:false)\",\n\t\t\"other\": \"(ed: true, cs: false)\"\n\t},\n\t\"consistencyCfg\": \"(consistency: Eventual, mm: true, prgns: [westus1,eastus1])\"\n}\n\nreviewers please note that although many files changed but the change is minimal (passing the ClientContext into DSR and to the constructor of the component working with DSR).\nTODO: more cleanup to only include important config in the above\n{\n\t\"userAgent\": \"azsdk-java-cosmos/4.6.0-beta.1 MacOSX/10.15.6 JRE/11.0.6\",\n\t\"requestLatencyInMs\": 1,\n\t\"requestStartTimeUTC\": \"2020-09-30T16:06:03.703178Z\",\n\t\"requestEndTimeUTC\": \"2020-09-30T16:06:03.704396Z\",\n\t\"connectionMode\": \"DIRECT\",\n\t\"responseStatisticsList\": [{\n\t\t\"storeResult\": {\n\t\t\t\"storePhysicalAddress\": \"rntbd://10.37.129.3:10253/apps/DocDbApp/services/DocDbServer2/partitions/a4cb494e-38c8-11e6-8106-8cdcd42c33be/replicas/1p/\",\n\t\t\t\"lsn\": 1731,\n\t\t\t\"globalCommittedLsn\": -1,\n\t\t\t\"partitionKeyRangeId\": \"1\",\n\t\t\t\"isValid\": true,\n\t\t\t\"statusCode\": 200,\n\t\t\t\"subStatusCode\": 0,\n\t\t\t\"isGone\": false,\n\t\t\t\"isNotFound\": false,\n\t\t\t\"isInvalidPartition\": false,\n\t\t\t\"requestCharge\": 1.0,\n\t\t\t\"itemLSN\": 1731,\n\t\t\t\"sessionToken\": \"-1#1731\",\n\t\t\t\"exception\": null,\n\t\t\t\"transportRequestTimeline\": [{\n\t\t\t\t\"eventName\": \"created\",\n\t\t\t\t\"durationInMicroSec\": \"8\",\n\t\t\t\t\"startTime\": \"2020-09-30T16:06:03.703458Z\"\n\t\t\t}, {\n\t\t\t\t\"eventName\": \"queued\",\n\t\t\t\t\"durationInMicroSec\": \"74\",\n\t\t\t\t\"startTime\": \"2020-09-30T16:06:03.703466Z\"\n\t\t\t}, {\n\t\t\t\t\"eventName\": \"pipelined\",\n\t\t\t\t\"durationInMicroSec\": \"161\",\n\t\t\t\t\"startTime\": \"2020-09-30T16:06:03.703540Z\"\n\t\t\t}, {\n\t\t\t\t\"eventName\": \"transitTime\",\n\t\t\t\t\"durationInMicroSec\": \"587\",\n\t\t\t\t\"startTime\": \"2020-09-30T16:06:03.703701Z\"\n\t\t\t}, {\n\t\t\t\t\"eventName\": \"received\",\n\t\t\t\t\"durationInMicroSec\": \"74\",\n\t\t\t\t\"startTime\": \"2020-09-30T16:06:03.704288Z\"\n\t\t\t}, {\n\t\t\t\t\"eventName\": \"completed\",\n\t\t\t\t\"durationInMicroSec\": \"1\",\n\t\t\t\t\"startTime\": \"2020-09-30T16:06:03.704362Z\"\n\t\t\t}],\n\t\t\t\"rntbdRequestLengthInBytes\": 413,\n\t\t\t\"rntbdResponseLengthInBytes\": 769,\n\t\t\t\"requestPayloadLengthInBytes\": 0,\n\t\t\t\"responsePayloadLengthInBytes\": 303,\n\t\t\t\"channelTaskQueueSize\": 1,\n\t\t\t\"pendingRequestsCount\": 0,\n\t\t\t\"serviceEndpointStatistics\": {\n\t\t\t\t\"availableChannels\": 1,\n\t\t\t\t\"acquiredChannels\": 0,\n\t\t\t\t\"executorTaskQueueSize\": 0,\n\t\t\t\t\"inflightRequests\": 1,\n\t\t\t\t\"lastSuccessfulRequestTime\": \"2020-09-30T16:06:03.702Z\",\n\t\t\t\t\"lastRequestTime\": \"2020-09-30T16:06:03.701Z\",\n\t\t\t\t\"createdTime\": \"2020-09-30T16:06:01.271855Z\",\n\t\t\t\t\"isClosed\": false\n\t\t\t}\n\t\t},\n\t\t\"requestResponseTimeUTC\": \"2020-09-30T16:06:03.704396Z\",\n\t\t\"requestResourceType\": \"Document\",\n\t\t\"requestOperationType\": \"Read\"\n\t}],\n\t\"supplementalResponseStatisticsList\": [],\n\t\"addressResolutionStatistics\": {},\n\t\"regionsContacted\": [\"https://10.37.129.3:8081/\"],\n\t\"retryContext\": {\n\t\t\"retryCount\": 0,\n\t\t\"statusAndSubStatusCodes\": null,\n\t\t\"retryLatency\": 0\n\t},\n\t\"metadataDiagnosticsContext\": {\n\t\t\"metadataDiagnosticList\": null\n\t},\n\t\"serializationDiagnosticsContext\": {\n\t\t\"serializationDiagnosticsList\": null\n\t},\n\t\"gatewayStatistics\": null,\n\t\"systemInformation\": {\n\t\t\"usedMemory\": \"97392 KB\",\n\t\t\"availableMemory\": \"16679824 KB\",\n\t\t\"systemCpuLoad\": \"empty\"\n\t},\n\t\"clientCfgs\": {\n\t\t\"id\": 0,\n\t\t\"numberOfClients\": 1,\n\t\t\"connCfg\": {\n\t\t\t\"rntbd\": \"(cto:PT5S, rto:PT5S, icto:PT0S, ieto:PT1H, mcpe:130, mrpc:30)\",\n\t\t\t\"gw\": \"(cps:1000, rto:PT5S, icto:null, p:false)\",\n\t\t\t\"other\": \"(ed: true, cs: false)\"\n\t\t},\n\t\t\"consistencyCfg\": \"(consistency: Eventual, mm: true, prgns: [westus1,eastus1])\"\n\t}\n}", "createdAt": "2020-09-25T23:33:46Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15738", "merged": true, "mergeCommit": {"oid": "b543bc20bb07d0445bf8e72388eeb51acf92346a"}, "closed": true, "closedAt": "2020-09-30T16:32:42Z", "author": {"login": "moderakh"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMb14cgH2gAyNDkzNDI3NjAzOjA5ZThkOTQxMDAyNTU4YTM2MTEyNjFhYmRhZmVlMzM3MjBiY2JmMjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN_VMQgFqTQ5OTYwNzk4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "09e8d941002558a3611261abdafee33720bcbf27", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/09e8d941002558a3611261abdafee33720bcbf27", "committedDate": "2020-09-25T20:30:37Z", "message": "client diagnostics contex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9944a45a3dd90a64432f5c1fb61970560ea6366", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e9944a45a3dd90a64432f5c1fb61970560ea6366", "committedDate": "2020-09-25T23:26:29Z", "message": "capture client statistics in request diagnostics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65885626b5149b6d2fe49c66fd9c9e5ea5f7422a", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/65885626b5149b6d2fe49c66fd9c9e5ea5f7422a", "committedDate": "2020-09-25T23:27:24Z", "message": "Merge branch 'master' into users/moderakh/diagnostics-ctx"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzUxNDAw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15738#pullrequestreview-497751400", "createdAt": "2020-09-28T17:32:21Z", "commit": {"oid": "65885626b5149b6d2fe49c66fd9c9e5ea5f7422a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzozMjoyMVrOHZIu5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzozMjoyMVrOHZIu5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExOTUyNw==", "bodyText": "Will it be addressed now?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15738#discussion_r496119527", "createdAt": "2020-09-28T17:32:21Z", "author": {"login": "kirankumarkolli"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ConnectionPolicy.java", "diffHunk": "@@ -498,4 +498,10 @@ public String toString() {\n             \", maxRequestsPerConnection=\" + maxRequestsPerConnection +\n             '}';\n     }\n+\n+    public String asDiagnostics() {\n+        // TODO: cache this to avoid recomputation per diagnostics request\n+        // TODO: only include essential configs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65885626b5149b6d2fe49c66fd9c9e5ea5f7422a"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODAyODI0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15738#pullrequestreview-497802824", "createdAt": "2020-09-28T18:46:07Z", "commit": {"oid": "65885626b5149b6d2fe49c66fd9c9e5ea5f7422a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODY1NTQy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15738#pullrequestreview-497865542", "createdAt": "2020-09-28T20:20:01Z", "commit": {"oid": "65885626b5149b6d2fe49c66fd9c9e5ea5f7422a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb47c8df039375137bec30bee357b09cc2b5d893", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/eb47c8df039375137bec30bee357b09cc2b5d893", "committedDate": "2020-09-28T23:16:24Z", "message": "fixed spotbug complain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5f950d7f395e88c72de46211f0441a90958ef9a", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c5f950d7f395e88c72de46211f0441a90958ef9a", "committedDate": "2020-09-29T00:01:48Z", "message": "diagnostics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac64ff868ceac68e24ad727e2980f1d7d0e40b89", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ac64ff868ceac68e24ad727e2980f1d7d0e40b89", "committedDate": "2020-09-29T22:03:46Z", "message": "fixed tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "639207670e28193b275371f9b8c4ca5aed29cc66", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/639207670e28193b275371f9b8c4ca5aed29cc66", "committedDate": "2020-09-30T06:23:31Z", "message": "capture rntbd, gw config, etc in the request diagnostics, cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0f3caea843c2d823f3d82c927cd17fd313fc829", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a0f3caea843c2d823f3d82c927cd17fd313fc829", "committedDate": "2020-09-30T06:29:46Z", "message": "Merge branch 'master' into users/moderakh/diagnostics-ctx"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71d5f3daee0f07ff1e18afb65b1a8b14c3050a3a", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/71d5f3daee0f07ff1e18afb65b1a8b14c3050a3a", "committedDate": "2020-09-30T07:39:12Z", "message": "added test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff91c42baeda015e8dae2e924e84fac426ee4f71", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ff91c42baeda015e8dae2e924e84fac426ee4f71", "committedDate": "2020-09-30T07:50:54Z", "message": "minor fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b353038ae7dbc15e20440ad0e841dcda5fcc26b1", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b353038ae7dbc15e20440ad0e841dcda5fcc26b1", "committedDate": "2020-09-30T08:19:33Z", "message": "prevent default connection policy to get overriden"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8474e2464ad645d7dcb6c0bdffb698e12e78e6a", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c8474e2464ad645d7dcb6c0bdffb698e12e78e6a", "committedDate": "2020-09-30T15:32:00Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dc862b80431558807b36228e55f5f196fecd35f", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1dc862b80431558807b36228e55f5f196fecd35f", "committedDate": "2020-09-30T15:43:55Z", "message": "added a missing file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NjA3OTg2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15738#pullrequestreview-499607986", "createdAt": "2020-09-30T16:25:25Z", "commit": {"oid": "1dc862b80431558807b36228e55f5f196fecd35f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3216, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}