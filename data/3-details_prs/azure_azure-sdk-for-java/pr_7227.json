{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5ODYyMjIx", "number": 7227, "title": "Direct TCP | Add support for request timelines to be used in diagnostic strings", "bodyText": "See issue #6580.\nAlso:\n\nTidies, simplifies, and adds javadocs for RntbdClientChannelHealthChecker.\nSee RntbdClientChannelHealthChecker.java.\nLogs an informational message regarding azure.cosmos.directTcp.defaultOptions.\nSee RntbdTransportClient.java.\nReplaces logger.trace messages with logger.debug messages in prep for move to Azure Central SDK logging package.\n\nTODO:\n\nAdd unit tests for RequestTimeline, RequestRecord.stage, and RequestRecord.takeTimelineSnapshot #7250", "createdAt": "2020-01-07T07:29:28Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227", "merged": true, "mergeCommit": {"oid": "f9edad4a1795a47972405d07f7a553e447b0e90b"}, "closed": true, "closedAt": "2020-01-15T06:24:28Z", "author": {"login": "David-Noble-at-work"}, "timelineItems": {"totalCount": 51, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbk2DwpgH2gAyMzU5ODYyMjIxOjBiYjMyZTFhM2NkMzIyYzUzNGQ3Y2IwZGFlZThjMmRkYTkxNTEzMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6XhRtAFqTM0MjgzODMyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0bb32e1a3cd322c534d7cb0daee8c2dda9151310", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0bb32e1a3cd322c534d7cb0daee8c2dda9151310", "committedDate": "2019-11-09T00:15:11Z", "message": "Corrected package misspelling in log4j.properties, removed System.exit from Main.java, and attempted to address a memory leak in the RntbdRequestTimer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "921d5ccf0ad962c627d390ac359b3799357aa299", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/921d5ccf0ad962c627d390ac359b3799357aa299", "committedDate": "2019-11-09T00:15:20Z", "message": "Merge branch 'feature/cosmos/v4' of github.com:David-Noble-at-work/azure-sdk-for-java into feature/cosmos/v4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2028dec2ed06af43a46d2a16afb51ec1d03aa313", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2028dec2ed06af43a46d2a16afb51ec1d03aa313", "committedDate": "2019-11-09T00:25:44Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into feature/cosmos/v4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30f5fd32f948a5c901226219516ad61b420b01b5", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/30f5fd32f948a5c901226219516ad61b420b01b5", "committedDate": "2019-11-09T07:45:05Z", "message": "Fixed a merge error and resolved #5043, Variables that specify time in long or int value should specify units"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a9b9471c89c8a0183bc12d0a15f4af308c81f8f", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a9b9471c89c8a0183bc12d0a15f4af308c81f8f", "committedDate": "2019-11-09T09:21:49Z", "message": "Minor code cleanup in RntbdTransportClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89bed8fd35ed4cd95edafe24079a0b3b4b322534", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/89bed8fd35ed4cd95edafe24079a0b3b4b322534", "committedDate": "2019-11-09T17:52:50Z", "message": "Fixed a second merge issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b039d0aa3654f37d789720c0fb1a3b633c61f09", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0b039d0aa3654f37d789720c0fb1a3b633c61f09", "committedDate": "2019-11-15T20:05:44Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into feature/cosmos/v4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76492b5288805ec91721d5f74702bef0a0f35255", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/76492b5288805ec91721d5f74702bef0a0f35255", "committedDate": "2019-11-21T21:25:36Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into feature/cosmos/v4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bad43a6667fbeb75f313fbf1b8922b8db7d5e56", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7bad43a6667fbeb75f313fbf1b8922b8db7d5e56", "committedDate": "2019-11-23T23:08:26Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into feature/cosmos/v4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cefe37e45556008535c1fa2645ae98b677559f4", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9cefe37e45556008535c1fa2645ae98b677559f4", "committedDate": "2019-11-27T17:27:45Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into feature/cosmos/v4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e20f0f62577f388593202d93b8bef928d77126b", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7e20f0f62577f388593202d93b8bef928d77126b", "committedDate": "2019-11-27T22:43:15Z", "message": "Checkpoint for safe keeping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "294ade519f59f157c237a355e06e9079b996fe86", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/294ade519f59f157c237a355e06e9079b996fe86", "committedDate": "2019-11-28T05:30:01Z", "message": "Checkpoint for safe keeping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72b09b93122aa554f8e9846edbd61701981777d1", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/72b09b93122aa554f8e9846edbd61701981777d1", "committedDate": "2019-11-28T09:17:38Z", "message": "Checkpoint for safe keeping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b792310ada7b0abfb2a778585ade4c40eb7b5eea", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b792310ada7b0abfb2a778585ade4c40eb7b5eea", "committedDate": "2019-11-28T23:13:19Z", "message": "Checkpoint for safe keeping (some testing successfully completed)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad076a819cd254cb39805e811977545ff4c40b8c", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ad076a819cd254cb39805e811977545ff4c40b8c", "committedDate": "2019-11-29T07:19:37Z", "message": "Checkpoint for safe keeping (some testing successfully completed)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7be144e780b240a322f50f4b42808d7bd9574498", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7be144e780b240a322f50f4b42808d7bd9574498", "committedDate": "2019-11-29T09:01:18Z", "message": "Checkpoint for safe keeping (some testing successfully completed)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6fef4db2016db1112b452b1cc5b183344441e05", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f6fef4db2016db1112b452b1cc5b183344441e05", "committedDate": "2019-12-01T04:36:32Z", "message": "Checkpoint for safe keeping (some testing successfully completed)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e9115efc56666c1abbf8a3d8fb95f95d9641f99", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0e9115efc56666c1abbf8a3d8fb95f95d9641f99", "committedDate": "2019-12-04T18:41:34Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into issue/#6580/cosmos/v4/support-request-timeline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fab001b74b63ad8ac1cafb73291172b2140dcd0", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2fab001b74b63ad8ac1cafb73291172b2140dcd0", "committedDate": "2019-12-11T00:56:20Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into issue/#6580/cosmos/v4/support-request-timeline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4f1db2b9620f08e38e53ba1a47f029c72bf3c51", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b4f1db2b9620f08e38e53ba1a47f029c72bf3c51", "committedDate": "2019-12-13T02:59:10Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into issue/#6580/cosmos/v4/support-request-timeline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a316547050b221f66692abf0bdef4bd9599a1c43", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a316547050b221f66692abf0bdef4bd9599a1c43", "committedDate": "2019-12-14T08:43:30Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into issue/#6580/cosmos/v4/support-request-timeline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "979e876bd3f1bf485c22958a75f8cf15e9ab83e0", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/979e876bd3f1bf485c22958a75f8cf15e9ab83e0", "committedDate": "2019-12-14T08:54:43Z", "message": "Addressed merge issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b31289abeaa11569e370bf439de9d5e8795d338", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b31289abeaa11569e370bf439de9d5e8795d338", "committedDate": "2019-12-14T21:49:30Z", "message": "Optimized imports and tweaked some logger/argument validation messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "896687589dd15eebc1103d6933f37e4eba7703fd", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/896687589dd15eebc1103d6933f37e4eba7703fd", "committedDate": "2020-01-04T07:53:35Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into feature/cosmos/v4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c17a695dd1922005ebdfe47d719b3ac48c0f0bc8", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c17a695dd1922005ebdfe47d719b3ac48c0f0bc8", "committedDate": "2020-01-04T09:03:05Z", "message": "Ported Default Direct TCP Options feature from v3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fced71eded189f2f7b268eb95bc56c279a037654", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/fced71eded189f2f7b268eb95bc56c279a037654", "committedDate": "2020-01-04T09:22:23Z", "message": "Updated change log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5439596fd2dfe994e46b9373eae29314e28f2077", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5439596fd2dfe994e46b9373eae29314e28f2077", "committedDate": "2020-01-06T18:17:19Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into feature/cosmos/v4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29306f5e550b12c69ae61086161ad0dd8402cc7b", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/29306f5e550b12c69ae61086161ad0dd8402cc7b", "committedDate": "2020-01-06T18:18:05Z", "message": "Updated javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c8f7f4b2f2e4436a1988b54d17140d675f1ffa5", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1c8f7f4b2f2e4436a1988b54d17140d675f1ffa5", "committedDate": "2020-01-06T19:04:21Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into issue/#6580/cosmos/v4/support-request-timeline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b273ae64834712780e41f774372cdbe189fc2c8", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4b273ae64834712780e41f774372cdbe189fc2c8", "committedDate": "2020-01-06T19:38:23Z", "message": "Merge branch 'feature/cosmos/v4' of github.com:David-Noble-at-work/azure-sdk-for-java into issue/#6580/cosmos/v4/support-request-timeline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c701112d3ff7a6d044751df7df3b6666402f9fc", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6c701112d3ff7a6d044751df7df3b6666402f9fc", "committedDate": "2020-01-07T00:51:21Z", "message": "Cleaned up RngtbClientChannelHealthChecker and turned all trace log-levels into debug log-levels in prep for switching to the Azure Central SDK logger."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0abf96a72a2a614912f87a282351cae281fd7590", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0abf96a72a2a614912f87a282351cae281fd7590", "committedDate": "2020-01-07T20:45:56Z", "message": "Added documentation and tweaked some code for readability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e50352818e136829097f5647ff686a59012fdd0c", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e50352818e136829097f5647ff686a59012fdd0c", "committedDate": "2020-01-07T22:01:58Z", "message": "javadoc tweak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a786bc62ef859cda5231daa41ed10ba68cf4143f", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a786bc62ef859cda5231daa41ed10ba68cf4143f", "committedDate": "2020-01-07T22:26:24Z", "message": "javadoc tweaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e6d787410f78219058ff2727272f7ae390737cd", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1e6d787410f78219058ff2727272f7ae390737cd", "committedDate": "2020-01-07T22:44:38Z", "message": "code tweaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29a3a74b5e18221a70ac5484bb195de36d558c53", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/29a3a74b5e18221a70ac5484bb195de36d558c53", "committedDate": "2020-01-07T23:35:51Z", "message": "Added support for RntbdRequestRecord.Stage.RECEIVED"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b0db88b6bf9c0803c8e19514b45ad4b96012abc", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8b0db88b6bf9c0803c8e19514b45ad4b96012abc", "committedDate": "2020-01-09T01:01:08Z", "message": "Tweaks for readability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47e644b5f05a83e5152873f78444d0e7a6548349", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/47e644b5f05a83e5152873f78444d0e7a6548349", "committedDate": "2020-01-09T01:04:46Z", "message": "Tweaks for readability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b1153ebe5af09a3301d73f1b14d3e8ca338baae", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b1153ebe5af09a3301d73f1b14d3e8ca338baae", "committedDate": "2020-01-09T01:18:23Z", "message": "Merge branch 'feature/cosmos/v4' of https://github.com/Azure/azure-sdk-for-java into issue/#6580/cosmos/v4/support-request-timeline"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMjQ2NzQ4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#pullrequestreview-340246748", "createdAt": "2020-01-09T01:34:39Z", "commit": {"oid": "1b1153ebe5af09a3301d73f1b14d3e8ca338baae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMTozNDozOVrOFboz0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMTozNDozOVrOFboz0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyNDQ5OQ==", "bodyText": "NOTE TO REVIEWERS\nChanges to the RntbdClientChannelHealthChecker class add javadocs, simplify the code by eliminating the RntbdClientChannelHealthChecker.JsonSerializer class, and break a few lines of code for readability and compliance with Azure Central SDK code guidelines.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r364524499", "createdAt": "2020-01-09T01:34:39Z", "author": {"login": "David-Noble-at-work"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelHealthChecker.java", "diffHunk": "@@ -4,18 +4,14 @@\n package com.azure.cosmos.implementation.directconnectivity.rntbd;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1153ebe5af09a3301d73f1b14d3e8ca338baae"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ad4f5a582eb24db519e253ac3d6f283626dc7018", "committedDate": "2020-01-09T01:47:48Z", "message": "Optimized imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNjU0NDEz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#pullrequestreview-340654413", "createdAt": "2020-01-09T16:35:48Z", "commit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNjozNTo0OFrOFb8H7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNjo1MDozOFrOFb8qFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0MDk0Mw==", "bodyText": "are we not record cancellation triggered by reactor-stream now?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r364840943", "createdAt": "2020-01-09T16:35:48Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -117,22 +117,30 @@ public long id() {\n         URI address = addressUri.getURI();\n \n         final RntbdRequestArgs requestArgs = new RntbdRequestArgs(request, address);\n+\n         requestArgs.traceOperation(logger, null, \"invokeStoreAsync\");\n \n         final RntbdEndpoint endpoint = this.endpointProvider.get(address);\n         final RntbdRequestRecord record = endpoint.request(requestArgs);\n \n         logger.debug(\"RntbdTransportClient.invokeStoreAsync({}, {}): {}\", address, request, record);\n \n-        return Mono.fromFuture(record).doFinally(signalType -> {\n-            logger.debug(\"SignalType.{} received from reactor: {\\n  endpoint: {},\\n  record: {}\\n}\",\n-                signalType.name(),\n-                endpoint,\n-                record);\n-            if (signalType == SignalType.CANCEL) {\n-                record.stage(RntbdRequestRecord.Stage.CANCELLED_BY_CLIENT);\n+        return Mono.fromFuture(record.whenComplete((response, throwable) -> {\n+\n+            record.stage(RntbdRequestRecord.Stage.COMPLETED);\n+\n+            if (throwable == null) {\n+                response.setRequestTimeline(record.takeTimelineSnapshot());\n+            } else {\n+                checkArgument(throwable instanceof CosmosClientException, \"expected %s, not %s: %s\",\n+                    CosmosClientException.class,\n+                    throwable.getClass(),\n+                    throwable);\n+                CosmosClientException error = (CosmosClientException) throwable;\n+                error.setRequestTimeline(record.takeTimelineSnapshot());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0ODUwMw==", "bodyText": "This is public surface area change, so we need to make sure if we know this is applicable to all connection modes or RNTBD only.\na few questions.\n\nis this related to only direct stack? what about GW mode?\nis there any reason this is not added to request diagnostics CosmosResponseDiagnostics which already exists? CosmosClientException has a getter for itCosmosClientException::getCosmosResponseDiagnostics()", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r364848503", "createdAt": "2020-01-09T16:48:23Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0OTY4NQ==", "bodyText": "setter should not be public. if setter needed for internal implementation we should so similar to `CosmosClientException::setCosmosResponseDiagnostics(.)", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r364849685", "createdAt": "2020-01-09T16:50:38Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {\n+        return this.requestTimeline;\n+    }\n+\n+    public CosmosClientException setRequestTimeline(RequestTimeline requestTimeline) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b60eeb2299afdf921825cb66a8c02559c5d9a82a", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b60eeb2299afdf921825cb66a8c02559c5d9a82a", "committedDate": "2020-01-10T18:01:28Z", "message": "CosmosClientException.setRequestTimeline is now package private and bridged for consumption by RntbdTransportClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/668b22c3a6f8f811a5568145a05121b100947885", "committedDate": "2020-01-13T11:01:20Z", "message": "RntbdTransportClient now correctly handles cancellations that originate with Reactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNzIwNjcy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#pullrequestreview-342720672", "createdAt": "2020-01-14T17:47:16Z", "commit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNzo0NzoxN1rOFdgSzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNzo0NzoxN1rOFdgSzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ4MjEyNA==", "bodyText": "Can we move this out of Direct so it wont be specific to one mode and can be use in gateway too", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366482124", "createdAt": "2020-01-14T17:47:17Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RequestTimeline.java", "diffHunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity;\n+\n+import com.azure.cosmos.implementation.directconnectivity.rntbd.RntbdObjectMapper;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import com.fasterxml.jackson.databind.ser.std.ToStringSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.time.Duration;\n+import java.time.OffsetDateTime;\n+import java.util.Iterator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+/**\n+ * Represents the time and duration of important events in the lifetime of a request.\n+ *\n+ * A {@link RequestTimeline} represents a timeline as a sequence of {@link Event} instances with name, time, and\n+ * duration properties. Hence, one might use this class to represent any timeline. Today we use it to represent\n+ * {@link RntbdTransportClient} request timelines. In the future we might also use it to represent\n+ * {@link HttpTransportClient} request timelines.\n+ *\n+ * A {@link RequestTimeline} serializes to JSON as an array of {@link Event} instances. This is the default\n+ * serialization for any class that implements {@link Iterable}.\n+ * <p>\n+ * <b>Example:</b>\n+ * <pre>{@code OffsetDateTime startTime = OffsetDateTime.parse(\"2020-01-07T11:24:12.842749-08:00\", DateTimeFormatter.ISO_OFFSET_DATE_TIME);\n+ * sys.out.println(RequestTimeline.of(\n+ *     new RequestTimeline.Event(\"foo\", startTime, startTime.plusSeconds(1)),\n+ *     new RequestTimeline.Event(\"bar\", startTime.plusSeconds(1), startTime.plusSeconds(2))));}</pre>\n+ * JSON serialization:\n+ * <pre>{@code [{\"name\":\"foo\",\"time\":\"2020-01-07T11:24:12.842749-08:00\",\"duration\":\"PT1S\"},{\"name\":\"bar\",\"time\":\"2020-01-07T11:24:13.842749-08:00\",\"duration\":\"PT1S\"}])}</pre>\n+ */\n+public final class RequestTimeline implements Iterable<RequestTimeline.Event> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNzgxNDk4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#pullrequestreview-342781498", "createdAt": "2020-01-14T19:26:11Z", "commit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOToyNjoxMVrOFdjIvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozMTo1MlrOFdjTFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUyODcwMA==", "bodyText": "Any reason we need this in addition to empty() API above ?\nIs it okay to share the EMPTY static instance. If multiple callers get this object and modify it, the EMPTY static instance will be modified, right ?\nOr if it is singleton, then looks good.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366528700", "createdAt": "2020-01-14T19:26:11Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RequestTimeline.java", "diffHunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity;\n+\n+import com.azure.cosmos.implementation.directconnectivity.rntbd.RntbdObjectMapper;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import com.fasterxml.jackson.databind.ser.std.ToStringSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.time.Duration;\n+import java.time.OffsetDateTime;\n+import java.util.Iterator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+/**\n+ * Represents the time and duration of important events in the lifetime of a request.\n+ *\n+ * A {@link RequestTimeline} represents a timeline as a sequence of {@link Event} instances with name, time, and\n+ * duration properties. Hence, one might use this class to represent any timeline. Today we use it to represent\n+ * {@link RntbdTransportClient} request timelines. In the future we might also use it to represent\n+ * {@link HttpTransportClient} request timelines.\n+ *\n+ * A {@link RequestTimeline} serializes to JSON as an array of {@link Event} instances. This is the default\n+ * serialization for any class that implements {@link Iterable}.\n+ * <p>\n+ * <b>Example:</b>\n+ * <pre>{@code OffsetDateTime startTime = OffsetDateTime.parse(\"2020-01-07T11:24:12.842749-08:00\", DateTimeFormatter.ISO_OFFSET_DATE_TIME);\n+ * sys.out.println(RequestTimeline.of(\n+ *     new RequestTimeline.Event(\"foo\", startTime, startTime.plusSeconds(1)),\n+ *     new RequestTimeline.Event(\"bar\", startTime.plusSeconds(1), startTime.plusSeconds(2))));}</pre>\n+ * JSON serialization:\n+ * <pre>{@code [{\"name\":\"foo\",\"time\":\"2020-01-07T11:24:12.842749-08:00\",\"duration\":\"PT1S\"},{\"name\":\"bar\",\"time\":\"2020-01-07T11:24:13.842749-08:00\",\"duration\":\"PT1S\"}])}</pre>\n+ */\n+public final class RequestTimeline implements Iterable<RequestTimeline.Event> {\n+\n+    private static final RequestTimeline EMPTY = new RequestTimeline();\n+    private final ImmutableList<Event> events;\n+\n+    private RequestTimeline() {\n+        this.events = ImmutableList.of();\n+    }\n+\n+    private RequestTimeline(final ImmutableList<Event> events) {\n+        checkNotNull(events, \"expected non-null events\");\n+        this.events = events;\n+    }\n+\n+    /**\n+     * Returns an empty {@link RequestTimeline}.\n+     *\n+     * The empty time line returned is static.\n+     *\n+     * @return an empty {@link RequestTimeline}.\n+     */\n+    public static RequestTimeline empty() {\n+        return EMPTY;\n+    }\n+\n+    /**\n+     * Returns an iterator for enumerating the {@link Event} instances in this {@link RequestTimeline}.\n+     *\n+     * @return an iterator for enumerating the {@link Event} instances in this {@link RequestTimeline}.\n+     */\n+    @Override\n+    public Iterator<Event> iterator() {\n+        return this.events.iterator();\n+    }\n+\n+    /**\n+     * Returns an empty {@link RequestTimeline}.\n+     *\n+     * The empty time line returned is static and equivalent to calling {@link RequestTimeline#empty}.\n+     *\n+     * @return an empty request timeline.\n+     */\n+    public static RequestTimeline of() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTAzNg==", "bodyText": "Reactor might / will wrap the exception in ReactiveException.\nThe safest way to check throwable instanceOf CosmosClientException is this.\nfinal Throwable unwrappedThrowable = reactor.core.Exceptions.unwrap(throwable);\nif (unwrappedThrowable instanceof CosmosClientException) {\n .....\n}", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366531036", "createdAt": "2020-01-14T19:31:15Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -117,21 +118,27 @@ public long id() {\n         URI address = addressUri.getURI();\n \n         final RntbdRequestArgs requestArgs = new RntbdRequestArgs(request, address);\n+\n         requestArgs.traceOperation(logger, null, \"invokeStoreAsync\");\n \n         final RntbdEndpoint endpoint = this.endpointProvider.get(address);\n         final RntbdRequestRecord record = endpoint.request(requestArgs);\n \n         logger.debug(\"RntbdTransportClient.invokeStoreAsync({}, {}): {}\", address, request, record);\n \n-        return Mono.fromFuture(record).doFinally(signalType -> {\n-            logger.debug(\"SignalType.{} received from reactor: {\\n  endpoint: {},\\n  record: {}\\n}\",\n-                signalType.name(),\n-                endpoint,\n-                record);\n-            if (signalType == SignalType.CANCEL) {\n-                record.stage(RntbdRequestRecord.Stage.CANCELLED_BY_CLIENT);\n+        return Mono.fromFuture(record.whenComplete((response, throwable) -> {\n+\n+            record.stage(RntbdRequestRecord.Stage.COMPLETED);\n+\n+            if (throwable == null) {\n+                response.setRequestTimeline(record.takeTimelineSnapshot());\n+            } else if (throwable instanceof CosmosClientException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTM0OA==", "bodyText": "Good to log this \ud83d\udc4d", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366531348", "createdAt": "2020-01-14T19:31:52Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -417,7 +424,14 @@ public String toString() {\n                         }\n                     }\n                 } finally {\n-                    DEFAULT_OPTIONS = options != null ? options : new Options();\n+                    if (options == null) {\n+                        DEFAULT_OPTIONS = new Options();\n+                    } else {\n+                        logger.info(\"Updated default Direct TCP options from system property {}: {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "175353c692f6124840c52c6178a00655b5ff540c", "author": {"user": {"login": "David-Noble-at-work", "name": "David Noble"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/175353c692f6124840c52c6178a00655b5ff540c", "committedDate": "2020-01-14T19:43:30Z", "message": "Moved RequestTimeline to com.azure.cosmos.implementation for use in HttpClient, HttpTransportClient, and RntbdTransportClient."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNzk0MzI2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#pullrequestreview-342794326", "createdAt": "2020-01-14T19:47:23Z", "commit": {"oid": "175353c692f6124840c52c6178a00655b5ff540c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo0NzoyM1rOFdjvXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo0OTozNFrOFdjzKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzODU5MA==", "bodyText": "@kushagraThapar reactor.core.Exceptions.unwrap should not be needed in this layer. right?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366538590", "createdAt": "2020-01-14T19:47:23Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -117,21 +118,27 @@ public long id() {\n         URI address = addressUri.getURI();\n \n         final RntbdRequestArgs requestArgs = new RntbdRequestArgs(request, address);\n+\n         requestArgs.traceOperation(logger, null, \"invokeStoreAsync\");\n \n         final RntbdEndpoint endpoint = this.endpointProvider.get(address);\n         final RntbdRequestRecord record = endpoint.request(requestArgs);\n \n         logger.debug(\"RntbdTransportClient.invokeStoreAsync({}, {}): {}\", address, request, record);\n \n-        return Mono.fromFuture(record).doFinally(signalType -> {\n-            logger.debug(\"SignalType.{} received from reactor: {\\n  endpoint: {},\\n  record: {}\\n}\",\n-                signalType.name(),\n-                endpoint,\n-                record);\n-            if (signalType == SignalType.CANCEL) {\n-                record.stage(RntbdRequestRecord.Stage.CANCELLED_BY_CLIENT);\n+        return Mono.fromFuture(record.whenComplete((response, throwable) -> {\n+\n+            record.stage(RntbdRequestRecord.Stage.COMPLETED);\n+\n+            if (throwable == null) {\n+                response.setRequestTimeline(record.takeTimelineSnapshot());\n+            } else if (throwable instanceof CosmosClientException) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTAzNg=="}, "originalCommit": {"oid": "668b22c3a6f8f811a5568145a05121b100947885"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzOTU2MA==", "bodyText": "David, what about the second portion of my comment?\n\nis there any reason this is not added to request diagnostics CosmosResponseDiagnostics which already exists? CosmosClientException has a getter for it CosmosClientException::getCosmosResponseDiagnostics()", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#discussion_r366539560", "createdAt": "2020-01-14T19:49:34Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientException.java", "diffHunk": "@@ -248,6 +250,15 @@ CosmosClientException setCosmosResponseDiagnostics(CosmosResponseDiagnostics cos\n         return this;\n     }\n \n+    public RequestTimeline getRequestTimeline() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0ODUwMw=="}, "originalCommit": {"oid": "ad4f5a582eb24db519e253ac3d6f283626dc7018"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyODA4MjU0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#pullrequestreview-342808254", "createdAt": "2020-01-14T20:11:10Z", "commit": {"oid": "175353c692f6124840c52c6178a00655b5ff540c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyODMxOTUy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#pullrequestreview-342831952", "createdAt": "2020-01-14T20:54:58Z", "commit": {"oid": "175353c692f6124840c52c6178a00655b5ff540c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyODM4MzIz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7227#pullrequestreview-342838323", "createdAt": "2020-01-14T21:06:42Z", "commit": {"oid": "175353c692f6124840c52c6178a00655b5ff540c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 705, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}