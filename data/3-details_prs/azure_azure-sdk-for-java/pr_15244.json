{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3Njc4MjAy", "number": 15244, "title": "RNTBD ensure closed connections are cleaned up", "bodyText": "Joint work:\n@xinlian12 Annie\n@mbhaskar Bhaskar\n@David-Noble-at-work David\n@FabianMeiswinkel Fabian\n@kirankumarkolli Kiran\n@kushagraThapar Kushagra\n@ealsur Matias\n@milismsft Milis\n@moderakh (myself) Mo\n@simplynaveen20 Naveen\n@ramrajprabu Ramraj\n\nregister cleanup on channel close future\noptimization to allow running doOperationComplete on the eventloop thread if we are on the eventloop thread.", "createdAt": "2020-09-16T02:14:16Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244", "merged": true, "mergeCommit": {"oid": "01f304ad7d392e9d93b02b150af478a027867a22"}, "closed": true, "closedAt": "2020-09-16T17:13:12Z", "author": {"login": "moderakh"}, "timelineItems": {"totalCount": 66, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdIYsJJAH2gAyNDg3Njc4MjAyOjk2NmEyMDI0YTQ0YzUyY2IxMjZjNGI2M2E5YTQ3YTBjMTVjZjBjMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJfkmJgFqTQ4OTgzMDM2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "966a2024a44c52cb126c4b63a9a47a0c15cf0c04", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/966a2024a44c52cb126c4b63a9a47a0c15cf0c04", "committedDate": "2020-09-13T06:34:34Z", "message": "rntbd improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2d586efd129b5b76a68766cc51c84727a93b4ec", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d2d586efd129b5b76a68766cc51c84727a93b4ec", "committedDate": "2020-09-13T18:43:51Z", "message": "fixed latency issue and a race condition on close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c8ff08638ad0b705b4db2949fe4b0b87b9683c3", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9c8ff08638ad0b705b4db2949fe4b0b87b9683c3", "committedDate": "2020-09-14T01:54:23Z", "message": "fixed race condition in connection management resulting in creating more connections, fixed a infinite loop issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "beb5fef10c2a3489f5a4ed28359936703de12df6", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/beb5fef10c2a3489f5a4ed28359936703de12df6", "committedDate": "2020-09-14T01:58:21Z", "message": "fixed compilation warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2330f9d09f994ac1f1612bbd1e69eefc1e047b7a", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2330f9d09f994ac1f1612bbd1e69eefc1e047b7a", "committedDate": "2020-09-14T02:37:30Z", "message": "ensure the channel is servicable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "065b4929f13b0f5f8ce61387faa68a1f29d2d54d", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/065b4929f13b0f5f8ce61387faa68a1f29d2d54d", "committedDate": "2020-09-14T02:39:30Z", "message": "increase monitoring period"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4385fa967c5886c126329563885a611d42f748de", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4385fa967c5886c126329563885a611d42f748de", "committedDate": "2020-09-14T02:43:53Z", "message": "removed info debug logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a23badb7a9f86f7d5f158053322203549674606", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6a23badb7a9f86f7d5f158053322203549674606", "committedDate": "2020-09-14T04:37:21Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8a1e50363c62aa37e2b9d17689444d5cd932bd8", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e8a1e50363c62aa37e2b9d17689444d5cd932bd8", "committedDate": "2020-09-14T05:00:15Z", "message": "update condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05ac2e23020cffa4dcd9fc8a1b975084151e4842", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/05ac2e23020cffa4dcd9fc8a1b975084151e4842", "committedDate": "2020-09-14T14:45:08Z", "message": "Reacting to code review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1757a02530c54281794416b121d26ad92f1d502b", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1757a02530c54281794416b121d26ad92f1d502b", "committedDate": "2020-09-14T15:01:38Z", "message": "Merge branch 'master' into users/moderakh/20200912T2019-rntbd-fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3d199264101350194f742c12ef632d044fff4e5", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d3d199264101350194f742c12ef632d044fff4e5", "committedDate": "2020-09-14T15:06:04Z", "message": "Merge branch 'users/moderakh/20200912T2019-rntbd-fixes' of https://github.com/moderakh/azure-sdk-for-java into users/fabianm/RntbdMetricsToDiagnostics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08879489d58638a7e4ca4cc4bb77184b8c16cdeb", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/08879489d58638a7e4ca4cc4bb77184b8c16cdeb", "committedDate": "2020-09-14T15:18:04Z", "message": "Merge pull request #1 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\nUsers/fabianm/rntbd metrics to diagnostics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "342d085195ab2354aef241dfc07ea1ad1d47f863", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/342d085195ab2354aef241dfc07ea1ad1d47f863", "committedDate": "2020-09-14T16:14:42Z", "message": "improved queue pending task monitoring, fixed spotbug complain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04f020a2f70984e9fc520d09e450d63bf6c695c6", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/04f020a2f70984e9fc520d09e450d63bf6c695c6", "committedDate": "2020-09-14T18:24:55Z", "message": "Defense in-depth against releaseChannel race condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d611df90c1a689865cd5f6e69579aeddff438adc", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d611df90c1a689865cd5f6e69579aeddff438adc", "committedDate": "2020-09-14T18:31:05Z", "message": "Merge pull request #3 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\n Defense in-depth against race condition if releaseChannel would be called concurrently for the same channel instance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf2a6c297c6213555d3f898ac5bbdb71eaf6f9fd", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/cf2a6c297c6213555d3f898ac5bbdb71eaf6f9fd", "committedDate": "2020-09-15T02:11:00Z", "message": "cancels pending acquisition tasks which are expired"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b251d07038e86ddb4f697eed8ef07d1a5b4b5f31", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b251d07038e86ddb4f697eed8ef07d1a5b4b5f31", "committedDate": "2020-09-15T02:12:09Z", "message": "cancels pending acquisition tasks which are expired"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fab1c4a3493e220e5a51c87fb891696813cd15b", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9fab1c4a3493e220e5a51c87fb891696813cd15b", "committedDate": "2020-09-15T02:30:57Z", "message": "Merge pull request #4 from moderakh/users/moderakh/20200913T1219-rntbd-fixes\n\nUsers/moderakh/20200913 t1219 rntbd fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0fc71c987acd3057f4de13ca7664404ef071d4e", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c0fc71c987acd3057f4de13ca7664404ef071d4e", "committedDate": "2020-09-15T03:20:06Z", "message": "Fixing compiler warnings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac6a984d77a66bd7c2033d096de8b28fe89a26e3", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ac6a984d77a66bd7c2033d096de8b28fe89a26e3", "committedDate": "2020-09-15T03:29:47Z", "message": "Merge pull request #6 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\nFixing compiler warnings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa91cf47ef383a33b0f2df3d33b9ea54a702fdf2", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/fa91cf47ef383a33b0f2df3d33b9ea54a702fdf2", "committedDate": "2020-09-15T04:40:46Z", "message": "Fixing SpotBug warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c585e0649e0efd81b2fa0ba0d5df225424e245c", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8c585e0649e0efd81b2fa0ba0d5df225424e245c", "committedDate": "2020-09-15T04:42:58Z", "message": "Merge pull request #7 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\nFixing SpotBug warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90aeea4274006e7025684c2465fa5c0f156a2242", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/90aeea4274006e7025684c2465fa5c0f156a2242", "committedDate": "2020-09-15T05:14:50Z", "message": "Fixing build issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5d184bcf3752f6fc2fdbee94eacb88d9466ed4d", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b5d184bcf3752f6fc2fdbee94eacb88d9466ed4d", "committedDate": "2020-09-15T05:18:14Z", "message": "Merge pull request #8 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\nFixing build issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee0696a9ae4b885bf115d602ca301a860637ddd0", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ee0696a9ae4b885bf115d602ca301a860637ddd0", "committedDate": "2020-09-15T05:42:02Z", "message": "Fixing SpotBug issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aaa7f208ea46b86e348cf11a032aa30b8eb88a7", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0aaa7f208ea46b86e348cf11a032aa30b8eb88a7", "committedDate": "2020-09-15T05:44:54Z", "message": "Merge pull request #9 from FabianMeiswinkel/users/fabianm/RntbdMetricsToDiagnostics\n\nFixing SpotBug issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b490f055b879e024134840ea94397cf46a973d07", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b490f055b879e024134840ea94397cf46a973d07", "committedDate": "2020-09-15T15:16:03Z", "message": "Moving AcquireTask completion callbacks away from the  channel pool executor's event loop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "094472e5e65e95740121ed30f9ddcf3cb2910f0b", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/094472e5e65e95740121ed30f9ddcf3cb2910f0b", "committedDate": "2020-09-15T17:21:27Z", "message": "Further iterating on the scheduling for AcuireTask completions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a18033dc2a4e516e53f8ca629c9805e87da1f3b2", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a18033dc2a4e516e53f8ca629c9805e87da1f3b2", "committedDate": "2020-09-15T17:42:48Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9be0f5eaa0110c5f4a9551a616bfe9537963a55", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d9be0f5eaa0110c5f4a9551a616bfe9537963a55", "committedDate": "2020-09-15T18:05:05Z", "message": "Stop ignoring maxRequest limit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51136dd1f76dc8f2e5b28146e839a9b60a6e2626", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/51136dd1f76dc8f2e5b28146e839a9b60a6e2626", "committedDate": "2020-09-15T18:26:30Z", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/AcquisitionTaskSchedulingFix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92edadeb61d7bdff5c6725d5f9a5acb79442366d", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/92edadeb61d7bdff5c6725d5f9a5acb79442366d", "committedDate": "2020-09-15T18:36:05Z", "message": "Missed porting one change when resolving merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "951f0efc72d7dd74f1209204455651a0b0752cde", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/951f0efc72d7dd74f1209204455651a0b0752cde", "committedDate": "2020-09-15T22:38:10Z", "message": "closes the channel and do the necessary cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3960111f760e2c25c6b508a19316b8747c5569c", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d3960111f760e2c25c6b508a19316b8747c5569c", "committedDate": "2020-09-15T23:07:16Z", "message": "Fxiing Json serialization issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3de984397b5e536a7e063f0c4e83db0c9f48ac13", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3de984397b5e536a7e063f0c4e83db0c9f48ac13", "committedDate": "2020-09-15T23:18:15Z", "message": "Merge pull request #11 from FabianMeiswinkel/users/fabianm/SerializationFix\n\nFxiing Json serialization issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62ecdbcaeda925cc8ac6d637a98605c1bb2df4e9", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/62ecdbcaeda925cc8ac6d637a98605c1bb2df4e9", "committedDate": "2020-09-15T23:57:05Z", "message": "optimization for running the work on the current thread if current thread is the right thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1b418a163f0b1d45d25290131e0381946aaaefa", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c1b418a163f0b1d45d25290131e0381946aaaefa", "committedDate": "2020-09-15T23:57:22Z", "message": "Merge branch 'users/moderakh/20200915T1247-rntbd-connection-hang' of github.com:moderakh/azure-sdk-for-java into users/moderakh/20200915T1247-rntbd-connection-hang"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88bbace618dadf6bf07f153d9a4e2242ddfa039b", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/88bbace618dadf6bf07f153d9a4e2242ddfa039b", "committedDate": "2020-09-16T02:08:33Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "485ef4ec98240899beb558daa87d378675bd0ffd", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/485ef4ec98240899beb558daa87d378675bd0ffd", "committedDate": "2020-09-16T02:11:10Z", "message": "Merge branch 'master' into users/moderakh/20200915T1247-rntbd-connection-hang"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90f627088c0b4d65b6871dee45b40ee591392c6a", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/90f627088c0b4d65b6871dee45b40ee591392c6a", "committedDate": "2020-09-16T02:17:41Z", "message": "Initial version of admission control in RntbdServiceEndpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faa2d866571d374d615a24c007fd9de728aecd1a", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/faa2d866571d374d615a24c007fd9de728aecd1a", "committedDate": "2020-09-16T03:10:03Z", "message": "Fixing test issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f870a547f2c87c1220d1d09333cf26f3309738f", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9f870a547f2c87c1220d1d09333cf26f3309738f", "committedDate": "2020-09-16T03:52:04Z", "message": "fix spotbug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MjcwMTk4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489270198", "createdAt": "2020-09-16T04:53:02Z", "commit": {"oid": "9f870a547f2c87c1220d1d09333cf26f3309738f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwNDo1MzowMlrOHSf-vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwNDo1MzowMlrOHSf-vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE2MDM4Mw==", "bodyText": "channel.ensureIneventLop()", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489160383", "createdAt": "2020-09-16T04:53:02Z", "author": {"login": "kirankumarkolli"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java", "diffHunk": "@@ -1297,6 +1332,40 @@ public final AcquireListener acquired() {\n             return this;\n         }\n \n+        private void doOperationComplete(Channel channel) {\n+            if (!channel.isActive()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f870a547f2c87c1220d1d09333cf26f3309738f"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "281d1b15e8ddab8e5be635b827055741b36073ee", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/281d1b15e8ddab8e5be635b827055741b36073ee", "committedDate": "2020-09-16T05:03:33Z", "message": "Fixing Config to allow overriding default of 10_000 maxConcurrentRequestsPerEndpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90b36e4daa72afb2afff4da0443f15f2997ce40b", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/90b36e4daa72afb2afff4da0443f15f2997ce40b", "committedDate": "2020-09-16T05:10:25Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c31fd9aa9494bce0330d329b33501f0029f2b758", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c31fd9aa9494bce0330d329b33501f0029f2b758", "committedDate": "2020-09-16T05:11:03Z", "message": "Merge pull request #12 from FabianMeiswinkel/users/fabianm/SerializationFix\n\nInitial version of admission control in RntbdServiceEndpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5a6f80902a47b4c7e3d86ef852995fdd7bab8bc", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f5a6f80902a47b4c7e3d86ef852995fdd7bab8bc", "committedDate": "2020-09-16T05:18:13Z", "message": "Reenforcing that doOperationComplete runs on channel's event loop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548", "committedDate": "2020-09-16T09:05:51Z", "message": "Merged latest master and resolved conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NDgwMTAx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489480101", "createdAt": "2020-09-16T10:16:12Z", "commit": {"oid": "dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDoxNjoxM1rOHSqHUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDoxNjoxM1rOHSqHUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMyNjQxNg==", "bodyText": "Is it future proofing or a bug?\nQuick check doesn't show any sub-classes.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489326416", "createdAt": "2020-09-16T10:16:13Z", "author": {"login": "kirankumarkolli"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdContextRequestEncoder.java", "diffHunk": "@@ -26,7 +26,7 @@\n      */\n     @Override\n     public boolean acceptOutboundMessage(final Object message) {\n-        return message.getClass() == RntbdContextRequest.class;\n+        return message instanceof RntbdContextRequest;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NDgxOTY1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489481965", "createdAt": "2020-09-16T10:18:50Z", "commit": {"oid": "dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDoxODo1MFrOHSqMww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDoxODo1MFrOHSqMww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMyNzgxMQ==", "bodyText": "Isn't null value a bug?\nOr when is it expected.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489327811", "createdAt": "2020-09-16T10:18:50Z", "author": {"login": "kirankumarkolli"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RequestTimeoutException.java", "diffHunk": "@@ -76,6 +77,23 @@ public RequestTimeoutException(String message, HttpHeaders headers, URI requestU\n                 : null);\n     }\n \n+    /**\n+     * Instantiates a new Request timeout exception.\n+     *\n+     * @param message the message\n+     * @param headers the headers\n+     * @param remoteAddress the remote address\n+     */\n+    public RequestTimeoutException(String message, HttpHeaders headers, SocketAddress remoteAddress) {\n+        super(message,\n+            null,\n+            HttpUtils.asMap(headers),\n+            HttpConstants.StatusCodes.REQUEST_TIMEOUT,\n+            remoteAddress != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NDkyNjk0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489492694", "createdAt": "2020-09-16T10:33:59Z", "commit": {"oid": "dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDozMzo1OVrOHSqtOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDozMzo1OVrOHSqtOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMzNjEyMQ==", "bodyText": "ActivityId for non-service interaction is mis-leading.\nHow about not have it?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489336121", "createdAt": "2020-09-16T10:33:59Z", "author": {"login": "kirankumarkolli"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/FailFastRntbdRequestRecord.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity.rntbd;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.RequestTimeoutException;\n+import com.azure.cosmos.implementation.http.HttpHeaders;\n+import io.netty.util.Timeout;\n+import io.netty.util.TimerTask;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.net.SocketAddress;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import static com.azure.cosmos.implementation.guava27.Strings.lenientFormat;\n+\n+public class FailFastRntbdRequestRecord extends RntbdRequestRecord {\n+    private static final Logger logger = LoggerFactory.getLogger(RntbdRequestRecord.class);\n+\n+    private FailFastRntbdRequestRecord(final RntbdRequestArgs args) {\n+        super(args);\n+    }\n+\n+    @Override\n+    public Timeout newTimeout(final TimerTask task) {\n+        throw new IllegalArgumentException(\"newTimeout must never be called for fail fast records.\");\n+    }\n+\n+    public static FailFastRntbdRequestRecord createAndFailFast(\n+        RntbdRequestArgs args,\n+        long concurrentRequestsSnapshot,\n+        AtomicInteger concurrentRequests,\n+        RntbdMetrics metrics,\n+        SocketAddress remoteAddress) {\n+\n+        FailFastRntbdRequestRecord failFastRecord = new FailFastRntbdRequestRecord(args);\n+\n+        logger.debug(\n+            \"\\n  [{}]\\n  {}\\n  created FailFastRntbdRequestRecord {} \",\n+            failFastRecord,\n+            args,\n+            concurrentRequests);\n+\n+        final String reason = lenientFormat(\n+            \"Failed due to too many (%s) concurrent requests.\",\n+            concurrentRequestsSnapshot);\n+\n+        HttpHeaders headers = new HttpHeaders();\n+        headers.set(HttpConstants.HttpHeaders.ACTIVITY_ID, failFastRecord.activityId().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NDk3NTYx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489497561", "createdAt": "2020-09-16T10:40:45Z", "commit": {"oid": "dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDo0MDo0NVrOHSq7Yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDo0MDo0NVrOHSq7Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMzOTc0Nw==", "bodyText": "Is it absolutely necessary?\nCan the decrement be done in the ServiceEndpoint before fail?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489339747", "createdAt": "2020-09-16T10:40:45Z", "author": {"login": "kirankumarkolli"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/FailFastRntbdRequestRecord.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity.rntbd;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.RequestTimeoutException;\n+import com.azure.cosmos.implementation.http.HttpHeaders;\n+import io.netty.util.Timeout;\n+import io.netty.util.TimerTask;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.net.SocketAddress;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import static com.azure.cosmos.implementation.guava27.Strings.lenientFormat;\n+\n+public class FailFastRntbdRequestRecord extends RntbdRequestRecord {\n+    private static final Logger logger = LoggerFactory.getLogger(RntbdRequestRecord.class);\n+\n+    private FailFastRntbdRequestRecord(final RntbdRequestArgs args) {\n+        super(args);\n+    }\n+\n+    @Override\n+    public Timeout newTimeout(final TimerTask task) {\n+        throw new IllegalArgumentException(\"newTimeout must never be called for fail fast records.\");\n+    }\n+\n+    public static FailFastRntbdRequestRecord createAndFailFast(\n+        RntbdRequestArgs args,\n+        long concurrentRequestsSnapshot,\n+        AtomicInteger concurrentRequests,\n+        RntbdMetrics metrics,\n+        SocketAddress remoteAddress) {\n+\n+        FailFastRntbdRequestRecord failFastRecord = new FailFastRntbdRequestRecord(args);\n+\n+        logger.debug(\n+            \"\\n  [{}]\\n  {}\\n  created FailFastRntbdRequestRecord {} \",\n+            failFastRecord,\n+            args,\n+            concurrentRequests);\n+\n+        final String reason = lenientFormat(\n+            \"Failed due to too many (%s) concurrent requests.\",\n+            concurrentRequestsSnapshot);\n+\n+        HttpHeaders headers = new HttpHeaders();\n+        headers.set(HttpConstants.HttpHeaders.ACTIVITY_ID, failFastRecord.activityId().toString());\n+\n+        failFastRecord.whenComplete((response, error) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NDk4MzYw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489498360", "createdAt": "2020-09-16T10:41:56Z", "commit": {"oid": "dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDo0MTo1NlrOHSq95Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMDo0MTo1NlrOHSq95Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0MDM4OQ==", "bodyText": "Do upstream retries fail these or retry? (not a blocker now)", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489340389", "createdAt": "2020-09-16T10:41:56Z", "author": {"login": "kirankumarkolli"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdServiceEndpoint.java", "diffHunk": "@@ -185,7 +187,17 @@ public RntbdRequestRecord request(final RntbdRequestArgs args) {\n \n         this.throwIfClosed();\n \n-        this.concurrentRequests.incrementAndGet();\n+        int concurrentRequestSnapshot = this.concurrentRequests.incrementAndGet();\n+\n+        if (concurrentRequestSnapshot > this.maxConcurrentRequests) {\n+            return FailFastRntbdRequestRecord.createAndFailFast(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc43aa8f89e26ec0e5f0b7ee574017fe59f6e548"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02a636dfef147a0a7000812017059f37278d051d", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/02a636dfef147a0a7000812017059f37278d051d", "committedDate": "2020-09-16T11:08:26Z", "message": "Merge branch 'users/moderakh/20200915T1247-rntbd-connection-hang' of https://github.com/moderakh/azure-sdk-for-java into users/fabianm/SerializationFix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e7426e6ebd46a908a210bf17e47cd6824a99a2a", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1e7426e6ebd46a908a210bf17e47cd6824a99a2a", "committedDate": "2020-09-16T11:08:47Z", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into users/fabianm/SerializationFix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbe09f7a35fcdfab2a6419fcad14d4073bc5a818", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bbe09f7a35fcdfab2a6419fcad14d4073bc5a818", "committedDate": "2020-09-16T11:13:39Z", "message": "Merge pull request #13 from FabianMeiswinkel/users/fabianm/SerializationFix\n\nMerging latest from master to address base CI failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b968cf5a3f581043e22cf851553c49f3bb65d771", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b968cf5a3f581043e22cf851553c49f3bb65d771", "committedDate": "2020-09-16T11:43:10Z", "message": "Reacted to CR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e", "author": {"user": {"login": "FabianMeiswinkel", "name": "Fabian Meiswinkel"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3f521cfcd75e1dbf7c5d8bc10d38084e594d655e", "committedDate": "2020-09-16T11:44:32Z", "message": "Merge pull request #14 from FabianMeiswinkel/users/fabianm/SerializationFix\n\nAddressing CR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NjIzNTg3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489623587", "createdAt": "2020-09-16T13:27:23Z", "commit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODA4Mzky", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489808392", "createdAt": "2020-09-16T16:40:27Z", "commit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjo0MDoyOFrOHS5WhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjo0MDoyOFrOHS5WhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU3NjA2OA==", "bodyText": "should it be DEFAULT_MAX_*?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489576068", "createdAt": "2020-09-16T16:40:28Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -252,6 +252,8 @@ private void throwIfClosed() {\n \n     public static final class Options {\n \n+        private static final int DEFAULT_MIN_MAX_CONCURRENT_REQUESTS_PER_ENDPOINT = 10_000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODExNTk3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489811597", "createdAt": "2020-09-16T16:44:39Z", "commit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjo0NDozOVrOHS5f9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjo0NDozOVrOHS5f9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU3ODQ4NQ==", "bodyText": "Should this be FailFastRntbdRequestRecord.class?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489578485", "createdAt": "2020-09-16T16:44:39Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/FailFastRntbdRequestRecord.java", "diffHunk": "@@ -0,0 +1,65 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity.rntbd;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.RequestTimeoutException;\n+import com.azure.cosmos.implementation.http.HttpHeaders;\n+import io.netty.util.Timeout;\n+import io.netty.util.TimerTask;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.net.SocketAddress;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import static com.azure.cosmos.implementation.guava27.Strings.lenientFormat;\n+\n+public class FailFastRntbdRequestRecord extends RntbdRequestRecord {\n+    private static final Logger logger = LoggerFactory.getLogger(RntbdRequestRecord.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODE0MjY4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489814268", "createdAt": "2020-09-16T16:48:11Z", "commit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjo0ODoxMlrOHS5n_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjo0ODoxMlrOHS5n_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU4MDU0Mg==", "bodyText": "The usual pattern I saw is: (should we follow here as well?)\nif (logger.isDebugEnabled) {\nlogger.debug()\n}", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489580542", "createdAt": "2020-09-16T16:48:12Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/FailFastRntbdRequestRecord.java", "diffHunk": "@@ -0,0 +1,65 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity.rntbd;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.RequestTimeoutException;\n+import com.azure.cosmos.implementation.http.HttpHeaders;\n+import io.netty.util.Timeout;\n+import io.netty.util.TimerTask;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.net.SocketAddress;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import static com.azure.cosmos.implementation.guava27.Strings.lenientFormat;\n+\n+public class FailFastRntbdRequestRecord extends RntbdRequestRecord {\n+    private static final Logger logger = LoggerFactory.getLogger(RntbdRequestRecord.class);\n+\n+    private FailFastRntbdRequestRecord(final RntbdRequestArgs args) {\n+        super(args);\n+    }\n+\n+    @Override\n+    public Timeout newTimeout(final TimerTask task) {\n+        throw new IllegalArgumentException(\"newTimeout must never be called for fail fast records.\");\n+    }\n+\n+    public static FailFastRntbdRequestRecord createAndFailFast(\n+        RntbdRequestArgs args,\n+        long concurrentRequestsSnapshot,\n+        RntbdMetrics metrics,\n+        SocketAddress remoteAddress) {\n+\n+        FailFastRntbdRequestRecord failFastRecord = new FailFastRntbdRequestRecord(args);\n+\n+        logger.debug(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODE2NDQw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489816440", "createdAt": "2020-09-16T16:51:05Z", "commit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjo1MTowNVrOHS5upQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjo1MTowNVrOHS5upQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU4MjI0NQ==", "bodyText": "Same here, should we check whether the logger.isDebugEnabled?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489582245", "createdAt": "2020-09-16T16:51:05Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java", "diffHunk": "@@ -588,7 +588,7 @@ private void acquireChannel(final ChannelPromiseWithExpiryTime promise) {\n                     final RntbdRequestManager manager = channel.pipeline().get(RntbdRequestManager.class);\n \n                     if (manager == null) {\n-                        logger.warn(\"Channel({} --> {}) closed\", channel, this.remoteAddress());\n+                        logger.debug(\"Channel({} --> {}) closed\", channel, this.remoteAddress());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODI4MDM5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489828039", "createdAt": "2020-09-16T17:06:21Z", "commit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzowNjoyMVrOHS6SDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzowNjoyMVrOHS6SDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU5MTMwOA==", "bodyText": "why only timeQueued changed to final? should also change timeCompleted, timePipelined etc?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489591308", "createdAt": "2020-09-16T17:06:21Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestRecord.java", "diffHunk": "@@ -48,29 +48,26 @@\n             \"stage\");\n \n     private final RntbdRequestArgs args;\n-    private final RntbdRequestTimer timer;\n \n     private volatile int requestLength;\n     private volatile int responseLength;\n     private volatile Stage stage;\n \n     private volatile Instant timeCompleted;\n     private volatile Instant timePipelined;\n-    private volatile Instant timeQueued;\n+    private final Instant timeQueued;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODMwMzY0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#pullrequestreview-489830364", "createdAt": "2020-09-16T17:09:35Z", "commit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzowOTozNVrOHS6ZLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzowOTozNVrOHS6ZLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU5MzEzMw==", "bodyText": "should decrease inside failFastRntbdRequestRecord.whenComplete?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15244#discussion_r489593133", "createdAt": "2020-09-16T17:09:35Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdServiceEndpoint.java", "diffHunk": "@@ -185,7 +187,21 @@ public RntbdRequestRecord request(final RntbdRequestArgs args) {\n \n         this.throwIfClosed();\n \n-        this.concurrentRequests.incrementAndGet();\n+        int concurrentRequestSnapshot = this.concurrentRequests.incrementAndGet();\n+\n+        if (concurrentRequestSnapshot > this.maxConcurrentRequests) {\n+            try {\n+                return FailFastRntbdRequestRecord.createAndFailFast(\n+                    args,\n+                    concurrentRequestSnapshot,\n+                    metrics,\n+                    remoteAddress);\n+            }\n+            finally {\n+                concurrentRequests.decrementAndGet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f521cfcd75e1dbf7c5d8bc10d38084e594d655e"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3359, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}