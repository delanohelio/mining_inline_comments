{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1MjQ3MjUw", "number": 15105, "title": "Add the Ability to Position HttpPipelinePolicies in Client Builders", "bodyText": "Fixes #15008\nThis PR adds a new concept of HttpPipelinePosition which allows for client builders to allow more flexibility in where HttpPipelinePolicies are positioned. Two initial position options are provided, PER_CALL and PER_RETRY. PER_CALL policies are only invoked once per HttpPipeline invocation while PER_RETRY policies are invoked at least once per pipeline invocation and additionally each time the request is retried.\nHttpPipelinePolicy adds a interface method getPipelinePosition that has a default return value of PER_RETRY. PER_RETRY was selected as a review of client builders indicated that they position custom policies after retry. Implementations may override the policy so they are positioned in a more appropriate place, for example a header setting policy should go before retry and it will inject static information into the request but a metrics capturing policy would go after retry to collect all networking information. A new guideline will also be introduced to never mark an HttpPipelinePolicy implementation as final so the policies position may be altered if needed.\nThe new functionality in this PR offers a middle ground between the rigid configuration previously offered and requiring a custom pipeline. Additionally, the position functionality offers the ability for enhancement in the future such as positioning policies in a more granular fashion.", "createdAt": "2020-09-11T16:32:39Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105", "merged": true, "mergeCommit": {"oid": "2c678d01025dccc7bfedd4ac07001576ada40a6d"}, "closed": true, "closedAt": "2020-09-24T17:31:06Z", "author": {"login": "alzimmermsft"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH4B6ugH2gAyNDg1MjQ3MjUwOjRlOWY2MzYxOGE2NWU5Y2RmOTZlYTFlZDcxNWQ2NGQ0MGNkN2NhMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdL1DG_AFqTQ5NTExNDM5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4e9f63618a65e9cdf96ea1ed715d64d40cd7ca35", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4e9f63618a65e9cdf96ea1ed715d64d40cd7ca35", "committedDate": "2020-09-11T16:31:29Z", "message": "Added HttpPipelinePosition which indicates where in the policy set an HttpPipelinePolicy will be placed when using a client builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77d1f99b635c373e0d3f0fd7e9446395ab2abf3c", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/77d1f99b635c373e0d3f0fd7e9446395ab2abf3c", "committedDate": "2020-09-14T16:48:41Z", "message": "Updated AppConfiguration to use unreleased azure-core-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73753aaf8460458883d3480d9120f486dcc1e09d", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/73753aaf8460458883d3480d9120f486dcc1e09d", "committedDate": "2020-09-14T16:51:33Z", "message": "Merged in master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8b2f1a1f50df63b7a11497d0083d56d229c7f43", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b8b2f1a1f50df63b7a11497d0083d56d229c7f43", "committedDate": "2020-09-14T18:31:10Z", "message": "Resolve testing issues by using unreleased version of azure-core"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MTkwNDMz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#pullrequestreview-489190433", "createdAt": "2020-09-16T00:16:13Z", "commit": {"oid": "b8b2f1a1f50df63b7a11497d0083d56d229c7f43"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMDoxNjoxM1rOHSbkAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMDoxNjoxM1rOHSbkAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4ODAwMg==", "bodyText": "Add a default implementation for getHttpPipelinePosition(), this will default to PER_RETRY.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#discussion_r489088002", "createdAt": "2020-09-16T00:16:13Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/policy/HttpPipelinePolicy.java", "diffHunk": "@@ -17,9 +17,9 @@\n @FunctionalInterface\n public interface HttpPipelinePolicy {\n     /**\n-     * Process provided request context and invokes the next policy.\n+     * Processes provided request context and invokes the next policy.\n      *\n-     * @param context request context\n+     * @param context The request context.\n      * @param next The next policy to invoke.\n      * @return A publisher that initiates the request upon subscription and emits a response on completion.\n      */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8b2f1a1f50df63b7a11497d0083d56d229c7f43"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5433cddba92a40446463731633a0b65d3c6956c8", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5433cddba92a40446463731633a0b65d3c6956c8", "committedDate": "2020-09-16T16:12:32Z", "message": "Merged in master, added getter for HttpPipelinePosition to HttpPipelinePolicy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a94522b5e05ea644696aa077003e638152021466", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a94522b5e05ea644696aa077003e638152021466", "committedDate": "2020-09-21T20:50:10Z", "message": "Merge branch 'master' into AzCore_AddPipelinePolicyPosition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a011ebd5e4392b61bf9576b39f5e4f1ea2481364", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a011ebd5e4392b61bf9576b39f5e4f1ea2481364", "committedDate": "2020-09-21T21:26:43Z", "message": "Remove client builder overload"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDE0NjEz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#pullrequestreview-493014613", "createdAt": "2020-09-21T22:08:27Z", "commit": {"oid": "a011ebd5e4392b61bf9576b39f5e4f1ea2481364"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjowODoyN1rOHVkGSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjoxMTo1MVrOHVkMTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM3MzU3OQ==", "bodyText": "There's already an entry for azure-core. This line can be removed.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#discussion_r492373579", "createdAt": "2020-09-21T22:08:27Z", "author": {"login": "srnagar"}, "path": "eng/versioning/version_client.txt", "diffHunk": "@@ -130,6 +130,8 @@ com.microsoft.azure:spring-cloud-starter-azure-appconfiguration-config;1.2.8-bet\n # Format;\n # unreleased_<groupId>:<artifactId>;dependency-version\n # note: The unreleased dependencies will not be manipulated with the automatic PR creation code.\n+unreleased_com.azure:azure-core;1.9.0-beta.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a011ebd5e4392b61bf9576b39f5e4f1ea2481364"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM3NTExOA==", "bodyText": "I thought @JonathanGiles  suggested creating a separate interface PositionalHttpPipelinePolicy extends HttpPipelinePolicy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#discussion_r492375118", "createdAt": "2020-09-21T22:11:51Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/policy/HttpPipelinePolicy.java", "diffHunk": "@@ -17,11 +18,22 @@\n @FunctionalInterface\n public interface HttpPipelinePolicy {\n     /**\n-     * Process provided request context and invokes the next policy.\n+     * Processes provided request context and invokes the next policy.\n      *\n-     * @param context request context\n+     * @param context The request context.\n      * @param next The next policy to invoke.\n      * @return A publisher that initiates the request upon subscription and emits a response on completion.\n      */\n     Mono<HttpResponse> process(HttpPipelineCallContext context, HttpPipelineNextPolicy next);\n+\n+    /**\n+     * Gets the position to place the policy.\n+     * <p>\n+     * By default pipeline policies are positioned {@link HttpPipelinePosition#PER_RETRY}.\n+     *\n+     * @return The position to place the policy.\n+     */\n+    default HttpPipelinePosition getPipelinePosition() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a011ebd5e4392b61bf9576b39f5e4f1ea2481364"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a45f39ca005c86e2945bf06ddb63bef49ed326d", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2a45f39ca005c86e2945bf06ddb63bef49ed326d", "committedDate": "2020-09-21T23:01:34Z", "message": "Remove duplicate version entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff0907a9bf8b41694786a6df0e6ddd63e1af9154", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ff0907a9bf8b41694786a6df0e6ddd63e1af9154", "committedDate": "2020-09-23T18:08:23Z", "message": "Merge in master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTE0Mzk4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#pullrequestreview-495114398", "createdAt": "2020-09-23T23:17:32Z", "commit": {"oid": "ff0907a9bf8b41694786a6df0e6ddd63e1af9154"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzoxNzozMlrOHXEQng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzoxNzozMlrOHXEQng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0OTA4Ng==", "bodyText": "Should we call this pipeline \"position\" or should we name this as HttpPolicyEvaluationStrategy? Since this doesn't define the position but defines if this policy needs to be evaluated just once per call or evaluated for every retry attempt.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15105#discussion_r493949086", "createdAt": "2020-09-23T23:17:32Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/HttpPipelinePosition.java", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http;\n+\n+import com.azure.core.http.policy.HttpPipelinePolicy;\n+import com.azure.core.http.policy.RetryPolicy;\n+\n+/**\n+ * Indicates the position in an {@link HttpPipeline} to place an {@link HttpPipelinePolicy}.\n+ */\n+public enum HttpPipelinePosition {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff0907a9bf8b41694786a6df0e6ddd63e1af9154"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3430, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}