{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MDMwNjk0", "number": 11108, "title": "Enable connection via proxy for ManagementClient", "bodyText": "Currently we don't support connection via proxy for ManagementClient, but we have proxy support for QueueClient, SubscriptionClient, MessageSender, MessageReceiver via AMQP. This change will address the feature gap.\n#10311", "createdAt": "2020-05-12T23:40:30Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108", "merged": true, "mergeCommit": {"oid": "77bda965419380a5dc887a7e69cdcfc5bedb3f64"}, "closed": true, "closedAt": "2020-05-20T22:34:21Z", "author": {"login": "DorothySun216"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRNCP6gH2gAyNDE3MDMwNjk0OjQzYTcxNzYzYWRiYmJlN2Q5M2MzZmRlMGY4MmZmZTRlMWNiODljNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjPmx_AH2gAyNDE3MDMwNjk0OjE5MzAyZDJjMWZmY2Y5MmE1YThlODk5YWVhMDViMDRlMjllNWFmMWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "43a71763adbbbe7d93c3fde0f82ffe4e1cb89c50", "author": {"user": {"login": "DorothySun216", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/43a71763adbbbe7d93c3fde0f82ffe4e1cb89c50", "committedDate": "2020-03-25T19:54:01Z", "message": "getMessageSessions doc update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1393e1a09413123aa5cacc2a9cbeab44afef3282", "author": {"user": {"login": "DorothySun216", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1393e1a09413123aa5cacc2a9cbeab44afef3282", "committedDate": "2020-03-25T22:09:45Z", "message": "Revert \"getMessageSessions doc update\"\n\nThis reverts commit 43a71763adbbbe7d93c3fde0f82ffe4e1cb89c50."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d64438077b4aaf172307a621ae39623558a371c2", "author": {"user": {"login": "DorothySun216", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d64438077b4aaf172307a621ae39623558a371c2", "committedDate": "2020-05-12T23:31:32Z", "message": "Enable ManagementClient to use proxy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDk2NTIx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#pullrequestreview-410496521", "createdAt": "2020-05-12T23:42:20Z", "commit": {"oid": "d64438077b4aaf172307a621ae39623558a371c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzo0MjoyMFrOGUcsUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzo0MjoyMFrOGUcsUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5NDgwMQ==", "bodyText": "I don't quite know why this sample code has this line. Since I am using localhost and the host name will be different from service bus host. If I enable this line, the proxy cannot be created properly. I don't think this line is necessary but just want to point out.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#discussion_r424094801", "createdAt": "2020-05-12T23:42:20Z", "author": {"login": "DorothySun216"}, "path": "sdk/servicebus/microsoft-azure-servicebus/src/test/java/com/microsoft/azure/servicebus/ManagementClientProxyTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.microsoft.azure.servicebus;\n+\n+import com.microsoft.azure.servicebus.management.ManagementClient;\n+import com.microsoft.azure.servicebus.management.QueueDescription;\n+import com.microsoft.azure.servicebus.primitives.ServiceBusException;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import java.io.IOException;\n+import java.net.*;\n+import java.util.*;\n+import java.net.InetSocketAddress;\n+import java.net.ProxySelector;\n+import java.net.URI;\n+import java.util.LinkedList;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutionException;\n+\n+public class ManagementClientProxyTest {\n+    @Test\n+    public void managementClientWithProxy() throws InterruptedException, ServiceBusException {\n+        String proxyHostName = \"127.0.0.1\";\n+        int proxyPort = 8888;\n+        final ProxySelector systemDefaultSelector = ProxySelector.getDefault();\n+\n+        ProxySelector.setDefault(new ProxySelector() {\n+            @Override\n+            public List<Proxy> select(URI uri) {\n+                if (uri != null\n+                    && uri.getHost() != null\n+//                    && uri.getHost().equalsIgnoreCase(proxyHostName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d64438077b4aaf172307a621ae39623558a371c2"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDk3NTM5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#pullrequestreview-410497539", "createdAt": "2020-05-12T23:45:08Z", "commit": {"oid": "d64438077b4aaf172307a621ae39623558a371c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzo0NTowOVrOGUcvyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzo0NTowOVrOGUcvyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA5NTY4OQ==", "bodyText": "These three methods are taken out from ProxyConnectionHandler. Will leave as a TODO to make them as a util class and shared between these two classes.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#discussion_r424095689", "createdAt": "2020-05-12T23:45:09Z", "author": {"login": "DorothySun216"}, "path": "sdk/servicebus/microsoft-azure-servicebus/src/main/java/com/microsoft/azure/servicebus/management/ManagementClientAsync.java", "diffHunk": "@@ -92,9 +92,48 @@ public ManagementClientAsync(URI namespaceEndpointURI, ClientSettings clientSett\n         DefaultAsyncHttpClientConfig.Builder clientBuilder = Dsl.config()\n                 .setConnectTimeout((int) CONNECTION_TIMEOUT.toMillis())\n                 .setRequestTimeout((int) this.clientSettings.getOperationTimeout().toMillis());\n+\n+        if(shouldUseProxy(this.namespaceEndpointURI.getHost())){\n+            InetSocketAddress address = (InetSocketAddress)this.proxies.get(0).address();\n+            String proxyHostName=address.getHostName();\n+            int proxyPort=address.getPort();\n+\n+            clientBuilder.setProxyServer(new ProxyServer.Builder(proxyHostName,proxyPort));\n+        }\n+\n         this.asyncHttpClient = asyncHttpClient(clientBuilder);\n     }\n \n+    public boolean shouldUseProxy(final String hostName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d64438077b4aaf172307a621ae39623558a371c2"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTIwNzQ2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#pullrequestreview-411120746", "createdAt": "2020-05-13T16:56:51Z", "commit": {"oid": "d64438077b4aaf172307a621ae39623558a371c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjo1Njo1MlrOGU67NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjo1Njo1MlrOGU67NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5MDEzMw==", "bodyText": "I am wondering if it may be easier/better to set the properties in the client that enables the integration with the default mechanisms that Java networking uses for proxy configuration - documented here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .setRequestTimeout((int) this.clientSettings.getOperationTimeout().toMillis());\n          \n          \n            \n            \n          \n          \n            \n                    if(shouldUseProxy(this.namespaceEndpointURI.getHost())){\n          \n          \n            \n                        InetSocketAddress address = (InetSocketAddress)this.proxies.get(0).address();\n          \n          \n            \n                        String proxyHostName=address.getHostName();\n          \n          \n            \n                        int proxyPort=address.getPort();\n          \n          \n            \n            \n          \n          \n            \n                        clientBuilder.setProxyServer(new ProxyServer.Builder(proxyHostName,proxyPort));\n          \n          \n            \n                    }\n          \n          \n            \n                            .setUseProxySelector(true)\n          \n          \n            \n                            .setUseProxyProperties(true)\n          \n          \n            \n                            .setRequestTimeout((int) this.clientSettings.getOperationTimeout().toMillis());", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#discussion_r424590133", "createdAt": "2020-05-13T16:56:52Z", "author": {"login": "giventocode"}, "path": "sdk/servicebus/microsoft-azure-servicebus/src/main/java/com/microsoft/azure/servicebus/management/ManagementClientAsync.java", "diffHunk": "@@ -92,9 +92,48 @@ public ManagementClientAsync(URI namespaceEndpointURI, ClientSettings clientSett\n         DefaultAsyncHttpClientConfig.Builder clientBuilder = Dsl.config()\n                 .setConnectTimeout((int) CONNECTION_TIMEOUT.toMillis())\n                 .setRequestTimeout((int) this.clientSettings.getOperationTimeout().toMillis());\n+\n+        if(shouldUseProxy(this.namespaceEndpointURI.getHost())){\n+            InetSocketAddress address = (InetSocketAddress)this.proxies.get(0).address();\n+            String proxyHostName=address.getHostName();\n+            int proxyPort=address.getPort();\n+\n+            clientBuilder.setProxyServer(new ProxyServer.Builder(proxyHostName,proxyPort));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d64438077b4aaf172307a621ae39623558a371c2"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3eab7a8d86c30426152db8dcd8bb28f395abf8a", "author": {"user": {"login": "DorothySun216", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f3eab7a8d86c30426152db8dcd8bb28f395abf8a", "committedDate": "2020-05-19T22:33:14Z", "message": "draft changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "def43718804ec39c32255bfc204a4914e9a88751", "author": {"user": {"login": "DorothySun216", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/def43718804ec39c32255bfc204a4914e9a88751", "committedDate": "2020-05-19T22:42:28Z", "message": "working test version and modified managementclientasync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59ef0af035949ba3756b7d0b1782d2d339568baa", "author": {"user": {"login": "DorothySun216", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/59ef0af035949ba3756b7d0b1782d2d339568baa", "committedDate": "2020-05-19T22:52:03Z", "message": "get rid of unnecessary dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fca8dfd778cfe00fcbb67f4cba633350f4c9677a", "author": {"user": {"login": "DorothySun216", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/fca8dfd778cfe00fcbb67f4cba633350f4c9677a", "committedDate": "2020-05-20T00:09:17Z", "message": "add setUseProxyProperties(true) to enable setting http.Proxy\u00a0properties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NzExMzgw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#pullrequestreview-415711380", "createdAt": "2020-05-20T21:02:07Z", "commit": {"oid": "d64438077b4aaf172307a621ae39623558a371c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTowMjowN1rOGYdr6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTowMjowN1rOGYdr6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwNTM4NQ==", "bodyText": "managementClientWithProxy [](start = 16, length = 25)\n\nYou can ignore this test. The CI/CD machine doens't have a proxy server and hence this won't run there.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#discussion_r428305385", "createdAt": "2020-05-20T21:02:07Z", "author": {"login": "nemakam"}, "path": "sdk/servicebus/microsoft-azure-servicebus/src/test/java/com/microsoft/azure/servicebus/ManagementClientProxyTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.microsoft.azure.servicebus;\n+\n+import com.microsoft.azure.servicebus.management.ManagementClient;\n+import com.microsoft.azure.servicebus.management.QueueDescription;\n+import com.microsoft.azure.servicebus.primitives.ServiceBusException;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import java.io.IOException;\n+import java.net.*;\n+import java.util.*;\n+import java.net.InetSocketAddress;\n+import java.net.ProxySelector;\n+import java.net.URI;\n+import java.util.LinkedList;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutionException;\n+\n+public class ManagementClientProxyTest {\n+    @Test\n+    public void managementClientWithProxy() throws InterruptedException, ServiceBusException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d64438077b4aaf172307a621ae39623558a371c2"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NzExNTA5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11108#pullrequestreview-415711509", "createdAt": "2020-05-20T21:02:19Z", "commit": {"oid": "fca8dfd778cfe00fcbb67f4cba633350f4c9677a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19302d2c1ffcf92a5a8e899aea05b04e29e5af1f", "author": {"user": {"login": "DorothySun216", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/19302d2c1ffcf92a5a8e899aea05b04e29e5af1f", "committedDate": "2020-05-20T21:04:22Z", "message": "ignore the test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4276, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}