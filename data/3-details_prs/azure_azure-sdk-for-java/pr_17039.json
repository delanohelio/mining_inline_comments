{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMzIyOTM4", "number": 17039, "title": "[Service Bus] Calculate total timeout from AmqpRetryOptions", "bodyText": "Calculate the total timeout from an AmqpRetryOptions properties assuming all retries exhausted.", "createdAt": "2020-10-30T23:02:28Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039", "merged": true, "mergeCommit": {"oid": "f89adafe6a280cc94132974114b4513993ba8f85"}, "closed": true, "closedAt": "2020-11-02T17:57:01Z", "author": {"login": "YijunXieMS"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXu7bJAH2gAyNTEzMzIyOTM4OjM1YjcwMzg4OWI5NzRmNjIyY2JhZjVhZjJhNDU5MGFiM2ViMWY0NDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYoRi1gFqTUyMTg2MDk0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "35b703889b974f622cbaf5af2a4590ab3eb1f449", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/35b703889b974f622cbaf5af2a4590ab3eb1f449", "committedDate": "2020-10-30T22:58:02Z", "message": "Calculate total timeout from AmqpRetryOptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb", "committedDate": "2020-10-30T23:24:45Z", "message": "Changed code for java8 compatible"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDkxNjc2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#pullrequestreview-521091676", "createdAt": "2020-10-31T00:05:18Z", "commit": {"oid": "483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMDowNToxOVrOHrjTMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMDowODo0M1rOHrjVLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTE2OQ==", "bodyText": "getTotalTimeout makes more sense.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515429169", "createdAt": "2020-10-31T00:05:19Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java", "diffHunk": "@@ -610,7 +611,7 @@ public ServiceBusSenderAsyncClient buildAsyncClient() {\n          * @throws IllegalArgumentException if the entity type is not a queue or a topic.\n          */\n         public ServiceBusSenderClient buildClient() {\n-            return new ServiceBusSenderClient(buildAsyncClient(), retryOptions.getTryTimeout());\n+            return new ServiceBusSenderClient(buildAsyncClient(), MessageUtils.calcTotalTimeout(retryOptions));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTI3NQ==", "bodyText": "Can we spell out these abbreviations? calc -> calculate.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515429275", "createdAt": "2020-10-31T00:05:59Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/MessageUtilsTest.java", "diffHunk": "@@ -60,4 +68,33 @@ void convertUUIDToDotNetBytes() {\n         // Assert\n         assertArrayEquals(dotNetGuidBytes, convertedBytes, \"UUID conversion from Java to DotNet failed\");\n     }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"calcTotalTimeoutTestData\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTM2Nw==", "bodyText": "The order is assertEquals(expected, actual)", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515429367", "createdAt": "2020-10-31T00:06:36Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/MessageUtilsTest.java", "diffHunk": "@@ -60,4 +68,33 @@ void convertUUIDToDotNetBytes() {\n         // Assert\n         assertArrayEquals(dotNetGuidBytes, convertedBytes, \"UUID conversion from Java to DotNet failed\");\n     }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"calcTotalTimeoutTestData\")\n+    void calcTotalTimeout(List<Object> testData) {\n+        AmqpRetryOptions amqpRetryOptions = (AmqpRetryOptions) testData.get(0);\n+        long expectedResult = (long) testData.get(1);\n+        assertEquals(MessageUtils.calcTotalTimeout(amqpRetryOptions).toMillis(), expectedResult);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTY3OA==", "bodyText": "This is hard to read. You can pass in a Stream and it'll try to deserialize it into the actual typees. Look for uses in our other tests.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515429678", "createdAt": "2020-10-31T00:08:43Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/MessageUtilsTest.java", "diffHunk": "@@ -60,4 +68,33 @@ void convertUUIDToDotNetBytes() {\n         // Assert\n         assertArrayEquals(dotNetGuidBytes, convertedBytes, \"UUID conversion from Java to DotNet failed\");\n     }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"calcTotalTimeoutTestData\")\n+    void calcTotalTimeout(List<Object> testData) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17ed086e9979159cc1c41f054abd9f8512dfb325", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/17ed086e9979159cc1c41f054abd9f8512dfb325", "committedDate": "2020-10-31T00:32:25Z", "message": "Rename calcTotalTime to getTotalTime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb08b6bd29dc4006d054012cc4ad2c7334dc388a", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/eb08b6bd29dc4006d054012cc4ad2c7334dc388a", "committedDate": "2020-10-31T00:48:58Z", "message": "Use Arguments in parameterized test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff955c4251da7a166af6d3d1c70110e9b6dd1bb0", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ff955c4251da7a166af6d3d1c70110e9b6dd1bb0", "committedDate": "2020-10-31T01:01:21Z", "message": "remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMTEwMzcw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#pullrequestreview-521110370", "createdAt": "2020-10-31T03:58:59Z", "commit": {"oid": "ff955c4251da7a166af6d3d1c70110e9b6dd1bb0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMzo1ODo1OVrOHrksHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwMzo1ODo1OVrOHrksHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ1MTkzNQ==", "bodyText": "The default in AmqpRetryOption is  AmqpRetryMode.EXPONENTIAL  which is what we use in our builder. So by default most of our customer will use EXPONENTIAL and exponent of 2 based on this logic  and this is different from how we will do EXPONENTIAL retry for Connections\nhttps://github.com/Azure/azure-sdk-for-java/blob/master/sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/RetryUtil.java#L86\nI am not saying it should be same but I am pointing that it is different.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515451935", "createdAt": "2020-10-31T03:58:59Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java", "diffHunk": "@@ -68,6 +70,30 @@ public static Duration adjustServerTimeout(Duration clientTimeout) {\n         return clientTimeout.minusMillis(1000);\n     }\n \n+    /**\n+     * Calculate the total time from the retry options assuming all retries are exhausted.\n+     */\n+    public static Duration getTotalTimeout(AmqpRetryOptions retryOptions) {\n+        long tryTimeout = retryOptions.getTryTimeout().toNanos();\n+        long maxDelay = retryOptions.getMaxDelay().toNanos();\n+        long totalTimeout = tryTimeout;  // The original attempt not counted as a retry\n+        if (retryOptions.getMode() == AmqpRetryMode.FIXED) {\n+            totalTimeout += (retryOptions.getDelay().toNanos() + tryTimeout) * retryOptions.getMaxRetries();\n+        } else {\n+            int multiplier = 1;\n+            for (int i = 0; i < retryOptions.getMaxRetries(); i++) {\n+                long retryDelay = retryOptions.getDelay().toNanos() * multiplier;\n+                if (retryDelay >= maxDelay) {\n+                    retryDelay = maxDelay;\n+                    totalTimeout += (tryTimeout + retryDelay) * (retryOptions.getMaxRetries() - i);\n+                    break;\n+                }\n+                multiplier *= 2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff955c4251da7a166af6d3d1c70110e9b6dd1bb0"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMTEyNDk1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#pullrequestreview-521112495", "createdAt": "2020-10-31T04:44:43Z", "commit": {"oid": "ff955c4251da7a166af6d3d1c70110e9b6dd1bb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMzEwNTMz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#pullrequestreview-521310533", "createdAt": "2020-11-02T03:18:42Z", "commit": {"oid": "ff955c4251da7a166af6d3d1c70110e9b6dd1bb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxODYwOTQx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#pullrequestreview-521860941", "createdAt": "2020-11-02T17:45:34Z", "commit": {"oid": "ff955c4251da7a166af6d3d1c70110e9b6dd1bb0"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNzo0NTozNFrOHsPTCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNzo0Njo0NFrOHsPVsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MDAyNQ==", "bodyText": "Can we create an issue to move this logic into as a part of of AMQP Retry policy? It seems like a lot of special logic that could be aggregated into the different retry policies we have.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r516150025", "createdAt": "2020-11-02T17:45:34Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java", "diffHunk": "@@ -68,6 +70,30 @@ public static Duration adjustServerTimeout(Duration clientTimeout) {\n         return clientTimeout.minusMillis(1000);\n     }\n \n+    /**\n+     * Calculate the total time from the retry options assuming all retries are exhausted.\n+     */\n+    public static Duration getTotalTimeout(AmqpRetryOptions retryOptions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff955c4251da7a166af6d3d1c70110e9b6dd1bb0"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MDcwNw==", "bodyText": "One of the things we consider is \"jitter\" to each retry... so this may not be exact. But it may be enough.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r516150707", "createdAt": "2020-11-02T17:46:44Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java", "diffHunk": "@@ -68,6 +70,30 @@ public static Duration adjustServerTimeout(Duration clientTimeout) {\n         return clientTimeout.minusMillis(1000);\n     }\n \n+    /**\n+     * Calculate the total time from the retry options assuming all retries are exhausted.\n+     */\n+    public static Duration getTotalTimeout(AmqpRetryOptions retryOptions) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MDAyNQ=="}, "originalCommit": {"oid": "ff955c4251da7a166af6d3d1c70110e9b6dd1bb0"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1625, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}