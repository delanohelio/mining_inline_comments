{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyOTAzMTkz", "number": 7430, "title": "Fix cancellation handling", "bodyText": "This PR extends/adjusts conditions on tasks and jobs to better handle cancellations. We have some tasks in jobs with an always() condition which effectively stops that job being cancelled. We need to avoid that in most cases because we generally need to cancel jobs in an build storm and always() conditions slow down recovery time.", "createdAt": "2020-01-15T00:34:53Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430", "merged": true, "mergeCommit": {"oid": "3c3900adac2b9cd1ed421b6b50b3e0c6ef1f0f00"}, "closed": true, "closedAt": "2020-01-16T23:00:11Z", "author": {"login": "mitchdenny"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6eyYTgFqTM0Mjk5NTE5OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7DCOCAFqTM0NDI4OTk1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyOTk1MTk4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#pullrequestreview-342995198", "createdAt": "2020-01-15T05:29:16Z", "commit": {"oid": "799963dbec7ef1e9ab6e6fd3e49433b9f1901099"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNToyOToxNlrOFdtq1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNTozNDozMlrOFdtudw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTI3MQ==", "bodyText": "I would prefer to keep PublishTestResults as always().  This task should only take a few seconds, and when cancelling a build (say due to a hung test) it's valuable to publish the test results we do have so far.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r366701271", "createdAt": "2020-01-15T05:29:16Z", "author": {"login": "mikeharder"}, "path": "eng/pipelines/templates/jobs/archetype-sdk-client.yml", "diffHunk": "@@ -312,7 +312,7 @@ jobs:\n         condition: and(succeeded(), or(ne(variables['TestFromSource'],'true'), eq(variables['ShouldRunSourceTests'],'true')))\n \n       - task: PublishTestResults@2\n-        condition: and(always(), or(ne(variables['TestFromSource'],'true'), eq(variables['ShouldRunSourceTests'],'true')))\n+        condition: and(succeededOrFailed(), or(ne(variables['TestFromSource'],'true'), eq(variables['ShouldRunSourceTests'],'true')))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799963dbec7ef1e9ab6e6fd3e49433b9f1901099"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTY1Ng==", "bodyText": "Why skip ComponentGovernance if an earlier task failed (say Verify Readmes)?  Usually with analyze/test tasks, it's better to run as much as possible even if an earlier step failed.  I agree it should not be always() since we want to skip on cancel, but I think succeededOrFailed() is better than just succeeded().", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r366701656", "createdAt": "2020-01-15T05:31:33Z", "author": {"login": "mikeharder"}, "path": "eng/pipelines/templates/jobs/archetype-sdk-client.yml", "diffHunk": "@@ -146,7 +146,7 @@ jobs:\n       - task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0\n         # ComponentGovernance is currently unable to run on pull requests of public projects. Running on non-PR\n         # builds should be sufficient.\n-        condition: and(succeededOrFailed(), ne(variables['Build.Reason'], 'PullRequest'))\n+        condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799963dbec7ef1e9ab6e6fd3e49433b9f1901099"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTk2OQ==", "bodyText": "I believe all the jobs are run in parallel, so would there be any difference between succeeded() and succeededAndFailed() here?  If not then succeeded() is fine with me.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r366701969", "createdAt": "2020-01-15T05:33:11Z", "author": {"login": "mikeharder"}, "path": "eng/pipelines/templates/jobs/archetype-sdk-client.yml", "diffHunk": "@@ -119,7 +119,7 @@ jobs:\n         artifact: repository\n \n   - job: 'Analyze'\n-    condition: ne(variables['Skip.Analyze'], 'true')\n+    condition: and(succeeded(), ne(variables['Skip.Analyze'], 'true'))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799963dbec7ef1e9ab6e6fd3e49433b9f1901099"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMjE5OQ==", "bodyText": "Same comment as above.  I would prefer to keep always() for PublishTestResults.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r366702199", "createdAt": "2020-01-15T05:34:32Z", "author": {"login": "mikeharder"}, "path": "eng/pipelines/templates/jobs/archetype-sdk-tests.yml", "diffHunk": "@@ -107,13 +107,13 @@ jobs:\n             -ProvisionerApplicationSecret '$(provisioner-aad-secret)'\n             -Force\n             -Verbose\n-          condition: ne(variables['AZURE_RESOURCEGROUP_NAME'], '')\n+          condition: and(always(), ne(variables['AZURE_RESOURCEGROUP_NAME'], ''))\n           continueOnError: true\n           displayName: Remove Test Resources\n \n \n       - task: PublishTestResults@2\n-        condition: always()\n+        condition: succeededOrFailed()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799963dbec7ef1e9ab6e6fd3e49433b9f1901099"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cd23cbc2647fc8dc6971e496103ad28584ed10e", "author": {"user": {"login": "mitchdenny", "name": "Mitch Denny"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6cd23cbc2647fc8dc6971e496103ad28584ed10e", "committedDate": "2020-01-15T23:19:42Z", "message": "Adjust conditions to better handle cancellations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03af12bbbfc95a4dee5d7b779272264a14993595", "author": {"user": {"login": "mitchdenny", "name": "Mitch Denny"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/03af12bbbfc95a4dee5d7b779272264a14993595", "committedDate": "2020-01-15T23:46:42Z", "message": "Reacting to Mike's feedback."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "799963dbec7ef1e9ab6e6fd3e49433b9f1901099", "author": {"user": {"login": "mitchdenny", "name": "Mitch Denny"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/799963dbec7ef1e9ab6e6fd3e49433b9f1901099", "committedDate": "2020-01-15T00:30:41Z", "message": "Adjust conditions to better handle cancellations."}, "afterCommit": {"oid": "03af12bbbfc95a4dee5d7b779272264a14993595", "author": {"user": {"login": "mitchdenny", "name": "Mitch Denny"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/03af12bbbfc95a4dee5d7b779272264a14993595", "committedDate": "2020-01-15T23:46:42Z", "message": "Reacting to Mike's feedback."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjA2NzYy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#pullrequestreview-343606762", "createdAt": "2020-01-16T00:18:57Z", "commit": {"oid": "03af12bbbfc95a4dee5d7b779272264a14993595"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MTc3NzQ3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#pullrequestreview-344177747", "createdAt": "2020-01-16T19:58:21Z", "commit": {"oid": "03af12bbbfc95a4dee5d7b779272264a14993595"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0Mjg5MDA5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#pullrequestreview-344289009", "createdAt": "2020-01-16T23:45:32Z", "commit": {"oid": "03af12bbbfc95a4dee5d7b779272264a14993595"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQyMzo0NTozMlrOFerCTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQyMzo0NTozMlrOFerCTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcwNjcwMA==", "bodyText": "@mitchdenny why was this changed from parameters back to variables? Variables is going to try and pull from the pipeline variable SDKType which isn't set for every pipeline. Using the parameters should, in theory, guarantee that this only runs for the correct track.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367706700", "createdAt": "2020-01-16T23:45:32Z", "author": {"login": "JimSuplizio"}, "path": "eng/pipelines/templates/jobs/archetype-sdk-client.yml", "diffHunk": "@@ -253,7 +253,7 @@ jobs:\n \n       - task: Maven@3\n         displayName: 'Start Jetty'\n-        condition: ne('${{ parameters.SDKType }}', 'client')\n+        condition: and(succeeded(), ne(variables['SdkType'], 'client'))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03af12bbbfc95a4dee5d7b779272264a14993595"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0Mjg5OTU1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#pullrequestreview-344289955", "createdAt": "2020-01-16T23:48:36Z", "commit": {"oid": "03af12bbbfc95a4dee5d7b779272264a14993595"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 534, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}