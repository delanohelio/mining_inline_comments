{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5OTQyNzc3", "number": 18136, "title": "Add refresh token converter to fix scopes error", "bodyText": "add refresh token converter and argument resolver to fix getted scopes error when on-demond is false", "createdAt": "2020-12-15T03:12:24Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136", "merged": true, "mergeCommit": {"oid": "46ded35284e53420d9e8e26bd5deef64c6282e47"}, "closed": true, "closedAt": "2020-12-16T07:06:32Z", "author": {"login": "zhichengliu12581"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmAwA0AH2gAyNTM5OTQyNzc3OjQ1ZDM4OWFmZTdlMjMyODVhZGYzMjU4MmI5OTE0OWI1MmVmZmI1YTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmpaK5gFqTU1MzQwMzQ3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "45d389afe7e23285adf32582b99149b52effb5a2", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/45d389afe7e23285adf32582b99149b52effb5a2", "committedDate": "2020-12-14T07:38:48Z", "message": "add RefreshTokenGrantRequestEntityConverter works when use refresh_token get access_token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9ee1372f01160f3216dbf984ad364eb299f8974", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c9ee1372f01160f3216dbf984ad364eb299f8974", "committedDate": "2020-12-14T07:40:39Z", "message": "add AzureHandlerMethodArgumentResolver to change the DefaultOAuth2AuthorizedClientManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42d5e28fd6bbac556e2eccccd50eb0f5da7c3f85", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/42d5e28fd6bbac556e2eccccd50eb0f5da7c3f85", "committedDate": "2020-12-15T02:54:08Z", "message": "add WebMvcConfigurer to add Argument Resolvers which use custom authorized client manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b55a6097ad9bab0b4b88e8285f5c6769cdd4521", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b55a6097ad9bab0b4b88e8285f5c6769cdd4521", "committedDate": "2020-12-15T02:54:25Z", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into add-refresh-token-converter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d66f7d56a9745dc73130ebfe48ce6607eccdaab0", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d66f7d56a9745dc73130ebfe48ce6607eccdaab0", "committedDate": "2020-12-15T02:55:34Z", "message": "add dependency to support WebMvcConfigurer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24d4901cfcc6f58be47600f67a744190f1f8d804", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/24d4901cfcc6f58be47600f67a744190f1f8d804", "committedDate": "2020-12-15T03:01:18Z", "message": "Unified dependency version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9a8ac067b61e3261de7cb86ce0f22e491542640c", "committedDate": "2020-12-15T08:29:37Z", "message": "format code for pipeline"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMjM0ODQw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#pullrequestreview-552234840", "createdAt": "2020-12-15T09:03:10Z", "commit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwOTowMzoxMFrOIGAGUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwOTowMzoxMFrOIGAGUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE2Mzk4NQ==", "bodyText": "Make it to optional.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543163985", "createdAt": "2020-12-15T09:03:10Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/pom.xml", "diffHunk": "@@ -270,6 +270,11 @@\n       <artifactId>spring-core</artifactId>\n       <version>5.2.10.RELEASE</version> <!-- {x-version-update;org.springframework:spring-core;external_dependency} -->\n     </dependency>\n+    <dependency>\n+      <groupId>org.springframework</groupId>\n+      <artifactId>spring-webmvc</artifactId>\n+      <version>5.2.10.RELEASE</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMjM1MDE4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#pullrequestreview-552235018", "createdAt": "2020-12-15T09:03:24Z", "commit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwOTowMzoyNFrOIGAG3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwOTowMzoyNFrOIGAG3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE2NDEyNA==", "bodyText": "Not jms", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543164124", "createdAt": "2020-12-15T09:03:24Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/pom.xml", "diffHunk": "@@ -296,6 +301,7 @@\n                 <include>org.springframework:spring-core:[5.2.10.RELEASE]</include> <!-- {x-include-update;org.springframework:spring-core;external_dependency} -->\n                 <include>org.springframework:spring-web:[5.2.10.RELEASE]</include> <!-- {x-include-update;org.springframework:spring-web;external_dependency} -->\n                 <include>org.springframework:spring-jms:[5.2.10.RELEASE]</include> <!-- {x-include-update;org.springframework:spring-jms;external_dependency} -->\n+                <include>org.springframework:spring-webmvc:[5.2.10.RELEASE]</include> <!-- {x-include-update;org.springframework:spring-jms;external_dependency} -->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMjM2Njcx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#pullrequestreview-552236671", "createdAt": "2020-12-15T09:05:24Z", "commit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwOTowNToyNFrOIGAMEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwOTowNToyNFrOIGAMEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE2NTQ1Nw==", "bodyText": "So the only logic we added is the constructor?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543165457", "createdAt": "2020-12-15T09:05:24Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/AzureHandlerMethodArgumentResolver.java", "diffHunk": "@@ -0,0 +1,141 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapp;\n+\n+import org.springframework.core.MethodParameter;\n+import org.springframework.core.annotation.AnnotatedElementUtils;\n+import org.springframework.lang.Nullable;\n+import org.springframework.security.authentication.AnonymousAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.authority.AuthorityUtils;\n+import org.springframework.security.core.context.SecurityContextHolder;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizeRequest;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientProviderBuilder;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientProvider;\n+import org.springframework.security.oauth2.client.annotation.RegisteredOAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2AccessTokenResponseClient;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2ClientCredentialsGrantRequest;\n+import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;\n+import org.springframework.security.oauth2.client.web.DefaultOAuth2AuthorizedClientManager;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.util.Assert;\n+import org.springframework.util.StringUtils;\n+import org.springframework.web.bind.support.WebDataBinderFactory;\n+import org.springframework.web.context.request.NativeWebRequest;\n+import org.springframework.web.method.support.HandlerMethodArgumentResolver;\n+import org.springframework.web.method.support.ModelAndViewContainer;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+\n+/**\n+ * Azure handler method argument resolver to add custom OAuth2AuthorizedClientManager\n+ */\n+public final class AzureHandlerMethodArgumentResolver implements HandlerMethodArgumentResolver {\n+    private static final Authentication ANONYMOUS_AUTHENTICATION = new AnonymousAuthenticationToken(\n+        \"anonymous\", \"anonymousUser\", AuthorityUtils.createAuthorityList(\"ROLE_ANONYMOUS\"));\n+\n+    private final OAuth2AuthorizedClientManager authorizedClientManager;\n+\n+    private final boolean defaultAuthorizedClientManager;\n+\n+    public AzureHandlerMethodArgumentResolver(OAuth2AuthorizedClientManager authorizedClientManager) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMjM3OTY4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#pullrequestreview-552237968", "createdAt": "2020-12-15T09:06:58Z", "commit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwOTowNjo1OFrOIGAQKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwOTowNjo1OFrOIGAQKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE2NjUwNg==", "bodyText": "Do we need to make it as a bean?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543166506", "createdAt": "2020-12-15T09:06:58Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/AzureWebMvcConfigurer.java", "diffHunk": "@@ -0,0 +1,66 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapp;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientProvider;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientProviderBuilder;\n+import org.springframework.security.oauth2.client.endpoint.DefaultRefreshTokenTokenResponseClient;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2AccessTokenResponseClient;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2RefreshTokenGrantRequest;\n+import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;\n+import org.springframework.security.oauth2.client.web.DefaultOAuth2AuthorizedClientManager;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.web.method.support.HandlerMethodArgumentResolver;\n+import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n+\n+import java.util.List;\n+\n+/**\n+ * Abstract configuration class, used to make RefreshTokenGrantRequestEntityConverter take effect.\n+ */\n+public abstract class AzureWebMvcConfigurer implements WebMvcConfigurer {\n+\n+    @Autowired\n+    private AzureClientRegistrationRepository clientRegistrations;\n+\n+    @Autowired\n+    ClientRegistrationRepository clientRegistrationRepository;\n+\n+    @Autowired\n+    OAuth2AuthorizedClientRepository authorizedClientRepository;\n+\n+    public OAuth2AuthorizedClientManager authorizedClientManager(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMjM5NTUx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#pullrequestreview-552239551", "createdAt": "2020-12-15T09:08:45Z", "commit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwOTowODo0NVrOIGAVBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwOTowODo0NVrOIGAVBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE2Nzc0OQ==", "bodyText": "Can we use AzureActiveDirectoryConfiguration.AZURE_CLIENT_REGISTRATION_ID.equals(...)?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543167749", "createdAt": "2020-12-15T09:08:45Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/RefreshTokenGrantRequestEntityConverter.java", "diffHunk": "@@ -0,0 +1,46 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapp;\n+\n+import org.springframework.http.HttpEntity;\n+import org.springframework.http.RequestEntity;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2RefreshTokenGrantRequest;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2RefreshTokenGrantRequestEntityConverter;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.util.MultiValueMap;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+/**\n+ * Used to set \"scope\" parameter when use \"refresh_token\" to get \"access_token\".\n+ */\n+public class RefreshTokenGrantRequestEntityConverter extends OAuth2RefreshTokenGrantRequestEntityConverter {\n+\n+    private final List<ClientRegistration> otherClients;\n+\n+    public RefreshTokenGrantRequestEntityConverter(List<ClientRegistration> otherClients) {\n+        this.otherClients = otherClients;\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public RequestEntity<?> convert(OAuth2RefreshTokenGrantRequest refreshTokenGrantRequest) {\n+        RequestEntity<?> result = super.convert(refreshTokenGrantRequest);\n+        if (isRequestForDefaultClient(refreshTokenGrantRequest)) {\n+            Optional.ofNullable(result)\n+                .map(HttpEntity::getBody)\n+                .map(b -> (MultiValueMap<String, String>) b)\n+                .ifPresent(body -> body.add(\"scope\", scopeValue(refreshTokenGrantRequest)));\n+        }\n+        return result;\n+    }\n+\n+    private boolean isRequestForDefaultClient(OAuth2RefreshTokenGrantRequest request) {\n+        return otherClients.contains(request.getClientRegistration());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMjQ3Mzcw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#pullrequestreview-552247370", "createdAt": "2020-12-15T09:18:06Z", "commit": {"oid": "9a8ac067b61e3261de7cb86ce0f22e491542640c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74ac190d34cba1ff2f5ff17118718c02f61ab7dc", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/74ac190d34cba1ff2f5ff17118718c02f61ab7dc", "committedDate": "2020-12-15T09:44:51Z", "message": "code format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6065dffc8ba7d1f66a24261d82e0ac6ee7f6edb5", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6065dffc8ba7d1f66a24261d82e0ac6ee7f6edb5", "committedDate": "2020-12-15T09:46:38Z", "message": "remove unused function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf41c79c703bf09c245f3f938e51316270da9938", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/cf41c79c703bf09c245f3f938e51316270da9938", "committedDate": "2020-12-15T09:53:39Z", "message": "fix error for dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5a39d049033db60d05584eba4ebab64ca605438", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d5a39d049033db60d05584eba4ebab64ca605438", "committedDate": "2020-12-15T10:59:42Z", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into add-refresh-token-converter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMTYwNDEx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#pullrequestreview-553160411", "createdAt": "2020-12-16T00:20:07Z", "commit": {"oid": "cf41c79c703bf09c245f3f938e51316270da9938"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMDoyMDowN1rOIGl6lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMDozMjoxNVrOIGmM8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4MzU3Mw==", "bodyText": "It's not sample, this code will take effect. I prefer the following description:\nTemp solution to make RefreshTokenGrantRequestEntityConverter take effect.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543783573", "createdAt": "2020-12-16T00:20:07Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/AzureActiveDirectoryConfiguration.java", "diffHunk": "@@ -172,4 +206,21 @@ protected void configure(HttpSecurity http) throws Exception {\n                 .oidcUserService(oidcUserService);\n         }\n     }\n+\n+    /**\n+     * Sample configuration to make RefreshTokenGrantRequestEntityConverter take effect.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf41c79c703bf09c245f3f938e51316270da9938"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4NDA3OA==", "bodyText": "Use one space instead of two after *.\nNo space after issues.\nIt will be issue instead of issues.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543784078", "createdAt": "2020-12-16T00:21:33Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/AzureActiveDirectoryConfiguration.java", "diffHunk": "@@ -172,4 +206,21 @@ protected void configure(HttpSecurity http) throws Exception {\n                 .oidcUserService(oidcUserService);\n         }\n     }\n+\n+    /**\n+     * Sample configuration to make RefreshTokenGrantRequestEntityConverter take effect.\n+     * TODO: spring-security can't inject OAuth2AuthorizedClientManager to OAuth2AuthorizedClientArgumentResolver\n+     *  Future versions may support this , this may be a better solution\n+     *  issues : https://github.com/spring-projects/spring-security/issues/8700", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf41c79c703bf09c245f3f938e51316270da9938"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4NDQzMg==", "bodyText": "TODO: remove this logic after spring-security can inject OAuth2AuthorizedClientManager to OAuth2AuthorizedClientArgumentResolver", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543784432", "createdAt": "2020-12-16T00:22:23Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/AzureActiveDirectoryConfiguration.java", "diffHunk": "@@ -172,4 +206,21 @@ protected void configure(HttpSecurity http) throws Exception {\n                 .oidcUserService(oidcUserService);\n         }\n     }\n+\n+    /**\n+     * Sample configuration to make RefreshTokenGrantRequestEntityConverter take effect.\n+     * TODO: spring-security can't inject OAuth2AuthorizedClientManager to OAuth2AuthorizedClientArgumentResolver", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf41c79c703bf09c245f3f938e51316270da9938"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4NTYzNg==", "bodyText": "What is this method used for?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543785636", "createdAt": "2020-12-16T00:25:38Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/AzureWebMvcConfigurer.java", "diffHunk": "@@ -0,0 +1,36 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapp;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager;\n+import org.springframework.security.oauth2.client.endpoint.DefaultRefreshTokenTokenResponseClient;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2AccessTokenResponseClient;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2RefreshTokenGrantRequest;\n+import org.springframework.security.oauth2.client.web.method.annotation.OAuth2AuthorizedClientArgumentResolver;\n+import org.springframework.web.method.support.HandlerMethodArgumentResolver;\n+import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n+\n+import java.util.List;\n+\n+/**\n+ * Abstract configuration class, used to make RefreshTokenGrantRequestEntityConverter take effect.\n+ */\n+public abstract class AzureWebMvcConfigurer implements WebMvcConfigurer {\n+\n+    @Autowired\n+    OAuth2AuthorizedClientManager oAuth2AuthorizedClientManager;\n+\n+    public OAuth2AccessTokenResponseClient<OAuth2RefreshTokenGrantRequest> oAuth2AccessTokenResponseClient() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf41c79c703bf09c245f3f938e51316270da9938"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4NjU5MA==", "bodyText": "Can we delete AzureWebMvcConfigurer and let DefaultAzureWebMvcContext implements WebMvcConfigurer?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543786590", "createdAt": "2020-12-16T00:28:03Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/AzureWebMvcConfigurer.java", "diffHunk": "@@ -0,0 +1,36 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapp;\n+\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager;\n+import org.springframework.security.oauth2.client.endpoint.DefaultRefreshTokenTokenResponseClient;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2AccessTokenResponseClient;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2RefreshTokenGrantRequest;\n+import org.springframework.security.oauth2.client.web.method.annotation.OAuth2AuthorizedClientArgumentResolver;\n+import org.springframework.web.method.support.HandlerMethodArgumentResolver;\n+import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n+\n+import java.util.List;\n+\n+/**\n+ * Abstract configuration class, used to make RefreshTokenGrantRequestEntityConverter take effect.\n+ */\n+public abstract class AzureWebMvcConfigurer implements WebMvcConfigurer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf41c79c703bf09c245f3f938e51316270da9938"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4NzEwNA==", "bodyText": "I prefer AzureOauth2RefreshTokenGrantRequestEntityConverter.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543787104", "createdAt": "2020-12-16T00:29:21Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/RefreshTokenGrantRequestEntityConverter.java", "diffHunk": "@@ -0,0 +1,32 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.aad.webapp;\n+\n+import org.springframework.http.HttpEntity;\n+import org.springframework.http.RequestEntity;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2RefreshTokenGrantRequest;\n+import org.springframework.security.oauth2.client.endpoint.OAuth2RefreshTokenGrantRequestEntityConverter;\n+import org.springframework.util.MultiValueMap;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Used to set \"scope\" parameter when use \"refresh_token\" to get \"access_token\".\n+ */\n+public class RefreshTokenGrantRequestEntityConverter extends OAuth2RefreshTokenGrantRequestEntityConverter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf41c79c703bf09c245f3f938e51316270da9938"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4ODI3NA==", "bodyText": "Move this to AzureActiveDirectoryConfiguration", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543788274", "createdAt": "2020-12-16T00:32:15Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/AzureActiveDirectoryConfiguration.java", "diffHunk": "@@ -58,6 +67,31 @@ public OAuth2AuthorizedClientRepository authorizedClientRepository(AzureClientRe\n         return new AzureAuthorizedClientRepository(repo);\n     }\n \n+    @Bean\n+    @ConditionalOnProperty(prefix = \"azure.activedirectory.user-group\", value = \"allowed-groups\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf41c79c703bf09c245f3f938e51316270da9938"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e995c1a930e9c953002385f1e056971652fb10a2", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e995c1a930e9c953002385f1e056971652fb10a2", "committedDate": "2020-12-16T01:57:58Z", "message": "code format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59338bbf5304d724d07d3db8340803b7aa1129d6", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/59338bbf5304d724d07d3db8340803b7aa1129d6", "committedDate": "2020-12-16T02:20:54Z", "message": "code format for pipeline"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMzEzMDkw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#pullrequestreview-553313090", "createdAt": "2020-12-16T02:36:08Z", "commit": {"oid": "59338bbf5304d724d07d3db8340803b7aa1129d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMzczNDc3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#pullrequestreview-553373477", "createdAt": "2020-12-16T05:47:06Z", "commit": {"oid": "59338bbf5304d724d07d3db8340803b7aa1129d6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNTo0NzowNlrOIGyjsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNTo0NzowNlrOIGyjsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk5MDcwNg==", "bodyText": "We need add this dependency in azure-spring-boot-starter-active-directory. (without optional).", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#discussion_r543990706", "createdAt": "2020-12-16T05:47:06Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot/pom.xml", "diffHunk": "@@ -270,6 +270,12 @@\n       <artifactId>spring-core</artifactId>\n       <version>5.2.10.RELEASE</version> <!-- {x-version-update;org.springframework:spring-core;external_dependency} -->\n     </dependency>\n+    <dependency>\n+      <groupId>org.springframework</groupId>\n+      <artifactId>spring-webmvc</artifactId>\n+      <version>5.2.10.RELEASE</version> <!-- {x-version-update;org.springframework:spring-webmvc;external_dependency} -->\n+      <optional>true</optional>\n+    </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59338bbf5304d724d07d3db8340803b7aa1129d6"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31c5c669974d44ffab422f9b24c9899f48234030", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/31c5c669974d44ffab422f9b24c9899f48234030", "committedDate": "2020-12-16T06:09:46Z", "message": "add dependency in starter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db6dc31c8a2b6f4fa0ea9518e9c1f3204ecd8004", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/db6dc31c8a2b6f4fa0ea9518e9c1f3204ecd8004", "committedDate": "2020-12-16T06:00:47Z", "message": "add dependency in starter"}, "afterCommit": {"oid": "31c5c669974d44ffab422f9b24c9899f48234030", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/31c5c669974d44ffab422f9b24c9899f48234030", "committedDate": "2020-12-16T06:09:46Z", "message": "add dependency in starter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e72f4c7c998dd72e13a7f8d97434a8d61a3ff27f", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e72f4c7c998dd72e13a7f8d97434a8d61a3ff27f", "committedDate": "2020-12-16T06:15:21Z", "message": "fix error dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac9fbfda70c4cf192192e27f4538cc72ffede67a", "author": {"user": {"login": "zhichengliu12581", "name": "liuzhicheng"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ac9fbfda70c4cf192192e27f4538cc72ffede67a", "committedDate": "2020-12-16T06:29:20Z", "message": "add missing includes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDAzNDc4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18136#pullrequestreview-553403478", "createdAt": "2020-12-16T07:01:03Z", "commit": {"oid": "ac9fbfda70c4cf192192e27f4538cc72ffede67a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1241, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}