{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMDA2NjAx", "number": 11991, "title": "Address the issue of not using the retry-after delay from the latest response", "bodyText": "Fix for the issue: #11814", "createdAt": "2020-06-09T19:02:42Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11991", "merged": true, "mergeCommit": {"oid": "15b17945160cd193375d6db42bf2290b555f461b"}, "closed": true, "closedAt": "2020-06-11T16:34:41Z", "author": {"login": "anuchandy"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpp0t8AH2gAyNDMyMDA2NjAxOjlmN2NmZGRlZDAwZjZhMWMyNjc5NzMxYTAwNjA5NzJhYWNmMjc4MDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpq4xaAFqTQyNzUwNjYxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9f7cfdded00f6a1c2679731a0060972aacf27804", "author": {"user": {"login": "anuchandy", "name": "Anu Thomas Chandy"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9f7cfdded00f6a1c2679731a0060972aacf27804", "committedDate": "2020-06-09T19:00:40Z", "message": "Address the issue of not using the retry-after delay from the latest response."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDk4MDUw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11991#pullrequestreview-427498050", "createdAt": "2020-06-09T20:02:23Z", "commit": {"oid": "9f7cfdded00f6a1c2679731a0060972aacf27804"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NTA2NjE0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11991#pullrequestreview-427506614", "createdAt": "2020-06-09T20:14:59Z", "commit": {"oid": "9f7cfdded00f6a1c2679731a0060972aacf27804"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMDoxNDo1OVrOGhaj2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMDoxNDo1OVrOGhaj2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY5MTM1NA==", "bodyText": "The issue was incorrect scoping of getDelay method.\nThe getDelay() method called once subscription on outer Flux is applied. This result in whatever value that call to getDelay returns (say 3 sec)  gets hardcoded in delaySubscription, it looks like:\nMono.defer(() -> this.pollOperation.apply(cxt))\n    .delaySubscription(3)\n    .switchIfEmpty(Mono.error(new IllegalStateException(\"PollOperation returned Mono.empty().\")))\n    .repeat()\nthen when we repeat, this fixed value applied instead of a new call to getDelay to retrieve the new value.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11991#discussion_r437691354", "createdAt": "2020-06-09T20:14:59Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/polling/PollerFlux.java", "diffHunk": "@@ -217,8 +217,12 @@ public void subscribe(CoreSubscriber<? super AsyncPollResponse<T, U>> actual) {\n             () -> this.rootContext.copy(),\n             // Do polling\n             // set|read to|from context as needed, reactor guarantee thread-safety of cxt object.\n-            cxt -> Mono.defer(() -> this.pollOperation.apply(cxt))\n-                .delaySubscription(getDelay(cxt.getLatestResponse()))\n+            cxt -> Mono.defer(() -> {\n+                final Mono<PollResponse<T>> pollOnceMono = this.pollOperation.apply(cxt);\n+                // Execute (subscribe to) the pollOnceMono after the default poll-interval\n+                // or duration specified in the last retry-after response header elapses.\n+                return pollOnceMono.delaySubscription(getDelay(cxt.getLatestResponse()));\n+            })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f7cfdded00f6a1c2679731a0060972aacf27804"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3734, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}