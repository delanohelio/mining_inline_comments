{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMjMzNDk2", "number": 17546, "title": "[Service Bus] Allow 0 prefetch and dynamically use batch size to request link credits", "bodyText": "This PR is for sync receiving performance tuning and allow prefetch 0 to avoid the bad side effects of using a non-zero prefetch.\n\n0 prefetch is allowed, as in other languages. For ServiceBus, using prefetch risks of missing some messages especially in the RECEIVE_AND_DELETE mode. This is different from EventHubs, with which one can read an event for unlimited times.\nWhen the prefetch is 0, this sync API add link credits by maxMessages to remarkably improve performance as opposed to adding link credit one by one.\n\npublic IterableStream<ServiceBusReceivedMessage> receiveMessages(int maxMessages, Duration maxWaitTime)\n\n\nFixes a bug that adds too many link credits.", "createdAt": "2020-11-13T00:06:07Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546", "merged": true, "mergeCommit": {"oid": "ad184d30293b2ae528809c456abf4e1a7c048fd5"}, "closed": true, "closedAt": "2020-11-20T18:08:11Z", "author": {"login": "YijunXieMS"}, "timelineItems": {"totalCount": 41, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcOwsFAH2gAyNTIwMjMzNDk2OmZkMTg0M2E3MWFiODY1MjA4MzcxZGZmYTYxMDA2MTk0MjhmNjA1MTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeV8zbgH2gAyNTIwMjMzNDk2OjNjMjM1NDI3MDA0MjE1ZTcwODQzMDBjOWVjN2Q3NzhkYjkyMDZkYTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fd1843a71ab865208371dffa6100619428f60518", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/fd1843a71ab865208371dffa6100619428f60518", "committedDate": "2020-11-13T22:18:58Z", "message": "Link credit size adjustment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deadef5e144beb48cf493e529cb816471ea539bf", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/deadef5e144beb48cf493e529cb816471ea539bf", "committedDate": "2020-11-13T22:18:58Z", "message": "Add API to block and flow link credit to the service."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "945f1c875d87e27de464e84b9d1e450092c8521e", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/945f1c875d87e27de464e84b9d1e450092c8521e", "committedDate": "2020-11-13T22:18:58Z", "message": "Use addCreditsBlocking instead of addCredits to avoid too many credits added."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d07dd80a99c59a37624a873734b834e8a22e3a", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/98d07dd80a99c59a37624a873734b834e8a22e3a", "committedDate": "2020-11-13T22:18:59Z", "message": "Request fewer credits in the 2nd request if the 1st request returns fewer messages than requested. (by Hemant)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef52f71ffcb9c2e8d118a600bae7777f3d67b0c7", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ef52f71ffcb9c2e8d118a600bae7777f3d67b0c7", "committedDate": "2020-11-13T23:01:54Z", "message": "Rename addCreditsBlocking to addCreditsInstantly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36c4302a1f9be24ae9ff13748d37852b00f39ff3", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/36c4302a1f9be24ae9ff13748d37852b00f39ff3", "committedDate": "2020-11-13T23:02:30Z", "message": "Update amqp-core dependency version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1a5c4c438972e0db0ab0f22fc17f99f296926d68", "committedDate": "2020-11-13T23:03:24Z", "message": "Use remaining instead of bufferMessages.size() to calculate num of requested."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDcwODgy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#pullrequestreview-530470882", "createdAt": "2020-11-13T23:05:15Z", "commit": {"oid": "22c089334f9cf26166f9239797be9851a18f9c56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzowNToxNlrOHzCUyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzowNToxNlrOHzCUyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI3NzUxNQ==", "bodyText": "final for both the variables?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r523277515", "createdAt": "2020-11-13T23:05:16Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverClient.java", "diffHunk": "@@ -590,13 +590,14 @@ public void close() {\n     private void queueWork(int maximumMessageCount, Duration maxWaitTime,\n                            FluxSink<ServiceBusReceivedMessage> emitter) {\n         final long id = idGenerator.getAndIncrement();\n-        final SynchronousReceiveWork work = new SynchronousReceiveWork(id, maximumMessageCount, maxWaitTime, emitter);\n-\n+        int prefetch = asyncClient.getReceiverOptions().getPrefetchCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22c089334f9cf26166f9239797be9851a18f9c56"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3aa0bbed003da027a96b25fb75107aed702ae726", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3aa0bbed003da027a96b25fb75107aed702ae726", "committedDate": "2020-11-13T23:10:43Z", "message": "Merge branch 'sb_receiver_tuning' of github.com:YijunXieMS/azure-sdk-for-java into sb_receiver_tuning"}, "afterCommit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1a5c4c438972e0db0ab0f22fc17f99f296926d68", "committedDate": "2020-11-13T23:03:24Z", "message": "Use remaining instead of bufferMessages.size() to calculate num of requested."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTU5ODQ5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#pullrequestreview-530559849", "createdAt": "2020-11-14T07:01:10Z", "commit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwNzowMToxMFrOHzI_9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwNzowMToxMFrOHzI_9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4Njg3MQ==", "bodyText": "Should we do similar logic in SessionManager, Like we spoke over the chat.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r523386871", "createdAt": "2020-11-14T07:01:10Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusReceiveLinkProcessor.java", "diffHunk": "@@ -199,12 +198,7 @@ public void onNext(ServiceBusReceiveLink next) {\n             oldSubscription = currentLinkSubscriptions;\n \n             currentLink = next;\n-            next.setEmptyCreditListener(() -> {\n-                final int creditsToAdd = getCreditsToAdd(0);\n-                linkCreditsAdded.set(creditsToAdd > 0);\n-\n-                return creditsToAdd;\n-            });\n+            next.setEmptyCreditListener(() -> 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTYwMzAw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#pullrequestreview-530560300", "createdAt": "2020-11-14T07:11:01Z", "commit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwNzoxMTowMVrOHzJC-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwNzoxMTowMVrOHzJC-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NzY0Mw==", "bodyText": "Most of the calls into Proton-j Reactor is done via ReactorDispatcher because of thread safety,\nAs commented here ..\nhttps://github.com/Azure/azure-sdk-for-java/blob/master/sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorDispatcher.java#L22\nWould this be okay to call this api directly ? @srnagar  Would this be okay here ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r523387643", "createdAt": "2020-11-14T07:11:01Z", "author": {"login": "hemanttanwar"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorReceiver.java", "diffHunk": "@@ -107,6 +107,11 @@ public void addCredits(int credits) {\n         }\n     }\n \n+    @Override\n+    public void addCreditsInstantly(int credits) {\n+        receiver.flow(credits);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d43457ead26f42eeaa898432797b8cfc16c7cedd", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d43457ead26f42eeaa898432797b8cfc16c7cedd", "committedDate": "2020-11-16T19:57:00Z", "message": "Add backpressure in request for async receiveMessages()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34c70ce1a03abfe0890c72ae665bc5671c5b3459", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/34c70ce1a03abfe0890c72ae665bc5671c5b3459", "committedDate": "2020-11-16T20:54:23Z", "message": "Use limitRate instead of autoConnect for back pressure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7aa8bcea866d35fd43b2cd3f7652b03469f4366", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e7aa8bcea866d35fd43b2cd3f7652b03469f4366", "committedDate": "2020-11-16T21:38:59Z", "message": "rename receiveMessagesNoConnection to receiveMessagesNoBackPressure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "152e193bff7ff1a2bbe68954a823cd4cb5a902b8", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/152e193bff7ff1a2bbe68954a823cd4cb5a902b8", "committedDate": "2020-11-17T00:32:41Z", "message": "Add back pressure, adjust link credits using prefetch and request size for session receiver."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65cdcf6a0382f996f433fd8c47ba869cecc10d3c", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/65cdcf6a0382f996f433fd8c47ba869cecc10d3c", "committedDate": "2020-11-18T09:48:04Z", "message": "Fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4a14f0307babb02647313b44ceb89392428b254", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c4a14f0307babb02647313b44ceb89392428b254", "committedDate": "2020-11-18T10:04:44Z", "message": "Merge branch 'master' into sb_receiver_tuning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41d08ab090d8d66d19d58c682ad09b589ae57337", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/41d08ab090d8d66d19d58c682ad09b589ae57337", "committedDate": "2020-11-18T18:11:12Z", "message": "Small change (add final to variable)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "124baabb430f4908388bad5a4b3652e41e30920c", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/124baabb430f4908388bad5a4b3652e41e30920c", "committedDate": "2020-11-18T18:11:56Z", "message": "Add unreleased core-amqp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5743dcba32b2057760a1e434faefcea5a5cc899d", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5743dcba32b2057760a1e434faefcea5a5cc899d", "committedDate": "2020-11-18T20:46:31Z", "message": "SessionReceiver uses reactor prefetch 1 instead of default 256"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8986b2fb14b4f57778fde7224f0e4fe01b5cea61", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8986b2fb14b4f57778fde7224f0e4fe01b5cea61", "committedDate": "2020-11-18T22:33:18Z", "message": "Dispose SynchronousMessageSubscriber before closing async client in sync client's close()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTU4ODc4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#pullrequestreview-533958878", "createdAt": "2020-11-18T23:16:32Z", "commit": {"oid": "8986b2fb14b4f57778fde7224f0e4fe01b5cea61"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzoxNjozMlrOH2GLsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzoyMDo0NVrOH2GSBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4NjQ0OA==", "bodyText": "Just like we have addCreditsInstantly , adding locally , Does getCredits return from local? And if it is returning from remote, there could be short time when there is diff in local v/s remote .\nShould there is equivalent getCreditsInstantly ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526486448", "createdAt": "2020-11-18T23:16:32Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSessionReceiver.java", "diffHunk": "@@ -63,14 +63,23 @@\n         this.receiveLink = receiveLink;\n         this.lockContainer = new LockContainer<>(ServiceBusConstants.OPERATION_TIMEOUT);\n \n-        receiveLink.setEmptyCreditListener(() -> 1);\n+        receiveLink.setEmptyCreditListener(() -> 0);\n \n         final Flux<ServiceBusMessageContext> receivedMessagesFlux = receiveLink\n             .receive()\n             .publishOn(scheduler)\n             .doOnSubscribe(subscription -> {\n                 logger.verbose(\"Adding prefetch to receive link.\");\n-                receiveLink.addCredits(prefetch);\n+                if (prefetch > 0) {\n+                    receiveLink.addCreditsInstantly(prefetch);\n+                }\n+            })\n+            .doOnRequest(request -> {  // request is of type long.\n+                if (prefetch == 0) {  //  add \"request\" number of credits\n+                    receiveLink.addCreditsInstantly((int) request);\n+                } else {  // keep total credits \"prefetch\" if prefetch is not 0.\n+                    receiveLink.addCreditsInstantly(Math.max(0, prefetch - receiveLink.getCredits()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8986b2fb14b4f57778fde7224f0e4fe01b5cea61"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4ODA2OA==", "bodyText": "How we get this in this case where  credit will need to be Integer.MAX_VALUE ? And should it be max ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526488068", "createdAt": "2020-11-18T23:20:45Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusReceiveLinkProcessor.java", "diffHunk": "@@ -571,21 +562,28 @@ private int getCreditsToAdd(int linkCredits) {\n         }\n \n         final int creditsToAdd;\n-        if (messageQueue.isEmpty() && !hasBackpressure) {\n-            creditsToAdd = prefetch;\n+        final int expectedTotalCredit;\n+        if (prefetch == 0) {\n+            if (r <= Integer.MAX_VALUE) {\n+                expectedTotalCredit = (int) r;\n+            } else {\n+                expectedTotalCredit = Integer.MAX_VALUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8986b2fb14b4f57778fde7224f0e4fe01b5cea61"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39bac24f39c5f3c5ef04adacac103e7f9c69d7f0", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/39bac24f39c5f3c5ef04adacac103e7f9c69d7f0", "committedDate": "2020-11-19T01:45:45Z", "message": "Prefetch 1 in instead fo default 256"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5572e15137c73ad71ba9909bdbeed95ff0009f21", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5572e15137c73ad71ba9909bdbeed95ff0009f21", "committedDate": "2020-11-19T01:46:46Z", "message": "Add some code comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "530e258ba4057b366a852c743da4b13fbc26716b", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/530e258ba4057b366a852c743da4b13fbc26716b", "committedDate": "2020-11-19T01:51:44Z", "message": "set low tide 0 in limitRate() to disable replenish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/aee463cec1e1e55aeb4673c9324041d968f4d98a", "committedDate": "2020-11-19T08:25:46Z", "message": "use limitRate in async client and remove the limit in processor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MzAyMDcy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#pullrequestreview-534302072", "createdAt": "2020-11-19T10:57:54Z", "commit": {"oid": "530e258ba4057b366a852c743da4b13fbc26716b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDo1Nzo1NFrOH2XkpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMTowNzoxMlrOH2X6rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3MTM2NQ==", "bodyText": "As discussed earlier, this logic should be moved to the async client.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526771365", "createdAt": "2020-11-19T10:57:54Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusProcessorClient.java", "diffHunk": "@@ -150,8 +150,8 @@ private synchronized void receiveMessages() {\n         }\n         ServiceBusReceiverAsyncClient receiverClient = asyncClient.get();\n         receiverClient.receiveMessagesWithContext()\n-            .parallel(processorOptions.getMaxConcurrentCalls())\n-            .runOn(Schedulers.boundedElastic())\n+            .parallel(processorOptions.getMaxConcurrentCalls(), 1)\n+            .runOn(Schedulers.boundedElastic(), 1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530e258ba4057b366a852c743da4b13fbc26716b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3MTg3Nw==", "bodyText": "why is this required?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526771877", "createdAt": "2020-11-19T10:58:44Z", "author": {"login": "srnagar"}, "path": "eng/versioning/version_client.txt", "diffHunk": "@@ -177,7 +177,8 @@ com.microsoft:microsoft-opentelemetry-exporter-azuremonitor;1.0.0-beta.1;1.0.0-b\n # unreleased_<groupId>:<artifactId>;dependency-version\n # note: The unreleased dependencies will not be manipulated with the automatic PR creation code.\n unreleased_com.azure:azure-core-experimental;1.0.0-beta.9\n-unreleased_com.azure:azure-messaging-servicebus;7.0.0-beta.7\n+unreleased_com.azure:azure-messaging-servicebus;7.0.0-beta.8", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3Mzk1Ng==", "bodyText": "Why was this removed?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526773956", "createdAt": "2020-11-19T11:02:00Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusAsyncConsumer.java", "diffHunk": "@@ -34,9 +34,7 @@\n         this.linkProcessor = linkProcessor;\n         this.messageSerializer = messageSerializer;\n         this.processor = linkProcessor\n-            .map(message -> this.messageSerializer.deserialize(message, ServiceBusReceivedMessage.class))\n-            .publish(receiverOptions.getPrefetchCount())\n-            .autoConnect(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3NzAwNg==", "bodyText": "We need to support multiple calls to receiveMessages. So, this should be fixed.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526777006", "createdAt": "2020-11-19T11:07:12Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientTest.java", "diffHunk": "@@ -849,12 +849,15 @@ void canPerformMultipleReceive() {\n             .expectNextCount(numberOfEvents)\n             .verifyComplete();\n \n-        StepVerifier.create(receiver.receiveMessages().take(numberOfEvents))\n-            .then(() -> messages.forEach(m -> messageSink.next(m)))\n-            .expectNextCount(numberOfEvents)\n-            .verifyComplete();\n+        // TODO: Do we need to support multiple calls of receiver.receiveMessages()?\n+        //  After the autoConnect was removed from ServiceBusAsyncConsumer.processor, the receiver doesn't support\n+        //  multiple calls of receiver.receiveMessages().\n+//        StepVerifier.create(receiver.receiveMessages().take(numberOfEvents))\n+//            .then(() -> messages.forEach(m -> messageSink.next(m)))\n+//            .expectNextCount(numberOfEvents)\n+//            .verifyComplete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bafc0e47dc93df26e4ae2cdbe2a7b64e5f8de990", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bafc0e47dc93df26e4ae2cdbe2a7b64e5f8de990", "committedDate": "2020-11-19T20:38:38Z", "message": "autoConnect in receiveMessages() so it can be subscribed multiple times."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "037cbbcd575ff91a8dca8dd9dae1bd0a365a177f", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/037cbbcd575ff91a8dca8dd9dae1bd0a365a177f", "committedDate": "2020-11-19T20:41:13Z", "message": "Enable subscribe twice test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3774d66ce51d08a0e7796de0bcd03fcb04a1a59d", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3774d66ce51d08a0e7796de0bcd03fcb04a1a59d", "committedDate": "2020-11-19T21:23:07Z", "message": "Merge branch 'master' into sb_receiver_tuning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTAzNDU2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#pullrequestreview-534903456", "createdAt": "2020-11-19T22:18:18Z", "commit": {"oid": "3774d66ce51d08a0e7796de0bcd03fcb04a1a59d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTY3OTg4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#pullrequestreview-534967988", "createdAt": "2020-11-20T00:04:49Z", "commit": {"oid": "3774d66ce51d08a0e7796de0bcd03fcb04a1a59d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMDowNDo0OVrOH2269w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMDowNDo0OVrOH2269w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4NDk4Mw==", "bodyText": "This needs to be tested for thread-safety. If proton-j doesn't support adding credits in a thread-safe manner we might add incorrect number of credits to the link and can potentially result in data loss if the SB mode is RECEIVE_AND_DELETE", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r527284983", "createdAt": "2020-11-20T00:04:49Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorReceiver.java", "diffHunk": "@@ -107,6 +107,11 @@ public void addCredits(int credits) {\n         }\n     }\n \n+    @Override\n+    public void addCreditsInstantly(int credits) {\n+        receiver.flow(credits);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NzY0Mw=="}, "originalCommit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09fca43acc2f2b2dcfb4db8eab25bf8c9c2ecadf", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/09fca43acc2f2b2dcfb4db8eab25bf8c9c2ecadf", "committedDate": "2020-11-20T03:35:59Z", "message": "Use publish / autoConnect to support multiple subscribers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe7ee04541be8b3c11664899092dc5275db91513", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/fe7ee04541be8b3c11664899092dc5275db91513", "committedDate": "2020-11-20T04:38:18Z", "message": "put addCreditInstantly in synchronized block."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59aee7bd5168ba4eff9e84dd4126eb701be4f730", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/59aee7bd5168ba4eff9e84dd4126eb701be4f730", "committedDate": "2020-11-20T04:53:47Z", "message": "Format change for checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ea5ba65832f8952314706c68f59cb44df70719b", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8ea5ba65832f8952314706c68f59cb44df70719b", "committedDate": "2020-11-20T10:32:33Z", "message": "Use addCredits instead of addCreditsInstantly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24e34217562cdb82e2b8f8f7916bb1f8dd395d62", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/24e34217562cdb82e2b8f8f7916bb1f8dd395d62", "committedDate": "2020-11-20T10:34:02Z", "message": "Use addCredits instead of addCreditsInstantly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de311a8ae5fdab3b1fdbe15e02a9287a0c3f24d9", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/de311a8ae5fdab3b1fdbe15e02a9287a0c3f24d9", "committedDate": "2020-11-20T10:35:03Z", "message": "Remove autoConnect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29085d3d5e59bb1397e36bab521ff0010e9a772e", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/29085d3d5e59bb1397e36bab521ff0010e9a772e", "committedDate": "2020-11-20T10:47:48Z", "message": "Remove test case that subscribe receiveMessages() twice."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c837b5eac822a6ad19cbcbcf6f471b4d81bcecb", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4c837b5eac822a6ad19cbcbcf6f471b4d81bcecb", "committedDate": "2020-11-20T11:19:16Z", "message": "Use addCredits instead of addCreditsInstantly (update test)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c235427004215e7084300c9ec7d778db9206da4", "author": {"user": {"login": "YijunXieMS", "name": "Yijun Xie"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3c235427004215e7084300c9ec7d778db9206da4", "committedDate": "2020-11-20T11:49:23Z", "message": "Checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1685, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}