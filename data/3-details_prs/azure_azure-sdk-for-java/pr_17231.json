{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2MjU0MTc4", "number": 17231, "title": "Fixes issue where it would try to autocomplete/abandon messages that were already settled", "bodyText": "Adds a package-private isSettled method, like .NET where we keep track of whether the message is settled or not. If it is, then we do not attempt to complete it again.\nFixes error where we would continue to fetch messages upstream even though the downstream has been cancelled.\n\nFixes #17071", "createdAt": "2020-11-05T18:21:54Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17231", "merged": true, "mergeCommit": {"oid": "7cea25fa65987722eb19f311d4b52f0eae3bfb1b"}, "closed": true, "closedAt": "2020-11-06T01:25:01Z", "author": {"login": "conniey"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYuGFnAH2gAyNTE2MjU0MTc4OjI0Njc2YmZiMjNmOTRlNDU0ZThjMjAzZTcwYTIyYzA1NjAwNzI4NTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZrGZlgFqTUyNDc1NjMxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "24676bfb23f94e454e8c203e70a22c0560072856", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/24676bfb23f94e454e8c203e70a22c0560072856", "committedDate": "2020-11-03T00:33:42Z", "message": "Follow with .NET in not throwing error when RECEIVE_AND_DELETE mode is used and AutoComplete."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d36fe080d748ae6a4d939faf4eccc95051b54da1", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d36fe080d748ae6a4d939faf4eccc95051b54da1", "committedDate": "2020-11-03T00:34:15Z", "message": "Add package private isSettled to message."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dea6241f646dc3be2aa035a778d1c427b6c081e0", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/dea6241f646dc3be2aa035a778d1c427b6c081e0", "committedDate": "2020-11-03T00:36:44Z", "message": "Adding logic to set isSettled in client receiver and utilise it in AutoComplete."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "917ebaeabd8ba1a099f860e01f62210aa967cd18", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/917ebaeabd8ba1a099f860e01f62210aa967cd18", "committedDate": "2020-11-05T18:09:47Z", "message": "Cancelling upstream on error."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbe2551feef5526682e450fbfd646677638ef1cd", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/dbe2551feef5526682e450fbfd646677638ef1cd", "committedDate": "2020-11-05T18:11:11Z", "message": "Remove unneeded publish."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a4f06d076831c82174607856102319a08b4cd38", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3a4f06d076831c82174607856102319a08b4cd38", "committedDate": "2020-11-05T18:17:36Z", "message": "Adding AutoComplete cancellation tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff69cf8c09b57266bb215bb2b4d290af2997938b", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ff69cf8c09b57266bb215bb2b4d290af2997938b", "committedDate": "2020-11-05T18:45:25Z", "message": "Check for disposed before waiting for semaphore."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2b09eb5aacc267836f778732777313cf5806aaf", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f2b09eb5aacc267836f778732777313cf5806aaf", "committedDate": "2020-11-05T18:49:13Z", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into issue-17071"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53672ee6eb9f47dcd6d12f7c4a9b72cf4b4866a2", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/53672ee6eb9f47dcd6d12f7c4a9b72cf4b4866a2", "committedDate": "2020-11-05T18:51:24Z", "message": "Fix test."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NjgxNTU0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17231#pullrequestreview-524681554", "createdAt": "2020-11-05T21:20:36Z", "commit": {"oid": "53672ee6eb9f47dcd6d12f7c4a9b72cf4b4866a2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMToyMDozNlrOHuXHGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMToyOTowMVrOHuXYAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM3NTE5Mg==", "bodyText": "Do we need argument. ? Shouldn't this always set it to true", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17231#discussion_r518375192", "createdAt": "2020-11-05T21:20:36Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceivedMessage.java", "diffHunk": "@@ -508,12 +523,12 @@ void setEnqueuedTime(OffsetDateTime enqueuedTime) {\n     }\n \n     /**\n-     * Sets the subject for the message.\n+     * Sets whether the message has been settled.\n      *\n-     * @param subject The subject to set.\n+     * @param isSettled True if the message has been settled and false otherwise.\n      */\n-    void setSubject(String subject) {\n-        amqpAnnotatedMessage.getProperties().setSubject(subject);\n+    void setIsSettled(boolean isSettled) {\n+        this.isSettled = isSettled;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53672ee6eb9f47dcd6d12f7c4a9b72cf4b4866a2"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM3OTUyMw==", "bodyText": "If the message is already settled, we should throw error with message something like The message has either been deleted or already settled \nCheck line item 2 on this.\nhttps://microsoft.sharepoint.com/teams/AzureDeveloperExperience/_layouts/15/Doc.aspx?sourcedoc={41b0af1e-8da3-4d88-b296-9b616c3e7b6b}&action=edit&wd=target%28Design.one%7C14d18aa9-3941-cf4d-b2fa-4b211ac30733%2FException%5C%2FError%20handling%7Ce696adb4-72c6-4a64-85fb-1d187557099b%2F%29&wdorigin=703", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17231#discussion_r518379523", "createdAt": "2020-11-05T21:29:01Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1001,16 +1005,18 @@ private boolean isManagementToken(String lockToken) {\n                 logger.info(\"{}: Management node Update completed. Disposition: {}. Lock: {}.\",\n                     entityPath, dispositionStatus, lockToken);\n \n+                message.setIsSettled(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53672ee6eb9f47dcd6d12f7c4a9b72cf4b4866a2"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f95dfa7123b408c8c134f9f9f39d850801edd08", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2f95dfa7123b408c8c134f9f9f39d850801edd08", "committedDate": "2020-11-05T21:58:48Z", "message": "Set isSettled to true. Add error message."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzQ5OTgx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17231#pullrequestreview-524749981", "createdAt": "2020-11-05T23:23:10Z", "commit": {"oid": "2f95dfa7123b408c8c134f9f9f39d850801edd08"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzU2MzE5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17231#pullrequestreview-524756319", "createdAt": "2020-11-05T23:38:15Z", "commit": {"oid": "2f95dfa7123b408c8c134f9f9f39d850801edd08"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 271, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}