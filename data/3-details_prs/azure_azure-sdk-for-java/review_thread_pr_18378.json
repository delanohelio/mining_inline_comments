{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2MDcwODU5", "number": 18378, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODoxNTowOVrOFJte9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODo0MToyNVrOFJtzkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1NzI2NzExOnYy", "diffSide": "RIGHT", "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/selenium/AADSeleniumITHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODoxNTowOVrOIMJmyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODoxNTowOVrOIMJmyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYxMTIwOA==", "bodyText": "Can these 2 lines be combined?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18378#discussion_r549611208", "createdAt": "2020-12-29T08:15:09Z", "author": {"login": "yiliuTo"}, "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/selenium/AADSeleniumITHelper.java", "diffHunk": "@@ -0,0 +1,115 @@\n+package com.azure.test.aad.selenium;\n+\n+import com.azure.test.utils.AppRunner;\n+import org.junit.Assert;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.Keys;\n+import org.openqa.selenium.WebDriver;\n+import org.openqa.selenium.chrome.ChromeDriver;\n+import org.openqa.selenium.chrome.ChromeDriverService;\n+import org.openqa.selenium.chrome.ChromeOptions;\n+import org.openqa.selenium.support.ui.WebDriverWait;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.regex.Pattern;\n+\n+import static com.azure.test.aad.AADTestUtils.AAD_MULTI_TENANT_CLIENT_ID;\n+import static com.azure.test.aad.AADTestUtils.AAD_MULTI_TENANT_CLIENT_SECRET;\n+import static com.azure.test.aad.AADTestUtils.AAD_TENANT_ID_1;\n+import static com.azure.test.aad.AADTestUtils.AAD_USER_NAME_1;\n+import static com.azure.test.aad.AADTestUtils.AAD_USER_PASSWORD_1;\n+import static org.openqa.selenium.support.ui.ExpectedConditions.presenceOfElementLocated;\n+\n+public class AADSeleniumITHelper {\n+\n+    private final String username;\n+    private final String password;\n+    private final AppRunner app;\n+    private final WebDriver driver;\n+    private static final Map<String, String> DEFAULT_PROPERTIES = new HashMap<>();\n+\n+    static {\n+        DEFAULT_PROPERTIES.put(\"azure.activedirectory.tenant-id\", System.getenv(AAD_TENANT_ID_1));\n+        DEFAULT_PROPERTIES.put(\"azure.activedirectory.client-id\", System.getenv(AAD_MULTI_TENANT_CLIENT_ID));\n+        DEFAULT_PROPERTIES.put(\"azure.activedirectory.client-secret\", System.getenv(AAD_MULTI_TENANT_CLIENT_SECRET));\n+        DEFAULT_PROPERTIES.put(\"azure.activedirectory.user-group.allowed-groups\", \"group1\");\n+        DEFAULT_PROPERTIES.put(\"azure.activedirectory.post-logout-redirect-uri\", \"http://localhost:${server.port}\");\n+\n+        final String directory = \"src/test/resources/driver/\";\n+        final String chromedriverLinux = \"chromedriver_linux64\";\n+        final String chromedriverWin32 = \"chromedriver_win32.exe\";\n+        final String chromedriverMac = \"chromedriver_mac64\";\n+        String osName = System.getProperty(\"os.name\").toLowerCase();\n+        Process process = null;\n+        try {\n+            File dir = new File(directory);\n+            if (Pattern.matches(\"linux.*\", osName)) {\n+                process = Runtime.getRuntime().exec(\"chmod +x \" + chromedriverLinux, null, dir);\n+                process.waitFor();\n+                System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, directory + chromedriverLinux);\n+            } else if (Pattern.matches(\"windows.*\", osName)) {\n+                System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, directory + chromedriverWin32);\n+            } else if (Pattern.matches(\"mac.*\", osName)) {\n+                process = Runtime.getRuntime().exec(\"chmod +x \" + chromedriverMac, null, dir);\n+                process.waitFor();\n+                System.setProperty(ChromeDriverService.CHROME_DRIVER_EXE_PROPERTY, directory + chromedriverMac);\n+            } else {\n+                throw new IllegalStateException(\"Unrecognized osName. osName = \" + System.getProperty(\"os.name\"));\n+            }\n+        } catch (InterruptedException | IOException e) {\n+            throw new RuntimeException(e);\n+        } finally {\n+            if (process != null) {\n+                process.destroy();\n+            }\n+        }\n+    }\n+\n+    public AADSeleniumITHelper(Class<?> appClass, Map<String, String> properties) throws InterruptedException {\n+        username = System.getenv(AAD_USER_NAME_1);\n+        password = System.getenv(AAD_USER_PASSWORD_1);\n+        app = new AppRunner(appClass);\n+        DEFAULT_PROPERTIES.forEach(app::property);\n+        properties.forEach(app::property);\n+\n+        ChromeOptions options = new ChromeOptions();\n+        options.addArguments(\"--headless\");\n+        options.addArguments(\"--incognito\", \"--no-sandbox\", \"--disable-dev-shm-usage\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4224f91e381c28ad22d78bf0cc4fd1646fc6224"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1NzMxOTE3OnYy", "diffSide": "RIGHT", "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/selenium/access/token/scopes/AADAccessTokenScopesIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODo0MTowM1rOIMKERA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODo0MTowM1rOIMKERA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYxODc1Ng==", "bodyText": "Can we add checks on if the authorization code flow is executed for \"arm\" client or the same checks as above?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18378#discussion_r549618756", "createdAt": "2020-12-29T08:41:03Z", "author": {"login": "yiliuTo"}, "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/selenium/access/token/scopes/AADAccessTokenScopesIT.java", "diffHunk": "@@ -0,0 +1,95 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.test.aad.selenium.access.token.scopes;\n+\n+import com.azure.test.aad.selenium.AADSeleniumITHelper;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.annotation.RegisteredOAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.core.OAuth2AccessToken;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+public class AADAccessTokenScopesIT {\n+\n+    @Test\n+    public void testAccessTokenScopes() throws InterruptedException {\n+        Map<String, String> arguments = new HashMap<>();\n+        arguments.put(\n+            \"azure.activedirectory.authorization-clients.office.scopes\",\n+            \"https://manage.office.com/ActivityFeed.Read, https://manage.office.com/ActivityFeed.ReadDlp, \"\n+                + \"https://manage.office.com/ServiceHealth.Read\");\n+        arguments.put(\n+            \"azure.activedirectory.authorization-clients.graph.scopes\",\n+            \"https://graph.microsoft.com/User.Read, https://graph.microsoft.com/Directory.AccessAsUser.All\");\n+        AADSeleniumITHelper aadSeleniumITHelper = new AADSeleniumITHelper(DumbApp.class, arguments);\n+\n+        String httpResponse = aadSeleniumITHelper.httpGet(\"accessTokenScopes/azure\");\n+        Assert.assertTrue(httpResponse.contains(\"profile\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://graph.microsoft.com/Directory.AccessAsUser.All\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://graph.microsoft.com/User.Read\"));\n+\n+        httpResponse = aadSeleniumITHelper.httpGet(\"accessTokenScopes/graph\");\n+        Assert.assertTrue(httpResponse.contains(\"profile\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://graph.microsoft.com/Directory.AccessAsUser.All\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://graph.microsoft.com/User.Read\"));\n+\n+        httpResponse = aadSeleniumITHelper.httpGet(\"accessTokenScopes/office\");\n+        Assert.assertFalse(httpResponse.contains(\"profile\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://manage.office.com/ActivityFeed.Read\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://manage.office.com/ActivityFeed.ReadDlp\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://manage.office.com/ServiceHealth.Read\"));\n+\n+        httpResponse = aadSeleniumITHelper.httpGet(\"arm\");\n+        Assert.assertNotEquals(httpResponse, \"arm\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d43ca770b68cae51e222f40816ac6751e81c55af"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1NzMxOTg2OnYy", "diffSide": "RIGHT", "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/selenium/access/token/scopes/AADAccessTokenScopesIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODo0MToyNVrOIMKErQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODo0MToyNVrOIMKErQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYxODg2MQ==", "bodyText": "Why do we make arm controller different with the others?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18378#discussion_r549618861", "createdAt": "2020-12-29T08:41:25Z", "author": {"login": "yiliuTo"}, "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/selenium/access/token/scopes/AADAccessTokenScopesIT.java", "diffHunk": "@@ -0,0 +1,95 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.test.aad.selenium.access.token.scopes;\n+\n+import com.azure.test.aad.selenium.AADSeleniumITHelper;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.springframework.boot.autoconfigure.SpringBootApplication;\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.annotation.RegisteredOAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.core.OAuth2AccessToken;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+public class AADAccessTokenScopesIT {\n+\n+    @Test\n+    public void testAccessTokenScopes() throws InterruptedException {\n+        Map<String, String> arguments = new HashMap<>();\n+        arguments.put(\n+            \"azure.activedirectory.authorization-clients.office.scopes\",\n+            \"https://manage.office.com/ActivityFeed.Read, https://manage.office.com/ActivityFeed.ReadDlp, \"\n+                + \"https://manage.office.com/ServiceHealth.Read\");\n+        arguments.put(\n+            \"azure.activedirectory.authorization-clients.graph.scopes\",\n+            \"https://graph.microsoft.com/User.Read, https://graph.microsoft.com/Directory.AccessAsUser.All\");\n+        AADSeleniumITHelper aadSeleniumITHelper = new AADSeleniumITHelper(DumbApp.class, arguments);\n+\n+        String httpResponse = aadSeleniumITHelper.httpGet(\"accessTokenScopes/azure\");\n+        Assert.assertTrue(httpResponse.contains(\"profile\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://graph.microsoft.com/Directory.AccessAsUser.All\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://graph.microsoft.com/User.Read\"));\n+\n+        httpResponse = aadSeleniumITHelper.httpGet(\"accessTokenScopes/graph\");\n+        Assert.assertTrue(httpResponse.contains(\"profile\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://graph.microsoft.com/Directory.AccessAsUser.All\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://graph.microsoft.com/User.Read\"));\n+\n+        httpResponse = aadSeleniumITHelper.httpGet(\"accessTokenScopes/office\");\n+        Assert.assertFalse(httpResponse.contains(\"profile\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://manage.office.com/ActivityFeed.Read\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://manage.office.com/ActivityFeed.ReadDlp\"));\n+        Assert.assertTrue(httpResponse.contains(\"https://manage.office.com/ServiceHealth.Read\"));\n+\n+        httpResponse = aadSeleniumITHelper.httpGet(\"arm\");\n+        Assert.assertNotEquals(httpResponse, \"arm\");\n+    }\n+\n+    @EnableGlobalMethodSecurity(securedEnabled = true, prePostEnabled = true)\n+    @SpringBootApplication\n+    @RestController\n+    public static class DumbApp {\n+\n+        @GetMapping(value = \"accessTokenScopes/azure\")\n+        public Set<String> azure(\n+            @RegisteredOAuth2AuthorizedClient(\"azure\") OAuth2AuthorizedClient authorizedClient) {\n+            return Optional.of(authorizedClient)\n+                           .map(OAuth2AuthorizedClient::getAccessToken)\n+                           .map(OAuth2AccessToken::getScopes)\n+                           .orElse(null);\n+        }\n+\n+        @GetMapping(value = \"accessTokenScopes/graph\")\n+        public Set<String> graph(\n+            @RegisteredOAuth2AuthorizedClient(\"graph\") OAuth2AuthorizedClient authorizedClient) {\n+            return Optional.of(authorizedClient)\n+                           .map(OAuth2AuthorizedClient::getAccessToken)\n+                           .map(OAuth2AccessToken::getScopes)\n+                           .orElse(null);\n+        }\n+\n+        @GetMapping(value = \"accessTokenScopes/office\")\n+        public Set<String> office(\n+            @RegisteredOAuth2AuthorizedClient(\"office\") OAuth2AuthorizedClient authorizedClient) {\n+            return Optional.of(authorizedClient)\n+                           .map(OAuth2AuthorizedClient::getAccessToken)\n+                           .map(OAuth2AccessToken::getScopes)\n+                           .orElse(null);\n+        }\n+\n+        @GetMapping(value = \"arm\")\n+        public String arm(\n+            @RegisteredOAuth2AuthorizedClient(\"arm\") OAuth2AuthorizedClient authorizedClient) {\n+            return \"arm\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d43ca770b68cae51e222f40816ac6751e81c55af"}, "originalPosition": 91}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1749, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}