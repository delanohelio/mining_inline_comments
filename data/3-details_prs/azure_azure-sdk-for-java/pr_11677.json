{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NzU3MDM2", "number": 11677, "title": "Reset sync stream on retry", "bodyText": "When the sdk issued an automatic retry, we neglected to reset the data stream in the sync case. This would cause us to send a payload of 0s in the retried request. By resetting the stream on each subscription, we guarantee we'll send the correct data again.", "createdAt": "2020-06-02T18:27:25Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677", "merged": true, "mergeCommit": {"oid": "7dc9cf5b663ad38ad2a04ef781e2148e6efa9375"}, "closed": true, "closedAt": "2020-06-09T18:09:51Z", "author": {"login": "rickle-msft"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnFf13AH2gAyNDI2NzU3MDM2OmFiNmU0ZGVjNTU2ZWVjNzNjYzdkZWY5OGRjMjI4M2NiNTdhNTY2MWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnx_h0AH2gAyNDI2NzU3MDM2OjRkNWU2NGZkZjI2M2ZmNTkwZjAyZTIzYTIwMDMwMTlkMDA4MDI2N2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ab6e4dec556eec73cc7def98dc2283cb57a5661f", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ab6e4dec556eec73cc7def98dc2283cb57a5661f", "committedDate": "2020-06-01T19:33:26Z", "message": "Fixes to stream reset on retry. Needs cleanup and test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7b90b8c8cd8470a22cf0fadd3ac80147b929d2c", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b7b90b8c8cd8470a22cf0fadd3ac80147b929d2c", "committedDate": "2020-06-01T23:23:31Z", "message": "Clean up and docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28df97939ea64aa7fdbfed9f8b47179a04ff44f4", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/28df97939ea64aa7fdbfed9f8b47179a04ff44f4", "committedDate": "2020-06-02T18:14:31Z", "message": "Cleanup and added test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f66bb4e972fefde9f5fd860bf63289d87604725", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4f66bb4e972fefde9f5fd860bf63289d87604725", "committedDate": "2020-06-02T18:24:07Z", "message": "Merge remote-tracking branch 'upstream/master' into md5empty"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTc1MDkw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#pullrequestreview-422975090", "createdAt": "2020-06-02T19:03:47Z", "commit": {"oid": "4f66bb4e972fefde9f5fd860bf63289d87604725"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOTowMzo0N1rOGeAE8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOTowMzo0N1rOGeAE8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDExMTcyOA==", "bodyText": "Alternatively we can wrap the original Flux inside a Flux.defer and have\nfinal long[] currentTotalLength = new long[1];\ninside the defer which is some what more idiomatic I think.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#discussion_r434111728", "createdAt": "2020-06-02T19:03:47Z", "author": {"login": "anuchandy"}, "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/Utility.java", "diffHunk": "@@ -243,6 +243,18 @@ public static OffsetDateTime parseDate(String dateString) {\n                     throw LOGGER.logExceptionAsError(new RuntimeException(\"I/O errors occurs. Error details: \"\n                         + e.getMessage()));\n                 }\n+            })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f66bb4e972fefde9f5fd860bf63289d87604725"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTgxMzE4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#pullrequestreview-422981318", "createdAt": "2020-06-02T19:12:17Z", "commit": {"oid": "4f66bb4e972fefde9f5fd860bf63289d87604725"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOToxMjoxN1rOGeAYOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOToxMjoxN1rOGeAYOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDExNjY2NQ==", "bodyText": "Why do we mark Integer.MAX_VALUE? If we call reset after this the read position of the stream will be Integer.MAX_VALUE.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#discussion_r434116665", "createdAt": "2020-06-02T19:12:17Z", "author": {"login": "alzimmermsft"}, "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/BlockBlobClient.java", "diffHunk": "@@ -306,6 +313,8 @@ public void stageBlock(String base64BlockId, InputStream data, long length) {\n     public Response<Void> stageBlockWithResponse(String base64BlockId, InputStream data, long length, byte[] contentMd5,\n         String leaseId, Duration timeout, Context context) {\n         Objects.requireNonNull(data);\n+        data.mark(Integer.MAX_VALUE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f66bb4e972fefde9f5fd860bf63289d87604725"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTg3MDky", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#pullrequestreview-422987092", "createdAt": "2020-06-02T19:19:40Z", "commit": {"oid": "4f66bb4e972fefde9f5fd860bf63289d87604725"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOToxOTo0MFrOGeAppQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOToxOTo0MFrOGeAppQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyMTEyNQ==", "bodyText": "Not all input streams support reset(). Some may throw IOException as specified in javadoc. Also, if the input stream does support resetting the position, this will reset to the last marked position that may be different from where the user wanted us to read the stream from.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#discussion_r434121125", "createdAt": "2020-06-02T19:19:40Z", "author": {"login": "srnagar"}, "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/Utility.java", "diffHunk": "@@ -243,6 +243,18 @@ public static OffsetDateTime parseDate(String dateString) {\n                     throw LOGGER.logExceptionAsError(new RuntimeException(\"I/O errors occurs. Error details: \"\n                         + e.getMessage()));\n                 }\n+            })\n+            .doFirst(() -> {\n+                /*\n+                If the request needs to be retried, the flux will be resubscribed to. The stream and counter must be\n+                reset in order to correctly return the same data again.\n+                 */\n+                currentTotalLength[0] = 0;\n+                try {\n+                    data.reset();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f66bb4e972fefde9f5fd860bf63289d87604725"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d933cc11f893e28afd6da8305b29008a28f179a0", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d933cc11f893e28afd6da8305b29008a28f179a0", "committedDate": "2020-06-02T23:15:33Z", "message": "Ci fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzODk4MDU0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#pullrequestreview-423898054", "createdAt": "2020-06-03T20:18:47Z", "commit": {"oid": "d933cc11f893e28afd6da8305b29008a28f179a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzOTAwMDA5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#pullrequestreview-423900009", "createdAt": "2020-06-03T20:21:39Z", "commit": {"oid": "d933cc11f893e28afd6da8305b29008a28f179a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d5287dc682597227ad8e0b162e0470e95ca5dd2", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5d5287dc682597227ad8e0b162e0470e95ca5dd2", "committedDate": "2020-06-03T21:44:20Z", "message": "Merge branch 'master' into md5empty"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzOTg1NzM1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#pullrequestreview-423985735", "createdAt": "2020-06-03T22:39:27Z", "commit": {"oid": "5d5287dc682597227ad8e0b162e0470e95ca5dd2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMjozOToyN1rOGev9kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMjozOToyN1rOGev9kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg5NjI3Mw==", "bodyText": "Could we enforce the mark supported by calling?\nhttps://docs.oracle.com/javase/7/docs/api/java/io/InputStream.html#markSupported()", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#discussion_r434896273", "createdAt": "2020-06-03T22:39:27Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/specialized/AppendBlobClient.java", "diffHunk": "@@ -156,7 +156,8 @@ public AppendBlobItem create(boolean overwrite) {\n      *\n      * {@codesnippet com.azure.storage.blob.specialized.AppendBlobClient.appendBlock#InputStream-long}\n      *\n-     * @param data The data to write to the blob.\n+     * @param data The data to write to the blob. The data must be markable. This is in order to support retries. If", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d5287dc682597227ad8e0b162e0470e95ca5dd2"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzOTg2OTIx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#pullrequestreview-423986921", "createdAt": "2020-06-03T22:42:29Z", "commit": {"oid": "5d5287dc682597227ad8e0b162e0470e95ca5dd2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9f2e6666411d986f1769d7a99a2be92b2558f13", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d9f2e6666411d986f1769d7a99a2be92b2558f13", "committedDate": "2020-06-03T23:02:52Z", "message": "PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d7606ededa7c6767ff4d138b103f37fde5b03e5", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6d7606ededa7c6767ff4d138b103f37fde5b03e5", "committedDate": "2020-06-03T23:03:10Z", "message": "Merge branch 'md5empty' of github.com:rickle-msft/azure-sdk-for-java into md5empty"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzOTk4Mzc4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11677#pullrequestreview-423998378", "createdAt": "2020-06-03T23:12:04Z", "commit": {"oid": "6d7606ededa7c6767ff4d138b103f37fde5b03e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d5e64fdf263ff590f02e23a2003019d0080267b", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4d5e64fdf263ff590f02e23a2003019d0080267b", "committedDate": "2020-06-03T23:23:52Z", "message": "Ci"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3916, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}