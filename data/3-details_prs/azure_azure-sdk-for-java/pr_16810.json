{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMjE2MzU3", "number": 16810, "title": "Add Azure Service Fabric MI Support.", "bodyText": "Fixes #13468\nAdds Service Fabric Managed Identity Support to Managed Identity Credential in Identity SDK.", "createdAt": "2020-10-26T18:11:52Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810", "merged": true, "mergeCommit": {"oid": "e3e2b83121717752c166791b9df6fed21d70425c"}, "closed": true, "closedAt": "2020-11-09T18:04:17Z", "author": {"login": "g2vinay"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWKqLCgH2gAyNTEwMjE2MzU3OmU0YTgzYTIwZTI1ZGMwZDAzNjMyODU0NGE3M2EyZGZiMzg1ZWY5OWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda4LnLAFqTUyNjQ4NjI3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e4a83a20e25dc0d036328544a73a2dfb385ef99e", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e4a83a20e25dc0d036328544a73a2dfb385ef99e", "committedDate": "2020-10-26T02:08:41Z", "message": "add service fabric MI auth logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c652939b18448cbaa8ed463cd431fcf5903af480", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c652939b18448cbaa8ed463cd431fcf5903af480", "committedDate": "2020-11-04T19:11:37Z", "message": "update code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3377fa9787c3cbca02402679dce5a8a5b7ddf133", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3377fa9787c3cbca02402679dce5a8a5b7ddf133", "committedDate": "2020-11-04T19:13:10Z", "message": "update tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "712c6b6efe10839b8262632e8834b6c3f1e37fe7", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/712c6b6efe10839b8262632e8834b6c3f1e37fe7", "committedDate": "2020-11-04T20:01:52Z", "message": "refactor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "452e49dc517806be06e3af0d8802f3c8cf6209b6", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/452e49dc517806be06e3af0d8802f3c8cf6209b6", "committedDate": "2020-11-04T20:08:02Z", "message": "Merge remote-tracking branch 'upstream/master' into add-azure-services-mi-support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b284402e45374860e8adfdf98fe4b975d5fbe89", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8b284402e45374860e8adfdf98fe4b975d5fbe89", "committedDate": "2020-11-04T20:48:31Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7072dfe552b939d0b0d13846dc09672edc1fdb3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b7072dfe552b939d0b0d13846dc09672edc1fdb3", "committedDate": "2020-11-04T20:57:54Z", "message": "refactor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6377db80e111bc16f2ce842fcda5a9bd5d205bd5", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6377db80e111bc16f2ce842fcda5a9bd5d205bd5", "committedDate": "2020-11-04T20:59:45Z", "message": "refactor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fe913349ab413f63053bbca825d45fcfd1bbfec", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8fe913349ab413f63053bbca825d45fcfd1bbfec", "committedDate": "2020-11-04T21:15:41Z", "message": "refector code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNzU5Mzcz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#pullrequestreview-523759373", "createdAt": "2020-11-04T21:47:45Z", "commit": {"oid": "8fe913349ab413f63053bbca825d45fcfd1bbfec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNzU1ODk0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#pullrequestreview-523755894", "createdAt": "2020-11-04T21:41:47Z", "commit": {"oid": "8fe913349ab413f63053bbca825d45fcfd1bbfec"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTo0MTo0OFrOHtqs2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTo0MTo0OFrOHtqs2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY0NzU3Ng==", "bodyText": "Small fix:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * The Managed Service Identity credential for Azure App Service.\n          \n          \n            \n             * The Managed Service Identity credential for Azure Service Fabric.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517647576", "createdAt": "2020-11-04T21:41:48Z", "author": {"login": "mccoyp"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/ServiceFabricMsiCredential.java", "diffHunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity;\n+\n+import com.azure.core.annotation.Immutable;\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.identity.implementation.IdentityClient;\n+import reactor.core.publisher.Mono;\n+\n+/**\n+ * The Managed Service Identity credential for Azure App Service.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fe913349ab413f63053bbca825d45fcfd1bbfec"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTM0NzIy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#pullrequestreview-523934722", "createdAt": "2020-11-05T05:27:10Z", "commit": {"oid": "8fe913349ab413f63053bbca825d45fcfd1bbfec"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNToyNzoxMFrOHt0BNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNTozMzoyOFrOHt0HUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMDI0Nw==", "bodyText": "Similar to the comments in PR #13466, throw the exception here.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517800247", "createdAt": "2020-11-05T05:27:10Z", "author": {"login": "srnagar"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/ManagedIdentityCredential.java", "diffHunk": "@@ -36,14 +37,20 @@\n             .identityClientOptions(identityClientOptions)\n             .build();\n         Configuration configuration = Configuration.getGlobalConfiguration().clone();\n-        if (configuration.contains(Configuration.PROPERTY_MSI_ENDPOINT)\n-                || (configuration.contains(Configuration.PROPERTY_IDENTITY_ENDPOINT)\n-                        && configuration.contains(Configuration.PROPERTY_IDENTITY_HEADER))) {\n-            appServiceMSICredential = new AppServiceMsiCredential(clientId, identityClient);\n-            virtualMachineMSICredential = null;\n+        if (configuration.contains(Configuration.PROPERTY_IDENTITY_ENDPOINT)) {\n+            if (configuration.contains(Configuration.PROPERTY_IDENTITY_HEADER)) {\n+                if (configuration.contains(PROPERTY_IDENTITY_SERVER_THUMBPRINT)) {\n+                    managedIdentityServiceCredential = new ServiceFabricMsiCredential(clientId, identityClient);\n+                } else {\n+                    managedIdentityServiceCredential = new AppServiceMsiCredential(clientId, identityClient);\n+                }\n+            } else {\n+                managedIdentityServiceCredential = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fe913349ab413f63053bbca825d45fcfd1bbfec"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTA5NA==", "bodyText": "Can this be converted into an enum where all the environments are listed?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517801094", "createdAt": "2020-11-05T05:30:28Z", "author": {"login": "srnagar"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/ManagedIdentityServiceCredential.java", "diffHunk": "@@ -0,0 +1,61 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity;\n+\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.identity.implementation.IdentityClient;\n+import reactor.core.publisher.Mono;\n+\n+/**\n+ * The Managed Service Identity credential.\n+ */\n+abstract class ManagedIdentityServiceCredential {\n+    private final String clientId;\n+    private final String environment;\n+    final IdentityClient identityClient;\n+\n+    /**\n+     * Creates an instance of ManagedIdentityServiceCredential.\n+     * @param clientId the client id of user assigned or system assigned identity\n+     * @param identityClient the identity client to acquire a token with.\n+     * @param environment The service environment of the credential.\n+     */\n+    ManagedIdentityServiceCredential(String clientId, IdentityClient identityClient, String environment) {\n+        this.identityClient = identityClient;\n+        this.clientId = clientId;\n+        this.environment = environment;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fe913349ab413f63053bbca825d45fcfd1bbfec"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTQwNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class IdentitySSLUtil {\n          \n          \n            \n            public class IdentitySslUtil {", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517801405", "createdAt": "2020-11-05T05:31:49Z", "author": {"login": "srnagar"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/util/IdentitySSLUtil.java", "diffHunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation.util;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import javax.net.ssl.HostnameVerifier;\n+import javax.net.ssl.HttpsURLConnection;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.SSLSession;\n+import javax.net.ssl.SSLSocketFactory;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.X509TrustManager;\n+import java.security.KeyManagementException;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateEncodingException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+\n+public class IdentitySSLUtil {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fe913349ab413f63053bbca825d45fcfd1bbfec"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTY4OA==", "bodyText": "Since this is a static helper class, make the ctor private to avoid instantiation.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517801688", "createdAt": "2020-11-05T05:32:59Z", "author": {"login": "srnagar"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/util/IdentitySSLUtil.java", "diffHunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation.util;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import javax.net.ssl.HostnameVerifier;\n+import javax.net.ssl.HttpsURLConnection;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.SSLSession;\n+import javax.net.ssl.SSLSocketFactory;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.X509TrustManager;\n+import java.security.KeyManagementException;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateEncodingException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+\n+public class IdentitySSLUtil {\n+    public static final HostnameVerifier ALL_HOSTS_ACCEPT_HOSTNAME_VERIFIER;\n+\n+    static {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fe913349ab413f63053bbca825d45fcfd1bbfec"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMTgwOA==", "bodyText": "This can be converted to a static logger.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#discussion_r517801808", "createdAt": "2020-11-05T05:33:28Z", "author": {"login": "srnagar"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/util/IdentitySSLUtil.java", "diffHunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.identity.implementation.util;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import javax.net.ssl.HostnameVerifier;\n+import javax.net.ssl.HttpsURLConnection;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.SSLSession;\n+import javax.net.ssl.SSLSocketFactory;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.X509TrustManager;\n+import java.security.KeyManagementException;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateEncodingException;\n+import java.security.cert.CertificateException;\n+import java.security.cert.X509Certificate;\n+\n+public class IdentitySSLUtil {\n+    public static final HostnameVerifier ALL_HOSTS_ACCEPT_HOSTNAME_VERIFIER;\n+\n+    static {\n+        ALL_HOSTS_ACCEPT_HOSTNAME_VERIFIER = new HostnameVerifier() {\n+            @SuppressWarnings(\"BadHostnameVerifier\")\n+            @Override\n+            public boolean verify(String hostname, SSLSession session) {\n+                return true;\n+            }\n+        };\n+    }\n+\n+    /**\n+     *\n+     * Pins the specified HTTPS URL Connection to work against a specific server-side certificate with\n+     * the specified thumbprint only.\n+     *\n+     * @param className The class calling the method.\n+     * @param httpsUrlConnection The https url connection to configure\n+     * @param certificateThumbprint The thumbprint of the certificate\n+     */\n+    public static void addTrustedCertificateThumbprint(String className, HttpsURLConnection httpsUrlConnection,\n+                                                       String certificateThumbprint) {\n+\n+        ClientLogger logger = new ClientLogger(className);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fe913349ab413f63053bbca825d45fcfd1bbfec"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "157448c1c8ec329ca0b4a2f1a20aec303236bf0b", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/157448c1c8ec329ca0b4a2f1a20aec303236bf0b", "committedDate": "2020-11-05T18:55:31Z", "message": "address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc1079dcbfacfb300dfdbe07bcc4fb124dd7565d", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/cc1079dcbfacfb300dfdbe07bcc4fb124dd7565d", "committedDate": "2020-11-05T18:56:45Z", "message": "update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NjMzNzI2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#pullrequestreview-524633726", "createdAt": "2020-11-05T20:17:52Z", "commit": {"oid": "cc1079dcbfacfb300dfdbe07bcc4fb124dd7565d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NDg2Mjc1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16810#pullrequestreview-526486275", "createdAt": "2020-11-09T17:26:38Z", "commit": {"oid": "cc1079dcbfacfb300dfdbe07bcc4fb124dd7565d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1649, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}