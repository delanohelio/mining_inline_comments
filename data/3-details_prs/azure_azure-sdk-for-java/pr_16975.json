{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNjAxOTUx", "number": 16975, "title": "Fix digital twins client not deserializing date times correctly", "bodyText": "Also fix BasicDigitalTwinMetadata to use the DigitalTwinPropertyMetadata class\nAlso mark DigitalTwinPropertyMetadata as fluent and final as per Azure SDK feedback\nFor some context:\n#16938", "createdAt": "2020-10-29T22:18:31Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975", "merged": true, "mergeCommit": {"oid": "15e7cf0a53c8c01ad9a057a9ec75084aedf3688f"}, "closed": true, "closedAt": "2020-10-29T23:43:00Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXZuUpgH2gAyNTEyNjAxOTUxOjZkOGU1YTY0NDM1NDkxM2M4Y2JkODk5ODJhMjUxMWZmY2YzMmNlNzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXa0qmgFqTUyMDE1OTE3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6d8e5a644354913c8cbd89982a2511ffcf32ce75", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6d8e5a644354913c8cbd89982a2511ffcf32ce75", "committedDate": "2020-10-29T22:15:43Z", "message": "Fix digital twins client not deserializing date times correctly\n\nAlso fix BasicDigitalTwinMetadata to use the DigitalTwinPropertyMetadata class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTMwMzkz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#pullrequestreview-520130393", "createdAt": "2020-10-29T22:21:26Z", "commit": {"oid": "6d8e5a644354913c8cbd89982a2511ffcf32ce75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMjoyMToyNlrOHqwwig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMjoyMToyNlrOHqwwig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwMTA5OA==", "bodyText": "The issue was that we used a different mapper in our convenience layer than we did in our generated layer. The generated layer one (from jacksonAdapter.serializer()) has a lot of useful modules registered already, including a module for parsing of date times. By simply using the generated layer's adapter in this layer as well, this issue is solved", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#discussion_r514601098", "createdAt": "2020-10-29T22:21:26Z", "author": {"login": "timtay-microsoft"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsAsyncClient.java", "diffHunk": "@@ -53,17 +54,18 @@\n @ServiceClient(builder = DigitalTwinsClientBuilder.class, isAsync = true)\n public final class DigitalTwinsAsyncClient {\n     private static final ClientLogger logger = new ClientLogger(DigitalTwinsAsyncClient.class);\n-    private static final ObjectMapper mapper = new ObjectMapper();\n+    private static ObjectMapper mapper;\n     private final DigitalTwinsServiceVersion serviceVersion;\n     private final AzureDigitalTwinsAPIImpl protocolLayer;\n     private static final Boolean includeModelDefinitionOnGet = true;\n     private final JsonSerializer serializer;\n \n     DigitalTwinsAsyncClient(String serviceEndpoint, HttpPipeline pipeline, DigitalTwinsServiceVersion serviceVersion, JsonSerializer jsonSerializer) {\n         final SimpleModule stringModule = new SimpleModule(\"String Serializer\");\n-        stringModule.addSerializer(new DigitalTwinsStringSerializer(String.class, mapper));\n \n         JacksonAdapter jacksonAdapter = new JacksonAdapter();\n+        mapper = jacksonAdapter.serializer(); // Use the same mapper in this layer that the generated layer will use\n+        stringModule.addSerializer(new DigitalTwinsStringSerializer(String.class, mapper));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d8e5a644354913c8cbd89982a2511ffcf32ce75"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTMyMTgy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#pullrequestreview-520132182", "createdAt": "2020-10-29T22:25:22Z", "commit": {"oid": "6d8e5a644354913c8cbd89982a2511ffcf32ce75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMjoyNToyMlrOHqw2SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMjoyNToyMlrOHqw2SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwMjU2OA==", "bodyText": "This is the module that was missing from our default mapper in the digital twins client. We get this module for free when we construct the JacksonAdapter and call .serializer() on that jacksonAdapter. We need to explicitly use it here, though", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#discussion_r514602568", "createdAt": "2020-10-29T22:25:22Z", "author": {"login": "timtay-microsoft"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/ComponentSyncSamples.java", "diffHunk": "@@ -46,6 +51,10 @@ public static void main(String[] args) throws IOException {\n                     .setLogLevel(parsedArguments.getHttpLogDetailLevel()))\n             .buildClient();\n \n+        // This mapper gets used to deserialize a digital twin that has a date time within a property metadata, so it\n+        // needs to have this module in order to correctly deserialize that date time\n+        mapper.registerModule(new JavaTimeModule());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d8e5a644354913c8cbd89982a2511ffcf32ce75"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTMyODQw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#pullrequestreview-520132840", "createdAt": "2020-10-29T22:26:45Z", "commit": {"oid": "6d8e5a644354913c8cbd89982a2511ffcf32ce75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88df5824d155dbe0b7353d966e266039c3200f69", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/88df5824d155dbe0b7353d966e266039c3200f69", "committedDate": "2020-10-29T22:34:57Z", "message": "fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f21ef76d78deade59960bb51841b12ae6130307", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8f21ef76d78deade59960bb51841b12ae6130307", "committedDate": "2020-10-29T22:54:29Z", "message": "fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4973e80ee946d484680622f1d69ee53555068a8", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a4973e80ee946d484680622f1d69ee53555068a8", "committedDate": "2020-10-29T23:01:21Z", "message": "Revert \"fixup\"\n\nThis reverts commit 8f21ef76d78deade59960bb51841b12ae6130307."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdfdb832f6614e7b8e2d4c4eee041c5227df3b1e", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/fdfdb832f6614e7b8e2d4c4eee041c5227df3b1e", "committedDate": "2020-10-29T23:05:22Z", "message": "fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTU3OTUw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#pullrequestreview-520157950", "createdAt": "2020-10-29T23:29:13Z", "commit": {"oid": "fdfdb832f6614e7b8e2d4c4eee041c5227df3b1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMzoyOToxM1rOHqyNCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMzoyOToxM1rOHqyNCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyNDc3OQ==", "bodyText": "Do we still need this string serializer? Are there any APIs that still operate on Strings? I thought we got rid of all those, and everything was objects now.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#discussion_r514624779", "createdAt": "2020-10-29T23:29:13Z", "author": {"login": "abhipsaMisra"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/main/java/com/azure/digitaltwins/core/DigitalTwinsAsyncClient.java", "diffHunk": "@@ -53,17 +54,18 @@\n @ServiceClient(builder = DigitalTwinsClientBuilder.class, isAsync = true)\n public final class DigitalTwinsAsyncClient {\n     private static final ClientLogger logger = new ClientLogger(DigitalTwinsAsyncClient.class);\n-    private static final ObjectMapper mapper = new ObjectMapper();\n+    private ObjectMapper mapper;\n     private final DigitalTwinsServiceVersion serviceVersion;\n     private final AzureDigitalTwinsAPIImpl protocolLayer;\n     private static final Boolean includeModelDefinitionOnGet = true;\n     private final JsonSerializer serializer;\n \n     DigitalTwinsAsyncClient(String serviceEndpoint, HttpPipeline pipeline, DigitalTwinsServiceVersion serviceVersion, JsonSerializer jsonSerializer) {\n         final SimpleModule stringModule = new SimpleModule(\"String Serializer\");\n-        stringModule.addSerializer(new DigitalTwinsStringSerializer(String.class, mapper));\n \n         JacksonAdapter jacksonAdapter = new JacksonAdapter();\n+        mapper = jacksonAdapter.serializer(); // Use the same mapper in this layer that the generated layer will use\n+        stringModule.addSerializer(new DigitalTwinsStringSerializer(String.class, mapper));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdfdb832f6614e7b8e2d4c4eee041c5227df3b1e"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTU5MTc3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16975#pullrequestreview-520159177", "createdAt": "2020-10-29T23:32:33Z", "commit": {"oid": "fdfdb832f6614e7b8e2d4c4eee041c5227df3b1e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1578, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}