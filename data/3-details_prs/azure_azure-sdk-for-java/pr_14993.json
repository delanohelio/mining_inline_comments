{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMTY3Mzkw", "number": 14993, "title": "Adds support for capturing CPU history in the request diagnostics", "bodyText": "Adds support for CPU history\nsample:\ncpu history in the request diagnostics\n\"systemCpuLoad\":\" (2020-09-09T21:46:35.284390Z 90.1%), (2020-09-09T21:46:45.283370Z 66.8%), (2020-09-09T21:46:55.283593Z 26.7%)\nTODO: we should move other system related info to also get captured with similar pattern as cpu history.", "createdAt": "2020-09-09T22:11:57Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14993", "merged": true, "mergeCommit": {"oid": "69f5467cb47145dc6aaf9c9ec4a6e642f728e0aa"}, "closed": true, "closedAt": "2020-09-11T14:50:59Z", "author": {"login": "moderakh"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFqKZ3AH2gAyNDgzMTY3MzkwOmU1MWFhNjI4YTQ3Y2FmM2Y3YzE3YTBiMjYwYzZkMWRkYjQ1MTgzZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHp00HAH2gAyNDgzMTY3MzkwOjA3NTFlODk4MzdmZDA1MTIxNjY0Yjc2ZDY2NjY2YjVjM2FlN2EyNTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e51aa628a47caf3f7c17a0b260c6d1ddb45183df", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e51aa628a47caf3f7c17a0b260c6d1ddb45183df", "committedDate": "2020-09-04T19:14:14Z", "message": "cpu history initial work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b167e02350090abc0e6b79059d2e8263edda5930", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b167e02350090abc0e6b79059d2e8263edda5930", "committedDate": "2020-09-08T16:29:03Z", "message": "Merge branch 'master' into users/moderakh/cpu-history"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eeff63c5421ad0f2d12d598d71af9db483b81714", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/eeff63c5421ad0f2d12d598d71af9db483b81714", "committedDate": "2020-09-09T20:00:03Z", "message": "cpu history working"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad5f140a14adf94d258acc2f799adfae5aaa98c1", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ad5f140a14adf94d258acc2f799adfae5aaa98c1", "committedDate": "2020-09-09T20:01:28Z", "message": "use deamon thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6159fd116ddc8bae39ec37ab8a076e1fefc43d12", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6159fd116ddc8bae39ec37ab8a076e1fefc43d12", "committedDate": "2020-09-09T20:20:31Z", "message": "counter based model works"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72d48db0b29200835e199315160218adc5bd1616", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/72d48db0b29200835e199315160218adc5bd1616", "committedDate": "2020-09-09T21:59:04Z", "message": "cpu history with register pattern"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bd822c6147a00c5ce4ee2a7d9a4f4aee25cc7ea", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5bd822c6147a00c5ce4ee2a7d9a4f4aee25cc7ea", "committedDate": "2020-09-09T22:00:47Z", "message": "comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60fd433ceca144c91f7d5e091d155e5098c6cfc7", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/60fd433ceca144c91f7d5e091d155e5098c6cfc7", "committedDate": "2020-09-09T22:11:48Z", "message": "cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NjQxOTAx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14993#pullrequestreview-485641901", "createdAt": "2020-09-10T07:12:13Z", "commit": {"oid": "60fd433ceca144c91f7d5e091d155e5098c6cfc7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzoxMjoxM1rOHPmGzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzoxMjoxM1rOHPmGzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjExNTAyMQ==", "bodyText": "Negative value should also be mapped to Double.NaN ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14993#discussion_r486115021", "createdAt": "2020-09-10T07:12:13Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/cpu/CpuReader.java", "diffHunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.cpu;\n+\n+import com.azure.cosmos.implementation.Utils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.lang.management.ManagementFactory;\n+\n+public class CpuReader {\n+    private final static Logger logger = LoggerFactory.getLogger(CpuReader.class);\n+    private final com.sun.management.OperatingSystemMXBean operatingSystemMXBean;\n+\n+    public CpuReader() {\n+        java.lang.management.OperatingSystemMXBean mxBean = null;\n+        try {\n+            mxBean =\n+                ManagementFactory.getOperatingSystemMXBean();\n+        } catch (Throwable t) {\n+            logger.error(\"failed to initialized CpuReader\", t);\n+        }\n+\n+        this.operatingSystemMXBean = tryGetAs(mxBean,\n+            com.sun.management.OperatingSystemMXBean.class);\n+    }\n+\n+    public double getSystemWideCpuUsage() {\n+        try {\n+            if (operatingSystemMXBean != null) {\n+                return operatingSystemMXBean.getSystemCpuLoad();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60fd433ceca144c91f7d5e091d155e5098c6cfc7"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NjQ0MzUx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14993#pullrequestreview-485644351", "createdAt": "2020-09-10T07:15:59Z", "commit": {"oid": "60fd433ceca144c91f7d5e091d155e5098c6cfc7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzoxNTo1OVrOHPmOPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzoxNTo1OVrOHPmOPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjExNjkyNA==", "bodyText": "I know these are the same values we use in .Net - IMO shorter intervals would have been good. Wondering whether we should start with 1 second when introducing this in Java?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14993#discussion_r486116924", "createdAt": "2020-09-10T07:15:59Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/cpu/CpuMonitor.java", "diffHunk": "@@ -0,0 +1,177 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.cpu;\n+\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.lang.ref.WeakReference;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.ThreadFactory;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.locks.ReentrantReadWriteLock;\n+\n+/**\n+ * Monitors history of CPU consumption. This is a singleton class and can support multiple cosmos clients.\n+ *\n+ * is used for tracking multiple cosmos clients registers to this CPU monitor.\n+ * in the absence of a listener the CpuMonitor will shutdown.\n+ */\n+public class CpuMonitor {\n+    private final static int DEFAULT_REFRESH_INTERVAL_IN_SECONDS = 10;\n+    private final static int HISTORY_LENGTH = 6;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60fd433ceca144c91f7d5e091d155e5098c6cfc7"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NjUwNDAx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14993#pullrequestreview-485650401", "createdAt": "2020-09-10T07:24:42Z", "commit": {"oid": "60fd433ceca144c91f7d5e091d155e5098c6cfc7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1de9ceb3667b560f784b4dd33c14e104ec9cb060", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1de9ceb3667b560f784b4dd33c14e104ec9cb060", "committedDate": "2020-09-10T18:21:45Z", "message": "addressed PR review, fixed CI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MjA1MDIx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14993#pullrequestreview-486205021", "createdAt": "2020-09-10T18:28:17Z", "commit": {"oid": "1de9ceb3667b560f784b4dd33c14e104ec9cb060"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cc99007a7774bfb0f082da30f69df7ce6a1a0eb", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1cc99007a7774bfb0f082da30f69df7ce6a1a0eb", "committedDate": "2020-09-10T19:08:38Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a54a8a65892c590035ee70d6d0a1f826a7f7a1af", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a54a8a65892c590035ee70d6d0a1f826a7f7a1af", "committedDate": "2020-09-10T21:06:37Z", "message": "Merge branch 'master' into users/moderakh/cpu-history"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21c72bed3ada494a5a0b7a4f85204f8afcbf51bb", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/21c72bed3ada494a5a0b7a4f85204f8afcbf51bb", "committedDate": "2020-09-10T22:51:51Z", "message": "fix readme"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0751e89837fd05121664b76d66666b5c3ae7a257", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0751e89837fd05121664b76d66666b5c3ae7a257", "committedDate": "2020-09-10T23:58:30Z", "message": "bugfix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3547, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}