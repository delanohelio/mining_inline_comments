{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMTMyNzQz", "number": 16283, "title": "cosmos lazy decryption", "bodyText": "This PR Provides EncryptableItem and DecryptableItem as wrapper on T to provide a way for lazy decryption.\nThe PR captures the APIs and design which discussed earlier and implemented on the dot-net side:\nAzure/azure-cosmos-dotnet-v3#1832", "createdAt": "2020-10-14T06:08:07Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283", "merged": true, "mergeCommit": {"oid": "6fabbe85cd316999c3e12b974923232ff40519c7"}, "closed": true, "closedAt": "2020-10-15T20:23:35Z", "author": {"login": "moderakh"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSWuS4gH2gAyNTAzMTMyNzQzOjQ1OTA4NDI2OGI3ZjA2ZjdlMDIyOWJhNWJiOGU5MjJmMDJjNzRkNGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSkaGpAH2gAyNTAzMTMyNzQzOjYzN2IyODM1YjU4NmQyYjczYmRlM2Y2OGYyY2MxOWEzMmQ3ZDg3MzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "459084268b7f06f7e0229ba5bb8e922f02c74d4f", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/459084268b7f06f7e0229ba5bb8e922f02c74d4f", "committedDate": "2020-10-14T05:56:21Z", "message": "cosmos lazy decryption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9eae05a8f6cb8433d8786b0ec3304bdd03a09a8", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b9eae05a8f6cb8433d8786b0ec3304bdd03a09a8", "committedDate": "2020-10-14T06:03:25Z", "message": "Merge branch 'master' into users/moderakh/20201002-lazyDecryption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8882476ce89b417f938ba0d4f39d10b47e2ceecd", "committedDate": "2020-10-14T18:03:21Z", "message": "fixed checkstyle spotbug complains"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjM1MDcw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#pullrequestreview-508635070", "createdAt": "2020-10-14T18:50:53Z", "commit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MDo1M1rOHhgm6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MDo1M1rOHhgm6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5OTMwNA==", "bodyText": "TODOs - are they tracked in a separate PR? or can this todo be removed due to the example provided above?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504899304", "createdAt": "2020-10-14T18:50:53Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/DecryptableItem.java", "diffHunk": "@@ -0,0 +1,97 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.encryption;\n+\n+import reactor.core.publisher.Mono;\n+\n+\n+/// <summary>\n+/// Allows for lazy decryption, which provides user a way to handle possible exceptions encountered as part of feed /\n+// query processing.\n+/// Also provides decryption operation details.\n+/// </summary>\n+/// <example>\n+/// <code language=\"c#\">\n+/// <![CDATA[\n+/// public class ToDoActivity{\n+///     public string id {get; set;}\n+///     public string status {get; set;}\n+///     public int cost {get; set;}\n+/// }\n+///\n+/// QueryDefinition queryDefinition = new QueryDefinition(\"select * from ToDos\");\n+/// using (FeedIterator<DecrytableItem> feedIterator = this.Container.GetItemQueryIterator<DecrytableItem>(\n+///     queryDefinition,\n+///     requestOptions: new QueryRequestOptions() { PartitionKey = new PartitionKey(\"Error\")}))\n+/// {\n+///     while (feedIterator.HasMoreResults)\n+///     {\n+///         FeedResponse<DecryptableItem> decryptableItems = await feedIterator.ReadNextAsync();\n+///         foreach(DecryptableItem item in decryptableItems){\n+///         {\n+///             try\n+///             {\n+///                 (ToDoActivity toDo, DecryptionContext _) = await item.GetItemAsync<ToDoActivity>();\n+///             }\n+///             catch (EncryptionException encryptionException)\n+///             {\n+///                 string dataEncryptionKeyId = encryptionException.DataEncryptionKeyId;\n+///                 string rawPayload = encryptionException.EncryptedContent;\n+///             }\n+///         }\n+///     }\n+/// }\n+/// ]]>\n+/// </code>\n+/// </example>\n+\n+// TODO: moderakh add example", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjM1NTc5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#pullrequestreview-508635579", "createdAt": "2020-10-14T18:51:38Z", "commit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MTozOFrOHhgosw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MTozOFrOHhgosw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5OTc2Mw==", "bodyText": "NIT remove on line", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504899763", "createdAt": "2020-10-14T18:51:38Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/DecryptableItemCore.java", "diffHunk": "@@ -0,0 +1,81 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.encryption;\n+\n+import com.azure.cosmos.implementation.ItemDeserializer;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.apachecommons.lang.tuple.Pair;\n+import com.azure.cosmos.implementation.encryption.Constants;\n+import com.azure.cosmos.implementation.encryption.EncryptionProcessor;\n+import com.azure.cosmos.implementation.guava25.base.Preconditions;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Mono;\n+\n+class DecryptableItemCore extends DecryptableItem {\n+\n+    /**\n+     * The encrypted content which is yet to be decrypted.\n+     */\n+    private final JsonNode decryptableContent;\n+    private final Encryptor encryptor;\n+    private final ItemDeserializer cosmosSerializer;\n+\n+    public DecryptableItemCore(JsonNode decryptableContent,\n+                               Encryptor encryptor,\n+                               ItemDeserializer cosmosSerializer) {\n+        Preconditions.checkNotNull(decryptableContent, \"decryptableContent\");\n+        Preconditions.checkNotNull(encryptor, \"encryptor\");\n+        Preconditions.checkNotNull(cosmosSerializer, \"cosmosSerializer\");\n+\n+        this.decryptableContent = decryptableContent;\n+        this.encryptor = encryptor;\n+        this.cosmosSerializer = cosmosSerializer;\n+    }\n+\n+    @Override\n+    public <T> Mono<DecryptionResult<T>> getDecryptionResult(final Class<T> classType) {\n+\n+        ObjectNode decryptableContentAsObjectNode = Utils.as(this.decryptableContent, ObjectNode.class);\n+        if (decryptableContentAsObjectNode == null) {\n+            // (this.cosmosSerializer.FromStream<T>(EncryptionProcessor.BaseSerializer.ToStream\n+            return Mono.just(new DecryptionResult<>(Utils.getSimpleObjectMapper().convertValue(this.decryptableContent, classType), null));\n+        }\n+\n+        Mono<Pair<ObjectNode, DecryptionContext>> decryptedItemAndContextPairMono =\n+            EncryptionProcessor.decrypt(decryptableContentAsObjectNode, this.encryptor);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjM2NjM1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#pullrequestreview-508636635", "createdAt": "2020-10-14T18:53:04Z", "commit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MzowNFrOHhgsJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MzowNFrOHhgsJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMDY0NA==", "bodyText": "NIT remove one line", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504900644", "createdAt": "2020-10-14T18:53:04Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptableItem.java", "diffHunk": "@@ -0,0 +1,90 @@\n+// ------------------------------------------------------------\n+// Copyright (c) Microsoft Corporation.  All rights reserved.\n+// ------------------------------------------------------------\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjM2ODYw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#pullrequestreview-508636860", "createdAt": "2020-10-14T18:53:23Z", "commit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MzoyM1rOHhgs3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1MzoyM1rOHhgs3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMDgyOQ==", "bodyText": "NIT remove todo", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504900829", "createdAt": "2020-10-14T18:53:23Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptableItem.java", "diffHunk": "@@ -0,0 +1,90 @@\n+// ------------------------------------------------------------\n+// Copyright (c) Microsoft Corporation.  All rights reserved.\n+// ------------------------------------------------------------\n+\n+\n+package com.azure.cosmos.encryption;\n+\n+import com.azure.cosmos.implementation.ItemDeserializer;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.encryption.EncryptionUtils;\n+import com.azure.cosmos.implementation.guava25.base.Preconditions;\n+\n+/// <summary>\n+/// Input type that can be used to allow for lazy decryption in the write path.\n+/// </summary>\n+/// <typeparam name=\"T\">Type of item.</typeparam>\n+/// <example>\n+/// This example takes in a item, encrypts it and writes to Cosmos container.\n+/// <code language=\"c#\">\n+/// <![CDATA[\n+/// public class ToDoActivity{\n+///     public string id {get; set;}\n+///     public string status {get; set;}\n+/// }\n+///\n+/// ToDoActivity test = new ToDoActivity()\n+/// {\n+///    id = Guid.NewGuid().ToString(),\n+///    status = \"InProgress\"\n+/// };\n+///\n+/// ItemResponse<EncryptableItem<ToDoActivity>> createResponse = await encryptionContainer\n+// .CreateItemAsync<EncryptableItem<ToDoActivity>>(\n+///     new EncryptableItem<ToDoActivity>(test),\n+///     new PartitionKey(test.Status),\n+///     EncryptionItemRequestOptions);\n+///\n+/// if (!createResponse.IsSuccessStatusCode)\n+/// {\n+///     //Handle and log exception\n+///     return;\n+/// }\n+///\n+/// (ToDoActivity toDo, DecryptionContext _) = await item.DecryptableItem.GetItemAsync<ToDoActivity>();\n+/// ]]>\n+/// </code>\n+/// </example>\n+\n+// TODO moderakh add example", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjM3ODgy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#pullrequestreview-508637882", "createdAt": "2020-10-14T18:54:52Z", "commit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1NDo1MlrOHhgv_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1NDo1MlrOHhgv_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMTYzMA==", "bodyText": "NIT remove one line - also below after the precondition check", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504901630", "createdAt": "2020-10-14T18:54:52Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -163,29 +204,66 @@\n         EncryptionItemRequestOptions encryptionItemRequestOptions = Utils.as(requestOptions,\n             EncryptionItemRequestOptions.class);\n \n-        if (encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null) {\n-            Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n-                + \"EncryptionContainer.\");\n+        if (encryptionItemRequestOptions == null || encryptionItemRequestOptions.getEncryptionOptions() == null) {\n+            return container.createItem(item, partitionKey, requestOptions);\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 233}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjM4MzEz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#pullrequestreview-508638313", "createdAt": "2020-10-14T18:55:28Z", "commit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1NToyOFrOHhgxZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1NToyOFrOHhgxZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMTk4OA==", "bodyText": "???", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504901988", "createdAt": "2020-10-14T18:55:28Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -163,29 +204,66 @@\n         EncryptionItemRequestOptions encryptionItemRequestOptions = Utils.as(requestOptions,\n             EncryptionItemRequestOptions.class);\n \n-        if (encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null) {\n-            Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n-                + \"EncryptionContainer.\");\n+        if (encryptionItemRequestOptions == null || encryptionItemRequestOptions.getEncryptionOptions() == null) {\n+            return container.createItem(item, partitionKey, requestOptions);\n+        }\n+\n+\n+        Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n+            + \"EncryptionContainer.\");\n+\n+\n+        EncryptableItem encryptableItem = Utils.as(item, EncryptableItem.class);\n+        if (encryptableItem != null) {\n+            byte[] streamPayload = encryptableItem.toStream(this.getItemDeserializer());\n+\n+            Mono<CosmosItemResponse<byte[]>> rspMono = this.createItemHelper(streamPayload,\n+                partitionKey,\n+                requestOptions,\n+                false);\n+\n \n-            return Mono.defer(() -> {\n-                byte[] payload = cosmosSerializerToStream(item);\n-                Mono<CosmosItemResponse<byte[]>> result = this.createItemStream(payload, partitionKey,\n-                    encryptionItemRequestOptions);\n+            return rspMono.map(\n+                rsp -> {\n+                    encryptableItem.setDecryptableItem(\n+                        // EncryptionProcessor.BaseSerializer.FromStream<JObject>(responseMessage.Content),\n+                        getItemDeserializer().parseFrom(ObjectNode.class,\n+                            EncryptionModelBridgeInternal.getByteArrayContent(rsp)),\n+                        this.encryptor,\n+                        this.getItemDeserializer()\n+                    );\n \n-                return result.map(rsp -> (CosmosItemResponse<T>) this.responseFactory.createItemResponse(rsp,\n-                    item.getClass()));\n+                    return createEncryptionItemResponse(rsp, (T) encryptableItem);\n+                }\n+            ).subscribeOn(encryptionScheduler);\n \n-            }).subscribeOn(encryptionScheduler);\n         } else {\n-            return container.createItem(item, partitionKey, requestOptions);\n+            byte[] streamPayload = cosmosSerializerToStream(item);\n+            Mono<CosmosItemResponse<byte[]>> response = createItemHelper(\n+                streamPayload,\n+                partitionKey,\n+                requestOptions,\n+                true\n+            );\n+\n+            return response\n+                .publishOn(encryptionScheduler)\n+                .map(\n+                    rsp -> {\n+                        return this.responseFactory.createItemResponse(rsp, (Class<T>) item.getClass());\n+                    }\n+                );\n+\n+            // TODO: no support for streaming", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 288}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjM5NTYw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#pullrequestreview-508639560", "createdAt": "2020-10-14T18:57:15Z", "commit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1NzoxNVrOHhg1Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo1NzoxNVrOHhg1Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkwMjk3MA==", "bodyText": "Same as above - at least to me it isn't clear what this comment means. We don't support Stream Apis at all in Java,  correct?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#discussion_r504902970", "createdAt": "2020-10-14T18:57:15Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -261,48 +375,85 @@\n         EncryptionItemRequestOptions encryptionItemRequestOptions = Utils.as(requestOptions,\n             EncryptionItemRequestOptions.class);\n \n-        if (encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null) {\n-            Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n-                + \"EncryptionContainer.\");\n+        if (encryptionItemRequestOptions == null || encryptionItemRequestOptions.getEncryptionOptions() == null) {\n+            return container.replaceItem(item, itemId, partitionKey, requestOptions);\n+        }\n+\n+        Preconditions.checkArgument(partitionKey != null, \"partitionKey cannot be null for operations using \"\n+            + \"EncryptionContainer.\");\n \n-            return Mono.defer(() -> {\n-                byte[] payload = cosmosSerializerToStream(item);\n-                Mono<CosmosItemResponse<byte[]>> result = this.replaceItemStream(payload,\n-                    itemId,\n-                    partitionKey,\n-                    encryptionItemRequestOptions);\n \n-                return result.map(rsp -> (CosmosItemResponse<T>) this.responseFactory.createItemResponse(rsp,\n-                    item.getClass()));\n-            }).subscribeOn(encryptionScheduler);\n+        EncryptableItem encryptableItem = Utils.as(item, EncryptableItem.class);\n+        if (encryptableItem != null) {\n+\n+            // using (Stream streamPayload = encryptableItem.ToStream(this.CosmosSerializer))\n+            byte[] streamPayload = encryptableItem.toStream(this.getItemDeserializer());\n+\n+            Mono<CosmosItemResponse<byte[]>> rspMono = this.replaceItemHelper(streamPayload,\n+                itemId,\n+                partitionKey,\n+                requestOptions,\n+                false);\n+\n+\n+            return rspMono.map(\n+                rsp -> {\n+                    encryptableItem.setDecryptableItem(\n+                        //EncryptionProcessor.BaseSerializer.FromStream<JObject>(responseMessage.Content),\n+                        getItemDeserializer().parseFrom(ObjectNode.class,\n+                            EncryptionModelBridgeInternal.getByteArrayContent(rsp)),\n+                        this.encryptor,\n+                        this.getItemDeserializer()\n+                    );\n+\n+                    return createEncryptionItemResponse(rsp, (T) encryptableItem);\n+                }\n+            ).subscribeOn(encryptionScheduler);\n \n         } else {\n-            return container.replaceItem(item, itemId, partitionKey, requestOptions);\n+            byte[] streamPayload = cosmosSerializerToStream(item);\n+            Mono<CosmosItemResponse<byte[]>> response = replaceItemHelper(\n+                streamPayload,\n+                itemId,\n+                partitionKey,\n+                requestOptions,\n+                true\n+            );\n+\n+            return response\n+                .publishOn(encryptionScheduler)\n+                .map(\n+                    rsp -> {\n+                        return this.responseFactory.createItemResponse(rsp, (Class<T>) item.getClass());\n+                    }\n+                );\n+\n+            // TODO: no support for streaming", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "originalPosition": 443}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjQyODU1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16283#pullrequestreview-508642855", "createdAt": "2020-10-14T19:01:48Z", "commit": {"oid": "8882476ce89b417f938ba0d4f39d10b47e2ceecd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f68d549c74614b9635f1d427035d9d8e2eaba076", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f68d549c74614b9635f1d427035d9d8e2eaba076", "committedDate": "2020-10-14T19:06:30Z", "message": "review comments addressed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "637b2835b586d2b73bde3f68f2cc19a32d7d8733", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/637b2835b586d2b73bde3f68f2cc19a32d7d8733", "committedDate": "2020-10-14T21:52:58Z", "message": "more cleanup to make spotbug happy"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2056, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}