{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NTc0MjI1", "number": 13599, "title": "encryption minor refactoring and query decryption", "bodyText": "minor refactoring on moving encryption files ( com.azure.cosmos.encryption)\nwired up deserialization on query with tests for decryption on query", "createdAt": "2020-07-29T17:17:18Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13599", "merged": true, "mergeCommit": {"oid": "856c2fb166ea35a51fde1fa44d466819051dfd31"}, "closed": true, "closedAt": "2020-07-30T00:05:49Z", "author": {"login": "moderakh"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc16H_AgH2gAyNDU4NTc0MjI1OjY5MWY4YjE2MmRkZTg0NDQwZGFmZDdkZDFjMjdlYjM5NzA5OWMzMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5za4SgH2gAyNDU4NTc0MjI1OjEwOTQ2OGIxZGFjZTkyYjVjOTc3MjAwNmNkYmYxMTg0MzJkYzM3NmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "691f8b162dde84440dafd7dd1c27eb397099c308", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/691f8b162dde84440dafd7dd1c27eb397099c308", "committedDate": "2020-07-17T20:47:17Z", "message": "minor cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8eda32c50f77257ea46091b21a02819f253e9faf", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8eda32c50f77257ea46091b21a02819f253e9faf", "committedDate": "2020-07-17T22:12:12Z", "message": "minor cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff37289bdc52b165166b69d2ee91420294818f23", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ff37289bdc52b165166b69d2ee91420294818f23", "committedDate": "2020-07-17T23:02:00Z", "message": "encryptor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77cf2ec44b4f5aa2c9f572af53485db248b22b71", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/77cf2ec44b4f5aa2c9f572af53485db248b22b71", "committedDate": "2020-07-17T23:05:10Z", "message": "static field name correction, fixed pre-condition check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d41cfff387576767afdf515af4587d323eca03e", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5d41cfff387576767afdf515af4587d323eca03e", "committedDate": "2020-07-20T16:38:44Z", "message": "Merge branch 'master' into users/moderakh/encryption-minor-cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51f3cdd0fa68f3d7c072e82951be3014935601ba", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/51f3cdd0fa68f3d7c072e82951be3014935601ba", "committedDate": "2020-07-20T17:14:58Z", "message": "Merge branch 'users/moderakh/encryption-minor-cleanup' into users/moderakh/20200717-encryption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfc13d2ff2513f21fd461c3a23691de556945c7a", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/cfc13d2ff2513f21fd461c3a23691de556945c7a", "committedDate": "2020-07-23T17:42:40Z", "message": "move encryption hooks out of sdk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2caa15601ede91a5ad95708843eb96ecd48cb0eb", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2caa15601ede91a5ad95708843eb96ecd48cb0eb", "committedDate": "2020-07-23T17:54:28Z", "message": "Merge branch 'master' into users/moderakh/20200717-encryption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b4cd567147799e37418450ed00a2817ced1fdfe", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b4cd567147799e37418450ed00a2817ced1fdfe", "committedDate": "2020-07-23T18:19:14Z", "message": "encryption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5e6f09d3634df5928ac322f9b6198cd73cbd7de", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e5e6f09d3634df5928ac322f9b6198cd73cbd7de", "committedDate": "2020-07-23T18:22:42Z", "message": "undid public api change to CosmosItemResponse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c17f86d6de14f46671de958b254b3b96d88272b", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5c17f86d6de14f46671de958b254b3b96d88272b", "committedDate": "2020-07-23T18:29:06Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b2e69796dbf9107018009f57ad33e76def18397", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6b2e69796dbf9107018009f57ad33e76def18397", "committedDate": "2020-07-23T18:39:03Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a6458d95e077faae9e7398237c9461ae57c925d", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0a6458d95e077faae9e7398237c9461ae57c925d", "committedDate": "2020-07-23T19:02:59Z", "message": "code review comments addressed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e9d20761317a111cb17ca10ffe1bba4b7c64b1e", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9e9d20761317a111cb17ca10ffe1bba4b7c64b1e", "committedDate": "2020-07-23T19:16:12Z", "message": "fixed compilation error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f262d5c0dc7059d832be76326dc91cd1ca7484f7", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f262d5c0dc7059d832be76326dc91cd1ca7484f7", "committedDate": "2020-07-23T20:02:10Z", "message": "minor code style cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a12d345d635a31d2e46c2e890257513ce4c1001f", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a12d345d635a31d2e46c2e890257513ce4c1001f", "committedDate": "2020-07-23T22:06:01Z", "message": "check style fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b79a5a8e6dc53abaed90535d10292cd9b99d3ac", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b79a5a8e6dc53abaed90535d10292cd9b99d3ac", "committedDate": "2020-07-23T22:30:53Z", "message": "javadoc fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88e984e4e32d11b6560782be1d86bd130edf9245", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/88e984e4e32d11b6560782be1d86bd130edf9245", "committedDate": "2020-07-23T22:35:26Z", "message": "javadoc fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f7d590dc679c865eb081cc7c8b5acea50b94fec", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6f7d590dc679c865eb081cc7c8b5acea50b94fec", "committedDate": "2020-07-23T22:49:18Z", "message": "check-style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b7ec08f10f7cd791234c8436a511d2d93bc3e21", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b7ec08f10f7cd791234c8436a511d2d93bc3e21", "committedDate": "2020-07-24T06:17:06Z", "message": "query basic support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5e67e1e2f69bc71950645c6299342e5af83502f", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c5e67e1e2f69bc71950645c6299342e5af83502f", "committedDate": "2020-07-24T06:19:35Z", "message": "Merge branch 'master' into users/moderakh/20200723-encryption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "290377d3f80c673d5a0719b526b20a936d770e8e", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/290377d3f80c673d5a0719b526b20a936d770e8e", "committedDate": "2020-07-24T22:45:36Z", "message": "encryption for query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad1136cd0eebc082eef4ca453042e3e05d1d2b89", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ad1136cd0eebc082eef4ca453042e3e05d1d2b89", "committedDate": "2020-07-24T22:46:18Z", "message": "Merge branch 'master' into users/moderakh/20200723-encryption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e171f089fc84bcf2b7294dc2c32a6225d7623360", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e171f089fc84bcf2b7294dc2c32a6225d7623360", "committedDate": "2020-07-29T17:09:34Z", "message": "minor package move, cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9822e2c34844894d500cbcc8232469842a83451f", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9822e2c34844894d500cbcc8232469842a83451f", "committedDate": "2020-07-29T17:14:18Z", "message": "Merge branch 'master' into users/moderakh/20200723-encryption"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NzMzODEw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13599#pullrequestreview-457733810", "createdAt": "2020-07-29T17:23:13Z", "commit": {"oid": "9822e2c34844894d500cbcc8232469842a83451f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNzoyMzoxM1rOG5Cgsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNzoyNzo1OFrOG5CsDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2MzE1NQ==", "bodyText": "This will probably fail the analyze build - because of multiple spaces between java docs. I can share my intellij code styling file - which you can import and when you refactor code through intellij, it should automatically solve these issues.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13599#discussion_r462463155", "createdAt": "2020-07-29T17:23:13Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -2,73 +2,80 @@\n // Licensed under the MIT License.\n \n \n-package com.azure.cosmos;\n+package com.azure.cosmos.encryption;\n \n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosAsyncContainer;\n+import com.azure.cosmos.CosmosAsyncDatabase;\n+import com.azure.cosmos.CosmosBridgeInternal;\n+import com.azure.cosmos.implementation.Document;\n import com.azure.cosmos.implementation.ItemDeserializer;\n import com.azure.cosmos.implementation.Utils;\n-import com.azure.cosmos.implementation.apachecommons.lang.NotImplementedException;\n import com.azure.cosmos.implementation.encryption.CosmosResponseFactory;\n import com.azure.cosmos.implementation.encryption.CosmosResponseFactoryCore;\n-import com.azure.cosmos.implementation.encryption.DecryptionResult;\n-import com.azure.cosmos.implementation.encryption.EncryptionItemRequestOptions;\n import com.azure.cosmos.implementation.encryption.EncryptionProcessor;\n+import com.azure.cosmos.implementation.encryption.EncryptionQueryRequestOption;\n import com.azure.cosmos.implementation.encryption.EncryptionUtils;\n import com.azure.cosmos.implementation.guava25.base.Preconditions;\n import com.azure.cosmos.models.CosmosItemRequestOptions;\n import com.azure.cosmos.models.CosmosItemResponse;\n-import com.azure.cosmos.models.EncryptionBridgeInternal;\n+import com.azure.cosmos.models.CosmosQueryRequestOptions;\n+import com.azure.cosmos.models.EncryptionModelBridgeInternal;\n import com.azure.cosmos.models.PartitionKey;\n+import com.azure.cosmos.models.SqlQuerySpec;\n+import com.azure.cosmos.util.CosmosPagedFlux;\n import reactor.core.publisher.Mono;\n import reactor.core.scheduler.Schedulers;\n \n import java.util.function.Consumer;\n+import java.util.function.Function;\n+\n \n // TODO: for now basic functionality is in. some APIs and some logic branch is not complete yet.\n-public class EncryptionCosmosAsyncContainer extends CosmosAsyncContainer {\n+public class EncryptionCosmosAsyncContainer {\n     private final Encryptor encryptor;\n     private final CosmosResponseFactory responseFactory = new CosmosResponseFactoryCore();\n+    private final CosmosAsyncContainer container;\n \n     EncryptionCosmosAsyncContainer(String id, CosmosAsyncDatabase database, Encryptor encryptor) {\n-        super(id, database);\n+        this.container = BridgeInternal.createCosmosAsyncContainer(id, database);\n         this.encryptor = encryptor;\n     }\n \n     private Mono<CosmosItemResponse<byte[]>> createItemStream(byte[] payload,\n                                                               PartitionKey partitionKey,\n-                                                              CosmosItemRequestOptions requestOptions) {\n+                                                              EncryptionItemRequestOptions encryptionItemRequestOptions) {\n         Preconditions.checkNotNull(payload, \"payload can't be null\");\n \n         // TODO: add diagnostics\n-        EncryptionItemRequestOptions encryptionItemRequestOptions = Utils.as(requestOptions, EncryptionItemRequestOptions.class);\n-        if (encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null) {\n-\n-            payload = EncryptionProcessor.encryptAsync(payload, encryptor, encryptionItemRequestOptions.getEncryptionOptions());\n+        assert encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null;\n+        payload = EncryptionProcessor.encryptAsync(payload, encryptor, encryptionItemRequestOptions.getEncryptionOptions());\n \n-            Mono<CosmosItemResponse<byte[]>> response = super.createItem(payload, partitionKey, requestOptions);\n+        Mono<CosmosItemResponse<byte[]>> response = container.createItem(payload, partitionKey, encryptionItemRequestOptions);\n \n-            return response\n-                .subscribeOn(Schedulers.elastic())\n-                .publishOn(Schedulers.elastic())\n-                .map(rsp -> {\n-                        EncryptionBridgeInternal.setByteArrayContent(rsp, decryptResponseAsync(EncryptionBridgeInternal.getByteArrayContent(rsp), encryptionItemRequestOptions.getDecryptionResultHandler()));\n-                        return rsp;\n-                    }\n-                );\n-\n-        } else {\n-            throw new NotImplementedException(\"TODO not implemented yet\");\n-            // TODO moderakh compelte the non encryption branch\n-            // return super.createItem()\n-        }\n+        return response\n+            .subscribeOn(Schedulers.elastic())\n+            .publishOn(Schedulers.elastic())\n+            .map(rsp -> {\n+                    EncryptionModelBridgeInternal.setByteArrayContent(\n+                        rsp,\n+                        decryptResponseAsync(\n+                            EncryptionModelBridgeInternal.getByteArrayContent(rsp),\n+                            encryptionItemRequestOptions.getDecryptionResultHandler()));\n+                    return rsp;\n+                }\n+            );\n     }\n \n     // TODO ensure all other apis call this guy\n+\n     /**\n      * create item and encrypts the requested fields\n-     * @param item the Cosmos item represented as a POJO or Cosmos item object.\n-     * @param partitionKey the partition key.\n+     *\n+     * @param item           the Cosmos item represented as a POJO or Cosmos item object.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9822e2c34844894d500cbcc8232469842a83451f"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2NjA2MQ==", "bodyText": "You should probably start with all these classes as final", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13599#discussion_r462466061", "createdAt": "2020-07-29T17:27:58Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/DecryptionResult.java", "diffHunk": "@@ -0,0 +1,35 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+\n+package com.azure.cosmos.encryption;\n+\n+public class DecryptionResult {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9822e2c34844894d500cbcc8232469842a83451f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdb6084b68ba37f607709a86a23375f7348f6ff5", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bdb6084b68ba37f607709a86a23375f7348f6ff5", "committedDate": "2020-07-29T18:49:20Z", "message": "code style fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c7dad4144b01582b7358cc3ae13cdf6ffc5dbfa", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9c7dad4144b01582b7358cc3ae13cdf6ffc5dbfa", "committedDate": "2020-07-29T19:55:07Z", "message": "fixed check style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "109468b1dace92b5c9772006cdbf118432dc376a", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/109468b1dace92b5c9772006cdbf118432dc376a", "committedDate": "2020-07-29T23:14:17Z", "message": "Merge branch 'master' into users/moderakh/20200723-encryption"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1013, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}