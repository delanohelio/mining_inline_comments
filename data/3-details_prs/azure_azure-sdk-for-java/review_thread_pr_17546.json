{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMjMzNDk2", "number": 17546, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzowNToxNlrOE43Sqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMTowNzoxMlrOE6_V-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDYxNjEwOnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzowNToxNlrOHzCUyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo1OTowOVrOH2B6Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI3NzUxNQ==", "bodyText": "final for both the variables?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r523277515", "createdAt": "2020-11-13T23:05:16Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverClient.java", "diffHunk": "@@ -590,13 +590,14 @@ public void close() {\n     private void queueWork(int maximumMessageCount, Duration maxWaitTime,\n                            FluxSink<ServiceBusReceivedMessage> emitter) {\n         final long id = idGenerator.getAndIncrement();\n-        final SynchronousReceiveWork work = new SynchronousReceiveWork(id, maximumMessageCount, maxWaitTime, emitter);\n-\n+        int prefetch = asyncClient.getReceiverOptions().getPrefetchCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22c089334f9cf26166f9239797be9851a18f9c56"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxNjM4Nw==", "bodyText": "Updated to final", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526416387", "createdAt": "2020-11-18T20:59:09Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverClient.java", "diffHunk": "@@ -590,13 +590,14 @@ public void close() {\n     private void queueWork(int maximumMessageCount, Duration maxWaitTime,\n                            FluxSink<ServiceBusReceivedMessage> emitter) {\n         final long id = idGenerator.getAndIncrement();\n-        final SynchronousReceiveWork work = new SynchronousReceiveWork(id, maximumMessageCount, maxWaitTime, emitter);\n-\n+        int prefetch = asyncClient.getReceiverOptions().getPrefetchCount();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI3NzUxNQ=="}, "originalCommit": {"oid": "22c089334f9cf26166f9239797be9851a18f9c56"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MTM0ODY0OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusReceiveLinkProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwNzowMToxMFrOHzI_9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo1MDowM1rOH2BmuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4Njg3MQ==", "bodyText": "Should we do similar logic in SessionManager, Like we spoke over the chat.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r523386871", "createdAt": "2020-11-14T07:01:10Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusReceiveLinkProcessor.java", "diffHunk": "@@ -199,12 +198,7 @@ public void onNext(ServiceBusReceiveLink next) {\n             oldSubscription = currentLinkSubscriptions;\n \n             currentLink = next;\n-            next.setEmptyCreditListener(() -> {\n-                final int creditsToAdd = getCreditsToAdd(0);\n-                linkCreditsAdded.set(creditsToAdd > 0);\n-\n-                return creditsToAdd;\n-            });\n+            next.setEmptyCreditListener(() -> 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxMTQ0OA==", "bodyText": "Updated to 0 in ServiceBusSessionReceiver", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526411448", "createdAt": "2020-11-18T20:50:03Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusReceiveLinkProcessor.java", "diffHunk": "@@ -199,12 +198,7 @@ public void onNext(ServiceBusReceiveLink next) {\n             oldSubscription = currentLinkSubscriptions;\n \n             currentLink = next;\n-            next.setEmptyCreditListener(() -> {\n-                final int creditsToAdd = getCreditsToAdd(0);\n-                linkCreditsAdded.set(creditsToAdd > 0);\n-\n-                return creditsToAdd;\n-            });\n+            next.setEmptyCreditListener(() -> 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4Njg3MQ=="}, "originalCommit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MTM1NTM0OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorReceiver.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwNzoxMTowMVrOHzJC-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDo0ODo1MVrOH3Ks1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NzY0Mw==", "bodyText": "Most of the calls into Proton-j Reactor is done via ReactorDispatcher because of thread safety,\nAs commented here ..\nhttps://github.com/Azure/azure-sdk-for-java/blob/master/sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorDispatcher.java#L22\nWould this be okay to call this api directly ? @srnagar  Would this be okay here ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r523387643", "createdAt": "2020-11-14T07:11:01Z", "author": {"login": "hemanttanwar"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorReceiver.java", "diffHunk": "@@ -107,6 +107,11 @@ public void addCredits(int credits) {\n         }\n     }\n \n+    @Override\n+    public void addCreditsInstantly(int credits) {\n+        receiver.flow(credits);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4NDk4Mw==", "bodyText": "This needs to be tested for thread-safety. If proton-j doesn't support adding credits in a thread-safe manner we might add incorrect number of credits to the link and can potentially result in data loss if the SB mode is RECEIVE_AND_DELETE", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r527284983", "createdAt": "2020-11-20T00:04:49Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorReceiver.java", "diffHunk": "@@ -107,6 +107,11 @@ public void addCredits(int credits) {\n         }\n     }\n \n+    @Override\n+    public void addCreditsInstantly(int credits) {\n+        receiver.flow(credits);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NzY0Mw=="}, "originalCommit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM5NzQ0Mg==", "bodyText": "I simply put it into a synchronized block. The performance overhead should be minimal.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r527397442", "createdAt": "2020-11-20T04:56:21Z", "author": {"login": "YijunXieMS"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorReceiver.java", "diffHunk": "@@ -107,6 +107,11 @@ public void addCredits(int credits) {\n         }\n     }\n \n+    @Override\n+    public void addCreditsInstantly(int credits) {\n+        receiver.flow(credits);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NzY0Mw=="}, "originalCommit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwOTA0NQ==", "bodyText": "Changed back to addCredits()", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r527609045", "createdAt": "2020-11-20T10:48:51Z", "author": {"login": "YijunXieMS"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorReceiver.java", "diffHunk": "@@ -107,6 +107,11 @@ public void addCredits(int credits) {\n         }\n     }\n \n+    @Override\n+    public void addCreditsInstantly(int credits) {\n+        receiver.flow(credits);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM4NzY0Mw=="}, "originalCommit": {"oid": "1a5c4c438972e0db0ab0f22fc17f99f296926d68"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDk4NTU2OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSessionReceiver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzoxNjozMlrOH2GLsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzozMDo1OVrOH2Gfwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4NjQ0OA==", "bodyText": "Just like we have addCreditsInstantly , adding locally , Does getCredits return from local? And if it is returning from remote, there could be short time when there is diff in local v/s remote .\nShould there is equivalent getCreditsInstantly ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526486448", "createdAt": "2020-11-18T23:16:32Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSessionReceiver.java", "diffHunk": "@@ -63,14 +63,23 @@\n         this.receiveLink = receiveLink;\n         this.lockContainer = new LockContainer<>(ServiceBusConstants.OPERATION_TIMEOUT);\n \n-        receiveLink.setEmptyCreditListener(() -> 1);\n+        receiveLink.setEmptyCreditListener(() -> 0);\n \n         final Flux<ServiceBusMessageContext> receivedMessagesFlux = receiveLink\n             .receive()\n             .publishOn(scheduler)\n             .doOnSubscribe(subscription -> {\n                 logger.verbose(\"Adding prefetch to receive link.\");\n-                receiveLink.addCredits(prefetch);\n+                if (prefetch > 0) {\n+                    receiveLink.addCreditsInstantly(prefetch);\n+                }\n+            })\n+            .doOnRequest(request -> {  // request is of type long.\n+                if (prefetch == 0) {  //  add \"request\" number of credits\n+                    receiveLink.addCreditsInstantly((int) request);\n+                } else {  // keep total credits \"prefetch\" if prefetch is not 0.\n+                    receiveLink.addCreditsInstantly(Math.max(0, prefetch - receiveLink.getCredits()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8986b2fb14b4f57778fde7224f0e4fe01b5cea61"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5MTU4Ng==", "bodyText": "getCredits() should return from local. I don't see a log for traffic of getCredits.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526491586", "createdAt": "2020-11-18T23:30:59Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSessionReceiver.java", "diffHunk": "@@ -63,14 +63,23 @@\n         this.receiveLink = receiveLink;\n         this.lockContainer = new LockContainer<>(ServiceBusConstants.OPERATION_TIMEOUT);\n \n-        receiveLink.setEmptyCreditListener(() -> 1);\n+        receiveLink.setEmptyCreditListener(() -> 0);\n \n         final Flux<ServiceBusMessageContext> receivedMessagesFlux = receiveLink\n             .receive()\n             .publishOn(scheduler)\n             .doOnSubscribe(subscription -> {\n                 logger.verbose(\"Adding prefetch to receive link.\");\n-                receiveLink.addCredits(prefetch);\n+                if (prefetch > 0) {\n+                    receiveLink.addCreditsInstantly(prefetch);\n+                }\n+            })\n+            .doOnRequest(request -> {  // request is of type long.\n+                if (prefetch == 0) {  //  add \"request\" number of credits\n+                    receiveLink.addCreditsInstantly((int) request);\n+                } else {  // keep total credits \"prefetch\" if prefetch is not 0.\n+                    receiveLink.addCreditsInstantly(Math.max(0, prefetch - receiveLink.getCredits()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4NjQ0OA=="}, "originalCommit": {"oid": "8986b2fb14b4f57778fde7224f0e4fe01b5cea61"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDk5NjY5OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusReceiveLinkProcessor.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzoyMDo0NVrOH2GSBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMjowMToxMlrOH2Jn5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4ODA2OA==", "bodyText": "How we get this in this case where  credit will need to be Integer.MAX_VALUE ? And should it be max ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526488068", "createdAt": "2020-11-18T23:20:45Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusReceiveLinkProcessor.java", "diffHunk": "@@ -571,21 +562,28 @@ private int getCreditsToAdd(int linkCredits) {\n         }\n \n         final int creditsToAdd;\n-        if (messageQueue.isEmpty() && !hasBackpressure) {\n-            creditsToAdd = prefetch;\n+        final int expectedTotalCredit;\n+        if (prefetch == 0) {\n+            if (r <= Integer.MAX_VALUE) {\n+                expectedTotalCredit = (int) r;\n+            } else {\n+                expectedTotalCredit = Integer.MAX_VALUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8986b2fb14b4f57778fde7224f0e4fe01b5cea61"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5ODIxNw==", "bodyText": "This won't really happen in reality. I still leave it there because Integer.MAX_VALUE is the largest allowed link credits.\nFor async client, receiveMessages() calls \"return receiveMessagesNoBackPressure().limitRate(1, 0);\". This will request one by one from the link processor, even though the user's request has no back pressure.\nFor sync client, the sync subscriber has back pressure. The request count uses the  the argument of method receiveMessages(int maxMessages). It's at most Integer.MAX_VALUE.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526498217", "createdAt": "2020-11-18T23:48:06Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusReceiveLinkProcessor.java", "diffHunk": "@@ -571,21 +562,28 @@ private int getCreditsToAdd(int linkCredits) {\n         }\n \n         final int creditsToAdd;\n-        if (messageQueue.isEmpty() && !hasBackpressure) {\n-            creditsToAdd = prefetch;\n+        final int expectedTotalCredit;\n+        if (prefetch == 0) {\n+            if (r <= Integer.MAX_VALUE) {\n+                expectedTotalCredit = (int) r;\n+            } else {\n+                expectedTotalCredit = Integer.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4ODA2OA=="}, "originalCommit": {"oid": "8986b2fb14b4f57778fde7224f0e4fe01b5cea61"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMjY0Mw==", "bodyText": "So does this justify In that case should we log point to help us debug this if needed.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526502643", "createdAt": "2020-11-19T00:00:03Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusReceiveLinkProcessor.java", "diffHunk": "@@ -571,21 +562,28 @@ private int getCreditsToAdd(int linkCredits) {\n         }\n \n         final int creditsToAdd;\n-        if (messageQueue.isEmpty() && !hasBackpressure) {\n-            creditsToAdd = prefetch;\n+        final int expectedTotalCredit;\n+        if (prefetch == 0) {\n+            if (r <= Integer.MAX_VALUE) {\n+                expectedTotalCredit = (int) r;\n+            } else {\n+                expectedTotalCredit = Integer.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4ODA2OA=="}, "originalCommit": {"oid": "8986b2fb14b4f57778fde7224f0e4fe01b5cea61"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU0MjgyMA==", "bodyText": "Added the code comments.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526542820", "createdAt": "2020-11-19T02:01:12Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusReceiveLinkProcessor.java", "diffHunk": "@@ -571,21 +562,28 @@ private int getCreditsToAdd(int linkCredits) {\n         }\n \n         final int creditsToAdd;\n-        if (messageQueue.isEmpty() && !hasBackpressure) {\n-            creditsToAdd = prefetch;\n+        final int expectedTotalCredit;\n+        if (prefetch == 0) {\n+            if (r <= Integer.MAX_VALUE) {\n+                expectedTotalCredit = (int) r;\n+            } else {\n+                expectedTotalCredit = Integer.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4ODA2OA=="}, "originalCommit": {"oid": "8986b2fb14b4f57778fde7224f0e4fe01b5cea61"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjg3MDY4OnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusProcessorClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDo1Nzo1NFrOH2XkpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxOToxNzozOFrOH2t2rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3MTM2NQ==", "bodyText": "As discussed earlier, this logic should be moved to the async client.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526771365", "createdAt": "2020-11-19T10:57:54Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusProcessorClient.java", "diffHunk": "@@ -150,8 +150,8 @@ private synchronized void receiveMessages() {\n         }\n         ServiceBusReceiverAsyncClient receiverClient = asyncClient.get();\n         receiverClient.receiveMessagesWithContext()\n-            .parallel(processorOptions.getMaxConcurrentCalls())\n-            .runOn(Schedulers.boundedElastic())\n+            .parallel(processorOptions.getMaxConcurrentCalls(), 1)\n+            .runOn(Schedulers.boundedElastic(), 1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530e258ba4057b366a852c743da4b13fbc26716b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEzNjQyOQ==", "bodyText": "Updated and pushed after discussion", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r527136429", "createdAt": "2020-11-19T19:17:38Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusProcessorClient.java", "diffHunk": "@@ -150,8 +150,8 @@ private synchronized void receiveMessages() {\n         }\n         ServiceBusReceiverAsyncClient receiverClient = asyncClient.get();\n         receiverClient.receiveMessagesWithContext()\n-            .parallel(processorOptions.getMaxConcurrentCalls())\n-            .runOn(Schedulers.boundedElastic())\n+            .parallel(processorOptions.getMaxConcurrentCalls(), 1)\n+            .runOn(Schedulers.boundedElastic(), 1)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3MTM2NQ=="}, "originalCommit": {"oid": "530e258ba4057b366a852c743da4b13fbc26716b"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjg3MzgyOnYy", "diffSide": "RIGHT", "path": "eng/versioning/version_client.txt", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDo1ODo0NFrOH2XmpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMToyNzoxNFrOH2yVGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3MTg3Nw==", "bodyText": "why is this required?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526771877", "createdAt": "2020-11-19T10:58:44Z", "author": {"login": "srnagar"}, "path": "eng/versioning/version_client.txt", "diffHunk": "@@ -177,7 +177,8 @@ com.microsoft:microsoft-opentelemetry-exporter-azuremonitor;1.0.0-beta.1;1.0.0-b\n # unreleased_<groupId>:<artifactId>;dependency-version\n # note: The unreleased dependencies will not be manipulated with the automatic PR creation code.\n unreleased_com.azure:azure-core-experimental;1.0.0-beta.9\n-unreleased_com.azure:azure-messaging-servicebus;7.0.0-beta.7\n+unreleased_com.azure:azure-messaging-servicebus;7.0.0-beta.8", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEzNzEzMw==", "bodyText": "7.0.0-beta.7 has been released so I updated it when I updated the core-amqp unreleased. This PR shouldn't require it.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r527137133", "createdAt": "2020-11-19T19:18:55Z", "author": {"login": "YijunXieMS"}, "path": "eng/versioning/version_client.txt", "diffHunk": "@@ -177,7 +177,8 @@ com.microsoft:microsoft-opentelemetry-exporter-azuremonitor;1.0.0-beta.1;1.0.0-b\n # unreleased_<groupId>:<artifactId>;dependency-version\n # note: The unreleased dependencies will not be manipulated with the automatic PR creation code.\n unreleased_com.azure:azure-core-experimental;1.0.0-beta.9\n-unreleased_com.azure:azure-messaging-servicebus;7.0.0-beta.7\n+unreleased_com.azure:azure-messaging-servicebus;7.0.0-beta.8", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3MTg3Nw=="}, "originalCommit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIwOTc1NQ==", "bodyText": "Removed it after merging from master.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r527209755", "createdAt": "2020-11-19T21:27:14Z", "author": {"login": "YijunXieMS"}, "path": "eng/versioning/version_client.txt", "diffHunk": "@@ -177,7 +177,8 @@ com.microsoft:microsoft-opentelemetry-exporter-azuremonitor;1.0.0-beta.1;1.0.0-b\n # unreleased_<groupId>:<artifactId>;dependency-version\n # note: The unreleased dependencies will not be manipulated with the automatic PR creation code.\n unreleased_com.azure:azure-core-experimental;1.0.0-beta.9\n-unreleased_com.azure:azure-messaging-servicebus;7.0.0-beta.7\n+unreleased_com.azure:azure-messaging-servicebus;7.0.0-beta.8", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3MTg3Nw=="}, "originalCommit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjg4NzIyOnYy", "diffSide": "LEFT", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusAsyncConsumer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMTowMjowMFrOH2XuxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDoxMTowM1rOH2vwZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3Mzk1Ng==", "bodyText": "Why was this removed?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526773956", "createdAt": "2020-11-19T11:02:00Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusAsyncConsumer.java", "diffHunk": "@@ -34,9 +34,7 @@\n         this.linkProcessor = linkProcessor;\n         this.messageSerializer = messageSerializer;\n         this.processor = linkProcessor\n-            .map(message -> this.messageSerializer.deserialize(message, ServiceBusReceivedMessage.class))\n-            .publish(receiverOptions.getPrefetchCount())\n-            .autoConnect(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE2NzU4OA==", "bodyText": "This is removed because the publish( ) method requests the upstream (link processor) with its own request count (the reactor prefetch). With publish(), the SynchronousMessageSubscriber can't pass its own request count to link processor. The request is used to adjust link credits when prefetch = 0 (default value).\nUpdated to still remove publish() from this place and updated the async client's receiveMessages() to publish and autoConnect. So the user can subscribe it more than once. For SynchronousMessageSubscriber, I use an internal API to avoid the publish() side effect.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r527167588", "createdAt": "2020-11-19T20:11:03Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusAsyncConsumer.java", "diffHunk": "@@ -34,9 +34,7 @@\n         this.linkProcessor = linkProcessor;\n         this.messageSerializer = messageSerializer;\n         this.processor = linkProcessor\n-            .map(message -> this.messageSerializer.deserialize(message, ServiceBusReceivedMessage.class))\n-            .publish(receiverOptions.getPrefetchCount())\n-            .autoConnect(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3Mzk1Ng=="}, "originalCommit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjkwNjgxOnYy", "diffSide": "RIGHT", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMTowNzoxMlrOH2X6rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMToxNzo1OFrOH3LoLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3NzAwNg==", "bodyText": "We need to support multiple calls to receiveMessages. So, this should be fixed.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r526777006", "createdAt": "2020-11-19T11:07:12Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientTest.java", "diffHunk": "@@ -849,12 +849,15 @@ void canPerformMultipleReceive() {\n             .expectNextCount(numberOfEvents)\n             .verifyComplete();\n \n-        StepVerifier.create(receiver.receiveMessages().take(numberOfEvents))\n-            .then(() -> messages.forEach(m -> messageSink.next(m)))\n-            .expectNextCount(numberOfEvents)\n-            .verifyComplete();\n+        // TODO: Do we need to support multiple calls of receiver.receiveMessages()?\n+        //  After the autoConnect was removed from ServiceBusAsyncConsumer.processor, the receiver doesn't support\n+        //  multiple calls of receiver.receiveMessages().\n+//        StepVerifier.create(receiver.receiveMessages().take(numberOfEvents))\n+//            .then(() -> messages.forEach(m -> messageSink.next(m)))\n+//            .expectNextCount(numberOfEvents)\n+//            .verifyComplete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE4ODIxNg==", "bodyText": "Fixed after I add publish().autoConnect() to receiveMessages() implementation.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r527188216", "createdAt": "2020-11-19T20:48:07Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientTest.java", "diffHunk": "@@ -849,12 +849,15 @@ void canPerformMultipleReceive() {\n             .expectNextCount(numberOfEvents)\n             .verifyComplete();\n \n-        StepVerifier.create(receiver.receiveMessages().take(numberOfEvents))\n-            .then(() -> messages.forEach(m -> messageSink.next(m)))\n-            .expectNextCount(numberOfEvents)\n-            .verifyComplete();\n+        // TODO: Do we need to support multiple calls of receiver.receiveMessages()?\n+        //  After the autoConnect was removed from ServiceBusAsyncConsumer.processor, the receiver doesn't support\n+        //  multiple calls of receiver.receiveMessages().\n+//        StepVerifier.create(receiver.receiveMessages().take(numberOfEvents))\n+//            .then(() -> messages.forEach(m -> messageSink.next(m)))\n+//            .expectNextCount(numberOfEvents)\n+//            .verifyComplete();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3NzAwNg=="}, "originalCommit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyNDIzNg==", "bodyText": "Discussed with Srikanta again. We agreed to remove the publish and autoConnect and don't support multiple subscribers now.\nIn the future, we may create a link for each subscriber. To be discussed in the future.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17546#discussion_r527624236", "createdAt": "2020-11-20T11:17:58Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientTest.java", "diffHunk": "@@ -849,12 +849,15 @@ void canPerformMultipleReceive() {\n             .expectNextCount(numberOfEvents)\n             .verifyComplete();\n \n-        StepVerifier.create(receiver.receiveMessages().take(numberOfEvents))\n-            .then(() -> messages.forEach(m -> messageSink.next(m)))\n-            .expectNextCount(numberOfEvents)\n-            .verifyComplete();\n+        // TODO: Do we need to support multiple calls of receiver.receiveMessages()?\n+        //  After the autoConnect was removed from ServiceBusAsyncConsumer.processor, the receiver doesn't support\n+        //  multiple calls of receiver.receiveMessages().\n+//        StepVerifier.create(receiver.receiveMessages().take(numberOfEvents))\n+//            .then(() -> messages.forEach(m -> messageSink.next(m)))\n+//            .expectNextCount(numberOfEvents)\n+//            .verifyComplete();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3NzAwNg=="}, "originalCommit": {"oid": "aee463cec1e1e55aeb4673c9324041d968f4d98a"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2825, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}