{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTI4NTEx", "number": 9242, "title": "Fixes issue where an error is output from request(0)", "bodyText": "Fixes issue where, in debug, an error log is output when subscribing to the async clients.\njava.lang.IllegalArgumentException: Spec. Rule 3.9 - Cannot request a non strictly positive number: 0\nat reactor.core.Exceptions.nullOrNegativeRequestException(Exceptions.java:318)\nat reactor.core.publisher.Operators.reportBadRequest(Operators.java:905)\nat reactor.core.publisher.Operators.validate(Operators.java:1103)\nat reactor.core.publisher.Operators$MultiSubscriptionSubscriber.request(Operators.java:1899)\nat com.azure.core.amqp.implementation.AmqpChannelProcessor.onSubscribe(AmqpChannelProcessor.java:64)\nat reactor.core.publisher.MonoRepeatPredicate.subscribeOrReturn(MonoRepeatPredicate.java:44)\nat reactor.core.publisher.Flux.subscribe(Flux.java:8120)\nat reactor.core.publisher.Flux.subscribeWith(Flux.java:8298)", "createdAt": "2020-03-19T17:08:18Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9242", "merged": true, "mergeCommit": {"oid": "c4ff4d5f8923f849c476db39cb0af8525dd3017f"}, "closed": true, "closedAt": "2020-03-19T20:04:15Z", "author": {"login": "conniey"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPNJ_7AH2gAyMzkxMTI4NTExOjg5NGQyYzc0MDBmYTYzOTY2MGE2ODk4MTk0YjIwMjk5Njc3MzdlZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPRQsbAH2gAyMzkxMTI4NTExOjRmY2E1OWNjMWNlOGM4YThiYzM1OWRkNTEzZmY5ZmMwNDQ5ZmY3NjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "894d2c7400fa639660a6898194b2029967737ef6", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/894d2c7400fa639660a6898194b2029967737ef6", "committedDate": "2020-03-19T14:54:38Z", "message": "Removing entityPath from ConnectionOptions because it can be to multiple paths."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9db9ccd574b017d43fcb27cc0edcaf14c98f04a2", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9db9ccd574b017d43fcb27cc0edcaf14c98f04a2", "committedDate": "2020-03-19T14:54:38Z", "message": "Adding a catch to IllegalStateException when reactor is free'd from another thread."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a0184d12ca1d0c7d24cb718374e4d9b00a1d982", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4a0184d12ca1d0c7d24cb718374e4d9b00a1d982", "committedDate": "2020-03-19T14:54:38Z", "message": "Fixing debug error when request(0L) is used."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03f792b21ad9deb7b460114275169e7a7c49758e", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/03f792b21ad9deb7b460114275169e7a7c49758e", "committedDate": "2020-03-19T14:54:39Z", "message": "Adding a queue to drain received messages."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca772a80be4dc47651110a60d1f448de2f59fb25", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ca772a80be4dc47651110a60d1f448de2f59fb25", "committedDate": "2020-03-19T16:58:57Z", "message": "Emitting a single connection."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "329c7613b5b9649cbbf4a46e176835daf12c3013", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/329c7613b5b9649cbbf4a46e176835daf12c3013", "committedDate": "2020-03-19T16:59:29Z", "message": "Updating ReactorConnection."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eda6f9c5fb9e6f7e6e39afc540251b70ed2ceeb", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3eda6f9c5fb9e6f7e6e39afc540251b70ed2ceeb", "committedDate": "2020-03-19T16:59:30Z", "message": "Adding fallback for PartitionBasedLoadBalancer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "836b4694a5a6d6dfe9d9bd6609b70956dd49426f", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/836b4694a5a6d6dfe9d9bd6609b70956dd49426f", "committedDate": "2020-03-19T16:59:30Z", "message": "Request 1 on subscribe."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3OTM4NjA2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9242#pullrequestreview-377938606", "createdAt": "2020-03-19T17:25:51Z", "commit": {"oid": "836b4694a5a6d6dfe9d9bd6609b70956dd49426f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzoyNTo1MlrOF445Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzoyNjo1NlrOF4473w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NjY3OA==", "bodyText": "Can this happen? We always request 1 connection.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9242#discussion_r395196678", "createdAt": "2020-03-19T17:25:52Z", "author": {"login": "srnagar"}, "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubClientBuilder.java", "diffHunk": "@@ -552,13 +548,24 @@ private EventHubConnectionProcessor buildConnectionProcessor(MessageSerializer m\n         final String product = properties.getOrDefault(NAME_KEY, UNKNOWN);\n         final String clientVersion = properties.getOrDefault(VERSION_KEY, UNKNOWN);\n \n-        final Flux<EventHubAmqpConnection> connectionFlux = Mono.fromCallable(() -> {\n-            final String connectionId = StringUtil.getRandomString(\"MF\");\n+        final Flux<EventHubAmqpConnection> connectionFlux = Flux.create(sink -> {\n+            sink.onRequest(request -> {\n+\n+                if (request == 0) {\n+                    return;\n+                } else if (request > 1) {\n+                    logger.warning(\"Requested more than one connection. Only emitting one. Request: {}\", request);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "836b4694a5a6d6dfe9d9bd6609b70956dd49426f"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NzQwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            // So it is okay that there is we return an empty Flux.\n          \n          \n            \n                            // So it is okay to return an empty Flux.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9242#discussion_r395197407", "createdAt": "2020-03-19T17:26:56Z", "author": {"login": "srnagar"}, "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionBasedLoadBalancer.java", "diffHunk": "@@ -112,6 +114,12 @@ void loadBalance() {\n         final Mono<List<String>> partitionsMono = eventHubAsyncClient\n             .getPartitionIds()\n             .timeout(Duration.ofMinutes(1))\n+            .onErrorResume(TimeoutException.class, error -> {\n+                // In the subsequent step where it tries to balance the load, it'll propagate an error to the user.\n+                // So it is okay that there is we return an empty Flux.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "836b4694a5a6d6dfe9d9bd6609b70956dd49426f"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebbc2307da557bf0514b9c503e8896a2e851b7e9", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ebbc2307da557bf0514b9c503e8896a2e851b7e9", "committedDate": "2020-03-19T17:37:03Z", "message": "Update sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionBasedLoadBalancer.java\n\nCo-Authored-By: Srikanta <51379715+srnagar@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70f6212e2d1aec2baf901916dbe75a5872034ace", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/70f6212e2d1aec2baf901916dbe75a5872034ace", "committedDate": "2020-03-19T18:12:42Z", "message": "Fixing logger error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2aa803c07e8ac96226bad842bcbeeef58cc52eb", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b2aa803c07e8ac96226bad842bcbeeef58cc52eb", "committedDate": "2020-03-19T18:13:43Z", "message": "Fixing log issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7465e489c99590c36facb0db0e8063b91390e316", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7465e489c99590c36facb0db0e8063b91390e316", "committedDate": "2020-03-19T18:26:37Z", "message": "Fixing errors."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed87dce45b052bf6bcaf6dc9f750ef19204c510c", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ed87dce45b052bf6bcaf6dc9f750ef19204c510c", "committedDate": "2020-03-19T18:29:41Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdda92381c67422dcef969a861401fb2e9ed4cb0", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bdda92381c67422dcef969a861401fb2e9ed4cb0", "committedDate": "2020-03-19T18:40:19Z", "message": "Merge branch 'subscribe-zero-issue' of https://github.com/conniey/azure-sdk-for-java into subscribe-zero-issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fca59cc1ce8c8a8bc359dd513ff9fc0449ff766", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4fca59cc1ce8c8a8bc359dd513ff9fc0449ff766", "committedDate": "2020-03-19T19:41:34Z", "message": "Return an error instead."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 591, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}