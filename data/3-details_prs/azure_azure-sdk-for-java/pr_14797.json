{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5MDYyNzk0", "number": 14797, "title": "[Tables] Fix tables livetest", "bodyText": "Fixes: #14798", "createdAt": "2020-09-03T22:46:26Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797", "merged": true, "mergeCommit": {"oid": "992ee0b4e839c6bfef0619ec072a82d8f20d64bf"}, "closed": true, "closedAt": "2020-09-09T01:02:23Z", "author": {"login": "bsiegel"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFY9UIgBqjM3MjcxNDEyMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHBPMEABqjM3NDMzMzc5NDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "128243f57dc45ec81a91f6db06041d3519c505df", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/128243f57dc45ec81a91f6db06041d3519c505df", "committedDate": "2020-09-03T22:45:58Z", "message": "Fix tables livetest"}, "afterCommit": {"oid": "ae88645cb0a4fbd9567ff9297cd23c8713aec7a7", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ae88645cb0a4fbd9567ff9297cd23c8713aec7a7", "committedDate": "2020-09-03T23:11:22Z", "message": "Fix tables livetest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDM3MTk2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#pullrequestreview-482437196", "createdAt": "2020-09-04T07:53:58Z", "commit": {"oid": "ae88645cb0a4fbd9567ff9297cd23c8713aec7a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNzo1Mzo1OFrOHNDgJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNzo1Mzo1OFrOHNDgJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MDkxOA==", "bodyText": "We run them in LIVE mode so that the results aren't persisted, it'll just run against the live service.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r483450918", "createdAt": "2020-09-04T07:53:58Z", "author": {"login": "conniey"}, "path": "sdk/tables/tests.yml", "diffHunk": "@@ -7,7 +7,7 @@ jobs:\n       Timeout: 60\n       MaxParallel: 12\n       EnvVars:\n-        AZURE_TEST_MODE: LIVE\n+        AZURE_TEST_MODE: RECORD", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae88645cb0a4fbd9567ff9297cd23c8713aec7a7"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f618bc95a32360fef3c4a460f23f57e4c8c70b6c", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f618bc95a32360fef3c4a460f23f57e4c8c70b6c", "committedDate": "2020-09-04T18:29:28Z", "message": "Fix LIVE mode"}, "afterCommit": {"oid": "7a9c189f3db2cec597f3002a079df06a810cd7b6", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a9c189f3db2cec597f3002a079df06a810cd7b6", "committedDate": "2020-09-07T22:36:08Z", "message": "Fix tests and re-enable disabled tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac250bca611a37c63eb60383a2615198bbe4eeb8", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ac250bca611a37c63eb60383a2615198bbe4eeb8", "committedDate": "2020-09-07T22:40:52Z", "message": "Fix checkstyle"}, "afterCommit": {"oid": "19acd897f614fce1918d180c16ecbbb1e74a0277", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/19acd897f614fce1918d180c16ecbbb1e74a0277", "committedDate": "2020-09-07T22:43:42Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDA2MTcw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#pullrequestreview-484406170", "createdAt": "2020-09-08T18:49:02Z", "commit": {"oid": "718971bf20e783ca1333d4e25212d93e3f6c3e1b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxODo0OTowMlrOHOpyHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxODo0OTowMlrOHOpyHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNjY4Nw==", "bodyText": "Does this work for async? The apply method would return a Mono but it would not actually be invoked until someone subscribed to it.\nI think a more reactive approach is required to keep retrying depending on the error. there is a retryWhen operator.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r485126687", "createdAt": "2020-09-08T18:49:02Z", "author": {"login": "conniey"}, "path": "sdk/tables/azure-data-tables/src/test/java/com/azure/data/tables/CosmosThrottled.java", "diffHunk": "@@ -0,0 +1,110 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.data.tables;\n+\n+import com.azure.core.exception.AzureException;\n+import com.azure.data.tables.implementation.AzureTableImpl;\n+import com.azure.data.tables.implementation.models.TableServiceErrorException;\n+\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+\n+public abstract class CosmosThrottled<T> {\n+    protected final T client;\n+    protected final boolean isPlaybackMode;\n+\n+    protected CosmosThrottled(T client, boolean isPlaybackMode) {\n+        this.client = client;\n+        this.isPlaybackMode = isPlaybackMode;\n+    }\n+\n+    public abstract boolean isCosmos();\n+\n+    public void runVoid(Consumer<T> action) {\n+        run(c -> {\n+            action.accept(c);\n+            return null;\n+        });\n+    }\n+\n+    public T getClient() {\n+        return client;\n+    }\n+\n+    public <TResult> TResult run(Function<T, TResult> action) {\n+        if (!isCosmos()) {\n+            return action.apply(client);\n+        }\n+\n+        int retryCount = 0;\n+        int delay = 1500;\n+        while (true) {\n+            try {\n+                return action.apply(client);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718971bf20e783ca1333d4e25212d93e3f6c3e1b"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "718971bf20e783ca1333d4e25212d93e3f6c3e1b", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/718971bf20e783ca1333d4e25212d93e3f6c3e1b", "committedDate": "2020-09-08T01:12:00Z", "message": "Update recordings"}, "afterCommit": {"oid": "d64917d510f80b43d10dd6bac7c7da1f6f5a4743", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d64917d510f80b43d10dd6bac7c7da1f6f5a4743", "committedDate": "2020-09-09T00:18:17Z", "message": "Remove CosmosThrottled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTc4OTY0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#pullrequestreview-484578964", "createdAt": "2020-09-09T00:28:27Z", "commit": {"oid": "d64917d510f80b43d10dd6bac7c7da1f6f5a4743"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDoyODoyOFrOHOyXAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDoyOToxNlrOHOyXxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NzIwMw==", "bodyText": "Can we split this into another test case and disable it? I feel it'll get lost as a comment since there is no issue or TODO tracking this.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r485267203", "createdAt": "2020-09-09T00:28:28Z", "author": {"login": "conniey"}, "path": "sdk/tables/azure-data-tables/src/test/java/com/azure/data/tables/TablesAsyncClientTest.java", "diffHunk": "@@ -339,20 +361,27 @@ void updateEntityWithResponseAsync(UpdateMode mode) {\n         createdEntity.getProperties().remove(oldPropertyKey);\n         createdEntity.addProperty(newPropertyKey, \"valueB\");\n \n-        // Act\n-        StepVerifier.create(tableClient.updateEntityWithResponse(createdEntity, true, mode))\n-            .assertNext(response -> assertEquals(expectedStatusCode, response.getStatusCode()))\n-            .expectComplete()\n-            .verify();\n-\n-        // Assert and verify that the new properties are in there.\n-        StepVerifier.create(tableClient.getEntity(partitionKeyValue, rowKeyValue))\n-            .assertNext(entity -> {\n-                final Map<String, Object> properties = entity.getProperties();\n-                assertTrue(properties.containsKey(newPropertyKey));\n-                assertEquals(expectOldProperty, properties.containsKey(oldPropertyKey));\n-            })\n-            .verifyComplete();\n+        // Act & Assert\n+        if (mode == UpdateMode.MERGE && tableClient.getTableUrl().contains(\"cosmos.azure.com\")) {\n+            // This scenario is currently broken when using the CosmosDB Table API\n+            StepVerifier.create(tableClient.updateEntityWithResponse(createdEntity, true, mode))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d64917d510f80b43d10dd6bac7c7da1f6f5a4743"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NzM5Nw==", "bodyText": "Is there a reason for splitting this into three sequential blocks rather than running them concurrently?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r485267397", "createdAt": "2020-09-09T00:29:16Z", "author": {"login": "conniey"}, "path": "sdk/tables/azure-data-tables/src/test/java/com/azure/data/tables/TableServiceAsyncClientTest.java", "diffHunk": "@@ -228,12 +227,10 @@ void serviceListTablesWithTopAsync() {\n         final String tableName2 = testResourceNamer.randomName(\"test\", 20);\n         final String tableName3 = testResourceNamer.randomName(\"test\", 20);\n         ListTablesOptions options = new ListTablesOptions().setTop(2);\n-        Mono.when(\n-            serviceClient.createTable(tableName),\n-            serviceClient.createTable(tableName2),\n-            serviceClient.createTable(tableName3)\n-        ).block(TIMEOUT);\n-        \n+        serviceClient.createTable(tableName).block(TIMEOUT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d64917d510f80b43d10dd6bac7c7da1f6f5a4743"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6853bab045dadfe1ec90e242060187ab848d5427", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6853bab045dadfe1ec90e242060187ab848d5427", "committedDate": "2020-09-09T00:39:57Z", "message": "Fix tables livetest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c2ba82a073bb2302a21385bef5bb7d854eab5ab", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2c2ba82a073bb2302a21385bef5bb7d854eab5ab", "committedDate": "2020-09-09T00:39:58Z", "message": "Fix LIVE mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "701ffe60b97d0a32c76c65c7779a5f01788e189f", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/701ffe60b97d0a32c76c65c7779a5f01788e189f", "committedDate": "2020-09-09T00:39:58Z", "message": "Work around unsupported operation in Cosmos API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8eeabeca907e280dfabb4f2f44463c6e56b3a28", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e8eeabeca907e280dfabb4f2f44463c6e56b3a28", "committedDate": "2020-09-09T00:39:58Z", "message": "Add CosmosThrottled wrapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b46416429c0dc87033d53246d68e91f4696370d5", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b46416429c0dc87033d53246d68e91f4696370d5", "committedDate": "2020-09-09T00:39:59Z", "message": "Fix merge test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4969d95f09583416e56fce3220eb4a2c885e6a59", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4969d95f09583416e56fce3220eb4a2c885e6a59", "committedDate": "2020-09-09T00:39:59Z", "message": "Fix cleanup in ImplTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c775e68a5d12777096440e0e30ea50c4b542ec47", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c775e68a5d12777096440e0e30ea50c4b542ec47", "committedDate": "2020-09-09T00:39:59Z", "message": "Mono.when doesn't play nice with CosmosThrottle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39d23000bfc7b47f66fc48288a6b322841a204c9", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/39d23000bfc7b47f66fc48288a6b322841a204c9", "committedDate": "2020-09-09T00:40:00Z", "message": "Permit more retries in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d08fd4741f461db1eb8c92940066d3ad90d66dc9", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d08fd4741f461db1eb8c92940066d3ad90d66dc9", "committedDate": "2020-09-09T00:40:00Z", "message": "Fix tests and re-enable disabled tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2366f82c22bd616c4dd993ea62cb0ca08442d38a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2366f82c22bd616c4dd993ea62cb0ca08442d38a", "committedDate": "2020-09-09T00:40:00Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bebd0fa8f9da706a83923c9bf3cf3fcfa46a60e", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2bebd0fa8f9da706a83923c9bf3cf3fcfa46a60e", "committedDate": "2020-09-09T00:40:01Z", "message": "Update recordings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "582c6dbd88b857239e963d62babddbbb5e77db08", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/582c6dbd88b857239e963d62babddbbb5e77db08", "committedDate": "2020-09-09T00:40:01Z", "message": "Remove CosmosThrottled"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d64917d510f80b43d10dd6bac7c7da1f6f5a4743", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d64917d510f80b43d10dd6bac7c7da1f6f5a4743", "committedDate": "2020-09-09T00:18:17Z", "message": "Remove CosmosThrottled"}, "afterCommit": {"oid": "582c6dbd88b857239e963d62babddbbb5e77db08", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/582c6dbd88b857239e963d62babddbbb5e77db08", "committedDate": "2020-09-09T00:40:01Z", "message": "Remove CosmosThrottled"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4894, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}