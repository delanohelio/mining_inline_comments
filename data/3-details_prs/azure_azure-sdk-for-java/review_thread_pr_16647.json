{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3OTE2Mzc2", "number": 16647, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNTowMzowNVrOEwmMtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMToxOTowMFrOEynMeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MzkyOTQ5OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/AddressInformation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNTowMzowNVrOHmQr8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTozNjoxMlrOHmn2iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4MTMyOQ==", "bodyText": "is getServerKey() invoked for every request?\nIs it possible to pre-compute the value and cache the URI? I think new URI uses toString and string parsing underneath which is CPU intensive.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r509881329", "createdAt": "2020-10-22T05:03:05Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/AddressInformation.java", "diffHunk": "@@ -53,6 +57,25 @@ public String getProtocolScheme() {\n         return this.protocol.scheme();\n     }\n \n+    public URI getServerKey() {\n+        URI uri = this.physicalUri.getURI();\n+\n+        try {\n+            return new URI(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2MDg3Mg==", "bodyText": "It is not invoked for each request, only called after we refreshed the address from the gateway. and should only be called once.\nI thought can compute it when construct the AddressInformation, but did not end up doing it because since we will only call it when connectionStateListener is enabled.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r510260872", "createdAt": "2020-10-22T15:36:12Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/AddressInformation.java", "diffHunk": "@@ -53,6 +57,25 @@ public String getProtocolScheme() {\n         return this.protocol.scheme();\n     }\n \n+    public URI getServerKey() {\n+        URI uri = this.physicalUri.getURI();\n+\n+        try {\n+            return new URI(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4MTMyOQ=="}, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MzkzNTc0OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNTowNjo1N1rOHmQvsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo0NTo1OVrOHmoSww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4MjI5MA==", "bodyText": "code style: \"{\" on the same line as if", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r509882290", "createdAt": "2020-10-22T05:06:57Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "diffHunk": "@@ -622,14 +644,40 @@ public void dispose() {\n     }\n \n     private Pair<PartitionKeyRangeIdentity, AddressInformation[]> toPartitionAddressAndRange(String collectionRid, List<Address> addresses) {\n-        logger.debug(\"toPartitionAddressAndRange\");\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"toPartitionAddressAndRange\");\n+        }\n+\n         Address address = addresses.get(0);\n+        PartitionKeyRangeIdentity partitionKeyRangeIdentity = new PartitionKeyRangeIdentity(collectionRid, address.getParitionKeyRangeId());\n \n         AddressInformation[] addressInfos =\n                 addresses.stream().map(addr ->\n                                 GatewayAddressCache.toAddressInformation(addr)\n                                       ).collect(Collectors.toList()).toArray(new AddressInformation[addresses.size()]);\n-        return Pair.of(new PartitionKeyRangeIdentity(collectionRid, address.getParitionKeyRangeId()), addressInfos);\n+\n+        if (this.tcpConnectionEndpointRediscoveryEnabled)\n+        {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2ODA5OQ==", "bodyText": "Updated.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r510268099", "createdAt": "2020-10-22T15:45:59Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "diffHunk": "@@ -622,14 +644,40 @@ public void dispose() {\n     }\n \n     private Pair<PartitionKeyRangeIdentity, AddressInformation[]> toPartitionAddressAndRange(String collectionRid, List<Address> addresses) {\n-        logger.debug(\"toPartitionAddressAndRange\");\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"toPartitionAddressAndRange\");\n+        }\n+\n         Address address = addresses.get(0);\n+        PartitionKeyRangeIdentity partitionKeyRangeIdentity = new PartitionKeyRangeIdentity(collectionRid, address.getParitionKeyRangeId());\n \n         AddressInformation[] addressInfos =\n                 addresses.stream().map(addr ->\n                                 GatewayAddressCache.toAddressInformation(addr)\n                                       ).collect(Collectors.toList()).toArray(new AddressInformation[addresses.size()]);\n-        return Pair.of(new PartitionKeyRangeIdentity(collectionRid, address.getParitionKeyRangeId()), addressInfos);\n+\n+        if (this.tcpConnectionEndpointRediscoveryEnabled)\n+        {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4MjI5MA=="}, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5Mzk0NDQxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GlobalAddressResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNToxMTo1NlrOHmQ0zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo0MDoyNlrOHmoCsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4MzU5Ng==", "bodyText": "don't we need a check inside the method if the feature flag is enabled here?\nor if the feature flag is disable this method never is invoked?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r509883596", "createdAt": "2020-10-22T05:11:56Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GlobalAddressResolver.java", "diffHunk": "@@ -101,23 +102,19 @@ public GlobalAddressResolver(\n     }\n \n     @Override\n-    public void remove(\n-        final RxDocumentServiceRequest request,\n-        final Set<PartitionKeyRangeIdentity> partitionKeyRangeIdentitySet) {\n+    public void updateAddresses(final RxDocumentServiceRequest request, final URI serverKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2Mzk4Ng==", "bodyText": "By theory, this method will never be called when the feature flag is disabled. It is guarded in the following code:\n  if (this.connectionStateListener != null) { this.connectionStateListener.onException(record.args().serviceRequest(), exception); }\nBut it is good to check here as well, so changed to check it and  log an warn message if the feature flag is not enabled.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r510263986", "createdAt": "2020-10-22T15:40:26Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GlobalAddressResolver.java", "diffHunk": "@@ -101,23 +102,19 @@ public GlobalAddressResolver(\n     }\n \n     @Override\n-    public void remove(\n-        final RxDocumentServiceRequest request,\n-        final Set<PartitionKeyRangeIdentity> partitionKeyRangeIdentitySet) {\n+    public void updateAddresses(final RxDocumentServiceRequest request, final URI serverKey) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4MzU5Ng=="}, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5Mzk0NzMyOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNToxMzo0MFrOHmQ2lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo0NDo0M1rOHmoPOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4NDA1Mg==", "bodyText": "in my understanding in .Net version we are doing the cache update in the global cache (all regions).\nBut here we are doing it per region (per GatewayAddressCache).\nam I right?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r509884052", "createdAt": "2020-10-22T05:13:40Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "diffHunk": "@@ -84,14 +85,18 @@\n     private volatile Pair<PartitionKeyRangeIdentity, AddressInformation[]> masterPartitionAddressCache;\n     private volatile Instant suboptimalMasterPartitionTimestamp;\n \n+    private final ConcurrentHashMap<URI, Set<PartitionKeyRangeIdentity>> serverPartitionAddressToPkRangeIdMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI2NzE5Mw==", "bodyText": "In .net version, the cache is also per region (per GatewayAddressCache).\nThe difference is around when exception happens, which cache to update:\nIn .net version, all caches (all regions) will be checked and updated if applicable.\nIn current java, we will get the endpoint from URI serviceEndpoint = this.endpointManager.resolveServiceEndpoint(request);, so we only update the cache for that specific region.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r510267193", "createdAt": "2020-10-22T15:44:43Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "diffHunk": "@@ -84,14 +85,18 @@\n     private volatile Pair<PartitionKeyRangeIdentity, AddressInformation[]> masterPartitionAddressCache;\n     private volatile Instant suboptimalMasterPartitionTimestamp;\n \n+    private final ConcurrentHashMap<URI, Set<PartitionKeyRangeIdentity>> serverPartitionAddressToPkRangeIdMap;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4NDA1Mg=="}, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNTA2NDI2OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/AddressInformation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMToxOTowMFrOHpWkPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxODoxMTowM1rOHp3XfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEyMzM5MA==", "bodyText": "the format of the ServerKey URI returned from here needs to exactly match with format of ServerKey URI constructed by RNTBD. as discussed offline please consider making a class for this.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r513123390", "createdAt": "2020-10-28T01:19:00Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/AddressInformation.java", "diffHunk": "@@ -53,6 +57,25 @@ public String getProtocolScheme() {\n         return this.protocol.scheme();\n     }\n \n+    public URI getServerKey() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaae86c23009fe57402c0996f8e15a9bb1cdbabe"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY2MDc5Nw==", "bodyText": "Thanks Mo~\nCreated a static method in RntbdUtils :: getServerKey to be used across", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r513660797", "createdAt": "2020-10-28T18:11:03Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/AddressInformation.java", "diffHunk": "@@ -53,6 +57,25 @@ public String getProtocolScheme() {\n         return this.protocol.scheme();\n     }\n \n+    public URI getServerKey() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEyMzM5MA=="}, "originalCommit": {"oid": "eaae86c23009fe57402c0996f8e15a9bb1cdbabe"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3985, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}