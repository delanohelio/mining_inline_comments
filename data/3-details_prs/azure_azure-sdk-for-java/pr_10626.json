{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExMTEyNTMy", "number": 10626, "title": "Fix Body Length Validation", "bodyText": "Fixes #10588\nResolves issue where the validation of the request body size didn't reset itself when retrying.", "createdAt": "2020-04-30T03:59:39Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626", "merged": true, "mergeCommit": {"oid": "da79f565085e516d7fa2c1f440995918a552cfe0"}, "closed": true, "closedAt": "2020-04-30T17:12:09Z", "author": {"login": "alzimmermsft"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcck8akAH2gAyNDExMTEyNTMyOmYxZDdlMTkzOTgzMTdmMmYxMDE2YmM5Nzg4Mjk3ZTI4ZTc2ZThiOWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccvcyygH2gAyNDExMTEyNTMyOmVjNmU1ODIyM2IxYzBlNDE5NjNjNDc2MGZhMTYyZTMyNWJkY2ZkYTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f1d7e19398317f2f1016bc9788297e28e76e8b9c", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f1d7e19398317f2f1016bc9788297e28e76e8b9c", "committedDate": "2020-04-30T03:58:32Z", "message": "Fix error where body length validation wouldn't reset on retry"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMTg5MDgy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#pullrequestreview-403189082", "createdAt": "2020-04-30T04:15:10Z", "commit": {"oid": "f1d7e19398317f2f1016bc9788297e28e76e8b9c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDoxNToxMVrOGOZCtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNDoxNToxMVrOGOZCtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MzU0Mg==", "bodyText": "just curious, is this issue happens due to one of these operators eagerly subscribing? or something else?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#discussion_r417743542", "createdAt": "2020-04-30T04:15:11Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/rest/RestProxy.java", "diffHunk": "@@ -135,38 +135,40 @@ public Object invoke(Object proxy, final Method method, Object[] args) {\n         }\n     }\n \n-    private Flux<ByteBuffer> validateLength(final HttpRequest request) {\n+    static Flux<ByteBuffer> validateLength(final HttpRequest request) {\n         final Flux<ByteBuffer> bbFlux = request.getBody();\n         if (bbFlux == null) {\n             return Flux.empty();\n         }\n \n         long expectedLength = Long.parseLong(request.getHeaders().getValue(\"Content-Length\"));\n-        final long[] currentTotalLength = new long[1];\n \n-        return Flux.concat(bbFlux, Flux.just(VALIDATION_BUFFER)).handle((buffer, sink) -> {\n-            if (buffer == null) {\n-                return;\n-            }\n+        return Flux.defer(() -> {\n+            final long[] currentTotalLength = new long[1];\n+            return Flux.concat(bbFlux, Flux.just(VALIDATION_BUFFER)).handle((buffer, sink) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1d7e19398317f2f1016bc9788297e28e76e8b9c"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMTk3MDcx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#pullrequestreview-403197071", "createdAt": "2020-04-30T04:47:13Z", "commit": {"oid": "f1d7e19398317f2f1016bc9788297e28e76e8b9c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMjg0NjAw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#pullrequestreview-403284600", "createdAt": "2020-04-30T07:55:19Z", "commit": {"oid": "f1d7e19398317f2f1016bc9788297e28e76e8b9c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNzo1NToxOVrOGOd8Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNzo1NToxOVrOGOd8Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgyMzgwMw==", "bodyText": "Would be better to validate the error message as well as that is what we will use to debug issues.\n        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"4\")))\n            .verifyErrorSatisfies(throwable -> {\n                    assertTrue(throwable instanceof UnexpectedLengthException);\n                    assertTrue(throwable.getMessage().equals(\"Request body emitted 4 bytes, less than the expected 5 bytes.\"\n            });\n\n        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"6\")))\n            .verifyErrorSatisfies(throwable -> {\n                    assertTrue(throwable instanceof UnexpectedLengthException);\n                    assertTrue(throwable.getMessage().equals(\"Request body emitted 6 bytes, more than the expected 5 bytes.\"\n            });", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#discussion_r417823803", "createdAt": "2020-04-30T07:55:19Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core/src/test/java/com/azure/core/http/rest/RestProxyTests.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.rest;\n+\n+import com.azure.core.exception.UnexpectedLengthException;\n+import com.azure.core.http.HttpMethod;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.util.FluxUtil;\n+import org.junit.jupiter.api.Test;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+import reactor.test.StepVerifier;\n+\n+import java.nio.ByteBuffer;\n+\n+import static org.junit.jupiter.api.Assertions.assertArrayEquals;\n+\n+/**\n+ * Tests {@link RestProxy}.\n+ */\n+public class RestProxyTests {\n+    private static final byte[] EXPECTED = new byte[] { 0, 1, 2, 3, 4 };\n+\n+    @Test\n+    public void emptyRequestBody() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\");\n+\n+        StepVerifier.create(RestProxy.validateLength(httpRequest))\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    public void expectedBodyLength() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\")\n+            .setBody(EXPECTED)\n+            .setHeader(\"Content-Length\", \"5\");\n+\n+        StepVerifier.create(collectRequest(httpRequest))\n+            .assertNext(bytes -> assertArrayEquals(EXPECTED, bytes))\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    public void unexpectedBodyLength() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\")\n+            .setBody(EXPECTED);\n+\n+        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"4\")))\n+            .verifyError(UnexpectedLengthException.class);\n+\n+        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"6\")))\n+            .verifyError(UnexpectedLengthException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1d7e19398317f2f1016bc9788297e28e76e8b9c"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec6e58223b1c0e41963c4760fa162e325bdcfda1", "author": {"user": {"login": "alzimmermsft", "name": "Alan Zimmer"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ec6e58223b1c0e41963c4760fa162e325bdcfda1", "committedDate": "2020-04-30T16:12:57Z", "message": "Make the tests more rigorous"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4455, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}