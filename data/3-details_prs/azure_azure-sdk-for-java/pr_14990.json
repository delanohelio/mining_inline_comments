{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMDg4ODAy", "number": 14990, "title": "Force closes links when connection is closed so it requests another link.", "bodyText": "There is a bug where we try to reopen the connection, but there are no downstream subscribers because the first receive link has not received a terminal signal yet. Consequently, another \"amqp:connection:forced\" error is propagated due to idle links, and the cycle continues.\n\nThe connection handler is closed first, but its children are not disposed of.\nRemoves getErrors() from Handler since an error is always a terminal signal, it can be grouped into getEndpointStates().\n\nFixes: #13785, #13420, #13924", "createdAt": "2020-09-09T19:39:04Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990", "merged": true, "mergeCommit": {"oid": "f2eb437a21ae91ab9f4516f8345546763729cffb"}, "closed": true, "closedAt": "2020-09-10T19:10:27Z", "author": {"login": "conniey"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHTKwZgBqjM3NDc5MzAzMDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHlNsagH2gAyNDgzMDg4ODAyOjg3NGVkZGRiY2M5MjZjYjg5ZTUxYzJkNjczMGM1ZTcwZjg5ZmY4Yzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "091b1f3eaa4b20238475c75aed79c5693c4b59b9", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/091b1f3eaa4b20238475c75aed79c5693c4b59b9", "committedDate": "2020-09-09T19:36:19Z", "message": "Locally closing on connection error."}, "afterCommit": {"oid": "1b10fd55cf95456aa4410dee467b8e8cb78d402d", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b10fd55cf95456aa4410dee467b8e8cb78d402d", "committedDate": "2020-09-09T21:34:28Z", "message": "Locally closing on connection error."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87b774c18dc4bd2bc18847d0babab07dc16a41a3", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/87b774c18dc4bd2bc18847d0babab07dc16a41a3", "committedDate": "2020-09-10T05:31:13Z", "message": "Remove unneeded retryuntils"}, "afterCommit": {"oid": "3ecd4390eee221bbef3ce518fff198fffb57b4b3", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3ecd4390eee221bbef3ce518fff198fffb57b4b3", "committedDate": "2020-09-10T05:43:18Z", "message": "Remove unneeded retryuntils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MzQ4NDI5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#pullrequestreview-485348429", "createdAt": "2020-09-09T19:41:29Z", "commit": {"oid": "091b1f3eaa4b20238475c75aed79c5693c4b59b9"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOTo0MToyOVrOHPXNYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMzo0MjoyOVrOHPd4rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3MDk0Ng==", "bodyText": "Delete empty class.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r485870946", "createdAt": "2020-09-09T19:41:29Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-amqp/src/test/java/com/azure/core/amqp/implementation/handler/ReceiveLinkHandlerTest.java", "diffHunk": "@@ -0,0 +1,10 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.amqp.implementation.handler;\n+\n+/**\n+ * Tests for {@link ReceiveLinkHandler}.\n+ */\n+class ReceiveLinkHandlerTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "091b1f3eaa4b20238475c75aed79c5693c4b59b9"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3ODI5NQ==", "bodyText": "Just curious if we need to cache the last event?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r485978295", "createdAt": "2020-09-09T23:35:22Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorConnection.java", "diffHunk": "@@ -106,23 +107,12 @@ public ReactorConnection(String connectionId, ConnectionOptions connectionOption\n         this.connectionMono = Mono.fromCallable(this::getOrCreateConnection)\n             .doOnSubscribe(c -> hasConnection.set(true));\n \n-        this.subscriptions = Disposables.composite(\n-            this.handler.getEndpointStates().subscribe(\n-                state -> {\n-                    logger.verbose(\"connectionId[{}]: Connection state: {}\", connectionId, state);\n-                    endpointStatesSink.next(AmqpEndpointStateUtil.getConnectionState(state));\n-                }, error -> {\n-                    logger.error(\"connectionId[{}] Error occurred in connection endpoint.\", connectionId, error);\n-                    endpointStatesSink.error(error);\n-                }, () -> {\n-                    endpointStatesSink.next(AmqpEndpointState.CLOSED);\n-                    endpointStatesSink.complete();\n-                }),\n-\n-            this.handler.getErrors().subscribe(error -> {\n-                logger.error(\"connectionId[{}] Error occurred in connection handler.\", connectionId, error);\n-                endpointStatesSink.error(error);\n-            }));\n+        this.endpointStates = this.handler.getEndpointStates()\n+            .takeUntilOther(shutdownSignals)\n+            .map(state -> {\n+                logger.verbose(\"connectionId[{}]: State {}\", connectionId, state);\n+                return AmqpEndpointStateUtil.getConnectionState(state);\n+            }).subscribeWith(ReplayProcessor.cacheLastOrDefault(AmqpEndpointState.UNINITIALIZED));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99b13b380fae5db73af433724a773d59c19418a3"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3ODg4NQ==", "bodyText": "Nice! Although, I haven't observed duplicates here generally but this is a nice improvement!", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r485978885", "createdAt": "2020-09-09T23:37:35Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorReceiver.java", "diffHunk": "@@ -69,43 +67,28 @@ protected ReactorReceiver(String entityPath, Receiver receiver, ReceiveLinkHandl\n                 }\n             })\n             .subscribeWith(EmitterProcessor.create());\n-\n-        this.subscriptions = Disposables.composite(\n-            this.handler.getEndpointStates().subscribe(\n-                state -> {\n-                    logger.verbose(\"Connection state: {}\", state);\n-                    endpointStateSink.next(AmqpEndpointStateUtil.getConnectionState(state));\n-                }, error -> {\n-                    logger.error(\"connectionId[{}] linkName[{}] entityPath[{}] Error occurred in connection.\",\n-                        handler.getConnectionId(), receiver.getName(), entityPath, error);\n-                    endpointStateSink.error(error);\n-                    dispose();\n-                }, () -> {\n-                    endpointStateSink.next(AmqpEndpointState.CLOSED);\n-                    dispose();\n-                }),\n-\n-            this.handler.getErrors().subscribe(error -> {\n-                logger.error(\"connectionId[{}] linkName[{}] entityPath[{}] Error occurred in link.\",\n-                    handler.getConnectionId(), receiver.getName(), entityPath, error);\n-                endpointStateSink.error(error);\n-                dispose();\n-            }),\n-\n-            this.tokenManager.getAuthorizationResults().subscribe(\n-                response -> {\n-                    logger.verbose(\"Token refreshed: {}\", response);\n-                    hasAuthorized.set(true);\n-                }, error -> {\n-                    logger.info(\"connectionId[{}], path[{}], linkName[{}] - tokenRenewalFailure[{}]\",\n-                        handler.getConnectionId(), this.entityPath, getLinkName(), error.getMessage());\n-                    hasAuthorized.set(false);\n-                }, () -> hasAuthorized.set(false)));\n+        this.endpointStates = this.handler.getEndpointStates()\n+            .map(state -> {\n+                logger.verbose(\"connectionId[{}], path[{}], linkName[{}]: State {}\", handler.getConnectionId(),\n+                    entityPath, getLinkName(), state);\n+                return AmqpEndpointStateUtil.getConnectionState(state);\n+            })\n+            .subscribeWith(ReplayProcessor.cacheLastOrDefault(AmqpEndpointState.UNINITIALIZED));\n+\n+        this.subscriptions = this.tokenManager.getAuthorizationResults().subscribe(\n+            response -> {\n+                logger.verbose(\"Token refreshed: {}\", response);\n+                hasAuthorized.set(true);\n+            }, error -> {\n+                logger.info(\"connectionId[{}], path[{}], linkName[{}] - tokenRenewalFailure[{}]\",\n+                    handler.getConnectionId(), this.entityPath, getLinkName(), error.getMessage());\n+                hasAuthorized.set(false);\n+            }, () -> hasAuthorized.set(false));\n     }\n \n     @Override\n     public Flux<AmqpEndpointState> getEndpointStates() {\n-        return endpointStates;\n+        return endpointStates.distinct();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99b13b380fae5db73af433724a773d59c19418a3"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3OTc2Mw==", "bodyText": "should this be private or protected? We already have a dispose() that's public and implements the interface method.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r485979763", "createdAt": "2020-09-09T23:40:35Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorSender.java", "diffHunk": "@@ -293,13 +283,35 @@ public boolean isDisposed() {\n \n     @Override\n     public void dispose() {\n+        dispose(null);\n+    }\n+\n+    /**\n+     * Disposes of the sender when an exception is encountered.\n+     *\n+     * @param errorCondition Error condition associated with close operation.\n+     */\n+    public void dispose(ErrorCondition errorCondition) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99b13b380fae5db73af433724a773d59c19418a3"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MDMzMw==", "bodyText": "Empty test can be removed", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r485980333", "createdAt": "2020-09-09T23:42:29Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-amqp/src/test/java/com/azure/core/amqp/implementation/ReactorConnectionTest.java", "diffHunk": "@@ -364,7 +362,7 @@ void cannotCreateResourcesOnFailure() {\n     }\n \n     @Test\n-    void cannotCreateSessionWhenDisposed() {\n+    void closesDownstreamLinks() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99b13b380fae5db73af433724a773d59c19418a3"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "018dee59feae4a0a5dcfac86939ee5b2b22a517a", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/018dee59feae4a0a5dcfac86939ee5b2b22a517a", "committedDate": "2020-09-10T06:32:36Z", "message": "Fixing the string format for task."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f11498187747e57c71d4419ab26a0d584d7d0ed", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0f11498187747e57c71d4419ab26a0d584d7d0ed", "committedDate": "2020-09-10T06:32:36Z", "message": "Adding this. in front of AmqpRetryOptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6441c46524c157f092108cae34021e8ffef5359", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a6441c46524c157f092108cae34021e8ffef5359", "committedDate": "2020-09-10T06:32:36Z", "message": "Cleaning up print statements."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edf4c4524097d4e16917fce133f10349a07dd910", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/edf4c4524097d4e16917fce133f10349a07dd910", "committedDate": "2020-09-10T06:32:36Z", "message": "Fixing issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14afc3bf8b7a29cd0f58472a46c7fb1580bba0b6", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/14afc3bf8b7a29cd0f58472a46c7fb1580bba0b6", "committedDate": "2020-09-10T06:32:36Z", "message": "Updating text in README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c7fef467d2caa3b6cf37f19a6acf496d5f0981a", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7c7fef467d2caa3b6cf37f19a6acf496d5f0981a", "committedDate": "2020-09-10T06:32:37Z", "message": "Remove getErrors() which overlaps with getEndpointStates(). Only ouputting one terminal state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e74046c253aedb56c5ddffee99a88aa3d1fa981e", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e74046c253aedb56c5ddffee99a88aa3d1fa981e", "committedDate": "2020-09-10T06:32:37Z", "message": "Fixing test breaks from removing getErrors."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cbb292d73b9d2c00d145370ba690af6cb7e9206", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5cbb292d73b9d2c00d145370ba690af6cb7e9206", "committedDate": "2020-09-10T06:32:37Z", "message": "Clean up tests and use subscribeWith."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a73a67a18214f245dbb2b4edd9d9dd9e65cfee4b", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a73a67a18214f245dbb2b4edd9d9dd9e65cfee4b", "committedDate": "2020-09-10T06:32:37Z", "message": "Adding test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95de918b9b36a7ce899b641712970ea404684a26", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/95de918b9b36a7ce899b641712970ea404684a26", "committedDate": "2020-09-10T06:32:38Z", "message": "Adding final."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a9883b5988a12cc9b595a08571f0443f47153b9", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a9883b5988a12cc9b595a08571f0443f47153b9", "committedDate": "2020-09-10T06:32:38Z", "message": "Adding test for session"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c940d34284b77d363b7f5d1debc4204f8c852bbf", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c940d34284b77d363b7f5d1debc4204f8c852bbf", "committedDate": "2020-09-10T06:32:38Z", "message": "Using close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecd66e4ac9aee092aa2c444999cefb17462184a2", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ecd66e4ac9aee092aa2c444999cefb17462184a2", "committedDate": "2020-09-10T06:32:38Z", "message": "Updating log messages."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "773dde99aed02fd16738532b488a16dcff1c4987", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/773dde99aed02fd16738532b488a16dcff1c4987", "committedDate": "2020-09-10T06:32:38Z", "message": "Locally closing on connection error."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8aae082fb882d1e52ccbdfd5304ac3d26f9daf1", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d8aae082fb882d1e52ccbdfd5304ac3d26f9daf1", "committedDate": "2020-09-10T06:32:39Z", "message": "Fix build breaks in Service Bus."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aa1e2be0625c7b807fb51eb64f812d3fe871e64", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0aa1e2be0625c7b807fb51eb64f812d3fe871e64", "committedDate": "2020-09-10T06:32:39Z", "message": "Fix indentation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6655e2dc2f0e72977cb170ab913644e0bd2b2fe", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c6655e2dc2f0e72977cb170ab913644e0bd2b2fe", "committedDate": "2020-09-10T06:32:39Z", "message": "Adding more logging."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ecd4390eee221bbef3ce518fff198fffb57b4b3", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3ecd4390eee221bbef3ce518fff198fffb57b4b3", "committedDate": "2020-09-10T05:43:18Z", "message": "Remove unneeded retryuntils"}, "afterCommit": {"oid": "50523911364139a7320e0c440c90d3f3ac8c827d", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/50523911364139a7320e0c440c90d3f3ac8c827d", "committedDate": "2020-09-10T06:32:39Z", "message": "Removing unneeded retries."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c75c65f3c5cdc8b0364c701fbaac91b74647ca3", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7c75c65f3c5cdc8b0364c701fbaac91b74647ca3", "committedDate": "2020-09-10T06:46:00Z", "message": "Removing unneeded retries."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50523911364139a7320e0c440c90d3f3ac8c827d", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/50523911364139a7320e0c440c90d3f3ac8c827d", "committedDate": "2020-09-10T06:32:39Z", "message": "Removing unneeded retries."}, "afterCommit": {"oid": "7c75c65f3c5cdc8b0364c701fbaac91b74647ca3", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7c75c65f3c5cdc8b0364c701fbaac91b74647ca3", "committedDate": "2020-09-10T06:46:00Z", "message": "Removing unneeded retries."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df0c5e6824a69799531b357332bb41292669db1d", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/df0c5e6824a69799531b357332bb41292669db1d", "committedDate": "2020-09-10T18:30:53Z", "message": "Remove empty tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d6215d129ed04e461ac19d94f3d9ac9ed1db778", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7d6215d129ed04e461ac19d94f3d9ac9ed1db778", "committedDate": "2020-09-10T18:32:23Z", "message": "Change methods to package-private."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "874edddbcc926cb89e51c2d6730c5e70f89ff8c8", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/874edddbcc926cb89e51c2d6730c5e70f89ff8c8", "committedDate": "2020-09-10T18:36:09Z", "message": "Add changelog entry"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3541, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}