{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyNjUyODA1", "number": 15625, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMTozNzoyNlrOEnOnXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo0ODozOVrOEoLImg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTY5MzcyOnYy", "diffSide": "RIGHT", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/BlobAsyncClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMTozNzoyNlrOHXtiDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMTozNzoyNlrOHXtiDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyNTI5NQ==", "bodyText": "This is the only part of the code that I'm iffy about. Like wrapping the ProgressReporter and stuff looks a little unclean. I could just make a method maybe and make it look a little better.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15625#discussion_r494625295", "createdAt": "2020-09-24T21:37:26Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/BlobAsyncClient.java", "diffHunk": "@@ -429,14 +429,16 @@ private SpecializedBlobClientBuilder prepareBuilder() {\n             Function<Flux<ByteBuffer>, Mono<Response<BlockBlobItem>>> uploadInChunksFunction = (stream) ->\n                 uploadInChunks(blockBlobAsyncClient, stream, validatedParallelTransferOptions,\n                     options.getHeaders(), options.getMetadata(), options.getTags(),\n-                    options.getTier(), validatedRequestConditions);\n+                    options.getTier(), validatedRequestConditions, options.isComputeMd5());\n \n             BiFunction<Flux<ByteBuffer>, Long, Mono<Response<BlockBlobItem>>> uploadFullBlobMethod =\n-                (stream, length) -> blockBlobAsyncClient.uploadWithResponse(new BlockBlobSimpleUploadOptions(\n-                    ProgressReporter.addProgressReporting(stream,\n-                        validatedParallelTransferOptions.getProgressReceiver()), length)\n+                (stream, length) -> UploadUtils.computeMd5(ProgressReporter.addProgressReporting(stream,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73c8a6c48530eca0336fd32a55471f200c41dc07"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTkwOTYyOnYy", "diffSide": "RIGHT", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/options/BlobParallelUploadOptions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMzowNjowMFrOHXvgrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMzowNjowMFrOHXvgrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY1NzcwOA==", "bodyText": "Rename to computeMd5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15625#discussion_r494657708", "createdAt": "2020-09-24T23:06:00Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/options/BlobParallelUploadOptions.java", "diffHunk": "@@ -214,6 +215,25 @@ public BlobParallelUploadOptions setRequestConditions(BlobRequestConditions requ\n         return this;\n     }\n \n+    /**\n+     * @return Whether or not the library should calculate the md5 and send it for the service to verify.\n+     */\n+    public boolean isComputeMd5() {\n+        return computeMd5;\n+    }\n+\n+    /**\n+     * Sets the calculateAndVerifyMd5 property.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d900dec3e1756e0e34865ff1705db20da22699b"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5OTE5MDc4OnYy", "diffSide": "RIGHT", "path": "sdk/storage/azure-storage-common/src/test/java/com/azure/storage/common/implementation/UploadUtilsTest.groovy", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxODozMToyNFrOHYOWiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxODozMToyNFrOHYOWiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE2MzAxOQ==", "bodyText": "Add comment that this test is for data integrity", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15625#discussion_r495163019", "createdAt": "2020-09-25T18:31:24Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-common/src/test/java/com/azure/storage/common/implementation/UploadUtilsTest.groovy", "diffHunk": "@@ -0,0 +1,85 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.common.implementation\n+\n+import com.azure.core.util.FluxUtil\n+import com.azure.core.util.logging.ClientLogger\n+import reactor.core.publisher.Flux\n+import reactor.test.StepVerifier\n+import spock.lang.Specification\n+import spock.lang.Unroll\n+\n+import java.nio.ByteBuffer\n+import java.security.MessageDigest\n+\n+class UploadUtilsTest extends Specification {\n+\n+    @Unroll\n+    def \"computeMd5 md5\"() {\n+        setup:\n+        def md5 = MessageDigest.getInstance(\"MD5\").digest(\"Hello World!\".getBytes())\n+        def flux = Flux.fromIterable(data.stream().map({ str -> ByteBuffer.wrap(str.getBytes())}) as Iterable<ByteBuffer>)\n+\n+        when: \"computeMd5 = true\"\n+        def sv = StepVerifier.create(UploadUtils.computeMd5(flux, true, new ClientLogger(UploadUtilsTest.class)))\n+\n+        then:\n+        sv.expectNextMatches({ w -> w.getMd5() == md5 })\n+            .expectComplete()\n+\n+        when: \"computeMd5 = false\"\n+        sv = StepVerifier.create(UploadUtils.computeMd5(flux, false, new ClientLogger(UploadUtilsTest.class)))\n+\n+        then:\n+        sv.expectNextMatches({ w -> w.getMd5() == null })\n+            .expectComplete()\n+\n+        where:\n+        data             || _\n+        [\"Hello World!\"] || _\n+        [\"Hello \", \"World!\"] || _\n+        [\"H\", \"e\", \"l\", \"l\", \"o\", \" \", \"W\", \"o\", \"r\", \"l\", \"d\", \"!\"] || _\n+        [\"Hel\", \"lo World!\"] || _\n+    }\n+\n+    @Unroll\n+    def \"computeMd5 data\"() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d900dec3e1756e0e34865ff1705db20da22699b"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTYwOTIyOnYy", "diffSide": "RIGHT", "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/UploadUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo0ODozOVrOHZHHcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjo1NTozM1rOHZHW8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5MzA0Mg==", "bodyText": "CoreUtils.clone should handle this.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15625#discussion_r496093042", "createdAt": "2020-09-28T16:48:39Z", "author": {"login": "alzimmermsft"}, "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/UploadUtils.java", "diffHunk": "@@ -142,4 +147,48 @@ public static void uploadFileCleanup(AsynchronousFileChannel channel, ClientLogg\n             throw logger.logExceptionAsError(new UncheckedIOException(e));\n         }\n     }\n+\n+    /**\n+     * Computes the md5 of the data and wraps it with the data.\n+     *\n+     * @param data The data.\n+     * @param computeMd5 Whether or not to compute the md5.\n+     * @param logger Logger to log errors.\n+     * @return The data wrapped with its md5.\n+     */\n+    public static Mono<FluxMd5Wrapper> computeMd5(Flux<ByteBuffer> data, boolean computeMd5, ClientLogger logger) {\n+        if (computeMd5) {\n+            try {\n+                return data.reduce(MessageDigest.getInstance(\"MD5\"), (digest, buffer) -> {\n+                    int position = buffer.position();\n+                    byte[] bytes = FluxUtil.byteBufferToArray(buffer);\n+                    digest.update(bytes, 0, bytes.length);\n+                    buffer.position(position);\n+                    return digest;\n+                }).map(messageDigest -> new FluxMd5Wrapper(data, messageDigest.digest()));\n+            } catch (NoSuchAlgorithmException e) {\n+                return monoError(logger, new RuntimeException(e));\n+            }\n+        } else {\n+            return Mono.just(new FluxMd5Wrapper(data, null));\n+        }\n+    }\n+\n+    public static class FluxMd5Wrapper {\n+        private final Flux<ByteBuffer> data;\n+        private final byte[] md5;\n+\n+        FluxMd5Wrapper(Flux<ByteBuffer> data, byte[] md5) {\n+            this.data = data;\n+            this.md5 = md5 == null ? null : md5.clone();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a549baa45dc9acaec88bc548bf464d8387beddf"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5NzAxMA==", "bodyText": "fixed.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15625#discussion_r496097010", "createdAt": "2020-09-28T16:55:33Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-common/src/main/java/com/azure/storage/common/implementation/UploadUtils.java", "diffHunk": "@@ -142,4 +147,48 @@ public static void uploadFileCleanup(AsynchronousFileChannel channel, ClientLogg\n             throw logger.logExceptionAsError(new UncheckedIOException(e));\n         }\n     }\n+\n+    /**\n+     * Computes the md5 of the data and wraps it with the data.\n+     *\n+     * @param data The data.\n+     * @param computeMd5 Whether or not to compute the md5.\n+     * @param logger Logger to log errors.\n+     * @return The data wrapped with its md5.\n+     */\n+    public static Mono<FluxMd5Wrapper> computeMd5(Flux<ByteBuffer> data, boolean computeMd5, ClientLogger logger) {\n+        if (computeMd5) {\n+            try {\n+                return data.reduce(MessageDigest.getInstance(\"MD5\"), (digest, buffer) -> {\n+                    int position = buffer.position();\n+                    byte[] bytes = FluxUtil.byteBufferToArray(buffer);\n+                    digest.update(bytes, 0, bytes.length);\n+                    buffer.position(position);\n+                    return digest;\n+                }).map(messageDigest -> new FluxMd5Wrapper(data, messageDigest.digest()));\n+            } catch (NoSuchAlgorithmException e) {\n+                return monoError(logger, new RuntimeException(e));\n+            }\n+        } else {\n+            return Mono.just(new FluxMd5Wrapper(data, null));\n+        }\n+    }\n+\n+    public static class FluxMd5Wrapper {\n+        private final Flux<ByteBuffer> data;\n+        private final byte[] md5;\n+\n+        FluxMd5Wrapper(Flux<ByteBuffer> data, byte[] md5) {\n+            this.data = data;\n+            this.md5 = md5 == null ? null : md5.clone();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5MzA0Mg=="}, "originalCommit": {"oid": "2a549baa45dc9acaec88bc548bf464d8387beddf"}, "originalPosition": 59}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 866, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}