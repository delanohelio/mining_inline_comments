{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxOTE2MDgy", "number": 15561, "title": "Add SNI support in Identity SDK", "bodyText": "Updates MSAL4J dependency to 1.7.1.\nAccommodates the TenantProfiles added to IAccount in MSAL4J.\nAdds Chained Certificate support to ClientCertificateCredential.\nAdds option for user to configure sending x5c on ClientCertificateCredentialBuilder\nFixes #10370", "createdAt": "2020-09-23T16:58:31Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561", "merged": true, "mergeCommit": {"oid": "484387196e35272cbda54c111599fa26d0db59a9"}, "closed": true, "closedAt": "2020-10-02T21:54:26Z", "author": {"login": "g2vinay"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLvhgIAH2gAyNDkxOTE2MDgyOjA0NmFmM2UwNGM2N2JmODIxOTM0YWQ3MjcyYmMwNzc5Yjk4MjgxYTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOsQ8HAH2gAyNDkxOTE2MDgyOjdlYTZkYmQ0OGQwZDQxZDY2YzM3MGNkMzVhY2VhNGE3NTdkZDJhYTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "046af3e04c67bf821934ad7272bc0779b98281a9", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/046af3e04c67bf821934ad7272bc0779b98281a9", "committedDate": "2020-09-23T16:52:32Z", "message": "update MSAL + add cert chain support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50f5671041585629e746c19b1285b5fd6027b0bc", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/50f5671041585629e746c19b1285b5fd6027b0bc", "committedDate": "2020-09-23T17:02:52Z", "message": "update cert resource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODc1OTEw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#pullrequestreview-494875910", "createdAt": "2020-09-23T17:12:50Z", "commit": {"oid": "046af3e04c67bf821934ad7272bc0779b98281a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzoxMjo1MFrOHW4fYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzoxMjo1MFrOHW4fYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc1NjI1Ng==", "bodyText": "NOTE: I'll update the external_dep file before merging, as that will impact other libraries using MSAL too.\nCurrently, the scope of review is kept till Identity only.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#discussion_r493756256", "createdAt": "2020-09-23T17:12:50Z", "author": {"login": "g2vinay"}, "path": "sdk/identity/azure-identity/pom.xml", "diffHunk": "@@ -32,7 +32,7 @@\n     <dependency>\n       <groupId>com.microsoft.azure</groupId>\n       <artifactId>msal4j</artifactId>\n-      <version>1.6.2</version> <!-- {x-version-update;com.microsoft.azure:msal4j;external_dependency} -->\n+      <version>1.7.0</version> <!-- {x-version-update;com.microsoft.azure:msal4j;external_dependency} -->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "046af3e04c67bf821934ad7272bc0779b98281a9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0ebb7e08de74a0d90f52e195a86fa4d58458556", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e0ebb7e08de74a0d90f52e195a86fa4d58458556", "committedDate": "2020-09-23T17:53:11Z", "message": "add logging to exceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTE2NDg3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#pullrequestreview-495116487", "createdAt": "2020-09-23T23:23:49Z", "commit": {"oid": "e0ebb7e08de74a0d90f52e195a86fa4d58458556"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTI5NTQx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#pullrequestreview-495129541", "createdAt": "2020-09-23T23:47:19Z", "commit": {"oid": "e0ebb7e08de74a0d90f52e195a86fa4d58458556"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzo0NzoxOVrOHXEy0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzo0OToyOFrOHXE4LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1Nzg0Mg==", "bodyText": "nit: The formatting looks a bit odd. Probably moving the instantiation of AuthenticationRecord outside of set() would make it more readable too.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#discussion_r493957842", "createdAt": "2020-09-23T23:47:19Z", "author": {"login": "srnagar"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/InteractiveBrowserCredential.java", "diffHunk": "@@ -119,8 +119,9 @@\n     private AccessToken updateCache(MsalToken msalToken) {\n         cachedToken.set(\n                 new MsalAuthenticationAccount(\n-                        new AuthenticationRecord(msalToken.getAuthenticationResult(),\n-                                identityClient.getTenantId(), identityClient.getClientId())));\n+                    new AuthenticationRecord(msalToken.getAuthenticationResult(),\n+                                identityClient.getTenantId(), identityClient.getClientId()),\n+                    msalToken.getAccount().getTenantProfiles()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0ebb7e08de74a0d90f52e195a86fa4d58458556"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1ODU5NA==", "bodyText": "Do we need to special-case this for a list with size 1? Can createFromCertificateChain handle a list that has just 1 entry?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#discussion_r493958594", "createdAt": "2020-09-23T23:48:37Z", "author": {"login": "srnagar"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -172,9 +174,15 @@ private ConfidentialClientApplication getConfidentialClientApplication() {\n                 if (certificatePassword == null) {\n                     byte[] pemCertificateBytes = Files.readAllBytes(Paths.get(certificatePath));\n \n-                    credential = ClientCredentialFactory.createFromCertificate(\n-                        CertificateUtil.privateKeyFromPem(pemCertificateBytes),\n-                        CertificateUtil.publicKeyFromPem(pemCertificateBytes));\n+                    List<X509Certificate> x509CertificateList =  CertificateUtil.publicKeyFromPem(pemCertificateBytes);\n+                    PrivateKey privateKey = CertificateUtil.privateKeyFromPem(pemCertificateBytes);\n+                    if (x509CertificateList.size() == 1) {\n+                        credential = ClientCredentialFactory.createFromCertificate(\n+                            privateKey, x509CertificateList.get(0));\n+                    } else {\n+                        credential = ClientCredentialFactory.createFromCertificateChain(\n+                            privateKey, x509CertificateList);\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0ebb7e08de74a0d90f52e195a86fa4d58458556"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1OTIxMg==", "bodyText": "Pattern compilation is expensive. So, maybe it's good to just make this pattern into a static final constant.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#discussion_r493959212", "createdAt": "2020-09-23T23:49:28Z", "author": {"login": "srnagar"}, "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/util/CertificateUtil.java", "diffHunk": "@@ -54,24 +56,31 @@ public static PrivateKey privateKeyFromPem(byte[] pem) {\n     }\n \n     /**\n-     * Extracts the X509Certificate certificate from a PEM certificate.\n+     * Extracts the X509Certificate certificate/certificate-chain from a PEM certificate.\n      * @param pem the contents of a PEM certificate.\n-     * @return the X509Certificate certificate\n+     * @return the {@link List} of X509Certificate certificate\n      */\n-    public static X509Certificate publicKeyFromPem(byte[] pem) {\n-        Pattern pattern = Pattern.compile(\"(?s)-----BEGIN CERTIFICATE-----.*-----END CERTIFICATE-----\");\n+    public static List<X509Certificate> publicKeyFromPem(byte[] pem) {\n+        Pattern pattern = Pattern.compile(\"(?s)-----BEGIN CERTIFICATE-----.*?-----END CERTIFICATE-----\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0ebb7e08de74a0d90f52e195a86fa4d58458556"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3e98d2f557d1317281655c3892fb5c99074f8e0", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a3e98d2f557d1317281655c3892fb5c99074f8e0", "committedDate": "2020-09-29T17:20:51Z", "message": "Merge remote-tracking branch 'upstream/master' into add-chained-cert-support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8a743d176f2778375d825dd31e4616c9f4160a1", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f8a743d176f2778375d825dd31e4616c9f4160a1", "committedDate": "2020-09-29T19:50:35Z", "message": "update MSAL + add x5c configurability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ef297f321820e6436fbc3d4a51b55a6b21877a8", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8ef297f321820e6436fbc3d4a51b55a6b21877a8", "committedDate": "2020-09-29T19:54:56Z", "message": "update details"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70e90f4780dc792659790ba08f0db5c8682898e4", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/70e90f4780dc792659790ba08f0db5c8682898e4", "committedDate": "2020-09-29T21:08:13Z", "message": "update javadocs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4OTM1NjE4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15561#pullrequestreview-498935618", "createdAt": "2020-09-29T22:18:16Z", "commit": {"oid": "70e90f4780dc792659790ba08f0db5c8682898e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ea6dbd48d0d41d66c370cd35acea4a757dd2aa1", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7ea6dbd48d0d41d66c370cd35acea4a757dd2aa1", "committedDate": "2020-10-02T20:46:30Z", "message": "update pom file"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3268, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}