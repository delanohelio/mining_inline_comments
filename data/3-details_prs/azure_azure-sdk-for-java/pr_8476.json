{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NzY2ODkz", "number": 8476, "title": "Fixing OkHttp Async Client early stream closing", "bodyText": "Addressing #8183\nThe stream get closed by Mono.using() as soon as ResponseBody is emitted.\nThe ResponseBody instance hold the content stream, we want to wait for the entire emission of content stream to complete to close the stream.", "createdAt": "2020-02-25T19:46:45Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8476", "merged": true, "mergeCommit": {"oid": "c4421df324aa9ba956bfac1d338fd41446b432f6"}, "closed": true, "closedAt": "2020-03-24T22:30:04Z", "author": {"login": "anuchandy"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcH39LMgBqjMwNzA4NDcxMzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ59f_AH2gAyMzc5NzY2ODkzOjc4MDEwNTJjZDAwMWFhMzY2OWU4MzdmZDZhNzNjNzVjYzI4MWRmOTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4f5ad3be81e0c5c85af081ddcbdc6012fdc9d48", "author": {"user": {"login": "anuchandy", "name": "Anu Thomas Chandy"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f4f5ad3be81e0c5c85af081ddcbdc6012fdc9d48", "committedDate": "2020-02-25T19:44:20Z", "message": "Fixing OkHttp Async Client early stream closing"}, "afterCommit": {"oid": "9db1f40c282ef85ad98b7c2c6fcf70f40239850a", "author": {"user": {"login": "anuchandy", "name": "Anu Thomas Chandy"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9db1f40c282ef85ad98b7c2c6fcf70f40239850a", "committedDate": "2020-02-25T20:14:51Z", "message": "Fixing OkHttp Async Client early stream closing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NDI1MjI1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8476#pullrequestreview-364425225", "createdAt": "2020-02-25T20:28:33Z", "commit": {"oid": "9db1f40c282ef85ad98b7c2c6fcf70f40239850a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDoyODozM1rOFuUG1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDoyODozM1rOFuUG1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEwODI0Ng==", "bodyText": "Do we still need the null check for mocking (a) and cacheResponse, networkResponse etc (b)?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8476#discussion_r384108246", "createdAt": "2020-02-25T20:28:33Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-http-okhttp/src/main/java/com/azure/core/http/okhttp/OkHttpAsyncHttpClient.java", "diffHunk": "@@ -178,29 +178,21 @@ public void onResponse(okhttp3.Call call, okhttp3.Response response) {\n     private static class OkHttpResponse extends HttpResponse {\n         private final int statusCode;\n         private final HttpHeaders headers;\n-        private final Mono<ResponseBody> responseBodyMono;\n+        private final ResponseBody responseBody;\n         // using 4K as default buffer size: https://stackoverflow.com/a/237495/1473510\n         private static final int BYTE_BUFFER_CHUNK_SIZE = 4096;\n \n         OkHttpResponse(Response innerResponse, HttpRequest request) {\n             super(request);\n             this.statusCode = innerResponse.code();\n             this.headers = fromOkHttpHeaders(innerResponse.headers());\n-            if (innerResponse.body() == null) {\n-                // innerResponse.body() getter will not return null for server returned responses.\n-                // It can be null:\n-                // [a]. if response is built manually with null body (e.g for mocking)\n-                // [b]. for the cases described here\n-                // [ref](https://square.github.io/okhttp/4.x/okhttp/okhttp3/-response/body/).\n-                //\n-                this.responseBodyMono = Mono.empty();\n-            } else {\n-                this.responseBodyMono = Mono.using(innerResponse::body,\n-                    Mono::just,\n-                    // Resource cleanup\n-                    // square.github.io/okhttp/4.x/okhttp/okhttp3/-response-body/#the-response-body-must-be-closed\n-                    ResponseBody::close, /* Change in behavior since reactor-core 3.3.0.RELEASE */ false);\n-            }\n+            // innerResponse.body() getter will not return null for server returned responses.\n+            // It can be null:\n+            // [a]. if response is built manually with null body (e.g for mocking)\n+            // [b]. for the cases described here\n+            // [ref](https://square.github.io/okhttp/4.x/okhttp/okhttp3/-response/body/).\n+            //\n+            this.responseBody = innerResponse.body();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db1f40c282ef85ad98b7c2c6fcf70f40239850a"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NDQ0MjU0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8476#pullrequestreview-364444254", "createdAt": "2020-02-25T21:00:57Z", "commit": {"oid": "9db1f40c282ef85ad98b7c2c6fcf70f40239850a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NDUwNTE0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8476#pullrequestreview-364450514", "createdAt": "2020-02-25T21:11:17Z", "commit": {"oid": "9db1f40c282ef85ad98b7c2c6fcf70f40239850a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9db1f40c282ef85ad98b7c2c6fcf70f40239850a", "author": {"user": {"login": "anuchandy", "name": "Anu Thomas Chandy"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9db1f40c282ef85ad98b7c2c6fcf70f40239850a", "committedDate": "2020-02-25T20:14:51Z", "message": "Fixing OkHttp Async Client early stream closing"}, "afterCommit": {"oid": "d2b4ff9e16b0dc79671bf9566f39de5abc342e11", "author": {"user": {"login": "anuchandy", "name": "Anu Thomas Chandy"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d2b4ff9e16b0dc79671bf9566f39de5abc342e11", "committedDate": "2020-02-25T22:11:02Z", "message": "Fixing OkHttp Async Client early stream closing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1097ddf5f30abd632822cb35dcd89aa2920e631", "author": {"user": {"login": "anuchandy", "name": "Anu Thomas Chandy"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d1097ddf5f30abd632822cb35dcd89aa2920e631", "committedDate": "2020-02-25T23:19:13Z", "message": "Fixing OkHttp Async Client early stream closing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2b4ff9e16b0dc79671bf9566f39de5abc342e11", "author": {"user": {"login": "anuchandy", "name": "Anu Thomas Chandy"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d2b4ff9e16b0dc79671bf9566f39de5abc342e11", "committedDate": "2020-02-25T22:11:02Z", "message": "Fixing OkHttp Async Client early stream closing"}, "afterCommit": {"oid": "d1097ddf5f30abd632822cb35dcd89aa2920e631", "author": {"user": {"login": "anuchandy", "name": "Anu Thomas Chandy"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d1097ddf5f30abd632822cb35dcd89aa2920e631", "committedDate": "2020-02-25T23:19:13Z", "message": "Fixing OkHttp Async Client early stream closing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8efd396da7150fd8dff699ce492f095eefcb1c9", "author": {"user": {"login": "anuchandy", "name": "Anu Thomas Chandy"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e8efd396da7150fd8dff699ce492f095eefcb1c9", "committedDate": "2020-03-24T21:17:14Z", "message": "sync upstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7801052cd001aa3669e837fd6a73c75cc281df91", "author": {"user": {"login": "anuchandy", "name": "Anu Thomas Chandy"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7801052cd001aa3669e837fd6a73c75cc281df91", "committedDate": "2020-03-24T21:40:38Z", "message": "use regex based spotbug pattern for okhttp PZLA_PREFER_ZERO_LENGTH_ARRAYS"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1025, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}