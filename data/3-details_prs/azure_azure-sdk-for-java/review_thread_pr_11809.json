{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MjE5NDg2", "number": 11809, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNDo1MDo1OVrOEC0Qvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODowNTozMVrOEC25Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxMzg4ODYzOnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-management/src/test/java/com/azure/core/management/implementation/polling/LROPollerTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNDo1MDo1OVrOGfgURw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNDo1MDo1OVrOGfgURw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4ODUxOQ==", "bodyText": "In test case, set Retry-After header to different value of default poll interval.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11809#discussion_r435688519", "createdAt": "2020-06-05T04:50:59Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/core/azure-core-management/src/test/java/com/azure/core/management/implementation/polling/LROPollerTests.java", "diffHunk": "@@ -324,6 +274,102 @@ public String getName() {\n         }\n     }\n \n+    @Test\n+    public void lroRetryAfter() {\n+        ServerConfigure configure = new ServerConfigure();\n+        Duration expectedPollingDuration = Duration.ofSeconds(3);\n+        configure.pollingCountTillSuccess = 3;\n+        configure.additionalHeaders = new HttpHeaders(new HttpHeader(\"Retry-After\", \"1\"));  // 1 second", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "838bd77906145cd6f59f53fd6a8449439dc4d960"}, "originalPosition": 168}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDAzMTQxOnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-management/src/test/java/com/azure/core/management/implementation/polling/LROPollerTests.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNjoxNjo1NVrOGfhrLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNjoyMTo1MlrOGfhxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTcxMDc2NA==", "bodyText": "If we just check polling duration larger than expected. I think we could make Retry-After larger than the original one.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11809#discussion_r435710764", "createdAt": "2020-06-05T06:16:55Z", "author": {"login": "ChenTanyi"}, "path": "sdk/core/azure-core-management/src/test/java/com/azure/core/management/implementation/polling/LROPollerTests.java", "diffHunk": "@@ -324,6 +276,107 @@ public String getName() {\n         }\n     }\n \n+    @Test\n+    public void lroRetryAfter() {\n+        ServerConfigure configure = new ServerConfigure();\n+        Duration expectedPollingDuration = Duration.ofSeconds(3);\n+        configure.pollingCountTillSuccess = 3;\n+        configure.additionalHeaders = new HttpHeaders(new HttpHeader(\"Retry-After\", \"1\"));  // 1 second\n+        WireMockServer lroServer = startServer(configure);\n+        lroServer.start();\n+\n+        try {\n+            final ProvisioningStateLroServiceClient client = RestProxy.create(ProvisioningStateLroServiceClient.class,\n+                createHttpPipeline(lroServer.port()),\n+                SERIALIZER);\n+\n+            PollerFlux<PollResult<FooWithProvisioningState>, FooWithProvisioningState> lroFlux\n+                = PollerFactory.create(SERIALIZER,\n+                new HttpPipelineBuilder().build(),\n+                FooWithProvisioningState.class,\n+                FooWithProvisioningState.class,\n+                POLLING_DURATION,\n+                newLroInitFunction(client, FooWithProvisioningState.class));\n+\n+            long nanoTime = System.nanoTime();\n+\n+            FooWithProvisioningState result = lroFlux\n+                .doOnNext(response -> {\n+                    System.out.println(String.format(\"[%s] status %s\",\n+                        OffsetDateTime.now().toString(), response.getStatus().toString()));\n+                }).blockLast()\n+                .getFinalResult().block();\n+            Assertions.assertNotNull(result);\n+\n+            Duration pollingDuration = Duration.ofNanos(System.nanoTime() - nanoTime);\n+            Assertions.assertTrue(pollingDuration.compareTo(expectedPollingDuration) > 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4afd944de07b91c1f83944722064747d2979a59"}, "originalPosition": 201}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTcxMTk0NA==", "bodyText": "Yes. In this test, Retry-After is 1sec, default interval is 100ms.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11809#discussion_r435711944", "createdAt": "2020-06-05T06:20:41Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/core/azure-core-management/src/test/java/com/azure/core/management/implementation/polling/LROPollerTests.java", "diffHunk": "@@ -324,6 +276,107 @@ public String getName() {\n         }\n     }\n \n+    @Test\n+    public void lroRetryAfter() {\n+        ServerConfigure configure = new ServerConfigure();\n+        Duration expectedPollingDuration = Duration.ofSeconds(3);\n+        configure.pollingCountTillSuccess = 3;\n+        configure.additionalHeaders = new HttpHeaders(new HttpHeader(\"Retry-After\", \"1\"));  // 1 second\n+        WireMockServer lroServer = startServer(configure);\n+        lroServer.start();\n+\n+        try {\n+            final ProvisioningStateLroServiceClient client = RestProxy.create(ProvisioningStateLroServiceClient.class,\n+                createHttpPipeline(lroServer.port()),\n+                SERIALIZER);\n+\n+            PollerFlux<PollResult<FooWithProvisioningState>, FooWithProvisioningState> lroFlux\n+                = PollerFactory.create(SERIALIZER,\n+                new HttpPipelineBuilder().build(),\n+                FooWithProvisioningState.class,\n+                FooWithProvisioningState.class,\n+                POLLING_DURATION,\n+                newLroInitFunction(client, FooWithProvisioningState.class));\n+\n+            long nanoTime = System.nanoTime();\n+\n+            FooWithProvisioningState result = lroFlux\n+                .doOnNext(response -> {\n+                    System.out.println(String.format(\"[%s] status %s\",\n+                        OffsetDateTime.now().toString(), response.getStatus().toString()));\n+                }).blockLast()\n+                .getFinalResult().block();\n+            Assertions.assertNotNull(result);\n+\n+            Duration pollingDuration = Duration.ofNanos(System.nanoTime() - nanoTime);\n+            Assertions.assertTrue(pollingDuration.compareTo(expectedPollingDuration) > 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTcxMDc2NA=="}, "originalCommit": {"oid": "f4afd944de07b91c1f83944722064747d2979a59"}, "originalPosition": 201}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTcxMjMwNQ==", "bodyText": "Got it. I had thought it was 30s.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11809#discussion_r435712305", "createdAt": "2020-06-05T06:21:52Z", "author": {"login": "ChenTanyi"}, "path": "sdk/core/azure-core-management/src/test/java/com/azure/core/management/implementation/polling/LROPollerTests.java", "diffHunk": "@@ -324,6 +276,107 @@ public String getName() {\n         }\n     }\n \n+    @Test\n+    public void lroRetryAfter() {\n+        ServerConfigure configure = new ServerConfigure();\n+        Duration expectedPollingDuration = Duration.ofSeconds(3);\n+        configure.pollingCountTillSuccess = 3;\n+        configure.additionalHeaders = new HttpHeaders(new HttpHeader(\"Retry-After\", \"1\"));  // 1 second\n+        WireMockServer lroServer = startServer(configure);\n+        lroServer.start();\n+\n+        try {\n+            final ProvisioningStateLroServiceClient client = RestProxy.create(ProvisioningStateLroServiceClient.class,\n+                createHttpPipeline(lroServer.port()),\n+                SERIALIZER);\n+\n+            PollerFlux<PollResult<FooWithProvisioningState>, FooWithProvisioningState> lroFlux\n+                = PollerFactory.create(SERIALIZER,\n+                new HttpPipelineBuilder().build(),\n+                FooWithProvisioningState.class,\n+                FooWithProvisioningState.class,\n+                POLLING_DURATION,\n+                newLroInitFunction(client, FooWithProvisioningState.class));\n+\n+            long nanoTime = System.nanoTime();\n+\n+            FooWithProvisioningState result = lroFlux\n+                .doOnNext(response -> {\n+                    System.out.println(String.format(\"[%s] status %s\",\n+                        OffsetDateTime.now().toString(), response.getStatus().toString()));\n+                }).blockLast()\n+                .getFinalResult().block();\n+            Assertions.assertNotNull(result);\n+\n+            Duration pollingDuration = Duration.ofNanos(System.nanoTime() - nanoTime);\n+            Assertions.assertTrue(pollingDuration.compareTo(expectedPollingDuration) > 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTcxMDc2NA=="}, "originalCommit": {"oid": "f4afd944de07b91c1f83944722064747d2979a59"}, "originalPosition": 201}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDMxOTUxOnYy", "diffSide": "LEFT", "path": "sdk/core/azure-core-management/src/main/java/com/azure/core/management/implementation/polling/PollOperation.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODowNTozMVrOGfkeuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODowNTozMVrOGfkeuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc1NjczMQ==", "bodyText": "Here is the bug. Previously, after doSinglePoll, the previous pollResponse is returned. Should use the latest one after doSinglePoll.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11809#discussion_r435756731", "createdAt": "2020-06-05T08:05:31Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/core/azure-core-management/src/main/java/com/azure/core/management/implementation/polling/PollOperation.java", "diffHunk": "@@ -45,35 +46,14 @@\n         return context -> {\n             PollingState pollingState = PollingState.from(serializerAdapter, context);\n             if (pollingState.getOperationStatus().isComplete()) {\n-                if (pollingState.getOperationStatus() == LongRunningOperationStatus.FAILED\n-                    || pollingState.getOperationStatus() == LRO_CANCELLED) {\n-                    // Failed|Cancelled\n-                    Error lroInitError = pollingState.getSynchronouslyFailedLroError();\n-                    if (lroInitError != null) {\n-                        return errorPollResponseMono(pollingState.getOperationStatus(), lroInitError);\n-                    }\n-                    Error pollError = pollingState.getPollError();\n-                    if (pollError != null) {\n-                        return errorPollResponseMono(pollingState.getOperationStatus(), pollError);\n-                    }\n-                    throw new IllegalStateException(\"Either LroError or PollError must\"\n-                        + \"be set when OperationStatus is in Failed|Cancelled State.\");\n-                } else {\n-                    // Succeeded\n-                    return pollResponseMono(serializerAdapter,\n-                        pollingState.getOperationStatus(),\n-                        pollingState.getLastResponseBody(),\n-                        pollResultType);\n-                }\n+                return pollResponseMonoFromPollingState(serializerAdapter, pollResultType, pollingState);\n             } else {\n                 // InProgress|NonTerminal-Status\n-                Mono<PollResponse<PollResult<T>>> pollResponse = pollResponseMono(serializerAdapter,\n-                    pollingState.getOperationStatus(),\n-                    pollingState.getLastResponseBody(),\n-                    pollResultType);\n                 return doSinglePoll(pipeline, pollingState)\n-                    .doOnNext(updatedState -> updatedState.store(context))\n-                    .then(pollResponse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ef54296b742072bd7cd5f98b9da9006bd133da7"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3990, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}