{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4NzY3MjU5", "number": 17454, "title": "[Service Bus] Client validation improvements for cross-language consistency", "bodyText": "Adding in additional client-side validation and unit tests.\nFixes #17364", "createdAt": "2020-11-10T21:13:04Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454", "merged": true, "mergeCommit": {"oid": "37137eb9fd5ef91142b0a0eb0f03f646c36062fb"}, "closed": true, "closedAt": "2020-11-11T06:45:16Z", "author": {"login": "richardpark-msft"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda8wgSgH2gAyNTE4NzY3MjU5OmVjOGY2NmFlYjIzYmZlMTc1MTcwM2NjOGU0NGVkYzVjM2E1Y2MyMjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbXDG0AFqTUyNzg3MDc5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ec8f66aeb23bfe1751703cc8e44edc5c3a5cc220", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ec8f66aeb23bfe1751703cc8e44edc5c3a5cc220", "committedDate": "2020-11-09T22:46:33Z", "message": "Adding in error message to explicitly check for a lock token and throw if it's null (catches people accidentally trying to complete peeked messages)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfe7dcbabb7957d4f5eb590e1510f3370a2719f6", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/cfe7dcbabb7957d4f5eb590e1510f3370a2719f6", "committedDate": "2020-11-10T00:17:41Z", "message": "* Throw if the user passes in a null sequence of messages when calling receiveDeferredMessages().\n* Return an empty Flux if the user passes an empty list of deferred messages."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "897069857ba0688216986e035b27c2681cb4a807", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/897069857ba0688216986e035b27c2681cb4a807", "committedDate": "2020-11-10T01:21:46Z", "message": "* Check the length of the session ID, partitionKey, and message ID to make sure they don't exceed 128 characters (when they do it causes general validation on the service bus side to fail and it's not helpful to pinpoint _why_)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1710154ea37719abe8a62e42d9df8b750bab2771", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1710154ea37719abe8a62e42d9df8b750bab2771", "committedDate": "2020-11-10T01:41:38Z", "message": "* Add in checks if the user accidentally tries to set different values for session ID and partition key."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bcb0e31443492b0c400d73633ed554e8570c404", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5bcb0e31443492b0c400d73633ed554e8570c404", "committedDate": "2020-11-10T01:52:03Z", "message": "Make the message consistent with .net"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "709bbbb9297a38ca4c75ed3a5c8b47fe11b5665d", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/709bbbb9297a38ca4c75ed3a5c8b47fe11b5665d", "committedDate": "2020-11-10T19:12:32Z", "message": "* Adding in tests for ServiceBusMessage checks\n* (Fixing a few stray comments that said \"Act\" when they probably meant \"Arrange\")"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbbe8cee77039c2d5a3de348c228fef63d3d690b", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/dbbe8cee77039c2d5a3de348c228fef63d3d690b", "committedDate": "2020-11-10T19:46:41Z", "message": "* Adding tests to validate changes to getDeferredMessages()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a19c91e135488f5b4e7b8318acb38fbc27ec4e89", "committedDate": "2020-11-10T21:07:29Z", "message": "* Fixing problem where I was throwing the exception directly rather than returning it through the Flux.\n* Adding in test to make sure we throw a reasonable error when the user tries to complete a peeked message."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NjIyNjQz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#pullrequestreview-527622643", "createdAt": "2020-11-10T21:29:56Z", "commit": {"oid": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMToyOTo1NlrOHwwVvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMToyOTo1NlrOHwwVvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NTY5Mg==", "bodyText": "Since you are adding validation, I would add a @throws to say what runtime exceptions are thrown.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520885692", "createdAt": "2020-11-10T21:29:56Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusMessage.java", "diffHunk": "@@ -267,6 +271,7 @@ public String getMessageId() {\n      * @return The updated {@link ServiceBusMessage}.\n      */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a21748afd6bcf3b0fe4acdf309739cc431146b1", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a21748afd6bcf3b0fe4acdf309739cc431146b1", "committedDate": "2020-11-10T22:31:57Z", "message": "* Adding in @throws clauses per Connie's feedback\n* Fixing a long line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NjU3NTg3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#pullrequestreview-527657587", "createdAt": "2020-11-10T22:25:10Z", "commit": {"oid": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMjoyNToxMFrOHwyBJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMjozNzozMFrOHwyW4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxMzE5MA==", "bodyText": "We can add this in java doc for all the settlement operation (for ex complete, abandon.. etc ) in the client\n@throws UnsupportedOperationException section.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520913190", "createdAt": "2020-11-10T22:25:10Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -987,6 +986,11 @@ private boolean isManagementToken(String lockToken) {\n         } else if (message.isSettled()) {\n             return Mono.error(logger.logExceptionAsError(\n                 new IllegalArgumentException(\"The message has either been deleted or already settled.\")));\n+        } else if (message.getLockToken() == null) {\n+            // message must be a peeked message (or somehow they created a message w/o a lock token)\n+            return Mono.error(\n+                logger.logExceptionAsError(new UnsupportedOperationException(\"This operation is not supported for peeked messages. Only messages received using receiveMessages() or receiveMessagesWithContext() in PEEK_LOCK mode can be settled.\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxNzgxNA==", "bodyText": "We might want to put in receiveDeferredMessages API  (which take in Iterable<Long> sequenceNumbers  ) in sync and async client that empty list will complete the flux without sending to service bus .", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520917814", "createdAt": "2020-11-10T22:35:27Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java", "diffHunk": "@@ -189,7 +189,17 @@\n      */\n     @Override\n     public Flux<ServiceBusReceivedMessage> receiveDeferredMessages(ReceiveMode receiveMode, String sessionId,\n-        String associatedLinkName, Iterable<Long> sequenceNumbers) {\n+                                                                   String associatedLinkName, Iterable<Long> sequenceNumbers) {\n+        if (sequenceNumbers == null) {\n+            return fluxError(logger, new NullPointerException(\"'sequenceNumbers' cannot be null\"));\n+        }\n+\n+        final List<Long> numbers = new ArrayList<>();\n+        sequenceNumbers.forEach(s -> numbers.add(s));\n+\n+        if (numbers.isEmpty()) {\n+            return Flux.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxODc1Mg==", "bodyText": "This is done by intellij for you, without you knowing . This should have 4 spaces before  int .  I see few more places like this.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#discussion_r520918752", "createdAt": "2020-11-10T22:37:30Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java", "diffHunk": "@@ -291,7 +298,7 @@\n      */\n     @Override\n     public Flux<Long> schedule(List<ServiceBusMessage> messages, OffsetDateTime scheduledEnqueueTime,\n-        int maxLinkSize, String associatedLinkName, ServiceBusTransactionContext transactionContext) {\n+                               int maxLinkSize, String associatedLinkName, ServiceBusTransactionContext transactionContext) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a19c91e135488f5b4e7b8318acb38fbc27ec4e89"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04c18e2e36cc48758b73fe1498434b6c11b00a9f", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/04c18e2e36cc48758b73fe1498434b6c11b00a9f", "committedDate": "2020-11-10T22:43:32Z", "message": "Fixing some more style issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b635395a29ba844f80bb488dee1f9ced9c3d5499", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b635395a29ba844f80bb488dee1f9ced9c3d5499", "committedDate": "2020-11-10T22:50:25Z", "message": "Fixing some more line length issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc339d5bb4f078bf4e12e6950fdd3550cc8bd384", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bc339d5bb4f078bf4e12e6950fdd3550cc8bd384", "committedDate": "2020-11-10T23:03:21Z", "message": "Fixing long lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28cb72b1555196ee6f1fcd466f52edf8e86e90f2", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/28cb72b1555196ee6f1fcd466f52edf8e86e90f2", "committedDate": "2020-11-10T23:11:04Z", "message": "Fixing imports that I inadvertantly collapsed in IntelliJ"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c85d5b253bbbe7a87d8a22c751fded58ffe9ebcc", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c85d5b253bbbe7a87d8a22c751fded58ffe9ebcc", "committedDate": "2020-11-10T23:16:23Z", "message": "Undoing some of my inadvertant formatting changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3195b7530316cf01fb8b2868cea71994a9316f5f", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3195b7530316cf01fb8b2868cea71994a9316f5f", "committedDate": "2020-11-10T23:32:02Z", "message": "Updating @throws doc comments to include they can also throw if the message itself was received from peekMessage."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97c5613e8f9679efe56640da0a4d19b0aff78ca4", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/97c5613e8f9679efe56640da0a4d19b0aff78ca4", "committedDate": "2020-11-10T23:35:11Z", "message": "Thou shalt not use 'var'!"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c02d996d7f3b7d85c040a7861442068599d35a5b", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c02d996d7f3b7d85c040a7861442068599d35a5b", "committedDate": "2020-11-10T23:40:54Z", "message": "Fixing a missing import from when I tried to revert formatting changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0944f11021110a3c1c2e039bd9df60aabd2124f7", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0944f11021110a3c1c2e039bd9df60aabd2124f7", "committedDate": "2020-11-10T23:47:42Z", "message": "Whoops, did not mean to strip out the type there."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "964fcbb009812fb7c061783326e373d972ca16a9", "author": {"user": {"login": "richardpark-msft", "name": "Richard Park"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/964fcbb009812fb7c061783326e373d972ca16a9", "committedDate": "2020-11-11T01:32:22Z", "message": "cancelScheduledMessages should also no-op with an empty array parameter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3ODcwNzk1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17454#pullrequestreview-527870795", "createdAt": "2020-11-11T05:24:24Z", "commit": {"oid": "964fcbb009812fb7c061783326e373d972ca16a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 67, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}