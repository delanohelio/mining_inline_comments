{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2NTEwMjI4", "number": 14661, "title": "Query annotation support", "bodyText": "This enables end users to add annotated queries to their repositories using @query(value = \"\") which opens up all the query capabilities of underlying cosmos java sdk to the cosmos spring driver.\nExamples\nSynchronous:\n    @Query(value = \"select * from c offset @offset limit @limit\" )\n    List<Contact> contactsWithOffsetLimit(@Param(\"offset\") int offset, @Param(\"limit\") int limit);\n\nReactive:\n    @Query(value = \"select count(c.id) as num_ids, c.department from c group by c.department\")\n    Flux<ObjectNode> coursesGroupBy();\n\n#12714: Support @Query annotation from spring-data-commons\nCloses: #12714", "createdAt": "2020-08-31T20:01:58Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661", "merged": true, "mergeCommit": {"oid": "32f9ae0279a1a4d8b13201572bed5a031ff54c49"}, "closed": true, "closedAt": "2020-09-09T06:21:16Z", "author": {"login": "mbhaskar"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE4TgFgFqTQ4MDU1NjExNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHEy5TgBqjM3NDM4NjgyMjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTU2MTE2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#pullrequestreview-480556116", "createdAt": "2020-09-02T07:33:40Z", "commit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNzozMzo0MFrOHLg3eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTowODozMVrOHLmCIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgzNDg3Mg==", "bodyText": "Do we need .publishOn(Schedulers.parallel()) here?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481834872", "createdAt": "2020-09-02T07:33:40Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/core/ReactiveCosmosTemplate.java", "diffHunk": "@@ -578,6 +578,25 @@ public MappingCosmosConverter getConverter() {\n         return mappingCosmosConverter;\n     }\n \n+    @Override\n+    public <T> Flux<T> runQuery(SqlQuerySpec querySpec, Class<?> domainType, Class<T> returnType) {\n+        String containerName = domainType.getSimpleName();\n+        CosmosQueryRequestOptions options = new CosmosQueryRequestOptions();\n+        return cosmosAsyncClient.getDatabase(this.databaseName)\n+                   .getContainer(containerName)\n+                   .queryItems(querySpec, options, returnType)\n+                   .byPage()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg0MTg0Mw==", "bodyText": "Do we need @Override in before line 38?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481841843", "createdAt": "2020-09-02T07:41:51Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/AbstractReactiveCosmosQuery.java", "diffHunk": "@@ -15,7 +15,7 @@\n public abstract class AbstractReactiveCosmosQuery implements RepositoryQuery {\n \n     private final ReactiveCosmosQueryMethod method;\n-    private final ReactiveCosmosOperations operations;\n+    protected final ReactiveCosmosOperations operations;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NjE0MQ==", "bodyText": "The following code will look better:\nreturn (Optional<A>) this.annotationCache.computeIfAbsent(\n    annotationType,\n    type -> Optional.ofNullable(AnnotatedElementUtils.findMergedAnnotation(method, type))\n);", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481876141", "createdAt": "2020-09-02T08:20:57Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/CosmosQueryMethod.java", "diffHunk": "@@ -39,4 +51,42 @@ public CosmosQueryMethod(Method method, RepositoryMetadata metadata, ProjectionF\n         this.metadata = new SimpleCosmosEntityMetadata<Object>(domainType, entityInformation);\n         return this.metadata;\n     }\n+\n+    /**\n+     * Returns whether the method has an annotated query.\n+     * @return if the query method has an annotated query\n+     */\n+    public boolean hasAnnotatedQuery() {\n+        return findAnnotatedQuery().isPresent();\n+    }\n+\n+    /**\n+     * Returns the query string declared in a {@link Query} annotation or {@literal null} if neither the annotation\n+     * found\n+     * nor the attribute was specified.\n+     *\n+     * @return the query string or null\n+     */\n+    @Nullable\n+    public String getQueryAnnotation() {\n+        return findAnnotatedQuery().orElse(null);\n+    }\n+\n+    private Optional<String> findAnnotatedQuery() {\n+\n+        return lookupQueryAnnotation()\n+                   .map(Query::value)\n+                   .filter(StringUtils::hasText);\n+    }\n+\n+    Optional<Query> lookupQueryAnnotation() {\n+        return doFindAnnotation(Query.class);\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private <A extends Annotation> Optional<A> doFindAnnotation(Class<A> annotationType) {\n+        return (Optional<A>) this.annotationCache\n+                                 .computeIfAbsent(annotationType, it -> Optional.ofNullable(AnnotatedElementUtils\n+                                                                                .findMergedAnnotation(method, it)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4MjIyNQ==", "bodyText": "The parameter annotationType is always Query.class, can we remove the parameter?\nFurther more, can we delete annotationCache and method, just use the following field instead:\nprivate final String annotatedQuery;\n\nInitialize annotatedQuery in constructor.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481882225", "createdAt": "2020-09-02T08:27:25Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/CosmosQueryMethod.java", "diffHunk": "@@ -39,4 +51,42 @@ public CosmosQueryMethod(Method method, RepositoryMetadata metadata, ProjectionF\n         this.metadata = new SimpleCosmosEntityMetadata<Object>(domainType, entityInformation);\n         return this.metadata;\n     }\n+\n+    /**\n+     * Returns whether the method has an annotated query.\n+     * @return if the query method has an annotated query\n+     */\n+    public boolean hasAnnotatedQuery() {\n+        return findAnnotatedQuery().isPresent();\n+    }\n+\n+    /**\n+     * Returns the query string declared in a {@link Query} annotation or {@literal null} if neither the annotation\n+     * found\n+     * nor the attribute was specified.\n+     *\n+     * @return the query string or null\n+     */\n+    @Nullable\n+    public String getQueryAnnotation() {\n+        return findAnnotatedQuery().orElse(null);\n+    }\n+\n+    private Optional<String> findAnnotatedQuery() {\n+\n+        return lookupQueryAnnotation()\n+                   .map(Query::value)\n+                   .filter(StringUtils::hasText);\n+    }\n+\n+    Optional<Query> lookupQueryAnnotation() {\n+        return doFindAnnotation(Query.class);\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private <A extends Annotation> Optional<A> doFindAnnotation(Class<A> annotationType) {\n+        return (Optional<A>) this.annotationCache\n+                                 .computeIfAbsent(annotationType, it -> Optional.ofNullable(AnnotatedElementUtils\n+                                                                                .findMergedAnnotation(method, it)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3NjE0MQ=="}, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4MzM2NA==", "bodyText": "Same to CosmosQueryMethod.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481883364", "createdAt": "2020-09-02T08:28:42Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/ReactiveCosmosQueryMethod.java", "diffHunk": "@@ -56,4 +66,41 @@ public ReactiveCosmosQueryMethod(Method method, RepositoryMetadata metadata, Pro\n     private static boolean isReactiveWrapperClass(Class<?> clazz) {\n         return clazz.equals(Flux.class) || clazz.equals(Mono.class);\n     }\n+\n+    /**\n+     * Returns whether the method has an annotated query.\n+     * @return if the query method has an annotated query\n+     */\n+    public boolean hasAnnotatedQuery() {\n+        return findAnnotatedQuery().isPresent();\n+    }\n+\n+    /**\n+     * Gets the annotated query or returns null\n+     * @return the annotated query String or null\n+     */\n+    @Nullable\n+    public String getQueryAnnotatation() {\n+        return findAnnotatedQuery().orElse(null);\n+    }\n+\n+    private Optional<String> findAnnotatedQuery() {\n+\n+        return lookupQueryAnnotation()\n+                   .map(Query::value)\n+                   .filter(StringUtils::hasText);\n+    }\n+\n+    Optional<Query> lookupQueryAnnotation() {\n+        return doFindAnnotation(Query.class);\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private <A extends Annotation> Optional<A> doFindAnnotation(Class<A> annotationType) {\n+\n+        return (Optional<A>) this.annotationCache\n+                                 .computeIfAbsent(annotationType, it -> Optional.ofNullable(AnnotatedElementUtils\n+                                                                                .findMergedAnnotation(method, it)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4ODA5MA==", "bodyText": "Use getAnnotatedQuery instead of getQueryAnnotation.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481888090", "createdAt": "2020-09-02T08:33:52Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/CosmosQueryMethod.java", "diffHunk": "@@ -39,4 +51,42 @@ public CosmosQueryMethod(Method method, RepositoryMetadata metadata, ProjectionF\n         this.metadata = new SimpleCosmosEntityMetadata<Object>(domainType, entityInformation);\n         return this.metadata;\n     }\n+\n+    /**\n+     * Returns whether the method has an annotated query.\n+     * @return if the query method has an annotated query\n+     */\n+    public boolean hasAnnotatedQuery() {\n+        return findAnnotatedQuery().isPresent();\n+    }\n+\n+    /**\n+     * Returns the query string declared in a {@link Query} annotation or {@literal null} if neither the annotation\n+     * found\n+     * nor the attribute was specified.\n+     *\n+     * @return the query string or null\n+     */\n+    @Nullable\n+    public String getQueryAnnotation() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5ODE3MQ==", "bodyText": "Use p.getName().orElse(\"\") instead of p.getName().get() to avoid NPE.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481898171", "createdAt": "2020-09-02T08:45:03Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/support/StringBasedCosmosQuery.java", "diffHunk": "@@ -0,0 +1,65 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.spring.data.cosmos.repository.support;\n+\n+import com.azure.cosmos.models.SqlParameter;\n+import com.azure.cosmos.models.SqlQuerySpec;\n+import com.azure.spring.data.cosmos.core.CosmosOperations;\n+import com.azure.spring.data.cosmos.core.query.CosmosQuery;\n+import com.azure.spring.data.cosmos.repository.query.AbstractCosmosQuery;\n+import com.azure.spring.data.cosmos.repository.query.CosmosParameterAccessor;\n+import com.azure.spring.data.cosmos.repository.query.CosmosParameterParameterAccessor;\n+import com.azure.spring.data.cosmos.repository.query.CosmosQueryMethod;\n+import org.springframework.data.repository.query.ResultProcessor;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static com.azure.spring.data.cosmos.core.convert.MappingCosmosConverter.toCosmosDbValue;\n+\n+/**\n+ * Cosmos query class to handle the annotated queries. This overrides the execution and runs the query directly\n+ */\n+public class StringBasedCosmosQuery extends AbstractCosmosQuery {\n+    private final String query;\n+\n+    /**\n+     * Constructor\n+     * @param queryMethod the CosmosQueryMethod\n+     * @param dbOperations the CosmosOperations\n+     */\n+    public StringBasedCosmosQuery(CosmosQueryMethod queryMethod, CosmosOperations dbOperations) {\n+        super(queryMethod, dbOperations);\n+        this.query = queryMethod.getQueryAnnotation();\n+    }\n+\n+    @Override\n+    protected CosmosQuery createQuery(CosmosParameterAccessor accessor) {\n+        return null;\n+    }\n+\n+    @Override\n+    public Object execute(final Object[] parameters) {\n+        final CosmosParameterAccessor accessor = new CosmosParameterParameterAccessor(getQueryMethod(), parameters);\n+        final ResultProcessor processor = getQueryMethod().getResultProcessor().withDynamicProjection(accessor);\n+\n+        List<SqlParameter> sqlParameters = getQueryMethod().getParameters().stream()\n+                            .map(p -> new SqlParameter(\"@\" + p.getName().get(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5ODMwNQ==", "bodyText": "Use p.getName().orElse(\"\") instead of p.getName().get() to avoid NPE.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481898305", "createdAt": "2020-09-02T08:45:12Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/support/StringBasedReactiveCosmosQuery.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.spring.data.cosmos.repository.support;\n+\n+import com.azure.cosmos.models.SqlParameter;\n+import com.azure.cosmos.models.SqlQuerySpec;\n+import com.azure.spring.data.cosmos.core.ReactiveCosmosOperations;\n+import com.azure.spring.data.cosmos.core.query.CosmosQuery;\n+import com.azure.spring.data.cosmos.repository.query.AbstractReactiveCosmosQuery;\n+import com.azure.spring.data.cosmos.repository.query.ReactiveCosmosParameterAccessor;\n+import com.azure.spring.data.cosmos.repository.query.ReactiveCosmosParameterParameterAccessor;\n+import com.azure.spring.data.cosmos.repository.query.ReactiveCosmosQueryMethod;\n+import org.springframework.data.repository.query.ResultProcessor;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static com.azure.spring.data.cosmos.core.convert.MappingCosmosConverter.toCosmosDbValue;\n+\n+/**\n+ * Cosmos query class to handle the annotated queries. This overrides the execution and runs the query directly\n+ */\n+public class StringBasedReactiveCosmosQuery extends AbstractReactiveCosmosQuery {\n+    private final String query;\n+\n+    /**\n+     * Constructor\n+     * @param queryMethod the query method\n+     * @param dbOperations the reactive cosmos operations\n+     */\n+    public StringBasedReactiveCosmosQuery(ReactiveCosmosQueryMethod queryMethod,\n+                                          ReactiveCosmosOperations dbOperations) {\n+        super(queryMethod, dbOperations);\n+        this.query = queryMethod.getQueryAnnotatation();\n+    }\n+\n+    @Override\n+    protected CosmosQuery createQuery(ReactiveCosmosParameterAccessor accessor) {\n+        return null;\n+    }\n+\n+    @Override\n+    public Object execute(final Object[] parameters) {\n+        final ReactiveCosmosParameterAccessor accessor = new ReactiveCosmosParameterParameterAccessor(getQueryMethod(),\n+                                                                                              parameters);\n+        final ResultProcessor processor = getQueryMethod().getResultProcessor().withDynamicProjection(accessor);\n+\n+        List<SqlParameter> sqlParameters = getQueryMethod().getParameters().stream()\n+                            .map(p -> new SqlParameter(\"@\" + p.getName().get(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwMTgwMA==", "bodyText": "Rename status to active.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481901800", "createdAt": "2020-09-02T08:48:58Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/domain/Contact.java", "diffHunk": "@@ -14,6 +14,10 @@\n \n     private String title;\n \n+    private int intValue;\n+\n+    private boolean status;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNzAyMQ==", "bodyText": "getContactsByTitleAndValue", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481907021", "createdAt": "2020-09-02T08:54:35Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/repository/ContactRepository.java", "diffHunk": "@@ -17,4 +21,17 @@\n     Contact findOneByTitle(String title);\n \n     Optional<Contact> findOptionallyByTitle(String title);\n+\n+    @Query(value = \"select * from c where c.title = @title and c.intValue = @value\")\n+    List<Contact> contactWithValueTitle(@Param(\"value\") int value, @Param(\"title\") String name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwODQxMA==", "bodyText": "getContactsWithOffsetAndLimit", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481908410", "createdAt": "2020-09-02T08:56:04Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/repository/ContactRepository.java", "diffHunk": "@@ -17,4 +21,17 @@\n     Contact findOneByTitle(String title);\n \n     Optional<Contact> findOptionallyByTitle(String title);\n+\n+    @Query(value = \"select * from c where c.title = @title and c.intValue = @value\")\n+    List<Contact> contactWithValueTitle(@Param(\"value\") int value, @Param(\"title\") String name);\n+\n+    @Query(value = \"select * from c offset @offset limit @limit\")\n+    List<Contact> contactsWithOffsetLimit(@Param(\"offset\") int offset, @Param(\"limit\") int limit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwOTQ2MA==", "bodyText": "Rename num_ids to id_count", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481909460", "createdAt": "2020-09-02T08:57:04Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/repository/ContactRepository.java", "diffHunk": "@@ -17,4 +21,17 @@\n     Contact findOneByTitle(String title);\n \n     Optional<Contact> findOptionallyByTitle(String title);\n+\n+    @Query(value = \"select * from c where c.title = @title and c.intValue = @value\")\n+    List<Contact> contactWithValueTitle(@Param(\"value\") int value, @Param(\"title\") String name);\n+\n+    @Query(value = \"select * from c offset @offset limit @limit\")\n+    List<Contact> contactsWithOffsetLimit(@Param(\"offset\") int offset, @Param(\"limit\") int limit);\n+\n+    @Query(value = \"select * from c where c.status= true\")\n+    List<Contact> findActiveContacts();\n+\n+    @Query(value = \"SELECT count(c.id) as num_ids, c.intValue FROM c group by c.intValue\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNjEwNg==", "bodyText": "To make test code easier to read, could you please:\n\nDelete Contact.Contact() and Contact.Contact(String logicId, String title), only keep Contact(final String logicId, final String title, final int intValue, boolean status).\nDelete all contects create in unit tests, define them as static field, just like TEST_CONTACT1 to TEST_CONTACT5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481916106", "createdAt": "2020-09-02T09:04:33Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/integration/ContactRepositoryIT.java", "diffHunk": "@@ -33,7 +35,11 @@\n @ContextConfiguration(classes = TestRepositoryConfig.class)\n public class ContactRepositoryIT {\n \n-    private static final Contact TEST_CONTACT = new Contact(\"testId\", \"faketitle\");\n+    private static final Contact TEST_CONTACT = new Contact(\"testId\", \"faketitle\", 25, true);\n+    private static final Contact TEST_CONTACT2 = new Contact(\"testId2\", \"faketitle2\",  32, false);\n+    private static final Contact TEST_CONTACT3 = new Contact(\"testId3\", \"faketitle3\", 25, false);\n+    private static final Contact TEST_CONTACT4 = new Contact(\"testId4\", \"faketitle4\", 43, true);\n+    private static final Contact TEST_CONTACT5 = new Contact(\"testId5\", \"faketitle3\", 43, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNjI5Nw==", "bodyText": "Rename to TEST_CONTACT1.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481916297", "createdAt": "2020-09-02T09:04:48Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/integration/ContactRepositoryIT.java", "diffHunk": "@@ -33,7 +35,11 @@\n @ContextConfiguration(classes = TestRepositoryConfig.class)\n public class ContactRepositoryIT {\n \n-    private static final Contact TEST_CONTACT = new Contact(\"testId\", \"faketitle\");\n+    private static final Contact TEST_CONTACT = new Contact(\"testId\", \"faketitle\", 25, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxOTExMw==", "bodyText": "getCoursesByNameAndDepartment", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481919113", "createdAt": "2020-09-02T09:08:01Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/repository/ReactiveCourseRepository.java", "diffHunk": "@@ -43,4 +46,10 @@\n      */\n     Mono<Course> findOneByName(String name);\n \n+    @Query(value = \"select * from c where c.name = @name and c.department = @department\")\n+    Flux<Course> coursesWithNameDepartment(@Param(\"name\") String name, @Param(\"department\") String department);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxOTUyMA==", "bodyText": "getCoursesGroupByDepartment.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r481919520", "createdAt": "2020-09-02T09:08:31Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/repository/ReactiveCourseRepository.java", "diffHunk": "@@ -43,4 +46,10 @@\n      */\n     Mono<Course> findOneByName(String name);\n \n+    @Query(value = \"select * from c where c.name = @name and c.department = @department\")\n+    Flux<Course> coursesWithNameDepartment(@Param(\"name\") String name, @Param(\"department\") String department);\n+\n+    @Query(value = \"select count(c.id) as num_ids, c.department from c group by c.department\")\n+    Flux<ObjectNode> coursesGroupBy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c8897c86cac147ac46118be15b47859528c8f26"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjEwODEy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#pullrequestreview-483210812", "createdAt": "2020-09-07T02:40:17Z", "commit": {"oid": "82bc456d19c71b49e4a01db3850622ed2560a12e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMjo0MDoxN1rOHNuifQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMjo0MjoxNVrOHNuj6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE1NjAyOQ==", "bodyText": "Can we just delete field method, use stringInQueryAnnotation instead?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r484156029", "createdAt": "2020-09-07T02:40:17Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/CosmosQueryMethod.java", "diffHunk": "@@ -27,6 +33,7 @@\n      */\n     public CosmosQueryMethod(Method method, RepositoryMetadata metadata, ProjectionFactory factory) {\n         super(method, metadata, factory);\n+        this.method = method;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82bc456d19c71b49e4a01db3850622ed2560a12e"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE1NjM5Mg==", "bodyText": "Same here, we can use a field stringInQueryAnnotation  instead of calculate it  every time.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r484156392", "createdAt": "2020-09-07T02:42:15Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/ReactiveCosmosQueryMethod.java", "diffHunk": "@@ -56,4 +61,33 @@ public ReactiveCosmosQueryMethod(Method method, RepositoryMetadata metadata, Pro\n     private static boolean isReactiveWrapperClass(Class<?> clazz) {\n         return clazz.equals(Flux.class) || clazz.equals(Mono.class);\n     }\n+\n+    /**\n+     * Returns whether the method has an annotated query.\n+     * @return if the query method has an annotated query\n+     */\n+    public boolean hasAnnotatedQuery() {\n+        return findAnnotatedQuery().isPresent();\n+    }\n+\n+    /**\n+     * Gets the annotated query or returns null\n+     * @return the annotated query String or null\n+     */\n+    @Nullable\n+    public String getQueryAnnotation() {\n+        return findAnnotatedQuery().orElse(null);\n+    }\n+\n+    private Optional<String> findAnnotatedQuery() {\n+\n+        return lookupQueryAnnotation()\n+                   .map(Query::value)\n+                   .filter(StringUtils::hasText);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82bc456d19c71b49e4a01db3850622ed2560a12e"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMzQyNTI3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#pullrequestreview-483342527", "createdAt": "2020-09-07T08:10:46Z", "commit": {"oid": "4722fbe0672a3cf6d6f03a197a78aa57a7a5feea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwODoxMDo0NlrOHN1HSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwODoxMDo0NlrOHN1HSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI2Mzc1Mw==", "bodyText": "Can we just delete method findAnnotatedQuery, and write the code directory in constructor?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#discussion_r484263753", "createdAt": "2020-09-07T08:10:46Z", "author": {"login": "chenrujun"}, "path": "sdk/cosmos/azure-spring-data-cosmos-core/src/main/java/com/azure/spring/data/cosmos/repository/query/CosmosQueryMethod.java", "diffHunk": "@@ -64,18 +65,13 @@ public boolean hasAnnotatedQuery() {\n      */\n     @Nullable\n     public String getQueryAnnotation() {\n-        return findAnnotatedQuery().orElse(null);\n+        return annotatedQueryValue;\n     }\n \n-    private Optional<String> findAnnotatedQuery() {\n-\n-        return lookupQueryAnnotation()\n+    private Optional<String> findAnnotatedQuery(Method method) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4722fbe0672a3cf6d6f03a197a78aa57a7a5feea"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNzM3MDU2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#pullrequestreview-483737056", "createdAt": "2020-09-08T00:53:16Z", "commit": {"oid": "4722fbe0672a3cf6d6f03a197a78aa57a7a5feea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NjAzNTM4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#pullrequestreview-484603538", "createdAt": "2020-09-09T01:37:02Z", "commit": {"oid": "4722fbe0672a3cf6d6f03a197a78aa57a7a5feea"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NjQ2OTYz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14661#pullrequestreview-484646963", "createdAt": "2020-09-09T04:08:48Z", "commit": {"oid": "4722fbe0672a3cf6d6f03a197a78aa57a7a5feea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8a1360f997447e670b9823eae75df781a521c2b", "author": {"user": {"login": "mbhaskar", "name": "Bhaskar Mallapragada"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a8a1360f997447e670b9823eae75df781a521c2b", "committedDate": "2020-09-09T04:35:43Z", "message": "This PR adds support for query annotations. This enables end users to add annotated queries to their repositories using @Query(value = \"<query>\") which opens up all the query capabilities of underlying cosmos java sdk to the cosmos spring driver."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30adff1a4e4614cc95901e70ce9d79214659e75e", "author": {"user": {"login": "mbhaskar", "name": "Bhaskar Mallapragada"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/30adff1a4e4614cc95901e70ce9d79214659e75e", "committedDate": "2020-09-09T04:35:43Z", "message": "Test fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "302a152a450d279099e96b10ada0191c09b760b9", "author": {"user": {"login": "mbhaskar", "name": "Bhaskar Mallapragada"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/302a152a450d279099e96b10ada0191c09b760b9", "committedDate": "2020-09-09T04:35:44Z", "message": "Test fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83353a6cd2497de81d476fe5f6d801ef3b068bee", "author": {"user": {"login": "mbhaskar", "name": "Bhaskar Mallapragada"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/83353a6cd2497de81d476fe5f6d801ef3b068bee", "committedDate": "2020-09-09T04:35:44Z", "message": "spotbug fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95db49a8716f7717435a9fae73282cf3a1730c0d", "author": {"user": {"login": "mbhaskar", "name": "Bhaskar Mallapragada"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/95db49a8716f7717435a9fae73282cf3a1730c0d", "committedDate": "2020-09-09T04:35:44Z", "message": "checkstyle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57e4075054446fca04aced7b16e67684618fff43", "author": {"user": {"login": "mbhaskar", "name": "Bhaskar Mallapragada"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/57e4075054446fca04aced7b16e67684618fff43", "committedDate": "2020-09-09T04:35:44Z", "message": "Implementing PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b0818bac0e09f6650ff48a3aaaf5aa35e4586c9", "author": {"user": {"login": "mbhaskar", "name": "Bhaskar Mallapragada"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3b0818bac0e09f6650ff48a3aaaf5aa35e4586c9", "committedDate": "2020-09-09T04:35:44Z", "message": "Implementing PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "158e08a74541fddeb78f8836abfbbe5cd1fdafa1", "author": {"user": {"login": "mbhaskar", "name": "Bhaskar Mallapragada"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/158e08a74541fddeb78f8836abfbbe5cd1fdafa1", "committedDate": "2020-09-09T04:35:44Z", "message": "checkstyle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0888f19a33169d8220a9862d2e14ba60eeb1996c", "author": {"user": {"login": "mbhaskar", "name": "Bhaskar Mallapragada"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0888f19a33169d8220a9862d2e14ba60eeb1996c", "committedDate": "2020-09-09T04:35:45Z", "message": "Refactoring couple of methods"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4722fbe0672a3cf6d6f03a197a78aa57a7a5feea", "author": {"user": {"login": "mbhaskar", "name": "Bhaskar Mallapragada"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4722fbe0672a3cf6d6f03a197a78aa57a7a5feea", "committedDate": "2020-09-07T08:06:39Z", "message": "Refactoring couple of methods"}, "afterCommit": {"oid": "0888f19a33169d8220a9862d2e14ba60eeb1996c", "author": {"user": {"login": "mbhaskar", "name": "Bhaskar Mallapragada"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0888f19a33169d8220a9862d2e14ba60eeb1996c", "committedDate": "2020-09-09T04:35:45Z", "message": "Refactoring couple of methods"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4983, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}