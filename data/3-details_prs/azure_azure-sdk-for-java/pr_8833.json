{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDgzMjAy", "number": 8833, "title": "Nio delete", "bodyText": "There are two parts to this PR.\n\nAdding the delete api and relevant tests\nA reasonably large refactor of tests that I promised I would fix when I merged the last PR.", "createdAt": "2020-03-07T01:17:38Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8833", "merged": true, "mergeCommit": {"oid": "ff8c2805373d1896bc3d3efc815940bf44ac0198"}, "closed": true, "closedAt": "2020-03-16T01:33:56Z", "author": {"login": "rickle-msft"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIMRJcAH2gAyMzg1MDgzMjAyOjJlZmUyYzExNWU3MGM0ZjA3YTY0NjdlNWZmM2VjODNhNTFlMmQ2NWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNabn0AH2gAyMzg1MDgzMjAyOjhlMzAxY2Q4OGZjYjgzY2FmMzRjZWQzMGUyNzE0YmEzYjY1NzQ3N2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2efe2c115e70c4f07a6467e5ff3ec83a51e2d65d", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2efe2c115e70c4f07a6467e5ff3ec83a51e2d65d", "committedDate": "2020-02-26T19:55:04Z", "message": "Worked on copy and some helpers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4d256ccd316b1be5f939e2de7be7ba0f5978cf4", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c4d256ccd316b1be5f939e2de7be7ba0f5978cf4", "committedDate": "2020-02-26T20:03:17Z", "message": "Added copy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e07f1e8e12eca5de38b463157b86bd4cc2b3177", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2e07f1e8e12eca5de38b463157b86bd4cc2b3177", "committedDate": "2020-02-26T20:11:30Z", "message": "More tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e3ca5a5a95c3fe2c945e755ba58ee406f0e1bbc", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4e3ca5a5a95c3fe2c945e755ba58ee406f0e1bbc", "committedDate": "2020-02-26T20:11:58Z", "message": "Cleanup and recordings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7297ab8ac6d23abe0320a90a958976358c45e20e", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7297ab8ac6d23abe0320a90a958976358c45e20e", "committedDate": "2020-02-26T20:12:37Z", "message": "Pom/style/resources cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bf83d19a92b5aec5f890152e811949d6f3b28e1", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3bf83d19a92b5aec5f890152e811949d6f3b28e1", "committedDate": "2020-02-26T21:39:53Z", "message": "Reverted core dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11224f2bc546bf26c9e3986dec155cee18f8d2f1", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/11224f2bc546bf26c9e3986dec155cee18f8d2f1", "committedDate": "2020-03-06T00:42:19Z", "message": "PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "191337e74eb8250cef93169f43097cee82c2586e", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/191337e74eb8250cef93169f43097cee82c2586e", "committedDate": "2020-03-06T18:49:23Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "372408acf0c085964f5249014cf61117ba2ea7e3", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/372408acf0c085964f5249014cf61117ba2ea7e3", "committedDate": "2020-03-07T00:49:45Z", "message": "Added delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "505a17cc40e797a68b5c87be556fdcd2f231c35e", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/505a17cc40e797a68b5c87be556fdcd2f231c35e", "committedDate": "2020-03-07T00:50:06Z", "message": "Refactored some tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d0d7b483e996f3ee9a365bb795b89af132ce12b", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3d0d7b483e996f3ee9a365bb795b89af132ce12b", "committedDate": "2020-03-07T00:50:19Z", "message": "added hooks for recording"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4766bf46b68c89762f8b741d55dd0a69e956be3", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e4766bf46b68c89762f8b741d55dd0a69e956be3", "committedDate": "2020-03-07T00:50:31Z", "message": "A bit more test cleanup and added correct recordings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a13c60387763df4549a96cf8be1aedf7ba75c773", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a13c60387763df4549a96cf8be1aedf7ba75c773", "committedDate": "2020-03-07T00:50:48Z", "message": "Fixed up path a bit and added new recordings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fa3b612ae31115f68b9e9fbe1c56d70ea375151", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2fa3b612ae31115f68b9e9fbe1c56d70ea375151", "committedDate": "2020-03-07T00:51:03Z", "message": "Added delete tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fbc61eb8d100c7f9a08f37016f7b40c93b28320", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4fbc61eb8d100c7f9a08f37016f7b40c93b28320", "committedDate": "2020-03-07T01:15:21Z", "message": "Merge remote-tracking branch 'upstream/master' into nioDelete2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzA4NTg3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8833#pullrequestreview-370708587", "createdAt": "2020-03-07T01:20:59Z", "commit": {"oid": "4fbc61eb8d100c7f9a08f37016f7b40c93b28320"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMToyMDo1OVrOFzLpXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMToyMDo1OVrOFzLpXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMjUxMQ==", "bodyText": "Oops!", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8833#discussion_r389212511", "createdAt": "2020-03-07T01:20:59Z", "author": {"login": "rickle-msft"}, "path": "sdk/storage/azure-storage-blob-nio/src/main/java/com/azure/storage/blob/nio/AzurePath.java", "diffHunk": "@@ -531,10 +555,24 @@ BlobClient toBlobClient() throws IOException {\n \n         String blobName = this.withoutRoot();\n         if (blobName.isEmpty()) {\n+<<<<<<< HEAD", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fbc61eb8d100c7f9a08f37016f7b40c93b28320"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f6697f44603982e22527e83bc9573b895dc37ee", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9f6697f44603982e22527e83bc9573b895dc37ee", "committedDate": "2020-03-09T17:46:25Z", "message": "Fixed minor errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84c9a9f2cb0ebe6a354bf8bbb0cba3d731c6f360", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/84c9a9f2cb0ebe6a354bf8bbb0cba3d731c6f360", "committedDate": "2020-03-09T20:10:00Z", "message": "Fixed test recording"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bdc841fbcb4fbea874463db8a43b489d8899c93", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1bdc841fbcb4fbea874463db8a43b489d8899c93", "committedDate": "2020-03-09T20:36:29Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyOTIyMDAw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8833#pullrequestreview-372922000", "createdAt": "2020-03-11T16:25:33Z", "commit": {"oid": "1bdc841fbcb4fbea874463db8a43b489d8899c93"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNjoyNTozM1rOF0-wSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNjoyODozNFrOF0-4fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA5ODQ0Mg==", "bodyText": "I don't think we need to call out what the NIO documents state explicitly, let's just include it as a statement in our docs. Would also like to change the first line to call out what exactly this method does, such as This API deletes the specified path/file, then adding the ancillary info like this isn't atomic, what can't be deleted, etc.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * As noted by the NIO docs, this method is not atomic. It is possible to delete a file in use by another process,\n          \n          \n            \n                 * and doing so will not immediately invalidate any channels open to that file--they will simply start to fail.\n          \n          \n            \n                 * Root directories cannot be deleted even when empty.\n          \n          \n            \n                 * Deletes the specified path.\n          \n          \n            \n                 * <p>\n          \n          \n            \n                 * This method is not atomic, it is possible to delete a file in use by another process. Open channels to the file won't immediately invalidate, they will simply start to fail.\n          \n          \n            \n                 * <p>\n          \n          \n            \n                 * Root directories cannot be deleted even when empty.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8833#discussion_r391098442", "createdAt": "2020-03-11T16:25:33Z", "author": {"login": "alzimmermsft"}, "path": "sdk/storage/azure-storage-blob-nio/src/main/java/com/azure/storage/blob/nio/AzureFileSystemProvider.java", "diffHunk": "@@ -363,11 +358,36 @@ BlobContainerClient getContainerClient(BlobClient client) {\n     }\n \n     /**\n+     * As noted by the NIO docs, this method is not atomic. It is possible to delete a file in use by another process,\n+     * and doing so will not immediately invalidate any channels open to that file--they will simply start to fail.\n+     * Root directories cannot be deleted even when empty.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bdc841fbcb4fbea874463db8a43b489d8899c93"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEwMDU0MQ==", "bodyText": "Do we want to log and throw an exception if the exception is that the blob doesn't exist? I'm good with either, just a theoretical question on what delete on something that doesn't exist means.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8833#discussion_r391100541", "createdAt": "2020-03-11T16:28:34Z", "author": {"login": "alzimmermsft"}, "path": "sdk/storage/azure-storage-blob-nio/src/main/java/com/azure/storage/blob/nio/AzureFileSystemProvider.java", "diffHunk": "@@ -363,11 +358,36 @@ BlobContainerClient getContainerClient(BlobClient client) {\n     }\n \n     /**\n+     * As noted by the NIO docs, this method is not atomic. It is possible to delete a file in use by another process,\n+     * and doing so will not immediately invalidate any channels open to that file--they will simply start to fail.\n+     * Root directories cannot be deleted even when empty.\n+     *\n      * {@inheritDoc}\n      */\n     @Override\n     public void delete(Path path) throws IOException {\n+        // Basic validation. Must be an AzurePath. Cannot be a root.\n+        AzurePath aPath = validatePathInstanceType(path);\n+        validateNotRoot(path, \"Delete\");\n+\n+        // Get client.\n+        BlobClient blobClient = aPath.toBlobClient();\n+\n+        // Check directory status--possibly throw DirectoryNotEmpty or NoSuchFile.\n+        DirectoryStatus dirStatus = checkDirStatus(blobClient);\n+        if (dirStatus.equals(DirectoryStatus.DOES_NOT_EXIST)) {\n+            throw Utility.logError(logger, new NoSuchFileException(path.toString()));\n+        }\n+        if (dirStatus.equals(DirectoryStatus.NOT_EMPTY)) {\n+            throw Utility.logError(logger, new DirectoryNotEmptyException(path.toString()));\n+        }\n \n+        // After all validation has completed, delete the resource.\n+        try {\n+            blobClient.delete();\n+        } catch (BlobStorageException e) {\n+            throw Utility.logError(logger, new IOException(e));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bdc841fbcb4fbea874463db8a43b489d8899c93"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyOTcwNjAy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8833#pullrequestreview-372970602", "createdAt": "2020-03-11T17:23:33Z", "commit": {"oid": "1bdc841fbcb4fbea874463db8a43b489d8899c93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzoyMzozM1rOF1BIMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzoyMzozM1rOF1BIMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzNzMzMQ==", "bodyText": "You could also make sure the value here is true just to prevent accidental fake news. One day the service could decide they want to set this to false for non-dir like blobs", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8833#discussion_r391137331", "createdAt": "2020-03-11T17:23:33Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob-nio/src/test/java/com/azure/storage/blob/nio/APISpec.groovy", "diffHunk": "@@ -481,10 +488,45 @@ class APISpec extends Specification {\n         }\n     }\n \n-    def rootToContainer(String root) {\n+    def rootNameToContainerName(String root) {\n         return root.substring(0, root.length() - 1)\n     }\n \n+    def rootNameToContainerClient(String root) {\n+        return primaryBlobServiceClient.getBlobContainerClient(rootNameToContainerName(root))\n+    }\n+\n+    def getNonDefaultRootDir(FileSystem fs) {\n+        for (Path dir : fs.getRootDirectories()) {\n+            if (!dir.equals(((AzureFileSystem) fs).getDefaultDirectory())) {\n+                return dir.toString()\n+            }\n+        }\n+        throw new Exception(\"File system only contains the default directory\");\n+    }\n+\n+    def getDefaultDir(FileSystem fs) {\n+        return ((AzureFileSystem) fs).getDefaultDirectory().toString()\n+    }\n+\n+    def getPathWithDepth(int depth) {\n+        def pathStr = \"\"\n+        for (int i = 0; i < depth; i++) {\n+            pathStr += generateBlobName() + AzureFileSystem.PATH_SEPARATOR\n+        }\n+        return pathStr\n+    }\n+\n+    def putDirectoryBlob(BlockBlobClient blobClient) {\n+        blobClient.commitBlockListWithResponse(Collections.emptyList(), null,\n+            [(AzureFileSystemProvider.DIR_METADATA_MARKER): \"true\"], null, null, null, null)\n+    }\n+\n+    def checkBlobIsDir(BlobClient blobClient) {\n+        return blobClient.getPropertiesWithResponse(null, null, null).getValue().getMetadata()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bdc841fbcb4fbea874463db8a43b489d8899c93"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyOTk3Njk4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8833#pullrequestreview-372997698", "createdAt": "2020-03-11T17:58:07Z", "commit": {"oid": "1bdc841fbcb4fbea874463db8a43b489d8899c93"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e301cd88fcb83caf34ced30e2714ba3b657477b", "author": {"user": {"login": "rickle-msft", "name": "Rick Ley"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8e301cd88fcb83caf34ced30e2714ba3b657477b", "committedDate": "2020-03-14T01:14:48Z", "message": "PR feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 940, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}