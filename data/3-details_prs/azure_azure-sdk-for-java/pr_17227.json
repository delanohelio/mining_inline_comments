{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2MjE4NzEx", "number": 17227, "title": "Sb track2 Fixing some live test ", "bodyText": "Fix  :  timeout when receiver.complete() or any other settlement method is called for \"specific session id\".\n\nFollowing are test fix only\n\n\nFor session  entity, only one receiver can get a lock to session receiver or  receiveAndDeleteReceiver. Connecting only one at run time. So we do not get session Lock error\n\n\ndisableAutoComplete for RECEIVE AND DELETE mode.", "createdAt": "2020-11-05T17:22:19Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227", "merged": true, "mergeCommit": {"oid": "3f7dee58ba83b6ab48f0ecace1966de58c0e8233"}, "closed": true, "closedAt": "2020-11-06T18:07:41Z", "author": {"login": "hemanttanwar"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZeGy7gH2gAyNTE2MjE4NzExOjE3ZjQ1YmMxNzk1N2ZmYmZjZWI5ZDZmYWI3NTg0MjhiNTY0NGQ4ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ68XJAFqTUyNTM4MDI1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "17f45bc17957ffbfceb9d6fab758428b5644d889", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/17f45bc17957ffbfceb9d6fab758428b5644d889", "committedDate": "2020-11-05T08:29:55Z", "message": "Continue to test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43ccafbba6d31c56e235eb0045c356fc634b252f", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/43ccafbba6d31c56e235eb0045c356fc634b252f", "committedDate": "2020-11-05T17:07:01Z", "message": "Fixing live test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0232012b14dc8c9b089165c0e4ef216a12b1e1ce", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0232012b14dc8c9b089165c0e4ef216a12b1e1ce", "committedDate": "2020-11-05T17:18:49Z", "message": "Removing unwanted test file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NTEzMTI1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-524513125", "createdAt": "2020-11-05T17:44:30Z", "commit": {"oid": "0232012b14dc8c9b089165c0e4ef216a12b1e1ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNzo0NDozMFrOHuO8bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNzo0NDozMFrOHuO8bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0MTM4OA==", "bodyText": "sessionId can not be null or empty for this method. This branch isn't reachable at runtime?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518241388", "createdAt": "2020-11-05T17:44:30Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSessionReceiverAsyncClient.java", "diffHunk": "@@ -113,13 +113,25 @@\n         final ReceiverOptions newReceiverOptions = new ReceiverOptions(receiverOptions.getReceiveMode(),\n             receiverOptions.getPrefetchCount(), receiverOptions.getMaxLockRenewDuration(),\n             receiverOptions.isEnableAutoComplete(), sessionId, null);\n+\n         final ServiceBusSessionManager sessionSpecificManager = new ServiceBusSessionManager(entityPath, entityType,\n             connectionProcessor, tracerProvider, messageSerializer, newReceiverOptions);\n \n-        return sessionSpecificManager.getActiveLink().map(receiveLink -> new ServiceBusReceiverAsyncClient(\n-            fullyQualifiedNamespace, entityPath, entityType, newReceiverOptions, connectionProcessor,\n-            ServiceBusConstants.OPERATION_TIMEOUT, tracerProvider, messageSerializer, () -> { },\n-            sessionSpecificManager));\n+        if (CoreUtils.isNullOrEmpty(sessionId)) {\n+            return sessionSpecificManager.getActiveLink().map(receiveLink -> new ServiceBusReceiverAsyncClient(\n+                fullyQualifiedNamespace, entityPath, entityType, newReceiverOptions, connectionProcessor,\n+                ServiceBusConstants.OPERATION_TIMEOUT, tracerProvider, messageSerializer, () -> {\n+            }, sessionSpecificManager));\n+        } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0232012b14dc8c9b089165c0e4ef216a12b1e1ce"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NTQxMzky", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-524541392", "createdAt": "2020-11-05T18:18:43Z", "commit": {"oid": "0232012b14dc8c9b089165c0e4ef216a12b1e1ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODoxODo0M1rOHuQbqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODoxODo0M1rOHuQbqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2NTc3MQ==", "bodyText": "Why do we have this?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518265771", "createdAt": "2020-11-05T18:18:43Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -166,6 +166,15 @@\n         });\n     }\n \n+    ServiceBusReceiverAsyncClient(String fullyQualifiedNamespace, String entityPath, MessagingEntityType entityType,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0232012b14dc8c9b089165c0e4ef216a12b1e1ce"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NTQyNTAz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-524542503", "createdAt": "2020-11-05T18:20:11Z", "commit": {"oid": "0232012b14dc8c9b089165c0e4ef216a12b1e1ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODoyMDoxMlrOHuQfEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODoyMDoxMlrOHuQfEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2NjY0Mg==", "bodyText": "Wait, why are we doing this logic here?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518266642", "createdAt": "2020-11-05T18:20:12Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSessionReceiverAsyncClient.java", "diffHunk": "@@ -113,13 +113,25 @@\n         final ReceiverOptions newReceiverOptions = new ReceiverOptions(receiverOptions.getReceiveMode(),\n             receiverOptions.getPrefetchCount(), receiverOptions.getMaxLockRenewDuration(),\n             receiverOptions.isEnableAutoComplete(), sessionId, null);\n+\n         final ServiceBusSessionManager sessionSpecificManager = new ServiceBusSessionManager(entityPath, entityType,\n             connectionProcessor, tracerProvider, messageSerializer, newReceiverOptions);\n \n-        return sessionSpecificManager.getActiveLink().map(receiveLink -> new ServiceBusReceiverAsyncClient(\n-            fullyQualifiedNamespace, entityPath, entityType, newReceiverOptions, connectionProcessor,\n-            ServiceBusConstants.OPERATION_TIMEOUT, tracerProvider, messageSerializer, () -> { },\n-            sessionSpecificManager));\n+        if (CoreUtils.isNullOrEmpty(sessionId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0232012b14dc8c9b089165c0e4ef216a12b1e1ce"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2940f9678bf3bc7d5fe75e9921dff565a85ab225", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2940f9678bf3bc7d5fe75e9921dff565a85ab225", "committedDate": "2020-11-05T18:30:53Z", "message": "removing unwanted check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NjA5NjA2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-524609606", "createdAt": "2020-11-05T19:43:44Z", "commit": {"oid": "2940f9678bf3bc7d5fe75e9921dff565a85ab225"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxOTo0Mzo0NFrOHuTxlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxOTo0Mzo0NFrOHuTxlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODMyMDUzNA==", "bodyText": "This Async suffix is .NET", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518320534", "createdAt": "2020-11-05T19:43:44Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1050,6 +1059,10 @@ private boolean isManagementToken(String lockToken) {\n             });\n     }\n \n+    Mono<ServiceBusAsyncConsumer> getOrCreateConsumerAsync() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2940f9678bf3bc7d5fe75e9921dff565a85ab225"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36c6c854f53191a1c3c454ae80133c9e546f5375", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/36c6c854f53191a1c3c454ae80133c9e546f5375", "committedDate": "2020-11-05T21:04:29Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7b212916c036623d949042c36c1e19155f99daa", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a7b212916c036623d949042c36c1e19155f99daa", "committedDate": "2020-11-05T21:10:23Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14038785e5c78938c2128a5d52c72bf56a80ced6", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/14038785e5c78938c2128a5d52c72bf56a80ced6", "committedDate": "2020-11-05T21:12:12Z", "message": "Review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzU2Nzkw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-524756790", "createdAt": "2020-11-05T23:39:29Z", "commit": {"oid": "14038785e5c78938c2128a5d52c72bf56a80ced6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMzozOToyOVrOHua11g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMzozOToyOVrOHua11g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzNjMxMA==", "bodyText": "One last question. So we get and forget the returned result?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518436310", "createdAt": "2020-11-05T23:39:29Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1050,6 +1050,13 @@ private boolean isManagementToken(String lockToken) {\n             });\n     }\n \n+    Mono<ServiceBusReceiverAsyncClient> createConsumerWithReceiveLink() {\n+        return Mono.defer(() -> {\n+            getOrCreateConsumer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14038785e5c78938c2128a5d52c72bf56a80ced6"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e70db071b76a3a660a73ed84850ac111917ac28", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4e70db071b76a3a660a73ed84850ac111917ac28", "committedDate": "2020-11-05T23:41:52Z", "message": "removing space"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzYwNTM3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-524760537", "createdAt": "2020-11-05T23:48:46Z", "commit": {"oid": "4e70db071b76a3a660a73ed84850ac111917ac28"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0Nzc5ODM0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-524779834", "createdAt": "2020-11-06T00:42:11Z", "commit": {"oid": "4e70db071b76a3a660a73ed84850ac111917ac28"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMDo0MjoxMlrOHucESQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMDo0MjoxMlrOHucESQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ1NjM5Mw==", "bodyText": "Why are we returning the object again? We already have a reference to it.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518456393", "createdAt": "2020-11-06T00:42:12Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1050,6 +1050,13 @@ private boolean isManagementToken(String lockToken) {\n             });\n     }\n \n+    Mono<ServiceBusReceiverAsyncClient> createConsumerWithReceiveLink() {\n+        return Mono.defer(() -> {\n+            getOrCreateConsumer();\n+            return Mono.just(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e70db071b76a3a660a73ed84850ac111917ac28"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzgwNDI2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-524780426", "createdAt": "2020-11-06T00:43:56Z", "commit": {"oid": "4e70db071b76a3a660a73ed84850ac111917ac28"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMDo0Mzo1N1rOHucGHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMDo0Mzo1N1rOHucGHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ1Njg2Mg==", "bodyText": "You should be disposing of the original receiver one before setting it again.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518456862", "createdAt": "2020-11-06T00:43:57Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -897,7 +944,7 @@ void sendReceiveMessageWithVariousPropertyTypes(MessagingEntityType entityType)\n     void setAndGetSessionState(MessagingEntityType entityType) {\n         // Arrange\n         setSenderAndReceiver(entityType, 0, true);\n-\n+        receiver = receiverMono.block(TIMEOUT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e70db071b76a3a660a73ed84850ac111917ac28"}, "originalPosition": 260}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzgwOTYx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-524780961", "createdAt": "2020-11-06T00:45:27Z", "commit": {"oid": "4e70db071b76a3a660a73ed84850ac111917ac28"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMDo0NToyN1rOHucH_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMDo0NToyN1rOHucH_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ1NzM0Mw==", "bodyText": "We're not cleaning up the existing receiver that was set.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518457343", "createdAt": "2020-11-06T00:45:27Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -897,7 +944,7 @@ void sendReceiveMessageWithVariousPropertyTypes(MessagingEntityType entityType)\n     void setAndGetSessionState(MessagingEntityType entityType) {\n         // Arrange\n         setSenderAndReceiver(entityType, 0, true);\n-\n+        receiver = receiverMono.block(TIMEOUT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e70db071b76a3a660a73ed84850ac111917ac28"}, "originalPosition": 260}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzgxODM2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-524781836", "createdAt": "2020-11-06T00:47:47Z", "commit": {"oid": "4e70db071b76a3a660a73ed84850ac111917ac28"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMDo0Nzo0OFrOHucK5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMDo0Nzo0OFrOHucK5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ1ODA4NA==", "bodyText": "We're not disposing of the receiver that was already set. This is some weird hack. If the flow is completely different, we should split test cases instead of shoehorning this in.\nAdditionally, you can do:\nvar receiver = sessionReceiver.acceptSession().cache(e -> Duration.MAX_VALUE, e -> Duration.MIN_VALUE, e -> Duration.MIN_VALUE);\ntry {\nStepVerifier.create(receiver.flatMap(e -> e.receive...))\n    .\n\n} finally {\n    receiver.close();\n}", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518458084", "createdAt": "2020-11-06T00:47:48Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -638,6 +671,10 @@ void receiveAndComplete(MessagingEntityType entityType, boolean isSessionEnabled\n         final String messageId = UUID.randomUUID().toString();\n         final ServiceBusMessage message = getMessage(messageId, isSessionEnabled);\n \n+        if (isSessionEnabled) {\n+            this.receiver = receiverMono.block(TIMEOUT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e70db071b76a3a660a73ed84850ac111917ac28"}, "originalPosition": 200}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e1e28295151b0774a6ecff1aa6a71f6f22c814c", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6e1e28295151b0774a6ecff1aa6a71f6f22c814c", "committedDate": "2020-11-06T03:36:59Z", "message": "REview comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b53db70b3eeea4d77cd46e169ab1b598886ffc2b", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b53db70b3eeea4d77cd46e169ab1b598886ffc2b", "committedDate": "2020-11-06T03:40:54Z", "message": "Review comments and test cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be2f0919a0ed60d553143fc67acded1714535ea9", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/be2f0919a0ed60d553143fc67acded1714535ea9", "committedDate": "2020-11-06T04:06:29Z", "message": " test cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "641ff343e9bedcf149c7920a3872b85c3d2ff650", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/641ff343e9bedcf149c7920a3872b85c3d2ff650", "committedDate": "2020-11-06T04:11:32Z", "message": " more test cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0OTM4MTM2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-524938136", "createdAt": "2020-11-06T08:21:32Z", "commit": {"oid": "641ff343e9bedcf149c7920a3872b85c3d2ff650"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODoyMTozMlrOHukMfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODoyOTozM1rOHukc5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4OTU2Ng==", "bodyText": "I don't think is correct or the change above. This method always returns a value. We only want the mono to complete successfully if it was able to acquire a lock on the session.\nThe logic before seems like the correct one.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518589566", "createdAt": "2020-11-06T08:21:32Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSessionReceiverAsyncClient.java", "diffHunk": "@@ -113,13 +113,17 @@\n         final ReceiverOptions newReceiverOptions = new ReceiverOptions(receiverOptions.getReceiveMode(),\n             receiverOptions.getPrefetchCount(), receiverOptions.getMaxLockRenewDuration(),\n             receiverOptions.isEnableAutoComplete(), sessionId, null);\n-        final ServiceBusSessionManager sessionSpecificManager = new ServiceBusSessionManager(entityPath, entityType,\n-            connectionProcessor, tracerProvider, messageSerializer, newReceiverOptions);\n \n-        return sessionSpecificManager.getActiveLink().map(receiveLink -> new ServiceBusReceiverAsyncClient(\n-            fullyQualifiedNamespace, entityPath, entityType, newReceiverOptions, connectionProcessor,\n-            ServiceBusConstants.OPERATION_TIMEOUT, tracerProvider, messageSerializer, () -> { },\n-            sessionSpecificManager));\n+        return  Mono.defer(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "641ff343e9bedcf149c7920a3872b85c3d2ff650"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5MDQxMw==", "bodyText": "There is a messagesDeferredPending that we no longer use and can be moved or removed. We never read its values.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518590413", "createdAt": "2020-11-06T08:23:15Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -64,12 +63,6 @@\n     private ServiceBusReceiverAsyncClient receiver;\n     private ServiceBusSenderAsyncClient sender;\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "641ff343e9bedcf149c7920a3872b85c3d2ff650"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5MTg3Ng==", "bodyText": "Why are we explicitly completing these? the method suggests that these should be auto completed receiveTwoMessagesAutoComplete. Same with the one below.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518591876", "createdAt": "2020-11-06T08:25:53Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -329,12 +261,15 @@ void receiveTwoMessagesAutoComplete(MessagingEntityType entityType, boolean isSe\n         StepVerifier.create(receiver.receiveMessages())\n             .assertNext(receivedMessage -> {\n                 assertMessageEquals(receivedMessage, messageId, isSessionEnabled);\n+                receiver.complete(receivedMessage).block(Duration.ofSeconds(15));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "641ff343e9bedcf149c7920a3872b85c3d2ff650"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5MjkyOQ==", "bodyText": "Then consume while always returns true? Shouldn't we assert that completed < messages.size() and then stop when completed >= messages.size()? And instead of thenCancel(), expect a complete?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518592929", "createdAt": "2020-11-06T08:27:53Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -558,9 +486,13 @@ void peekMessages(MessagingEntityType entityType, boolean isSessionEnabled) {\n                 .assertNext(message -> checkCorrectMessage.accept(message, 7))\n                 .verifyComplete();\n         } finally {\n-            receiveAndDeleteReceiver.receiveMessages()\n-                .take(messages.size())\n-                .blockLast(Duration.ofSeconds(15));\n+            StepVerifier.create(receiver.receiveMessages().take(messages.size()))\n+                .thenConsumeWhile(receivedMessage -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "641ff343e9bedcf149c7920a3872b85c3d2ff650"}, "originalPosition": 212}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5MzUxNA==", "bodyText": "We have a TIMEOUT duration already defined. We can replace all instances of this Duration.ofSeconds.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518593514", "createdAt": "2020-11-06T08:29:08Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -436,9 +362,10 @@ void sendScheduledMessageAndReceive(MessagingEntityType entityType, boolean isSe\n         sender.scheduleMessage(message, scheduledEnqueueTime).block(TIMEOUT);\n \n         // Assert & Act\n-        StepVerifier.create(Mono.delay(Duration.ofSeconds(3)).then(receiveAndDeleteReceiver.receiveMessages().next()))\n+        StepVerifier.create(Mono.delay(Duration.ofSeconds(4)).then(receiver.receiveMessages().next()))\n             .assertNext(receivedMessage -> {\n                 assertMessageEquals(receivedMessage, messageId, isSessionEnabled);\n+                receiver.complete(receivedMessage).block(Duration.ofSeconds(15));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "641ff343e9bedcf149c7920a3872b85c3d2ff650"}, "originalPosition": 190}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5Mzc2Nw==", "bodyText": "Same with this... wouldn't we expect receiver.receiveMessages().take(2) then not cancel?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518593767", "createdAt": "2020-11-06T08:29:33Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -586,6 +518,17 @@ void peekMessagesFromSequence(MessagingEntityType entityType) {\n         StepVerifier.create(receiver.peekMessagesAt(maxMessages, fromSequenceNumber))\n             .expectNextCount(maxMessages)\n             .verifyComplete();\n+\n+        // cleanup\n+        StepVerifier.create(receiver.receiveMessages())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "641ff343e9bedcf149c7920a3872b85c3d2ff650"}, "originalPosition": 227}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3949a8e250fe77e6e852bc11d49e41d49c19483", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c3949a8e250fe77e6e852bc11d49e41d49c19483", "committedDate": "2020-11-06T17:20:44Z", "message": "Review comment incorporated."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4ba7f43149fdbc2a8cc60af8d61e04200c8ac89", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b4ba7f43149fdbc2a8cc60af8d61e04200c8ac89", "committedDate": "2020-11-06T17:28:47Z", "message": "Review comment incorporated."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzgwMjU3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#pullrequestreview-525380257", "createdAt": "2020-11-06T18:05:46Z", "commit": {"oid": "b4ba7f43149fdbc2a8cc60af8d61e04200c8ac89"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 267, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}