{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0Mzc1NjM0", "number": 17075, "title": "Add tests to digital twins sdk for etag scenarios", "bodyText": "Just like with .NET, I've added happy/sad path tests for all ifMatch and ifNoneMatch scenarios", "createdAt": "2020-11-02T22:46:34Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17075", "merged": true, "mergeCommit": {"oid": "aa6d2526c9f0081ee08cbcafbf27a9af15839de3"}, "closed": true, "closedAt": "2020-11-03T17:43:27Z", "author": {"login": "timtay-microsoft"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYsizHgH2gAyNTE0Mzc1NjM0OjRiZGFiYzk2NTdkMzE0YWJkMmVkMTQxZWI5OGNlNTU0MmIyYWE3NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY8eSMAH2gAyNTE0Mzc1NjM0OmEyM2FhYjBiZGJiYzgxOTRiMzYyZGFjOWJmOTVlMGQxZTU0M2NjMDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4bdabc9657d314abd2ed141eb98ce5542b2aa742", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4bdabc9657d314abd2ed141eb98ce5542b2aa742", "committedDate": "2020-11-02T22:45:15Z", "message": "Add tests to digital twins sdk for etag scenarios"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMTA3NDE5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17075#pullrequestreview-522107419", "createdAt": "2020-11-02T23:37:30Z", "commit": {"oid": "4bdabc9657d314abd2ed141eb98ce5542b2aa742"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMzozNzozMFrOHsaj1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMzozNzozMFrOHsaj1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMzNDU1MA==", "bodyText": "formatting differences between this and the previous call on line 189 in terms of line breaks and tabbing.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17075#discussion_r516334550", "createdAt": "2020-11-02T23:37:30Z", "author": {"login": "drwill-ms"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/ComponentsAsyncTests.java", "diffHunk": "@@ -89,4 +92,153 @@ public void componentLifecycleTest(HttpClient httpClient, DigitalTwinsServiceVer\n             }\n         }\n     }\n+\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void patchComponentFailsIfETagDoesNotMatch(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion) throws JsonProcessingException {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String wifiComponentName = \"wifiAccessPoint\";\n+\n+        String roomWithWifiTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_WITH_WIFI_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String roomWithWifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_WITH_WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String wifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+\n+        String modelWifi = TestAssetsHelper.getWifiModelPayload(wifiModelId);\n+        String modelRoomWithWifi = TestAssetsHelper.getRoomWithWifiModelPayload(roomWithWifiModelId, wifiModelId, wifiComponentName);\n+        String roomWithWifiTwin = TestAssetsHelper.getRoomWithWifiTwinPayload(roomWithWifiModelId, wifiComponentName);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(modelWifi, modelRoomWithWifi));\n+\n+        try {\n+            // Create models and components to test the lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created models successfully\"))\n+                .verifyComplete();\n+\n+            AtomicReference<String> etagBeforeUpdate = new AtomicReference<>();\n+            StepVerifier.create(asyncClient.createOrReplaceDigitalTwinWithResponse(\n+                roomWithWifiTwinId,\n+                deserializeJsonString(roomWithWifiTwin, BasicDigitalTwin.class),\n+                BasicDigitalTwin.class,\n+                null))\n+                .assertNext(createdTwinResponse -> {\n+                    etagBeforeUpdate.set(createdTwinResponse.getDeserializedHeaders().getETag());\n+                })\n+                .verifyComplete();\n+\n+            StepVerifier.create(asyncClient.updateComponentWithResponse(roomWithWifiTwinId, wifiComponentName, TestAssetsHelper.getWifiComponentUpdatePayload(), null))\n+                .assertNext(updateResponse -> {\n+                    logger.info(\"Updated the component successfully\");\n+                })\n+                .verifyComplete();\n+\n+            // Update the component again, but with the out of date etag\n+            StepVerifier.create(\n+                asyncClient.updateComponentWithResponse(\n+                    roomWithWifiTwinId,\n+                    wifiComponentName,\n+                    TestAssetsHelper.getWifiComponentSecondUpdatePayload(),\n+                    new UpdateComponentOptions().setIfMatch(etagBeforeUpdate.get())))\n+                .verifyErrorSatisfies(ex -> assertRestException(ex, HttpURLConnection.HTTP_PRECON_FAILED));\n+        }\n+        finally {\n+            try\n+            {\n+                if (roomWithWifiTwinId != null)\n+                {\n+                    asyncClient.deleteDigitalTwin(roomWithWifiTwinId).block();\n+                }\n+                if (roomWithWifiModelId != null)\n+                {\n+                    asyncClient.deleteModel(roomWithWifiModelId).block();\n+                }\n+                if (wifiModelId != null)\n+                {\n+                    asyncClient.deleteModel(wifiModelId).block();\n+                }\n+            }\n+            catch (Exception ex)\n+            {\n+                fail(\"Test cleanup failed\", ex);\n+            }\n+        }\n+    }\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void patchComponentSucceedsIfETagMatches(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion) throws JsonProcessingException {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String wifiComponentName = \"wifiAccessPoint\";\n+\n+        String roomWithWifiTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_WITH_WIFI_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String roomWithWifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_WITH_WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String wifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+\n+        String modelWifi = TestAssetsHelper.getWifiModelPayload(wifiModelId);\n+        String modelRoomWithWifi = TestAssetsHelper.getRoomWithWifiModelPayload(roomWithWifiModelId, wifiModelId, wifiComponentName);\n+        String roomWithWifiTwin = TestAssetsHelper.getRoomWithWifiTwinPayload(roomWithWifiModelId, wifiComponentName);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(modelWifi, modelRoomWithWifi));\n+\n+        try {\n+            // Create models and components to test the lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created models successfully\"))\n+                .verifyComplete();\n+\n+            StepVerifier.create(asyncClient.createOrReplaceDigitalTwinWithResponse(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bdabc9657d314abd2ed141eb98ce5542b2aa742"}, "originalPosition": 121}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMTA3Njgy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17075#pullrequestreview-522107682", "createdAt": "2020-11-02T23:38:12Z", "commit": {"oid": "4bdabc9657d314abd2ed141eb98ce5542b2aa742"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMzozODoxMlrOHsalQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMzozODoxMlrOHsalQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMzNDkxMg==", "bodyText": "in Java, shouldn't brace formatting be like } finally {, try {, and } catch {?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17075#discussion_r516334912", "createdAt": "2020-11-02T23:38:12Z", "author": {"login": "drwill-ms"}, "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/ComponentsAsyncTests.java", "diffHunk": "@@ -89,4 +92,153 @@ public void componentLifecycleTest(HttpClient httpClient, DigitalTwinsServiceVer\n             }\n         }\n     }\n+\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void patchComponentFailsIfETagDoesNotMatch(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion) throws JsonProcessingException {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String wifiComponentName = \"wifiAccessPoint\";\n+\n+        String roomWithWifiTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_WITH_WIFI_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String roomWithWifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_WITH_WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String wifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+\n+        String modelWifi = TestAssetsHelper.getWifiModelPayload(wifiModelId);\n+        String modelRoomWithWifi = TestAssetsHelper.getRoomWithWifiModelPayload(roomWithWifiModelId, wifiModelId, wifiComponentName);\n+        String roomWithWifiTwin = TestAssetsHelper.getRoomWithWifiTwinPayload(roomWithWifiModelId, wifiComponentName);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(modelWifi, modelRoomWithWifi));\n+\n+        try {\n+            // Create models and components to test the lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created models successfully\"))\n+                .verifyComplete();\n+\n+            AtomicReference<String> etagBeforeUpdate = new AtomicReference<>();\n+            StepVerifier.create(asyncClient.createOrReplaceDigitalTwinWithResponse(\n+                roomWithWifiTwinId,\n+                deserializeJsonString(roomWithWifiTwin, BasicDigitalTwin.class),\n+                BasicDigitalTwin.class,\n+                null))\n+                .assertNext(createdTwinResponse -> {\n+                    etagBeforeUpdate.set(createdTwinResponse.getDeserializedHeaders().getETag());\n+                })\n+                .verifyComplete();\n+\n+            StepVerifier.create(asyncClient.updateComponentWithResponse(roomWithWifiTwinId, wifiComponentName, TestAssetsHelper.getWifiComponentUpdatePayload(), null))\n+                .assertNext(updateResponse -> {\n+                    logger.info(\"Updated the component successfully\");\n+                })\n+                .verifyComplete();\n+\n+            // Update the component again, but with the out of date etag\n+            StepVerifier.create(\n+                asyncClient.updateComponentWithResponse(\n+                    roomWithWifiTwinId,\n+                    wifiComponentName,\n+                    TestAssetsHelper.getWifiComponentSecondUpdatePayload(),\n+                    new UpdateComponentOptions().setIfMatch(etagBeforeUpdate.get())))\n+                .verifyErrorSatisfies(ex -> assertRestException(ex, HttpURLConnection.HTTP_PRECON_FAILED));\n+        }\n+        finally {\n+            try\n+            {\n+                if (roomWithWifiTwinId != null)\n+                {\n+                    asyncClient.deleteDigitalTwin(roomWithWifiTwinId).block();\n+                }\n+                if (roomWithWifiModelId != null)\n+                {\n+                    asyncClient.deleteModel(roomWithWifiModelId).block();\n+                }\n+                if (wifiModelId != null)\n+                {\n+                    asyncClient.deleteModel(wifiModelId).block();\n+                }\n+            }\n+            catch (Exception ex)\n+            {\n+                fail(\"Test cleanup failed\", ex);\n+            }\n+        }\n+    }\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void patchComponentSucceedsIfETagMatches(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion) throws JsonProcessingException {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String wifiComponentName = \"wifiAccessPoint\";\n+\n+        String roomWithWifiTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_WITH_WIFI_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String roomWithWifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_WITH_WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String wifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+\n+        String modelWifi = TestAssetsHelper.getWifiModelPayload(wifiModelId);\n+        String modelRoomWithWifi = TestAssetsHelper.getRoomWithWifiModelPayload(roomWithWifiModelId, wifiModelId, wifiComponentName);\n+        String roomWithWifiTwin = TestAssetsHelper.getRoomWithWifiTwinPayload(roomWithWifiModelId, wifiComponentName);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(modelWifi, modelRoomWithWifi));\n+\n+        try {\n+            // Create models and components to test the lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created models successfully\"))\n+                .verifyComplete();\n+\n+            StepVerifier.create(asyncClient.createOrReplaceDigitalTwinWithResponse(\n+                roomWithWifiTwinId,\n+                deserializeJsonString(roomWithWifiTwin, BasicDigitalTwin.class),\n+                BasicDigitalTwin.class,\n+                null))\n+                .assertNext(createdTwinResponse -> {\n+                    logger.info(\"Updated the component successfully\");\n+                })\n+                .verifyComplete();\n+\n+            AtomicReference<String> upToDateETag = new AtomicReference<>();\n+            StepVerifier.create(asyncClient.updateComponentWithResponse(roomWithWifiTwinId, wifiComponentName, TestAssetsHelper.getWifiComponentUpdatePayload(), null))\n+                .assertNext(updateResponse -> {\n+                    upToDateETag.set(updateResponse.getDeserializedHeaders().getETag());\n+                    logger.info(\"Updated the component successfully\");\n+                })\n+                .verifyComplete();\n+\n+            // Update the component again, but with the out of date etag\n+            StepVerifier.create(\n+                asyncClient.updateComponentWithResponse(\n+                    roomWithWifiTwinId,\n+                    wifiComponentName,\n+                    TestAssetsHelper.getWifiComponentSecondUpdatePayload(),\n+                    new UpdateComponentOptions().setIfMatch(upToDateETag.get())))\n+                .assertNext(response -> { /* don't care as long as it is a success status code */ })\n+                .verifyComplete();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bdabc9657d314abd2ed141eb98ce5542b2aa742"}, "originalPosition": 148}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMTA4MzQz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17075#pullrequestreview-522108343", "createdAt": "2020-11-02T23:40:05Z", "commit": {"oid": "4bdabc9657d314abd2ed141eb98ce5542b2aa742"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMTI2MjIw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17075#pullrequestreview-522126220", "createdAt": "2020-11-03T00:32:13Z", "commit": {"oid": "4bdabc9657d314abd2ed141eb98ce5542b2aa742"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5787a50b286e3ed0cd79445473ad81318d324cd7", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5787a50b286e3ed0cd79445473ad81318d324cd7", "committedDate": "2020-11-03T17:16:22Z", "message": "fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a23aab0bdbbc8194b362dac9bf95e0d1e543cc03", "author": {"user": {"login": "timtay-microsoft", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a23aab0bdbbc8194b362dac9bf95e0d1e543cc03", "committedDate": "2020-11-03T17:18:48Z", "message": "fixup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 315, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}