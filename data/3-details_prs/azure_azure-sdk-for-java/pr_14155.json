{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MjY5NjMz", "number": 14155, "title": "Performance: Cache AccountConsitencylevel and maxReplicaSetSize", "bodyText": "Per request access to ConsistencyLevel and MaxReplicasize matierized from JSON\nFrom CPU profiles shown below:\nConnectionPolicy.getDefaultConsistencyLevel(0.5%)\ngetMaxReplicaSetSize(0.13%)", "createdAt": "2020-08-15T06:35:34Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14155", "merged": true, "mergeCommit": {"oid": "9b4d7b18824b99d774db9096fe6573c4bb8f6f5e"}, "closed": true, "closedAt": "2020-08-18T03:05:22Z", "author": {"login": "kirankumarkolli"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_DTkYAH2gAyNDY4MjY5NjMzOmJiZjVlODU4MTE5ZWRmZjVhYWNmNGExODZmZDUyOTI1MmNmMWQ3YjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_5IqtAH2gAyNDY4MjY5NjMzOmQ2NWMwN2YxOTFmMmIyOTNhNWViMWY1NjlmYzI4OWViNmU3OTBjNWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bbf5e858119edff5aacf4a186fd529252cf1d7b3", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bbf5e858119edff5aacf4a186fd529252cf1d7b3", "committedDate": "2020-08-15T06:34:24Z", "message": "Performance: Cache AccountConsitencylevel and maxReplicaSetSize\n\nPer request access to ConsistencyLevel and MaxReplicasize matierized from JSON\n\nFrom CPU profiles shown below:\n\tConnectionPolicy.getDefaultConsistencyLevel(0.5%)\n\tgetMaxReplicaSetSize(0.13%)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NjEyNDI4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14155#pullrequestreview-468612428", "createdAt": "2020-08-17T16:23:38Z", "commit": {"oid": "bbf5e858119edff5aacf4a186fd529252cf1d7b3"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNjoyMzozOVrOHBvyWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNjoyNjowOVrOHBv4TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5MzU2MQ==", "bodyText": "in the other places we don't call this \"cached\" to be consistency please rename to consistencyLevel\nplease see DocumentCollection as example.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14155#discussion_r471593561", "createdAt": "2020-08-17T16:23:39Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ConsistencyPolicy.java", "diffHunk": "@@ -129,4 +135,10 @@ public ConsistencyPolicy setMaxStalenessInterval(Duration maxStalenessInterval)\n         super.set(Constants.Properties.MAX_STALENESS_INTERVAL_IN_SECONDS, maxStalenessInterval.getSeconds());\n         return this;\n     }\n+\n+    /**\n+     * Assumption: all consistency mutations are through setDefaultConsistencyLevel only.\n+     * NOTE: If the underlying ObjectNode is mutated cache might be stale\n+     */\n+    private ConsistencyLevel cachedConsistencyLevel = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbf5e858119edff5aacf4a186fd529252cf1d7b3"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5NTA4NQ==", "bodyText": "please use the following instead:\nConsistencyLevel.fromServiceSerializedFormat(.)\nif the method is not accessible from this package use:\nBridgeInternal.fromServiceSerializedFormat()", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14155#discussion_r471595085", "createdAt": "2020-08-17T16:26:09Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ConsistencyPolicy.java", "diffHunk": "@@ -52,16 +52,21 @@ public ConsistencyPolicy(String jsonString) {\n      */\n     public ConsistencyLevel getDefaultConsistencyLevel() {\n \n-        ConsistencyLevel result = ConsistencyPolicy.DEFAULT_DEFAULT_CONSISTENCY_LEVEL;\n-        String consistencyLevelString = super.getString(Constants.Properties.DEFAULT_CONSISTENCY_LEVEL);\n-        try {\n-            result = ConsistencyLevel\n-                         .valueOf(CaseFormat.UPPER_CAMEL.to(CaseFormat.UPPER_UNDERSCORE, consistencyLevelString));\n-        } catch (IllegalArgumentException e) {\n-            // ignore the exception and return the default\n-            this.getLogger().warn(\"Unknown consistency level {}, value ignored.\", consistencyLevelString);\n+        if (this.cachedConsistencyLevel == null) {\n+            ConsistencyLevel result = ConsistencyPolicy.DEFAULT_DEFAULT_CONSISTENCY_LEVEL;\n+            String consistencyLevelString = super.getString(Constants.Properties.DEFAULT_CONSISTENCY_LEVEL);\n+            try {\n+                result = ConsistencyLevel\n+                    .valueOf(CaseFormat.UPPER_CAMEL.to(CaseFormat.UPPER_UNDERSCORE, consistencyLevelString));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbf5e858119edff5aacf4a186fd529252cf1d7b3"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0adcc7235bcdad4ce23b1806f5d7d6bf437b6fc", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f0adcc7235bcdad4ce23b1806f5d7d6bf437b6fc", "committedDate": "2020-08-17T18:52:56Z", "message": "Merge branch 'master' into users/kirankk/few_misc_perf_fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d742bf0231c616196b412d7b3cf954461637405b", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d742bf0231c616196b412d7b3cf954461637405b", "committedDate": "2020-08-17T18:57:03Z", "message": "Incorporating the comments feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NzU0ODM0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14155#pullrequestreview-468754834", "createdAt": "2020-08-17T18:58:12Z", "commit": {"oid": "d742bf0231c616196b412d7b3cf954461637405b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo1ODoxMlrOHB3Ezw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo1ODoxMlrOHB3Ezw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMjk3NQ==", "bodyText": "you don't need ConsistencyLeve.valueOf() here.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14155#discussion_r471712975", "createdAt": "2020-08-17T18:58:12Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ConsistencyPolicy.java", "diffHunk": "@@ -52,21 +53,21 @@ public ConsistencyPolicy(String jsonString) {\n      */\n     public ConsistencyLevel getDefaultConsistencyLevel() {\n \n-        if (this.cachedConsistencyLevel == null) {\n+        if (this.consistencyLevel == null) {\n             ConsistencyLevel result = ConsistencyPolicy.DEFAULT_DEFAULT_CONSISTENCY_LEVEL;\n             String consistencyLevelString = super.getString(Constants.Properties.DEFAULT_CONSISTENCY_LEVEL);\n             try {\n                 result = ConsistencyLevel\n-                    .valueOf(CaseFormat.UPPER_CAMEL.to(CaseFormat.UPPER_UNDERSCORE, consistencyLevelString));\n+                    .valueOf(BridgeInternal.fromServiceSerializedFormat(consistencyLevelString));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d742bf0231c616196b412d7b3cf954461637405b"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d65c07f191f2b293a5eb1f569fc289eb6e790c5c", "author": {"user": {"login": "kirankumarkolli", "name": "Kiran Kumar Kolli"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d65c07f191f2b293a5eb1f569fc289eb6e790c5c", "committedDate": "2020-08-17T21:17:22Z", "message": "Fixing the bugs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 399, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}