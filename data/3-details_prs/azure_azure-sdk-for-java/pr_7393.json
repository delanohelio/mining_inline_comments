{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMjc2MjUy", "number": 7393, "title": "write json serialization optimization", "bodyText": "the purpose of this PR is to improve json serialization in document write path:\n\nReduces multiple rounds of json serialization/deserialization to and from Document\nIf partition-key is provided in the request options, avoids deserializing the item to Document.\n\nnumbers for inserting 4000_000 documents against a collection with 1M throughput on Ubuntu with 16CPU cores.\nScenario 1:\nTotal time required for inserting 4_000_000 documents each with 1000 fields\n\n\n\n\npk passed as request option\npk extracted from document (require json deserialization)\n\n\n\n\ntotal time to insert 4M docs before this PR\n195 seconds\n186 seconds\n\n\ntotal time to insert 4M docs after this PR\n123 seconds\n130 seconds\n\n\n\nbenchmark invocation cmd:\njava -Xmx8g -Xms8g -Dcosmos.directModeProtocol=Tcp -Dazure.cosmos.directModeProtocol=Tcp -jar /home/moderakh/baseline.jar -serviceEndpoint https://XXX.documents.azure.com:443/ -masterKey YYY -databaseId testdb -collectionId testcol -consistencyLevel Eventual -concurrency 2000 -numberOfOperations 4000000 -operation WriteThroughput -connectionMode Direct -numberOfPreCreatedDocuments 2000 -documentDataFieldSize 1 -documentDataFieldCount 1000\nScenario2:\nTotal time required for inserting 4_000_000 documents each with 10 fields\n\n\n\n\npk passed as request option\npk extracted from document (require json deserialization)\n\n\n\n\ntotal time to insert 4M docs before this PR\n85 seconds\n85 seconds\n\n\ntotal time to insert 4M docs after this PR\n81 seconds\n85 seconds\n\n\n\nbenchmark invocation cmd:\njava -Xmx8g -Xms8g -Dcosmos.directModeProtocol=Tcp -Dazure.cosmos.directModeProtocol=Tcp -jar /home/moderakh/baseline.jar -serviceEndpoint https://XXX.documents.azure.com:443/ -masterKey YYY -databaseId testdb -collectionId testcol -consistencyLevel Eventual -concurrency 2000 -numberOfOperations 4000000 -operation WriteThroughput -connectionMode Direct -numberOfPreCreatedDocuments 2000 -documentDataFieldSize 1 -documentDataFieldCount 10", "createdAt": "2020-01-13T19:11:58Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7393", "merged": true, "mergeCommit": {"oid": "30cb3a85b67724227fcd179f89b6d8b86796a103"}, "closed": true, "closedAt": "2020-01-14T21:57:11Z", "author": {"login": "moderakh"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4wOKYAH2gAyMzYyMjc2MjUyOjI1MGU3MjVlNWMyNGE5Y2NjYjkxMDgwNDA5NWQ3YTU5NGIwMWRkZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6TZAngH2gAyMzYyMjc2MjUyOjc3NTFmM2M2NjkwYzQ2Njg1YTdlMGE1MjgzMWU5Mjc1NjRkZTJiYzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "250e725e5c24a9cccb910804095d7a594b01dde9", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/250e725e5c24a9cccb910804095d7a594b01dde9", "committedDate": "2020-01-09T20:45:36Z", "message": "point operation for non item resource avoid duplicate json serialization/deserialization on top of v2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62dad5b5635ea58389188e7366815ffee4ac46a4", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/62dad5b5635ea58389188e7366815ffee4ac46a4", "committedDate": "2020-01-09T22:27:24Z", "message": "fix database from json"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e7f410b0d7bc8ee2b9cb50efbbe089738544efc", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8e7f410b0d7bc8ee2b9cb50efbbe089738544efc", "committedDate": "2020-01-10T17:31:36Z", "message": "Merge branch 'feature/cosmos/v4' into users/moderakh/20200109-write-json-serialization-optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37d10e55ba606466a10af34c3bf6a0dfaf3070b0", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/37d10e55ba606466a10af34c3bf6a0dfaf3070b0", "committedDate": "2020-01-10T18:30:22Z", "message": "Merge branch 'feature/cosmos/v4' into users/moderakh/20200109-write-json-serialization-optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae6391196a33190488b607ce56c5ee37d0865602", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ae6391196a33190488b607ce56c5ee37d0865602", "committedDate": "2020-01-10T22:13:41Z", "message": "Merge branch 'feature/cosmos/v4' into users/moderakh/20200109-write-json-serialization-optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9849d66861bd3ca40f87fcd5d2a34e0930fa4dfb", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9849d66861bd3ca40f87fcd5d2a34e0930fa4dfb", "committedDate": "2020-01-10T23:07:46Z", "message": "use partition key in the option and don't re-serialize/de-serialize on write"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6167ab2fb9bac2a3c229aabf3b499dd6f923af5b", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6167ab2fb9bac2a3c229aabf3b499dd6f923af5b", "committedDate": "2020-01-13T19:09:46Z", "message": "optimize json serialization in write"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bd202476d718c335f06c0ab831bce1153e4c668", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2bd202476d718c335f06c0ab831bce1153e4c668", "committedDate": "2020-01-13T23:04:58Z", "message": "fix broken tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjY5NTMy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7393#pullrequestreview-342269532", "createdAt": "2020-01-14T03:07:21Z", "commit": {"oid": "2bd202476d718c335f06c0ab831bce1153e4c668"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMzowNzoyMVrOFdLD5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMzowNzoyMVrOFdLD5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEzNDI0NQ==", "bodyText": "unused imports, please remove them.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7393#discussion_r366134245", "createdAt": "2020-01-14T03:07:21Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosItemProperties.java", "diffHunk": "@@ -7,6 +7,8 @@\n import com.fasterxml.jackson.databind.ObjectMapper;\n \n import java.io.IOException;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bd202476d718c335f06c0ab831bce1153e4c668"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMzUzMTEy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7393#pullrequestreview-342353112", "createdAt": "2020-01-14T08:22:17Z", "commit": {"oid": "2bd202476d718c335f06c0ab831bce1153e4c668"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwODoyMjoxN1rOFdPLZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwODoyMjoxN1rOFdPLZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjIwMTcwMQ==", "bodyText": "Just for my understanding: Why is it modeled as string, isn't stream the right abstraction?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7393#discussion_r366201701", "createdAt": "2020-01-14T08:22:17Z", "author": {"login": "kirankumarkolli"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/BridgeInternal.java", "diffHunk": "@@ -52,6 +52,10 @@ public static Document documentFromObject(Object document, ObjectMapper mapper)\n         return Document.FromObject(document, mapper);\n     }\n \n+    public static String toJsonString(Object document, ObjectMapper mapper) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bd202476d718c335f06c0ab831bce1153e4c668"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7751f3c6690c46685a7e0a52831e927564de2bc7", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7751f3c6690c46685a7e0a52831e927564de2bc7", "committedDate": "2020-01-14T16:18:03Z", "message": "removed unused imports"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 503, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}