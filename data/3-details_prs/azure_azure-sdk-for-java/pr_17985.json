{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyODA0Nzcw", "number": 17985, "title": "check if index policy has changed on repo initialization and update if needed", "bodyText": "This is a fix for #17536", "createdAt": "2020-12-04T21:40:54Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985", "merged": true, "mergeCommit": {"oid": "f463b5ac03204117f6094db86a688d42539dffa6"}, "closed": true, "closedAt": "2021-01-04T21:01:45Z", "author": {"login": "Blackbaud-EricSlater"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdi-w6aAH2gAyNTMyODA0NzcwOjA4NjljNjQzODZlZmYwZmRjZmFmYjdmZjYwOGYxZjFhNzViNjhkYWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABds80AsgFqTU2MTM0MTY3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0869c64386eff0fdcfafb7ff608f1f1a75b68daa", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0869c64386eff0fdcfafb7ff608f1f1a75b68daa", "committedDate": "2020-12-04T21:38:12Z", "message": "check if index policy has changed on repo initialization and update if needed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzIzODIx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#pullrequestreview-545323821", "createdAt": "2020-12-04T21:53:42Z", "commit": {"oid": "0869c64386eff0fdcfafb7ff608f1f1a75b68daa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTo1Mzo0M1rOH_jgiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTo1Mzo0M1rOH_jgiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNDEwNQ==", "bodyText": "i wanted to go ahead and open this PR to start discussion of this line. The issue here is that the indexPolicy object retrieved from the server will not ever compare with the index policy that is contained in CosmosEntityInformation using .equals(). This is for a few reasons....\n1.) The IndexPolicy object only contains a few instance fields and the rest of the data is contained in the serialized version of the object that is contained internally. The version of indexPolicy that is within CosmosEntityInformation will never contain a serialized version of the object that is comparable to the one retrieved from the server due to all the metadata fields that are added to the serialized json by the server.\n2.) The version of the indexPolicy object in CosmosEntityInformation is created from the parameters provided by the annotation. However the annotation does not account for any of the implied state that is set in certain cases. For instance, if you apply the CosmosIndexingPolicy annotation with no parameters, then the default indexing policy will get applied to your container. The index policy object in CosmosEntityInformation will contain an empty list for the included and excluded fields in this case. The index policy object retrieved from the server will contain an included list with \"/\"  and an excluded list with \"/_etag/\".\nSince the way the index policy is updated is by doing a container replace, it seems like this check needs to be accurate as far as detecting if the index policy actually changed so that needless container replaces are not being done.\nThe only approach i can think of to do this is to account for all the discrepancies between these objects when comparing.\nCan you guys think of a better way of determining if an index policy update is needed?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r536404105", "createdAt": "2020-12-04T21:53:43Z", "author": {"login": "Blackbaud-EricSlater"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/repository/support/SimpleCosmosRepository.java", "diffHunk": "@@ -45,6 +46,32 @@ public SimpleCosmosRepository(CosmosEntityInformation<T, ID> metadata,\n         if (this.information.isAutoCreateContainer()) {\n             createContainerIfNotExists();\n         }\n+\n+        CosmosContainerProperties currentProperties = getContainerProperties();\n+        if (shouldUpdateIndexingPolicy(currentProperties)) {\n+            currentProperties.setIndexingPolicy(information.getIndexingPolicy());\n+            replaceContainerProperties(currentProperties);\n+        }\n+    }\n+\n+    private boolean shouldUpdateIndexingPolicy(CosmosContainerProperties currentProperties) {\n+        return currentProperties != null && !currentProperties.getIndexingPolicy().equals(information.getIndexingPolicy());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0869c64386eff0fdcfafb7ff608f1f1a75b68daa"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzI2MDg4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#pullrequestreview-545326088", "createdAt": "2020-12-04T21:58:15Z", "commit": {"oid": "0869c64386eff0fdcfafb7ff608f1f1a75b68daa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTo1ODoxNlrOH_ju6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTo1ODoxNlrOH_ju6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzc4Ng==", "bodyText": "This was necessary because the container replace method that is being used in azure-cosmos depends on the __self link being in the propertyBag. You can see below in SimpleCosmosRepository that I have to retrieve the CosmosContainerProperties from the server so that this field is contained in the properties bag. I cannot use one that i create myself using CosmosEntityInformation since it will not contain the __self link.\nSo, I retrieve CosmosContainerProperties from the server and then set the new indexing policy on it. This change makes it so that calling setIndexingPolicy updates that underlying json representation that is sent to the server. Without this is place, calling setIndexingPolicy() has no effect.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r536407786", "createdAt": "2020-12-04T21:58:16Z", "author": {"login": "Blackbaud-EricSlater"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/DocumentCollection.java", "diffHunk": "@@ -90,6 +90,7 @@ public void setIndexingPolicy(IndexingPolicy indexingPolicy) {\n         }\n \n         this.indexingPolicy = indexingPolicy;\n+        setProperty(this, Constants.Properties.INDEXING_POLICY, this.indexingPolicy);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0869c64386eff0fdcfafb7ff608f1f1a75b68daa"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c331d3bd08c9d39ec774573a30d4f94e8004e4c6", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c331d3bd08c9d39ec774573a30d4f94e8004e4c6", "committedDate": "2020-12-08T21:22:03Z", "message": "undo changes to DocumentCollection. CosmosContainerReplace test case to have stronger assertions. Fix checkstyle issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24af71b96a9d885b199b81cf89035d436b96ba42", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/24af71b96a9d885b199b81cf89035d436b96ba42", "committedDate": "2020-12-09T17:56:45Z", "message": "fix CosmosContainerTest and add integration test for updating index on startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bc6dd1df55a0922dda3cc3a367a6fbbcf9786e6", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5bc6dd1df55a0922dda3cc3a367a6fbbcf9786e6", "committedDate": "2020-12-09T18:18:54Z", "message": "add reactive support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NDg0MjI4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#pullrequestreview-548484228", "createdAt": "2020-12-09T18:33:44Z", "commit": {"oid": "5bc6dd1df55a0922dda3cc3a367a6fbbcf9786e6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxODozMzo0NFrOICjdOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxODozNDowMFrOICjd5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0ODk4Ng==", "bodyText": "header missing.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r539548986", "createdAt": "2020-12-09T18:33:44Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/domain/IndexPolicyEntity.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.azure.spring.data.cosmos.domain;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc6dd1df55a0922dda3cc3a367a6fbbcf9786e6"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0OTA2Nw==", "bodyText": "header missing.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r539549067", "createdAt": "2020-12-09T18:33:51Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/integration/IndexPolicyUpdateIT.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package com.azure.spring.data.cosmos.repository.integration;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc6dd1df55a0922dda3cc3a367a6fbbcf9786e6"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU0OTE1Nw==", "bodyText": "header missing.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r539549157", "createdAt": "2020-12-09T18:34:00Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos-test/src/test/java/com/azure/spring/data/cosmos/repository/integration/ReactiveIndexPolicyUpdateIT.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package com.azure.spring.data.cosmos.repository.integration;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bc6dd1df55a0922dda3cc3a367a6fbbcf9786e6"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c1683a8ac972697393d4e30a74ea0b3671cc20f", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6c1683a8ac972697393d4e30a74ea0b3671cc20f", "committedDate": "2020-12-09T19:15:40Z", "message": "fix checkstyle issues. Add headers to new files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "453e00043a5072869e3e3042b822d2c1462b9b6b", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/453e00043a5072869e3e3042b822d2c1462b9b6b", "committedDate": "2020-12-10T21:15:59Z", "message": "fix logic for determining if index policy has changed. implement equals in necessary classes. Add more test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6028b5483e486aef358ee6c9186eeb9aadb4bc11", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6028b5483e486aef358ee6c9186eeb9aadb4bc11", "committedDate": "2020-12-10T21:20:30Z", "message": "add missing header. remove unneeded repos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "273743a23a82354ab5c681e2667ac9fa569f2445", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/273743a23a82354ab5c681e2667ac9fa569f2445", "committedDate": "2020-12-10T21:22:01Z", "message": "remove unused autowire"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be5a0ed471457c5aa5af5e36b6acb73a3dc4c2c0", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/be5a0ed471457c5aa5af5e36b6acb73a3dc4c2c0", "committedDate": "2020-12-10T21:57:49Z", "message": "add missing javadoc and fi style issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d01b84aa05122ae31d295117002723afb776da34", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d01b84aa05122ae31d295117002723afb776da34", "committedDate": "2020-12-11T22:01:47Z", "message": "remove unused autowired client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjQ2OTA4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#pullrequestreview-550646908", "createdAt": "2020-12-11T23:39:34Z", "commit": {"oid": "d01b84aa05122ae31d295117002723afb776da34"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjU4MjMx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#pullrequestreview-550658231", "createdAt": "2020-12-12T00:13:40Z", "commit": {"oid": "d01b84aa05122ae31d295117002723afb776da34"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDoxMzo0MFrOIEXRgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDoxMzo0MFrOIEXRgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ0NjUyOQ==", "bodyText": "@Blackbaud-EricSlater - why do we need an instance here ?\nSince this is a stateless service, creating instance here is redundant in my opinion, thoughts ?\nIt will unnecessary create multiple instances of IndexPolicyCompareService, where in case of static method, all it needs is just the Class instance, which does not pose a risk of memory leak.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#discussion_r541446529", "createdAt": "2020-12-12T00:13:40Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/repository/support/IndexPolicyCompareService.java", "diffHunk": "@@ -0,0 +1,62 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.spring.data.cosmos.repository.support;\n+\n+import com.azure.cosmos.models.ExcludedPath;\n+import com.azure.cosmos.models.IncludedPath;\n+import com.azure.cosmos.models.IndexingPolicy;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Class for determining if the index policy currenlt applied to the container matches the index policy that is\n+ * specified on an entities' @CosmosIndexingPolicy annotation\n+ */\n+public class IndexPolicyCompareService {\n+\n+    public static boolean policyNeedsUpdate(IndexingPolicy existingPolicy, IndexingPolicy newPolicy) {\n+        return new IndexPolicyCompareService().needsUpdate(existingPolicy, newPolicy);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d01b84aa05122ae31d295117002723afb776da34"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50ae6fb2c3fef20b7cfea1760cf741e58ef18d6e", "author": {"user": {"login": "Blackbaud-EricSlater", "name": "Eric Slater"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/50ae6fb2c3fef20b7cfea1760cf741e58ef18d6e", "committedDate": "2020-12-15T20:04:54Z", "message": "make class fully static"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMzQxNjc4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17985#pullrequestreview-561341678", "createdAt": "2021-01-04T21:01:01Z", "commit": {"oid": "50ae6fb2c3fef20b7cfea1760cf741e58ef18d6e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1365, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}