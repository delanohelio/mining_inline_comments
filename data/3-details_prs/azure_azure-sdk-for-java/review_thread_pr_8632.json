{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyMjMyNjE3", "number": 8632, "reviewThreads": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNToyNTozNVrODl_xtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDo0NjowOFrODtwZuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTY4ODIzOnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk11/httpclient/Jdk11AsyncHttpClient.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNToyNTozNVrOFzMtBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwOTowMDowMFrOF_hysQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyOTgyOQ==", "bodyText": "@JonathanGiles I think this bug in JDK11 HttpClient may be a blocker for this HttpClient adoption. \"Date\" is a necessary header for many of the track2 libs, something we need to look into.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r389229829", "createdAt": "2020-03-07T05:25:35Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk11/httpclient/Jdk11AsyncHttpClient.java", "diffHunk": "@@ -6,57 +6,59 @@\n import com.azure.core.http.HttpClient;\n import com.azure.core.http.HttpHeader;\n import com.azure.core.http.HttpHeaders;\n-import com.azure.core.http.HttpMethod;\n import com.azure.core.http.HttpRequest;\n import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n import reactor.adapter.JdkFlowAdapter;\n import reactor.core.Exceptions;\n import reactor.core.publisher.Flux;\n import reactor.core.publisher.Mono;\n \n-import java.io.IOException;\n-import java.io.InputStream;\n import java.net.URISyntaxException;\n import java.nio.ByteBuffer;\n import java.nio.charset.Charset;\n-import java.util.concurrent.CompletableFuture;\n+import java.util.Collections;\n+import java.util.List;\n \n import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n import java.util.concurrent.Flow;\n \n import static java.net.http.HttpResponse.BodyHandlers.*;\n import static java.net.http.HttpRequest.BodyPublishers.*;\n-import static java.net.http.HttpResponse.BodyHandlers.ofInputStream;\n \n /**\n  * HttpClient implementation for the JDK 11 HttpClient.\n  */\n class Jdk11AsyncHttpClient implements HttpClient {\n     private final java.net.http.HttpClient jdk11HttpClient;\n \n-    private static final Mono<BodyPublisher> EMPTY_BODY_PUBLISHER_MONO = Mono.just(noBody());\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d2c4ef7b1bc8134a8360621e2d3ec64d783df88"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMDE4OQ==", "bodyText": "In that case we would only support this on JDK 12 and later, which is unfortunate.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r389230189", "createdAt": "2020-03-07T05:32:00Z", "author": {"login": "JonathanGiles"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk11/httpclient/Jdk11AsyncHttpClient.java", "diffHunk": "@@ -6,57 +6,59 @@\n import com.azure.core.http.HttpClient;\n import com.azure.core.http.HttpHeader;\n import com.azure.core.http.HttpHeaders;\n-import com.azure.core.http.HttpMethod;\n import com.azure.core.http.HttpRequest;\n import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n import reactor.adapter.JdkFlowAdapter;\n import reactor.core.Exceptions;\n import reactor.core.publisher.Flux;\n import reactor.core.publisher.Mono;\n \n-import java.io.IOException;\n-import java.io.InputStream;\n import java.net.URISyntaxException;\n import java.nio.ByteBuffer;\n import java.nio.charset.Charset;\n-import java.util.concurrent.CompletableFuture;\n+import java.util.Collections;\n+import java.util.List;\n \n import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n import java.util.concurrent.Flow;\n \n import static java.net.http.HttpResponse.BodyHandlers.*;\n import static java.net.http.HttpRequest.BodyPublishers.*;\n-import static java.net.http.HttpResponse.BodyHandlers.ofInputStream;\n \n /**\n  * HttpClient implementation for the JDK 11 HttpClient.\n  */\n class Jdk11AsyncHttpClient implements HttpClient {\n     private final java.net.http.HttpClient jdk11HttpClient;\n \n-    private static final Mono<BodyPublisher> EMPTY_BODY_PUBLISHER_MONO = Mono.just(noBody());\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyOTgyOQ=="}, "originalCommit": {"oid": "8d2c4ef7b1bc8134a8360621e2d3ec64d783df88"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1ODI1Nw==", "bodyText": "added necessary validation to log error in case this client is ever used with java_version <= 11.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402158257", "createdAt": "2020-04-02T09:00:00Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk11/httpclient/Jdk11AsyncHttpClient.java", "diffHunk": "@@ -6,57 +6,59 @@\n import com.azure.core.http.HttpClient;\n import com.azure.core.http.HttpHeader;\n import com.azure.core.http.HttpHeaders;\n-import com.azure.core.http.HttpMethod;\n import com.azure.core.http.HttpRequest;\n import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n import reactor.adapter.JdkFlowAdapter;\n import reactor.core.Exceptions;\n import reactor.core.publisher.Flux;\n import reactor.core.publisher.Mono;\n \n-import java.io.IOException;\n-import java.io.InputStream;\n import java.net.URISyntaxException;\n import java.nio.ByteBuffer;\n import java.nio.charset.Charset;\n-import java.util.concurrent.CompletableFuture;\n+import java.util.Collections;\n+import java.util.List;\n \n import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n import java.util.concurrent.Flow;\n \n import static java.net.http.HttpResponse.BodyHandlers.*;\n import static java.net.http.HttpRequest.BodyPublishers.*;\n-import static java.net.http.HttpResponse.BodyHandlers.ofInputStream;\n \n /**\n  * HttpClient implementation for the JDK 11 HttpClient.\n  */\n class Jdk11AsyncHttpClient implements HttpClient {\n     private final java.net.http.HttpClient jdk11HttpClient;\n \n-    private static final Mono<BodyPublisher> EMPTY_BODY_PUBLISHER_MONO = Mono.just(noBody());\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyOTgyOQ=="}, "originalCommit": {"oid": "8d2c4ef7b1bc8134a8360621e2d3ec64d783df88"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3OTUxMjM1OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/pom.xml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQyMTo1MjoxOVrOF9VdEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwODo1NzoxNVrOF_hryQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg1ODk2Mg==", "bodyText": "The name of the artifact and directory name don't match. Should this be azure-core-jdk11-httpclient? Also, since we have a known issue in JDK 11 not supporting Date, should this really only be used with jdk12 and named as such?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r399858962", "createdAt": "2020-03-29T21:52:19Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/pom.xml", "diffHunk": "@@ -0,0 +1,120 @@\n+<!--\n+  ~ Copyright (c) Microsoft Corporation. All rights reserved.\n+  ~ Licensed under the MIT License.\n+  -->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+  <parent>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-client-sdk-parent</artifactId>\n+    <version>1.7.0</version> <!-- {x-version-update;com.azure:azure-client-sdk-parent;current} -->\n+    <relativePath>../../../pom.client.xml</relativePath>\n+  </parent>\n+\n+  <groupId>com.azure</groupId>\n+  <artifactId>azure-core-http-jdk-httpclient</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk2MTUwOA==", "bodyText": "I initially named it jdk11 but moved away from that - I now want it all to just be jdk", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r399961508", "createdAt": "2020-03-30T06:50:44Z", "author": {"login": "JonathanGiles"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/pom.xml", "diffHunk": "@@ -0,0 +1,120 @@\n+<!--\n+  ~ Copyright (c) Microsoft Corporation. All rights reserved.\n+  ~ Licensed under the MIT License.\n+  -->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+  <parent>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-client-sdk-parent</artifactId>\n+    <version>1.7.0</version> <!-- {x-version-update;com.azure:azure-client-sdk-parent;current} -->\n+    <relativePath>../../../pom.client.xml</relativePath>\n+  </parent>\n+\n+  <groupId>com.azure</groupId>\n+  <artifactId>azure-core-http-jdk-httpclient</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg1ODk2Mg=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NjQ4OQ==", "bodyText": "removed the 11 from all places (dir, files, types, etc..).", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402156489", "createdAt": "2020-04-02T08:57:15Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/pom.xml", "diffHunk": "@@ -0,0 +1,120 @@\n+<!--\n+  ~ Copyright (c) Microsoft Corporation. All rights reserved.\n+  ~ Licensed under the MIT License.\n+  -->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+  <parent>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-client-sdk-parent</artifactId>\n+    <version>1.7.0</version> <!-- {x-version-update;com.azure:azure-client-sdk-parent;current} -->\n+    <relativePath>../../../pom.client.xml</relativePath>\n+  </parent>\n+\n+  <groupId>com.azure</groupId>\n+  <artifactId>azure-core-http-jdk-httpclient</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg1ODk2Mg=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3OTUyMTI3OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQyMjowMjowN1rOF9Vhhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwODo1NjozM1rOF_hp9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg2MDEwMg==", "bodyText": "Set this.disposed = true after diposing.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r399860102", "createdAt": "2020-03-29T22:02:07Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)\n+            \"expect\",\n+            \"from\",\n+            \"host\",\n+            \"upgrade\",\n+            \"via\",\n+            \"warning\"));\n+        JDK11_RESTRICTED_HEADERS = Collections.unmodifiableSet(treeSet);\n+    }\n+\n+    JdkAsyncHttpClient(java.net.http.HttpClient httpClient) {\n+        this.jdk11HttpClient = httpClient;\n+    }\n+\n+    @Override\n+    public Mono<HttpResponse> send(HttpRequest request) {\n+        return toJdk11HttpRequest(request)\n+            .flatMap(jdk11Request -> Mono.fromCompletionStage(jdk11HttpClient.sendAsync(jdk11Request, ofPublisher()))\n+                .map(innerResponse -> new Jdk11HttpResponse(request, innerResponse)));\n+    }\n+\n+    /**\n+     * Converts the given azure-core request to the JDK 11 HttpRequest type.\n+     *\n+     * @param request the azure-core request\n+     * @return the Mono emitting HttpRequest\n+     */\n+    private static Mono<java.net.http.HttpRequest> toJdk11HttpRequest(HttpRequest request) {\n+        return Mono.fromCallable(() -> {\n+            final java.net.http.HttpRequest.Builder builder = java.net.http.HttpRequest.newBuilder();\n+            try {\n+                builder.uri(request.getUrl().toURI());\n+            } catch (URISyntaxException e) {\n+                throw Exceptions.propagate(e);\n+            }\n+            final HttpHeaders headers = request.getHeaders();\n+            if (headers != null) {\n+                for (HttpHeader header : headers) {\n+                    final String headerName = header.getName();\n+                    if (!JDK11_RESTRICTED_HEADERS.contains(headerName)) {\n+                        final String headerValue = header.getValue();\n+                        builder.setHeader(headerName, headerValue);\n+                    }\n+                }\n+            }\n+            switch (request.getHttpMethod()) {\n+                case GET:\n+                    return builder.GET().build();\n+                case HEAD:\n+                    return builder.method(\"HEAD\", noBody()).build();\n+                default:\n+                    final String contentLength = request.getHeaders().getValue(\"content-length\");\n+                    final BodyPublisher bodyPublisher = toBodyPublisher(request.getBody(), contentLength);\n+                    return builder.method(request.getHttpMethod().toString(), bodyPublisher).build();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Create BodyPublisher from the given java.nio.ByteBuffer publisher.\n+     *\n+     * @param bbPublisher stream of java.nio.ByteBuffer representing request content\n+     * @return the BodyPublisher\n+     */\n+    private static BodyPublisher toBodyPublisher(Flux<ByteBuffer> bbPublisher, String contentLength) {\n+        if (bbPublisher == null) {\n+            return noBody();\n+        }\n+        final Flow.Publisher<ByteBuffer> bbFlowPublisher = JdkFlowAdapter.publisherToFlowPublisher(bbPublisher);\n+        if (CoreUtils.isNullOrEmpty(contentLength)) {\n+            return fromPublisher(bbFlowPublisher);\n+        } else {\n+            long contentLengthLong = Long.parseLong(contentLength);\n+            if (contentLengthLong < 1) {\n+                return fromPublisher(bbFlowPublisher);\n+            } else {\n+                return fromPublisher(bbFlowPublisher, contentLengthLong);\n+            }\n+        }\n+    }\n+\n+    private static class Jdk11HttpResponse extends HttpResponse {\n+        private final int statusCode;\n+        private final HttpHeaders headers;\n+        private final Flux<ByteBuffer> contentFlux;\n+        private volatile boolean disposed = false;\n+\n+        protected Jdk11HttpResponse(final HttpRequest request,\n+                                    java.net.http.HttpResponse<Flow.Publisher<List<ByteBuffer>>> innerResponse) {\n+            super(request);\n+            this.statusCode = innerResponse.statusCode();\n+            this.headers = fromJdk11HttpHeaders(innerResponse.headers());\n+            this.contentFlux = JdkFlowAdapter.flowPublisherToFlux(innerResponse.body())\n+                .flatMapSequential(Flux::fromIterable);\n+        }\n+\n+        @Override\n+        public int getStatusCode() {\n+            return this.statusCode;\n+        }\n+\n+        @Override\n+        public String getHeaderValue(String name) {\n+            return this.headers.getValue(name);\n+        }\n+\n+        @Override\n+        public HttpHeaders getHeaders() {\n+            return this.headers;\n+        }\n+\n+        @Override\n+        public Flux<ByteBuffer> getBody() {\n+            return this.contentFlux\n+                .doFinally(signalType -> disposed = true);\n+        }\n+\n+        @Override\n+        public Mono<byte[]> getBodyAsByteArray() {\n+            return FluxUtil.collectBytesInByteBufferStream(getBody())\n+                .flatMap(bytes -> bytes.length == 0 ? Mono.empty() : Mono.just(bytes));\n+        }\n+\n+        @Override\n+        public Mono<String> getBodyAsString() {\n+            return getBodyAsByteArray()\n+                .map(bytes -> new String(bytes));\n+        }\n+\n+        @Override\n+        public Mono<String> getBodyAsString(Charset charset) {\n+            return getBodyAsByteArray()\n+                .map(bytes -> new String(bytes, charset));\n+        }\n+\n+        @Override\n+        public void close() {\n+            if (!this.disposed) {\n+                this.contentFlux\n+                    .subscribe()\n+                    .dispose();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 183}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NjAyMQ==", "bodyText": "fixed.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402156021", "createdAt": "2020-04-02T08:56:33Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)\n+            \"expect\",\n+            \"from\",\n+            \"host\",\n+            \"upgrade\",\n+            \"via\",\n+            \"warning\"));\n+        JDK11_RESTRICTED_HEADERS = Collections.unmodifiableSet(treeSet);\n+    }\n+\n+    JdkAsyncHttpClient(java.net.http.HttpClient httpClient) {\n+        this.jdk11HttpClient = httpClient;\n+    }\n+\n+    @Override\n+    public Mono<HttpResponse> send(HttpRequest request) {\n+        return toJdk11HttpRequest(request)\n+            .flatMap(jdk11Request -> Mono.fromCompletionStage(jdk11HttpClient.sendAsync(jdk11Request, ofPublisher()))\n+                .map(innerResponse -> new Jdk11HttpResponse(request, innerResponse)));\n+    }\n+\n+    /**\n+     * Converts the given azure-core request to the JDK 11 HttpRequest type.\n+     *\n+     * @param request the azure-core request\n+     * @return the Mono emitting HttpRequest\n+     */\n+    private static Mono<java.net.http.HttpRequest> toJdk11HttpRequest(HttpRequest request) {\n+        return Mono.fromCallable(() -> {\n+            final java.net.http.HttpRequest.Builder builder = java.net.http.HttpRequest.newBuilder();\n+            try {\n+                builder.uri(request.getUrl().toURI());\n+            } catch (URISyntaxException e) {\n+                throw Exceptions.propagate(e);\n+            }\n+            final HttpHeaders headers = request.getHeaders();\n+            if (headers != null) {\n+                for (HttpHeader header : headers) {\n+                    final String headerName = header.getName();\n+                    if (!JDK11_RESTRICTED_HEADERS.contains(headerName)) {\n+                        final String headerValue = header.getValue();\n+                        builder.setHeader(headerName, headerValue);\n+                    }\n+                }\n+            }\n+            switch (request.getHttpMethod()) {\n+                case GET:\n+                    return builder.GET().build();\n+                case HEAD:\n+                    return builder.method(\"HEAD\", noBody()).build();\n+                default:\n+                    final String contentLength = request.getHeaders().getValue(\"content-length\");\n+                    final BodyPublisher bodyPublisher = toBodyPublisher(request.getBody(), contentLength);\n+                    return builder.method(request.getHttpMethod().toString(), bodyPublisher).build();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Create BodyPublisher from the given java.nio.ByteBuffer publisher.\n+     *\n+     * @param bbPublisher stream of java.nio.ByteBuffer representing request content\n+     * @return the BodyPublisher\n+     */\n+    private static BodyPublisher toBodyPublisher(Flux<ByteBuffer> bbPublisher, String contentLength) {\n+        if (bbPublisher == null) {\n+            return noBody();\n+        }\n+        final Flow.Publisher<ByteBuffer> bbFlowPublisher = JdkFlowAdapter.publisherToFlowPublisher(bbPublisher);\n+        if (CoreUtils.isNullOrEmpty(contentLength)) {\n+            return fromPublisher(bbFlowPublisher);\n+        } else {\n+            long contentLengthLong = Long.parseLong(contentLength);\n+            if (contentLengthLong < 1) {\n+                return fromPublisher(bbFlowPublisher);\n+            } else {\n+                return fromPublisher(bbFlowPublisher, contentLengthLong);\n+            }\n+        }\n+    }\n+\n+    private static class Jdk11HttpResponse extends HttpResponse {\n+        private final int statusCode;\n+        private final HttpHeaders headers;\n+        private final Flux<ByteBuffer> contentFlux;\n+        private volatile boolean disposed = false;\n+\n+        protected Jdk11HttpResponse(final HttpRequest request,\n+                                    java.net.http.HttpResponse<Flow.Publisher<List<ByteBuffer>>> innerResponse) {\n+            super(request);\n+            this.statusCode = innerResponse.statusCode();\n+            this.headers = fromJdk11HttpHeaders(innerResponse.headers());\n+            this.contentFlux = JdkFlowAdapter.flowPublisherToFlux(innerResponse.body())\n+                .flatMapSequential(Flux::fromIterable);\n+        }\n+\n+        @Override\n+        public int getStatusCode() {\n+            return this.statusCode;\n+        }\n+\n+        @Override\n+        public String getHeaderValue(String name) {\n+            return this.headers.getValue(name);\n+        }\n+\n+        @Override\n+        public HttpHeaders getHeaders() {\n+            return this.headers;\n+        }\n+\n+        @Override\n+        public Flux<ByteBuffer> getBody() {\n+            return this.contentFlux\n+                .doFinally(signalType -> disposed = true);\n+        }\n+\n+        @Override\n+        public Mono<byte[]> getBodyAsByteArray() {\n+            return FluxUtil.collectBytesInByteBufferStream(getBody())\n+                .flatMap(bytes -> bytes.length == 0 ? Mono.empty() : Mono.just(bytes));\n+        }\n+\n+        @Override\n+        public Mono<String> getBodyAsString() {\n+            return getBodyAsByteArray()\n+                .map(bytes -> new String(bytes));\n+        }\n+\n+        @Override\n+        public Mono<String> getBodyAsString(Charset charset) {\n+            return getBodyAsByteArray()\n+                .map(bytes -> new String(bytes, charset));\n+        }\n+\n+        @Override\n+        public void close() {\n+            if (!this.disposed) {\n+                this.contentFlux\n+                    .subscribe()\n+                    .dispose();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg2MDEwMg=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 183}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3OTUyOTIzOnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQyMjoxMDo1MlrOF9Vllw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxOToyMjozNlrOF_6Eqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg2MTE0Mw==", "bodyText": "If there are multiple values in java.net.http.HttpHeaders, instead of overwriting the value field here, we should have comma-separated values as recommended in the RFC", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r399861143", "createdAt": "2020-03-29T22:10:52Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)\n+            \"expect\",\n+            \"from\",\n+            \"host\",\n+            \"upgrade\",\n+            \"via\",\n+            \"warning\"));\n+        JDK11_RESTRICTED_HEADERS = Collections.unmodifiableSet(treeSet);\n+    }\n+\n+    JdkAsyncHttpClient(java.net.http.HttpClient httpClient) {\n+        this.jdk11HttpClient = httpClient;\n+    }\n+\n+    @Override\n+    public Mono<HttpResponse> send(HttpRequest request) {\n+        return toJdk11HttpRequest(request)\n+            .flatMap(jdk11Request -> Mono.fromCompletionStage(jdk11HttpClient.sendAsync(jdk11Request, ofPublisher()))\n+                .map(innerResponse -> new Jdk11HttpResponse(request, innerResponse)));\n+    }\n+\n+    /**\n+     * Converts the given azure-core request to the JDK 11 HttpRequest type.\n+     *\n+     * @param request the azure-core request\n+     * @return the Mono emitting HttpRequest\n+     */\n+    private static Mono<java.net.http.HttpRequest> toJdk11HttpRequest(HttpRequest request) {\n+        return Mono.fromCallable(() -> {\n+            final java.net.http.HttpRequest.Builder builder = java.net.http.HttpRequest.newBuilder();\n+            try {\n+                builder.uri(request.getUrl().toURI());\n+            } catch (URISyntaxException e) {\n+                throw Exceptions.propagate(e);\n+            }\n+            final HttpHeaders headers = request.getHeaders();\n+            if (headers != null) {\n+                for (HttpHeader header : headers) {\n+                    final String headerName = header.getName();\n+                    if (!JDK11_RESTRICTED_HEADERS.contains(headerName)) {\n+                        final String headerValue = header.getValue();\n+                        builder.setHeader(headerName, headerValue);\n+                    }\n+                }\n+            }\n+            switch (request.getHttpMethod()) {\n+                case GET:\n+                    return builder.GET().build();\n+                case HEAD:\n+                    return builder.method(\"HEAD\", noBody()).build();\n+                default:\n+                    final String contentLength = request.getHeaders().getValue(\"content-length\");\n+                    final BodyPublisher bodyPublisher = toBodyPublisher(request.getBody(), contentLength);\n+                    return builder.method(request.getHttpMethod().toString(), bodyPublisher).build();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Create BodyPublisher from the given java.nio.ByteBuffer publisher.\n+     *\n+     * @param bbPublisher stream of java.nio.ByteBuffer representing request content\n+     * @return the BodyPublisher\n+     */\n+    private static BodyPublisher toBodyPublisher(Flux<ByteBuffer> bbPublisher, String contentLength) {\n+        if (bbPublisher == null) {\n+            return noBody();\n+        }\n+        final Flow.Publisher<ByteBuffer> bbFlowPublisher = JdkFlowAdapter.publisherToFlowPublisher(bbPublisher);\n+        if (CoreUtils.isNullOrEmpty(contentLength)) {\n+            return fromPublisher(bbFlowPublisher);\n+        } else {\n+            long contentLengthLong = Long.parseLong(contentLength);\n+            if (contentLengthLong < 1) {\n+                return fromPublisher(bbFlowPublisher);\n+            } else {\n+                return fromPublisher(bbFlowPublisher, contentLengthLong);\n+            }\n+        }\n+    }\n+\n+    private static class Jdk11HttpResponse extends HttpResponse {\n+        private final int statusCode;\n+        private final HttpHeaders headers;\n+        private final Flux<ByteBuffer> contentFlux;\n+        private volatile boolean disposed = false;\n+\n+        protected Jdk11HttpResponse(final HttpRequest request,\n+                                    java.net.http.HttpResponse<Flow.Publisher<List<ByteBuffer>>> innerResponse) {\n+            super(request);\n+            this.statusCode = innerResponse.statusCode();\n+            this.headers = fromJdk11HttpHeaders(innerResponse.headers());\n+            this.contentFlux = JdkFlowAdapter.flowPublisherToFlux(innerResponse.body())\n+                .flatMapSequential(Flux::fromIterable);\n+        }\n+\n+        @Override\n+        public int getStatusCode() {\n+            return this.statusCode;\n+        }\n+\n+        @Override\n+        public String getHeaderValue(String name) {\n+            return this.headers.getValue(name);\n+        }\n+\n+        @Override\n+        public HttpHeaders getHeaders() {\n+            return this.headers;\n+        }\n+\n+        @Override\n+        public Flux<ByteBuffer> getBody() {\n+            return this.contentFlux\n+                .doFinally(signalType -> disposed = true);\n+        }\n+\n+        @Override\n+        public Mono<byte[]> getBodyAsByteArray() {\n+            return FluxUtil.collectBytesInByteBufferStream(getBody())\n+                .flatMap(bytes -> bytes.length == 0 ? Mono.empty() : Mono.just(bytes));\n+        }\n+\n+        @Override\n+        public Mono<String> getBodyAsString() {\n+            return getBodyAsByteArray()\n+                .map(bytes -> new String(bytes));\n+        }\n+\n+        @Override\n+        public Mono<String> getBodyAsString(Charset charset) {\n+            return getBodyAsByteArray()\n+                .map(bytes -> new String(bytes, charset));\n+        }\n+\n+        @Override\n+        public void close() {\n+            if (!this.disposed) {\n+                this.contentFlux\n+                    .subscribe()\n+                    .dispose();\n+            }\n+        }\n+\n+        private static HttpHeaders fromJdk11HttpHeaders(java.net.http.HttpHeaders headers) {\n+            final HttpHeaders httpHeaders = new HttpHeaders();\n+            for (final String key : headers.map().keySet()) {\n+                for (final String value : headers.allValues(key)) {\n+                    httpHeaders.put(key, value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 191}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU1NjA3NA==", "bodyText": "cool, updated to join multi-values using comma separator.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402556074", "createdAt": "2020-04-02T19:22:36Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)\n+            \"expect\",\n+            \"from\",\n+            \"host\",\n+            \"upgrade\",\n+            \"via\",\n+            \"warning\"));\n+        JDK11_RESTRICTED_HEADERS = Collections.unmodifiableSet(treeSet);\n+    }\n+\n+    JdkAsyncHttpClient(java.net.http.HttpClient httpClient) {\n+        this.jdk11HttpClient = httpClient;\n+    }\n+\n+    @Override\n+    public Mono<HttpResponse> send(HttpRequest request) {\n+        return toJdk11HttpRequest(request)\n+            .flatMap(jdk11Request -> Mono.fromCompletionStage(jdk11HttpClient.sendAsync(jdk11Request, ofPublisher()))\n+                .map(innerResponse -> new Jdk11HttpResponse(request, innerResponse)));\n+    }\n+\n+    /**\n+     * Converts the given azure-core request to the JDK 11 HttpRequest type.\n+     *\n+     * @param request the azure-core request\n+     * @return the Mono emitting HttpRequest\n+     */\n+    private static Mono<java.net.http.HttpRequest> toJdk11HttpRequest(HttpRequest request) {\n+        return Mono.fromCallable(() -> {\n+            final java.net.http.HttpRequest.Builder builder = java.net.http.HttpRequest.newBuilder();\n+            try {\n+                builder.uri(request.getUrl().toURI());\n+            } catch (URISyntaxException e) {\n+                throw Exceptions.propagate(e);\n+            }\n+            final HttpHeaders headers = request.getHeaders();\n+            if (headers != null) {\n+                for (HttpHeader header : headers) {\n+                    final String headerName = header.getName();\n+                    if (!JDK11_RESTRICTED_HEADERS.contains(headerName)) {\n+                        final String headerValue = header.getValue();\n+                        builder.setHeader(headerName, headerValue);\n+                    }\n+                }\n+            }\n+            switch (request.getHttpMethod()) {\n+                case GET:\n+                    return builder.GET().build();\n+                case HEAD:\n+                    return builder.method(\"HEAD\", noBody()).build();\n+                default:\n+                    final String contentLength = request.getHeaders().getValue(\"content-length\");\n+                    final BodyPublisher bodyPublisher = toBodyPublisher(request.getBody(), contentLength);\n+                    return builder.method(request.getHttpMethod().toString(), bodyPublisher).build();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Create BodyPublisher from the given java.nio.ByteBuffer publisher.\n+     *\n+     * @param bbPublisher stream of java.nio.ByteBuffer representing request content\n+     * @return the BodyPublisher\n+     */\n+    private static BodyPublisher toBodyPublisher(Flux<ByteBuffer> bbPublisher, String contentLength) {\n+        if (bbPublisher == null) {\n+            return noBody();\n+        }\n+        final Flow.Publisher<ByteBuffer> bbFlowPublisher = JdkFlowAdapter.publisherToFlowPublisher(bbPublisher);\n+        if (CoreUtils.isNullOrEmpty(contentLength)) {\n+            return fromPublisher(bbFlowPublisher);\n+        } else {\n+            long contentLengthLong = Long.parseLong(contentLength);\n+            if (contentLengthLong < 1) {\n+                return fromPublisher(bbFlowPublisher);\n+            } else {\n+                return fromPublisher(bbFlowPublisher, contentLengthLong);\n+            }\n+        }\n+    }\n+\n+    private static class Jdk11HttpResponse extends HttpResponse {\n+        private final int statusCode;\n+        private final HttpHeaders headers;\n+        private final Flux<ByteBuffer> contentFlux;\n+        private volatile boolean disposed = false;\n+\n+        protected Jdk11HttpResponse(final HttpRequest request,\n+                                    java.net.http.HttpResponse<Flow.Publisher<List<ByteBuffer>>> innerResponse) {\n+            super(request);\n+            this.statusCode = innerResponse.statusCode();\n+            this.headers = fromJdk11HttpHeaders(innerResponse.headers());\n+            this.contentFlux = JdkFlowAdapter.flowPublisherToFlux(innerResponse.body())\n+                .flatMapSequential(Flux::fromIterable);\n+        }\n+\n+        @Override\n+        public int getStatusCode() {\n+            return this.statusCode;\n+        }\n+\n+        @Override\n+        public String getHeaderValue(String name) {\n+            return this.headers.getValue(name);\n+        }\n+\n+        @Override\n+        public HttpHeaders getHeaders() {\n+            return this.headers;\n+        }\n+\n+        @Override\n+        public Flux<ByteBuffer> getBody() {\n+            return this.contentFlux\n+                .doFinally(signalType -> disposed = true);\n+        }\n+\n+        @Override\n+        public Mono<byte[]> getBodyAsByteArray() {\n+            return FluxUtil.collectBytesInByteBufferStream(getBody())\n+                .flatMap(bytes -> bytes.length == 0 ? Mono.empty() : Mono.just(bytes));\n+        }\n+\n+        @Override\n+        public Mono<String> getBodyAsString() {\n+            return getBodyAsByteArray()\n+                .map(bytes -> new String(bytes));\n+        }\n+\n+        @Override\n+        public Mono<String> getBodyAsString(Charset charset) {\n+            return getBodyAsByteArray()\n+                .map(bytes -> new String(bytes, charset));\n+        }\n+\n+        @Override\n+        public void close() {\n+            if (!this.disposed) {\n+                this.contentFlux\n+                    .subscribe()\n+                    .dispose();\n+            }\n+        }\n+\n+        private static HttpHeaders fromJdk11HttpHeaders(java.net.http.HttpHeaders headers) {\n+            final HttpHeaders httpHeaders = new HttpHeaders();\n+            for (final String key : headers.map().keySet()) {\n+                for (final String value : headers.allValues(key)) {\n+                    httpHeaders.put(key, value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg2MTE0Mw=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 191}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3OTU0OTQyOnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQyMjozMzo1MlrOF9VwAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwODo1NjoyMVrOF_hpdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg2MzgwOA==", "bodyText": "May want to log a warning here when we find a restricted header to let the user know that we skipped over some headers.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r399863808", "createdAt": "2020-03-29T22:33:52Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)\n+            \"expect\",\n+            \"from\",\n+            \"host\",\n+            \"upgrade\",\n+            \"via\",\n+            \"warning\"));\n+        JDK11_RESTRICTED_HEADERS = Collections.unmodifiableSet(treeSet);\n+    }\n+\n+    JdkAsyncHttpClient(java.net.http.HttpClient httpClient) {\n+        this.jdk11HttpClient = httpClient;\n+    }\n+\n+    @Override\n+    public Mono<HttpResponse> send(HttpRequest request) {\n+        return toJdk11HttpRequest(request)\n+            .flatMap(jdk11Request -> Mono.fromCompletionStage(jdk11HttpClient.sendAsync(jdk11Request, ofPublisher()))\n+                .map(innerResponse -> new Jdk11HttpResponse(request, innerResponse)));\n+    }\n+\n+    /**\n+     * Converts the given azure-core request to the JDK 11 HttpRequest type.\n+     *\n+     * @param request the azure-core request\n+     * @return the Mono emitting HttpRequest\n+     */\n+    private static Mono<java.net.http.HttpRequest> toJdk11HttpRequest(HttpRequest request) {\n+        return Mono.fromCallable(() -> {\n+            final java.net.http.HttpRequest.Builder builder = java.net.http.HttpRequest.newBuilder();\n+            try {\n+                builder.uri(request.getUrl().toURI());\n+            } catch (URISyntaxException e) {\n+                throw Exceptions.propagate(e);\n+            }\n+            final HttpHeaders headers = request.getHeaders();\n+            if (headers != null) {\n+                for (HttpHeader header : headers) {\n+                    final String headerName = header.getName();\n+                    if (!JDK11_RESTRICTED_HEADERS.contains(headerName)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NTg5Mw==", "bodyText": "yes, updated to log these as errors.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402155893", "createdAt": "2020-04-02T08:56:21Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)\n+            \"expect\",\n+            \"from\",\n+            \"host\",\n+            \"upgrade\",\n+            \"via\",\n+            \"warning\"));\n+        JDK11_RESTRICTED_HEADERS = Collections.unmodifiableSet(treeSet);\n+    }\n+\n+    JdkAsyncHttpClient(java.net.http.HttpClient httpClient) {\n+        this.jdk11HttpClient = httpClient;\n+    }\n+\n+    @Override\n+    public Mono<HttpResponse> send(HttpRequest request) {\n+        return toJdk11HttpRequest(request)\n+            .flatMap(jdk11Request -> Mono.fromCompletionStage(jdk11HttpClient.sendAsync(jdk11Request, ofPublisher()))\n+                .map(innerResponse -> new Jdk11HttpResponse(request, innerResponse)));\n+    }\n+\n+    /**\n+     * Converts the given azure-core request to the JDK 11 HttpRequest type.\n+     *\n+     * @param request the azure-core request\n+     * @return the Mono emitting HttpRequest\n+     */\n+    private static Mono<java.net.http.HttpRequest> toJdk11HttpRequest(HttpRequest request) {\n+        return Mono.fromCallable(() -> {\n+            final java.net.http.HttpRequest.Builder builder = java.net.http.HttpRequest.newBuilder();\n+            try {\n+                builder.uri(request.getUrl().toURI());\n+            } catch (URISyntaxException e) {\n+                throw Exceptions.propagate(e);\n+            }\n+            final HttpHeaders headers = request.getHeaders();\n+            if (headers != null) {\n+                for (HttpHeader header : headers) {\n+                    final String headerName = header.getName();\n+                    if (!JDK11_RESTRICTED_HEADERS.contains(headerName)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg2MzgwOA=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3OTU3MDg2OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/README.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQyMjo1Nzo0MVrOF9V6oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwODo1NTo0N1rOF_hoBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg2NjUyOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <version>1.1.0</version>\n          \n          \n            \n                <version>1.0.0-beta.1</version>", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r399866528", "createdAt": "2020-03-29T22:57:41Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/README.md", "diffHunk": "@@ -0,0 +1,68 @@\n+# Azure Core JDK HttpClient library for Java\n+\n+This is an azure-core HTTP client that makes use of the asynchronous HttpClient that was made generally available as \n+part of JDK 11. \n+\n+## Getting started\n+\n+### Prerequisites\n+\n+- Java Development Kit (JDK) with version 11 or above\n+\n+### Adding the package to your product\n+\n+[//]: # ({x-version-update-start;com.azure:azure-core-http-jdk-httpclient;current})\n+```xml\n+<dependency>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-core-http-jdk-httpclient</artifactId>\n+    <version>1.1.0</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NTUyNw==", "bodyText": "updated to 1.0.0-beta.1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402155527", "createdAt": "2020-04-02T08:55:47Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/README.md", "diffHunk": "@@ -0,0 +1,68 @@\n+# Azure Core JDK HttpClient library for Java\n+\n+This is an azure-core HTTP client that makes use of the asynchronous HttpClient that was made generally available as \n+part of JDK 11. \n+\n+## Getting started\n+\n+### Prerequisites\n+\n+- Java Development Kit (JDK) with version 11 or above\n+\n+### Adding the package to your product\n+\n+[//]: # ({x-version-update-start;com.azure:azure-core-http-jdk-httpclient;current})\n+```xml\n+<dependency>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-core-http-jdk-httpclient</artifactId>\n+    <version>1.1.0</version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg2NjUyOA=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjUxMjM3OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjoyMDoyMFrOF9xtsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjoyMDoyMFrOF9xtsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMyMTk2OA==", "bodyText": "* imports.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400321968", "createdAt": "2020-03-30T16:20:20Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjUyMDk2OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjoyMjoxNVrOF9xzCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwODo1NDozNlrOF_hlDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMyMzMzOA==", "bodyText": "How will this work for libraries which require fine tuning for these headers? In the case of Storage the upload could fail on a mismatch Content-Length header and shared key credential authentication will fail if the Date header is mismatch compared to what was used to generate the key.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400323338", "createdAt": "2020-03-30T16:22:15Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwMDY3Ng==", "bodyText": "If JDK httpClient supports completely disabling its header checks programmatically then that would be the easiest path. So far we didn't see that Netty/OkHttp blocking any headers.\nIf full disabling is not possible then we need to see if the native HTTP client has a programmatic way to white list subset of headers, if yes we can identify the headers that JDK blocks by default but required by our SDKs to function properly and white list them.\nYet to explore.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400600676", "createdAt": "2020-03-31T02:09:08Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMyMzMzOA=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NDc2Ng==", "bodyText": "Relaxed validations and added necessary log messages as agreed offline.\nRegarding the headers we care about:\nDate header is allowed from JDK12+\nContent-Length header will be set by JDK native HttpClient before sending out the requests.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402154766", "createdAt": "2020-04-02T08:54:36Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"date\", // BUG: Java11: https://bugs.openjdk.java.net/browse/JDK-8213189 (Fixed in JDK12)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMyMzMzOA=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjU2ODU5OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClientBuilder.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjozMzowN1rOF9yQUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzo0MjowMlrOF_e-Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMDgzMg==", "bodyText": "Would this handle digest authentication?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400330832", "createdAt": "2020-03-30T16:33:07Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClientBuilder.java", "diffHunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.ProxyOptions;\n+import com.azure.core.http.jdk.httpclient.implementation.JdkHttpClientProxySelector;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import java.net.Authenticator;\n+import java.net.PasswordAuthentication;\n+import java.net.Proxy;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.concurrent.Executor;\n+\n+/**\n+ * Builder to configure and build an instance of the azure-core {@link HttpClient} type using the JDK HttpClient APIs,\n+ * first introduced as preview in JDK 9, but made generally available from JDK 11 onwards.\n+ */\n+public class JdkAsyncHttpClientBuilder {\n+    private final ClientLogger logger = new ClientLogger(JdkAsyncHttpClientBuilder.class);\n+\n+    private static final Duration DEFAULT_CONNECT_TIMEOUT = Duration.ofSeconds(60);\n+\n+    private java.net.http.HttpClient.Builder httpClientBuilder;\n+    private Duration connectionTimeout;\n+    private ProxyOptions proxyOptions;\n+    private Configuration configuration;\n+    private Executor executor;\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder.\n+     */\n+    public JdkAsyncHttpClientBuilder() {\n+    }\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder from the builder of an existing {@link java.net.http.HttpClient.Builder}.\n+     *\n+     * @param httpClientBuilder the HttpClient builder to use\n+     */\n+    public JdkAsyncHttpClientBuilder(java.net.http.HttpClient.Builder httpClientBuilder) {\n+        this.httpClientBuilder = Objects.requireNonNull(httpClientBuilder, \"'httpClientBuilder' cannot be null.\");\n+    }\n+\n+    /**\n+     * Sets the executor to be used for asynchronous and dependent tasks. This cannot be null.\n+     *\n+     * <p> If this method is not invoked prior to {@linkplain #build() building}, a default executor is created for each\n+     * newly built {@code HttpClient}.\n+     *\n+     * @param executor the executor to be used for asynchronous and dependent tasks\n+     * @return the updated Jdk11AsyncHttpClientBuilder object\n+     */\n+    public JdkAsyncHttpClientBuilder executor(Executor executor) {\n+        this.executor = Objects.requireNonNull(executor, \"executor can not be null\");\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the connection timeout.\n+     *\n+     * The default connection timeout is 60 seconds.\n+     *\n+     * @param connectionTimeout the connection timeout\n+     * @return the updated JdkAsyncHttpClientBuilder object\n+     */\n+    public JdkAsyncHttpClientBuilder connectionTimeout(Duration connectionTimeout) {\n+        // setConnectionTimeout can be null\n+        this.connectionTimeout = connectionTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the proxy.\n+     *\n+     * <p><strong>Code Samples</strong></p>\n+     *\n+     * {@codesnippet com.azure.core.http.jdk.httpclient.JdkAsyncHttpClientBuilder.proxy#ProxyOptions}\n+     *\n+     * @param proxyOptions The proxy configuration to use.\n+     * @return the updated {@link JdkAsyncHttpClientBuilder} object\n+     */\n+    public JdkAsyncHttpClientBuilder proxy(ProxyOptions proxyOptions) {\n+        // proxyOptions can be null\n+        this.proxyOptions = proxyOptions;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the configuration store that is used during construction of the HTTP client.\n+     * <p>\n+     * The default configuration store is a clone of the {@link Configuration#getGlobalConfiguration() global\n+     * configuration store}, use {@link Configuration#NONE} to bypass using configuration settings during construction.\n+     *\n+     * @param configuration The configuration store used to\n+     * @return The updated JdkAsyncHttpClientBuilder object.\n+     */\n+    public JdkAsyncHttpClientBuilder configuration(Configuration configuration) {\n+        this.configuration = configuration;\n+        return this;\n+    }\n+\n+    /**\n+     * Build a HttpClient with current configurations.\n+     *\n+     * @return a {@link HttpClient}.\n+     */\n+    public HttpClient build() {\n+        java.net.http.HttpClient.Builder httpClientBuilder = this.httpClientBuilder == null\n+                     ? java.net.http.HttpClient.newBuilder()\n+                     : this.httpClientBuilder;\n+\n+        httpClientBuilder = (this.connectionTimeout != null)\n+            ? httpClientBuilder.connectTimeout(this.connectionTimeout)\n+            : httpClientBuilder.connectTimeout(DEFAULT_CONNECT_TIMEOUT);\n+\n+        Configuration buildConfiguration = (configuration == null)\n+            ? Configuration.getGlobalConfiguration()\n+            : configuration;\n+\n+        ProxyOptions buildProxyOptions = (proxyOptions == null && buildConfiguration != Configuration.NONE)\n+            ? ProxyOptions.fromConfiguration(buildConfiguration)\n+            : proxyOptions;\n+\n+        if (executor != null) {\n+            httpClientBuilder.executor(executor);\n+        }\n+\n+        if (buildProxyOptions != null) {\n+            httpClientBuilder = httpClientBuilder.proxy(new JdkHttpClientProxySelector(\n+                buildProxyOptions.getType().toProxyType(),\n+                buildProxyOptions.getAddress(),\n+                buildProxyOptions.getNonProxyHosts()));\n+\n+            if (buildProxyOptions.getUsername() != null) {\n+                httpClientBuilder.authenticator(new Authenticator() {\n+                    @Override\n+                    protected PasswordAuthentication getPasswordAuthentication() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5NTYyNQ==", "bodyText": "good question :) it won't. Is our current digest auth code just pluggable? or it's tailored per HTTP client? I haven't looked into that yet.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400595625", "createdAt": "2020-03-31T01:49:48Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClientBuilder.java", "diffHunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.ProxyOptions;\n+import com.azure.core.http.jdk.httpclient.implementation.JdkHttpClientProxySelector;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import java.net.Authenticator;\n+import java.net.PasswordAuthentication;\n+import java.net.Proxy;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.concurrent.Executor;\n+\n+/**\n+ * Builder to configure and build an instance of the azure-core {@link HttpClient} type using the JDK HttpClient APIs,\n+ * first introduced as preview in JDK 9, but made generally available from JDK 11 onwards.\n+ */\n+public class JdkAsyncHttpClientBuilder {\n+    private final ClientLogger logger = new ClientLogger(JdkAsyncHttpClientBuilder.class);\n+\n+    private static final Duration DEFAULT_CONNECT_TIMEOUT = Duration.ofSeconds(60);\n+\n+    private java.net.http.HttpClient.Builder httpClientBuilder;\n+    private Duration connectionTimeout;\n+    private ProxyOptions proxyOptions;\n+    private Configuration configuration;\n+    private Executor executor;\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder.\n+     */\n+    public JdkAsyncHttpClientBuilder() {\n+    }\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder from the builder of an existing {@link java.net.http.HttpClient.Builder}.\n+     *\n+     * @param httpClientBuilder the HttpClient builder to use\n+     */\n+    public JdkAsyncHttpClientBuilder(java.net.http.HttpClient.Builder httpClientBuilder) {\n+        this.httpClientBuilder = Objects.requireNonNull(httpClientBuilder, \"'httpClientBuilder' cannot be null.\");\n+    }\n+\n+    /**\n+     * Sets the executor to be used for asynchronous and dependent tasks. This cannot be null.\n+     *\n+     * <p> If this method is not invoked prior to {@linkplain #build() building}, a default executor is created for each\n+     * newly built {@code HttpClient}.\n+     *\n+     * @param executor the executor to be used for asynchronous and dependent tasks\n+     * @return the updated Jdk11AsyncHttpClientBuilder object\n+     */\n+    public JdkAsyncHttpClientBuilder executor(Executor executor) {\n+        this.executor = Objects.requireNonNull(executor, \"executor can not be null\");\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the connection timeout.\n+     *\n+     * The default connection timeout is 60 seconds.\n+     *\n+     * @param connectionTimeout the connection timeout\n+     * @return the updated JdkAsyncHttpClientBuilder object\n+     */\n+    public JdkAsyncHttpClientBuilder connectionTimeout(Duration connectionTimeout) {\n+        // setConnectionTimeout can be null\n+        this.connectionTimeout = connectionTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the proxy.\n+     *\n+     * <p><strong>Code Samples</strong></p>\n+     *\n+     * {@codesnippet com.azure.core.http.jdk.httpclient.JdkAsyncHttpClientBuilder.proxy#ProxyOptions}\n+     *\n+     * @param proxyOptions The proxy configuration to use.\n+     * @return the updated {@link JdkAsyncHttpClientBuilder} object\n+     */\n+    public JdkAsyncHttpClientBuilder proxy(ProxyOptions proxyOptions) {\n+        // proxyOptions can be null\n+        this.proxyOptions = proxyOptions;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the configuration store that is used during construction of the HTTP client.\n+     * <p>\n+     * The default configuration store is a clone of the {@link Configuration#getGlobalConfiguration() global\n+     * configuration store}, use {@link Configuration#NONE} to bypass using configuration settings during construction.\n+     *\n+     * @param configuration The configuration store used to\n+     * @return The updated JdkAsyncHttpClientBuilder object.\n+     */\n+    public JdkAsyncHttpClientBuilder configuration(Configuration configuration) {\n+        this.configuration = configuration;\n+        return this;\n+    }\n+\n+    /**\n+     * Build a HttpClient with current configurations.\n+     *\n+     * @return a {@link HttpClient}.\n+     */\n+    public HttpClient build() {\n+        java.net.http.HttpClient.Builder httpClientBuilder = this.httpClientBuilder == null\n+                     ? java.net.http.HttpClient.newBuilder()\n+                     : this.httpClientBuilder;\n+\n+        httpClientBuilder = (this.connectionTimeout != null)\n+            ? httpClientBuilder.connectTimeout(this.connectionTimeout)\n+            : httpClientBuilder.connectTimeout(DEFAULT_CONNECT_TIMEOUT);\n+\n+        Configuration buildConfiguration = (configuration == null)\n+            ? Configuration.getGlobalConfiguration()\n+            : configuration;\n+\n+        ProxyOptions buildProxyOptions = (proxyOptions == null && buildConfiguration != Configuration.NONE)\n+            ? ProxyOptions.fromConfiguration(buildConfiguration)\n+            : proxyOptions;\n+\n+        if (executor != null) {\n+            httpClientBuilder.executor(executor);\n+        }\n+\n+        if (buildProxyOptions != null) {\n+            httpClientBuilder = httpClientBuilder.proxy(new JdkHttpClientProxySelector(\n+                buildProxyOptions.getType().toProxyType(),\n+                buildProxyOptions.getAddress(),\n+                buildProxyOptions.getNonProxyHosts()));\n+\n+            if (buildProxyOptions.getUsername() != null) {\n+                httpClientBuilder.authenticator(new Authenticator() {\n+                    @Override\n+                    protected PasswordAuthentication getPasswordAuthentication() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMDgzMg=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExMjAxNA==", "bodyText": "digest-auth is on hold for now, like we discussed this will be picked up once we hear from native HTTP client owner.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402112014", "createdAt": "2020-04-02T07:42:02Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClientBuilder.java", "diffHunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.ProxyOptions;\n+import com.azure.core.http.jdk.httpclient.implementation.JdkHttpClientProxySelector;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import java.net.Authenticator;\n+import java.net.PasswordAuthentication;\n+import java.net.Proxy;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.concurrent.Executor;\n+\n+/**\n+ * Builder to configure and build an instance of the azure-core {@link HttpClient} type using the JDK HttpClient APIs,\n+ * first introduced as preview in JDK 9, but made generally available from JDK 11 onwards.\n+ */\n+public class JdkAsyncHttpClientBuilder {\n+    private final ClientLogger logger = new ClientLogger(JdkAsyncHttpClientBuilder.class);\n+\n+    private static final Duration DEFAULT_CONNECT_TIMEOUT = Duration.ofSeconds(60);\n+\n+    private java.net.http.HttpClient.Builder httpClientBuilder;\n+    private Duration connectionTimeout;\n+    private ProxyOptions proxyOptions;\n+    private Configuration configuration;\n+    private Executor executor;\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder.\n+     */\n+    public JdkAsyncHttpClientBuilder() {\n+    }\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder from the builder of an existing {@link java.net.http.HttpClient.Builder}.\n+     *\n+     * @param httpClientBuilder the HttpClient builder to use\n+     */\n+    public JdkAsyncHttpClientBuilder(java.net.http.HttpClient.Builder httpClientBuilder) {\n+        this.httpClientBuilder = Objects.requireNonNull(httpClientBuilder, \"'httpClientBuilder' cannot be null.\");\n+    }\n+\n+    /**\n+     * Sets the executor to be used for asynchronous and dependent tasks. This cannot be null.\n+     *\n+     * <p> If this method is not invoked prior to {@linkplain #build() building}, a default executor is created for each\n+     * newly built {@code HttpClient}.\n+     *\n+     * @param executor the executor to be used for asynchronous and dependent tasks\n+     * @return the updated Jdk11AsyncHttpClientBuilder object\n+     */\n+    public JdkAsyncHttpClientBuilder executor(Executor executor) {\n+        this.executor = Objects.requireNonNull(executor, \"executor can not be null\");\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the connection timeout.\n+     *\n+     * The default connection timeout is 60 seconds.\n+     *\n+     * @param connectionTimeout the connection timeout\n+     * @return the updated JdkAsyncHttpClientBuilder object\n+     */\n+    public JdkAsyncHttpClientBuilder connectionTimeout(Duration connectionTimeout) {\n+        // setConnectionTimeout can be null\n+        this.connectionTimeout = connectionTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the proxy.\n+     *\n+     * <p><strong>Code Samples</strong></p>\n+     *\n+     * {@codesnippet com.azure.core.http.jdk.httpclient.JdkAsyncHttpClientBuilder.proxy#ProxyOptions}\n+     *\n+     * @param proxyOptions The proxy configuration to use.\n+     * @return the updated {@link JdkAsyncHttpClientBuilder} object\n+     */\n+    public JdkAsyncHttpClientBuilder proxy(ProxyOptions proxyOptions) {\n+        // proxyOptions can be null\n+        this.proxyOptions = proxyOptions;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the configuration store that is used during construction of the HTTP client.\n+     * <p>\n+     * The default configuration store is a clone of the {@link Configuration#getGlobalConfiguration() global\n+     * configuration store}, use {@link Configuration#NONE} to bypass using configuration settings during construction.\n+     *\n+     * @param configuration The configuration store used to\n+     * @return The updated JdkAsyncHttpClientBuilder object.\n+     */\n+    public JdkAsyncHttpClientBuilder configuration(Configuration configuration) {\n+        this.configuration = configuration;\n+        return this;\n+    }\n+\n+    /**\n+     * Build a HttpClient with current configurations.\n+     *\n+     * @return a {@link HttpClient}.\n+     */\n+    public HttpClient build() {\n+        java.net.http.HttpClient.Builder httpClientBuilder = this.httpClientBuilder == null\n+                     ? java.net.http.HttpClient.newBuilder()\n+                     : this.httpClientBuilder;\n+\n+        httpClientBuilder = (this.connectionTimeout != null)\n+            ? httpClientBuilder.connectTimeout(this.connectionTimeout)\n+            : httpClientBuilder.connectTimeout(DEFAULT_CONNECT_TIMEOUT);\n+\n+        Configuration buildConfiguration = (configuration == null)\n+            ? Configuration.getGlobalConfiguration()\n+            : configuration;\n+\n+        ProxyOptions buildProxyOptions = (proxyOptions == null && buildConfiguration != Configuration.NONE)\n+            ? ProxyOptions.fromConfiguration(buildConfiguration)\n+            : proxyOptions;\n+\n+        if (executor != null) {\n+            httpClientBuilder.executor(executor);\n+        }\n+\n+        if (buildProxyOptions != null) {\n+            httpClientBuilder = httpClientBuilder.proxy(new JdkHttpClientProxySelector(\n+                buildProxyOptions.getType().toProxyType(),\n+                buildProxyOptions.getAddress(),\n+                buildProxyOptions.getNonProxyHosts()));\n+\n+            if (buildProxyOptions.getUsername() != null) {\n+                httpClientBuilder.authenticator(new Authenticator() {\n+                    @Override\n+                    protected PasswordAuthentication getPasswordAuthentication() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMDgzMg=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjU3Nzk0OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClientBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjozNToxNFrOF9yV6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjozNToxNFrOF9yV6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMjI2Ng==", "bodyText": "Add a @throws", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400332266", "createdAt": "2020-03-30T16:35:14Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClientBuilder.java", "diffHunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.ProxyOptions;\n+import com.azure.core.http.jdk.httpclient.implementation.JdkHttpClientProxySelector;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import java.net.Authenticator;\n+import java.net.PasswordAuthentication;\n+import java.net.Proxy;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.concurrent.Executor;\n+\n+/**\n+ * Builder to configure and build an instance of the azure-core {@link HttpClient} type using the JDK HttpClient APIs,\n+ * first introduced as preview in JDK 9, but made generally available from JDK 11 onwards.\n+ */\n+public class JdkAsyncHttpClientBuilder {\n+    private final ClientLogger logger = new ClientLogger(JdkAsyncHttpClientBuilder.class);\n+\n+    private static final Duration DEFAULT_CONNECT_TIMEOUT = Duration.ofSeconds(60);\n+\n+    private java.net.http.HttpClient.Builder httpClientBuilder;\n+    private Duration connectionTimeout;\n+    private ProxyOptions proxyOptions;\n+    private Configuration configuration;\n+    private Executor executor;\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder.\n+     */\n+    public JdkAsyncHttpClientBuilder() {\n+    }\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder from the builder of an existing {@link java.net.http.HttpClient.Builder}.\n+     *\n+     * @param httpClientBuilder the HttpClient builder to use", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjU3ODI1OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClientBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjozNToxOVrOF9yWGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjozNToxOVrOF9yWGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMjMxMw==", "bodyText": "Add a @throws", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400332313", "createdAt": "2020-03-30T16:35:19Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClientBuilder.java", "diffHunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.ProxyOptions;\n+import com.azure.core.http.jdk.httpclient.implementation.JdkHttpClientProxySelector;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import java.net.Authenticator;\n+import java.net.PasswordAuthentication;\n+import java.net.Proxy;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.concurrent.Executor;\n+\n+/**\n+ * Builder to configure and build an instance of the azure-core {@link HttpClient} type using the JDK HttpClient APIs,\n+ * first introduced as preview in JDK 9, but made generally available from JDK 11 onwards.\n+ */\n+public class JdkAsyncHttpClientBuilder {\n+    private final ClientLogger logger = new ClientLogger(JdkAsyncHttpClientBuilder.class);\n+\n+    private static final Duration DEFAULT_CONNECT_TIMEOUT = Duration.ofSeconds(60);\n+\n+    private java.net.http.HttpClient.Builder httpClientBuilder;\n+    private Duration connectionTimeout;\n+    private ProxyOptions proxyOptions;\n+    private Configuration configuration;\n+    private Executor executor;\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder.\n+     */\n+    public JdkAsyncHttpClientBuilder() {\n+    }\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder from the builder of an existing {@link java.net.http.HttpClient.Builder}.\n+     *\n+     * @param httpClientBuilder the HttpClient builder to use\n+     */\n+    public JdkAsyncHttpClientBuilder(java.net.http.HttpClient.Builder httpClientBuilder) {\n+        this.httpClientBuilder = Objects.requireNonNull(httpClientBuilder, \"'httpClientBuilder' cannot be null.\");\n+    }\n+\n+    /**\n+     * Sets the executor to be used for asynchronous and dependent tasks. This cannot be null.\n+     *\n+     * <p> If this method is not invoked prior to {@linkplain #build() building}, a default executor is created for each\n+     * newly built {@code HttpClient}.\n+     *\n+     * @param executor the executor to be used for asynchronous and dependent tasks\n+     * @return the updated Jdk11AsyncHttpClientBuilder object", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjU3OTIzOnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClientBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjozNTozM1rOF9yWvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxOToyMTo0MFrOF_6ClA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMjQ3OA==", "bodyText": "<p>", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400332478", "createdAt": "2020-03-30T16:35:33Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClientBuilder.java", "diffHunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.ProxyOptions;\n+import com.azure.core.http.jdk.httpclient.implementation.JdkHttpClientProxySelector;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import java.net.Authenticator;\n+import java.net.PasswordAuthentication;\n+import java.net.Proxy;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.concurrent.Executor;\n+\n+/**\n+ * Builder to configure and build an instance of the azure-core {@link HttpClient} type using the JDK HttpClient APIs,\n+ * first introduced as preview in JDK 9, but made generally available from JDK 11 onwards.\n+ */\n+public class JdkAsyncHttpClientBuilder {\n+    private final ClientLogger logger = new ClientLogger(JdkAsyncHttpClientBuilder.class);\n+\n+    private static final Duration DEFAULT_CONNECT_TIMEOUT = Duration.ofSeconds(60);\n+\n+    private java.net.http.HttpClient.Builder httpClientBuilder;\n+    private Duration connectionTimeout;\n+    private ProxyOptions proxyOptions;\n+    private Configuration configuration;\n+    private Executor executor;\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder.\n+     */\n+    public JdkAsyncHttpClientBuilder() {\n+    }\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder from the builder of an existing {@link java.net.http.HttpClient.Builder}.\n+     *\n+     * @param httpClientBuilder the HttpClient builder to use\n+     */\n+    public JdkAsyncHttpClientBuilder(java.net.http.HttpClient.Builder httpClientBuilder) {\n+        this.httpClientBuilder = Objects.requireNonNull(httpClientBuilder, \"'httpClientBuilder' cannot be null.\");\n+    }\n+\n+    /**\n+     * Sets the executor to be used for asynchronous and dependent tasks. This cannot be null.\n+     *\n+     * <p> If this method is not invoked prior to {@linkplain #build() building}, a default executor is created for each\n+     * newly built {@code HttpClient}.\n+     *\n+     * @param executor the executor to be used for asynchronous and dependent tasks\n+     * @return the updated Jdk11AsyncHttpClientBuilder object\n+     */\n+    public JdkAsyncHttpClientBuilder executor(Executor executor) {\n+        this.executor = Objects.requireNonNull(executor, \"executor can not be null\");\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the connection timeout.\n+     *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU1NTU0MA==", "bodyText": "good catch, added code snippet.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402555540", "createdAt": "2020-04-02T19:21:40Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClientBuilder.java", "diffHunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.ProxyOptions;\n+import com.azure.core.http.jdk.httpclient.implementation.JdkHttpClientProxySelector;\n+import com.azure.core.util.Configuration;\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import java.net.Authenticator;\n+import java.net.PasswordAuthentication;\n+import java.net.Proxy;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.concurrent.Executor;\n+\n+/**\n+ * Builder to configure and build an instance of the azure-core {@link HttpClient} type using the JDK HttpClient APIs,\n+ * first introduced as preview in JDK 9, but made generally available from JDK 11 onwards.\n+ */\n+public class JdkAsyncHttpClientBuilder {\n+    private final ClientLogger logger = new ClientLogger(JdkAsyncHttpClientBuilder.class);\n+\n+    private static final Duration DEFAULT_CONNECT_TIMEOUT = Duration.ofSeconds(60);\n+\n+    private java.net.http.HttpClient.Builder httpClientBuilder;\n+    private Duration connectionTimeout;\n+    private ProxyOptions proxyOptions;\n+    private Configuration configuration;\n+    private Executor executor;\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder.\n+     */\n+    public JdkAsyncHttpClientBuilder() {\n+    }\n+\n+    /**\n+     * Creates JdkAsyncHttpClientBuilder from the builder of an existing {@link java.net.http.HttpClient.Builder}.\n+     *\n+     * @param httpClientBuilder the HttpClient builder to use\n+     */\n+    public JdkAsyncHttpClientBuilder(java.net.http.HttpClient.Builder httpClientBuilder) {\n+        this.httpClientBuilder = Objects.requireNonNull(httpClientBuilder, \"'httpClientBuilder' cannot be null.\");\n+    }\n+\n+    /**\n+     * Sets the executor to be used for asynchronous and dependent tasks. This cannot be null.\n+     *\n+     * <p> If this method is not invoked prior to {@linkplain #build() building}, a default executor is created for each\n+     * newly built {@code HttpClient}.\n+     *\n+     * @param executor the executor to be used for asynchronous and dependent tasks\n+     * @return the updated Jdk11AsyncHttpClientBuilder object\n+     */\n+    public JdkAsyncHttpClientBuilder executor(Executor executor) {\n+        this.executor = Objects.requireNonNull(executor, \"executor can not be null\");\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the connection timeout.\n+     *", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMjQ3OA=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjU4MDg5OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/implementation/JdkHttpClientProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjozNjowMVrOF9yX5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjozNjowMVrOF9yX5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMjc3NA==", "bodyText": "Missing class level Javadoc", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400332774", "createdAt": "2020-03-30T16:36:01Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/implementation/JdkHttpClientProvider.java", "diffHunk": "@@ -0,0 +1,16 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient.implementation;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpClientProvider;\n+import com.azure.core.http.jdk.httpclient.JdkAsyncHttpClientBuilder;\n+\n+public class JdkHttpClientProvider implements HttpClientProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjU4MzE3OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/implementation/JdkHttpClientProxySelector.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjozNjozNVrOF9yZSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzozOTo1NlrOF_e5-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMzEyOA==", "bodyText": "Constructor Javadoc?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400333128", "createdAt": "2020-03-30T16:36:35Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/implementation/JdkHttpClientProxySelector.java", "diffHunk": "@@ -0,0 +1,46 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient.implementation;\n+\n+import java.io.IOException;\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+import java.net.URI;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * This class handles selecting the proxy during a request.\n+ */\n+public final class JdkHttpClientProxySelector extends ProxySelector {\n+    private final Proxy.Type proxyType;\n+    private final SocketAddress proxyAddress;\n+    private final Pattern nonProxyHostsPattern;\n+\n+    public JdkHttpClientProxySelector(Proxy.Type proxyType, SocketAddress proxyAddress, String nonProxyHosts) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExMDk3MA==", "bodyText": "It's an implementation package type but added minimal Javadoc for this.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402110970", "createdAt": "2020-04-02T07:39:56Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/implementation/JdkHttpClientProxySelector.java", "diffHunk": "@@ -0,0 +1,46 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient.implementation;\n+\n+import java.io.IOException;\n+import java.net.Proxy;\n+import java.net.ProxySelector;\n+import java.net.SocketAddress;\n+import java.net.URI;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * This class handles selecting the proxy during a request.\n+ */\n+public final class JdkHttpClientProxySelector extends ProxySelector {\n+    private final Proxy.Type proxyType;\n+    private final SocketAddress proxyAddress;\n+    private final Pattern nonProxyHostsPattern;\n+\n+    public JdkHttpClientProxySelector(Proxy.Type proxyType, SocketAddress proxyAddress, String nonProxyHosts) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMzEyOA=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjU4ODMyOnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjozNzo0OFrOF9ycfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzozNzowMlrOF_e0JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMzk0OA==", "bodyText": "Needs a version change", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400333948", "createdAt": "2020-03-30T16:37:48Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/pom.xml", "diffHunk": "@@ -0,0 +1,120 @@\n+<!--\n+  ~ Copyright (c) Microsoft Corporation. All rights reserved.\n+  ~ Licensed under the MIT License.\n+  -->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+  <parent>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-client-sdk-parent</artifactId>\n+    <version>1.7.0</version> <!-- {x-version-update;com.azure:azure-client-sdk-parent;current} -->\n+    <relativePath>../../../pom.client.xml</relativePath>\n+  </parent>\n+\n+  <groupId>com.azure</groupId>\n+  <artifactId>azure-core-http-jdk-httpclient</artifactId>\n+  <packaging>jar</packaging>\n+  <version>1.0.0-beta.1</version> <!-- {x-version-update;com.azure:azure-core-http-jdk-httpclient;current} -->\n+\n+  <name>Microsoft Azure JDK HTTP Client Library</name>\n+  <description>This package contains the Azure HTTP client library using the JDK HttpClient API.</description>\n+  <url>https://github.com/Azure/azure-sdk-for-java</url>\n+\n+  <licenses>\n+    <license>\n+      <name>The MIT License (MIT)</name>\n+      <url>http://opensource.org/licenses/MIT</url>\n+      <distribution>repo</distribution>\n+    </license>\n+  </licenses>\n+\n+  <distributionManagement>\n+    <site>\n+      <id>azure-java-build-docs</id>\n+      <url>${site.url}/site/${project.artifactId}</url>\n+    </site>\n+  </distributionManagement>\n+\n+  <scm>\n+    <url>https://github.com/Azure/azure-sdk-for-java</url>\n+    <connection>scm:git:https://github.com/Azure/azure-sdk-for-java.git</connection>\n+    <developerConnection>scm:git:https://github.com/Azure/azure-sdk-for-java.git</developerConnection>\n+  </scm>\n+\n+  <properties>\n+    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n+    <maven.compiler.source>11</maven.compiler.source>\n+    <maven.compiler.target>11</maven.compiler.target>\n+    <legal>\n+      <![CDATA[[INFO] Any downloads listed may be third party software.  Microsoft grants you no rights for third party software.]]></legal>\n+  </properties>\n+\n+  <developers>\n+    <developer>\n+      <id>microsoft</id>\n+      <name>Microsoft</name>\n+    </developer>\n+  </developers>\n+\n+  <dependencies>\n+    <dependency>\n+      <groupId>com.azure</groupId>\n+      <artifactId>azure-core</artifactId>\n+      <version>1.3.0-beta.2</version> <!-- {x-version-update;com.azure:azure-core;current} -->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEwOTQ3Nw==", "bodyText": "updated to the lastest azure-core.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402109477", "createdAt": "2020-04-02T07:37:02Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/pom.xml", "diffHunk": "@@ -0,0 +1,120 @@\n+<!--\n+  ~ Copyright (c) Microsoft Corporation. All rights reserved.\n+  ~ Licensed under the MIT License.\n+  -->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+  <parent>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-client-sdk-parent</artifactId>\n+    <version>1.7.0</version> <!-- {x-version-update;com.azure:azure-client-sdk-parent;current} -->\n+    <relativePath>../../../pom.client.xml</relativePath>\n+  </parent>\n+\n+  <groupId>com.azure</groupId>\n+  <artifactId>azure-core-http-jdk-httpclient</artifactId>\n+  <packaging>jar</packaging>\n+  <version>1.0.0-beta.1</version> <!-- {x-version-update;com.azure:azure-core-http-jdk-httpclient;current} -->\n+\n+  <name>Microsoft Azure JDK HTTP Client Library</name>\n+  <description>This package contains the Azure HTTP client library using the JDK HttpClient API.</description>\n+  <url>https://github.com/Azure/azure-sdk-for-java</url>\n+\n+  <licenses>\n+    <license>\n+      <name>The MIT License (MIT)</name>\n+      <url>http://opensource.org/licenses/MIT</url>\n+      <distribution>repo</distribution>\n+    </license>\n+  </licenses>\n+\n+  <distributionManagement>\n+    <site>\n+      <id>azure-java-build-docs</id>\n+      <url>${site.url}/site/${project.artifactId}</url>\n+    </site>\n+  </distributionManagement>\n+\n+  <scm>\n+    <url>https://github.com/Azure/azure-sdk-for-java</url>\n+    <connection>scm:git:https://github.com/Azure/azure-sdk-for-java.git</connection>\n+    <developerConnection>scm:git:https://github.com/Azure/azure-sdk-for-java.git</developerConnection>\n+  </scm>\n+\n+  <properties>\n+    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n+    <maven.compiler.source>11</maven.compiler.source>\n+    <maven.compiler.target>11</maven.compiler.target>\n+    <legal>\n+      <![CDATA[[INFO] Any downloads listed may be third party software.  Microsoft grants you no rights for third party software.]]></legal>\n+  </properties>\n+\n+  <developers>\n+    <developer>\n+      <id>microsoft</id>\n+      <name>Microsoft</name>\n+    </developer>\n+  </developers>\n+\n+  <dependencies>\n+    <dependency>\n+      <groupId>com.azure</groupId>\n+      <artifactId>azure-core</artifactId>\n+      <version>1.3.0-beta.2</version> <!-- {x-version-update;com.azure:azure-core;current} -->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzMzk0OA=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4Mzk0NDA2OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzoxMzo1OVrOF9_njA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzozNjozMlrOF_ezOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0OTc3Mg==", "bodyText": "This should be more flexible in its configuration, if someone is using Java 12+ and set the system property to allow restricted headers we should allow these headers.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400549772", "createdAt": "2020-03-30T23:13:59Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5NjcxNg==", "bodyText": "I added this initially to avoid JDK11 HttpClient native builder from throwing an exception. Thinking what would be the best approach here:\nMaybe we can copy over the same jdk11+ logic around the header whitelisting here or if the exception thrown by the JDK11+ HttpClient native builder has a special error code for disallowed headers then we can catch, log and continue.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r400596716", "createdAt": "2020-03-31T01:53:52Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0OTc3Mg=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEwOTI0MQ==", "bodyText": "Relaxed validations and added necessary log messages as agreed offline.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402109241", "createdAt": "2020-04-02T07:36:32Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.*;\n+import static java.net.http.HttpRequest.BodyPublishers.*;\n+\n+/**\n+ * HttpClient implementation for the JDK 11 HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final java.net.http.HttpClient jdk11HttpClient;\n+\n+    private static final Set<String> JDK11_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0OTc3Mg=="}, "originalCommit": {"oid": "32d147918ced47f684fc645ab0914bfe2277c988"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzA1NTI4OnYy", "diffSide": "RIGHT", "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDo0NjowOFrOF_Xl7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwODo1ODo1OFrOF_hwHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MTE1MQ==", "bodyText": "This could be made static right?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r401991151", "createdAt": "2020-04-02T00:46:08Z", "author": {"login": "alzimmermsft"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,253 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import com.azure.core.util.logging.ClientLogger;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.ofPublisher;\n+import static java.net.http.HttpRequest.BodyPublishers.fromPublisher;\n+import static java.net.http.HttpRequest.BodyPublishers.noBody;\n+\n+/**\n+ * HttpClient implementation for the JDK HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final ClientLogger logger = new ClientLogger(JdkAsyncHttpClient.class);\n+    private final java.net.http.HttpClient jdkHttpClient;\n+    private final int javaVersion;\n+\n+    // These headers are restricted by default in native JDK12 HttpClient.\n+    // These headers can be whitelisted by setting jdk.httpclient.allowRestrictedHeaders\n+    // property in the network properties file: 'JAVA_HOME/conf/net.properties'\n+    // e.g white listing 'host' header.\n+    //\n+    // jdk.httpclient.allowRestrictedHeaders=host\n+    //\n+    private static final Set<String> JDK12_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"expect\",\n+            \"host\",\n+            \"upgrade\"));\n+        JDK12_RESTRICTED_HEADERS = Collections.unmodifiableSet(treeSet);\n+    }\n+\n+    JdkAsyncHttpClient(java.net.http.HttpClient httpClient) {\n+        this.jdkHttpClient = httpClient;\n+        this.javaVersion = getJavaVersion();\n+        if (javaVersion <= 11) {\n+            logger.logExceptionAsError(\n+                new RuntimeException(\"JdkAsyncHttpClient is not supported in Java version 11 and below.\"));\n+        }\n+    }\n+\n+    @Override\n+    public Mono<HttpResponse> send(HttpRequest request) {\n+        return toJdkHttpRequest(request)\n+            .flatMap(jdkRequest -> Mono.fromCompletionStage(jdkHttpClient.sendAsync(jdkRequest, ofPublisher()))\n+                .map(innerResponse -> new JdkHttpResponse(request, innerResponse)));\n+    }\n+\n+    /**\n+     * Converts the given azure-core request to the JDK HttpRequest type.\n+     *\n+     * @param request the azure-core request\n+     * @return the Mono emitting HttpRequest\n+     */\n+    private Mono<java.net.http.HttpRequest> toJdkHttpRequest(HttpRequest request) {\n+        return Mono.fromCallable(() -> {\n+            final java.net.http.HttpRequest.Builder builder = java.net.http.HttpRequest.newBuilder();\n+            try {\n+                builder.uri(request.getUrl().toURI());\n+            } catch (URISyntaxException e) {\n+                throw Exceptions.propagate(e);\n+            }\n+            final HttpHeaders headers = request.getHeaders();\n+            if (headers != null) {\n+                for (HttpHeader header : headers) {\n+                    final String headerName = header.getName();\n+                    if (!JDK12_RESTRICTED_HEADERS.contains(headerName)) {\n+                        final String headerValue = header.getValue();\n+                        builder.setHeader(headerName, headerValue);\n+                    } else {\n+                        logger.logExceptionAsError(\n+                            new IllegalArgumentException(\"The header \" +\n+                                \"'\" + headerName + \"' is restricted by default in JDK HttpClient 12 and above.\" +\n+                                \"(unless it is whitelisted in JAVA_HOME/conf/net.properties)\"));\n+                    }\n+                }\n+            }\n+            switch (request.getHttpMethod()) {\n+                case GET:\n+                    return builder.GET().build();\n+                case HEAD:\n+                    return builder.method(\"HEAD\", noBody()).build();\n+                default:\n+                    final String contentLength = request.getHeaders().getValue(\"content-length\");\n+                    final BodyPublisher bodyPublisher = toBodyPublisher(request.getBody(), contentLength);\n+                    return builder.method(request.getHttpMethod().toString(), bodyPublisher).build();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Create BodyPublisher from the given java.nio.ByteBuffer publisher.\n+     *\n+     * @param bbPublisher stream of java.nio.ByteBuffer representing request content\n+     * @return the request BodyPublisher\n+     */\n+    private static BodyPublisher toBodyPublisher(Flux<ByteBuffer> bbPublisher, String contentLength) {\n+        if (bbPublisher == null) {\n+            return noBody();\n+        }\n+        final Flow.Publisher<ByteBuffer> bbFlowPublisher = JdkFlowAdapter.publisherToFlowPublisher(bbPublisher);\n+        if (CoreUtils.isNullOrEmpty(contentLength)) {\n+            return fromPublisher(bbFlowPublisher);\n+        } else {\n+            long contentLengthLong = Long.parseLong(contentLength);\n+            if (contentLengthLong < 1) {\n+                return fromPublisher(bbFlowPublisher);\n+            } else {\n+                return fromPublisher(bbFlowPublisher, contentLengthLong);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Get the java runtime major version.\n+     *\n+     * @return the java major version\n+     */\n+    private int getJavaVersion() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86ffa1ec7af769e303225cfd1b49335b99fbcc33"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MzExMA==", "bodyText": "could be, it uses instance-level logger, so static means we need to pass it.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r401993110", "createdAt": "2020-04-02T00:53:24Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,253 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import com.azure.core.util.logging.ClientLogger;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.ofPublisher;\n+import static java.net.http.HttpRequest.BodyPublishers.fromPublisher;\n+import static java.net.http.HttpRequest.BodyPublishers.noBody;\n+\n+/**\n+ * HttpClient implementation for the JDK HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final ClientLogger logger = new ClientLogger(JdkAsyncHttpClient.class);\n+    private final java.net.http.HttpClient jdkHttpClient;\n+    private final int javaVersion;\n+\n+    // These headers are restricted by default in native JDK12 HttpClient.\n+    // These headers can be whitelisted by setting jdk.httpclient.allowRestrictedHeaders\n+    // property in the network properties file: 'JAVA_HOME/conf/net.properties'\n+    // e.g white listing 'host' header.\n+    //\n+    // jdk.httpclient.allowRestrictedHeaders=host\n+    //\n+    private static final Set<String> JDK12_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"expect\",\n+            \"host\",\n+            \"upgrade\"));\n+        JDK12_RESTRICTED_HEADERS = Collections.unmodifiableSet(treeSet);\n+    }\n+\n+    JdkAsyncHttpClient(java.net.http.HttpClient httpClient) {\n+        this.jdkHttpClient = httpClient;\n+        this.javaVersion = getJavaVersion();\n+        if (javaVersion <= 11) {\n+            logger.logExceptionAsError(\n+                new RuntimeException(\"JdkAsyncHttpClient is not supported in Java version 11 and below.\"));\n+        }\n+    }\n+\n+    @Override\n+    public Mono<HttpResponse> send(HttpRequest request) {\n+        return toJdkHttpRequest(request)\n+            .flatMap(jdkRequest -> Mono.fromCompletionStage(jdkHttpClient.sendAsync(jdkRequest, ofPublisher()))\n+                .map(innerResponse -> new JdkHttpResponse(request, innerResponse)));\n+    }\n+\n+    /**\n+     * Converts the given azure-core request to the JDK HttpRequest type.\n+     *\n+     * @param request the azure-core request\n+     * @return the Mono emitting HttpRequest\n+     */\n+    private Mono<java.net.http.HttpRequest> toJdkHttpRequest(HttpRequest request) {\n+        return Mono.fromCallable(() -> {\n+            final java.net.http.HttpRequest.Builder builder = java.net.http.HttpRequest.newBuilder();\n+            try {\n+                builder.uri(request.getUrl().toURI());\n+            } catch (URISyntaxException e) {\n+                throw Exceptions.propagate(e);\n+            }\n+            final HttpHeaders headers = request.getHeaders();\n+            if (headers != null) {\n+                for (HttpHeader header : headers) {\n+                    final String headerName = header.getName();\n+                    if (!JDK12_RESTRICTED_HEADERS.contains(headerName)) {\n+                        final String headerValue = header.getValue();\n+                        builder.setHeader(headerName, headerValue);\n+                    } else {\n+                        logger.logExceptionAsError(\n+                            new IllegalArgumentException(\"The header \" +\n+                                \"'\" + headerName + \"' is restricted by default in JDK HttpClient 12 and above.\" +\n+                                \"(unless it is whitelisted in JAVA_HOME/conf/net.properties)\"));\n+                    }\n+                }\n+            }\n+            switch (request.getHttpMethod()) {\n+                case GET:\n+                    return builder.GET().build();\n+                case HEAD:\n+                    return builder.method(\"HEAD\", noBody()).build();\n+                default:\n+                    final String contentLength = request.getHeaders().getValue(\"content-length\");\n+                    final BodyPublisher bodyPublisher = toBodyPublisher(request.getBody(), contentLength);\n+                    return builder.method(request.getHttpMethod().toString(), bodyPublisher).build();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Create BodyPublisher from the given java.nio.ByteBuffer publisher.\n+     *\n+     * @param bbPublisher stream of java.nio.ByteBuffer representing request content\n+     * @return the request BodyPublisher\n+     */\n+    private static BodyPublisher toBodyPublisher(Flux<ByteBuffer> bbPublisher, String contentLength) {\n+        if (bbPublisher == null) {\n+            return noBody();\n+        }\n+        final Flow.Publisher<ByteBuffer> bbFlowPublisher = JdkFlowAdapter.publisherToFlowPublisher(bbPublisher);\n+        if (CoreUtils.isNullOrEmpty(contentLength)) {\n+            return fromPublisher(bbFlowPublisher);\n+        } else {\n+            long contentLengthLong = Long.parseLong(contentLength);\n+            if (contentLengthLong < 1) {\n+                return fromPublisher(bbFlowPublisher);\n+            } else {\n+                return fromPublisher(bbFlowPublisher, contentLengthLong);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Get the java runtime major version.\n+     *\n+     * @return the java major version\n+     */\n+    private int getJavaVersion() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MTE1MQ=="}, "originalCommit": {"oid": "86ffa1ec7af769e303225cfd1b49335b99fbcc33"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NzU5OQ==", "bodyText": "going with a private instance-level method, Can be static if we ever move this method to utils.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8632#discussion_r402157599", "createdAt": "2020-04-02T08:58:58Z", "author": {"login": "anuchandy"}, "path": "sdk/core/azure-core-http-jdk11-httpclient/src/main/java/com/azure/core/http/jdk/httpclient/JdkAsyncHttpClient.java", "diffHunk": "@@ -0,0 +1,253 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.jdk.httpclient;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.http.HttpHeader;\n+import com.azure.core.http.HttpHeaders;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.http.HttpResponse;\n+import com.azure.core.util.CoreUtils;\n+import com.azure.core.util.FluxUtil;\n+import com.azure.core.util.logging.ClientLogger;\n+import reactor.adapter.JdkFlowAdapter;\n+import reactor.core.Exceptions;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+import java.nio.charset.Charset;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import java.net.http.HttpRequest.BodyPublisher;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.concurrent.Flow;\n+\n+import static java.net.http.HttpResponse.BodyHandlers.ofPublisher;\n+import static java.net.http.HttpRequest.BodyPublishers.fromPublisher;\n+import static java.net.http.HttpRequest.BodyPublishers.noBody;\n+\n+/**\n+ * HttpClient implementation for the JDK HttpClient.\n+ */\n+class JdkAsyncHttpClient implements HttpClient {\n+    private final ClientLogger logger = new ClientLogger(JdkAsyncHttpClient.class);\n+    private final java.net.http.HttpClient jdkHttpClient;\n+    private final int javaVersion;\n+\n+    // These headers are restricted by default in native JDK12 HttpClient.\n+    // These headers can be whitelisted by setting jdk.httpclient.allowRestrictedHeaders\n+    // property in the network properties file: 'JAVA_HOME/conf/net.properties'\n+    // e.g white listing 'host' header.\n+    //\n+    // jdk.httpclient.allowRestrictedHeaders=host\n+    //\n+    private static final Set<String> JDK12_RESTRICTED_HEADERS;\n+    static {\n+        TreeSet<String> treeSet = new TreeSet<>(String.CASE_INSENSITIVE_ORDER);\n+        treeSet.addAll(Set.of(\"connection\",\n+            \"content-length\",\n+            \"expect\",\n+            \"host\",\n+            \"upgrade\"));\n+        JDK12_RESTRICTED_HEADERS = Collections.unmodifiableSet(treeSet);\n+    }\n+\n+    JdkAsyncHttpClient(java.net.http.HttpClient httpClient) {\n+        this.jdkHttpClient = httpClient;\n+        this.javaVersion = getJavaVersion();\n+        if (javaVersion <= 11) {\n+            logger.logExceptionAsError(\n+                new RuntimeException(\"JdkAsyncHttpClient is not supported in Java version 11 and below.\"));\n+        }\n+    }\n+\n+    @Override\n+    public Mono<HttpResponse> send(HttpRequest request) {\n+        return toJdkHttpRequest(request)\n+            .flatMap(jdkRequest -> Mono.fromCompletionStage(jdkHttpClient.sendAsync(jdkRequest, ofPublisher()))\n+                .map(innerResponse -> new JdkHttpResponse(request, innerResponse)));\n+    }\n+\n+    /**\n+     * Converts the given azure-core request to the JDK HttpRequest type.\n+     *\n+     * @param request the azure-core request\n+     * @return the Mono emitting HttpRequest\n+     */\n+    private Mono<java.net.http.HttpRequest> toJdkHttpRequest(HttpRequest request) {\n+        return Mono.fromCallable(() -> {\n+            final java.net.http.HttpRequest.Builder builder = java.net.http.HttpRequest.newBuilder();\n+            try {\n+                builder.uri(request.getUrl().toURI());\n+            } catch (URISyntaxException e) {\n+                throw Exceptions.propagate(e);\n+            }\n+            final HttpHeaders headers = request.getHeaders();\n+            if (headers != null) {\n+                for (HttpHeader header : headers) {\n+                    final String headerName = header.getName();\n+                    if (!JDK12_RESTRICTED_HEADERS.contains(headerName)) {\n+                        final String headerValue = header.getValue();\n+                        builder.setHeader(headerName, headerValue);\n+                    } else {\n+                        logger.logExceptionAsError(\n+                            new IllegalArgumentException(\"The header \" +\n+                                \"'\" + headerName + \"' is restricted by default in JDK HttpClient 12 and above.\" +\n+                                \"(unless it is whitelisted in JAVA_HOME/conf/net.properties)\"));\n+                    }\n+                }\n+            }\n+            switch (request.getHttpMethod()) {\n+                case GET:\n+                    return builder.GET().build();\n+                case HEAD:\n+                    return builder.method(\"HEAD\", noBody()).build();\n+                default:\n+                    final String contentLength = request.getHeaders().getValue(\"content-length\");\n+                    final BodyPublisher bodyPublisher = toBodyPublisher(request.getBody(), contentLength);\n+                    return builder.method(request.getHttpMethod().toString(), bodyPublisher).build();\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Create BodyPublisher from the given java.nio.ByteBuffer publisher.\n+     *\n+     * @param bbPublisher stream of java.nio.ByteBuffer representing request content\n+     * @return the request BodyPublisher\n+     */\n+    private static BodyPublisher toBodyPublisher(Flux<ByteBuffer> bbPublisher, String contentLength) {\n+        if (bbPublisher == null) {\n+            return noBody();\n+        }\n+        final Flow.Publisher<ByteBuffer> bbFlowPublisher = JdkFlowAdapter.publisherToFlowPublisher(bbPublisher);\n+        if (CoreUtils.isNullOrEmpty(contentLength)) {\n+            return fromPublisher(bbFlowPublisher);\n+        } else {\n+            long contentLengthLong = Long.parseLong(contentLength);\n+            if (contentLengthLong < 1) {\n+                return fromPublisher(bbFlowPublisher);\n+            } else {\n+                return fromPublisher(bbFlowPublisher, contentLengthLong);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Get the java runtime major version.\n+     *\n+     * @return the java major version\n+     */\n+    private int getJavaVersion() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MTE1MQ=="}, "originalCommit": {"oid": "86ffa1ec7af769e303225cfd1b49335b99fbcc33"}, "originalPosition": 146}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 293, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}