{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMzEyNTc5", "number": 7336, "title": "Continue to use same .receive() method on disconnection", "bodyText": "Adds AmqpReceiveLinkProcessor to fetch new links when one dies.\nFixes logging for ActiveToken provider to give the resource rather than a full scope\n\nFixes #7273", "createdAt": "2020-01-10T07:25:32Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7336", "merged": true, "mergeCommit": {"oid": "379dddf5fbadd2d8db5b0d7e9352649be67a271c"}, "closed": true, "closedAt": "2020-01-14T09:23:23Z", "author": {"login": "conniey"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4-WK0gFqTM0MTE0MjQyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6MgkJAH2gAyMzYxMzEyNTc5OjJhOWFhN2I3NjE4MDdkOTIzZmJmNTMyMjRlYTAxNWRlMGI2MTkxN2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMTQyNDIx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7336#pullrequestreview-341142421", "createdAt": "2020-01-10T12:51:30Z", "commit": {"oid": "437b1bc4484829d8e9402394b409090d20252182"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxMjo1MTozMFrOFcTOeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxMzowMjo0NVrOFcTdnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIxOTQ1MA==", "bodyText": "getScopesFromResource() might be a better name for this method?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7336#discussion_r365219450", "createdAt": "2020-01-10T12:51:30Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/AzureTokenManagerProvider.java", "diffHunk": "@@ -47,7 +47,7 @@ public TokenManager getTokenManager(Mono<ClaimsBasedSecurityNode> cbsNodeMono, S\n         final String scopes = getResourceString(resource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437b1bc4484829d8e9402394b409090d20252182"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIyMzMyNQ==", "bodyText": "Would it be more efficient if we just kept track of offset (long value) and convert to EventPosition only when the link goes down to restore the link? It prevents creating a lot of EventPosition objects.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7336#discussion_r365223325", "createdAt": "2020-01-10T13:02:45Z", "author": {"login": "srnagar"}, "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubPartitionAsyncConsumer.java", "diffHunk": "@@ -3,127 +3,68 @@\n \n package com.azure.messaging.eventhubs;\n \n-import com.azure.core.amqp.implementation.AmqpReceiveLink;\n import com.azure.core.amqp.implementation.MessageSerializer;\n import com.azure.core.util.logging.ClientLogger;\n+import com.azure.messaging.eventhubs.implementation.AmqpReceiveLinkProcessor;\n+import com.azure.messaging.eventhubs.models.EventPosition;\n import com.azure.messaging.eventhubs.models.LastEnqueuedEventProperties;\n import com.azure.messaging.eventhubs.models.PartitionContext;\n import com.azure.messaging.eventhubs.models.PartitionEvent;\n import com.azure.messaging.eventhubs.models.ReceiveOptions;\n import org.apache.qpid.proton.message.Message;\n import reactor.core.publisher.EmitterProcessor;\n import reactor.core.publisher.Flux;\n-import reactor.core.publisher.Mono;\n \n import java.util.concurrent.atomic.AtomicBoolean;\n-import java.util.concurrent.atomic.AtomicInteger;\n import java.util.concurrent.atomic.AtomicReference;\n-import java.util.concurrent.atomic.AtomicReferenceFieldUpdater;\n \n /**\n  * A package-private consumer responsible for reading {@link EventData} from a specific Event Hub partition in the\n  * context of a specific consumer group.\n  */\n class EventHubPartitionAsyncConsumer implements AutoCloseable {\n-    private static final AtomicReferenceFieldUpdater<EventHubPartitionAsyncConsumer, AmqpReceiveLink>\n-        RECEIVE_LINK_FIELD_UPDATER = AtomicReferenceFieldUpdater.newUpdater(\n-        EventHubPartitionAsyncConsumer.class, AmqpReceiveLink.class, \"receiveLink\");\n-\n-    // We don't want to dump too many credits on the link at once. It's easy enough to ask for more.\n-    private static final int MINIMUM_REQUEST = 0;\n-    private static final int MAXIMUM_REQUEST = 100;\n-\n-    private final AtomicInteger creditsToRequest = new AtomicInteger(1);\n+    private final ClientLogger logger = new ClientLogger(EventHubPartitionAsyncConsumer.class);\n     private final AtomicBoolean isDisposed = new AtomicBoolean();\n     private final AtomicReference<LastEnqueuedEventProperties> lastEnqueuedEventProperties = new AtomicReference<>();\n-    private final ClientLogger logger = new ClientLogger(EventHubPartitionAsyncConsumer.class);\n+    private final AmqpReceiveLinkProcessor amqpReceiveLinkProcessor;\n     private final MessageSerializer messageSerializer;\n     private final String fullyQualifiedNamespace;\n     private final String eventHubName;\n     private final String consumerGroup;\n     private final String partitionId;\n-    private final EmitterProcessor<PartitionEvent> emitterProcessor;\n-    private final Flux<PartitionEvent> messageFlux;\n     private final boolean trackLastEnqueuedEventProperties;\n+    private final EmitterProcessor<PartitionEvent> emitterProcessor;\n \n-    private volatile AmqpReceiveLink receiveLink;\n-\n-    EventHubPartitionAsyncConsumer(Mono<AmqpReceiveLink> receiveLinkMono, MessageSerializer messageSerializer,\n-        String fullyQualifiedNamespace, String eventHubName, String consumerGroup, String partitionId,\n-        int prefetchCount, boolean trackLastEnqueuedEventProperties) {\n+    EventHubPartitionAsyncConsumer(AmqpReceiveLinkProcessor amqpReceiveLinkProcessor,\n+        MessageSerializer messageSerializer, String fullyQualifiedNamespace, String eventHubName, String consumerGroup,\n+        String partitionId, AtomicReference<EventPosition> currentEventPosition,\n+        boolean trackLastEnqueuedEventProperties) {\n+        this.amqpReceiveLinkProcessor = amqpReceiveLinkProcessor;\n         this.messageSerializer = messageSerializer;\n         this.fullyQualifiedNamespace = fullyQualifiedNamespace;\n         this.eventHubName = eventHubName;\n         this.consumerGroup = consumerGroup;\n         this.partitionId = partitionId;\n-        this.emitterProcessor = EmitterProcessor.create(prefetchCount, false);\n+        this.emitterProcessor = amqpReceiveLinkProcessor\n+            .map(message -> onMessageReceived(message))\n+            .doOnNext(event -> {\n+                // Keep track of the last position so if the link goes down, we don't start from the original location.\n+                final Long offset = event.getData().getOffset();\n+                if (offset != null) {\n+                    currentEventPosition.set(EventPosition.fromOffset(offset));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437b1bc4484829d8e9402394b409090d20252182"}, "originalPosition": 74}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00e9c9a04913bc634394cfd38b2f0cb26a60cce6", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/00e9c9a04913bc634394cfd38b2f0cb26a60cce6", "committedDate": "2020-01-13T07:26:51Z", "message": "Adding tests."}, "afterCommit": {"oid": "d6458e56013b1cbd7936ced5da04c044f8c7a6e2", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d6458e56013b1cbd7936ced5da04c044f8c7a6e2", "committedDate": "2020-01-14T00:16:41Z", "message": "Update to getScopeFromResource."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9dc952aef45e18fb7473ad5af2c00aa3e947ec2", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a9dc952aef45e18fb7473ad5af2c00aa3e947ec2", "committedDate": "2020-01-14T08:07:53Z", "message": "Fix logging."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f22186723a7f88049751570ee2fe335115ac5f3", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5f22186723a7f88049751570ee2fe335115ac5f3", "committedDate": "2020-01-14T08:07:54Z", "message": " Adds AmqpChannelProcessor and test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85cb4e11e2afe6751260b96672664260ebeaf602", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/85cb4e11e2afe6751260b96672664260ebeaf602", "committedDate": "2020-01-14T08:07:55Z", "message": "Delete AmqpChannelProcessor and test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d57f3c7a3ffd22a672525ba6153b1cece4f0aa06", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d57f3c7a3ffd22a672525ba6153b1cece4f0aa06", "committedDate": "2020-01-14T08:07:56Z", "message": "Add AmqpLinkMessageProcessor and partition async consumer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c270855749fcf3cc4e62f7f02f79e256c812218", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7c270855749fcf3cc4e62f7f02f79e256c812218", "committedDate": "2020-01-14T08:07:56Z", "message": "Add AmqpReceiveLinkProcessor and test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "659a481862ffb50dd6663f1d4d8887a1347ed233", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/659a481862ffb50dd6663f1d4d8887a1347ed233", "committedDate": "2020-01-14T08:07:57Z", "message": "Connect AMQP link processor to EventHubConsumer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ff212d4e383424d1bd24497ccc4f4f0315d47e9", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6ff212d4e383424d1bd24497ccc4f4f0315d47e9", "committedDate": "2020-01-14T08:07:58Z", "message": "Adding tests for EventHubPartitionAsyncConsumer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc8c78c08d27f679f6748c2911f5e61c145ab948", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bc8c78c08d27f679f6748c2911f5e61c145ab948", "committedDate": "2020-01-14T08:07:59Z", "message": "Enabling tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "943d8b3a7d5cf53ba4cadad1b2b3b781bbb1b5d4", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/943d8b3a7d5cf53ba4cadad1b2b3b781bbb1b5d4", "committedDate": "2020-01-14T08:08:00Z", "message": "Add support for updating link position."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41952343efb726c9625d65aacf45da25c7ae8b6e", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/41952343efb726c9625d65aacf45da25c7ae8b6e", "committedDate": "2020-01-14T08:08:01Z", "message": "Fix assertions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "004f413cbc6c3e2240fc06ab394bbfaedb9c3d72", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/004f413cbc6c3e2240fc06ab394bbfaedb9c3d72", "committedDate": "2020-01-14T08:08:02Z", "message": "Update test with receive."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c902645988570f9a84a22cc6579021dbb7036ae2", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c902645988570f9a84a22cc6579021dbb7036ae2", "committedDate": "2020-01-14T08:08:02Z", "message": "Remove all public modifiers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b869fff63588464167d796daea27554d380921b9", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b869fff63588464167d796daea27554d380921b9", "committedDate": "2020-01-14T08:08:03Z", "message": "Fix bug where we're constantly asking for more connections."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61d596548ed689b07152d98dfb3a2ca22b79c129", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/61d596548ed689b07152d98dfb3a2ca22b79c129", "committedDate": "2020-01-14T08:08:04Z", "message": "Fixing integration tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11f7ce3dbc19ade91198627d61d1298a11435106", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/11f7ce3dbc19ade91198627d61d1298a11435106", "committedDate": "2020-01-14T08:08:05Z", "message": "Fixing checkstyle issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cb3e06f85c1f8561a31ea8ddcd12dfadd1035d2", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1cb3e06f85c1f8561a31ea8ddcd12dfadd1035d2", "committedDate": "2020-01-14T08:08:06Z", "message": "Pass Supplier for EventPosition."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f58df9f4a6f7b51565b572ccf1e6178b71fe698a", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f58df9f4a6f7b51565b572ccf1e6178b71fe698a", "committedDate": "2020-01-14T08:08:07Z", "message": "Adding tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9774305afb8746a8919d7edbc96c5f0828f45b9a", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9774305afb8746a8919d7edbc96c5f0828f45b9a", "committedDate": "2020-01-14T08:08:08Z", "message": "Request another link on link closure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94180976e455e88f32eb1e6ce7a15482180452ef", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/94180976e455e88f32eb1e6ce7a15482180452ef", "committedDate": "2020-01-14T08:08:08Z", "message": "Fix tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d9ce08ca09dd6967a9ed06d791bfe30738f82f7", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9d9ce08ca09dd6967a9ed06d791bfe30738f82f7", "committedDate": "2020-01-14T08:08:09Z", "message": "When EndpointState == closed, also close the link."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9849d1bf362f769dcb356dcce0a2fb15470d65f7", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9849d1bf362f769dcb356dcce0a2fb15470d65f7", "committedDate": "2020-01-14T08:08:10Z", "message": "Fix tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3716892fa94191f1c07f7cced8cc6726a7a6bdb3", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3716892fa94191f1c07f7cced8cc6726a7a6bdb3", "committedDate": "2020-01-14T08:08:11Z", "message": "Fix test errors."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df5dbfd9fad5c04b6c1bb99667ebe679d3ed9dcd", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/df5dbfd9fad5c04b6c1bb99667ebe679d3ed9dcd", "committedDate": "2020-01-14T08:08:12Z", "message": "Update to getScopeFromResource."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b347611ff371f01e043d7bf2e3c477a107f5f710", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b347611ff371f01e043d7bf2e3c477a107f5f710", "committedDate": "2020-01-14T08:08:13Z", "message": "Update RetryUtil to log more information."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c559a876677bb73b62a94729658fa73e91f1b8f5", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c559a876677bb73b62a94729658fa73e91f1b8f5", "committedDate": "2020-01-14T08:08:14Z", "message": "Fix test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17e7e261cd48a9e8ac393def33e0868842cf3ba2", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/17e7e261cd48a9e8ac393def33e0868842cf3ba2", "committedDate": "2020-01-14T08:08:14Z", "message": "Adding ReactorConnection to handle transient errors."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d9ebf16da9a524382160f9c797156121a23a753", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9d9ebf16da9a524382160f9c797156121a23a753", "committedDate": "2020-01-14T08:08:15Z", "message": "Passing reference to parent connection for disposed."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3b5ddc03e6e9dec9b380333b5bd3756564e47ee", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b3b5ddc03e6e9dec9b380333b5bd3756564e47ee", "committedDate": "2020-01-14T07:59:32Z", "message": "Passing reference to parent connection for disposed."}, "afterCommit": {"oid": "9d9ebf16da9a524382160f9c797156121a23a753", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9d9ebf16da9a524382160f9c797156121a23a753", "committedDate": "2020-01-14T08:08:15Z", "message": "Passing reference to parent connection for disposed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a9aa7b761807d923fbf53224ea015de0b61917f", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2a9aa7b761807d923fbf53224ea015de0b61917f", "committedDate": "2020-01-14T08:16:58Z", "message": "Fixing message."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 613, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}