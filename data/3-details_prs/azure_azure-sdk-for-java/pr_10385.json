{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2Mzk5NDM3", "number": 10385, "title": "Adding support for completing messages on receiver link. Moving logic out of azure-core-amqp. Adding more status codes", "bodyText": "Service Bus changes\n\nSettles (abandon, complete, defer, dead-letter) messages on the receive link rather than always going to the management node\nVarious fixes in fetching a named session.\nMove ManagementLockContainer out of receive link. These are only kept updated by messages received from management link\n\nMakes lock container an expiring set. (Adapted from .NET implementation.)\n\n\n\nazure-core-amqp changes\n\nMoves translation of management responses into their respective services.\n\nEvent Hubs translates RequestResponse messages differently than Service Bus does. Which makes the logic in azure-core-amqp very complex\n\n\nCleans up the endpoint status management\nAdds flexibility for translation of AMQP error codes, instead of throwing an IllegalArgumetnException. They are an expandable set.\nAdding missing AmqpResponseCodes. The ones taken from Event Hubs are incomplete.\n\nTests\n\nChanges in Event Hubs was tested by running live integration tests.\nAdds tests for azure-core-amqp classes like RequestResponseUtils and RequestResponseChannel.\n\nFixes #10033", "createdAt": "2020-04-21T02:23:03Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10385", "merged": true, "mergeCommit": {"oid": "dcde901d2f61311235ccd75829087aec69434e08"}, "closed": true, "closedAt": "2020-04-22T14:51:24Z", "author": {"login": "conniey"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZgx9NgH2gAyNDA2Mzk5NDM3OjBmMmExZTU5NWVlYWQyYWI4ODNmZjc5MWYxMjViY2VmZDRkMjA4N2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaJICJABqjMyNjA4NTk0NjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f2a1e595eead2ab883ff791f125bcefd4d2087a", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0f2a1e595eead2ab883ff791f125bcefd4d2087a", "committedDate": "2020-04-20T15:25:43Z", "message": "Adding missing AmqpResponseCode from .NET's AMQP library."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16cc857e3faf6480ac41a127c35335ee0814b865", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/16cc857e3faf6480ac41a127c35335ee0814b865", "committedDate": "2020-04-20T15:26:14Z", "message": "Using a processor rather than a sink that could be null."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f3657565b27cbb15d182e9b6b44d410b60f8ca0", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9f3657565b27cbb15d182e9b6b44d410b60f8ca0", "committedDate": "2020-04-20T15:41:22Z", "message": "Not throwing IllegalArgumentException when AMQP error condition not found. Being more versatile in parsing response codes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9ab30beaed01af446a9d5eebcc971d379cfc434", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d9ab30beaed01af446a9d5eebcc971d379cfc434", "committedDate": "2020-04-20T16:42:56Z", "message": "Adding flexibility to decoding RequestResponse messages."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "007a3605dae6f680318ed016ab4e9e6d00cee2cf", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/007a3605dae6f680318ed016ab4e9e6d00cee2cf", "committedDate": "2020-04-20T17:21:57Z", "message": "Move message deserialization and validation out of RequestResponseChannel. Just validate a matching message."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "733058666673a9ce9ae435b3abc12560c268e1a3", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/733058666673a9ce9ae435b3abc12560c268e1a3", "committedDate": "2020-04-20T20:32:02Z", "message": "Fixing exceptions and adding a test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7aade5831faf0f7559287acb0231302bc771b7df", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7aade5831faf0f7559287acb0231302bc771b7df", "committedDate": "2020-04-20T21:22:40Z", "message": "Adding condition when it is actually a symbol."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b06e14afc0613974252896318bdba04ce8c42848", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b06e14afc0613974252896318bdba04ce8c42848", "committedDate": "2020-04-20T21:44:41Z", "message": "Fixing error handling in RequestResponseChannel."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "782dafa269b5e957402c004a329c1d44072a19e2", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/782dafa269b5e957402c004a329c1d44072a19e2", "committedDate": "2020-04-20T22:56:46Z", "message": "Update message lock container to expire lock tokens."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14376291df7125b5c33f6e0417331bd61ac8f5b1", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/14376291df7125b5c33f6e0417331bd61ac8f5b1", "committedDate": "2020-04-20T22:57:17Z", "message": "Add methods for reading RequestResponse status codes and error messages."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a42da761f3a62be7f54538282d61ed98d63f2c56", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a42da761f3a62be7f54538282d61ed98d63f2c56", "committedDate": "2020-04-20T22:57:55Z", "message": "Use correct error message."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbe6119c4613d2026074cca55b546aeb014f6a29", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bbe6119c4613d2026074cca55b546aeb014f6a29", "committedDate": "2020-04-20T22:58:33Z", "message": "Add comment for service bus session and unnamed session."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39bf5612ddab751cb22d41e65b302f4740164def", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/39bf5612ddab751cb22d41e65b302f4740164def", "committedDate": "2020-04-20T22:59:02Z", "message": "MessageLockContainer removed from constructor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae1168b49854a547e90762b8c2f5ba5e64d83acb", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ae1168b49854a547e90762b8c2f5ba5e64d83acb", "committedDate": "2020-04-20T22:59:53Z", "message": "Adding support for keeping sessions open."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc291bf574eb2a1220c1f64bd577dd278900e0f", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4fc291bf574eb2a1220c1f64bd577dd278900e0f", "committedDate": "2020-04-20T23:00:45Z", "message": "Adding support for settling messages on receive link."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a5fd32261a90a1fc7efad8644ec77a585b4b1e1", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a5fd32261a90a1fc7efad8644ec77a585b4b1e1", "committedDate": "2020-04-20T23:01:57Z", "message": "Fixing tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bf2d935281e0b60800405013c4cb8c808ad2cf5", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3bf2d935281e0b60800405013c4cb8c808ad2cf5", "committedDate": "2020-04-21T02:16:34Z", "message": "Fixing test failures."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2OTQzNDM1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10385#pullrequestreview-396943435", "createdAt": "2020-04-21T02:23:32Z", "commit": {"oid": "3bf2d935281e0b60800405013c4cb8c808ad2cf5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMjoyMzozMlrOGIviTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMjoyMzozMlrOGIviTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyMDYyMw==", "bodyText": "Changed from hex to dec values for readability.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10385#discussion_r411820623", "createdAt": "2020-04-21T02:23:32Z", "author": {"login": "conniey"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/exception/AmqpResponseCode.java", "diffHunk": "@@ -10,13 +10,54 @@\n  * Error response codes returned from AMQP.\n  */\n public enum AmqpResponseCode {\n-    ACCEPTED(0xca),\n+    ACCEPTED(202),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bf2d935281e0b60800405013c4cb8c808ad2cf5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "246c2e0257649351d682d618f9e3cfcbf13b7af9", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/246c2e0257649351d682d618f9e3cfcbf13b7af9", "committedDate": "2020-04-21T02:29:51Z", "message": "Fix incorrect formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c87e2734950a2ad445273890f8ba26b072d2aad", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2c87e2734950a2ad445273890f8ba26b072d2aad", "committedDate": "2020-04-21T13:56:34Z", "message": "Adding error condition."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1368b371445a454fdefbfeee1ed4410fb998d8a1", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1368b371445a454fdefbfeee1ed4410fb998d8a1", "committedDate": "2020-04-21T15:19:23Z", "message": "Fixing tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d14fa563ccfdb2784891af71d204e855f0f4251", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2d14fa563ccfdb2784891af71d204e855f0f4251", "committedDate": "2020-04-21T16:34:24Z", "message": "Fixing logic when completing messages."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fbecfe8c2e779b39ea1751c9d6588cdc3d93bd6", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8fbecfe8c2e779b39ea1751c9d6588cdc3d93bd6", "committedDate": "2020-04-21T17:39:00Z", "message": "Waiting for work to be completed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b4bfe61f3566bf3995835a330fabe357f5f9f0e", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b4bfe61f3566bf3995835a330fabe357f5f9f0e", "committedDate": "2020-04-21T17:50:45Z", "message": "test cleanup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTAyODc3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10385#pullrequestreview-397502877", "createdAt": "2020-04-21T17:06:30Z", "commit": {"oid": "1368b371445a454fdefbfeee1ed4410fb998d8a1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzowNjozMFrOGJO6sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzowOToxNlrOGJPCYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzNDc2OA==", "bodyText": "How are we checking the error condition and throw error when service did not send OK status code ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10385#discussion_r412334768", "createdAt": "2020-04-21T17:06:30Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java", "diffHunk": "@@ -86,19 +84,11 @@\n         return isAuthorized(ManagementConstants.OPERATION_CANCEL_SCHEDULED_MESSAGE)\n             .then(createChannel.flatMap(channel -> {\n                 final Message requestMessage = createManagementMessage(\n-                    ManagementConstants.OPERATION_CANCEL_SCHEDULED_MESSAGE, channel.getReceiveLinkName());\n+                    ManagementConstants.OPERATION_CANCEL_SCHEDULED_MESSAGE, null);\n \n                 requestMessage.setBody(new AmqpValue(Collections.singletonMap(ManagementConstants.SEQUENCE_NUMBERS,\n                     new Long[]{sequenceNumber})));\n                 return channel.sendWithAck(requestMessage);\n-            }).map(responseMessage -> {\n-                int statusCode = RequestResponseUtils.getResponseStatusCode(responseMessage);\n-\n-                if (statusCode == AmqpResponseCode.OK.getValue()) {\n-                    return Mono.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1368b371445a454fdefbfeee1ed4410fb998d8a1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzNjczOA==", "bodyText": "Should we use CoreUtils.isNullOrEmpty(associatedLinkName) here ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10385#discussion_r412336738", "createdAt": "2020-04-21T17:09:16Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java", "diffHunk": "@@ -417,17 +383,17 @@ private Message createDispositionMessage(UUID[] lockTokens, DispositionStatus di\n      * Creates an AMQP message with the required application properties.\n      *\n      * @param operation Management operation to perform (ie. peek, update-disposition, etc.)\n-     * @param linkName Name of receiver link associated with operation.\n+     * @param associatedLinkName Name of the open receive link that first received the message.\n      * @return An AMQP message with the required headers.\n      */\n-    private Message createManagementMessage(String operation, String linkName) {\n+    private Message createManagementMessage(String operation, String associatedLinkName) {\n         final Duration serverTimeout = MessageUtils.adjustServerTimeout(operationTimeout);\n         final Map<String, Object> applicationProperties = new HashMap<>();\n         applicationProperties.put(ManagementConstants.MANAGEMENT_OPERATION_KEY, operation);\n         applicationProperties.put(ManagementConstants.SERVER_TIMEOUT, serverTimeout.toMillis());\n \n-        if (linkName != null && !linkName.isEmpty()) {\n-            applicationProperties.put(ManagementConstants.ASSOCIATED_LINK_NAME_KEY, linkName);\n+        if (associatedLinkName != null && !associatedLinkName.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1368b371445a454fdefbfeee1ed4410fb998d8a1"}, "originalPosition": 166}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dfa82ff99f971a20d8d7e0df9f6a79504ec6bf9", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0dfa82ff99f971a20d8d7e0df9f6a79504ec6bf9", "committedDate": "2020-04-21T18:13:43Z", "message": "Add verification for success."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bacc41fe0228453797145543e03c7ca347dc98a6", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bacc41fe0228453797145543e03c7ca347dc98a6", "committedDate": "2020-04-21T18:16:31Z", "message": "Adding verification of messages back."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjEzNjU0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10385#pullrequestreview-397613654", "createdAt": "2020-04-21T19:34:03Z", "commit": {"oid": "bacc41fe0228453797145543e03c7ca347dc98a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a13a639341043b092493e6b675e6524d21ee2ad5", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a13a639341043b092493e6b675e6524d21ee2ad5", "committedDate": "2020-04-21T19:44:33Z", "message": "Fixing checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96598b52a13e9192c998bf7837e3eda6b24a7814", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/96598b52a13e9192c998bf7837e3eda6b24a7814", "committedDate": "2020-04-21T19:51:23Z", "message": "Updating duratin."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ea84f36abea1d05c26dc3bbe771e4355a4b5045", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0ea84f36abea1d05c26dc3bbe771e4355a4b5045", "committedDate": "2020-04-21T21:13:36Z", "message": "Fixing spotbugs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58bb77e88b8f7970f34adc154f867f9060b4735e", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/58bb77e88b8f7970f34adc154f867f9060b4735e", "committedDate": "2020-04-22T00:02:29Z", "message": "Fix errors when sending message through management channel."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTg0MjU2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10385#pullrequestreview-397584256", "createdAt": "2020-04-21T18:52:29Z", "commit": {"oid": "bacc41fe0228453797145543e03c7ca347dc98a6"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODo1MjoyOVrOGJTbrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjowMToxMVrOGJf8Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQwODc1MA==", "bodyText": "nit: FluxUtil in azure-core has monoError static helper log and return errors.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10385#discussion_r412408750", "createdAt": "2020-04-21T18:52:29Z", "author": {"login": "srnagar"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/RequestResponseChannel.java", "diffHunk": "@@ -220,8 +196,7 @@ public boolean isDisposed() {\n         }\n \n         if (message == null) {\n-            return Mono.error(logger.logExceptionAsError(\n-                new IllegalArgumentException(\"message cannot be null\")));\n+            return Mono.error(logger.logExceptionAsError(new NullPointerException(\"message cannot be null\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bacc41fe0228453797145543e03c7ca347dc98a6"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYxMjM1NA==", "bodyText": "Can this be configurable? Or at least made a constant?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10385#discussion_r412612354", "createdAt": "2020-04-22T01:57:21Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -118,9 +112,10 @@\n         this.receiveMode = receiverOptions.getReceiveMode();\n         this.sessionId = receiverOptions.getSessionId();\n         this.entityType = entityType;\n-        this.messageLockContainer = messageLockContainer;\n         this.onClientClose = onClientClose;\n \n+        this.linkName = StringUtil.getRandomString(entityPath);\n+        this.managementNodeLocks = new MessageLockContainer(Duration.ofSeconds(30));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58bb77e88b8f7970f34adc154f867f9060b4735e"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYxMzcwMg==", "bodyText": "Maybe worth making this log info as removing expired entries should be uncommon and users should be able to see it at info level? Also, consider adding a count of expired entries removed in the log.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10385#discussion_r412613702", "createdAt": "2020-04-22T02:01:11Z", "author": {"login": "srnagar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageLockContainer.java", "diffHunk": "@@ -3,14 +3,41 @@\n \n package com.azure.messaging.servicebus.implementation;\n \n+import com.azure.core.util.logging.ClientLogger;\n+import reactor.core.Disposable;\n+import reactor.core.publisher.Flux;\n+\n+import java.time.Duration;\n import java.time.Instant;\n import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicBoolean;\n \n /**\n- * Container of Message lock and related metadata related.\n+ * Container for message locks that are cleaned up periodically.\n  */\n-public class MessageLockContainer {\n-    private final ConcurrentHashMap<String, Instant> lockTokenExpirationMap = new ConcurrentHashMap<>();\n+public class MessageLockContainer implements AutoCloseable {\n+    private final ClientLogger logger = new ClientLogger(MessageLockContainer.class);\n+    private final ConcurrentHashMap<String, Instant> lockTokens = new ConcurrentHashMap<>();\n+    private final AtomicBoolean isDisposed = new AtomicBoolean();\n+    private final Disposable cleanupOperation;\n+\n+    public MessageLockContainer(Duration cleanupInterval) {\n+        cleanupOperation = Flux.interval(cleanupInterval).subscribe(e -> {\n+            if (lockTokens.isEmpty()) {\n+                return;\n+            }\n+\n+            final Instant now = Instant.now();\n+            final boolean removed = lockTokens.entrySet().removeIf(entry -> {\n+                final Instant expiration = entry.getValue();\n+                return expiration != null && expiration.isBefore(now);\n+            });\n+\n+            if (removed) {\n+                logger.verbose(\"{}: Removed expired entries.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58bb77e88b8f7970f34adc154f867f9060b4735e"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "629845b430c5692a35efe2a0fc114e37b766d765", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/629845b430c5692a35efe2a0fc114e37b766d765", "committedDate": "2020-04-22T11:40:51Z", "message": "Adding verbosity to message processor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e844dd0e962c5c3725dffe22e918135e90e47b0", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9e844dd0e962c5c3725dffe22e918135e90e47b0", "committedDate": "2020-04-22T11:47:59Z", "message": "Increase timeout."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d1d77d8d58185f50de07ffab60a0efaa5981717", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6d1d77d8d58185f50de07ffab60a0efaa5981717", "committedDate": "2020-04-22T12:00:18Z", "message": "Making cleanup duration configurable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "630862d5fa32ee6674de9dddb67596ca3b2d4553", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/630862d5fa32ee6674de9dddb67596ca3b2d4553", "committedDate": "2020-04-22T13:00:26Z", "message": "Fixing tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6e0913fc78598496358ab25e95533db2496543f", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d6e0913fc78598496358ab25e95533db2496543f", "committedDate": "2020-04-22T14:25:45Z", "message": "Fixing checkstyle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7cc9a0190ee61c623afc4a9aa3fac1f07c44f89d", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7cc9a0190ee61c623afc4a9aa3fac1f07c44f89d", "committedDate": "2020-04-22T14:05:08Z", "message": "Fixing checkstyle"}, "afterCommit": {"oid": "d6e0913fc78598496358ab25e95533db2496543f", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d6e0913fc78598496358ab25e95533db2496543f", "committedDate": "2020-04-22T14:25:45Z", "message": "Fixing checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4726, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}