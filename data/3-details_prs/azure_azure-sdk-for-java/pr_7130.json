{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5Mjg4Mzkz", "number": 7130, "title": "Reactor netty connection pooling", "bodyText": "Removed explicit disposing connections after reading response.\nReactor netty automatically puts the connection back to connection pool after response is read: https://gitter.im/reactor/reactor-netty?at=5e11accfa769bf30fd3e8c0f\nAddresses this issue: #6973\nTested this PR with ReadThroughput benchmark and the results show that connections are being re-used\nHere are some snapshots when running readThroughput in Https and gateway mode.\n** Https mode:\n\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 ESTABLISHED\n      3 LISTEN\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 LISTEN\n   2984 ESTABLISHED\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 LISTEN\n   3094 ESTABLISHED\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 LISTEN\n   3108 ESTABLISHED\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 LISTEN\n   3152 ESTABLISHED\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 LISTEN\n   3156 ESTABLISHED\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 LISTEN\n   3181 ESTABLISHED\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 LISTEN\n   3191 ESTABLISHED\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 ESTABLISHED\n      3 LISTEN\n   3192 TIME_WAIT\n\n** Gateway mode:\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 ESTABLISHED\n      3 LISTEN\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 LISTEN\n    105 ESTABLISHED\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 LISTEN\n   1004 ESTABLISHED\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 LISTEN\n   1004 ESTABLISHED\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 LISTEN\n   1004 ESTABLISHED\nconsistency-test@consistency-tests-machine:~/azure-sdk-for-java/sdk/cosmos$ netstat -ant | awk '{print $6}' | sort | uniq -c | sort -n\n      1 Foreign\n      1 established)\n      3 ESTABLISHED\n      3 LISTEN\n   1001 TIME_WAIT", "createdAt": "2020-01-05T10:18:57Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7130", "merged": true, "mergeCommit": {"oid": "51c4efc5709bb4e1fe5d02a8ecd49df89235e406"}, "closed": true, "closedAt": "2020-01-06T07:19:46Z", "author": {"login": "kushagraThapar"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbxegUKAH2gAyMzU5Mjg4MzkzOjYxZjQ2NmU5NmEyMmMzYmI4NzgxNDY2MGNhNzI2NzI4Zjk1ZjFkZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb3jt_4gFqTMzODQ1NjMwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "61f466e96a22c3bb87814660ca726728f95f1de0", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/61f466e96a22c3bb87814660ca726728f95f1de0", "committedDate": "2019-12-18T06:09:40Z", "message": "Added some logging around open connections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3ac4b5cc9737ad1a1f06afba7db2a9ad246e8ca", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a3ac4b5cc9737ad1a1f06afba7db2a9ad246e8ca", "committedDate": "2019-12-19T01:52:06Z", "message": "Removed extra logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a29cabd22d2334ef2ad90424fcd6dc9f76403428", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a29cabd22d2334ef2ad90424fcd6dc9f76403428", "committedDate": "2020-01-05T10:04:11Z", "message": "Removed dispose calls to re-use connection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDExMDYy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7130#pullrequestreview-338411062", "createdAt": "2020-01-05T16:59:58Z", "commit": {"oid": "a29cabd22d2334ef2ad90424fcd6dc9f76403428"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDExMjAz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7130#pullrequestreview-338411203", "createdAt": "2020-01-05T17:03:39Z", "commit": {"oid": "a29cabd22d2334ef2ad90424fcd6dc9f76403428"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQxNzowMzozOVrOFaSL7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQxNzowMzozOVrOFaSL7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEwNTI2Mw==", "bodyText": "Might the method override be removed now that the body of close is empty?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7130#discussion_r363105263", "createdAt": "2020-01-05T17:03:39Z", "author": {"login": "David-Noble-at-work"}, "path": "sdk/cosmos/microsoft-azure-cosmos/src/main/java/com/azure/data/cosmos/internal/http/ReactorNettyClient.java", "diffHunk": "@@ -172,31 +172,26 @@ public HttpHeaders headers() {\n \n         @Override\n         public Flux<ByteBuf> body() {\n-            return bodyIntern().doFinally(s -> this.close());\n+            return bodyIntern();\n         }\n \n         @Override\n         public Mono<byte[]> bodyAsByteArray() {\n-            return bodyIntern().aggregate().asByteArray().doFinally(s -> this.close());\n+            return bodyIntern().aggregate().asByteArray();\n         }\n \n         @Override\n         public Mono<String> bodyAsString() {\n-            return bodyIntern().aggregate().asString().doFinally(s -> this.close());\n+            return bodyIntern().aggregate().asString();\n         }\n \n         @Override\n         public Mono<String> bodyAsString(Charset charset) {\n-            return bodyIntern().aggregate().asString(charset).doFinally(s -> this.close());\n+            return bodyIntern().aggregate().asString(charset);\n         }\n \n         @Override\n         public void close() {\n-            if (reactorNettyConnection.channel().eventLoop().inEventLoop()) {\n-                reactorNettyConnection.dispose();\n-            } else {\n-                reactorNettyConnection.channel().eventLoop().execute(reactorNettyConnection::dispose);\n-            }\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a29cabd22d2334ef2ad90424fcd6dc9f76403428"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0b9b05fd266949d96d1949904a3e38c6e9011f7", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b0b9b05fd266949d96d1949904a3e38c6e9011f7", "committedDate": "2020-01-05T18:10:11Z", "message": "Removed empty close method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e70554038817eee7bf214044f9c94ac54a468c9e", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e70554038817eee7bf214044f9c94ac54a468c9e", "committedDate": "2020-01-05T18:10:56Z", "message": "Merge branch 'master' into reactor-netty-connection-pooling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDE1NTY2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7130#pullrequestreview-338415566", "createdAt": "2020-01-05T18:54:19Z", "commit": {"oid": "e70554038817eee7bf214044f9c94ac54a468c9e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDU2MzAy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7130#pullrequestreview-338456302", "createdAt": "2020-01-06T03:37:41Z", "commit": {"oid": "e70554038817eee7bf214044f9c94ac54a468c9e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 656, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}