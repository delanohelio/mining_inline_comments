{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5NTgxNTIz", "number": 10525, "title": "Adds session operations to receiver", "bodyText": "Adds setSessionState, getSessionState, and renewSessionLock to receiver client.", "createdAt": "2020-04-27T15:39:53Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10525", "merged": true, "mergeCommit": {"oid": "3103cfc65905a85943b02b558c60d352bb2be725"}, "closed": true, "closedAt": "2020-04-28T07:23:14Z", "author": {"login": "conniey"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbxFCIgH2gAyNDA5NTgxNTIzOjZmZjZjMmQ5ZDFkOWU0ZDA1Y2U0MDg4Y2FiN2FhZDNhY2FjMWE5MTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb-QGMAH2gAyNDA5NTgxNTIzOjczMDAwY2ZkNzcyNDM2N2NjNWVmY2ZkZDUzNmI5NTM1ZTBmZTQ5OWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6ff6c2d9d1d9e4d05ce4088cab7aad3acac1a913", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6ff6c2d9d1d9e4d05ce4088cab7aad3acac1a913", "committedDate": "2020-04-27T15:32:53Z", "message": "Splitting management node into multiple interfaces. Adding session operations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a3a0aa4162df925c1d1bcfd31f0103f7a20f34d", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9a3a0aa4162df925c1d1bcfd31f0103f7a20f34d", "committedDate": "2020-04-27T15:32:53Z", "message": "Adding tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9658e1ada5113aa0a5a78e5862bc83e8df9e994c", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9658e1ada5113aa0a5a78e5862bc83e8df9e994c", "committedDate": "2020-04-27T15:35:31Z", "message": "Remove extra interfaces."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMDc4MzU1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10525#pullrequestreview-401078355", "createdAt": "2020-04-27T15:41:02Z", "commit": {"oid": "9658e1ada5113aa0a5a78e5862bc83e8df9e994c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNTo0MTowM1rOGMp60Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNTo0MTowM1rOGMp60Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkyMjg5Nw==", "bodyText": "Alphabetized methods in addition to adding session ones.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10525#discussion_r415922897", "createdAt": "2020-04-27T15:41:03Z", "author": {"login": "conniey"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusManagementNode.java", "diffHunk": "@@ -6,7 +6,6 @@\n import com.azure.messaging.servicebus.ServiceBusMessage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9658e1ada5113aa0a5a78e5862bc83e8df9e994c"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc9f536b1f6fd2f53f5da6321ccdcf221d045b7f", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/dc9f536b1f6fd2f53f5da6321ccdcf221d045b7f", "committedDate": "2020-04-27T15:52:55Z", "message": "Clean up api. ManagementChannel already has sessionId."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acda3bfb2bdb76ac7285e7847b6693937d406d0d", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/acda3bfb2bdb76ac7285e7847b6693937d406d0d", "committedDate": "2020-04-27T16:40:11Z", "message": "Replace with .count()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTg3MTg0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10525#pullrequestreview-401187184", "createdAt": "2020-04-27T17:49:56Z", "commit": {"oid": "acda3bfb2bdb76ac7285e7847b6693937d406d0d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNzo0OTo1NlrOGMwCNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODowMjo0NlrOGMwmDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAyMzA5NQ==", "bodyText": "The check map.containsKey(ManagementConstants.SESSION_STATE) : Does not have value if  we do it after we already try to get sessionState.  Either this check should be before or not required because sessionState == null will be sufficient.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10525#discussion_r416023095", "createdAt": "2020-04-27T17:49:56Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ManagementChannel.java", "diffHunk": "@@ -96,6 +97,44 @@\n             })).then();\n     }\n \n+    @Override\n+    public Mono<byte[]> getSessionState() {\n+        if (!isSessionEnabled) {\n+            return monoError(logger, new IllegalStateException(\"Cannot get session state for non-session management node\"));\n+        }\n+\n+        return isAuthorized(ManagementConstants.OPERATION_GET_SESSION_STATE).then(createChannel.flatMap(channel -> {\n+            final Message message = createManagementMessage(ManagementConstants.OPERATION_GET_SESSION_STATE, null);\n+\n+            final Map<String, Object> body = new HashMap<>();\n+            body.put(ManagementConstants.SESSION_ID, sessionId);\n+\n+            message.setBody(new AmqpValue(body));\n+\n+            return sendWithVerify(channel, message);\n+        })).flatMap(response -> {\n+            final Object value = ((AmqpValue) response.getBody()).getValue();\n+\n+            if (!(value instanceof Map)) {\n+                return monoError(logger, Exceptions.propagate(new AmqpException(false, String.format(\n+                    \"Body not expected when renewing session. Id: %s. Value: %s\", sessionId, value),\n+                    getErrorContext())));\n+            }\n+\n+            @SuppressWarnings(\"unchecked\")\n+            final Map<String, Object> map = (Map<String, Object>) value;\n+            final Object sessionState = map.get(ManagementConstants.SESSION_STATE);\n+\n+            if (!map.containsKey(ManagementConstants.SESSION_STATE) || sessionState == null) {\n+                logger.info(\"sessionId[{}]. Does not have a session state.\", sessionId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acda3bfb2bdb76ac7285e7847b6693937d406d0d"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAyNjUwMQ==", "bodyText": "sessionId : If this session id  is not maintained by this receiver. Should we validate it against list of session id this received is actively managing ? So if this session id  is managed by some other receiver, we thro error for example \"Session id is not managed by this receiver\".", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10525#discussion_r416026501", "createdAt": "2020-04-27T17:54:46Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -190,6 +191,24 @@ public String getEntityPath() {\n         return updateDisposition(lockToken, DispositionStatus.COMPLETED, null, null, null);\n     }\n \n+    /**\n+     * Gets the state of a session given its identifier.\n+     *\n+     * @param sessionId Identifier of session to get.\n+     *\n+     * @return The session state or an empty Mono if there is no state set for the session.\n+     * @throws IllegalStateException if the receiver is a non-session receiver.\n+     */\n+    public Mono<byte[]> getSessionState(String sessionId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acda3bfb2bdb76ac7285e7847b6693937d406d0d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAzMjI2OA==", "bodyText": "Are we going to add these API in ServiceBusReceiverClient .\nAlso will we add integration test for this ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10525#discussion_r416032268", "createdAt": "2020-04-27T18:02:46Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -494,6 +513,43 @@ public String getEntityPath() {\n             });\n     }\n \n+    /**\n+     * Sets the state of a session given its identifier.\n+     *\n+     * @param sessionId Identifier of session to get.\n+     *\n+     * @return The next expiration time for the session lock.\n+     * @throws IllegalStateException if the receiver is a non-session receiver.\n+     */\n+    public Mono<Instant> renewSessionLock(String sessionId) {\n+        if (!isSessionReceiver) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acda3bfb2bdb76ac7285e7847b6693937d406d0d"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e020e1a8575c9784ba2f1344e225e74c3a9c140", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1e020e1a8575c9784ba2f1344e225e74c3a9c140", "committedDate": "2020-04-27T18:49:41Z", "message": "Add tests and simplify conditions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc0d08ce3638b7981d1592a027a7aede11dd5bfe", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/cc0d08ce3638b7981d1592a027a7aede11dd5bfe", "committedDate": "2020-04-27T19:03:52Z", "message": "Fixing tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0a954293c366ff88c457939643acfc4472fe9b6", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f0a954293c366ff88c457939643acfc4472fe9b6", "committedDate": "2020-04-27T19:16:04Z", "message": "Adding test for session state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfee869bba89cff4eabaf545bc8e5d2519d91dd4", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/dfee869bba89cff4eabaf545bc8e5d2519d91dd4", "committedDate": "2020-04-27T19:52:37Z", "message": "Clean up messages."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75c74d3a9fcde98ab8b1a0b6f69760618569c1ef", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/75c74d3a9fcde98ab8b1a0b6f69760618569c1ef", "committedDate": "2020-04-28T03:57:26Z", "message": "Adding synchronous methods."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "facfceab28ca1af761562f708def93123740a5c9", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/facfceab28ca1af761562f708def93123740a5c9", "committedDate": "2020-04-28T04:05:15Z", "message": "Adding tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNDk5NzMy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10525#pullrequestreview-401499732", "createdAt": "2020-04-28T05:05:14Z", "commit": {"oid": "facfceab28ca1af761562f708def93123740a5c9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "039014b56fb86a76cf5564b5517c8811dced5d0e", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/039014b56fb86a76cf5564b5517c8811dced5d0e", "committedDate": "2020-04-28T05:26:02Z", "message": "Adding methods to get information for session receive link."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "415b0928621da7aae2153137703d8a4ee981878c", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/415b0928621da7aae2153137703d8a4ee981878c", "committedDate": "2020-04-28T06:07:14Z", "message": "Adding session receiver tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a353867a8d461645ac2b6388cc9a2f45d5b9630", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a353867a8d461645ac2b6388cc9a2f45d5b9630", "committedDate": "2020-04-28T06:50:22Z", "message": "Adding more tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73000cfd7724367cc5efcfdd536b9535e0fe499e", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/73000cfd7724367cc5efcfdd536b9535e0fe499e", "committedDate": "2020-04-28T06:53:44Z", "message": "Fix tests."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4601, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}