{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNzM2NTMx", "number": 16197, "title": "MiscellaneousChangeForRntbd", "bodyText": "This PR is a duplicate of changes not related to ConnectionStateListener incuded in PR #14697. For example, renaming, style clean etc", "createdAt": "2020-10-12T18:21:05Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197", "merged": true, "mergeCommit": {"oid": "6210baaf237ab184a59dfabe300a9cbf86adeaa3"}, "closed": true, "closedAt": "2020-10-26T15:29:41Z", "author": {"login": "xinlian12"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP6JRLgH2gAyNTAxNzM2NTMxOjg1MGU3MThhMDk5NjdhMDJlNzM5MDY4OGJjY2EwODg4NWM3YTk2YzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVaRWwAFqTUxNTg3OTMyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "850e718a09967a02e7390688bcca08885c7a96c3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/850e718a09967a02e7390688bcca08885c7a96c3", "committedDate": "2020-10-06T15:30:43Z", "message": "ConnectionStateListener change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49b62d6ef3d36ed3b3e0a56d5366ef3ac7fe0a4a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/49b62d6ef3d36ed3b3e0a56d5366ef3ac7fe0a4a", "committedDate": "2020-10-06T17:31:45Z", "message": "clean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c38d31c4ec7c5251cfabb9fb5f281c58b99baad8", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c38d31c4ec7c5251cfabb9fb5f281c58b99baad8", "committedDate": "2020-10-06T18:27:18Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "committedDate": "2020-10-06T19:02:13Z", "message": "resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a8bcccacfb0528d426ae1adc3c2557ee622c78b", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1a8bcccacfb0528d426ae1adc3c2557ee622c78b", "committedDate": "2020-10-09T19:46:59Z", "message": "Merge branch 'master' into ConnectionStateListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d353fdf1a1e6501dc0eb0198837756372dc90dc", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8d353fdf1a1e6501dc0eb0198837756372dc90dc", "committedDate": "2020-10-12T16:49:08Z", "message": "Merge branch 'master' into ConnectionStateListenerSplit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be1512532374ab85eb46e977c70eb646ba6482ec", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/be1512532374ab85eb46e977c70eb646ba6482ec", "committedDate": "2020-10-12T17:36:21Z", "message": "revert back ConnectionStateListener"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODMwMzIy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#pullrequestreview-506830322", "createdAt": "2020-10-12T18:21:40Z", "commit": {"oid": "be1512532374ab85eb46e977c70eb646ba6482ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxODoyMTo0MVrOHgI60w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxODoyMTo0MVrOHgI60w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2MjYxMQ==", "bodyText": "\"It is reported, just not stored as a value\" (copied from the original PR).\nThis will not change the rntbd timeline diagnostics. After this change:\n\"serializationDiagnosticsContext\":{\"serializationDiagnosticsList\":[{\"serializationType\":\"ITEM_SERIALIZATION\",\"startTimeUTC\":\"22 Sep 2020 17:40:59.239\",\"endTimeUTC\":\"22 Sep 2020 17:40:59.239\",\"durationInMicroSec\":0},{\"serializationType\":\"PARTITION_KEY_FETCH_SERIALIZATION\",\"startTimeUTC\":\"22 Sep 2020 17:40:59.317\",\"endTimeUTC\":\"22 Sep 2020 17:40:59.323\",\"durationInMicroSec\":5998}]},\"gatewayStatistics\":null,\"systemInformation\":{\"usedMemory\":\"60586 KB\",\"availableMemory\":\"8309590 KB\",\"systemCpuLoad\":\"(2020-09-22T17:40:58.729927700Z 20.1%)\"}}", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r503462611", "createdAt": "2020-10-12T18:21:41Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RequestTimeline.java", "diffHunk": "@@ -151,19 +151,17 @@ public String toString() {\n         return RntbdObjectMapper.toString(this);\n     }\n \n-    @JsonPropertyOrder({ \"name\", \"startTimeUTC\", \"durationInMicroSec\" })\n+    @JsonPropertyOrder({ \"name\", \"startTimeUTC\" })\n     public static final class Event {\n \n         @JsonIgnore\n         private final Duration duration;\n \n-        @JsonSerialize(using = ToStringSerializer.class)\n-        private final long durationInMicroSec;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be1512532374ab85eb46e977c70eb646ba6482ec"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f418ba312a8d2d07c70b13680b28f933e707d77", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9f418ba312a8d2d07c70b13680b28f933e707d77", "committedDate": "2020-10-12T18:23:39Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODMxODY1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#pullrequestreview-506831865", "createdAt": "2020-10-12T18:24:39Z", "commit": {"oid": "9f418ba312a8d2d07c70b13680b28f933e707d77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxODoyNDozOVrOHgI_wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxODoyNDozOVrOHgI_wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2Mzg3NA==", "bodyText": "This is removed because no where is using it.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r503463874", "createdAt": "2020-10-12T18:24:39Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -327,9 +364,6 @@ private void throwIfClosed() {\n         @JsonProperty()\n         private final Duration receiveHangDetectionTime;\n \n-        @JsonProperty()\n-        private final Duration requestExpiryInterval;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f418ba312a8d2d07c70b13680b28f933e707d77"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1665ab1f2a74e153f598493d6b2afa80b66d4a5e", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1665ab1f2a74e153f598493d6b2afa80b66d4a5e", "committedDate": "2020-10-13T00:59:06Z", "message": "revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09", "committedDate": "2020-10-22T22:38:00Z", "message": "Merge and resolve conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTcwODgx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#pullrequestreview-515170881", "createdAt": "2020-10-22T22:46:11Z", "commit": {"oid": "88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMjo0NjoxMVrOHm2blw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMjo0NzoyNVrOHm2dKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTczNQ==", "bodyText": "I think we should remove these, since DirectConnectionConfig already provides the APIs now. This was before the public APIs and was only used through JVM options.\nOr if we want to keep these configurations, we should update them to the correct values - like maxChannelsPerEndpoint, maxRequestsPerChannel, idleEndpointTimeout, etc.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510499735", "createdAt": "2020-10-22T22:46:11Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -566,7 +599,6 @@ public String toString() {\n          *   \"maxRequestsPerChannel\": 30,\n          *   \"maxConcurrentRequestsPerEndpointOverride\": 500,\n          *   \"receiveHangDetectionTime\": \"PT1M5S\",\n-         *   \"requestExpiryInterval\": \"PT5S\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDEzNw==", "bodyText": "What is the reason behind this change ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510500137", "createdAt": "2020-10-22T22:47:25Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java", "diffHunk": "@@ -527,7 +527,7 @@ public void write(final ChannelHandlerContext context, final Object message, fin\n \n         if (message == RntbdHealthCheckRequest.MESSAGE) {\n \n-            context.write(RntbdHealthCheckRequest.MESSAGE, promise).addListener(completed -> {\n+            context.writeAndFlush(RntbdHealthCheckRequest.MESSAGE, promise).addListener(completed -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTg1MDg1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#pullrequestreview-515185085", "createdAt": "2020-10-22T23:26:03Z", "commit": {"oid": "88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMzoyNjowM1rOHm3Lag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMzozMDozNVrOHm3QkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxMTk3OA==", "bodyText": "this adds IdleStateHandler before SSLHandler. Is is intentional?\nThe old code had IdleStateHandler after SSLHandler.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510511978", "createdAt": "2020-10-22T23:26:03Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelHandler.java", "diffHunk": "@@ -114,9 +113,14 @@ protected void initChannel(final Channel channel) {\n         }\n \n         pipeline.addFirst(\n-            // TODO (DANOBLE) Log an issue with netty\n-            // Initialize sslHandler with jdkCompatibilityMode = true for openssl context.\n-            new SslHandler(this.config.sslContext().newEngine(channel.alloc())),\n+            // Initialize sslHandler with jdkCompatibilityMode = true for OpenSSL context\n+            // TODO Log an issue with netty for clarification on the design of this constructor and the\n+            //  semantic differences between the JDK and OpenSSL implementations\n+            new SslHandler(this.config.sslContext().newEngine(channel.alloc())));\n+\n+        final long idleConnectionTimerResolutionInNanos = config.idleConnectionTimerResolutionInNanos();\n+\n+        pipeline.addFirst(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxMzI5Nw==", "bodyText": "This potentially can be a perf impacting change.\nIf we decide to include this we should study the impact of this on both latency and throughput. I think the following studies would be needed:\n\nboth latency and throughput using the normal benchmark flow (when saturating max load)\nboth latency and throughput on sparse workload (https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/Configuration.java#L144)", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#discussion_r510513297", "createdAt": "2020-10-22T23:30:35Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java", "diffHunk": "@@ -527,7 +527,7 @@ public void write(final ChannelHandlerContext context, final Object message, fin\n \n         if (message == RntbdHealthCheckRequest.MESSAGE) {\n \n-            context.write(RntbdHealthCheckRequest.MESSAGE, promise).addListener(completed -> {\n+            context.writeAndFlush(RntbdHealthCheckRequest.MESSAGE, promise).addListener(completed -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDEzNw=="}, "originalCommit": {"oid": "88de52c2fea1a6ee1b62bbd22ca507dcc4f8ee09"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba6a55cd10ba052353b8ed6d3892bacbed8b2435", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ba6a55cd10ba052353b8ed6d3892bacbed8b2435", "committedDate": "2020-10-23T00:11:21Z", "message": "resolve comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjE0MDc4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#pullrequestreview-515214078", "createdAt": "2020-10-23T00:59:48Z", "commit": {"oid": "ba6a55cd10ba052353b8ed6d3892bacbed8b2435"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1ODc5MzI4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16197#pullrequestreview-515879328", "createdAt": "2020-10-23T17:46:09Z", "commit": {"oid": "ba6a55cd10ba052353b8ed6d3892bacbed8b2435"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2113, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}