{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5OTkzODEw", "number": 11303, "reviewThreads": {"totalCount": 51, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODozNjo1MFrOD97I-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNjozMzozOFrOED9ywA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MjU4NjgwOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/TestSuiteBase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODozNjo1MFrOGXtmPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMjowNDozNFrOGX0SsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxNzUwMg==", "bodyText": "POJO end user type is not expected to extend JsonSerializable. Why are we extending the POJO test classes from POJOSerializable?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r427517502", "createdAt": "2020-05-19T18:36:50Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/TestSuiteBase.java", "diffHunk": "@@ -1125,4 +1127,88 @@ protected int expectedNumberOfPages(int totalExpectedResult, int maxPageSize) {\n     public static CosmosClientBuilder copyCosmosClientBuilder(CosmosClientBuilder builder) {\n         return CosmosBridgeInternal.cloneCosmosClientBuilder(builder);\n     }\n+\n+\n+    public enum City {\n+        NEW_YORK,\n+        LOS_ANGELES,\n+        SEATTLE\n+    }\n+\n+    public final class Pet extends JsonSerializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e945839c8d285bc3a38aa66afcf9c03bb466d037"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNzE4NA==", "bodyText": "Yup these will be refactored", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r427627184", "createdAt": "2020-05-19T22:04:34Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/TestSuiteBase.java", "diffHunk": "@@ -1125,4 +1127,88 @@ protected int expectedNumberOfPages(int totalExpectedResult, int maxPageSize) {\n     public static CosmosClientBuilder copyCosmosClientBuilder(CosmosClientBuilder builder) {\n         return CosmosBridgeInternal.cloneCosmosClientBuilder(builder);\n     }\n+\n+\n+    public enum City {\n+        NEW_YORK,\n+        LOS_ANGELES,\n+        SEATTLE\n+    }\n+\n+    public final class Pet extends JsonSerializable {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxNzUwMg=="}, "originalCommit": {"oid": "e945839c8d285bc3a38aa66afcf9c03bb466d037"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MjU4OTA1OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/TestSuiteBase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODozNzoyM1rOGXtnpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMjowNDo0MlrOGX0S7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxNzg2Mw==", "bodyText": "please move the test POJO types to standalone files outside of TestSuiteBase. Same as Pet class, etc.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r427517863", "createdAt": "2020-05-19T18:37:23Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/TestSuiteBase.java", "diffHunk": "@@ -1125,4 +1127,88 @@ protected int expectedNumberOfPages(int totalExpectedResult, int maxPageSize) {\n     public static CosmosClientBuilder copyCosmosClientBuilder(CosmosClientBuilder builder) {\n         return CosmosBridgeInternal.cloneCosmosClientBuilder(builder);\n     }\n+\n+\n+    public enum City {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e945839c8d285bc3a38aa66afcf9c03bb466d037"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNzI0Nw==", "bodyText": "Sure will move", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r427627247", "createdAt": "2020-05-19T22:04:42Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/TestSuiteBase.java", "diffHunk": "@@ -1125,4 +1127,88 @@ protected int expectedNumberOfPages(int totalExpectedResult, int maxPageSize) {\n     public static CosmosClientBuilder copyCosmosClientBuilder(CosmosClientBuilder builder) {\n         return CosmosBridgeInternal.cloneCosmosClientBuilder(builder);\n     }\n+\n+\n+    public enum City {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxNzg2Mw=="}, "originalCommit": {"oid": "e945839c8d285bc3a38aa66afcf9c03bb466d037"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MjYwMTYyOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/JsonSerializable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODo0MDo0OVrOGXtvfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMjowNToxN1rOGX0T2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxOTg3MQ==", "bodyText": "I think as per central SDK guideline we should avoid protected access modifier. @kushagraThapar please comment if protected is fine here.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r427519871", "createdAt": "2020-05-19T18:40:49Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/JsonSerializable.java", "diffHunk": "@@ -159,6 +161,15 @@ public void populatePropertyBag() {\n         return getMapper().convertValue(this.propertyBag, HashMap.class);\n     }\n \n+    protected <T> Map<String, T> getMap(String propertyKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e945839c8d285bc3a38aa66afcf9c03bb466d037"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNzQ4MQ==", "bodyText": "JsonSerializable is an implementation type now. These methods could be public too :)", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r427627481", "createdAt": "2020-05-19T22:05:17Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/JsonSerializable.java", "diffHunk": "@@ -159,6 +161,15 @@ public void populatePropertyBag() {\n         return getMapper().convertValue(this.propertyBag, HashMap.class);\n     }\n \n+    protected <T> Map<String, T> getMap(String propertyKey) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUxOTg3MQ=="}, "originalCommit": {"oid": "e945839c8d285bc3a38aa66afcf9c03bb466d037"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MjYxNTg2OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODo0NDozOFrOGXt4QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODo0NDozOFrOGXt4QA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyMjExMg==", "bodyText": "license file header here and in other new files.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r427522112", "createdAt": "2020-05-19T18:44:38Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.azure.cosmos.implementation.query;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e945839c8d285bc3a38aa66afcf9c03bb466d037"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MjYyMDQ4OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODo0NTo1MlrOGXt7VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODo0NTo1MlrOGXt7VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyMjkwMA==", "bodyText": "if this is fatal, wrap in approprate RuntimeException and rethrow.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r427522900", "createdAt": "2020-05-19T18:45:52Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+\n+import java.io.IOException;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();\n+\n+    private final Map<UInt128, SingleGroupAggregator> table;\n+    private final Map<String, AggregateOperator> groupByAliasToAggregateType;\n+    private final List<String> orderedAliases;\n+    private final boolean hasSelectValue;\n+\n+    public GroupingTable(\n+        Map<String, AggregateOperator> groupByAliasToAggregateType, List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        this.table = new HashMap<>();\n+        this.groupByAliasToAggregateType = groupByAliasToAggregateType;\n+        this.orderedAliases = orderedAliases;\n+        this.hasSelectValue = hasSelectValue;\n+    }\n+\n+    public void addPayLoad(GroupByDocumentQueryExecutionContext.RewrittenGroupByProjection rewrittenGroupByProjection) {\n+        try {\n+            final UInt128 groupByKeysHash = DistinctHash.getHash(rewrittenGroupByProjection.getGroupByItems());\n+            SingleGroupAggregator singleGroupAggregator;\n+            if (!this.table.containsKey(groupByKeysHash)) {\n+                singleGroupAggregator = SingleGroupAggregator.create(EmptyAggregateOperators,\n+                                                                     this.groupByAliasToAggregateType,\n+                                                                     this.orderedAliases,\n+                                                                     this.hasSelectValue,\n+                                                                      null);\n+                this.table.put(groupByKeysHash, singleGroupAggregator);\n+            } else {\n+                singleGroupAggregator = table.get(groupByKeysHash);\n+            }\n+\n+            singleGroupAggregator.addValues(rewrittenGroupByProjection.getPayload());\n+\n+        } catch (JsonProcessingException | NoSuchAlgorithmException e) {\n+            //TODO: User logger instead\n+            e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e945839c8d285bc3a38aa66afcf9c03bb466d037"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzY2OTQxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/JsonSerializable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjowNzozMlrOGejFdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxMjozNVrOGfksMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY4NTMwMA==", "bodyText": "Error check  if value is not map ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434685300", "createdAt": "2020-06-03T16:07:32Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/JsonSerializable.java", "diffHunk": "@@ -154,6 +154,15 @@ public void populatePropertyBag() {\n         return getMapper().convertValue(this.propertyBag, HashMap.class);\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    public <T> Map<String, T> getMap(String propertyKey) {\n+        if (this.propertyBag.has(propertyKey)) {\n+            Object value = this.get(propertyKey);\n+            return (Map<String, T>) getMapper().convertValue(value, HashMap.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MDE3OQ==", "bodyText": "Done by the convertValue. It throws IllegalArgumentException, and thats what we would throw even if we check.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435760179", "createdAt": "2020-06-05T08:12:35Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/JsonSerializable.java", "diffHunk": "@@ -154,6 +154,15 @@ public void populatePropertyBag() {\n         return getMapper().convertValue(this.propertyBag, HashMap.class);\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    public <T> Map<String, T> getMap(String propertyKey) {\n+        if (this.propertyBag.has(propertyKey)) {\n+            Object value = this.get(propertyKey);\n+            return (Map<String, T>) getMapper().convertValue(value, HashMap.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY4NTMwMA=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzY4MjIxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/Utils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoxMDo0M1rOGejNhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo0NTo1NFrOGf1yqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY4NzM2Nw==", "bodyText": "Should we close the stream  ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434687367", "createdAt": "2020-06-03T16:10:43Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/Utils.java", "diffHunk": "@@ -646,4 +648,11 @@ public static String toJson(ObjectMapper mapper, ObjectNode object) {\n             throw new IllegalStateException(\"Unable to convert JSON to STRING\", e);\n         }\n     }\n+\n+    public static byte[] serializeObjectToByteArray(Object obj) throws IOException {\n+        ByteArrayOutputStream out = new ByteArrayOutputStream();\n+        ObjectOutputStream os = new ObjectOutputStream(out);\n+        os.writeObject(obj);\n+        return out.toByteArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA0MDM2Mg==", "bodyText": "The objects should get destroyed once out of the function", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r436040362", "createdAt": "2020-06-05T16:45:54Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/Utils.java", "diffHunk": "@@ -646,4 +648,11 @@ public static String toJson(ObjectMapper mapper, ObjectNode object) {\n             throw new IllegalStateException(\"Unable to convert JSON to STRING\", e);\n         }\n     }\n+\n+    public static byte[] serializeObjectToByteArray(Object obj) throws IOException {\n+        ByteArrayOutputStream out = new ByteArrayOutputStream();\n+        ObjectOutputStream os = new ObjectOutputStream(out);\n+        os.writeObject(obj);\n+        return out.toByteArray();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY4NzM2Nw=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzcwNTE5OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoxNjozMFrOGejceQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxMjo0NFrOGfksgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5MTE5Mw==", "bodyText": "nit: formatting , aligning all parameters", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434691193", "createdAt": "2020-06-03T16:16:30Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "diffHunk": "@@ -31,37 +25,28 @@\n \n public class AggregateDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T>{\n \n+    private final boolean isValueAggregateQuery;\n     private IDocumentQueryExecutionComponent<T> component;\n-    private Aggregator aggregator;\n     private ConcurrentMap<String, QueryMetrics> queryMetricsMap = new ConcurrentHashMap<>();\n+    private SingleGroupAggregator singleGroupAggregator;\n \n     //QueryInfo class used in PipelinedDocumentQueryExecutionContext returns a Collection of AggregateOperators\n-    //while Multiple aggregates are allowed in queries targeted at a single partition, only a single aggregate is allowed in x-partition queries (currently)\n-    public AggregateDocumentQueryExecutionContext (IDocumentQueryExecutionComponent<T> component, Collection<AggregateOperator> aggregateOperators) {\n+    public AggregateDocumentQueryExecutionContext(IDocumentQueryExecutionComponent<T> component,\n+                                                  List<AggregateOperator> aggregateOperators,\n+                                                  Map<String, AggregateOperator> groupByAliasToAggregateType,\n+                                                  List<String> orderedAliases,\n+                                                  boolean hasSelectValue,\n+                                                  String continuationToken) {\n \n         this.component = component;\n-        AggregateOperator aggregateOperator = aggregateOperators.iterator().next();\n-\n-        switch (aggregateOperator) {\n-            case Average:\n-                this.aggregator = new AverageAggregator();\n-                break;\n-            case Count:\n-                this.aggregator = new CountAggregator();\n-                break;\n-            case Max:\n-                this.aggregator = new MaxAggregator();\n-                break;\n-            case Min:\n-                this.aggregator = new MinAggregator();\n-                break;\n-            case Sum:\n-                this.aggregator = new SumAggregator();\n-                break;\n-            default:\n-                throw new IllegalStateException(\"Unexpected value: \" + aggregateOperator.toString());\n-            }\n-        }\n+        this.isValueAggregateQuery = hasSelectValue;\n+\n+        this.singleGroupAggregator = SingleGroupAggregator.create(aggregateOperators,\n+                                                                                   groupByAliasToAggregateType,\n+                                                                                   orderedAliases,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MDI1Nw==", "bodyText": "done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435760257", "createdAt": "2020-06-05T08:12:44Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "diffHunk": "@@ -31,37 +25,28 @@\n \n public class AggregateDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T>{\n \n+    private final boolean isValueAggregateQuery;\n     private IDocumentQueryExecutionComponent<T> component;\n-    private Aggregator aggregator;\n     private ConcurrentMap<String, QueryMetrics> queryMetricsMap = new ConcurrentHashMap<>();\n+    private SingleGroupAggregator singleGroupAggregator;\n \n     //QueryInfo class used in PipelinedDocumentQueryExecutionContext returns a Collection of AggregateOperators\n-    //while Multiple aggregates are allowed in queries targeted at a single partition, only a single aggregate is allowed in x-partition queries (currently)\n-    public AggregateDocumentQueryExecutionContext (IDocumentQueryExecutionComponent<T> component, Collection<AggregateOperator> aggregateOperators) {\n+    public AggregateDocumentQueryExecutionContext(IDocumentQueryExecutionComponent<T> component,\n+                                                  List<AggregateOperator> aggregateOperators,\n+                                                  Map<String, AggregateOperator> groupByAliasToAggregateType,\n+                                                  List<String> orderedAliases,\n+                                                  boolean hasSelectValue,\n+                                                  String continuationToken) {\n \n         this.component = component;\n-        AggregateOperator aggregateOperator = aggregateOperators.iterator().next();\n-\n-        switch (aggregateOperator) {\n-            case Average:\n-                this.aggregator = new AverageAggregator();\n-                break;\n-            case Count:\n-                this.aggregator = new CountAggregator();\n-                break;\n-            case Max:\n-                this.aggregator = new MaxAggregator();\n-                break;\n-            case Min:\n-                this.aggregator = new MinAggregator();\n-                break;\n-            case Sum:\n-                this.aggregator = new SumAggregator();\n-                break;\n-            default:\n-                throw new IllegalStateException(\"Unexpected value: \" + aggregateOperator.toString());\n-            }\n-        }\n+        this.isValueAggregateQuery = hasSelectValue;\n+\n+        this.singleGroupAggregator = SingleGroupAggregator.create(aggregateOperators,\n+                                                                                   groupByAliasToAggregateType,\n+                                                                                   orderedAliases,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5MTE5Mw=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzcyMDkzOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyMDoyNVrOGejmqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo0NjowMlrOGf1y6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5MzgwMg==", "bodyText": "nit: space after if", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434693802", "createdAt": "2020-06-03T16:20:25Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "diffHunk": "@@ -114,18 +103,49 @@ public AggregateDocumentQueryExecutionContext (IDocumentQueryExecutionComponent<\n                 }).flux();\n     }\n \n-    public static <T extends Resource>  Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n-            Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n-            Collection<AggregateOperator> aggregates,\n-            String continuationToken) {\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        Collection<AggregateOperator> aggregates,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> groupByAliases,\n+        boolean hasSelectValue,\n+        String continuationToken) {\n \n         return createSourceComponentFunction\n-                .apply(continuationToken)\n-                .map( component -> { return new AggregateDocumentQueryExecutionContext<T>(component, aggregates);});\n+                   .apply(continuationToken)\n+                   .map(component -> {\n+                       return new AggregateDocumentQueryExecutionContext<T>(component,\n+                                                                            new ArrayList<>(aggregates),\n+                                                                            groupByAliasToAggregateType,\n+                                                                            groupByAliases,\n+                                                                            hasSelectValue,\n+                                                                            continuationToken);\n+                   });\n     }\n \n     public IDocumentQueryExecutionComponent<T> getComponent() {\n         return this.component;\n     }\n \n+    class RewrittenAggregateProjections {\n+        private Document payload;\n+\n+        public RewrittenAggregateProjections(boolean isValueAggregateQuery, Document document) {\n+            if (document == null) {\n+                throw new IllegalArgumentException(\"document cannot be null\");\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA0MDQyNA==", "bodyText": "done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r436040424", "createdAt": "2020-06-05T16:46:02Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "diffHunk": "@@ -114,18 +103,49 @@ public AggregateDocumentQueryExecutionContext (IDocumentQueryExecutionComponent<\n                 }).flux();\n     }\n \n-    public static <T extends Resource>  Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n-            Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n-            Collection<AggregateOperator> aggregates,\n-            String continuationToken) {\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        Collection<AggregateOperator> aggregates,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> groupByAliases,\n+        boolean hasSelectValue,\n+        String continuationToken) {\n \n         return createSourceComponentFunction\n-                .apply(continuationToken)\n-                .map( component -> { return new AggregateDocumentQueryExecutionContext<T>(component, aggregates);});\n+                   .apply(continuationToken)\n+                   .map(component -> {\n+                       return new AggregateDocumentQueryExecutionContext<T>(component,\n+                                                                            new ArrayList<>(aggregates),\n+                                                                            groupByAliasToAggregateType,\n+                                                                            groupByAliases,\n+                                                                            hasSelectValue,\n+                                                                            continuationToken);\n+                   });\n     }\n \n     public IDocumentQueryExecutionComponent<T> getComponent() {\n         return this.component;\n     }\n \n+    class RewrittenAggregateProjections {\n+        private Document payload;\n+\n+        public RewrittenAggregateProjections(boolean isValueAggregateQuery, Document document) {\n+            if (document == null) {\n+                throw new IllegalArgumentException(\"document cannot be null\");\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5MzgwMg=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 152}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzcyNTA1OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyMToxOVrOGejpJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxMzozNFrOGfkuEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5NDQzNw==", "bodyText": "nit: return can be removed , implicit lambda", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434694437", "createdAt": "2020-06-03T16:21:19Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "diffHunk": "@@ -114,18 +103,49 @@ public AggregateDocumentQueryExecutionContext (IDocumentQueryExecutionComponent<\n                 }).flux();\n     }\n \n-    public static <T extends Resource>  Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n-            Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n-            Collection<AggregateOperator> aggregates,\n-            String continuationToken) {\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        Collection<AggregateOperator> aggregates,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> groupByAliases,\n+        boolean hasSelectValue,\n+        String continuationToken) {\n \n         return createSourceComponentFunction\n-                .apply(continuationToken)\n-                .map( component -> { return new AggregateDocumentQueryExecutionContext<T>(component, aggregates);});\n+                   .apply(continuationToken)\n+                   .map(component -> {\n+                       return new AggregateDocumentQueryExecutionContext<T>(component,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MDY1Nw==", "bodyText": "Wrote it like this Just to be consistent with other QueryExecutionContexts. Will eventually clean up all of them together", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435760657", "createdAt": "2020-06-05T08:13:34Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "diffHunk": "@@ -114,18 +103,49 @@ public AggregateDocumentQueryExecutionContext (IDocumentQueryExecutionComponent<\n                 }).flux();\n     }\n \n-    public static <T extends Resource>  Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n-            Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n-            Collection<AggregateOperator> aggregates,\n-            String continuationToken) {\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        Collection<AggregateOperator> aggregates,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> groupByAliases,\n+        boolean hasSelectValue,\n+        String continuationToken) {\n \n         return createSourceComponentFunction\n-                .apply(continuationToken)\n-                .map( component -> { return new AggregateDocumentQueryExecutionContext<T>(component, aggregates);});\n+                   .apply(continuationToken)\n+                   .map(component -> {\n+                       return new AggregateDocumentQueryExecutionContext<T>(component,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5NDQzNw=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 133}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzczMDc0OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyMjo0NFrOGejszQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyMjo0NFrOGejszQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5NTM3Mw==", "bodyText": "\"payload\" spread across few files , can we centralize it with constant ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434695373", "createdAt": "2020-06-03T16:22:44Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "diffHunk": "@@ -114,18 +103,49 @@ public AggregateDocumentQueryExecutionContext (IDocumentQueryExecutionComponent<\n                 }).flux();\n     }\n \n-    public static <T extends Resource>  Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n-            Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n-            Collection<AggregateOperator> aggregates,\n-            String continuationToken) {\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        Collection<AggregateOperator> aggregates,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> groupByAliases,\n+        boolean hasSelectValue,\n+        String continuationToken) {\n \n         return createSourceComponentFunction\n-                .apply(continuationToken)\n-                .map( component -> { return new AggregateDocumentQueryExecutionContext<T>(component, aggregates);});\n+                   .apply(continuationToken)\n+                   .map(component -> {\n+                       return new AggregateDocumentQueryExecutionContext<T>(component,\n+                                                                            new ArrayList<>(aggregates),\n+                                                                            groupByAliasToAggregateType,\n+                                                                            groupByAliases,\n+                                                                            hasSelectValue,\n+                                                                            continuationToken);\n+                   });\n     }\n \n     public IDocumentQueryExecutionComponent<T> getComponent() {\n         return this.component;\n     }\n \n+    class RewrittenAggregateProjections {\n+        private Document payload;\n+\n+        public RewrittenAggregateProjections(boolean isValueAggregateQuery, Document document) {\n+            if (document == null) {\n+                throw new IllegalArgumentException(\"document cannot be null\");\n+            }\n+            if (isValueAggregateQuery) {\n+                this.payload = new Document(document.getPropertyBag());\n+            } else {\n+                if (document.get(\"payload\") instanceof ObjectNode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 156}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc0MDYxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateItem.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyNDo1NFrOGejzBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyNDo1NFrOGejzBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5Njk2NA==", "bodyText": "nit: space after else", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434696964", "createdAt": "2020-06-03T16:24:54Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateItem.java", "diffHunk": "@@ -0,0 +1,40 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+public class AggregateItem {\n+    private static final String ITEM_NAME_1 = \"item\";\n+    private static final String ITEM_NAME_2 = \"item2\";\n+\n+    private final Object document;\n+\n+    public AggregateItem(Object document) {\n+        this.document = document;\n+    }\n+\n+    public Object getItem() {\n+        Object object = null;\n+        if (document instanceof Document || document instanceof ObjectNode) {\n+            ObjectNode documentNode = null;\n+            if (document instanceof Document) {\n+                documentNode = ((Document)document).getPropertyBag();\n+            } else{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc0NjkxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctContinuationToken.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyNjoyOFrOGej3CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyNjoyOFrOGej3CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5Nzk5Mg==", "bodyText": "nit: empty line after if", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434697992", "createdAt": "2020-06-03T16:26:28Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctContinuationToken.java", "diffHunk": "@@ -60,17 +64,25 @@ public void setSourceToken(String sourceToken) {\n         BridgeInternal.setProperty(this, SOURCE_TOKEN_PROPERTY_NAME, sourceToken);\n     }\n \n-    String getLastHash() {\n-        return super.getString(LAST_HASH_PROPERTY_NAME);\n+    UInt128 getLastHash() {\n+        ByteBuffer byteBuffer = super.getObject(LAST_HASH_PROPERTY_NAME, ByteBuffer.class);\n+        if (byteBuffer != null) {\n+            return new UInt128(byteBuffer);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc1ODMxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctContinuationToken.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyOTozMVrOGej-bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyOTozMVrOGej-bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5OTg4NA==", "bodyText": "do we need else, wouldn't it by default null ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434699884", "createdAt": "2020-06-03T16:29:31Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctContinuationToken.java", "diffHunk": "@@ -60,17 +64,25 @@ public void setSourceToken(String sourceToken) {\n         BridgeInternal.setProperty(this, SOURCE_TOKEN_PROPERTY_NAME, sourceToken);\n     }\n \n-    String getLastHash() {\n-        return super.getString(LAST_HASH_PROPERTY_NAME);\n+    UInt128 getLastHash() {\n+        ByteBuffer byteBuffer = super.getObject(LAST_HASH_PROPERTY_NAME, ByteBuffer.class);\n+        if (byteBuffer != null) {\n+            return new UInt128(byteBuffer);\n+        }\n+        return null;\n     }\n \n     /**\n      * Setter for property 'lastHash'.\n      *\n      * @param lastHash Value to set for property 'lastHash'.\n      */\n-    public void setLastHash(String lastHash) {\n-        BridgeInternal.setProperty(this, LAST_HASH_PROPERTY_NAME, lastHash);\n+    public void setLastHash(UInt128 lastHash) {\n+        if (lastHash != null) {\n+            BridgeInternal.setProperty(this, LAST_HASH_PROPERTY_NAME, lastHash.toByteBuffer());\n+        } else {\n+            this.set(LAST_HASH_PROPERTY_NAME, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc2NDg5OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/TopDocumentQueryExecutionContext.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjozMToxMlrOGekCwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo1MjoyOVrOGf1_Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMDk5NA==", "bodyText": "hmm, maybe can use recursion? so I think the following can be changed to:\n   private ParallelDocumentQueryExecutionContextBase<T> getContext(IDocumentQueryExecutionComponent<T> component) {\n    if (component instanceof GroupByDocumentQueryExecutionContext) {\n        return this.getContext(((GroupByDocumentQueryExecutionContext<T>) component).getComponent());\n    } if (component instanceof DistinctDocumentQueryExecutionContext) {\n        return this.getContext(((DistinctDocumentQueryExecutionContext<T>) component).getComponent());\n    } else if (component instanceof AggregateDocumentQueryExecutionContext) {\n        return this.getContext(((AggregateDocumentQueryExecutionContext<T>) component).getComponent());\n    } else if (component instanceof SkipDocumentQueryExecutionContext) {\n        return this.getContext(((SkipDocumentQueryExecutionContext<T>) component).getComponent());\n    } else {\n        return (ParallelDocumentQueryExecutionContextBase<T>) component;\n    }\n}", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434700994", "createdAt": "2020-06-03T16:31:12Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/TopDocumentQueryExecutionContext.java", "diffHunk": "@@ -138,4 +124,45 @@ public boolean test(FeedResponse<T> frp) {\n             }\n         });\n     }\n+\n+    // TODO: This could be restructured eventually with better design to avoid these many checks", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MzMxMQ==", "bodyText": "Wanted to avoid recursion deliberately to avoid the extra cost involved in recursion vs few lines of code. Also, we need to redesign the to avoid these checks all together.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435773311", "createdAt": "2020-06-05T08:36:53Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/TopDocumentQueryExecutionContext.java", "diffHunk": "@@ -138,4 +124,45 @@ public boolean test(FeedResponse<T> frp) {\n             }\n         });\n     }\n+\n+    // TODO: This could be restructured eventually with better design to avoid these many checks", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMDk5NA=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA0MzYxNQ==", "bodyText": "I see, thanks for the explanation~", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r436043615", "createdAt": "2020-06-05T16:52:29Z", "author": {"login": "xinlian12"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/TopDocumentQueryExecutionContext.java", "diffHunk": "@@ -138,4 +124,45 @@ public boolean test(FeedResponse<T> frp) {\n             }\n         });\n     }\n+\n+    // TODO: This could be restructured eventually with better design to avoid these many checks", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMDk5NA=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc2NzMxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjozMTo0OVrOGekEVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxNzozNVrOGfk16Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMTM5OQ==", "bodyText": "Constant names should be all upper case with underscores.\nARRAY_HASH_SEED", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434701399", "createdAt": "2020-06-03T16:31:49Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+\n+public class DistinctHash {\n+\n+    private static final UInt128 ArrayHashSeed = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MjY2NQ==", "bodyText": "Corrected.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435762665", "createdAt": "2020-06-05T08:17:35Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+\n+public class DistinctHash {\n+\n+    private static final UInt128 ArrayHashSeed = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMTM5OQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc3MTI3OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctMap.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjozMjo1MlrOGekG7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo0NjoxMlrOGf1zQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMjA2Mg==", "bodyText": "final string can be avoided", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434702062", "createdAt": "2020-06-03T16:32:52Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctMap.java", "diffHunk": "@@ -31,17 +28,18 @@ public static DistinctMap create(DistinctQueryType distinctQueryType, String pre\n         }\n     }\n \n-    public abstract boolean add(Resource object, Utils.ValueHolder<String> outHash);\n+    public abstract boolean add(Object object, Utils.ValueHolder<UInt128> outHash);\n \n-    String getHash(Resource resource) throws JsonProcessingException,\n-                                                 NoSuchAlgorithmException {\n-        final Object obj = OBJECT_MAPPER.treeToValue(ModelBridgeInternal.getPropertyBagFromJsonSerializable(resource)\n-            , Object.class);\n-        final String sortedJson =\n-            OBJECT_MAPPER.writeValueAsString(obj);\n-        MessageDigest md = MessageDigest.getInstance(\"SHA-1\");\n-        byte[] digest = md.digest(sortedJson.getBytes(Charset.defaultCharset()));\n-        return Base64.getEncoder().encodeToString(digest);\n+    String getSortedJsonStringValueFromResource(Resource resource) {\n+        final Object obj;\n+        try {\n+            obj = OBJECT_MAPPER.treeToValue(resource.getPropertyBag()\n+                , Object.class);\n+            final String sortedJson = OBJECT_MAPPER.writeValueAsString(obj);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA0MDUxNQ==", "bodyText": "done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r436040515", "createdAt": "2020-06-05T16:46:12Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctMap.java", "diffHunk": "@@ -31,17 +28,18 @@ public static DistinctMap create(DistinctQueryType distinctQueryType, String pre\n         }\n     }\n \n-    public abstract boolean add(Resource object, Utils.ValueHolder<String> outHash);\n+    public abstract boolean add(Object object, Utils.ValueHolder<UInt128> outHash);\n \n-    String getHash(Resource resource) throws JsonProcessingException,\n-                                                 NoSuchAlgorithmException {\n-        final Object obj = OBJECT_MAPPER.treeToValue(ModelBridgeInternal.getPropertyBagFromJsonSerializable(resource)\n-            , Object.class);\n-        final String sortedJson =\n-            OBJECT_MAPPER.writeValueAsString(obj);\n-        MessageDigest md = MessageDigest.getInstance(\"SHA-1\");\n-        byte[] digest = md.digest(sortedJson.getBytes(Charset.defaultCharset()));\n-        return Base64.getEncoder().encodeToString(digest);\n+    String getSortedJsonStringValueFromResource(Resource resource) {\n+        final Object obj;\n+        try {\n+            obj = OBJECT_MAPPER.treeToValue(resource.getPropertyBag()\n+                , Object.class);\n+            final String sortedJson = OBJECT_MAPPER.writeValueAsString(obj);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMjA2Mg=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc3ODI0OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjozNDozOVrOGekLfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxODozNlrOGfk4FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMzIyOQ==", "bodyText": "There is no API in FeedResponse#responseContinuation\nDid you mean getContinuationToken() ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434703229", "createdAt": "2020-06-03T16:34:39Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -0,0 +1,151 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosException;\n+import com.azure.cosmos.implementation.BadRequestException;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.Resource;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public class GroupByDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T> {\n+\n+    public static final String CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY = \"Continuation token is not supported \" +\n+                                                                                    \"for queries with GROUP BY.\" +\n+                                                                                    \"Do not use FeedResponse#\" +\n+                                                                                    \"responseContinuation\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MzIyMQ==", "bodyText": "Changed the text to just continuation token, so should function names should not matter anymore", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435763221", "createdAt": "2020-06-05T08:18:36Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -0,0 +1,151 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosException;\n+import com.azure.cosmos.implementation.BadRequestException;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.Resource;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public class GroupByDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T> {\n+\n+    public static final String CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY = \"Continuation token is not supported \" +\n+                                                                                    \"for queries with GROUP BY.\" +\n+                                                                                    \"Do not use FeedResponse#\" +\n+                                                                                    \"responseContinuation\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMzIyOQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc4MDc5OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjozNToxNlrOGekNEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxMzo0MlrOGfkuUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMzYzMg==", "bodyText": "nit: extra line after if", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434703632", "createdAt": "2020-06-03T16:35:16Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -0,0 +1,151 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosException;\n+import com.azure.cosmos.implementation.BadRequestException;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.Resource;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public class GroupByDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T> {\n+\n+    public static final String CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY = \"Continuation token is not supported \" +\n+                                                                                    \"for queries with GROUP BY.\" +\n+                                                                                    \"Do not use FeedResponse#\" +\n+                                                                                    \"responseContinuation\" +\n+                                                                                    \" or remove the GROUP BY \" +\n+                                                                                    \"from the query.\";\n+    private final IDocumentQueryExecutionComponent<T> component;\n+    private final GroupingTable groupingTable;\n+\n+    GroupByDocumentQueryExecutionContext(\n+        IDocumentQueryExecutionComponent<T> component,\n+        GroupingTable groupingTable) {\n+        this.component = component;\n+        this.groupingTable = groupingTable;\n+    }\n+\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        String continuationToken,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        if (continuationToken != null) {\n+            CosmosException dce = new BadRequestException(CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY);\n+            return Flux.error(dce);\n+        }\n+        GroupingTable table = new GroupingTable(groupByAliasToAggregateType, orderedAliases, hasSelectValue);\n+        // Have to pass non-null continuation token once supported\n+        return createSourceComponentFunction.apply(null)\n+                   .map(component -> new GroupByDocumentQueryExecutionContext<>(component,\n+                                                                                table));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    @Override\n+    public Flux<FeedResponse<T>> drainAsync(int maxPageSize) {\n+        return this.component.drainAsync(maxPageSize)\n+                   .collectList()\n+                   .map(superList -> {\n+                       double requestCharge = 0;\n+                       HashMap<String, String> headers = new HashMap<>();\n+                       List<Document> documentList = new ArrayList<>();\n+                       /* Do groupby stuff here */\n+                       // Stage 1:\n+                       // Drain the groupings fully from all continuation and all partitions\n+                       for (FeedResponse<T> page : superList) {\n+                           List<Document> results = (List<Document>) page.getResults();\n+                           documentList.addAll(results);\n+                       }\n+\n+                       this.aggregateGroupings(documentList);\n+\n+                       // Stage 2:\n+                       // Emit the results from the grouping table page by page\n+\n+                       List<Document> groupByResults = this.groupingTable.drain(maxPageSize);\n+\n+                       headers.put(HttpConstants.HttpHeaders.REQUEST_CHARGE, Double.toString(requestCharge));\n+                       FeedResponse<Document> frp =\n+                           BridgeInternal.createFeedResponse(groupByResults, headers);\n+\n+                       return (FeedResponse<T>) frp;\n+                   }).flux();\n+    }\n+\n+    private void aggregateGroupings(List<Document> superList) {\n+        for (Document d : superList) {\n+            RewrittenGroupByProjection rewrittenGroupByProjection =\n+                new RewrittenGroupByProjection(ModelBridgeInternal.getPropertyBagFromJsonSerializable(d));\n+            this.groupingTable.addPayLoad(rewrittenGroupByProjection);\n+        }\n+    }\n+\n+    IDocumentQueryExecutionComponent<T> getComponent() {\n+        return this.component;\n+    }\n+\n+    /**\n+     * When a group by query gets rewritten the projection looks like:\n+     * <p>\n+     * SELECT\n+     * [{\"item\": c.age}, {\"item\": c.name}] AS groupByItems,\n+     * {\"age\": c.age, \"name\": c.name} AS payload\n+     * <p>\n+     * This class just lets us easily access the \"groupByItems\" and \"payload\" property.\n+     */\n+    public class RewrittenGroupByProjection extends JsonSerializable {\n+        private static final String GroupByItemsPropertyName = \"groupByItems\";\n+        private static final String PayloadPropertyName = \"payload\";\n+\n+        private List<Document> groupByItems;\n+\n+        public RewrittenGroupByProjection(ObjectNode objectNode) {\n+            super(objectNode);\n+            if (objectNode == null) {\n+                throw new IllegalArgumentException(\"objectNode can not be null\");\n+            }\n+        }\n+\n+        /**\n+         * Getter for property 'groupByItems'.\n+         *\n+         * @return Value for property 'groupByItems'.\n+         */\n+        public List<Document> getGroupByItems() {\n+            groupByItems = this.getList(GroupByItemsPropertyName, Document.class);\n+            if (groupByItems == null) {\n+                throw new IllegalStateException(\"Underlying object does not have an 'groupByItems' field.\");\n+            }\n+            return groupByItems;\n+        }\n+\n+        /**\n+         * Getter for property 'payload'.\n+         *\n+         * @return Value for property 'payload'.\n+         */\n+        public Document getPayload() {\n+            Document document = new Document((ObjectNode) this.get(PayloadPropertyName));\n+            if (document == null) {\n+                throw new IllegalStateException(\"Underlying object does not have an 'payload' field.\");\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 147}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MDcyMg==", "bodyText": "done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435760722", "createdAt": "2020-06-05T08:13:42Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -0,0 +1,151 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosException;\n+import com.azure.cosmos.implementation.BadRequestException;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.Resource;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public class GroupByDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T> {\n+\n+    public static final String CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY = \"Continuation token is not supported \" +\n+                                                                                    \"for queries with GROUP BY.\" +\n+                                                                                    \"Do not use FeedResponse#\" +\n+                                                                                    \"responseContinuation\" +\n+                                                                                    \" or remove the GROUP BY \" +\n+                                                                                    \"from the query.\";\n+    private final IDocumentQueryExecutionComponent<T> component;\n+    private final GroupingTable groupingTable;\n+\n+    GroupByDocumentQueryExecutionContext(\n+        IDocumentQueryExecutionComponent<T> component,\n+        GroupingTable groupingTable) {\n+        this.component = component;\n+        this.groupingTable = groupingTable;\n+    }\n+\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        String continuationToken,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        if (continuationToken != null) {\n+            CosmosException dce = new BadRequestException(CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY);\n+            return Flux.error(dce);\n+        }\n+        GroupingTable table = new GroupingTable(groupByAliasToAggregateType, orderedAliases, hasSelectValue);\n+        // Have to pass non-null continuation token once supported\n+        return createSourceComponentFunction.apply(null)\n+                   .map(component -> new GroupByDocumentQueryExecutionContext<>(component,\n+                                                                                table));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    @Override\n+    public Flux<FeedResponse<T>> drainAsync(int maxPageSize) {\n+        return this.component.drainAsync(maxPageSize)\n+                   .collectList()\n+                   .map(superList -> {\n+                       double requestCharge = 0;\n+                       HashMap<String, String> headers = new HashMap<>();\n+                       List<Document> documentList = new ArrayList<>();\n+                       /* Do groupby stuff here */\n+                       // Stage 1:\n+                       // Drain the groupings fully from all continuation and all partitions\n+                       for (FeedResponse<T> page : superList) {\n+                           List<Document> results = (List<Document>) page.getResults();\n+                           documentList.addAll(results);\n+                       }\n+\n+                       this.aggregateGroupings(documentList);\n+\n+                       // Stage 2:\n+                       // Emit the results from the grouping table page by page\n+\n+                       List<Document> groupByResults = this.groupingTable.drain(maxPageSize);\n+\n+                       headers.put(HttpConstants.HttpHeaders.REQUEST_CHARGE, Double.toString(requestCharge));\n+                       FeedResponse<Document> frp =\n+                           BridgeInternal.createFeedResponse(groupByResults, headers);\n+\n+                       return (FeedResponse<T>) frp;\n+                   }).flux();\n+    }\n+\n+    private void aggregateGroupings(List<Document> superList) {\n+        for (Document d : superList) {\n+            RewrittenGroupByProjection rewrittenGroupByProjection =\n+                new RewrittenGroupByProjection(ModelBridgeInternal.getPropertyBagFromJsonSerializable(d));\n+            this.groupingTable.addPayLoad(rewrittenGroupByProjection);\n+        }\n+    }\n+\n+    IDocumentQueryExecutionComponent<T> getComponent() {\n+        return this.component;\n+    }\n+\n+    /**\n+     * When a group by query gets rewritten the projection looks like:\n+     * <p>\n+     * SELECT\n+     * [{\"item\": c.age}, {\"item\": c.name}] AS groupByItems,\n+     * {\"age\": c.age, \"name\": c.name} AS payload\n+     * <p>\n+     * This class just lets us easily access the \"groupByItems\" and \"payload\" property.\n+     */\n+    public class RewrittenGroupByProjection extends JsonSerializable {\n+        private static final String GroupByItemsPropertyName = \"groupByItems\";\n+        private static final String PayloadPropertyName = \"payload\";\n+\n+        private List<Document> groupByItems;\n+\n+        public RewrittenGroupByProjection(ObjectNode objectNode) {\n+            super(objectNode);\n+            if (objectNode == null) {\n+                throw new IllegalArgumentException(\"objectNode can not be null\");\n+            }\n+        }\n+\n+        /**\n+         * Getter for property 'groupByItems'.\n+         *\n+         * @return Value for property 'groupByItems'.\n+         */\n+        public List<Document> getGroupByItems() {\n+            groupByItems = this.getList(GroupByItemsPropertyName, Document.class);\n+            if (groupByItems == null) {\n+                throw new IllegalStateException(\"Underlying object does not have an 'groupByItems' field.\");\n+            }\n+            return groupByItems;\n+        }\n+\n+        /**\n+         * Getter for property 'payload'.\n+         *\n+         * @return Value for property 'payload'.\n+         */\n+        public Document getPayload() {\n+            Document document = new Document((ObjectNode) this.get(PayloadPropertyName));\n+            if (document == null) {\n+                throw new IllegalStateException(\"Underlying object does not have an 'payload' field.\");\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMzYzMg=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 147}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc4NjQxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjozNjo0MFrOGekQuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxNDoxOFrOGfkvjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwNDU2OQ==", "bodyText": "can keys be null ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434704569", "createdAt": "2020-06-03T16:36:40Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();\n+\n+    private final Map<UInt128, SingleGroupAggregator> table;\n+    private final Map<String, AggregateOperator> groupByAliasToAggregateType;\n+    private final List<String> orderedAliases;\n+    private final boolean hasSelectValue;\n+\n+    GroupingTable(Map<String, AggregateOperator> groupByAliasToAggregateType, List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        this.table = new HashMap<>();\n+        this.groupByAliasToAggregateType = groupByAliasToAggregateType;\n+        this.orderedAliases = orderedAliases;\n+        this.hasSelectValue = hasSelectValue;\n+    }\n+\n+    public void addPayLoad(GroupByDocumentQueryExecutionContext<?>.RewrittenGroupByProjection rewrittenGroupByProjection) {\n+        try {\n+            final UInt128 groupByKeysHash = DistinctHash.getHash(rewrittenGroupByProjection.getGroupByItems());\n+            SingleGroupAggregator singleGroupAggregator;\n+            if (!this.table.containsKey(groupByKeysHash)) {\n+                singleGroupAggregator = SingleGroupAggregator.create(EmptyAggregateOperators,\n+                                                                     this.groupByAliasToAggregateType,\n+                                                                     this.orderedAliases,\n+                                                                     this.hasSelectValue,\n+                                                                      /*continuationtoken*/ null);\n+                this.table.put(groupByKeysHash, singleGroupAggregator);\n+            } else {\n+                singleGroupAggregator = table.get(groupByKeysHash);\n+            }\n+\n+            singleGroupAggregator.addValues(rewrittenGroupByProjection.getPayload());\n+\n+        } catch (IOException e) {\n+            throw new IllegalStateException(\"Failed to add payload to groupby projection\", e);\n+        }\n+    }\n+\n+    public List<Document> drain(int maxItemCount) {\n+        Collection<UInt128> keys = this.table.keySet().stream().limit(maxItemCount).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MTAzNg==", "bodyText": "collect will always initialize the list, so can never be null even when stream is empty", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435761036", "createdAt": "2020-06-05T08:14:18Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();\n+\n+    private final Map<UInt128, SingleGroupAggregator> table;\n+    private final Map<String, AggregateOperator> groupByAliasToAggregateType;\n+    private final List<String> orderedAliases;\n+    private final boolean hasSelectValue;\n+\n+    GroupingTable(Map<String, AggregateOperator> groupByAliasToAggregateType, List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        this.table = new HashMap<>();\n+        this.groupByAliasToAggregateType = groupByAliasToAggregateType;\n+        this.orderedAliases = orderedAliases;\n+        this.hasSelectValue = hasSelectValue;\n+    }\n+\n+    public void addPayLoad(GroupByDocumentQueryExecutionContext<?>.RewrittenGroupByProjection rewrittenGroupByProjection) {\n+        try {\n+            final UInt128 groupByKeysHash = DistinctHash.getHash(rewrittenGroupByProjection.getGroupByItems());\n+            SingleGroupAggregator singleGroupAggregator;\n+            if (!this.table.containsKey(groupByKeysHash)) {\n+                singleGroupAggregator = SingleGroupAggregator.create(EmptyAggregateOperators,\n+                                                                     this.groupByAliasToAggregateType,\n+                                                                     this.orderedAliases,\n+                                                                     this.hasSelectValue,\n+                                                                      /*continuationtoken*/ null);\n+                this.table.put(groupByKeysHash, singleGroupAggregator);\n+            } else {\n+                singleGroupAggregator = table.get(groupByKeysHash);\n+            }\n+\n+            singleGroupAggregator.addValues(rewrittenGroupByProjection.getPayload());\n+\n+        } catch (IOException e) {\n+            throw new IllegalStateException(\"Failed to add payload to groupby projection\", e);\n+        }\n+    }\n+\n+    public List<Document> drain(int maxItemCount) {\n+        Collection<UInt128> keys = this.table.keySet().stream().limit(maxItemCount).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwNDU2OQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc5NzM5OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjozOTo1MVrOGekYMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOTowOTo0NVrOGeppTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwNjQ4Mw==", "bodyText": "these two if can be merged", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434706483", "createdAt": "2020-06-03T16:39:51Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "diffHunk": "@@ -0,0 +1,316 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.Constants;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.Undefined;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.query.aggregation.Aggregator;\n+import com.azure.cosmos.implementation.query.aggregation.AverageAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.CountAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MaxAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MinAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.SumAggregator;\n+import com.azure.cosmos.implementation.Resource;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Aggregates all the projections for a single grouping.\n+ */\n+public abstract class SingleGroupAggregator {\n+\n+    public static SingleGroupAggregator create(List<AggregateOperator> aggregates,\n+                                               Map<String, AggregateOperator> aggregateAliasToAggregateType,\n+                                               List<String> orderedAliases,\n+                                               boolean hasSelectValue,\n+                                               String continuationToken) {\n+\n+        if (aggregates == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        if (aggregateAliasToAggregateType == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5Mjc4MA==", "bodyText": "You want to keep them separate so you know which one was null.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434792780", "createdAt": "2020-06-03T19:09:45Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "diffHunk": "@@ -0,0 +1,316 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.Constants;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.Undefined;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.query.aggregation.Aggregator;\n+import com.azure.cosmos.implementation.query.aggregation.AverageAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.CountAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MaxAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MinAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.SumAggregator;\n+import com.azure.cosmos.implementation.Resource;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Aggregates all the projections for a single grouping.\n+ */\n+public abstract class SingleGroupAggregator {\n+\n+    public static SingleGroupAggregator create(List<AggregateOperator> aggregates,\n+                                               Map<String, AggregateOperator> aggregateAliasToAggregateType,\n+                                               List<String> orderedAliases,\n+                                               boolean hasSelectValue,\n+                                               String continuationToken) {\n+\n+        if (aggregates == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        if (aggregateAliasToAggregateType == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwNjQ4Mw=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzgxMDAxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjo0Mjo1OFrOGekgKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxNDo0NlrOGfkwaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwODUyMQ==", "bodyText": "What is the use of map here ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434708521", "createdAt": "2020-06-03T16:42:58Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "diffHunk": "@@ -0,0 +1,316 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.Constants;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.Undefined;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.query.aggregation.Aggregator;\n+import com.azure.cosmos.implementation.query.aggregation.AverageAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.CountAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MaxAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MinAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.SumAggregator;\n+import com.azure.cosmos.implementation.Resource;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Aggregates all the projections for a single grouping.\n+ */\n+public abstract class SingleGroupAggregator {\n+\n+    public static SingleGroupAggregator create(List<AggregateOperator> aggregates,\n+                                               Map<String, AggregateOperator> aggregateAliasToAggregateType,\n+                                               List<String> orderedAliases,\n+                                               boolean hasSelectValue,\n+                                               String continuationToken) {\n+\n+        if (aggregates == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        if (aggregateAliasToAggregateType == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        SingleGroupAggregator singleGroupAggregator;\n+\n+        if (hasSelectValue) {\n+            if (!aggregates.isEmpty()) {\n+                // SELECT VALUE <AGGREGATE>\n+                singleGroupAggregator = SelectValueAggregateValues.create(\n+                    aggregates.get(0),\n+                    continuationToken);\n+            } else {\n+                // SELECT VALUE <NON AGGREGATE>\n+                singleGroupAggregator = SelectValueAggregateValues.create(\n+                    null, continuationToken);\n+            }\n+        } else {\n+            singleGroupAggregator = SelectListAggregateValues.create(\n+                aggregateAliasToAggregateType,\n+                orderedAliases,\n+                continuationToken);\n+        }\n+\n+        return singleGroupAggregator;\n+    }\n+\n+    /**\n+     * Adds the payload for group by values\n+     * @param values\n+     */\n+    public abstract void addValues(Document values);\n+\n+    /**\n+     * Forms the final result of the grouping.\n+     * @return Document\n+     */\n+    public abstract Document getResult();\n+\n+    public abstract Resource getDocumentContinuationToken();\n+\n+    /**\n+     * For SELECT VALUE queries there is only one value for each grouping.\n+     * This class just helps maintain that and captures the first value across all continuations.\n+     */\n+    public static class SelectValueAggregateValues extends SingleGroupAggregator {\n+        private final AggregateValue aggregateValue;\n+\n+        public SelectValueAggregateValues(AggregateValue aggregateValue) {\n+            //TODO: null check\n+            this.aggregateValue = aggregateValue;\n+        }\n+\n+        public static SingleGroupAggregator create(AggregateOperator aggregateOperator, String continuationToken) {\n+            AggregateValue aggregateValue = AggregateValue.create(aggregateOperator, continuationToken);\n+            return new SelectValueAggregateValues(aggregateValue);\n+        }\n+\n+        @Override\n+        public void addValues(Document values) {\n+            this.aggregateValue.addValue(values);\n+        }\n+\n+        @Override\n+        public Document getResult() {\n+            Document document;\n+            Object result = aggregateValue.getResult();\n+            if (result instanceof Document) {\n+                document = (Document) aggregateValue.getResult();\n+            } else {\n+                document = new Document();\n+                if (result instanceof Undefined) {\n+                    result = null;\n+                }\n+                // This is for value queries.Need to append value property for scalar values (non key value pairs)\n+                // to make them a key value pair document as our impl is based on Document.\n+                document.set(Constants.Properties.VALUE, result);\n+            }\n+            return document;\n+        }\n+\n+        @Override\n+        public Resource getDocumentContinuationToken() {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * For select list queries we need to create a dictionary of alias to group by value.\n+     * For each grouping drained from the backend we merge it with the results here.\n+     * At the end this class will form a JSON object with the correct aliases and grouping result.\n+     */\n+    public static class SelectListAggregateValues extends SingleGroupAggregator {\n+        Map<String, AggregateValue> aliasToValue;\n+        List<String> orderedAliases;\n+\n+        private SelectListAggregateValues(\n+            Map<String, AggregateValue> aliasToValue,\n+            List<String> orderedAliases) {\n+            this.aliasToValue = aliasToValue;\n+            this.orderedAliases = orderedAliases;\n+        }\n+\n+        public static SingleGroupAggregator create(\n+            Map<String, AggregateOperator> aggregateAliasToAggregateType, List<String> orderedAliases,\n+            String continuationToken) {\n+            if (aggregateAliasToAggregateType == null) {\n+                throw new IllegalArgumentException(\"aggregateAliasToAggregateType cannot be null\");\n+            }\n+\n+            if (orderedAliases == null) {\n+                throw new IllegalArgumentException(\"orderedAliases cannot be null\");\n+            }\n+\n+            Map<String, AggregateValue> groupingTable = new HashMap<>();\n+\n+            for (Map.Entry<String, AggregateOperator> aliasToAggregate : aggregateAliasToAggregateType.entrySet()) {\n+                String alias = aliasToAggregate.getKey();\n+                AggregateOperator aggregateOperator = null;\n+                if (aliasToAggregate.getValue() != null) {\n+                    aggregateOperator = AggregateOperator.valueOf(String.valueOf(aliasToAggregate.getValue()));\n+                }\n+                AggregateValue aggregateValue = AggregateValue.create(aggregateOperator, continuationToken);\n+                groupingTable.put(alias, aggregateValue);\n+\n+            }\n+            return new SelectListAggregateValues(groupingTable, orderedAliases);\n+        }\n+\n+        @Override\n+        public void addValues(Document values) {\n+            for (Map.Entry<String, AggregateValue> aliasAndValue : this.aliasToValue.entrySet()) {\n+                String alias = aliasAndValue.getKey();\n+                AggregateValue aggregateValue = aliasAndValue.getValue();\n+                aggregateValue.addValue(values.get(alias));\n+            }\n+        }\n+\n+        @Override\n+        public Document getResult() {\n+            Document aggregateDocument = new Document();\n+            for (String alias : this.orderedAliases) {\n+                AggregateValue aggregateValue = this.aliasToValue.get(alias);\n+                if (aggregateValue.getResult() != null) {\n+                    Map<String, Object> map = new HashMap<>();\n+                    map.put(alias,  aggregateValue.getResult());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 186}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MTI1OQ==", "bodyText": "Stale code, removed.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435761259", "createdAt": "2020-06-05T08:14:46Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "diffHunk": "@@ -0,0 +1,316 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.Constants;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.Undefined;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.query.aggregation.Aggregator;\n+import com.azure.cosmos.implementation.query.aggregation.AverageAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.CountAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MaxAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MinAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.SumAggregator;\n+import com.azure.cosmos.implementation.Resource;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Aggregates all the projections for a single grouping.\n+ */\n+public abstract class SingleGroupAggregator {\n+\n+    public static SingleGroupAggregator create(List<AggregateOperator> aggregates,\n+                                               Map<String, AggregateOperator> aggregateAliasToAggregateType,\n+                                               List<String> orderedAliases,\n+                                               boolean hasSelectValue,\n+                                               String continuationToken) {\n+\n+        if (aggregates == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        if (aggregateAliasToAggregateType == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        SingleGroupAggregator singleGroupAggregator;\n+\n+        if (hasSelectValue) {\n+            if (!aggregates.isEmpty()) {\n+                // SELECT VALUE <AGGREGATE>\n+                singleGroupAggregator = SelectValueAggregateValues.create(\n+                    aggregates.get(0),\n+                    continuationToken);\n+            } else {\n+                // SELECT VALUE <NON AGGREGATE>\n+                singleGroupAggregator = SelectValueAggregateValues.create(\n+                    null, continuationToken);\n+            }\n+        } else {\n+            singleGroupAggregator = SelectListAggregateValues.create(\n+                aggregateAliasToAggregateType,\n+                orderedAliases,\n+                continuationToken);\n+        }\n+\n+        return singleGroupAggregator;\n+    }\n+\n+    /**\n+     * Adds the payload for group by values\n+     * @param values\n+     */\n+    public abstract void addValues(Document values);\n+\n+    /**\n+     * Forms the final result of the grouping.\n+     * @return Document\n+     */\n+    public abstract Document getResult();\n+\n+    public abstract Resource getDocumentContinuationToken();\n+\n+    /**\n+     * For SELECT VALUE queries there is only one value for each grouping.\n+     * This class just helps maintain that and captures the first value across all continuations.\n+     */\n+    public static class SelectValueAggregateValues extends SingleGroupAggregator {\n+        private final AggregateValue aggregateValue;\n+\n+        public SelectValueAggregateValues(AggregateValue aggregateValue) {\n+            //TODO: null check\n+            this.aggregateValue = aggregateValue;\n+        }\n+\n+        public static SingleGroupAggregator create(AggregateOperator aggregateOperator, String continuationToken) {\n+            AggregateValue aggregateValue = AggregateValue.create(aggregateOperator, continuationToken);\n+            return new SelectValueAggregateValues(aggregateValue);\n+        }\n+\n+        @Override\n+        public void addValues(Document values) {\n+            this.aggregateValue.addValue(values);\n+        }\n+\n+        @Override\n+        public Document getResult() {\n+            Document document;\n+            Object result = aggregateValue.getResult();\n+            if (result instanceof Document) {\n+                document = (Document) aggregateValue.getResult();\n+            } else {\n+                document = new Document();\n+                if (result instanceof Undefined) {\n+                    result = null;\n+                }\n+                // This is for value queries.Need to append value property for scalar values (non key value pairs)\n+                // to make them a key value pair document as our impl is based on Document.\n+                document.set(Constants.Properties.VALUE, result);\n+            }\n+            return document;\n+        }\n+\n+        @Override\n+        public Resource getDocumentContinuationToken() {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * For select list queries we need to create a dictionary of alias to group by value.\n+     * For each grouping drained from the backend we merge it with the results here.\n+     * At the end this class will form a JSON object with the correct aliases and grouping result.\n+     */\n+    public static class SelectListAggregateValues extends SingleGroupAggregator {\n+        Map<String, AggregateValue> aliasToValue;\n+        List<String> orderedAliases;\n+\n+        private SelectListAggregateValues(\n+            Map<String, AggregateValue> aliasToValue,\n+            List<String> orderedAliases) {\n+            this.aliasToValue = aliasToValue;\n+            this.orderedAliases = orderedAliases;\n+        }\n+\n+        public static SingleGroupAggregator create(\n+            Map<String, AggregateOperator> aggregateAliasToAggregateType, List<String> orderedAliases,\n+            String continuationToken) {\n+            if (aggregateAliasToAggregateType == null) {\n+                throw new IllegalArgumentException(\"aggregateAliasToAggregateType cannot be null\");\n+            }\n+\n+            if (orderedAliases == null) {\n+                throw new IllegalArgumentException(\"orderedAliases cannot be null\");\n+            }\n+\n+            Map<String, AggregateValue> groupingTable = new HashMap<>();\n+\n+            for (Map.Entry<String, AggregateOperator> aliasToAggregate : aggregateAliasToAggregateType.entrySet()) {\n+                String alias = aliasToAggregate.getKey();\n+                AggregateOperator aggregateOperator = null;\n+                if (aliasToAggregate.getValue() != null) {\n+                    aggregateOperator = AggregateOperator.valueOf(String.valueOf(aliasToAggregate.getValue()));\n+                }\n+                AggregateValue aggregateValue = AggregateValue.create(aggregateOperator, continuationToken);\n+                groupingTable.put(alias, aggregateValue);\n+\n+            }\n+            return new SelectListAggregateValues(groupingTable, orderedAliases);\n+        }\n+\n+        @Override\n+        public void addValues(Document values) {\n+            for (Map.Entry<String, AggregateValue> aliasAndValue : this.aliasToValue.entrySet()) {\n+                String alias = aliasAndValue.getKey();\n+                AggregateValue aggregateValue = aliasAndValue.getValue();\n+                aggregateValue.addValue(values.get(alias));\n+            }\n+        }\n+\n+        @Override\n+        public Document getResult() {\n+            Document aggregateDocument = new Document();\n+            for (String alias : this.orderedAliases) {\n+                AggregateValue aggregateValue = this.aliasToValue.get(alias);\n+                if (aggregateValue.getResult() != null) {\n+                    Map<String, Object> map = new HashMap<>();\n+                    map.put(alias,  aggregateValue.getResult());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwODUyMQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 186}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzgzMzMyOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjo0ODozNFrOGekuqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxNzo0N1rOGfk2YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcxMjIzNQ==", "bodyText": "Please follow java naming conventions here.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434712235", "createdAt": "2020-06-03T16:48:34Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -0,0 +1,151 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosException;\n+import com.azure.cosmos.implementation.BadRequestException;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.Resource;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public class GroupByDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T> {\n+\n+    public static final String CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY = \"Continuation token is not supported \" +\n+                                                                                    \"for queries with GROUP BY.\" +\n+                                                                                    \"Do not use FeedResponse#\" +\n+                                                                                    \"responseContinuation\" +\n+                                                                                    \" or remove the GROUP BY \" +\n+                                                                                    \"from the query.\";\n+    private final IDocumentQueryExecutionComponent<T> component;\n+    private final GroupingTable groupingTable;\n+\n+    GroupByDocumentQueryExecutionContext(\n+        IDocumentQueryExecutionComponent<T> component,\n+        GroupingTable groupingTable) {\n+        this.component = component;\n+        this.groupingTable = groupingTable;\n+    }\n+\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        String continuationToken,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        if (continuationToken != null) {\n+            CosmosException dce = new BadRequestException(CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY);\n+            return Flux.error(dce);\n+        }\n+        GroupingTable table = new GroupingTable(groupByAliasToAggregateType, orderedAliases, hasSelectValue);\n+        // Have to pass non-null continuation token once supported\n+        return createSourceComponentFunction.apply(null)\n+                   .map(component -> new GroupByDocumentQueryExecutionContext<>(component,\n+                                                                                table));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    @Override\n+    public Flux<FeedResponse<T>> drainAsync(int maxPageSize) {\n+        return this.component.drainAsync(maxPageSize)\n+                   .collectList()\n+                   .map(superList -> {\n+                       double requestCharge = 0;\n+                       HashMap<String, String> headers = new HashMap<>();\n+                       List<Document> documentList = new ArrayList<>();\n+                       /* Do groupby stuff here */\n+                       // Stage 1:\n+                       // Drain the groupings fully from all continuation and all partitions\n+                       for (FeedResponse<T> page : superList) {\n+                           List<Document> results = (List<Document>) page.getResults();\n+                           documentList.addAll(results);\n+                       }\n+\n+                       this.aggregateGroupings(documentList);\n+\n+                       // Stage 2:\n+                       // Emit the results from the grouping table page by page\n+\n+                       List<Document> groupByResults = this.groupingTable.drain(maxPageSize);\n+\n+                       headers.put(HttpConstants.HttpHeaders.REQUEST_CHARGE, Double.toString(requestCharge));\n+                       FeedResponse<Document> frp =\n+                           BridgeInternal.createFeedResponse(groupByResults, headers);\n+\n+                       return (FeedResponse<T>) frp;\n+                   }).flux();\n+    }\n+\n+    private void aggregateGroupings(List<Document> superList) {\n+        for (Document d : superList) {\n+            RewrittenGroupByProjection rewrittenGroupByProjection =\n+                new RewrittenGroupByProjection(ModelBridgeInternal.getPropertyBagFromJsonSerializable(d));\n+            this.groupingTable.addPayLoad(rewrittenGroupByProjection);\n+        }\n+    }\n+\n+    IDocumentQueryExecutionComponent<T> getComponent() {\n+        return this.component;\n+    }\n+\n+    /**\n+     * When a group by query gets rewritten the projection looks like:\n+     * <p>\n+     * SELECT\n+     * [{\"item\": c.age}, {\"item\": c.name}] AS groupByItems,\n+     * {\"age\": c.age, \"name\": c.name} AS payload\n+     * <p>\n+     * This class just lets us easily access the \"groupByItems\" and \"payload\" property.\n+     */\n+    public class RewrittenGroupByProjection extends JsonSerializable {\n+        private static final String GroupByItemsPropertyName = \"groupByItems\";\n+        private static final String PayloadPropertyName = \"payload\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2Mjc4NA==", "bodyText": "Done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435762784", "createdAt": "2020-06-05T08:17:47Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -0,0 +1,151 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosException;\n+import com.azure.cosmos.implementation.BadRequestException;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.Resource;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public class GroupByDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T> {\n+\n+    public static final String CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY = \"Continuation token is not supported \" +\n+                                                                                    \"for queries with GROUP BY.\" +\n+                                                                                    \"Do not use FeedResponse#\" +\n+                                                                                    \"responseContinuation\" +\n+                                                                                    \" or remove the GROUP BY \" +\n+                                                                                    \"from the query.\";\n+    private final IDocumentQueryExecutionComponent<T> component;\n+    private final GroupingTable groupingTable;\n+\n+    GroupByDocumentQueryExecutionContext(\n+        IDocumentQueryExecutionComponent<T> component,\n+        GroupingTable groupingTable) {\n+        this.component = component;\n+        this.groupingTable = groupingTable;\n+    }\n+\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        String continuationToken,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        if (continuationToken != null) {\n+            CosmosException dce = new BadRequestException(CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY);\n+            return Flux.error(dce);\n+        }\n+        GroupingTable table = new GroupingTable(groupByAliasToAggregateType, orderedAliases, hasSelectValue);\n+        // Have to pass non-null continuation token once supported\n+        return createSourceComponentFunction.apply(null)\n+                   .map(component -> new GroupByDocumentQueryExecutionContext<>(component,\n+                                                                                table));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    @Override\n+    public Flux<FeedResponse<T>> drainAsync(int maxPageSize) {\n+        return this.component.drainAsync(maxPageSize)\n+                   .collectList()\n+                   .map(superList -> {\n+                       double requestCharge = 0;\n+                       HashMap<String, String> headers = new HashMap<>();\n+                       List<Document> documentList = new ArrayList<>();\n+                       /* Do groupby stuff here */\n+                       // Stage 1:\n+                       // Drain the groupings fully from all continuation and all partitions\n+                       for (FeedResponse<T> page : superList) {\n+                           List<Document> results = (List<Document>) page.getResults();\n+                           documentList.addAll(results);\n+                       }\n+\n+                       this.aggregateGroupings(documentList);\n+\n+                       // Stage 2:\n+                       // Emit the results from the grouping table page by page\n+\n+                       List<Document> groupByResults = this.groupingTable.drain(maxPageSize);\n+\n+                       headers.put(HttpConstants.HttpHeaders.REQUEST_CHARGE, Double.toString(requestCharge));\n+                       FeedResponse<Document> frp =\n+                           BridgeInternal.createFeedResponse(groupByResults, headers);\n+\n+                       return (FeedResponse<T>) frp;\n+                   }).flux();\n+    }\n+\n+    private void aggregateGroupings(List<Document> superList) {\n+        for (Document d : superList) {\n+            RewrittenGroupByProjection rewrittenGroupByProjection =\n+                new RewrittenGroupByProjection(ModelBridgeInternal.getPropertyBagFromJsonSerializable(d));\n+            this.groupingTable.addPayLoad(rewrittenGroupByProjection);\n+        }\n+    }\n+\n+    IDocumentQueryExecutionComponent<T> getComponent() {\n+        return this.component;\n+    }\n+\n+    /**\n+     * When a group by query gets rewritten the projection looks like:\n+     * <p>\n+     * SELECT\n+     * [{\"item\": c.age}, {\"item\": c.name}] AS groupByItems,\n+     * {\"age\": c.age, \"name\": c.name} AS payload\n+     * <p>\n+     * This class just lets us easily access the \"groupByItems\" and \"payload\" property.\n+     */\n+    public class RewrittenGroupByProjection extends JsonSerializable {\n+        private static final String GroupByItemsPropertyName = \"groupByItems\";\n+        private static final String PayloadPropertyName = \"payload\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcxMjIzNQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzg0NzM5OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjo1MjoyNFrOGek34g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxNzo1NFrOGfk2ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcxNDU5NA==", "bodyText": "Here as well - naming.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434714594", "createdAt": "2020-06-03T16:52:24Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2Mjg0Ng==", "bodyText": "done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435762846", "createdAt": "2020-06-05T08:17:54Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcxNDU5NA=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzg4MTQxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzowMToxNFrOGelNew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo1MjoyOVrOGepFZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMDEyMw==", "bodyText": "why is this needed?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434720123", "createdAt": "2020-06-03T17:01:14Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+\n+public class DistinctHash {\n+\n+    private static final UInt128 ArrayHashSeed = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);\n+\n+    private static final ObjectMapper OBJECT_MAPPER =\n+        new ObjectMapper()\n+            .configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true)\n+            .configure(SerializationFeature.ORDER_MAP_ENTRIES_BY_KEYS, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4MzU5MQ==", "bodyText": "I think it's so that two json objects whose properties are the same, but ordered differently hash to the same value", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434783591", "createdAt": "2020-06-03T18:52:29Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+\n+public class DistinctHash {\n+\n+    private static final UInt128 ArrayHashSeed = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);\n+\n+    private static final ObjectMapper OBJECT_MAPPER =\n+        new ObjectMapper()\n+            .configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true)\n+            .configure(SerializationFeature.ORDER_MAP_ENTRIES_BY_KEYS, true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMDEyMw=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzg5NTM3OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/OrderedDistinctMap.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzowNToyNVrOGelWxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxNjozMFrOGfkz1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMjUwMw==", "bodyText": "you may loose the root cause exception this way\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalStateException(\"Failed to add value to distinct map\" +e);\n          \n          \n            \n                        throw new IllegalStateException(\"Failed to add value to distinct map\", e);", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434722503", "createdAt": "2020-06-03T17:05:25Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/OrderedDistinctMap.java", "diffHunk": "@@ -2,30 +2,36 @@\n // Licensed under the MIT License.\n package com.azure.cosmos.implementation.query;\n \n-import com.azure.cosmos.implementation.Utils;\n-import com.azure.cosmos.implementation.apachecommons.lang.StringUtils;\n import com.azure.cosmos.implementation.Resource;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.UInt128;\n \n-import java.security.NoSuchAlgorithmException;\n+import java.io.IOException;\n \n public class OrderedDistinctMap extends DistinctMap {\n-    private volatile String lastHash;\n+    private volatile UInt128 lastHash;\n \n-    public OrderedDistinctMap(String lastHash) {\n+    public OrderedDistinctMap(UInt128 lastHash) {\n         this.lastHash = lastHash;\n     }\n \n     @Override\n-    public boolean add(Resource resource, Utils.ValueHolder<String> outHash) {\n+    public boolean add(Object resource, Utils.ValueHolder<UInt128> outHash) {\n         try {\n-            outHash.v = getHash(resource);\n+            if (resource instanceof Resource) {\n+                // We do this to ensure the property order in document should not effect the hash\n+                resource = getSortedJsonStringValueFromResource((Resource)resource);\n+            }\n+            outHash.v = DistinctHash.getHash(resource);\n             // value should be true if hashes are not equal\n-            final boolean value = !StringUtils.equals(lastHash, outHash.v);\n+            boolean value = true;\n+            if (lastHash != null) {\n+                value = !(outHash.v.equals(lastHash));\n+            }\n             lastHash = outHash.v;\n             return value;\n-        } catch (JsonProcessingException | NoSuchAlgorithmException e) {\n-            throw new IllegalStateException(e);\n+        } catch (IOException e) {\n+            throw new IllegalStateException(\"Failed to add value to distinct map\" +e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MjEzNQ==", "bodyText": "Intention was to add , but did + some how. Cleaned up. Thanks", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435762135", "createdAt": "2020-06-05T08:16:30Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/OrderedDistinctMap.java", "diffHunk": "@@ -2,30 +2,36 @@\n // Licensed under the MIT License.\n package com.azure.cosmos.implementation.query;\n \n-import com.azure.cosmos.implementation.Utils;\n-import com.azure.cosmos.implementation.apachecommons.lang.StringUtils;\n import com.azure.cosmos.implementation.Resource;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.UInt128;\n \n-import java.security.NoSuchAlgorithmException;\n+import java.io.IOException;\n \n public class OrderedDistinctMap extends DistinctMap {\n-    private volatile String lastHash;\n+    private volatile UInt128 lastHash;\n \n-    public OrderedDistinctMap(String lastHash) {\n+    public OrderedDistinctMap(UInt128 lastHash) {\n         this.lastHash = lastHash;\n     }\n \n     @Override\n-    public boolean add(Resource resource, Utils.ValueHolder<String> outHash) {\n+    public boolean add(Object resource, Utils.ValueHolder<UInt128> outHash) {\n         try {\n-            outHash.v = getHash(resource);\n+            if (resource instanceof Resource) {\n+                // We do this to ensure the property order in document should not effect the hash\n+                resource = getSortedJsonStringValueFromResource((Resource)resource);\n+            }\n+            outHash.v = DistinctHash.getHash(resource);\n             // value should be true if hashes are not equal\n-            final boolean value = !StringUtils.equals(lastHash, outHash.v);\n+            boolean value = true;\n+            if (lastHash != null) {\n+                value = !(outHash.v.equals(lastHash));\n+            }\n             lastHash = outHash.v;\n             return value;\n-        } catch (JsonProcessingException | NoSuchAlgorithmException e) {\n-            throw new IllegalStateException(e);\n+        } catch (IOException e) {\n+            throw new IllegalStateException(\"Failed to add value to distinct map\" +e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMjUwMw=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzg5ODg3OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzowNjoyM1rOGelZCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxNzoxM1rOGfk1FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMzA4MQ==", "bodyText": "why continuation token is null here?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434723081", "createdAt": "2020-06-03T17:06:23Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "diffHunk": "@@ -0,0 +1,316 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.Constants;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.Undefined;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.query.aggregation.Aggregator;\n+import com.azure.cosmos.implementation.query.aggregation.AverageAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.CountAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MaxAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MinAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.SumAggregator;\n+import com.azure.cosmos.implementation.Resource;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Aggregates all the projections for a single grouping.\n+ */\n+public abstract class SingleGroupAggregator {\n+\n+    public static SingleGroupAggregator create(List<AggregateOperator> aggregates,\n+                                               Map<String, AggregateOperator> aggregateAliasToAggregateType,\n+                                               List<String> orderedAliases,\n+                                               boolean hasSelectValue,\n+                                               String continuationToken) {\n+\n+        if (aggregates == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        if (aggregateAliasToAggregateType == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        SingleGroupAggregator singleGroupAggregator;\n+\n+        if (hasSelectValue) {\n+            if (!aggregates.isEmpty()) {\n+                // SELECT VALUE <AGGREGATE>\n+                singleGroupAggregator = SelectValueAggregateValues.create(\n+                    aggregates.get(0),\n+                    continuationToken);\n+            } else {\n+                // SELECT VALUE <NON AGGREGATE>\n+                singleGroupAggregator = SelectValueAggregateValues.create(\n+                    null, continuationToken);\n+            }\n+        } else {\n+            singleGroupAggregator = SelectListAggregateValues.create(\n+                aggregateAliasToAggregateType,\n+                orderedAliases,\n+                continuationToken);\n+        }\n+\n+        return singleGroupAggregator;\n+    }\n+\n+    /**\n+     * Adds the payload for group by values\n+     * @param values\n+     */\n+    public abstract void addValues(Document values);\n+\n+    /**\n+     * Forms the final result of the grouping.\n+     * @return Document\n+     */\n+    public abstract Document getResult();\n+\n+    public abstract Resource getDocumentContinuationToken();\n+\n+    /**\n+     * For SELECT VALUE queries there is only one value for each grouping.\n+     * This class just helps maintain that and captures the first value across all continuations.\n+     */\n+    public static class SelectValueAggregateValues extends SingleGroupAggregator {\n+        private final AggregateValue aggregateValue;\n+\n+        public SelectValueAggregateValues(AggregateValue aggregateValue) {\n+            //TODO: null check\n+            this.aggregateValue = aggregateValue;\n+        }\n+\n+        public static SingleGroupAggregator create(AggregateOperator aggregateOperator, String continuationToken) {\n+            AggregateValue aggregateValue = AggregateValue.create(aggregateOperator, continuationToken);\n+            return new SelectValueAggregateValues(aggregateValue);\n+        }\n+\n+        @Override\n+        public void addValues(Document values) {\n+            this.aggregateValue.addValue(values);\n+        }\n+\n+        @Override\n+        public Document getResult() {\n+            Document document;\n+            Object result = aggregateValue.getResult();\n+            if (result instanceof Document) {\n+                document = (Document) aggregateValue.getResult();\n+            } else {\n+                document = new Document();\n+                if (result instanceof Undefined) {\n+                    result = null;\n+                }\n+                // This is for value queries.Need to append value property for scalar values (non key value pairs)\n+                // to make them a key value pair document as our impl is based on Document.\n+                document.set(Constants.Properties.VALUE, result);\n+            }\n+            return document;\n+        }\n+\n+        @Override\n+        public Resource getDocumentContinuationToken() {\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MjQ1Mg==", "bodyText": "Continuation token is not yet supported for this, this method not referenced yet. Will change this when implementing cont.token.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435762452", "createdAt": "2020-06-05T08:17:13Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "diffHunk": "@@ -0,0 +1,316 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.Constants;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.Undefined;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.query.aggregation.Aggregator;\n+import com.azure.cosmos.implementation.query.aggregation.AverageAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.CountAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MaxAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MinAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.SumAggregator;\n+import com.azure.cosmos.implementation.Resource;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Aggregates all the projections for a single grouping.\n+ */\n+public abstract class SingleGroupAggregator {\n+\n+    public static SingleGroupAggregator create(List<AggregateOperator> aggregates,\n+                                               Map<String, AggregateOperator> aggregateAliasToAggregateType,\n+                                               List<String> orderedAliases,\n+                                               boolean hasSelectValue,\n+                                               String continuationToken) {\n+\n+        if (aggregates == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        if (aggregateAliasToAggregateType == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        SingleGroupAggregator singleGroupAggregator;\n+\n+        if (hasSelectValue) {\n+            if (!aggregates.isEmpty()) {\n+                // SELECT VALUE <AGGREGATE>\n+                singleGroupAggregator = SelectValueAggregateValues.create(\n+                    aggregates.get(0),\n+                    continuationToken);\n+            } else {\n+                // SELECT VALUE <NON AGGREGATE>\n+                singleGroupAggregator = SelectValueAggregateValues.create(\n+                    null, continuationToken);\n+            }\n+        } else {\n+            singleGroupAggregator = SelectListAggregateValues.create(\n+                aggregateAliasToAggregateType,\n+                orderedAliases,\n+                continuationToken);\n+        }\n+\n+        return singleGroupAggregator;\n+    }\n+\n+    /**\n+     * Adds the payload for group by values\n+     * @param values\n+     */\n+    public abstract void addValues(Document values);\n+\n+    /**\n+     * Forms the final result of the grouping.\n+     * @return Document\n+     */\n+    public abstract Document getResult();\n+\n+    public abstract Resource getDocumentContinuationToken();\n+\n+    /**\n+     * For SELECT VALUE queries there is only one value for each grouping.\n+     * This class just helps maintain that and captures the first value across all continuations.\n+     */\n+    public static class SelectValueAggregateValues extends SingleGroupAggregator {\n+        private final AggregateValue aggregateValue;\n+\n+        public SelectValueAggregateValues(AggregateValue aggregateValue) {\n+            //TODO: null check\n+            this.aggregateValue = aggregateValue;\n+        }\n+\n+        public static SingleGroupAggregator create(AggregateOperator aggregateOperator, String continuationToken) {\n+            AggregateValue aggregateValue = AggregateValue.create(aggregateOperator, continuationToken);\n+            return new SelectValueAggregateValues(aggregateValue);\n+        }\n+\n+        @Override\n+        public void addValues(Document values) {\n+            this.aggregateValue.addValue(values);\n+        }\n+\n+        @Override\n+        public Document getResult() {\n+            Document document;\n+            Object result = aggregateValue.getResult();\n+            if (result instanceof Document) {\n+                document = (Document) aggregateValue.getResult();\n+            } else {\n+                document = new Document();\n+                if (result instanceof Undefined) {\n+                    result = null;\n+                }\n+                // This is for value queries.Need to append value property for scalar values (non key value pairs)\n+                // to make them a key value pair document as our impl is based on Document.\n+                document.set(Constants.Properties.VALUE, result);\n+            }\n+            return document;\n+        }\n+\n+        @Override\n+        public Resource getDocumentContinuationToken() {\n+            return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMzA4MQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 124}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzkwMjU0OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/aggregation/MinAggregator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzowNzoyOFrOGelbaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo0NzowNlrOGf11Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMzY4OQ==", "bodyText": "we should make these constants. here and elsewhere", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434723689", "createdAt": "2020-06-03T17:07:28Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/aggregation/MinAggregator.java", "diffHunk": "@@ -15,6 +16,30 @@ public MinAggregator() {\n \n     @Override\n     public void aggregate(Object item) {\n+\n+        if (item instanceof ObjectNode) {\n+            ObjectNode objectNode = (ObjectNode) item;\n+            if (objectNode.hasNonNull(\"count\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA0MDk3NA==", "bodyText": "done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r436040974", "createdAt": "2020-06-05T16:47:06Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/aggregation/MinAggregator.java", "diffHunk": "@@ -15,6 +16,30 @@ public MinAggregator() {\n \n     @Override\n     public void aggregate(Object item) {\n+\n+        if (item instanceof ObjectNode) {\n+            ObjectNode objectNode = (ObjectNode) item;\n+            if (objectNode.hasNonNull(\"count\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMzY4OQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzkwMzMxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/aggregation/MinAggregator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzowNzo0MFrOGelb6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxNzoyM1rOGfk1aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMzgxNw==", "bodyText": "we should make this constants, ditto. here and elsewhere", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434723817", "createdAt": "2020-06-03T17:07:40Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/aggregation/MinAggregator.java", "diffHunk": "@@ -15,6 +16,30 @@ public MinAggregator() {\n \n     @Override\n     public void aggregate(Object item) {\n+\n+        if (item instanceof ObjectNode) {\n+            ObjectNode objectNode = (ObjectNode) item;\n+            if (objectNode.hasNonNull(\"count\")) {\n+                long count = objectNode.get(\"count\").asLong();\n+                if (count == 0) {\n+                    // Ignore the value since the continuation / partition had no results that matched the filter\n+                    // so min/max is undefined.\n+                    return;\n+                }\n+\n+                if (objectNode.has(\"min\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MjUzNw==", "bodyText": "Done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435762537", "createdAt": "2020-06-05T08:17:23Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/aggregation/MinAggregator.java", "diffHunk": "@@ -15,6 +16,30 @@ public MinAggregator() {\n \n     @Override\n     public void aggregate(Object item) {\n+\n+        if (item instanceof ObjectNode) {\n+            ObjectNode objectNode = (ObjectNode) item;\n+            if (objectNode.hasNonNull(\"count\")) {\n+                long count = objectNode.get(\"count\").asLong();\n+                if (count == 0) {\n+                    // Ignore the value since the continuation / partition had no results that matched the filter\n+                    // so min/max is undefined.\n+                    return;\n+                }\n+\n+                if (objectNode.has(\"min\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyMzgxNw=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzkxNTIyOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzoxMToyM1rOGelj6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNjo0Nzo0NVrOGf12bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNTg2Ng==", "bodyText": "can any of the public APIs of GroupingTable be invoked on different email threads. if so you will have race condition on updating these internal states.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434725866", "createdAt": "2020-06-03T17:11:23Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();\n+\n+    private final Map<UInt128, SingleGroupAggregator> table;\n+    private final Map<String, AggregateOperator> groupByAliasToAggregateType;\n+    private final List<String> orderedAliases;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA0MTMyNQ==", "bodyText": "grouping will be sequential after collecting records from all the producers, so I dont see issue of multiple threads here.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r436041325", "createdAt": "2020-06-05T16:47:45Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();\n+\n+    private final Map<UInt128, SingleGroupAggregator> table;\n+    private final Map<String, AggregateOperator> groupByAliasToAggregateType;\n+    private final List<String> orderedAliases;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcyNTg2Ng=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzk0OTA2OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzoyMTowOVrOGel5pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOTowODozOVrOGepnEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczMTQyOA==", "bodyText": "Since there is no ordering in the keySet() API - are we just limiting with maxItemCount randomly on the keys in this.table map ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434731428", "createdAt": "2020-06-03T17:21:09Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();\n+\n+    private final Map<UInt128, SingleGroupAggregator> table;\n+    private final Map<String, AggregateOperator> groupByAliasToAggregateType;\n+    private final List<String> orderedAliases;\n+    private final boolean hasSelectValue;\n+\n+    GroupingTable(Map<String, AggregateOperator> groupByAliasToAggregateType, List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        this.table = new HashMap<>();\n+        this.groupByAliasToAggregateType = groupByAliasToAggregateType;\n+        this.orderedAliases = orderedAliases;\n+        this.hasSelectValue = hasSelectValue;\n+    }\n+\n+    public void addPayLoad(GroupByDocumentQueryExecutionContext<?>.RewrittenGroupByProjection rewrittenGroupByProjection) {\n+        try {\n+            final UInt128 groupByKeysHash = DistinctHash.getHash(rewrittenGroupByProjection.getGroupByItems());\n+            SingleGroupAggregator singleGroupAggregator;\n+            if (!this.table.containsKey(groupByKeysHash)) {\n+                singleGroupAggregator = SingleGroupAggregator.create(EmptyAggregateOperators,\n+                                                                     this.groupByAliasToAggregateType,\n+                                                                     this.orderedAliases,\n+                                                                     this.hasSelectValue,\n+                                                                      /*continuationtoken*/ null);\n+                this.table.put(groupByKeysHash, singleGroupAggregator);\n+            } else {\n+                singleGroupAggregator = table.get(groupByKeysHash);\n+            }\n+\n+            singleGroupAggregator.addValues(rewrittenGroupByProjection.getPayload());\n+\n+        } catch (IOException e) {\n+            throw new IllegalStateException(\"Failed to add payload to groupby projection\", e);\n+        }\n+    }\n+\n+    public List<Document> drain(int maxItemCount) {\n+        Collection<UInt128> keys = this.table.keySet().stream().limit(maxItemCount).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5MjIxMQ==", "bodyText": "The ordering doesn't matter in this scenario. The user is just getting back some subset of the keys. It's never defined what order that would be.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434792211", "createdAt": "2020-06-03T19:08:39Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();\n+\n+    private final Map<UInt128, SingleGroupAggregator> table;\n+    private final Map<String, AggregateOperator> groupByAliasToAggregateType;\n+    private final List<String> orderedAliases;\n+    private final boolean hasSelectValue;\n+\n+    GroupingTable(Map<String, AggregateOperator> groupByAliasToAggregateType, List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        this.table = new HashMap<>();\n+        this.groupByAliasToAggregateType = groupByAliasToAggregateType;\n+        this.orderedAliases = orderedAliases;\n+        this.hasSelectValue = hasSelectValue;\n+    }\n+\n+    public void addPayLoad(GroupByDocumentQueryExecutionContext<?>.RewrittenGroupByProjection rewrittenGroupByProjection) {\n+        try {\n+            final UInt128 groupByKeysHash = DistinctHash.getHash(rewrittenGroupByProjection.getGroupByItems());\n+            SingleGroupAggregator singleGroupAggregator;\n+            if (!this.table.containsKey(groupByKeysHash)) {\n+                singleGroupAggregator = SingleGroupAggregator.create(EmptyAggregateOperators,\n+                                                                     this.groupByAliasToAggregateType,\n+                                                                     this.orderedAliases,\n+                                                                     this.hasSelectValue,\n+                                                                      /*continuationtoken*/ null);\n+                this.table.put(groupByKeysHash, singleGroupAggregator);\n+            } else {\n+                singleGroupAggregator = table.get(groupByKeysHash);\n+            }\n+\n+            singleGroupAggregator.addValues(rewrittenGroupByProjection.getPayload());\n+\n+        } catch (IOException e) {\n+            throw new IllegalStateException(\"Failed to add payload to groupby projection\", e);\n+        }\n+    }\n+\n+    public List<Document> drain(int maxItemCount) {\n+        Collection<UInt128> keys = this.table.keySet().stream().limit(maxItemCount).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczMTQyOA=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzk2ODgwOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/OrderedDistinctMap.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzoyNjo0MVrOGemGaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxOTowMlrOGfk49g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczNDY5OQ==", "bodyText": "Please use this constructor instead of concatenation of error :\npublic IllegalStateException(String message, Throwable cause)", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434734699", "createdAt": "2020-06-03T17:26:41Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/OrderedDistinctMap.java", "diffHunk": "@@ -2,30 +2,36 @@\n // Licensed under the MIT License.\n package com.azure.cosmos.implementation.query;\n \n-import com.azure.cosmos.implementation.Utils;\n-import com.azure.cosmos.implementation.apachecommons.lang.StringUtils;\n import com.azure.cosmos.implementation.Resource;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.UInt128;\n \n-import java.security.NoSuchAlgorithmException;\n+import java.io.IOException;\n \n public class OrderedDistinctMap extends DistinctMap {\n-    private volatile String lastHash;\n+    private volatile UInt128 lastHash;\n \n-    public OrderedDistinctMap(String lastHash) {\n+    public OrderedDistinctMap(UInt128 lastHash) {\n         this.lastHash = lastHash;\n     }\n \n     @Override\n-    public boolean add(Resource resource, Utils.ValueHolder<String> outHash) {\n+    public boolean add(Object resource, Utils.ValueHolder<UInt128> outHash) {\n         try {\n-            outHash.v = getHash(resource);\n+            if (resource instanceof Resource) {\n+                // We do this to ensure the property order in document should not effect the hash\n+                resource = getSortedJsonStringValueFromResource((Resource)resource);\n+            }\n+            outHash.v = DistinctHash.getHash(resource);\n             // value should be true if hashes are not equal\n-            final boolean value = !StringUtils.equals(lastHash, outHash.v);\n+            boolean value = true;\n+            if (lastHash != null) {\n+                value = !(outHash.v.equals(lastHash));\n+            }\n             lastHash = outHash.v;\n             return value;\n-        } catch (JsonProcessingException | NoSuchAlgorithmException e) {\n-            throw new IllegalStateException(e);\n+        } catch (IOException e) {\n+            throw new IllegalStateException(\"Failed to add value to distinct map\" +e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MzQ0Ng==", "bodyText": "That was the intention, ended up with this. Corrected.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435763446", "createdAt": "2020-06-05T08:19:02Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/OrderedDistinctMap.java", "diffHunk": "@@ -2,30 +2,36 @@\n // Licensed under the MIT License.\n package com.azure.cosmos.implementation.query;\n \n-import com.azure.cosmos.implementation.Utils;\n-import com.azure.cosmos.implementation.apachecommons.lang.StringUtils;\n import com.azure.cosmos.implementation.Resource;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.UInt128;\n \n-import java.security.NoSuchAlgorithmException;\n+import java.io.IOException;\n \n public class OrderedDistinctMap extends DistinctMap {\n-    private volatile String lastHash;\n+    private volatile UInt128 lastHash;\n \n-    public OrderedDistinctMap(String lastHash) {\n+    public OrderedDistinctMap(UInt128 lastHash) {\n         this.lastHash = lastHash;\n     }\n \n     @Override\n-    public boolean add(Resource resource, Utils.ValueHolder<String> outHash) {\n+    public boolean add(Object resource, Utils.ValueHolder<UInt128> outHash) {\n         try {\n-            outHash.v = getHash(resource);\n+            if (resource instanceof Resource) {\n+                // We do this to ensure the property order in document should not effect the hash\n+                resource = getSortedJsonStringValueFromResource((Resource)resource);\n+            }\n+            outHash.v = DistinctHash.getHash(resource);\n             // value should be true if hashes are not equal\n-            final boolean value = !StringUtils.equals(lastHash, outHash.v);\n+            boolean value = true;\n+            if (lastHash != null) {\n+                value = !(outHash.v.equals(lastHash));\n+            }\n             lastHash = outHash.v;\n             return value;\n-        } catch (JsonProcessingException | NoSuchAlgorithmException e) {\n-            throw new IllegalStateException(e);\n+        } catch (IOException e) {\n+            throw new IllegalStateException(\"Failed to add value to distinct map\" +e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczNDY5OQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzk3MjAxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/QueryFeature.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzoyNzozOVrOGemIuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxOToxMlrOGfk5RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczNTI4OA==", "bodyText": "Nit : Extra comma at the end.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434735288", "createdAt": "2020-06-03T17:27:39Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/QueryFeature.java", "diffHunk": "@@ -12,5 +12,6 @@\n     MultipleOrderBy,\n     OffsetAndLimit,\n     OrderBy,\n-    Top\n+    Top,\n+    NonValueAggregate,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MzUyNQ==", "bodyText": "Removed", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435763525", "createdAt": "2020-06-05T08:19:12Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/QueryFeature.java", "diffHunk": "@@ -12,5 +12,6 @@\n     MultipleOrderBy,\n     OffsetAndLimit,\n     OrderBy,\n-    Top\n+    Top,\n+    NonValueAggregate,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczNTI4OA=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODIzODEyOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosAsyncContainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo0NTo0NFrOGeo3Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxOToyMlrOGfk5mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc3OTkxMA==", "bodyText": "Don't return in an if else. Predeclare the variablee and return at the end.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434779910", "createdAt": "2020-06-03T18:45:44Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosAsyncContainer.java", "diffHunk": "@@ -397,7 +397,13 @@ public String getId() {\n         if (queryInfo != null && queryInfo.hasSelectValue()) {\n             List<T> transformedResults = response.getResults()\n                                              .stream()\n-                                             .map(d -> d.get(Constants.Properties.VALUE))\n+                                             .map(d -> {\n+                                                 if (d.has(Constants.Properties.VALUE)) {\n+                                                     return d.get(Constants.Properties.VALUE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2MzYxMQ==", "bodyText": "changed", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435763611", "createdAt": "2020-06-05T08:19:22Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosAsyncContainer.java", "diffHunk": "@@ -397,7 +397,13 @@ public String getId() {\n         if (queryInfo != null && queryInfo.hasSelectValue()) {\n             List<T> transformedResults = response.getResults()\n                                              .stream()\n-                                             .map(d -> d.get(Constants.Properties.VALUE))\n+                                             .map(d -> {\n+                                                 if (d.has(Constants.Properties.VALUE)) {\n+                                                     return d.get(Constants.Properties.VALUE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc3OTkxMA=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODIzOTg1OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/JsonSerializable.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo0NjoxNFrOGeo4Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMDo0MVrOGfk8gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4MDE4Mw==", "bodyText": "returning null is a soft contract. Is there a TryGet equivalent in Java?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434780183", "createdAt": "2020-06-03T18:46:14Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/JsonSerializable.java", "diffHunk": "@@ -154,6 +154,15 @@ public void populatePropertyBag() {\n         return getMapper().convertValue(this.propertyBag, HashMap.class);\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    public <T> Map<String, T> getMap(String propertyKey) {\n+        if (this.propertyBag.has(propertyKey)) {\n+            Object value = this.get(propertyKey);\n+            return (Map<String, T>) getMapper().convertValue(value, HashMap.class);\n+        }\n+        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDM1Mw==", "bodyText": "Have a tryget in utils for getting values from maps, but this is otherwise not as widely used pattern in our code as .NET.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435764353", "createdAt": "2020-06-05T08:20:41Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/JsonSerializable.java", "diffHunk": "@@ -154,6 +154,15 @@ public void populatePropertyBag() {\n         return getMapper().convertValue(this.propertyBag, HashMap.class);\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    public <T> Map<String, T> getMap(String propertyKey) {\n+        if (this.propertyBag.has(propertyKey)) {\n+            Object value = this.get(propertyKey);\n+            return (Map<String, T>) getMapper().convertValue(value, HashMap.class);\n+        }\n+        return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4MDE4Mw=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODI0OTU4OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo0OToxNVrOGeo-bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMDo1NFrOGfk9AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4MTgwNA==", "bodyText": "if \"payload\" does not exist, then this should throw an exception.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434781804", "createdAt": "2020-06-03T18:49:15Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "diffHunk": "@@ -114,18 +103,49 @@ public AggregateDocumentQueryExecutionContext (IDocumentQueryExecutionComponent<\n                 }).flux();\n     }\n \n-    public static <T extends Resource>  Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n-            Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n-            Collection<AggregateOperator> aggregates,\n-            String continuationToken) {\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        Collection<AggregateOperator> aggregates,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> groupByAliases,\n+        boolean hasSelectValue,\n+        String continuationToken) {\n \n         return createSourceComponentFunction\n-                .apply(continuationToken)\n-                .map( component -> { return new AggregateDocumentQueryExecutionContext<T>(component, aggregates);});\n+                   .apply(continuationToken)\n+                   .map(component -> {\n+                       return new AggregateDocumentQueryExecutionContext<T>(component,\n+                                                                            new ArrayList<>(aggregates),\n+                                                                            groupByAliasToAggregateType,\n+                                                                            groupByAliases,\n+                                                                            hasSelectValue,\n+                                                                            continuationToken);\n+                   });\n     }\n \n     public IDocumentQueryExecutionComponent<T> getComponent() {\n         return this.component;\n     }\n \n+    class RewrittenAggregateProjections {\n+        private Document payload;\n+\n+        public RewrittenAggregateProjections(boolean isValueAggregateQuery, Document document) {\n+            if (document == null) {\n+                throw new IllegalArgumentException(\"document cannot be null\");\n+            }\n+            if (isValueAggregateQuery) {\n+                this.payload = new Document(document.getPropertyBag());\n+            } else {\n+                if (document.get(\"payload\") instanceof ObjectNode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDQ4MQ==", "bodyText": "Added check", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435764481", "createdAt": "2020-06-05T08:20:54Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/AggregateDocumentQueryExecutionContext.java", "diffHunk": "@@ -114,18 +103,49 @@ public AggregateDocumentQueryExecutionContext (IDocumentQueryExecutionComponent<\n                 }).flux();\n     }\n \n-    public static <T extends Resource>  Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n-            Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n-            Collection<AggregateOperator> aggregates,\n-            String continuationToken) {\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        Collection<AggregateOperator> aggregates,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> groupByAliases,\n+        boolean hasSelectValue,\n+        String continuationToken) {\n \n         return createSourceComponentFunction\n-                .apply(continuationToken)\n-                .map( component -> { return new AggregateDocumentQueryExecutionContext<T>(component, aggregates);});\n+                   .apply(continuationToken)\n+                   .map(component -> {\n+                       return new AggregateDocumentQueryExecutionContext<T>(component,\n+                                                                            new ArrayList<>(aggregates),\n+                                                                            groupByAliasToAggregateType,\n+                                                                            groupByAliases,\n+                                                                            hasSelectValue,\n+                                                                            continuationToken);\n+                   });\n     }\n \n     public IDocumentQueryExecutionComponent<T> getComponent() {\n         return this.component;\n     }\n \n+    class RewrittenAggregateProjections {\n+        private Document payload;\n+\n+        public RewrittenAggregateProjections(boolean isValueAggregateQuery, Document document) {\n+            if (document == null) {\n+                throw new IllegalArgumentException(\"document cannot be null\");\n+            }\n+            if (isValueAggregateQuery) {\n+                this.payload = new Document(document.getPropertyBag());\n+            } else {\n+                if (document.get(\"payload\") instanceof ObjectNode) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4MTgwNA=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 156}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODI1MzQxOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo1MDoyNlrOGepBAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMTowM1rOGfk9XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4MjQ2Ng==", "bodyText": "sealed (which I think is final in Java).", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434782466", "createdAt": "2020-06-03T18:50:26Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+\n+public class DistinctHash {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4MjYxNg==", "bodyText": "actually this could be a static class.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434782616", "createdAt": "2020-06-03T18:50:41Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+\n+public class DistinctHash {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4MjQ2Ng=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDU3Mw==", "bodyText": "made final", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435764573", "createdAt": "2020-06-05T08:21:03Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+\n+public class DistinctHash {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4MjQ2Ng=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODI1ODcyOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo1MTo1N1rOGepEVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMTo0NlrOGfk-2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4MzMxNg==", "bodyText": "This class is missing a lot of the hash seeds.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434783316", "createdAt": "2020-06-03T18:51:57Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+\n+public class DistinctHash {\n+\n+    private static final UInt128 ArrayHashSeed = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDk1Mw==", "bodyText": "At the moment, hashing all types as just Object, and not doing it at the granular level of .NET. Should be improved.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435764953", "createdAt": "2020-06-05T08:21:46Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+\n+public class DistinctHash {\n+\n+    private static final UInt128 ArrayHashSeed = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4MzMxNg=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODI2MjkyOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo1MzoxMVrOGepG2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMjoyMlrOGflADg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4Mzk2Mw==", "bodyText": "This isn't going to work, since 1.0 and 1.00 need to hash to the same value. Also strings and their different escaped variants.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434783963", "createdAt": "2020-06-03T18:53:11Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+\n+public class DistinctHash {\n+\n+    private static final UInt128 ArrayHashSeed = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);\n+\n+    private static final ObjectMapper OBJECT_MAPPER =\n+        new ObjectMapper()\n+            .configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true)\n+            .configure(SerializationFeature.ORDER_MAP_ENTRIES_BY_KEYS, true);\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static UInt128 getHash(Object resource) throws IOException {\n+\n+        if (resource instanceof List) {\n+            return getHashFromList((List<Object>) resource);\n+        }\n+\n+        if (resource instanceof JsonSerializable) {\n+            return getHashFromJsonSerializable((JsonSerializable) resource);\n+        }\n+\n+        final byte[] bytes = Utils.serializeObjectToByteArray(resource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NTI2Mg==", "bodyText": "Have tests for checking 1.0 vs 1 and they pass", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435765262", "createdAt": "2020-06-05T08:22:22Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.List;\n+\n+public class DistinctHash {\n+\n+    private static final UInt128 ArrayHashSeed = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);\n+\n+    private static final ObjectMapper OBJECT_MAPPER =\n+        new ObjectMapper()\n+            .configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true)\n+            .configure(SerializationFeature.ORDER_MAP_ENTRIES_BY_KEYS, true);\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static UInt128 getHash(Object resource) throws IOException {\n+\n+        if (resource instanceof List) {\n+            return getHashFromList((List<Object>) resource);\n+        }\n+\n+        if (resource instanceof JsonSerializable) {\n+            return getHashFromJsonSerializable((JsonSerializable) resource);\n+        }\n+\n+        final byte[] bytes = Utils.serializeObjectToByteArray(resource);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4Mzk2Mw=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODI2NTI0OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo1Mzo1N1rOGepIVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMjozNlrOGflAjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NDM0MA==", "bodyText": "sealed.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434784340", "createdAt": "2020-06-03T18:53:57Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -0,0 +1,151 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosException;\n+import com.azure.cosmos.implementation.BadRequestException;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.Resource;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public class GroupByDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NTM5MA==", "bodyText": "done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435765390", "createdAt": "2020-06-05T08:22:36Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -0,0 +1,151 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosException;\n+import com.azure.cosmos.implementation.BadRequestException;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.Resource;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public class GroupByDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NDM0MA=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODI2NjgwOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo1NDozMFrOGepJVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMjo0NFrOGflA0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NDU5Ng==", "bodyText": "null check the other argumetns.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434784596", "createdAt": "2020-06-03T18:54:30Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -0,0 +1,151 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosException;\n+import com.azure.cosmos.implementation.BadRequestException;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.Resource;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public class GroupByDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T> {\n+\n+    public static final String CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY = \"Continuation token is not supported \" +\n+                                                                                    \"for queries with GROUP BY.\" +\n+                                                                                    \"Do not use FeedResponse#\" +\n+                                                                                    \"responseContinuation\" +\n+                                                                                    \" or remove the GROUP BY \" +\n+                                                                                    \"from the query.\";\n+    private final IDocumentQueryExecutionComponent<T> component;\n+    private final GroupingTable groupingTable;\n+\n+    GroupByDocumentQueryExecutionContext(\n+        IDocumentQueryExecutionComponent<T> component,\n+        GroupingTable groupingTable) {\n+        this.component = component;\n+        this.groupingTable = groupingTable;\n+    }\n+\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        String continuationToken,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        if (continuationToken != null) {\n+            CosmosException dce = new BadRequestException(CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY);\n+            return Flux.error(dce);\n+        }\n+        GroupingTable table = new GroupingTable(groupByAliasToAggregateType, orderedAliases, hasSelectValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NTQ1Nw==", "bodyText": "done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435765457", "createdAt": "2020-06-05T08:22:44Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupByDocumentQueryExecutionContext.java", "diffHunk": "@@ -0,0 +1,151 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosException;\n+import com.azure.cosmos.implementation.BadRequestException;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.HttpConstants;\n+import com.azure.cosmos.implementation.Resource;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.implementation.JsonSerializable;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import reactor.core.publisher.Flux;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public class GroupByDocumentQueryExecutionContext<T extends Resource> implements IDocumentQueryExecutionComponent<T> {\n+\n+    public static final String CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY = \"Continuation token is not supported \" +\n+                                                                                    \"for queries with GROUP BY.\" +\n+                                                                                    \"Do not use FeedResponse#\" +\n+                                                                                    \"responseContinuation\" +\n+                                                                                    \" or remove the GROUP BY \" +\n+                                                                                    \"from the query.\";\n+    private final IDocumentQueryExecutionComponent<T> component;\n+    private final GroupingTable groupingTable;\n+\n+    GroupByDocumentQueryExecutionContext(\n+        IDocumentQueryExecutionComponent<T> component,\n+        GroupingTable groupingTable) {\n+        this.component = component;\n+        this.groupingTable = groupingTable;\n+    }\n+\n+    public static <T extends Resource> Flux<IDocumentQueryExecutionComponent<T>> createAsync(\n+        Function<String, Flux<IDocumentQueryExecutionComponent<T>>> createSourceComponentFunction,\n+        String continuationToken,\n+        Map<String, AggregateOperator> groupByAliasToAggregateType,\n+        List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        if (continuationToken != null) {\n+            CosmosException dce = new BadRequestException(CONTINUATION_TOKEN_NOT_SUPPORTED_WITH_GROUP_BY);\n+            return Flux.error(dce);\n+        }\n+        GroupingTable table = new GroupingTable(groupByAliasToAggregateType, orderedAliases, hasSelectValue);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NDU5Ng=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODI3MzM0OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo1NjoyNFrOGepNSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyNDoxN1rOGflEEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NTYwOA==", "bodyText": "readonly list", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434785608", "createdAt": "2020-06-03T18:56:24Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NjI5MA==", "bodyText": "list is final. Do yo mean immutable?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435766290", "createdAt": "2020-06-05T08:24:17Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NTYwOA=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODI3NDAyOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo1Njo0MFrOGepNxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMjo1NlrOGflBNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NTczNQ==", "bodyText": "null checks.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434785735", "createdAt": "2020-06-03T18:56:40Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();\n+\n+    private final Map<UInt128, SingleGroupAggregator> table;\n+    private final Map<String, AggregateOperator> groupByAliasToAggregateType;\n+    private final List<String> orderedAliases;\n+    private final boolean hasSelectValue;\n+\n+    GroupingTable(Map<String, AggregateOperator> groupByAliasToAggregateType, List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        this.table = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NTU1Ng==", "bodyText": "Added", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435765556", "createdAt": "2020-06-05T08:22:56Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/GroupingTable.java", "diffHunk": "@@ -0,0 +1,69 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.routing.UInt128;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class GroupingTable {\n+    private static final List<AggregateOperator> EmptyAggregateOperators = new ArrayList<>();\n+\n+    private final Map<UInt128, SingleGroupAggregator> table;\n+    private final Map<String, AggregateOperator> groupByAliasToAggregateType;\n+    private final List<String> orderedAliases;\n+    private final boolean hasSelectValue;\n+\n+    GroupingTable(Map<String, AggregateOperator> groupByAliasToAggregateType, List<String> orderedAliases,\n+        boolean hasSelectValue) {\n+        this.table = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NTczNQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODMxODY1OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOToxMDowNVrOGepp_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOToxMDowNVrOGepp_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5Mjk1OA==", "bodyText": "there is a typo here.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434792958", "createdAt": "2020-06-03T19:10:05Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "diffHunk": "@@ -0,0 +1,316 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.Constants;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.Undefined;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.query.aggregation.Aggregator;\n+import com.azure.cosmos.implementation.query.aggregation.AverageAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.CountAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MaxAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MinAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.SumAggregator;\n+import com.azure.cosmos.implementation.Resource;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Aggregates all the projections for a single grouping.\n+ */\n+public abstract class SingleGroupAggregator {\n+\n+    public static SingleGroupAggregator create(List<AggregateOperator> aggregates,\n+                                               Map<String, AggregateOperator> aggregateAliasToAggregateType,\n+                                               List<String> orderedAliases,\n+                                               boolean hasSelectValue,\n+                                               String continuationToken) {\n+\n+        if (aggregates == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        if (aggregateAliasToAggregateType == null) {\n+            throw new IllegalArgumentException(\"aggregates\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODMzODY0OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOToxNTo1MlrOGep2IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOToxNTo1MlrOGep2IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5NjA2NQ==", "bodyText": "final", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434796065", "createdAt": "2020-06-03T19:15:52Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/SingleGroupAggregator.java", "diffHunk": "@@ -0,0 +1,316 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.implementation.Constants;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.Undefined;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.query.aggregation.AggregateOperator;\n+import com.azure.cosmos.implementation.query.aggregation.Aggregator;\n+import com.azure.cosmos.implementation.query.aggregation.AverageAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.CountAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MaxAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.MinAggregator;\n+import com.azure.cosmos.implementation.query.aggregation.SumAggregator;\n+import com.azure.cosmos.implementation.Resource;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Aggregates all the projections for a single grouping.\n+ */\n+public abstract class SingleGroupAggregator {\n+\n+    public static SingleGroupAggregator create(List<AggregateOperator> aggregates,\n+                                               Map<String, AggregateOperator> aggregateAliasToAggregateType,\n+                                               List<String> orderedAliases,\n+                                               boolean hasSelectValue,\n+                                               String continuationToken) {\n+\n+        if (aggregates == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        if (aggregateAliasToAggregateType == null) {\n+            throw new IllegalArgumentException(\"aggregates\");\n+        }\n+\n+        SingleGroupAggregator singleGroupAggregator;\n+\n+        if (hasSelectValue) {\n+            if (!aggregates.isEmpty()) {\n+                // SELECT VALUE <AGGREGATE>\n+                singleGroupAggregator = SelectValueAggregateValues.create(\n+                    aggregates.get(0),\n+                    continuationToken);\n+            } else {\n+                // SELECT VALUE <NON AGGREGATE>\n+                singleGroupAggregator = SelectValueAggregateValues.create(\n+                    null, continuationToken);\n+            }\n+        } else {\n+            singleGroupAggregator = SelectListAggregateValues.create(\n+                aggregateAliasToAggregateType,\n+                orderedAliases,\n+                continuationToken);\n+        }\n+\n+        return singleGroupAggregator;\n+    }\n+\n+    /**\n+     * Adds the payload for group by values\n+     * @param values\n+     */\n+    public abstract void addValues(Document values);\n+\n+    /**\n+     * Forms the final result of the grouping.\n+     * @return Document\n+     */\n+    public abstract Document getResult();\n+\n+    public abstract Resource getDocumentContinuationToken();\n+\n+    /**\n+     * For SELECT VALUE queries there is only one value for each grouping.\n+     * This class just helps maintain that and captures the first value across all continuations.\n+     */\n+    public static class SelectValueAggregateValues extends SingleGroupAggregator {\n+        private final AggregateValue aggregateValue;\n+\n+        public SelectValueAggregateValues(AggregateValue aggregateValue) {\n+            //TODO: null check\n+            this.aggregateValue = aggregateValue;\n+        }\n+\n+        public static SingleGroupAggregator create(AggregateOperator aggregateOperator, String continuationToken) {\n+            AggregateValue aggregateValue = AggregateValue.create(aggregateOperator, continuationToken);\n+            return new SelectValueAggregateValues(aggregateValue);\n+        }\n+\n+        @Override\n+        public void addValues(Document values) {\n+            this.aggregateValue.addValue(values);\n+        }\n+\n+        @Override\n+        public Document getResult() {\n+            Document document;\n+            Object result = aggregateValue.getResult();\n+            if (result instanceof Document) {\n+                document = (Document) aggregateValue.getResult();\n+            } else {\n+                document = new Document();\n+                if (result instanceof Undefined) {\n+                    result = null;\n+                }\n+                // This is for value queries.Need to append value property for scalar values (non key value pairs)\n+                // to make them a key value pair document as our impl is based on Document.\n+                document.set(Constants.Properties.VALUE, result);\n+            }\n+            return document;\n+        }\n+\n+        @Override\n+        public Resource getDocumentContinuationToken() {\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * For select list queries we need to create a dictionary of alias to group by value.\n+     * For each grouping drained from the backend we merge it with the results here.\n+     * At the end this class will form a JSON object with the correct aliases and grouping result.\n+     */\n+    public static class SelectListAggregateValues extends SingleGroupAggregator {\n+        Map<String, AggregateValue> aliasToValue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODM1Mjg3OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/routing/UInt128.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOToyMDozN1rOGep_lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozMTozMlrOGflTlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5ODQ4Ng==", "bodyText": "usually smaller cases are handled first:\nif(other not instanceof UInt128)\n{\n    return false;\n}\n\nreturn this.low == ((UInt128) other).low && this.high == ((UInt128) other).high;", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434798486", "createdAt": "2020-06-03T19:20:37Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/routing/UInt128.java", "diffHunk": "@@ -3,12 +3,55 @@\n \n package com.azure.cosmos.implementation.routing;\n \n-class UInt128 {\n-    long low;\n-    long high;\n+import java.nio.ByteBuffer;\n+import java.util.Objects;\n \n-    UInt128(long x, long y) {\n+public class UInt128 {\n+    private static final int SIZE  = Long.SIZE + Long.SIZE;\n+    public static final int BYTES = SIZE / Byte.SIZE;\n+    final long low;\n+    final long high;\n+\n+    public UInt128(long x, long y) {\n         this.low = x;\n         this.high = y;\n     }\n+\n+    public UInt128 (ByteBuffer byteBuffer) {\n+        byteBuffer.rewind();\n+        this.low = byteBuffer.getLong();\n+        this.high = byteBuffer.getLong();\n+    }\n+\n+    @Override\n+    public boolean equals(final Object other) {\n+        if (other instanceof UInt128) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MDI2MA==", "bodyText": "I see similar style being used in java boxed types like Integer", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435770260", "createdAt": "2020-06-05T08:31:32Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/routing/UInt128.java", "diffHunk": "@@ -3,12 +3,55 @@\n \n package com.azure.cosmos.implementation.routing;\n \n-class UInt128 {\n-    long low;\n-    long high;\n+import java.nio.ByteBuffer;\n+import java.util.Objects;\n \n-    UInt128(long x, long y) {\n+public class UInt128 {\n+    private static final int SIZE  = Long.SIZE + Long.SIZE;\n+    public static final int BYTES = SIZE / Byte.SIZE;\n+    final long low;\n+    final long high;\n+\n+    public UInt128(long x, long y) {\n         this.low = x;\n         this.high = y;\n     }\n+\n+    public UInt128 (ByteBuffer byteBuffer) {\n+        byteBuffer.rewind();\n+        this.low = byteBuffer.getLong();\n+        this.high = byteBuffer.getLong();\n+    }\n+\n+    @Override\n+    public boolean equals(final Object other) {\n+        if (other instanceof UInt128) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5ODQ4Ng=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODM1NDA4OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/routing/UInt128.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOToyMDo1NlrOGeqASQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozMTo0MVrOGflT9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5ODY2NQ==", "bodyText": "avoid the cast multiple times", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434798665", "createdAt": "2020-06-03T19:20:56Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/routing/UInt128.java", "diffHunk": "@@ -3,12 +3,55 @@\n \n package com.azure.cosmos.implementation.routing;\n \n-class UInt128 {\n-    long low;\n-    long high;\n+import java.nio.ByteBuffer;\n+import java.util.Objects;\n \n-    UInt128(long x, long y) {\n+public class UInt128 {\n+    private static final int SIZE  = Long.SIZE + Long.SIZE;\n+    public static final int BYTES = SIZE / Byte.SIZE;\n+    final long low;\n+    final long high;\n+\n+    public UInt128(long x, long y) {\n         this.low = x;\n         this.high = y;\n     }\n+\n+    public UInt128 (ByteBuffer byteBuffer) {\n+        byteBuffer.rewind();\n+        this.low = byteBuffer.getLong();\n+        this.high = byteBuffer.getLong();\n+    }\n+\n+    @Override\n+    public boolean equals(final Object other) {\n+        if (other instanceof UInt128) {\n+            return this.low == ((UInt128) other).low && this.high == ((UInt128) other).high;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MDM1OA==", "bodyText": "Done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435770358", "createdAt": "2020-06-05T08:31:41Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/routing/UInt128.java", "diffHunk": "@@ -3,12 +3,55 @@\n \n package com.azure.cosmos.implementation.routing;\n \n-class UInt128 {\n-    long low;\n-    long high;\n+import java.nio.ByteBuffer;\n+import java.util.Objects;\n \n-    UInt128(long x, long y) {\n+public class UInt128 {\n+    private static final int SIZE  = Long.SIZE + Long.SIZE;\n+    public static final int BYTES = SIZE / Byte.SIZE;\n+    final long low;\n+    final long high;\n+\n+    public UInt128(long x, long y) {\n         this.low = x;\n         this.high = y;\n     }\n+\n+    public UInt128 (ByteBuffer byteBuffer) {\n+        byteBuffer.rewind();\n+        this.low = byteBuffer.getLong();\n+        this.high = byteBuffer.getLong();\n+    }\n+\n+    @Override\n+    public boolean equals(final Object other) {\n+        if (other instanceof UInt128) {\n+            return this.low == ((UInt128) other).low && this.high == ((UInt128) other).high;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5ODY2NQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODM1NzM5OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/DistinctMapTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOToyMTo1NVrOGeqCaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozMjo1NlrOGflW-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5OTIxMQ==", "bodyText": "Add tests for 1 vs 1.0 and escaped string", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434799211", "createdAt": "2020-06-03T19:21:55Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/DistinctMapTest.java", "diffHunk": "@@ -6,6 +6,7 @@\n import com.azure.cosmos.implementation.Utils;\n import com.azure.cosmos.implementation.query.DistinctMap;\n import com.azure.cosmos.implementation.query.DistinctQueryType;\n+import com.azure.cosmos.implementation.routing.UInt128;\n import org.testng.annotations.DataProvider;\n import org.testng.annotations.Test;\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MTEyOA==", "bodyText": "Added integration test for this already in DistinctQueryTests#queryDocumentsForDistinctIntValues", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435771128", "createdAt": "2020-06-05T08:32:56Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/DistinctMapTest.java", "diffHunk": "@@ -6,6 +6,7 @@\n import com.azure.cosmos.implementation.Utils;\n import com.azure.cosmos.implementation.query.DistinctMap;\n import com.azure.cosmos.implementation.query.DistinctQueryType;\n+import com.azure.cosmos.implementation.routing.UInt128;\n import org.testng.annotations.DataProvider;\n import org.testng.annotations.Test;\n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc5OTIxMQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODM2NTM4OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/GroupByQueryTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOToyNDozMVrOGeqHnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozMzoyN1rOGflYQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgwMDU0MQ==", "bodyText": "There are a lot of other cases that need to be covered.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434800541", "createdAt": "2020-06-03T19:24:31Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/GroupByQueryTests.java", "diffHunk": "@@ -0,0 +1,170 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.rx;\n+\n+import com.azure.cosmos.CosmosAsyncClient;\n+import com.azure.cosmos.CosmosAsyncContainer;\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.implementation.CosmosItemProperties;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.azure.cosmos.models.QueryRequestOptions;\n+import com.azure.cosmos.rx.pojos.City;\n+import com.azure.cosmos.rx.pojos.Person;\n+import com.azure.cosmos.rx.pojos.Pet;\n+import com.azure.cosmos.util.CosmosPagedFlux;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class GroupByQueryTests extends TestSuiteBase {\n+    List<Person> personList;\n+    private CosmosAsyncContainer createdCollection;\n+    private ArrayList<CosmosItemProperties> docs = new ArrayList<>();\n+    private CosmosAsyncClient client;\n+\n+    @Factory(dataProvider = \"clientBuildersWithDirect\")\n+    public GroupByQueryTests(CosmosClientBuilder clientBuilder) {\n+        super(clientBuilder);\n+    }\n+\n+    private static String getRandomName(Random rand) {\n+        StringBuilder stringBuilder = new StringBuilder();\n+        stringBuilder.append(\"name_\" + rand.nextInt(100));\n+\n+        return stringBuilder.toString();\n+    }\n+\n+    private static City getRandomCity(Random rand) {\n+        int index = rand.nextInt(3);\n+        switch (index) {\n+            case 0:\n+                return City.LOS_ANGELES;\n+            case 1:\n+                return City.NEW_YORK;\n+            case 2:\n+                return City.SEATTLE;\n+        }\n+\n+        return City.LOS_ANGELES;\n+    }\n+\n+    private static double getRandomIncome(Random rand) {\n+        return rand.nextDouble() * Double.MAX_VALUE;\n+    }\n+\n+    private static int getRandomAge(Random rand) {\n+        return rand.nextInt(100);\n+    }\n+\n+    @Test(groups = {\"simple\"}, timeOut = TIMEOUT)\n+    public void queryDocuments() {\n+        boolean qmEnabled = true;\n+\n+        String query = \"SELECT sum(c.age) as sum_age, c.city FROM c group by c.city\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MTQ1Nw==", "bodyText": "Yup, need to add more tests for groupby. Plan is to get this in and run the Queryoracle. In the mean time will also try to add more tests", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435771457", "createdAt": "2020-06-05T08:33:27Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/GroupByQueryTests.java", "diffHunk": "@@ -0,0 +1,170 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.rx;\n+\n+import com.azure.cosmos.CosmosAsyncClient;\n+import com.azure.cosmos.CosmosAsyncContainer;\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.implementation.CosmosItemProperties;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.models.FeedResponse;\n+import com.azure.cosmos.models.ModelBridgeInternal;\n+import com.azure.cosmos.models.QueryRequestOptions;\n+import com.azure.cosmos.rx.pojos.City;\n+import com.azure.cosmos.rx.pojos.Person;\n+import com.azure.cosmos.rx.pojos.Pet;\n+import com.azure.cosmos.util.CosmosPagedFlux;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Random;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class GroupByQueryTests extends TestSuiteBase {\n+    List<Person> personList;\n+    private CosmosAsyncContainer createdCollection;\n+    private ArrayList<CosmosItemProperties> docs = new ArrayList<>();\n+    private CosmosAsyncClient client;\n+\n+    @Factory(dataProvider = \"clientBuildersWithDirect\")\n+    public GroupByQueryTests(CosmosClientBuilder clientBuilder) {\n+        super(clientBuilder);\n+    }\n+\n+    private static String getRandomName(Random rand) {\n+        StringBuilder stringBuilder = new StringBuilder();\n+        stringBuilder.append(\"name_\" + rand.nextInt(100));\n+\n+        return stringBuilder.toString();\n+    }\n+\n+    private static City getRandomCity(Random rand) {\n+        int index = rand.nextInt(3);\n+        switch (index) {\n+            case 0:\n+                return City.LOS_ANGELES;\n+            case 1:\n+                return City.NEW_YORK;\n+            case 2:\n+                return City.SEATTLE;\n+        }\n+\n+        return City.LOS_ANGELES;\n+    }\n+\n+    private static double getRandomIncome(Random rand) {\n+        return rand.nextDouble() * Double.MAX_VALUE;\n+    }\n+\n+    private static int getRandomAge(Random rand) {\n+        return rand.nextInt(100);\n+    }\n+\n+    @Test(groups = {\"simple\"}, timeOut = TIMEOUT)\n+    public void queryDocuments() {\n+        boolean qmEnabled = true;\n+\n+        String query = \"SELECT sum(c.age) as sum_age, c.city FROM c group by c.city\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgwMDU0MQ=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODM2ODA2OnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/QueryPlanRetriever.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOToyNToyMFrOGeqJUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozMzo1MVrOGflZGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgwMDk3OA==", "bodyText": "We need to add tests for this if you are going to turn the flag on.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r434800978", "createdAt": "2020-06-03T19:25:20Z", "author": {"login": "bchong95"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/QueryPlanRetriever.java", "diffHunk": "@@ -23,10 +23,13 @@\n     private static final String SUPPORTED_QUERY_FEATURES = QueryFeature.Aggregate.name() + \", \" +\n                                                                QueryFeature.CompositeAggregate.name() + \", \" +\n                                                                QueryFeature.MultipleOrderBy.name() + \", \" +\n+                                                               QueryFeature.MultipleAggregates.name() + \", \" +\n                                                                QueryFeature.OrderBy.name() + \", \" +\n                                                                QueryFeature.OffsetAndLimit.name() + \", \" +\n                                                                QueryFeature.Distinct.name() + \", \" +\n-                                                               QueryFeature.Top.name();\n+                                                               QueryFeature.GroupBy.name() + \", \" +\n+                                                               QueryFeature.Top.name() + \", \" +\n+                                                               QueryFeature.NonValueAggregate.name();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MTY3NA==", "bodyText": "Yeah, already added tests for NonValue and Multi Aggregates in AggregateQueryTests", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r435771674", "createdAt": "2020-06-05T08:33:51Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/QueryPlanRetriever.java", "diffHunk": "@@ -23,10 +23,13 @@\n     private static final String SUPPORTED_QUERY_FEATURES = QueryFeature.Aggregate.name() + \", \" +\n                                                                QueryFeature.CompositeAggregate.name() + \", \" +\n                                                                QueryFeature.MultipleOrderBy.name() + \", \" +\n+                                                               QueryFeature.MultipleAggregates.name() + \", \" +\n                                                                QueryFeature.OrderBy.name() + \", \" +\n                                                                QueryFeature.OffsetAndLimit.name() + \", \" +\n                                                                QueryFeature.Distinct.name() + \", \" +\n-                                                               QueryFeature.Top.name();\n+                                                               QueryFeature.GroupBy.name() + \", \" +\n+                                                               QueryFeature.Top.name() + \", \" +\n+                                                               QueryFeature.NonValueAggregate.name();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgwMDk3OA=="}, "originalCommit": {"oid": "bcc778fa80f1ccea27fff4f6f22abea5065da728"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNTkzNjAwOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/aggregation/MaxAggregator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNjozMzozOFrOGhS60Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxODoyNjo1MlrOGipr-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NjE2MQ==", "bodyText": "we should use constant for all of these \"count\", \"max\" etc, here and other places.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r437566161", "createdAt": "2020-06-09T16:33:38Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/aggregation/MaxAggregator.java", "diffHunk": "@@ -13,8 +19,47 @@ public MaxAggregator() {\n         this.value = Undefined.value();\n     }\n \n+    static Object getValue(Object value) {\n+\n+        if (value instanceof TextNode) {\n+            return ((JsonNode) value).asText();\n+        } else if (value instanceof NumericNode) {\n+            return ((JsonNode) value).numberValue();\n+        } else if (value instanceof BooleanNode) {\n+            return ((JsonNode) value).asBoolean();\n+        } else if (value instanceof NullNode) {\n+            return null;\n+        } else {\n+            return value;\n+        }\n+    }\n+\n     @Override\n     public void aggregate(Object item) {\n+\n+        if (item instanceof ObjectNode) {\n+            ObjectNode objectNode = (ObjectNode) item;\n+            if (objectNode.hasNonNull(\"count\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c9c7ac582ed6547e19b4374159ed0a61e9f3975"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4Nzc2OQ==", "bodyText": "done", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11303#discussion_r438987769", "createdAt": "2020-06-11T18:26:52Z", "author": {"login": "mbhaskar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/aggregation/MaxAggregator.java", "diffHunk": "@@ -13,8 +19,47 @@ public MaxAggregator() {\n         this.value = Undefined.value();\n     }\n \n+    static Object getValue(Object value) {\n+\n+        if (value instanceof TextNode) {\n+            return ((JsonNode) value).asText();\n+        } else if (value instanceof NumericNode) {\n+            return ((JsonNode) value).numberValue();\n+        } else if (value instanceof BooleanNode) {\n+            return ((JsonNode) value).asBoolean();\n+        } else if (value instanceof NullNode) {\n+            return null;\n+        } else {\n+            return value;\n+        }\n+    }\n+\n     @Override\n     public void aggregate(Object item) {\n+\n+        if (item instanceof ObjectNode) {\n+            ObjectNode objectNode = (ObjectNode) item;\n+            if (objectNode.hasNonNull(\"count\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NjE2MQ=="}, "originalCommit": {"oid": "0c9c7ac582ed6547e19b4374159ed0a61e9f3975"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4183, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}