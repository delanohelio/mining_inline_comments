{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3OTg5NzE3", "number": 16651, "title": "Add multipage business cards test form recognizer", "bodyText": "Add tests to cover scenarios for multipage documents with one business card per page for business card recognition API in Form Recognizer.\nUpdate test methods to combine receipt and business card testing methods.", "createdAt": "2020-10-22T03:38:34Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651", "merged": true, "mergeCommit": {"oid": "94c33a4a7f97c453cd9273c588999918349c7b5b"}, "closed": true, "closedAt": "2020-10-22T19:05:27Z", "author": {"login": "samvaity"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdU76k3AH2gAyNTA3OTg5NzE3OjE3NTA1YjZhZTlhYWQ3MTVmZGFjY2VmYmZkNWIzNGZiNTM5MDE1ZWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVF-pkAFqTUxNDk5MTc0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "17505b6ae9aad715fdaccefbfd5b34fb539015ea", "author": {"user": {"login": "samvaity", "name": "Sameeksha Vaity"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/17505b6ae9aad715fdaccefbfd5b34fb539015ea", "committedDate": "2020-10-22T06:24:06Z", "message": "add business card multipage tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48d10caec56c942b8b90cdbe38b2c076b8b26393", "author": {"user": {"login": "samvaity", "name": "Sameeksha Vaity"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/48d10caec56c942b8b90cdbe38b2c076b8b26393", "committedDate": "2020-10-22T03:33:18Z", "message": "add business card multipage tests"}, "afterCommit": {"oid": "17505b6ae9aad715fdaccefbfd5b34fb539015ea", "author": {"user": {"login": "samvaity", "name": "Sameeksha Vaity"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/17505b6ae9aad715fdaccefbfd5b34fb539015ea", "committedDate": "2020-10-22T06:24:06Z", "message": "add business card multipage tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODU4NjE4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651#pullrequestreview-514858618", "createdAt": "2020-10-22T15:32:56Z", "commit": {"oid": "17505b6ae9aad715fdaccefbfd5b34fb539015ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTozMjo1NlrOHmntLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTozMjo1NlrOHmntLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI1ODQ3OA==", "bodyText": "if recognize from url, shouldn't content-type be application/json?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651#discussion_r510258478", "createdAt": "2020-10-22T15:32:56Z", "author": {"login": "kristapratico"}, "path": "sdk/formrecognizer/azure-ai-formrecognizer/src/test/java/com/azure/ai/formrecognizer/FormRecognizerClientTest.java", "diffHunk": "@@ -1528,10 +1551,30 @@ public void recognizeBusinessCardSourceUrlWithPngFile(HttpClient httpClient,\n                     new RecognizeBusinessCardsOptions().setFieldElementsIncluded(true)\n                         .setPollInterval(durationTestMode), Context.NONE);\n             syncPoller.waitForCompletion();\n-            validateBusinessCardResultData(syncPoller.getFinalResult(), true);\n+            validatePrebuiltResultData(syncPoller.getFinalResult(), true, BUSINESS_CARD);\n         }, BUSINESS_CARD_PNG);\n     }\n \n+    /**\n+     * Verify business card recognition with multipage pdf url.\n+     */\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.ai.formrecognizer.TestUtils#getTestParameters\")\n+    public void recognizeMultipageBusinessCardUrl(HttpClient httpClient, FormRecognizerServiceVersion serviceVersion) {\n+        client = getFormRecognizerClient(httpClient, serviceVersion);\n+        urlRunner(sourceUrl -> {\n+            SyncPoller<FormRecognizerOperationResult, List<RecognizedForm>> syncPoller =\n+                client.beginRecognizeBusinessCardsFromUrl(sourceUrl,\n+                    new RecognizeBusinessCardsOptions()\n+                        .setContentType(FormContentType.APPLICATION_PDF)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17505b6ae9aad715fdaccefbfd5b34fb539015ea"}, "originalPosition": 174}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODU5MzQ2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651#pullrequestreview-514859346", "createdAt": "2020-10-22T15:33:42Z", "commit": {"oid": "17505b6ae9aad715fdaccefbfd5b34fb539015ea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c060e572f09acd0594fff41215610ccb10a1f364", "author": {"user": {"login": "samvaity", "name": "Sameeksha Vaity"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c060e572f09acd0594fff41215610ccb10a1f364", "committedDate": "2020-10-22T17:27:55Z", "message": "remove content type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0OTY3NjA4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651#pullrequestreview-514967608", "createdAt": "2020-10-22T17:36:42Z", "commit": {"oid": "c060e572f09acd0594fff41215610ccb10a1f364"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzozNjo0MlrOHmsvwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzozNjo0MlrOHmsvwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0MTA1Nw==", "bodyText": "nit: extra line", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651#discussion_r510341057", "createdAt": "2020-10-22T17:36:42Z", "author": {"login": "mssfang"}, "path": "sdk/formrecognizer/azure-ai-formrecognizer/src/test/java/com/azure/ai/formrecognizer/FormRecognizerClientTestBase.java", "diffHunk": "@@ -655,29 +627,35 @@ void validateRecognizedResult(List<RecognizedForm> actualFormList, boolean inclu\n         }\n     }\n \n-    // Business cards\n-    void validateBusinessCardDataFields(Map<String, FormField> actualRecognizedBusinessCardFields, boolean includeFieldElements) {\n-        final AnalyzeResult analyzeResult = getAnalyzeRawResponse().getAnalyzeResult();\n-        List<ReadResult> readResults = analyzeResult.getReadResults();\n-        DocumentResult documentResult = analyzeResult.getDocumentResults().get(0);\n-        Map<String, FieldValue> expectedReceiptFields = documentResult.getFields();\n-\n-        BUSINESS_CARD_FIELDS.forEach(businessCardField ->\n-            validateFieldValueTransforms(expectedReceiptFields.get(businessCardField),\n-                actualRecognizedBusinessCardFields.get(businessCardField), readResults, includeFieldElements));\n-\n-    }\n-\n-    void validateBusinessCardResultData(List<RecognizedForm> actualBusinessCardList, boolean includeFieldElements) {\n+    void validatePrebuiltResultData(List<RecognizedForm> actualPrebuiltRecognizedForms, boolean includeFieldElements,\n+        PREBUILT_TYPE prebuiltType) {\n         final AnalyzeResult rawResponse = getAnalyzeRawResponse().getAnalyzeResult();\n-        for (int i = 0; i < actualBusinessCardList.size(); i++) {\n-            final RecognizedForm actualBusinessCard = actualBusinessCardList.get(i);\n-            validateLabeledData(actualBusinessCard, includeFieldElements, rawResponse.getReadResults(),\n-                rawResponse.getDocumentResults().get(i));\n-            validateBusinessCardDataFields(actualBusinessCard.getFields(), includeFieldElements);\n+        final List<ReadResult> rawReadResults = rawResponse.getReadResults();\n+        for (int i = 0; i < actualPrebuiltRecognizedForms.size(); i++) {\n+            final RecognizedForm actualForm = actualPrebuiltRecognizedForms.get(i);\n+            final DocumentResult rawDocumentResult = rawResponse.getDocumentResults().get(i);\n+\n+            validateLabeledData(actualForm, includeFieldElements, rawReadResults, rawDocumentResult);\n+            if (BUSINESS_CARD.equals(prebuiltType)) {\n+                BUSINESS_CARD_FIELDS.forEach(businessCardField ->\n+                    validateFieldValueTransforms(rawDocumentResult.getFields().get(businessCardField),\n+                        actualForm.getFields().get(businessCardField), rawReadResults, includeFieldElements));\n+            } else {\n+                RECEIPT_FIELDS.forEach(receiptField -> {\n+                    final Map<String, FormField> actualRecognizedReceiptFields = actualForm.getFields();\n+                    Map<String, FieldValue> expectedReceiptFields = rawDocumentResult.getFields();\n+                    assertEquals(expectedReceiptFields.get(\"ReceiptType\").getValueString(),\n+                        actualRecognizedReceiptFields.get(\"ReceiptType\").getValue().asString());\n+                    assertEquals(expectedReceiptFields.get(\"ReceiptType\").getConfidence(),\n+                        actualRecognizedReceiptFields.get(\"ReceiptType\").getConfidence());\n+                    validateFieldValueTransforms(rawDocumentResult.getFields().get(receiptField),\n+                        actualRecognizedReceiptFields.get(receiptField), rawReadResults, includeFieldElements);\n+                });\n+            }\n         }\n     }\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c060e572f09acd0594fff41215610ccb10a1f364"}, "originalPosition": 147}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0OTY5MTc0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651#pullrequestreview-514969174", "createdAt": "2020-10-22T17:38:43Z", "commit": {"oid": "c060e572f09acd0594fff41215610ccb10a1f364"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0OTcxMDU1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651#pullrequestreview-514971055", "createdAt": "2020-10-22T17:41:05Z", "commit": {"oid": "c060e572f09acd0594fff41215610ccb10a1f364"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzo0MTowNVrOHms6Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzo0MTowNVrOHms6Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0MzcyMw==", "bodyText": "nit: wrong comment", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651#discussion_r510343723", "createdAt": "2020-10-22T17:41:05Z", "author": {"login": "maririos"}, "path": "sdk/formrecognizer/azure-ai-formrecognizer/src/test/java/com/azure/ai/formrecognizer/FormRecognizerClientTestBase.java", "diffHunk": "@@ -110,6 +115,14 @@\n     static final List<String> BUSINESS_CARD_FIELDS = Arrays.asList(\"ContactNames\", \"JobTitles\", \"Departments\",\n         \"Emails\", \"Websites\", \"MobilePhones\", \"OtherPhones\", \"Faxes\", \"Addresses\", \"CompanyNames\");\n \n+    // Business Card fields", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c060e572f09acd0594fff41215610ccb10a1f364"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0OTkxNjgx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651#pullrequestreview-514991681", "createdAt": "2020-10-22T18:07:32Z", "commit": {"oid": "c060e572f09acd0594fff41215610ccb10a1f364"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxODowNzozMlrOHmt28g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxODowNzozMlrOHmt28g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM1OTI4Mg==", "bodyText": "in a future PR, this will be a great place to check that the page for ContactName is 2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651#discussion_r510359282", "createdAt": "2020-10-22T18:07:32Z", "author": {"login": "maririos"}, "path": "sdk/formrecognizer/azure-ai-formrecognizer/src/test/java/com/azure/ai/formrecognizer/FormRecognizerClientTestBase.java", "diffHunk": "@@ -799,10 +777,32 @@ static void validateMultiPageDataUnlabeled(List<RecognizedForm> actualRecognized\n                 assertNotNull(formField.getValue());\n                 assertNotNull(formField.getValueData().getText());\n                 assertNotNull(formField.getLabelData().getText());\n-\n             });\n         });\n     }\n+    static void validateMultipageBusinessData(List<RecognizedForm> recognizedBusinessCards) {\n+        assertEquals(2, recognizedBusinessCards.size());\n+        RecognizedForm businessCard1 = recognizedBusinessCards.get(0);\n+        RecognizedForm businessCard2 = recognizedBusinessCards.get(1);\n+\n+        assertEquals(1, businessCard1.getPageRange().getFirstPageNumber());\n+        assertEquals(1, businessCard1.getPageRange().getLastPageNumber());\n+        Map<String, FormField> businessCard1Fields = businessCard1.getFields();\n+        List<FormField> emailList = businessCard1Fields.get(\"Emails\").getValue().asList();\n+        assertEquals(\"johnsinger@contoso.com\", emailList.get(0).getValue().asString());\n+        List<FormField> phoneNumberList = businessCard1Fields.get(\"OtherPhones\").getValue().asList();\n+        assertEquals(\"+14257793479\", phoneNumberList.get(0).getValue().asPhoneNumber());\n+        assertNotNull(businessCard1.getPages());\n+\n+        assertEquals(2, businessCard2.getPageRange().getFirstPageNumber());\n+        assertEquals(2, businessCard2.getPageRange().getLastPageNumber());\n+        Map<String, FormField> businessCard2Fields = businessCard2.getFields();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c060e572f09acd0594fff41215610ccb10a1f364"}, "originalPosition": 175}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0OTkxNzQx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16651#pullrequestreview-514991741", "createdAt": "2020-10-22T18:07:36Z", "commit": {"oid": "c060e572f09acd0594fff41215610ccb10a1f364"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1899, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}