{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MDk5NDI5", "number": 12978, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzo0MToyNlrOENW85g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDo1MDowOFrOENaUxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDQyOTgyOnYy", "diffSide": "RIGHT", "path": "sdk/storage/azure-storage-blob-cryptography/pom.xml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzo0MToyNlrOGv_5kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxODozOToxNVrOGwBkyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4MzE4NA==", "bodyText": "This should target dependency correct?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12978#discussion_r452983184", "createdAt": "2020-07-10T17:41:26Z", "author": {"login": "alzimmermsft"}, "path": "sdk/storage/azure-storage-blob-cryptography/pom.xml", "diffHunk": "@@ -98,6 +98,12 @@\n       <version>1.0.8</version> <!-- {x-version-update;com.azure:azure-identity;dependency} -->\n       <scope>test</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>com.azure</groupId>\n+      <artifactId>azure-security-keyvault-keys</artifactId>\n+      <version>4.2.0-beta.5</version> <!-- {x-version-update;com.azure:azure-security-keyvault-keys;current} -->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b12eba114671bfa02423661412abe99698f03d75"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwOTQ1Ng==", "bodyText": "Yeah I tried that but I think dependency is latest GA version, which doesnt have the latest LocalKeyEncryptionKey stuff", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12978#discussion_r453009456", "createdAt": "2020-07-10T18:37:15Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/pom.xml", "diffHunk": "@@ -98,6 +98,12 @@\n       <version>1.0.8</version> <!-- {x-version-update;com.azure:azure-identity;dependency} -->\n       <scope>test</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>com.azure</groupId>\n+      <artifactId>azure-security-keyvault-keys</artifactId>\n+      <version>4.2.0-beta.5</version> <!-- {x-version-update;com.azure:azure-security-keyvault-keys;current} -->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4MzE4NA=="}, "originalCommit": {"oid": "b12eba114671bfa02423661412abe99698f03d75"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAxMDYzMw==", "bodyText": "Ah, didn't realize that.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12978#discussion_r453010633", "createdAt": "2020-07-10T18:39:15Z", "author": {"login": "alzimmermsft"}, "path": "sdk/storage/azure-storage-blob-cryptography/pom.xml", "diffHunk": "@@ -98,6 +98,12 @@\n       <version>1.0.8</version> <!-- {x-version-update;com.azure:azure-identity;dependency} -->\n       <scope>test</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>com.azure</groupId>\n+      <artifactId>azure-security-keyvault-keys</artifactId>\n+      <version>4.2.0-beta.5</version> <!-- {x-version-update;com.azure:azure-security-keyvault-keys;current} -->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4MzE4NA=="}, "originalCommit": {"oid": "b12eba114671bfa02423661412abe99698f03d75"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDQ1MjUwOnYy", "diffSide": "RIGHT", "path": "sdk/storage/test-resources.json", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzo0OToyMFrOGwAIIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzo0OToyMFrOGwAIIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4NjkxNQ==", "bodyText": "I think AAD needs to be given access to this resource.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12978#discussion_r452986915", "createdAt": "2020-07-10T17:49:20Z", "author": {"login": "alzimmermsft"}, "path": "sdk/storage/test-resources.json", "diffHunk": "@@ -239,6 +249,77 @@\n                     \"keySource\": \"Microsoft.Storage\"\n                 }\n             }\n+        },\n+        {\n+            \"type\": \"Microsoft.KeyVault/vaults\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b12eba114671bfa02423661412abe99698f03d75"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNDk4MjQ1OnYy", "diffSide": "RIGHT", "path": "sdk/storage/azure-storage-blob-cryptography/src/test/java/com/azure/storage/blob/specialized/cryptography/KeyvaultKeyTest.groovy", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDo1MDowOFrOGwFP7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzo0MToxN1rOGwy8VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDgyOQ==", "bodyText": "Ideally, I would build a pipeline here and in playback mode skip adding the BearerTokenAuth policy in the pipeline.\nThen set the pipeline on the builder.\nBut, to keep the setup as it is, the below line might work too. The credential should return a dummy token in playback mode.\n.credential(trc -> Mono.just(new AccessToken(\"Dummy-Token\", OffsetDateTime.now().plusHours(2))));", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12978#discussion_r453070829", "createdAt": "2020-07-10T20:50:08Z", "author": {"login": "g2vinay"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/test/java/com/azure/storage/blob/specialized/cryptography/KeyvaultKeyTest.groovy", "diffHunk": "@@ -0,0 +1,155 @@\n+package com.azure.storage.blob.specialized.cryptography\n+\n+import com.azure.core.credential.TokenCredential\n+import com.azure.core.cryptography.AsyncKeyEncryptionKey\n+import com.azure.core.http.HttpClient\n+import com.azure.core.http.HttpPipeline\n+import com.azure.core.http.HttpPipelineBuilder\n+import com.azure.core.http.netty.NettyAsyncHttpClientBuilder\n+import com.azure.core.http.policy.BearerTokenAuthenticationPolicy\n+import com.azure.core.http.policy.ExponentialBackoff\n+import com.azure.core.http.policy.HttpLogDetailLevel\n+import com.azure.core.http.policy.HttpLogOptions\n+import com.azure.core.http.policy.HttpLoggingPolicy\n+import com.azure.core.http.policy.HttpPipelinePolicy\n+import com.azure.core.http.policy.HttpPolicyProviders\n+import com.azure.core.http.policy.RetryPolicy\n+import com.azure.core.http.policy.RetryStrategy\n+import com.azure.core.http.policy.UserAgentPolicy\n+import com.azure.core.test.TestMode\n+import com.azure.core.util.Configuration\n+import com.azure.identity.ClientSecretCredentialBuilder\n+import com.azure.identity.DefaultAzureCredentialBuilder\n+import com.azure.security.keyvault.keys.KeyClient\n+import com.azure.security.keyvault.keys.KeyClientBuilder\n+import com.azure.security.keyvault.keys.KeyServiceVersion\n+import com.azure.security.keyvault.keys.cryptography.KeyEncryptionKeyClientBuilder\n+import com.azure.security.keyvault.keys.models.CreateRsaKeyOptions\n+import com.azure.security.keyvault.keys.models.KeyVaultKey\n+import com.azure.storage.blob.BlobContainerClient\n+import com.azure.storage.common.implementation.Constants\n+\n+import java.time.Duration\n+import java.time.OffsetDateTime\n+\n+class KeyvaultKeyTest extends APISpec {\n+\n+    BlobContainerClient cc\n+    EncryptedBlobClient bec // encrypted client for download\n+    KeyClient keyClient\n+    String keyId\n+\n+    def setup() {\n+        def keyVaultUrl = \"https://azstoragesdkvault.vault.azure.net/\"\n+        if (testMode != TestMode.PLAYBACK) {\n+            keyVaultUrl = Configuration.getGlobalConfiguration().get(\"KEYVAULT_URL\")\n+        }\n+\n+        KeyClientBuilder builder = new KeyClientBuilder()\n+            .pipeline(getHttpPipeline(getHttpClient(), KeyServiceVersion.V7_0))\n+\n+        keyClient = builder\n+            .httpClient(getHttpClient())\n+            .vaultUrl(keyVaultUrl)\n+            .buildClient()\n+\n+        keyId = generateResourceName(\"keyId\", entityNo++)\n+\n+        KeyVaultKey keyVaultKey = keyClient.createRsaKey(new CreateRsaKeyOptions(keyId)\n+            .setExpiresOn(OffsetDateTime.now().plusYears(1))\n+            .setKeySize(2048))\n+\n+        AsyncKeyEncryptionKey akek = new KeyEncryptionKeyClientBuilder()\n+            .credential(new DefaultAzureCredentialBuilder().build())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b12eba114671bfa02423661412abe99698f03d75"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxOTQ3Ng==", "bodyText": "Thanks for catching that! Forgot about this client", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12978#discussion_r453819476", "createdAt": "2020-07-13T17:41:17Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/test/java/com/azure/storage/blob/specialized/cryptography/KeyvaultKeyTest.groovy", "diffHunk": "@@ -0,0 +1,155 @@\n+package com.azure.storage.blob.specialized.cryptography\n+\n+import com.azure.core.credential.TokenCredential\n+import com.azure.core.cryptography.AsyncKeyEncryptionKey\n+import com.azure.core.http.HttpClient\n+import com.azure.core.http.HttpPipeline\n+import com.azure.core.http.HttpPipelineBuilder\n+import com.azure.core.http.netty.NettyAsyncHttpClientBuilder\n+import com.azure.core.http.policy.BearerTokenAuthenticationPolicy\n+import com.azure.core.http.policy.ExponentialBackoff\n+import com.azure.core.http.policy.HttpLogDetailLevel\n+import com.azure.core.http.policy.HttpLogOptions\n+import com.azure.core.http.policy.HttpLoggingPolicy\n+import com.azure.core.http.policy.HttpPipelinePolicy\n+import com.azure.core.http.policy.HttpPolicyProviders\n+import com.azure.core.http.policy.RetryPolicy\n+import com.azure.core.http.policy.RetryStrategy\n+import com.azure.core.http.policy.UserAgentPolicy\n+import com.azure.core.test.TestMode\n+import com.azure.core.util.Configuration\n+import com.azure.identity.ClientSecretCredentialBuilder\n+import com.azure.identity.DefaultAzureCredentialBuilder\n+import com.azure.security.keyvault.keys.KeyClient\n+import com.azure.security.keyvault.keys.KeyClientBuilder\n+import com.azure.security.keyvault.keys.KeyServiceVersion\n+import com.azure.security.keyvault.keys.cryptography.KeyEncryptionKeyClientBuilder\n+import com.azure.security.keyvault.keys.models.CreateRsaKeyOptions\n+import com.azure.security.keyvault.keys.models.KeyVaultKey\n+import com.azure.storage.blob.BlobContainerClient\n+import com.azure.storage.common.implementation.Constants\n+\n+import java.time.Duration\n+import java.time.OffsetDateTime\n+\n+class KeyvaultKeyTest extends APISpec {\n+\n+    BlobContainerClient cc\n+    EncryptedBlobClient bec // encrypted client for download\n+    KeyClient keyClient\n+    String keyId\n+\n+    def setup() {\n+        def keyVaultUrl = \"https://azstoragesdkvault.vault.azure.net/\"\n+        if (testMode != TestMode.PLAYBACK) {\n+            keyVaultUrl = Configuration.getGlobalConfiguration().get(\"KEYVAULT_URL\")\n+        }\n+\n+        KeyClientBuilder builder = new KeyClientBuilder()\n+            .pipeline(getHttpPipeline(getHttpClient(), KeyServiceVersion.V7_0))\n+\n+        keyClient = builder\n+            .httpClient(getHttpClient())\n+            .vaultUrl(keyVaultUrl)\n+            .buildClient()\n+\n+        keyId = generateResourceName(\"keyId\", entityNo++)\n+\n+        KeyVaultKey keyVaultKey = keyClient.createRsaKey(new CreateRsaKeyOptions(keyId)\n+            .setExpiresOn(OffsetDateTime.now().plusYears(1))\n+            .setKeySize(2048))\n+\n+        AsyncKeyEncryptionKey akek = new KeyEncryptionKeyClientBuilder()\n+            .credential(new DefaultAzureCredentialBuilder().build())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDgyOQ=="}, "originalCommit": {"oid": "b12eba114671bfa02423661412abe99698f03d75"}, "originalPosition": 63}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3609, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}