{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5OTk2MzI5", "number": 14270, "title": "add resource manager throttling info", "bodyText": "close Azure/azure-libraries-for-java#1222\nShould we close the issue after merging?", "createdAt": "2020-08-19T08:10:46Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270", "merged": true, "mergeCommit": {"oid": "73aaeb301acf7fcb0511f81f4e4fac0c5f04bf42"}, "closed": true, "closedAt": "2020-08-20T08:05:03Z", "author": {"login": "ChenTanyi"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAXEDqgH2gAyNDY5OTk2MzI5OjE3NTk5NWJkZDUxYzYxZmM4YzFmYzA4MGExMDUyZGViNmE5YzJiZDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAqbSNgH2gAyNDY5OTk2MzI5OmUzYmMyMDYzNjUzN2Q3MjNiNTI0ZGMzNTFkNWJiNDU3Y2Y3YTAwMDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "175995bdd51c61fc8c1fc080a1052deb6a9c2bd6", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/175995bdd51c61fc8c1fc080a1052deb6a9c2bd6", "committedDate": "2020-08-19T08:09:29Z", "message": "add resource manager throttling info"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMjMwMjM2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270#pullrequestreview-470230236", "createdAt": "2020-08-19T08:20:48Z", "commit": {"oid": "175995bdd51c61fc8c1fc080a1052deb6a9c2bd6"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODoyMDo0OFrOHC8f3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODoyNToxOFrOHC8q-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg1MDM5OQ==", "bodyText": "It would be nice if we can try parse it, regex maybe. We can give user the string, and if we can parse, put value to commonRateLimits.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270#discussion_r472850399", "createdAt": "2020-08-19T08:20:48Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/ResourceManagerThrottlingInfo.java", "diffHunk": "@@ -0,0 +1,91 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.resourcemanager.resources.fluentcore.utils;\n+\n+import com.azure.core.http.HttpHeaders;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * The class to collect all throttling info from response header\n+ */\n+public class ResourceManagerThrottlingInfo {\n+    // refer https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/request-limits-and-throttling\n+    private static final List<String> COMMON_RATE_LIMIT_HEADERS = Arrays.asList(\n+        \"x-ms-ratelimit-remaining-subscription-reads\",\n+        \"x-ms-ratelimit-remaining-subscription-writes\",\n+        \"x-ms-ratelimit-remaining-tenant-reads\",\n+        \"x-ms-ratelimit-remaining-tenant-writes\",\n+        \"x-ms-ratelimit-remaining-subscription-resource-requests\",\n+        \"x-ms-ratelimit-remaining-subscription-resource-entities-read\",\n+        \"x-ms-ratelimit-remaining-tenant-resource-requests\",\n+        \"x-ms-ratelimit-remaining-tenant-resource-entities-read\"\n+    );\n+\n+    // refer https://docs.microsoft.com/en-us/azure/virtual-machines/troubleshooting/troubleshooting-throttling-errors\n+    private static final String RESOURCE_RATE_LIMIT_HEADERS = \"x-ms-ratelimit-remaining-resource\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "175995bdd51c61fc8c1fc080a1052deb6a9c2bd6"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg1MjUxOQ==", "bodyText": "Probably need to notify that the code in callback is not thread-safe.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270#discussion_r472852519", "createdAt": "2020-08-19T08:24:16Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/policy/ResourceManagerThrottlingPolicy.java", "diffHunk": "@@ -7,86 +7,28 @@\n import com.azure.core.http.HttpPipelineNextPolicy;\n import com.azure.core.http.HttpResponse;\n import com.azure.core.http.policy.HttpPipelinePolicy;\n-import com.azure.core.util.DateTimeRfc1123;\n-import com.azure.core.util.FluxUtil;\n-import com.azure.core.util.logging.ClientLogger;\n-import com.azure.resourcemanager.resources.fluentcore.utils.SdkContext;\n+import com.azure.resourcemanager.resources.fluentcore.utils.ResourceManagerThrottlingInfo;\n import reactor.core.publisher.Mono;\n \n-import java.nio.charset.StandardCharsets;\n-import java.time.Duration;\n-import java.time.Instant;\n-import java.time.OffsetDateTime;\n-import java.util.concurrent.TimeUnit;\n-import java.util.regex.Matcher;\n-import java.util.regex.Pattern;\n+import java.util.function.Consumer;\n \n /**\n- * A Http Pipeline Policy for automatic retry when Azure Resource Manager is throttling\n- * because of too many read/write requests.\n- * <p>\n- * For each subscription and tenant, Azure Resource Manager limits read requests to 15,000 per hour and\n- *   write requests to 1,200 per hour. These limits apply to each Azure Resource Manager instance.\n+ * A Http Pipeline Policy for automatic send throttling rate limit info to a call back function\n  */\n public class ResourceManagerThrottlingPolicy implements HttpPipelinePolicy {\n-    private static final String RETRY_MESSAGE_FORMAT =\n-        \"Azure Resource Manager read/write per hour limit reached. Will retry in: %d seconds\";\n+    private final Consumer<? super ResourceManagerThrottlingInfo> callback;\n+\n+    /**\n+     * Creates the resource manager throttling policy\n+     * @param callback consume the ResourceManagerThrottlingInfo for every request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "175995bdd51c61fc8c1fc080a1052deb6a9c2bd6"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg1MzI0MQ==", "bodyText": "If possible, get info on whether network/storage has limit but does not return in headers.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270#discussion_r472853241", "createdAt": "2020-08-19T08:25:18Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/ResourceManagerThrottlingInfo.java", "diffHunk": "@@ -0,0 +1,91 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.resourcemanager.resources.fluentcore.utils;\n+\n+import com.azure.core.http.HttpHeaders;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * The class to collect all throttling info from response header", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "175995bdd51c61fc8c1fc080a1052deb6a9c2bd6"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86bbab63934a6a53df5eeb23bea96836b9ca7c7a", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/86bbab63934a6a53df5eeb23bea96836b9ca7c7a", "committedDate": "2020-08-20T02:23:05Z", "message": "add additional comment and regex for resource limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDkzNDIz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270#pullrequestreview-471093423", "createdAt": "2020-08-20T02:57:32Z", "commit": {"oid": "175995bdd51c61fc8c1fc080a1052deb6a9c2bd6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff61c045f401d702f38598667c1c018bd51e170a", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ff61c045f401d702f38598667c1c018bd51e170a", "committedDate": "2020-08-20T03:09:29Z", "message": "add test and fix regex"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDk4MjAy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270#pullrequestreview-471098202", "createdAt": "2020-08-20T03:14:57Z", "commit": {"oid": "ff61c045f401d702f38598667c1c018bd51e170a"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMzoxNDo1OFrOHDn96A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMzoxNjoyMlrOHDn_Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2MjYwMA==", "bodyText": "Should we put Pattern.compile(\"\\\\w+\\\\.\\\\w+/([^;]+);(\\\\d+)\") to a static, to save runtime cost to do it every time?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270#discussion_r473562600", "createdAt": "2020-08-20T03:14:58Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/ResourceManagerThrottlingInfo.java", "diffHunk": "@@ -47,6 +50,11 @@ public ResourceManagerThrottlingInfo(HttpHeaders headers) {\n             }\n         }\n         resourceRateLimit = headers.getValue(RESOURCE_RATE_LIMIT_HEADERS);\n+        Matcher matcher = Pattern.compile(\"\\\\w+\\\\.\\\\w+/([^;]+);(\\\\d+)\").matcher(resourceRateLimit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff61c045f401d702f38598667c1c018bd51e170a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2Mjk3OQ==", "bodyText": "a specific rate limit header value from compute should be enough. without parsed here seems grammatically not correct.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270#discussion_r473562979", "createdAt": "2020-08-20T03:16:22Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/ResourceManagerThrottlingInfo.java", "diffHunk": "@@ -83,7 +91,7 @@ public static ResourceManagerThrottlingInfo fromHeaders(HttpHeaders headers) {\n \n     /**\n      * refer https://docs.microsoft.com/en-us/azure/virtual-machines/troubleshooting/troubleshooting-throttling-errors\n-     * @return a specific rate limit from compute\n+     * @return a specific rate limit header value without parsed from compute", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff61c045f401d702f38598667c1c018bd51e170a"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23201affcb71666463bbb1682d99b16465631290", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/23201affcb71666463bbb1682d99b16465631290", "committedDate": "2020-08-20T03:25:42Z", "message": "fix comment and move info test to a new class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMTQ0NTQ0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270#pullrequestreview-471144544", "createdAt": "2020-08-20T03:57:12Z", "commit": {"oid": "ff61c045f401d702f38598667c1c018bd51e170a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMzo1NzoxMlrOHDom2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMzo1NzoxMlrOHDom2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3MzA4MQ==", "bodyText": "The callback seems better to take a HttpResponse, so received be able to match request/response with throttling info.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270#discussion_r473573081", "createdAt": "2020-08-20T03:57:12Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/policy/ResourceManagerThrottlingPolicy.java", "diffHunk": "@@ -7,86 +7,28 @@\n import com.azure.core.http.HttpPipelineNextPolicy;\n import com.azure.core.http.HttpResponse;\n import com.azure.core.http.policy.HttpPipelinePolicy;\n-import com.azure.core.util.DateTimeRfc1123;\n-import com.azure.core.util.FluxUtil;\n-import com.azure.core.util.logging.ClientLogger;\n-import com.azure.resourcemanager.resources.fluentcore.utils.SdkContext;\n+import com.azure.resourcemanager.resources.fluentcore.utils.ResourceManagerThrottlingInfo;\n import reactor.core.publisher.Mono;\n \n-import java.nio.charset.StandardCharsets;\n-import java.time.Duration;\n-import java.time.Instant;\n-import java.time.OffsetDateTime;\n-import java.util.concurrent.TimeUnit;\n-import java.util.regex.Matcher;\n-import java.util.regex.Pattern;\n+import java.util.function.Consumer;\n \n /**\n- * A Http Pipeline Policy for automatic retry when Azure Resource Manager is throttling\n- * because of too many read/write requests.\n- * <p>\n- * For each subscription and tenant, Azure Resource Manager limits read requests to 15,000 per hour and\n- *   write requests to 1,200 per hour. These limits apply to each Azure Resource Manager instance.\n+ * A Http Pipeline Policy for automatic send throttling rate limit info to a call back function\n  */\n public class ResourceManagerThrottlingPolicy implements HttpPipelinePolicy {\n-    private static final String RETRY_MESSAGE_FORMAT =\n-        \"Azure Resource Manager read/write per hour limit reached. Will retry in: %d seconds\";\n+    private final Consumer<? super ResourceManagerThrottlingInfo> callback;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff61c045f401d702f38598667c1c018bd51e170a"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMjE1MTI3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14270#pullrequestreview-471215127", "createdAt": "2020-08-20T04:40:08Z", "commit": {"oid": "ff61c045f401d702f38598667c1c018bd51e170a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0824c0b1cc39ebf60d5994daecd05ddd5d43fe6e", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0824c0b1cc39ebf60d5994daecd05ddd5d43fe6e", "committedDate": "2020-08-20T05:28:22Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e07388cdaaa794a8852c825c09a5c9ef5dec8ac7", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e07388cdaaa794a8852c825c09a5c9ef5dec8ac7", "committedDate": "2020-08-20T05:58:34Z", "message": "return response as well in ResourceManagerThrottlingPolicy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8887a1b13954b5ce754c6c726bc6fdaab192c81b", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8887a1b13954b5ce754c6c726bc6fdaab192c81b", "committedDate": "2020-08-20T05:59:27Z", "message": "use static pattern"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3bc20636537d723b524dc351d5bb457cf7a0000", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e3bc20636537d723b524dc351d5bb457cf7a0000", "committedDate": "2020-08-20T06:43:03Z", "message": "compile error in java 8"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 295, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}