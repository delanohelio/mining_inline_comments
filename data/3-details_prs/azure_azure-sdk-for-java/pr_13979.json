{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MjE4NzAx", "number": 13979, "title": "Updated Changefeed to be able to read last consumable. Also unified cursor.", "bodyText": "Cursor format:\n{\n\"CursorVersion\": 1,\n\"UrlHost\": \"azstoragesdkaccount.blob.core.windows.net\",\n\"EndTime\": \"2020-07-31T00:00:00Z\",\n\"CurrentSegmentCursor\": {\n\"ShardCursors\": [\n{\n\"CurrentChunkPath\": \"log/00/2020/07/30/2300/00000.avro\",\n\"BlockOffset\": 96253,\n\"EventIndex\": 0\n}\n],\n\"CurrentShardPath\": \"log/00/2020/07/30/2300/\",\n\"SegmentPath\": \"idx/segments/2020/07/30/2300/meta.json\"\n}\n}", "createdAt": "2020-08-11T16:31:15Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13979", "merged": true, "mergeCommit": {"oid": "eb6850517315026c67c3748e3f85225f027537f2"}, "closed": true, "closedAt": "2020-08-13T17:20:50Z", "author": {"login": "gapra-msft"}, "timelineItems": {"totalCount": 36, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7rxutgH2gAyNDY2MjE4NzAxOjE5MDIwNDQ2ZGM0NmM0YTlmODIzNmJjZTU2YTEwMTU5OWMxMTJhMmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-iK10AFqTQ2Njg5OTk4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "19020446dc46c4a9f8236bce56a101599c112a2b", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/19020446dc46c4a9f8236bce56a101599c112a2b", "committedDate": "2020-08-04T19:27:51Z", "message": "Added support for writing, serializing and deserializing new cursor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93deb8595bd4f7cd7c25523d052b897ad8254054", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/93deb8595bd4f7cd7c25523d052b897ad8254054", "committedDate": "2020-08-04T21:19:31Z", "message": "Added support to read from new cursor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "608fc287f0a774418c492c8dfd2e52ef8f157954", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/608fc287f0a774418c492c8dfd2e52ef8f157954", "committedDate": "2020-08-04T21:40:34Z", "message": "Removed all references to old cursor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1be6ff372edef81b509909e4ba410386240b446b", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1be6ff372edef81b509909e4ba410386240b446b", "committedDate": "2020-08-04T23:29:05Z", "message": "Added tests for ChangefeedCursor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe4ca41ff12afc043d9a3ac0142076ce75cde77a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/fe4ca41ff12afc043d9a3ac0142076ce75cde77a", "committedDate": "2020-08-05T16:12:53Z", "message": "Modified BlobChangefeedPagedFlux tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71b4140db779acba55324c5806957506d6743d34", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/71b4140db779acba55324c5806957506d6743d34", "committedDate": "2020-08-05T17:18:58Z", "message": "Fixed bug where last consumable would not be included in iteration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6425bac3cd5965f94c30103577b8558d4d5baeff", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6425bac3cd5965f94c30103577b8558d4d5baeff", "committedDate": "2020-08-05T18:19:10Z", "message": "In the middle of changing chunk test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "969e8210a430722e8008ae80f766b4fcd7e3b215", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/969e8210a430722e8008ae80f766b4fcd7e3b215", "committedDate": "2020-08-06T16:06:38Z", "message": "modified chunk test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "806082dfd9b410c3655806ac8566529511237f70", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/806082dfd9b410c3655806ac8566529511237f70", "committedDate": "2020-08-06T18:39:46Z", "message": "Added more tests for chunk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2de1c4355e99336f6bb14451639e24b75731abf5", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2de1c4355e99336f6bb14451639e24b75731abf5", "committedDate": "2020-08-06T19:44:13Z", "message": "Added more test for Chunk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a43a72059ef7c6b141898cf9752e93be1d379e17", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a43a72059ef7c6b141898cf9752e93be1d379e17", "committedDate": "2020-08-06T20:02:18Z", "message": "Added more chunk tests and added code to check for cursor version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92e3f55e11bb235207e3749ab4b508b2c104d333", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/92e3f55e11bb235207e3749ab4b508b2c104d333", "committedDate": "2020-08-06T21:03:34Z", "message": "Modified some ShardTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec202d9ab53e9a51c034e632018607afad203820", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ec202d9ab53e9a51c034e632018607afad203820", "committedDate": "2020-08-06T22:42:15Z", "message": "Added more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e35e1b0228b252e8eb767a36a6e687c4800660a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8e35e1b0228b252e8eb767a36a6e687c4800660a", "committedDate": "2020-08-07T16:41:59Z", "message": "modifying tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db241c89ecfcc19b017e38c7034347233a104465", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/db241c89ecfcc19b017e38c7034347233a104465", "committedDate": "2020-08-07T19:23:22Z", "message": "Updated segment test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a98e2225ebf755616a1f365137e22590d33924bd", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a98e2225ebf755616a1f365137e22590d33924bd", "committedDate": "2020-08-07T19:50:31Z", "message": "Modified Changefeed test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eba82b795ed19103fb85257b6382770df587f657", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/eba82b795ed19103fb85257b6382770df587f657", "committedDate": "2020-08-07T23:02:23Z", "message": "Added prints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11ce4ef6fd9b9eb41af176f7f580e93f1754e0e3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/11ce4ef6fd9b9eb41af176f7f580e93f1754e0e3", "committedDate": "2020-08-10T16:41:16Z", "message": "Added more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81aac47f3217d1c8777b985dfc24819e0dbb8c61", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/81aac47f3217d1c8777b985dfc24819e0dbb8c61", "committedDate": "2020-08-10T18:37:33Z", "message": "Added code for test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38a16474c34db57198c7d2f2ffd30e75b15cd2b2", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/38a16474c34db57198c7d2f2ffd30e75b15cd2b2", "committedDate": "2020-08-10T23:10:40Z", "message": "Added some new recorded tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c47ebd8de4ec45ef45c40bb48c8a83ef79a3937", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5c47ebd8de4ec45ef45c40bb48c8a83ef79a3937", "committedDate": "2020-08-11T02:38:20Z", "message": "Added all CF tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcd26e3ca9124e314000a75bd0f6bbd6a73cba6d", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/dcd26e3ca9124e314000a75bd0f6bbd6a73cba6d", "committedDate": "2020-08-11T02:40:32Z", "message": "Added comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f175ed74177023919f1eb0a329e033549a02fa81", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f175ed74177023919f1eb0a329e033549a02fa81", "committedDate": "2020-08-11T16:29:28Z", "message": "Modified to use url host instead of url hash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90c418d5d5d224650c6adbd0be37a2944eca6b6a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/90c418d5d5d224650c6adbd0be37a2944eca6b6a", "committedDate": "2020-08-11T16:31:56Z", "message": "Optimized imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c220bd656a561ddccb30982305e52225490a3f95", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c220bd656a561ddccb30982305e52225490a3f95", "committedDate": "2020-08-11T17:50:27Z", "message": "Modified pom"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fa06c7b0871f3e85d24fe59c7ca5b822f4dc322", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6fa06c7b0871f3e85d24fe59c7ca5b822f4dc322", "committedDate": "2020-08-11T18:54:30Z", "message": "Added code to pass Analyze step"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "787e9ee3c333c230fbaa6e6e16b0182da19b16fa", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/787e9ee3c333c230fbaa6e6e16b0182da19b16fa", "committedDate": "2020-08-12T17:17:14Z", "message": "Added code to change cursor starting point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3e3b63665d254a6ce0629ab54b6cef6dceb740f", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f3e3b63665d254a6ce0629ab54b6cef6dceb740f", "committedDate": "2020-08-12T20:11:57Z", "message": "Updated AvroParser logic to live in BlockSchema"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a7df8664b36ac569c05c160eedbffc6fec1a046", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a7df8664b36ac569c05c160eedbffc6fec1a046", "committedDate": "2020-08-12T20:15:29Z", "message": "Cleaned up more code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b9ee845f5aa544f5023d98ccc9358e9ad45e472", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b9ee845f5aa544f5023d98ccc9358e9ad45e472", "committedDate": "2020-08-12T20:16:40Z", "message": "Removed comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31b8801f9535ffd516837c6a6780bdca305ad3f2", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/31b8801f9535ffd516837c6a6780bdca305ad3f2", "committedDate": "2020-08-12T20:45:41Z", "message": "Fixed some more stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "149da3fcaf78dde9fc1f7650ad38cd89e7e64185", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/149da3fcaf78dde9fc1f7650ad38cd89e7e64185", "committedDate": "2020-08-12T22:31:18Z", "message": "Added readme sample"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODY1OTk4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13979#pullrequestreview-466865998", "createdAt": "2020-08-13T15:19:42Z", "commit": {"oid": "31b8801f9535ffd516837c6a6780bdca305ad3f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODcwOTc5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13979#pullrequestreview-466870979", "createdAt": "2020-08-13T15:25:01Z", "commit": {"oid": "149da3fcaf78dde9fc1f7650ad38cd89e7e64185"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNToyNTowMlrOHAQr-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNTozMzo0NlrOHARCsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAzNTQ1MA==", "bodyText": "endTime is/should be optional parameter. How do we handle that case? I.e. we should default to lastConsumable if end time is null . Also if end time is null we shouldn't populate it in the cursor.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13979#discussion_r470035450", "createdAt": "2020-08-13T15:25:02Z", "author": {"login": "kasobol-msft"}, "path": "sdk/storage/azure-storage-blob-changefeed/src/main/java/com/azure/storage/blob/changefeed/Changefeed.java", "diffHunk": "@@ -100,25 +116,24 @@\n     private Mono<OffsetDateTime> populateLastConsumable() {\n         /* We can keep the entire metadata file in memory since it is expected to only be a few hundred bytes. */\n         return DownloadUtils.downloadToByteArray(this.client, METADATA_SEGMENT_PATH)\n+            .flatMap(DownloadUtils::parseJson)\n             /* Parse JSON for last consumable. */\n-            .flatMap(json -> {\n-                try {\n-                    JsonNode jsonNode = MAPPER.reader().readTree(json);\n-                    this.lastConsumable = OffsetDateTime.parse(jsonNode.get(\"lastConsumable\").asText());\n-                    if (this.lastConsumable.isBefore(endTime)) {\n-                        this.safeEndTime = this.lastConsumable;\n-                    }\n-                    return Mono.just(this.lastConsumable);\n-                } catch (IOException e) {\n-                    return FluxUtil.monoError(logger, new UncheckedIOException(e));\n+            .flatMap(jsonNode -> {\n+                /* Last consumable time. The latest time the changefeed can safely be read from.*/\n+                OffsetDateTime lastConsumableTime = OffsetDateTime.parse(jsonNode.get(\"lastConsumable\").asText());\n+                /* Soonest time between lastConsumable and endTime. */\n+                OffsetDateTime safeEndTime = this.endTime;\n+                if (lastConsumableTime.isBefore(endTime)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "149da3fcaf78dde9fc1f7650ad38cd89e7e64185"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0MDI3NQ==", "bodyText": "I'd go back to ObjectIndex. Avro doesn't know it's used in CF context. It's supposed to be general purpose parser.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13979#discussion_r470040275", "createdAt": "2020-08-13T15:32:16Z", "author": {"login": "kasobol-msft"}, "path": "sdk/storage/azure-storage-internal-avro/src/main/java/com/azure/storage/internal/avro/implementation/AvroObject.java", "diffHunk": "@@ -35,8 +42,8 @@ public long getBlockOffset() {\n     /**\n      * @return The index of the object in the block.\n      */\n-    public long getObjectBlockIndex() {\n-        return objectBlockIndex;\n+    public long getEventIndex() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "149da3fcaf78dde9fc1f7650ad38cd89e7e64185"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0MTI2Ng==", "bodyText": "maybe this should be called beginIndex or beginObjectIndex. Threshold sounds more like upper boundary.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13979#discussion_r470041266", "createdAt": "2020-08-13T15:33:46Z", "author": {"login": "kasobol-msft"}, "path": "sdk/storage/azure-storage-internal-avro/src/main/java/com/azure/storage/internal/avro/implementation/AvroParser.java", "diffHunk": "@@ -106,31 +103,26 @@ private void onFilteredHeader(Object header) {\n \n         /* On reading the header, read a block. */\n         if (!partialRead) { /* Only do this if we are reading the stream from start to finish. */\n-            onBlock(-1L);\n+            onBlock(0L);\n         }\n     }\n \n     /**\n      * Block handler.\n      *\n-     * @param index The object index after which to start aggregating events in the block.\n+     * @param threshold The object index after which to start aggregating events in the block.\n      *                         By default this is 0 to collect all objects in the block.\n      */\n-    private void onBlock(Object index) {\n+    private void onBlock(Object threshold) {\n         /* On reading the block, read another block. */\n-        AvroSchema.checkType(\"objectBlockIndex\", index, Long.class);\n-        long threshold = (Long) index;\n+        AvroSchema.checkType(\"threshold\", threshold, Long.class);\n \n-        this.blockOffset = this.state.getSourceOffset();\n-        this.objectBlockIndex = 0;\n-        AvroBlockSchema blockSchema = new AvroBlockSchema(\n+        final AvroBlockSchema blockSchema = new AvroBlockSchema(\n             this.objectType,\n+            (Long) threshold,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "149da3fcaf78dde9fc1f7650ad38cd89e7e64185"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0e00ca1f777ad8ff5a811f182c9bae8413eadc8", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e0e00ca1f777ad8ff5a811f182c9bae8413eadc8", "committedDate": "2020-08-13T15:54:10Z", "message": "renamed eventIndex to objectIndex"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODk5OTgx", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13979#pullrequestreview-466899981", "createdAt": "2020-08-13T15:58:00Z", "commit": {"oid": "e0e00ca1f777ad8ff5a811f182c9bae8413eadc8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 555, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}