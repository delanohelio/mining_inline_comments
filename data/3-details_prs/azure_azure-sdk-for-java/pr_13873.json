{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0NTc0NzEx", "number": 13873, "title": "Settle delivered messages on AMQP receive link", "bodyText": "This PR updates the AMQP receive link to decode the message from Delivery and settle it immediately.\nProton-J holds on to the Delivery objects until it's explicitly settled and currently the EmitterProcessor only settles the message only if the downstream subscriber actually processes the message. So, if there are extra credits on the link and messages were delivered to the link but not consumed by the subscriber, they are stored in Proton-J's TransportSession forever as they are not settled.\nFixes #13775", "createdAt": "2020-08-07T12:22:04Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13873", "merged": true, "mergeCommit": {"oid": "30b8bbb8c8dc14d7a054bb974931c5d774018a52"}, "closed": true, "closedAt": "2020-08-11T22:19:59Z", "author": {"login": "srnagar"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8jUpXAH2gAyNDY0NTc0NzExOmYyZmE5ODkwM2E2MDk5NzIxMmJlYzQ1ZTA2M2JjNWMwYzU0ODNlZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc97Y3IgH2gAyNDY0NTc0NzExOjhjYTkwODIyOWNiZWU5MmIxMzIzNWQ1Yjc4Nzg0NTI4ODZiYWZkODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f2fa98903a60997212bec45e063bc5c0c5483eff", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f2fa98903a60997212bec45e063bc5c0c5483eff", "committedDate": "2020-08-07T12:10:46Z", "message": "Settle delivered messaged on AMQP receive link"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNDU3ODg4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13873#pullrequestreview-463457888", "createdAt": "2020-08-07T16:48:05Z", "commit": {"oid": "f2fa98903a60997212bec45e063bc5c0c5483eff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6cbb366a9543f696f289b38e592ef129f28a172", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e6cbb366a9543f696f289b38e592ef129f28a172", "committedDate": "2020-08-07T17:43:45Z", "message": "Fix warning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNTUzNDM4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13873#pullrequestreview-463553438", "createdAt": "2020-08-07T19:14:25Z", "commit": {"oid": "e6cbb366a9543f696f289b38e592ef129f28a172"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxOToxNDoyNVrOG9lEzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxOToxNDoyNVrOG9lEzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIyMzc1OQ==", "bodyText": "I was curious why we do decoding here? Does this break service bus? iirc, SB keeps track of deliveries when they are not in receive and delete mode to understand which ones to hold onto and when a user performs a settlement method on it, will then settle that delivery.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13873#discussion_r467223759", "createdAt": "2020-08-07T19:14:25Z", "author": {"login": "conniey"}, "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/handler/ReceiveLinkHandler.java", "diffHunk": "@@ -17,28 +19,31 @@\n \n public class ReceiveLinkHandler extends LinkHandler {\n     private final String linkName;\n+    private final Function<Delivery, Message> deliveryDecoder;\n     private AtomicBoolean isFirstResponse = new AtomicBoolean(true);\n-    private final DirectProcessor<Delivery> deliveries;\n-    private FluxSink<Delivery> deliverySink;\n+    private final DirectProcessor<Message> messages;\n+    private FluxSink<Message> messageSink;\n \n-    public ReceiveLinkHandler(String connectionId, String hostname, String linkName, String entityPath) {\n+    public ReceiveLinkHandler(String connectionId, String hostname, String linkName, String entityPath,\n+        Function<Delivery, Message> deliveryDecoder) {\n         super(connectionId, hostname, entityPath, new ClientLogger(ReceiveLinkHandler.class));\n-        this.deliveries = DirectProcessor.create();\n-        this.deliverySink = deliveries.sink(FluxSink.OverflowStrategy.BUFFER);\n+        this.messages = DirectProcessor.create();\n+        this.messageSink = messages.sink(FluxSink.OverflowStrategy.BUFFER);\n         this.linkName = linkName;\n+        this.deliveryDecoder = deliveryDecoder;\n     }\n \n     public String getLinkName() {\n         return linkName;\n     }\n \n-    public Flux<Delivery> getDeliveredMessages() {\n-        return deliveries;\n+    public Flux<Message> getDeliveredMessages() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6cbb366a9543f696f289b38e592ef129f28a172"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNTU0MDk2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13873#pullrequestreview-463554096", "createdAt": "2020-08-07T19:15:34Z", "commit": {"oid": "e6cbb366a9543f696f289b38e592ef129f28a172"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxOToxNTozNFrOG9lGtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxOToxNTozNFrOG9lGtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIyNDI0NQ==", "bodyText": "Are these changes also tested on service bus? I have a feeling it might break it.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13873#discussion_r467224245", "createdAt": "2020-08-07T19:15:34Z", "author": {"login": "conniey"}, "path": "eng/versioning/version_client.txt", "diffHunk": "@@ -81,6 +81,7 @@ com.microsoft.azure:spring-data-cosmosdb;3.0.0-beta.1;3.0.0-beta.1\n # unreleased_<groupId>:<artifactId>;dependency-version", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6cbb366a9543f696f289b38e592ef129f28a172"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e955f73c89e8ab48950dd2edaf069fd4fd4b63f", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0e955f73c89e8ab48950dd2edaf069fd4fd4b63f", "committedDate": "2020-08-07T19:20:50Z", "message": "Fix unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d32c32bc1413515597b2870a119d8802ec031e47", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d32c32bc1413515597b2870a119d8802ec031e47", "committedDate": "2020-08-07T20:57:04Z", "message": "Update add link credits condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15b11e814d77b3852400d7414f56af179b0d8568", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/15b11e814d77b3852400d7414f56af179b0d8568", "committedDate": "2020-08-07T21:29:37Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNjYwNTg3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13873#pullrequestreview-463660587", "createdAt": "2020-08-07T21:56:28Z", "commit": {"oid": "15b11e814d77b3852400d7414f56af179b0d8568"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d0d88f25f76b08b316c1bcfde8ea81c91b08d93", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3d0d88f25f76b08b316c1bcfde8ea81c91b08d93", "committedDate": "2020-08-07T22:19:26Z", "message": "Fix indentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "132b702b6d53d809315579e85ecdbd0d5cb8b8c1", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/132b702b6d53d809315579e85ecdbd0d5cb8b8c1", "committedDate": "2020-08-11T08:41:20Z", "message": "Set disposition state to abandon before settling a delivery"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MzI2NTY4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13873#pullrequestreview-465326568", "createdAt": "2020-08-11T18:34:18Z", "commit": {"oid": "132b702b6d53d809315579e85ecdbd0d5cb8b8c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ca908229cbee92b13235d5b7878452886bafd86", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8ca908229cbee92b13235d5b7878452886bafd86", "committedDate": "2020-08-11T18:47:01Z", "message": "Merge branch 'master' into amqp-settle-message"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 864, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}