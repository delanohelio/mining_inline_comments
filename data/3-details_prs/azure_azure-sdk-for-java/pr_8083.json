{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMjk5Mzcw", "number": 8083, "title": "added retry analyzer for failing tests", "bodyText": "retrying methods in CosmosKeyCredentialTest as they perform many master resource operation and they fail often due to 429\nonly run CosmosKeyCredentialTest in session mode, it is overkill to run in other modes, which increases the chance of 429.\nadded support for special handling for 429 to RetryAnalyzer", "createdAt": "2020-02-10T19:01:30Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8083", "merged": true, "mergeCommit": {"oid": "0f576e97149104292b9639860341ab1068c1a152"}, "closed": true, "closedAt": "2020-02-10T19:54:08Z", "author": {"login": "moderakh"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDB3KqgH2gAyMzczMjk5MzcwOmNiYjljNTU5OWMwOGM2M2M4OWVmZGQ1YTJhY2NmZTQyNWY3NTdhNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDCQdzgFqTM1NjIwMDI3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cbb9c5599c08c63c89efdd5a2accfe425f757a51", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/cbb9c5599c08c63c89efdd5a2accfe425f757a51", "committedDate": "2020-02-10T18:58:01Z", "message": "added retry analyzer for failing tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTg3MjQw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8083#pullrequestreview-356187240", "createdAt": "2020-02-10T19:05:30Z", "commit": {"oid": "cbb9c5599c08c63c89efdd5a2accfe425f757a51"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOTowNTozMVrOFnx--w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOTowNTozMVrOFnx--w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI1NzcyMw==", "bodyText": "Recursion should be avoided as much as we can because of obvious reasons.\nI believe this can easily be converted to a while loop.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8083#discussion_r377257723", "createdAt": "2020-02-10T19:05:31Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/RetryAnalyzer.java", "diffHunk": "@@ -22,11 +24,41 @@ public RetryAnalyzer() {\n     @Override\n     public boolean retryMethod(ITestResult result) {\n         try {\n-            TimeUnit.SECONDS.sleep(waitBetweenRetriesInSeconds);\n+\n+            int timeToWaitBeforeRetryInSeconds = getTimeToWaitInSeconds(result);\n+            TimeUnit.SECONDS.sleep(timeToWaitBeforeRetryInSeconds);\n         } catch (InterruptedException e) {\n             return false;\n         }\n \n         return true;\n     }\n+\n+    private int getTimeToWaitInSeconds(ITestResult result) {\n+        Throwable throwable = result.getThrowable();\n+        CosmosClientException cosmosClientException = extractCosmosClientExceptionIfAny(throwable);\n+\n+        if (cosmosClientException == null) {\n+            return  waitBetweenRetriesInSeconds;\n+        }\n+\n+        long retryAfterInMilliseconds = cosmosClientException.getRetryAfterInMilliseconds();\n+        if (retryAfterInMilliseconds <= 0) {\n+            return waitBetweenRetriesInSeconds;\n+        }\n+\n+        return Math.max(Math.toIntExact(Duration.ofMillis(retryAfterInMilliseconds).getSeconds()), waitBetweenRetriesInSeconds);\n+    }\n+\n+    private CosmosClientException extractCosmosClientExceptionIfAny(Throwable t) {\n+        if (t == null) {\n+            return null;\n+        }\n+\n+        if (t instanceof CosmosClientException) {\n+            return (CosmosClientException) t;\n+        }\n+\n+        return extractCosmosClientExceptionIfAny(t.getCause());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbb9c5599c08c63c89efdd5a2accfe425f757a51"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78a037742a3b82573150ba676bcd824440ffb43c", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/78a037742a3b82573150ba676bcd824440ffb43c", "committedDate": "2020-02-10T19:21:40Z", "message": "minor change in retryanalyzer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MjAwMjc2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8083#pullrequestreview-356200276", "createdAt": "2020-02-10T19:25:39Z", "commit": {"oid": "78a037742a3b82573150ba676bcd824440ffb43c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2400, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}