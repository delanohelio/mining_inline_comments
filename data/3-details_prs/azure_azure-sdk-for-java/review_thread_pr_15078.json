{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0NjI0MDY0", "number": 15078, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNjozNDozNVrOEi-w9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1NDowMVrOEmar3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MTE1MzgzOnYy", "diffSide": "RIGHT", "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/microsoft/azure/test/keyvault/KeyVaultIT.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNjozNDozNVrOHRFo1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwNjoyMTo1OFrOHRybRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4MDIxMg==", "bodyText": "Why make such changes here?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r487680212", "createdAt": "2020-09-14T06:34:35Z", "author": {"login": "saragluna"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/microsoft/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -164,7 +155,13 @@ public void keyVaultWithVirtualMachineMSI() throws Exception {\n             AZURE_KEYVAULT_URI,\n             \"app.jar\"));\n \n-        vm.runCommand(new RunCommandInput().withCommandId(\"RunShellScript\").withScript(commands));\n+        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d10b4b5236ac3f98d273b30ac4d030808ec1067f"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4MzcwMw==", "bodyText": "Because VirtualMachine.runCommands() cannot find the java environment when executing commands in the virtual machine.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r487683703", "createdAt": "2020-09-14T06:43:17Z", "author": {"login": "zhichengliu12581"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/microsoft/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -164,7 +155,13 @@ public void keyVaultWithVirtualMachineMSI() throws Exception {\n             AZURE_KEYVAULT_URI,\n             \"app.jar\"));\n \n-        vm.runCommand(new RunCommandInput().withCommandId(\"RunShellScript\").withScript(commands));\n+        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4MDIxMg=="}, "originalCommit": {"oid": "d10b4b5236ac3f98d273b30ac4d030808ec1067f"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY5NzI4NA==", "bodyText": "And moving the command will help with the Java environment?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r487697284", "createdAt": "2020-09-14T07:14:15Z", "author": {"login": "saragluna"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/microsoft/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -164,7 +155,13 @@ public void keyVaultWithVirtualMachineMSI() throws Exception {\n             AZURE_KEYVAULT_URI,\n             \"app.jar\"));\n \n-        vm.runCommand(new RunCommandInput().withCommandId(\"RunShellScript\").withScript(commands));\n+        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4MDIxMg=="}, "originalCommit": {"oid": "d10b4b5236ac3f98d273b30ac4d030808ec1067f"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcwNDQyOQ==", "bodyText": "No, I just changed the way of executing commands from VirtualMachine.runCommands() to SSHShell.runCommands(). Command still needs to be executed.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r487704429", "createdAt": "2020-09-14T07:28:15Z", "author": {"login": "zhichengliu12581"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/microsoft/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -164,7 +155,13 @@ public void keyVaultWithVirtualMachineMSI() throws Exception {\n             AZURE_KEYVAULT_URI,\n             \"app.jar\"));\n \n-        vm.runCommand(new RunCommandInput().withCommandId(\"RunShellScript\").withScript(commands));\n+        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4MDIxMg=="}, "originalCommit": {"oid": "d10b4b5236ac3f98d273b30ac4d030808ec1067f"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM1MzMwMA==", "bodyText": "Okay. Let's try fixing this Java environment issue then.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r488353300", "createdAt": "2020-09-15T02:59:35Z", "author": {"login": "saragluna"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/microsoft/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -164,7 +155,13 @@ public void keyVaultWithVirtualMachineMSI() throws Exception {\n             AZURE_KEYVAULT_URI,\n             \"app.jar\"));\n \n-        vm.runCommand(new RunCommandInput().withCommandId(\"RunShellScript\").withScript(commands));\n+        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4MDIxMg=="}, "originalCommit": {"oid": "d10b4b5236ac3f98d273b30ac4d030808ec1067f"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM1NDg2Mg==", "bodyText": "Sorry, after testing, if the virtual machine is created through test-resources.json, this problem does not occur, but if it is a virtual machine created by myself, there will be a problem of not being able to find the java environment. Maybe some configuration is missing in the virtual machine I created?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r488354862", "createdAt": "2020-09-15T03:05:45Z", "author": {"login": "zhichengliu12581"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/microsoft/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -164,7 +155,13 @@ public void keyVaultWithVirtualMachineMSI() throws Exception {\n             AZURE_KEYVAULT_URI,\n             \"app.jar\"));\n \n-        vm.runCommand(new RunCommandInput().withCommandId(\"RunShellScript\").withScript(commands));\n+        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4MDIxMg=="}, "originalCommit": {"oid": "d10b4b5236ac3f98d273b30ac4d030808ec1067f"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQxNDAyMw==", "bodyText": "test-resources.json have a step to install java.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r488414023", "createdAt": "2020-09-15T06:21:58Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/microsoft/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -164,7 +155,13 @@ public void keyVaultWithVirtualMachineMSI() throws Exception {\n             AZURE_KEYVAULT_URI,\n             \"app.jar\"));\n \n-        vm.runCommand(new RunCommandInput().withCommandId(\"RunShellScript\").withScript(commands));\n+        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4MDIxMg=="}, "originalCommit": {"oid": "d10b4b5236ac3f98d273b30ac4d030808ec1067f"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4Mjg2NDY5OnYy", "diffSide": "RIGHT", "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/azure/test/keyvault/KeyVaultIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOTo0MjoyN1rOHVyMkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOTo0MjoyN1rOHVyMkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYwNDU2MQ==", "bodyText": "Please install java maven in this file: https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/spring/azure-spring-boot-test-keyvault/install_java.sh", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r492604561", "createdAt": "2020-09-22T09:42:27Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -131,30 +127,25 @@ public void keyVaultWithAppServiceMSI() {\n     }\n \n     @Test\n-    @Ignore\n-    public void keyVaultWithVirtualMachineMSI() throws Exception {\n+    public void keyVaultWithVirtualMachineMSI() {\n         final VirtualMachine vm = AZURE.virtualMachines().getByResourceGroup(SPRING_RESOURCE_GROUP, VM_NAME);\n \n         final String host = vm.getPrimaryPublicIPAddress().ipAddress();\n \n-        // Upload app.jar to virtual machine\n-        final MavenBasedProject app = new MavenBasedProject(\"../azure-spring-boot-test-application\");\n-        app.packageUp();\n-\n-        final File file = new File(app.artifact());\n-\n-        if (!file.exists()) {\n-            throw new FileNotFoundException(\"There's no app.jar file found.\");\n-        }\n-        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);\n-            FileInputStream fis = new FileInputStream(file)) {\n-            LOGGER.info(\"Uploading jar file...\");\n-            sshShell.upload(fis, \"app.jar\", \"\", true, \"4095\");\n-        }\n-\n-        // run java application\n         final List<String> commands = new ArrayList<>();\n         commands.add(String.format(\"cd /home/%s\", VM_USER_USERNAME));\n+        commands.add(\"apt-get install maven -y\");\n+        commands.add(\"apt-get install git\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbab4bce9a0ffde43e7710bd4749cef9e77cd71f"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NzE2OTcwOnYy", "diffSide": "RIGHT", "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/azure/test/keyvault/KeyVaultIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1MDozOFrOHWa3_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1MDozOFrOHWa3_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3MTAzOQ==", "bodyText": "Can we use current branch instead of master branch?\nRefs: https://stackoverflow.com/questions/49106104/get-current-git-branch-inside-a-java-test", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r493271039", "createdAt": "2020-09-23T07:50:38Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -131,30 +127,23 @@ public void keyVaultWithAppServiceMSI() {\n     }\n \n     @Test\n-    @Ignore\n-    public void keyVaultWithVirtualMachineMSI() throws Exception {\n+    public void keyVaultWithVirtualMachineMSI() {\n         final VirtualMachine vm = AZURE.virtualMachines().getByResourceGroup(SPRING_RESOURCE_GROUP, VM_NAME);\n \n         final String host = vm.getPrimaryPublicIPAddress().ipAddress();\n \n-        // Upload app.jar to virtual machine\n-        final MavenBasedProject app = new MavenBasedProject(\"../azure-spring-boot-test-application\");\n-        app.packageUp();\n-\n-        final File file = new File(app.artifact());\n-\n-        if (!file.exists()) {\n-            throw new FileNotFoundException(\"There's no app.jar file found.\");\n-        }\n-        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);\n-            FileInputStream fis = new FileInputStream(file)) {\n-            LOGGER.info(\"Uploading jar file...\");\n-            sshShell.upload(fis, \"app.jar\", \"\", true, \"4095\");\n-        }\n-\n-        // run java application\n         final List<String> commands = new ArrayList<>();\n         commands.add(String.format(\"cd /home/%s\", VM_USER_USERNAME));\n+        commands.add(\"mkdir azure-sdk-for-java\");\n+        commands.add(\"cd azure-sdk-for-java\");\n+        commands.add(\"git init\");\n+        commands.add(\"git remote add origin https://github.com/Azure/azure-sdk-for-java.git\");\n+        commands.add(\"git config core.sparsecheckout true\");\n+        commands.add(\"echo sdk/spring > .git/info/sparse-checkout\");\n+        commands.add(\"git pull origin master\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6910cc8db9af1500d2df9919f08dc36b058c148"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NzE4NTU2OnYy", "diffSide": "RIGHT", "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/azure/test/keyvault/KeyVaultIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1NDowMVrOHWbCQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMzozMTo0NFrOHWubbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3MzY2NQ==", "bodyText": "We need update origin too.\nRefs: https://stackoverflow.com/questions/171550/find-out-which-remote-branch-a-local-branch-is-tracking", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r493273665", "createdAt": "2020-09-23T07:54:01Z", "author": {"login": "chenrujun"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -131,30 +127,23 @@ public void keyVaultWithAppServiceMSI() {\n     }\n \n     @Test\n-    @Ignore\n-    public void keyVaultWithVirtualMachineMSI() throws Exception {\n+    public void keyVaultWithVirtualMachineMSI() {\n         final VirtualMachine vm = AZURE.virtualMachines().getByResourceGroup(SPRING_RESOURCE_GROUP, VM_NAME);\n \n         final String host = vm.getPrimaryPublicIPAddress().ipAddress();\n \n-        // Upload app.jar to virtual machine\n-        final MavenBasedProject app = new MavenBasedProject(\"../azure-spring-boot-test-application\");\n-        app.packageUp();\n-\n-        final File file = new File(app.artifact());\n-\n-        if (!file.exists()) {\n-            throw new FileNotFoundException(\"There's no app.jar file found.\");\n-        }\n-        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);\n-            FileInputStream fis = new FileInputStream(file)) {\n-            LOGGER.info(\"Uploading jar file...\");\n-            sshShell.upload(fis, \"app.jar\", \"\", true, \"4095\");\n-        }\n-\n-        // run java application\n         final List<String> commands = new ArrayList<>();\n         commands.add(String.format(\"cd /home/%s\", VM_USER_USERNAME));\n+        commands.add(\"mkdir azure-sdk-for-java\");\n+        commands.add(\"cd azure-sdk-for-java\");\n+        commands.add(\"git init\");\n+        commands.add(\"git remote add origin https://github.com/Azure/azure-sdk-for-java.git\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6910cc8db9af1500d2df9919f08dc36b058c148"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzU5MTQwNw==", "bodyText": "So why do we choose to pull the project from GitHub instead of pushing it?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15078#discussion_r493591407", "createdAt": "2020-09-23T13:31:44Z", "author": {"login": "saragluna"}, "path": "sdk/spring/azure-spring-boot-test-keyvault/src/test/java/com/azure/test/keyvault/KeyVaultIT.java", "diffHunk": "@@ -131,30 +127,23 @@ public void keyVaultWithAppServiceMSI() {\n     }\n \n     @Test\n-    @Ignore\n-    public void keyVaultWithVirtualMachineMSI() throws Exception {\n+    public void keyVaultWithVirtualMachineMSI() {\n         final VirtualMachine vm = AZURE.virtualMachines().getByResourceGroup(SPRING_RESOURCE_GROUP, VM_NAME);\n \n         final String host = vm.getPrimaryPublicIPAddress().ipAddress();\n \n-        // Upload app.jar to virtual machine\n-        final MavenBasedProject app = new MavenBasedProject(\"../azure-spring-boot-test-application\");\n-        app.packageUp();\n-\n-        final File file = new File(app.artifact());\n-\n-        if (!file.exists()) {\n-            throw new FileNotFoundException(\"There's no app.jar file found.\");\n-        }\n-        try (SSHShell sshShell = SSHShell.open(host, 22, VM_USER_USERNAME, VM_USER_PASSWORD);\n-            FileInputStream fis = new FileInputStream(file)) {\n-            LOGGER.info(\"Uploading jar file...\");\n-            sshShell.upload(fis, \"app.jar\", \"\", true, \"4095\");\n-        }\n-\n-        // run java application\n         final List<String> commands = new ArrayList<>();\n         commands.add(String.format(\"cd /home/%s\", VM_USER_USERNAME));\n+        commands.add(\"mkdir azure-sdk-for-java\");\n+        commands.add(\"cd azure-sdk-for-java\");\n+        commands.add(\"git init\");\n+        commands.add(\"git remote add origin https://github.com/Azure/azure-sdk-for-java.git\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3MzY2NQ=="}, "originalCommit": {"oid": "b6910cc8db9af1500d2df9919f08dc36b058c148"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1199, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}