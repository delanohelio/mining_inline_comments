{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDQ2Njky", "number": 8825, "title": "EncryptedBlobClientBuilder enhancements", "bodyText": "Resolves #6558\nAdded CPK support\nFixed bug where decryption policy would not be added on the pipeline method", "createdAt": "2020-03-06T22:19:34Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825", "merged": true, "mergeCommit": {"oid": "5814744207f8f461abe0aebc454438d011d95f63"}, "closed": true, "closedAt": "2020-03-11T17:33:39Z", "author": {"login": "gapra-msft"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKbhLWAH2gAyMzg1MDQ2NjkyOmVkNjdiYzkzNmEwOWQwZWFhNDRmNWMyMWRlODZmY2IwMjJmNjhkYzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMpiOkAFqTM3MjkxNDIzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ed67bc936a09d0eaa44f5c21de86fcb022f68dc9", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ed67bc936a09d0eaa44f5c21de86fcb022f68dc9", "committedDate": "2020-03-04T18:49:00Z", "message": "Added initial CPK ground work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f56f1b4e75287d063b918ce6ceb50d0ae7afa926", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f56f1b4e75287d063b918ce6ceb50d0ae7afa926", "committedDate": "2020-03-06T22:12:47Z", "message": "added tests and removed ability to get cpk from a blob"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjYxNjk5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#pullrequestreview-370661699", "createdAt": "2020-03-06T22:20:04Z", "commit": {"oid": "f56f1b4e75287d063b918ce6ceb50d0ae7afa926"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMjoyMDowNVrOFzJLSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMjoyMDowNVrOFzJLSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE3MjA0MQ==", "bodyText": "remove this comment", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389172041", "createdAt": "2020-03-06T22:20:05Z", "author": {"login": "gapra-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobAsyncClient.java", "diffHunk": "@@ -93,13 +94,17 @@\n      * @param containerName The container name.\n      * @param blobName The blob name.\n      * @param snapshot The snapshot identifier for the blob, pass {@code null} to interact with the blob directly.\n+     * @param customerProvidedKey Customer provided key used during encryption of the blob's data on the server, pass\n+     * {@code null} to allow the service to use its own encryption.\n      * @param key The key used to encrypt and decrypt data.\n      * @param keyWrapAlgorithm The algorithm used to wrap/unwrap the key during encryption.\n      */\n     EncryptedBlobAsyncClient(HttpPipeline pipeline, String url, BlobServiceVersion serviceVersion, String accountName,\n-        String containerName, String blobName, String snapshot, AsyncKeyEncryptionKey key, String keyWrapAlgorithm) {\n-        super(pipeline, url, serviceVersion, accountName, containerName, blobName, snapshot, null /*cpk*/,\n-            null /*encryption scope*/);\n+        String containerName, String blobName, String snapshot, CpkInfo customerProvidedKey,\n+        AsyncKeyEncryptionKey key, String keyWrapAlgorithm) {\n+        super(pipeline, url, serviceVersion, accountName, containerName, blobName, snapshot, customerProvidedKey,\n+            null);\n+        // Note encryption scope is always null when passed in from the client builder.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f56f1b4e75287d063b918ce6ceb50d0ae7afa926"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1c429a76a42a682fff5e3132ca1e562fc7b36b8e", "committedDate": "2020-03-06T23:18:09Z", "message": "removed comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDY1NjE5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#pullrequestreview-371465619", "createdAt": "2020-03-09T19:26:09Z", "commit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOToyNjowOVrOFz2RBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOToyNjowOVrOFz2RBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMDc5MQ==", "bodyText": "If one is not present", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389910791", "createdAt": "2020-03-09T19:26:09Z", "author": {"login": "rickle-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -469,19 +472,37 @@ public EncryptedBlobClientBuilder retryOptions(RequestRetryOptions retryOptions)\n     }\n \n     /**\n-     * Sets the {@link HttpPipeline} to use for the service client.\n+     * Sets the {@link HttpPipeline} to use for the service client, and adds a decryption policy.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDY5MTY4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#pullrequestreview-371469168", "createdAt": "2020-03-09T19:31:53Z", "commit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTozMTo1M1rOFz2cog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTozMTo1M1rOFz2cog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMzc2Mg==", "bodyText": "cpk isn't ignored, right? Maybe for a bit of future-proofing, we should specify that any options used to configure a pipeline are ignored?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389913762", "createdAt": "2020-03-09T19:31:53Z", "author": {"login": "rickle-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -469,19 +472,37 @@ public EncryptedBlobClientBuilder retryOptions(RequestRetryOptions retryOptions)\n     }\n \n     /**\n-     * Sets the {@link HttpPipeline} to use for the service client.\n+     * Sets the {@link HttpPipeline} to use for the service client, and adds a decryption policy.\n      *\n      * If {@code pipeline} is set, all other settings are ignored, aside from {@link #endpoint(String) endpoint}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDY5NTc0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#pullrequestreview-371469574", "createdAt": "2020-03-09T19:32:32Z", "commit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTozMjozM1rOFz2dyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTozMjozM1rOFz2dyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxNDA1OQ==", "bodyText": "Can we check to ensure one isn't already present? I suppose it wouldn't matter because we remove the encryption metadata, so it wouldn't double decrypt, but it's probably safer if we check.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389914059", "createdAt": "2020-03-09T19:32:33Z", "author": {"login": "rickle-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -469,19 +472,37 @@ public EncryptedBlobClientBuilder retryOptions(RequestRetryOptions retryOptions)\n     }\n \n     /**\n-     * Sets the {@link HttpPipeline} to use for the service client.\n+     * Sets the {@link HttpPipeline} to use for the service client, and adds a decryption policy.\n      *\n      * If {@code pipeline} is set, all other settings are ignored, aside from {@link #endpoint(String) endpoint}.\n      *\n+     * <p>Use this method after setting the key in {@link #key(AsyncKeyEncryptionKey, String) key} and keyResolver in\n+     * {@link #keyResolver(AsyncKeyEncryptionKeyResolver)}.</p>\n+     *\n      * @param httpPipeline HttpPipeline to use for sending service requests and receiving responses.\n      * @return the updated EncryptedBlobClientBuilder object\n      */\n     public EncryptedBlobClientBuilder pipeline(HttpPipeline httpPipeline) {\n         if (this.httpPipeline != null && httpPipeline == null) {\n             logger.info(\"HttpPipeline is being set to 'null' when it was previously configured.\");\n         }\n+        checkValidEncryptionParameters();\n+\n+        HttpPipeline pipeline = null;\n+        if (httpPipeline != null) {\n+            List<HttpPipelinePolicy> policies = new ArrayList<>();\n+            policies.add(new BlobDecryptionPolicy(keyWrapper, keyResolver));\n+            for (int i = 0; i < httpPipeline.getPolicyCount(); i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDc2MDYw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#pullrequestreview-371476060", "createdAt": "2020-03-09T19:43:04Z", "commit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTo0MzowNFrOFz2ysA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTo0MzowNFrOFz2ysA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxOTQwOA==", "bodyText": "Can you add \"for security reasons\" to hopefully preempt some customers who may ask for this?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#discussion_r389919408", "createdAt": "2020-03-09T19:43:04Z", "author": {"login": "rickle-msft"}, "path": "sdk/storage/azure-storage-blob-cryptography/src/main/java/com/azure/storage/blob/specialized/cryptography/EncryptedBlobClientBuilder.java", "diffHunk": "@@ -512,6 +552,9 @@ public EncryptedBlobClientBuilder serviceVersion(BlobServiceVersion version) {\n      * <p>If {@code pipeline} is set, all other settings are ignored, aside from {@link #endpoint(String) endpoint} and\n      * {@link #serviceVersion(BlobServiceVersion) serviceVersion}.</p>\n      *\n+     * <p>Note that this method does not copy over the {@link CustomerProvidedKey} and encryption scope properties", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c429a76a42a682fff5e3132ca1e562fc7b36b8e"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41d2b2c3097e472bc9118fb4f64bea4752e75ed7", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/41d2b2c3097e472bc9118fb4f64bea4752e75ed7", "committedDate": "2020-03-09T21:18:08Z", "message": "addressed PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzg5MzAw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#pullrequestreview-372389300", "createdAt": "2020-03-10T23:30:47Z", "commit": {"oid": "41d2b2c3097e472bc9118fb4f64bea4752e75ed7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzk5Mzky", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#pullrequestreview-372399392", "createdAt": "2020-03-11T00:02:12Z", "commit": {"oid": "41d2b2c3097e472bc9118fb4f64bea4752e75ed7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyOTE0MjM4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8825#pullrequestreview-372914238", "createdAt": "2020-03-11T16:16:40Z", "commit": {"oid": "41d2b2c3097e472bc9118fb4f64bea4752e75ed7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 930, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}