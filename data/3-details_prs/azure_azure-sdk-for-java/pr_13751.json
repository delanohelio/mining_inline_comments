{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMjc5NjMx", "number": 13751, "title": "Renew currently owned partitions stored in checkpointstore", "bodyText": "This PR updates the renew ownership logic to renew only partitions that are currently owned by the processor instance as stored in the checkpointstore instead of using the partitions stored in the partition processor map. This will resolve the issue of partitions switching between instances due to delays caused by service closing the link to a partition that was stolen by another instance.\nFixes #13597", "createdAt": "2020-08-03T16:34:40Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13751", "merged": true, "mergeCommit": {"oid": "665a605dd33f63d7914ac052a31cb79bdce6f02e"}, "closed": true, "closedAt": "2020-08-04T23:05:22Z", "author": {"login": "srnagar"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7MQfMgH2gAyNDYyMjc5NjMxOmY3MmU5Yzg4Y2ZhOTI0ZjNhN2I3ZTcyNWJiNmJkYTEyMDYyNjU4NDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7tmgWAH2gAyNDYyMjc5NjMxOmFmNDc1NThmMTk5OTk2ZTM0OGM0NTQ1MTkxNzRjZDU3ZGUzODdmN2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f72e9c88cfa924f3a7b7e725bb6bda1206265843", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f72e9c88cfa924f3a7b7e725bb6bda1206265843", "committedDate": "2020-08-03T06:44:29Z", "message": "Renew currently owned partitions stored in checkpointstore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMTgzMjY3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13751#pullrequestreview-460183267", "createdAt": "2020-08-03T16:50:38Z", "commit": {"oid": "f72e9c88cfa924f3a7b7e725bb6bda1206265843"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNjo1MDozOFrOG7BAvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNjo1MDo1N1rOG7BBZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUzNTc0Mw==", "bodyText": "Do we need to collect this into a list if we're doing anything on the output?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13751#discussion_r464535743", "createdAt": "2020-08-03T16:50:38Z", "author": {"login": "conniey"}, "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionBasedLoadBalancer.java", "diffHunk": "@@ -278,6 +258,24 @@ void loadBalance() {\n         });\n     }\n \n+    private void renewOwnership(Map<String, PartitionOwnership> partitionOwnershipMap) {\n+        // renew ownership of already owned partitions\n+        checkpointStore.claimOwnership(partitionPumpManager.getPartitionPumps().keySet()\n+            .stream()\n+            .filter(\n+                partitionId -> partitionOwnershipMap.containsKey(partitionId) && partitionOwnershipMap.get(partitionId)\n+                    .equals(this.ownerId))\n+            .map(partitionId -> createPartitionOwnershipRequest(partitionOwnershipMap, partitionId))\n+            .collect(Collectors.toList()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f72e9c88cfa924f3a7b7e725bb6bda1206265843"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUzNTkwOA==", "bodyText": "Is it possible to have a test for this? \ud83e\udd14", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13751#discussion_r464535908", "createdAt": "2020-08-03T16:50:57Z", "author": {"login": "conniey"}, "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionBasedLoadBalancer.java", "diffHunk": "@@ -218,35 +218,15 @@ void loadBalance() {\n                 // If the partitions are evenly distributed among all active event processors, no change required.\n                 logger.info(\"Load is balanced with this event processor owning {} partitions\",\n                     ownerPartitionMap.get(ownerId).size());\n-                // renew ownership of already owned partitions\n-                checkpointStore.claimOwnership(partitionPumpManager.getPartitionPumps().keySet()\n-                    .stream()\n-                    .map(partitionId -> createPartitionOwnershipRequest(partitionOwnershipMap, partitionId))\n-                    .collect(Collectors.toList()))\n-                    .subscribe(ignored -> { },\n-                        ex -> {\n-                            logger.error(\"Error renewing partition ownership\", ex);\n-                            isLoadBalancerRunning.set(false);\n-                        },\n-                        () -> isLoadBalancerRunning.set(false));\n+                renewOwnership(partitionOwnershipMap);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f72e9c88cfa924f3a7b7e725bb6bda1206265843"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ba9649e6b19fde08dfde7e5625232b9e5a607b2", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7ba9649e6b19fde08dfde7e5625232b9e5a607b2", "committedDate": "2020-08-04T20:17:31Z", "message": "Add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eaed5e2dda204d3e4e2c36bc406f431c76050f1", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3eaed5e2dda204d3e4e2c36bc406f431c76050f1", "committedDate": "2020-08-04T20:19:13Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1133253acc44ca3738f80013051a3555a6b5da2c", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1133253acc44ca3738f80013051a3555a6b5da2c", "committedDate": "2020-08-04T21:34:20Z", "message": "Fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af47558f199996e348c454519174cd57de387f7f", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/af47558f199996e348c454519174cd57de387f7f", "committedDate": "2020-08-04T21:35:24Z", "message": "Fix unit test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 943, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}