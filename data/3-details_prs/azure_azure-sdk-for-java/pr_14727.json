{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3NjIwNjQw", "number": 14727, "title": "Fixed netty leak on DELETE operations in GATEWAY mode", "bodyText": "Fixed memory leak in DELETE operations because of body not being subscribed.\nAddress issue: #13763\nAddress issues: #14432\n\nHere are findings on how the leak was detected and fixed - using netty debug level logs.\nBEFORE FIX: Subscribe operation is not happening on DELETE calls in Gateway mode.\n[2020-09-01T23:35:57.052Z] [DEBUG] [id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] Handler is being applied: {uri=https://netty-leak-detection-test-eastus2.documents.azure.com/dbs/AzureSampleFamilyDB/colls/FamilyContainer1/docs/bad2, method=DELETE}\n\n[2020-09-01T23:35:57.053Z] [DEBUG] [id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] onStateChange(DELETE{uri=/dbs/AzureSampleFamilyDB/colls/FamilyContainer1/docs/bad2, connection=PooledConnection{channel=[id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443]}}, [request_prepared])\n\n[2020-09-01T23:35:57.054Z] [DEBUG] [id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] onStateChange(DELETE{uri=/dbs/AzureSampleFamilyDB/colls/FamilyContainer1/docs/bad2, connection=PooledConnection{channel=[id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443]}}, [request_sent])\n\n[2020-09-01T23:35:57.148Z] [DEBUG] [id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] Received response (auto-read:false) : [Transfer-Encoding=chunked, Content-Type=application/json, Content-Location=https://netty-leak-detection-test-eastus2.documents.azure.com/dbs/AzureSampleFamilyDB/colls/FamilyContainer1/docs/bad2, Server=Microsoft-HTTPAPI/2.0, x-ms-last-state-change-utc=Sat, 29 Aug 2020 10:07:19.454 GMT, lsn=433, x-ms-schemaversion=1.9, x-ms-quorum-acked-lsn=433, x-ms-current-write-quorum=3, x-ms-current-replica-set-size=4, x-ms-xp-role=1, x-ms-global-Committed-lsn=433, x-ms-number-of-read-regions=0, x-ms-transport-request-id=82, x-ms-cosmos-llsn=433, x-ms-cosmos-quorum-acked-llsn=433, x-ms-session-token=0:-1#433, x-ms-request-charge=1.24, x-ms-serviceversion=version=2.11.0.0, x-ms-activity-id=4eebc3f3-554b-44d3-bf71-2985679e9a6a, Strict-Transport-Security=max-age=31536000, x-ms-gatewayversion=version=2.11.0, Date=Tue, 01 Sep 2020 23:35:56 GMT]\n\n[2020-09-01T23:35:57.149Z] [DEBUG] [id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] onStateChange(DELETE{uri=/dbs/AzureSampleFamilyDB/colls/FamilyContainer1/docs/bad2, connection=PooledConnection{channel=[id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443]}}, [response_received])\n\n[2020-09-01T23:35:57.154Z] [DEBUG] [id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] Received last HTTP packet\n\n[2020-09-01T23:35:57.154Z] [DEBUG] [id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] onStateChange(DELETE{uri=/dbs/AzureSampleFamilyDB/colls/FamilyContainer1/docs/bad2, connection=PooledConnection{channel=[id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443]}}, [response_completed])\n\n[2020-09-01T23:35:57.154Z] [DEBUG] [id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] onStateChange(DELETE{uri=/dbs/AzureSampleFamilyDB/colls/FamilyContainer1/docs/bad2, connection=PooledConnection{channel=[id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443]}}, [disconnecting])\n\n[2020-09-01T23:35:57.155Z] [DEBUG] [id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] Releasing channel\n\n[2020-09-01T23:35:57.155Z] [DEBUG] [id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] Channel cleaned, now 3 active connections and 1 inactive connections\n\n[2020-09-01T23:35:57.279Z] [ERROR] LEAK: ByteBuf.release() was not called before it's garbage-collected. See https://netty.io/wiki/reference-counted-objects.html for more information.\nRecent access records: \n#1:\n\tHint: [id: 0x4b1bdf4b, L:/172.17.0.2:33890 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] Buffered ByteBufHolder in Inbound Flux Queue\n\tio.netty.handler.codec.http.DefaultHttpContent.touch(DefaultHttpContent.java:86)\n\tio.netty.handler.codec.http.DefaultHttpContent.touch(DefaultHttpContent.java:25)\n\treactor.netty.channel.FluxReceive.onInboundNext(FluxReceive.java:357)\n\treactor.netty.channel.ChannelOperations.onInboundNext(ChannelOperations.java:358)\n\treactor.netty.http.client.HttpClientOperations.onInboundNext(HttpClientOperations.java:677)\n\treactor.netty.channel.ChannelOperationsHandler.channelRead(ChannelOperationsHandler.java:96)\n\tio.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\n\tio.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\n\tio.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\n\tio.netty.channel.CombinedChannelDuplexHandler$DelegatingChannelHandlerContext.fireChannelRead(CombinedChannelDuplexHandler.java:436)\n\tio.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:324)\n\tio.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:296)\n\tio.netty.channel.CombinedChannelDuplexHandler.channelRead(CombinedChannelDuplexHandler.java:251)\n\tio.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\n\tio.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\n\tio.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\n\tio.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1526)\n\tio.netty.handler.ssl.SslHandler.decodeJdkCompatible(SslHandler.java:1275)\n\tio.netty.handler.ssl.SslHandler.decode(SslHandler.java:1322)\n\tio.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:501)\n\tio.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:440)\n\tio.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:276)\n\tio.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\n\tio.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\n\tio.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)\n\tio.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)\n\tio.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)\n\tio.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)\n\tio.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)\n\tio.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:792)\n\tio.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:475)\n\tio.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:378)\n\tio.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989)\n\tio.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n\tio.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n\tjava.base/java.lang.Thread.run(Thread.java:834)\n\nAFTER FIX: Subscribe operation is happening on DELETE operations in Gateway mode.\n[2020-09-02T00:20:19.808Z] [DEBUG] [id: 0xb4d8e549, L:/172.17.0.2:34022 - R:netty-leak-detection-test-eastus2.documents.azure.com/104.208.231.16:443] Subscribing inbound receiver [pending: 0, cancelled:false, inboundDone: false]", "createdAt": "2020-09-02T07:07:09Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14727", "merged": true, "mergeCommit": {"oid": "37c78d715851cd2af1cb2c6cdbc7a7864d4218d2"}, "closed": true, "closedAt": "2020-09-02T19:29:45Z", "author": {"login": "kushagraThapar"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEw2DcgH2gAyNDc3NjIwNjQwOmRjMzYwYTUxMDc1MTliNDEwNTlmN2NiNjlhM2ZmODIyYjJiODk5ZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE_n9iAFqTQ4MTA2NTU0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dc360a5107519b41059f7cb69a3ff822b2b899fc", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/dc360a5107519b41059f7cb69a3ff822b2b899fc", "committedDate": "2020-09-02T00:27:25Z", "message": "Fixed netty leak on DELETE operations in GATEWAY mode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTQxNjI0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14727#pullrequestreview-480541624", "createdAt": "2020-09-02T07:11:48Z", "commit": {"oid": "dc360a5107519b41059f7cb69a3ff822b2b899fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwODEyODcy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14727#pullrequestreview-480812872", "createdAt": "2020-09-02T13:22:12Z", "commit": {"oid": "dc360a5107519b41059f7cb69a3ff822b2b899fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMDY1NTQ0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14727#pullrequestreview-481065544", "createdAt": "2020-09-02T17:40:36Z", "commit": {"oid": "dc360a5107519b41059f7cb69a3ff822b2b899fc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzo0MDozNlrOHL6Qew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzo0MDozNlrOHL6Qew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1MDg3NQ==", "bodyText": "what this change for ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14727#discussion_r482250875", "createdAt": "2020-09-02T17:40:36Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/http/ReactorNettyClient.java", "diffHunk": "@@ -197,11 +197,7 @@ public HttpHeaders headers() {\n         @Override\n         public Flux<ByteBuf> body() {\n             return bodyIntern()\n-                .doOnSubscribe(this::updateSubscriptionState)\n-                .map(byteBuf -> {\n-                    byteBuf.retain();\n-                    return byteBuf;\n-                });\n+                .doOnSubscribe(this::updateSubscriptionState);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc360a5107519b41059f7cb69a3ff822b2b899fc"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 79, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}