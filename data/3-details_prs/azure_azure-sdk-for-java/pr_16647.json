{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3OTE2Mzc2", "number": 16647, "title": "ConnectionStateListener-improvement1", "bodyText": "Relates to #16245\nRemove connectionStateListener cache update from request path to gateway address refresh path.", "createdAt": "2020-10-21T23:19:24Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647", "merged": true, "mergeCommit": {"oid": "9496334337f48b1ecaeb6ee60c766962153f7e7c"}, "closed": true, "closedAt": "2020-10-30T19:59:22Z", "author": {"login": "xinlian12"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP6JRLgH2gAyNTA3OTE2Mzc2Ojg1MGU3MThhMDk5NjdhMDJlNzM5MDY4OGJjY2EwODg4NWM3YTk2YzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXb2JCAH2gAyNTA3OTE2Mzc2OmE0ODNjZmI5NjAxMGQ5ZmYyYTcwN2I4OWM3NTg3NDhjNWVhNGM1MjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "850e718a09967a02e7390688bcca08885c7a96c3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/850e718a09967a02e7390688bcca08885c7a96c3", "committedDate": "2020-10-06T15:30:43Z", "message": "ConnectionStateListener change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49b62d6ef3d36ed3b3e0a56d5366ef3ac7fe0a4a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/49b62d6ef3d36ed3b3e0a56d5366ef3ac7fe0a4a", "committedDate": "2020-10-06T17:31:45Z", "message": "clean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c38d31c4ec7c5251cfabb9fb5f281c58b99baad8", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c38d31c4ec7c5251cfabb9fb5f281c58b99baad8", "committedDate": "2020-10-06T18:27:18Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "committedDate": "2020-10-06T19:02:13Z", "message": "resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a8bcccacfb0528d426ae1adc3c2557ee622c78b", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1a8bcccacfb0528d426ae1adc3c2557ee622c78b", "committedDate": "2020-10-09T19:46:59Z", "message": "Merge branch 'master' into ConnectionStateListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcc29d6d0d74e9c8ce4dcb974b4f83d5d26f6a62", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/fcc29d6d0d74e9c8ce4dcb974b4f83d5d26f6a62", "committedDate": "2020-10-12T16:47:50Z", "message": "revert back change not related to ConnectionStateListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "718c7546afea371b44028b242af8e9906d4a76f8", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/718c7546afea371b44028b242af8e9906d4a76f8", "committedDate": "2020-10-12T16:48:38Z", "message": "Merge branch 'master' into ConnectionStateListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df9af7f18e93688c3f8263a5838fe183c0381b93", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/df9af7f18e93688c3f8263a5838fe183c0381b93", "committedDate": "2020-10-12T18:17:50Z", "message": "resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d964363e5d221330f8c5d9fc1466739a8d9a0705", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d964363e5d221330f8c5d9fc1466739a8d9a0705", "committedDate": "2020-10-12T18:34:51Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb34f16b0ca1829caacb8dbef9c87d1bda9f76bf", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bb34f16b0ca1829caacb8dbef9c87d1bda9f76bf", "committedDate": "2020-10-12T19:46:09Z", "message": "changeConnectionStateListener default to false and resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2148f92be5ab600cf8769602495e0440cba72e9a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2148f92be5ab600cf8769602495e0440cba72e9a", "committedDate": "2020-10-12T19:59:10Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd12a8bc987de2ecbdfef20ff62c2327eb65844d", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bd12a8bc987de2ecbdfef20ff62c2327eb65844d", "committedDate": "2020-10-13T19:20:21Z", "message": "Merge branch 'master' into ConnectionStateListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "475a085771f2cecb4f019d7f79d68cdbad0e5ca8", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/475a085771f2cecb4f019d7f79d68cdbad0e5ca8", "committedDate": "2020-10-18T16:33:51Z", "message": "Merge branch 'master' into ConnectionStateListener-improvement1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da0ddb320f24345f095cc694d9586df587227dfb", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/da0ddb320f24345f095cc694d9586df587227dfb", "committedDate": "2020-10-20T00:35:51Z", "message": "ConnectionStateListner improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e1ebc881da569f35de8d488c99e09dd778c01fe", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3e1ebc881da569f35de8d488c99e09dd778c01fe", "committedDate": "2020-10-20T06:29:14Z", "message": "add logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e33cf2bbcb7b3929e80a5ddd373f7fa32ec9860", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6e33cf2bbcb7b3929e80a5ddd373f7fa32ec9860", "committedDate": "2020-10-20T06:29:16Z", "message": "Merge branch 'master' into ConnectionStateListener-improvement1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecccb2ab1ea7df522bbcfaf203d0a2386e4e5a33", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ecccb2ab1ea7df522bbcfaf203d0a2386e4e5a33", "committedDate": "2020-10-21T18:22:19Z", "message": "add test for gatewayaddressCache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ee6eaa81e81202d3dc1d4d56a8467b00edf9f4a", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2ee6eaa81e81202d3dc1d4d56a8467b00edf9f4a", "committedDate": "2020-10-21T19:35:37Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80dd34ba6195ad47d08f186c4a3738930b973a01", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/80dd34ba6195ad47d08f186c4a3738930b973a01", "committedDate": "2020-10-21T19:35:41Z", "message": "Merge branch 'master' into ConnectionStateListener-improvement1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac227199da98078159cc0d93917505048125f2ee", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ac227199da98078159cc0d93917505048125f2ee", "committedDate": "2020-10-21T23:01:07Z", "message": "merge and resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f808bf6750d2b5d5983a79ad03c7b66d6c589f3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1f808bf6750d2b5d5983a79ad03c7b66d6c589f3", "committedDate": "2020-10-21T23:11:42Z", "message": "clean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/97158ea5e74b5b117da484d8bbbff1c4096f1a72", "committedDate": "2020-10-21T23:17:22Z", "message": "clean"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MzYwOTQ4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#pullrequestreview-514360948", "createdAt": "2020-10-22T05:03:05Z", "commit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNTowMzowNVrOHmQr8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNToxMzo0MFrOHmQ2lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4MTMyOQ==", "bodyText": "is getServerKey() invoked for every request?\nIs it possible to pre-compute the value and cache the URI? I think new URI uses toString and string parsing underneath which is CPU intensive.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r509881329", "createdAt": "2020-10-22T05:03:05Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/AddressInformation.java", "diffHunk": "@@ -53,6 +57,25 @@ public String getProtocolScheme() {\n         return this.protocol.scheme();\n     }\n \n+    public URI getServerKey() {\n+        URI uri = this.physicalUri.getURI();\n+\n+        try {\n+            return new URI(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4MjI5MA==", "bodyText": "code style: \"{\" on the same line as if", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r509882290", "createdAt": "2020-10-22T05:06:57Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "diffHunk": "@@ -622,14 +644,40 @@ public void dispose() {\n     }\n \n     private Pair<PartitionKeyRangeIdentity, AddressInformation[]> toPartitionAddressAndRange(String collectionRid, List<Address> addresses) {\n-        logger.debug(\"toPartitionAddressAndRange\");\n+        if (logger.isDebugEnabled()) {\n+            logger.debug(\"toPartitionAddressAndRange\");\n+        }\n+\n         Address address = addresses.get(0);\n+        PartitionKeyRangeIdentity partitionKeyRangeIdentity = new PartitionKeyRangeIdentity(collectionRid, address.getParitionKeyRangeId());\n \n         AddressInformation[] addressInfos =\n                 addresses.stream().map(addr ->\n                                 GatewayAddressCache.toAddressInformation(addr)\n                                       ).collect(Collectors.toList()).toArray(new AddressInformation[addresses.size()]);\n-        return Pair.of(new PartitionKeyRangeIdentity(collectionRid, address.getParitionKeyRangeId()), addressInfos);\n+\n+        if (this.tcpConnectionEndpointRediscoveryEnabled)\n+        {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4MzU5Ng==", "bodyText": "don't we need a check inside the method if the feature flag is enabled here?\nor if the feature flag is disable this method never is invoked?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r509883596", "createdAt": "2020-10-22T05:11:56Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GlobalAddressResolver.java", "diffHunk": "@@ -101,23 +102,19 @@ public GlobalAddressResolver(\n     }\n \n     @Override\n-    public void remove(\n-        final RxDocumentServiceRequest request,\n-        final Set<PartitionKeyRangeIdentity> partitionKeyRangeIdentitySet) {\n+    public void updateAddresses(final RxDocumentServiceRequest request, final URI serverKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg4NDA1Mg==", "bodyText": "in my understanding in .Net version we are doing the cache update in the global cache (all regions).\nBut here we are doing it per region (per GatewayAddressCache).\nam I right?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r509884052", "createdAt": "2020-10-22T05:13:40Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "diffHunk": "@@ -84,14 +85,18 @@\n     private volatile Pair<PartitionKeyRangeIdentity, AddressInformation[]> masterPartitionAddressCache;\n     private volatile Instant suboptimalMasterPartitionTimestamp;\n \n+    private final ConcurrentHashMap<URI, Set<PartitionKeyRangeIdentity>> serverPartitionAddressToPkRangeIdMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97158ea5e74b5b117da484d8bbbff1c4096f1a72"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0597c3e1d40ca6b241686c4fba75b838038390c1", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0597c3e1d40ca6b241686c4fba75b838038390c1", "committedDate": "2020-10-22T15:45:27Z", "message": "resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81f5d46ea318dfcb61344d6312ad8d2fdf8a20b6", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/81f5d46ea318dfcb61344d6312ad8d2fdf8a20b6", "committedDate": "2020-10-27T14:47:28Z", "message": "Merge branch 'master' into ConnectionStateListener-improvement1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaae86c23009fe57402c0996f8e15a9bb1cdbabe", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/eaae86c23009fe57402c0996f8e15a9bb1cdbabe", "committedDate": "2020-10-27T14:49:01Z", "message": "option.builder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MjU5NzAy", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#pullrequestreview-518259702", "createdAt": "2020-10-28T01:19:00Z", "commit": {"oid": "eaae86c23009fe57402c0996f8e15a9bb1cdbabe"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMToxOTowMFrOHpWkPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMToxOTowMFrOHpWkPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEyMzM5MA==", "bodyText": "the format of the ServerKey URI returned from here needs to exactly match with format of ServerKey URI constructed by RNTBD. as discussed offline please consider making a class for this.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/16647#discussion_r513123390", "createdAt": "2020-10-28T01:19:00Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/AddressInformation.java", "diffHunk": "@@ -53,6 +57,25 @@ public String getProtocolScheme() {\n         return this.protocol.scheme();\n     }\n \n+    public URI getServerKey() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaae86c23009fe57402c0996f8e15a9bb1cdbabe"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30eaba0fb54e03fe94553c77b55eadf3233c72d4", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/30eaba0fb54e03fe94553c77b55eadf3233c72d4", "committedDate": "2020-10-28T18:09:51Z", "message": "add getServerKey static method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a483cfb96010d9ff2a707b89c758748c5ea4c522", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a483cfb96010d9ff2a707b89c758748c5ea4c522", "committedDate": "2020-10-30T00:44:04Z", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into ConnectionStateListener-improvement1"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1895, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}