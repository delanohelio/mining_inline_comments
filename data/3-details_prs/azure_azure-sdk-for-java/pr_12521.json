{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMzE1OTA5", "number": 12521, "title": "Fix for null pointer exception with order by by array/object type", "bodyText": "Fix issue: #12520\nContinuation token will not be supported for array/object type.", "createdAt": "2020-06-26T00:07:38Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521", "merged": true, "mergeCommit": {"oid": "2862f26abade536bafba31fcadda488852c8b3f0"}, "closed": true, "closedAt": "2020-07-02T08:11:06Z", "author": {"login": "xinlian12"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcu1HamAH2gAyNDQwMzE1OTA5OjM1ZmQ2M2ZiNzBjODk5YjgyODhkYmU2N2UxMzE3NjZiMmZiODM2MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwkGnFgH2gAyNDQwMzE1OTA5OmY4NzllM2QyNmYyZTg5NjJhNDZiYzQ4NWQ3NWVhNWJmODk2N2NkYTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "35fd63fb70c899b8288dbe67e131766b2fb83601", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/35fd63fb70c899b8288dbe67e131766b2fb83601", "committedDate": "2020-06-25T20:59:40Z", "message": "index on FixForOrderByQuery: e599af164d9 Reliable download range error (#12342)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2eecdb301a91dadb2cdd65b14e64a01774d06b4", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d2eecdb301a91dadb2cdd65b14e64a01774d06b4", "committedDate": "2020-06-25T20:59:40Z", "message": "On FixForOrderByQuery: lalalal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f404124112b5c9667f2dc99584400172618a5bf", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6f404124112b5c9667f2dc99584400172618a5bf", "committedDate": "2020-06-25T22:57:10Z", "message": "merge and resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa0136ce3db41734704b4056e04d8d27dbdcfe3d", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/fa0136ce3db41734704b4056e04d8d27dbdcfe3d", "committedDate": "2020-06-25T23:56:05Z", "message": "add array/object type support for order by query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15904856383eda5d3ce13aa73d615fbeebf5efa9", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/15904856383eda5d3ce13aa73d615fbeebf5efa9", "committedDate": "2020-06-26T00:00:13Z", "message": "Merge branch 'master' into FixForOrderByByArrayOrObject"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a37df0acac1cc92b2811fd8e99237e29fa4c6534", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a37df0acac1cc92b2811fd8e99237e29fa4c6534", "committedDate": "2020-06-26T00:07:10Z", "message": "fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTM5Njk4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#pullrequestreview-437939698", "createdAt": "2020-06-26T00:15:16Z", "commit": {"oid": "a37df0acac1cc92b2811fd8e99237e29fa4c6534"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDoxNToxNlrOGpP3og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDoxODowNVrOGpP6bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNDgwMg==", "bodyText": "code style: \"{\" on the same line as class definition.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r445904802", "createdAt": "2020-06-26T00:15:16Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -3,60 +3,130 @@\n package com.azure.cosmos.implementation.query;\n \n import com.azure.cosmos.implementation.JsonSerializable;\n-import com.azure.cosmos.implementation.Utils;\n import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n import com.azure.cosmos.implementation.routing.UInt128;\n-import com.azure.cosmos.models.ModelBridgeInternal;\n-import com.fasterxml.jackson.databind.MapperFeature;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import com.fasterxml.jackson.databind.SerializationFeature;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.fasterxml.jackson.databind.node.ValueNode;\n \n import java.io.IOException;\n-import java.nio.ByteBuffer;\n+import java.util.Iterator;\n import java.util.List;\n+import java.util.Map;\n \n public final class DistinctHash {\n \n-    private static final UInt128 ARRAY_HASH_SEED = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);\n+    private static final UInt128 RootHashSeed = new UInt128(0xbfc2359eafc0e2b7L, 0x8846e00284c4cf1fL);\n \n-    private static final ObjectMapper OBJECT_MAPPER =\n-        new ObjectMapper()\n-            .configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true)\n-            .configure(SerializationFeature.ORDER_MAP_ENTRIES_BY_KEYS, true);\n+    private static class HashSeeds\n+    {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a37df0acac1cc92b2811fd8e99237e29fa4c6534"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNTAxMw==", "bodyText": "code style: java static field name all caps:\nNull -> NULL\nPropertyName -> PROPERTY_NAME", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r445905013", "createdAt": "2020-06-26T00:16:05Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -3,60 +3,130 @@\n package com.azure.cosmos.implementation.query;\n \n import com.azure.cosmos.implementation.JsonSerializable;\n-import com.azure.cosmos.implementation.Utils;\n import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n import com.azure.cosmos.implementation.routing.UInt128;\n-import com.azure.cosmos.models.ModelBridgeInternal;\n-import com.fasterxml.jackson.databind.MapperFeature;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import com.fasterxml.jackson.databind.SerializationFeature;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.fasterxml.jackson.databind.node.ValueNode;\n \n import java.io.IOException;\n-import java.nio.ByteBuffer;\n+import java.util.Iterator;\n import java.util.List;\n+import java.util.Map;\n \n public final class DistinctHash {\n \n-    private static final UInt128 ARRAY_HASH_SEED = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);\n+    private static final UInt128 RootHashSeed = new UInt128(0xbfc2359eafc0e2b7L, 0x8846e00284c4cf1fL);\n \n-    private static final ObjectMapper OBJECT_MAPPER =\n-        new ObjectMapper()\n-            .configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true)\n-            .configure(SerializationFeature.ORDER_MAP_ENTRIES_BY_KEYS, true);\n+    private static class HashSeeds\n+    {\n+        public static final UInt128 Null = new UInt128(0x1380f68bb3b0cfe4L, 0x156c918bf564ee48L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a37df0acac1cc92b2811fd8e99237e29fa4c6534"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNTM5OA==", "bodyText": "code style xor?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r445905398", "createdAt": "2020-06-26T00:17:32Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/routing/UInt128.java", "diffHunk": "@@ -55,4 +57,32 @@ public long getLow() {\n     public long getHigh() {\n         return high;\n     }\n+\n+    public UInt128 add(int value) {\n+        UInt128 add = new UInt128(value, 0);\n+        long low = this.low + add.low;\n+        long high = this.high + add.high;\n+\n+        if (low < add.low)\n+        {\n+            high++;\n+        }\n+\n+        return new UInt128(low, high);\n+    }\n+\n+    public UInt128 XOR(UInt128 other) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a37df0acac1cc92b2811fd8e99237e29fa4c6534"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNTUxOA==", "bodyText": "to be consistent with existing tests:\ndrop the \"Test\" prefix. here and other new tests..", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r445905518", "createdAt": "2020-06-26T00:18:05Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/query/DistinctHashTest.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package com.azure.cosmos.implementation.query;\n+\n+import com.azure.cosmos.implementation.routing.UInt128;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+public class DistinctHashTest {\n+\n+    @Test(groups = {\"unit\"})\n+    public void TestHashForNull() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a37df0acac1cc92b2811fd8e99237e29fa4c6534"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a29b8bd251125e39f76acb0f91d4168c30fc6bc4", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a29b8bd251125e39f76acb0f91d4168c30fc6bc4", "committedDate": "2020-06-26T00:29:00Z", "message": "resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6d6bca1bcc38d4162ae42932462278146362614", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a6d6bca1bcc38d4162ae42932462278146362614", "committedDate": "2020-06-26T00:37:57Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDYyNzA4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#pullrequestreview-438462708", "createdAt": "2020-06-26T17:12:58Z", "commit": {"oid": "a6d6bca1bcc38d4162ae42932462278146362614"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d71cd196cbcaccfd3dcc69be16fa6514a9767c3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/3d71cd196cbcaccfd3dcc69be16fa6514a9767c3", "committedDate": "2020-06-26T17:14:22Z", "message": "fix compilation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MTE5Mjcz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#pullrequestreview-438119273", "createdAt": "2020-06-26T08:43:23Z", "commit": {"oid": "a6d6bca1bcc38d4162ae42932462278146362614"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwODo0MzoyM1rOGpYyUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwODo0MzoyM1rOGpYyUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA1MDg5Ng==", "bodyText": "file header for new files.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r446050896", "createdAt": "2020-06-26T08:43:23Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/query/DistinctHashTest.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package com.azure.cosmos.implementation.query;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6d6bca1bcc38d4162ae42932462278146362614"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d8970ed692c3820048d468f4f1087e1c7431642", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/2d8970ed692c3820048d468f4f1087e1c7431642", "committedDate": "2020-06-26T17:40:57Z", "message": "Merge branch 'master' into FixForOrderByByArrayOrObject"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8178690bce9782bbefd0fdef0cf578724f9c4df3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8178690bce9782bbefd0fdef0cf578724f9c4df3", "committedDate": "2020-06-26T17:50:48Z", "message": "resolve comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDg3ODA4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#pullrequestreview-438487808", "createdAt": "2020-06-26T17:53:20Z", "commit": {"oid": "8178690bce9782bbefd0fdef0cf578724f9c4df3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzo1MzoyMFrOGpptWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzo1MzoyMFrOGpptWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyODE1Mg==", "bodyText": "the exception message is not correct you are not passing any arg to need String.format and %s", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r446328152", "createdAt": "2020-06-26T17:53:20Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/ItemComparator.java", "diffHunk": "@@ -41,6 +44,17 @@ public int compare(Object obj1, Object obj2) {\n             return Double.compare(((Number) obj1).doubleValue(), ((Number) obj2).doubleValue());\n         case String:\n             return ((String) obj1).compareTo((String) obj2);\n+        case ArrayNode:\n+        case ObjectNode:\n+            try{\n+                UInt128 hash1 = DistinctHash.getHash(obj1);\n+                UInt128 hash2 = DistinctHash.getHash(obj2);\n+                return hash1.compareTo(hash2);\n+            }\n+            catch (IOException e) {\n+                throw new IllegalStateException(String.format(\"Exception for getting has %s\", e));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8178690bce9782bbefd0fdef0cf578724f9c4df3"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDg4MjI1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#pullrequestreview-438488225", "createdAt": "2020-06-26T17:53:59Z", "commit": {"oid": "8178690bce9782bbefd0fdef0cf578724f9c4df3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzo1Mzo1OVrOGppukQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzo1Mzo1OVrOGppukQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyODQ2NQ==", "bodyText": "static field name?\n-> ROOT_HASH_SEED", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r446328465", "createdAt": "2020-06-26T17:53:59Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -3,60 +3,129 @@\n package com.azure.cosmos.implementation.query;\n \n import com.azure.cosmos.implementation.JsonSerializable;\n-import com.azure.cosmos.implementation.Utils;\n import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n import com.azure.cosmos.implementation.routing.UInt128;\n-import com.azure.cosmos.models.ModelBridgeInternal;\n-import com.fasterxml.jackson.databind.MapperFeature;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import com.fasterxml.jackson.databind.SerializationFeature;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.fasterxml.jackson.databind.node.ValueNode;\n \n import java.io.IOException;\n-import java.nio.ByteBuffer;\n+import java.util.Iterator;\n import java.util.List;\n+import java.util.Map;\n \n public final class DistinctHash {\n \n-    private static final UInt128 ARRAY_HASH_SEED = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);\n+    private static final UInt128 RootHashSeed = new UInt128(0xbfc2359eafc0e2b7L, 0x8846e00284c4cf1fL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8178690bce9782bbefd0fdef0cf578724f9c4df3"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52f37498de4dec4bbdc6112c27ba50f82901765d", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/52f37498de4dec4bbdc6112c27ba50f82901765d", "committedDate": "2020-06-26T18:05:26Z", "message": "resolve comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDk3NTAz", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#pullrequestreview-438497503", "createdAt": "2020-06-26T18:09:05Z", "commit": {"oid": "52f37498de4dec4bbdc6112c27ba50f82901765d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODowOTowNVrOGpqJ1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxODowOTowNVrOGpqJ1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMzNTQ0NQ==", "bodyText": "with this you will be loosing the cause exception stacktrace.\nYou probably want to keep the root cause exception stacktrace.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r446335445", "createdAt": "2020-06-26T18:09:05Z", "author": {"login": "moderakh"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/ItemComparator.java", "diffHunk": "@@ -41,6 +44,17 @@ public int compare(Object obj1, Object obj2) {\n             return Double.compare(((Number) obj1).doubleValue(), ((Number) obj2).doubleValue());\n         case String:\n             return ((String) obj1).compareTo((String) obj2);\n+        case ArrayNode:\n+        case ObjectNode:\n+            try{\n+                UInt128 hash1 = DistinctHash.getHash(obj1);\n+                UInt128 hash2 = DistinctHash.getHash(obj2);\n+                return hash1.compareTo(hash2);\n+            }\n+            catch (IOException e) {\n+                throw new IllegalStateException(String.format(\"Exception for getting hash for type %s: %s \", type1.toString(), e.getMessage()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52f37498de4dec4bbdc6112c27ba50f82901765d"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bc42dd801047a7b4a93e055981a0698980647a2", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1bc42dd801047a7b4a93e055981a0698980647a2", "committedDate": "2020-06-26T18:19:52Z", "message": "resolve comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ea6aa34fb74289296d6d71d3d069d74d0c90476", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/5ea6aa34fb74289296d6d71d3d069d74d0c90476", "committedDate": "2020-06-30T17:39:16Z", "message": "spotbugs fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fd9171f858b5de74144ef40c47654c1a056a371", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4fd9171f858b5de74144ef40c47654c1a056a371", "committedDate": "2020-06-30T20:55:34Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzcxNTY2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#pullrequestreview-440371566", "createdAt": "2020-06-30T20:44:31Z", "commit": {"oid": "5ea6aa34fb74289296d6d71d3d069d74d0c90476"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMDo0NDozMVrOGrNw0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMDo1ODoxOFrOGrON4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk2NzQ0MQ==", "bodyText": "I think there is a possible infinite recursion scenario here.\nThis calls getHashFromJsonSerializable -> which then again calls this method getHash by casing resource to JsonSerializable", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r447967441", "createdAt": "2020-06-30T20:44:31Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -3,60 +3,129 @@\n package com.azure.cosmos.implementation.query;\n \n import com.azure.cosmos.implementation.JsonSerializable;\n-import com.azure.cosmos.implementation.Utils;\n import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n import com.azure.cosmos.implementation.routing.UInt128;\n-import com.azure.cosmos.models.ModelBridgeInternal;\n-import com.fasterxml.jackson.databind.MapperFeature;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import com.fasterxml.jackson.databind.SerializationFeature;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.fasterxml.jackson.databind.node.ValueNode;\n \n import java.io.IOException;\n-import java.nio.ByteBuffer;\n+import java.util.Iterator;\n import java.util.List;\n+import java.util.Map;\n \n public final class DistinctHash {\n \n-    private static final UInt128 ARRAY_HASH_SEED = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);\n+    private static final UInt128 ROOT_HASH_SEED = new UInt128(0xbfc2359eafc0e2b7L, 0x8846e00284c4cf1fL);\n \n-    private static final ObjectMapper OBJECT_MAPPER =\n-        new ObjectMapper()\n-            .configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true)\n-            .configure(SerializationFeature.ORDER_MAP_ENTRIES_BY_KEYS, true);\n+    private static class HashSeeds {\n+        public static final UInt128 NULL = new UInt128(0x1380f68bb3b0cfe4L, 0x156c918bf564ee48L);\n+        public static final UInt128 FALSE = new UInt128(0xc1be517fe893b40cL, 0xe9fc8a4c531cd0ddL);\n+        public static final UInt128 TRUE = new UInt128(0xf86d4abf9a412e74L, 0x788488365c8a985dL);\n+        public static final UInt128 STRING = new UInt128(0x61f53f0a44204cfbL, 0x09481be8ef4b56ddL);\n+        public static final UInt128 ARRAY = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);\n+        public static final UInt128 OBJECT = new UInt128(0x77b285ac511aef30L, 0x3dcf187245822449L);\n+        public static final UInt128 INTEGER = new UInt128(0x0320dc908e0d3e71L, 0xf575de218f09ffa5L);\n+        public static final UInt128 LONG = new UInt128(0xed93baf7fdc76638L, 0x0d5733c37e079869L);\n+        public static final UInt128 DOUBLE = new UInt128(0x62fb48cc659963a0L, 0xe9e690779309c403L);\n+        public static final UInt128 ARRAY_INDEX = new UInt128(0xfe057204216db999L, 0x5b1cc3178bd9c593L);\n+        public static final UInt128 PROPERTY_NAME = new UInt128(0xc915dde058492a8aL, 0x7c8be2eba72e4634L);\n+    }\n \n     @SuppressWarnings(\"unchecked\")\n     public static UInt128 getHash(Object resource) throws IOException {\n+        return getHash(resource, ROOT_HASH_SEED);\n+    }\n \n-        if (resource instanceof List) {\n-            return getHashFromList((List<Object>) resource);\n+    @SuppressWarnings(\"unchecked\")\n+    private static UInt128 getHash(Object resource, UInt128 seed) throws IOException {\n+        if (resource == null) {\n+            return MurmurHash3_128.hash128(HashSeeds.NULL, seed);\n         }\n-\n         if (resource instanceof JsonSerializable) {\n-            return getHashFromJsonSerializable((JsonSerializable) resource);\n+            return getHashFromJsonSerializable((JsonSerializable) resource, seed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ea6aa34fb74289296d6d71d3d069d74d0c90476"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk2OTA5NQ==", "bodyText": "I think this is a typo ->\nthis.high < this.high -> should be -> this.high < other.high ??", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r447969095", "createdAt": "2020-06-30T20:47:32Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/routing/UInt128.java", "diffHunk": "@@ -55,4 +57,32 @@ public long getLow() {\n     public long getHigh() {\n         return high;\n     }\n+\n+    public UInt128 add(int value) {\n+        UInt128 add = new UInt128(value, 0);\n+        long low = this.low + add.low;\n+        long high = this.high + add.high;\n+\n+        if (low < add.low)\n+        {\n+            high++;\n+        }\n+\n+        return new UInt128(low, high);\n+    }\n+\n+    public UInt128 xor(UInt128 other) {\n+        return new UInt128(this.low ^ other.low, this.high ^ other.high);\n+    }\n+\n+    @Override\n+    public int compareTo(UInt128 other) {\n+        if (this.equals(other)) {\n+            return 0;\n+        }\n+        if ((this.high < this.high) || ((this.high == other.high) && (this.low < other.low))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ea6aa34fb74289296d6d71d3d069d74d0c90476"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk3MDUxMw==", "bodyText": "why do we need this ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r447970513", "createdAt": "2020-06-30T20:50:16Z", "author": {"login": "kushagraThapar"}, "path": "eng/code-quality-reports/src/main/resources/spotbugs/spotbugs-exclude.xml", "diffHunk": "@@ -1836,6 +1836,13 @@\n     <Bug pattern=\"UPM_UNCALLED_PRIVATE_METHOD\"/>\n   </Match>\n \n+\n+  <Match>\n+    <Class name=\"com.azure.cosmos.implementation.routing.UInt128\"/>\n+    <Method name=\"compareTo\"/>\n+    <Bug pattern=\"SA_FIELD_SELF_COMPARISON\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ea6aa34fb74289296d6d71d3d069d74d0c90476"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk3NDE5NQ==", "bodyText": "I can see a possibility to merge the logic of this function - getHashFromList and getHashFromArrayNode since the logic is exactly same.\nOr @xinlian12  do you want to keep it separate for more readability ? The only downside of keeping them separate is that if we have a bug in one logic, we could have it in other logic as well and we will have to fix them separately.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r447974195", "createdAt": "2020-06-30T20:57:05Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/DistinctHash.java", "diffHunk": "@@ -3,60 +3,129 @@\n package com.azure.cosmos.implementation.query;\n \n import com.azure.cosmos.implementation.JsonSerializable;\n-import com.azure.cosmos.implementation.Utils;\n import com.azure.cosmos.implementation.routing.MurmurHash3_128;\n import com.azure.cosmos.implementation.routing.UInt128;\n-import com.azure.cosmos.models.ModelBridgeInternal;\n-import com.fasterxml.jackson.databind.MapperFeature;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import com.fasterxml.jackson.databind.SerializationFeature;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.fasterxml.jackson.databind.node.ValueNode;\n \n import java.io.IOException;\n-import java.nio.ByteBuffer;\n+import java.util.Iterator;\n import java.util.List;\n+import java.util.Map;\n \n public final class DistinctHash {\n \n-    private static final UInt128 ARRAY_HASH_SEED = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);\n+    private static final UInt128 ROOT_HASH_SEED = new UInt128(0xbfc2359eafc0e2b7L, 0x8846e00284c4cf1fL);\n \n-    private static final ObjectMapper OBJECT_MAPPER =\n-        new ObjectMapper()\n-            .configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true)\n-            .configure(SerializationFeature.ORDER_MAP_ENTRIES_BY_KEYS, true);\n+    private static class HashSeeds {\n+        public static final UInt128 NULL = new UInt128(0x1380f68bb3b0cfe4L, 0x156c918bf564ee48L);\n+        public static final UInt128 FALSE = new UInt128(0xc1be517fe893b40cL, 0xe9fc8a4c531cd0ddL);\n+        public static final UInt128 TRUE = new UInt128(0xf86d4abf9a412e74L, 0x788488365c8a985dL);\n+        public static final UInt128 STRING = new UInt128(0x61f53f0a44204cfbL, 0x09481be8ef4b56ddL);\n+        public static final UInt128 ARRAY = new UInt128(0xfa573b014c4dc18eL, 0xa014512c858eb115L);\n+        public static final UInt128 OBJECT = new UInt128(0x77b285ac511aef30L, 0x3dcf187245822449L);\n+        public static final UInt128 INTEGER = new UInt128(0x0320dc908e0d3e71L, 0xf575de218f09ffa5L);\n+        public static final UInt128 LONG = new UInt128(0xed93baf7fdc76638L, 0x0d5733c37e079869L);\n+        public static final UInt128 DOUBLE = new UInt128(0x62fb48cc659963a0L, 0xe9e690779309c403L);\n+        public static final UInt128 ARRAY_INDEX = new UInt128(0xfe057204216db999L, 0x5b1cc3178bd9c593L);\n+        public static final UInt128 PROPERTY_NAME = new UInt128(0xc915dde058492a8aL, 0x7c8be2eba72e4634L);\n+    }\n \n     @SuppressWarnings(\"unchecked\")\n     public static UInt128 getHash(Object resource) throws IOException {\n+        return getHash(resource, ROOT_HASH_SEED);\n+    }\n \n-        if (resource instanceof List) {\n-            return getHashFromList((List<Object>) resource);\n+    @SuppressWarnings(\"unchecked\")\n+    private static UInt128 getHash(Object resource, UInt128 seed) throws IOException {\n+        if (resource == null) {\n+            return MurmurHash3_128.hash128(HashSeeds.NULL, seed);\n         }\n-\n         if (resource instanceof JsonSerializable) {\n-            return getHashFromJsonSerializable((JsonSerializable) resource);\n+            return getHashFromJsonSerializable((JsonSerializable) resource, seed);\n+        }\n+        if (resource instanceof List) {\n+            return getHashFromList((List<Object>) resource, seed);\n+        }\n+        if (resource instanceof Boolean) {\n+            return (Boolean)resource ? MurmurHash3_128.hash128(HashSeeds.TRUE, seed) : MurmurHash3_128.hash128(HashSeeds.FALSE, seed);\n+        }\n+        if (resource instanceof Integer) {\n+            UInt128 hash = MurmurHash3_128.hash128(HashSeeds.INTEGER, seed);\n+            return MurmurHash3_128.hash128(resource, hash);\n+        }\n+        if (resource instanceof Long) {\n+            UInt128 hash = MurmurHash3_128.hash128(HashSeeds.LONG, seed);\n+            return MurmurHash3_128.hash128(resource, hash);\n+        }\n+        if (resource instanceof Double) {\n+            UInt128 hash = MurmurHash3_128.hash128(HashSeeds.DOUBLE, seed);\n+            return MurmurHash3_128.hash128(resource, hash);\n+        }\n+        if (resource instanceof String) {\n+            UInt128 hash = MurmurHash3_128.hash128(HashSeeds.STRING, seed);\n+            return MurmurHash3_128.hash128(resource, hash);\n+        }\n+        if (resource instanceof ValueNode) {\n+            return getHash(JsonSerializable.getValue((JsonNode) resource));\n+        }\n+        if (resource instanceof ArrayNode) {\n+            return getHashFromArrayNode((ArrayNode) resource, seed);\n+        }\n+        if (resource instanceof ObjectNode) {\n+            return getHashFromObjectNode((ObjectNode) resource, seed);\n         }\n \n-        final byte[] bytes = Utils.serializeObjectToByteArray(resource);\n-        UInt128 uInt128 = MurmurHash3_128.hash128(bytes, bytes.length);\n-        return uInt128;\n+        throw new IllegalArgumentException(String.format(\"Unexpected type: %s\", resource.getClass().toString()));\n     }\n \n-    private static UInt128 getHashFromJsonSerializable(JsonSerializable resource) {\n-        final ByteBuffer byteBuffer = ModelBridgeInternal.serializeJsonToByteBuffer(resource, OBJECT_MAPPER);\n-        final byte[] bytes = byteBuffer.array();\n-        return MurmurHash3_128.hash128(bytes, bytes.length);\n+    private static UInt128 getHashFromJsonSerializable(JsonSerializable resource, UInt128 seed) throws IOException {\n+        resource.populatePropertyBag();\n+        return getHash(resource.getPropertyBag(), seed);\n     }\n \n-    private static UInt128 getHashFromList(List<Object> resource) {\n-        UInt128 hash = ARRAY_HASH_SEED;\n-        for (Object obj : resource) {\n-            if (obj instanceof JsonSerializable) {\n-                byte[] bytes = hash.toByteBuffer().array();\n-                if (bytes.length == 0) {\n-                    throw new IllegalStateException(\"Failed to hash!\");\n-                }\n-                hash = MurmurHash3_128.hash128(bytes, bytes.length,\n-                                               getHashFromJsonSerializable((JsonSerializable) obj));\n-            }\n+    private static UInt128 getHashFromArrayNode(ArrayNode arrayNode, UInt128 seed) throws IOException {\n+        // Start the array with a distinct hash, so that empty array doesn't hash to another value.\n+        UInt128 hash = MurmurHash3_128.hash128(HashSeeds.ARRAY, seed);\n+\n+        for (int i = 0; i < arrayNode.size(); i++) {\n+            // Order of array items matter in equality check, so add the index just in case that property does not hold in the future.\n+            UInt128 arrayItemSeed = HashSeeds.ARRAY_INDEX.add(i);\n+            hash = MurmurHash3_128.hash128(hash, getHash(arrayNode.get(i), arrayItemSeed));\n+        }\n+        return hash;\n+    }\n+\n+    private static UInt128 getHashFromObjectNode(ObjectNode objectNode, UInt128 seed) throws IOException {\n+        UInt128 hash = MurmurHash3_128.hash128(HashSeeds.OBJECT, seed);\n+        UInt128 intermediateHash = UInt128.ZERO;\n+\n+        // Property order should not result in a different hash.\n+        // This is consistent with equality comparison.\n+        Iterator<Map.Entry<String, JsonNode>> children = objectNode.fields();\n+        while ((children.hasNext())) {\n+            Map.Entry<String, JsonNode> child = children.next();\n+            UInt128 nameHash = MurmurHash3_128.hash128(child.getKey(), HashSeeds.PROPERTY_NAME);\n+            UInt128 propertyHash = getHash(child.getValue(), nameHash);\n+            intermediateHash = intermediateHash.xor(propertyHash);\n+        }\n+\n+        if (intermediateHash.compareTo(UInt128.ZERO) == 1) {\n+            hash = MurmurHash3_128.hash128(intermediateHash, hash);\n+        }\n+\n+        return hash;\n+    }\n+\n+    private static UInt128 getHashFromList(List<Object> resource, UInt128 seed) throws IOException {\n+        UInt128 hash = MurmurHash3_128.hash128(HashSeeds.ARRAY, seed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ea6aa34fb74289296d6d71d3d069d74d0c90476"}, "originalPosition": 154}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk3NDg4MQ==", "bodyText": "I don't think this exception message makes sense, since there is no type1 in this try catch block.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r447974881", "createdAt": "2020-06-30T20:58:18Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/ItemComparator.java", "diffHunk": "@@ -41,6 +44,17 @@ public int compare(Object obj1, Object obj2) {\n             return Double.compare(((Number) obj1).doubleValue(), ((Number) obj2).doubleValue());\n         case String:\n             return ((String) obj1).compareTo((String) obj2);\n+        case ArrayNode:\n+        case ObjectNode:\n+            try{\n+                UInt128 hash1 = DistinctHash.getHash(obj1);\n+                UInt128 hash2 = DistinctHash.getHash(obj2);\n+                return hash1.compareTo(hash2);\n+            }\n+            catch (IOException e) {\n+                throw new IllegalStateException(String.format(\"Getting hash exception for type %s \", type1.toString()), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ea6aa34fb74289296d6d71d3d069d74d0c90476"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32f54f05463fd885f18df3f342cd07f828f9d4f8", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/32f54f05463fd885f18df3f342cd07f828f9d4f8", "committedDate": "2020-06-30T21:14:22Z", "message": "resolve comments and clean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca8fb917d5a8d63bf4aa29feca282b28369d7393", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/ca8fb917d5a8d63bf4aa29feca282b28369d7393", "committedDate": "2020-06-30T21:15:07Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDQ0NDA1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#pullrequestreview-440444405", "createdAt": "2020-06-30T23:06:33Z", "commit": {"oid": "5ea6aa34fb74289296d6d71d3d069d74d0c90476"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMzowNjozM1rOGrRa1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMzowNjozM1rOGrRa1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyNzM0OQ==", "bodyText": "why only type1 and not type2 ?\nAlso, what does type1.toString() represents ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12521#discussion_r448027349", "createdAt": "2020-06-30T23:06:33Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/query/ItemComparator.java", "diffHunk": "@@ -41,6 +44,17 @@ public int compare(Object obj1, Object obj2) {\n             return Double.compare(((Number) obj1).doubleValue(), ((Number) obj2).doubleValue());\n         case String:\n             return ((String) obj1).compareTo((String) obj2);\n+        case ArrayNode:\n+        case ObjectNode:\n+            try{\n+                UInt128 hash1 = DistinctHash.getHash(obj1);\n+                UInt128 hash2 = DistinctHash.getHash(obj2);\n+                return hash1.compareTo(hash2);\n+            }\n+            catch (IOException e) {\n+                throw new IllegalStateException(String.format(\"Getting hash exception for type %s \", type1.toString()), e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk3NDg4MQ=="}, "originalCommit": {"oid": "5ea6aa34fb74289296d6d71d3d069d74d0c90476"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f879e3d26f2e8962a46bc485d75ea5bf8967cda2", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/f879e3d26f2e8962a46bc485d75ea5bf8967cda2", "committedDate": "2020-07-01T06:18:15Z", "message": "fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2939, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}