{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0OTI0Njc2", "number": 14529, "title": "Cosmos Encryption removed block() in implementation", "bodyText": "This PR has 0 change in azure-cosmos\nThis PR scope is to remove block() calls in cosmos-encryption lib implementation.", "createdAt": "2020-08-27T20:12:46Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529", "merged": true, "mergeCommit": {"oid": "181a04ab2f2769246c9b60e05fa4dc50cfa73493"}, "closed": true, "closedAt": "2020-09-01T19:33:00Z", "author": {"login": "moderakh"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDGKkdgH2gAyNDc0OTI0Njc2OmMwYTQ0NDczMDcyMTJmYzJlMDI5NzI3NGNhY2U2OWU4NjFhYWU3M2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEcBeSgH2gAyNDc0OTI0Njc2OjZkZGI2NTRiZDYwYzU0OGU2MjQ3N2JhYzQ1MjMyNWJjZjEyNDRkMTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c0a4447307212fc2e0297274cace69e861aae73c", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c0a4447307212fc2e0297274cace69e861aae73c", "committedDate": "2020-08-27T20:09:59Z", "message": "removed blocking calls from cosmos encryption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89e49447ab5f62d3c80180250aaf28509f793a51", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/89e49447ab5f62d3c80180250aaf28509f793a51", "committedDate": "2020-08-27T20:12:23Z", "message": "undo change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MTE3ODg0", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#pullrequestreview-477117884", "createdAt": "2020-08-27T22:08:08Z", "commit": {"oid": "89e49447ab5f62d3c80180250aaf28509f793a51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjowODowOFrOHIi7ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjowODowOFrOHIi7ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMjkxNw==", "bodyText": "NIT: Remove TODO comment?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#discussion_r478722917", "createdAt": "2020-08-27T22:08:08Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/AzureKeyVaultKeyWrapProvider.java", "diffHunk": "@@ -50,7 +50,7 @@ public AzureKeyVaultKeyWrapProvider(KeyVaultTokenCredentialFactory keyVaultToken\n \n     // TODO make this async", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89e49447ab5f62d3c80180250aaf28509f793a51"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "079dc12e5baf57be3ef4468a3ed7537b76274c53", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/079dc12e5baf57be3ef4468a3ed7537b76274c53", "committedDate": "2020-08-27T22:10:54Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7c2ef92baa39c341b79fad6b511628e8f307336", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a7c2ef92baa39c341b79fad6b511628e8f307336", "committedDate": "2020-08-27T22:11:20Z", "message": "Merge branch 'master' into users/moderakh/20200826-encryption"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MTE5NjQw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#pullrequestreview-477119640", "createdAt": "2020-08-27T22:11:56Z", "commit": {"oid": "89e49447ab5f62d3c80180250aaf28509f793a51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjoxMTo1N1rOHIjA7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjoxMTo1N1rOHIjA7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNDMzNA==", "bodyText": "NIT: wouldn't it make sense to do that in this PR vs. just adding TODO? Or is the work more involved than I naively assume?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#discussion_r478724334", "createdAt": "2020-08-27T22:11:57Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/implementation/encryption/CachedDekProperties.java", "diffHunk": "@@ -13,7 +13,7 @@ public CachedDekProperties(\n         DataEncryptionKeyProperties serverProperties,\n         Instant serverPropertiesExpiryUtc) {\n         assert(serverProperties != null);\n-\n+        // TODO: add NPE validation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89e49447ab5f62d3c80180250aaf28509f793a51"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MTIyMTQ2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#pullrequestreview-477122146", "createdAt": "2020-08-27T22:17:35Z", "commit": {"oid": "89e49447ab5f62d3c80180250aaf28509f793a51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjoxNzozNVrOHIjI9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMjoxNzozNVrOHIjI9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNjM4OQ==", "bodyText": "You are modifying the passed in request options here. Wouldn't it be better to create a deep copy instead?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#discussion_r478726389", "createdAt": "2020-08-27T22:17:35Z", "author": {"login": "FabianMeiswinkel"}, "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/implementation/encryption/DataEncryptionKeyContainerCore.java", "diffHunk": "@@ -96,39 +99,42 @@ public DataEncryptionKeyContainerCore(CosmosDataEncryptionKeyProvider dekProvide\n                 DataEncryptionKeyProperties dekProperties = result.getT1();\n                 InMemoryRawDek inMemoryRawDek = result.getT2();\n \n-                Tuple3<byte[], EncryptionKeyWrapMetadata, InMemoryRawDek> wrapResult =\n-                    this.wrapAsync(\n-                        id,\n-                        inMemoryRawDek.getDataEncryptionKey().getRawKey(),\n-                        dekProperties.encryptionAlgorithm,\n-                        newWrapMetadata);\n-\n-                byte[] wrappedDek = wrapResult.getLeft();\n-                EncryptionKeyWrapMetadata updatedMetadata = wrapResult.getMiddle();\n-                InMemoryRawDek updatedRawDek = wrapResult.getRight();\n-\n-                CosmosItemRequestOptions effectiveRequestOptions = requestOptions != null ? requestOptions : new CosmosItemRequestOptions();\n-\n-                effectiveRequestOptions.setIfMatchETag(dekProperties.eTag);\n-\n-                DataEncryptionKeyProperties newDekProperties = new DataEncryptionKeyProperties(dekProperties);\n-                newDekProperties.wrappedDataEncryptionKey = wrappedDek;\n-                newDekProperties.encryptionKeyWrapMetadata = updatedMetadata;\n-\n-                Mono<CosmosItemResponse<DataEncryptionKeyProperties>> responseMono = this.dekProvider.getContainer().replaceItem(\n-                    newDekProperties,\n-                    newDekProperties.id,\n-                    new PartitionKey(newDekProperties.id),\n-                    effectiveRequestOptions);\n-\n-                return responseMono.flatMap(\n-                    response -> {\n-                        DataEncryptionKeyProperties item = response.getItem();\n-\n-                        assert (item != null);\n-                        this.dekProvider.getDekCache().setDekProperties(id, item);\n-                        this.dekProvider.getDekCache().setRawDek(id, updatedRawDek);\n-                        return Mono.just(response);\n+                Mono<Tuple3<byte[], EncryptionKeyWrapMetadata, InMemoryRawDek>> wrapResultMono = this.wrapAsync(\n+                    id,\n+                    inMemoryRawDek.getDataEncryptionKey().getRawKey(),\n+                    dekProperties.encryptionAlgorithm,\n+                    newWrapMetadata);\n+\n+                return wrapResultMono.flatMap(\n+                    wrapResult -> {\n+                        byte[] wrappedDek = wrapResult.getLeft();\n+                        EncryptionKeyWrapMetadata updatedMetadata = wrapResult.getMiddle();\n+                        InMemoryRawDek updatedRawDek = wrapResult.getRight();\n+\n+                        CosmosItemRequestOptions effectiveRequestOptions = requestOptions != null ? requestOptions : new CosmosItemRequestOptions();\n+\n+                        effectiveRequestOptions.setIfMatchETag(dekProperties.eTag);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89e49447ab5f62d3c80180250aaf28509f793a51"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MTIyODM2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#pullrequestreview-477122836", "createdAt": "2020-08-27T22:19:09Z", "commit": {"oid": "89e49447ab5f62d3c80180250aaf28509f793a51"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb53b282350c2c9a13a43895fb9dda002f5a04ff", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bb53b282350c2c9a13a43895fb9dda002f5a04ff", "committedDate": "2020-08-27T22:54:53Z", "message": "minor cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a151c0e69d67016ba34c1cc3c6baf70d046b8616", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a151c0e69d67016ba34c1cc3c6baf70d046b8616", "committedDate": "2020-08-31T16:35:03Z", "message": "address code review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34c9d73d635e75c75a22dd74561bf1188e1beb7b", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/34c9d73d635e75c75a22dd74561bf1188e1beb7b", "committedDate": "2020-08-31T16:58:05Z", "message": "method renaming (dropped Async suffix from the methods)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "374104cb78b21f6c5d4772d5289197460e8f68d4", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/374104cb78b21f6c5d4772d5289197460e8f68d4", "committedDate": "2020-08-31T21:50:18Z", "message": "cleanup, move internal classes to implementation package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79ef32707bfe44371965b3bc85e0b7742bf86a72", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/79ef32707bfe44371965b3bc85e0b7742bf86a72", "committedDate": "2020-08-31T23:38:34Z", "message": "move internal classes to implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ddb654bd60c548e62477bac452325bcf1244d11", "author": {"user": {"login": "moderakh", "name": "Mohammad Derakhshani"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6ddb654bd60c548e62477bac452325bcf1244d11", "committedDate": "2020-09-01T00:11:53Z", "message": "internal APIs moved to package private"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 115, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}