{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMTY5MjUw", "number": 7243, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNTowNDo1M1rODWkf2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNTowODo1NlrODWkkxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0OTkzMjQwOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ClientRetryPolicy.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNTowNDo1M1rOFbZsvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxODo0Mjo0N1rOFbgNDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI3NjkyNg==", "bodyText": "HttpConstants.StatusCodes.FORBIDDEN, HttpConstants.SubStatusCodes.FORBIDDEN_WRITEFORBIDDEN will qualify as isWebExceptionRetriable ? If not then how does that case handled ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#discussion_r364276926", "createdAt": "2020-01-08T15:04:53Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ClientRetryPolicy.java", "diffHunk": "@@ -173,8 +173,17 @@ private ShouldRetryResult shouldRetryOnSessionNotAvailable() {\n             retryDelay = Duration.ofMillis(ClientRetryPolicy.RetryIntervalInMS);\n         }\n         this.retryContext = new RetryContext(this.failoverRetryCount, false);\n-        return this.globalEndpointManager.refreshLocationAsync(null, forceRefresh)\n-                .then(Mono.just(ShouldRetryResult.retryAfter(retryDelay)));\n+        Mono<Void> completable = this.globalEndpointManager.refreshLocationAsync(null, forceRefresh);\n+        if (isReadRequest || WebExceptionUtility.isWebExceptionRetriable(e)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5be6b4066ad42c1618b7e10f3e387fbeea8823f1"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM4MzUwMw==", "bodyText": "I don't think it will be qualified as WebExceptionRetriable\nAnd in that case, we force refresh but I don't think we will retry.\nWorth discussing over a meeting.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#discussion_r364383503", "createdAt": "2020-01-08T18:42:47Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ClientRetryPolicy.java", "diffHunk": "@@ -173,8 +173,17 @@ private ShouldRetryResult shouldRetryOnSessionNotAvailable() {\n             retryDelay = Duration.ofMillis(ClientRetryPolicy.RetryIntervalInMS);\n         }\n         this.retryContext = new RetryContext(this.failoverRetryCount, false);\n-        return this.globalEndpointManager.refreshLocationAsync(null, forceRefresh)\n-                .then(Mono.just(ShouldRetryResult.retryAfter(retryDelay)));\n+        Mono<Void> completable = this.globalEndpointManager.refreshLocationAsync(null, forceRefresh);\n+        if (isReadRequest || WebExceptionUtility.isWebExceptionRetriable(e)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI3NjkyNg=="}, "originalCommit": {"oid": "5be6b4066ad42c1618b7e10f3e387fbeea8823f1"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0OTk0NTAzOnYy", "diffSide": "RIGHT", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ClientRetryPolicy.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNTowODo1NlrOFbZ01Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwNDoyMToyMlrOFbqm0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI3ODk5Nw==", "bodyText": "Isn't heading of PR is contradicting , we are retrying on write in case of network failure ? Until I am missing something", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#discussion_r364278997", "createdAt": "2020-01-08T15:08:56Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ClientRetryPolicy.java", "diffHunk": "@@ -173,8 +173,17 @@ private ShouldRetryResult shouldRetryOnSessionNotAvailable() {\n             retryDelay = Duration.ofMillis(ClientRetryPolicy.RetryIntervalInMS);\n         }\n         this.retryContext = new RetryContext(this.failoverRetryCount, false);\n-        return this.globalEndpointManager.refreshLocationAsync(null, forceRefresh)\n-                .then(Mono.just(ShouldRetryResult.retryAfter(retryDelay)));\n+        Mono<Void> completable = this.globalEndpointManager.refreshLocationAsync(null, forceRefresh);\n+        if (isReadRequest || WebExceptionUtility.isWebExceptionRetriable(e)) {\n+            // refresh cache and\n+            // if it is a read request or if it is a write but we are sure the write\n+            // hasn't reached the service retry\n+            return completable.then(Mono.just(ShouldRetryResult.retryAfter(retryDelay)));\n+        } else {\n+            // refresh cache and\n+            // no retry for writes which we are not sure if have reached to the service or not\n+            return completable.then(Mono.just(ShouldRetryResult.noRetry()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5be6b4066ad42c1618b7e10f3e387fbeea8823f1"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM3NDM2NA==", "bodyText": "We are only retrying if it is a readRequest, or WebExceptionRetriable.\nIn the else case, we are not retrying.. we are calling noRetry()\nWebExceptionRetriable only returns true, when you are trying to connect but you get connection exception.\nThat means, we are sure we haven't reached the server.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#discussion_r364374364", "createdAt": "2020-01-08T18:21:23Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ClientRetryPolicy.java", "diffHunk": "@@ -173,8 +173,17 @@ private ShouldRetryResult shouldRetryOnSessionNotAvailable() {\n             retryDelay = Duration.ofMillis(ClientRetryPolicy.RetryIntervalInMS);\n         }\n         this.retryContext = new RetryContext(this.failoverRetryCount, false);\n-        return this.globalEndpointManager.refreshLocationAsync(null, forceRefresh)\n-                .then(Mono.just(ShouldRetryResult.retryAfter(retryDelay)));\n+        Mono<Void> completable = this.globalEndpointManager.refreshLocationAsync(null, forceRefresh);\n+        if (isReadRequest || WebExceptionUtility.isWebExceptionRetriable(e)) {\n+            // refresh cache and\n+            // if it is a read request or if it is a write but we are sure the write\n+            // hasn't reached the service retry\n+            return completable.then(Mono.just(ShouldRetryResult.retryAfter(retryDelay)));\n+        } else {\n+            // refresh cache and\n+            // no retry for writes which we are not sure if have reached to the service or not\n+            return completable.then(Mono.just(ShouldRetryResult.noRetry()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI3ODk5Nw=="}, "originalCommit": {"oid": "5be6b4066ad42c1618b7e10f3e387fbeea8823f1"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU1MzkzNg==", "bodyText": "Ok so it is retry on write in case of connection exception , thinking other way round was confusing.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7243#discussion_r364553936", "createdAt": "2020-01-09T04:21:22Z", "author": {"login": "simplynaveen20"}, "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ClientRetryPolicy.java", "diffHunk": "@@ -173,8 +173,17 @@ private ShouldRetryResult shouldRetryOnSessionNotAvailable() {\n             retryDelay = Duration.ofMillis(ClientRetryPolicy.RetryIntervalInMS);\n         }\n         this.retryContext = new RetryContext(this.failoverRetryCount, false);\n-        return this.globalEndpointManager.refreshLocationAsync(null, forceRefresh)\n-                .then(Mono.just(ShouldRetryResult.retryAfter(retryDelay)));\n+        Mono<Void> completable = this.globalEndpointManager.refreshLocationAsync(null, forceRefresh);\n+        if (isReadRequest || WebExceptionUtility.isWebExceptionRetriable(e)) {\n+            // refresh cache and\n+            // if it is a read request or if it is a write but we are sure the write\n+            // hasn't reached the service retry\n+            return completable.then(Mono.just(ShouldRetryResult.retryAfter(retryDelay)));\n+        } else {\n+            // refresh cache and\n+            // no retry for writes which we are not sure if have reached to the service or not\n+            return completable.then(Mono.just(ShouldRetryResult.noRetry()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI3ODk5Nw=="}, "originalCommit": {"oid": "5be6b4066ad42c1618b7e10f3e387fbeea8823f1"}, "originalPosition": 65}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 513, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}