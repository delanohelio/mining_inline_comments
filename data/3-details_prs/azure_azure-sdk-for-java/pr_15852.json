{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1ODg5Mzgw", "number": 15852, "title": "[Event Hubs] Check connection status of each partition periodically", "bodyText": "This PR adds a check to verify the connection state of each partition periodically. If the connection is not active and the partition is still in the list of pumps, the change removes it to allow other nodes to claim the partition.\nThis also adds more verbose level logging to help troubleshoot receiver issues. Also fixes logger names where we were not using standard class names.", "createdAt": "2020-10-01T01:28:00Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15852", "merged": true, "mergeCommit": {"oid": "90b51737a28ccea6d72bd796b13d6632307b54a8"}, "closed": true, "closedAt": "2020-10-09T00:23:21Z", "author": {"login": "srnagar"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMFvg6gH2gAyNDk1ODg5MzgwOjcyYTNhY2QzYjg2NWUyMjNiOGZhN2ZlZmVlYmM1Yzk3YjAzMzc4ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQq8ZEAFqTUwNTI2MDc0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "72a3acd3b865e223b8fa7fefeebc5c97b0337888", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/72a3acd3b865e223b8fa7fefeebc5c97b0337888", "committedDate": "2020-09-24T18:45:45Z", "message": "Add link credits when remote credits are empty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14fd830dc3bba843e31bf8d0a2c9571b158619a6", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/14fd830dc3bba843e31bf8d0a2c9571b158619a6", "committedDate": "2020-09-28T07:20:07Z", "message": "Accumulate credits before sending"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d1533dc45e1ee40fde63467806193d308dbc731", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/1d1533dc45e1ee40fde63467806193d308dbc731", "committedDate": "2020-09-28T17:59:18Z", "message": "Conditional logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b685ea99a763abd5b5181660b29ce87898b68587", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b685ea99a763abd5b5181660b29ce87898b68587", "committedDate": "2020-09-30T11:35:14Z", "message": "More updates to receiver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6deb79a84c4719982b7d484201e386f6d513fa7d", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6deb79a84c4719982b7d484201e386f6d513fa7d", "committedDate": "2020-10-02T05:51:16Z", "message": "Check link status before adding credits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c502ddb66d7b03be1da3b3c561b3739de00d61e8", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c502ddb66d7b03be1da3b3c561b3739de00d61e8", "committedDate": "2020-10-08T16:53:17Z", "message": "Check connection state periodically"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "340b47cb60e144afadf0a1f09772f23bf8f869f6", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/340b47cb60e144afadf0a1f09772f23bf8f869f6", "committedDate": "2020-10-08T16:55:51Z", "message": "Remove prefetch for publish on operator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83c180dfdd22f3721133e9d993c84849f5facee5", "author": {"user": {"login": "srnagar", "name": "Srikanta"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/83c180dfdd22f3721133e9d993c84849f5facee5", "committedDate": "2020-10-08T18:13:54Z", "message": "Fix checkstyle errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MTk3NTUw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15852#pullrequestreview-505197550", "createdAt": "2020-10-08T22:03:00Z", "commit": {"oid": "83c180dfdd22f3721133e9d993c84849f5facee5"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjowMzowMFrOHex9Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjowNDoxMVrOHex-4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNzgxMA==", "bodyText": "Should we also dispose of the client if it is closed?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15852#discussion_r502037810", "createdAt": "2020-10-08T22:03:00Z", "author": {"login": "conniey"}, "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionPumpManager.java", "diffHunk": "@@ -119,6 +120,23 @@ void stopAllPartitionPumps() {\n         });\n     }\n \n+    /**\n+     * Checks the state of the connection for the given partition. If the connection is closed, then this method will\n+     * remove the partition from the list of partition pumps.\n+     *\n+     * @param ownership The partition ownership information for which the connection state will be verified.\n+     */\n+    void verifyPartitionConnection(PartitionOwnership ownership) {\n+        if (partitionPumps.containsKey(ownership.getPartitionId())) {\n+            EventHubConsumerAsyncClient consumerClient = partitionPumps.get(ownership.getPartitionId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83c180dfdd22f3721133e9d993c84849f5facee5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzODE3OA==", "bodyText": "The if condition isn't necessary, iirc, we already call that logic internally.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15852#discussion_r502038178", "createdAt": "2020-10-08T22:04:01Z", "author": {"login": "conniey"}, "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionPumpManager.java", "diffHunk": "@@ -166,17 +184,25 @@ void startPartitionPump(PartitionOwnership claimedOwnership, Checkpoint checkpoi\n             partitionPumps.put(claimedOwnership.getPartitionId(), eventHubConsumer);\n             //@formatter:off\n             Flux<Flux<PartitionEvent>> partitionEventFlux;\n+            Flux<PartitionEvent> receiver = eventHubConsumer\n+                .receiveFromPartition(claimedOwnership.getPartitionId(), startFromEventPosition, receiveOptions)\n+                .doOnNext(partitionEvent -> {\n+                    if (logger.canLogAtLevel(LogLevel.VERBOSE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83c180dfdd22f3721133e9d993c84849f5facee5"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzODI0Mw==", "bodyText": "Same with all other instances.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15852#discussion_r502038243", "createdAt": "2020-10-08T22:04:11Z", "author": {"login": "conniey"}, "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionPumpManager.java", "diffHunk": "@@ -166,17 +184,25 @@ void startPartitionPump(PartitionOwnership claimedOwnership, Checkpoint checkpoi\n             partitionPumps.put(claimedOwnership.getPartitionId(), eventHubConsumer);\n             //@formatter:off\n             Flux<Flux<PartitionEvent>> partitionEventFlux;\n+            Flux<PartitionEvent> receiver = eventHubConsumer\n+                .receiveFromPartition(claimedOwnership.getPartitionId(), startFromEventPosition, receiveOptions)\n+                .doOnNext(partitionEvent -> {\n+                    if (logger.canLogAtLevel(LogLevel.VERBOSE)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzODE3OA=="}, "originalCommit": {"oid": "83c180dfdd22f3721133e9d993c84849f5facee5"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjYwNzQ4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15852#pullrequestreview-505260748", "createdAt": "2020-10-09T00:22:00Z", "commit": {"oid": "83c180dfdd22f3721133e9d993c84849f5facee5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3151, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}