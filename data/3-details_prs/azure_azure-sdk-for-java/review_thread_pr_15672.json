{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyOTQ3NTcz", "number": 15672, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMjozMzowNlrOEny4BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMjozNDoyM1rOEny4WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTYzNDYxOnYy", "diffSide": "RIGHT", "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/PagedConverter.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMjozMzowNlrOHYkCgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNDozMzoxN1rOHYklaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxODMzOA==", "bodyText": "If use concatMap, is it better to change function name to concatMapPage?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15672#discussion_r495518338", "createdAt": "2020-09-27T02:33:06Z", "author": {"login": "ChenTanyi"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/PagedConverter.java", "diffHunk": "@@ -28,36 +29,58 @@ private PagedConverter() {\n     /**\n      * Applies flatMap transform to elements of PagedFlux.\n      *\n-     * @param <T> input type of pagedFlux\n-     * @param <S> return type of pagedFlux\n-     * @param pagedFlux input\n-     * @param mapper the flatMap transform of element T to Publisher of S.\n-     * @return the PagedFlux.\n+     * @param pagedFlux the input of PagedFlux.\n+     * @param transformer the flatMap transform of element T to Publisher of S.\n+     * @param <T> input type of PagedFlux.\n+     * @param <S> return type of PagedFlux.\n+     * @return the PagedFlux with elements in PagedResponse transformed.\n      */\n     public static <T, S> PagedFlux<S> flatMapPage(PagedFlux<T> pagedFlux,\n-            Function<? super T, ? extends Publisher<? extends S>> mapper) {\n+            Function<? super T, ? extends Publisher<? extends S>> transformer) {\n         Supplier<PageRetriever<String, PagedResponse<S>>> provider = () -> (continuationToken, pageSize) -> {\n             Flux<PagedResponse<T>> flux = (continuationToken == null)\n                     ? pagedFlux.byPage()\n                     : pagedFlux.byPage(continuationToken);\n-            return flux.flatMap(PagedConverter.flatMapPagedResponse(mapper));\n+            return flux.concatMap(PagedConverter.flatMapPagedResponse(transformer));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c72bc8ac1e9f18c5a10ea73316fc19385547a6c9"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMDgzOA==", "bodyText": "the name of flatMapPage is actually about the Function<? super T, ? extends Publisher<? extends S>> mapper transform function. It is map of one to Flux, hence flatMap.\nIt is not about the concatMap on parent PagedFlux, it will always be concatMap, process one page, then next page (lazy fetch by page, allow user cancel in between).", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15672#discussion_r495520838", "createdAt": "2020-09-27T03:07:33Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/PagedConverter.java", "diffHunk": "@@ -28,36 +29,58 @@ private PagedConverter() {\n     /**\n      * Applies flatMap transform to elements of PagedFlux.\n      *\n-     * @param <T> input type of pagedFlux\n-     * @param <S> return type of pagedFlux\n-     * @param pagedFlux input\n-     * @param mapper the flatMap transform of element T to Publisher of S.\n-     * @return the PagedFlux.\n+     * @param pagedFlux the input of PagedFlux.\n+     * @param transformer the flatMap transform of element T to Publisher of S.\n+     * @param <T> input type of PagedFlux.\n+     * @param <S> return type of PagedFlux.\n+     * @return the PagedFlux with elements in PagedResponse transformed.\n      */\n     public static <T, S> PagedFlux<S> flatMapPage(PagedFlux<T> pagedFlux,\n-            Function<? super T, ? extends Publisher<? extends S>> mapper) {\n+            Function<? super T, ? extends Publisher<? extends S>> transformer) {\n         Supplier<PageRetriever<String, PagedResponse<S>>> provider = () -> (continuationToken, pageSize) -> {\n             Flux<PagedResponse<T>> flux = (continuationToken == null)\n                     ? pagedFlux.byPage()\n                     : pagedFlux.byPage(continuationToken);\n-            return flux.flatMap(PagedConverter.flatMapPagedResponse(mapper));\n+            return flux.concatMap(PagedConverter.flatMapPagedResponse(transformer));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxODMzOA=="}, "originalCommit": {"oid": "c72bc8ac1e9f18c5a10ea73316fc19385547a6c9"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyNTQxNw==", "bodyText": "flatMap and concatMap could take same mapper to map flux, the only different is that flatMap do it as soon as possible, but the concatMap will do it one after the previous one finished.\nIf the flatMap and the concatMap behave same in PagedFlux, then it could be OK.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15672#discussion_r495525417", "createdAt": "2020-09-27T04:08:38Z", "author": {"login": "ChenTanyi"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/PagedConverter.java", "diffHunk": "@@ -28,36 +29,58 @@ private PagedConverter() {\n     /**\n      * Applies flatMap transform to elements of PagedFlux.\n      *\n-     * @param <T> input type of pagedFlux\n-     * @param <S> return type of pagedFlux\n-     * @param pagedFlux input\n-     * @param mapper the flatMap transform of element T to Publisher of S.\n-     * @return the PagedFlux.\n+     * @param pagedFlux the input of PagedFlux.\n+     * @param transformer the flatMap transform of element T to Publisher of S.\n+     * @param <T> input type of PagedFlux.\n+     * @param <S> return type of PagedFlux.\n+     * @return the PagedFlux with elements in PagedResponse transformed.\n      */\n     public static <T, S> PagedFlux<S> flatMapPage(PagedFlux<T> pagedFlux,\n-            Function<? super T, ? extends Publisher<? extends S>> mapper) {\n+            Function<? super T, ? extends Publisher<? extends S>> transformer) {\n         Supplier<PageRetriever<String, PagedResponse<S>>> provider = () -> (continuationToken, pageSize) -> {\n             Flux<PagedResponse<T>> flux = (continuationToken == null)\n                     ? pagedFlux.byPage()\n                     : pagedFlux.byPage(continuationToken);\n-            return flux.flatMap(PagedConverter.flatMapPagedResponse(mapper));\n+            return flux.concatMap(PagedConverter.flatMapPagedResponse(transformer));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxODMzOA=="}, "originalCommit": {"oid": "c72bc8ac1e9f18c5a10ea73316fc19385547a6c9"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyNzI3NQ==", "bodyText": "I think we want concatMap here, point here to do one page after another, so we do not eagerly fetch results (and apply the mapper) on next page.\nWithin page, it uses flatMapSequential to process all items eagerly, while still keep the item order.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15672#discussion_r495527275", "createdAt": "2020-09-27T04:33:17Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/PagedConverter.java", "diffHunk": "@@ -28,36 +29,58 @@ private PagedConverter() {\n     /**\n      * Applies flatMap transform to elements of PagedFlux.\n      *\n-     * @param <T> input type of pagedFlux\n-     * @param <S> return type of pagedFlux\n-     * @param pagedFlux input\n-     * @param mapper the flatMap transform of element T to Publisher of S.\n-     * @return the PagedFlux.\n+     * @param pagedFlux the input of PagedFlux.\n+     * @param transformer the flatMap transform of element T to Publisher of S.\n+     * @param <T> input type of PagedFlux.\n+     * @param <S> return type of PagedFlux.\n+     * @return the PagedFlux with elements in PagedResponse transformed.\n      */\n     public static <T, S> PagedFlux<S> flatMapPage(PagedFlux<T> pagedFlux,\n-            Function<? super T, ? extends Publisher<? extends S>> mapper) {\n+            Function<? super T, ? extends Publisher<? extends S>> transformer) {\n         Supplier<PageRetriever<String, PagedResponse<S>>> provider = () -> (continuationToken, pageSize) -> {\n             Flux<PagedResponse<T>> flux = (continuationToken == null)\n                     ? pagedFlux.byPage()\n                     : pagedFlux.byPage(continuationToken);\n-            return flux.flatMap(PagedConverter.flatMapPagedResponse(mapper));\n+            return flux.concatMap(PagedConverter.flatMapPagedResponse(transformer));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxODMzOA=="}, "originalCommit": {"oid": "c72bc8ac1e9f18c5a10ea73316fc19385547a6c9"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTYzNDc3OnYy", "diffSide": "RIGHT", "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/PagedConverter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMjozMzoyNFrOHYkClA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzowOTozOFrOHYkM1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxODM1Ng==", "bodyText": "Same as above", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15672#discussion_r495518356", "createdAt": "2020-09-27T02:33:24Z", "author": {"login": "ChenTanyi"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/PagedConverter.java", "diffHunk": "@@ -28,36 +29,58 @@ private PagedConverter() {\n     /**\n      * Applies flatMap transform to elements of PagedFlux.\n      *\n-     * @param <T> input type of pagedFlux\n-     * @param <S> return type of pagedFlux\n-     * @param pagedFlux input\n-     * @param mapper the flatMap transform of element T to Publisher of S.\n-     * @return the PagedFlux.\n+     * @param pagedFlux the input of PagedFlux.\n+     * @param transformer the flatMap transform of element T to Publisher of S.\n+     * @param <T> input type of PagedFlux.\n+     * @param <S> return type of PagedFlux.\n+     * @return the PagedFlux with elements in PagedResponse transformed.\n      */\n     public static <T, S> PagedFlux<S> flatMapPage(PagedFlux<T> pagedFlux,\n-            Function<? super T, ? extends Publisher<? extends S>> mapper) {\n+            Function<? super T, ? extends Publisher<? extends S>> transformer) {\n         Supplier<PageRetriever<String, PagedResponse<S>>> provider = () -> (continuationToken, pageSize) -> {\n             Flux<PagedResponse<T>> flux = (continuationToken == null)\n                     ? pagedFlux.byPage()\n                     : pagedFlux.byPage(continuationToken);\n-            return flux.flatMap(PagedConverter.flatMapPagedResponse(mapper));\n+            return flux.concatMap(PagedConverter.flatMapPagedResponse(transformer));\n+        };\n+        return PagedFlux.create(provider);\n+    }\n+\n+    /**\n+     * Merge PagedFlux in PagedFlux to a single PagedFlux.\n+     *\n+     * @param pagedFlux the input of PagedFlux.\n+     * @param transformer the transform of element T to PagedFlux of S.\n+     * @param <T> input type of PagedFlux.\n+     * @param <S> return type of PagedFlux.\n+     * @return the merged PagedFlux.\n+     */\n+    public static <T, S> PagedFlux<S> mergePagedFlux(PagedFlux<T> pagedFlux,\n+            Function<? super T, PagedFlux<S>> transformer) {\n+        // one possible issue is that when inner PagedFlux ends, that PagedResponse will have continuationToken == null\n+\n+        Supplier<PageRetriever<String, PagedResponse<S>>> provider = () -> (continuationToken, pageSize) -> {\n+            Flux<PagedResponse<T>> flux = (continuationToken == null)\n+                ? pagedFlux.byPage()\n+                : pagedFlux.byPage(continuationToken);\n+            return flux.concatMap(PagedConverter.mergePagedFluxPagedResponse(transformer));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c72bc8ac1e9f18c5a10ea73316fc19385547a6c9"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMDk4MA==", "bodyText": "This one is actually pretty different from last one. It still process based on parent PagedFlux, here not only transform the element to something, instead it get PagedFlux from each element, then merge all these PagedResponse to a PagedFlux, meantime discarding the parent PagedResponse.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15672#discussion_r495520980", "createdAt": "2020-09-27T03:09:38Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/PagedConverter.java", "diffHunk": "@@ -28,36 +29,58 @@ private PagedConverter() {\n     /**\n      * Applies flatMap transform to elements of PagedFlux.\n      *\n-     * @param <T> input type of pagedFlux\n-     * @param <S> return type of pagedFlux\n-     * @param pagedFlux input\n-     * @param mapper the flatMap transform of element T to Publisher of S.\n-     * @return the PagedFlux.\n+     * @param pagedFlux the input of PagedFlux.\n+     * @param transformer the flatMap transform of element T to Publisher of S.\n+     * @param <T> input type of PagedFlux.\n+     * @param <S> return type of PagedFlux.\n+     * @return the PagedFlux with elements in PagedResponse transformed.\n      */\n     public static <T, S> PagedFlux<S> flatMapPage(PagedFlux<T> pagedFlux,\n-            Function<? super T, ? extends Publisher<? extends S>> mapper) {\n+            Function<? super T, ? extends Publisher<? extends S>> transformer) {\n         Supplier<PageRetriever<String, PagedResponse<S>>> provider = () -> (continuationToken, pageSize) -> {\n             Flux<PagedResponse<T>> flux = (continuationToken == null)\n                     ? pagedFlux.byPage()\n                     : pagedFlux.byPage(continuationToken);\n-            return flux.flatMap(PagedConverter.flatMapPagedResponse(mapper));\n+            return flux.concatMap(PagedConverter.flatMapPagedResponse(transformer));\n+        };\n+        return PagedFlux.create(provider);\n+    }\n+\n+    /**\n+     * Merge PagedFlux in PagedFlux to a single PagedFlux.\n+     *\n+     * @param pagedFlux the input of PagedFlux.\n+     * @param transformer the transform of element T to PagedFlux of S.\n+     * @param <T> input type of PagedFlux.\n+     * @param <S> return type of PagedFlux.\n+     * @return the merged PagedFlux.\n+     */\n+    public static <T, S> PagedFlux<S> mergePagedFlux(PagedFlux<T> pagedFlux,\n+            Function<? super T, PagedFlux<S>> transformer) {\n+        // one possible issue is that when inner PagedFlux ends, that PagedResponse will have continuationToken == null\n+\n+        Supplier<PageRetriever<String, PagedResponse<S>>> provider = () -> (continuationToken, pageSize) -> {\n+            Flux<PagedResponse<T>> flux = (continuationToken == null)\n+                ? pagedFlux.byPage()\n+                : pagedFlux.byPage(continuationToken);\n+            return flux.concatMap(PagedConverter.mergePagedFluxPagedResponse(transformer));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxODM1Ng=="}, "originalCommit": {"oid": "c72bc8ac1e9f18c5a10ea73316fc19385547a6c9"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTYzNTQ0OnYy", "diffSide": "RIGHT", "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/PagedConverter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMjozNDoyM1rOHYkC4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzowNDo0MVrOHYkLcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxODQzMg==", "bodyText": "I think transformer is not better than mapper. Flux has a function transform is different to flatMap", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15672#discussion_r495518432", "createdAt": "2020-09-27T02:34:23Z", "author": {"login": "ChenTanyi"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/PagedConverter.java", "diffHunk": "@@ -28,36 +29,58 @@ private PagedConverter() {\n     /**\n      * Applies flatMap transform to elements of PagedFlux.\n      *\n-     * @param <T> input type of pagedFlux\n-     * @param <S> return type of pagedFlux\n-     * @param pagedFlux input\n-     * @param mapper the flatMap transform of element T to Publisher of S.\n-     * @return the PagedFlux.\n+     * @param pagedFlux the input of PagedFlux.\n+     * @param transformer the flatMap transform of element T to Publisher of S.\n+     * @param <T> input type of PagedFlux.\n+     * @param <S> return type of PagedFlux.\n+     * @return the PagedFlux with elements in PagedResponse transformed.\n      */\n     public static <T, S> PagedFlux<S> flatMapPage(PagedFlux<T> pagedFlux,\n-            Function<? super T, ? extends Publisher<? extends S>> mapper) {\n+            Function<? super T, ? extends Publisher<? extends S>> transformer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c72bc8ac1e9f18c5a10ea73316fc19385547a6c9"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMDYyNA==", "bodyText": "OK. I will still call it mapper.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15672#discussion_r495520624", "createdAt": "2020-09-27T03:04:41Z", "author": {"login": "weidongxu-microsoft"}, "path": "sdk/resourcemanager/azure-resourcemanager-resources/src/main/java/com/azure/resourcemanager/resources/fluentcore/utils/PagedConverter.java", "diffHunk": "@@ -28,36 +29,58 @@ private PagedConverter() {\n     /**\n      * Applies flatMap transform to elements of PagedFlux.\n      *\n-     * @param <T> input type of pagedFlux\n-     * @param <S> return type of pagedFlux\n-     * @param pagedFlux input\n-     * @param mapper the flatMap transform of element T to Publisher of S.\n-     * @return the PagedFlux.\n+     * @param pagedFlux the input of PagedFlux.\n+     * @param transformer the flatMap transform of element T to Publisher of S.\n+     * @param <T> input type of PagedFlux.\n+     * @param <S> return type of PagedFlux.\n+     * @return the PagedFlux with elements in PagedResponse transformed.\n      */\n     public static <T, S> PagedFlux<S> flatMapPage(PagedFlux<T> pagedFlux,\n-            Function<? super T, ? extends Publisher<? extends S>> mapper) {\n+            Function<? super T, ? extends Publisher<? extends S>> transformer) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxODQzMg=="}, "originalCommit": {"oid": "c72bc8ac1e9f18c5a10ea73316fc19385547a6c9"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 893, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}