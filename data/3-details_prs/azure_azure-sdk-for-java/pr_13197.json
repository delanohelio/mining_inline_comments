{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MzY2ODYx", "number": 13197, "title": "support multiple database in azure-spring-data-cosmos", "bodyText": "Support multiple database accounts in azure-spring-data-cosmos  #microsoft/spring-data-cosmosdb#520\n\nTargets this issue: #12713", "createdAt": "2020-07-15T09:39:55Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197", "merged": true, "mergeCommit": {"oid": "84a12d93094a632848a58bac6215e360e0382a37"}, "closed": true, "closedAt": "2020-07-17T19:21:16Z", "author": {"login": "zhoufenqin"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1M51bAFqTQ0OTA5MzIwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc12s9bgFqTQ1MDgwOTUwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDkzMjA4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#pullrequestreview-449093208", "createdAt": "2020-07-15T15:54:52Z", "commit": {"oid": "bc42039403bdaf7c0226787b2c40b8c0ad3275ed"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNTo1NDo1M1rOGyEn4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNjowMzoxN1rOGyE8Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1NzczMQ==", "bodyText": "I think the basePackages name should be com.azure.primarydatasource since we moved the package structure to track 2 library - which is com.azure instead of com.microsoft.azure", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455157731", "createdAt": "2020-07-15T15:54:53Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/README.md", "diffHunk": "@@ -318,6 +318,134 @@ public class SampleApplication implements CommandLineRunner {\n ```\n Autowired UserRepository interface, then can do save, delete and find operations. Spring Data Azure Cosmos DB uses the CosmosTemplate to execute the queries behind *find*, *save* methods. You can use the template yourself for more complex queries.\n \n+## Support multi-database configuration\n+The `azure-spring-data-cosmos` support multi-database configuration, here is a sample to config multiple account database\n+### Add the dependency\n+```xml\n+<dependency>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-spring-data-cosmos</artifactId>\n+    <version>3.0.0-beta.1</version>\n+</dependency>\n+```\n+### Config application properties\n+The example uses the `application.properties` file\n+```properties\n+azure.cosmosdb.primary.uri=your-primary-cosmosDb-uri\n+azure.cosmosdb.primary.key=your-primary-cosmosDb-key\n+azure.cosmosdb.primary.secondaryKey=your-primary-cosmosDb-secondary-key\n+azure.cosmosdb.primary.database=your-primary-cosmosDb-dbName\n+azure.cosmosdb.primary.populateQueryMetrics=if-populate-query-metrics\n+\n+azure.cosmosdb.secondary.uri=your-secondary-cosmosDb-uri\n+azure.cosmosdb.secondary.key=your-secondary-cosmosDb-key\n+azure.cosmosdb.secondary.secondaryKey=your-secondary-cosmosDb-secondary-key\n+azure.cosmosdb.secondary.database=your-secondary-cosmosDb-dbName\n+azure.cosmosdb.secondary.populateQueryMetrics=if-populate-query-metrics\n+```\n+\n+### Define Entities and Repositories\n+The [Entity](https://github.com/Azure/azure-sdk-for-java/tree/master/sdk/cosmos/azure-spring-data-cosmos#create-repositories) definition is same as above.\n+You can put different database entities into different packages.\n+\n+### Setup configuration\n+The `@EnableReactiveCosmosRepositories` or `@EnableCosmosRepositories` support user-define the cosmos template, use `reactiveCosmosTemplateRef` or `cosmosTemplateRef` to config the name of the `ReactiveCosmosTemplate` or `CosmosTemplate` bean to be used with the repositories detected.\n+<!-- embedme src/samples/java/com/azure/cosmos/multidatasource/DatabaseConfiguration.java#L23-L70 -->\n+```java\n+@Configuration\n+@PropertySource(\"classpath:application.properties\")\n+public class DatabaseConfiguration extends AbstractCosmosConfiguration {\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.primary\")\n+    public CosmosDbProperties primaryDataSourceConfiguration() {\n+        return new CosmosDbProperties();\n+    }\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.secondary\")\n+    public CosmosDbProperties secondaryDataSourceConfiguration() {\n+        return new CosmosDbProperties();\n+    }\n+\n+    @EnableReactiveCosmosRepositories(basePackages = \"com.microsoft.azure.primarydatasource\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc42039403bdaf7c0226787b2c40b8c0ad3275ed"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1ODA5OA==", "bodyText": "Same here - pls update basePackages to com.azure.secondarydatasource.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455158098", "createdAt": "2020-07-15T15:55:22Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/README.md", "diffHunk": "@@ -318,6 +318,134 @@ public class SampleApplication implements CommandLineRunner {\n ```\n Autowired UserRepository interface, then can do save, delete and find operations. Spring Data Azure Cosmos DB uses the CosmosTemplate to execute the queries behind *find*, *save* methods. You can use the template yourself for more complex queries.\n \n+## Support multi-database configuration\n+The `azure-spring-data-cosmos` support multi-database configuration, here is a sample to config multiple account database\n+### Add the dependency\n+```xml\n+<dependency>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-spring-data-cosmos</artifactId>\n+    <version>3.0.0-beta.1</version>\n+</dependency>\n+```\n+### Config application properties\n+The example uses the `application.properties` file\n+```properties\n+azure.cosmosdb.primary.uri=your-primary-cosmosDb-uri\n+azure.cosmosdb.primary.key=your-primary-cosmosDb-key\n+azure.cosmosdb.primary.secondaryKey=your-primary-cosmosDb-secondary-key\n+azure.cosmosdb.primary.database=your-primary-cosmosDb-dbName\n+azure.cosmosdb.primary.populateQueryMetrics=if-populate-query-metrics\n+\n+azure.cosmosdb.secondary.uri=your-secondary-cosmosDb-uri\n+azure.cosmosdb.secondary.key=your-secondary-cosmosDb-key\n+azure.cosmosdb.secondary.secondaryKey=your-secondary-cosmosDb-secondary-key\n+azure.cosmosdb.secondary.database=your-secondary-cosmosDb-dbName\n+azure.cosmosdb.secondary.populateQueryMetrics=if-populate-query-metrics\n+```\n+\n+### Define Entities and Repositories\n+The [Entity](https://github.com/Azure/azure-sdk-for-java/tree/master/sdk/cosmos/azure-spring-data-cosmos#create-repositories) definition is same as above.\n+You can put different database entities into different packages.\n+\n+### Setup configuration\n+The `@EnableReactiveCosmosRepositories` or `@EnableCosmosRepositories` support user-define the cosmos template, use `reactiveCosmosTemplateRef` or `cosmosTemplateRef` to config the name of the `ReactiveCosmosTemplate` or `CosmosTemplate` bean to be used with the repositories detected.\n+<!-- embedme src/samples/java/com/azure/cosmos/multidatasource/DatabaseConfiguration.java#L23-L70 -->\n+```java\n+@Configuration\n+@PropertySource(\"classpath:application.properties\")\n+public class DatabaseConfiguration extends AbstractCosmosConfiguration {\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.primary\")\n+    public CosmosDbProperties primaryDataSourceConfiguration() {\n+        return new CosmosDbProperties();\n+    }\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.secondary\")\n+    public CosmosDbProperties secondaryDataSourceConfiguration() {\n+        return new CosmosDbProperties();\n+    }\n+\n+    @EnableReactiveCosmosRepositories(basePackages = \"com.microsoft.azure.primarydatasource\")\n+    public class PrimaryDataSourceConfiguration {\n+        @Autowired\n+        @Qualifier(\"primaryDataSourceConfiguration\")\n+        CosmosDbProperties properties;\n+        @Bean\n+        public CosmosDBConfig cosmosDbConfig() {\n+            CosmosDBConfig cosmosDBConfig = CosmosDBConfig.builder(properties.getUri(),\n+                new CosmosKeyCredential(properties.getKey()),\n+                properties.getDatabase()).build();\n+            cosmosDBConfig.setPopulateQueryMetrics(properties.isPopulateQueryMetrics());\n+            return cosmosDBConfig;\n+        }\n+\n+    }\n+\n+    @EnableReactiveCosmosRepositories(basePackages = \"com.microsoft.azure.secondarydatasource\", reactiveCosmosTemplateRef = \"secondaryReactiveCosmosTemplate\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc42039403bdaf7c0226787b2c40b8c0ad3275ed"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1ODg0NA==", "bodyText": "Typo in class name - SecondaryDataSource1Configuration -> should be SecondaryDataSourceConfiguration", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455158844", "createdAt": "2020-07-15T15:56:34Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/README.md", "diffHunk": "@@ -318,6 +318,134 @@ public class SampleApplication implements CommandLineRunner {\n ```\n Autowired UserRepository interface, then can do save, delete and find operations. Spring Data Azure Cosmos DB uses the CosmosTemplate to execute the queries behind *find*, *save* methods. You can use the template yourself for more complex queries.\n \n+## Support multi-database configuration\n+The `azure-spring-data-cosmos` support multi-database configuration, here is a sample to config multiple account database\n+### Add the dependency\n+```xml\n+<dependency>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-spring-data-cosmos</artifactId>\n+    <version>3.0.0-beta.1</version>\n+</dependency>\n+```\n+### Config application properties\n+The example uses the `application.properties` file\n+```properties\n+azure.cosmosdb.primary.uri=your-primary-cosmosDb-uri\n+azure.cosmosdb.primary.key=your-primary-cosmosDb-key\n+azure.cosmosdb.primary.secondaryKey=your-primary-cosmosDb-secondary-key\n+azure.cosmosdb.primary.database=your-primary-cosmosDb-dbName\n+azure.cosmosdb.primary.populateQueryMetrics=if-populate-query-metrics\n+\n+azure.cosmosdb.secondary.uri=your-secondary-cosmosDb-uri\n+azure.cosmosdb.secondary.key=your-secondary-cosmosDb-key\n+azure.cosmosdb.secondary.secondaryKey=your-secondary-cosmosDb-secondary-key\n+azure.cosmosdb.secondary.database=your-secondary-cosmosDb-dbName\n+azure.cosmosdb.secondary.populateQueryMetrics=if-populate-query-metrics\n+```\n+\n+### Define Entities and Repositories\n+The [Entity](https://github.com/Azure/azure-sdk-for-java/tree/master/sdk/cosmos/azure-spring-data-cosmos#create-repositories) definition is same as above.\n+You can put different database entities into different packages.\n+\n+### Setup configuration\n+The `@EnableReactiveCosmosRepositories` or `@EnableCosmosRepositories` support user-define the cosmos template, use `reactiveCosmosTemplateRef` or `cosmosTemplateRef` to config the name of the `ReactiveCosmosTemplate` or `CosmosTemplate` bean to be used with the repositories detected.\n+<!-- embedme src/samples/java/com/azure/cosmos/multidatasource/DatabaseConfiguration.java#L23-L70 -->\n+```java\n+@Configuration\n+@PropertySource(\"classpath:application.properties\")\n+public class DatabaseConfiguration extends AbstractCosmosConfiguration {\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.primary\")\n+    public CosmosDbProperties primaryDataSourceConfiguration() {\n+        return new CosmosDbProperties();\n+    }\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.secondary\")\n+    public CosmosDbProperties secondaryDataSourceConfiguration() {\n+        return new CosmosDbProperties();\n+    }\n+\n+    @EnableReactiveCosmosRepositories(basePackages = \"com.microsoft.azure.primarydatasource\")\n+    public class PrimaryDataSourceConfiguration {\n+        @Autowired\n+        @Qualifier(\"primaryDataSourceConfiguration\")\n+        CosmosDbProperties properties;\n+        @Bean\n+        public CosmosDBConfig cosmosDbConfig() {\n+            CosmosDBConfig cosmosDBConfig = CosmosDBConfig.builder(properties.getUri(),\n+                new CosmosKeyCredential(properties.getKey()),\n+                properties.getDatabase()).build();\n+            cosmosDBConfig.setPopulateQueryMetrics(properties.isPopulateQueryMetrics());\n+            return cosmosDBConfig;\n+        }\n+\n+    }\n+\n+    @EnableReactiveCosmosRepositories(basePackages = \"com.microsoft.azure.secondarydatasource\", reactiveCosmosTemplateRef = \"secondaryReactiveCosmosTemplate\")\n+    public class SecondaryDataSource1Configuration {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc42039403bdaf7c0226787b2c40b8c0ad3275ed"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2MTg3MA==", "bodyText": "To make it work with the current CI, you will also have to add these SECONDARY_ACCOUNT_HOST as output values in test-resources.json file\nSo as to output these values when we create cosmos db account.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455161870", "createdAt": "2020-07-15T16:01:27Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/test/resources/application.properties", "diffHunk": "@@ -13,3 +13,13 @@ perf.acceptance.percentage=10\n \n # Populate query metrics\n cosmosdb.populateQueryMetrics=true\n+\n+cosmosdb.secondary.uri=${SECONDARY_ACCOUNT_HOST}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc42039403bdaf7c0226787b2c40b8c0ad3275ed"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2Mjc0OA==", "bodyText": "AutoCreateContainer is an annotation property - which supports creating containers automatically in cosmosdb if not exists.\nWhy are we removing this functionality ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455162748", "createdAt": "2020-07-15T16:03:02Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/repository/support/SimpleReactiveCosmosRepository.java", "diffHunk": "@@ -28,22 +27,6 @@\n     private final CosmosEntityInformation<T, K> entityInformation;\n     private final ReactiveCosmosOperations cosmosOperations;\n \n-    /**\n-     * Initialization with metadata and applicationContext will create container if required\n-     *\n-     * @param metadata for entityInformation\n-     * @param applicationContext for cosmosOperations\n-     */\n-    public SimpleReactiveCosmosRepository(CosmosEntityInformation<T, K> metadata,\n-                                          ApplicationContext applicationContext) {\n-        this.cosmosOperations = applicationContext.getBean(ReactiveCosmosOperations.class);\n-        this.entityInformation = metadata;\n-\n-        if (this.entityInformation.isAutoCreateContainer()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc42039403bdaf7c0226787b2c40b8c0ad3275ed"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE2Mjg5MA==", "bodyText": "Same here -\nWhy are we removing this functionality ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455162890", "createdAt": "2020-07-15T16:03:17Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/main/java/com/azure/spring/data/cosmos/repository/support/SimpleCosmosRepository.java", "diffHunk": "@@ -32,22 +31,6 @@\n     private final CosmosOperations operation;\n     private final CosmosEntityInformation<T, ID> information;\n \n-    /**\n-     * Initialization\n-     *\n-     * @param metadata for cosmos entity information\n-     * @param applicationContext to get bean of CosmosOperations class\n-     */\n-    public SimpleCosmosRepository(CosmosEntityInformation<T, ID> metadata,\n-                                  ApplicationContext applicationContext) {\n-        this.operation = applicationContext.getBean(CosmosOperations.class);\n-        this.information = metadata;\n-\n-        if (this.information.isAutoCreateContainer()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc42039403bdaf7c0226787b2c40b8c0ad3275ed"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc42039403bdaf7c0226787b2c40b8c0ad3275ed", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/bc42039403bdaf7c0226787b2c40b8c0ad3275ed", "committedDate": "2020-07-15T09:34:26Z", "message": "support multiple database in azure-spring-data-cosmos"}, "afterCommit": {"oid": "0c3b047c2dabfbe3b8e6e5a5251396638506d224", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0c3b047c2dabfbe3b8e6e5a5251396638506d224", "committedDate": "2020-07-16T01:50:32Z", "message": "support multiple database in azure-spring-data-cosmos"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c3b047c2dabfbe3b8e6e5a5251396638506d224", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0c3b047c2dabfbe3b8e6e5a5251396638506d224", "committedDate": "2020-07-16T01:50:32Z", "message": "support multiple database in azure-spring-data-cosmos"}, "afterCommit": {"oid": "b887df18a3073f98db6bfd9a20751c621debe3b1", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b887df18a3073f98db6bfd9a20751c621debe3b1", "committedDate": "2020-07-16T03:08:46Z", "message": "support multiple database in azure-spring-data-cosmos"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b887df18a3073f98db6bfd9a20751c621debe3b1", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/b887df18a3073f98db6bfd9a20751c621debe3b1", "committedDate": "2020-07-16T03:08:46Z", "message": "support multiple database in azure-spring-data-cosmos"}, "afterCommit": {"oid": "c9fb39ef4c98705c8ba7a9729dee0980979bc38e", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c9fb39ef4c98705c8ba7a9729dee0980979bc38e", "committedDate": "2020-07-16T05:06:17Z", "message": "support multiple database in azure-spring-data-cosmos"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9fb39ef4c98705c8ba7a9729dee0980979bc38e", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c9fb39ef4c98705c8ba7a9729dee0980979bc38e", "committedDate": "2020-07-16T05:06:17Z", "message": "support multiple database in azure-spring-data-cosmos"}, "afterCommit": {"oid": "7b98471d19530bdca028a7217483efb96a712369", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b98471d19530bdca028a7217483efb96a712369", "committedDate": "2020-07-16T06:55:55Z", "message": "support multiple database in azure-spring-data-cosmos"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5ODQ5Mzc4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#pullrequestreview-449849378", "createdAt": "2020-07-16T13:31:07Z", "commit": {"oid": "7b98471d19530bdca028a7217483efb96a712369"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMzozMTowOFrOGyrDTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMzozNToyM1rOGyrOdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc4NzM0Mg==", "bodyText": "Should we look at defining variables for these keys and using those in the additional args instead this really, really long inline expansion?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455787342", "createdAt": "2020-07-16T13:31:08Z", "author": {"login": "JimSuplizio"}, "path": "eng/pipelines/templates/stages/cosmos-sdk-client.yml", "diffHunk": "@@ -106,7 +106,7 @@ stages:\n             JavaTestVersion: '1.8'\n             ProfileFlag: '-P integration-test-emulator'\n             DisplayName: 'Spring Emulator only Integration Tests'\n-            AdditionalArgs: '-DargLine=\"-DACCOUNT_HOST=https://localhost:8081/ -DACCOUNT_KEY=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw== -DSECONDARY_ACCOUNT_KEY=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==\"'\n+            AdditionalArgs: '-DargLine=\"-DACCOUNT_HOST=https://localhost:8081/ -DACCOUNT_KEY=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw== -DSECONDARY_ACCOUNT_KEY=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw== -DNEW_ACCOUNT_HOST=https://localhost:8081/ -DNEW_ACCOUNT_KEY=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw== -DNEW_SECONDARY_ACCOUNT_KEY=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==\"'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b98471d19530bdca028a7217483efb96a712369"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc5MDE5OA==", "bodyText": "This is missing the update tags. You'll want to add the following before the XML start code tag\n[//]: # ({x-version-update-start;com.azure:azure-spring-data-cosmos;current})\nand then add the following after the XML end code tag\n[//]: # ({x-version-update-end})\nThe way the tags are formatted they won't show up unless looking at the raw readme. The version tools use the tags for updating.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r455790198", "createdAt": "2020-07-16T13:35:23Z", "author": {"login": "JimSuplizio"}, "path": "sdk/cosmos/azure-spring-data-cosmos/README.md", "diffHunk": "@@ -318,6 +318,137 @@ public class SampleApplication implements CommandLineRunner {\n ```\n Autowired UserRepository interface, then can do save, delete and find operations. Spring Data Azure Cosmos DB uses the CosmosTemplate to execute the queries behind *find*, *save* methods. You can use the template yourself for more complex queries.\n \n+## Support multi-database configuration\n+The `azure-spring-data-cosmos` support multi-database configuration, here is a sample to config multiple account database\n+\n+### Add the dependency\n+```xml", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b98471d19530bdca028a7217483efb96a712369"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b98471d19530bdca028a7217483efb96a712369", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b98471d19530bdca028a7217483efb96a712369", "committedDate": "2020-07-16T06:55:55Z", "message": "support multiple database in azure-spring-data-cosmos"}, "afterCommit": {"oid": "e0d372248b3aa890a53c26726a7149f5a26227ae", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e0d372248b3aa890a53c26726a7149f5a26227ae", "committedDate": "2020-07-17T02:53:54Z", "message": "support multiple database in azure-spring-data-cosmos"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e0d372248b3aa890a53c26726a7149f5a26227ae", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e0d372248b3aa890a53c26726a7149f5a26227ae", "committedDate": "2020-07-17T02:53:54Z", "message": "support multiple database in azure-spring-data-cosmos"}, "afterCommit": {"oid": "6197bd8e608fae4f2511e1d47af156b39bdba3c3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6197bd8e608fae4f2511e1d47af156b39bdba3c3", "committedDate": "2020-07-17T04:45:23Z", "message": "support multiple database in azure-spring-data-cosmos"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6197bd8e608fae4f2511e1d47af156b39bdba3c3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/6197bd8e608fae4f2511e1d47af156b39bdba3c3", "committedDate": "2020-07-17T04:45:23Z", "message": "support multiple database in azure-spring-data-cosmos"}, "afterCommit": {"oid": "91b6fedadd118166d4542535534e81e21661feac", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/91b6fedadd118166d4542535534e81e21661feac", "committedDate": "2020-07-17T05:06:05Z", "message": "support multiple database in azure-spring-data-cosmos"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzc2Mzkw", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#pullrequestreview-450376390", "createdAt": "2020-07-17T05:11:55Z", "commit": {"oid": "91b6fedadd118166d4542535534e81e21661feac"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNToxMTo1NVrOGzFkNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNToxNTozOFrOGzFoCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyMTc0OQ==", "bodyText": "As part of rebranding, we are updating cosmosdb -> cosmos . That's one of the changes I did in my other PR.\nPlease change these to azure.cosmos.... instead of azure.cosmosdb...", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r456221749", "createdAt": "2020-07-17T05:11:55Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/README.md", "diffHunk": "@@ -334,6 +334,143 @@ public class SampleApplication implements CommandLineRunner {\n ```\n Autowired UserRepository interface, then can do save, delete and find operations. Spring Data Azure Cosmos DB uses the CosmosTemplate to execute the queries behind *find*, *save* methods. You can use the template yourself for more complex queries.\n \n+## Support multi-database configuration\n+The `azure-spring-data-cosmos` support multi-database configuration, here is a sample to config multiple account database\n+\n+### Add the dependency\n+[//]: # ({x-version-update-start;com.azure:azure-spring-data-cosmos;current})\n+```xml\n+<dependency>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-spring-data-cosmos</artifactId>\n+    <version>3.0.0-beta.1</version>\n+</dependency>\n+```\n+[//]: # ({x-version-update-end})\n+\n+### Config application properties\n+The example uses the `application.properties` file\n+```properties\n+azure.cosmosdb.primary.uri=your-primary-cosmosDb-uri\n+azure.cosmosdb.primary.key=your-primary-cosmosDb-key\n+azure.cosmosdb.primary.secondaryKey=your-primary-cosmosDb-secondary-key\n+azure.cosmosdb.primary.database=your-primary-cosmosDb-dbName\n+azure.cosmosdb.primary.populateQueryMetrics=if-populate-query-metrics\n+\n+azure.cosmosdb.secondary.uri=your-secondary-cosmosDb-uri\n+azure.cosmosdb.secondary.key=your-secondary-cosmosDb-key\n+azure.cosmosdb.secondary.secondaryKey=your-secondary-cosmosDb-secondary-key\n+azure.cosmosdb.secondary.database=your-secondary-cosmosDb-dbName\n+azure.cosmosdb.secondary.populateQueryMetrics=if-populate-query-metrics", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b6fedadd118166d4542535534e81e21661feac"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyMTg4Nw==", "bodyText": "also here -> azure.cosmos.secondary", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r456221887", "createdAt": "2020-07-17T05:12:25Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/README.md", "diffHunk": "@@ -334,6 +334,143 @@ public class SampleApplication implements CommandLineRunner {\n ```\n Autowired UserRepository interface, then can do save, delete and find operations. Spring Data Azure Cosmos DB uses the CosmosTemplate to execute the queries behind *find*, *save* methods. You can use the template yourself for more complex queries.\n \n+## Support multi-database configuration\n+The `azure-spring-data-cosmos` support multi-database configuration, here is a sample to config multiple account database\n+\n+### Add the dependency\n+[//]: # ({x-version-update-start;com.azure:azure-spring-data-cosmos;current})\n+```xml\n+<dependency>\n+    <groupId>com.azure</groupId>\n+    <artifactId>azure-spring-data-cosmos</artifactId>\n+    <version>3.0.0-beta.1</version>\n+</dependency>\n+```\n+[//]: # ({x-version-update-end})\n+\n+### Config application properties\n+The example uses the `application.properties` file\n+```properties\n+azure.cosmosdb.primary.uri=your-primary-cosmosDb-uri\n+azure.cosmosdb.primary.key=your-primary-cosmosDb-key\n+azure.cosmosdb.primary.secondaryKey=your-primary-cosmosDb-secondary-key\n+azure.cosmosdb.primary.database=your-primary-cosmosDb-dbName\n+azure.cosmosdb.primary.populateQueryMetrics=if-populate-query-metrics\n+\n+azure.cosmosdb.secondary.uri=your-secondary-cosmosDb-uri\n+azure.cosmosdb.secondary.key=your-secondary-cosmosDb-key\n+azure.cosmosdb.secondary.secondaryKey=your-secondary-cosmosDb-secondary-key\n+azure.cosmosdb.secondary.database=your-secondary-cosmosDb-dbName\n+azure.cosmosdb.secondary.populateQueryMetrics=if-populate-query-metrics\n+```\n+\n+### Define Entities and Repositories\n+The [Entity](https://github.com/Azure/azure-sdk-for-java/tree/master/sdk/cosmos/azure-spring-data-cosmos#create-repositories) definition is same as above.\n+You can put different database entities into different packages.\n+\n+### Setup configuration\n+The `@EnableReactiveCosmosRepositories` or `@EnableCosmosRepositories` support user-define the cosmos template, use `reactiveCosmosTemplateRef` or `cosmosTemplateRef` to config the name of the `ReactiveCosmosTemplate` or `CosmosTemplate` bean to be used with the repositories detected.\n+<!-- embedme src/samples/java/com/azure/cosmos/multidatasource/DatabaseConfiguration.java#L25-L76 -->\n+```java\n+@Configuration\n+@PropertySource(\"classpath:application.properties\")\n+public class DatabaseConfiguration extends AbstractCosmosConfiguration {\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.primary\")\n+    public CosmosProperties primaryDataSourceConfiguration() {\n+        return new CosmosProperties();\n+    }\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.secondary\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b6fedadd118166d4542535534e81e21661feac"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyMjMzNQ==", "bodyText": "Update here -> azure.cosmos.primary", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r456222335", "createdAt": "2020-07-17T05:14:13Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/samples/java/com/azure/cosmos/multidatasource/DatabaseConfiguration.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.multidatasource;\n+\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.CosmosProperties;\n+import com.azure.spring.data.cosmos.CosmosFactory;\n+import com.azure.spring.data.cosmos.config.AbstractCosmosConfiguration;\n+import com.azure.spring.data.cosmos.config.CosmosConfig;\n+import com.azure.spring.data.cosmos.core.ReactiveCosmosTemplate;\n+import com.azure.spring.data.cosmos.core.convert.MappingCosmosConverter;\n+import com.azure.spring.data.cosmos.repository.config.EnableReactiveCosmosRepositories;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.PropertySource;\n+\n+/**\n+ * WARNING: MODIFYING THIS FILE WILL REQUIRE CORRESPONDING UPDATES TO README.md FILE. LINE NUMBERS\n+ * ARE USED TO EXTRACT APPROPRIATE CODE SEGMENTS FROM THIS FILE. ADD NEW CODE AT THE BOTTOM TO AVOID CHANGING\n+ * LINE NUMBERS OF EXISTING CODE SAMPLES.\n+ */\n+@Configuration\n+@PropertySource(\"classpath:application.properties\")\n+public class DatabaseConfiguration extends AbstractCosmosConfiguration {\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.primary\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b6fedadd118166d4542535534e81e21661feac"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyMjM2MA==", "bodyText": "Update here -> azure.cosmos.secondary", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r456222360", "createdAt": "2020-07-17T05:14:19Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/samples/java/com/azure/cosmos/multidatasource/DatabaseConfiguration.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.multidatasource;\n+\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.CosmosProperties;\n+import com.azure.spring.data.cosmos.CosmosFactory;\n+import com.azure.spring.data.cosmos.config.AbstractCosmosConfiguration;\n+import com.azure.spring.data.cosmos.config.CosmosConfig;\n+import com.azure.spring.data.cosmos.core.ReactiveCosmosTemplate;\n+import com.azure.spring.data.cosmos.core.convert.MappingCosmosConverter;\n+import com.azure.spring.data.cosmos.repository.config.EnableReactiveCosmosRepositories;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.PropertySource;\n+\n+/**\n+ * WARNING: MODIFYING THIS FILE WILL REQUIRE CORRESPONDING UPDATES TO README.md FILE. LINE NUMBERS\n+ * ARE USED TO EXTRACT APPROPRIATE CODE SEGMENTS FROM THIS FILE. ADD NEW CODE AT THE BOTTOM TO AVOID CHANGING\n+ * LINE NUMBERS OF EXISTING CODE SAMPLES.\n+ */\n+@Configuration\n+@PropertySource(\"classpath:application.properties\")\n+public class DatabaseConfiguration extends AbstractCosmosConfiguration {\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.primary\")\n+    public CosmosProperties primaryDataSourceConfiguration() {\n+        return new CosmosProperties();\n+    }\n+\n+    @Bean\n+    @ConfigurationProperties(prefix = \"azure.cosmosdb.secondary\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b6fedadd118166d4542535534e81e21661feac"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyMjYxNg==", "bodyText": "We also changed collection -> container.\nCan you please update it here and other places -> users-container", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r456222616", "createdAt": "2020-07-17T05:15:18Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/samples/java/com/azure/cosmos/multidatasource/primarydatasource/User.java", "diffHunk": "@@ -0,0 +1,70 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.multidatasource.primarydatasource;\n+\n+import com.azure.spring.data.cosmos.core.mapping.Document;\n+import com.azure.spring.data.cosmos.core.mapping.PartitionKey;\n+import org.springframework.data.annotation.Id;\n+\n+/**\n+ * WARNING: MODIFYING THIS FILE WILL REQUIRE CORRESPONDING UPDATES TO README.md FILE. LINE NUMBERS\n+ * ARE USED TO EXTRACT APPROPRIATE CODE SEGMENTS FROM THIS FILE. ADD NEW CODE AT THE BOTTOM TO AVOID CHANGING\n+ * LINE NUMBERS OF EXISTING CODE SAMPLES.\n+ */\n+\n+@Document(container = \"users-collection\", ru = \"400\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b6fedadd118166d4542535534e81e21661feac"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyMjczMA==", "bodyText": "Please update to book-container", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#discussion_r456222730", "createdAt": "2020-07-17T05:15:38Z", "author": {"login": "kushagraThapar"}, "path": "sdk/cosmos/azure-spring-data-cosmos/src/samples/java/com/azure/cosmos/multidatasource/secondarydatasource/Book.java", "diffHunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.multidatasource.secondarydatasource;\n+\n+import com.azure.spring.data.cosmos.core.mapping.Document;\n+import org.springframework.data.annotation.Id;\n+\n+/**\n+ * WARNING: MODIFYING THIS FILE WILL REQUIRE CORRESPONDING UPDATES TO README.md FILE. LINE NUMBERS\n+ * ARE USED TO EXTRACT APPROPRIATE CODE SEGMENTS FROM THIS FILE. ADD NEW CODE AT THE BOTTOM TO AVOID CHANGING\n+ * LINE NUMBERS OF EXISTING CODE SAMPLES.\n+ */\n+\n+@Document(container = \"book-collection\", ru = \"400\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b6fedadd118166d4542535534e81e21661feac"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d92dcbc83c8deeea6158ae53667bfa90c1f97327", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d92dcbc83c8deeea6158ae53667bfa90c1f97327", "committedDate": "2020-07-17T06:53:43Z", "message": "support multiple database in azure-spring-data-cosmos"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91b6fedadd118166d4542535534e81e21661feac", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/91b6fedadd118166d4542535534e81e21661feac", "committedDate": "2020-07-17T05:06:05Z", "message": "support multiple database in azure-spring-data-cosmos"}, "afterCommit": {"oid": "d92dcbc83c8deeea6158ae53667bfa90c1f97327", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d92dcbc83c8deeea6158ae53667bfa90c1f97327", "committedDate": "2020-07-17T06:53:43Z", "message": "support multiple database in azure-spring-data-cosmos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c26c2a12df018bbc126c28e5a2701fea681876f0", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c26c2a12df018bbc126c28e5a2701fea681876f0", "committedDate": "2020-07-17T15:45:55Z", "message": "Merge branch 'master' into feature/support-multiple-database-in-spring-data-cosmos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f09f6082d6633d7580f83981b6cdd3a188f0d96", "author": {"user": {"login": "kushagraThapar", "name": "Kushagra Thapar"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4f09f6082d6633d7580f83981b6cdd3a188f0d96", "committedDate": "2020-07-17T16:45:19Z", "message": "Re-exanding parameters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODA5NTA2", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13197#pullrequestreview-450809506", "createdAt": "2020-07-17T16:48:03Z", "commit": {"oid": "4f09f6082d6633d7580f83981b6cdd3a188f0d96"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1263, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}