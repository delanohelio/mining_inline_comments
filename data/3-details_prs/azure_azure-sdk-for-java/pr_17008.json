{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNzkxODM3", "number": 17008, "title": "Fixes rules update.", "bodyText": "Fixes serialization bug for creating and deserializing rules.\nAdds tests for serialization.\n\nFixes #15723", "createdAt": "2020-10-30T06:36:34Z", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17008", "merged": true, "mergeCommit": {"oid": "92ce7dac670215b6217ebfbd61139c86532e845c"}, "closed": true, "closedAt": "2020-10-31T06:15:14Z", "author": {"login": "conniey"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXgx4EAH2gAyNTEyNzkxODM3OjBjNTZkZDc2ZDRjYzdlZGY2ZTBhNjA3ZWUxYjc3YWJlYjk1NTliMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXwTuggFqTUyMTA5NTg3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0c56dd76d4cc7edf6e0a607ee1b77abeb9559b04", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/0c56dd76d4cc7edf6e0a607ee1b77abeb9559b04", "committedDate": "2020-10-30T06:28:56Z", "message": "Moving private method back down."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2e51793c2b2d42e5632381b7db9b8e6d9d6fbc8", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/c2e51793c2b2d42e5632381b7db9b8e6d9d6fbc8", "committedDate": "2020-10-30T06:28:56Z", "message": "Adding serialization tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "582179984449b5985240aa03d3ec1fbe07ebb132", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/582179984449b5985240aa03d3ec1fbe07ebb132", "committedDate": "2020-10-30T06:30:17Z", "message": "Fixing mapping of FalseFilter to FalseFilterImpl."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a71f3c7251f06b346452049e4fc06cb1720f2668", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/a71f3c7251f06b346452049e4fc06cb1720f2668", "committedDate": "2020-10-30T06:30:38Z", "message": "Fixing serialization of RuleProperties."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bc5702fdfd6310a268c08cad749d9a5f86a7941", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/9bc5702fdfd6310a268c08cad749d9a5f86a7941", "committedDate": "2020-10-30T06:30:38Z", "message": "Adding tests for serialization fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0b47f73b2e3fd8a7a65d98274e3a7179f23e43e", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/d0b47f73b2e3fd8a7a65d98274e3a7179f23e43e", "committedDate": "2020-10-30T06:34:17Z", "message": "Adding back retry policy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a821796da950bd0b521aa1f41483479dd32e76c", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/8a821796da950bd0b521aa1f41483479dd32e76c", "committedDate": "2020-10-30T06:43:20Z", "message": "Removing unused method."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTMyMjM1", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17008#pullrequestreview-520932235", "createdAt": "2020-10-30T18:27:00Z", "commit": {"oid": "8a821796da950bd0b521aa1f41483479dd32e76c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyNzowMFrOHrbYYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyNzowMFrOHrbYYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5OTQyNQ==", "bodyText": "Rules might also have ns1 in some cases.", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17008#discussion_r515299425", "createdAt": "2020-10-30T18:27:00Z", "author": {"login": "YijunXieMS"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusManagementSerializer.java", "diffHunk": "@@ -35,21 +39,39 @@\n     public String serialize(Object object, SerializerEncoding encoding) throws IOException {\n         final String contents = jacksonAdapter.serialize(object, encoding);\n \n+        final Class<?> clazz = object.getClass();\n+        if (!CreateQueueBody.class.equals(clazz) && !CreateRuleBody.class.equals(clazz)\n+            && !CreateSubscriptionBody.class.equals(clazz)) {\n+            return contents;\n+        }\n+\n         // This hack exists because the service requires a global namespace for the XML rather than allowing\n         // each XML element to be prefaced with an explicit namespace. For example:\n         // xmlns=\"foo\" works because \"foo\" is assigned the global namespace.\n         // xmlns:ns0=\"foo\", and then prefixing all elements with ns0:AuthorizationRule will break.\n-        if (object instanceof CreateQueueBody) {\n-            final Matcher matcher = NAMESPACE_PATTERN.matcher(contents);\n-            if (matcher.find()) {\n-                final String namespace = matcher.group(\"namespace\");\n-                return contents\n-                    .replaceAll(namespace + \":\", \"\")\n-                    .replace(\"xmlns:\" + namespace + \"=\", \"xmlns=\");\n-            }\n+        final Matcher namespaceMatcher = NAMESPACE_PATTERN.matcher(contents);\n+        if (!namespaceMatcher.find()) {\n+            logger.info(\"Could not find {} in {}\", NAMESPACE_PATTERN.pattern(), contents);\n+            return contents;\n+        }\n+\n+        final String namespace = namespaceMatcher.group(\"namespace\");\n+        final String replaced = contents\n+            .replaceAll(namespace + \":\", \"\")\n+            .replace(\"xmlns:\" + namespace + \"=\", \"xmlns=\");\n+\n+        if (!CreateRuleBody.class.equals(clazz)) {\n+            return replaced;\n         }\n \n-        return contents;\n+        // This hack is here because RuleFilter and RuleAction type=\"Foo\" should have a namespace like n0:type=\"Foo\".\n+        final Matcher filterType = FILTER_ACTION_PATTERN.matcher(replaced);\n+        if (filterType.find()) {\n+            return filterType.replaceAll(\"<$1 xmlns:ns0=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" ns0:type=\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a821796da950bd0b521aa1f41483479dd32e76c"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDc2NDA4", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17008#pullrequestreview-521076408", "createdAt": "2020-10-30T22:55:09Z", "commit": {"oid": "8a821796da950bd0b521aa1f41483479dd32e76c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMjo1NToxMFrOHrieBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMjo1NToxMFrOHrieBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQxNTU1Nw==", "bodyText": "If we could not find namespace pattern , wouldn't this be a error or warning ?", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17008#discussion_r515415557", "createdAt": "2020-10-30T22:55:10Z", "author": {"login": "hemanttanwar"}, "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/ServiceBusManagementSerializer.java", "diffHunk": "@@ -35,21 +39,39 @@\n     public String serialize(Object object, SerializerEncoding encoding) throws IOException {\n         final String contents = jacksonAdapter.serialize(object, encoding);\n \n+        final Class<?> clazz = object.getClass();\n+        if (!CreateQueueBody.class.equals(clazz) && !CreateRuleBody.class.equals(clazz)\n+            && !CreateSubscriptionBody.class.equals(clazz)) {\n+            return contents;\n+        }\n+\n         // This hack exists because the service requires a global namespace for the XML rather than allowing\n         // each XML element to be prefaced with an explicit namespace. For example:\n         // xmlns=\"foo\" works because \"foo\" is assigned the global namespace.\n         // xmlns:ns0=\"foo\", and then prefixing all elements with ns0:AuthorizationRule will break.\n-        if (object instanceof CreateQueueBody) {\n-            final Matcher matcher = NAMESPACE_PATTERN.matcher(contents);\n-            if (matcher.find()) {\n-                final String namespace = matcher.group(\"namespace\");\n-                return contents\n-                    .replaceAll(namespace + \":\", \"\")\n-                    .replace(\"xmlns:\" + namespace + \"=\", \"xmlns=\");\n-            }\n+        final Matcher namespaceMatcher = NAMESPACE_PATTERN.matcher(contents);\n+        if (!namespaceMatcher.find()) {\n+            logger.info(\"Could not find {} in {}\", NAMESPACE_PATTERN.pattern(), contents);\n+            return contents;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a821796da950bd0b521aa1f41483479dd32e76c"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb723983001ee957b6150882efaecde6a57a372a", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/cb723983001ee957b6150882efaecde6a57a372a", "committedDate": "2020-10-30T23:30:06Z", "message": "Add test for creating default rule."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e940492025f0c7c0cb4579d805c0b2e97eae6fdc", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e940492025f0c7c0cb4579d805c0b2e97eae6fdc", "committedDate": "2020-10-30T23:39:45Z", "message": "Adding update method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e34428cfa762b8e961edc585d29301fb80523304", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/e34428cfa762b8e961edc585d29301fb80523304", "committedDate": "2020-10-30T23:42:32Z", "message": "Change to warnings."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bac32fa2336db5cf11ec4af893ad08af42c46be", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/4bac32fa2336db5cf11ec4af893ad08af42c46be", "committedDate": "2020-10-30T23:44:57Z", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into rules-update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "676080bbf8c9da1ba8046cacc82f213bd6002ad6", "author": {"user": {"login": "conniey", "name": "Connie Yau"}}, "url": "https://github.com/Azure/azure-sdk-for-java/commit/676080bbf8c9da1ba8046cacc82f213bd6002ad6", "committedDate": "2020-10-31T00:04:31Z", "message": "Rename to getParameters."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDk1ODc5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17008#pullrequestreview-521095879", "createdAt": "2020-10-31T00:34:29Z", "commit": {"oid": "676080bbf8c9da1ba8046cacc82f213bd6002ad6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1590, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}