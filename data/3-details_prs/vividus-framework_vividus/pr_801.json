{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMjU2NTM4", "number": 801, "title": "Add step adding headers to proxied requests with given URL pattern", "bodyText": "Closes #603", "createdAt": "2020-08-05T09:16:08Z", "url": "https://github.com/vividus-framework/vividus/pull/801", "merged": true, "mergeCommit": {"oid": "14d18cab39862dbd0b199c05753ae2b1ce6a5000"}, "closed": true, "closedAt": "2020-10-06T13:42:09Z", "author": {"login": "ngrudnitsky"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc74OWHAFqTQ2MTUxNDg5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP1SqRgH2gAyNDYzMjU2NTM4OmJlYjk2ZTQ0NDU1NGI0YzRjMDU0YmE0YTU3OTczYTVjYjVmZjgyN2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNTE0ODky", "url": "https://github.com/vividus-framework/vividus/pull/801#pullrequestreview-461514892", "createdAt": "2020-08-05T09:57:57Z", "commit": {"oid": "4f472dc6ae013ebf9010e3347360e7bad0857fa8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwOTo1Nzo1N1rOG8CuSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwOTo1Nzo1N1rOG8CuSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYxMjM2Mg==", "bodyText": "Verification is missing?", "url": "https://github.com/vividus-framework/vividus/pull/801#discussion_r465612362", "createdAt": "2020-08-05T09:57:57Z", "author": {"login": "ikalinin1"}, "path": "vividus-tests/src/main/resources/story/integration/ProxyStepsTests.story", "diffHunk": "@@ -31,3 +31,10 @@ Scenario: Verify step When I wait until HTTP $httpMethod request with URL patter\n Given I am on a page with the URL 'http://httpbin.org/get'\n When I wait until HTTP GET request with URL pattern `http://httpbin.org/get` exists in proxy log\n Then number of HTTP GET requests with URL pattern `http://httpbin.org/get` is EQUAL TO `1`\n+\n+Scenario: Verify step When I add headers:$headers to proxied requests with URL pattern $urlPattern\n+When I add headers to proxied requests with URL pattern `http://httpbin.org/headers`:\n+|name    |value    |\n+|testName|testValue|\n+Given I am on a page with the URL 'http://httpbin.org/headers'\n+When I save response body to the SCENARIO variable 'requestHeaders'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f472dc6ae013ebf9010e3347360e7bad0857fa8"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNTE3ODQ5", "url": "https://github.com/vividus-framework/vividus/pull/801#pullrequestreview-461517849", "createdAt": "2020-08-05T10:02:06Z", "commit": {"oid": "4f472dc6ae013ebf9010e3347360e7bad0857fa8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDowMjowNlrOG8C3Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDowMjowNlrOG8C3Tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYxNDY3MQ==", "bodyText": "String urlPattern why not use some flexible mechanism to match URLs like Patter or StringComparisonRule ?", "url": "https://github.com/vividus-framework/vividus/pull/801#discussion_r465614671", "createdAt": "2020-08-05T10:02:06Z", "author": {"login": "ikalinin1"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -238,6 +241,30 @@ public String toString()\n         });\n     }\n \n+    /**\n+     * Add headers to proxy request that will be used while sending request with given urlPattern\n+     * @param headers ExamplesTable representing list of headers with columns \"name\" and \"value\" specifying HTTP header\n+     * names and values respectively\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     */\n+    @When(\"I add headers to proxied requests with URL pattern `$urlPattern`:$headers\")\n+    public void addHeadersToProxyRequest(ExamplesTable headers, String urlPattern)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f472dc6ae013ebf9010e3347360e7bad0857fa8"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f472dc6ae013ebf9010e3347360e7bad0857fa8", "author": {"user": {"login": "ngrudnitsky", "name": "Nikita Grudnitsky"}}, "url": "https://github.com/vividus-framework/vividus/commit/4f472dc6ae013ebf9010e3347360e7bad0857fa8", "committedDate": "2020-08-05T09:09:43Z", "message": "Add step adding headers to proxied requests with given URL pattern"}, "afterCommit": {"oid": "290237ce59e0014da8957e84e7f15498baa4ad2f", "author": {"user": {"login": "ngrudnitsky", "name": "Nikita Grudnitsky"}}, "url": "https://github.com/vividus-framework/vividus/commit/290237ce59e0014da8957e84e7f15498baa4ad2f", "committedDate": "2020-08-05T11:45:29Z", "message": "Add step adding headers to proxied requests with given URL pattern"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f78097103925022f069363418ec4d97333d4d98f", "author": {"user": {"login": "ngrudnitsky", "name": "Nikita Grudnitsky"}}, "url": "https://github.com/vividus-framework/vividus/commit/f78097103925022f069363418ec4d97333d4d98f", "committedDate": "2020-08-05T13:28:20Z", "message": "Add step adding headers to proxied requests with given URL pattern"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "290237ce59e0014da8957e84e7f15498baa4ad2f", "author": {"user": {"login": "ngrudnitsky", "name": "Nikita Grudnitsky"}}, "url": "https://github.com/vividus-framework/vividus/commit/290237ce59e0014da8957e84e7f15498baa4ad2f", "committedDate": "2020-08-05T11:45:29Z", "message": "Add step adding headers to proxied requests with given URL pattern"}, "afterCommit": {"oid": "f78097103925022f069363418ec4d97333d4d98f", "author": {"user": {"login": "ngrudnitsky", "name": "Nikita Grudnitsky"}}, "url": "https://github.com/vividus-framework/vividus/commit/f78097103925022f069363418ec4d97333d4d98f", "committedDate": "2020-08-05T13:28:20Z", "message": "Add step adding headers to proxied requests with given URL pattern"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMjQzMDE5", "url": "https://github.com/vividus-framework/vividus/pull/801#pullrequestreview-462243019", "createdAt": "2020-08-06T07:12:02Z", "commit": {"oid": "f78097103925022f069363418ec4d97333d4d98f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNzoxMjowMlrOG8mHVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNzoxMjowMlrOG8mHVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5MjIxMg==", "bodyText": "@valfirst  in the current implementation, the filter will be cleared off on before scenario hook.\nIs it expected behavior?\nShouldn't we support filters that will work whole run time? (For example, if we need to pass basic authentication for some of the requests)\nAnd I think we should give the user the possibility to clear the filters via step.", "url": "https://github.com/vividus-framework/vividus/pull/801#discussion_r466192212", "createdAt": "2020-08-06T07:12:02Z", "author": {"login": "ikalinin1"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -238,6 +243,32 @@ public String toString()\n         });\n     }\n \n+    /**\n+     * Add headers to proxy request that will be used while sending request with given urlPattern\n+     * @param headers ExamplesTable representing list of headers with columns \"name\" and \"value\" specifying HTTP header\n+     * names and values respectively\n+     * @param comparisonRule String comparison rule: \"is equal to\", \"contains\", \"does not contain\"\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     */\n+    @When(\"I add headers to proxied requests with URL pattern which $comparisonRule `$urlPattern`:$headers\")\n+    public void addHeadersToProxyRequest(StringComparisonRule comparisonRule, String urlPattern, ExamplesTable headers)\n+    {\n+        DefaultHttpHeaders httpHeaders = new DefaultHttpHeaders();\n+        headers.getRowsAsParameters(true)\n+                .forEach(row -> httpHeaders.add(\n+                        row.valueAs(\"name\", String.class),\n+                        (Object) row.valueAs(\"value\", String.class)\n+                ));\n+        Matcher<String> expected = comparisonRule.createMatcher(urlPattern);\n+        proxy.addRequestFilter((request, contents, messageInfo) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f78097103925022f069363418ec4d97333d4d98f"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5ODU1ODk3", "url": "https://github.com/vividus-framework/vividus/pull/801#pullrequestreview-479855897", "createdAt": "2020-09-01T15:21:12Z", "commit": {"oid": "f78097103925022f069363418ec4d97333d4d98f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5ODYxMzAw", "url": "https://github.com/vividus-framework/vividus/pull/801#pullrequestreview-479861300", "createdAt": "2020-09-01T15:27:01Z", "commit": {"oid": "f78097103925022f069363418ec4d97333d4d98f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNToyNzowMVrOHK792g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNToyNzowMVrOHK792g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzMDI5OA==", "bodyText": "I believe unit test should be expanded a bit to invoke the filter actually (and 2 unit tests will be required: when URL matches and doesn't match to the rule)", "url": "https://github.com/vividus-framework/vividus/pull/801#discussion_r481230298", "createdAt": "2020-09-01T15:27:01Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java", "diffHunk": "@@ -261,6 +267,17 @@ void testWaitRequestInProxyLog()\n                         httpMethod, URL_PATTERN).equals(e.toString())));\n     }\n \n+    @Test\n+    void testAddHeadersToProxyRequest()\n+    {\n+        HttpRequest request = mock(HttpRequest.class);\n+        HttpMessageContents contents = mock(HttpMessageContents.class);\n+        HttpMessageInfo message = mock(HttpMessageInfo.class);\n+        ExamplesTable headers = new ExamplesTable(\"|name|value|\\n|name1|value1|\");\n+        proxySteps.addHeadersToProxyRequest(StringComparisonRule.IS_EQUAL_TO, URL_PATTERN, headers);\n+        verify(proxy).addRequestFilter(argThat(filter -> filter.filterRequest(request, contents, message) == null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f78097103925022f069363418ec4d97333d4d98f"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5ODgyMDE0", "url": "https://github.com/vividus-framework/vividus/pull/801#pullrequestreview-479882014", "createdAt": "2020-09-01T15:49:41Z", "commit": {"oid": "f78097103925022f069363418ec4d97333d4d98f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNTo0OTo0MlrOHK856g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNTo0OTo0MlrOHK856g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI0NTY3NA==", "bodyText": "Please add requirementId", "url": "https://github.com/vividus-framework/vividus/pull/801#discussion_r481245674", "createdAt": "2020-09-01T15:49:42Z", "author": {"login": "ikalinin1"}, "path": "vividus-tests/src/main/resources/story/integration/ProxyStepsTests.story", "diffHunk": "@@ -31,3 +31,18 @@ Scenario: Verify step When I wait until HTTP $httpMethod request with URL patter\n Given I am on a page with the URL 'http://httpbin.org/get'\n When I wait until HTTP GET request with URL pattern `http://httpbin.org/get` exists in proxy log\n Then number of HTTP GET requests with URL pattern `http://httpbin.org/get` is EQUAL TO `1`\n+\n+Scenario: Verify step When I add headers to proxied requests with URL pattern which $comparisonRule `$urlPattern`:$headers", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f78097103925022f069363418ec4d97333d4d98f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9640c50934152d9bedf9b5fb67bb30e7d7d3438d", "author": {"user": {"login": "valfirst", "name": "Valery Yatsynovich"}}, "url": "https://github.com/vividus-framework/vividus/commit/9640c50934152d9bedf9b5fb67bb30e7d7d3438d", "committedDate": "2020-10-06T08:39:44Z", "message": "Merge branch 'master' into proxy-request-headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66895b9c900a9ddd74f60ec3efd79782ca108255", "author": {"user": {"login": "valfirst", "name": "Valery Yatsynovich"}}, "url": "https://github.com/vividus-framework/vividus/commit/66895b9c900a9ddd74f60ec3efd79782ca108255", "committedDate": "2020-10-06T08:44:07Z", "message": "Fix merge issue in docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c90ce574e167e3b99683d87055e2fb5dfa740507", "author": {"user": {"login": "valfirst", "name": "Valery Yatsynovich"}}, "url": "https://github.com/vividus-framework/vividus/commit/c90ce574e167e3b99683d87055e2fb5dfa740507", "committedDate": "2020-10-06T08:45:17Z", "message": "Add requirementId to integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "beb96e444554b4c4c054ba4a57973a5cb5ff827e", "author": {"user": {"login": "valfirst", "name": "Valery Yatsynovich"}}, "url": "https://github.com/vividus-framework/vividus/commit/beb96e444554b4c4c054ba4a57973a5cb5ff827e", "committedDate": "2020-10-06T09:51:27Z", "message": "Add more unit tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 166, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}