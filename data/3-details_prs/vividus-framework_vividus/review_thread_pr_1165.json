{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1ODg1Njc3", "number": 1165, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoxNzoyNlrOE8t5yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoyMDowM1rOE8t94A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMTAyMDg5OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-kafka/src/main/java/org/vividus/bdd/steps/kafka/KafkaSteps.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoxNzoyNlrOH5AYag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoyMTozOVrOH5AjKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzNzEzMA==", "bodyText": "does it make sense to add topics into the log message?", "url": "https://github.com/vividus-framework/vividus/pull/1165#discussion_r529537130", "createdAt": "2020-11-24T13:17:26Z", "author": {"login": "ikalinin1"}, "path": "vividus-plugin-kafka/src/main/java/org/vividus/bdd/steps/kafka/KafkaSteps.java", "diffHunk": "@@ -58,4 +101,88 @@ public void sendData(String data, String topic) throws InterruptedException, Exe\n     {\n         kafkaTemplate.send(topic, data).get(WAIT_TIMEOUT_IN_MINUTES, TimeUnit.MINUTES);\n     }\n+\n+    /**\n+     * Starts the Kafka consumer with the provided configuration to listen the specified topics. The consumer must be\n+     * stopped when it's not needed.\n+     *\n+     * @param topics the comma-separated set of topics to listen\n+     */\n+    @When(\"I start consuming messages from Kafka topics `$topics`\")\n+    public void startKafkaListener(Set<String> topics)\n+    {\n+        BlockingQueue<String> messageQueue = new LinkedBlockingDeque<>();\n+        testContext.put(MESSAGES_KEY, messageQueue);\n+        ContainerProperties containerProperties = new ContainerProperties(topics.toArray(new String[0]));\n+        containerProperties.setMessageListener(\n+                (MessageListener<String, String>) data -> messageQueue.add(data.value()));\n+        KafkaMessageListenerContainer<String, String> container = new KafkaMessageListenerContainer<>(consumerFactory,\n+                containerProperties);\n+        container.start();\n+        testContext.put(LISTENER_KEY, container);\n+        LOGGER.info(\"Kafka message listener is started\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzOTg4MQ==", "bodyText": "the data is logged by kafka client:", "url": "https://github.com/vividus-framework/vividus/pull/1165#discussion_r529539881", "createdAt": "2020-11-24T13:21:39Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-kafka/src/main/java/org/vividus/bdd/steps/kafka/KafkaSteps.java", "diffHunk": "@@ -58,4 +101,88 @@ public void sendData(String data, String topic) throws InterruptedException, Exe\n     {\n         kafkaTemplate.send(topic, data).get(WAIT_TIMEOUT_IN_MINUTES, TimeUnit.MINUTES);\n     }\n+\n+    /**\n+     * Starts the Kafka consumer with the provided configuration to listen the specified topics. The consumer must be\n+     * stopped when it's not needed.\n+     *\n+     * @param topics the comma-separated set of topics to listen\n+     */\n+    @When(\"I start consuming messages from Kafka topics `$topics`\")\n+    public void startKafkaListener(Set<String> topics)\n+    {\n+        BlockingQueue<String> messageQueue = new LinkedBlockingDeque<>();\n+        testContext.put(MESSAGES_KEY, messageQueue);\n+        ContainerProperties containerProperties = new ContainerProperties(topics.toArray(new String[0]));\n+        containerProperties.setMessageListener(\n+                (MessageListener<String, String>) data -> messageQueue.add(data.value()));\n+        KafkaMessageListenerContainer<String, String> container = new KafkaMessageListenerContainer<>(consumerFactory,\n+                containerProperties);\n+        container.start();\n+        testContext.put(LISTENER_KEY, container);\n+        LOGGER.info(\"Kafka message listener is started\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzNzEzMA=="}, "originalCommit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMTAzMTM2OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-kafka/src/main/java/org/vividus/bdd/steps/kafka/KafkaSteps.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoyMDowM1rOH5Aesw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoyOTowOVrOH5A1kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzODczOQ==", "bodyText": "Could you please clarify why the polling duration is a hardcoded value?", "url": "https://github.com/vividus-framework/vividus/pull/1165#discussion_r529538739", "createdAt": "2020-11-24T13:20:03Z", "author": {"login": "ikalinin1"}, "path": "vividus-plugin-kafka/src/main/java/org/vividus/bdd/steps/kafka/KafkaSteps.java", "diffHunk": "@@ -58,4 +101,88 @@ public void sendData(String data, String topic) throws InterruptedException, Exe\n     {\n         kafkaTemplate.send(topic, data).get(WAIT_TIMEOUT_IN_MINUTES, TimeUnit.MINUTES);\n     }\n+\n+    /**\n+     * Starts the Kafka consumer with the provided configuration to listen the specified topics. The consumer must be\n+     * stopped when it's not needed.\n+     *\n+     * @param topics the comma-separated set of topics to listen\n+     */\n+    @When(\"I start consuming messages from Kafka topics `$topics`\")\n+    public void startKafkaListener(Set<String> topics)\n+    {\n+        BlockingQueue<String> messageQueue = new LinkedBlockingDeque<>();\n+        testContext.put(MESSAGES_KEY, messageQueue);\n+        ContainerProperties containerProperties = new ContainerProperties(topics.toArray(new String[0]));\n+        containerProperties.setMessageListener(\n+                (MessageListener<String, String>) data -> messageQueue.add(data.value()));\n+        KafkaMessageListenerContainer<String, String> container = new KafkaMessageListenerContainer<>(consumerFactory,\n+                containerProperties);\n+        container.start();\n+        testContext.put(LISTENER_KEY, container);\n+        LOGGER.info(\"Kafka message listener is started\");\n+    }\n+\n+    /**\n+     * Waits until the count of the consumed messaged (from the consumer start or after the last draining operation)\n+     * matches to the rule or until the timeout is exceeded.\n+     *\n+     * @param timeout        the maximum time to wait for the messages in ISO-8601 format\n+     * @param comparisonRule The rule to compare values\n+     *                       (<i>Possible values:<b> less than, less than or equal to, greater than, greater than or\n+     *                       equal to,\n+     *                       equal to</b></i>)\n+     * @param expectedCount  the expected count of the messages to be matched by the rule\n+     */\n+    @When(\"I wait with `$timeout` timeout until count of consumed Kafka messages is $comparisonRule `$expectedCount`\")\n+    public void waitForKafkaMessages(Duration timeout, ComparisonRule comparisonRule, int expectedCount)\n+    {\n+        Matcher<Integer> countMatcher = comparisonRule.getComparisonRule(expectedCount);\n+        Integer result = new DurationBasedWaiter(timeout, Duration.ofSeconds(1)).wait(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU0MjQ4MA==", "bodyText": "we poll the data from memory (testContext), so it's cheap,\nIMHO, 1 second is a period which could save test time and at the same time it's not so much for humans (like, 1s or 0.5s - it doesn't matter for users)", "url": "https://github.com/vividus-framework/vividus/pull/1165#discussion_r529542480", "createdAt": "2020-11-24T13:25:47Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-kafka/src/main/java/org/vividus/bdd/steps/kafka/KafkaSteps.java", "diffHunk": "@@ -58,4 +101,88 @@ public void sendData(String data, String topic) throws InterruptedException, Exe\n     {\n         kafkaTemplate.send(topic, data).get(WAIT_TIMEOUT_IN_MINUTES, TimeUnit.MINUTES);\n     }\n+\n+    /**\n+     * Starts the Kafka consumer with the provided configuration to listen the specified topics. The consumer must be\n+     * stopped when it's not needed.\n+     *\n+     * @param topics the comma-separated set of topics to listen\n+     */\n+    @When(\"I start consuming messages from Kafka topics `$topics`\")\n+    public void startKafkaListener(Set<String> topics)\n+    {\n+        BlockingQueue<String> messageQueue = new LinkedBlockingDeque<>();\n+        testContext.put(MESSAGES_KEY, messageQueue);\n+        ContainerProperties containerProperties = new ContainerProperties(topics.toArray(new String[0]));\n+        containerProperties.setMessageListener(\n+                (MessageListener<String, String>) data -> messageQueue.add(data.value()));\n+        KafkaMessageListenerContainer<String, String> container = new KafkaMessageListenerContainer<>(consumerFactory,\n+                containerProperties);\n+        container.start();\n+        testContext.put(LISTENER_KEY, container);\n+        LOGGER.info(\"Kafka message listener is started\");\n+    }\n+\n+    /**\n+     * Waits until the count of the consumed messaged (from the consumer start or after the last draining operation)\n+     * matches to the rule or until the timeout is exceeded.\n+     *\n+     * @param timeout        the maximum time to wait for the messages in ISO-8601 format\n+     * @param comparisonRule The rule to compare values\n+     *                       (<i>Possible values:<b> less than, less than or equal to, greater than, greater than or\n+     *                       equal to,\n+     *                       equal to</b></i>)\n+     * @param expectedCount  the expected count of the messages to be matched by the rule\n+     */\n+    @When(\"I wait with `$timeout` timeout until count of consumed Kafka messages is $comparisonRule `$expectedCount`\")\n+    public void waitForKafkaMessages(Duration timeout, ComparisonRule comparisonRule, int expectedCount)\n+    {\n+        Matcher<Integer> countMatcher = comparisonRule.getComparisonRule(expectedCount);\n+        Integer result = new DurationBasedWaiter(timeout, Duration.ofSeconds(1)).wait(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzODczOQ=="}, "originalCommit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU0NDU5NA==", "bodyText": "", "url": "https://github.com/vividus-framework/vividus/pull/1165#discussion_r529544594", "createdAt": "2020-11-24T13:29:09Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-kafka/src/main/java/org/vividus/bdd/steps/kafka/KafkaSteps.java", "diffHunk": "@@ -58,4 +101,88 @@ public void sendData(String data, String topic) throws InterruptedException, Exe\n     {\n         kafkaTemplate.send(topic, data).get(WAIT_TIMEOUT_IN_MINUTES, TimeUnit.MINUTES);\n     }\n+\n+    /**\n+     * Starts the Kafka consumer with the provided configuration to listen the specified topics. The consumer must be\n+     * stopped when it's not needed.\n+     *\n+     * @param topics the comma-separated set of topics to listen\n+     */\n+    @When(\"I start consuming messages from Kafka topics `$topics`\")\n+    public void startKafkaListener(Set<String> topics)\n+    {\n+        BlockingQueue<String> messageQueue = new LinkedBlockingDeque<>();\n+        testContext.put(MESSAGES_KEY, messageQueue);\n+        ContainerProperties containerProperties = new ContainerProperties(topics.toArray(new String[0]));\n+        containerProperties.setMessageListener(\n+                (MessageListener<String, String>) data -> messageQueue.add(data.value()));\n+        KafkaMessageListenerContainer<String, String> container = new KafkaMessageListenerContainer<>(consumerFactory,\n+                containerProperties);\n+        container.start();\n+        testContext.put(LISTENER_KEY, container);\n+        LOGGER.info(\"Kafka message listener is started\");\n+    }\n+\n+    /**\n+     * Waits until the count of the consumed messaged (from the consumer start or after the last draining operation)\n+     * matches to the rule or until the timeout is exceeded.\n+     *\n+     * @param timeout        the maximum time to wait for the messages in ISO-8601 format\n+     * @param comparisonRule The rule to compare values\n+     *                       (<i>Possible values:<b> less than, less than or equal to, greater than, greater than or\n+     *                       equal to,\n+     *                       equal to</b></i>)\n+     * @param expectedCount  the expected count of the messages to be matched by the rule\n+     */\n+    @When(\"I wait with `$timeout` timeout until count of consumed Kafka messages is $comparisonRule `$expectedCount`\")\n+    public void waitForKafkaMessages(Duration timeout, ComparisonRule comparisonRule, int expectedCount)\n+    {\n+        Matcher<Integer> countMatcher = comparisonRule.getComparisonRule(expectedCount);\n+        Integer result = new DurationBasedWaiter(timeout, Duration.ofSeconds(1)).wait(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzODczOQ=="}, "originalCommit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20"}, "originalPosition": 124}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4951, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}