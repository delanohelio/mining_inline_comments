{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4NDE1NTM3", "number": 392, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMDozNzoyNlrODoG1BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNzoxMTowOFrODomrEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMzgxNTA5OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/test/java/org/vividus/spring/StringToIntegerRangeConverterTests.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMDozNzoyNlrOF2eH1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMTo0MToyMVrOF2eZwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDk0OQ==", "bodyText": "the valid port range is 0-65535, shouldn't IntegerRange be renamed to PortsRange? (also additional validations should be added)", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r392660949", "createdAt": "2020-03-15T10:37:26Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-web-app/src/test/java/org/vividus/spring/StringToIntegerRangeConverterTests.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.spring;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.params.provider.Arguments.arguments;\n+\n+import java.util.List;\n+import java.util.stream.Stream;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.vividus.model.IntegerRange;\n+\n+class StringToIntegerRangeConverterTests\n+{\n+    private final StringToIntegerRangeConverter converter = new StringToIntegerRangeConverter();\n+\n+    static Stream<Arguments> rangeSource()\n+    {\n+        return Stream.of(\n+                arguments(\"0..5\", List.of(0, 1, 2, 3, 4, 5)),\n+                arguments(\"4,5\", List.of(4, 5)),\n+                arguments(\"-1..4,3..6\", List.of(-1, 0, 1, 2, 3, 4, 5, 6)),\n+                arguments(\"3..6,-1..4\", List.of(3, 4, 5, 6, -1, 0, 1, 2))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11707c7ad2f95ff943348ff230225695dd4c5dfd"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2NTA4OA==", "bodyText": "The IntegerRange itself I wanted to make generic, as to port verification that's verified in underlying layer by java.net.InetSocketAddress.checkPort(int)", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r392665088", "createdAt": "2020-03-15T11:35:36Z", "author": {"login": "uarlouski"}, "path": "vividus-plugin-web-app/src/test/java/org/vividus/spring/StringToIntegerRangeConverterTests.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.spring;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.params.provider.Arguments.arguments;\n+\n+import java.util.List;\n+import java.util.stream.Stream;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.vividus.model.IntegerRange;\n+\n+class StringToIntegerRangeConverterTests\n+{\n+    private final StringToIntegerRangeConverter converter = new StringToIntegerRangeConverter();\n+\n+    static Stream<Arguments> rangeSource()\n+    {\n+        return Stream.of(\n+                arguments(\"0..5\", List.of(0, 1, 2, 3, 4, 5)),\n+                arguments(\"4,5\", List.of(4, 5)),\n+                arguments(\"-1..4,3..6\", List.of(-1, 0, 1, 2, 3, 4, 5, 6)),\n+                arguments(\"3..6,-1..4\", List.of(3, 4, 5, 6, -1, 0, 1, 2))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDk0OQ=="}, "originalCommit": {"oid": "11707c7ad2f95ff943348ff230225695dd4c5dfd"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2NTUzNw==", "bodyText": "agree, it's better to check ports before they are pulled from the ports pool", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r392665537", "createdAt": "2020-03-15T11:41:21Z", "author": {"login": "uarlouski"}, "path": "vividus-plugin-web-app/src/test/java/org/vividus/spring/StringToIntegerRangeConverterTests.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.spring;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.params.provider.Arguments.arguments;\n+\n+import java.util.List;\n+import java.util.stream.Stream;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.vividus.model.IntegerRange;\n+\n+class StringToIntegerRangeConverterTests\n+{\n+    private final StringToIntegerRangeConverter converter = new StringToIntegerRangeConverter();\n+\n+    static Stream<Arguments> rangeSource()\n+    {\n+        return Stream.of(\n+                arguments(\"0..5\", List.of(0, 1, 2, 3, 4, 5)),\n+                arguments(\"4,5\", List.of(4, 5)),\n+                arguments(\"-1..4,3..6\", List.of(-1, 0, 1, 2, 3, 4, 5, 6)),\n+                arguments(\"3..6,-1..4\", List.of(3, 4, 5, 6, -1, 0, 1, 2))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDk0OQ=="}, "originalCommit": {"oid": "11707c7ad2f95ff943348ff230225695dd4c5dfd"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDEyNDY5OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxOToxODo1NFrOF2gu0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxOToxODo1NFrOF2gu0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcwMzY5Nw==", "bodyText": "toString() is not needed (from SQ :))", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r392703697", "createdAt": "2020-03-15T19:18:54Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "diffHunk": "@@ -16,73 +16,144 @@\n \n package org.vividus.proxy;\n \n-import javax.inject.Inject;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Queue;\n \n import com.browserup.bup.BrowserUpProxy;\n import com.browserup.bup.filters.RequestFilter;\n \n+import org.apache.commons.lang3.Validate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.model.IntegerRange;\n+\n public class ThreadedProxy implements IProxy\n {\n-    @Inject private IProxyServerFactory proxyServerFactory;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ThreadedProxy.class);\n+\n+    private final InetAddress proxyHost;\n+    private final Queue<Integer> proxyPorts;\n+    private final boolean useDefaultPort;\n+    private final ThreadLocal<IProxy> proxy;\n+\n+    public ThreadedProxy(String proxyHost, IntegerRange proxyPorts, IProxyFactory proxyFactory)\n+            throws UnknownHostException\n+    {\n+        List<Integer> proxyPortsRange = proxyPorts.getRange();\n+        if (proxyPortsRange.contains(0))\n+        {\n+            Validate.isTrue(proxyPortsRange.size() == 1,\n+                    \"Port 0 (default port selection) can not be used with custom ports\");\n+            useDefaultPort = true;\n+        }\n+        else\n+        {\n+            useDefaultPort = false;\n+            proxyPortsRange.forEach(ThreadedProxy::validatePort);\n+        }\n+        this.proxyPorts = new LinkedList<>(proxyPortsRange);\n+        this.proxy = ThreadLocal.withInitial(proxyFactory::createProxy);\n+        this.proxyHost = InetAddress.getByName(proxyHost);\n+    }\n \n-    private final ThreadLocal<IProxy> proxy = ThreadLocal.withInitial(() ->\n+    @SuppressWarnings(\"MagicNumber\")\n+    private static void validatePort(int port)\n     {\n-        Proxy proxy = new Proxy();\n-        proxy.setProxyServerFactory(proxyServerFactory);\n-        return proxy;\n-    });\n+        Validate.isTrue(port > 0 && port <= 65535, \"Expected ports range is 1-65535 but got: %d\", port);\n+    }\n \n     @Override\n     public void start()\n     {\n-        proxy.get().start();\n+        if (useDefaultPort)\n+        {\n+            proxy().start();\n+            return;\n+        }\n+        synchronized (proxyPorts)\n+        {\n+            Validate.isTrue(!proxyPorts.isEmpty(), \"There are no available ports in the ports pool\");\n+            int port = proxyPorts.poll();\n+            LOGGER.info(\"Allocate {} port from the proxy ports pool\", port);\n+            logAvailablePorts();\n+            proxy().start(port, proxyHost);\n+        }\n+    }\n+\n+    @Override\n+    public void start(int port, InetAddress address)\n+    {\n+        proxy().start(port, address);\n     }\n \n     @Override\n     public void startRecording()\n     {\n-        proxy.get().startRecording();\n+        proxy().startRecording();\n     }\n \n     @Override\n     public void stopRecording()\n     {\n-        proxy.get().stopRecording();\n+        proxy().stopRecording();\n     }\n \n     @Override\n     public void stop()\n     {\n-        proxy.get().stop();\n+        synchronized (proxyPorts)\n+        {\n+            if (!useDefaultPort)\n+            {\n+                int port = proxy().getProxyServer().getPort();\n+                proxyPorts.add(port);\n+                LOGGER.info(\"Return {} port back to the proxy ports pool\", port);\n+                logAvailablePorts();\n+            }\n+            proxy().stop();\n+        }\n     }\n \n     @Override\n     public boolean isStarted()\n     {\n-        return proxy.get().isStarted();\n+        return proxy().isStarted();\n     }\n \n     @Override\n     public BrowserUpProxy getProxyServer()\n     {\n-        return proxy.get().getProxyServer();\n+        return proxy().getProxyServer();\n     }\n \n     @Override\n     public ProxyLog getLog()\n     {\n-        return proxy.get().getLog();\n+        return proxy().getLog();\n     }\n \n     @Override\n     public void addRequestFilter(RequestFilter requestFilter)\n     {\n-        proxy.get().addRequestFilter(requestFilter);\n+        proxy().addRequestFilter(requestFilter);\n     }\n \n     @Override\n     public void clearRequestFilters()\n     {\n-        proxy.get().clearRequestFilters();\n+        proxy().clearRequestFilters();\n+    }\n+\n+    private void logAvailablePorts()\n+    {\n+        LOGGER.info(\"Available ports for proxies in the pool: {}\", proxyPorts.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "780d1ba62c74ef0588ca6702d4729d12f5ad96ac"}, "originalPosition": 153}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDEyNTQzOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/test/java/org/vividus/proxy/ThreadedProxySystemTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxOToyMDoyNVrOF2gvRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxOToyMDoyNVrOF2gvRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcwMzgxNA==", "bodyText": "should be removed", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r392703814", "createdAt": "2020-03-15T19:20:25Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-web-app/src/test/java/org/vividus/proxy/ThreadedProxySystemTests.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.proxy;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.atLeastOnce;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.time.Duration;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+import com.browserup.bup.BrowserUpProxy;\n+\n+import org.apache.commons.lang3.RandomUtils;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.vividus.model.IntegerRange;\n+import org.vividus.util.Sleeper;\n+\n+class ThreadedProxySystemTests\n+{\n+    @Test\n+    void testAllocatePorts() throws InterruptedException, ExecutionException, UnknownHostException\n+    {\n+        String host = \"localhost\";\n+        InetAddress address = InetAddress.getByName(host);\n+        IntegerRange range = new IntegerRange(Arrays.asList(55023, 53450, 55300));\n+        IProxyFactory proxyFactory = mock(IProxyFactory.class);\n+        ThreadedProxy threadedProxy = new ThreadedProxy(host, range, proxyFactory);\n+\n+        ExecutorService executor = Executors.newFixedThreadPool(3);\n+        Map<String, IProxy> localProxies = mockLocalProxy(3);\n+        Supplier<IProxy> proxyGetter = () -> localProxies.get(Thread.currentThread().getName());\n+        when(proxyFactory.createProxy()).thenAnswer(inv -> proxyGetter.get());\n+\n+        int tasksCount = 50;\n+        List<Callable<Optional<Throwable>>> tasks = new ArrayList<>(tasksCount);\n+        IntStream.range(0, tasksCount).forEach(i -> tasks.add(() ->\n+        {\n+            try\n+            {\n+                IProxy localProxy = proxyGetter.get();\n+                BrowserUpProxy mobProxy = mock(BrowserUpProxy.class);\n+                ArgumentCaptor<Integer> portCapturer = ArgumentCaptor.forClass(Integer.class);\n+\n+                threadedProxy.start();\n+\n+                verify(localProxy, atLeastOnce()).start(portCapturer.capture(), eq(address));\n+                when(localProxy.getProxyServer()).thenReturn(mobProxy);\n+                when(mobProxy.getPort()).thenReturn(portCapturer.getValue());\n+                int timeout = RandomUtils.nextInt(0, 100);\n+                Sleeper.sleep(Duration.ofMillis(timeout));\n+\n+                threadedProxy.stop();\n+            }\n+            catch (Exception | AssertionError e)\n+            {\n+                e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "780d1ba62c74ef0588ca6702d4729d12f5ad96ac"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDEyODk5OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxOToyNjozN1rOF2gxMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxOToyNjozN1rOF2gxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcwNDMwNQ==", "bodyText": "useDefaultPort -> useEphemeralPort", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r392704305", "createdAt": "2020-03-15T19:26:37Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "diffHunk": "@@ -16,73 +16,144 @@\n \n package org.vividus.proxy;\n \n-import javax.inject.Inject;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Queue;\n \n import com.browserup.bup.BrowserUpProxy;\n import com.browserup.bup.filters.RequestFilter;\n \n+import org.apache.commons.lang3.Validate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.model.IntegerRange;\n+\n public class ThreadedProxy implements IProxy\n {\n-    @Inject private IProxyServerFactory proxyServerFactory;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ThreadedProxy.class);\n+\n+    private final InetAddress proxyHost;\n+    private final Queue<Integer> proxyPorts;\n+    private final boolean useDefaultPort;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "780d1ba62c74ef0588ca6702d4729d12f5ad96ac"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDEyOTMxOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxOToyNzoyOVrOF2gxZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxOToyNzoyOVrOF2gxZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcwNDM1OA==", "bodyText": "default -> ephemeral", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r392704358", "createdAt": "2020-03-15T19:27:29Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "diffHunk": "@@ -16,73 +16,144 @@\n \n package org.vividus.proxy;\n \n-import javax.inject.Inject;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Queue;\n \n import com.browserup.bup.BrowserUpProxy;\n import com.browserup.bup.filters.RequestFilter;\n \n+import org.apache.commons.lang3.Validate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.model.IntegerRange;\n+\n public class ThreadedProxy implements IProxy\n {\n-    @Inject private IProxyServerFactory proxyServerFactory;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ThreadedProxy.class);\n+\n+    private final InetAddress proxyHost;\n+    private final Queue<Integer> proxyPorts;\n+    private final boolean useDefaultPort;\n+    private final ThreadLocal<IProxy> proxy;\n+\n+    public ThreadedProxy(String proxyHost, IntegerRange proxyPorts, IProxyFactory proxyFactory)\n+            throws UnknownHostException\n+    {\n+        List<Integer> proxyPortsRange = proxyPorts.getRange();\n+        if (proxyPortsRange.contains(0))\n+        {\n+            Validate.isTrue(proxyPortsRange.size() == 1,\n+                    \"Port 0 (default port selection) can not be used with custom ports\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "780d1ba62c74ef0588ca6702d4729d12f5ad96ac"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDEyOTQ5OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxOToyODowMFrOF2gxgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxOToyODowMFrOF2gxgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcwNDM4Nw==", "bodyText": "no reason to use synchronization if port is not picked up from the pool", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r392704387", "createdAt": "2020-03-15T19:28:00Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "diffHunk": "@@ -16,73 +16,144 @@\n \n package org.vividus.proxy;\n \n-import javax.inject.Inject;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Queue;\n \n import com.browserup.bup.BrowserUpProxy;\n import com.browserup.bup.filters.RequestFilter;\n \n+import org.apache.commons.lang3.Validate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.model.IntegerRange;\n+\n public class ThreadedProxy implements IProxy\n {\n-    @Inject private IProxyServerFactory proxyServerFactory;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ThreadedProxy.class);\n+\n+    private final InetAddress proxyHost;\n+    private final Queue<Integer> proxyPorts;\n+    private final boolean useDefaultPort;\n+    private final ThreadLocal<IProxy> proxy;\n+\n+    public ThreadedProxy(String proxyHost, IntegerRange proxyPorts, IProxyFactory proxyFactory)\n+            throws UnknownHostException\n+    {\n+        List<Integer> proxyPortsRange = proxyPorts.getRange();\n+        if (proxyPortsRange.contains(0))\n+        {\n+            Validate.isTrue(proxyPortsRange.size() == 1,\n+                    \"Port 0 (default port selection) can not be used with custom ports\");\n+            useDefaultPort = true;\n+        }\n+        else\n+        {\n+            useDefaultPort = false;\n+            proxyPortsRange.forEach(ThreadedProxy::validatePort);\n+        }\n+        this.proxyPorts = new LinkedList<>(proxyPortsRange);\n+        this.proxy = ThreadLocal.withInitial(proxyFactory::createProxy);\n+        this.proxyHost = InetAddress.getByName(proxyHost);\n+    }\n \n-    private final ThreadLocal<IProxy> proxy = ThreadLocal.withInitial(() ->\n+    @SuppressWarnings(\"MagicNumber\")\n+    private static void validatePort(int port)\n     {\n-        Proxy proxy = new Proxy();\n-        proxy.setProxyServerFactory(proxyServerFactory);\n-        return proxy;\n-    });\n+        Validate.isTrue(port > 0 && port <= 65535, \"Expected ports range is 1-65535 but got: %d\", port);\n+    }\n \n     @Override\n     public void start()\n     {\n-        proxy.get().start();\n+        if (useDefaultPort)\n+        {\n+            proxy().start();\n+            return;\n+        }\n+        synchronized (proxyPorts)\n+        {\n+            Validate.isTrue(!proxyPorts.isEmpty(), \"There are no available ports in the ports pool\");\n+            int port = proxyPorts.poll();\n+            LOGGER.info(\"Allocate {} port from the proxy ports pool\", port);\n+            logAvailablePorts();\n+            proxy().start(port, proxyHost);\n+        }\n+    }\n+\n+    @Override\n+    public void start(int port, InetAddress address)\n+    {\n+        proxy().start(port, address);\n     }\n \n     @Override\n     public void startRecording()\n     {\n-        proxy.get().startRecording();\n+        proxy().startRecording();\n     }\n \n     @Override\n     public void stopRecording()\n     {\n-        proxy.get().stopRecording();\n+        proxy().stopRecording();\n     }\n \n     @Override\n     public void stop()\n     {\n-        proxy.get().stop();\n+        synchronized (proxyPorts)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "780d1ba62c74ef0588ca6702d4729d12f5ad96ac"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDg1NzU4OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNjo1NDozOVrOF2nYHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNjo1NDozOVrOF2nYHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgxMjU3NA==", "bodyText": "Please use  http://www.slf4j.org/manual.html#fluent", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r392812574", "createdAt": "2020-03-16T06:54:39Z", "author": {"login": "ikalinin1"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "diffHunk": "@@ -16,73 +16,144 @@\n \n package org.vividus.proxy;\n \n-import javax.inject.Inject;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Queue;\n \n import com.browserup.bup.BrowserUpProxy;\n import com.browserup.bup.filters.RequestFilter;\n \n+import org.apache.commons.lang3.Validate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.model.IntegerRange;\n+\n public class ThreadedProxy implements IProxy\n {\n-    @Inject private IProxyServerFactory proxyServerFactory;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ThreadedProxy.class);\n+\n+    private final InetAddress proxyHost;\n+    private final Queue<Integer> proxyPorts;\n+    private final boolean useEphemeralPort;\n+    private final ThreadLocal<IProxy> proxy;\n+\n+    public ThreadedProxy(String proxyHost, IntegerRange proxyPorts, IProxyFactory proxyFactory)\n+            throws UnknownHostException\n+    {\n+        List<Integer> proxyPortsRange = proxyPorts.getRange();\n+        if (proxyPortsRange.contains(0))\n+        {\n+            Validate.isTrue(proxyPortsRange.size() == 1,\n+                    \"Port 0 (ephemeral port selection) can not be used with custom ports\");\n+            useEphemeralPort = true;\n+        }\n+        else\n+        {\n+            useEphemeralPort = false;\n+            proxyPortsRange.forEach(ThreadedProxy::validatePort);\n+        }\n+        this.proxyPorts = new LinkedList<>(proxyPortsRange);\n+        this.proxy = ThreadLocal.withInitial(proxyFactory::createProxy);\n+        this.proxyHost = InetAddress.getByName(proxyHost);\n+    }\n \n-    private final ThreadLocal<IProxy> proxy = ThreadLocal.withInitial(() ->\n+    @SuppressWarnings(\"MagicNumber\")\n+    private static void validatePort(int port)\n     {\n-        Proxy proxy = new Proxy();\n-        proxy.setProxyServerFactory(proxyServerFactory);\n-        return proxy;\n-    });\n+        Validate.isTrue(port > 0 && port <= 65535, \"Expected ports range is 1-65535 but got: %d\", port);\n+    }\n \n     @Override\n     public void start()\n     {\n-        proxy.get().start();\n+        if (useEphemeralPort)\n+        {\n+            proxy().start();\n+            return;\n+        }\n+        synchronized (proxyPorts)\n+        {\n+            Validate.isTrue(!proxyPorts.isEmpty(), \"There are no available ports in the ports pool\");\n+            int port = proxyPorts.poll();\n+            LOGGER.info(\"Allocate {} port from the proxy ports pool\", port);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b491f55e8e74c15bf7c39e4af6322b6e93d3151"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjkyNTQwOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjoxNToyNlrOF27ivg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjoxNToyNlrOF27ivg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE0Mjk3NA==", "bodyText": "to avoid collisions you should stop proxy in synchronized block", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r393142974", "createdAt": "2020-03-16T16:15:26Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "diffHunk": "@@ -16,73 +16,146 @@\n \n package org.vividus.proxy;\n \n-import javax.inject.Inject;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Queue;\n \n import com.browserup.bup.BrowserUpProxy;\n import com.browserup.bup.filters.RequestFilter;\n \n+import org.apache.commons.lang3.Validate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.model.IntegerRange;\n+\n public class ThreadedProxy implements IProxy\n {\n-    @Inject private IProxyServerFactory proxyServerFactory;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ThreadedProxy.class);\n+\n+    private final InetAddress proxyHost;\n+    private final Queue<Integer> proxyPorts;\n+    private final boolean useEphemeralPort;\n+    private final ThreadLocal<IProxy> proxy;\n+\n+    public ThreadedProxy(String proxyHost, IntegerRange proxyPorts, IProxyFactory proxyFactory)\n+            throws UnknownHostException\n+    {\n+        List<Integer> proxyPortsRange = proxyPorts.getRange();\n+        if (proxyPortsRange.contains(0))\n+        {\n+            Validate.isTrue(proxyPortsRange.size() == 1,\n+                    \"Port 0 (ephemeral port selection) can not be used with custom ports\");\n+            useEphemeralPort = true;\n+        }\n+        else\n+        {\n+            useEphemeralPort = false;\n+            proxyPortsRange.forEach(ThreadedProxy::validatePort);\n+        }\n+        this.proxyPorts = new LinkedList<>(proxyPortsRange);\n+        this.proxy = ThreadLocal.withInitial(proxyFactory::createProxy);\n+        this.proxyHost = InetAddress.getByName(proxyHost);\n+    }\n \n-    private final ThreadLocal<IProxy> proxy = ThreadLocal.withInitial(() ->\n+    @SuppressWarnings(\"MagicNumber\")\n+    private static void validatePort(int port)\n     {\n-        Proxy proxy = new Proxy();\n-        proxy.setProxyServerFactory(proxyServerFactory);\n-        return proxy;\n-    });\n+        Validate.isTrue(port > 0 && port <= 65535, \"Expected ports range is 1-65535 but got: %d\", port);\n+    }\n \n     @Override\n     public void start()\n     {\n-        proxy.get().start();\n+        if (useEphemeralPort)\n+        {\n+            proxy().start();\n+            return;\n+        }\n+        synchronized (proxyPorts)\n+        {\n+            Validate.isTrue(!proxyPorts.isEmpty(), \"There are no available ports in the ports pool\");\n+            int port = proxyPorts.poll();\n+            LOGGER.atInfo().log(\"Allocate {} port from the proxy ports pool\", port);\n+            logAvailablePorts();\n+            proxy().start(port, proxyHost);\n+        }\n+    }\n+\n+    @Override\n+    public void start(int port, InetAddress address)\n+    {\n+        proxy().start(port, address);\n     }\n \n     @Override\n     public void startRecording()\n     {\n-        proxy.get().startRecording();\n+        proxy().startRecording();\n     }\n \n     @Override\n     public void stopRecording()\n     {\n-        proxy.get().stopRecording();\n+        proxy().stopRecording();\n     }\n \n     @Override\n     public void stop()\n     {\n-        proxy.get().stop();\n+        if (!useEphemeralPort)\n+        {\n+            synchronized (proxyPorts)\n+            {\n+                int port = proxy().getProxyServer().getPort();\n+                proxyPorts.add(port);\n+                LOGGER.atInfo().log(\"Return {} port back to the proxy ports pool\", port);\n+                logAvailablePorts();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8f6f4c238f5f34e9da70acd1254f8aa65ebec57"}, "originalPosition": 111}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjkzMTQyOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjoxNjo1MVrOF27mlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjoxNjo1MVrOF27mlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE0Mzk1Ng==", "bodyText": "LOGGER.atInfo().addArgument(port).log(\"Return {} port back to the proxy ports pool\");", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r393143956", "createdAt": "2020-03-16T16:16:51Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "diffHunk": "@@ -16,73 +16,146 @@\n \n package org.vividus.proxy;\n \n-import javax.inject.Inject;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Queue;\n \n import com.browserup.bup.BrowserUpProxy;\n import com.browserup.bup.filters.RequestFilter;\n \n+import org.apache.commons.lang3.Validate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.model.IntegerRange;\n+\n public class ThreadedProxy implements IProxy\n {\n-    @Inject private IProxyServerFactory proxyServerFactory;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ThreadedProxy.class);\n+\n+    private final InetAddress proxyHost;\n+    private final Queue<Integer> proxyPorts;\n+    private final boolean useEphemeralPort;\n+    private final ThreadLocal<IProxy> proxy;\n+\n+    public ThreadedProxy(String proxyHost, IntegerRange proxyPorts, IProxyFactory proxyFactory)\n+            throws UnknownHostException\n+    {\n+        List<Integer> proxyPortsRange = proxyPorts.getRange();\n+        if (proxyPortsRange.contains(0))\n+        {\n+            Validate.isTrue(proxyPortsRange.size() == 1,\n+                    \"Port 0 (ephemeral port selection) can not be used with custom ports\");\n+            useEphemeralPort = true;\n+        }\n+        else\n+        {\n+            useEphemeralPort = false;\n+            proxyPortsRange.forEach(ThreadedProxy::validatePort);\n+        }\n+        this.proxyPorts = new LinkedList<>(proxyPortsRange);\n+        this.proxy = ThreadLocal.withInitial(proxyFactory::createProxy);\n+        this.proxyHost = InetAddress.getByName(proxyHost);\n+    }\n \n-    private final ThreadLocal<IProxy> proxy = ThreadLocal.withInitial(() ->\n+    @SuppressWarnings(\"MagicNumber\")\n+    private static void validatePort(int port)\n     {\n-        Proxy proxy = new Proxy();\n-        proxy.setProxyServerFactory(proxyServerFactory);\n-        return proxy;\n-    });\n+        Validate.isTrue(port > 0 && port <= 65535, \"Expected ports range is 1-65535 but got: %d\", port);\n+    }\n \n     @Override\n     public void start()\n     {\n-        proxy.get().start();\n+        if (useEphemeralPort)\n+        {\n+            proxy().start();\n+            return;\n+        }\n+        synchronized (proxyPorts)\n+        {\n+            Validate.isTrue(!proxyPorts.isEmpty(), \"There are no available ports in the ports pool\");\n+            int port = proxyPorts.poll();\n+            LOGGER.atInfo().log(\"Allocate {} port from the proxy ports pool\", port);\n+            logAvailablePorts();\n+            proxy().start(port, proxyHost);\n+        }\n+    }\n+\n+    @Override\n+    public void start(int port, InetAddress address)\n+    {\n+        proxy().start(port, address);\n     }\n \n     @Override\n     public void startRecording()\n     {\n-        proxy.get().startRecording();\n+        proxy().startRecording();\n     }\n \n     @Override\n     public void stopRecording()\n     {\n-        proxy.get().stopRecording();\n+        proxy().stopRecording();\n     }\n \n     @Override\n     public void stop()\n     {\n-        proxy.get().stop();\n+        if (!useEphemeralPort)\n+        {\n+            synchronized (proxyPorts)\n+            {\n+                int port = proxy().getProxyServer().getPort();\n+                proxyPorts.add(port);\n+                LOGGER.atInfo().log(\"Return {} port back to the proxy ports pool\", port);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8f6f4c238f5f34e9da70acd1254f8aa65ebec57"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNzU5NjIwOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxOTowNjoyNVrOF3CNhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxOTowNjoyNVrOF3CNhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI1MjIyOQ==", "bodyText": "LOGGER.atInfo().addArgument(port).log(\"Return {} port back to the proxy ports pool\");", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r393252229", "createdAt": "2020-03-16T19:06:25Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "diffHunk": "@@ -16,73 +16,157 @@\n \n package org.vividus.proxy;\n \n-import javax.inject.Inject;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.function.Supplier;\n \n import com.browserup.bup.BrowserUpProxy;\n import com.browserup.bup.filters.RequestFilter;\n \n+import org.apache.commons.lang3.Validate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.model.IntegerRange;\n+\n public class ThreadedProxy implements IProxy\n {\n-    @Inject private IProxyServerFactory proxyServerFactory;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ThreadedProxy.class);\n+\n+    private final InetAddress proxyHost;\n+    private final Queue<Integer> proxyPorts;\n+    private final boolean useEphemeralPort;\n+    private final ThreadLocal<IProxy> proxy;\n+\n+    public ThreadedProxy(String proxyHost, IntegerRange proxyPorts, IProxyFactory proxyFactory)\n+            throws UnknownHostException\n+    {\n+        List<Integer> proxyPortsRange = proxyPorts.getRange();\n+        if (proxyPortsRange.contains(0))\n+        {\n+            Validate.isTrue(proxyPortsRange.size() == 1,\n+                    \"Port 0 (ephemeral port selection) can not be used with custom ports\");\n+            useEphemeralPort = true;\n+        }\n+        else\n+        {\n+            useEphemeralPort = false;\n+            proxyPortsRange.forEach(ThreadedProxy::validatePort);\n+        }\n+        this.proxyPorts = new LinkedList<>(proxyPortsRange);\n+        this.proxy = ThreadLocal.withInitial(proxyFactory::createProxy);\n+        this.proxyHost = InetAddress.getByName(proxyHost);\n+    }\n \n-    private final ThreadLocal<IProxy> proxy = ThreadLocal.withInitial(() ->\n+    @SuppressWarnings(\"MagicNumber\")\n+    private static void validatePort(int port)\n     {\n-        Proxy proxy = new Proxy();\n-        proxy.setProxyServerFactory(proxyServerFactory);\n-        return proxy;\n-    });\n+        Validate.isTrue(port > 0 && port <= 65535, \"Expected ports range is 1-65535 but got: %d\", port);\n+    }\n \n     @Override\n     public void start()\n     {\n-        proxy.get().start();\n+        perform(() -> proxy().start(), () ->\n+        {\n+            Validate.isTrue(!proxyPorts.isEmpty(), \"There are no available ports in the ports pool\");\n+            int port = proxyPorts.poll();\n+            logMessage(\"Allocate {} port from the proxy ports pool\", () -> port);\n+            logAvailablePorts();\n+            proxy().start(port, proxyHost);\n+        });\n+    }\n+\n+    @Override\n+    public void start(int port, InetAddress address)\n+    {\n+        proxy().start(port, address);\n     }\n \n     @Override\n     public void startRecording()\n     {\n-        proxy.get().startRecording();\n+        proxy().startRecording();\n     }\n \n     @Override\n     public void stopRecording()\n     {\n-        proxy.get().stopRecording();\n+        proxy().stopRecording();\n     }\n \n     @Override\n     public void stop()\n     {\n-        proxy.get().stop();\n+        perform(() -> proxy().stop(), () ->\n+        {\n+            int port = proxy().getProxyServer().getPort();\n+            proxyPorts.add(port);\n+            logMessage(\"Return {} port back to the proxy ports pool\", () -> port);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2952fec8d6edcb1a31592071854375ca4e1f068"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNzU5ODAxOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxOTowNzowOFrOF3COww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxOTowNzowOFrOF3COww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI1MjU0Nw==", "bodyText": "LOGGER.atInfo().addArgument(port).log(\"Allocate {} port from the proxy ports pool\");", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r393252547", "createdAt": "2020-03-16T19:07:08Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/ThreadedProxy.java", "diffHunk": "@@ -16,73 +16,157 @@\n \n package org.vividus.proxy;\n \n-import javax.inject.Inject;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Queue;\n+import java.util.function.Supplier;\n \n import com.browserup.bup.BrowserUpProxy;\n import com.browserup.bup.filters.RequestFilter;\n \n+import org.apache.commons.lang3.Validate;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.model.IntegerRange;\n+\n public class ThreadedProxy implements IProxy\n {\n-    @Inject private IProxyServerFactory proxyServerFactory;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ThreadedProxy.class);\n+\n+    private final InetAddress proxyHost;\n+    private final Queue<Integer> proxyPorts;\n+    private final boolean useEphemeralPort;\n+    private final ThreadLocal<IProxy> proxy;\n+\n+    public ThreadedProxy(String proxyHost, IntegerRange proxyPorts, IProxyFactory proxyFactory)\n+            throws UnknownHostException\n+    {\n+        List<Integer> proxyPortsRange = proxyPorts.getRange();\n+        if (proxyPortsRange.contains(0))\n+        {\n+            Validate.isTrue(proxyPortsRange.size() == 1,\n+                    \"Port 0 (ephemeral port selection) can not be used with custom ports\");\n+            useEphemeralPort = true;\n+        }\n+        else\n+        {\n+            useEphemeralPort = false;\n+            proxyPortsRange.forEach(ThreadedProxy::validatePort);\n+        }\n+        this.proxyPorts = new LinkedList<>(proxyPortsRange);\n+        this.proxy = ThreadLocal.withInitial(proxyFactory::createProxy);\n+        this.proxyHost = InetAddress.getByName(proxyHost);\n+    }\n \n-    private final ThreadLocal<IProxy> proxy = ThreadLocal.withInitial(() ->\n+    @SuppressWarnings(\"MagicNumber\")\n+    private static void validatePort(int port)\n     {\n-        Proxy proxy = new Proxy();\n-        proxy.setProxyServerFactory(proxyServerFactory);\n-        return proxy;\n-    });\n+        Validate.isTrue(port > 0 && port <= 65535, \"Expected ports range is 1-65535 but got: %d\", port);\n+    }\n \n     @Override\n     public void start()\n     {\n-        proxy.get().start();\n+        perform(() -> proxy().start(), () ->\n+        {\n+            Validate.isTrue(!proxyPorts.isEmpty(), \"There are no available ports in the ports pool\");\n+            int port = proxyPorts.poll();\n+            logMessage(\"Allocate {} port from the proxy ports pool\", () -> port);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2952fec8d6edcb1a31592071854375ca4e1f068"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzOTAzMjUxOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-web-app/src/main/java/org/vividus/model/IntegerRange.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNzoxMTowOFrOF3QHhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNzoxMTowOFrOF3QHhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ4MDA3MA==", "bodyText": "Does the set fit better?", "url": "https://github.com/vividus-framework/vividus/pull/392#discussion_r393480070", "createdAt": "2020-03-17T07:11:08Z", "author": {"login": "ikalinin1"}, "path": "vividus-plugin-web-app/src/main/java/org/vividus/model/IntegerRange.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.model;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+public class IntegerRange\n+{\n+    private final List<Integer> range;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d29d75c8eef7a6ca32701ed164f03aeb595c2ea0"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 471, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}