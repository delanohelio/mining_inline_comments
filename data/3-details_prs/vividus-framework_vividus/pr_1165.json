{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1ODg1Njc3", "number": 1165, "title": "[plugin-kafka] Add ability to consume messages from Kafka", "bodyText": "", "createdAt": "2020-11-23T17:27:42Z", "url": "https://github.com/vividus-framework/vividus/pull/1165", "merged": true, "mergeCommit": {"oid": "be2f465a7bcf499661ca85df8b50c1644acda271"}, "closed": true, "closedAt": "2020-11-24T14:34:24Z", "author": {"login": "valfirst"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfZJwLABqjQwMjg5ODc4Mzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfqNoDgFqTUzNzUxNzQ2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7514490e477e55cdd4bde749b1fb6a7a5f115098", "author": {"user": {"login": "valfirst", "name": "Valery Yatsynovich"}}, "url": "https://github.com/vividus-framework/vividus/commit/7514490e477e55cdd4bde749b1fb6a7a5f115098", "committedDate": "2020-11-23T17:26:13Z", "message": "[plugin-kafka] Add ability to consume messages from Kafka"}, "afterCommit": {"oid": "4dd284a1719f91663edcb78d6c86748bcdcc6025", "author": {"user": {"login": "valfirst", "name": "Valery Yatsynovich"}}, "url": "https://github.com/vividus-framework/vividus/commit/4dd284a1719f91663edcb78d6c86748bcdcc6025", "committedDate": "2020-11-23T18:06:51Z", "message": "[plugin-kafka] Add ability to consume messages from Kafka"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4dd284a1719f91663edcb78d6c86748bcdcc6025", "author": {"user": {"login": "valfirst", "name": "Valery Yatsynovich"}}, "url": "https://github.com/vividus-framework/vividus/commit/4dd284a1719f91663edcb78d6c86748bcdcc6025", "committedDate": "2020-11-23T18:06:51Z", "message": "[plugin-kafka] Add ability to consume messages from Kafka"}, "afterCommit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20", "author": {"user": {"login": "valfirst", "name": "Valery Yatsynovich"}}, "url": "https://github.com/vividus-framework/vividus/commit/08f4df72c12676f939a18df3ef582392ebc19e20", "committedDate": "2020-11-24T13:04:32Z", "message": "[plugin-kafka] Add ability to consume messages from Kafka"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NDgwNjk3", "url": "https://github.com/vividus-framework/vividus/pull/1165#pullrequestreview-537480697", "createdAt": "2020-11-24T13:17:25Z", "commit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoxNzoyNlrOH5AYag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoxNzoyNlrOH5AYag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzNzEzMA==", "bodyText": "does it make sense to add topics into the log message?", "url": "https://github.com/vividus-framework/vividus/pull/1165#discussion_r529537130", "createdAt": "2020-11-24T13:17:26Z", "author": {"login": "ikalinin1"}, "path": "vividus-plugin-kafka/src/main/java/org/vividus/bdd/steps/kafka/KafkaSteps.java", "diffHunk": "@@ -58,4 +101,88 @@ public void sendData(String data, String topic) throws InterruptedException, Exe\n     {\n         kafkaTemplate.send(topic, data).get(WAIT_TIMEOUT_IN_MINUTES, TimeUnit.MINUTES);\n     }\n+\n+    /**\n+     * Starts the Kafka consumer with the provided configuration to listen the specified topics. The consumer must be\n+     * stopped when it's not needed.\n+     *\n+     * @param topics the comma-separated set of topics to listen\n+     */\n+    @When(\"I start consuming messages from Kafka topics `$topics`\")\n+    public void startKafkaListener(Set<String> topics)\n+    {\n+        BlockingQueue<String> messageQueue = new LinkedBlockingDeque<>();\n+        testContext.put(MESSAGES_KEY, messageQueue);\n+        ContainerProperties containerProperties = new ContainerProperties(topics.toArray(new String[0]));\n+        containerProperties.setMessageListener(\n+                (MessageListener<String, String>) data -> messageQueue.add(data.value()));\n+        KafkaMessageListenerContainer<String, String> container = new KafkaMessageListenerContainer<>(consumerFactory,\n+                containerProperties);\n+        container.start();\n+        testContext.put(LISTENER_KEY, container);\n+        LOGGER.info(\"Kafka message listener is started\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NDgyODcw", "url": "https://github.com/vividus-framework/vividus/pull/1165#pullrequestreview-537482870", "createdAt": "2020-11-24T13:20:03Z", "commit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoyMDowM1rOH5Aesw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzoyMDowM1rOH5Aesw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzODczOQ==", "bodyText": "Could you please clarify why the polling duration is a hardcoded value?", "url": "https://github.com/vividus-framework/vividus/pull/1165#discussion_r529538739", "createdAt": "2020-11-24T13:20:03Z", "author": {"login": "ikalinin1"}, "path": "vividus-plugin-kafka/src/main/java/org/vividus/bdd/steps/kafka/KafkaSteps.java", "diffHunk": "@@ -58,4 +101,88 @@ public void sendData(String data, String topic) throws InterruptedException, Exe\n     {\n         kafkaTemplate.send(topic, data).get(WAIT_TIMEOUT_IN_MINUTES, TimeUnit.MINUTES);\n     }\n+\n+    /**\n+     * Starts the Kafka consumer with the provided configuration to listen the specified topics. The consumer must be\n+     * stopped when it's not needed.\n+     *\n+     * @param topics the comma-separated set of topics to listen\n+     */\n+    @When(\"I start consuming messages from Kafka topics `$topics`\")\n+    public void startKafkaListener(Set<String> topics)\n+    {\n+        BlockingQueue<String> messageQueue = new LinkedBlockingDeque<>();\n+        testContext.put(MESSAGES_KEY, messageQueue);\n+        ContainerProperties containerProperties = new ContainerProperties(topics.toArray(new String[0]));\n+        containerProperties.setMessageListener(\n+                (MessageListener<String, String>) data -> messageQueue.add(data.value()));\n+        KafkaMessageListenerContainer<String, String> container = new KafkaMessageListenerContainer<>(consumerFactory,\n+                containerProperties);\n+        container.start();\n+        testContext.put(LISTENER_KEY, container);\n+        LOGGER.info(\"Kafka message listener is started\");\n+    }\n+\n+    /**\n+     * Waits until the count of the consumed messaged (from the consumer start or after the last draining operation)\n+     * matches to the rule or until the timeout is exceeded.\n+     *\n+     * @param timeout        the maximum time to wait for the messages in ISO-8601 format\n+     * @param comparisonRule The rule to compare values\n+     *                       (<i>Possible values:<b> less than, less than or equal to, greater than, greater than or\n+     *                       equal to,\n+     *                       equal to</b></i>)\n+     * @param expectedCount  the expected count of the messages to be matched by the rule\n+     */\n+    @When(\"I wait with `$timeout` timeout until count of consumed Kafka messages is $comparisonRule `$expectedCount`\")\n+    public void waitForKafkaMessages(Duration timeout, ComparisonRule comparisonRule, int expectedCount)\n+    {\n+        Matcher<Integer> countMatcher = comparisonRule.getComparisonRule(expectedCount);\n+        Integer result = new DurationBasedWaiter(timeout, Duration.ofSeconds(1)).wait(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20"}, "originalPosition": 124}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7778474e991012caef33f8abfa7c8bca2052a66", "author": {"user": {"login": "valfirst", "name": "Valery Yatsynovich"}}, "url": "https://github.com/vividus-framework/vividus/commit/e7778474e991012caef33f8abfa7c8bca2052a66", "committedDate": "2020-11-24T13:50:15Z", "message": "[plugin-kafka] Add ability to consume messages from Kafka"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20", "author": {"user": {"login": "valfirst", "name": "Valery Yatsynovich"}}, "url": "https://github.com/vividus-framework/vividus/commit/08f4df72c12676f939a18df3ef582392ebc19e20", "committedDate": "2020-11-24T13:04:32Z", "message": "[plugin-kafka] Add ability to consume messages from Kafka"}, "afterCommit": {"oid": "e7778474e991012caef33f8abfa7c8bca2052a66", "author": {"user": {"login": "valfirst", "name": "Valery Yatsynovich"}}, "url": "https://github.com/vividus-framework/vividus/commit/e7778474e991012caef33f8abfa7c8bca2052a66", "committedDate": "2020-11-24T13:50:15Z", "message": "[plugin-kafka] Add ability to consume messages from Kafka"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NTE2Nzg2", "url": "https://github.com/vividus-framework/vividus/pull/1165#pullrequestreview-537516786", "createdAt": "2020-11-24T13:59:08Z", "commit": {"oid": "08f4df72c12676f939a18df3ef582392ebc19e20"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NTE3NDY0", "url": "https://github.com/vividus-framework/vividus/pull/1165#pullrequestreview-537517464", "createdAt": "2020-11-24T13:59:47Z", "commit": {"oid": "e7778474e991012caef33f8abfa7c8bca2052a66"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4740, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}