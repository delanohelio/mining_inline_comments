{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MTA3NjY0", "number": 1178, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDoyMzowMVrOE9p9xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTo1OTowMVrOFAIVgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDg2MTQ4OnYy", "diffSide": "RIGHT", "path": "vividus-extension-selenium/src/main/java/org/vividus/selenium/AbstractDesiredCapabilitiesConfigurer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDoyMzowMlrOH6dcEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDoyMzowMlrOH6dcEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2MTc3OA==", "bodyText": "tunnellingEnabled", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531061778", "createdAt": "2020-11-26T14:23:02Z", "author": {"login": "valfirst"}, "path": "vividus-extension-selenium/src/main/java/org/vividus/selenium/AbstractDesiredCapabilitiesConfigurer.java", "diffHunk": "@@ -19,18 +19,31 @@\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Optional;\n+import java.util.function.Consumer;\n \n+import com.google.common.eventbus.Subscribe;\n+\n+import org.openqa.selenium.Proxy;\n+import org.openqa.selenium.remote.CapabilityType;\n import org.openqa.selenium.remote.DesiredCapabilities;\n import org.vividus.bdd.context.IBddRunContext;\n import org.vividus.bdd.model.RunningStory;\n+import org.vividus.selenium.event.WebDriverQuitEvent;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.selenium.tunnel.TunnelOptions;\n \n-public abstract class AbstractDesiredCapabilitiesConfigurer implements DesiredCapabilitiesConfigurer\n+public abstract class AbstractDesiredCapabilitiesConfigurer<T extends TunnelOptions>\n+        implements DesiredCapabilitiesConfigurer\n {\n     private final IBddRunContext bddRunContext;\n+    private final TunnelManager<T> tunnelManager;\n+\n+    private boolean tunnelEnabled;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a532ca467d1f2a28bca41e1e46603a12ea3331fc"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDg2NzQ4OnYy", "diffSide": "RIGHT", "path": "vividus-extension-selenium/src/main/java/org/vividus/selenium/AbstractDesiredCapabilitiesConfigurer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDoyNDoyOVrOH6dfrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDoyNDoyOVrOH6dfrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2MjcwMQ==", "bodyText": "stopTunnel", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531062701", "createdAt": "2020-11-26T14:24:29Z", "author": {"login": "valfirst"}, "path": "vividus-extension-selenium/src/main/java/org/vividus/selenium/AbstractDesiredCapabilitiesConfigurer.java", "diffHunk": "@@ -51,4 +64,35 @@ protected void configureTestName(DesiredCapabilities desiredCapabilities, String\n                 .map(RunningStory::getName)\n                 .ifPresent(name -> putNestedCapability(desiredCapabilities, parentKey, testNameKey, name));\n     }\n+\n+    protected void configureTunnel(DesiredCapabilities desiredCapabilities, Consumer<String> tunnelIdConsumer)\n+    {\n+        Proxy proxy = (Proxy) desiredCapabilities.getCapability(CapabilityType.PROXY);\n+        if (tunnelEnabled || proxy != null)\n+        {\n+            T options = createOptions();\n+            if (proxy != null)\n+            {\n+                options.setProxy(proxy.getHttpProxy());\n+            }\n+\n+            String tunnelId = tunnelManager.start(options);\n+            desiredCapabilities.setCapability(CapabilityType.PROXY, (Object) null);\n+\n+            tunnelIdConsumer.accept(tunnelId);\n+        }\n+    }\n+\n+    protected abstract T createOptions();\n+\n+    @Subscribe\n+    public void stopSauceConnect(WebDriverQuitEvent event)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a532ca467d1f2a28bca41e1e46603a12ea3331fc"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDg4MDkwOnYy", "diffSide": "RIGHT", "path": "vividus-extension-selenium/src/main/java/org/vividus/selenium/AbstractDesiredCapabilitiesConfigurer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDoyNzoyOFrOH6dnvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDoyNzoyOFrOH6dnvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2NDc2NQ==", "bodyText": "Why is Selenium configurer bind to tunnelling? What about usual Selenium Grid based on Docker? it doesn't support tunnelling", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531064765", "createdAt": "2020-11-26T14:27:28Z", "author": {"login": "valfirst"}, "path": "vividus-extension-selenium/src/main/java/org/vividus/selenium/AbstractDesiredCapabilitiesConfigurer.java", "diffHunk": "@@ -19,18 +19,31 @@\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Optional;\n+import java.util.function.Consumer;\n \n+import com.google.common.eventbus.Subscribe;\n+\n+import org.openqa.selenium.Proxy;\n+import org.openqa.selenium.remote.CapabilityType;\n import org.openqa.selenium.remote.DesiredCapabilities;\n import org.vividus.bdd.context.IBddRunContext;\n import org.vividus.bdd.model.RunningStory;\n+import org.vividus.selenium.event.WebDriverQuitEvent;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.selenium.tunnel.TunnelOptions;\n \n-public abstract class AbstractDesiredCapabilitiesConfigurer implements DesiredCapabilitiesConfigurer\n+public abstract class AbstractDesiredCapabilitiesConfigurer<T extends TunnelOptions>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDkwNDM5OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackCapabilitiesConfigurer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozMzoxM1rOH6d1yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNToxNjo1NFrOH6feEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2ODM2MA==", "bodyText": "is it required? isn't localIdentifier  enough?", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531068360", "createdAt": "2020-11-26T14:33:13Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackCapabilitiesConfigurer.java", "diffHunk": "@@ -20,26 +20,49 @@\n import org.vividus.bdd.context.IBddRunContext;\n import org.vividus.selenium.AbstractDesiredCapabilitiesConfigurer;\n \n-public class BrowserStackCapabilitiesConfigurer extends AbstractDesiredCapabilitiesConfigurer\n+public class BrowserStackCapabilitiesConfigurer extends AbstractDesiredCapabilitiesConfigurer<BrowserStackLocalOptions>\n {\n+    private static final String BSTACK_KEY = \"bstack:options\";\n+\n     private boolean browserStackEnabled;\n+    private String skipUrlsPattern;\n \n-    public BrowserStackCapabilitiesConfigurer(IBddRunContext bddRunContext)\n+    public BrowserStackCapabilitiesConfigurer(IBddRunContext bddRunContext,\n+            BrowserStackLocalManager browserStackLocalManager)\n     {\n-        super(bddRunContext);\n+        super(bddRunContext, browserStackLocalManager);\n     }\n \n     @Override\n     public void configure(DesiredCapabilities desiredCapabilities)\n     {\n         if (browserStackEnabled)\n         {\n-            configureTestName(desiredCapabilities, \"bstack:options\", \"sessionName\");\n+            configureTunnel(desiredCapabilities, tunnelId ->\n+            {\n+                putNestedCapability(desiredCapabilities, BSTACK_KEY, \"local\", true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA5NTA1OQ==", "bodyText": "yes, both local and localId are required", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531095059", "createdAt": "2020-11-26T15:16:54Z", "author": {"login": "uarlouski"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackCapabilitiesConfigurer.java", "diffHunk": "@@ -20,26 +20,49 @@\n import org.vividus.bdd.context.IBddRunContext;\n import org.vividus.selenium.AbstractDesiredCapabilitiesConfigurer;\n \n-public class BrowserStackCapabilitiesConfigurer extends AbstractDesiredCapabilitiesConfigurer\n+public class BrowserStackCapabilitiesConfigurer extends AbstractDesiredCapabilitiesConfigurer<BrowserStackLocalOptions>\n {\n+    private static final String BSTACK_KEY = \"bstack:options\";\n+\n     private boolean browserStackEnabled;\n+    private String skipUrlsPattern;\n \n-    public BrowserStackCapabilitiesConfigurer(IBddRunContext bddRunContext)\n+    public BrowserStackCapabilitiesConfigurer(IBddRunContext bddRunContext,\n+            BrowserStackLocalManager browserStackLocalManager)\n     {\n-        super(bddRunContext);\n+        super(bddRunContext, browserStackLocalManager);\n     }\n \n     @Override\n     public void configure(DesiredCapabilities desiredCapabilities)\n     {\n         if (browserStackEnabled)\n         {\n-            configureTestName(desiredCapabilities, \"bstack:options\", \"sessionName\");\n+            configureTunnel(desiredCapabilities, tunnelId ->\n+            {\n+                putNestedCapability(desiredCapabilities, BSTACK_KEY, \"local\", true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2ODM2MA=="}, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDkwNTk5OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackCapabilitiesConfigurer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozMzozN1rOH6d20A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozMzozN1rOH6d20A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2ODYyNA==", "bodyText": "BSTACK_KEY -> BSTACK_OPTIONS", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531068624", "createdAt": "2020-11-26T14:33:37Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackCapabilitiesConfigurer.java", "diffHunk": "@@ -20,26 +20,49 @@\n import org.vividus.bdd.context.IBddRunContext;\n import org.vividus.selenium.AbstractDesiredCapabilitiesConfigurer;\n \n-public class BrowserStackCapabilitiesConfigurer extends AbstractDesiredCapabilitiesConfigurer\n+public class BrowserStackCapabilitiesConfigurer extends AbstractDesiredCapabilitiesConfigurer<BrowserStackLocalOptions>\n {\n+    private static final String BSTACK_KEY = \"bstack:options\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDkxMDUxOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalException.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozNDozMlrOH6d5Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxODoxNDo1NFrOH6kjAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2OTI2Ng==", "bodyText": "why is RuntimeException ?", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531069266", "createdAt": "2020-11-26T14:34:32Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalException.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+public class BrowserStackLocalException extends RuntimeException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwNjMyMg==", "bodyText": "why not? anyway we should fail fast if something wrong happened with BS", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531106322", "createdAt": "2020-11-26T15:35:59Z", "author": {"login": "uarlouski"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalException.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+public class BrowserStackLocalException extends RuntimeException", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2OTI2Ng=="}, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE3ODI0MA==", "bodyText": "it would be better to have a single checked exception for both SL and BS, like: TunnelStartException", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531178240", "createdAt": "2020-11-26T18:14:54Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalException.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+public class BrowserStackLocalException extends RuntimeException", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2OTI2Ng=="}, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDkxMjAwOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozNDo1M1rOH6d6Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozNDo1M1rOH6d6Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2OTQ5OA==", "bodyText": "it's not saucelabs", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531069498", "createdAt": "2020-11-26T14:34:53Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+import org.vividus.util.wait.RetryTimesBasedWaiter;\n+\n+public class BrowserStackLocalManager implements TunnelManager<BrowserStackLocalOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String sauceLabsAccessKey;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDkyMDQwOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozNjo1NlrOH6d_QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxODoxNzoyOFrOH6kmJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA3MDc4NA==", "bodyText": "why is it outside synchronized block?", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531070784", "createdAt": "2020-11-26T14:36:56Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+import org.vividus.util.wait.RetryTimesBasedWaiter;\n+\n+public class BrowserStackLocalManager implements TunnelManager<BrowserStackLocalOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String sauceLabsAccessKey;\n+    private final TestContext testContext;\n+\n+    public BrowserStackLocalManager(String sauceLabsAccessKey, TestContext testContext)\n+    {\n+        this.sauceLabsAccessKey = sauceLabsAccessKey;\n+        this.testContext = testContext;\n+    }\n+\n+    private final Map<BrowserStackLocalOptions, BrowserStackLocalConnection> activeConnections = new HashMap<>();\n+\n+    @Override\n+    public String start(BrowserStackLocalOptions options)\n+    {\n+        BrowserStackLocalConnection connection = getCurrentConnection();\n+        if (connection == null)\n+        {\n+            try\n+            {\n+                connection = activeConnections.get(options);\n+                if (connection == null)\n+                {\n+                    synchronized (activeConnections)\n+                    {\n+                        connection = activeConnections.get(options);\n+                        if (connection != null)\n+                        {\n+                            putCurrentConnection(connection);\n+                            connection.waitForStart();\n+                            return connection.getLocalIdentifier();\n+                        }\n+                        connection = new BrowserStackLocalConnection(options);\n+                        putCurrentConnection(connection);\n+                        activeConnections.put(options, connection);\n+                    }\n+                }\n+                connection.startConnection();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwODYyMQ==", "bodyText": "each thread with different options has its own Local instance, if options are the same, other threads will not reach this point", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531108621", "createdAt": "2020-11-26T15:39:57Z", "author": {"login": "uarlouski"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+import org.vividus.util.wait.RetryTimesBasedWaiter;\n+\n+public class BrowserStackLocalManager implements TunnelManager<BrowserStackLocalOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String sauceLabsAccessKey;\n+    private final TestContext testContext;\n+\n+    public BrowserStackLocalManager(String sauceLabsAccessKey, TestContext testContext)\n+    {\n+        this.sauceLabsAccessKey = sauceLabsAccessKey;\n+        this.testContext = testContext;\n+    }\n+\n+    private final Map<BrowserStackLocalOptions, BrowserStackLocalConnection> activeConnections = new HashMap<>();\n+\n+    @Override\n+    public String start(BrowserStackLocalOptions options)\n+    {\n+        BrowserStackLocalConnection connection = getCurrentConnection();\n+        if (connection == null)\n+        {\n+            try\n+            {\n+                connection = activeConnections.get(options);\n+                if (connection == null)\n+                {\n+                    synchronized (activeConnections)\n+                    {\n+                        connection = activeConnections.get(options);\n+                        if (connection != null)\n+                        {\n+                            putCurrentConnection(connection);\n+                            connection.waitForStart();\n+                            return connection.getLocalIdentifier();\n+                        }\n+                        connection = new BrowserStackLocalConnection(options);\n+                        putCurrentConnection(connection);\n+                        activeConnections.put(options, connection);\n+                    }\n+                }\n+                connection.startConnection();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA3MDc4NA=="}, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE3OTA0NQ==", "bodyText": "connection = activeConnections.get(options);\nif (connection == null)\n{\n    synchronized (activeConnections)\n    {\n        connection = activeConnections.get(options);\n        if (connection == null)\n        {\n            connection = new BrowserStackLocalConnection(options);\n            connection.startConnection();\n            connection.waitForStart();\n            activeConnections.put(options, connection);\n        }\n        putCurrentConnection(connection);\n    }\n}", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531179045", "createdAt": "2020-11-26T18:17:28Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+import org.vividus.util.wait.RetryTimesBasedWaiter;\n+\n+public class BrowserStackLocalManager implements TunnelManager<BrowserStackLocalOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String sauceLabsAccessKey;\n+    private final TestContext testContext;\n+\n+    public BrowserStackLocalManager(String sauceLabsAccessKey, TestContext testContext)\n+    {\n+        this.sauceLabsAccessKey = sauceLabsAccessKey;\n+        this.testContext = testContext;\n+    }\n+\n+    private final Map<BrowserStackLocalOptions, BrowserStackLocalConnection> activeConnections = new HashMap<>();\n+\n+    @Override\n+    public String start(BrowserStackLocalOptions options)\n+    {\n+        BrowserStackLocalConnection connection = getCurrentConnection();\n+        if (connection == null)\n+        {\n+            try\n+            {\n+                connection = activeConnections.get(options);\n+                if (connection == null)\n+                {\n+                    synchronized (activeConnections)\n+                    {\n+                        connection = activeConnections.get(options);\n+                        if (connection != null)\n+                        {\n+                            putCurrentConnection(connection);\n+                            connection.waitForStart();\n+                            return connection.getLocalIdentifier();\n+                        }\n+                        connection = new BrowserStackLocalConnection(options);\n+                        putCurrentConnection(connection);\n+                        activeConnections.put(options, connection);\n+                    }\n+                }\n+                connection.startConnection();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA3MDc4NA=="}, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDkyMjIwOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozNzoyNlrOH6eAXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozNzoyNlrOH6eAXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA3MTA2OQ==", "bodyText": "decrement", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531071069", "createdAt": "2020-11-26T14:37:26Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+import org.vividus.util.wait.RetryTimesBasedWaiter;\n+\n+public class BrowserStackLocalManager implements TunnelManager<BrowserStackLocalOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String sauceLabsAccessKey;\n+    private final TestContext testContext;\n+\n+    public BrowserStackLocalManager(String sauceLabsAccessKey, TestContext testContext)\n+    {\n+        this.sauceLabsAccessKey = sauceLabsAccessKey;\n+        this.testContext = testContext;\n+    }\n+\n+    private final Map<BrowserStackLocalOptions, BrowserStackLocalConnection> activeConnections = new HashMap<>();\n+\n+    @Override\n+    public String start(BrowserStackLocalOptions options)\n+    {\n+        BrowserStackLocalConnection connection = getCurrentConnection();\n+        if (connection == null)\n+        {\n+            try\n+            {\n+                connection = activeConnections.get(options);\n+                if (connection == null)\n+                {\n+                    synchronized (activeConnections)\n+                    {\n+                        connection = activeConnections.get(options);\n+                        if (connection != null)\n+                        {\n+                            putCurrentConnection(connection);\n+                            connection.waitForStart();\n+                            return connection.getLocalIdentifier();\n+                        }\n+                        connection = new BrowserStackLocalConnection(options);\n+                        putCurrentConnection(connection);\n+                        activeConnections.put(options, connection);\n+                    }\n+                }\n+                connection.startConnection();\n+            }\n+            catch (Exception e)\n+            {\n+                throw new BrowserStackLocalException(e);\n+            }\n+        }\n+        return connection.getLocalIdentifier();\n+    }\n+\n+    @Override\n+    public void stop()\n+    {\n+        if (isStarted())\n+        {\n+            synchronized (activeConnections)\n+            {\n+                if (isStarted())\n+                {\n+                    BrowserStackLocalConnection connection = getCurrentConnection();\n+                    if (connection.decreaseSessionCount() == 0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDkyNDM3OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozNzo1OVrOH6eBtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozNzo1OVrOH6eBtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA3MTQxMg==", "bodyText": "increment", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531071412", "createdAt": "2020-11-26T14:37:59Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+import org.vividus.util.wait.RetryTimesBasedWaiter;\n+\n+public class BrowserStackLocalManager implements TunnelManager<BrowserStackLocalOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String sauceLabsAccessKey;\n+    private final TestContext testContext;\n+\n+    public BrowserStackLocalManager(String sauceLabsAccessKey, TestContext testContext)\n+    {\n+        this.sauceLabsAccessKey = sauceLabsAccessKey;\n+        this.testContext = testContext;\n+    }\n+\n+    private final Map<BrowserStackLocalOptions, BrowserStackLocalConnection> activeConnections = new HashMap<>();\n+\n+    @Override\n+    public String start(BrowserStackLocalOptions options)\n+    {\n+        BrowserStackLocalConnection connection = getCurrentConnection();\n+        if (connection == null)\n+        {\n+            try\n+            {\n+                connection = activeConnections.get(options);\n+                if (connection == null)\n+                {\n+                    synchronized (activeConnections)\n+                    {\n+                        connection = activeConnections.get(options);\n+                        if (connection != null)\n+                        {\n+                            putCurrentConnection(connection);\n+                            connection.waitForStart();\n+                            return connection.getLocalIdentifier();\n+                        }\n+                        connection = new BrowserStackLocalConnection(options);\n+                        putCurrentConnection(connection);\n+                        activeConnections.put(options, connection);\n+                    }\n+                }\n+                connection.startConnection();\n+            }\n+            catch (Exception e)\n+            {\n+                throw new BrowserStackLocalException(e);\n+            }\n+        }\n+        return connection.getLocalIdentifier();\n+    }\n+\n+    @Override\n+    public void stop()\n+    {\n+        if (isStarted())\n+        {\n+            synchronized (activeConnections)\n+            {\n+                if (isStarted())\n+                {\n+                    BrowserStackLocalConnection connection = getCurrentConnection();\n+                    if (connection.decreaseSessionCount() == 0)\n+                    {\n+                        try\n+                        {\n+                            connection.stopConnection();\n+                        }\n+                        catch (Exception e)\n+                        {\n+                            throw new BrowserStackLocalException(e);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public boolean isStarted()\n+    {\n+        return activeConnections.containsValue(getCurrentConnection());\n+    }\n+\n+    private BrowserStackLocalConnection getCurrentConnection()\n+    {\n+        return testContext.get(KEY);\n+    }\n+\n+    private void putCurrentConnection(BrowserStackLocalConnection connection)\n+    {\n+        connection.increaseSessionCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDkzMDA1OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozOToyN1rOH6eFRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDozOToyN1rOH6eFRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA3MjMyNw==", "bodyText": "\"pac-browserstack-\" + localIdentifier, \".js\", ?", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531072327", "createdAt": "2020-11-26T14:39:27Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+import org.vividus.util.wait.RetryTimesBasedWaiter;\n+\n+public class BrowserStackLocalManager implements TunnelManager<BrowserStackLocalOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String sauceLabsAccessKey;\n+    private final TestContext testContext;\n+\n+    public BrowserStackLocalManager(String sauceLabsAccessKey, TestContext testContext)\n+    {\n+        this.sauceLabsAccessKey = sauceLabsAccessKey;\n+        this.testContext = testContext;\n+    }\n+\n+    private final Map<BrowserStackLocalOptions, BrowserStackLocalConnection> activeConnections = new HashMap<>();\n+\n+    @Override\n+    public String start(BrowserStackLocalOptions options)\n+    {\n+        BrowserStackLocalConnection connection = getCurrentConnection();\n+        if (connection == null)\n+        {\n+            try\n+            {\n+                connection = activeConnections.get(options);\n+                if (connection == null)\n+                {\n+                    synchronized (activeConnections)\n+                    {\n+                        connection = activeConnections.get(options);\n+                        if (connection != null)\n+                        {\n+                            putCurrentConnection(connection);\n+                            connection.waitForStart();\n+                            return connection.getLocalIdentifier();\n+                        }\n+                        connection = new BrowserStackLocalConnection(options);\n+                        putCurrentConnection(connection);\n+                        activeConnections.put(options, connection);\n+                    }\n+                }\n+                connection.startConnection();\n+            }\n+            catch (Exception e)\n+            {\n+                throw new BrowserStackLocalException(e);\n+            }\n+        }\n+        return connection.getLocalIdentifier();\n+    }\n+\n+    @Override\n+    public void stop()\n+    {\n+        if (isStarted())\n+        {\n+            synchronized (activeConnections)\n+            {\n+                if (isStarted())\n+                {\n+                    BrowserStackLocalConnection connection = getCurrentConnection();\n+                    if (connection.decreaseSessionCount() == 0)\n+                    {\n+                        try\n+                        {\n+                            connection.stopConnection();\n+                        }\n+                        catch (Exception e)\n+                        {\n+                            throw new BrowserStackLocalException(e);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public boolean isStarted()\n+    {\n+        return activeConnections.containsValue(getCurrentConnection());\n+    }\n+\n+    private BrowserStackLocalConnection getCurrentConnection()\n+    {\n+        return testContext.get(KEY);\n+    }\n+\n+    private void putCurrentConnection(BrowserStackLocalConnection connection)\n+    {\n+        connection.increaseSessionCount();\n+        testContext.put(KEY, connection);\n+    }\n+\n+    private class BrowserStackLocalConnection\n+    {\n+        private static final String PAC_FORMAT = \"function FindProxyForURL(url, host) \"\n+                + \"{ if (shExpMatch(url, \\\"%s\\\") || shExpMatch(host, \\\"*.browserstack.com\\\")) { return \\\"DIRECT\\\"; }\"\n+                + \"return \\\"PROXY %s\\\"; }\";\n+\n+        private final String localIdentifier;\n+        private final AtomicInteger sessionCount;\n+        private final Map<String, String> localParameters;\n+        private final Local local;\n+\n+        BrowserStackLocalConnection(BrowserStackLocalOptions options) throws IOException\n+        {\n+            this.localIdentifier = UUID.randomUUID().toString();\n+            this.sessionCount = new AtomicInteger(0);\n+\n+            Map<String, String> parameters = new HashMap<>();\n+            parameters.put(\"localIdentifier\", localIdentifier);\n+            parameters.put(\"forcelocal\", \"true\");\n+            parameters.put(\"key\", sauceLabsAccessKey);\n+\n+            if (options.getProxy() != null)\n+            {\n+                String pac = ResourceUtils.createTempFile(\"pac-\" + localIdentifier, \".js\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 152}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDk0MzA5OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDo0Mjo0N1rOH6eNUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNjo0NTozNVrOH6yp5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA3NDM4Ng==", "bodyText": "why not to wait for start ending here?", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531074386", "createdAt": "2020-11-26T14:42:47Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+import org.vividus.util.wait.RetryTimesBasedWaiter;\n+\n+public class BrowserStackLocalManager implements TunnelManager<BrowserStackLocalOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String sauceLabsAccessKey;\n+    private final TestContext testContext;\n+\n+    public BrowserStackLocalManager(String sauceLabsAccessKey, TestContext testContext)\n+    {\n+        this.sauceLabsAccessKey = sauceLabsAccessKey;\n+        this.testContext = testContext;\n+    }\n+\n+    private final Map<BrowserStackLocalOptions, BrowserStackLocalConnection> activeConnections = new HashMap<>();\n+\n+    @Override\n+    public String start(BrowserStackLocalOptions options)\n+    {\n+        BrowserStackLocalConnection connection = getCurrentConnection();\n+        if (connection == null)\n+        {\n+            try\n+            {\n+                connection = activeConnections.get(options);\n+                if (connection == null)\n+                {\n+                    synchronized (activeConnections)\n+                    {\n+                        connection = activeConnections.get(options);\n+                        if (connection != null)\n+                        {\n+                            putCurrentConnection(connection);\n+                            connection.waitForStart();\n+                            return connection.getLocalIdentifier();\n+                        }\n+                        connection = new BrowserStackLocalConnection(options);\n+                        putCurrentConnection(connection);\n+                        activeConnections.put(options, connection);\n+                    }\n+                }\n+                connection.startConnection();\n+            }\n+            catch (Exception e)\n+            {\n+                throw new BrowserStackLocalException(e);\n+            }\n+        }\n+        return connection.getLocalIdentifier();\n+    }\n+\n+    @Override\n+    public void stop()\n+    {\n+        if (isStarted())\n+        {\n+            synchronized (activeConnections)\n+            {\n+                if (isStarted())\n+                {\n+                    BrowserStackLocalConnection connection = getCurrentConnection();\n+                    if (connection.decreaseSessionCount() == 0)\n+                    {\n+                        try\n+                        {\n+                            connection.stopConnection();\n+                        }\n+                        catch (Exception e)\n+                        {\n+                            throw new BrowserStackLocalException(e);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public boolean isStarted()\n+    {\n+        return activeConnections.containsValue(getCurrentConnection());\n+    }\n+\n+    private BrowserStackLocalConnection getCurrentConnection()\n+    {\n+        return testContext.get(KEY);\n+    }\n+\n+    private void putCurrentConnection(BrowserStackLocalConnection connection)\n+    {\n+        connection.increaseSessionCount();\n+        testContext.put(KEY, connection);\n+    }\n+\n+    private class BrowserStackLocalConnection\n+    {\n+        private static final String PAC_FORMAT = \"function FindProxyForURL(url, host) \"\n+                + \"{ if (shExpMatch(url, \\\"%s\\\") || shExpMatch(host, \\\"*.browserstack.com\\\")) { return \\\"DIRECT\\\"; }\"\n+                + \"return \\\"PROXY %s\\\"; }\";\n+\n+        private final String localIdentifier;\n+        private final AtomicInteger sessionCount;\n+        private final Map<String, String> localParameters;\n+        private final Local local;\n+\n+        BrowserStackLocalConnection(BrowserStackLocalOptions options) throws IOException\n+        {\n+            this.localIdentifier = UUID.randomUUID().toString();\n+            this.sessionCount = new AtomicInteger(0);\n+\n+            Map<String, String> parameters = new HashMap<>();\n+            parameters.put(\"localIdentifier\", localIdentifier);\n+            parameters.put(\"forcelocal\", \"true\");\n+            parameters.put(\"key\", sauceLabsAccessKey);\n+\n+            if (options.getProxy() != null)\n+            {\n+                String pac = ResourceUtils.createTempFile(\"pac-\" + localIdentifier, \".js\",\n+                        String.format(PAC_FORMAT, options.getSkipUrlsPattern(), options.getProxy())).toString();\n+                parameters.put(\"-pac-file\", pac);\n+            }\n+\n+            this.localParameters = parameters;\n+            this.local = new Local();\n+        }\n+\n+        String getLocalIdentifier()\n+        {\n+            return localIdentifier;\n+        }\n+\n+        void startConnection() throws Exception\n+        {\n+            LOGGER.atInfo().addArgument(localIdentifier)\n+                           .log(\"Starting BrowserStack Local connection with {} identifier\");\n+            local.start(localParameters);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 170}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEwOTQyMA==", "bodyText": "it will not prevent other threads from using this connection", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531109420", "createdAt": "2020-11-26T15:41:18Z", "author": {"login": "uarlouski"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+import org.vividus.util.wait.RetryTimesBasedWaiter;\n+\n+public class BrowserStackLocalManager implements TunnelManager<BrowserStackLocalOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String sauceLabsAccessKey;\n+    private final TestContext testContext;\n+\n+    public BrowserStackLocalManager(String sauceLabsAccessKey, TestContext testContext)\n+    {\n+        this.sauceLabsAccessKey = sauceLabsAccessKey;\n+        this.testContext = testContext;\n+    }\n+\n+    private final Map<BrowserStackLocalOptions, BrowserStackLocalConnection> activeConnections = new HashMap<>();\n+\n+    @Override\n+    public String start(BrowserStackLocalOptions options)\n+    {\n+        BrowserStackLocalConnection connection = getCurrentConnection();\n+        if (connection == null)\n+        {\n+            try\n+            {\n+                connection = activeConnections.get(options);\n+                if (connection == null)\n+                {\n+                    synchronized (activeConnections)\n+                    {\n+                        connection = activeConnections.get(options);\n+                        if (connection != null)\n+                        {\n+                            putCurrentConnection(connection);\n+                            connection.waitForStart();\n+                            return connection.getLocalIdentifier();\n+                        }\n+                        connection = new BrowserStackLocalConnection(options);\n+                        putCurrentConnection(connection);\n+                        activeConnections.put(options, connection);\n+                    }\n+                }\n+                connection.startConnection();\n+            }\n+            catch (Exception e)\n+            {\n+                throw new BrowserStackLocalException(e);\n+            }\n+        }\n+        return connection.getLocalIdentifier();\n+    }\n+\n+    @Override\n+    public void stop()\n+    {\n+        if (isStarted())\n+        {\n+            synchronized (activeConnections)\n+            {\n+                if (isStarted())\n+                {\n+                    BrowserStackLocalConnection connection = getCurrentConnection();\n+                    if (connection.decreaseSessionCount() == 0)\n+                    {\n+                        try\n+                        {\n+                            connection.stopConnection();\n+                        }\n+                        catch (Exception e)\n+                        {\n+                            throw new BrowserStackLocalException(e);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public boolean isStarted()\n+    {\n+        return activeConnections.containsValue(getCurrentConnection());\n+    }\n+\n+    private BrowserStackLocalConnection getCurrentConnection()\n+    {\n+        return testContext.get(KEY);\n+    }\n+\n+    private void putCurrentConnection(BrowserStackLocalConnection connection)\n+    {\n+        connection.increaseSessionCount();\n+        testContext.put(KEY, connection);\n+    }\n+\n+    private class BrowserStackLocalConnection\n+    {\n+        private static final String PAC_FORMAT = \"function FindProxyForURL(url, host) \"\n+                + \"{ if (shExpMatch(url, \\\"%s\\\") || shExpMatch(host, \\\"*.browserstack.com\\\")) { return \\\"DIRECT\\\"; }\"\n+                + \"return \\\"PROXY %s\\\"; }\";\n+\n+        private final String localIdentifier;\n+        private final AtomicInteger sessionCount;\n+        private final Map<String, String> localParameters;\n+        private final Local local;\n+\n+        BrowserStackLocalConnection(BrowserStackLocalOptions options) throws IOException\n+        {\n+            this.localIdentifier = UUID.randomUUID().toString();\n+            this.sessionCount = new AtomicInteger(0);\n+\n+            Map<String, String> parameters = new HashMap<>();\n+            parameters.put(\"localIdentifier\", localIdentifier);\n+            parameters.put(\"forcelocal\", \"true\");\n+            parameters.put(\"key\", sauceLabsAccessKey);\n+\n+            if (options.getProxy() != null)\n+            {\n+                String pac = ResourceUtils.createTempFile(\"pac-\" + localIdentifier, \".js\",\n+                        String.format(PAC_FORMAT, options.getSkipUrlsPattern(), options.getProxy())).toString();\n+                parameters.put(\"-pac-file\", pac);\n+            }\n+\n+            this.localParameters = parameters;\n+            this.local = new Local();\n+        }\n+\n+        String getLocalIdentifier()\n+        {\n+            return localIdentifier;\n+        }\n+\n+        void startConnection() throws Exception\n+        {\n+            LOGGER.atInfo().addArgument(localIdentifier)\n+                           .log(\"Starting BrowserStack Local connection with {} identifier\");\n+            local.start(localParameters);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA3NDM4Ng=="}, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 170}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE3OTQ2NA==", "bodyText": "but still this connection won't be operable, and extra resources will be required to synchronize start completion", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531179464", "createdAt": "2020-11-26T18:19:00Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+import org.vividus.util.wait.RetryTimesBasedWaiter;\n+\n+public class BrowserStackLocalManager implements TunnelManager<BrowserStackLocalOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String sauceLabsAccessKey;\n+    private final TestContext testContext;\n+\n+    public BrowserStackLocalManager(String sauceLabsAccessKey, TestContext testContext)\n+    {\n+        this.sauceLabsAccessKey = sauceLabsAccessKey;\n+        this.testContext = testContext;\n+    }\n+\n+    private final Map<BrowserStackLocalOptions, BrowserStackLocalConnection> activeConnections = new HashMap<>();\n+\n+    @Override\n+    public String start(BrowserStackLocalOptions options)\n+    {\n+        BrowserStackLocalConnection connection = getCurrentConnection();\n+        if (connection == null)\n+        {\n+            try\n+            {\n+                connection = activeConnections.get(options);\n+                if (connection == null)\n+                {\n+                    synchronized (activeConnections)\n+                    {\n+                        connection = activeConnections.get(options);\n+                        if (connection != null)\n+                        {\n+                            putCurrentConnection(connection);\n+                            connection.waitForStart();\n+                            return connection.getLocalIdentifier();\n+                        }\n+                        connection = new BrowserStackLocalConnection(options);\n+                        putCurrentConnection(connection);\n+                        activeConnections.put(options, connection);\n+                    }\n+                }\n+                connection.startConnection();\n+            }\n+            catch (Exception e)\n+            {\n+                throw new BrowserStackLocalException(e);\n+            }\n+        }\n+        return connection.getLocalIdentifier();\n+    }\n+\n+    @Override\n+    public void stop()\n+    {\n+        if (isStarted())\n+        {\n+            synchronized (activeConnections)\n+            {\n+                if (isStarted())\n+                {\n+                    BrowserStackLocalConnection connection = getCurrentConnection();\n+                    if (connection.decreaseSessionCount() == 0)\n+                    {\n+                        try\n+                        {\n+                            connection.stopConnection();\n+                        }\n+                        catch (Exception e)\n+                        {\n+                            throw new BrowserStackLocalException(e);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public boolean isStarted()\n+    {\n+        return activeConnections.containsValue(getCurrentConnection());\n+    }\n+\n+    private BrowserStackLocalConnection getCurrentConnection()\n+    {\n+        return testContext.get(KEY);\n+    }\n+\n+    private void putCurrentConnection(BrowserStackLocalConnection connection)\n+    {\n+        connection.increaseSessionCount();\n+        testContext.put(KEY, connection);\n+    }\n+\n+    private class BrowserStackLocalConnection\n+    {\n+        private static final String PAC_FORMAT = \"function FindProxyForURL(url, host) \"\n+                + \"{ if (shExpMatch(url, \\\"%s\\\") || shExpMatch(host, \\\"*.browserstack.com\\\")) { return \\\"DIRECT\\\"; }\"\n+                + \"return \\\"PROXY %s\\\"; }\";\n+\n+        private final String localIdentifier;\n+        private final AtomicInteger sessionCount;\n+        private final Map<String, String> localParameters;\n+        private final Local local;\n+\n+        BrowserStackLocalConnection(BrowserStackLocalOptions options) throws IOException\n+        {\n+            this.localIdentifier = UUID.randomUUID().toString();\n+            this.sessionCount = new AtomicInteger(0);\n+\n+            Map<String, String> parameters = new HashMap<>();\n+            parameters.put(\"localIdentifier\", localIdentifier);\n+            parameters.put(\"forcelocal\", \"true\");\n+            parameters.put(\"key\", sauceLabsAccessKey);\n+\n+            if (options.getProxy() != null)\n+            {\n+                String pac = ResourceUtils.createTempFile(\"pac-\" + localIdentifier, \".js\",\n+                        String.format(PAC_FORMAT, options.getSkipUrlsPattern(), options.getProxy())).toString();\n+                parameters.put(\"-pac-file\", pac);\n+            }\n+\n+            this.localParameters = parameters;\n+            this.local = new Local();\n+        }\n+\n+        String getLocalIdentifier()\n+        {\n+            return localIdentifier;\n+        }\n+\n+        void startConnection() throws Exception\n+        {\n+            LOGGER.atInfo().addArgument(localIdentifier)\n+                           .log(\"Starting BrowserStack Local connection with {} identifier\");\n+            local.start(localParameters);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA3NDM4Ng=="}, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 170}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwOTM4MA==", "bodyText": "start method already contains wait logic within it, for starting thread this connection will be always operable", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531409380", "createdAt": "2020-11-27T06:45:35Z", "author": {"login": "uarlouski"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+import org.vividus.util.wait.RetryTimesBasedWaiter;\n+\n+public class BrowserStackLocalManager implements TunnelManager<BrowserStackLocalOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String sauceLabsAccessKey;\n+    private final TestContext testContext;\n+\n+    public BrowserStackLocalManager(String sauceLabsAccessKey, TestContext testContext)\n+    {\n+        this.sauceLabsAccessKey = sauceLabsAccessKey;\n+        this.testContext = testContext;\n+    }\n+\n+    private final Map<BrowserStackLocalOptions, BrowserStackLocalConnection> activeConnections = new HashMap<>();\n+\n+    @Override\n+    public String start(BrowserStackLocalOptions options)\n+    {\n+        BrowserStackLocalConnection connection = getCurrentConnection();\n+        if (connection == null)\n+        {\n+            try\n+            {\n+                connection = activeConnections.get(options);\n+                if (connection == null)\n+                {\n+                    synchronized (activeConnections)\n+                    {\n+                        connection = activeConnections.get(options);\n+                        if (connection != null)\n+                        {\n+                            putCurrentConnection(connection);\n+                            connection.waitForStart();\n+                            return connection.getLocalIdentifier();\n+                        }\n+                        connection = new BrowserStackLocalConnection(options);\n+                        putCurrentConnection(connection);\n+                        activeConnections.put(options, connection);\n+                    }\n+                }\n+                connection.startConnection();\n+            }\n+            catch (Exception e)\n+            {\n+                throw new BrowserStackLocalException(e);\n+            }\n+        }\n+        return connection.getLocalIdentifier();\n+    }\n+\n+    @Override\n+    public void stop()\n+    {\n+        if (isStarted())\n+        {\n+            synchronized (activeConnections)\n+            {\n+                if (isStarted())\n+                {\n+                    BrowserStackLocalConnection connection = getCurrentConnection();\n+                    if (connection.decreaseSessionCount() == 0)\n+                    {\n+                        try\n+                        {\n+                            connection.stopConnection();\n+                        }\n+                        catch (Exception e)\n+                        {\n+                            throw new BrowserStackLocalException(e);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public boolean isStarted()\n+    {\n+        return activeConnections.containsValue(getCurrentConnection());\n+    }\n+\n+    private BrowserStackLocalConnection getCurrentConnection()\n+    {\n+        return testContext.get(KEY);\n+    }\n+\n+    private void putCurrentConnection(BrowserStackLocalConnection connection)\n+    {\n+        connection.increaseSessionCount();\n+        testContext.put(KEY, connection);\n+    }\n+\n+    private class BrowserStackLocalConnection\n+    {\n+        private static final String PAC_FORMAT = \"function FindProxyForURL(url, host) \"\n+                + \"{ if (shExpMatch(url, \\\"%s\\\") || shExpMatch(host, \\\"*.browserstack.com\\\")) { return \\\"DIRECT\\\"; }\"\n+                + \"return \\\"PROXY %s\\\"; }\";\n+\n+        private final String localIdentifier;\n+        private final AtomicInteger sessionCount;\n+        private final Map<String, String> localParameters;\n+        private final Local local;\n+\n+        BrowserStackLocalConnection(BrowserStackLocalOptions options) throws IOException\n+        {\n+            this.localIdentifier = UUID.randomUUID().toString();\n+            this.sessionCount = new AtomicInteger(0);\n+\n+            Map<String, String> parameters = new HashMap<>();\n+            parameters.put(\"localIdentifier\", localIdentifier);\n+            parameters.put(\"forcelocal\", \"true\");\n+            parameters.put(\"key\", sauceLabsAccessKey);\n+\n+            if (options.getProxy() != null)\n+            {\n+                String pac = ResourceUtils.createTempFile(\"pac-\" + localIdentifier, \".js\",\n+                        String.format(PAC_FORMAT, options.getSkipUrlsPattern(), options.getProxy())).toString();\n+                parameters.put(\"-pac-file\", pac);\n+            }\n+\n+            this.localParameters = parameters;\n+            this.local = new Local();\n+        }\n+\n+        String getLocalIdentifier()\n+        {\n+            return localIdentifier;\n+        }\n+\n+        void startConnection() throws Exception\n+        {\n+            LOGGER.atInfo().addArgument(localIdentifier)\n+                           .log(\"Starting BrowserStack Local connection with {} identifier\");\n+            local.start(localParameters);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA3NDM4Ng=="}, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 170}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDk1NzQ4OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-saucelabs/src/main/java/org/vividus/selenium/sauce/SauceConnectOptions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDo0NjoyOVrOH6eWSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNDo0NjoyOVrOH6eWSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA3NjY4MQ==", "bodyText": "\"pac-saucelabs-\" + tunnelIdentifier, \".js\"", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r531076681", "createdAt": "2020-11-26T14:46:29Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-saucelabs/src/main/java/org/vividus/selenium/sauce/SauceConnectOptions.java", "diffHunk": "@@ -105,21 +91,12 @@ public String build(String tunnelIdentifier) throws IOException\n     private Path createPacFile(String tunnelIdentifier) throws IOException\n     {\n         return createTempFile(\"pac-\" + tunnelIdentifier, \".js\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b6556d6c1592571b8cc5f03cdd4e034adc1799"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1Njc2NjkxOnYy", "diffSide": "RIGHT", "path": "vividus-extension-selenium/src/test/java/org/vividus/selenium/AbstractDesiredCapabilitiesConfigurerTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTo1MzowMVrOH-Pjww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTo1MzowMVrOH-Pjww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAyODY3NQ==", "bodyText": "noisy change", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r535028675", "createdAt": "2020-12-03T09:53:01Z", "author": {"login": "valfirst"}, "path": "vividus-extension-selenium/src/test/java/org/vividus/selenium/AbstractDesiredCapabilitiesConfigurerTests.java", "diffHunk": "@@ -100,7 +100,8 @@ void shouldNotConfigureTestNameIfStoryIsNull()\n         verifyNoInteractions(desiredCapabilities);\n     }\n \n-    private static final class TestAbstractDesiredCapabilitiesConfigurer extends AbstractDesiredCapabilitiesConfigurer\n+    private static final class TestAbstractDesiredCapabilitiesConfigurer\n+            extends AbstractDesiredCapabilitiesConfigurer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2249bf44a5a8aa54de411962d38395abd9a2f374"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1Njc5MDAwOnYy", "diffSide": "RIGHT", "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTo1NjoxM1rOH-PzBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTo1NjoxM1rOH-PzBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzMjU4Mw==", "bodyText": "connection = activeConnections.get(options);\nif (connection == null)\n{\n    connection = new BrowserStackLocalConnection(options);\n    connection.startConnection();\n    activeConnections.put(options, connection);\n}", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r535032583", "createdAt": "2020-12-03T09:56:13Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/java/org/vividus/selenium/browserstack/BrowserStackLocalManager.java", "diffHunk": "@@ -0,0 +1,190 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.selenium.browserstack;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+import com.browserstack.local.Local;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.vividus.selenium.tunnel.TunnelException;\n+import org.vividus.selenium.tunnel.TunnelManager;\n+import org.vividus.selenium.tunnel.TunnelOptions;\n+import org.vividus.testcontext.TestContext;\n+import org.vividus.util.ResourceUtils;\n+\n+public class BrowserStackLocalManager implements TunnelManager<TunnelOptions>\n+{\n+    private static final Logger LOGGER = LoggerFactory.getLogger(BrowserStackLocalManager.class);\n+    private static final Object KEY = BrowserStackLocalConnection.class;\n+\n+    private final String browserStackAccessKey;\n+    private final TestContext testContext;\n+\n+    private final Map<TunnelOptions, BrowserStackLocalConnection> activeConnections = new HashMap<>();\n+\n+    public BrowserStackLocalManager(String browserStackAccessKey, TestContext testContext)\n+    {\n+        this.browserStackAccessKey = browserStackAccessKey;\n+        this.testContext = testContext;\n+    }\n+\n+    @Override\n+    public String start(TunnelOptions options) throws TunnelException\n+    {\n+        BrowserStackLocalConnection connection = getCurrentConnection();\n+        if (connection == null)\n+        {\n+            try\n+            {\n+                connection = activeConnections.get(options);\n+                if (connection == null)\n+                {\n+                    synchronized (activeConnections)\n+                    {\n+                        connection = activeConnections.get(options);\n+                        if (connection != null)\n+                        {\n+                            putCurrentConnection(connection);\n+                            return connection.getLocalIdentifier();\n+                        }\n+                        connection = new BrowserStackLocalConnection(options);\n+                        connection.startConnection();\n+                        activeConnections.put(options, connection);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2249bf44a5a8aa54de411962d38395abd9a2f374"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1NjgwODk5OnYy", "diffSide": "RIGHT", "path": "vividus-plugin-browserstack/src/main/resources/properties/profile/browserstack/profile.properties", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTo1OTowMVrOH-P_7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTo1OTowMVrOH-P_7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzNTg4NA==", "bodyText": "browserstack.browserstack-local.enabled", "url": "https://github.com/vividus-framework/vividus/pull/1178#discussion_r535035884", "createdAt": "2020-12-03T09:59:01Z", "author": {"login": "valfirst"}, "path": "vividus-plugin-browserstack/src/main/resources/properties/profile/browserstack/profile.properties", "diffHunk": "@@ -1,3 +1,5 @@\n selenium.grid.enabled=true\n selenium.grid.host=hub-cloud.browserstack.com\n selenium.grid.url=https://${selenium.grid.username}:${selenium.grid.password}@${selenium.grid.host}/wd/hub\n+\n+browserstack.local.enabled=false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2249bf44a5a8aa54de411962d38395abd9a2f374"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4955, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}