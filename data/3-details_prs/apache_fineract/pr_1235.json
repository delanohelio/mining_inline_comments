{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNzQ1MTMy", "number": 1235, "title": "FINERACT-734 Creditbureau-Integration-phase3", "bodyText": "Description\nDescribe the changes made and why they were made. Ignore if these details are present on the associated Jira ticket\nChecklist\nPlease make sure these boxes are checked before submitting your pull request - thanks!\n\n\n Commit message starts with the issue number from https://issues.apache.org/jira/projects/FINERACT/. Ex: FINERACT-646 Pockets API.\n\n\n Coding conventions at https://cwiki.apache.org/confluence/display/FINERACT/Coding+Conventions have been followed.\n\n\n API documentation at fineract-provider/src/main/resources/static/api-docs/apiLive.htm has been updated with details of any API changes.\n\n\n Integration tests have been created/updated for verifying the changes made.\n\n\n All Integrations tests are passing with the new commits.\n\n\n Submission is not a \"code dump\".  (Large changes can be made \"in repository\" via a branch.  Ask on the list.)\n\n\nOur guidelines for code reviews is at https://cwiki.apache.org/confluence/display/FINERACT/Code+Review+Guide", "createdAt": "2020-08-04T12:48:12Z", "url": "https://github.com/apache/fineract/pull/1235", "merged": true, "mergeCommit": {"oid": "db32e569d5901aae34340865b154f168873f02a7"}, "closed": true, "closedAt": "2021-01-04T17:42:14Z", "author": {"login": "rrpawar96"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc73coeABqjM2MjM3MzE4Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdq-QuNABqjQxNTUyOTcyODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41e5b53ce87eaf3cf9626e91ccb6a075057f4677", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/41e5b53ce87eaf3cf9626e91ccb6a075057f4677", "committedDate": "2020-08-04T12:44:15Z", "message": "token and get_creditreport module completed"}, "afterCommit": {"oid": "76c3b3f9905c9ec5f4a1746aac8ef7b1ad80a163", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/76c3b3f9905c9ec5f4a1746aac8ef7b1ad80a163", "committedDate": "2020-08-05T09:02:21Z", "message": "token and get_creditreport module completed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76c3b3f9905c9ec5f4a1746aac8ef7b1ad80a163", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/76c3b3f9905c9ec5f4a1746aac8ef7b1ad80a163", "committedDate": "2020-08-05T09:02:21Z", "message": "token and get_creditreport module completed"}, "afterCommit": {"oid": "0430d46c93b914c2d4c62aa528d497291c25eaa4", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/0430d46c93b914c2d4c62aa528d497291c25eaa4", "committedDate": "2020-08-05T09:52:44Z", "message": "token and get_creditreport module completed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0430d46c93b914c2d4c62aa528d497291c25eaa4", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/0430d46c93b914c2d4c62aa528d497291c25eaa4", "committedDate": "2020-08-05T09:52:44Z", "message": "token and get_creditreport module completed"}, "afterCommit": {"oid": "2df8e7ea10d63c056dc6707ec53aa13f672094a0", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/2df8e7ea10d63c056dc6707ec53aa13f672094a0", "committedDate": "2020-08-09T00:44:02Z", "message": "token and get_creditreport module completed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2df8e7ea10d63c056dc6707ec53aa13f672094a0", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/2df8e7ea10d63c056dc6707ec53aa13f672094a0", "committedDate": "2020-08-09T00:44:02Z", "message": "token and get_creditreport module completed"}, "afterCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/59c95b91ad70a18fcf86856036298ff9cef3dee0", "committedDate": "2020-08-09T13:18:35Z", "message": "token and get_creditreport module completed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NzExMDE2", "url": "https://github.com/apache/fineract/pull/1235#pullrequestreview-464711016", "createdAt": "2020-08-11T02:41:55Z", "commit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMjo0MTo1NVrOG-mYaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMzowMDozNlrOG-mr-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5MzczNw==", "bodyText": "change the datatypes to actual datatypes", "url": "https://github.com/apache/fineract/pull/1235#discussion_r468293737", "createdAt": "2020-08-11T02:41:55Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/data/CreditReportData.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.data;\n+\n+import java.io.Serializable;\n+\n+public final class CreditReportData implements Serializable {\n+\n+    @SuppressWarnings(\"unused\")\n+    private final Object creditScore;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5NDAyOA==", "bodyText": "why String is used instead of date.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r468294028", "createdAt": "2020-08-11T02:43:03Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/domain/CreditBureauToken.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package org.apache.fineract.infrastructure.creditbureau.domain;\n+\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.Table;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.domain.AbstractPersistableCustom;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Entity\n+@Table(name = \"m_creditbureau_token\")\n+public class CreditBureauToken extends AbstractPersistableCustom {\n+\n+    @Column(name = \"username\")\n+    private String userName;\n+\n+    @Column(name = \"token\")\n+    private String access_token;\n+\n+    @Column(name = \"token_type\")\n+    private String token_type;\n+\n+    @Column(name = \"expires_in\")\n+    private String expires_in;\n+\n+    @Column(name = \"issued\")\n+    private String issued;\n+\n+    @Column(name = \"expires\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5NTk1Nw==", "bodyText": "don't hard code time zones", "url": "https://github.com/apache/fineract/pull/1235#discussion_r468295957", "createdAt": "2020-08-11T02:50:17Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.time.LocalDate;\n+import java.time.ZoneId;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    @CacheEvict(value = \"searchreport\", key = \"T(org.apache.fineract.infrastructure.core.service.ThreadLocalContextUtil).getTenant().getTenantIdentifier().concat('cv')\")\n+    public CreditReportData retrieveAllSearchReport(final String searchId) {\n+        String result = null;\n+        Long uniqueID = 0L;\n+        try {\n+            this.context.authenticatedUser();\n+\n+            final CreditBureauTokenCredential credittokendata = this.tokenDataRepository.getTokenCredential();\n+            String userName = credittokendata.getUserName();\n+            String password = credittokendata.getPassword();\n+            String subscriptionId = credittokendata.getSubscriptionId();\n+            String subscriptionKey = credittokendata.getSubscriptionKey();\n+            String tokenDate;\n+\n+            CreditBureauToken creditbureautoken = this.tokenRepository.getToken();\n+            LOG.info(\"credit bureau token : {} \", creditbureautoken);\n+\n+            // check the expiry date of the previous token.\n+            if (creditbureautoken != null) {\n+                try {\n+                    Date current = new Date();\n+\n+                    String getDate = creditbureautoken.getTokenExpiryDate();\n+                    DateFormat dateformat = new SimpleDateFormat(\"EEE, dd MMM yyyy kk:mm:ss zzz\", Locale.ENGLISH);\n+                    Date getExpiryDate = dateformat.parse(getDate);\n+                    LOG.info(\"current date : {} \", current);\n+                    LOG.info(\"getExpiryDate : {} \", getExpiryDate);\n+\n+                    ZoneId zid = ZoneId.of(\"Asia/Rangoon\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5NjE3Nw==", "bodyText": "change data type to Date and come up with better way to compare dates", "url": "https://github.com/apache/fineract/pull/1235#discussion_r468296177", "createdAt": "2020-08-11T02:51:07Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.time.LocalDate;\n+import java.time.ZoneId;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    @CacheEvict(value = \"searchreport\", key = \"T(org.apache.fineract.infrastructure.core.service.ThreadLocalContextUtil).getTenant().getTenantIdentifier().concat('cv')\")\n+    public CreditReportData retrieveAllSearchReport(final String searchId) {\n+        String result = null;\n+        Long uniqueID = 0L;\n+        try {\n+            this.context.authenticatedUser();\n+\n+            final CreditBureauTokenCredential credittokendata = this.tokenDataRepository.getTokenCredential();\n+            String userName = credittokendata.getUserName();\n+            String password = credittokendata.getPassword();\n+            String subscriptionId = credittokendata.getSubscriptionId();\n+            String subscriptionKey = credittokendata.getSubscriptionKey();\n+            String tokenDate;\n+\n+            CreditBureauToken creditbureautoken = this.tokenRepository.getToken();\n+            LOG.info(\"credit bureau token : {} \", creditbureautoken);\n+\n+            // check the expiry date of the previous token.\n+            if (creditbureautoken != null) {\n+                try {\n+                    Date current = new Date();\n+\n+                    String getDate = creditbureautoken.getTokenExpiryDate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5NjUwMQ==", "bodyText": "Please be consistent with date data types, use either of date, LocalDate or LocalDateTime.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r468296501", "createdAt": "2020-08-11T02:52:22Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.time.LocalDate;\n+import java.time.ZoneId;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    @CacheEvict(value = \"searchreport\", key = \"T(org.apache.fineract.infrastructure.core.service.ThreadLocalContextUtil).getTenant().getTenantIdentifier().concat('cv')\")\n+    public CreditReportData retrieveAllSearchReport(final String searchId) {\n+        String result = null;\n+        Long uniqueID = 0L;\n+        try {\n+            this.context.authenticatedUser();\n+\n+            final CreditBureauTokenCredential credittokendata = this.tokenDataRepository.getTokenCredential();\n+            String userName = credittokendata.getUserName();\n+            String password = credittokendata.getPassword();\n+            String subscriptionId = credittokendata.getSubscriptionId();\n+            String subscriptionKey = credittokendata.getSubscriptionKey();\n+            String tokenDate;\n+\n+            CreditBureauToken creditbureautoken = this.tokenRepository.getToken();\n+            LOG.info(\"credit bureau token : {} \", creditbureautoken);\n+\n+            // check the expiry date of the previous token.\n+            if (creditbureautoken != null) {\n+                try {\n+                    Date current = new Date();\n+\n+                    String getDate = creditbureautoken.getTokenExpiryDate();\n+                    DateFormat dateformat = new SimpleDateFormat(\"EEE, dd MMM yyyy kk:mm:ss zzz\", Locale.ENGLISH);\n+                    Date getExpiryDate = dateformat.parse(getDate);\n+                    LOG.info(\"current date : {} \", current);\n+                    LOG.info(\"getExpiryDate : {} \", getExpiryDate);\n+\n+                    ZoneId zid = ZoneId.of(\"Asia/Rangoon\");\n+                    final LocalDate date = LocalDate.now(zid);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5Njg2MQ==", "bodyText": "encapsulate http connection into method, so that it can be resued.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r468296861", "createdAt": "2020-08-11T02:53:48Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.time.LocalDate;\n+import java.time.ZoneId;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    @CacheEvict(value = \"searchreport\", key = \"T(org.apache.fineract.infrastructure.core.service.ThreadLocalContextUtil).getTenant().getTenantIdentifier().concat('cv')\")\n+    public CreditReportData retrieveAllSearchReport(final String searchId) {\n+        String result = null;\n+        Long uniqueID = 0L;\n+        try {\n+            this.context.authenticatedUser();\n+\n+            final CreditBureauTokenCredential credittokendata = this.tokenDataRepository.getTokenCredential();\n+            String userName = credittokendata.getUserName();\n+            String password = credittokendata.getPassword();\n+            String subscriptionId = credittokendata.getSubscriptionId();\n+            String subscriptionKey = credittokendata.getSubscriptionKey();\n+            String tokenDate;\n+\n+            CreditBureauToken creditbureautoken = this.tokenRepository.getToken();\n+            LOG.info(\"credit bureau token : {} \", creditbureautoken);\n+\n+            // check the expiry date of the previous token.\n+            if (creditbureautoken != null) {\n+                try {\n+                    Date current = new Date();\n+\n+                    String getDate = creditbureautoken.getTokenExpiryDate();\n+                    DateFormat dateformat = new SimpleDateFormat(\"EEE, dd MMM yyyy kk:mm:ss zzz\", Locale.ENGLISH);\n+                    Date getExpiryDate = dateformat.parse(getDate);\n+                    LOG.info(\"current date : {} \", current);\n+                    LOG.info(\"getExpiryDate : {} \", getExpiryDate);\n+\n+                    ZoneId zid = ZoneId.of(\"Asia/Rangoon\");\n+                    final LocalDate date = LocalDate.now(zid);\n+                    LOG.info(\"local date : {} \", date);\n+\n+                    if (getExpiryDate.before(current)) {\n+                        LOG.info(\"The token is expired\");\n+                        final CreditBureauToken credittoken = this.tokenRepository.getToken();\n+                        if (credittoken != null) {\n+\n+                            this.tokenRepository.delete(credittoken);\n+                            creditbureautoken = null;\n+                        }\n+\n+                    }\n+\n+                } catch (ParseException Ex) {\n+                    LOG.error(\"Error occured.\", Ex);\n+                }\n+            }\n+\n+            // if token is not available or previous token is expired then create a new token\n+            if (creditbureautoken == null) {\n+\n+                LOG.info(\"-----creating new token-----\");\n+                final String POST_PARAMS = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName\n+                        + \"&\\r\\n\" + \"password=\" + password + \"&\\r\\n\";\n+\n+                URL obj = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+                String readLine = null;\n+\n+                HttpURLConnection postConnection = (HttpURLConnection) obj.openConnection();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5NzA3NA==", "bodyText": "refactor http connection into method.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r468297074", "createdAt": "2020-08-11T02:54:21Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.time.LocalDate;\n+import java.time.ZoneId;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    @CacheEvict(value = \"searchreport\", key = \"T(org.apache.fineract.infrastructure.core.service.ThreadLocalContextUtil).getTenant().getTenantIdentifier().concat('cv')\")\n+    public CreditReportData retrieveAllSearchReport(final String searchId) {\n+        String result = null;\n+        Long uniqueID = 0L;\n+        try {\n+            this.context.authenticatedUser();\n+\n+            final CreditBureauTokenCredential credittokendata = this.tokenDataRepository.getTokenCredential();\n+            String userName = credittokendata.getUserName();\n+            String password = credittokendata.getPassword();\n+            String subscriptionId = credittokendata.getSubscriptionId();\n+            String subscriptionKey = credittokendata.getSubscriptionKey();\n+            String tokenDate;\n+\n+            CreditBureauToken creditbureautoken = this.tokenRepository.getToken();\n+            LOG.info(\"credit bureau token : {} \", creditbureautoken);\n+\n+            // check the expiry date of the previous token.\n+            if (creditbureautoken != null) {\n+                try {\n+                    Date current = new Date();\n+\n+                    String getDate = creditbureautoken.getTokenExpiryDate();\n+                    DateFormat dateformat = new SimpleDateFormat(\"EEE, dd MMM yyyy kk:mm:ss zzz\", Locale.ENGLISH);\n+                    Date getExpiryDate = dateformat.parse(getDate);\n+                    LOG.info(\"current date : {} \", current);\n+                    LOG.info(\"getExpiryDate : {} \", getExpiryDate);\n+\n+                    ZoneId zid = ZoneId.of(\"Asia/Rangoon\");\n+                    final LocalDate date = LocalDate.now(zid);\n+                    LOG.info(\"local date : {} \", date);\n+\n+                    if (getExpiryDate.before(current)) {\n+                        LOG.info(\"The token is expired\");\n+                        final CreditBureauToken credittoken = this.tokenRepository.getToken();\n+                        if (credittoken != null) {\n+\n+                            this.tokenRepository.delete(credittoken);\n+                            creditbureautoken = null;\n+                        }\n+\n+                    }\n+\n+                } catch (ParseException Ex) {\n+                    LOG.error(\"Error occured.\", Ex);\n+                }\n+            }\n+\n+            // if token is not available or previous token is expired then create a new token\n+            if (creditbureautoken == null) {\n+\n+                LOG.info(\"-----creating new token-----\");\n+                final String POST_PARAMS = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName\n+                        + \"&\\r\\n\" + \"password=\" + password + \"&\\r\\n\";\n+\n+                URL obj = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+                String readLine = null;\n+\n+                HttpURLConnection postConnection = (HttpURLConnection) obj.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+                postConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+                postConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+                postConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+                postConnection.setDoOutput(true);\n+\n+                OutputStream os = postConnection.getOutputStream();\n+                os.write(POST_PARAMS.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+\n+                int responseCode = postConnection.getResponseCode();\n+\n+                String ResponseMessage = postConnection.getResponseMessage();\n+\n+                if (responseCode == HttpURLConnection.HTTP_OK) {\n+                    BufferedReader in = new BufferedReader(new InputStreamReader(postConnection.getInputStream(), StandardCharsets.UTF_8));\n+                    StringBuilder response = new StringBuilder();\n+                    while ((readLine = in.readLine()) != null) {\n+                        response.append(readLine);\n+                    }\n+                    in.close();\n+\n+                    result = response.toString();\n+\n+                    final CommandWrapper wrapper = new CommandWrapperBuilder().withJson(result).build();\n+                    final String json = wrapper.getJson();\n+                    result = null;\n+                    JsonCommand apicommand = null;\n+                    boolean isApprovedByChecker = false;\n+                    final JsonElement parsedCommand = this.fromApiJsonHelper.parse(json);\n+\n+                    apicommand = JsonCommand.from(json, parsedCommand, this.fromApiJsonHelper, wrapper.getEntityName(),\n+                            wrapper.getEntityId(), wrapper.getSubentityId(), wrapper.getGroupId(), wrapper.getClientId(),\n+                            wrapper.getLoanId(), wrapper.getSavingsId(), wrapper.getTransactionId(), wrapper.getHref(),\n+                            wrapper.getProductId(), wrapper.getCreditBureauId(), wrapper.getOrganisationCreditBureauId());\n+\n+                    this.fromApiJsonDeserializer.validateForCreate(apicommand.json());\n+\n+                    final CreditBureauToken generatedtoken = CreditBureauToken.fromJson(apicommand);\n+\n+                    this.tokenRepository.save(generatedtoken);\n+\n+                } else {\n+                    LOG.info(\"Request is Invalid\");\n+\n+                }\n+            }\n+\n+            // Search Methods\n+            LOG.info(\"-----Search by NRC-----\");\n+            StringBuilder response = new StringBuilder();\n+            creditbureautoken = this.tokenRepository.getToken();\n+            String token = creditbureautoken.getCurrentToken();\n+\n+            final String POST_PARAMS = \"BODY=x-www-form-urlencoded&nrc=\" + searchId + \"&\";\n+\n+            URL obj = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Search/SimpleSearch?nrc=\" + searchId);\n+            String readLine = null;\n+            LOG.info(\"POST_PARAMS : {} \", POST_PARAMS);\n+            LOG.info(\"obj : {} \", obj);\n+            LOG.info(\"subscriptionId : {} \", subscriptionId);\n+            LOG.info(\"subscriptionKey : {} \", subscriptionKey);\n+            LOG.info(\"token : {} \", token);\n+\n+            HttpURLConnection postConnection = (HttpURLConnection) obj.openConnection();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 212}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5NzU4MA==", "bodyText": "extract http connection code into method", "url": "https://github.com/apache/fineract/pull/1235#discussion_r468297580", "createdAt": "2020-08-11T02:56:10Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauTokenWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonElement;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.commands.service.PortfolioCommandSourceWritePlatformService;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResultBuilder;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauTokenWritePlatformServiceImpl implements CreditBureauTokenWritePlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauTokenWritePlatformServiceImpl.class);\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final CreditBureauTokenRepository creditBureauTokenRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+    private final CreditBureauTokenReadPlatformService readPlatformServiceCreditBureauToken;\n+    private final PortfolioCommandSourceWritePlatformService commandsSourceWritePlatformService;\n+    private final CreditBureauToken creditBureauToken;\n+    private final TokenDataRepository tokendatRepository;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private static String tokenstr;\n+    private final JdbcTemplate jdbcTemplate;\n+\n+    @Autowired\n+    public CreditBureauTokenWritePlatformServiceImpl(final PlatformSecurityContext context,\n+            final CreditBureauTokenRepository creditBureauTokenRepository, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository, final TokenDataRepository tokendatRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer, final FromJsonHelper fromApiJsonHelper,\n+            final CreditBureauTokenReadPlatformService readPlatformServiceCreditBureauToken,\n+            final PortfolioCommandSourceWritePlatformService commandsSourceWritePlatformService, final CreditBureauToken creditBureauToken,\n+            final RoutingDataSource dataSource) {\n+        this.context = context;\n+        this.creditBureauTokenRepository = creditBureauTokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.tokenRepository = tokenRepository;\n+        this.tokendatRepository = tokendatRepository;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.readPlatformServiceCreditBureauToken = readPlatformServiceCreditBureauToken;\n+        this.commandsSourceWritePlatformService = commandsSourceWritePlatformService;\n+        this.creditBureauToken = creditBureauToken;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+    }\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    @CacheEvict(value = \"credittoken\", key = \"T(org.apache.fineract.infrastructure.core.service.ThreadLocalContextUtil).getTenant().getTenantIdentifier().concat('cv')\")\n+    public CommandProcessingResult createCreditBureauToken(JsonCommand command) {\n+        try {\n+            this.context.authenticatedUser();\n+\n+            // fetch the token credentials for using it in header\n+            final CreditBureauTokenCredential credittokendata = this.tokenDataRepository.getTokenCredential();\n+\n+            String userName = credittokendata.getUserName();\n+            String password = credittokendata.getPassword();\n+            String subscriptionId = credittokendata.getSubscriptionId();\n+            String subscriptionKey = credittokendata.getSubscriptionKey();\n+\n+            final String POST_PARAMS = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName\n+                    + \"&\\r\\n\" + \"password=\" + password + \"&\\r\\n\";\n+\n+            URL obj = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+            String readLine = null;\n+\n+            HttpURLConnection postConnection = (HttpURLConnection) obj.openConnection();\n+            postConnection.setRequestMethod(\"POST\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5Nzg1OA==", "bodyText": "this data should not be given. Take this out", "url": "https://github.com/apache/fineract/pull/1235#discussion_r468297858", "createdAt": "2020-08-11T02:57:12Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/resources/sql/migrations/core_db/V273__oauth_changes.sql", "diffHunk": "@@ -59,3 +59,42 @@ CREATE TABLE `oauth_refresh_token` (\n )\n COLLATE='utf8mb4_general_ci'\n ENGINE=InnoDB;\n+\n+CREATE TABLE `m_creditbureau_tokendata` (\n+  `id` INT(128) NOT NULL AUTO_INCREMENT,\n+  `userNames` varchar(128) DEFAULT NULL,\n+  `password` varchar(128) DEFAULT NULL,\n+  `subscription_id` varchar(128) DEFAULT NULL,\n+  `subscription_key` varchar(128) DEFAULT NULL,\n+\n+  PRIMARY KEY (`id`)\n+)\n+COLLATE='utf8mb4_general_ci'\n+ENGINE=InnoDB;\n+\n+INSERT INTO `m_creditbureau_tokendata` (`id`, `userNames`, `password`, `subscription_id`, `subscription_key`) VALUES", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5ODUxMw==", "bodyText": "Come up with more generic design to store configurations of credit bureau, we can't have one table per credit bureau for storing configurations. You may have to refactor this token module.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r468298513", "createdAt": "2020-08-11T02:59:47Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/domain/CreditBureauTokenCredential.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.domain;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.Table;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.domain.AbstractPersistableCustom;\n+\n+@Entity", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5ODc0Nw==", "bodyText": "come up with more generic design to store configs.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r468298747", "createdAt": "2020-08-11T03:00:36Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/resources/sql/migrations/core_db/V273__oauth_changes.sql", "diffHunk": "@@ -59,3 +59,42 @@ CREATE TABLE `oauth_refresh_token` (\n )\n COLLATE='utf8mb4_general_ci'\n ENGINE=InnoDB;\n+\n+CREATE TABLE `m_creditbureau_tokendata` (\n+  `id` INT(128) NOT NULL AUTO_INCREMENT,\n+  `userNames` varchar(128) DEFAULT NULL,\n+  `password` varchar(128) DEFAULT NULL,\n+  `subscription_id` varchar(128) DEFAULT NULL,\n+  `subscription_key` varchar(128) DEFAULT NULL,\n+\n+  PRIMARY KEY (`id`)\n+)\n+COLLATE='utf8mb4_general_ci'\n+ENGINE=InnoDB;\n+\n+INSERT INTO `m_creditbureau_tokendata` (`id`, `userNames`, `password`, `subscription_id`, `subscription_key`) VALUES\n+('1', 'demomfi1@gmail.com','Sampleuser123*' ,'317A1FF8-625D-41BA-BE0F-F8ED8A644A7C', 'cb225c15ff1742feab2f1fb444393ace'),\n+('2', 'demomfi2@gmail.com','Sampleuser123*' ,'B76FEFF5-5B42-4A36-AFDA-AB5C7398220C', '91ce69a972b14c7fab057788fe61ce8a'),\n+('3', 'demomfi3@gmail.com','Sampleuser123*' ,'31333A80-BDE7-43EE-B1FD-6699C518AF85', '86f4f58542554e0ba9a309003eadd1fc'),\n+('4', 'demomfi4@gmail.com','Sampleuser123*' ,'C929C107-E779-4233-8493-176CF6DEA251', '302ed3b928df43ccb0de97f008b07320');\n+\n+-- permissions added\n+\n+\n+INSERT INTO `m_permission` (`grouping`, `code`, `entity_name`, `action_name`, `can_maker_checker`) VALUES ('configuration', 'CREATE_CREDITBUREAUTOKEN', 'CREDITBUREAUTOKEN', 'CREATE', 0);\n+INSERT INTO `m_permission` (`grouping`, `code`, `entity_name`, `action_name`, `can_maker_checker`) VALUES ('configuration', 'CREATE_CREDITBUREAUTOKENDATA', 'CREDITBUREAUTOKENDATA', 'CREATE', 0);\n+\n+CREATE TABLE `m_creditbureau_token` (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/59c95b91ad70a18fcf86856036298ff9cef3dee0", "committedDate": "2020-08-09T13:18:35Z", "message": "token and get_creditreport module completed"}, "afterCommit": {"oid": "4b23b921e64f38668861a2b5ca77174c96f8b467", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/4b23b921e64f38668861a2b5ca77174c96f8b467", "committedDate": "2020-08-11T06:48:23Z", "message": "token and get_creditreport module completed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b23b921e64f38668861a2b5ca77174c96f8b467", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/4b23b921e64f38668861a2b5ca77174c96f8b467", "committedDate": "2020-08-11T06:48:23Z", "message": "token and get_creditreport module completed"}, "afterCommit": {"oid": "261d516b6bf62d54f1d2444e2ce8dc906dde3a17", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/261d516b6bf62d54f1d2444e2ce8dc906dde3a17", "committedDate": "2020-08-21T18:39:46Z", "message": "token and get_creditreport module completed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "261d516b6bf62d54f1d2444e2ce8dc906dde3a17", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/261d516b6bf62d54f1d2444e2ce8dc906dde3a17", "committedDate": "2020-08-21T18:39:46Z", "message": "token and get_creditreport module completed"}, "afterCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/e34b1d52b6156fd7b86e97ab7e33a973f401f560", "committedDate": "2020-08-21T21:39:42Z", "message": "token and get_creditreport module completed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTY4OTEx", "url": "https://github.com/apache/fineract/pull/1235#pullrequestreview-472968911", "createdAt": "2020-08-22T23:44:55Z", "commit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQyMzo0NDo1NVrOHFI19A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QwMDoyMzoxOFrOHFI_9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE0OTgxMg==", "bodyText": "mark private", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475149812", "createdAt": "2020-08-22T23:44:55Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;\n+    Long uniqueID = 0L;\n+    String userName = \"\";\n+    String password = \"\";\n+    String subscriptionId = \"\";\n+    String subscriptionKey = \"\";\n+\n+    StringBuilder response = new StringBuilder();\n+    HttpURLConnection postConnection;\n+    String tokenDate;\n+    String token = null;\n+    String process = null;\n+    String result = null;\n+\n+    public void httpConnectionMethod() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE0OTg2NA==", "bodyText": "url should be part of configuration and should not be hard coded.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475149864", "createdAt": "2020-08-22T23:45:38Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;\n+    Long uniqueID = 0L;\n+    String userName = \"\";\n+    String password = \"\";\n+    String subscriptionId = \"\";\n+    String subscriptionKey = \"\";\n+\n+    StringBuilder response = new StringBuilder();\n+    HttpURLConnection postConnection;\n+    String tokenDate;\n+    String token = null;\n+    String process = null;\n+    String result = null;\n+\n+    public void httpConnectionMethod() {\n+        try {\n+            String readLine = null;\n+            String post_params = null;\n+\n+            if (process.equals(\"token\")) {\n+                LOG.info(\"-----creating new token-----\");\n+                post_params = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName + \"&\\r\\n\"\n+                        + \"password=\" + password + \"&\\r\\n\";\n+\n+                URL tokenurl = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE0OTkwNQ==", "bodyText": "same here", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475149905", "createdAt": "2020-08-22T23:46:23Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;\n+    Long uniqueID = 0L;\n+    String userName = \"\";\n+    String password = \"\";\n+    String subscriptionId = \"\";\n+    String subscriptionKey = \"\";\n+\n+    StringBuilder response = new StringBuilder();\n+    HttpURLConnection postConnection;\n+    String tokenDate;\n+    String token = null;\n+    String process = null;\n+    String result = null;\n+\n+    public void httpConnectionMethod() {\n+        try {\n+            String readLine = null;\n+            String post_params = null;\n+\n+            if (process.equals(\"token\")) {\n+                LOG.info(\"-----creating new token-----\");\n+                post_params = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName + \"&\\r\\n\"\n+                        + \"password=\" + password + \"&\\r\\n\";\n+\n+                URL tokenurl = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+                readLine = null;\n+                postConnection = (HttpURLConnection) tokenurl.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+                // Search Methods\n+                LOG.info(\"-----Search by NRC-----\");\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcId + \"&\";\n+\n+                URL NrcURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Search/SimpleSearch?nrc=\" + nrcId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE0OTkyNA==", "bodyText": "here as well", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475149924", "createdAt": "2020-08-22T23:46:38Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;\n+    Long uniqueID = 0L;\n+    String userName = \"\";\n+    String password = \"\";\n+    String subscriptionId = \"\";\n+    String subscriptionKey = \"\";\n+\n+    StringBuilder response = new StringBuilder();\n+    HttpURLConnection postConnection;\n+    String tokenDate;\n+    String token = null;\n+    String process = null;\n+    String result = null;\n+\n+    public void httpConnectionMethod() {\n+        try {\n+            String readLine = null;\n+            String post_params = null;\n+\n+            if (process.equals(\"token\")) {\n+                LOG.info(\"-----creating new token-----\");\n+                post_params = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName + \"&\\r\\n\"\n+                        + \"password=\" + password + \"&\\r\\n\";\n+\n+                URL tokenurl = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+                readLine = null;\n+                postConnection = (HttpURLConnection) tokenurl.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+                // Search Methods\n+                LOG.info(\"-----Search by NRC-----\");\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcId + \"&\";\n+\n+                URL NrcURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Search/SimpleSearch?nrc=\" + nrcId);\n+                postConnection = (HttpURLConnection) NrcURL.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            else if (process.equals(\"CREDITREPORT\")) {\n+                LOG.info(\"-----Search by CREDIT_REPORT-----\");\n+                URL CreditReportURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Dashboard/GetCreditReport?uniqueId=\" + uniqueID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDA0NA==", "bodyText": "please keep the scope of variables as small as possible. Applies to all the variables below", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475150044", "createdAt": "2020-08-22T23:48:48Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDExMQ==", "bodyText": "why do we need @CacheEvict", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475150111", "createdAt": "2020-08-22T23:49:39Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;\n+    Long uniqueID = 0L;\n+    String userName = \"\";\n+    String password = \"\";\n+    String subscriptionId = \"\";\n+    String subscriptionKey = \"\";\n+\n+    StringBuilder response = new StringBuilder();\n+    HttpURLConnection postConnection;\n+    String tokenDate;\n+    String token = null;\n+    String process = null;\n+    String result = null;\n+\n+    public void httpConnectionMethod() {\n+        try {\n+            String readLine = null;\n+            String post_params = null;\n+\n+            if (process.equals(\"token\")) {\n+                LOG.info(\"-----creating new token-----\");\n+                post_params = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName + \"&\\r\\n\"\n+                        + \"password=\" + password + \"&\\r\\n\";\n+\n+                URL tokenurl = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+                readLine = null;\n+                postConnection = (HttpURLConnection) tokenurl.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+                // Search Methods\n+                LOG.info(\"-----Search by NRC-----\");\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcId + \"&\";\n+\n+                URL NrcURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Search/SimpleSearch?nrc=\" + nrcId);\n+                postConnection = (HttpURLConnection) NrcURL.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            else if (process.equals(\"CREDITREPORT\")) {\n+                LOG.info(\"-----Search by CREDIT_REPORT-----\");\n+                URL CreditReportURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Dashboard/GetCreditReport?uniqueId=\" + uniqueID);\n+                postConnection = (HttpURLConnection) CreditReportURL.openConnection();\n+                postConnection.setRequestMethod(\"GET\");\n+\n+            }\n+\n+            // common set of headers\n+            postConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+            postConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+            postConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                postConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set of code only required for fetching uniqueID from Nrc fetched data (POST-SimpleSearch)\n+            if (process.equals(\"NRC\") || process.equals(\"token\")) {\n+                LOG.info(\"-----NRC & CREDITREPORT -----\");\n+                postConnection.setDoOutput(true);\n+                OutputStream os = postConnection.getOutputStream();\n+                os.write(post_params.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+\n+            }\n+\n+            // common part of code in http connection method\n+            int responseCode = postConnection.getResponseCode();\n+\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                response = new StringBuilder();\n+\n+                LOG.info(\"----- RESPONSE OK-----\");\n+                BufferedReader in = new BufferedReader(new InputStreamReader(postConnection.getInputStream(), StandardCharsets.UTF_8));\n+                while ((readLine = in.readLine()) != null) {\n+                    response.append(readLine);\n+                }\n+                in.close();\n+                result = response.toString();\n+\n+            } else {\n+                LOG.info(\"Request is Invalid\");\n+            }\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+    }\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    @CacheEvict(value = \"searchreport\", key = \"T(org.apache.fineract.infrastructure.core.service.ThreadLocalContextUtil).getTenant().getTenantIdentifier().concat('cv')\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 177}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDI3Nw==", "bodyText": "I liked this approach, its just that make process as parameter to this method.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475150277", "createdAt": "2020-08-22T23:52:27Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;\n+    Long uniqueID = 0L;\n+    String userName = \"\";\n+    String password = \"\";\n+    String subscriptionId = \"\";\n+    String subscriptionKey = \"\";\n+\n+    StringBuilder response = new StringBuilder();\n+    HttpURLConnection postConnection;\n+    String tokenDate;\n+    String token = null;\n+    String process = null;\n+    String result = null;\n+\n+    public void httpConnectionMethod() {\n+        try {\n+            String readLine = null;\n+            String post_params = null;\n+\n+            if (process.equals(\"token\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDM1NQ==", "bodyText": "Try resources could be helpful here, please check out the java doc.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475150355", "createdAt": "2020-08-22T23:53:36Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;\n+    Long uniqueID = 0L;\n+    String userName = \"\";\n+    String password = \"\";\n+    String subscriptionId = \"\";\n+    String subscriptionKey = \"\";\n+\n+    StringBuilder response = new StringBuilder();\n+    HttpURLConnection postConnection;\n+    String tokenDate;\n+    String token = null;\n+    String process = null;\n+    String result = null;\n+\n+    public void httpConnectionMethod() {\n+        try {\n+            String readLine = null;\n+            String post_params = null;\n+\n+            if (process.equals(\"token\")) {\n+                LOG.info(\"-----creating new token-----\");\n+                post_params = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName + \"&\\r\\n\"\n+                        + \"password=\" + password + \"&\\r\\n\";\n+\n+                URL tokenurl = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+                readLine = null;\n+                postConnection = (HttpURLConnection) tokenurl.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+                // Search Methods\n+                LOG.info(\"-----Search by NRC-----\");\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcId + \"&\";\n+\n+                URL NrcURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Search/SimpleSearch?nrc=\" + nrcId);\n+                postConnection = (HttpURLConnection) NrcURL.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            else if (process.equals(\"CREDITREPORT\")) {\n+                LOG.info(\"-----Search by CREDIT_REPORT-----\");\n+                URL CreditReportURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Dashboard/GetCreditReport?uniqueId=\" + uniqueID);\n+                postConnection = (HttpURLConnection) CreditReportURL.openConnection();\n+                postConnection.setRequestMethod(\"GET\");\n+\n+            }\n+\n+            // common set of headers\n+            postConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+            postConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+            postConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                postConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set of code only required for fetching uniqueID from Nrc fetched data (POST-SimpleSearch)\n+            if (process.equals(\"NRC\") || process.equals(\"token\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDg5OA==", "bodyText": "keep it simple : SimpleDateFormat df = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss.SSS\");", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475150898", "createdAt": "2020-08-23T00:01:42Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;\n+    Long uniqueID = 0L;\n+    String userName = \"\";\n+    String password = \"\";\n+    String subscriptionId = \"\";\n+    String subscriptionKey = \"\";\n+\n+    StringBuilder response = new StringBuilder();\n+    HttpURLConnection postConnection;\n+    String tokenDate;\n+    String token = null;\n+    String process = null;\n+    String result = null;\n+\n+    public void httpConnectionMethod() {\n+        try {\n+            String readLine = null;\n+            String post_params = null;\n+\n+            if (process.equals(\"token\")) {\n+                LOG.info(\"-----creating new token-----\");\n+                post_params = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName + \"&\\r\\n\"\n+                        + \"password=\" + password + \"&\\r\\n\";\n+\n+                URL tokenurl = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+                readLine = null;\n+                postConnection = (HttpURLConnection) tokenurl.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+                // Search Methods\n+                LOG.info(\"-----Search by NRC-----\");\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcId + \"&\";\n+\n+                URL NrcURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Search/SimpleSearch?nrc=\" + nrcId);\n+                postConnection = (HttpURLConnection) NrcURL.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            else if (process.equals(\"CREDITREPORT\")) {\n+                LOG.info(\"-----Search by CREDIT_REPORT-----\");\n+                URL CreditReportURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Dashboard/GetCreditReport?uniqueId=\" + uniqueID);\n+                postConnection = (HttpURLConnection) CreditReportURL.openConnection();\n+                postConnection.setRequestMethod(\"GET\");\n+\n+            }\n+\n+            // common set of headers\n+            postConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+            postConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+            postConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                postConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set of code only required for fetching uniqueID from Nrc fetched data (POST-SimpleSearch)\n+            if (process.equals(\"NRC\") || process.equals(\"token\")) {\n+                LOG.info(\"-----NRC & CREDITREPORT -----\");\n+                postConnection.setDoOutput(true);\n+                OutputStream os = postConnection.getOutputStream();\n+                os.write(post_params.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+\n+            }\n+\n+            // common part of code in http connection method\n+            int responseCode = postConnection.getResponseCode();\n+\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                response = new StringBuilder();\n+\n+                LOG.info(\"----- RESPONSE OK-----\");\n+                BufferedReader in = new BufferedReader(new InputStreamReader(postConnection.getInputStream(), StandardCharsets.UTF_8));\n+                while ((readLine = in.readLine()) != null) {\n+                    response.append(readLine);\n+                }\n+                in.close();\n+                result = response.toString();\n+\n+            } else {\n+                LOG.info(\"Request is Invalid\");\n+            }\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+    }\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    @CacheEvict(value = \"searchreport\", key = \"T(org.apache.fineract.infrastructure.core.service.ThreadLocalContextUtil).getTenant().getTenantIdentifier().concat('cv')\")\n+    public CreditReportData retrieveAllSearchReport(final String searchId) {\n+        String Name = null;\n+        String Gender = null;\n+        nrcId = searchId;\n+        String Address = null;\n+\n+        this.context.authenticatedUser();\n+\n+        final CreditBureauTokenCredential credittokendata = this.tokenDataRepository.getTokenCredential();\n+\n+        if (credittokendata != null) {\n+            userName = credittokendata.getUserName();\n+            password = credittokendata.getPassword();\n+            subscriptionId = credittokendata.getSubscriptionId();\n+            subscriptionKey = credittokendata.getSubscriptionKey();\n+\n+            // validation required, incase when configuration is not stored in database while fetching data.\n+        } else {\n+\n+            String configJson = \"{ 'userName':'\" + userName + \"','password':'\" + password + \"','subscriptionId':'\" + subscriptionId\n+                    + \"','subscriptionKey':'\" + subscriptionKey + \"'}\";\n+\n+            this.fromApiJsonDeserializer.validateForUsingTokenConfig(configJson);\n+        }\n+\n+        CreditBureauToken creditbureautoken = this.tokenRepository.getToken();\n+        LOG.info(\"creditbureautoken : {} \", creditbureautoken);\n+\n+        // check the expiry date of the previous token.\n+        if (creditbureautoken != null) {\n+            Date current = new Date();\n+            Date getExpiryDate = creditbureautoken.getTokenExpiryDate();\n+\n+            LOG.info(\"current date : {} \", current);\n+            LOG.info(\"getExpiryDate : {} \", getExpiryDate);\n+\n+            if (getExpiryDate.before(current)) {\n+                LOG.info(\"The token is expired\");\n+                this.tokenRepository.delete(creditbureautoken);\n+                creditbureautoken = null;\n+            }\n+        }\n+        // storing token if it is valid token(not expired)\n+        if (creditbureautoken != null) {\n+            token = creditbureautoken.getCurrentToken();\n+        }\n+\n+        // if token is not available or previous token is expired then create a new token\n+        if (creditbureautoken == null) {\n+\n+            // using common http connection method for creating token\n+            process = \"token\";\n+            this.httpConnectionMethod();\n+\n+            JsonObject tokenObject = JsonParser.parseString(result).getAsJsonObject();\n+            String expiresextra = tokenObject.get(\".expires\").toString();\n+            String expires = expiresextra.substring(1, expiresextra.length() - 1);\n+            DateFormat dateformat = new SimpleDateFormat(\"EEE, dd MMM yyyy kk:mm:ss zzz\", Locale.ENGLISH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 235}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDk2Ng==", "bodyText": "SimpleDateFormat df = new SimpleDateFormat(\"dd-MM-yyyy HH:mm:ss.SSS\");", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475150966", "createdAt": "2020-08-23T00:02:26Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/domain/CreditBureauToken.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package org.apache.fineract.infrastructure.creditbureau.domain;\n+\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.Table;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.domain.AbstractPersistableCustom;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Entity\n+@Table(name = \"m_creditbureau_token\")\n+public class CreditBureauToken extends AbstractPersistableCustom {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauToken.class);\n+\n+    @Column(name = \"username\")\n+    private String userName;\n+\n+    @Column(name = \"token\")\n+    private String accessToken;\n+\n+    @Column(name = \"token_type\")\n+    private String tokenType;\n+\n+    @Column(name = \"expires_in\")\n+    private String expiresIn;\n+\n+    @Column(name = \"issued\")\n+    private String issued;\n+\n+    @Column(name = \"expires\")\n+    private Date expires;\n+\n+    public CreditBureauToken(String userName, String accessToken, String tokenType, String expiresIn, String issued, Date expires) {\n+        this.userName = userName;\n+        this.accessToken = accessToken;\n+        this.tokenType = tokenType;\n+        this.expiresIn = expiresIn;\n+        this.issued = issued;\n+        this.expires = expires;\n+    }\n+\n+    public CreditBureauToken() {\n+        this.userName = null;\n+        this.accessToken = null;\n+        this.tokenType = null;\n+        this.expiresIn = null;\n+        this.issued = null;\n+        this.expires = null;\n+    }\n+\n+    public static CreditBureauToken fromJson(final JsonCommand command) {\n+        final String userName = command.stringValueOfParameterNamed(\"userName\");\n+        final String accessToken = command.stringValueOfParameterNamed(\"access_token\");\n+        final String tokenType = command.stringValueOfParameterNamed(\"token_type\");\n+        final String expiresIn = command.stringValueOfParameterNamed(\"expires_in\");\n+        final String issued = command.stringValueOfParameterNamed(\".issued\");\n+        final String expiry = command.stringValueOfParameterNamed(\".expires\");\n+\n+        LOG.info(\"Expiry {}\", expiry);\n+\n+        DateFormat dateformat = new SimpleDateFormat(\"EEE, dd MMM yyyy kk:mm:ss zzz\", Locale.ENGLISH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MTAwMw==", "bodyText": "did you intend to add this File in commit?", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475151003", "createdAt": "2020-08-23T00:03:04Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/config/swagger/fineract-input.yaml", "diffHunk": "@@ -0,0 +1,37 @@\n+openapi: 3.0.3", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MTU4OQ==", "bodyText": "I think result should be the return type of this method.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475151589", "createdAt": "2020-08-23T00:11:17Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;\n+    Long uniqueID = 0L;\n+    String userName = \"\";\n+    String password = \"\";\n+    String subscriptionId = \"\";\n+    String subscriptionKey = \"\";\n+\n+    StringBuilder response = new StringBuilder();\n+    HttpURLConnection postConnection;\n+    String tokenDate;\n+    String token = null;\n+    String process = null;\n+    String result = null;\n+\n+    public void httpConnectionMethod() {\n+        try {\n+            String readLine = null;\n+            String post_params = null;\n+\n+            if (process.equals(\"token\")) {\n+                LOG.info(\"-----creating new token-----\");\n+                post_params = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName + \"&\\r\\n\"\n+                        + \"password=\" + password + \"&\\r\\n\";\n+\n+                URL tokenurl = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+                readLine = null;\n+                postConnection = (HttpURLConnection) tokenurl.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+                // Search Methods\n+                LOG.info(\"-----Search by NRC-----\");\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcId + \"&\";\n+\n+                URL NrcURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Search/SimpleSearch?nrc=\" + nrcId);\n+                postConnection = (HttpURLConnection) NrcURL.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            else if (process.equals(\"CREDITREPORT\")) {\n+                LOG.info(\"-----Search by CREDIT_REPORT-----\");\n+                URL CreditReportURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Dashboard/GetCreditReport?uniqueId=\" + uniqueID);\n+                postConnection = (HttpURLConnection) CreditReportURL.openConnection();\n+                postConnection.setRequestMethod(\"GET\");\n+\n+            }\n+\n+            // common set of headers\n+            postConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+            postConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+            postConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                postConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set of code only required for fetching uniqueID from Nrc fetched data (POST-SimpleSearch)\n+            if (process.equals(\"NRC\") || process.equals(\"token\")) {\n+                LOG.info(\"-----NRC & CREDITREPORT -----\");\n+                postConnection.setDoOutput(true);\n+                OutputStream os = postConnection.getOutputStream();\n+                os.write(post_params.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+\n+            }\n+\n+            // common part of code in http connection method\n+            int responseCode = postConnection.getResponseCode();\n+\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                response = new StringBuilder();\n+\n+                LOG.info(\"----- RESPONSE OK-----\");\n+                BufferedReader in = new BufferedReader(new InputStreamReader(postConnection.getInputStream(), StandardCharsets.UTF_8));\n+                while ((readLine = in.readLine()) != null) {\n+                    response.append(readLine);\n+                }\n+                in.close();\n+                result = response.toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MTY5MQ==", "bodyText": "Get result as return type of httpConnectionMethod() and validate if it is null.\nProcessing it directly is a potential NPE.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475151691", "createdAt": "2020-08-23T00:12:51Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;\n+    Long uniqueID = 0L;\n+    String userName = \"\";\n+    String password = \"\";\n+    String subscriptionId = \"\";\n+    String subscriptionKey = \"\";\n+\n+    StringBuilder response = new StringBuilder();\n+    HttpURLConnection postConnection;\n+    String tokenDate;\n+    String token = null;\n+    String process = null;\n+    String result = null;\n+\n+    public void httpConnectionMethod() {\n+        try {\n+            String readLine = null;\n+            String post_params = null;\n+\n+            if (process.equals(\"token\")) {\n+                LOG.info(\"-----creating new token-----\");\n+                post_params = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName + \"&\\r\\n\"\n+                        + \"password=\" + password + \"&\\r\\n\";\n+\n+                URL tokenurl = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+                readLine = null;\n+                postConnection = (HttpURLConnection) tokenurl.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+                // Search Methods\n+                LOG.info(\"-----Search by NRC-----\");\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcId + \"&\";\n+\n+                URL NrcURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Search/SimpleSearch?nrc=\" + nrcId);\n+                postConnection = (HttpURLConnection) NrcURL.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            else if (process.equals(\"CREDITREPORT\")) {\n+                LOG.info(\"-----Search by CREDIT_REPORT-----\");\n+                URL CreditReportURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Dashboard/GetCreditReport?uniqueId=\" + uniqueID);\n+                postConnection = (HttpURLConnection) CreditReportURL.openConnection();\n+                postConnection.setRequestMethod(\"GET\");\n+\n+            }\n+\n+            // common set of headers\n+            postConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+            postConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+            postConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                postConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set of code only required for fetching uniqueID from Nrc fetched data (POST-SimpleSearch)\n+            if (process.equals(\"NRC\") || process.equals(\"token\")) {\n+                LOG.info(\"-----NRC & CREDITREPORT -----\");\n+                postConnection.setDoOutput(true);\n+                OutputStream os = postConnection.getOutputStream();\n+                os.write(post_params.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+\n+            }\n+\n+            // common part of code in http connection method\n+            int responseCode = postConnection.getResponseCode();\n+\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                response = new StringBuilder();\n+\n+                LOG.info(\"----- RESPONSE OK-----\");\n+                BufferedReader in = new BufferedReader(new InputStreamReader(postConnection.getInputStream(), StandardCharsets.UTF_8));\n+                while ((readLine = in.readLine()) != null) {\n+                    response.append(readLine);\n+                }\n+                in.close();\n+                result = response.toString();\n+\n+            } else {\n+                LOG.info(\"Request is Invalid\");\n+            }\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+    }\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    @CacheEvict(value = \"searchreport\", key = \"T(org.apache.fineract.infrastructure.core.service.ThreadLocalContextUtil).getTenant().getTenantIdentifier().concat('cv')\")\n+    public CreditReportData retrieveAllSearchReport(final String searchId) {\n+        String Name = null;\n+        String Gender = null;\n+        nrcId = searchId;\n+        String Address = null;\n+\n+        this.context.authenticatedUser();\n+\n+        final CreditBureauTokenCredential credittokendata = this.tokenDataRepository.getTokenCredential();\n+\n+        if (credittokendata != null) {\n+            userName = credittokendata.getUserName();\n+            password = credittokendata.getPassword();\n+            subscriptionId = credittokendata.getSubscriptionId();\n+            subscriptionKey = credittokendata.getSubscriptionKey();\n+\n+            // validation required, incase when configuration is not stored in database while fetching data.\n+        } else {\n+\n+            String configJson = \"{ 'userName':'\" + userName + \"','password':'\" + password + \"','subscriptionId':'\" + subscriptionId\n+                    + \"','subscriptionKey':'\" + subscriptionKey + \"'}\";\n+\n+            this.fromApiJsonDeserializer.validateForUsingTokenConfig(configJson);\n+        }\n+\n+        CreditBureauToken creditbureautoken = this.tokenRepository.getToken();\n+        LOG.info(\"creditbureautoken : {} \", creditbureautoken);\n+\n+        // check the expiry date of the previous token.\n+        if (creditbureautoken != null) {\n+            Date current = new Date();\n+            Date getExpiryDate = creditbureautoken.getTokenExpiryDate();\n+\n+            LOG.info(\"current date : {} \", current);\n+            LOG.info(\"getExpiryDate : {} \", getExpiryDate);\n+\n+            if (getExpiryDate.before(current)) {\n+                LOG.info(\"The token is expired\");\n+                this.tokenRepository.delete(creditbureautoken);\n+                creditbureautoken = null;\n+            }\n+        }\n+        // storing token if it is valid token(not expired)\n+        if (creditbureautoken != null) {\n+            token = creditbureautoken.getCurrentToken();\n+        }\n+\n+        // if token is not available or previous token is expired then create a new token\n+        if (creditbureautoken == null) {\n+\n+            // using common http connection method for creating token\n+            process = \"token\";\n+            this.httpConnectionMethod();\n+\n+            JsonObject tokenObject = JsonParser.parseString(result).getAsJsonObject();\n+            String expiresextra = tokenObject.get(\".expires\").toString();\n+            String expires = expiresextra.substring(1, expiresextra.length() - 1);\n+            DateFormat dateformat = new SimpleDateFormat(\"EEE, dd MMM yyyy kk:mm:ss zzz\", Locale.ENGLISH);\n+            try {\n+                Date getExpiryDate = dateformat.parse(expires);\n+                LOG.info(\"The expirydate {}\", getExpiryDate);\n+            } catch (ParseException Ex) {\n+                LOG.error(\"Error occured.\", Ex);\n+            }\n+\n+            // created token will be storing it into database\n+            final CommandWrapper wrapper = new CommandWrapperBuilder().withJson(result).build();\n+            final String json = wrapper.getJson();\n+            result = null;\n+            JsonCommand apicommand = null;\n+            boolean isApprovedByChecker = false;\n+            final JsonElement parsedCommand = this.fromApiJsonHelper.parse(json);\n+\n+            apicommand = JsonCommand.from(json, parsedCommand, this.fromApiJsonHelper, wrapper.getEntityName(), wrapper.getEntityId(),\n+                    wrapper.getSubentityId(), wrapper.getGroupId(), wrapper.getClientId(), wrapper.getLoanId(), wrapper.getSavingsId(),\n+                    wrapper.getTransactionId(), wrapper.getHref(), wrapper.getProductId(), wrapper.getCreditBureauId(),\n+                    wrapper.getOrganisationCreditBureauId());\n+\n+            this.fromApiJsonDeserializer.validateForCreate(apicommand.json());\n+\n+            final CreditBureauToken generatedtoken = CreditBureauToken.fromJson(apicommand);\n+\n+            // saved new token\n+            this.tokenRepository.save(generatedtoken);\n+\n+            // fetched\n+            creditbureautoken = this.tokenRepository.getToken();\n+            token = creditbureautoken.getCurrentToken();\n+\n+            // at this stage token is available for all cases i.e.(deleted expired token and saved new token)\n+        }\n+\n+        // will use only \"NRC\" part of code from common http method to get data based on nrc\n+        process = \"NRC\";\n+        this.httpConnectionMethod();\n+\n+        // after fetching the data from httpconnection it will be come back here for fetching UniqueID from data\n+        if (process.equals(\"NRC\")) {\n+\n+            // to fetch the Unique ID from Result\n+            JsonObject jsonObject = JsonParser.parseString(result).getAsJsonObject();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 278}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MjE5NA==", "bodyText": "is there a better way to do this null check?\nusing instanceof is not considered as good practice:\nhttps://dzone.com/articles/instanceof-considered-harmful", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475152194", "createdAt": "2020-08-23T00:20:11Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauReportsReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,347 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.text.DateFormat;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauReportsReadPlatformServiceImpl implements CreditBureauReportsReadPlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauReportsReadPlatformServiceImpl.class);\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public CreditBureauReportsReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    String nrcId = null;\n+    Long uniqueID = 0L;\n+    String userName = \"\";\n+    String password = \"\";\n+    String subscriptionId = \"\";\n+    String subscriptionKey = \"\";\n+\n+    StringBuilder response = new StringBuilder();\n+    HttpURLConnection postConnection;\n+    String tokenDate;\n+    String token = null;\n+    String process = null;\n+    String result = null;\n+\n+    public void httpConnectionMethod() {\n+        try {\n+            String readLine = null;\n+            String post_params = null;\n+\n+            if (process.equals(\"token\")) {\n+                LOG.info(\"-----creating new token-----\");\n+                post_params = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName + \"&\\r\\n\"\n+                        + \"password=\" + password + \"&\\r\\n\";\n+\n+                URL tokenurl = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+                readLine = null;\n+                postConnection = (HttpURLConnection) tokenurl.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+                // Search Methods\n+                LOG.info(\"-----Search by NRC-----\");\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcId + \"&\";\n+\n+                URL NrcURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Search/SimpleSearch?nrc=\" + nrcId);\n+                postConnection = (HttpURLConnection) NrcURL.openConnection();\n+                postConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            else if (process.equals(\"CREDITREPORT\")) {\n+                LOG.info(\"-----Search by CREDIT_REPORT-----\");\n+                URL CreditReportURL = new URL(\"https://mmcix.azure-api.net/qa/20200324/api/Dashboard/GetCreditReport?uniqueId=\" + uniqueID);\n+                postConnection = (HttpURLConnection) CreditReportURL.openConnection();\n+                postConnection.setRequestMethod(\"GET\");\n+\n+            }\n+\n+            // common set of headers\n+            postConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+            postConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+            postConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                postConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set of code only required for fetching uniqueID from Nrc fetched data (POST-SimpleSearch)\n+            if (process.equals(\"NRC\") || process.equals(\"token\")) {\n+                LOG.info(\"-----NRC & CREDITREPORT -----\");\n+                postConnection.setDoOutput(true);\n+                OutputStream os = postConnection.getOutputStream();\n+                os.write(post_params.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+\n+            }\n+\n+            // common part of code in http connection method\n+            int responseCode = postConnection.getResponseCode();\n+\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                response = new StringBuilder();\n+\n+                LOG.info(\"----- RESPONSE OK-----\");\n+                BufferedReader in = new BufferedReader(new InputStreamReader(postConnection.getInputStream(), StandardCharsets.UTF_8));\n+                while ((readLine = in.readLine()) != null) {\n+                    response.append(readLine);\n+                }\n+                in.close();\n+                result = response.toString();\n+\n+            } else {\n+                LOG.info(\"Request is Invalid\");\n+            }\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+    }\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    @CacheEvict(value = \"searchreport\", key = \"T(org.apache.fineract.infrastructure.core.service.ThreadLocalContextUtil).getTenant().getTenantIdentifier().concat('cv')\")\n+    public CreditReportData retrieveAllSearchReport(final String searchId) {\n+        String Name = null;\n+        String Gender = null;\n+        nrcId = searchId;\n+        String Address = null;\n+\n+        this.context.authenticatedUser();\n+\n+        final CreditBureauTokenCredential credittokendata = this.tokenDataRepository.getTokenCredential();\n+\n+        if (credittokendata != null) {\n+            userName = credittokendata.getUserName();\n+            password = credittokendata.getPassword();\n+            subscriptionId = credittokendata.getSubscriptionId();\n+            subscriptionKey = credittokendata.getSubscriptionKey();\n+\n+            // validation required, incase when configuration is not stored in database while fetching data.\n+        } else {\n+\n+            String configJson = \"{ 'userName':'\" + userName + \"','password':'\" + password + \"','subscriptionId':'\" + subscriptionId\n+                    + \"','subscriptionKey':'\" + subscriptionKey + \"'}\";\n+\n+            this.fromApiJsonDeserializer.validateForUsingTokenConfig(configJson);\n+        }\n+\n+        CreditBureauToken creditbureautoken = this.tokenRepository.getToken();\n+        LOG.info(\"creditbureautoken : {} \", creditbureautoken);\n+\n+        // check the expiry date of the previous token.\n+        if (creditbureautoken != null) {\n+            Date current = new Date();\n+            Date getExpiryDate = creditbureautoken.getTokenExpiryDate();\n+\n+            LOG.info(\"current date : {} \", current);\n+            LOG.info(\"getExpiryDate : {} \", getExpiryDate);\n+\n+            if (getExpiryDate.before(current)) {\n+                LOG.info(\"The token is expired\");\n+                this.tokenRepository.delete(creditbureautoken);\n+                creditbureautoken = null;\n+            }\n+        }\n+        // storing token if it is valid token(not expired)\n+        if (creditbureautoken != null) {\n+            token = creditbureautoken.getCurrentToken();\n+        }\n+\n+        // if token is not available or previous token is expired then create a new token\n+        if (creditbureautoken == null) {\n+\n+            // using common http connection method for creating token\n+            process = \"token\";\n+            this.httpConnectionMethod();\n+\n+            JsonObject tokenObject = JsonParser.parseString(result).getAsJsonObject();\n+            String expiresextra = tokenObject.get(\".expires\").toString();\n+            String expires = expiresextra.substring(1, expiresextra.length() - 1);\n+            DateFormat dateformat = new SimpleDateFormat(\"EEE, dd MMM yyyy kk:mm:ss zzz\", Locale.ENGLISH);\n+            try {\n+                Date getExpiryDate = dateformat.parse(expires);\n+                LOG.info(\"The expirydate {}\", getExpiryDate);\n+            } catch (ParseException Ex) {\n+                LOG.error(\"Error occured.\", Ex);\n+            }\n+\n+            // created token will be storing it into database\n+            final CommandWrapper wrapper = new CommandWrapperBuilder().withJson(result).build();\n+            final String json = wrapper.getJson();\n+            result = null;\n+            JsonCommand apicommand = null;\n+            boolean isApprovedByChecker = false;\n+            final JsonElement parsedCommand = this.fromApiJsonHelper.parse(json);\n+\n+            apicommand = JsonCommand.from(json, parsedCommand, this.fromApiJsonHelper, wrapper.getEntityName(), wrapper.getEntityId(),\n+                    wrapper.getSubentityId(), wrapper.getGroupId(), wrapper.getClientId(), wrapper.getLoanId(), wrapper.getSavingsId(),\n+                    wrapper.getTransactionId(), wrapper.getHref(), wrapper.getProductId(), wrapper.getCreditBureauId(),\n+                    wrapper.getOrganisationCreditBureauId());\n+\n+            this.fromApiJsonDeserializer.validateForCreate(apicommand.json());\n+\n+            final CreditBureauToken generatedtoken = CreditBureauToken.fromJson(apicommand);\n+\n+            // saved new token\n+            this.tokenRepository.save(generatedtoken);\n+\n+            // fetched\n+            creditbureautoken = this.tokenRepository.getToken();\n+            token = creditbureautoken.getCurrentToken();\n+\n+            // at this stage token is available for all cases i.e.(deleted expired token and saved new token)\n+        }\n+\n+        // will use only \"NRC\" part of code from common http method to get data based on nrc\n+        process = \"NRC\";\n+        this.httpConnectionMethod();\n+\n+        // after fetching the data from httpconnection it will be come back here for fetching UniqueID from data\n+        if (process.equals(\"NRC\")) {\n+\n+            // to fetch the Unique ID from Result\n+            JsonObject jsonObject = JsonParser.parseString(result).getAsJsonObject();\n+            JsonArray jArray = jsonObject.getAsJsonArray(\"Data\");\n+            JsonObject jobject = jArray.get(0).getAsJsonObject();\n+            String uniqueIdString = jobject.get(\"UniqueID\").toString();\n+\n+            // cleaned the uniqueID value. Example id: \"123\" to 123\n+            String TrimUniqueId = uniqueIdString.substring(1, uniqueIdString.length() - 1);\n+\n+            // unique ID is stored\n+            uniqueID = Long.parseLong(TrimUniqueId);\n+\n+            // will use \"CREDITREPORT\" part of code from common http method to fetch creditreport based on UniqueID\n+            process = \"CREDITREPORT\";\n+            this.httpConnectionMethod();\n+\n+        }\n+\n+        // after fetching the data from httpconnection it will be come back here to assign data(result) to generic\n+        // creditreportdata object\n+\n+        JsonObject reportObject = JsonParser.parseString(result).getAsJsonObject();\n+\n+        JsonObject borrowerInfo = null;\n+        JsonObject CreditScore = null;\n+        JsonArray ActiveLoans = null;\n+        JsonArray PaidLoans = null;\n+\n+        // Credit Reports Stored into Generic CreditReportData\n+        JsonObject data = null;\n+        JsonElement element = reportObject.get(\"Data\");\n+\n+        if (!(element instanceof JsonNull)) { // NOTE : \"element instanceof JsonNull\" is for handling empty values (and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560"}, "originalPosition": 309}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MjM3NQ==", "bodyText": "i don't see a method.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r475152375", "createdAt": "2020-08-23T00:23:18Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditBureauTokenWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonElement;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.commands.service.PortfolioCommandSourceWritePlatformService;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResultBuilder;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenCredential;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauTokenRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenDataRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditBureauTokenWritePlatformServiceImpl implements CreditBureauTokenWritePlatformService {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauTokenWritePlatformServiceImpl.class);\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final CreditBureauTokenRepository creditBureauTokenRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+    private final CreditBureauTokenReadPlatformService readPlatformServiceCreditBureauToken;\n+    private final PortfolioCommandSourceWritePlatformService commandsSourceWritePlatformService;\n+    private final CreditBureauToken creditBureauToken;\n+    private final TokenDataRepository tokendatRepository;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final TokenDataRepositoryWrapper tokenDataRepository;\n+    private static String tokenstr;\n+    private final JdbcTemplate jdbcTemplate;\n+\n+    @Autowired\n+    public CreditBureauTokenWritePlatformServiceImpl(final PlatformSecurityContext context,\n+            final CreditBureauTokenRepository creditBureauTokenRepository, final TokenRepositoryWrapper tokenRepository,\n+            final TokenDataRepositoryWrapper tokenDataRepository, final TokenDataRepository tokendatRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer, final FromJsonHelper fromApiJsonHelper,\n+            final CreditBureauTokenReadPlatformService readPlatformServiceCreditBureauToken,\n+            final PortfolioCommandSourceWritePlatformService commandsSourceWritePlatformService, final CreditBureauToken creditBureauToken,\n+            final RoutingDataSource dataSource) {\n+        this.context = context;\n+        this.creditBureauTokenRepository = creditBureauTokenRepository;\n+        this.tokenDataRepository = tokenDataRepository;\n+        this.tokenRepository = tokenRepository;\n+        this.tokendatRepository = tokendatRepository;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.readPlatformServiceCreditBureauToken = readPlatformServiceCreditBureauToken;\n+        this.commandsSourceWritePlatformService = commandsSourceWritePlatformService;\n+        this.creditBureauToken = creditBureauToken;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+    }\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    @CacheEvict(value = \"credittoken\", key = \"T(org.apache.fineract.infrastructure.core.service.ThreadLocalContextUtil).getTenant().getTenantIdentifier().concat('cv')\")\n+    public CommandProcessingResult createCreditBureauToken(JsonCommand command) {\n+        try {\n+            this.context.authenticatedUser();\n+\n+            // fetch the token credentials for using it in header\n+            final CreditBureauTokenCredential credittokendata = this.tokenDataRepository.getTokenCredential();\n+\n+            String userName = credittokendata.getUserName();\n+            String password = credittokendata.getPassword();\n+            String subscriptionId = credittokendata.getSubscriptionId();\n+            String subscriptionKey = credittokendata.getSubscriptionKey();\n+\n+            final String POST_PARAMS = \"\\n\" + \"BODY=x-www-form-urlencoded&\\r\\n\" + \"grant_type=password&\\r\\n\" + \"userName=\" + userName\n+                    + \"&\\r\\n\" + \"password=\" + password + \"&\\r\\n\";\n+\n+            URL obj = new URL(\"https://mmcix.azure-api.net/qa/20200324/Token\");\n+            String readLine = null;\n+\n+            HttpURLConnection postConnection = (HttpURLConnection) obj.openConnection();\n+            postConnection.setRequestMethod(\"POST\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI5NzU4MA=="}, "originalCommit": {"oid": "59c95b91ad70a18fcf86856036298ff9cef3dee0"}, "originalPosition": 115}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e34b1d52b6156fd7b86e97ab7e33a973f401f560", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/e34b1d52b6156fd7b86e97ab7e33a973f401f560", "committedDate": "2020-08-21T21:39:42Z", "message": "token and get_creditreport module completed"}, "afterCommit": {"oid": "cd4212339e062bec85f033e27bdd6bd95db8fda0", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/cd4212339e062bec85f033e27bdd6bd95db8fda0", "committedDate": "2020-09-22T07:11:28Z", "message": "Credit_Bureau_Phase3 (FINERACT-734)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd4212339e062bec85f033e27bdd6bd95db8fda0", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/cd4212339e062bec85f033e27bdd6bd95db8fda0", "committedDate": "2020-09-22T07:11:28Z", "message": "Credit_Bureau_Phase3 (FINERACT-734)"}, "afterCommit": {"oid": "69eb3d215b59b7a0a8c152e8ee2dc423922cda17", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/69eb3d215b59b7a0a8c152e8ee2dc423922cda17", "committedDate": "2020-09-22T08:53:08Z", "message": "Credit_Bureau_Phase3 (FINERACT-734)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "268bc3f241a9c5cf5bdb8cd35d6ef48596602508", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/268bc3f241a9c5cf5bdb8cd35d6ef48596602508", "committedDate": "2020-09-25T14:00:50Z", "message": "Submit-creditReport and Configuration modification"}, "afterCommit": {"oid": "643fef05a5c12247bbcb9e40f405d461f0003790", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/643fef05a5c12247bbcb9e40f405d461f0003790", "committedDate": "2020-09-25T14:07:00Z", "message": "Submit-creditReport and Configuration modification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "643fef05a5c12247bbcb9e40f405d461f0003790", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/643fef05a5c12247bbcb9e40f405d461f0003790", "committedDate": "2020-09-25T14:07:00Z", "message": "Submit-creditReport and Configuration modification"}, "afterCommit": {"oid": "df8b070742979c7da096d06b217d2e188b74ecb1", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/df8b070742979c7da096d06b217d2e188b74ecb1", "committedDate": "2020-09-25T16:28:58Z", "message": "Submit-creditReport and Configuration modification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNzAwMDc1", "url": "https://github.com/apache/fineract/pull/1235#pullrequestreview-501700075", "createdAt": "2020-10-05T03:09:16Z", "commit": {"oid": "df8b070742979c7da096d06b217d2e188b74ecb1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwMzowOToxN1rOHcMinw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwMzowOToxN1rOHcMinw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMyNzY0Nw==", "bodyText": "is this the format of date we get from creditbureau?", "url": "https://github.com/apache/fineract/pull/1235#discussion_r499327647", "createdAt": "2020-10-05T03:09:17Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/domain/CreditBureauToken.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package org.apache.fineract.infrastructure.creditbureau.domain;\n+\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.Table;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.domain.AbstractPersistableCustom;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Entity\n+@Table(name = \"m_creditbureau_token\")\n+public class CreditBureauToken extends AbstractPersistableCustom {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauToken.class);\n+\n+    @Column(name = \"username\")\n+    private String userName;\n+\n+    @Column(name = \"token\")\n+    private String accessToken;\n+\n+    @Column(name = \"token_type\")\n+    private String tokenType;\n+\n+    @Column(name = \"expires_in\")\n+    private String expiresIn;\n+\n+    @Column(name = \"issued\")\n+    private String issued;\n+\n+    @Column(name = \"expires\")\n+    private Date expires;\n+\n+    public CreditBureauToken(String userName, String accessToken, String tokenType, String expiresIn, String issued, Date expires) {\n+        this.userName = userName;\n+        this.accessToken = accessToken;\n+        this.tokenType = tokenType;\n+        this.expiresIn = expiresIn;\n+        this.issued = issued;\n+        this.expires = expires;\n+    }\n+\n+    public CreditBureauToken() {\n+        this.userName = null;\n+        this.accessToken = null;\n+        this.tokenType = null;\n+        this.expiresIn = null;\n+        this.issued = null;\n+        this.expires = null;\n+    }\n+\n+    public static CreditBureauToken fromJson(final JsonCommand command) {\n+        final String userName = command.stringValueOfParameterNamed(\"userName\");\n+        final String accessToken = command.stringValueOfParameterNamed(\"access_token\");\n+        final String tokenType = command.stringValueOfParameterNamed(\"token_type\");\n+        final String expiresIn = command.stringValueOfParameterNamed(\"expires_in\");\n+        final String issued = command.stringValueOfParameterNamed(\".issued\");\n+        final String expiry = command.stringValueOfParameterNamed(\".expires\");\n+\n+        SimpleDateFormat dateformat = new SimpleDateFormat(\"EEE, dd MMM yyyy kk:mm:ss zzz\", Locale.ENGLISH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df8b070742979c7da096d06b217d2e188b74ecb1"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNzA1MzI3", "url": "https://github.com/apache/fineract/pull/1235#pullrequestreview-501705327", "createdAt": "2020-10-05T03:35:29Z", "commit": {"oid": "df8b070742979c7da096d06b217d2e188b74ecb1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwMzozNToyOVrOHcMztw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwMzozNToyOVrOHcMztw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMzMjAyMw==", "bodyText": "why are we using File in http request", "url": "https://github.com/apache/fineract/pull/1235#discussion_r499332023", "createdAt": "2020-10-05T03:35:29Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditReportWritePlatformServiceImpl.java", "diffHunk": "@@ -95,7 +95,7 @@ public CreditReportWritePlatformServiceImpl(final PlatformSecurityContext contex\n     private static final Logger LOG = LoggerFactory.getLogger(CreditReportWritePlatformServiceImpl.class);\n \n     public String httpConnectionMethod(String process, String nrcID, String userName, String password, String subscriptionKey,\n-            String subscriptionId, String url, String token, Long uniqueID) {\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df8b070742979c7da096d06b217d2e188b74ecb1"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd8d5fd33f6c9cffb5dcf2217dd30eddcc2c5eaf", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/bd8d5fd33f6c9cffb5dcf2217dd30eddcc2c5eaf", "committedDate": "2020-10-25T13:35:07Z", "message": "separeted-thitsawork-with-generic"}, "afterCommit": {"oid": "90bf8686f7b991428caef883ab2b69492a7fc640", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/90bf8686f7b991428caef883ab2b69492a7fc640", "committedDate": "2020-10-25T13:50:17Z", "message": "separeted-thitsawork-with-generic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90bf8686f7b991428caef883ab2b69492a7fc640", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/90bf8686f7b991428caef883ab2b69492a7fc640", "committedDate": "2020-10-25T13:50:17Z", "message": "separeted-thitsawork-with-generic"}, "afterCommit": {"oid": "1b26e5e64cd26dfb4073c82fd245e4aa2b954243", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/1b26e5e64cd26dfb4073c82fd245e4aa2b954243", "committedDate": "2020-10-25T15:17:41Z", "message": "separeted-thitsawork-with-generic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b26e5e64cd26dfb4073c82fd245e4aa2b954243", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/1b26e5e64cd26dfb4073c82fd245e4aa2b954243", "committedDate": "2020-10-25T15:17:41Z", "message": "separeted-thitsawork-with-generic"}, "afterCommit": {"oid": "3b9f7c63c9bd06ba7cdcb6658d31bb9906eef513", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/3b9f7c63c9bd06ba7cdcb6658d31bb9906eef513", "committedDate": "2020-10-26T14:06:16Z", "message": "spotless-apply"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzM0Mjkz", "url": "https://github.com/apache/fineract/pull/1235#pullrequestreview-517334293", "createdAt": "2020-10-27T04:07:33Z", "commit": {"oid": "3b9f7c63c9bd06ba7cdcb6658d31bb9906eef513"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDowNzozNFrOHoqtZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDowNzozNFrOHoqtZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwNDgzOQ==", "bodyText": "potential null pointer excption", "url": "https://github.com/apache/fineract/pull/1235#discussion_r512404839", "createdAt": "2020-10-27T04:07:34Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditReportWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.File;\n+import java.util.NoSuchElementException;\n+import javax.persistence.PersistenceException;\n+import org.apache.commons.lang3.exception.ExceptionUtils;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResultBuilder;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditBureaNames;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureau;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfiguration;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauLoanProductMappingRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.dao.DataIntegrityViolationException;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditReportWritePlatformServiceImpl implements CreditReportWritePlatformService {\n+\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+    private final CreditBureauLoanProductMappingRepository loanProductMappingRepository;\n+    private final CreditBureauRepository creditBureauRepository;\n+    private final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService;\n+\n+    @Autowired\n+    public CreditReportWritePlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer,\n+            final CreditBureauLoanProductMappingRepository loanProductMappingRepository,\n+            final CreditBureauRepository creditBureauRepository,\n+            final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.configDataRepository = configDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+        this.loanProductMappingRepository = loanProductMappingRepository;\n+        this.creditBureauRepository = creditBureauRepository;\n+        this.thitsaWorksCreditBureauIntegrationWritePlatformService = thitsaWorksCreditBureauIntegrationWritePlatformService;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditReportWritePlatformServiceImpl.class);\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    public CommandProcessingResult getCreditReport(JsonCommand command) {\n+\n+        try {\n+            this.context.authenticatedUser();\n+\n+            String creditBureauID = command.stringValueOfParameterNamed(\"creditBureauID\");\n+\n+            String creditBureauName = getCreditBureau(creditBureauID);\n+\n+            CreditReportData reportobj = null;\n+\n+            if (creditBureauName.equals(CreditBureaNames.THITSAWORKS.toString())) {\n+                reportobj = this.thitsaWorksCreditBureauIntegrationWritePlatformService.getCreditReportFromThitsaWorks(command);\n+            }\n+\n+            return new CommandProcessingResultBuilder().withCreditReport(reportobj).build();\n+        } catch (final DataIntegrityViolationException dve) {\n+            handleTokenDataIntegrityIssues(command, dve.getMostSpecificCause(), dve);\n+            return CommandProcessingResult.empty();\n+        } catch (final PersistenceException ee) {\n+            Throwable throwable = ExceptionUtils.getRootCause(ee.getCause());\n+            handleTokenDataIntegrityIssues(command, throwable, ee);\n+            return CommandProcessingResult.empty();\n+        }\n+\n+    }\n+\n+    private String getCreditBureau(final String creditBureauID) {\n+\n+        String creditBureauName = null;\n+        CreditBureau creditBureau = null;\n+        if (creditBureauID != null) {\n+\n+            Long bureauID = Long.parseLong(creditBureauID);\n+\n+            try {\n+                creditBureau = this.creditBureauRepository.findById(bureauID).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b9f7c63c9bd06ba7cdcb6658d31bb9906eef513"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzM0NDMx", "url": "https://github.com/apache/fineract/pull/1235#pullrequestreview-517334431", "createdAt": "2020-10-27T04:08:02Z", "commit": {"oid": "3b9f7c63c9bd06ba7cdcb6658d31bb9906eef513"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDowODowM1rOHoqt2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDowODowM1rOHoqt2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwNDk1Mg==", "bodyText": "I think, if string does not match you should let client know,", "url": "https://github.com/apache/fineract/pull/1235#discussion_r512404952", "createdAt": "2020-10-27T04:08:03Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditReportWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.File;\n+import java.util.NoSuchElementException;\n+import javax.persistence.PersistenceException;\n+import org.apache.commons.lang3.exception.ExceptionUtils;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResultBuilder;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditBureaNames;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureau;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfiguration;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauLoanProductMappingRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.dao.DataIntegrityViolationException;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditReportWritePlatformServiceImpl implements CreditReportWritePlatformService {\n+\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+    private final CreditBureauLoanProductMappingRepository loanProductMappingRepository;\n+    private final CreditBureauRepository creditBureauRepository;\n+    private final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService;\n+\n+    @Autowired\n+    public CreditReportWritePlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer,\n+            final CreditBureauLoanProductMappingRepository loanProductMappingRepository,\n+            final CreditBureauRepository creditBureauRepository,\n+            final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.configDataRepository = configDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+        this.loanProductMappingRepository = loanProductMappingRepository;\n+        this.creditBureauRepository = creditBureauRepository;\n+        this.thitsaWorksCreditBureauIntegrationWritePlatformService = thitsaWorksCreditBureauIntegrationWritePlatformService;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditReportWritePlatformServiceImpl.class);\n+\n+    @SuppressWarnings({ \"CatchAndPrintStackTrace\", \"DefaultCharset\" })\n+    @Override\n+    @Transactional\n+    public CommandProcessingResult getCreditReport(JsonCommand command) {\n+\n+        try {\n+            this.context.authenticatedUser();\n+\n+            String creditBureauID = command.stringValueOfParameterNamed(\"creditBureauID\");\n+\n+            String creditBureauName = getCreditBureau(creditBureauID);\n+\n+            CreditReportData reportobj = null;\n+\n+            if (creditBureauName.equals(CreditBureaNames.THITSAWORKS.toString())) {\n+                reportobj = this.thitsaWorksCreditBureauIntegrationWritePlatformService.getCreditReportFromThitsaWorks(command);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b9f7c63c9bd06ba7cdcb6658d31bb9906eef513"}, "originalPosition": 100}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b9f7c63c9bd06ba7cdcb6658d31bb9906eef513", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/3b9f7c63c9bd06ba7cdcb6658d31bb9906eef513", "committedDate": "2020-10-26T14:06:16Z", "message": "spotless-apply"}, "afterCommit": {"oid": "c60a32386c1c2a10b1b4fe29a84d26923999eda1", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/c60a32386c1c2a10b1b4fe29a84d26923999eda1", "committedDate": "2020-11-07T21:02:41Z", "message": "cleaned-and-fixed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c60a32386c1c2a10b1b4fe29a84d26923999eda1", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/c60a32386c1c2a10b1b4fe29a84d26923999eda1", "committedDate": "2020-11-07T21:02:41Z", "message": "cleaned-and-fixed"}, "afterCommit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/ccfdc2a8c8da9244116744073dc32ed576c93c24", "committedDate": "2020-11-08T19:01:23Z", "message": "cleaned-and-fixed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1ODQyNjkz", "url": "https://github.com/apache/fineract/pull/1235#pullrequestreview-525842693", "createdAt": "2020-11-08T20:35:10Z", "commit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMDozNToxMVrOHvaKqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMTo1NjozMVrOHvaspQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3MzgzNA==", "bodyText": "Can we have subscriptionId and other config params as enums?", "url": "https://github.com/apache/fineract/pull/1235#discussion_r519473834", "createdAt": "2020-11-08T20:35:11Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditReportWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,248 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Objects;\n+import java.util.Optional;\n+import javax.persistence.PersistenceException;\n+import org.apache.commons.lang3.exception.ExceptionUtils;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResultBuilder;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditBureaNames;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureau;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfiguration;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauLoanProductMappingRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditReport;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditReportRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.dao.DataIntegrityViolationException;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditReportWritePlatformServiceImpl implements CreditReportWritePlatformService {\n+\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+    private final CreditBureauLoanProductMappingRepository loanProductMappingRepository;\n+    private final CreditBureauRepository creditBureauRepository;\n+    private final CreditReportRepository creditReportRepository;\n+    private final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService;\n+\n+    @Autowired\n+    public CreditReportWritePlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer,\n+            final CreditBureauLoanProductMappingRepository loanProductMappingRepository,\n+            final CreditBureauRepository creditBureauRepository, final CreditReportRepository creditReportRepository,\n+            final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.configDataRepository = configDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+        this.loanProductMappingRepository = loanProductMappingRepository;\n+        this.creditBureauRepository = creditBureauRepository;\n+        this.creditReportRepository = creditReportRepository;\n+        this.thitsaWorksCreditBureauIntegrationWritePlatformService = thitsaWorksCreditBureauIntegrationWritePlatformService;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditReportWritePlatformServiceImpl.class);\n+\n+    @Override\n+    @Transactional\n+    public CommandProcessingResult getCreditReport(JsonCommand command) {\n+\n+        try {\n+            this.context.authenticatedUser();\n+\n+            Long creditBureauID = command.longValueOfParameterNamed(\"creditBureauID\");\n+\n+            Optional<String> creditBureauName = getCreditBureau(creditBureauID);\n+\n+            if (creditBureauName.isEmpty()) {\n+                throw new PlatformDataIntegrityException(\"Credit Bureau has not been Integrated\", \"Credit Bureau has not been Integrated\");\n+            }\n+\n+            if (Objects.equals(creditBureauName.get(), CreditBureaNames.THITSAWORKS.toString())) {\n+                CreditReportData reportobj = this.thitsaWorksCreditBureauIntegrationWritePlatformService\n+                        .getCreditReportFromThitsaWorks(command);\n+                return new CommandProcessingResultBuilder().withCreditReport(reportobj).build();\n+            }\n+\n+            throw new PlatformDataIntegrityException(\"Credit Bureau has not been Integrated\", \"Credit Bureau has not been Integrated\");\n+\n+        } catch (final DataIntegrityViolationException dve) {\n+            handleTokenDataIntegrityIssues(command, dve.getMostSpecificCause(), dve);\n+            return CommandProcessingResult.empty();\n+        } catch (final PersistenceException ee) {\n+            Throwable throwable = ExceptionUtils.getRootCause(ee.getCause());\n+            handleTokenDataIntegrityIssues(command, throwable, ee);\n+            return CommandProcessingResult.empty();\n+        }\n+\n+    }\n+\n+    private Optional<String> getCreditBureau(Long creditBureauID) {\n+\n+        if (creditBureauID != null) {\n+            Optional<CreditBureau> creditBureau = this.creditBureauRepository.findById(creditBureauID);\n+\n+            if (creditBureau.isEmpty()) {\n+                LOG.info(\"Credit Bureau Id {} not found\", creditBureauID);\n+                return Optional.empty();\n+            }\n+\n+            return Optional.of(creditBureau.get().getName());\n+\n+        }\n+\n+        return Optional.empty();\n+    }\n+\n+    @Override\n+    public String addCreditReport(File report, Long bureauId) {\n+\n+        Optional<String> creditBureauName = getCreditBureau(bureauId);\n+\n+        if (Objects.equals(creditBureauName.get(), CreditBureaNames.THITSAWORKS.toString())) {\n+\n+            Integer creditBureauId = bureauId.intValue();\n+\n+            // make lower case\n+            CreditBureauConfiguration subscriptionIdData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                    \"SubscriptionId\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24"}, "originalPosition": 154}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3Mzk0Nw==", "bodyText": "Instead of catching NPE here, Can we check if CreditBureauConfiguration itself is Null, if yes, not move ahead", "url": "https://github.com/apache/fineract/pull/1235#discussion_r519473947", "createdAt": "2020-11-08T20:36:14Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditReportWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,248 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Objects;\n+import java.util.Optional;\n+import javax.persistence.PersistenceException;\n+import org.apache.commons.lang3.exception.ExceptionUtils;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResultBuilder;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditBureaNames;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureau;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfiguration;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauLoanProductMappingRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditReport;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditReportRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.dao.DataIntegrityViolationException;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditReportWritePlatformServiceImpl implements CreditReportWritePlatformService {\n+\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+    private final CreditBureauLoanProductMappingRepository loanProductMappingRepository;\n+    private final CreditBureauRepository creditBureauRepository;\n+    private final CreditReportRepository creditReportRepository;\n+    private final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService;\n+\n+    @Autowired\n+    public CreditReportWritePlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer,\n+            final CreditBureauLoanProductMappingRepository loanProductMappingRepository,\n+            final CreditBureauRepository creditBureauRepository, final CreditReportRepository creditReportRepository,\n+            final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.configDataRepository = configDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+        this.loanProductMappingRepository = loanProductMappingRepository;\n+        this.creditBureauRepository = creditBureauRepository;\n+        this.creditReportRepository = creditReportRepository;\n+        this.thitsaWorksCreditBureauIntegrationWritePlatformService = thitsaWorksCreditBureauIntegrationWritePlatformService;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditReportWritePlatformServiceImpl.class);\n+\n+    @Override\n+    @Transactional\n+    public CommandProcessingResult getCreditReport(JsonCommand command) {\n+\n+        try {\n+            this.context.authenticatedUser();\n+\n+            Long creditBureauID = command.longValueOfParameterNamed(\"creditBureauID\");\n+\n+            Optional<String> creditBureauName = getCreditBureau(creditBureauID);\n+\n+            if (creditBureauName.isEmpty()) {\n+                throw new PlatformDataIntegrityException(\"Credit Bureau has not been Integrated\", \"Credit Bureau has not been Integrated\");\n+            }\n+\n+            if (Objects.equals(creditBureauName.get(), CreditBureaNames.THITSAWORKS.toString())) {\n+                CreditReportData reportobj = this.thitsaWorksCreditBureauIntegrationWritePlatformService\n+                        .getCreditReportFromThitsaWorks(command);\n+                return new CommandProcessingResultBuilder().withCreditReport(reportobj).build();\n+            }\n+\n+            throw new PlatformDataIntegrityException(\"Credit Bureau has not been Integrated\", \"Credit Bureau has not been Integrated\");\n+\n+        } catch (final DataIntegrityViolationException dve) {\n+            handleTokenDataIntegrityIssues(command, dve.getMostSpecificCause(), dve);\n+            return CommandProcessingResult.empty();\n+        } catch (final PersistenceException ee) {\n+            Throwable throwable = ExceptionUtils.getRootCause(ee.getCause());\n+            handleTokenDataIntegrityIssues(command, throwable, ee);\n+            return CommandProcessingResult.empty();\n+        }\n+\n+    }\n+\n+    private Optional<String> getCreditBureau(Long creditBureauID) {\n+\n+        if (creditBureauID != null) {\n+            Optional<CreditBureau> creditBureau = this.creditBureauRepository.findById(creditBureauID);\n+\n+            if (creditBureau.isEmpty()) {\n+                LOG.info(\"Credit Bureau Id {} not found\", creditBureauID);\n+                return Optional.empty();\n+            }\n+\n+            return Optional.of(creditBureau.get().getName());\n+\n+        }\n+\n+        return Optional.empty();\n+    }\n+\n+    @Override\n+    public String addCreditReport(File report, Long bureauId) {\n+\n+        Optional<String> creditBureauName = getCreditBureau(bureauId);\n+\n+        if (Objects.equals(creditBureauName.get(), CreditBureaNames.THITSAWORKS.toString())) {\n+\n+            Integer creditBureauId = bureauId.intValue();\n+\n+            // make lower case\n+            CreditBureauConfiguration subscriptionIdData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                    \"SubscriptionId\");\n+            CreditBureauConfiguration subscriptionKeyData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                    \"SubscriptionKey\");\n+            CreditBureauConfiguration userNameData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Username\");\n+            CreditBureauConfiguration passwordData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Password\");\n+\n+            String subscriptionId = \"\";\n+            String subscriptionKey = \"\";\n+            String userName = \"\";\n+            String password = \"\";\n+\n+            try {\n+                subscriptionId = subscriptionIdData.getValue();\n+                subscriptionKey = subscriptionKeyData.getValue();\n+                userName = userNameData.getValue();\n+                password = passwordData.getValue();\n+            } catch (NullPointerException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24"}, "originalPosition": 170}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NDUwNw==", "bodyText": "you can check if there is common string class method which would check if string is null or empty, instead of repeating logic everywhere. If there isn't try to create one mehtod. ex boolisStringNullOrEmpty(String str) {\nif (str != null && !str.isEmpty()) {\nreturn true;} return false;}    or may be come up with more better checks", "url": "https://github.com/apache/fineract/pull/1235#discussion_r519474507", "createdAt": "2020-11-08T20:41:54Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditReportWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,248 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Objects;\n+import java.util.Optional;\n+import javax.persistence.PersistenceException;\n+import org.apache.commons.lang3.exception.ExceptionUtils;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResultBuilder;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditBureaNames;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureau;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfiguration;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauLoanProductMappingRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditReport;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditReportRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.dao.DataIntegrityViolationException;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditReportWritePlatformServiceImpl implements CreditReportWritePlatformService {\n+\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+    private final CreditBureauLoanProductMappingRepository loanProductMappingRepository;\n+    private final CreditBureauRepository creditBureauRepository;\n+    private final CreditReportRepository creditReportRepository;\n+    private final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService;\n+\n+    @Autowired\n+    public CreditReportWritePlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer,\n+            final CreditBureauLoanProductMappingRepository loanProductMappingRepository,\n+            final CreditBureauRepository creditBureauRepository, final CreditReportRepository creditReportRepository,\n+            final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.tokenRepository = tokenRepository;\n+        this.configDataRepository = configDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+        this.loanProductMappingRepository = loanProductMappingRepository;\n+        this.creditBureauRepository = creditBureauRepository;\n+        this.creditReportRepository = creditReportRepository;\n+        this.thitsaWorksCreditBureauIntegrationWritePlatformService = thitsaWorksCreditBureauIntegrationWritePlatformService;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditReportWritePlatformServiceImpl.class);\n+\n+    @Override\n+    @Transactional\n+    public CommandProcessingResult getCreditReport(JsonCommand command) {\n+\n+        try {\n+            this.context.authenticatedUser();\n+\n+            Long creditBureauID = command.longValueOfParameterNamed(\"creditBureauID\");\n+\n+            Optional<String> creditBureauName = getCreditBureau(creditBureauID);\n+\n+            if (creditBureauName.isEmpty()) {\n+                throw new PlatformDataIntegrityException(\"Credit Bureau has not been Integrated\", \"Credit Bureau has not been Integrated\");\n+            }\n+\n+            if (Objects.equals(creditBureauName.get(), CreditBureaNames.THITSAWORKS.toString())) {\n+                CreditReportData reportobj = this.thitsaWorksCreditBureauIntegrationWritePlatformService\n+                        .getCreditReportFromThitsaWorks(command);\n+                return new CommandProcessingResultBuilder().withCreditReport(reportobj).build();\n+            }\n+\n+            throw new PlatformDataIntegrityException(\"Credit Bureau has not been Integrated\", \"Credit Bureau has not been Integrated\");\n+\n+        } catch (final DataIntegrityViolationException dve) {\n+            handleTokenDataIntegrityIssues(command, dve.getMostSpecificCause(), dve);\n+            return CommandProcessingResult.empty();\n+        } catch (final PersistenceException ee) {\n+            Throwable throwable = ExceptionUtils.getRootCause(ee.getCause());\n+            handleTokenDataIntegrityIssues(command, throwable, ee);\n+            return CommandProcessingResult.empty();\n+        }\n+\n+    }\n+\n+    private Optional<String> getCreditBureau(Long creditBureauID) {\n+\n+        if (creditBureauID != null) {\n+            Optional<CreditBureau> creditBureau = this.creditBureauRepository.findById(creditBureauID);\n+\n+            if (creditBureau.isEmpty()) {\n+                LOG.info(\"Credit Bureau Id {} not found\", creditBureauID);\n+                return Optional.empty();\n+            }\n+\n+            return Optional.of(creditBureau.get().getName());\n+\n+        }\n+\n+        return Optional.empty();\n+    }\n+\n+    @Override\n+    public String addCreditReport(File report, Long bureauId) {\n+\n+        Optional<String> creditBureauName = getCreditBureau(bureauId);\n+\n+        if (Objects.equals(creditBureauName.get(), CreditBureaNames.THITSAWORKS.toString())) {\n+\n+            Integer creditBureauId = bureauId.intValue();\n+\n+            // make lower case\n+            CreditBureauConfiguration subscriptionIdData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                    \"SubscriptionId\");\n+            CreditBureauConfiguration subscriptionKeyData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                    \"SubscriptionKey\");\n+            CreditBureauConfiguration userNameData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Username\");\n+            CreditBureauConfiguration passwordData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Password\");\n+\n+            String subscriptionId = \"\";\n+            String subscriptionKey = \"\";\n+            String userName = \"\";\n+            String password = \"\";\n+\n+            try {\n+                subscriptionId = subscriptionIdData.getValue();\n+                subscriptionKey = subscriptionKeyData.getValue();\n+                userName = userNameData.getValue();\n+                password = passwordData.getValue();\n+            } catch (NullPointerException ex) {\n+                throw new PlatformDataIntegrityException(\"Credit Bureau Configuration is not available\",\n+                        \"Credit Bureau Configuration is not available\" + ex);\n+            }\n+\n+            LOG.info(\"subscriptionIdData {}\", subscriptionIdData + \"subscriptionId {}\", subscriptionId);\n+\n+            if (!\"\".equals(subscriptionId) && !\"\".equals(subscriptionKey) && !\"\".equals(userName) && !\"\".equals(password)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24"}, "originalPosition": 177}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3Nzk2NA==", "bodyText": "I think we can break this method down to two methods, getHTTPPostConnection() and getHTTPGetConnection(). Let me know if you agree.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r519477964", "createdAt": "2020-11-08T21:14:23Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,420 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Date;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfiguration;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Component\n+@Service\n+public class ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl implements ThitsaWorksCreditBureauIntegrationWritePlatformService {\n+\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl(final PlatformSecurityContext context,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.tokenRepository = tokenRepository;\n+        this.configDataRepository = configDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.class);\n+\n+    @Transactional\n+    @Override\n+    public String httpConnectionMethod(String process, String nrcID, String userName, String password, String subscriptionKey,\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {\n+\n+        String result = null;\n+\n+        try {\n+            String post_params = null;\n+            HttpURLConnection httpConnection = this.process(process, nrcID, userName, password, subscriptionKey, subscriptionId, url, token,\n+                    uniqueID, report);\n+\n+            if (process.equals(\"token\")) {\n+                post_params = \"\" + \"BODY=x-www-form-urlencoded&\\r\" + \"grant_type=password&\\r\" + \"userName=\" + userName + \"&\\r\" + \"password=\"\n+                        + password + \"&\\r\";\n+            } else if (process.equals(\"NRC\")) {\n+\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcID + \"&\";\n+            } else if (process.equals(\"UploadCreditReport\")) {\n+\n+                post_params = \"BODY=formdata&\" + report + \"&\" + \"userName=\" + userName + \"&\";\n+            }\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                httpConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set is required only for (POST METHOD)- fetching uniqueID from NRC/Creating Token/Add Credit report\n+            if (process.equals(\"NRC\") || process.equals(\"token\") || process.equals(\"UploadCreditReport\")) {\n+                httpConnection.setDoOutput(true);\n+                OutputStream os = httpConnection.getOutputStream();\n+                os.write(post_params.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+            }\n+\n+            result = this.httpResponse(httpConnection);\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return result;\n+\n+    }\n+\n+    private HttpURLConnection process(String process, String nrcID, String userName, String password, String subscriptionKey,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3ODY0OA==", "bodyText": "i gave feedback regarding this approach above.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r519478648", "createdAt": "2020-11-08T21:21:00Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,420 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Date;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfiguration;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Component\n+@Service\n+public class ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl implements ThitsaWorksCreditBureauIntegrationWritePlatformService {\n+\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl(final PlatformSecurityContext context,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.tokenRepository = tokenRepository;\n+        this.configDataRepository = configDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.class);\n+\n+    @Transactional\n+    @Override\n+    public String httpConnectionMethod(String process, String nrcID, String userName, String password, String subscriptionKey,\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {\n+\n+        String result = null;\n+\n+        try {\n+            String post_params = null;\n+            HttpURLConnection httpConnection = this.process(process, nrcID, userName, password, subscriptionKey, subscriptionId, url, token,\n+                    uniqueID, report);\n+\n+            if (process.equals(\"token\")) {\n+                post_params = \"\" + \"BODY=x-www-form-urlencoded&\\r\" + \"grant_type=password&\\r\" + \"userName=\" + userName + \"&\\r\" + \"password=\"\n+                        + password + \"&\\r\";\n+            } else if (process.equals(\"NRC\")) {\n+\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcID + \"&\";\n+            } else if (process.equals(\"UploadCreditReport\")) {\n+\n+                post_params = \"BODY=formdata&\" + report + \"&\" + \"userName=\" + userName + \"&\";\n+            }\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                httpConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set is required only for (POST METHOD)- fetching uniqueID from NRC/Creating Token/Add Credit report\n+            if (process.equals(\"NRC\") || process.equals(\"token\") || process.equals(\"UploadCreditReport\")) {\n+                httpConnection.setDoOutput(true);\n+                OutputStream os = httpConnection.getOutputStream();\n+                os.write(post_params.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+            }\n+\n+            result = this.httpResponse(httpConnection);\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return result;\n+\n+    }\n+\n+    private HttpURLConnection process(String process, String nrcID, String userName, String password, String subscriptionKey,\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {\n+\n+        HttpURLConnection httpConnection = null;\n+\n+        try {\n+            if (process.equals(\"token\")) {\n+\n+                URL tokenurl = new URL(url);\n+                httpConnection = (HttpURLConnection) tokenurl.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+\n+                URL NrcURL = new URL(url + nrcID);\n+                httpConnection = (HttpURLConnection) NrcURL.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"CreditReport\")) {\n+\n+                URL CreditReportURL = new URL(url + uniqueID);\n+                httpConnection = (HttpURLConnection) CreditReportURL.openConnection();\n+                httpConnection.setRequestMethod(\"GET\");\n+\n+            } else if (process.equals(\"UploadCreditReport\")) {\n+\n+                URL addCreditReporturl = new URL(url);\n+                httpConnection = (HttpURLConnection) addCreditReporturl.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            // common set of headers\n+            httpConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+            httpConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+            httpConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return httpConnection;\n+    }\n+\n+    public String httpResponse(HttpURLConnection httpConnection) {\n+\n+        String result = null; // return type of this method\n+        try {\n+            int responseCode = httpConnection.getResponseCode();\n+\n+            StringBuilder response = new StringBuilder();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                response = new StringBuilder();\n+\n+                LOG.info(\"----- RESPONSE OK-----\");\n+\n+                BufferedReader in = new BufferedReader(new InputStreamReader(httpConnection.getInputStream(), StandardCharsets.UTF_8));\n+\n+                String readLine = null;\n+                while ((readLine = in.readLine()) != null) {\n+                    response.append(readLine);\n+                }\n+                in.close();\n+                result = response.toString();\n+                LOG.info(\"----- result-----{}\", result);\n+\n+            } else if (responseCode == HttpURLConnection.HTTP_UNAUTHORIZED) {\n+                LOG.info(\"-----IP FORBIDDEN-----\");\n+                String httpResponse = \"HTTP_UNAUTHORIZED\";\n+                this.handleAPIIntegrityIssues(httpResponse);\n+\n+            } else if (responseCode == HttpURLConnection.HTTP_FORBIDDEN) {\n+                LOG.info(\"-----IP FORBIDDEN-----\");\n+                String httpResponse = \"HTTP_FORBIDDEN\";\n+                this.handleAPIIntegrityIssues(httpResponse);\n+\n+            } else {\n+                LOG.info(\"Request is Invalid\");\n+            }\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return result;\n+    }\n+\n+    @Transactional\n+    @Override\n+    @SuppressWarnings(\"StringSplitter\")\n+    public CreditReportData getCreditReportFromThitsaWorks(final JsonCommand command) {\n+\n+        this.context.authenticatedUser();\n+        String nrcId = command.stringValueOfParameterNamed(\"NRC\");\n+        String bureauID = command.stringValueOfParameterNamed(\"creditBureauID\");\n+        Integer creditBureauId = Integer.parseInt(bureauID);\n+\n+        CreditBureauConfiguration subscriptionIdData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                \"SubscriptionId\");\n+        CreditBureauConfiguration subscriptionKeyData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                \"SubscriptionKey\");\n+        CreditBureauConfiguration userNameData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Username\");\n+        CreditBureauConfiguration passwordData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Password\");\n+\n+        String subscriptionId = \"\";\n+        String subscriptionKey = \"\";\n+        String userName = \"\";\n+        String password = \"\";\n+\n+        try {\n+            subscriptionId = subscriptionIdData.getValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24"}, "originalPosition": 232}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3OTE0Nw==", "bodyText": "extract a method of NRC process", "url": "https://github.com/apache/fineract/pull/1235#discussion_r519479147", "createdAt": "2020-11-08T21:26:08Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,420 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Date;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfiguration;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Component\n+@Service\n+public class ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl implements ThitsaWorksCreditBureauIntegrationWritePlatformService {\n+\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl(final PlatformSecurityContext context,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.tokenRepository = tokenRepository;\n+        this.configDataRepository = configDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.class);\n+\n+    @Transactional\n+    @Override\n+    public String httpConnectionMethod(String process, String nrcID, String userName, String password, String subscriptionKey,\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {\n+\n+        String result = null;\n+\n+        try {\n+            String post_params = null;\n+            HttpURLConnection httpConnection = this.process(process, nrcID, userName, password, subscriptionKey, subscriptionId, url, token,\n+                    uniqueID, report);\n+\n+            if (process.equals(\"token\")) {\n+                post_params = \"\" + \"BODY=x-www-form-urlencoded&\\r\" + \"grant_type=password&\\r\" + \"userName=\" + userName + \"&\\r\" + \"password=\"\n+                        + password + \"&\\r\";\n+            } else if (process.equals(\"NRC\")) {\n+\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcID + \"&\";\n+            } else if (process.equals(\"UploadCreditReport\")) {\n+\n+                post_params = \"BODY=formdata&\" + report + \"&\" + \"userName=\" + userName + \"&\";\n+            }\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                httpConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set is required only for (POST METHOD)- fetching uniqueID from NRC/Creating Token/Add Credit report\n+            if (process.equals(\"NRC\") || process.equals(\"token\") || process.equals(\"UploadCreditReport\")) {\n+                httpConnection.setDoOutput(true);\n+                OutputStream os = httpConnection.getOutputStream();\n+                os.write(post_params.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+            }\n+\n+            result = this.httpResponse(httpConnection);\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return result;\n+\n+    }\n+\n+    private HttpURLConnection process(String process, String nrcID, String userName, String password, String subscriptionKey,\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {\n+\n+        HttpURLConnection httpConnection = null;\n+\n+        try {\n+            if (process.equals(\"token\")) {\n+\n+                URL tokenurl = new URL(url);\n+                httpConnection = (HttpURLConnection) tokenurl.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+\n+                URL NrcURL = new URL(url + nrcID);\n+                httpConnection = (HttpURLConnection) NrcURL.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"CreditReport\")) {\n+\n+                URL CreditReportURL = new URL(url + uniqueID);\n+                httpConnection = (HttpURLConnection) CreditReportURL.openConnection();\n+                httpConnection.setRequestMethod(\"GET\");\n+\n+            } else if (process.equals(\"UploadCreditReport\")) {\n+\n+                URL addCreditReporturl = new URL(url);\n+                httpConnection = (HttpURLConnection) addCreditReporturl.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            // common set of headers\n+            httpConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+            httpConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+            httpConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return httpConnection;\n+    }\n+\n+    public String httpResponse(HttpURLConnection httpConnection) {\n+\n+        String result = null; // return type of this method\n+        try {\n+            int responseCode = httpConnection.getResponseCode();\n+\n+            StringBuilder response = new StringBuilder();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                response = new StringBuilder();\n+\n+                LOG.info(\"----- RESPONSE OK-----\");\n+\n+                BufferedReader in = new BufferedReader(new InputStreamReader(httpConnection.getInputStream(), StandardCharsets.UTF_8));\n+\n+                String readLine = null;\n+                while ((readLine = in.readLine()) != null) {\n+                    response.append(readLine);\n+                }\n+                in.close();\n+                result = response.toString();\n+                LOG.info(\"----- result-----{}\", result);\n+\n+            } else if (responseCode == HttpURLConnection.HTTP_UNAUTHORIZED) {\n+                LOG.info(\"-----IP FORBIDDEN-----\");\n+                String httpResponse = \"HTTP_UNAUTHORIZED\";\n+                this.handleAPIIntegrityIssues(httpResponse);\n+\n+            } else if (responseCode == HttpURLConnection.HTTP_FORBIDDEN) {\n+                LOG.info(\"-----IP FORBIDDEN-----\");\n+                String httpResponse = \"HTTP_FORBIDDEN\";\n+                this.handleAPIIntegrityIssues(httpResponse);\n+\n+            } else {\n+                LOG.info(\"Request is Invalid\");\n+            }\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return result;\n+    }\n+\n+    @Transactional\n+    @Override\n+    @SuppressWarnings(\"StringSplitter\")\n+    public CreditReportData getCreditReportFromThitsaWorks(final JsonCommand command) {\n+\n+        this.context.authenticatedUser();\n+        String nrcId = command.stringValueOfParameterNamed(\"NRC\");\n+        String bureauID = command.stringValueOfParameterNamed(\"creditBureauID\");\n+        Integer creditBureauId = Integer.parseInt(bureauID);\n+\n+        CreditBureauConfiguration subscriptionIdData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                \"SubscriptionId\");\n+        CreditBureauConfiguration subscriptionKeyData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                \"SubscriptionKey\");\n+        CreditBureauConfiguration userNameData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Username\");\n+        CreditBureauConfiguration passwordData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Password\");\n+\n+        String subscriptionId = \"\";\n+        String subscriptionKey = \"\";\n+        String userName = \"\";\n+        String password = \"\";\n+\n+        try {\n+            subscriptionId = subscriptionIdData.getValue();\n+            subscriptionKey = subscriptionKeyData.getValue();\n+            userName = userNameData.getValue();\n+            password = passwordData.getValue();\n+        } catch (NullPointerException ex) {\n+            throw new PlatformDataIntegrityException(\"Credit Bureau Configuration is not available\",\n+                    \"Credit Bureau Configuration is not available\" + ex);\n+        }\n+\n+        String token = null;\n+        if (!\"\".equals(subscriptionId) && !\"\".equals(subscriptionKey) && !\"\".equals(userName) && !\"\".equals(password)) {\n+            token = createToken(userName, password, subscriptionId, subscriptionKey, creditBureauId);\n+        } else {\n+            throw new PlatformDataIntegrityException(\"Credit Bureau Configuration is not available\",\n+                    \"Credit Bureau Configuration is not available\");\n+        }\n+\n+        // will use only \"NRC\" part of code from common http method to get data based on nrc\n+        String process = \"NRC\";\n+        CreditBureauConfiguration SearchURL = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"searchurl\");\n+        String url = SearchURL.getValue();\n+        String result = this.httpConnectionMethod(process, nrcId, userName, password, subscriptionKey, subscriptionId, url, token, 0L,\n+                null);\n+\n+        // after fetching the data from httpconnection it will be come back here for fetching UniqueID from data\n+        if (process.equals(\"NRC\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24"}, "originalPosition": 257}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ4MDEwNA==", "bodyText": "don't start with caps for url names, applies throughout the PR.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r519480104", "createdAt": "2020-11-08T21:35:36Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,420 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Date;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfiguration;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Component\n+@Service\n+public class ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl implements ThitsaWorksCreditBureauIntegrationWritePlatformService {\n+\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl(final PlatformSecurityContext context,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.tokenRepository = tokenRepository;\n+        this.configDataRepository = configDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.class);\n+\n+    @Transactional\n+    @Override\n+    public String httpConnectionMethod(String process, String nrcID, String userName, String password, String subscriptionKey,\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {\n+\n+        String result = null;\n+\n+        try {\n+            String post_params = null;\n+            HttpURLConnection httpConnection = this.process(process, nrcID, userName, password, subscriptionKey, subscriptionId, url, token,\n+                    uniqueID, report);\n+\n+            if (process.equals(\"token\")) {\n+                post_params = \"\" + \"BODY=x-www-form-urlencoded&\\r\" + \"grant_type=password&\\r\" + \"userName=\" + userName + \"&\\r\" + \"password=\"\n+                        + password + \"&\\r\";\n+            } else if (process.equals(\"NRC\")) {\n+\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcID + \"&\";\n+            } else if (process.equals(\"UploadCreditReport\")) {\n+\n+                post_params = \"BODY=formdata&\" + report + \"&\" + \"userName=\" + userName + \"&\";\n+            }\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                httpConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set is required only for (POST METHOD)- fetching uniqueID from NRC/Creating Token/Add Credit report\n+            if (process.equals(\"NRC\") || process.equals(\"token\") || process.equals(\"UploadCreditReport\")) {\n+                httpConnection.setDoOutput(true);\n+                OutputStream os = httpConnection.getOutputStream();\n+                os.write(post_params.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+            }\n+\n+            result = this.httpResponse(httpConnection);\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return result;\n+\n+    }\n+\n+    private HttpURLConnection process(String process, String nrcID, String userName, String password, String subscriptionKey,\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {\n+\n+        HttpURLConnection httpConnection = null;\n+\n+        try {\n+            if (process.equals(\"token\")) {\n+\n+                URL tokenurl = new URL(url);\n+                httpConnection = (HttpURLConnection) tokenurl.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+\n+                URL NrcURL = new URL(url + nrcID);\n+                httpConnection = (HttpURLConnection) NrcURL.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"CreditReport\")) {\n+\n+                URL CreditReportURL = new URL(url + uniqueID);\n+                httpConnection = (HttpURLConnection) CreditReportURL.openConnection();\n+                httpConnection.setRequestMethod(\"GET\");\n+\n+            } else if (process.equals(\"UploadCreditReport\")) {\n+\n+                URL addCreditReporturl = new URL(url);\n+                httpConnection = (HttpURLConnection) addCreditReporturl.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            // common set of headers\n+            httpConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+            httpConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+            httpConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return httpConnection;\n+    }\n+\n+    public String httpResponse(HttpURLConnection httpConnection) {\n+\n+        String result = null; // return type of this method\n+        try {\n+            int responseCode = httpConnection.getResponseCode();\n+\n+            StringBuilder response = new StringBuilder();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                response = new StringBuilder();\n+\n+                LOG.info(\"----- RESPONSE OK-----\");\n+\n+                BufferedReader in = new BufferedReader(new InputStreamReader(httpConnection.getInputStream(), StandardCharsets.UTF_8));\n+\n+                String readLine = null;\n+                while ((readLine = in.readLine()) != null) {\n+                    response.append(readLine);\n+                }\n+                in.close();\n+                result = response.toString();\n+                LOG.info(\"----- result-----{}\", result);\n+\n+            } else if (responseCode == HttpURLConnection.HTTP_UNAUTHORIZED) {\n+                LOG.info(\"-----IP FORBIDDEN-----\");\n+                String httpResponse = \"HTTP_UNAUTHORIZED\";\n+                this.handleAPIIntegrityIssues(httpResponse);\n+\n+            } else if (responseCode == HttpURLConnection.HTTP_FORBIDDEN) {\n+                LOG.info(\"-----IP FORBIDDEN-----\");\n+                String httpResponse = \"HTTP_FORBIDDEN\";\n+                this.handleAPIIntegrityIssues(httpResponse);\n+\n+            } else {\n+                LOG.info(\"Request is Invalid\");\n+            }\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return result;\n+    }\n+\n+    @Transactional\n+    @Override\n+    @SuppressWarnings(\"StringSplitter\")\n+    public CreditReportData getCreditReportFromThitsaWorks(final JsonCommand command) {\n+\n+        this.context.authenticatedUser();\n+        String nrcId = command.stringValueOfParameterNamed(\"NRC\");\n+        String bureauID = command.stringValueOfParameterNamed(\"creditBureauID\");\n+        Integer creditBureauId = Integer.parseInt(bureauID);\n+\n+        CreditBureauConfiguration subscriptionIdData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                \"SubscriptionId\");\n+        CreditBureauConfiguration subscriptionKeyData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                \"SubscriptionKey\");\n+        CreditBureauConfiguration userNameData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Username\");\n+        CreditBureauConfiguration passwordData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Password\");\n+\n+        String subscriptionId = \"\";\n+        String subscriptionKey = \"\";\n+        String userName = \"\";\n+        String password = \"\";\n+\n+        try {\n+            subscriptionId = subscriptionIdData.getValue();\n+            subscriptionKey = subscriptionKeyData.getValue();\n+            userName = userNameData.getValue();\n+            password = passwordData.getValue();\n+        } catch (NullPointerException ex) {\n+            throw new PlatformDataIntegrityException(\"Credit Bureau Configuration is not available\",\n+                    \"Credit Bureau Configuration is not available\" + ex);\n+        }\n+\n+        String token = null;\n+        if (!\"\".equals(subscriptionId) && !\"\".equals(subscriptionKey) && !\"\".equals(userName) && !\"\".equals(password)) {\n+            token = createToken(userName, password, subscriptionId, subscriptionKey, creditBureauId);\n+        } else {\n+            throw new PlatformDataIntegrityException(\"Credit Bureau Configuration is not available\",\n+                    \"Credit Bureau Configuration is not available\");\n+        }\n+\n+        // will use only \"NRC\" part of code from common http method to get data based on nrc\n+        String process = \"NRC\";\n+        CreditBureauConfiguration SearchURL = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"searchurl\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24"}, "originalPosition": 251}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ4MjM1NQ==", "bodyText": "extract this logic in method. Can we validate uniqueId, instead of depending on IndexOutOfBoundsExcp", "url": "https://github.com/apache/fineract/pull/1235#discussion_r519482355", "createdAt": "2020-11-08T21:54:53Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,420 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Date;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfiguration;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Component\n+@Service\n+public class ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl implements ThitsaWorksCreditBureauIntegrationWritePlatformService {\n+\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl(final PlatformSecurityContext context,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.tokenRepository = tokenRepository;\n+        this.configDataRepository = configDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.class);\n+\n+    @Transactional\n+    @Override\n+    public String httpConnectionMethod(String process, String nrcID, String userName, String password, String subscriptionKey,\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {\n+\n+        String result = null;\n+\n+        try {\n+            String post_params = null;\n+            HttpURLConnection httpConnection = this.process(process, nrcID, userName, password, subscriptionKey, subscriptionId, url, token,\n+                    uniqueID, report);\n+\n+            if (process.equals(\"token\")) {\n+                post_params = \"\" + \"BODY=x-www-form-urlencoded&\\r\" + \"grant_type=password&\\r\" + \"userName=\" + userName + \"&\\r\" + \"password=\"\n+                        + password + \"&\\r\";\n+            } else if (process.equals(\"NRC\")) {\n+\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcID + \"&\";\n+            } else if (process.equals(\"UploadCreditReport\")) {\n+\n+                post_params = \"BODY=formdata&\" + report + \"&\" + \"userName=\" + userName + \"&\";\n+            }\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                httpConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set is required only for (POST METHOD)- fetching uniqueID from NRC/Creating Token/Add Credit report\n+            if (process.equals(\"NRC\") || process.equals(\"token\") || process.equals(\"UploadCreditReport\")) {\n+                httpConnection.setDoOutput(true);\n+                OutputStream os = httpConnection.getOutputStream();\n+                os.write(post_params.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+            }\n+\n+            result = this.httpResponse(httpConnection);\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return result;\n+\n+    }\n+\n+    private HttpURLConnection process(String process, String nrcID, String userName, String password, String subscriptionKey,\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {\n+\n+        HttpURLConnection httpConnection = null;\n+\n+        try {\n+            if (process.equals(\"token\")) {\n+\n+                URL tokenurl = new URL(url);\n+                httpConnection = (HttpURLConnection) tokenurl.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+\n+                URL NrcURL = new URL(url + nrcID);\n+                httpConnection = (HttpURLConnection) NrcURL.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"CreditReport\")) {\n+\n+                URL CreditReportURL = new URL(url + uniqueID);\n+                httpConnection = (HttpURLConnection) CreditReportURL.openConnection();\n+                httpConnection.setRequestMethod(\"GET\");\n+\n+            } else if (process.equals(\"UploadCreditReport\")) {\n+\n+                URL addCreditReporturl = new URL(url);\n+                httpConnection = (HttpURLConnection) addCreditReporturl.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            // common set of headers\n+            httpConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+            httpConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+            httpConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return httpConnection;\n+    }\n+\n+    public String httpResponse(HttpURLConnection httpConnection) {\n+\n+        String result = null; // return type of this method\n+        try {\n+            int responseCode = httpConnection.getResponseCode();\n+\n+            StringBuilder response = new StringBuilder();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                response = new StringBuilder();\n+\n+                LOG.info(\"----- RESPONSE OK-----\");\n+\n+                BufferedReader in = new BufferedReader(new InputStreamReader(httpConnection.getInputStream(), StandardCharsets.UTF_8));\n+\n+                String readLine = null;\n+                while ((readLine = in.readLine()) != null) {\n+                    response.append(readLine);\n+                }\n+                in.close();\n+                result = response.toString();\n+                LOG.info(\"----- result-----{}\", result);\n+\n+            } else if (responseCode == HttpURLConnection.HTTP_UNAUTHORIZED) {\n+                LOG.info(\"-----IP FORBIDDEN-----\");\n+                String httpResponse = \"HTTP_UNAUTHORIZED\";\n+                this.handleAPIIntegrityIssues(httpResponse);\n+\n+            } else if (responseCode == HttpURLConnection.HTTP_FORBIDDEN) {\n+                LOG.info(\"-----IP FORBIDDEN-----\");\n+                String httpResponse = \"HTTP_FORBIDDEN\";\n+                this.handleAPIIntegrityIssues(httpResponse);\n+\n+            } else {\n+                LOG.info(\"Request is Invalid\");\n+            }\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return result;\n+    }\n+\n+    @Transactional\n+    @Override\n+    @SuppressWarnings(\"StringSplitter\")\n+    public CreditReportData getCreditReportFromThitsaWorks(final JsonCommand command) {\n+\n+        this.context.authenticatedUser();\n+        String nrcId = command.stringValueOfParameterNamed(\"NRC\");\n+        String bureauID = command.stringValueOfParameterNamed(\"creditBureauID\");\n+        Integer creditBureauId = Integer.parseInt(bureauID);\n+\n+        CreditBureauConfiguration subscriptionIdData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                \"SubscriptionId\");\n+        CreditBureauConfiguration subscriptionKeyData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                \"SubscriptionKey\");\n+        CreditBureauConfiguration userNameData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Username\");\n+        CreditBureauConfiguration passwordData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Password\");\n+\n+        String subscriptionId = \"\";\n+        String subscriptionKey = \"\";\n+        String userName = \"\";\n+        String password = \"\";\n+\n+        try {\n+            subscriptionId = subscriptionIdData.getValue();\n+            subscriptionKey = subscriptionKeyData.getValue();\n+            userName = userNameData.getValue();\n+            password = passwordData.getValue();\n+        } catch (NullPointerException ex) {\n+            throw new PlatformDataIntegrityException(\"Credit Bureau Configuration is not available\",\n+                    \"Credit Bureau Configuration is not available\" + ex);\n+        }\n+\n+        String token = null;\n+        if (!\"\".equals(subscriptionId) && !\"\".equals(subscriptionKey) && !\"\".equals(userName) && !\"\".equals(password)) {\n+            token = createToken(userName, password, subscriptionId, subscriptionKey, creditBureauId);\n+        } else {\n+            throw new PlatformDataIntegrityException(\"Credit Bureau Configuration is not available\",\n+                    \"Credit Bureau Configuration is not available\");\n+        }\n+\n+        // will use only \"NRC\" part of code from common http method to get data based on nrc\n+        String process = \"NRC\";\n+        CreditBureauConfiguration SearchURL = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"searchurl\");\n+        String url = SearchURL.getValue();\n+        String result = this.httpConnectionMethod(process, nrcId, userName, password, subscriptionKey, subscriptionId, url, token, 0L,\n+                null);\n+\n+        // after fetching the data from httpconnection it will be come back here for fetching UniqueID from data\n+        if (process.equals(\"NRC\")) {\n+\n+            JsonObject reportObject = JsonParser.parseString(result).getAsJsonObject();\n+\n+            JsonElement element = reportObject.get(\"Data\");\n+\n+            if (element.isJsonNull()) {\n+                String ResponseMessage = reportObject.get(\"ResponseMessage\").getAsString();\n+                handleAPIIntegrityIssues(ResponseMessage);\n+            }\n+\n+            // to fetch the Unique ID from Result\n+            JsonObject jsonObject = JsonParser.parseString(result).getAsJsonObject();\n+            Long uniqueID = 0L;\n+            try {\n+                JsonArray jArray = jsonObject.getAsJsonArray(\"Data\");\n+                JsonObject jobject = jArray.get(0).getAsJsonObject();\n+                String uniqueIdString = jobject.get(\"UniqueID\").toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24"}, "originalPosition": 274}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ4MjUzMw==", "bodyText": "extract this repeating logic in method", "url": "https://github.com/apache/fineract/pull/1235#discussion_r519482533", "createdAt": "2020-11-08T21:56:31Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,420 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonNull;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Date;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfiguration;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauToken;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Component\n+@Service\n+public class ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl implements ThitsaWorksCreditBureauIntegrationWritePlatformService {\n+\n+    private final PlatformSecurityContext context;\n+    private final FromJsonHelper fromApiJsonHelper;\n+    private final TokenRepositoryWrapper tokenRepository;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer;\n+\n+    @Autowired\n+    public ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl(final PlatformSecurityContext context,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer) {\n+        this.context = context;\n+        this.tokenRepository = tokenRepository;\n+        this.configDataRepository = configDataRepository;\n+        this.fromApiJsonHelper = fromApiJsonHelper;\n+        this.fromApiJsonDeserializer = fromApiJsonDeserializer;\n+    }\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl.class);\n+\n+    @Transactional\n+    @Override\n+    public String httpConnectionMethod(String process, String nrcID, String userName, String password, String subscriptionKey,\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {\n+\n+        String result = null;\n+\n+        try {\n+            String post_params = null;\n+            HttpURLConnection httpConnection = this.process(process, nrcID, userName, password, subscriptionKey, subscriptionId, url, token,\n+                    uniqueID, report);\n+\n+            if (process.equals(\"token\")) {\n+                post_params = \"\" + \"BODY=x-www-form-urlencoded&\\r\" + \"grant_type=password&\\r\" + \"userName=\" + userName + \"&\\r\" + \"password=\"\n+                        + password + \"&\\r\";\n+            } else if (process.equals(\"NRC\")) {\n+\n+                post_params = \"BODY=x-www-form-urlencoded&nrc=\" + nrcID + \"&\";\n+            } else if (process.equals(\"UploadCreditReport\")) {\n+\n+                post_params = \"BODY=formdata&\" + report + \"&\" + \"userName=\" + userName + \"&\";\n+            }\n+\n+            // token header not used when creating token i.e. when token will be null\n+            if (token != null) {\n+                httpConnection.setRequestProperty(\"Authorization\", \"Bearer \" + token);\n+            }\n+\n+            // this set is required only for (POST METHOD)- fetching uniqueID from NRC/Creating Token/Add Credit report\n+            if (process.equals(\"NRC\") || process.equals(\"token\") || process.equals(\"UploadCreditReport\")) {\n+                httpConnection.setDoOutput(true);\n+                OutputStream os = httpConnection.getOutputStream();\n+                os.write(post_params.getBytes(StandardCharsets.UTF_8));\n+                os.flush();\n+                os.close();\n+            }\n+\n+            result = this.httpResponse(httpConnection);\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return result;\n+\n+    }\n+\n+    private HttpURLConnection process(String process, String nrcID, String userName, String password, String subscriptionKey,\n+            String subscriptionId, String url, String token, Long uniqueID, File report) {\n+\n+        HttpURLConnection httpConnection = null;\n+\n+        try {\n+            if (process.equals(\"token\")) {\n+\n+                URL tokenurl = new URL(url);\n+                httpConnection = (HttpURLConnection) tokenurl.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"NRC\")) {\n+\n+                URL NrcURL = new URL(url + nrcID);\n+                httpConnection = (HttpURLConnection) NrcURL.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+\n+            } else if (process.equals(\"CreditReport\")) {\n+\n+                URL CreditReportURL = new URL(url + uniqueID);\n+                httpConnection = (HttpURLConnection) CreditReportURL.openConnection();\n+                httpConnection.setRequestMethod(\"GET\");\n+\n+            } else if (process.equals(\"UploadCreditReport\")) {\n+\n+                URL addCreditReporturl = new URL(url);\n+                httpConnection = (HttpURLConnection) addCreditReporturl.openConnection();\n+                httpConnection.setRequestMethod(\"POST\");\n+            }\n+\n+            // common set of headers\n+            httpConnection.setRequestProperty(\"mcix-subscription-key\", subscriptionKey);\n+            httpConnection.setRequestProperty(\"mcix-subscription-id\", subscriptionId);\n+            httpConnection.setRequestProperty(\"Content-Type\", \"application/x-www-form-urlencoded\");\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return httpConnection;\n+    }\n+\n+    public String httpResponse(HttpURLConnection httpConnection) {\n+\n+        String result = null; // return type of this method\n+        try {\n+            int responseCode = httpConnection.getResponseCode();\n+\n+            StringBuilder response = new StringBuilder();\n+            if (responseCode == HttpURLConnection.HTTP_OK) {\n+                response = new StringBuilder();\n+\n+                LOG.info(\"----- RESPONSE OK-----\");\n+\n+                BufferedReader in = new BufferedReader(new InputStreamReader(httpConnection.getInputStream(), StandardCharsets.UTF_8));\n+\n+                String readLine = null;\n+                while ((readLine = in.readLine()) != null) {\n+                    response.append(readLine);\n+                }\n+                in.close();\n+                result = response.toString();\n+                LOG.info(\"----- result-----{}\", result);\n+\n+            } else if (responseCode == HttpURLConnection.HTTP_UNAUTHORIZED) {\n+                LOG.info(\"-----IP FORBIDDEN-----\");\n+                String httpResponse = \"HTTP_UNAUTHORIZED\";\n+                this.handleAPIIntegrityIssues(httpResponse);\n+\n+            } else if (responseCode == HttpURLConnection.HTTP_FORBIDDEN) {\n+                LOG.info(\"-----IP FORBIDDEN-----\");\n+                String httpResponse = \"HTTP_FORBIDDEN\";\n+                this.handleAPIIntegrityIssues(httpResponse);\n+\n+            } else {\n+                LOG.info(\"Request is Invalid\");\n+            }\n+\n+        } catch (IOException e) {\n+            LOG.error(\"Error occured.\", e);\n+        }\n+        return result;\n+    }\n+\n+    @Transactional\n+    @Override\n+    @SuppressWarnings(\"StringSplitter\")\n+    public CreditReportData getCreditReportFromThitsaWorks(final JsonCommand command) {\n+\n+        this.context.authenticatedUser();\n+        String nrcId = command.stringValueOfParameterNamed(\"NRC\");\n+        String bureauID = command.stringValueOfParameterNamed(\"creditBureauID\");\n+        Integer creditBureauId = Integer.parseInt(bureauID);\n+\n+        CreditBureauConfiguration subscriptionIdData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                \"SubscriptionId\");\n+        CreditBureauConfiguration subscriptionKeyData = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                \"SubscriptionKey\");\n+        CreditBureauConfiguration userNameData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Username\");\n+        CreditBureauConfiguration passwordData = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"Password\");\n+\n+        String subscriptionId = \"\";\n+        String subscriptionKey = \"\";\n+        String userName = \"\";\n+        String password = \"\";\n+\n+        try {\n+            subscriptionId = subscriptionIdData.getValue();\n+            subscriptionKey = subscriptionKeyData.getValue();\n+            userName = userNameData.getValue();\n+            password = passwordData.getValue();\n+        } catch (NullPointerException ex) {\n+            throw new PlatformDataIntegrityException(\"Credit Bureau Configuration is not available\",\n+                    \"Credit Bureau Configuration is not available\" + ex);\n+        }\n+\n+        String token = null;\n+        if (!\"\".equals(subscriptionId) && !\"\".equals(subscriptionKey) && !\"\".equals(userName) && !\"\".equals(password)) {\n+            token = createToken(userName, password, subscriptionId, subscriptionKey, creditBureauId);\n+        } else {\n+            throw new PlatformDataIntegrityException(\"Credit Bureau Configuration is not available\",\n+                    \"Credit Bureau Configuration is not available\");\n+        }\n+\n+        // will use only \"NRC\" part of code from common http method to get data based on nrc\n+        String process = \"NRC\";\n+        CreditBureauConfiguration SearchURL = this.configDataRepository.getCreditBureauConfigData(creditBureauId, \"searchurl\");\n+        String url = SearchURL.getValue();\n+        String result = this.httpConnectionMethod(process, nrcId, userName, password, subscriptionKey, subscriptionId, url, token, 0L,\n+                null);\n+\n+        // after fetching the data from httpconnection it will be come back here for fetching UniqueID from data\n+        if (process.equals(\"NRC\")) {\n+\n+            JsonObject reportObject = JsonParser.parseString(result).getAsJsonObject();\n+\n+            JsonElement element = reportObject.get(\"Data\");\n+\n+            if (element.isJsonNull()) {\n+                String ResponseMessage = reportObject.get(\"ResponseMessage\").getAsString();\n+                handleAPIIntegrityIssues(ResponseMessage);\n+            }\n+\n+            // to fetch the Unique ID from Result\n+            JsonObject jsonObject = JsonParser.parseString(result).getAsJsonObject();\n+            Long uniqueID = 0L;\n+            try {\n+                JsonArray jArray = jsonObject.getAsJsonArray(\"Data\");\n+                JsonObject jobject = jArray.get(0).getAsJsonObject();\n+                String uniqueIdString = jobject.get(\"UniqueID\").toString();\n+\n+                String TrimUniqueId = uniqueIdString.substring(1, uniqueIdString.length() - 1);\n+                uniqueID = Long.parseLong(TrimUniqueId);\n+            } catch (IndexOutOfBoundsException e) {\n+                String ResponseMessage = reportObject.get(\"ResponseMessage\").getAsString();\n+                handleAPIIntegrityIssues(ResponseMessage);\n+            }\n+\n+            process = \"CreditReport\";\n+            CreditBureauConfiguration creditReportURL = this.configDataRepository.getCreditBureauConfigData(creditBureauId,\n+                    \"creditReporturl\");\n+            url = creditReportURL.getValue();\n+            result = this.httpConnectionMethod(process, nrcId, userName, password, subscriptionKey, subscriptionId, url, token, uniqueID,\n+                    null);\n+\n+        }\n+\n+        // after getting the result(creditreport) from httpconnection-response it will assign creditreport to generic\n+        // creditreportdata object\n+\n+        JsonObject reportObject = JsonParser.parseString(result).getAsJsonObject();\n+\n+        JsonObject borrowerInfos = null;\n+        String borrowerInfo = null;\n+        String CreditScore = null;\n+        String ActiveLoans = null;\n+        String PaidLoans = null;\n+\n+        // Credit Reports Stored into Generic CreditReportData\n+        JsonObject data = null;\n+        JsonElement element = reportObject.get(\"Data\");\n+\n+        if (!(element instanceof JsonNull)) { // NOTE : \"element instanceof JsonNull\" is for handling empty values (and\n+                                              // assigning null) while fetching data from results\n+            data = (JsonObject) element;\n+        }\n+\n+        borrowerInfo = null;\n+        element = data.get(\"BorrowerInfo\");\n+        if (!(element instanceof JsonNull)) {\n+            borrowerInfos = (JsonObject) element;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24"}, "originalPosition": 315}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTQ2MTc5", "url": "https://github.com/apache/fineract/pull/1235#pullrequestreview-529546179", "createdAt": "2020-11-12T22:19:50Z", "commit": {"oid": "ccfdc2a8c8da9244116744073dc32ed576c93c24"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "133d4a22abe265bae0588d1ffb5315f971f0f893", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/133d4a22abe265bae0588d1ffb5315f971f0f893", "committedDate": "2020-11-23T20:48:17Z", "message": "okHttp-library_and_refactor-code"}, "afterCommit": {"oid": "da27f6774005291b16d7b72a45af3e19cc682828", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/da27f6774005291b16d7b72a45af3e19cc682828", "committedDate": "2020-11-29T08:16:37Z", "message": "okHttp-library_and_refactor-code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da27f6774005291b16d7b72a45af3e19cc682828", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/da27f6774005291b16d7b72a45af3e19cc682828", "committedDate": "2020-11-29T08:16:37Z", "message": "okHttp-library_and_refactor-code"}, "afterCommit": {"oid": "2f904375b0cbcc772ad7665437679c21c31c12cd", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/2f904375b0cbcc772ad7665437679c21c31c12cd", "committedDate": "2020-11-29T11:13:24Z", "message": "okHttp-library_and_refactor-code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f904375b0cbcc772ad7665437679c21c31c12cd", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/2f904375b0cbcc772ad7665437679c21c31c12cd", "committedDate": "2020-11-29T11:13:24Z", "message": "okHttp-library_and_refactor-code"}, "afterCommit": {"oid": "0fe911172b1b7113947d7f36cd8568773b8ac66d", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/0fe911172b1b7113947d7f36cd8568773b8ac66d", "committedDate": "2020-12-14T19:49:43Z", "message": "refactoring and test-cases added"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0fe911172b1b7113947d7f36cd8568773b8ac66d", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/0fe911172b1b7113947d7f36cd8568773b8ac66d", "committedDate": "2020-12-14T19:49:43Z", "message": "refactoring and test-cases added"}, "afterCommit": {"oid": "429102e6f1caca4e8bee7878be01141d96c38a0a", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/429102e6f1caca4e8bee7878be01141d96c38a0a", "committedDate": "2020-12-14T21:16:02Z", "message": "refactoring and test-cases added"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "429102e6f1caca4e8bee7878be01141d96c38a0a", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/429102e6f1caca4e8bee7878be01141d96c38a0a", "committedDate": "2020-12-14T21:16:02Z", "message": "refactoring and test-cases added"}, "afterCommit": {"oid": "fdecb679032c0f2e0a151bab572c1ae3762c1e51", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/fdecb679032c0f2e0a151bab572c1ae3762c1e51", "committedDate": "2020-12-15T21:05:27Z", "message": "Credit_Bureau_Phase3 (FINERACT-734)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdecb679032c0f2e0a151bab572c1ae3762c1e51", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/fdecb679032c0f2e0a151bab572c1ae3762c1e51", "committedDate": "2020-12-15T21:05:27Z", "message": "Credit_Bureau_Phase3 (FINERACT-734)"}, "afterCommit": {"oid": "e31fa1f1ed89d9b1bce6e48125a36e06c035f578", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/e31fa1f1ed89d9b1bce6e48125a36e06c035f578", "committedDate": "2020-12-16T18:14:34Z", "message": "Credit_Bureau_Phase3 (FINERACT-734)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e31fa1f1ed89d9b1bce6e48125a36e06c035f578", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/e31fa1f1ed89d9b1bce6e48125a36e06c035f578", "committedDate": "2020-12-16T18:14:34Z", "message": "Credit_Bureau_Phase3 (FINERACT-734)"}, "afterCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/a92ac0ff5a725092eb954bcd411da9c8a981cb47", "committedDate": "2020-12-16T18:43:34Z", "message": "Credit_Bureau_Phase3 (FINERACT-734)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MDQyNDU1", "url": "https://github.com/apache/fineract/pull/1235#pullrequestreview-556042455", "createdAt": "2020-12-20T18:59:42Z", "commit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQxODo1OTo0M1rOIJGjRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMFQxOTozNTo0OFrOIJGxyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxNTQyOQ==", "bodyText": "this should be fetch credit report not post", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546415429", "createdAt": "2020-12-20T18:59:43Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/api/CreditBureauIntegrationAPI.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.api;\n+\n+import com.google.gson.Gson;\n+import io.swagger.v3.oas.annotations.Parameter;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+import javax.ws.rs.Consumes;\n+import javax.ws.rs.DELETE;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.POST;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.UriInfo;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.commands.service.PortfolioCommandSourceWritePlatformService;\n+import org.apache.fineract.infrastructure.core.api.ApiRequestParameterHelper;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.serialization.ApiRequestJsonSerializationSettings;\n+import org.apache.fineract.infrastructure.core.serialization.DefaultToApiJsonSerializer;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.service.CreditReportReadPlatformService;\n+import org.apache.fineract.infrastructure.creditbureau.service.CreditReportWritePlatformService;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.bind.annotation.RequestParam;\n+\n+@Path(\"/creditBureauIntegration\")\n+@Component\n+@Scope(\"singleton\")\n+public class CreditBureauIntegrationAPI {\n+\n+    private static final Set<String> RESPONSE_DATA_PARAMETERS = new HashSet<>(Arrays.asList(\"id\", \"creditBureauId\", \"nrc\", \"creditReport\"));\n+\n+    private final PlatformSecurityContext context;\n+    private final DefaultToApiJsonSerializer<CreditReportData> toCreditReportApiJsonSerializer;\n+    private final PortfolioCommandSourceWritePlatformService commandsSourceWritePlatformService;\n+    private final ApiRequestParameterHelper apiRequestParameterHelper;\n+    private final CreditReportWritePlatformService creditReportWritePlatformService;\n+    private final CreditReportReadPlatformService creditReportReadPlatformService;\n+    private final DefaultToApiJsonSerializer<CreditReportData> toApiJsonSerializer;\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauIntegrationAPI.class);\n+\n+    @Autowired\n+    public CreditBureauIntegrationAPI(final PlatformSecurityContext context,\n+            final DefaultToApiJsonSerializer<CreditReportData> toCreditReportApiJsonSerializer,\n+            final PortfolioCommandSourceWritePlatformService commandsSourceWritePlatformService,\n+            final ApiRequestParameterHelper apiRequestParameterHelper,\n+            final CreditReportWritePlatformService creditReportWritePlatformService,\n+            final CreditReportReadPlatformService creditReportReadPlatformService,\n+            final DefaultToApiJsonSerializer<CreditReportData> toApiJsonSerializer) {\n+        this.context = context;\n+        this.toCreditReportApiJsonSerializer = toCreditReportApiJsonSerializer;\n+        this.commandsSourceWritePlatformService = commandsSourceWritePlatformService;\n+        this.apiRequestParameterHelper = apiRequestParameterHelper;\n+        this.creditReportWritePlatformService = creditReportWritePlatformService;\n+        this.creditReportReadPlatformService = creditReportReadPlatformService;\n+        this.toApiJsonSerializer = toApiJsonSerializer;\n+\n+    }\n+\n+    @POST\n+    @Path(\"creditReport\")\n+    @Consumes({ MediaType.APPLICATION_JSON })\n+    @Produces({ MediaType.APPLICATION_JSON })\n+    public String postCreditReport(@Context final UriInfo uriInfo, @RequestParam(\"params\") final Map<String, Object> params) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxNTU4OA==", "bodyText": "enum values should be all caps", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546415588", "createdAt": "2020-12-20T19:01:43Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/data/CreditBureauConfigurations.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.data;\n+\n+public enum CreditBureauConfigurations {\n+\n+    THITSAWORKS, subscriptionId, subscriptionKey, userName, password;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxNTgxNg==", "bodyText": "rename creditBureauID to creditReportID", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546415816", "createdAt": "2020-12-20T19:03:54Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/api/CreditBureauIntegrationAPI.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.api;\n+\n+import com.google.gson.Gson;\n+import io.swagger.v3.oas.annotations.Parameter;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+import javax.ws.rs.Consumes;\n+import javax.ws.rs.DELETE;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.POST;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.UriInfo;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.commands.service.PortfolioCommandSourceWritePlatformService;\n+import org.apache.fineract.infrastructure.core.api.ApiRequestParameterHelper;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.serialization.ApiRequestJsonSerializationSettings;\n+import org.apache.fineract.infrastructure.core.serialization.DefaultToApiJsonSerializer;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.service.CreditReportReadPlatformService;\n+import org.apache.fineract.infrastructure.creditbureau.service.CreditReportWritePlatformService;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.bind.annotation.RequestParam;\n+\n+@Path(\"/creditBureauIntegration\")\n+@Component\n+@Scope(\"singleton\")\n+public class CreditBureauIntegrationAPI {\n+\n+    private static final Set<String> RESPONSE_DATA_PARAMETERS = new HashSet<>(Arrays.asList(\"id\", \"creditBureauId\", \"nrc\", \"creditReport\"));\n+\n+    private final PlatformSecurityContext context;\n+    private final DefaultToApiJsonSerializer<CreditReportData> toCreditReportApiJsonSerializer;\n+    private final PortfolioCommandSourceWritePlatformService commandsSourceWritePlatformService;\n+    private final ApiRequestParameterHelper apiRequestParameterHelper;\n+    private final CreditReportWritePlatformService creditReportWritePlatformService;\n+    private final CreditReportReadPlatformService creditReportReadPlatformService;\n+    private final DefaultToApiJsonSerializer<CreditReportData> toApiJsonSerializer;\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauIntegrationAPI.class);\n+\n+    @Autowired\n+    public CreditBureauIntegrationAPI(final PlatformSecurityContext context,\n+            final DefaultToApiJsonSerializer<CreditReportData> toCreditReportApiJsonSerializer,\n+            final PortfolioCommandSourceWritePlatformService commandsSourceWritePlatformService,\n+            final ApiRequestParameterHelper apiRequestParameterHelper,\n+            final CreditReportWritePlatformService creditReportWritePlatformService,\n+            final CreditReportReadPlatformService creditReportReadPlatformService,\n+            final DefaultToApiJsonSerializer<CreditReportData> toApiJsonSerializer) {\n+        this.context = context;\n+        this.toCreditReportApiJsonSerializer = toCreditReportApiJsonSerializer;\n+        this.commandsSourceWritePlatformService = commandsSourceWritePlatformService;\n+        this.apiRequestParameterHelper = apiRequestParameterHelper;\n+        this.creditReportWritePlatformService = creditReportWritePlatformService;\n+        this.creditReportReadPlatformService = creditReportReadPlatformService;\n+        this.toApiJsonSerializer = toApiJsonSerializer;\n+\n+    }\n+\n+    @POST\n+    @Path(\"creditReport\")\n+    @Consumes({ MediaType.APPLICATION_JSON })\n+    @Produces({ MediaType.APPLICATION_JSON })\n+    public String postCreditReport(@Context final UriInfo uriInfo, @RequestParam(\"params\") final Map<String, Object> params) {\n+\n+        Gson gson = new Gson();\n+        final String json = gson.toJson(params);\n+        final CommandWrapper commandRequest = new CommandWrapperBuilder().getCreditReport().withJson(json).build();\n+\n+        final CommandProcessingResult result = this.commandsSourceWritePlatformService.logCommandSource(commandRequest);\n+        return this.toCreditReportApiJsonSerializer.serialize(result);\n+\n+    }\n+\n+    // saves fetched-creditreport into database\n+    @POST\n+    @Path(\"saveCreditReport\")\n+    @Consumes({ MediaType.APPLICATION_JSON })\n+    @Produces({ MediaType.APPLICATION_JSON })\n+    public String saveCreditReport(@Parameter(hidden = true) final String apiRequestBodyAsJson,\n+            @QueryParam(\"creditBureauId\") @Parameter(description = \"creditBureauId\") final Long creditBureauId,\n+            @QueryParam(\"creditReportNumber\") @Parameter(description = \"creditReportNumber\") final String creditReportNumber) {\n+\n+        final CommandWrapper commandRequest = new CommandWrapperBuilder() //\n+                .saveCreditReport(creditBureauId, creditReportNumber) // creditReportNumber is a NRC number for\n+                                                                      // Thitsawork\n+                .withJson(apiRequestBodyAsJson) // apiRequestBodyAsJson is a creditReport\n+                .build(); //\n+\n+        final CommandProcessingResult result = this.commandsSourceWritePlatformService.logCommandSource(commandRequest);\n+        return this.toCreditReportApiJsonSerializer.serialize(result);\n+\n+    }\n+\n+    // fetch saved creditReports(NRC) from DB by creditBureauId, to select for downloading and deleting the reports\n+    @GET\n+    @Path(\"creditReport/{creditBureauId}\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxNTg1NQ==", "bodyText": "rename creditBureauID to creditReportID", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546415855", "createdAt": "2020-12-20T19:04:21Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/api/CreditBureauIntegrationAPI.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.api;\n+\n+import com.google.gson.Gson;\n+import io.swagger.v3.oas.annotations.Parameter;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+import javax.ws.rs.Consumes;\n+import javax.ws.rs.DELETE;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.POST;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.UriInfo;\n+import org.apache.fineract.commands.domain.CommandWrapper;\n+import org.apache.fineract.commands.service.CommandWrapperBuilder;\n+import org.apache.fineract.commands.service.PortfolioCommandSourceWritePlatformService;\n+import org.apache.fineract.infrastructure.core.api.ApiRequestParameterHelper;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.serialization.ApiRequestJsonSerializationSettings;\n+import org.apache.fineract.infrastructure.core.serialization.DefaultToApiJsonSerializer;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditReportData;\n+import org.apache.fineract.infrastructure.creditbureau.service.CreditReportReadPlatformService;\n+import org.apache.fineract.infrastructure.creditbureau.service.CreditReportWritePlatformService;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.bind.annotation.RequestParam;\n+\n+@Path(\"/creditBureauIntegration\")\n+@Component\n+@Scope(\"singleton\")\n+public class CreditBureauIntegrationAPI {\n+\n+    private static final Set<String> RESPONSE_DATA_PARAMETERS = new HashSet<>(Arrays.asList(\"id\", \"creditBureauId\", \"nrc\", \"creditReport\"));\n+\n+    private final PlatformSecurityContext context;\n+    private final DefaultToApiJsonSerializer<CreditReportData> toCreditReportApiJsonSerializer;\n+    private final PortfolioCommandSourceWritePlatformService commandsSourceWritePlatformService;\n+    private final ApiRequestParameterHelper apiRequestParameterHelper;\n+    private final CreditReportWritePlatformService creditReportWritePlatformService;\n+    private final CreditReportReadPlatformService creditReportReadPlatformService;\n+    private final DefaultToApiJsonSerializer<CreditReportData> toApiJsonSerializer;\n+    private static final Logger LOG = LoggerFactory.getLogger(CreditBureauIntegrationAPI.class);\n+\n+    @Autowired\n+    public CreditBureauIntegrationAPI(final PlatformSecurityContext context,\n+            final DefaultToApiJsonSerializer<CreditReportData> toCreditReportApiJsonSerializer,\n+            final PortfolioCommandSourceWritePlatformService commandsSourceWritePlatformService,\n+            final ApiRequestParameterHelper apiRequestParameterHelper,\n+            final CreditReportWritePlatformService creditReportWritePlatformService,\n+            final CreditReportReadPlatformService creditReportReadPlatformService,\n+            final DefaultToApiJsonSerializer<CreditReportData> toApiJsonSerializer) {\n+        this.context = context;\n+        this.toCreditReportApiJsonSerializer = toCreditReportApiJsonSerializer;\n+        this.commandsSourceWritePlatformService = commandsSourceWritePlatformService;\n+        this.apiRequestParameterHelper = apiRequestParameterHelper;\n+        this.creditReportWritePlatformService = creditReportWritePlatformService;\n+        this.creditReportReadPlatformService = creditReportReadPlatformService;\n+        this.toApiJsonSerializer = toApiJsonSerializer;\n+\n+    }\n+\n+    @POST\n+    @Path(\"creditReport\")\n+    @Consumes({ MediaType.APPLICATION_JSON })\n+    @Produces({ MediaType.APPLICATION_JSON })\n+    public String postCreditReport(@Context final UriInfo uriInfo, @RequestParam(\"params\") final Map<String, Object> params) {\n+\n+        Gson gson = new Gson();\n+        final String json = gson.toJson(params);\n+        final CommandWrapper commandRequest = new CommandWrapperBuilder().getCreditReport().withJson(json).build();\n+\n+        final CommandProcessingResult result = this.commandsSourceWritePlatformService.logCommandSource(commandRequest);\n+        return this.toCreditReportApiJsonSerializer.serialize(result);\n+\n+    }\n+\n+    // saves fetched-creditreport into database\n+    @POST\n+    @Path(\"saveCreditReport\")\n+    @Consumes({ MediaType.APPLICATION_JSON })\n+    @Produces({ MediaType.APPLICATION_JSON })\n+    public String saveCreditReport(@Parameter(hidden = true) final String apiRequestBodyAsJson,\n+            @QueryParam(\"creditBureauId\") @Parameter(description = \"creditBureauId\") final Long creditBureauId,\n+            @QueryParam(\"creditReportNumber\") @Parameter(description = \"creditReportNumber\") final String creditReportNumber) {\n+\n+        final CommandWrapper commandRequest = new CommandWrapperBuilder() //\n+                .saveCreditReport(creditBureauId, creditReportNumber) // creditReportNumber is a NRC number for\n+                                                                      // Thitsawork\n+                .withJson(apiRequestBodyAsJson) // apiRequestBodyAsJson is a creditReport\n+                .build(); //\n+\n+        final CommandProcessingResult result = this.commandsSourceWritePlatformService.logCommandSource(commandRequest);\n+        return this.toCreditReportApiJsonSerializer.serialize(result);\n+\n+    }\n+\n+    // fetch saved creditReports(NRC) from DB by creditBureauId, to select for downloading and deleting the reports\n+    @GET\n+    @Path(\"creditReport/{creditBureauId}\")\n+    @Consumes({ MediaType.APPLICATION_JSON })\n+    @Produces({ MediaType.APPLICATION_JSON })\n+    public String getSavedCreditReport(@PathParam(\"creditBureauId\") @Parameter(description = \"creditBureauId\") final Long creditBureauId,\n+            @Context final UriInfo uriInfo) {\n+\n+        this.context.authenticatedUser();\n+\n+        final Collection<CreditReportData> creditReport = this.creditReportReadPlatformService.retrieveCreditReport(creditBureauId);\n+\n+        final ApiRequestJsonSerializationSettings settings = this.apiRequestParameterHelper.process(uriInfo.getQueryParameters());\n+        return this.toApiJsonSerializer.serialize(settings, creditReport, RESPONSE_DATA_PARAMETERS);\n+\n+    }\n+\n+    // deletes saved creditReports from database\n+    @DELETE\n+    @Path(\"deleteCreditReport/{creditBureauId}\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxNjE2MA==", "bodyText": "is this plain string or do you want to put this in array or some collection?", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546416160", "createdAt": "2020-12-20T19:06:54Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/data/CreditBureauReportData.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.data;\n+\n+import java.io.Serializable;\n+\n+public final class CreditBureauReportData implements Serializable {\n+\n+    @SuppressWarnings(\"unused\")\n+    private final String name;\n+\n+    private final String gender;\n+\n+    private final String address;\n+\n+    private final String creditScore;\n+\n+    private final String borrowerInfo;\n+\n+    private final String activeLoans;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxNjQxOA==", "bodyText": "same here, this could be multiple accounts, so you may want to put it in array/collections. You may also rename this to closedAccounts and rename activeLoans to openAccounts. I am fine if you don't rename it.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546416418", "createdAt": "2020-12-20T19:09:30Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/data/CreditBureauReportData.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.data;\n+\n+import java.io.Serializable;\n+\n+public final class CreditBureauReportData implements Serializable {\n+\n+    @SuppressWarnings(\"unused\")\n+    private final String name;\n+\n+    private final String gender;\n+\n+    private final String address;\n+\n+    private final String creditScore;\n+\n+    private final String borrowerInfo;\n+\n+    private final String activeLoans;\n+\n+    private final String paidLoans;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxNjQ2OQ==", "bodyText": "remove commented code.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546416469", "createdAt": "2020-12-20T19:09:57Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/data/CreditBureauReportData.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.fineract.infrastructure.creditbureau.data;\n+\n+import java.io.Serializable;\n+\n+public final class CreditBureauReportData implements Serializable {\n+\n+    @SuppressWarnings(\"unused\")\n+    private final String name;\n+\n+    private final String gender;\n+\n+    private final String address;\n+\n+    private final String creditScore;\n+\n+    private final String borrowerInfo;\n+\n+    private final String activeLoans;\n+\n+    private final String paidLoans;\n+\n+    /*\n+     * private final Object borrowerInformation; private final Object creditScore; private final Object activeLoans;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxNjgwMw==", "bodyText": "I don't see we are retrieving credit report.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546416803", "createdAt": "2020-12-20T19:13:46Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/data/CreditReportReadPlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.data;\n+\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Collection;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.service.CreditReportReadPlatformService;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.jdbc.core.RowMapper;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class CreditReportReadPlatformServiceImpl implements CreditReportReadPlatformService {\n+\n+    private final JdbcTemplate jdbcTemplate;\n+    private final PlatformSecurityContext context;\n+\n+    @Autowired\n+    public CreditReportReadPlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource) {\n+        this.context = context;\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+    }\n+\n+    private static final class CreditReportDataMapper implements RowMapper<CreditReportData> {\n+\n+        public String schema() {\n+            return \" c.id as id, c.creditBureauId as creditBureauId , c.nrc as nrc from m_creditreport c \";\n+        }\n+\n+        @Override\n+        public CreditReportData mapRow(final ResultSet rs, @SuppressWarnings(\"unused\") final int rowNum) throws SQLException {\n+\n+            final Long id = rs.getLong(\"id\");\n+            final Long creditBureauId = rs.getLong(\"creditBureauId\");\n+            final String nrc = rs.getString(\"nrc\");\n+            // final byte[] creditReports = rs.getBytes(\"creditReports\");\n+\n+            return CreditReportData.instance(id, creditBureauId, nrc);// , creditReports);\n+        }\n+    }\n+\n+    @Override\n+    public Collection<CreditReportData> retrieveCreditReport(Long creditBureauId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxNzQyMg==", "bodyText": "you can rename nrc to nationalID to make it sound as generic", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546417422", "createdAt": "2020-12-20T19:18:51Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/domain/CreditReport.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.domain;\n+\n+import javax.persistence.Basic;\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.FetchType;\n+import javax.persistence.Table;\n+import org.apache.fineract.infrastructure.core.domain.AbstractPersistableCustom;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Entity\n+@Table(name = \"m_creditreport\")\n+public final class CreditReport extends AbstractPersistableCustom {\n+\n+    @Column(name = \"creditBureauId\")\n+    private Long creditBureauId;\n+\n+    @Column(name = \"nrc\")\n+    private String nrc;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxNzc2Mg==", "bodyText": "I think If you rename nrc to nationalID, I would say other credit bureaus would also have such a ID. So this can be generic as well. We may revisit this later, if we think this is not the case.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546417762", "createdAt": "2020-12-20T19:22:41Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/domain/CreditReportRepository.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.domain;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.JpaSpecificationExecutor;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+\n+public interface CreditReportRepository extends JpaRepository<CreditReport, Long>, JpaSpecificationExecutor<CreditReport> {\n+\n+    @Query(\"SELECT creditBureauReport from CreditReport creditBureauReport where creditBureauReport.nrc = :nrc and creditBureauReport.creditBureauId = :creditBureauId \")\n+    CreditReport getThitsaWorksCreditReport(@Param(\"creditBureauId\") Long creditBureauId, @Param(\"nrc\") String nrc);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxODk4NQ==", "bodyText": "I don't think you need to check if null here, it would always be null.", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546418985", "createdAt": "2020-12-20T19:34:23Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditReportWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import javax.persistence.PersistenceException;\n+import org.apache.commons.lang3.exception.ExceptionUtils;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.data.ApiParameterError;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResultBuilder;\n+import org.apache.fineract.infrastructure.core.data.DataValidatorBuilder;\n+import org.apache.fineract.infrastructure.core.exception.PlatformApiDataValidationException;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditBureauConfigurations;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditBureauReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureau;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauLoanProductMappingRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditReport;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditReportRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.dao.DataIntegrityViolationException;\n+import org.springframework.orm.jpa.JpaSystemException;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditReportWritePlatformServiceImpl implements CreditReportWritePlatformService {\n+\n+    private final PlatformSecurityContext context;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauRepository creditBureauRepository;\n+    private final CreditReportRepository creditReportRepository;\n+    private final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService;\n+    private final ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl thitsaWorksCreditBureauIntegrationWritePlatformServiceImpl;\n+    private final List<ApiParameterError> dataValidationErrors = new ArrayList<>();\n+    private final DataValidatorBuilder baseDataValidator = new DataValidatorBuilder(dataValidationErrors)\n+            .resource(\"creditBureauIntegration\");\n+\n+    @Autowired\n+    public CreditReportWritePlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer,\n+            final CreditBureauLoanProductMappingRepository loanProductMappingRepository,\n+            final CreditBureauRepository creditBureauRepository, final CreditReportRepository creditReportRepository,\n+            final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService,\n+            final ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl thitsaWorksCreditBureauIntegrationWritePlatformServiceImpl) {\n+        this.context = context;\n+        this.configDataRepository = configDataRepository;\n+        this.creditBureauRepository = creditBureauRepository;\n+        this.creditReportRepository = creditReportRepository;\n+        this.thitsaWorksCreditBureauIntegrationWritePlatformService = thitsaWorksCreditBureauIntegrationWritePlatformService;\n+        this.thitsaWorksCreditBureauIntegrationWritePlatformServiceImpl = thitsaWorksCreditBureauIntegrationWritePlatformServiceImpl;\n+    }\n+\n+    @Override\n+    @Transactional\n+    public CommandProcessingResult getCreditReport(JsonCommand command) {\n+\n+        try {\n+            Long creditBureauID = command.longValueOfParameterNamed(\"creditBureauID\");\n+\n+            Optional<String> creditBureauName = getCreditBureau(creditBureauID);\n+\n+            if (creditBureauName.isEmpty()) {\n+                baseDataValidator.reset().failWithCode(\"creditBureau.has.not.been.Integrated\");\n+                throw new PlatformApiDataValidationException(\"creditBureau.has.not.been.Integrated\", \"creditBureau.has.not.been.Integrated\",\n+                        dataValidationErrors);\n+            }\n+\n+            if (Objects.equals(creditBureauName.get(), CreditBureauConfigurations.THITSAWORKS.toString())) {\n+\n+                // CreditBureauToken creditBureauToken = this.thitsaWorksCreditBureauIntegrationWritePlatformService\n+                // .createToken(creditBureauID);\n+\n+                CreditBureauReportData reportobj = this.thitsaWorksCreditBureauIntegrationWritePlatformService\n+                        .getCreditReportFromThitsaWorks(command);\n+\n+                // return new\n+                // CommandProcessingResultBuilder().withCreditReport(reportobj).withCreditBureauToken(creditBureauToken).build();\n+                return new CommandProcessingResultBuilder().withCreditReport(reportobj).build();\n+            }\n+\n+            baseDataValidator.reset().failWithCode(\"creditBureau.has.not.been.Integrated\");\n+            throw new PlatformApiDataValidationException(\"creditBureau.has.not.been.Integrated\", \"creditBureau.has.not.been.Integrated\",\n+                    dataValidationErrors);\n+\n+        } catch (final DataIntegrityViolationException dve) {\n+            handleTokenDataIntegrityIssues(command, dve.getMostSpecificCause(), dve);\n+            return CommandProcessingResult.empty();\n+        } catch (final PersistenceException ee) {\n+            Throwable throwable = ExceptionUtils.getRootCause(ee.getCause());\n+            handleTokenDataIntegrityIssues(command, throwable, ee);\n+            return CommandProcessingResult.empty();\n+        }\n+\n+    }\n+\n+    private Optional<String> getCreditBureau(Long creditBureauID) {\n+\n+        if (creditBureauID != null) {\n+            Optional<CreditBureau> creditBureau = this.creditBureauRepository.findById(creditBureauID);\n+\n+            if (creditBureau.isEmpty()) {\n+                return Optional.empty();\n+            }\n+\n+            return Optional.of(creditBureau.get().getName());\n+\n+        }\n+\n+        return Optional.empty();\n+    }\n+\n+    // saving the fetched creditreport in database\n+    @Override\n+    @Transactional\n+    public CommandProcessingResult saveCreditReport(Long creditBureauId, String creditReportNumber, JsonCommand command) {\n+\n+        try {\n+            this.context.authenticatedUser();\n+\n+            Optional<String> creditBureauName = getCreditBureau(creditBureauId);\n+            CreditReport creditReport = null;\n+\n+            if (Objects.equals(creditBureauName.get(), CreditBureauConfigurations.THITSAWORKS.toString())) {\n+\n+                creditReport = creditReportRepository.getThitsaWorksCreditReport(creditBureauId, creditReportNumber);\n+\n+                // checks whether the creditReport for same NRC was saved before. if yes, then deletes it and replaces\n+                // it with new one.\n+                if (creditReport != null) {\n+                    this.creditReportRepository.delete(creditReport);\n+                    creditReport = null;\n+                }\n+\n+                if (creditReport == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQxOTE0Ng==", "bodyText": "don't set it as null and remove the null check below", "url": "https://github.com/apache/fineract/pull/1235#discussion_r546419146", "createdAt": "2020-12-20T19:35:48Z", "author": {"login": "nikpawar89"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/creditbureau/service/CreditReportWritePlatformServiceImpl.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.fineract.infrastructure.creditbureau.service;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import javax.persistence.PersistenceException;\n+import org.apache.commons.lang3.exception.ExceptionUtils;\n+import org.apache.fineract.infrastructure.core.api.JsonCommand;\n+import org.apache.fineract.infrastructure.core.data.ApiParameterError;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResult;\n+import org.apache.fineract.infrastructure.core.data.CommandProcessingResultBuilder;\n+import org.apache.fineract.infrastructure.core.data.DataValidatorBuilder;\n+import org.apache.fineract.infrastructure.core.exception.PlatformApiDataValidationException;\n+import org.apache.fineract.infrastructure.core.exception.PlatformDataIntegrityException;\n+import org.apache.fineract.infrastructure.core.serialization.FromJsonHelper;\n+import org.apache.fineract.infrastructure.core.service.RoutingDataSource;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditBureauConfigurations;\n+import org.apache.fineract.infrastructure.creditbureau.data.CreditBureauReportData;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureau;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauConfigurationRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauLoanProductMappingRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditBureauRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditReport;\n+import org.apache.fineract.infrastructure.creditbureau.domain.CreditReportRepository;\n+import org.apache.fineract.infrastructure.creditbureau.domain.TokenRepositoryWrapper;\n+import org.apache.fineract.infrastructure.creditbureau.serialization.CreditBureauTokenCommandFromApiJsonDeserializer;\n+import org.apache.fineract.infrastructure.security.service.PlatformSecurityContext;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.dao.DataIntegrityViolationException;\n+import org.springframework.orm.jpa.JpaSystemException;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Service\n+public class CreditReportWritePlatformServiceImpl implements CreditReportWritePlatformService {\n+\n+    private final PlatformSecurityContext context;\n+    private final CreditBureauConfigurationRepositoryWrapper configDataRepository;\n+    private final CreditBureauRepository creditBureauRepository;\n+    private final CreditReportRepository creditReportRepository;\n+    private final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService;\n+    private final ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl thitsaWorksCreditBureauIntegrationWritePlatformServiceImpl;\n+    private final List<ApiParameterError> dataValidationErrors = new ArrayList<>();\n+    private final DataValidatorBuilder baseDataValidator = new DataValidatorBuilder(dataValidationErrors)\n+            .resource(\"creditBureauIntegration\");\n+\n+    @Autowired\n+    public CreditReportWritePlatformServiceImpl(final PlatformSecurityContext context, final RoutingDataSource dataSource,\n+            final FromJsonHelper fromApiJsonHelper, final TokenRepositoryWrapper tokenRepository,\n+            final CreditBureauConfigurationRepositoryWrapper configDataRepository,\n+            final CreditBureauTokenCommandFromApiJsonDeserializer fromApiJsonDeserializer,\n+            final CreditBureauLoanProductMappingRepository loanProductMappingRepository,\n+            final CreditBureauRepository creditBureauRepository, final CreditReportRepository creditReportRepository,\n+            final ThitsaWorksCreditBureauIntegrationWritePlatformService thitsaWorksCreditBureauIntegrationWritePlatformService,\n+            final ThitsaWorksCreditBureauIntegrationWritePlatformServiceImpl thitsaWorksCreditBureauIntegrationWritePlatformServiceImpl) {\n+        this.context = context;\n+        this.configDataRepository = configDataRepository;\n+        this.creditBureauRepository = creditBureauRepository;\n+        this.creditReportRepository = creditReportRepository;\n+        this.thitsaWorksCreditBureauIntegrationWritePlatformService = thitsaWorksCreditBureauIntegrationWritePlatformService;\n+        this.thitsaWorksCreditBureauIntegrationWritePlatformServiceImpl = thitsaWorksCreditBureauIntegrationWritePlatformServiceImpl;\n+    }\n+\n+    @Override\n+    @Transactional\n+    public CommandProcessingResult getCreditReport(JsonCommand command) {\n+\n+        try {\n+            Long creditBureauID = command.longValueOfParameterNamed(\"creditBureauID\");\n+\n+            Optional<String> creditBureauName = getCreditBureau(creditBureauID);\n+\n+            if (creditBureauName.isEmpty()) {\n+                baseDataValidator.reset().failWithCode(\"creditBureau.has.not.been.Integrated\");\n+                throw new PlatformApiDataValidationException(\"creditBureau.has.not.been.Integrated\", \"creditBureau.has.not.been.Integrated\",\n+                        dataValidationErrors);\n+            }\n+\n+            if (Objects.equals(creditBureauName.get(), CreditBureauConfigurations.THITSAWORKS.toString())) {\n+\n+                // CreditBureauToken creditBureauToken = this.thitsaWorksCreditBureauIntegrationWritePlatformService\n+                // .createToken(creditBureauID);\n+\n+                CreditBureauReportData reportobj = this.thitsaWorksCreditBureauIntegrationWritePlatformService\n+                        .getCreditReportFromThitsaWorks(command);\n+\n+                // return new\n+                // CommandProcessingResultBuilder().withCreditReport(reportobj).withCreditBureauToken(creditBureauToken).build();\n+                return new CommandProcessingResultBuilder().withCreditReport(reportobj).build();\n+            }\n+\n+            baseDataValidator.reset().failWithCode(\"creditBureau.has.not.been.Integrated\");\n+            throw new PlatformApiDataValidationException(\"creditBureau.has.not.been.Integrated\", \"creditBureau.has.not.been.Integrated\",\n+                    dataValidationErrors);\n+\n+        } catch (final DataIntegrityViolationException dve) {\n+            handleTokenDataIntegrityIssues(command, dve.getMostSpecificCause(), dve);\n+            return CommandProcessingResult.empty();\n+        } catch (final PersistenceException ee) {\n+            Throwable throwable = ExceptionUtils.getRootCause(ee.getCause());\n+            handleTokenDataIntegrityIssues(command, throwable, ee);\n+            return CommandProcessingResult.empty();\n+        }\n+\n+    }\n+\n+    private Optional<String> getCreditBureau(Long creditBureauID) {\n+\n+        if (creditBureauID != null) {\n+            Optional<CreditBureau> creditBureau = this.creditBureauRepository.findById(creditBureauID);\n+\n+            if (creditBureau.isEmpty()) {\n+                return Optional.empty();\n+            }\n+\n+            return Optional.of(creditBureau.get().getName());\n+\n+        }\n+\n+        return Optional.empty();\n+    }\n+\n+    // saving the fetched creditreport in database\n+    @Override\n+    @Transactional\n+    public CommandProcessingResult saveCreditReport(Long creditBureauId, String creditReportNumber, JsonCommand command) {\n+\n+        try {\n+            this.context.authenticatedUser();\n+\n+            Optional<String> creditBureauName = getCreditBureau(creditBureauId);\n+            CreditReport creditReport = null;\n+\n+            if (Objects.equals(creditBureauName.get(), CreditBureauConfigurations.THITSAWORKS.toString())) {\n+\n+                creditReport = creditReportRepository.getThitsaWorksCreditReport(creditBureauId, creditReportNumber);\n+\n+                // checks whether the creditReport for same NRC was saved before. if yes, then deletes it and replaces\n+                // it with new one.\n+                if (creditReport != null) {\n+                    this.creditReportRepository.delete(creditReport);\n+                    creditReport = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92ac0ff5a725092eb954bcd411da9c8a981cb47"}, "originalPosition": 162}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37c04a18f59a22ee4e1fbec68da979a1ea5de1ea", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/37c04a18f59a22ee4e1fbec68da979a1ea5de1ea", "committedDate": "2020-12-25T06:47:56Z", "message": "renaming-and-stringarray"}, "afterCommit": {"oid": "50ff4871aa7f69f95a74c7d9de4199236e74581b", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/50ff4871aa7f69f95a74c7d9de4199236e74581b", "committedDate": "2020-12-25T13:41:05Z", "message": "renaming-and-stringarray"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50ff4871aa7f69f95a74c7d9de4199236e74581b", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/50ff4871aa7f69f95a74c7d9de4199236e74581b", "committedDate": "2020-12-25T13:41:05Z", "message": "renaming-and-stringarray"}, "afterCommit": {"oid": "2b0e21b44c11ad5018207a47213111593c1525fd", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/2b0e21b44c11ad5018207a47213111593c1525fd", "committedDate": "2020-12-25T14:39:20Z", "message": "CreditBureau-Integration-Api-documentation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b0e21b44c11ad5018207a47213111593c1525fd", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/2b0e21b44c11ad5018207a47213111593c1525fd", "committedDate": "2020-12-25T14:39:20Z", "message": "CreditBureau-Integration-Api-documentation"}, "afterCommit": {"oid": "d7c36b20e8cde0347c4658a718727153479e7ffa", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/d7c36b20e8cde0347c4658a718727153479e7ffa", "committedDate": "2020-12-25T14:46:17Z", "message": "CreditBureau-Integration-Api-documentation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7c36b20e8cde0347c4658a718727153479e7ffa", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/d7c36b20e8cde0347c4658a718727153479e7ffa", "committedDate": "2020-12-25T14:46:17Z", "message": "CreditBureau-Integration-Api-documentation"}, "afterCommit": {"oid": "2f45a8bc26618a51dc6c892c731ddbcda4e62f9d", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/2f45a8bc26618a51dc6c892c731ddbcda4e62f9d", "committedDate": "2020-12-29T16:29:22Z", "message": "CreditBureau-Integration-Api-documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e24b32e6d858e68e81a48dea683623fabda610c6", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/e24b32e6d858e68e81a48dea683623fabda610c6", "committedDate": "2020-12-29T16:59:39Z", "message": "Credit_Bureau_Phase3 (FINERACT-734)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bffbdb3d2b99b852ee3fd52a6f2894bf2535d32f", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/bffbdb3d2b99b852ee3fd52a6f2894bf2535d32f", "committedDate": "2020-12-29T16:59:40Z", "message": "CreditBureau-Integration-Api-documentation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f45a8bc26618a51dc6c892c731ddbcda4e62f9d", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/2f45a8bc26618a51dc6c892c731ddbcda4e62f9d", "committedDate": "2020-12-29T16:29:22Z", "message": "CreditBureau-Integration-Api-documentation"}, "afterCommit": {"oid": "bffbdb3d2b99b852ee3fd52a6f2894bf2535d32f", "author": {"user": {"login": "rrpawar96", "name": "Rahul Pawar"}}, "url": "https://github.com/apache/fineract/commit/bffbdb3d2b99b852ee3fd52a6f2894bf2535d32f", "committedDate": "2020-12-29T16:59:40Z", "message": "CreditBureau-Integration-Api-documentation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1791, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}