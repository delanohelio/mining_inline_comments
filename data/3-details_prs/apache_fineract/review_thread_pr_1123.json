{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMzAzOTEx", "number": 1123, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwOTo0OToyNVrOEJmqGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNDo0MTo0NFrOELRUuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NTA2MDA4OnYy", "diffSide": "LEFT", "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/group/service/CenterReadPlatformServiceImpl.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwOTo0OToyNVrOGqLhTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwMDowNjoyMlrOG14VZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4MjEyNw==", "bodyText": "Also removing this part is not correct as of NOW, the problem is we are talking SQL query as a query to give users more functionality and certainly that is not supported in SQL builder currently, we probably would need to parse things find relevant queries and then add those to extra criteria still thinking on it.\nWill be looked after limit and order by are supported.", "url": "https://github.com/apache/fineract/pull/1123#discussion_r446882127", "createdAt": "2020-06-29T09:49:25Z", "author": {"login": "thesmallstar"}, "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/group/service/CenterReadPlatformServiceImpl.java", "diffHunk": "@@ -122,55 +122,26 @@ public CenterReadPlatformServiceImpl(final PlatformSecurityContext context, fina\n     // 'g.' preffix because of ERROR 1052 (23000): Column 'column_name' in where\n     // clause is ambiguous\n     // caused by the same name of columns in m_office and m_group tables\n-    private String getCenterExtraCriteria(String schemaSl, List<Object> paramList, final SearchParameters searchCriteria) {\n+    private SQLBuilder getCenterExtraCriteria(String schemaSl, final SearchParameters searchCriteria) {\n \n-        StringBuilder extraCriteria = new StringBuilder(200);\n-        extraCriteria.append(\" and g.level_id = \" + GroupTypes.CENTER.getId());\n+        SQLBuilder extraCriteria = new SQLBuilder();\n+        extraCriteria.addCriteria(\"g.level_id =\", GroupTypes.CENTER.getId());\n         if (searchCriteria != null) {\n             String sqlQueryCriteria = searchCriteria.getSqlSearch();\n             if (StringUtils.isNotBlank(sqlQueryCriteria)) {\n                 SQLInjectionValidator.validateSQLInput(sqlQueryCriteria);\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\" display_name \", \" g.display_name \");\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\"display_name \", \"g.display_name \");\n-                extraCriteria.append(\" and (\").append(sqlQueryCriteria).append(\") \");\n-                this.columnValidator.validateSqlInjection(schemaSl, sqlQueryCriteria);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI3MTkzMA==", "bodyText": "@vorburger  WDYT on this?", "url": "https://github.com/apache/fineract/pull/1123#discussion_r448271930", "createdAt": "2020-07-01T10:32:49Z", "author": {"login": "thesmallstar"}, "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/group/service/CenterReadPlatformServiceImpl.java", "diffHunk": "@@ -122,55 +122,26 @@ public CenterReadPlatformServiceImpl(final PlatformSecurityContext context, fina\n     // 'g.' preffix because of ERROR 1052 (23000): Column 'column_name' in where\n     // clause is ambiguous\n     // caused by the same name of columns in m_office and m_group tables\n-    private String getCenterExtraCriteria(String schemaSl, List<Object> paramList, final SearchParameters searchCriteria) {\n+    private SQLBuilder getCenterExtraCriteria(String schemaSl, final SearchParameters searchCriteria) {\n \n-        StringBuilder extraCriteria = new StringBuilder(200);\n-        extraCriteria.append(\" and g.level_id = \" + GroupTypes.CENTER.getId());\n+        SQLBuilder extraCriteria = new SQLBuilder();\n+        extraCriteria.addCriteria(\"g.level_id =\", GroupTypes.CENTER.getId());\n         if (searchCriteria != null) {\n             String sqlQueryCriteria = searchCriteria.getSqlSearch();\n             if (StringUtils.isNotBlank(sqlQueryCriteria)) {\n                 SQLInjectionValidator.validateSQLInput(sqlQueryCriteria);\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\" display_name \", \" g.display_name \");\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\"display_name \", \"g.display_name \");\n-                extraCriteria.append(\" and (\").append(sqlQueryCriteria).append(\") \");\n-                this.columnValidator.validateSqlInjection(schemaSl, sqlQueryCriteria);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4MjEyNw=="}, "originalCommit": null, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYxNjUxNA==", "bodyText": "@thesmallstar I'm not sure I fully understand what you mean here, but starting to think about adding parsing things sounds like the wrong direction - try not to have to do that (it will be a mess - trust me).", "url": "https://github.com/apache/fineract/pull/1123#discussion_r449616514", "createdAt": "2020-07-03T14:42:31Z", "author": {"login": "vorburger"}, "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/group/service/CenterReadPlatformServiceImpl.java", "diffHunk": "@@ -122,55 +122,26 @@ public CenterReadPlatformServiceImpl(final PlatformSecurityContext context, fina\n     // 'g.' preffix because of ERROR 1052 (23000): Column 'column_name' in where\n     // clause is ambiguous\n     // caused by the same name of columns in m_office and m_group tables\n-    private String getCenterExtraCriteria(String schemaSl, List<Object> paramList, final SearchParameters searchCriteria) {\n+    private SQLBuilder getCenterExtraCriteria(String schemaSl, final SearchParameters searchCriteria) {\n \n-        StringBuilder extraCriteria = new StringBuilder(200);\n-        extraCriteria.append(\" and g.level_id = \" + GroupTypes.CENTER.getId());\n+        SQLBuilder extraCriteria = new SQLBuilder();\n+        extraCriteria.addCriteria(\"g.level_id =\", GroupTypes.CENTER.getId());\n         if (searchCriteria != null) {\n             String sqlQueryCriteria = searchCriteria.getSqlSearch();\n             if (StringUtils.isNotBlank(sqlQueryCriteria)) {\n                 SQLInjectionValidator.validateSQLInput(sqlQueryCriteria);\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\" display_name \", \" g.display_name \");\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\"display_name \", \"g.display_name \");\n-                extraCriteria.append(\" and (\").append(sqlQueryCriteria).append(\") \");\n-                this.columnValidator.validateSqlInjection(schemaSl, sqlQueryCriteria);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4MjEyNw=="}, "originalCommit": null, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwMzAyMw==", "bodyText": "@thesmallstar sorry for the huge delay in getting back to you on this one. I've re-read it again now (took me a minute to get back into it). Are you suggesting that we merge this now? Because, unless I misunderstand, this would break the currently existing functionality for these sqlQueryCriteria, agreed? But they really are a problem, huh? I need to dig more into the code to understand where this is coming from..", "url": "https://github.com/apache/fineract/pull/1123#discussion_r459103023", "createdAt": "2020-07-22T21:47:34Z", "author": {"login": "vorburger"}, "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/group/service/CenterReadPlatformServiceImpl.java", "diffHunk": "@@ -122,55 +122,26 @@ public CenterReadPlatformServiceImpl(final PlatformSecurityContext context, fina\n     // 'g.' preffix because of ERROR 1052 (23000): Column 'column_name' in where\n     // clause is ambiguous\n     // caused by the same name of columns in m_office and m_group tables\n-    private String getCenterExtraCriteria(String schemaSl, List<Object> paramList, final SearchParameters searchCriteria) {\n+    private SQLBuilder getCenterExtraCriteria(String schemaSl, final SearchParameters searchCriteria) {\n \n-        StringBuilder extraCriteria = new StringBuilder(200);\n-        extraCriteria.append(\" and g.level_id = \" + GroupTypes.CENTER.getId());\n+        SQLBuilder extraCriteria = new SQLBuilder();\n+        extraCriteria.addCriteria(\"g.level_id =\", GroupTypes.CENTER.getId());\n         if (searchCriteria != null) {\n             String sqlQueryCriteria = searchCriteria.getSqlSearch();\n             if (StringUtils.isNotBlank(sqlQueryCriteria)) {\n                 SQLInjectionValidator.validateSQLInput(sqlQueryCriteria);\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\" display_name \", \" g.display_name \");\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\"display_name \", \"g.display_name \");\n-                extraCriteria.append(\" and (\").append(sqlQueryCriteria).append(\") \");\n-                this.columnValidator.validateSqlInjection(schemaSl, sqlQueryCriteria);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4MjEyNw=="}, "originalCommit": null, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1MDY5Mw==", "bodyText": "We can't (shouldn't) merge this PR as is, because it will break support for sqlSearch. We need to EITHER support it here, OR (my preference) should just cleanly remove it all together - as (now) suggested in https://issues.apache.org/jira/browse/FINERACT-1095.", "url": "https://github.com/apache/fineract/pull/1123#discussion_r459150693", "createdAt": "2020-07-23T00:06:22Z", "author": {"login": "vorburger"}, "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/group/service/CenterReadPlatformServiceImpl.java", "diffHunk": "@@ -122,55 +122,26 @@ public CenterReadPlatformServiceImpl(final PlatformSecurityContext context, fina\n     // 'g.' preffix because of ERROR 1052 (23000): Column 'column_name' in where\n     // clause is ambiguous\n     // caused by the same name of columns in m_office and m_group tables\n-    private String getCenterExtraCriteria(String schemaSl, List<Object> paramList, final SearchParameters searchCriteria) {\n+    private SQLBuilder getCenterExtraCriteria(String schemaSl, final SearchParameters searchCriteria) {\n \n-        StringBuilder extraCriteria = new StringBuilder(200);\n-        extraCriteria.append(\" and g.level_id = \" + GroupTypes.CENTER.getId());\n+        SQLBuilder extraCriteria = new SQLBuilder();\n+        extraCriteria.addCriteria(\"g.level_id =\", GroupTypes.CENTER.getId());\n         if (searchCriteria != null) {\n             String sqlQueryCriteria = searchCriteria.getSqlSearch();\n             if (StringUtils.isNotBlank(sqlQueryCriteria)) {\n                 SQLInjectionValidator.validateSQLInput(sqlQueryCriteria);\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\" display_name \", \" g.display_name \");\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\"display_name \", \"g.display_name \");\n-                extraCriteria.append(\" and (\").append(sqlQueryCriteria).append(\") \");\n-                this.columnValidator.validateSqlInjection(schemaSl, sqlQueryCriteria);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4MjEyNw=="}, "originalCommit": null, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMjUzNjI1OnYy", "diffSide": "RIGHT", "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/security/utils/SQLBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNDo0MTo0NFrOGsyZNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNDo0MTo0NFrOGsyZNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYxNjE4MQ==", "bodyText": "lower-case y:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void addOrderBY(Object orderBy) {\n          \n          \n            \n                public void addOrderBy(Object orderBy) {", "url": "https://github.com/apache/fineract/pull/1123#discussion_r449616181", "createdAt": "2020-07-03T14:41:44Z", "author": {"login": "vorburger"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/security/utils/SQLBuilder.java", "diffHunk": "@@ -110,6 +111,39 @@ public void addNonNullCriteria(String criteria, Object argument) {\n         }\n     }\n \n+    /**\n+     * Adds the limit statement in the end of WHERE clause\n+     *\n+     * @param limit\n+     *            The value that will be used as limit\n+     */\n+    public void setLimit(Object limit) {\n+        sb.append(\" LIMIT ? \");\n+        args.add(limit);\n+    }\n+\n+    /**\n+     * Adds the offset statement in the end of WHERE clause\n+     *\n+     * @param offset\n+     *            The value that will be used as offset\n+     */\n+    public void setOffset(Object offset) {\n+        sb.append(\" OFFSET ? \");\n+        args.add(offset);\n+    }\n+\n+    /**\n+     * Adds the orderBy statement in the end of WHERE clause\n+     *\n+     * @param orderBy\n+     *            The value that will be used as orderBy\n+     */\n+    public void addOrderBY(Object orderBy) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1896, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}