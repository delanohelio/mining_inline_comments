{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MTE3NjIw", "number": 1207, "title": "FINERACT-1095 Added status parameter in Clients API", "bodyText": "This PR adds a new parameter in client - onlyPending.\nThe reason for adding onlyPending and not isPending is because\nwe are trying to remove the use of\n\"c.status_enum= 100\"\nNow that means the status should be \"only pending\".\nJust to remember how we are fixing this:\n\nThis PR is merged\n@luckyman20 makes changes in community App\nWe wait for confirmation from the community and remove sqlSearch param in the client.\n\nNext up I will take up the loan module.\nAfter which, if the community agrees we will completely remove the sqlSearch param in all APIs.", "createdAt": "2020-07-28T23:57:48Z", "url": "https://github.com/apache/fineract/pull/1207", "merged": true, "mergeCommit": {"oid": "d00d978c46df9dfab02cb804393e29ab40f971e1"}, "closed": true, "closedAt": "2020-08-15T01:58:52Z", "author": {"login": "thesmallstar"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5gcuPABqjM1OTY4Mzk4MzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-_WzngFqTQ2NzkzODg2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03c829286cf6a8890ed502fa41d4fa4ad6b02573", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/03c829286cf6a8890ed502fa41d4fa4ad6b02573", "committedDate": "2020-07-29T01:02:23Z", "message": "Added Integration test for onlyPending parameter"}, "afterCommit": {"oid": "aa0f65d8ba6103d60040f4bd209f1374704c8e6b", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/aa0f65d8ba6103d60040f4bd209f1374704c8e6b", "committedDate": "2020-07-29T01:04:17Z", "message": "Added Integration test for onlyPending parameter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa0f65d8ba6103d60040f4bd209f1374704c8e6b", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/aa0f65d8ba6103d60040f4bd209f1374704c8e6b", "committedDate": "2020-07-29T01:04:17Z", "message": "Added Integration test for onlyPending parameter"}, "afterCommit": {"oid": "c39f21712aecddea4251436d032b322bef6e1b00", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/c39f21712aecddea4251436d032b322bef6e1b00", "committedDate": "2020-07-29T01:56:53Z", "message": "Added Integration test for onlyPending parameter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c39f21712aecddea4251436d032b322bef6e1b00", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/c39f21712aecddea4251436d032b322bef6e1b00", "committedDate": "2020-07-29T01:56:53Z", "message": "Added Integration test for onlyPending parameter"}, "afterCommit": {"oid": "74757288c3db15ee09f36180a4c8aa20a004278c", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/74757288c3db15ee09f36180a4c8aa20a004278c", "committedDate": "2020-07-29T20:26:19Z", "message": "FINERACT-1095 Added status parameter in Clients API"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODk4Mzg0", "url": "https://github.com/apache/fineract/pull/1207#pullrequestreview-458898384", "createdAt": "2020-07-31T03:42:20Z", "commit": {"oid": "74757288c3db15ee09f36180a4c8aa20a004278c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzo0MjoyMVrOG57Chg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzo0MjoyMVrOG57Chg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4OTMxOA==", "bodyText": "If you look at org.apache.fineract.portfolio.client.domain.ClientStatus, there seems to be more values for this enum than shown here. Was there a reason why only this subset is relevant for this?\nAlso for mapping from string to value,  would it make sense to put this into the ClientStatus class and make it reusable? The same way as for example for GLAccountType.fromString() or CalendarFrequencyType.fromString()? That way we would be maintaining the logic in one place only...", "url": "https://github.com/apache/fineract/pull/1207#discussion_r463389318", "createdAt": "2020-07-31T03:42:21Z", "author": {"login": "ptuomola"}, "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/client/service/ClientReadPlatformServiceImpl.java", "diffHunk": "@@ -258,6 +261,19 @@ private String buildSqlStringFromClientCriteria(String schemaSql, final SearchPa\n             extraCriteria += \" and c.display_name like ? \";\n         }\n \n+        if (status != null) {\n+            final String lowerCaseStatus = status.toLowerCase();\n+            Map<String, Integer> statusNumber = new HashMap<String, Integer>();\n+            statusNumber.put(\"active\", 300);\n+            statusNumber.put(\"withdrawn\", 800);\n+            statusNumber.put(\"closed\", 600);\n+            statusNumber.put(\"rejected\", 700);\n+            statusNumber.put(\"pending\", 100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74757288c3db15ee09f36180a4c8aa20a004278c"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTc5NjUz", "url": "https://github.com/apache/fineract/pull/1207#pullrequestreview-459579653", "createdAt": "2020-08-01T13:53:43Z", "commit": {"oid": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NjE2NjYy", "url": "https://github.com/apache/fineract/pull/1207#pullrequestreview-459616662", "createdAt": "2020-08-02T03:13:28Z", "commit": {"oid": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQwMzoxMzoyOFrOG6h1dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQwMzoxOToxMlrOG6h3RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNDk0OA==", "bodyText": "Should we not check that we receive at least some clients? As far as I can see, this test will still pass if the search doesn't actually work and returns nothing...\nIdeally we should check that we receive some of the same clients that we set to status pending above - but at the very least we should check that we've received something...", "url": "https://github.com/apache/fineract/pull/1207#discussion_r464024948", "createdAt": "2020-08-02T03:13:28Z", "author": {"login": "ptuomola"}, "path": "fineract-provider/src/integrationTest/java/org/apache/fineract/integrationtests/ClientTest.java", "diffHunk": "@@ -143,4 +143,36 @@ public void testClientAsEntityStatus() {\n \n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void testPendingOnlyClientRequest() {\n+\n+        Random rand = new Random();\n+        // Add a few clients to the server and activate a random amount of them\n+        for (int i = 0; i < 15; i++) {\n+            final Integer clientId = ClientHelper.createClientAsEntity(this.requestSpec, this.responseSpec);\n+            if (rand.nextInt(10) % 2 == 0) {\n+                // Takes Client to pending status\n+                this.clientHelper.closeClient(clientId);\n+                this.clientHelper.reactivateClient(clientId);\n+            }\n+            // Other clients stay in Active status\n+        }\n+        List<HashMap<String, Object>> clientsRecieved = (List<HashMap<String, Object>>) clientHelper.getClientWithStatus(50, \"pending\");\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNDk4OA==", "bodyText": "Same here as above - shouldn't we check we received at least one active client?", "url": "https://github.com/apache/fineract/pull/1207#discussion_r464024988", "createdAt": "2020-08-02T03:14:01Z", "author": {"login": "ptuomola"}, "path": "fineract-provider/src/integrationTest/java/org/apache/fineract/integrationtests/ClientTest.java", "diffHunk": "@@ -143,4 +143,36 @@ public void testClientAsEntityStatus() {\n \n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void testPendingOnlyClientRequest() {\n+\n+        Random rand = new Random();\n+        // Add a few clients to the server and activate a random amount of them\n+        for (int i = 0; i < 15; i++) {\n+            final Integer clientId = ClientHelper.createClientAsEntity(this.requestSpec, this.responseSpec);\n+            if (rand.nextInt(10) % 2 == 0) {\n+                // Takes Client to pending status\n+                this.clientHelper.closeClient(clientId);\n+                this.clientHelper.reactivateClient(clientId);\n+            }\n+            // Other clients stay in Active status\n+        }\n+        List<HashMap<String, Object>> clientsRecieved = (List<HashMap<String, Object>>) clientHelper.getClientWithStatus(50, \"pending\");\n+\n+        for (int i = 0; i < clientsRecieved.size(); i++) {\n+            HashMap<String, Object> clientStatus = ClientHelper.getClientStatus(requestSpec, responseSpec,\n+                    String.valueOf(clientsRecieved.get(i).get(\"id\")));\n+            ClientStatusChecker.verifyClientPending(clientStatus);\n+        }\n+\n+        clientsRecieved = (List<HashMap<String, Object>>) clientHelper.getClientWithStatus(50, \"active\");\n+\n+        for (int i = 0; i < clientsRecieved.size(); i++) {\n+            HashMap<String, Object> clientStatus = ClientHelper.getClientStatus(requestSpec, responseSpec,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNTIzNQ==", "bodyText": "Hmm... couldn't spot any difference except removal of the formatting (one status per line) - was there something changed here?", "url": "https://github.com/apache/fineract/pull/1207#discussion_r464025235", "createdAt": "2020-08-02T03:15:45Z", "author": {"login": "ptuomola"}, "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/client/domain/ClientStatus.java", "diffHunk": "@@ -18,17 +18,17 @@\n  */\n package org.apache.fineract.portfolio.client.domain;\n \n+import org.springframework.util.StringUtils;\n+\n /**\n  * Enum representation of client status states.\n  */\n public enum ClientStatus {\n \n-    INVALID(0, \"clientStatusType.invalid\"), //\n-    PENDING(100, \"clientStatusType.pending\"), //\n-    ACTIVE(300, \"clientStatusType.active\"), //\n-    TRANSFER_IN_PROGRESS(303, \"clientStatusType.transfer.in.progress\"), //\n-    TRANSFER_ON_HOLD(304, \"clientStatusType.transfer.on.hold\"), //\n-    CLOSED(600, \"clientStatusType.closed\"), REJECTED(700, \"clientStatusType.rejected\"), WITHDRAWN(800, \"clientStatusType.withdraw\");\n+    INVALID(0, \"clientStatusType.invalid\"), PENDING(100, \"clientStatusType.pending\"), ACTIVE(300,\n+            \"clientStatusType.active\"), TRANSFER_IN_PROGRESS(303, \"clientStatusType.transfer.in.progress\"), TRANSFER_ON_HOLD(304,\n+                    \"clientStatusType.transfer.on.hold\"), CLOSED(600, \"clientStatusType.closed\"), REJECTED(700,\n+                            \"clientStatusType.rejected\"), WITHDRAWN(800, \"clientStatusType.withdraw\");\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNTMxNg==", "bodyText": "Hmmm... how does this actually work now? Here we are comparing to the strings as defined in the enum (e.g. clientStatusType.active) but the test is passing in just \"active\". So it should not match / return anything. What did I miss here?", "url": "https://github.com/apache/fineract/pull/1207#discussion_r464025316", "createdAt": "2020-08-02T03:17:19Z", "author": {"login": "ptuomola"}, "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/client/domain/ClientStatus.java", "diffHunk": "@@ -63,6 +63,33 @@ public static ClientStatus fromInt(final Integer statusValue) {\n         return enumeration;\n     }\n \n+    public static ClientStatus fromString(final String clientString) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNTQxMw==", "bodyText": "So this would mean you can't search for clients with status = INVALID. Is this correct behaviour - shouldn't we still allow searching even if the value you pass in is INVALID? I.e. to find any INVALID entries (if any)...\nAt the same time it would be good to validate the provided input string to ensure it has actually mapped to a valid value, and throw PlatformValidationException if it doesn't.\nSo you should be able to search for any invalid entries by sending in clientStatusType.invalid - but if you send in clientStatusType.blah then you should get a validation exception.", "url": "https://github.com/apache/fineract/pull/1207#discussion_r464025413", "createdAt": "2020-08-02T03:19:12Z", "author": {"login": "ptuomola"}, "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/client/service/ClientReadPlatformServiceImpl.java", "diffHunk": "@@ -258,6 +259,13 @@ private String buildSqlStringFromClientCriteria(String schemaSql, final SearchPa\n             extraCriteria += \" and c.display_name like ? \";\n         }\n \n+        if (status != null) {\n+            ClientStatus clientStatus = ClientStatus.fromString(status);\n+            if (clientStatus.getValue() != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2dc58ce4c883b463735fef8ec48bfe4a0248dfd3", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/2dc58ce4c883b463735fef8ec48bfe4a0248dfd3", "committedDate": "2020-07-31T22:39:37Z", "message": "Added fromString function to ClientStatus"}, "afterCommit": {"oid": "e5aa70a14555ec1cf96a038a9408fe535a627fed", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/e5aa70a14555ec1cf96a038a9408fe535a627fed", "committedDate": "2020-08-05T11:25:37Z", "message": "FINERACT-1095 Added status parameter in Clients API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e5aa70a14555ec1cf96a038a9408fe535a627fed", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/e5aa70a14555ec1cf96a038a9408fe535a627fed", "committedDate": "2020-08-05T11:25:37Z", "message": "FINERACT-1095 Added status parameter in Clients API"}, "afterCommit": {"oid": "4735e32f454b189276aa48dd910f38682b12a78c", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/4735e32f454b189276aa48dd910f38682b12a78c", "committedDate": "2020-08-05T11:28:23Z", "message": "FINERACT-1095 Added status parameter in Clients API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4735e32f454b189276aa48dd910f38682b12a78c", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/4735e32f454b189276aa48dd910f38682b12a78c", "committedDate": "2020-08-05T11:28:23Z", "message": "FINERACT-1095 Added status parameter in Clients API"}, "afterCommit": {"oid": "b7ebed0b0e5bcd3d09d542a9663087611274b618", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/b7ebed0b0e5bcd3d09d542a9663087611274b618", "committedDate": "2020-08-05T19:14:07Z", "message": "FINERACT-1095 Added status parameter in Clients API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8906d5802eef120dec4ea63339c80be45a891973", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/8906d5802eef120dec4ea63339c80be45a891973", "committedDate": "2020-08-14T20:28:28Z", "message": "FINERACT-1095 Added status parameter in Clients API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd35edf145a70686955bbbfedf1ce0e2f79a5b05", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/bd35edf145a70686955bbbfedf1ce0e2f79a5b05", "committedDate": "2020-08-14T20:28:28Z", "message": "Removed duplicate status values to check status parameter validity"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b7ebed0b0e5bcd3d09d542a9663087611274b618", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/b7ebed0b0e5bcd3d09d542a9663087611274b618", "committedDate": "2020-08-05T19:14:07Z", "message": "FINERACT-1095 Added status parameter in Clients API"}, "afterCommit": {"oid": "bd35edf145a70686955bbbfedf1ce0e2f79a5b05", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/bd35edf145a70686955bbbfedf1ce0e2f79a5b05", "committedDate": "2020-08-14T20:28:28Z", "message": "Removed duplicate status values to check status parameter validity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3OTM4ODYx", "url": "https://github.com/apache/fineract/pull/1207#pullrequestreview-467938861", "createdAt": "2020-08-15T01:58:20Z", "commit": {"oid": "bd35edf145a70686955bbbfedf1ce0e2f79a5b05"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1775, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}