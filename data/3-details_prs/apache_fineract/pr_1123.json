{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMzAzOTEx", "number": 1123, "title": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatform", "bodyText": "Refer: https://issues.apache.org/jira/browse/FINERACT-854 and #725 #723 for background.\nThe work for this part is completed, but SQLbuilder currently does not support the use of \"limit\" and \"order by\" query which I will be adding before this can be merged.", "createdAt": "2020-06-29T09:44:56Z", "url": "https://github.com/apache/fineract/pull/1123", "merged": true, "mergeCommit": {"oid": "b22d4b64ba327cc4a5452d4df8273c2c2a1a25c4"}, "closed": true, "closedAt": "2020-08-26T10:44:29Z", "author": {"login": "thesmallstar"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv97PHAFqTQzOTAyMDg3NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCpeW4gFqTQ3NTM2Nzg3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MDIwODc0", "url": "https://github.com/apache/fineract/pull/1123#pullrequestreview-439020874", "createdAt": "2020-06-29T09:49:25Z", "commit": {"oid": "322a93b33d30d551b58975f04d156b3e747d5811"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwOTo0OToyNVrOGqLhTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwOTo0OToyNVrOGqLhTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4MjEyNw==", "bodyText": "Also removing this part is not correct as of NOW, the problem is we are talking SQL query as a query to give users more functionality and certainly that is not supported in SQL builder currently, we probably would need to parse things find relevant queries and then add those to extra criteria still thinking on it.\nWill be looked after limit and order by are supported.", "url": "https://github.com/apache/fineract/pull/1123#discussion_r446882127", "createdAt": "2020-06-29T09:49:25Z", "author": {"login": "thesmallstar"}, "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/group/service/CenterReadPlatformServiceImpl.java", "diffHunk": "@@ -122,55 +122,26 @@ public CenterReadPlatformServiceImpl(final PlatformSecurityContext context, fina\n     // 'g.' preffix because of ERROR 1052 (23000): Column 'column_name' in where\n     // clause is ambiguous\n     // caused by the same name of columns in m_office and m_group tables\n-    private String getCenterExtraCriteria(String schemaSl, List<Object> paramList, final SearchParameters searchCriteria) {\n+    private SQLBuilder getCenterExtraCriteria(String schemaSl, final SearchParameters searchCriteria) {\n \n-        StringBuilder extraCriteria = new StringBuilder(200);\n-        extraCriteria.append(\" and g.level_id = \" + GroupTypes.CENTER.getId());\n+        SQLBuilder extraCriteria = new SQLBuilder();\n+        extraCriteria.addCriteria(\"g.level_id =\", GroupTypes.CENTER.getId());\n         if (searchCriteria != null) {\n             String sqlQueryCriteria = searchCriteria.getSqlSearch();\n             if (StringUtils.isNotBlank(sqlQueryCriteria)) {\n                 SQLInjectionValidator.validateSQLInput(sqlQueryCriteria);\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\" display_name \", \" g.display_name \");\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\"display_name \", \"g.display_name \");\n-                extraCriteria.append(\" and (\").append(sqlQueryCriteria).append(\") \");\n-                this.columnValidator.validateSqlInjection(schemaSl, sqlQueryCriteria);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "322a93b33d30d551b58975f04d156b3e747d5811"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e43abcd5360c41aed64a4df61ea9fe29ab1d462", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/2e43abcd5360c41aed64a4df61ea9fe29ab1d462", "committedDate": "2020-07-01T13:23:01Z", "message": "Fineract-1058 added support for limit,offset and orderBy in SQLbuilder"}, "afterCommit": {"oid": "19d91377ece68dd85c41f0883d24ae9857f557c6", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/19d91377ece68dd85c41f0883d24ae9857f557c6", "committedDate": "2020-07-01T13:26:30Z", "message": "Fineract-1058 added support for limit,offset and orderBy in SQLbuilder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19d91377ece68dd85c41f0883d24ae9857f557c6", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/19d91377ece68dd85c41f0883d24ae9857f557c6", "committedDate": "2020-07-01T13:26:30Z", "message": "Fineract-1058 added support for limit,offset and orderBy in SQLbuilder"}, "afterCommit": {"oid": "4ab4d9de1a31217a4148ba37fad2dfaed339499c", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/4ab4d9de1a31217a4148ba37fad2dfaed339499c", "committedDate": "2020-07-01T16:52:32Z", "message": "Fineract-1058 added support for limit,offset and orderBy in SQLbuilder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ab4d9de1a31217a4148ba37fad2dfaed339499c", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/4ab4d9de1a31217a4148ba37fad2dfaed339499c", "committedDate": "2020-07-01T16:52:32Z", "message": "Fineract-1058 added support for limit,offset and orderBy in SQLbuilder"}, "afterCommit": {"oid": "e6a24b5aa7087b98b0a23c9e7756039b2d3e8914", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/e6a24b5aa7087b98b0a23c9e7756039b2d3e8914", "committedDate": "2020-07-02T18:42:19Z", "message": "Fineract-1058 added support for limit,offset and orderBy in SQLbuilder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNDU1Mzcy", "url": "https://github.com/apache/fineract/pull/1123#pullrequestreview-442455372", "createdAt": "2020-07-03T14:41:07Z", "commit": {"oid": "e6a24b5aa7087b98b0a23c9e7756039b2d3e8914"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNDU1NzM0", "url": "https://github.com/apache/fineract/pull/1123#pullrequestreview-442455734", "createdAt": "2020-07-03T14:41:44Z", "commit": {"oid": "e6a24b5aa7087b98b0a23c9e7756039b2d3e8914"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNDo0MTo0NFrOGsyZNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNDo0MTo0NFrOGsyZNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYxNjE4MQ==", "bodyText": "lower-case y:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void addOrderBY(Object orderBy) {\n          \n          \n            \n                public void addOrderBy(Object orderBy) {", "url": "https://github.com/apache/fineract/pull/1123#discussion_r449616181", "createdAt": "2020-07-03T14:41:44Z", "author": {"login": "vorburger"}, "path": "fineract-provider/src/main/java/org/apache/fineract/infrastructure/security/utils/SQLBuilder.java", "diffHunk": "@@ -110,6 +111,39 @@ public void addNonNullCriteria(String criteria, Object argument) {\n         }\n     }\n \n+    /**\n+     * Adds the limit statement in the end of WHERE clause\n+     *\n+     * @param limit\n+     *            The value that will be used as limit\n+     */\n+    public void setLimit(Object limit) {\n+        sb.append(\" LIMIT ? \");\n+        args.add(limit);\n+    }\n+\n+    /**\n+     * Adds the offset statement in the end of WHERE clause\n+     *\n+     * @param offset\n+     *            The value that will be used as offset\n+     */\n+    public void setOffset(Object offset) {\n+        sb.append(\" OFFSET ? \");\n+        args.add(offset);\n+    }\n+\n+    /**\n+     * Adds the orderBy statement in the end of WHERE clause\n+     *\n+     * @param orderBy\n+     *            The value that will be used as orderBy\n+     */\n+    public void addOrderBY(Object orderBy) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6a24b5aa7087b98b0a23c9e7756039b2d3e8914"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6a24b5aa7087b98b0a23c9e7756039b2d3e8914", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/e6a24b5aa7087b98b0a23c9e7756039b2d3e8914", "committedDate": "2020-07-02T18:42:19Z", "message": "Fineract-1058 added support for limit,offset and orderBy in SQLbuilder"}, "afterCommit": {"oid": "9249e25e0d22a13034a484ac1719d2a00cd0da45", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/9249e25e0d22a13034a484ac1719d2a00cd0da45", "committedDate": "2020-07-04T12:55:10Z", "message": "Fineract-1058 added support for limit,offset and orderBy in SQLbuilder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9249e25e0d22a13034a484ac1719d2a00cd0da45", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/9249e25e0d22a13034a484ac1719d2a00cd0da45", "committedDate": "2020-07-04T12:55:10Z", "message": "Fineract-1058 added support for limit,offset and orderBy in SQLbuilder"}, "afterCommit": {"oid": "7a89391f95311084ca8f93e0c589865c54137890", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/7a89391f95311084ca8f93e0c589865c54137890", "committedDate": "2020-07-04T22:30:30Z", "message": "Fineract-1058 added support for limit,offset and orderBy in SQLbuilder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a89391f95311084ca8f93e0c589865c54137890", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/7a89391f95311084ca8f93e0c589865c54137890", "committedDate": "2020-07-04T22:30:30Z", "message": "Fineract-1058 added support for limit,offset and orderBy in SQLbuilder"}, "afterCommit": {"oid": "f70ae3b76cf633a47a6a244b3e7d6d979eb85652", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/f70ae3b76cf633a47a6a244b3e7d6d979eb85652", "committedDate": "2020-07-05T22:07:08Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatformService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f70ae3b76cf633a47a6a244b3e7d6d979eb85652", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/f70ae3b76cf633a47a6a244b3e7d6d979eb85652", "committedDate": "2020-07-05T22:07:08Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatformService"}, "afterCommit": {"oid": "adc0701d1ec4781fe712c3bcf101406e90f89dd9", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/adc0701d1ec4781fe712c3bcf101406e90f89dd9", "committedDate": "2020-07-05T22:15:30Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatformService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adc0701d1ec4781fe712c3bcf101406e90f89dd9", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/adc0701d1ec4781fe712c3bcf101406e90f89dd9", "committedDate": "2020-07-05T22:15:30Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatformService"}, "afterCommit": {"oid": "008dfe710f5a2e830124916ae6435dec753a7680", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/008dfe710f5a2e830124916ae6435dec753a7680", "committedDate": "2020-07-12T20:39:55Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatform"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzA5MzY0", "url": "https://github.com/apache/fineract/pull/1123#pullrequestreview-453709364", "createdAt": "2020-07-22T21:47:34Z", "commit": {"oid": "008dfe710f5a2e830124916ae6435dec753a7680"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMTo0NzozNFrOG11bLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMTo0NzozNFrOG11bLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwMzAyMw==", "bodyText": "@thesmallstar sorry for the huge delay in getting back to you on this one. I've re-read it again now (took me a minute to get back into it). Are you suggesting that we merge this now? Because, unless I misunderstand, this would break the currently existing functionality for these sqlQueryCriteria, agreed? But they really are a problem, huh? I need to dig more into the code to understand where this is coming from..", "url": "https://github.com/apache/fineract/pull/1123#discussion_r459103023", "createdAt": "2020-07-22T21:47:34Z", "author": {"login": "vorburger"}, "path": "fineract-provider/src/main/java/org/apache/fineract/portfolio/group/service/CenterReadPlatformServiceImpl.java", "diffHunk": "@@ -122,55 +122,26 @@ public CenterReadPlatformServiceImpl(final PlatformSecurityContext context, fina\n     // 'g.' preffix because of ERROR 1052 (23000): Column 'column_name' in where\n     // clause is ambiguous\n     // caused by the same name of columns in m_office and m_group tables\n-    private String getCenterExtraCriteria(String schemaSl, List<Object> paramList, final SearchParameters searchCriteria) {\n+    private SQLBuilder getCenterExtraCriteria(String schemaSl, final SearchParameters searchCriteria) {\n \n-        StringBuilder extraCriteria = new StringBuilder(200);\n-        extraCriteria.append(\" and g.level_id = \" + GroupTypes.CENTER.getId());\n+        SQLBuilder extraCriteria = new SQLBuilder();\n+        extraCriteria.addCriteria(\"g.level_id =\", GroupTypes.CENTER.getId());\n         if (searchCriteria != null) {\n             String sqlQueryCriteria = searchCriteria.getSqlSearch();\n             if (StringUtils.isNotBlank(sqlQueryCriteria)) {\n                 SQLInjectionValidator.validateSQLInput(sqlQueryCriteria);\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\" display_name \", \" g.display_name \");\n                 sqlQueryCriteria = sqlQueryCriteria.replace(\"display_name \", \"g.display_name \");\n-                extraCriteria.append(\" and (\").append(sqlQueryCriteria).append(\") \");\n-                this.columnValidator.validateSqlInjection(schemaSl, sqlQueryCriteria);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4MjEyNw=="}, "originalCommit": {"oid": "322a93b33d30d551b58975f04d156b3e747d5811"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "008dfe710f5a2e830124916ae6435dec753a7680", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/008dfe710f5a2e830124916ae6435dec753a7680", "committedDate": "2020-07-12T20:39:55Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatform"}, "afterCommit": {"oid": "e9249ad048d5f05afec8a247c2332bdda939e8a3", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/e9249ad048d5f05afec8a247c2332bdda939e8a3", "committedDate": "2020-08-25T21:12:26Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatform"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9249ad048d5f05afec8a247c2332bdda939e8a3", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/e9249ad048d5f05afec8a247c2332bdda939e8a3", "committedDate": "2020-08-25T21:12:26Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatform"}, "afterCommit": {"oid": "67d412693c5065a47b857969c956a3c6a53e2564", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/67d412693c5065a47b857969c956a3c6a53e2564", "committedDate": "2020-08-25T21:34:01Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01a71fb4871cacc6635f82e87a32c108e1b3fec7", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/01a71fb4871cacc6635f82e87a32c108e1b3fec7", "committedDate": "2020-08-26T09:35:54Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatform"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67d412693c5065a47b857969c956a3c6a53e2564", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/67d412693c5065a47b857969c956a3c6a53e2564", "committedDate": "2020-08-25T21:34:01Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatform"}, "afterCommit": {"oid": "01a71fb4871cacc6635f82e87a32c108e1b3fec7", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/01a71fb4871cacc6635f82e87a32c108e1b3fec7", "committedDate": "2020-08-26T09:35:54Z", "message": "FINERACT-854 Removed string concatenated SQL from CenterReadPlatform"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MzY3ODc3", "url": "https://github.com/apache/fineract/pull/1123#pullrequestreview-475367877", "createdAt": "2020-08-26T10:44:21Z", "commit": {"oid": "01a71fb4871cacc6635f82e87a32c108e1b3fec7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1833, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}