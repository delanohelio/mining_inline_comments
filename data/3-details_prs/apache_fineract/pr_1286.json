{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczODE1NjM2", "number": 1286, "title": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)", "bodyText": "Removed string concatenated SQL and use of SQLseach parameter from Staff,\nI have looked closely in what I am changing but a detailed review would help since we probably don't have good tests coverage on fineract yet.\n@awasum  how do you think this as the project idea for outreachy this winter? WE NEED MORE TESTS!!", "createdAt": "2020-08-26T10:37:46Z", "url": "https://github.com/apache/fineract/pull/1286", "merged": true, "mergeCommit": {"oid": "e74204e7403ebb575a9674af50a0e4150b985e65"}, "closed": true, "closedAt": "2020-09-06T00:50:26Z", "author": {"login": "thesmallstar"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdC27n-gFqTQ3NjMzOTg4Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGDkMpAFqTQ4MzEwMjg0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2MzM5ODg2", "url": "https://github.com/apache/fineract/pull/1286#pullrequestreview-476339886", "createdAt": "2020-08-27T02:19:00Z", "commit": {"oid": "3c1f5722e21ec0807da5fa7cd15ed006a5361204"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwMjoxOTowMVrOHHzJ4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwMjoyNDo0M1rOHHzoRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk0MDE5NQ==", "bodyText": "Are we sure that no client is calling this - i.e. will this change make an impact to one of the UIs?", "url": "https://github.com/apache/fineract/pull/1286#discussion_r477940195", "createdAt": "2020-08-27T02:19:01Z", "author": {"login": "ptuomola"}, "path": "fineract-provider/src/main/java/org/apache/fineract/organisation/staff/api/StaffApiResource.java", "diffHunk": "@@ -118,7 +118,6 @@ public StaffApiResource(final PlatformSecurityContext context, final StaffReadPl\n             @ApiResponse(responseCode = \"200\", description = \"OK\", content = @Content(array = @ArraySchema(schema = @Schema(implementation = StaffApiResourceSwagger.GetStaffResponse.class)))),\n             @ApiResponse(responseCode = \"200\", description = \"GET https://DomainName/api/v1/staff?status={ACTIVE|INACTIVE|ALL}\", content = @Content(schema = @Schema(implementation = StaffApiResourceSwagger.GetStaffResponse.class))) })\n     public String retrieveStaff(@Context final UriInfo uriInfo,\n-            @QueryParam(\"sqlSearch\") @Parameter(description = \"sqlSearch\") final String sqlSearch,\n             @QueryParam(\"officeId\") @Parameter(description = \"officeId\") final Long officeId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c1f5722e21ec0807da5fa7cd15ed006a5361204"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk0NDY2NQ==", "bodyText": "Would we not want to do this \"magic\" of adding the condition for hierarchy and then executing the JDBC template only in one place? I.e. would it not be better to keep this code still in retrieveAllStaff and just call retrieveAllStaff with the right SQLBuilder from here? Or is there a reason why we want to duplicate the code here?", "url": "https://github.com/apache/fineract/pull/1286#discussion_r477944665", "createdAt": "2020-08-27T02:22:14Z", "author": {"login": "ptuomola"}, "path": "fineract-provider/src/main/java/org/apache/fineract/organisation/staff/service/StaffReadPlatformServiceImpl.java", "diffHunk": "@@ -159,7 +159,18 @@ public StaffData mapRow(final ResultSet rs, @SuppressWarnings(\"unused\") final in\n \n     @Override\n     public Collection<StaffData> retrieveAllLoanOfficersInOfficeById(final Long officeId) {\n-        return retrieveAllStaff(\" office_id = ? and is_loan_officer=1 and o.hierarchy like ?\", officeId);\n+        final StaffMapper rm = new StaffMapper();\n+        String sql = \"select \" + rm.schema();\n+        SQLBuilder extraCriteria = new SQLBuilder();\n+        extraCriteria.addCriteria(\" office_id = \", officeId);\n+        extraCriteria.addCriteria(\" is_loan_officer= = \", 1);\n+        final String hierarchy = this.context.authenticatedUser().getOffice().getHierarchy() + \"%\";\n+        extraCriteria.addCriteria(\" o.hierarchy like \", hierarchy);\n+\n+        sql += \" \" + extraCriteria.getSQLTemplate();\n+        sql = sql + \" order by s.lastname \";\n+\n+        return this.jdbcTemplate.query(sql, rm, extraCriteria.getArguments());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c1f5722e21ec0807da5fa7cd15ed006a5361204"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk0Nzk3Mw==", "bodyText": "I think it would have actually been good to leave looking up hierarchy and adding the condition for it here. That way, regardless of how you call retrieveAllStaff, you can't retrieve things you are not allowed to see. Otherwise we are relying on the caller to add the condition for hierarchy - which they may forget...", "url": "https://github.com/apache/fineract/pull/1286#discussion_r477947973", "createdAt": "2020-08-27T02:24:43Z", "author": {"login": "ptuomola"}, "path": "fineract-provider/src/main/java/org/apache/fineract/organisation/staff/service/StaffReadPlatformServiceImpl.java", "diffHunk": "@@ -204,49 +215,38 @@ public StaffData retrieveStaff(final Long staffId) {\n     }\n \n     @Override\n-    public Collection<StaffData> retrieveAllStaff(final String sqlSearch, final Long officeId, final boolean loanOfficersOnly,\n-            final String status) {\n-        final String extraCriteria = getStaffCriteria(sqlSearch, officeId, loanOfficersOnly, status);\n-        return retrieveAllStaff(extraCriteria, officeId);\n+    public Collection<StaffData> retrieveAllStaff(final Long officeId, final boolean loanOfficersOnly, final String status) {\n+        final SQLBuilder extraCriteria = getStaffCriteria(officeId, loanOfficersOnly, status);\n+        return retrieveAllStaff(extraCriteria);\n     }\n \n-    private Collection<StaffData> retrieveAllStaff(final String extraCriteria, Long officeId) {\n+    private Collection<StaffData> retrieveAllStaff(final SQLBuilder extraCriteria) {\n \n         final StaffMapper rm = new StaffMapper();\n         String sql = \"select \" + rm.schema();\n-        final String hierarchy = this.context.authenticatedUser().getOffice().getHierarchy() + \"%\";\n-        if (StringUtils.isNotBlank(extraCriteria)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c1f5722e21ec0807da5fa7cd15ed006a5361204"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c1f5722e21ec0807da5fa7cd15ed006a5361204", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/3c1f5722e21ec0807da5fa7cd15ed006a5361204", "committedDate": "2020-08-26T10:34:28Z", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)"}, "afterCommit": {"oid": "baed1f0b39a1061d1486599e462ace79e229acd1", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/baed1f0b39a1061d1486599e462ace79e229acd1", "committedDate": "2020-08-30T13:14:54Z", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "baed1f0b39a1061d1486599e462ace79e229acd1", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/baed1f0b39a1061d1486599e462ace79e229acd1", "committedDate": "2020-08-30T13:14:54Z", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)"}, "afterCommit": {"oid": "a88f2f91ede770803a934ee49aeac1f8fcc7eee5", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/a88f2f91ede770803a934ee49aeac1f8fcc7eee5", "committedDate": "2020-08-30T13:24:19Z", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a88f2f91ede770803a934ee49aeac1f8fcc7eee5", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/a88f2f91ede770803a934ee49aeac1f8fcc7eee5", "committedDate": "2020-08-30T13:24:19Z", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)"}, "afterCommit": {"oid": "4570eb6c88620f218369db4c775ea0dabc30b69d", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/4570eb6c88620f218369db4c775ea0dabc30b69d", "committedDate": "2020-08-30T14:50:27Z", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjcwODM3", "url": "https://github.com/apache/fineract/pull/1286#pullrequestreview-478270837", "createdAt": "2020-08-31T02:20:44Z", "commit": {"oid": "4570eb6c88620f218369db4c775ea0dabc30b69d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwMjoyMDo0NFrOHJoEZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwMjoyMDo0NFrOHJoEZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg1NTcxNg==", "bodyText": "I think this comment is now in the wrong place and should be moved to retrieveAllStaff(), right?", "url": "https://github.com/apache/fineract/pull/1286#discussion_r479855716", "createdAt": "2020-08-31T02:20:44Z", "author": {"login": "ptuomola"}, "path": "fineract-provider/src/main/java/org/apache/fineract/organisation/staff/service/StaffReadPlatformServiceImpl.java", "diffHunk": "@@ -257,14 +252,7 @@ private String getStaffCriteria(final String sqlSearch, final Long officeId, fin\n         // employee who does not belong to his office or a sub office for his\n         // office.\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4570eb6c88620f218369db4c775ea0dabc30b69d"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "813d8c693361a8af0cc5ebe214975ee89be7b3a0", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/813d8c693361a8af0cc5ebe214975ee89be7b3a0", "committedDate": "2020-09-05T19:42:53Z", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4570eb6c88620f218369db4c775ea0dabc30b69d", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/4570eb6c88620f218369db4c775ea0dabc30b69d", "committedDate": "2020-08-30T14:50:27Z", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)"}, "afterCommit": {"oid": "813d8c693361a8af0cc5ebe214975ee89be7b3a0", "author": {"user": {"login": "thesmallstar", "name": "Manthan Surkar"}}, "url": "https://github.com/apache/fineract/commit/813d8c693361a8af0cc5ebe214975ee89be7b3a0", "committedDate": "2020-09-05T19:42:53Z", "message": "Removed string concatenated SQL & sqlSearch from Staff (Fineract-854)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMTAyODQ1", "url": "https://github.com/apache/fineract/pull/1286#pullrequestreview-483102845", "createdAt": "2020-09-06T00:50:02Z", "commit": {"oid": "813d8c693361a8af0cc5ebe214975ee89be7b3a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1723, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}