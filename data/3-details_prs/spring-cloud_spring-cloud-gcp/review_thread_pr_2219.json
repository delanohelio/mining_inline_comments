{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNTQ1Mjcw", "number": 2219, "reviewThreads": {"totalCount": 38, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNDo1NToxOFrODjfQhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo1OTozMFrODo1Ehw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTM4ODg1OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/SpannerPersistentProperty.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNDo1NToxOFrOFvUs3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNDo1NToxOFrOFvUs3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE2NjU1Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Return Where cause of the property. Could be null.\n          \n          \n            \n            \t * Return {@code WHERE} clause of the property. Could be {@code null}.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385166556", "createdAt": "2020-02-27T14:55:18Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/SpannerPersistentProperty.java", "diffHunk": "@@ -120,4 +121,10 @@\n \t */\n \tboolean isEagerInterleaved();\n \n+\t/**\n+\t * Return Where cause of the property. Could be null.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11176bb9825cb72ea28f4b4968fdb2a3c97a8b1"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTM4OTExOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/SpannerPersistentProperty.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNDo1NToyMlrOFvUtDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNDo1NToyMlrOFvUtDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE2NjYwNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @return an optional {@code Where} cause of the property.\n          \n          \n            \n            \t * @return an optional {@code WHERE} cause of the property.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385166604", "createdAt": "2020-02-27T14:55:22Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/SpannerPersistentProperty.java", "diffHunk": "@@ -120,4 +121,10 @@\n \t */\n \tboolean isEagerInterleaved();\n \n+\t/**\n+\t * Return Where cause of the property. Could be null.\n+\t * @return an optional {@code Where} cause of the property.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11176bb9825cb72ea28f4b4968fdb2a3c97a8b1"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTM5NDUwOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/Where.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNDo1NjozOVrOFvUwtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjoyMzo0MFrOFvX4BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE2NzU0Mw==", "bodyText": "\"overwrites the class annotation\"?\nWhat does that mean?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385167543", "createdAt": "2020-02-27T14:56:39Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/Where.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.data.spanner.core.mapping;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.Target;\n+\n+import static java.lang.annotation.ElementType.FIELD;\n+import static java.lang.annotation.ElementType.TYPE;\n+import static java.lang.annotation.RetentionPolicy.RUNTIME;\n+\n+/**\n+ * Where clause to add to the element Entity or target entity of a collection.\n+ * The clause is written in SQL. A common use case here is for soft-deletes.\n+ * It can be used on class level or on interleaved list as well.\n+ * It overwrites the class annotation when used on an interleaved list of the same type.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11176bb9825cb72ea28f4b4968fdb2a3c97a8b1"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE4OTY5MA==", "bodyText": "It means that English is not my native, sorry for that.\nI wanted to say that IF the annotation is used on an interleaved list column on some \"parent\" entity it will overwrite the same annotation on the child entity class.\nFor instance - a \"child\" class is annotated like\n@Table(name = \"CHILDREN\")\n@Where(\"deleted=false\")\npublic class Child  {\n   ...\n}\nBut we can create some \"patent\" with a column like\n    @Column\n    @Where(\"deleted=true\")\n    private List<Child> children;\nIn such case the @Where(\"deleted=true\") will be used when we fetch interlived list of the \"parent\" entity.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385189690", "createdAt": "2020-02-27T15:33:53Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/Where.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.data.spanner.core.mapping;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.Target;\n+\n+import static java.lang.annotation.ElementType.FIELD;\n+import static java.lang.annotation.ElementType.TYPE;\n+import static java.lang.annotation.RetentionPolicy.RUNTIME;\n+\n+/**\n+ * Where clause to add to the element Entity or target entity of a collection.\n+ * The clause is written in SQL. A common use case here is for soft-deletes.\n+ * It can be used on class level or on interleaved list as well.\n+ * It overwrites the class annotation when used on an interleaved list of the same type.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE2NzU0Mw=="}, "originalCommit": {"oid": "e11176bb9825cb72ea28f4b4968fdb2a3c97a8b1"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIxODU2NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * It overwrites the class annotation when used on an interleaved list of the same type.\n          \n          \n            \n             * It overwrites the class-level `@Where` annotation when used on an interleaved list property of the same type.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385218565", "createdAt": "2020-02-27T16:23:40Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/Where.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.data.spanner.core.mapping;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.Target;\n+\n+import static java.lang.annotation.ElementType.FIELD;\n+import static java.lang.annotation.ElementType.TYPE;\n+import static java.lang.annotation.RetentionPolicy.RUNTIME;\n+\n+/**\n+ * Where clause to add to the element Entity or target entity of a collection.\n+ * The clause is written in SQL. A common use case here is for soft-deletes.\n+ * It can be used on class level or on interleaved list as well.\n+ * It overwrites the class annotation when used on an interleaved list of the same type.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE2NzU0Mw=="}, "originalCommit": {"oid": "e11176bb9825cb72ea28f4b4968fdb2a3c97a8b1"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTQwMjM1OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNDo1ODo0OVrOFvU12g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNTozNToyNVrOFvWLaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE2ODg1OA==", "bodyText": "You are repeating these two lines in several places. Please create a private utility method to reduce duplication.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385168858", "createdAt": "2020-02-27T14:58:49Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -162,6 +165,11 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\t\t\t\t.getPersistentProperty(o.getProperty());\n \t\t\t\t\treturn (property != null) ? property.getColumnName() : o.getProperty();\n \t\t\t\t});\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11176bb9825cb72ea28f4b4968fdb2a3c97a8b1"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE5MDc2Mw==", "bodyText": "ok, will check, thanks", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385190763", "createdAt": "2020-02-27T15:35:25Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -162,6 +165,11 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\t\t\t\t.getPersistentProperty(o.getProperty());\n \t\t\t\t\treturn (property != null) ? property.getColumnName() : o.getProperty();\n \t\t\t\t});\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE2ODg1OA=="}, "originalCommit": {"oid": "e11176bb9825cb72ea28f4b4968fdb2a3c97a8b1"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTgyOTMyOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjo0ODozMlrOFvY34Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOTowNDoxNVrOFvdgsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzNDkxMw==", "bodyText": "Rename to combine to avoid confusion with sql JOIN", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385234913", "createdAt": "2020-02-27T16:48:32Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,27 +227,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\tor.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))\n+\t\t\t\t.map(Where::value).orElse(\"\");\n+\t\tString condition = join(or.size() == 0 ? \"\" : or.size() == 1 ? or.get(0)\n+\t\t\t\t: or.stream().collect(Collectors.joining(\") OR (\", \"(\", \")\")), whereCause);\n \t\tString sb = \"SELECT \" + getColumnsStringForSelect(persistentEntity, mappingContext, true) + \" FROM \"\n-\t\t\t\t+ persistentEntity.tableName() + (cond.isEmpty() ? \"\" : \" WHERE \" + cond);\n+\t\t\t\t+ persistentEntity.tableName() + (condition.isEmpty() ? \"\" : \" WHERE \" + condition);\n \t\treturn buildStatementFromSqlWithArgs(sb, tags, null, writeConverter,\n \t\t\t\tkeyParts.toArray(), null);\n \t}\n \n+\tprivate static String join(String cond1, String cond2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxMDg5Nw==", "bodyText": "ok", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385310897", "createdAt": "2020-02-27T19:04:15Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,27 +227,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\tor.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))\n+\t\t\t\t.map(Where::value).orElse(\"\");\n+\t\tString condition = join(or.size() == 0 ? \"\" : or.size() == 1 ? or.get(0)\n+\t\t\t\t: or.stream().collect(Collectors.joining(\") OR (\", \"(\", \")\")), whereCause);\n \t\tString sb = \"SELECT \" + getColumnsStringForSelect(persistentEntity, mappingContext, true) + \" FROM \"\n-\t\t\t\t+ persistentEntity.tableName() + (cond.isEmpty() ? \"\" : \" WHERE \" + cond);\n+\t\t\t\t+ persistentEntity.tableName() + (condition.isEmpty() ? \"\" : \" WHERE \" + condition);\n \t\treturn buildStatementFromSqlWithArgs(sb, tags, null, writeConverter,\n \t\t\t\tkeyParts.toArray(), null);\n \t}\n \n+\tprivate static String join(String cond1, String cond2) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzNDkxMw=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTg0NzAxOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjo1MjozOFrOFvZC7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMDo1OToxNFrOFvg_TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzNzc0MQ==", "bodyText": "you don't need or.size() == 0 ? \"\" : or.size() == 1 ? or.get(0)\nyou should be able to do something like or.stream().map(s -> \"(\"+s\")\").collect(Collectors.joining(\" OR \"))", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385237741", "createdAt": "2020-02-27T16:52:38Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,27 +227,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\tor.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))\n+\t\t\t\t.map(Where::value).orElse(\"\");\n+\t\tString condition = join(or.size() == 0 ? \"\" : or.size() == 1 ? or.get(0)\n+\t\t\t\t: or.stream().collect(Collectors.joining(\") OR (\", \"(\", \")\")), whereCause);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNDkyMQ==", "bodyText": "I did it as a first attempt. The stream always returns some value and when we have only one element it became wrapped by bracket - it looks dummy. We need a custom \"Joiner\" to prevent extra brackets when the stream has a single entry.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385314921", "createdAt": "2020-02-27T19:11:44Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,27 +227,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\tor.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))\n+\t\t\t\t.map(Where::value).orElse(\"\");\n+\t\tString condition = join(or.size() == 0 ? \"\" : or.size() == 1 ? or.get(0)\n+\t\t\t\t: or.stream().collect(Collectors.joining(\") OR (\", \"(\", \")\")), whereCause);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzNzc0MQ=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2NDY1Mw==", "bodyText": "That's ok if the only element it's wrapped in parentheses. I'm ok with that if that's the price to pay for more readable code :)\n  static String orJoin(List<String> parts){\n    return parts.stream().map(s -> \"(\"+s+\")\").collect(Collectors.joining(\" OR \"));\n  }\n.....\n  System.out.println(orJoin(Arrays.asList()));\n  System.out.println(orJoin(Arrays.asList(\"one\")));\n  System.out.println(orJoin(Arrays.asList(\"one\", \"two\")));\n\ngives this:\n\n(one)\n(one) OR (two)\n\nIt looks totally acceptable to me.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385364653", "createdAt": "2020-02-27T20:52:44Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,27 +227,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\tor.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))\n+\t\t\t\t.map(Where::value).orElse(\"\");\n+\t\tString condition = join(or.size() == 0 ? \"\" : or.size() == 1 ? or.get(0)\n+\t\t\t\t: or.stream().collect(Collectors.joining(\") OR (\", \"(\", \")\")), whereCause);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzNzc0MQ=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2Nzg4NA==", "bodyText": "it's better to use Collectors.joining(\") OR (\", \"(\", \")\") instead of map(s -> \"(\"+s+\")\").\nOk, I'll follow your advice but I'll update some tests to satisfy additional brackets - I tried not to update any test that not related directly to my change", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385367884", "createdAt": "2020-02-27T20:59:14Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,27 +227,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\tor.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))\n+\t\t\t\t.map(Where::value).orElse(\"\");\n+\t\tString condition = join(or.size() == 0 ? \"\" : or.size() == 1 ? or.get(0)\n+\t\t\t\t: or.stream().collect(Collectors.joining(\") OR (\", \"(\", \")\")), whereCause);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzNzc0MQ=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTg2MTY2OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjo1NjoyNFrOFvZMJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMTowMDowNlrOFvhA0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0MDEwMg==", "bodyText": "You have exactly 2 parts at that point. Just return \"(\"+cond1+\") AND (\"+cond2+\")\"", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385240102", "createdAt": "2020-02-27T16:56:24Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,27 +227,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\tor.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))\n+\t\t\t\t.map(Where::value).orElse(\"\");\n+\t\tString condition = join(or.size() == 0 ? \"\" : or.size() == 1 ? or.get(0)\n+\t\t\t\t: or.stream().collect(Collectors.joining(\") OR (\", \"(\", \")\")), whereCause);\n \t\tString sb = \"SELECT \" + getColumnsStringForSelect(persistentEntity, mappingContext, true) + \" FROM \"\n-\t\t\t\t+ persistentEntity.tableName() + (cond.isEmpty() ? \"\" : \" WHERE \" + cond);\n+\t\t\t\t+ persistentEntity.tableName() + (condition.isEmpty() ? \"\" : \" WHERE \" + condition);\n \t\treturn buildStatementFromSqlWithArgs(sb, tags, null, writeConverter,\n \t\t\t\tkeyParts.toArray(), null);\n \t}\n \n+\tprivate static String join(String cond1, String cond2) {\n+\t\tif (cond1.isEmpty()) {\n+\t\t\treturn cond2;\n+\t\t}\n+\t\tif (cond2.isEmpty()) {\n+\t\t\treturn cond1;\n+\t\t}\n+\t\tStringJoiner where = new StringJoiner(\") AND (\", \"(\", \")\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNTU4OQ==", "bodyText": "No, some of them or even both can be an empty string.\nNot null but empty", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385315589", "createdAt": "2020-02-27T19:13:04Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,27 +227,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\tor.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))\n+\t\t\t\t.map(Where::value).orElse(\"\");\n+\t\tString condition = join(or.size() == 0 ? \"\" : or.size() == 1 ? or.get(0)\n+\t\t\t\t: or.stream().collect(Collectors.joining(\") OR (\", \"(\", \")\")), whereCause);\n \t\tString sb = \"SELECT \" + getColumnsStringForSelect(persistentEntity, mappingContext, true) + \" FROM \"\n-\t\t\t\t+ persistentEntity.tableName() + (cond.isEmpty() ? \"\" : \" WHERE \" + cond);\n+\t\t\t\t+ persistentEntity.tableName() + (condition.isEmpty() ? \"\" : \" WHERE \" + condition);\n \t\treturn buildStatementFromSqlWithArgs(sb, tags, null, writeConverter,\n \t\t\t\tkeyParts.toArray(), null);\n \t}\n \n+\tprivate static String join(String cond1, String cond2) {\n+\t\tif (cond1.isEmpty()) {\n+\t\t\treturn cond2;\n+\t\t}\n+\t\tif (cond2.isEmpty()) {\n+\t\t\treturn cond1;\n+\t\t}\n+\t\tStringJoiner where = new StringJoiner(\") AND (\", \"(\", \")\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0MDEwMg=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1OTg3Mg==", "bodyText": "yes, but you check if they are empty in lines 243-248\nafter that we know we have 2 parts and they are not empty", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385359872", "createdAt": "2020-02-27T20:42:28Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,27 +227,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\tor.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))\n+\t\t\t\t.map(Where::value).orElse(\"\");\n+\t\tString condition = join(or.size() == 0 ? \"\" : or.size() == 1 ? or.get(0)\n+\t\t\t\t: or.stream().collect(Collectors.joining(\") OR (\", \"(\", \")\")), whereCause);\n \t\tString sb = \"SELECT \" + getColumnsStringForSelect(persistentEntity, mappingContext, true) + \" FROM \"\n-\t\t\t\t+ persistentEntity.tableName() + (cond.isEmpty() ? \"\" : \" WHERE \" + cond);\n+\t\t\t\t+ persistentEntity.tableName() + (condition.isEmpty() ? \"\" : \" WHERE \" + condition);\n \t\treturn buildStatementFromSqlWithArgs(sb, tags, null, writeConverter,\n \t\t\t\tkeyParts.toArray(), null);\n \t}\n \n+\tprivate static String join(String cond1, String cond2) {\n+\t\tif (cond1.isEmpty()) {\n+\t\t\treturn cond2;\n+\t\t}\n+\t\tif (cond2.isEmpty()) {\n+\t\t\treturn cond1;\n+\t\t}\n+\t\tStringJoiner where = new StringJoiner(\") AND (\", \"(\", \")\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0MDEwMg=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2ODI3Mw==", "bodyText": "will check it again, thanks", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385368273", "createdAt": "2020-02-27T21:00:06Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,27 +227,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\tor.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString whereCause = Optional.ofNullable(persistentEntity.findAnnotation(Where.class))\n+\t\t\t\t.map(Where::value).orElse(\"\");\n+\t\tString condition = join(or.size() == 0 ? \"\" : or.size() == 1 ? or.get(0)\n+\t\t\t\t: or.stream().collect(Collectors.joining(\") OR (\", \"(\", \")\")), whereCause);\n \t\tString sb = \"SELECT \" + getColumnsStringForSelect(persistentEntity, mappingContext, true) + \" FROM \"\n-\t\t\t\t+ persistentEntity.tableName() + (cond.isEmpty() ? \"\" : \" WHERE \" + cond);\n+\t\t\t\t+ persistentEntity.tableName() + (condition.isEmpty() ? \"\" : \" WHERE \" + condition);\n \t\treturn buildStatementFromSqlWithArgs(sb, tags, null, writeConverter,\n \t\t\t\tkeyParts.toArray(), null);\n \t}\n \n+\tprivate static String join(String cond1, String cond2) {\n+\t\tif (cond1.isEmpty()) {\n+\t\t\treturn cond2;\n+\t\t}\n+\t\tif (cond2.isEmpty()) {\n+\t\t\treturn cond1;\n+\t\t}\n+\t\tStringJoiner where = new StringJoiner(\") AND (\", \"(\", \")\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0MDEwMg=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTg3NDY2OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjo1OTozNVrOFvZUTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOToxNDowN1rOFvd1CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0MjE5MQ==", "bodyText": "create getWhere() method in SpannerPersistentEntity and use it instead of findMergedAnnotation", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385242191", "createdAt": "2020-02-27T16:59:35Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -324,7 +351,11 @@ private static String getChildrenSubquery(\n \t\t\t\tClass childType = spannerPersistentProperty.getColumnInnerType();\n \t\t\t\tSpannerPersistentEntity childPersistentEntity = mappingContext.getPersistentEntity(childType);\n \t\t\t\tjoiner.add(getChildrenStructsQuery(\n-\t\t\t\t\t\tchildPersistentEntity, spannerPersistentEntity, mappingContext, spannerPersistentProperty.getColumnName()));\n+\t\t\t\t\t\tchildPersistentEntity, spannerPersistentEntity, mappingContext, spannerPersistentProperty.getColumnName(),\n+\t\t\t\t\t\tOptional.ofNullable(spannerPersistentProperty.getWhere().map(Where::value)\n+\t\t\t\t\t\t\t\t.orElseGet(() -> Optional.ofNullable(AnnotatedElementUtils\n+\t\t\t\t\t\t\t\t\t\t.findMergedAnnotation(childType, Where.class)).map(Where::value).orElse(null))))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNjEwNA==", "bodyText": "ok, will try\nThanks!", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385316104", "createdAt": "2020-02-27T19:14:07Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -324,7 +351,11 @@ private static String getChildrenSubquery(\n \t\t\t\tClass childType = spannerPersistentProperty.getColumnInnerType();\n \t\t\t\tSpannerPersistentEntity childPersistentEntity = mappingContext.getPersistentEntity(childType);\n \t\t\t\tjoiner.add(getChildrenStructsQuery(\n-\t\t\t\t\t\tchildPersistentEntity, spannerPersistentEntity, mappingContext, spannerPersistentProperty.getColumnName()));\n+\t\t\t\t\t\tchildPersistentEntity, spannerPersistentEntity, mappingContext, spannerPersistentProperty.getColumnName(),\n+\t\t\t\t\t\tOptional.ofNullable(spannerPersistentProperty.getWhere().map(Where::value)\n+\t\t\t\t\t\t\t\t.orElseGet(() -> Optional.ofNullable(AnnotatedElementUtils\n+\t\t\t\t\t\t\t\t\t\t.findMergedAnnotation(childType, Where.class)).map(Where::value).orElse(null))))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0MjE5MQ=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTg5MDYwOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNzowMzo1MVrOFvZePQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMTowMDozOFrOFvhBzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NDczMw==", "bodyText": "create getWhere() method in SpannerPersistentEntity", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385244733", "createdAt": "2020-02-27T17:03:51Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation\n+\t\t//3. there are no read options, as they can't be applied to a query\n+\t\t//4. key set does not have ranges, as they can't be used in a query\n \t\treturn persistentEntity.hasEagerlyLoadedProperties() &&\n+\t\t\t\tpersistentEntity.findAnnotation(Where.class) == null &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2ODUyNw==", "bodyText": "clear", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385368527", "createdAt": "2020-02-27T21:00:38Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation\n+\t\t//3. there are no read options, as they can't be applied to a query\n+\t\t//4. key set does not have ranges, as they can't be used in a query\n \t\treturn persistentEntity.hasEagerlyLoadedProperties() &&\n+\t\t\t\tpersistentEntity.findAnnotation(Where.class) == null &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NDczMw=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTkwNDY2OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "isResolved": true, "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNzowNzo0MVrOFvZm1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMjozMjoxMFrOFvjkaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NjkzNA==", "bodyText": "Could you explain why can't an entity be eagerly loaded if it is annotated with @Where?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385246934", "createdAt": "2020-02-27T17:07:41Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxODI4Mg==", "bodyText": "The method isEligibleForEagerFetch is used to determine can we use readContext.read to fetch the entity or should create an SQL query and execute it by the method executeReadQueryAndResolveChildren.\nSo when we have an \"eager interleaved\" or when we have a @Where annotation on the interleaved property - we can't fetch it with readContext.read but should create a query instead. Probably you find a bug - if @Where is located on  a \"lazy interleaved\" we can use a readContext.read. Thanks!", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385318282", "createdAt": "2020-02-27T19:18:18Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NjkzNA=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMyNjY5OQ==", "bodyText": "I think the isEligibleForEagerFetch should be renamed", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385326699", "createdAt": "2020-02-27T19:33:57Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NjkzNA=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1NzQ5Mw==", "bodyText": "isEligibleForEagerFetch is intended to determine if we can and should run executeReadQueryAndResolveChildren instead of readContext.read, hence the name.\nIf someone want's to use read and pass read options - we need to call readContext.read, we can't just replace it with a call to executeReadQueryAndResolveChildren and ignore options. The interleaved children will have to be loaded lazily.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385357493", "createdAt": "2020-02-27T20:37:07Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NjkzNA=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM3MTY1Ng==", "bodyText": "ok, I gave a wrong explanation, sorry.\nIt is not related to interleaved fields.\nWhat if the entity itself has a class annotation @Where?\nIn such a case, we can't use the readContext.read to fetch it but instead, we should build an SQL query with \"SQL where condition\"  from the annotation we have.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385371656", "createdAt": "2020-02-27T21:07:32Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NjkzNA=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM4NjQ0NA==", "bodyText": "I see your point.\nIn that case will need to modify the logic a little bit.\nWhat we need to do is throw an exception when we have @Interleaved (eager) children or @Where present and options are not null.\nWe can't just silently ignore the options if we can't pass them. Instead, we should let the user know that something is wrong.\nDoes it make sense?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385386444", "createdAt": "2020-02-27T21:38:52Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NjkzNA=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5NTE0Nw==", "bodyText": "Options? what options?\nHow they affect each other?\nwe have a code\n\tprivate <T> boolean isEligibleForEagerFetch(KeySet keys, SpannerReadOptions options,\n\t\t\tSpannerPersistentEntity<T> persistentEntity) {\n\t\treturn persistentEntity.hasEagerlyLoadedProperties() &&\n\t\t\t\tpersistentEntity.findAnnotation(Where.class) == null &&\n\t\t\t\toptions == null && !keys.getRanges().iterator().hasNext();\n\t}\ndo you propose to throw an exception here like this?\n...\n\t\tif (options!=null && (persistentEntity.hasEagerlyLoadedProperties() ||  persistentEntity.getWhere() != null )){\n\t\t\tthrow new IllegalArgumentException(\"bla-bla-bla\");\n\t\t}\n\n\t\treturn persistentEntity.hasEagerlyLoadedProperties() &&\n\t\t\t\toptions == null && !keys.getRanges().iterator().hasNext();\n...\nwell, can we better convert the SpannerReadOptions to the SpannerQueryOption and throw an exception when it is impossible?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385395147", "createdAt": "2020-02-27T21:57:35Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NjkzNA=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5ODY0Mg==", "bodyText": "Another idea - the method readContext.read is very simple, It has completely another design and another idea with \"query\" methods and related feature-annotations (Interleaved, Where, whatever else). Can we just completely ignore these annotations for readContext.read - I mean for SpannerOperations#read? We should just stop the usage of this method in repositories", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385398642", "createdAt": "2020-02-27T22:05:11Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NjkzNA=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQwMDc1Nw==", "bodyText": "or we can design the @Where to be easily converted to the KeySet.\n@Where` - is a new feature and we can do it as we like.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385400757", "createdAt": "2020-02-27T22:10:18Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NjkzNA=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQwOTU1MA==", "bodyText": "There are 3 separate branches\n\nno need for eager or @Where - we call readContext.read\nwe need eager or @Where and options are null - in this case we call executeReadQueryAndResolveChildren\nwe need eager or @Where and options are not null - we throw an exception\n\nWhat do you think about that approach?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385409550", "createdAt": "2020-02-27T22:30:47Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NjkzNA=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQxMDE1Mg==", "bodyText": "deal", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385410152", "createdAt": "2020-02-27T22:32:10Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -213,9 +216,11 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\t\tSpannerPersistentEntity<T> persistentEntity) {\n \t\t//an entity is eligible if all of the following true:\n \t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n+\t\t//2. entity has \"Where\" annotation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0NjkzNA=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NjYzNjg1OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMDo1MzoyOVrOFvg0FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMTowOTo0NlrOFvhRvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2NTAxMw==", "bodyText": "rename to orParts", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385365013", "createdAt": "2020-02-27T20:53:29Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -201,14 +209,15 @@ private SpannerStatementQueryExecutor() {\n \tpublic static <T> Statement buildQuery(KeySet keySet,\n \t\t\tSpannerPersistentEntity<T> persistentEntity, SpannerCustomConverter writeConverter,\n \t\t\tSpannerMappingContext mappingContext) {\n-\t\tStringJoiner orJoiner = new StringJoiner(\" OR \");\n+\t\tList<String> or = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM3MjYwNw==", "bodyText": "ok", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r385372607", "createdAt": "2020-02-27T21:09:46Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -201,14 +209,15 @@ private SpannerStatementQueryExecutor() {\n \tpublic static <T> Statement buildQuery(KeySet keySet,\n \t\t\tSpannerPersistentEntity<T> persistentEntity, SpannerCustomConverter writeConverter,\n \t\t\tSpannerMappingContext mappingContext) {\n-\t\tStringJoiner orJoiner = new StringJoiner(\" OR \");\n+\t\tList<String> or = new ArrayList<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM2NTAxMw=="}, "originalCommit": {"oid": "d037dfbca7958c41279b33e3669be055d7d596c3"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODEwNDU3OnYy", "diffSide": "RIGHT", "path": "docs/src/main/asciidoc/spanner.adoc", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTozMzoxOFrOFxKxlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTo0Nzo1N1rOFxLYEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMTA3Ng==", "bodyText": "Soft Delete is just one application of this. The section should probably be called something like \"Declarative Filtering with @Where\"", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387101076", "createdAt": "2020-03-03T15:33:18Z", "author": {"login": "meltsufin"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,9 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Soft Delete", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwNTA4MQ==", "bodyText": "ok\nShould I add more information like examples? For me, it is a trivial use-case that Hirberhane has for years.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387105081", "createdAt": "2020-03-03T15:39:17Z", "author": {"login": "s13o"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,9 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Soft Delete", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMTA3Ng=="}, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwNjAxMQ==", "bodyText": "Yeah a small example of soft-delete would be great!", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387106011", "createdAt": "2020-03-03T15:40:41Z", "author": {"login": "meltsufin"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,9 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Soft Delete", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMTA3Ng=="}, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExMDkzMA==", "bodyText": "will add one", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387110930", "createdAt": "2020-03-03T15:47:57Z", "author": {"login": "s13o"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,9 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Soft Delete", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMTA3Ng=="}, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODEwNzgxOnYy", "diffSide": "RIGHT", "path": "docs/src/main/asciidoc/spanner.adoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTozNDowOVrOFxKzqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTo0MDoxOFrOFxLD8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMTYxMA==", "bodyText": "Our conventions is one sentence per line.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387101610", "createdAt": "2020-03-03T15:34:09Z", "author": {"login": "meltsufin"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,9 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Soft Delete\n+The `@Where` annotation could be applied to the entity class or to the interleaved property. This annotation provides an SQL where clause", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwNTc3OQ==", "bodyText": "ok, thanks", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387105779", "createdAt": "2020-03-03T15:40:18Z", "author": {"login": "s13o"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,9 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Soft Delete\n+The `@Where` annotation could be applied to the entity class or to the interleaved property. This annotation provides an SQL where clause", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMTYxMA=="}, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMjEyMDU0OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNToxNjozM1rOFxxVgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNToxNjozM1rOFxxVgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzczMjg2Ng==", "bodyText": "This construction persistentEntity.getWhere().isEmpty() is used in multiple places.  Please create hasWhere() method to improve readability.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387732866", "createdAt": "2020-03-04T15:16:33Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -162,6 +164,9 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\t\t\t\t.getPersistentProperty(o.getProperty());\n \t\t\t\t\treturn (property != null) ? property.getColumnName() : o.getProperty();\n \t\t\t\t});\n+\t\tif (!persistentEntity.getWhere().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMjEzNTcyOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNToyMDowOVrOFxxfMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjo1ODo1MVrOFyAviw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzczNTM0NA==", "bodyText": "Move this method to SpannerQueryOptions class and rename to fromReadOptions", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387735344", "createdAt": "2020-03-04T15:20:09Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -209,14 +213,35 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\treturn entities;\n \t}\n \n-\tprivate <T> boolean isEligibleForEagerFetch(KeySet keys, SpannerReadOptions options,\n-\t\t\tSpannerPersistentEntity<T> persistentEntity) {\n-\t\t//an entity is eligible if all of the following true:\n-\t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n-\t\treturn persistentEntity.hasEagerlyLoadedProperties() &&\n-\t\t\t\toptions == null && !keys.getRanges().iterator().hasNext();\n+\t/**\n+\t * In many cases {@link KeySet} with {@link SpannerReadOptions} are compatible with\n+\t * {@link SpannerReadOptions}. The method throws exception when it is impossible.\n+\t * @param options read-parameters\n+\t * @return query-parameters\n+\t * @throws IllegalArgumentException when {@link SpannerQueryOptions} can't be converted to {@link SpannerQueryOptions}\n+\t * \tor {@code keys} have \"ranges\".\n+\t */\n+\tprivate static SpannerQueryOptions toQueryOption(KeySet keys, SpannerReadOptions options) throws IllegalArgumentException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MzY5OQ==", "bodyText": "Another option is to move this method to SpannerReadOptions, so you could call it like this:\noptions.toQueryOptions()", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387983699", "createdAt": "2020-03-04T22:54:59Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -209,14 +213,35 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\treturn entities;\n \t}\n \n-\tprivate <T> boolean isEligibleForEagerFetch(KeySet keys, SpannerReadOptions options,\n-\t\t\tSpannerPersistentEntity<T> persistentEntity) {\n-\t\t//an entity is eligible if all of the following true:\n-\t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n-\t\treturn persistentEntity.hasEagerlyLoadedProperties() &&\n-\t\t\t\toptions == null && !keys.getRanges().iterator().hasNext();\n+\t/**\n+\t * In many cases {@link KeySet} with {@link SpannerReadOptions} are compatible with\n+\t * {@link SpannerReadOptions}. The method throws exception when it is impossible.\n+\t * @param options read-parameters\n+\t * @return query-parameters\n+\t * @throws IllegalArgumentException when {@link SpannerQueryOptions} can't be converted to {@link SpannerQueryOptions}\n+\t * \tor {@code keys} have \"ranges\".\n+\t */\n+\tprivate static SpannerQueryOptions toQueryOption(KeySet keys, SpannerReadOptions options) throws IllegalArgumentException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzczNTM0NA=="}, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NTI5MQ==", "bodyText": "Ah, well, clear", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387985291", "createdAt": "2020-03-04T22:58:51Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -209,14 +213,35 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t\treturn entities;\n \t}\n \n-\tprivate <T> boolean isEligibleForEagerFetch(KeySet keys, SpannerReadOptions options,\n-\t\t\tSpannerPersistentEntity<T> persistentEntity) {\n-\t\t//an entity is eligible if all of the following true:\n-\t\t//1. entity has eager loaded properties\n-\t\t//2. there are no read options, as they can't be applied to a query\n-\t\t//3. key set does not have ranges, as they can't be used in a query\n-\t\treturn persistentEntity.hasEagerlyLoadedProperties() &&\n-\t\t\t\toptions == null && !keys.getRanges().iterator().hasNext();\n+\t/**\n+\t * In many cases {@link KeySet} with {@link SpannerReadOptions} are compatible with\n+\t * {@link SpannerReadOptions}. The method throws exception when it is impossible.\n+\t * @param options read-parameters\n+\t * @return query-parameters\n+\t * @throws IllegalArgumentException when {@link SpannerQueryOptions} can't be converted to {@link SpannerQueryOptions}\n+\t * \tor {@code keys} have \"ranges\".\n+\t */\n+\tprivate static SpannerQueryOptions toQueryOption(KeySet keys, SpannerReadOptions options) throws IllegalArgumentException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzczNTM0NA=="}, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMjE5MjY5OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNTozMjoyNFrOFxyCWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNTozMjoyNFrOFxyCWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0NDM0NA==", "bodyText": "typos, should be keyClause, whereClause", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387744344", "createdAt": "2020-03-04T15:32:24Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,32 +250,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\torParts.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString keyCause = orParts.stream().collect(\n+\t\t\t\t() -> new StringJoiner(\") OR (\", \"(\", \")\").setEmptyValue(\"\"),\n+\t\t\t\tStringJoiner::add, StringJoiner::merge).toString();\n+\t\tString condition = combine(keyCause, whereCause != null ? whereCause : \"\");\n \t\tString sb = \"SELECT \" + getColumnsStringForSelect(persistentEntity, mappingContext, true) + \" FROM \"\n-\t\t\t\t+ persistentEntity.tableName() + (cond.isEmpty() ? \"\" : \" WHERE \" + cond);\n+\t\t\t\t+ (StringUtils.isEmpty(index) ? persistentEntity.tableName() : String.format(\"%s@{FORCE_INDEX=%s}\", persistentEntity.tableName(), index))\n+\t\t\t\t+ (condition.isEmpty() ? \"\" : \" WHERE \" + condition);\n \t\treturn buildStatementFromSqlWithArgs(sb, tags, null, writeConverter,\n \t\t\t\tkeyParts.toArray(), null);\n \t}\n \n \tprivate static <C, P> String getChildrenStructsQuery(\n \t\t\tSpannerPersistentEntity<C> childPersistentEntity,\n \t\t\tSpannerPersistentEntity<P> parentPersistentEntity, SpannerMappingContext mappingContext,\n-\t\t\tString columnName) {\n+\t\t\tString columnName, String whereCause) {\n \t\tString tableName = childPersistentEntity.tableName();\n \t\tList<SpannerPersistentProperty> parentKeyProperties = parentPersistentEntity\n \t\t\t\t.getFlattenedPrimaryKeyProperties();\n-\t\tString condition = parentKeyProperties.stream()\n+\t\tString keyCause = parentKeyProperties.stream()\n \t\t\t\t.map(keyProp -> tableName + \".\" + keyProp.getColumnName()\n \t\t\t\t\t\t+ \" = \"\n \t\t\t\t\t\t+ parentPersistentEntity.tableName() + \".\" + keyProp.getColumnName())\n \t\t\t\t.collect(Collectors.joining(\" AND \"));\n-\n+\t\tString condition = combine(keyCause, whereCause);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 132}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMjIxODk1OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNTozODoxMVrOFxySkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxODoyOTo0MlrOFx4qtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0ODQ5Ng==", "bodyText": "Can we use orParts.stream().map(s -> \"(\"+s+\")\").collect(Collectors.joining(\" OR \")) instead?\nThat would be shorter and more readable.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387748496", "createdAt": "2020-03-04T15:38:11Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,32 +250,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\torParts.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString keyCause = orParts.stream().collect(\n+\t\t\t\t() -> new StringJoiner(\") OR (\", \"(\", \")\").setEmptyValue(\"\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1Mjk4MA==", "bodyText": "I thought I found a way to not wrap an item by parentheses when the stream has a single value only. But I was wrong. I'll switch to your implementation, thanks.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r387852980", "createdAt": "2020-03-04T18:29:42Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,32 +250,45 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\torParts.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString keyCause = orParts.stream().collect(\n+\t\t\t\t() -> new StringJoiner(\") OR (\", \"(\", \")\").setEmptyValue(\"\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0ODQ5Ng=="}, "originalCommit": {"oid": "06998a141c352ba74aa6d7d4529cf99b5e40f448"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTIxODY3OnYy", "diffSide": "RIGHT", "path": "docs/src/main/asciidoc/spanner.adoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDo1MTo1MFrOF0SdzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDo1MTo1MFrOF0SdzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3MjgxMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The `@Where` annotation could be applied to the entity class or to the interleaved property.\n          \n          \n            \n            The `@Where` annotation could be applied to an entity class or to an interleaved property.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390372813", "createdAt": "2020-03-10T14:51:50Z", "author": {"login": "dmitry-s"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,33 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Declarative Filtering with `@Where`\n+The `@Where` annotation could be applied to the entity class or to the interleaved property.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTIzNzAzOnYy", "diffSide": "RIGHT", "path": "docs/src/main/asciidoc/spanner.adoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDo1NToxN1rOF0So4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDo1NToxN1rOF0So4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3NTY0OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Let's think we have an `Agreement` with a list of `Participants` which could be changed at work on it.\n          \n          \n            \n            Let's say we have an `Agreement` entity with a list of `Participants` which could be associated with it.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390375648", "createdAt": "2020-03-10T14:55:17Z", "author": {"login": "dmitry-s"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,33 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Declarative Filtering with `@Where`\n+The `@Where` annotation could be applied to the entity class or to the interleaved property.\n+This annotation provides an SQL where clause that will be applied at the fetching of interleaved collections or the entity itself.\n+\n+Let's think we have an `Agreement` with a list of `Participants` which could be changed at work on it.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTI1MTc2OnYy", "diffSide": "RIGHT", "path": "docs/src/main/asciidoc/spanner.adoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDo1ODoyMVrOF0SyWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDo1ODoyMVrOF0SyWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3ODA3NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The business requirement is to fetch an actual list of participants but for a security reason, all records should remain in the database forever.\n          \n          \n            \n            We would like to fetch a list of currently active participants. For security reasons, all records should remain in the database forever, even if participants become inactive.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390378075", "createdAt": "2020-03-10T14:58:21Z", "author": {"login": "dmitry-s"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,33 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Declarative Filtering with `@Where`\n+The `@Where` annotation could be applied to the entity class or to the interleaved property.\n+This annotation provides an SQL where clause that will be applied at the fetching of interleaved collections or the entity itself.\n+\n+Let's think we have an `Agreement` with a list of `Participants` which could be changed at work on it.\n+The business requirement is to fetch an actual list of participants but for a security reason, all records should remain in the database forever.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTI2NDE1OnYy", "diffSide": "RIGHT", "path": "docs/src/main/asciidoc/spanner.adoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTowMDo1NFrOF0S6Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTowMDo1NFrOF0S6Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM4MDEzMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The simplest way to do it is to use the `@Where` annotation like on the example below.\n          \n          \n            \n            That can be easily achieved with the `@Where` annotation, which is demonstrated by this example:", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390380130", "createdAt": "2020-03-10T15:00:54Z", "author": {"login": "dmitry-s"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,33 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Declarative Filtering with `@Where`\n+The `@Where` annotation could be applied to the entity class or to the interleaved property.\n+This annotation provides an SQL where clause that will be applied at the fetching of interleaved collections or the entity itself.\n+\n+Let's think we have an `Agreement` with a list of `Participants` which could be changed at work on it.\n+The business requirement is to fetch an actual list of participants but for a security reason, all records should remain in the database forever.\n+The simplest way to do it is to use the `@Where` annotation like on the example below.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTI3OTk3OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerOperations.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTowNDoxOVrOF0TEWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTowNDoxOVrOF0TEWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM4MjY4MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t *      <li>we need \"eager\" or \"Where\" and {@code options} with {@code keys} are compatible with {@link SpannerQueryOptions} - in this case we execute an SQL query</li>\n          \n          \n            \n            \t *      <li>we need \"eager\" or \"Where\", {@code options} and {@code keys} are compatible with {@link SpannerQueryOptions} - in this case we execute an SQL query</li>", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390382681", "createdAt": "2020-03-10T15:04:19Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerOperations.java", "diffHunk": "@@ -85,14 +86,24 @@\n \n \t/**\n \t * Finds objects stored from their keys.\n+\t * When the entity has a {@link org.springframework.cloud.gcp.data.spanner.core.mapping.Where} class annotation\n+\t * or some property is eagerly interleaved the SQL query will be performed instead of the\n+\t * {@link ReadContext#read} to fetch such properties and satisfy the {@code sql where} condition.\n \t * @param entityClass the type of the object to retrieve.\n \t * @param keys the keys of the objects to retrieve.\n \t * @param options the Cloud Spanner read options with which to conduct the read operation.\n \t * @param <T> the type of the object to retrieve.\n \t * @return a list of objects that could be found using the given keys. If no keys could be\n \t * found the list will be empty.\n+\t * @throws IllegalArgumentException when a combination of provided parameters and annotations does not allow to take\n+\t *  unambiguous decision about the way to perform the operation. Such algorithm is used:\n+\t *  <ul>\n+\t *      <li>no need for \"eager\" or \"Where\" - we call {@link ReadContext#read}</li>\n+\t *      <li>we need \"eager\" or \"Where\" and {@code options} with {@code keys} are compatible with {@link SpannerQueryOptions} - in this case we execute an SQL query</li>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTI4MjA1OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerOperations.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTowNDo1MFrOF0TFtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTowNDo1MFrOF0TFtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM4MzAzMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t *      <li>we need \"eager\" or \"Where\" and {@code options} with {@code keys} can't be converted to {@link SpannerQueryOptions} - an exception will be thrown</li>\n          \n          \n            \n            \t *      <li>otherwise an exception will be thrown</li>", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390383031", "createdAt": "2020-03-10T15:04:50Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerOperations.java", "diffHunk": "@@ -85,14 +86,24 @@\n \n \t/**\n \t * Finds objects stored from their keys.\n+\t * When the entity has a {@link org.springframework.cloud.gcp.data.spanner.core.mapping.Where} class annotation\n+\t * or some property is eagerly interleaved the SQL query will be performed instead of the\n+\t * {@link ReadContext#read} to fetch such properties and satisfy the {@code sql where} condition.\n \t * @param entityClass the type of the object to retrieve.\n \t * @param keys the keys of the objects to retrieve.\n \t * @param options the Cloud Spanner read options with which to conduct the read operation.\n \t * @param <T> the type of the object to retrieve.\n \t * @return a list of objects that could be found using the given keys. If no keys could be\n \t * found the list will be empty.\n+\t * @throws IllegalArgumentException when a combination of provided parameters and annotations does not allow to take\n+\t *  unambiguous decision about the way to perform the operation. Such algorithm is used:\n+\t *  <ul>\n+\t *      <li>no need for \"eager\" or \"Where\" - we call {@link ReadContext#read}</li>\n+\t *      <li>we need \"eager\" or \"Where\" and {@code options} with {@code keys} are compatible with {@link SpannerQueryOptions} - in this case we execute an SQL query</li>\n+\t *      <li>we need \"eager\" or \"Where\" and {@code options} with {@code keys} can't be converted to {@link SpannerQueryOptions} - an exception will be thrown</li>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTI5MTc1OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerReadOptions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTowNjo0OFrOF0TLrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTowNjo0OFrOF0TLrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM4NDU1Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * The method does this conversion or throws an exception when such is impossible.\n          \n          \n            \n            \t * The method executes such conversion or throws an exception if it's impossible.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390384556", "createdAt": "2020-03-10T15:06:48Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerReadOptions.java", "diffHunk": "@@ -92,4 +93,27 @@ public SpannerReadOptions setAllowPartialRead(boolean allowPartialRead) {\n \t\treturn this.getOptions();\n \t}\n \n+\t/**\n+\t * In many cases a {@link SpannerReadOptions} class instance could be compatible with {@link SpannerQueryOptions}.\n+\t * The method does this conversion or throws an exception when such is impossible.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTM0NDQ0OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNToxNzozMVrOF0Tr-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNToxNzozMVrOF0Tr-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MjgyNg==", "bodyText": "Use fully qualified name for toArray()", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390392826", "createdAt": "2020-03-10T15:17:31Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -473,35 +484,27 @@ private ResultSet performQuery(Statement statement, SpannerQueryOptions options)\n \t\treturn resultSet;\n \t}\n \n-\tprivate <T> List<T> executeReadQueryAndResolveChildren(KeySet keys, SpannerPersistentEntity<T> persistentEntity) {\n+\tprivate <T> List<T> executeReadQueryAndResolveChildren(KeySet keys, SpannerPersistentEntity<T> persistentEntity,\n+\t\t\tSpannerQueryOptions options, String index) {\n \t\tStatement statement = SpannerStatementQueryExecutor.buildQuery(keys, persistentEntity,\n \t\t\t\tthis.spannerEntityProcessor.getWriteConverter(),\n-\t\t\t\tthis.mappingContext);\n+\t\t\t\tthis.mappingContext, index);\n \n-\t\treturn resolveChildEntities(query(persistentEntity.getType(), statement, null), null);\n+\t\treturn resolveChildEntities(query(persistentEntity.getType(), statement, options), options.getIncludeProperties());\n \t}\n \n \tprivate ResultSet executeRead(String tableName, KeySet keys, Iterable<String> columns,\n \t\t\tSpannerReadOptions options) {\n \n \t\tlong startTime = LOGGER.isDebugEnabled() ? System.currentTimeMillis() : 0;\n \n-\t\tResultSet resultSet;\n-\n \t\tReadContext readContext = (options != null && options.getTimestampBound() != null)\n \t\t\t\t? getReadContext(options.getTimestampBound())\n \t\t\t\t: getReadContext();\n \n-\t\tif (options == null) {\n-\t\t\tresultSet = readContext.read(tableName, keys, columns);\n-\t\t}\n-\t\telse if (options.getIndex() != null) {\n-\t\t\tresultSet = readContext.readUsingIndex(tableName, options.getIndex(), keys,\n-\t\t\t\t\tcolumns, options.getOptions());\n-\t\t}\n-\t\telse {\n-\t\t\tresultSet = readContext.read(tableName, keys, columns, options.getOptions());\n-\t\t}\n+\t\tfinal ResultSet resultSet = options != null && options.getIndex() != null\n+\t\t\t\t? readContext.readUsingIndex(tableName, options.getIndex(), keys, columns, options.getOptions())\n+\t\t\t\t: readContext.read(tableName, keys, columns, options == null ? toArray() : options.getOptions());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 137}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTY4MzYwOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/SpannerPersistentProperty.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjozMDo0MlrOF0XAoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjozMDo0MlrOF0XAoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ0NzI2NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Return {@code WHERE} clause of the interleaved property. Couldn't be {@code null} but an empty string.\n          \n          \n            \n            \t * Returns {@code WHERE} clause of the interleaved property or empty string if no value.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390447264", "createdAt": "2020-03-10T16:30:42Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/SpannerPersistentProperty.java", "diffHunk": "@@ -120,4 +121,19 @@\n \t */\n \tboolean isEagerInterleaved();\n \n+\t/**\n+\t * Return {@code WHERE} clause of the interleaved property. Couldn't be {@code null} but an empty string.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTY4NTQ1OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/SpannerPersistentProperty.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjozMTowNVrOF0XB1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjozMTowNVrOF0XB1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ0NzU3NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @return a {@code Where} cause of the interleaved property or empty string.\n          \n          \n            \n            \t * @return a {@code Where} clause of the interleaved property or empty string.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390447575", "createdAt": "2020-03-10T16:31:05Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/SpannerPersistentProperty.java", "diffHunk": "@@ -120,4 +121,19 @@\n \t */\n \tboolean isEagerInterleaved();\n \n+\t/**\n+\t * Return {@code WHERE} clause of the interleaved property. Couldn't be {@code null} but an empty string.\n+\t * @return a {@code Where} cause of the interleaved property or empty string.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTczNDE0OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjo0Mjo0NVrOF0Xg9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjo0Mjo0NVrOF0Xg9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1NTU0MQ==", "bodyText": "Please document that property's @Where overrides the chid entities' @Where", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390455541", "createdAt": "2020-03-10T16:42:45Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -316,19 +360,25 @@ public static String getColumnsStringForSelect(SpannerPersistentEntity<?> spanne\n \t\treturn fetchInterleaved ? sql + getChildrenSubquery(spannerPersistentEntity, mappingContext) : sql;\n \t}\n \n+\tprivate static String getWhere(SpannerPersistentProperty spannerPersistentProperty, SpannerPersistentEntity<?> childPersistentEntity) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 153}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTc1MTYwOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjo0Njo0OFrOF0XsPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxODoxNDoyMFrOF3AZ4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1ODQyOQ==", "bodyText": "Could you clarify what is this method for?\nAlso, if it ignores @Where why is it passed as a parameter String whereClause?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390458429", "createdAt": "2020-03-10T16:46:48Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -201,14 +210,37 @@ private SpannerStatementQueryExecutor() {\n \tpublic static <T> Statement buildQuery(KeySet keySet,\n \t\t\tSpannerPersistentEntity<T> persistentEntity, SpannerCustomConverter writeConverter,\n \t\t\tSpannerMappingContext mappingContext) {\n-\t\tStringJoiner orJoiner = new StringJoiner(\" OR \");\n+\t\treturn buildQuery(keySet, persistentEntity, writeConverter, mappingContext, persistentEntity.getWhere());\n+\t}\n+\n+\t/**\n+\t * Builds a query that returns the rows associated with a key set with additional SQL-where.\n+\t * But the {@link org.springframework.cloud.gcp.data.spanner.core.mapping.Where} will be ignored.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyMjYyNQ==", "bodyText": "the method is needed for better compatibility with the previous version. Probably someone already uses the previous method - it was \"public static\"\nJava doc updated, check it, pls.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r393222625", "createdAt": "2020-03-16T18:14:20Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -201,14 +210,37 @@ private SpannerStatementQueryExecutor() {\n \tpublic static <T> Statement buildQuery(KeySet keySet,\n \t\t\tSpannerPersistentEntity<T> persistentEntity, SpannerCustomConverter writeConverter,\n \t\t\tSpannerMappingContext mappingContext) {\n-\t\tStringJoiner orJoiner = new StringJoiner(\" OR \");\n+\t\treturn buildQuery(keySet, persistentEntity, writeConverter, mappingContext, persistentEntity.getWhere());\n+\t}\n+\n+\t/**\n+\t * Builds a query that returns the rows associated with a key set with additional SQL-where.\n+\t * But the {@link org.springframework.cloud.gcp.data.spanner.core.mapping.Where} will be ignored.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1ODQyOQ=="}, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTc1MzgzOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjo0NzoyN1rOF0XttA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjo0NzoyN1rOF0XttA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1ODgwNA==", "bodyText": "Please add java doc", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390458804", "createdAt": "2020-03-10T16:47:27Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -201,14 +210,37 @@ private SpannerStatementQueryExecutor() {\n \tpublic static <T> Statement buildQuery(KeySet keySet,\n \t\t\tSpannerPersistentEntity<T> persistentEntity, SpannerCustomConverter writeConverter,\n \t\t\tSpannerMappingContext mappingContext) {\n-\t\tStringJoiner orJoiner = new StringJoiner(\" OR \");\n+\t\treturn buildQuery(keySet, persistentEntity, writeConverter, mappingContext, persistentEntity.getWhere());\n+\t}\n+\n+\t/**\n+\t * Builds a query that returns the rows associated with a key set with additional SQL-where.\n+\t * But the {@link org.springframework.cloud.gcp.data.spanner.core.mapping.Where} will be ignored.\n+\t * @param keySet the key set whose members to get.\n+\t * @param persistentEntity the persistent entity of the table.\n+\t * @param <T> the type of the persistent entity\n+\t * @param writeConverter a converter to convert key values as needed to bind to the query statement.\n+\t * @param mappingContext mapping context\n+\t * @param whereClause SQL where clause\n+\t * @return the Spanner statement to perform the retrieval.\n+\t */\n+\tpublic static <T> Statement buildQuery(KeySet keySet,\n+\t\t\tSpannerPersistentEntity<T> persistentEntity, SpannerCustomConverter writeConverter,\n+\t\t\tSpannerMappingContext mappingContext, String whereClause) {\n+\t\treturn buildQuery(keySet, persistentEntity, writeConverter, mappingContext, whereClause, null);\n+\t}\n+\n+\tpublic static <T> Statement buildQuery(KeySet keySet,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTc3NjE4OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjo1Mjo1N1rOF0X8Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMjo1NDowM1rOF1ykxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ2MjU1MQ==", "bodyText": "Let's just remove this ternary operator.  orParts.get(0) : orParts.stream().map(s -> \"(\" + s + \")\").collect(Collectors.joining(\" OR \")) is sufficient.\nIt has a side effect of adding unnecessary parentheses if there is only one part, but that is not a problem.\nThis will make the code more readable.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390462551", "createdAt": "2020-03-10T16:52:57Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,32 +250,44 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\torParts.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString keyClause = orParts.size() == 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NzQ2MQ==", "bodyText": "I do not agree with your argument. The code is already complex enough and this small update will not simplify it - it will just brake some IT tests. But, sure, I'll follow your advice.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r391947461", "createdAt": "2020-03-12T22:54:03Z", "author": {"login": "s13o"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,32 +250,44 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\torParts.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString keyClause = orParts.size() == 1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ2MjU1MQ=="}, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTgyNjUxOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzowNDoyN1rOF0YbZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzowNDoyN1rOF0YbZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3MDUwMw==", "bodyText": "I see this logic is repeated multiple times. We should introduce a method (let's call it buildWhere) that checks if a string is empty or null and if not, returns \" WHERE \" + string, otherwise returns \"\"", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390470503", "createdAt": "2020-03-10T17:04:27Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerTemplate.java", "diffHunk": "@@ -253,10 +264,10 @@ public long executePartitionedDmlStatement(Statement statement) {\n \t@Override\n \tpublic <T> List<T> queryAll(Class<T> entityClass,\n \t\t\tSpannerPageableQueryOptions options) {\n-\t\tSpannerPersistentEntity<?> persistentEntity = this.mappingContext\n-\t\t\t\t.getPersistentEntity(entityClass);\n+\t\tSpannerPersistentEntity<?> persistentEntity = this.mappingContext.getPersistentEntity(entityClass);\n+\t\tString condition = persistentEntity.hasWhere() ? \" WHERE \" + persistentEntity.getWhere() : \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTg1ODAyOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzoxMTo1NVrOF0YvQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzoxMTo1NVrOF0YvQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3NTU4NQ==", "bodyText": "let's move this  whereClause != null ? whereClause : \"\" to the combine method and apply it to both arguments", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390475585", "createdAt": "2020-03-10T17:11:55Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,32 +250,44 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\torParts.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString keyClause = orParts.size() == 1\n+\t\t\t\t? orParts.get(0) : orParts.stream().map(s -> \"(\" + s + \")\").collect(Collectors.joining(\" OR \"));\n+\t\tString condition = combine(keyClause, whereClause != null ? whereClause : \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTg2MDgwOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzoxMjozOFrOF0YxAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzoxMjozOFrOF0YxAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3NjAzMw==", "bodyText": "rename to combineWithAnd for clarity", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r390476033", "createdAt": "2020-03-10T17:12:38Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/repository/query/SpannerStatementQueryExecutor.java", "diffHunk": "@@ -218,32 +250,44 @@ private SpannerStatementQueryExecutor() {\n \t\t\t\tkeyParts.add(parentKeyParts.next());\n \t\t\t\ttagNum++;\n \t\t\t}\n-\t\t\torJoiner.add(andJoiner.toString());\n+\t\t\torParts.add(andJoiner.toString());\n \t\t}\n-\t\tString cond = orJoiner.toString();\n+\t\tString keyClause = orParts.size() == 1\n+\t\t\t\t? orParts.get(0) : orParts.stream().map(s -> \"(\" + s + \")\").collect(Collectors.joining(\" OR \"));\n+\t\tString condition = combine(keyClause, whereClause != null ? whereClause : \"\");\n \t\tString sb = \"SELECT \" + getColumnsStringForSelect(persistentEntity, mappingContext, true) + \" FROM \"\n-\t\t\t\t+ persistentEntity.tableName() + (cond.isEmpty() ? \"\" : \" WHERE \" + cond);\n+\t\t\t\t+ (StringUtils.isEmpty(index) ? persistentEntity.tableName() : String.format(\"%s@{FORCE_INDEX=%s}\", persistentEntity.tableName(), index))\n+\t\t\t\t+ (condition.isEmpty() ? \"\" : \" WHERE \" + condition);\n \t\treturn buildStatementFromSqlWithArgs(sb, tags, null, writeConverter,\n \t\t\t\tkeyParts.toArray(), null);\n \t}\n \n \tprivate static <C, P> String getChildrenStructsQuery(\n \t\t\tSpannerPersistentEntity<C> childPersistentEntity,\n \t\t\tSpannerPersistentEntity<P> parentPersistentEntity, SpannerMappingContext mappingContext,\n-\t\t\tString columnName) {\n+\t\t\tString columnName, String whereClause) {\n \t\tString tableName = childPersistentEntity.tableName();\n \t\tList<SpannerPersistentProperty> parentKeyProperties = parentPersistentEntity\n \t\t\t\t.getFlattenedPrimaryKeyProperties();\n-\t\tString condition = parentKeyProperties.stream()\n+\t\tString keylCause = parentKeyProperties.stream()\n \t\t\t\t.map(keyProp -> tableName + \".\" + keyProp.getColumnName()\n \t\t\t\t\t\t+ \" = \"\n \t\t\t\t\t\t+ parentPersistentEntity.tableName() + \".\" + keyProp.getColumnName())\n \t\t\t\t.collect(Collectors.joining(\" AND \"));\n-\n+\t\tString condition = combine(keylCause, whereClause);\n \t\treturn \"ARRAY (SELECT AS STRUCT \" + getColumnsStringForSelect(childPersistentEntity, mappingContext, true) + \" FROM \"\n-\t\t\t\t+ tableName + \" WHERE \" + condition + \") as \" + columnName;\n+\t\t\t\t+ tableName + \" WHERE \" + condition + \") AS \" + columnName;\n \t}\n \n+\tprivate static String combine(String cond1, String cond2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e555ab6b5b56a10c8e238f3284f4697775b3e41"}, "originalPosition": 137}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNzQwNjU0OnYy", "diffSide": "RIGHT", "path": "docs/src/main/asciidoc/spanner.adoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDo0NDo1OVrOF1hsng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDo0NDo1OVrOF1hsng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY3MDk0Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Let's think we have an `Agreement` with a list of `Participants` which could be changed at work on it.\n          \n          \n            \n            Let's say we have an `Agreement` with a list of `Participants` which could be assigned to it.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r391670942", "createdAt": "2020-03-12T14:44:59Z", "author": {"login": "dmitry-s"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,33 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Declarative Filtering with `@Where`\n+The `@Where` annotation could be applied to an entity class or to an interleaved property.\n+This annotation provides an SQL where clause that will be applied at the fetching of interleaved collections or the entity itself.\n+\n+Let's think we have an `Agreement` with a list of `Participants` which could be changed at work on it.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ef09152f0ae2066ef6b599bf7f9ab20409db886"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MTM1MzA4OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerOperations.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo0OToyM1rOF3nb-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo0OToyM1rOF3nb-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg2MjEzNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * or some property is eagerly interleaved the SQL query will be performed instead of the\n          \n          \n            \n            \t * or any of the properties is eagerly interleaved, the SQL query will be performed instead of the", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r393862137", "createdAt": "2020-03-17T17:49:23Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/SpannerOperations.java", "diffHunk": "@@ -85,14 +86,24 @@\n \n \t/**\n \t * Finds objects stored from their keys.\n+\t * When the entity has a {@link org.springframework.cloud.gcp.data.spanner.core.mapping.Where} class annotation\n+\t * or some property is eagerly interleaved the SQL query will be performed instead of the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d54c206d0040c8e603dc2bfcddb3b6c6373d34c"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MTM4ODY0OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/SpannerPersistentProperty.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo1ODo1MlrOF3nzVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo1ODo1MlrOF3nzVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg2ODExNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @return a {@code Where} clause of the interleaved property or empty string.\n          \n          \n            \n            \t * @return a {@code WHERE} clause of the interleaved property or empty string.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r393868117", "createdAt": "2020-03-17T17:58:52Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-spanner/src/main/java/org/springframework/cloud/gcp/data/spanner/core/mapping/SpannerPersistentProperty.java", "diffHunk": "@@ -120,4 +121,19 @@\n \t */\n \tboolean isEagerInterleaved();\n \n+\t/**\n+\t * Returns {@code WHERE} clause of the interleaved property or empty string if no value.\n+\t * @return a {@code Where} clause of the interleaved property or empty string.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d54c206d0040c8e603dc2bfcddb3b6c6373d34c"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MTM5MTQzOnYy", "diffSide": "RIGHT", "path": "docs/src/main/asciidoc/spanner.adoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo1OTozMFrOF3n1Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo1OTozMFrOF3n1Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg2ODU1MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            We would like to fetch a list of currently active participants. For security reasons, all records should remain in the database forever, even if participants become inactive.\n          \n          \n            \n            We would like to fetch a list of currently active participants.\n          \n          \n            \n            For security reasons, all records should remain in the database forever, even if participants become inactive.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2219#discussion_r393868550", "createdAt": "2020-03-17T17:59:30Z", "author": {"login": "dmitry-s"}, "path": "docs/src/main/asciidoc/spanner.adoc", "diffHunk": "@@ -420,6 +420,33 @@ If a property marked for lazy fetching is never retrieved, then it is also skipp\n \n If used inside a transaction, subsequent operations on lazily-fetched properties use the same transaction context as that of the original parent entity.\n \n+===== Declarative Filtering with `@Where`\n+The `@Where` annotation could be applied to an entity class or to an interleaved property.\n+This annotation provides an SQL where clause that will be applied at the fetching of interleaved collections or the entity itself.\n+\n+Let's say we have an `Agreement` with a list of `Participants` which could be assigned to it.\n+We would like to fetch a list of currently active participants. For security reasons, all records should remain in the database forever, even if participants become inactive.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d54c206d0040c8e603dc2bfcddb3b6c6373d34c"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2267, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}