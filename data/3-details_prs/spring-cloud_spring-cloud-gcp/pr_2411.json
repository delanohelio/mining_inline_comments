{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NTYyMjAz", "number": 2411, "title": "Account for possible concurrent topic creation in PubSub topic auto-c\u2026", "bodyText": "\u2026reate functionality.\n#2410", "createdAt": "2020-06-02T12:48:20Z", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411", "merged": true, "mergeCommit": {"oid": "5a4c1a7b5ef40093d6bdeb60bf4f4b96ea7355af"}, "closed": true, "closedAt": "2020-06-02T17:33:17Z", "author": {"login": "mvmn"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnUNM7gH2gAyNDI2NTYyMjAzOjY1NzI5OGU1OTU1NDg3NGE0YTA2M2I1YWQ5ZjVlZjZmM2M3OGE0NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnYXJcAFqTQyMjkwMzM3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "657298e59554874a4a063b5ad9f5ef6f3c78a462", "author": {"user": {"login": "mvmn", "name": "Mykola Makhin"}}, "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/657298e59554874a4a063b5ad9f5ef6f3c78a462", "committedDate": "2020-06-02T12:41:39Z", "message": "Account for possible concurrent topic creation in PubSub topic auto-create functionality."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNjQwOTM3", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#pullrequestreview-422640937", "createdAt": "2020-06-02T12:49:43Z", "commit": {"oid": "657298e59554874a4a063b5ad9f5ef6f3c78a462"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMjo0OTo0M1rOGdwCzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMjo0OTo0M1rOGdwCzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0OTAzNg==", "bodyText": "Could you log a warning here?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#discussion_r433849036", "createdAt": "2020-06-02T12:49:43Z", "author": {"login": "elefeint"}, "path": "spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/provisioning/PubSubChannelProvisioner.java", "diffHunk": "@@ -118,7 +120,11 @@ private Topic makeSureTopicExists(String topicName, boolean autoCreate) {\n \t\tTopic topic = this.pubSubAdmin.getTopic(topicName);\n \t\tif (topic == null) {\n \t\t\tif (autoCreate) {\n-\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\ttry {\n+\t\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\t} catch(AlreadyExistsException alreadyExistsException) {\n+\t\t\t\t\t// Ignore concurrent topic creation - we're good as long as topic was created and exists", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657298e59554874a4a063b5ad9f5ef6f3c78a462"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0e6814879352d28a063aa451f1eee5b2c8c4a98", "author": {"user": {"login": "mvmn", "name": "Mykola Makhin"}}, "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/d0e6814879352d28a063aa451f1eee5b2c8c4a98", "committedDate": "2020-06-02T13:06:51Z", "message": "Added warning message in case topic already existed when auto-creation was attempted."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92c9ab6455594f63695c62bc3225ba99c4ae006a", "author": {"user": {"login": "mvmn", "name": "Mykola Makhin"}}, "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/92c9ab6455594f63695c62bc3225ba99c4ae006a", "committedDate": "2020-06-02T13:14:37Z", "message": "Account for possible concurrent topic creation in PubSub topic auto-create functionality - added unit test for this."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aebb5868c34e5cdfe097619f92079affccc29520", "author": {"user": {"login": "mvmn", "name": "Mykola Makhin"}}, "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/aebb5868c34e5cdfe097619f92079affccc29520", "committedDate": "2020-06-02T13:29:07Z", "message": "Fix checkstyle nonsense"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e2c02541783a56d558a313b4d2d79ad586f1d5b", "author": {"user": {"login": "mvmn", "name": "Mykola Makhin"}}, "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/3e2c02541783a56d558a313b4d2d79ad586f1d5b", "committedDate": "2020-06-02T13:32:44Z", "message": "Fix checkstyle nonsense"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNjkwMDU2", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#pullrequestreview-422690056", "createdAt": "2020-06-02T13:44:07Z", "commit": {"oid": "3e2c02541783a56d558a313b4d2d79ad586f1d5b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo0NDowN1rOGdyR2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo0NDowN1rOGdyR2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4NTY1Ng==", "bodyText": "Why warning level if it's not a real issue?\nI would go with DEBUG, or at most INFO.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#discussion_r433885656", "createdAt": "2020-06-02T13:44:07Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/provisioning/PubSubChannelProvisioner.java", "diffHunk": "@@ -118,7 +120,11 @@ private Topic makeSureTopicExists(String topicName, boolean autoCreate) {\n \t\tTopic topic = this.pubSubAdmin.getTopic(topicName);\n \t\tif (topic == null) {\n \t\t\tif (autoCreate) {\n-\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\ttry {\n+\t\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\t} catch(AlreadyExistsException alreadyExistsException) {\n+\t\t\t\t\t// Ignore concurrent topic creation - we're good as long as topic was created and exists", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0OTAzNg=="}, "originalCommit": {"oid": "657298e59554874a4a063b5ad9f5ef6f3c78a462"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e51fdf8d965ed03dc4ece907c2006a2607e88b2", "author": {"user": {"login": "mvmn", "name": "Mykola Makhin"}}, "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/6e51fdf8d965ed03dc4ece907c2006a2607e88b2", "committedDate": "2020-06-02T14:06:36Z", "message": "Added warning message in case topic already existed when auto-creation was attempted - changed log level to INFO instead of WARN."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNzY3NzAx", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#pullrequestreview-422767701", "createdAt": "2020-06-02T15:00:05Z", "commit": {"oid": "6e51fdf8d965ed03dc4ece907c2006a2607e88b2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNTowMDowNVrOGd11mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNTowMDowNVrOGd11mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk0Mzk2Mg==", "bodyText": "Extreme nit: replace \"non_existing_topic\" with \"already_existing_topic\".", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#discussion_r433943962", "createdAt": "2020-06-02T15:00:05Z", "author": {"login": "elefeint"}, "path": "spring-cloud-gcp-pubsub-stream-binder/src/test/java/org/springframework/cloud/gcp/stream/binder/pubsub/provisioning/PubSubChannelProvisionerTests.java", "diffHunk": "@@ -176,4 +177,14 @@ public void testAfterUnbindConsumer_nonAnonymous() {\n \n \t\tverify(this.pubSubAdminMock, never()).deleteSubscription(result.getName());\n \t}\n+\n+\t@Test\n+\tpublic void testProvisionConsumerDestination_concurrentTopicCreation() {\n+\t\twhen(this.pubSubAdminMock.createTopic(any())).thenThrow(AlreadyExistsException.class);\n+\t\twhen(this.pubSubAdminMock.getTopic(eq(\"non_existing_topic\"))).thenReturn(null);\n+\n+\t\t// Ensure no exceptions occur if topic already exists on create call\n+\t\tthis.pubSubChannelProvisioner\n+\t\t\t\t.provisionConsumerDestination(\"non_existing_topic\", \"group1\", this.properties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e51fdf8d965ed03dc4ece907c2006a2607e88b2"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7280465461eda785ce6bd91ff368b30ba7ebd86", "author": {"user": {"login": "mvmn", "name": "Mykola Makhin"}}, "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/c7280465461eda785ce6bd91ff368b30ba7ebd86", "committedDate": "2020-06-02T15:01:50Z", "message": "Account for possible concurrent topic creation in PubSub topic auto-create functionality - slightly changed unit test for this (better mock topic name)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyODU5NzIy", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#pullrequestreview-422859722", "createdAt": "2020-06-02T16:35:43Z", "commit": {"oid": "c7280465461eda785ce6bd91ff368b30ba7ebd86"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTAzMzc2", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#pullrequestreview-422903376", "createdAt": "2020-06-02T17:32:08Z", "commit": {"oid": "c7280465461eda785ce6bd91ff368b30ba7ebd86"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 472, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}