{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNjE2Mjgy", "number": 2223, "title": "Create AutoConfiguration for Secret Manager Template and extend sample", "bodyText": "This adds a non-bootstrap phase autoconfiguration class to autowire the SecretManagerTemplate and then extends the existing sample application to use the template class.\nContributes to #2176.\nRefdoc is prepared in the PR here: #2224.", "createdAt": "2020-02-28T22:04:12Z", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223", "merged": true, "mergeCommit": {"oid": "c20caf1405d834ee9b31c089213034e44f679d6d"}, "closed": true, "closedAt": "2020-03-02T20:13:44Z", "author": {"login": "dzou"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcI3R3RAH2gAyMzgxNjE2MjgyOjNiNzU0M2NmYzlkMmY1YzQzOWEzNzgxODQ4N2U2OGZhOTE4YmZlYzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJzg48gFqTM2NzQ5NDEzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3b7543cfc9d2f5c439a37818487e68fa918bfec0", "author": {"user": {"login": "dzou", "name": "Daniel Zou"}}, "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/3b7543cfc9d2f5c439a37818487e68fa918bfec0", "committedDate": "2020-02-28T22:01:46Z", "message": "Finalize autoconfiguration for Secret Manager and add Sample Application"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8cc811db7a0281a884dbe149fb8b2ae943a1e8", "author": {"user": {"login": "dzou", "name": "Daniel Zou"}}, "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/ae8cc811db7a0281a884dbe149fb8b2ae943a1e8", "committedDate": "2020-02-28T22:12:31Z", "message": "Fix typos"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NzczNDI4", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#pullrequestreview-366773428", "createdAt": "2020-02-29T03:26:31Z", "commit": {"oid": "ae8cc811db7a0281a884dbe149fb8b2ae943a1e8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQwMzoyNjozMVrOFwHXFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQwMzoyNjozMVrOFwHXFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk5NjU2NQ==", "bodyText": "I'm having second thoughts on the separation of the template from the bootstrap configuration. The main reason being that we wanted to re-use the template in the property source implementation, and currently we don't. If we do create the SecretManagerTemplate in the boostrap, does it remain accessible to the application context? If so, I'm not sure of what the benefit would be of this separate configuration class.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r385996565", "createdAt": "2020-02-29T03:26:31Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/GcpSecretManagerTemplateConfiguration.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n+\n+import java.io.IOException;\n+\n+import com.google.api.gax.core.CredentialsProvider;\n+import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient;\n+import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceSettings;\n+\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.boot.context.properties.EnableConfigurationProperties;\n+import org.springframework.cloud.gcp.core.DefaultCredentialsProvider;\n+import org.springframework.cloud.gcp.core.DefaultGcpProjectIdProvider;\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+import org.springframework.cloud.gcp.core.UserAgentHeaderProvider;\n+import org.springframework.cloud.gcp.secretmanager.SecretManagerTemplate;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+\n+/**\n+ * Autoconfiguration for GCP Secret Manager which provides an instance of the\n+ * {@link SecretManagerTemplate}.\n+ *\n+ * @author Daniel Zou\n+ * @since 1.2.2\n+ */\n+@Configuration\n+@EnableConfigurationProperties(GcpSecretManagerProperties.class)\n+@ConditionalOnClass(SecretManagerServiceClient.class)\n+@ConditionalOnProperty(value = \"spring.cloud.gcp.secretmanager.template.enabled\", matchIfMissing = true)\n+public class GcpSecretManagerTemplateConfiguration {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae8cc811db7a0281a884dbe149fb8b2ae943a1e8"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MzAyMjQy", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#pullrequestreview-367302242", "createdAt": "2020-03-02T15:44:59Z", "commit": {"oid": "ae8cc811db7a0281a884dbe149fb8b2ae943a1e8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNTo0NDo1OVrOFwkZjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNTo0NDo1OVrOFwkZjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ3MjMzMg==", "bodyText": "GcpSecretManagerTemplateConfiguration and GcpSecretManagerBootstrapConfiguration end up being somewhat similar.\nI guess it's related to Mike's comment above, but possibly we should have one autoconfiguration with an optional conversion bean/property source additions that are blocked by an extra, off-by-default, property?\nIs there any harm in doing regular bean initialization during bootstrap phase if someone does opt for template-only without enabling property initialization?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r386472332", "createdAt": "2020-03-02T15:44:59Z", "author": {"login": "elefeint"}, "path": "spring-cloud-gcp-autoconfigure/src/main/java/org/springframework/cloud/gcp/autoconfigure/secretmanager/GcpSecretManagerTemplateConfiguration.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2017-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.springframework.cloud.gcp.autoconfigure.secretmanager;\n+\n+import java.io.IOException;\n+\n+import com.google.api.gax.core.CredentialsProvider;\n+import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceClient;\n+import com.google.cloud.secretmanager.v1beta1.SecretManagerServiceSettings;\n+\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.boot.context.properties.EnableConfigurationProperties;\n+import org.springframework.cloud.gcp.core.DefaultCredentialsProvider;\n+import org.springframework.cloud.gcp.core.DefaultGcpProjectIdProvider;\n+import org.springframework.cloud.gcp.core.GcpProjectIdProvider;\n+import org.springframework.cloud.gcp.core.UserAgentHeaderProvider;\n+import org.springframework.cloud.gcp.secretmanager.SecretManagerTemplate;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+\n+/**\n+ * Autoconfiguration for GCP Secret Manager which provides an instance of the\n+ * {@link SecretManagerTemplate}.\n+ *\n+ * @author Daniel Zou\n+ * @since 1.2.2\n+ */\n+@Configuration\n+@EnableConfigurationProperties(GcpSecretManagerProperties.class)\n+@ConditionalOnClass(SecretManagerServiceClient.class)\n+@ConditionalOnProperty(value = \"spring.cloud.gcp.secretmanager.template.enabled\", matchIfMissing = true)\n+public class GcpSecretManagerTemplateConfiguration {\n+\n+\tprivate final GcpSecretManagerProperties properties;\n+\n+\tprivate final CredentialsProvider credentialsProvider;\n+\n+\tprivate final GcpProjectIdProvider gcpProjectIdProvider;\n+\n+\tpublic GcpSecretManagerTemplateConfiguration(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae8cc811db7a0281a884dbe149fb8b2ae943a1e8"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c830a5ce59eadbb3ad944a4561f90fa7f7b487b7", "author": {"user": {"login": "dzou", "name": "Daniel Zou"}}, "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/c830a5ce59eadbb3ad944a4561f90fa7f7b487b7", "committedDate": "2020-03-02T19:16:23Z", "message": "PR Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NDU4ODI5", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#pullrequestreview-367458829", "createdAt": "2020-03-02T19:18:04Z", "commit": {"oid": "ae8cc811db7a0281a884dbe149fb8b2ae943a1e8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxOToxODowNVrOFwr9gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxOToyMToxNVrOFwsEQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU5NjIyNA==", "bodyText": "The secret blends into the sentence. Maybe emphasize it a bit more?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              <br/>application-secret: [[${applicationSecret}]]\n          \n          \n            \n              <br/><b>application-secret:</b> <i>[[${applicationSecret}]]</i>", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r386596224", "createdAt": "2020-03-02T19:18:05Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-samples/spring-cloud-gcp-secretmanager-sample/src/main/resources/templates/index.html", "diffHunk": "@@ -0,0 +1,98 @@\n+<html>\n+\n+<style>\n+  html * {\n+    font-family: Roboto, Verdana, sans-serif;\n+  }\n+\n+  body {\n+    max-width: 50em;\n+  }\n+\n+  li {\n+    padding: 0.25em;\n+  }\n+\n+  .panel {\n+    margin: 1em;\n+    padding: 1em;\n+    border: 1px solid black;\n+    border-radius: 5px;\n+  }\n+\n+  .highlight {\n+    background-color: #d6f5d6;\n+  }\n+\n+\n+</style>\n+\n+<head>\n+  <title>Google Cloud Secret Manager Demo</title>\n+  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/>\n+  <link type=\"text/css\" href=\"css/style.css\" rel=\"stylesheet\"/>\n+</head>\n+\n+<body>\n+<h1>Secret Manager Demo with Spring Cloud GCP</h1>\n+\n+<div class=\"panel\">\n+  <h3>Secret Manager Property Source</h3>\n+  At the bootstrap phase, we loaded the following secret into the application context:\n+  <br/>application-secret: [[${applicationSecret}]]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae8cc811db7a0281a884dbe149fb8b2ae943a1e8"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU5Nzk1NQ==", "bodyText": "The redirect makes it hard to tell that something actually happened.\nMaybe just return a message like \"Secret created\".\nYou can of course also just use the ModelAndView with an additional \"message\" argument for this endpoint and the one above, but that's a bit more fancy.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#discussion_r386597955", "createdAt": "2020-03-02T19:21:15Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-samples/spring-cloud-gcp-secretmanager-sample/src/main/java/com/example/SecretManagerWebController.java", "diffHunk": "@@ -18,30 +18,50 @@\n \n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.cloud.gcp.secretmanager.SecretManagerTemplate;\n import org.springframework.core.env.Environment;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.ui.ModelMap;\n import org.springframework.web.bind.annotation.GetMapping;\n-import org.springframework.web.bind.annotation.RestController;\n+import org.springframework.web.bind.annotation.PostMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+import org.springframework.web.servlet.ModelAndView;\n \n-@RestController\n-public class WebController {\n+@Controller\n+public class SecretManagerWebController {\n \n \t@Autowired\n \tprivate Environment environment;\n \n \t@Autowired\n \tprivate MyAppProperties properties;\n \n+\t@Autowired\n+\tprivate SecretManagerTemplate secretManagerTemplate;\n+\n \t// Application secrets can be accessed using @Value and passing in the secret name.\n \t// Note that the secret name is prefixed with \"secrets\" because of the prefix setting in\n \t// bootstrap.properties.\n \t@Value(\"${secrets.application-secret}\")\n \tprivate String applicationSecretValue;\n \n \t@GetMapping(\"/\")\n-\tpublic String getRoot() {\n-\t\t// In practice, you never want to print your secrets as plaintext.\n-\t\treturn \"<h1>Secret Manager Sample Application</h1>\"\n-\t\t\t\t+ \"The secret property is: \" + properties.getApplicationSecret() + \"<br/>\"\n-\t\t\t\t+ \"You can also access secrets using @Value: \" + applicationSecretValue + \"<br/>\";\n+\tpublic ModelAndView renderIndex(ModelMap map) {\n+\t\tmap.put(\"applicationSecret\", this.applicationSecretValue);\n+\t\treturn new ModelAndView(\"index.html\", map);\n+\t}\n+\n+\t@GetMapping(\"/getSecret\")\n+\t@ResponseBody\n+\tpublic String getSecret(@RequestParam String secretId, ModelMap map) {\n+\t\tString secretPayload = this.secretManagerTemplate.getSecretString(secretId);\n+\t\treturn \"Secret ID: \" + secretId + \" | Value: \" + secretPayload;\n+\t}\n+\n+\t@PostMapping(\"/createSecret\")\n+\tpublic String createSecret(@RequestParam String secretId, @RequestParam String secretPayload) {\n+\t\tthis.secretManagerTemplate.createSecret(secretId, secretPayload);\n+\t\treturn \"redirect:/\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c830a5ce59eadbb3ad944a4561f90fa7f7b487b7"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bacabd32c57296d0060b2e2e5414456d0aa45708", "author": {"user": {"login": "dzou", "name": "Daniel Zou"}}, "url": "https://github.com/spring-cloud/spring-cloud-gcp/commit/bacabd32c57296d0060b2e2e5414456d0aa45708", "committedDate": "2020-03-02T19:35:51Z", "message": "Polish Sample"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NDcyODcz", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#pullrequestreview-367472873", "createdAt": "2020-03-02T19:39:09Z", "commit": {"oid": "c830a5ce59eadbb3ad944a4561f90fa7f7b487b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NDk0MTM0", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2223#pullrequestreview-367494134", "createdAt": "2020-03-02T20:12:29Z", "commit": {"oid": "bacabd32c57296d0060b2e2e5414456d0aa45708"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 557, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}