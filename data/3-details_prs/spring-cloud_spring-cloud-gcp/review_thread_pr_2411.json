{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NTYyMjAz", "number": 2411, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMjo0OTo0M1rOEBuqeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNTowMDowNVrOEByNyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjQ4NTY5OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/provisioning/PubSubChannelProvisioner.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMjo0OTo0M1rOGdwCzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDowNzoxNVrOGdzc9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0OTAzNg==", "bodyText": "Could you log a warning here?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#discussion_r433849036", "createdAt": "2020-06-02T12:49:43Z", "author": {"login": "elefeint"}, "path": "spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/provisioning/PubSubChannelProvisioner.java", "diffHunk": "@@ -118,7 +120,11 @@ private Topic makeSureTopicExists(String topicName, boolean autoCreate) {\n \t\tTopic topic = this.pubSubAdmin.getTopic(topicName);\n \t\tif (topic == null) {\n \t\t\tif (autoCreate) {\n-\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\ttry {\n+\t\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\t} catch(AlreadyExistsException alreadyExistsException) {\n+\t\t\t\t\t// Ignore concurrent topic creation - we're good as long as topic was created and exists", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657298e59554874a4a063b5ad9f5ef6f3c78a462"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg1OTgwNQ==", "bodyText": "Sure", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#discussion_r433859805", "createdAt": "2020-06-02T13:07:13Z", "author": {"login": "mvmn"}, "path": "spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/provisioning/PubSubChannelProvisioner.java", "diffHunk": "@@ -118,7 +120,11 @@ private Topic makeSureTopicExists(String topicName, boolean autoCreate) {\n \t\tTopic topic = this.pubSubAdmin.getTopic(topicName);\n \t\tif (topic == null) {\n \t\t\tif (autoCreate) {\n-\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\ttry {\n+\t\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\t} catch(AlreadyExistsException alreadyExistsException) {\n+\t\t\t\t\t// Ignore concurrent topic creation - we're good as long as topic was created and exists", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0OTAzNg=="}, "originalCommit": {"oid": "657298e59554874a4a063b5ad9f5ef6f3c78a462"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg4NTY1Ng==", "bodyText": "Why warning level if it's not a real issue?\nI would go with DEBUG, or at most INFO.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#discussion_r433885656", "createdAt": "2020-06-02T13:44:07Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/provisioning/PubSubChannelProvisioner.java", "diffHunk": "@@ -118,7 +120,11 @@ private Topic makeSureTopicExists(String topicName, boolean autoCreate) {\n \t\tTopic topic = this.pubSubAdmin.getTopic(topicName);\n \t\tif (topic == null) {\n \t\t\tif (autoCreate) {\n-\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\ttry {\n+\t\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\t} catch(AlreadyExistsException alreadyExistsException) {\n+\t\t\t\t\t// Ignore concurrent topic creation - we're good as long as topic was created and exists", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0OTAzNg=="}, "originalCommit": {"oid": "657298e59554874a4a063b5ad9f5ef6f3c78a462"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkwNDg4NA==", "bodyText": "Changed level to INFO according to @elefeint comment", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#discussion_r433904884", "createdAt": "2020-06-02T14:07:15Z", "author": {"login": "mvmn"}, "path": "spring-cloud-gcp-pubsub-stream-binder/src/main/java/org/springframework/cloud/gcp/stream/binder/pubsub/provisioning/PubSubChannelProvisioner.java", "diffHunk": "@@ -118,7 +120,11 @@ private Topic makeSureTopicExists(String topicName, boolean autoCreate) {\n \t\tTopic topic = this.pubSubAdmin.getTopic(topicName);\n \t\tif (topic == null) {\n \t\t\tif (autoCreate) {\n-\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\ttry {\n+\t\t\t\t\ttopic = this.pubSubAdmin.createTopic(topicName);\n+\t\t\t\t} catch(AlreadyExistsException alreadyExistsException) {\n+\t\t\t\t\t// Ignore concurrent topic creation - we're good as long as topic was created and exists", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0OTAzNg=="}, "originalCommit": {"oid": "657298e59554874a4a063b5ad9f5ef6f3c78a462"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMzA2NzYyOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-pubsub-stream-binder/src/test/java/org/springframework/cloud/gcp/stream/binder/pubsub/provisioning/PubSubChannelProvisionerTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNTowMDowNVrOGd11mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNTowMjowOVrOGd17lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk0Mzk2Mg==", "bodyText": "Extreme nit: replace \"non_existing_topic\" with \"already_existing_topic\".", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#discussion_r433943962", "createdAt": "2020-06-02T15:00:05Z", "author": {"login": "elefeint"}, "path": "spring-cloud-gcp-pubsub-stream-binder/src/test/java/org/springframework/cloud/gcp/stream/binder/pubsub/provisioning/PubSubChannelProvisionerTests.java", "diffHunk": "@@ -176,4 +177,14 @@ public void testAfterUnbindConsumer_nonAnonymous() {\n \n \t\tverify(this.pubSubAdminMock, never()).deleteSubscription(result.getName());\n \t}\n+\n+\t@Test\n+\tpublic void testProvisionConsumerDestination_concurrentTopicCreation() {\n+\t\twhen(this.pubSubAdminMock.createTopic(any())).thenThrow(AlreadyExistsException.class);\n+\t\twhen(this.pubSubAdminMock.getTopic(eq(\"non_existing_topic\"))).thenReturn(null);\n+\n+\t\t// Ensure no exceptions occur if topic already exists on create call\n+\t\tthis.pubSubChannelProvisioner\n+\t\t\t\t.provisionConsumerDestination(\"non_existing_topic\", \"group1\", this.properties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e51fdf8d965ed03dc4ece907c2006a2607e88b2"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk0NTQ5NA==", "bodyText": "Done", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2411#discussion_r433945494", "createdAt": "2020-06-02T15:02:09Z", "author": {"login": "mvmn"}, "path": "spring-cloud-gcp-pubsub-stream-binder/src/test/java/org/springframework/cloud/gcp/stream/binder/pubsub/provisioning/PubSubChannelProvisionerTests.java", "diffHunk": "@@ -176,4 +177,14 @@ public void testAfterUnbindConsumer_nonAnonymous() {\n \n \t\tverify(this.pubSubAdminMock, never()).deleteSubscription(result.getName());\n \t}\n+\n+\t@Test\n+\tpublic void testProvisionConsumerDestination_concurrentTopicCreation() {\n+\t\twhen(this.pubSubAdminMock.createTopic(any())).thenThrow(AlreadyExistsException.class);\n+\t\twhen(this.pubSubAdminMock.getTopic(eq(\"non_existing_topic\"))).thenReturn(null);\n+\n+\t\t// Ensure no exceptions occur if topic already exists on create call\n+\t\tthis.pubSubChannelProvisioner\n+\t\t\t\t.provisionConsumerDestination(\"non_existing_topic\", \"group1\", this.properties);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk0Mzk2Mg=="}, "originalCommit": {"oid": "6e51fdf8d965ed03dc4ece907c2006a2607e88b2"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2143, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}