{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNTYwNjg4", "number": 2307, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTo1OToyN1rODvzgUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOToyOTowNFrODwIkjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDUzNTIxOnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTo1OToyN1rOGCcWGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo0MjowN1rOGDALWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxNDc0NA==", "bodyText": "is this instanceof still needed? The newly parameterized List<OrPart> assumes the type.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2307#discussion_r405214744", "createdAt": "2020-04-08T01:59:27Z", "author": {"login": "elefeint"}, "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -117,7 +118,7 @@ private void validateAndSetFilterParts() {\n \t\t\t\t\t\"Cloud Datastore structured queries do not support the Distinct keyword.\");\n \t\t}\n \n-\t\tList parts = this.tree.get().collect(Collectors.toList());\n+\t\tList<OrPart> parts = this.tree.get().collect(Collectors.toList());\n \t\tif (parts.size() > 0) {\n \t\t\tif (parts.get(0) instanceof OrPart && parts.size() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cbbc0935670b80eee9e76226066aa6cce55088a"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwMTgxNw==", "bodyText": "good point!", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2307#discussion_r405801817", "createdAt": "2020-04-08T20:42:07Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -117,7 +118,7 @@ private void validateAndSetFilterParts() {\n \t\t\t\t\t\"Cloud Datastore structured queries do not support the Distinct keyword.\");\n \t\t}\n \n-\t\tList parts = this.tree.get().collect(Collectors.toList());\n+\t\tList<OrPart> parts = this.tree.get().collect(Collectors.toList());\n \t\tif (parts.size() > 0) {\n \t\t\tif (parts.get(0) instanceof OrPart && parts.size() > 1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxNDc0NA=="}, "originalCommit": {"oid": "5cbbc0935670b80eee9e76226066aa6cce55088a"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDU0NzU3OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMjowNzowNlrOGCcd4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo1NTo0NlrOGDAo5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxNjczOA==", "bodyText": "Will this be easier to read as a helper method?\n.map(this::findProperty)", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2307#discussion_r405216738", "createdAt": "2020-04-08T02:07:06Z", "author": {"login": "elefeint"}, "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -319,11 +320,20 @@ else if (pageable instanceof DatastorePageable) {\n \tprivate void applySelectWithFilter(Object[] parameters, Builder builder) {\n \t\tIterator it = Arrays.asList(parameters).iterator();\n \t\tFilter[] filters = this.filterParts.stream().map((part) -> {\n-\t\t\tDatastorePersistentProperty persistentProperty = (DatastorePersistentProperty) this.datastorePersistentEntity\n-\t\t\t\t\t.getPersistentProperty(part.getProperty().getSegment());\n+\t\t\tIterable<PropertyPath> iterable = () -> part.getProperty().iterator();\n+\t\t\tList<DatastorePersistentProperty> properties =\n+\t\t\t\t\tStreamSupport.stream(iterable.spliterator(), false)\n+\t\t\t\t\t.map(propertyPath -> {\n+\t\t\t\t\t\tDatastorePersistentEntity<?> persistentEntity =\n+\t\t\t\t\t\t\t\tthis.datastoreMappingContext.getPersistentEntity(propertyPath.getOwningType());\n+\t\t\t\t\t\treturn persistentEntity.getPersistentProperty(propertyPath.getSegment());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cbbc0935670b80eee9e76226066aa6cce55088a"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwOTM4Mg==", "bodyText": "refactored", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2307#discussion_r405809382", "createdAt": "2020-04-08T20:55:46Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -319,11 +320,20 @@ else if (pageable instanceof DatastorePageable) {\n \tprivate void applySelectWithFilter(Object[] parameters, Builder builder) {\n \t\tIterator it = Arrays.asList(parameters).iterator();\n \t\tFilter[] filters = this.filterParts.stream().map((part) -> {\n-\t\t\tDatastorePersistentProperty persistentProperty = (DatastorePersistentProperty) this.datastorePersistentEntity\n-\t\t\t\t\t.getPersistentProperty(part.getProperty().getSegment());\n+\t\t\tIterable<PropertyPath> iterable = () -> part.getProperty().iterator();\n+\t\t\tList<DatastorePersistentProperty> properties =\n+\t\t\t\t\tStreamSupport.stream(iterable.spliterator(), false)\n+\t\t\t\t\t.map(propertyPath -> {\n+\t\t\t\t\t\tDatastorePersistentEntity<?> persistentEntity =\n+\t\t\t\t\t\t\t\tthis.datastoreMappingContext.getPersistentEntity(propertyPath.getOwningType());\n+\t\t\t\t\t\treturn persistentEntity.getPersistentProperty(propertyPath.getSegment());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxNjczOA=="}, "originalCommit": {"oid": "5cbbc0935670b80eee9e76226066aa6cce55088a"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDU1MjA4OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMjowOToyMFrOGCcgcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo1OTo1N1rOGDAyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxNzM5NA==", "bodyText": "Is there possibility of property name clashes if parent class and child class both have a property named, say, name?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2307#discussion_r405217394", "createdAt": "2020-04-08T02:09:20Z", "author": {"login": "elefeint"}, "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -335,9 +345,9 @@ private void applySelectWithFilter(Object[] parameters, Builder builder) {\n \t\t\t\t\t\t\"Too few parameters are provided for query method: \" + getQueryMethod().getName());\n \t\t\t}\n \n-\t\t\tValue convertedValue = convertParam(persistentProperty, it.next());\n+\t\t\tValue convertedValue = convertParam(properties.get(properties.size() - 1), it.next());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cbbc0935670b80eee9e76226066aa6cce55088a"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMTc2Nw==", "bodyText": "In general that would be resolved appropriately, but there is a way to disambiguate using \"_\" as a nested properties separator.", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2307#discussion_r405811767", "createdAt": "2020-04-08T20:59:57Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -335,9 +345,9 @@ private void applySelectWithFilter(Object[] parameters, Builder builder) {\n \t\t\t\t\t\t\"Too few parameters are provided for query method: \" + getQueryMethod().getName());\n \t\t\t}\n \n-\t\t\tValue convertedValue = convertParam(persistentProperty, it.next());\n+\t\t\tValue convertedValue = convertParam(properties.get(properties.size() - 1), it.next());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxNzM5NA=="}, "originalCommit": {"oid": "5cbbc0935670b80eee9e76226066aa6cce55088a"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzk3OTU4OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOToyNjo1OVrOGC9sNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo1NzozOFrOGDAs9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2MTA3OA==", "bodyText": "In Firestore you call the method getPropertyName but here it's getFieldName. Is it too late to make them consistent?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2307#discussion_r405761078", "createdAt": "2020-04-08T19:26:59Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -319,11 +320,20 @@ else if (pageable instanceof DatastorePageable) {\n \tprivate void applySelectWithFilter(Object[] parameters, Builder builder) {\n \t\tIterator it = Arrays.asList(parameters).iterator();\n \t\tFilter[] filters = this.filterParts.stream().map((part) -> {\n-\t\t\tDatastorePersistentProperty persistentProperty = (DatastorePersistentProperty) this.datastorePersistentEntity\n-\t\t\t\t\t.getPersistentProperty(part.getProperty().getSegment());\n+\t\t\tIterable<PropertyPath> iterable = () -> part.getProperty().iterator();\n+\t\t\tList<DatastorePersistentProperty> properties =\n+\t\t\t\t\tStreamSupport.stream(iterable.spliterator(), false)\n+\t\t\t\t\t.map(propertyPath -> {\n+\t\t\t\t\t\tDatastorePersistentEntity<?> persistentEntity =\n+\t\t\t\t\t\t\t\tthis.datastoreMappingContext.getPersistentEntity(propertyPath.getOwningType());\n+\t\t\t\t\t\treturn persistentEntity.getPersistentProperty(propertyPath.getSegment());\n+\t\t\t\t\t}).collect(Collectors.toList());\n+\n+\t\t\tString fieldName = properties.stream().map(DatastorePersistentProperty::getFieldName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cbbc0935670b80eee9e76226066aa6cce55088a"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMDQyMg==", "bodyText": "renamed the method from Firestore", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2307#discussion_r405810422", "createdAt": "2020-04-08T20:57:38Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -319,11 +320,20 @@ else if (pageable instanceof DatastorePageable) {\n \tprivate void applySelectWithFilter(Object[] parameters, Builder builder) {\n \t\tIterator it = Arrays.asList(parameters).iterator();\n \t\tFilter[] filters = this.filterParts.stream().map((part) -> {\n-\t\t\tDatastorePersistentProperty persistentProperty = (DatastorePersistentProperty) this.datastorePersistentEntity\n-\t\t\t\t\t.getPersistentProperty(part.getProperty().getSegment());\n+\t\t\tIterable<PropertyPath> iterable = () -> part.getProperty().iterator();\n+\t\t\tList<DatastorePersistentProperty> properties =\n+\t\t\t\t\tStreamSupport.stream(iterable.spliterator(), false)\n+\t\t\t\t\t.map(propertyPath -> {\n+\t\t\t\t\t\tDatastorePersistentEntity<?> persistentEntity =\n+\t\t\t\t\t\t\t\tthis.datastoreMappingContext.getPersistentEntity(propertyPath.getOwningType());\n+\t\t\t\t\t\treturn persistentEntity.getPersistentProperty(propertyPath.getSegment());\n+\t\t\t\t\t}).collect(Collectors.toList());\n+\n+\t\t\tString fieldName = properties.stream().map(DatastorePersistentProperty::getFieldName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2MTA3OA=="}, "originalCommit": {"oid": "5cbbc0935670b80eee9e76226066aa6cce55088a"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzk4NjY5OnYy", "diffSide": "RIGHT", "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOToyOTowNFrOGC9wpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo0Mzo0N1rOGDAPFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2MjIxNA==", "bodyText": "Put this block into a separate helper private method buildName like you did for Firestore?", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2307#discussion_r405762214", "createdAt": "2020-04-08T19:29:04Z", "author": {"login": "meltsufin"}, "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -319,11 +320,20 @@ else if (pageable instanceof DatastorePageable) {\n \tprivate void applySelectWithFilter(Object[] parameters, Builder builder) {\n \t\tIterator it = Arrays.asList(parameters).iterator();\n \t\tFilter[] filters = this.filterParts.stream().map((part) -> {\n-\t\t\tDatastorePersistentProperty persistentProperty = (DatastorePersistentProperty) this.datastorePersistentEntity\n-\t\t\t\t\t.getPersistentProperty(part.getProperty().getSegment());\n+\t\t\tIterable<PropertyPath> iterable = () -> part.getProperty().iterator();\n+\t\t\tList<DatastorePersistentProperty> properties =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cbbc0935670b80eee9e76226066aa6cce55088a"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwMjc3Mw==", "bodyText": "here we need not only the name, but also the persistent property", "url": "https://github.com/spring-cloud/spring-cloud-gcp/pull/2307#discussion_r405802773", "createdAt": "2020-04-08T20:43:47Z", "author": {"login": "dmitry-s"}, "path": "spring-cloud-gcp-data-datastore/src/main/java/org/springframework/cloud/gcp/data/datastore/repository/query/PartTreeDatastoreQuery.java", "diffHunk": "@@ -319,11 +320,20 @@ else if (pageable instanceof DatastorePageable) {\n \tprivate void applySelectWithFilter(Object[] parameters, Builder builder) {\n \t\tIterator it = Arrays.asList(parameters).iterator();\n \t\tFilter[] filters = this.filterParts.stream().map((part) -> {\n-\t\t\tDatastorePersistentProperty persistentProperty = (DatastorePersistentProperty) this.datastorePersistentEntity\n-\t\t\t\t\t.getPersistentProperty(part.getProperty().getSegment());\n+\t\t\tIterable<PropertyPath> iterable = () -> part.getProperty().iterator();\n+\t\t\tList<DatastorePersistentProperty> properties =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2MjIxNA=="}, "originalCommit": {"oid": "5cbbc0935670b80eee9e76226066aa6cce55088a"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2346, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}