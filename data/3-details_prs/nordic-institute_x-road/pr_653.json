{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4ODgxNjkw", "number": 653, "title": "XRDDEV-1268", "bodyText": "Fix error that caused alerts endpoint (GET /api/v1/notifications/alerts) to return HTTP 500 when connection to signer fails.\nAdd two new properties to Alerts endpoint: global_conf_valid_check_success and soft_token_pin_entered_check_success. After the update Alerts endpoint's response is:\n{\n  \"global_conf_valid\":true,\n  \"global_conf_valid_check_success\": true,\n  \"soft_token_pin_entered\":true,\n  \"soft_token_pin_entered_check_success\":true\n}\n\nThe _check_success properties indicate whether the check was successful and whether global_conf_valid / soft_token_pin_entered tell the real status. When _check_success property is true, we know that the current status is correct. When _check_success property is false, we know that the check failed and we cannot be sure what\u2019s the current status.\nFor example, connection to signer fails:\n{\n   \"global_conf_valid\":true,\n   \"global_conf_valid_check_success\":true,\n   \"soft_token_pin_entered\":false,\n   \"soft_token_pin_entered_check_success\":false\n}\n\nFor example, connection to signer succeeds, but PIN code has not been entered:\n{\n   \"global_conf_valid\":true,\n   \"global_conf_valid_check_success\":true,\n   \"soft_token_pin_entered\":false,\n   \"soft_token_pin_entered_check_success\":true\n}\n\nBackground information: https://niis.slack.com/archives/GGBHVCYSY/p1597732119019400?thread_ts=1597402894.008800&cid=GGBHVCYSY\nJIRA issue: https://jira.niis.org/browse/XRDDEV-1268", "createdAt": "2020-08-17T14:50:34Z", "url": "https://github.com/nordic-institute/X-Road/pull/653", "merged": true, "mergeCommit": {"oid": "9a0f48369900e44c34504e55616fe26502064fc2"}, "closed": true, "closedAt": "2020-08-19T13:25:08Z", "author": {"login": "petkivim"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_zUgWAH2gAyNDY4ODgxNjkwOjQyNWQ3MThjYzM1Yzk3YTlhYjQyMDM3MTM4NGE5YzE1NTNjN2NkZGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAbk3EAFqTQ3MDQ1MzM5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "425d718cc35c97a9ab420371384a9c1553c7cddb", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/425d718cc35c97a9ab420371384a9c1553c7cddb", "committedDate": "2020-08-17T14:30:52Z", "message": "XRDDEV-1268 Add exception handling to methods that access signer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "828cf68ba5de8ae2591419f76e1a6a4d53aed592", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/828cf68ba5de8ae2591419f76e1a6a4d53aed592", "committedDate": "2020-08-17T14:48:50Z", "message": "XRDDEV-1268 Fix failing unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4e3c90425e26ed6f4f93f4b59ea96106c1519e2", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/f4e3c90425e26ed6f4f93f4b59ea96106c1519e2", "committedDate": "2020-08-17T15:14:56Z", "message": "XRDDEV-1268 Remove package lock file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "418907469de43d3cb96160af0f587c5c386b32de", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/418907469de43d3cb96160af0f587c5c386b32de", "committedDate": "2020-08-17T15:22:05Z", "message": "XRDDEV-1268 Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e5399d38770c2a41f23aaf1cc44410cfb70f088", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/1e5399d38770c2a41f23aaf1cc44410cfb70f088", "committedDate": "2020-08-17T15:29:59Z", "message": "XRDDEV-1268 Refactor implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af0b4e72e4dcf5da615b3ed196ad75860870f5d3", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/af0b4e72e4dcf5da615b3ed196ad75860870f5d3", "committedDate": "2020-08-17T15:49:46Z", "message": "XRDDEV-1268 Add logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "defff3e37a152efa2de953fef116c36a0e64ef16", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/defff3e37a152efa2de953fef116c36a0e64ef16", "committedDate": "2020-08-18T05:46:34Z", "message": "XRDDEV-1268 Refactor implementation\n\n- Remove @Transactional annotial from NotificationService.\n- Remove isSecurityServerFullyInitialized check from Notification service.\n- Update unit tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/9367172506d97e5b4033ce9de6bf0f6f2ebb654b", "committedDate": "2020-08-18T08:16:13Z", "message": "XRDDEV-1268 Add new properties to Alerts endpoint\n\n- Add new global_conf_valid_check_success property that indicates whether global conf validity check succeeded.\n- Add new soft_token_pin_entered_check_success property that indicates whether soft token pin entered check succeeded.\n- Update unit tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTA0MzQ0", "url": "https://github.com/nordic-institute/X-Road/pull/653#pullrequestreview-469504344", "createdAt": "2020-08-18T14:20:45Z", "commit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDoyMDo0NVrOHCW5Qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDo0Njo1NFrOHCYG8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIzNDMwNw==", "bodyText": "This method now never returns false, since globalConfFacade.verifyValidity either returns true or throws CodedException?\na private boolean isGlobalConfValid that either returns true or throws exception is pretty nonstandard for a Java method, would be better to return true/false in un-exceptional cases. Maybe the old implementation was better after all?\nI may have posted misleading comments in the slack thread I guess the implementation should then inspect the exception to distinguish which case it is , as it looks like the implementation already did that (well, it did not inspect the error code vs X_OUTDATED_GLOBALCONF, so it was not completely flawless)?", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472234307", "createdAt": "2020-08-18T14:20:45Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -79,35 +73,35 @@ public AlertStatus getAlerts() {\n             alertStatus.setBackupRestoreRunningSince(backupRestoreStartedAt);\n             alertStatus.setCurrentTime(OffsetDateTime.now(ZoneOffset.UTC));\n         }\n-        if (isSecurityServerFullyInitialized()) {\n+\n+        try {\n             alertStatus.setGlobalConfValid(isGlobalConfValid());\n-            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n-        } else {\n+            alertStatus.setGlobalConfValidCheckSuccess(true);\n+        } catch (CodedException e) {\n+            log.error(\"getting global conf status failed\");\n             alertStatus.setGlobalConfValid(false);\n+            alertStatus.setGlobalConfValidCheckSuccess(false);\n+        }\n+\n+        try {\n+            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n+            alertStatus.setSoftTokenPinEnteredCheckSuccess(true);\n+        } catch (Exception e) {\n+            log.error(\"getting soft token pin status failed\");\n             alertStatus.setSoftTokenPinEntered(false);\n+            alertStatus.setSoftTokenPinEnteredCheckSuccess(false);\n         }\n-        return alertStatus;\n-    }\n \n-    private boolean isSecurityServerFullyInitialized() {\n-        InitializationStatusDto initStatusDto = initializationService.getSecurityServerInitializationStatus();\n-        return initStatusDto.isAnchorImported()\n-                && initStatusDto.isServerCodeInitialized()\n-                && initStatusDto.isServerOwnerInitialized()\n-                && initStatusDto.isSoftwareTokenInitialized();\n+        return alertStatus;\n     }\n \n     /**\n      * Verifies that the global configuration is valid.\n      * @return\n      */\n     private boolean isGlobalConfValid() {\n-        try {\n-            globalConfFacade.verifyValidity();\n-            return true;\n-        } catch (CodedException e) {\n-            return false;\n-        }\n+        globalConfFacade.verifyValidity();\n+        return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIzODY1Mw==", "bodyText": "Should we just setSoftTokenPinEnteredCheckSuccess(false) if we know that backup restore is running? Since doing isSoftTokenPinEntered will likely fail doing restore, and possibly cause the \"could not list all tokens\" error to appear with some delay?", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472238653", "createdAt": "2020-08-18T14:26:47Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -79,35 +73,35 @@ public AlertStatus getAlerts() {\n             alertStatus.setBackupRestoreRunningSince(backupRestoreStartedAt);\n             alertStatus.setCurrentTime(OffsetDateTime.now(ZoneOffset.UTC));\n         }\n-        if (isSecurityServerFullyInitialized()) {\n+\n+        try {\n             alertStatus.setGlobalConfValid(isGlobalConfValid());\n-            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n-        } else {\n+            alertStatus.setGlobalConfValidCheckSuccess(true);\n+        } catch (CodedException e) {\n+            log.error(\"getting global conf status failed\");\n             alertStatus.setGlobalConfValid(false);\n+            alertStatus.setGlobalConfValidCheckSuccess(false);\n+        }\n+\n+        try {\n+            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0OTQwMg==", "bodyText": "Could just catch any Exception, probably only CodedExceptions should occur now, but we might not have realized a possibility of some other exceptions like RuntimeExceptions or some future changes may make that possible - and we probably want those to also result in setGlobalConfValidCheckSuccess(false)?", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472249402", "createdAt": "2020-08-18T14:40:53Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -79,35 +73,35 @@ public AlertStatus getAlerts() {\n             alertStatus.setBackupRestoreRunningSince(backupRestoreStartedAt);\n             alertStatus.setCurrentTime(OffsetDateTime.now(ZoneOffset.UTC));\n         }\n-        if (isSecurityServerFullyInitialized()) {\n+\n+        try {\n             alertStatus.setGlobalConfValid(isGlobalConfValid());\n-            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n-        } else {\n+            alertStatus.setGlobalConfValidCheckSuccess(true);\n+        } catch (CodedException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI1NDE5Mg==", "bodyText": "If alerts are disabled, the status of all alerts true.\n\nIs this comment up to date? Does \"alerts are disabled\" refer to backupRestoreRunningSince?", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472254192", "createdAt": "2020-08-18T14:46:54Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -47,23 +45,19 @@\n  */\n @Slf4j\n @Service\n-@Transactional\n @PreAuthorize(\"isAuthenticated()\")\n public class NotificationService {\n     private OffsetDateTime backupRestoreRunningSince;\n     private final GlobalConfFacade globalConfFacade;\n     private final TokenService tokenService;\n-    private final InitializationService initializationService;\n \n     /**\n      * constructor\n      */\n     @Autowired\n-    public NotificationService(GlobalConfFacade globalConfFacade, TokenService tokenService,\n-            InitializationService initializationService) {\n+    public NotificationService(GlobalConfFacade globalConfFacade, TokenService tokenService) {\n         this.globalConfFacade = globalConfFacade;\n         this.tokenService = tokenService;\n-        this.initializationService = initializationService;\n     }\n \n     /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec1ca74b2ef14c0023a95fb2bcd35d4e96b9a57f", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/ec1ca74b2ef14c0023a95fb2bcd35d4e96b9a57f", "committedDate": "2020-08-19T04:34:41Z", "message": "XRDDEV-1269 Update implementation based on review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90544875569e813d78d7875d66c0b7f5e932fad7", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/90544875569e813d78d7875d66c0b7f5e932fad7", "committedDate": "2020-08-19T04:37:22Z", "message": "XRDDEV-1269 Update unit test name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1233f5dab3db599556037b065f70dad0fa841ba2", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/1233f5dab3db599556037b065f70dad0fa841ba2", "committedDate": "2020-08-19T05:16:30Z", "message": "XRDDEV-1269 Update unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNDUzMzkx", "url": "https://github.com/nordic-institute/X-Road/pull/653#pullrequestreview-470453391", "createdAt": "2020-08-19T13:24:56Z", "commit": {"oid": "1233f5dab3db599556037b065f70dad0fa841ba2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4058, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}