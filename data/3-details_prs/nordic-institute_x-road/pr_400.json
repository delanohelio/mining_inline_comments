{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNDE0ODQ1", "number": 400, "title": "XRDDEV-866 delete client", "bodyText": "Do not merge before #380\nAdds endpoints for client delete\n\nDELETE /clients/{id}\nGET /clients/{id}/orphans\nDELETE /clients/{id}/orphans", "createdAt": "2020-03-02T14:27:39Z", "url": "https://github.com/nordic-institute/X-Road/pull/400", "merged": true, "mergeCommit": {"oid": "625bda004f6efe402c5d27d44c1f24dc3cd11c4c"}, "closed": true, "closedAt": "2020-03-11T11:10:48Z", "author": {"login": "jansu76"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcF8fQigH2gAyMzgyNDE0ODQ1OjIzOWU5YWUyMDc5ZTc3NTczOWUzMzkzZWNiN2E5ZmEwYmE0Y2I5MmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMkbTtgH2gAyMzgyNDE0ODQ1OmIzODQwNGFmZTljYmExMDhkZDZkY2JlODc1MDI2ZGM2NjkxNTgxMzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "239e9ae2079e775739e3393ecb7a9fa0ba4cb92b", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/239e9ae2079e775739e3393ecb7a9fa0ba4cb92b", "committedDate": "2020-02-19T20:24:09Z", "message": "XRDDEV-866 add service skeletons"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54ebcec4e3ef07a20d8a878ab1a7ee4cc02e6a9a", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/54ebcec4e3ef07a20d8a878ab1a7ee4cc02e6a9a", "committedDate": "2020-02-20T14:53:14Z", "message": "XRDDEV-866 api design and implement failing (ignored) tests for deleteClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3e14603719b3837fde5933268ef1afab331c262", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/e3e14603719b3837fde5933268ef1afab331c262", "committedDate": "2020-02-20T20:19:53Z", "message": "XRDDEV-866 implement clientService.deleteLocalClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70b31094b1d5ab1178a29509b1635e229cb17f66", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/70b31094b1d5ab1178a29509b1635e229cb17f66", "committedDate": "2020-02-21T07:06:37Z", "message": "XRDDEV-866 add tests and impementation for orphansExists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02a2bfe723c6bdeb4085afa405029b6f2af0f675", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/02a2bfe723c6bdeb4085afa405029b6f2af0f675", "committedDate": "2020-02-21T07:09:26Z", "message": "XRDDEV-866 fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f7ed5b972995b2fb0e5fa2197979402aab06902", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/5f7ed5b972995b2fb0e5fa2197979402aab06902", "committedDate": "2020-02-24T11:15:06Z", "message": "XRDDEV-866 implement deleteOrphans, make tests pass"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc3752af4423f5b37a1a2802d456ae2c9eaa3410", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/fc3752af4423f5b37a1a2802d456ae2c9eaa3410", "committedDate": "2020-02-24T11:47:14Z", "message": "XRDDEV-866 mock signerFacade instead of tokenService, fix mockito verifications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa06ff713063d0e89c5c9b342083582dc1b60115", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/fa06ff713063d0e89c5c9b342083582dc1b60115", "committedDate": "2020-03-02T07:27:07Z", "message": "XRDDEV-866 add controller method and test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f571efac67a803d41249d095c159f37bc43f260d", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/f571efac67a803d41249d095c159f37bc43f260d", "committedDate": "2020-03-02T13:39:49Z", "message": "XRDDEV-866 add orphan controller endpoints and tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e08499c342bb5879dc849b073e850cf4d9ceea3", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/6e08499c342bb5879dc849b073e850cf4d9ceea3", "committedDate": "2020-03-02T14:24:30Z", "message": "Merge branch 'XRDDEV-860-add-client' into XRDDEV-866-delete-client\n\nFix Conflicts:\n\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/ClientServiceIntegrationTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89d0d9b66625dc45e5e0a7f5aede8eade2029627", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/89d0d9b66625dc45e5e0a7f5aede8eade2029627", "committedDate": "2020-03-09T09:50:04Z", "message": "Merge branch 'develop' into XRDDEV-866-delete-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05947f12d36847cecbd4d6bf239262019c8ed6bb", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/05947f12d36847cecbd4d6bf239262019c8ed6bb", "committedDate": "2020-03-09T13:51:32Z", "message": "Merge branch 'develop' into XRDDEV-866-delete-client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNzYwNzM4", "url": "https://github.com/nordic-institute/X-Road/pull/400#pullrequestreview-371760738", "createdAt": "2020-03-10T08:41:54Z", "commit": {"oid": "05947f12d36847cecbd4d6bf239262019c8ed6bb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwODo0MTo1NFrOF0FjKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMToxMjo0NFrOF0KiMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE2MTE5Mw==", "bodyText": "Javadocs missing ClientNotFoundException", "url": "https://github.com/nordic-institute/X-Road/pull/400#discussion_r390161193", "createdAt": "2020-03-10T08:41:54Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -560,6 +565,43 @@ private ClientId getPossiblyManagedEntity(ClientId transientClientId) {\n         }\n     }\n \n+    /**\n+     * Delete a local client.\n+     * @param clientId\n+     * @throws ActionNotPossibleException if client status did not allow delete\n+     * @throws CannotDeleteOwnerException if attempted to delete the owner\n+     */\n+    public void deleteLocalClient(ClientId clientId) throws ActionNotPossibleException,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05947f12d36847cecbd4d6bf239262019c8ed6bb"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI0Mjg2Ng==", "bodyText": "This is probably intentionally a non-atomic operation? Just wondering what happens in a case where some certs are deleted and some are not because in the middle of the deletion process a wild CertificateNotFoundException appears?\nIn the case of removing orphans that shouldn't happen since the certs are not actually provided by the user. This is probably something to be looked more into if we ever need an API endpoint supporting the deletion of multiple certificates.", "url": "https://github.com/nordic-institute/X-Road/pull/400#discussion_r390242866", "createdAt": "2020-03-10T11:12:44Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenCertificateService.java", "diffHunk": "@@ -744,6 +746,35 @@ static boolean isCausedByCertNotFound(CodedException e) {\n         return possibleActions;\n     }\n \n+    /**\n+     * Deletes a collection of certificates\n+     * @throws CertificateNotFoundException if certificate with given hash was not found\n+     * @throws ActionNotPossibleException if delete was not possible due to cert/key/token states\n+     */\n+    public void deleteCertificates(List<CertificateInfo> certificateInfos)\n+            throws CertificateNotFoundException, ActionNotPossibleException {\n+        List<TokenInfo> tokenInfos = tokenService.getAllTokens();\n+        for (CertificateInfo certificateInfo: certificateInfos) {\n+            deleteCertificate(certificateInfo.getId(), tokenInfos);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05947f12d36847cecbd4d6bf239262019c8ed6bb"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "331a4e6875eb2591ee1183f25c8b5fc50a525e74", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/331a4e6875eb2591ee1183f25c8b5fc50a525e74", "committedDate": "2020-03-10T13:14:18Z", "message": "XRDDEV-866 update javadocs based on PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNjI4MzI0", "url": "https://github.com/nordic-institute/X-Road/pull/400#pullrequestreview-372628324", "createdAt": "2020-03-11T10:18:42Z", "commit": {"oid": "331a4e6875eb2591ee1183f25c8b5fc50a525e74"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b38404afe9cba108dd6dcbe875026dc669158131", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/b38404afe9cba108dd6dcbe875026dc669158131", "committedDate": "2020-03-11T10:19:35Z", "message": "Merge branch 'develop' into XRDDEV-866-delete-client"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4352, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}