{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3MjY5MjQ4", "number": 472, "title": "XRDDEV-17 certificate validate", "bodyText": "", "createdAt": "2020-04-22T12:50:12Z", "url": "https://github.com/nordic-institute/X-Road/pull/472", "merged": true, "mergeCommit": {"oid": "2a60fcc2b7ab5484583d80a3d18a28bfb25bd183"}, "closed": true, "closedAt": "2020-05-05T06:36:50Z", "author": {"login": "martensoo"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaHVo2gH2gAyNDA3MjY5MjQ4OjUzOGZiYTI3MGFmODhlZTU0MDAyMDdlZTM2ZmJlMjQyYjU3NzM5MDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceOMyfgFqTQwNTUyMzY2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "538fba270af88ee5400207ee36fbe242b5773909", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/538fba270af88ee5400207ee36fbe242b5773909", "committedDate": "2020-04-22T12:21:05Z", "message": "XRDDEV-17 validate cert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be9f7a97a340d3d1bfd41083083ce86c4c65a4f4", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/be9f7a97a340d3d1bfd41083083ce86c4c65a4f4", "committedDate": "2020-04-22T12:43:17Z", "message": "validation of cert"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NjY5NTc3", "url": "https://github.com/nordic-institute/X-Road/pull/472#pullrequestreview-399669577", "createdAt": "2020-04-24T06:23:50Z", "commit": {"oid": "be9f7a97a340d3d1bfd41083083ce86c4c65a4f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwNjoyMzo1MFrOGLIY0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwNjoyMzo1MFrOGLIY0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyNDk0Ng==", "bodyText": "Since the original isCerts.contains(auth.getCert()) already verifies that the cert is one of the IS certs, iterating the list is unnecessary. One could after that test safely check the validity of the received certificate (auth.getCert().checkValidity()).\nI'd also argue that it would be more readable (and perhaps a bit more efficient) than using a stream.", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r414324946", "createdAt": "2020-04-24T06:23:50Z", "author": {"login": "jhyoty"}, "path": "src/serverconf/src/main/java/ee/ria/xroad/common/conf/serverconf/IsAuthentication.java", "diffHunk": "@@ -90,10 +93,18 @@ public static void verifyClientAuthentication(ClientId client,\n                         \"Client (%s) has no IS certificates\", client);\n             }\n \n-            if (!isCerts.contains(auth.getCert())) {\n-                throw new CodedException(X_SSL_AUTH_FAILED,\n-                        \"Client (%s) TLS certificate does not match any\"\n-                                + \" IS certificates\", client);\n+            X509Certificate isCert = isCerts.stream()\n+                    .filter(c -> Objects.equals(c, auth.getCert()))\n+                    .findFirst()\n+                    .orElseThrow(() -> new CodedException(X_SSL_AUTH_FAILED,\n+                    \"Client (%s) TLS certificate does not match any\"\n+                                    + \" IS certificates\", client));\n+            try {\n+                isCert.checkValidity();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be9f7a97a340d3d1bfd41083083ce86c4c65a4f4"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "101740ce8655ec75b8932dab9d55fe5b3f78f337", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/101740ce8655ec75b8932dab9d55fe5b3f78f337", "committedDate": "2020-04-24T08:51:48Z", "message": "XRDDEV-17 refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODMwMTE4", "url": "https://github.com/nordic-institute/X-Road/pull/472#pullrequestreview-399830118", "createdAt": "2020-04-24T10:33:08Z", "commit": {"oid": "101740ce8655ec75b8932dab9d55fe5b3f78f337"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDozMzowOFrOGLRXtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDozMzowOFrOGLRXtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3MjExNw==", "bodyText": "The \"does the cert exist\" check is missing.", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r414472117", "createdAt": "2020-04-24T10:33:08Z", "author": {"login": "jhyoty"}, "path": "src/serverconf/src/main/java/ee/ria/xroad/common/conf/serverconf/IsAuthentication.java", "diffHunk": "@@ -89,11 +92,13 @@ public static void verifyClientAuthentication(ClientId client,\n                 throw new CodedException(X_SSL_AUTH_FAILED,\n                         \"Client (%s) has no IS certificates\", client);\n             }\n-\n-            if (!isCerts.contains(auth.getCert())) {\n-                throw new CodedException(X_SSL_AUTH_FAILED,\n-                        \"Client (%s) TLS certificate does not match any\"\n-                                + \" IS certificates\", client);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "101740ce8655ec75b8932dab9d55fe5b3f78f337"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6214e12c3f2e04bc48aaf8b77700e198516e1ac5", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/6214e12c3f2e04bc48aaf8b77700e198516e1ac5", "committedDate": "2020-04-24T10:51:08Z", "message": "add missing check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0727759577db1d7144afd9f6136d16b3de395d09", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/0727759577db1d7144afd9f6136d16b3de395d09", "committedDate": "2020-04-24T12:48:59Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e6e50878953e132108c16e6cbfb1952cb062318", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/6e6e50878953e132108c16e6cbfb1952cb062318", "committedDate": "2020-04-24T14:44:23Z", "message": "Checkstyle modifications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c80acd17c220d2812350473bafccdabd9fea912", "author": {"user": {"login": "jhyoty", "name": "Jarkko Hy\u00f6ty"}}, "url": "https://github.com/nordic-institute/X-Road/commit/0c80acd17c220d2812350473bafccdabd9fea912", "committedDate": "2020-04-27T04:54:47Z", "message": "XRDDEV-17: Add integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1ba909fb99a47e104f3aca6c58aedb03919d035", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/f1ba909fb99a47e104f3aca6c58aedb03919d035", "committedDate": "2020-04-29T10:40:58Z", "message": "* XRDDEV-17: Add integration test for the expired cert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fcf8511ecba0b781d57fc66c6eb077d2f27bd34", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/9fcf8511ecba0b781d57fc66c6eb077d2f27bd34", "committedDate": "2020-04-29T20:25:00Z", "message": "XRDDEV-17: Make certificate validity errors configurable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cffca1fcd9ef42e6874a2360d960245df073c193", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/cffca1fcd9ef42e6874a2360d960245df073c193", "committedDate": "2020-04-30T05:11:53Z", "message": "XRDDEV-17: expired certificate check depends on the configuration parameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a04af6fad603a1a291d8006e4cac1411b29464b0", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/a04af6fad603a1a291d8006e4cac1411b29464b0", "committedDate": "2020-04-30T05:59:14Z", "message": "Documenting the field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "731d1330bc776fede1cfcf9282ca22d71b83d104", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/731d1330bc776fede1cfcf9282ca22d71b83d104", "committedDate": "2020-05-04T08:02:11Z", "message": "Merge branch 'develop' into XRDDEV-17-certificate-validate"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0ODYyOTE5", "url": "https://github.com/nordic-institute/X-Road/pull/472#pullrequestreview-404862919", "createdAt": "2020-05-04T10:18:33Z", "commit": {"oid": "731d1330bc776fede1cfcf9282ca22d71b83d104"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMDoxODozNFrOGP6X2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMDoxODozNFrOGP6X2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMzODIwMA==", "bodyText": "Perhaps the parameter name should be ~ enforce-client-is-certificate-validity-period because there are also other certificates this setting does not control. The explanation could also be a bit more abstract, something like whether to reject a request when client information system certificate is expired or not yet valid; throwing and exception is an implementation detail.", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r419338200", "createdAt": "2020-05-04T10:18:34Z", "author": {"login": "jhyoty"}, "path": "doc/Manuals/ug-syspar_x-road_v6_system_parameters.md", "diffHunk": "@@ -262,7 +263,7 @@ This chapter describes the system parameters used by the components of the X-Roa\n | server-conf-client-cache-size                    | 100                                        |   |   | Maximum number of local clients to keep cached |\n | server-conf-service-cache-size                   | 1000                                       |   |   | Maximum number of services to keep cached |\n | server-conf-acl-cache-size                       | 100000                                     |   |   | Maximum number of access rights to keep cached in memory. |\n-\n+| enforce-certificate-validity-period-check        | false                                      |   |   | Whether to throw an exception about expired or not yet valid certificates. |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "731d1330bc776fede1cfcf9282ca22d71b83d104"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "239517ef270eca7c68b95925cc822bf3ed967a61", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/239517ef270eca7c68b95925cc822bf3ed967a61", "committedDate": "2020-05-04T16:14:46Z", "message": "XRDDEV-17 Change parameter name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e9e5b5a0377a59111eba4e9196f4da2170a974f", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/6e9e5b5a0377a59111eba4e9196f4da2170a974f", "committedDate": "2020-05-04T20:18:49Z", "message": "Merge branch 'develop' into XRDDEV-17-certificate-validate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f70e0d33432da00984f114ea60c87a3960721fed", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/f70e0d33432da00984f114ea60c87a3960721fed", "committedDate": "2020-05-05T05:49:14Z", "message": "XRDDEV-17 Improve the code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NTIzNjY2", "url": "https://github.com/nordic-institute/X-Road/pull/472#pullrequestreview-405523666", "createdAt": "2020-05-05T06:36:27Z", "commit": {"oid": "f70e0d33432da00984f114ea60c87a3960721fed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4221, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}