{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MjkzMTg1", "number": 625, "title": "XRDDEV-1123 remove unnecessary ocsp fetching", "bodyText": "", "createdAt": "2020-07-29T08:53:47Z", "url": "https://github.com/nordic-institute/X-Road/pull/625", "merged": true, "mergeCommit": {"oid": "977b23b60d642e6693eeb72b483966d9407eeda0"}, "closed": true, "closedAt": "2020-08-07T11:58:27Z", "author": {"login": "iluwatar"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5lQ8zAH2gAyNDU4MjkzMTg1OmJlNmI2NzQ0NzQ2ZDBkN2UxNGM0MzhhNGI4Y2JjNjUyNGZkZjAxY2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8ifKggFqTQ2MzIyOTc4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "be6b6744746d0d7e14c438a4b8cbc6524fdf01cf", "author": {"user": {"login": "iluwatar", "name": "Ilkka Sepp\u00e4l\u00e4"}}, "url": "https://github.com/nordic-institute/X-Road/commit/be6b6744746d0d7e14c438a4b8cbc6524fdf01cf", "committedDate": "2020-07-29T06:44:46Z", "message": "XRDDEV-1123 do not try to fetch ocsp responses for root level CAs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52cdafb451f0c48c1970b71b6c6c21073ba65522", "author": {"user": {"login": "iluwatar", "name": "Ilkka Sepp\u00e4l\u00e4"}}, "url": "https://github.com/nordic-institute/X-Road/commit/52cdafb451f0c48c1970b71b6c6c21073ba65522", "committedDate": "2020-07-29T08:52:55Z", "message": "XRDDEV-1123 fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e6529619a6a1cf796e3fc24e35d621610977fd8", "author": {"user": {"login": "iluwatar", "name": "Ilkka Sepp\u00e4l\u00e4"}}, "url": "https://github.com/nordic-institute/X-Road/commit/3e6529619a6a1cf796e3fc24e35d621610977fd8", "committedDate": "2020-08-05T06:34:41Z", "message": "Merge branch 'develop' into XRDDEV-1123"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "205bef730622b1684a7f6750f25febef7324002f", "author": {"user": {"login": "iluwatar", "name": "Ilkka Sepp\u00e4l\u00e4"}}, "url": "https://github.com/nordic-institute/X-Road/commit/205bef730622b1684a7f6750f25febef7324002f", "committedDate": "2020-08-06T07:15:04Z", "message": "Revert \"XRDDEV-1123 fix tests\"\n\nThis reverts commit 52cdafb4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15f4f051621a9d33fd0b28f22baaec8699d03c94", "author": {"user": {"login": "iluwatar", "name": "Ilkka Sepp\u00e4l\u00e4"}}, "url": "https://github.com/nordic-institute/X-Road/commit/15f4f051621a9d33fd0b28f22baaec8699d03c94", "committedDate": "2020-08-06T07:15:13Z", "message": "Revert \"XRDDEV-1123 do not try to fetch ocsp responses for root level CAs\"\n\nThis reverts commit be6b6744"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d900ed215d6e13594c46714fe5d3769b9cfd73d", "author": {"user": {"login": "iluwatar", "name": "Ilkka Sepp\u00e4l\u00e4"}}, "url": "https://github.com/nordic-institute/X-Road/commit/0d900ed215d6e13594c46714fe5d3769b9cfd73d", "committedDate": "2020-08-06T07:51:10Z", "message": "XRDDEV-1123 add logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a9e4d81783fab49119c0aef0a2a9db3f30447b8", "author": {"user": {"login": "iluwatar", "name": "Ilkka Sepp\u00e4l\u00e4"}}, "url": "https://github.com/nordic-institute/X-Road/commit/3a9e4d81783fab49119c0aef0a2a9db3f30447b8", "committedDate": "2020-08-06T11:41:39Z", "message": "XRDDEV-1123 implement ocsp response fetching only for intermediate approved CAs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79f8060210e251ef417c889c62a33e77d3e674bd", "author": {"user": {"login": "iluwatar", "name": "Ilkka Sepp\u00e4l\u00e4"}}, "url": "https://github.com/nordic-institute/X-Road/commit/79f8060210e251ef417c889c62a33e77d3e674bd", "committedDate": "2020-08-06T13:35:09Z", "message": "XRDDEV-1123 fix index bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f128c13a6419c7088394af53f35bdc0dff5161c9", "author": {"user": {"login": "iluwatar", "name": "Ilkka Sepp\u00e4l\u00e4"}}, "url": "https://github.com/nordic-institute/X-Road/commit/f128c13a6419c7088394af53f35bdc0dff5161c9", "committedDate": "2020-08-06T13:35:35Z", "message": "XRDDEV-1123 fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMDQ4MzIw", "url": "https://github.com/nordic-institute/X-Road/pull/625#pullrequestreview-463048320", "createdAt": "2020-08-07T05:46:32Z", "commit": {"oid": "f128c13a6419c7088394af53f35bdc0dff5161c9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNTo0NjozMlrOG9NQkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNjozMToyNFrOG9OGjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgzMzU1Mg==", "bodyText": "The debug output seems unnecessary (or at least should be surrounded with \"log.isDebugEnabled\")", "url": "https://github.com/nordic-institute/X-Road/pull/625#discussion_r466833552", "createdAt": "2020-08-07T05:46:32Z", "author": {"login": "jhyoty"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/CertificateAuthorityService.java", "diffHunk": "@@ -141,36 +141,48 @@ public void evict() {\n      *                               false = only include top CAs\n      * @throws InconsistentCaDataException if required CA data could not be extracted, for example due to OCSP\n      * responses not being valid\n-     * @return\n+     * @return list of approved CAs\n      */\n     @Cacheable(GET_CERTIFICATE_AUTHORITIES_CACHE)\n     public List<ApprovedCaDto> getCertificateAuthorities(KeyUsageInfo keyUsageInfo,\n             boolean includeIntermediateCas) throws InconsistentCaDataException {\n \n         log.info(\"getCertificateAuthorities\");\n         List<X509Certificate> caCerts = new ArrayList<>(globalConfService.getAllCaCertsForThisInstance());\n+        caCerts.forEach(cert -> log.debug(String.format(\"Cert SubjectDN=%s IssuerDN=%s\", cert.getSubjectDN(),\n+                cert.getIssuerDN())));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f128c13a6419c7088394af53f35bdc0dff5161c9"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg0NzM3NA==", "bodyText": "Could be written as a \"for cert : caCerts\" loop, avoids the two get() calls and using the i by mistake.", "url": "https://github.com/nordic-institute/X-Road/pull/625#discussion_r466847374", "createdAt": "2020-08-07T06:31:24Z", "author": {"login": "jhyoty"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/CertificateAuthorityService.java", "diffHunk": "@@ -141,36 +141,48 @@ public void evict() {\n      *                               false = only include top CAs\n      * @throws InconsistentCaDataException if required CA data could not be extracted, for example due to OCSP\n      * responses not being valid\n-     * @return\n+     * @return list of approved CAs\n      */\n     @Cacheable(GET_CERTIFICATE_AUTHORITIES_CACHE)\n     public List<ApprovedCaDto> getCertificateAuthorities(KeyUsageInfo keyUsageInfo,\n             boolean includeIntermediateCas) throws InconsistentCaDataException {\n \n         log.info(\"getCertificateAuthorities\");\n         List<X509Certificate> caCerts = new ArrayList<>(globalConfService.getAllCaCertsForThisInstance());\n+        caCerts.forEach(cert -> log.debug(String.format(\"Cert SubjectDN=%s IssuerDN=%s\", cert.getSubjectDN(),\n+                cert.getIssuerDN())));\n+\n         List<ApprovedCaDto> dtos = new ArrayList<>();\n         // map of each subject - issuer DN pair for easy lookups\n         Map<String, String> subjectsToIssuers = caCerts.stream().collect(\n                 Collectors.toMap(\n                         x509 -> x509.getSubjectDN().getName(),\n                         x509 -> x509.getIssuerDN().getName()));\n \n+        // we only fetch ocsp responses for intermediate approved CAs\n+        // configured as approved CA and its issuer cert is also an approved CA\n+        List<X509Certificate> filteredCerts = caCerts.stream()\n+                .filter(cert -> subjectsToIssuers.containsKey(cert.getIssuerDN().getName()))\n+                .collect(Collectors.toList());\n+\n         String[] base64EncodedOcspResponses;\n         try {\n-            String[] certHashes = CertUtils.getCertHashes(new ArrayList<>(caCerts));\n+            String[] certHashes = CertUtils.getCertHashes(new ArrayList<>(filteredCerts));\n             base64EncodedOcspResponses = signerProxyFacade.getOcspResponses(certHashes);\n         } catch (Exception e) {\n             throw new InconsistentCaDataException(\"failed to get read CA OCSP responses\", e);\n         }\n-        if (caCerts.size() != base64EncodedOcspResponses.length) {\n-            throw new InconsistentCaDataException(\"ocsp responses do not match ca certs\");\n+        if (filteredCerts.size() != base64EncodedOcspResponses.length) {\n+            throw new InconsistentCaDataException(\n+                    String.format(\"ocsp responses do not match ca certs %d vs %d\",\n+                            filteredCerts.size(), base64EncodedOcspResponses.length));\n         }\n \n         // build dtos\n         for (int i = 0; i < caCerts.size(); i++) {\n+            int idx = filteredCerts.indexOf(caCerts.get(i));\n             dtos.add(buildCertificateAuthorityDto(caCerts.get(i),\n-                    base64EncodedOcspResponses[i],\n+                    (idx != -1) ? base64EncodedOcspResponses[idx] : null,\n                     subjectsToIssuers));\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f128c13a6419c7088394af53f35bdc0dff5161c9"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98906867c258f6e704954b2cc4f0fd77c3ac00d6", "author": {"user": {"login": "iluwatar", "name": "Ilkka Sepp\u00e4l\u00e4"}}, "url": "https://github.com/nordic-institute/X-Road/commit/98906867c258f6e704954b2cc4f0fd77c3ac00d6", "committedDate": "2020-08-07T10:45:31Z", "message": "XRDDEV-1123 simplify for loop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMjI5Nzg2", "url": "https://github.com/nordic-institute/X-Road/pull/625#pullrequestreview-463229786", "createdAt": "2020-08-07T11:12:21Z", "commit": {"oid": "98906867c258f6e704954b2cc4f0fd77c3ac00d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4152, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}