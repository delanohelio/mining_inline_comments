{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzNTU2MTU4", "number": 402, "title": "XRDDEV-865 Unregister client", "bodyText": "Should not be merged before client registering PR #399\nJIRA: https://jira.niis.org/browse/XRDDEV-865", "createdAt": "2020-03-04T13:29:55Z", "url": "https://github.com/nordic-institute/X-Road/pull/402", "merged": true, "mergeCommit": {"oid": "97ee72287917a928a18379cc16bebf07e604f29e"}, "closed": true, "closedAt": "2020-03-11T13:23:46Z", "author": {"login": "carohauta"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJs3QtgH2gAyMzgzNTU2MTU4OjVhZjliNDc5NzhiNmU5NmY0YTQ5NzYwYjdmNDlkN2FiOWY2OWJiOGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMluwiAH2gAyMzgzNTU2MTU4OmI2MTU0NTJiODAyYTUyNmM0ZmI1YmQxNzU0YzgzOGEyYTZiYjhjZmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5af9b47978b6e96f4a49760b7f49d7ab9f69bb8a", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/5af9b47978b6e96f4a49760b7f49d7ab9f69bb8a", "committedDate": "2020-03-02T12:27:35Z", "message": "XRDDEV-861 Register client\n\n* controller and service layer done\n* exception refactoring - sorry about the noise!\n* WIP: tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "014268241df54b1b5c8177bf7a775842da3a671d", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/014268241df54b1b5c8177bf7a775842da3a671d", "committedDate": "2020-03-02T13:49:04Z", "message": "XRDDEV-861 Register client // tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73d193e39fa81e1892b7507333987709eb24a1d4", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/73d193e39fa81e1892b7507333987709eb24a1d4", "committedDate": "2020-03-02T14:26:40Z", "message": "XRDDEV-861 Register client // javadov update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4833e41fce8c6ae263f2a98a159953d1b4f18dfb", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/4833e41fce8c6ae263f2a98a159953d1b4f18dfb", "committedDate": "2020-03-04T13:12:02Z", "message": "XRDDEV-865 Unregister client\n\n* controller, service, tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "358eb1deb6bd3cf05946274b4a892bf1d3862be5", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/358eb1deb6bd3cf05946274b4a892bf1d3862be5", "committedDate": "2020-03-04T13:37:16Z", "message": "Merge branch 'develop' into XRDDEV-865-unregister-client\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/ClientServiceIntegrationTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98cb840ef56d189a99199bf5383782704eaf5ec7", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/98cb840ef56d189a99199bf5383782704eaf5ec7", "committedDate": "2020-03-04T13:47:48Z", "message": "XRDDEV-865 Unregister client // after merge fixes\n\n* throw ClientNotFound\n* add test for non existing client unregister"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "395fe1492a818aa1f1e7489544bf311553c3999c", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/395fe1492a818aa1f1e7489544bf311553c3999c", "committedDate": "2020-03-04T13:52:38Z", "message": "Merge branch 'develop' into XRDDEV-861-register-client\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/ClientServiceIntegrationTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8864a6125a5c86f52af1b3a522eb8f2582990db1", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/8864a6125a5c86f52af1b3a522eb8f2582990db1", "committedDate": "2020-03-04T14:35:47Z", "message": "XRDDEV-865 Unregister client // checkstyle fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxODI2OTEx", "url": "https://github.com/nordic-institute/X-Road/pull/402#pullrequestreview-371826911", "createdAt": "2020-03-10T10:19:17Z", "commit": {"oid": "8864a6125a5c86f52af1b3a522eb8f2582990db1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDoxOToxN1rOF0I0yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMDo0MDo1MVrOF0JiPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIxNDg1Ng==", "bodyText": "nitpick: \"is already unregistered\" may be slightly misleading, since ActionNotPossibleException is thrown also when client has status STATUS_SAVED, STATUS_DELINPROG or STATUS_GLOBALERR. At least STATUS_SAVED can happen even if client has not been already unregistered.", "url": "https://github.com/nordic-institute/X-Road/pull/402#discussion_r390214856", "createdAt": "2020-03-10T10:19:17Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -418,6 +425,51 @@ public ClientType deleteTlsCertificate(ClientId id, String certificateHash)\n         return mergeClientListsDistinctively(globalClients, localClients);\n     }\n \n+    /**\n+     * Registers a client\n+     * @param clientId client to register\n+     * @throws GlobalConfOutdatedException\n+     * @throws ClientNotFoundException\n+     */\n+    public void registerClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException {\n+        ClientType client = getLocalClientOrThrowNotFound(clientId);\n+        try {\n+            managementRequestSenderService.sendClientRegisterRequest(clientId);\n+            client.setClientStatus(ClientType.STATUS_REGINPROG);\n+            clientRepository.saveOrUpdate(client);\n+        } catch (ManagementRequestSendingFailedException e) {\n+            throw new DeviationAwareRuntimeException(e, e.getErrorDeviation());\n+        }\n+    }\n+\n+    /**\n+     * Unregister a client\n+     * @param clientId client to unregister\n+     * @throws GlobalConfOutdatedException\n+     * @throws ClientNotFoundException\n+     * @throws CannotUnregisterOwnerException when trying to unregister the security server owner\n+     * @throws ActionNotPossibleException when trying do unregister a client that is already unregistered", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8864a6125a5c86f52af1b3a522eb8f2582990db1"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIxOTg3Mg==", "bodyText": "Are you sure about ActionNotPossibleException being bad request? For example similar operation token certificate register / unregister seem to map into http 409 conflict: \n  \n    \n      X-Road/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/TokenCertificatesApiController.java\n    \n    \n        Lines 213 to 214\n      in\n      05e6443\n    \n    \n    \n    \n\n        \n          \n           } catch (ActionNotPossibleException | KeyNotFoundException e) { \n        \n\n        \n          \n               throw new ConflictException(e); \n        \n    \n  \n\n\nAlso other controllers seem to map ActionNotPossibleExceptions into conflicts, currently.\nI am not sure if this means CannotUnregisterOwnerException should follow suit, if ActionNotPossible is changed into 409. It is a little bit different, since owner is mostly static, and it is not very likely that a conflict could happen due to some other API call changing the owner. It is more common / likely that client status is changed due to another API call.", "url": "https://github.com/nordic-institute/X-Road/pull/402#discussion_r390219872", "createdAt": "2020-03-10T10:28:31Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java", "diffHunk": "@@ -406,6 +404,35 @@ private ClientType getClientType(String encodedId) {\n         return new ResponseEntity<>(subjects, HttpStatus.OK);\n     }\n \n+    @Override\n+    @PreAuthorize(\"hasAuthority('SEND_CLIENT_REG_REQ')\")\n+    public ResponseEntity<Void> registerClient(String encodedClientId) {\n+        ClientId clientId = clientConverter.convertId(encodedClientId);\n+        try {\n+            clientService.registerClient(clientId);\n+        } catch (GlobalConfOutdatedException e) {\n+            throw new BadRequestException(e);\n+        } catch (ClientNotFoundException e) {\n+            throw new ResourceNotFoundException(e);\n+        }\n+        return new ResponseEntity<>(HttpStatus.NO_CONTENT);\n+    }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('SEND_CLIENT_DEL_REQ')\")\n+    public ResponseEntity<Void> unregisterClient(String encodedClientId) {\n+        ClientId clientId = clientConverter.convertId(encodedClientId);\n+        try {\n+            clientService.unregisterClient(clientId);\n+        } catch (GlobalConfOutdatedException | ClientService.CannotUnregisterOwnerException\n+                | ActionNotPossibleException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8864a6125a5c86f52af1b3a522eb8f2582990db1"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyNTg3OQ==", "bodyText": "saveOrUpdate does not hurt, but out of curiosity, is it needed? Or would JPA implementation automatically persist the modified managed entity when transaction ends?\n(@Transactional tests might have something to do with this....if so, it would in principle be better to make adjustments to tests instead of production code - em.flush?)\nIf saveOrUpdate is not needed, we could consider removing it, just to make things simpler and not fooling maintainers into thinking there is something important that requires calling saveOrUpdate, when there is not?", "url": "https://github.com/nordic-institute/X-Road/pull/402#discussion_r390225879", "createdAt": "2020-03-10T10:39:40Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -418,6 +425,51 @@ public ClientType deleteTlsCertificate(ClientId id, String certificateHash)\n         return mergeClientListsDistinctively(globalClients, localClients);\n     }\n \n+    /**\n+     * Registers a client\n+     * @param clientId client to register\n+     * @throws GlobalConfOutdatedException\n+     * @throws ClientNotFoundException\n+     */\n+    public void registerClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException {\n+        ClientType client = getLocalClientOrThrowNotFound(clientId);\n+        try {\n+            managementRequestSenderService.sendClientRegisterRequest(clientId);\n+            client.setClientStatus(ClientType.STATUS_REGINPROG);\n+            clientRepository.saveOrUpdate(client);\n+        } catch (ManagementRequestSendingFailedException e) {\n+            throw new DeviationAwareRuntimeException(e, e.getErrorDeviation());\n+        }\n+    }\n+\n+    /**\n+     * Unregister a client\n+     * @param clientId client to unregister\n+     * @throws GlobalConfOutdatedException\n+     * @throws ClientNotFoundException\n+     * @throws CannotUnregisterOwnerException when trying to unregister the security server owner\n+     * @throws ActionNotPossibleException when trying do unregister a client that is already unregistered\n+     */\n+    public void unregisterClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException,\n+            CannotUnregisterOwnerException, ActionNotPossibleException {\n+        ClientType client = getLocalClientOrThrowNotFound(clientId);\n+        List<String> allowedStatuses = Arrays.asList(STATUS_REGISTERED, STATUS_REGINPROG);\n+        if (!allowedStatuses.contains(client.getClientStatus())) {\n+            throw new ActionNotPossibleException(\"cannot unregister client with status \" + client.getClientStatus());\n+        }\n+        ClientId ownerId = securityServerOwner.getId();\n+        if (clientId.equals(ownerId)) {\n+            throw new CannotUnregisterOwnerException();\n+        }\n+        try {\n+            managementRequestSenderService.sendClientUnregisterRequest(clientId);\n+            client.setClientStatus(STATUS_DELINPROG);\n+            clientRepository.saveOrUpdate(client);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8864a6125a5c86f52af1b3a522eb8f2582990db1"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyNjQ5NQ==", "bodyText": "Javadoc does not seem to be in sync with the implementation.", "url": "https://github.com/nordic-institute/X-Road/pull/402#discussion_r390226495", "createdAt": "2020-03-10T10:40:51Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ManagementRequestSenderService.java", "diffHunk": "@@ -99,27 +103,51 @@ public Integer sendAuthCertDeletionRequest(byte[] authCert) throws\n         }\n     }\n \n-    private ManagementRequestSender createManagementRequestSender()\n-            throws GlobalConfService.GlobalConfOutdatedException {\n-        globalConfService.verifyGlobalConfValidity();\n-        ServerConfType serverConf = serverConfService.getServerConf();\n-        ClientId sender = serverConf.getOwner().getIdentifier();\n-        ClientId receiver = globalConfFacade.getManagementRequestService();\n-        return new ManagementRequestSender(sender, receiver);\n+    /**\n+     * Sends a client register request as a normal X-Road message\n+     * @param securityServer the security server id\n+     * @param clientId the client id that will be registered\n+     * @return request ID in the central server database\n+     * @throws GlobalConfOutdatedException\n+     * @throws ManagementRequestSendingFailedException if there is a problem sending the message\n+     */\n+    Integer sendClientRegisterRequest(ClientId clientId)\n+            throws GlobalConfOutdatedException, ManagementRequestSendingFailedException {\n+        ManagementRequestSender sender = createManagementRequestSender();\n+        try {\n+            return sender.sendClientRegRequest(serverConfService.getSecurityServerId(), clientId);\n+        } catch (CodedException ce) {\n+            throw ce;\n+        } catch (Exception e) {\n+            throw new ManagementRequestSendingFailedException(e);\n+        }\n     }\n \n     /**\n-     * Missing a valid auth cert\n+     * Sends a client unregister request as a normal X-Road message\n+     * @param securityServer the security server id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8864a6125a5c86f52af1b3a522eb8f2582990db1"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "412132cd91ee5028c178a0fd5b94c0bde24c502e", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/412132cd91ee5028c178a0fd5b94c0bde24c502e", "committedDate": "2020-03-10T14:40:48Z", "message": "XRDDEV-861 Register client // PR comment fixes 1\n\n* refactor SecurityServerOwner -> CurrentSecurityServerId\n* add verifications to whether or not client can be registered\n* test coverage for controller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32fd524825145a0368d82e8c0852a29f7435b5ea", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/32fd524825145a0368d82e8c0852a29f7435b5ea", "committedDate": "2020-03-10T14:51:32Z", "message": "Merge branch 'XRDDEV-861-register-client' into XRDDEV-865-unregister-client\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ManagementRequestSenderService.java\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/ClientServiceIntegrationTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d99c7e6c6425f62efd330421eeffb9cd0850a8b9", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/d99c7e6c6425f62efd330421eeffb9cd0850a8b9", "committedDate": "2020-03-10T16:01:18Z", "message": "XRDDEV-865 Unregister client // test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "732506671384e6f95c26703aa1ef608ba8a9eff1", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/732506671384e6f95c26703aa1ef608ba8a9eff1", "committedDate": "2020-03-11T07:54:30Z", "message": "XRDDEV-865 Unregister client // PR fixes 1\n\n* added controller tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNTY3OTk2", "url": "https://github.com/nordic-institute/X-Road/pull/402#pullrequestreview-372567996", "createdAt": "2020-03-11T08:53:34Z", "commit": {"oid": "732506671384e6f95c26703aa1ef608ba8a9eff1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b358e0f30d09a6d2e85b9dfbce484126bc3167af", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/b358e0f30d09a6d2e85b9dfbce484126bc3167af", "committedDate": "2020-03-11T10:07:10Z", "message": "Merge branch 'develop' into XRDDEV-861-register-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34a93d79d5baa6623ad4d98a648f2eb9c88cb512", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/34a93d79d5baa6623ad4d98a648f2eb9c88cb512", "committedDate": "2020-03-11T10:07:41Z", "message": "Merge branch 'XRDDEV-861-register-client' into XRDDEV-865-unregister-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1b7015a7c280e7168a8c4d9efa7b12a3682ea14", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/a1b7015a7c280e7168a8c4d9efa7b12a3682ea14", "committedDate": "2020-03-11T11:09:10Z", "message": "XRDDEV-865 Unregister client // checkstyle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "550f0fcfbccf2163c5fe092c8a5628865b03d1e4", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/550f0fcfbccf2163c5fe092c8a5628865b03d1e4", "committedDate": "2020-03-11T11:28:30Z", "message": "Merge branch 'develop' into XRDDEV-861-register-client\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/openapi/ClientsApiControllerIntegrationTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b615452b802a526c4fb5bd1754c838a2a6bb8cfb", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/b615452b802a526c4fb5bd1754c838a2a6bb8cfb", "committedDate": "2020-03-11T11:50:44Z", "message": "Merge branch 'XRDDEV-861-register-client' into XRDDEV-865-unregister-client\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4357, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}