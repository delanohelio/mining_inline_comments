{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MTA1NzM0", "number": 435, "title": "XRDDEV-941", "bodyText": "Add API for updating existing API key.\nAdd tests.\nUpdate documentation.", "createdAt": "2020-03-26T11:15:53Z", "url": "https://github.com/nordic-institute/X-Road/pull/435", "merged": true, "mergeCommit": {"oid": "739fa0e149b2313f9a1e6ef4c3f486998c7cef7c"}, "closed": true, "closedAt": "2020-04-02T12:32:21Z", "author": {"login": "petkivim"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRaGbigH2gAyMzk0MTA1NzM0OmQxNTc2NDMxYTM0ZWQ4YmE3OTQ2MjA2MTllNzZkZWRkYTkxMmMwZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTrgkUAFqTM4NjM3ODc1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d1576431a34ed8ba794620619e76dedda912c0ff", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/d1576431a34ed8ba794620619e76dedda912c0ff", "committedDate": "2020-03-26T11:07:21Z", "message": "XRDDEV-941 API for updating existing API key\n\n- Add API for updating existing API key.\n- Add tests.\n- Update documentation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35a6abee0f156d558706b51f80b5db3c16f5e039", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/35a6abee0f156d558706b51f80b5db3c16f5e039", "committedDate": "2020-03-26T11:09:45Z", "message": "XRDDEV-941 Update documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a28d5e8d8d63ba2b2576081a09a84c6b75a10f95", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/a28d5e8d8d63ba2b2576081a09a84c6b75a10f95", "committedDate": "2020-03-26T11:11:28Z", "message": "XRDDEV-941 Update documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "735e853ba2b24871b82606d8df77478ba2283ecb", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/735e853ba2b24871b82606d8df77478ba2283ecb", "committedDate": "2020-03-26T11:13:33Z", "message": "XRDDEV-941 Update documentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODAxNjAy", "url": "https://github.com/nordic-institute/X-Road/pull/435#pullrequestreview-382801602", "createdAt": "2020-03-27T12:10:50Z", "commit": {"oid": "735e853ba2b24871b82606d8df77478ba2283ecb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMjoxMDo1MFrOF8udbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMjo1Mjo0MVrOF8vyag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMDA3Nw==", "bodyText": "Feels like this ApiKeyRepository is a bit different from the conventions used in other repositories. Other repositories mostly\n\nhave a saveOrUpdate method which is used for both creating and updating\ndo not deletegate simple update / delete operations to DAO, but instead just use direct calls with persistenceUtils, e.g. \n  \n    \n      X-Road/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/LocalGroupRepository.java\n    \n    \n        Lines 104 to 106\n      in\n      735e853\n    \n    \n    \n    \n\n        \n          \n           public void delete(LocalGroupType localGroupType) { \n        \n\n        \n          \n               persistenceUtils.getCurrentSession().delete(localGroupType); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\n\nBut this is earlier legacy than this ticket so nothing has to be done here. I think I will add a few lines to confluence to offer some conventions for future repository implementations.\nI think I will pick an API key related ticket next, so I might refactor this part there. Or, if you get the inspiration, you can do it also.", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399220077", "createdAt": "2020-03-27T12:10:50Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/ApiKeyRepository.java", "diffHunk": "@@ -108,6 +108,44 @@ private String createApiKey() {\n         return entry;\n     }\n \n+    /**\n+     * update api key with one role by key id\n+     * @param id\n+     * @param roleName\n+     * @throws InvalidRoleNameException if roleNames was empty or contained invalid roles\n+     * @throws ApiKeyNotFoundException if api key was not found\n+     */\n+    @CacheEvict(allEntries = true, cacheNames = { LIST_ALL_KEYS_CACHE, GET_KEY_CACHE })\n+    public PersistentApiKeyType update(long id, String roleName)\n+            throws InvalidRoleNameException, ApiKeyNotFoundException {\n+        return update(id, Collections.singletonList(roleName));\n+    }\n+\n+    /**\n+     * update api key with collection of roles by key id\n+     * @param id\n+     * @param roleNames\n+     * @return\n+     * @throws InvalidRoleNameException if roleNames was empty or contained invalid roles\n+     * @throws ApiKeyNotFoundException if api key was not found\n+     */\n+    @CacheEvict(allEntries = true, cacheNames = { LIST_ALL_KEYS_CACHE, GET_KEY_CACHE })\n+    public PersistentApiKeyType update(long id, Collection<String> roleNames)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "735e853ba2b24871b82606d8df77478ba2283ecb"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyNDU0Nw==", "bodyText": "Confluence updated: https://confluence.niis.org/display/XRDDEV/API+backend+conventions#APIbackendconventions-Repositories", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399224547", "createdAt": "2020-03-27T12:19:53Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/ApiKeyRepository.java", "diffHunk": "@@ -108,6 +108,44 @@ private String createApiKey() {\n         return entry;\n     }\n \n+    /**\n+     * update api key with one role by key id\n+     * @param id\n+     * @param roleName\n+     * @throws InvalidRoleNameException if roleNames was empty or contained invalid roles\n+     * @throws ApiKeyNotFoundException if api key was not found\n+     */\n+    @CacheEvict(allEntries = true, cacheNames = { LIST_ALL_KEYS_CACHE, GET_KEY_CACHE })\n+    public PersistentApiKeyType update(long id, String roleName)\n+            throws InvalidRoleNameException, ApiKeyNotFoundException {\n+        return update(id, Collections.singletonList(roleName));\n+    }\n+\n+    /**\n+     * update api key with collection of roles by key id\n+     * @param id\n+     * @param roleNames\n+     * @return\n+     * @throws InvalidRoleNameException if roleNames was empty or contained invalid roles\n+     * @throws ApiKeyNotFoundException if api key was not found\n+     */\n+    @CacheEvict(allEntries = true, cacheNames = { LIST_ALL_KEYS_CACHE, GET_KEY_CACHE })\n+    public PersistentApiKeyType update(long id, Collection<String> roleNames)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyMDA3Nw=="}, "originalCommit": {"oid": "735e853ba2b24871b82606d8df77478ba2283ecb"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyODI4Nw==", "bodyText": "Looks like update targets key 60 but returns 61, is it a mistake?", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399228287", "createdAt": "2020-03-27T12:27:08Z", "author": {"login": "jansu76"}, "path": "doc/Manuals/ug-ss_x-road_6_security_server_user_guide.md", "diffHunk": "@@ -2025,7 +2027,24 @@ curl -X GET -u <user>:<password> https://localhost:4000/api/api-key -k\n \n ```\n \n-#### 19.1.3 Revoking API keys\n+#### 19.1.3 Updating API keys\n+\n+An existing API key is updated with a `PUT` request to `/api/api-key/{id}`. Message body must contain the roles to be\n+associated with the key. Server responds with data that contains the key id and roles associated with the key.\n+\n+```\n+curl -X PUT -u <user>:<password> https://localhost:4000/api/api-key/60 --data '[\"XROAD_SECURITYSERVER_OBSERVER\",\"XROAD_REGISTRATION_OFFICER\"]' --header \"Content-Type: application/json\" -k\n+{\n+  \"id\": 61,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "735e853ba2b24871b82606d8df77478ba2283ecb"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIzNDk4Mw==", "bodyText": "Should the use case documentation also be updated, as it contains other API key related operations? https://github.com/nordic-institute/X-Road/blob/735e853ba2b24871b82606d8df77478ba2283ecb/doc/UseCases/uc-ss_x-road_use_case_model_for_security_server_management_1.4_Y-883-4.md#344-uc-ss_43-create-a-new-api-key", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399234983", "createdAt": "2020-03-27T12:40:06Z", "author": {"login": "jansu76"}, "path": "doc/Manuals/ug-ss_x-road_6_security_server_user_guide.md", "diffHunk": "@@ -6,7 +6,7 @@\n \n **X-ROAD 6**\n \n-Version: 2.36\n+Version: 2.38", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "735e853ba2b24871b82606d8df77478ba2283ecb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0MTgzNA==", "bodyText": "ApiKeyNotFoundException should probably result in ResourceNotFoundException instead (see revoke)", "url": "https://github.com/nordic-institute/X-Road/pull/435#discussion_r399241834", "createdAt": "2020-03-27T12:52:41Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/controller/ApiKeyController.java", "diffHunk": "@@ -82,6 +82,20 @@\n         return result;\n     }\n \n+    /**\n+     * update an existing api key\n+     */\n+    @RequestMapping(value = \"/{id}\", method = RequestMethod.PUT, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)\n+    public ResponseEntity<PublicKeyData> updateKey(@PathVariable(\"id\") long id,\n+                                                          @RequestBody List<String> roles) {\n+        try {\n+            PersistentApiKeyType key = apiKeyRepository.update(id, roles);\n+            return new ResponseEntity<>(new PublicKeyData(key.getId(), key.getRoles()), HttpStatus.OK);\n+        } catch (InvalidRoleNameException | ApiKeyRepository.ApiKeyNotFoundException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "735e853ba2b24871b82606d8df77478ba2283ecb"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c0a787b2dfde17ee9475d66e9c67aacfc35c13c", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/2c0a787b2dfde17ee9475d66e9c67aacfc35c13c", "committedDate": "2020-03-28T15:08:03Z", "message": "XRDDEV-941 Update documentation\n\n- Update Security Server user guide.\n- Update Security Server use case document."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb5e5e687a019a4a948ed87e412c1155448d00e4", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/cb5e5e687a019a4a948ed87e412c1155448d00e4", "committedDate": "2020-03-28T15:05:58Z", "message": "XRDDEV-947 Update documentation\n\n- Update Security Server user guide.\n- Update Security Server use case document."}, "afterCommit": {"oid": "2c0a787b2dfde17ee9475d66e9c67aacfc35c13c", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/2c0a787b2dfde17ee9475d66e9c67aacfc35c13c", "committedDate": "2020-03-28T15:08:03Z", "message": "XRDDEV-941 Update documentation\n\n- Update Security Server user guide.\n- Update Security Server use case document."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc20188fb9ac5602ae11c4f6ebb881ecb88d8e1c", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/bc20188fb9ac5602ae11c4f6ebb881ecb88d8e1c", "committedDate": "2020-03-28T15:11:07Z", "message": "XRDDEV-941 Update Security Server use case document"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a53bd0a095b78eff5549a8b0b3a11a02d1990672", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/a53bd0a095b78eff5549a8b0b3a11a02d1990672", "committedDate": "2020-03-28T15:20:51Z", "message": "XRDDEV-941 Minor update on API key controller based on review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdd72f685ac2cceb1a47eeb78398999deb1b2759", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/fdd72f685ac2cceb1a47eeb78398999deb1b2759", "committedDate": "2020-03-29T06:48:25Z", "message": "XRDDEV-941 Refactor repository implementation\n\n- Add new ApiKeyService class that contains business logic.\n- Refactor ApiKeyRepository so that in contains only DB operations.\n- Update tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20b48bd6a6be2f667f09cf70918e13d16a09bea1", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/20b48bd6a6be2f667f09cf70918e13d16a09bea1", "committedDate": "2020-03-29T07:55:26Z", "message": "XRDDEV-941 Separate service and API layer data models\n\n- Implement new data model for API layer.\n- Add converter.\n- Add tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da8edfeccb4be9e731d4fdd13c33461145235ab2", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/da8edfeccb4be9e731d4fdd13c33461145235ab2", "committedDate": "2020-03-29T08:32:44Z", "message": "XRDDEV-941  Fix failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaeac8ef91345319456a82dd63c31e96f92ccd13", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/eaeac8ef91345319456a82dd63c31e96f92ccd13", "committedDate": "2020-03-29T09:04:04Z", "message": "XRDDEV-941  Fix failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13059996338a1f1d6c3daa13785d6d78b57a35e7", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/13059996338a1f1d6c3daa13785d6d78b57a35e7", "committedDate": "2020-03-29T09:05:46Z", "message": "XRDDEV-941 Fix checkstyle issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25bfef4167b9f6be63bf333fefdde1b197957ced", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/25bfef4167b9f6be63bf333fefdde1b197957ced", "committedDate": "2020-03-29T12:42:13Z", "message": "XRDDEV-941 Fix SonarQube findings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22d66e32f5cf071bef800e028d21f34033320935", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/22d66e32f5cf071bef800e028d21f34033320935", "committedDate": "2020-04-02T04:45:05Z", "message": "Merge branch 'develop' into XRDDEV-941"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2Mzc4NzU1", "url": "https://github.com/nordic-institute/X-Road/pull/435#pullrequestreview-386378755", "createdAt": "2020-04-02T12:32:08Z", "commit": {"oid": "22d66e32f5cf071bef800e028d21f34033320935"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4177, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}