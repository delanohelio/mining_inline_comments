{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNTEzODQy", "number": 577, "title": "XRDDEV-1172 WSDL request size limit bug", "bodyText": "The bug could not be reproduced but there was a missing feature that was implemented in this PR:\n10MB size limit for WSDLs\nCheck the task description for more comments:\nJIRA: https://jira.niis.org/browse/XRDDEV-1172", "createdAt": "2020-07-02T13:22:32Z", "url": "https://github.com/nordic-institute/X-Road/pull/577", "merged": true, "mergeCommit": {"oid": "b19ed0b17538a95cb8b24736accd49b7f2f82a96"}, "closed": true, "closedAt": "2020-07-15T13:11:32Z", "author": {"login": "carohauta"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcw81zTgH2gAyNDQzNTEzODQyOjQ0OTBjZmJhMTBkMTZmNzFjYzc0MTA4OWQzYmRkYmU2OWI5NmY3NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1KVLVgFqTQ0ODkzMjU3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4490cfba10d16f71cc741089d3bddbe69b96f748", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/4490cfba10d16f71cc741089d3bddbe69b96f748", "committedDate": "2020-07-02T11:07:31Z", "message": "XRDDEV-1172 Set a 10MB size limit for a WSDL document"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d2ee9417ccfb7c58453302a3fcf94681e8d20a4", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/3d2ee9417ccfb7c58453302a3fcf94681e8d20a4", "committedDate": "2020-07-02T12:12:25Z", "message": "XRDDEV-1172 WSDL size error cause to detail message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40ece9e3adbafe6317e488c5dac0e9f17e1719b1", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/40ece9e3adbafe6317e488c5dac0e9f17e1719b1", "committedDate": "2020-07-03T05:56:12Z", "message": "Merge branch 'develop' into XRDDEV-1172-wsdl-request-size-limit-bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODE2MjAw", "url": "https://github.com/nordic-institute/X-Road/pull/577#pullrequestreview-443816200", "createdAt": "2020-07-07T11:52:26Z", "commit": {"oid": "40ece9e3adbafe6317e488c5dac0e9f17e1719b1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMTo1MjoyN1rOGt7EKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjowMTo1MVrOGt7XMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgwNjgyNA==", "bodyText": "It would be a bit more efficient to avoid creating the potentially large String if logging is not set at trace level. Suggestion: surround with if ( log.isTraceEnabled() ) ....", "url": "https://github.com/nordic-institute/X-Road/pull/577#discussion_r450806824", "createdAt": "2020-07-07T11:52:27Z", "author": {"login": "jhyoty"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/wsdl/WsdlParser.java", "diffHunk": "@@ -282,22 +288,35 @@ public ServiceInfo(String name, String title, String url,\n             this.wsdlUrl = wsdlUrl;\n         }\n \n+        // cannot change the method signature when overriding so we need to sneakily throw the WsdlParseException\n+        @SneakyThrows(WsdlParseException.class)\n         @Override\n         public InputSource getBaseInputSource() {\n-            try {\n+            try (ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream()) {\n                 URLConnection conn = new URL(wsdlUrl).openConnection();\n                 if (conn instanceof HttpsURLConnection) {\n                     configureHttps((HttpsURLConnection) conn);\n                 }\n \n-                // cache the response\n-                byte[] response;\n                 try (InputStream in = conn.getInputStream()) {\n-                    response = IOUtils.toByteArray(in);\n+                    long count = 0;\n+                    int n;\n+                    byte[] buf = new byte[BUF_SIZE];\n+                    while ((n = in.read(buf)) != -1) {\n+                        count += n;\n+                        if (count > MAX_DESCRIPTION_SIZE) {\n+                            throw new WsdlParseException(\n+                                    \"Error reading WSDL: Size exceeds \" + MAX_DESCRIPTION_SIZE + \" bytes.\");\n+                        }\n+                        byteArrayOutputStream.write(buf, 0, n);\n+                    }\n                 }\n+                byte[] response = byteArrayOutputStream.toByteArray();\n                 log.trace(\"Received WSDL response: {}\", new String(response));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40ece9e3adbafe6317e488c5dac0e9f17e1719b1"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgwNzgzMw==", "bodyText": "Instead of WsdlParseException, one could use e.g. UncheckedIOException (and avoid using SneakyThrows).  It seems that most exceptions are anyway converted to WsdlParseExceptions on a higher level.", "url": "https://github.com/nordic-institute/X-Road/pull/577#discussion_r450807833", "createdAt": "2020-07-07T11:54:27Z", "author": {"login": "jhyoty"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/wsdl/WsdlParser.java", "diffHunk": "@@ -282,22 +288,35 @@ public ServiceInfo(String name, String title, String url,\n             this.wsdlUrl = wsdlUrl;\n         }\n \n+        // cannot change the method signature when overriding so we need to sneakily throw the WsdlParseException\n+        @SneakyThrows(WsdlParseException.class)\n         @Override\n         public InputSource getBaseInputSource() {\n-            try {\n+            try (ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream()) {\n                 URLConnection conn = new URL(wsdlUrl).openConnection();\n                 if (conn instanceof HttpsURLConnection) {\n                     configureHttps((HttpsURLConnection) conn);\n                 }\n \n-                // cache the response\n-                byte[] response;\n                 try (InputStream in = conn.getInputStream()) {\n-                    response = IOUtils.toByteArray(in);\n+                    long count = 0;\n+                    int n;\n+                    byte[] buf = new byte[BUF_SIZE];\n+                    while ((n = in.read(buf)) != -1) {\n+                        count += n;\n+                        if (count > MAX_DESCRIPTION_SIZE) {\n+                            throw new WsdlParseException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40ece9e3adbafe6317e488c5dac0e9f17e1719b1"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgxMTY5OQ==", "bodyText": "This catches also java.lang.Errors, which should not be normally done. Should be narrowed to the actual possible checked exception types or at least \"Exception\".", "url": "https://github.com/nordic-institute/X-Road/pull/577#discussion_r450811699", "createdAt": "2020-07-07T12:01:51Z", "author": {"login": "jhyoty"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/wsdl/WsdlParser.java", "diffHunk": "@@ -282,22 +288,35 @@ public ServiceInfo(String name, String title, String url,\n             this.wsdlUrl = wsdlUrl;\n         }\n \n+        // cannot change the method signature when overriding so we need to sneakily throw the WsdlParseException\n+        @SneakyThrows(WsdlParseException.class)\n         @Override\n         public InputSource getBaseInputSource() {\n-            try {\n+            try (ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream()) {\n                 URLConnection conn = new URL(wsdlUrl).openConnection();\n                 if (conn instanceof HttpsURLConnection) {\n                     configureHttps((HttpsURLConnection) conn);\n                 }\n \n-                // cache the response\n-                byte[] response;\n                 try (InputStream in = conn.getInputStream()) {\n-                    response = IOUtils.toByteArray(in);\n+                    long count = 0;\n+                    int n;\n+                    byte[] buf = new byte[BUF_SIZE];\n+                    while ((n = in.read(buf)) != -1) {\n+                        count += n;\n+                        if (count > MAX_DESCRIPTION_SIZE) {\n+                            throw new WsdlParseException(\n+                                    \"Error reading WSDL: Size exceeds \" + MAX_DESCRIPTION_SIZE + \" bytes.\");\n+                        }\n+                        byteArrayOutputStream.write(buf, 0, n);\n+                    }\n                 }\n+                byte[] response = byteArrayOutputStream.toByteArray();\n                 log.trace(\"Received WSDL response: {}\", new String(response));\n \n                 return new InputSource(new ByteArrayInputStream(response));\n+            } catch (WsdlParseException e) {\n+                throw e;\n             } catch (Throwable t) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40ece9e3adbafe6317e488c5dac0e9f17e1719b1"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "845d074ffaac13a35572a2374e3619695b0fd13a", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/845d074ffaac13a35572a2374e3619695b0fd13a", "committedDate": "2020-07-08T07:27:17Z", "message": "XRDDEV-1172 Update exception handling // PR fix 1"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTMxMzg1", "url": "https://github.com/nordic-institute/X-Road/pull/577#pullrequestreview-448931385", "createdAt": "2020-07-15T13:04:57Z", "commit": {"oid": "845d074ffaac13a35572a2374e3619695b0fd13a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTMyNTcy", "url": "https://github.com/nordic-institute/X-Road/pull/577#pullrequestreview-448932572", "createdAt": "2020-07-15T13:06:15Z", "commit": {"oid": "845d074ffaac13a35572a2374e3619695b0fd13a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4119, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}