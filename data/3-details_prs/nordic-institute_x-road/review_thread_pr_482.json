{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwODM4NTIy", "number": 482, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToxMjozNVrOD5UVjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1Mzo1MlrOD5VOaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDI4NjIxOnYy", "diffSide": "RIGHT", "path": "src/packages/src/xroad/common/proxy/usr/share/xroad/scripts/backup_db.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToxMjozNVrOGQg2lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToxMjozNVrOGQg2lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2ODY2MQ==", "bodyText": "hard-coded schema serverconf, but the db setup uses configurable schema name (same as username)", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419968661", "createdAt": "2020-05-05T09:12:35Z", "author": {"login": "jhyoty"}, "path": "src/packages/src/xroad/common/proxy/usr/share/xroad/scripts/backup_db.sh", "diffHunk": "@@ -6,7 +6,7 @@ dump_file=\"$1\"\n db_properties=/etc/xroad/db.properties\n db_host=\"127.0.0.1:5432\"\n db_user=\"$(get_prop ${db_properties} 'serverconf.hibernate.connection.username' 'serverconf')\"\n-db_schema=\"$db_user\"\n+db_schema=serverconf", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e35d45dce58b618b95fe35b86cce8f0bba792d0"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDI4NzM4OnYy", "diffSide": "RIGHT", "path": "src/packages/src/xroad/common/proxy/usr/share/xroad/scripts/restore_db.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToxMjo1OFrOGQg3VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToxMjo1OFrOGQg3VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2ODg1Mg==", "bodyText": "hard-coded schema serverconf, but the db setup uses configurable schema name (same as username).", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419968852", "createdAt": "2020-05-05T09:12:58Z", "author": {"login": "jhyoty"}, "path": "src/packages/src/xroad/common/proxy/usr/share/xroad/scripts/restore_db.sh", "diffHunk": "@@ -6,7 +6,7 @@ dump_file=\"$1\"\n db_properties=/etc/xroad/db.properties\n db_host=\"127.0.0.1:5432\"\n db_user=\"$(get_prop ${db_properties} 'serverconf.hibernate.connection.username' 'serverconf')\"\n-db_schema=\"$db_user\"\n+db_schema=serverconf", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e35d45dce58b618b95fe35b86cce8f0bba792d0"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDI5MDg5OnYy", "diffSide": "RIGHT", "path": "src/packages/src/xroad/common/center/usr/share/xroad/scripts/restore_db.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToxMzo1NlrOGQg5jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToxMzo1NlrOGQg5jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk2OTQyMg==", "bodyText": "why is the default schema name hardcoded to centerui?", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419969422", "createdAt": "2020-05-05T09:13:56Z", "author": {"login": "jhyoty"}, "path": "src/packages/src/xroad/common/center/usr/share/xroad/scripts/restore_db.sh", "diffHunk": "@@ -9,7 +9,7 @@ abort() { local rc=$?; echo -e \"FATAL: $*\" >&2; exit $rc; }\n \n DUMP_FILE=$1\n USER=$(get_db_prop 'username' 'centerui')\n-SCHEMA=$(get_db_prop 'schema' \"$USER\")\n+SCHEMA=$(get_db_prop 'schema' 'centerui')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e35d45dce58b618b95fe35b86cce8f0bba792d0"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDMxMTY5OnYy", "diffSide": "RIGHT", "path": "src/packages/src/xroad/redhat/SOURCES/proxy/xroad-proxy-setup.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToxOTo0N1rOGQhF5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToxOTo0N1rOGQhF5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3MjU4MQ==", "bodyText": "On line 139, the username is (potentially) written as user@suffix. During subsequent upgrade, the username is read from properties (line 61), and here the suffix would be re-applied (user@suffix@suffix). And so on.\nI think it would be better to read the username from the properties file, assume that it has the suffix if it is required, and then remove the suffix to get a \"plain\" username which is used where required.", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419972581", "createdAt": "2020-05-05T09:19:47Z", "author": {"login": "jhyoty"}, "path": "src/packages/src/xroad/redhat/SOURCES/proxy/xroad-proxy-setup.sh", "diffHunk": "@@ -85,24 +86,30 @@ setup_database() {\n     local_psql() { su -l -c \"psql -qtA -p ${db_port:-5432} $*\" postgres; }\n     remote_psql() { psql -h \"${db_addr:-127.0.0.1}\" -p \"${db_port:-5432}\" -qtA \"$@\"; }\n \n-    psql_dbuser() {\n-        PGDATABASE=\"$db_database\" PGUSER=\"$db_user\" PGPASSWORD=\"$db_password\" remote_psql \"$@\"\n-    }\n-\n     if [[ -f ${root_properties} && $(get_prop ${root_properties} postgres.connection.password) != \"\" ]]; then\n         local db_master_passwd=$(get_prop ${root_properties} postgres.connection.password)\n         db_master_user=$(get_prop ${root_properties} postgres.connection.user 'postgres')\n+        db_conn_master_user=\"${db_master_user}\"\n+        if [[ $(get_prop ${root_properties} postgres.connection.login_suffix) != \"\" ]]; then\n+            suffix=$(get_prop ${root_properties} postgres.connection.login_suffix)\n+            db_conn_master_user=\"${db_master_user}${suffix}\"\n+            db_conn_user=\"${db_user}${suffix}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e35d45dce58b618b95fe35b86cce8f0bba792d0"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDMyMTA0OnYy", "diffSide": "RIGHT", "path": "src/packages/src/xroad/redhat/SOURCES/opmonitor/xroad-opmonitor-initdb.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToyMjoyNlrOGQhLmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToyMjoyNlrOGQhLmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3NDA0MQ==", "bodyText": "duplicates the suffix if the db_user is already in format user@suffix (as written on line 151)", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419974041", "createdAt": "2020-05-05T09:22:26Z", "author": {"login": "jhyoty"}, "path": "src/packages/src/xroad/redhat/SOURCES/opmonitor/xroad-opmonitor-initdb.sh", "diffHunk": "@@ -73,6 +81,7 @@ then\n \n   db_url=$(get_prop ${db_properties} op-monitor.hibernate.connection.url)\n   db_user=$(get_prop ${db_properties} op-monitor.hibernate.connection.username \"$db_user\")\n+  db_conn_user=\"${db_user}${suffix}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e35d45dce58b618b95fe35b86cce8f0bba792d0"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDMzNDM0OnYy", "diffSide": "RIGHT", "path": "src/packages/src/xroad/redhat/SPECS/xroad-addon-messagelog.spec", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToyNjowOVrOGQhT4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToyNjowOVrOGQhT4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3NjE2Mg==", "bodyText": "can duplicate the suffix if db_user is already in that format.", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419976162", "createdAt": "2020-05-05T09:26:09Z", "author": {"login": "jhyoty"}, "path": "src/packages/src/xroad/redhat/SPECS/xroad-addon-messagelog.spec", "diffHunk": "@@ -66,12 +66,19 @@ rm -rf %{buildroot}\n \n %post\n \n+db_properties=/etc/xroad/db.properties\n+root_properties=/etc/xroad.properties\n db_name=messagelog\n db_url=jdbc:postgresql://127.0.0.1:5432/${db_name}\n db_user=messagelog\n+db_conn_user=\"${db_user}\"\n+if  [[ -f ${root_properties}  && `crudini --get ${root_properties} '' postgres.connection.login_suffix` != \"\" ]]\n+then\n+    suffix=`crudini --get ${root_properties} '' postgres.connection.login_suffix`\n+    db_conn_user=\"${db_user}${suffix}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e35d45dce58b618b95fe35b86cce8f0bba792d0"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDMzOTAxOnYy", "diffSide": "RIGHT", "path": "src/packages/src/xroad/ubuntu/generic/xroad-center.postinst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToyNzoyOVrOGQhWxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOToyNzoyOVrOGQhWxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3NjkwMA==", "bodyText": "the suffix should only be applied if the username does not already contain one.", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419976900", "createdAt": "2020-05-05T09:27:29Z", "author": {"login": "jhyoty"}, "path": "src/packages/src/xroad/ubuntu/generic/xroad-center.postinst", "diffHunk": "@@ -46,11 +46,12 @@ setup_database() {\n     crudini --set \"${db_properties}\" '' host \"${db_addr}\"\n     crudini --set \"${db_properties}\" '' port \"${db_port}\"\n \n-    local db_user=$(get_prop ${db_properties} 'username' 'centerui')\n-    local db_schema=$(get_prop ${db_properties} 'schema' \"$db_user\")\n+    local suffix=$(get_prop ${root_properties} postgres.connection.login_suffix \"\")\n+    local db_user=$(get_prop ${db_properties} 'username' 'centerui')\"${suffix}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e35d45dce58b618b95fe35b86cce8f0bba792d0"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDQzMDU1OnYy", "diffSide": "RIGHT", "path": "src/packages/src/xroad/ubuntu/generic/xroad-proxy.postinst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1MzozM1rOGQiPSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1MzozM1rOGQiPSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MTM3MA==", "bodyText": "if db_user already has the suffix (line 134), the schema name will be invalid", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419991370", "createdAt": "2020-05-05T09:53:33Z", "author": {"login": "jhyoty"}, "path": "src/packages/src/xroad/ubuntu/generic/xroad-proxy.postinst", "diffHunk": "@@ -53,7 +53,8 @@ setup_database() {\n \n     local tmp_password=\"$(head -c 24 /dev/urandom | base64 | tr \"/+\" \"_-\")\"\n     local db_user=$(get_prop ${db_properties} 'serverconf.hibernate.connection.username' 'serverconf')\n-    local db_schema=\"$db_user\"\n+    local db_conn_user=\"${db_user}\"\n+    local db_schema=\"${db_user}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e35d45dce58b618b95fe35b86cce8f0bba792d0"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDQzMTc5OnYy", "diffSide": "RIGHT", "path": "src/packages/src/xroad/ubuntu/generic/xroad-proxy.postinst", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1Mzo1MlrOGQiQBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1Mzo1MlrOGQiQBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MTU1Ng==", "bodyText": "suffix potentially duplicated", "url": "https://github.com/nordic-institute/X-Road/pull/482#discussion_r419991556", "createdAt": "2020-05-05T09:53:52Z", "author": {"login": "jhyoty"}, "path": "src/packages/src/xroad/ubuntu/generic/xroad-proxy.postinst", "diffHunk": "@@ -80,24 +81,30 @@ setup_database() {\n     local_psql() { su -l -c \"psql -qtA -p ${db_port:-5432} ${*@Q}\" postgres; }\n     remote_psql() { psql -h \"${db_addr:-127.0.0.1}\" -p \"${db_port:-5432}\" -qtA \"$@\"; }\n \n-    psql_dbuser() {\n-        PGDATABASE=\"$db_database\" PGUSER=\"$db_user\" PGPASSWORD=\"$db_password\" remote_psql \"$@\"\n-    }\n-\n     if [[ -f ${root_properties} && $(get_prop ${root_properties} postgres.connection.password) != \"\" ]]; then\n         local db_master_passwd=$(get_prop ${root_properties} postgres.connection.password)\n         db_master_user=$(get_prop ${root_properties} postgres.connection.user 'postgres')\n+        db_conn_master_user=\"${db_master_user}\"\n+        if [[ $(get_prop ${root_properties} postgres.connection.login_suffix) != \"\" ]]; then\n+            suffix=$(get_prop ${root_properties} postgres.connection.login_suffix)\n+            db_conn_master_user=\"${db_master_user}${suffix}\"\n+            db_conn_user=\"${db_user}${suffix}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e35d45dce58b618b95fe35b86cce8f0bba792d0"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2856, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}