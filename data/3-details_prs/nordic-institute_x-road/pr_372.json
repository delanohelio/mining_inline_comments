{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1ODI0ODUw", "number": 372, "title": "XRDDEV-882/883 APIs for adding and deleting configured timestamping services", "bodyText": "Implement API for adding new configured timestamping services (XRDDEV-882)\nImplement API for deleting configured timestamping services (XRDDEV-883)\nUpdate OpenAPI description.\nAdd unit tests.", "createdAt": "2020-02-16T13:18:12Z", "url": "https://github.com/nordic-institute/X-Road/pull/372", "merged": true, "mergeCommit": {"oid": "8f201c35ad7343768cdfcb0d43fb9acd5f031445"}, "closed": true, "closedAt": "2020-02-19T08:01:13Z", "author": {"login": "petkivim"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEkQJgAH2gAyMzc1ODI0ODUwOjQ3NzcyODNlMGVjN2RjZDQyZjA4MTIxZmM2ZDRiMmM3NjczYjkyMzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFwJDTAFqTM2MDg1OTA2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4777283e0ec7dcd42f08121fc6d4b2c7673b9234", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/4777283e0ec7dcd42f08121fc6d4b2c7673b9234", "committedDate": "2020-02-15T13:36:00Z", "message": "XRDDEV-910 API for listing configured timestamping services\n\n- Implement API for listing configured timestamping services.\n- Update OpenAPI description.\n- Add unit tests.\n- Enable eager loading of configured timestamping services in serverconf DAO.\n- Implement reverse ordering of returned timestamping services so that they're in the order used by proxy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7b3d17e61166e1720b8c51cf239914d7877766d", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/f7b3d17e61166e1720b8c51cf239914d7877766d", "committedDate": "2020-02-15T13:39:45Z", "message": "XRDDEV-910 Fix proxy-ui-api incorrect target folder in Ansible script\n\n- Change proxy-ui-api target folder from /usr/share/xroad/jlib/webapps to /usr/share/xroad/jlib."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf1d0d372b562d594e8061080ec589e77cf8f606", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/cf1d0d372b562d594e8061080ec589e77cf8f606", "committedDate": "2020-02-15T15:48:58Z", "message": "XRDDEV-910 Update unit tests\n\n- Add new test that verifies that timestamping services are returned in reverse order."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a6412a9b92d499b22465f7de4ffaabf807a4ac5", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/7a6412a9b92d499b22465f7de4ffaabf807a4ac5", "committedDate": "2020-02-16T08:11:36Z", "message": "XRDDEV-910 Refactor loading of configured timestamping services\n\n- Revert changes in server conf DAO.\n- Use Hibernate.initialize to load timestamping service objects.\n- Remove reverse ordering of returned timestamping services."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f643c0883779bf502cf3b40956539db31d8e9ea1", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/f643c0883779bf502cf3b40956539db31d8e9ea1", "committedDate": "2020-02-16T10:39:03Z", "message": "XRDDEV-883 API for deleting configured timestamping services\n\n- Implement API for deleting configured timestamping services.\n- Update OpenAPI description.\n- Add unit tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38d7830b127781a85a300b23ec52210e907073bd", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/38d7830b127781a85a300b23ec52210e907073bd", "committedDate": "2020-02-16T10:55:33Z", "message": "XRDDEV-910 Refactor API and service layers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84bf684235da5d435e78fc44b3a81147cb22b81f", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/84bf684235da5d435e78fc44b3a81147cb22b81f", "committedDate": "2020-02-16T11:07:11Z", "message": "XRDDEV-883 Merge changes from branch XRDDEV-910"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86cfcf8756ef750da8bbb41a7bb809e535ba672b", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/86cfcf8756ef750da8bbb41a7bb809e535ba672b", "committedDate": "2020-02-16T13:12:27Z", "message": "XRDDEV-882 API for adding new configured timestamping services\n\n- Implement API for adding new configured timestamping services.\n- Add unit tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3bc8157950c46f5425d3d3d5be5b3f550985c90", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/d3bc8157950c46f5425d3d3d5be5b3f550985c90", "committedDate": "2020-02-16T13:28:16Z", "message": "XRDDEV-883 Minor refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f2d50ca257a5f1dd2e327a1414d64aad9adec79", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/4f2d50ca257a5f1dd2e327a1414d64aad9adec79", "committedDate": "2020-02-16T14:31:31Z", "message": "XRDDEV-883 Refactor exception messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/16f8bc1c64e70cf1592b13ae542ac8e69f189960", "committedDate": "2020-02-16T14:36:13Z", "message": "XRDDEV-883 Minor regactoring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5Njc3NDE3", "url": "https://github.com/nordic-institute/X-Road/pull/372#pullrequestreview-359677417", "createdAt": "2020-02-17T11:47:27Z", "commit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTo0NzoyN1rOFqhreg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMjo1OTo0OFrOFqjmHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNjMxNA==", "bodyText": "Instead of multi-type-converters with instanceof conditional it would probably be more consistent with the existing converters to have separate convert(Iterable<String> list) and convert(<TspType> list) methods.\nI have another suggestion about removing convert(Iterable) altogether elsewhere, though.", "url": "https://github.com/nordic-institute/X-Road/pull/372#discussion_r380136314", "createdAt": "2020-02-17T11:47:27Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/converter/TimestampingServiceConverter.java", "diffHunk": "@@ -57,7 +59,15 @@ public TimestampingService convert(String url)  {\n         return timestampingService;\n     }\n \n-    public List<TimestampingService> convert(Iterable<String> urls)  {\n-        return Streams.stream(urls).map(this::convert).collect(Collectors.toList());\n+    public TimestampingService convert(TspType tsp)  {\n+        TimestampingService timestampingService = new TimestampingService();\n+        timestampingService.setUrl(tsp.getUrl());\n+        timestampingService.setName(tsp.getName());\n+        return timestampingService;\n+    }\n+\n+    public List<TimestampingService> convert(Iterable<?> list)  {\n+        return Streams.stream(list).map(n -> n instanceof String ? convert((String)n) : convert((TspType)n))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0MDAzMw==", "bodyText": "What do you think about changing this to public Collection<TspType> getApprovedTimestampingServices() with TspType.id = null (and documenting that in the javadoc)? That would make it easier for the callers to handle both types of timestamping services with same constructs, especially it would enable bit of simplification for TimestampingServiceConverter and remove globalConfFacade calls from it. It would make converter layer more thin and dumb and I think unless there's some trouble related to that, we should try to do that to focus business logic inside the service layer. There's some exceptions to this (member name lookups, security server owner lookups) but ideally they should be minimized.", "url": "https://github.com/nordic-institute/X-Road/pull/372#discussion_r380140033", "createdAt": "2020-02-17T11:56:02Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TimestampingServiceService.java", "diffHunk": "@@ -42,20 +47,106 @@\n public class TimestampingServiceService {\n \n     private final GlobalConfService globalConfService;\n+    private final ServerConfService serverConfService;\n \n     /**\n      * constructor\n      */\n     @Autowired\n-    public TimestampingServiceService(GlobalConfService globalConfService) {\n+    public TimestampingServiceService(GlobalConfService globalConfService, ServerConfService serverConfService) {\n         this.globalConfService = globalConfService;\n+        this.serverConfService = serverConfService;\n     }\n \n     /**\n-     * Return timestamping authorities\n+     * Return approved timestamping authorities\n      * @return\n      */\n-    public Collection<String> getTimestampingServices() {\n+    public Collection<String> getApprovedTimestampingServices() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0NDAyOQ==", "bodyText": "There is a possibility to simplify a little bit these \"find first match\" checks by using streams, as in e.g. \n  \n    \n      X-Road/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n    \n    \n        Lines 237 to 242\n      in\n      c5d7658\n    \n    \n    \n    \n\n        \n          \n           Optional<CertificateType> duplicate = clientType.getIsCert().stream() \n        \n\n        \n          \n                   .filter(cert -> hash.equalsIgnoreCase(calculateCertHexHash(cert.getData()))) \n        \n\n        \n          \n                   .findFirst(); \n        \n\n        \n          \n           if (duplicate.isPresent()) { \n        \n\n        \n          \n               throw new CertificateAlreadyExistsException(\"certificate already exists\"); \n        \n\n        \n          \n           }", "url": "https://github.com/nordic-institute/X-Road/pull/372#discussion_r380144029", "createdAt": "2020-02-17T12:05:32Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TimestampingServiceService.java", "diffHunk": "@@ -42,20 +47,106 @@\n public class TimestampingServiceService {\n \n     private final GlobalConfService globalConfService;\n+    private final ServerConfService serverConfService;\n \n     /**\n      * constructor\n      */\n     @Autowired\n-    public TimestampingServiceService(GlobalConfService globalConfService) {\n+    public TimestampingServiceService(GlobalConfService globalConfService, ServerConfService serverConfService) {\n         this.globalConfService = globalConfService;\n+        this.serverConfService = serverConfService;\n     }\n \n     /**\n-     * Return timestamping authorities\n+     * Return approved timestamping authorities\n      * @return\n      */\n-    public Collection<String> getTimestampingServices() {\n+    public Collection<String> getApprovedTimestampingServices() {\n         return globalConfService.getApprovedTspsForThisInstance();\n     }\n+\n+    /**\n+     * Return a list of configured timestamping services\n+     * @return\n+     */\n+    public List<TspType> getConfiguredTimestampingServices() {\n+        return serverConfService.getConfiguredTimestampingServices();\n+    }\n+\n+    public void addConfiguredTimestampingService(TimestampingService timestampingServiceToAdd)\n+            throws TimestampingServiceNotFoundException, DuplicateConfiguredTimestampingServiceException {\n+        // Check that the timestamping service is an approved timestamping service\n+        boolean match = false;\n+        for (String url: getApprovedTimestampingServices()) {\n+            if (timestampingServiceToAdd.getName().equals(globalConfService.getApprovedTspName(url))\n+                    && timestampingServiceToAdd.getUrl().equals(url)) {\n+                match = true;\n+                break;\n+            }\n+        }\n+        if (!match) {\n+            throw new TimestampingServiceNotFoundException(getExceptionMessage(timestampingServiceToAdd.getName(),\n+                    timestampingServiceToAdd.getUrl(), \"not found\"));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0Njk0Mg==", "bodyText": "We've used a convention where ResourceNotFoundException is reserved for resource as in http URL. So since resource is /timestamping-services, that resource exists and the problem is in the request body, not the \"resource\" identified by the URL. By that logic this would be a BadRequestException (a problem with request body).\nAn example of this \n  \n    \n      X-Road/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/TokensApiController.java\n    \n    \n        Lines 207 to 222\n      in\n      c5d7658\n    \n    \n    \n    \n\n        \n          \n           try { \n        \n\n        \n          \n               keyAndCertRequest = keyAndCertificateRequestService.addKeyAndCertRequest( \n        \n\n        \n          \n                       tokenId, keyLabelWithCsrGenerate.getKeyLabel(), \n        \n\n        \n          \n                       memberId, \n        \n\n        \n          \n                       keyUsageInfo, \n        \n\n        \n          \n                       csrGenerate.getCaName(), \n        \n\n        \n          \n                       csrGenerate.getSubjectFieldValues(), \n        \n\n        \n          \n                       csrFormat); \n        \n\n        \n          \n           } catch (ClientNotFoundException | CertificateAuthorityNotFoundException \n        \n\n        \n          \n                   | DnFieldHelper.InvalidDnParameterException e) { \n        \n\n        \n          \n               throw new BadRequestException(e); \n        \n\n        \n          \n           } catch (ActionNotPossibleException e) { \n        \n\n        \n          \n               throw new ConflictException(e); \n        \n\n        \n          \n           } catch (TokenNotFoundException e) { \n        \n\n        \n          \n               throw new ResourceNotFoundException(e); \n        \n\n        \n          \n           } \n        \n    \n  \n\n where ClientNotFoundException -> BadRequestException and TokenNotFoundException -> ResourceNotFound (token id is in the URL)", "url": "https://github.com/nordic-institute/X-Road/pull/372#discussion_r380146942", "createdAt": "2020-02-17T12:12:30Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/TimestampingServicesApiController.java", "diffHunk": "@@ -62,9 +65,42 @@ public TimestampingServicesApiController(TimestampingServiceService timestamping\n \n     @Override\n     @PreAuthorize(\"hasAuthority('VIEW_TSPS')\")\n-    public ResponseEntity<List<TimestampingService>> getTimestampingServices() {\n-        Collection<String> urls = timestampingServiceService.getTimestampingServices();\n-        List<TimestampingService> timestampingServices = timestampingServiceConverter.convert(urls);\n+    public ResponseEntity<List<TimestampingService>> getTimestampingServices(Boolean showConfigured) {\n+        List<TimestampingService> timestampingServices;\n+        // If show configured is true, return configured timestamping services from serverconf db.\n+        // Otherwise return approved timestamping services from global conf.\n+        if (showConfigured) {\n+            List<TspType> tsps = timestampingServiceService.getConfiguredTimestampingServices();\n+            timestampingServices = timestampingServiceConverter.convert(tsps);\n+        } else {\n+            Collection<String> urls = timestampingServiceService.getApprovedTimestampingServices();\n+            timestampingServices = timestampingServiceConverter.convert(urls);\n+        }\n         return new ResponseEntity<>(timestampingServices, HttpStatus.OK);\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('ADD_TSP')\")\n+    public ResponseEntity<TimestampingService> addTimestampingService(TimestampingService timestampingServiceToAdd) {\n+        try {\n+            timestampingServiceService.addConfiguredTimestampingService(timestampingServiceToAdd);\n+        } catch (TimestampingServiceService.DuplicateConfiguredTimestampingServiceException e) {\n+            throw new ConflictException(e);\n+        } catch (TimestampingServiceNotFoundException e) {\n+            throw new ResourceNotFoundException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0NzUxOA==", "bodyText": "Probably BadRequest (see earlier)", "url": "https://github.com/nordic-institute/X-Road/pull/372#discussion_r380147518", "createdAt": "2020-02-17T12:13:48Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/TimestampingServicesApiController.java", "diffHunk": "@@ -62,9 +65,42 @@ public TimestampingServicesApiController(TimestampingServiceService timestamping\n \n     @Override\n     @PreAuthorize(\"hasAuthority('VIEW_TSPS')\")\n-    public ResponseEntity<List<TimestampingService>> getTimestampingServices() {\n-        Collection<String> urls = timestampingServiceService.getTimestampingServices();\n-        List<TimestampingService> timestampingServices = timestampingServiceConverter.convert(urls);\n+    public ResponseEntity<List<TimestampingService>> getTimestampingServices(Boolean showConfigured) {\n+        List<TimestampingService> timestampingServices;\n+        // If show configured is true, return configured timestamping services from serverconf db.\n+        // Otherwise return approved timestamping services from global conf.\n+        if (showConfigured) {\n+            List<TspType> tsps = timestampingServiceService.getConfiguredTimestampingServices();\n+            timestampingServices = timestampingServiceConverter.convert(tsps);\n+        } else {\n+            Collection<String> urls = timestampingServiceService.getApprovedTimestampingServices();\n+            timestampingServices = timestampingServiceConverter.convert(urls);\n+        }\n         return new ResponseEntity<>(timestampingServices, HttpStatus.OK);\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('ADD_TSP')\")\n+    public ResponseEntity<TimestampingService> addTimestampingService(TimestampingService timestampingServiceToAdd) {\n+        try {\n+            timestampingServiceService.addConfiguredTimestampingService(timestampingServiceToAdd);\n+        } catch (TimestampingServiceService.DuplicateConfiguredTimestampingServiceException e) {\n+            throw new ConflictException(e);\n+        } catch (TimestampingServiceNotFoundException e) {\n+            throw new ResourceNotFoundException(e);\n+        }\n+        return new ResponseEntity<>(timestampingServiceToAdd, HttpStatus.CREATED);\n+    }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('DELETE_TSP')\")\n+    public ResponseEntity<Void> deleteTimestampingService(TimestampingService timestampingService) {\n+        try {\n+            timestampingServiceService.deleteConfiguredTimestampingService(timestampingService);\n+        } catch (TimestampingServiceNotFoundException e) {\n+            throw new ResourceNotFoundException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1MTc4Mw==", "bodyText": "We have used convention where response has Location header which points to created entity. There is a helper to make this convenient, \n  \n    \n      X-Road/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n    \n    \n         Line 308\n      in\n      c5d7658\n    \n    \n    \n    \n\n        \n          \n           return createCreatedResponse(\"/api/local-groups/{id}\", createdGroup, localGroupType.getId()); \n        \n    \n  \n\n\nWe do not have a single-item-getter for timestamping services, so I wonder which would be better, a) point to all-items-getter /token-certificates or b) not include Location header at all?", "url": "https://github.com/nordic-institute/X-Road/pull/372#discussion_r380151783", "createdAt": "2020-02-17T12:23:22Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/TimestampingServicesApiController.java", "diffHunk": "@@ -62,9 +65,42 @@ public TimestampingServicesApiController(TimestampingServiceService timestamping\n \n     @Override\n     @PreAuthorize(\"hasAuthority('VIEW_TSPS')\")\n-    public ResponseEntity<List<TimestampingService>> getTimestampingServices() {\n-        Collection<String> urls = timestampingServiceService.getTimestampingServices();\n-        List<TimestampingService> timestampingServices = timestampingServiceConverter.convert(urls);\n+    public ResponseEntity<List<TimestampingService>> getTimestampingServices(Boolean showConfigured) {\n+        List<TimestampingService> timestampingServices;\n+        // If show configured is true, return configured timestamping services from serverconf db.\n+        // Otherwise return approved timestamping services from global conf.\n+        if (showConfigured) {\n+            List<TspType> tsps = timestampingServiceService.getConfiguredTimestampingServices();\n+            timestampingServices = timestampingServiceConverter.convert(tsps);\n+        } else {\n+            Collection<String> urls = timestampingServiceService.getApprovedTimestampingServices();\n+            timestampingServices = timestampingServiceConverter.convert(urls);\n+        }\n         return new ResponseEntity<>(timestampingServices, HttpStatus.OK);\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('ADD_TSP')\")\n+    public ResponseEntity<TimestampingService> addTimestampingService(TimestampingService timestampingServiceToAdd) {\n+        try {\n+            timestampingServiceService.addConfiguredTimestampingService(timestampingServiceToAdd);\n+        } catch (TimestampingServiceService.DuplicateConfiguredTimestampingServiceException e) {\n+            throw new ConflictException(e);\n+        } catch (TimestampingServiceNotFoundException e) {\n+            throw new ResourceNotFoundException(e);\n+        }\n+        return new ResponseEntity<>(timestampingServiceToAdd, HttpStatus.CREATED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1NTcxMg==", "bodyText": "Consider making timestampingServiceService.addConfiguredTimestampingService public TimestampingService addConfiguredTimestampingService(TimestampingService timestampingServiceToAdd) and returning the created object?\nNow if I understand correctly API returns partial TimestampingService object with empty updated_at, message and status? This is a bit inconsistent with how other creates work, an example:\n\n  \n    \n      X-Road/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n    \n    \n        Lines 299 to 307\n      in\n      c5d7658\n    \n    \n    \n    \n\n        \n          \n           try { \n        \n\n        \n          \n               localGroupType = localGroupService.addLocalGroup(clientType.getIdentifier(), \n        \n\n        \n          \n                       localGroupConverter.convert(localGroup)); \n        \n\n        \n          \n           } catch (LocalGroupService.DuplicateLocalGroupCodeException e) { \n        \n\n        \n          \n               throw new ConflictException(e); \n        \n\n        \n          \n           } catch (ClientNotFoundException e) { \n        \n\n        \n          \n               throw new ResourceNotFoundException(e); \n        \n\n        \n          \n           } \n        \n\n        \n          \n           LocalGroup createdGroup = localGroupConverter.convert(localGroupType); \n        \n    \n  \n\n\nIt probably does not make sense to go through lots of effort to get this perfect, but at least low hanging fruits can be picked.\nSomething in guidelines about this: https://confluence.niis.org/pages/viewpage.action?pageId=8520435#APIGuidelines&Examples-POSTandPUTshouldreturnusefuldatapostputconvention", "url": "https://github.com/nordic-institute/X-Road/pull/372#discussion_r380155712", "createdAt": "2020-02-17T12:32:21Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/TimestampingServicesApiController.java", "diffHunk": "@@ -62,9 +65,42 @@ public TimestampingServicesApiController(TimestampingServiceService timestamping\n \n     @Override\n     @PreAuthorize(\"hasAuthority('VIEW_TSPS')\")\n-    public ResponseEntity<List<TimestampingService>> getTimestampingServices() {\n-        Collection<String> urls = timestampingServiceService.getTimestampingServices();\n-        List<TimestampingService> timestampingServices = timestampingServiceConverter.convert(urls);\n+    public ResponseEntity<List<TimestampingService>> getTimestampingServices(Boolean showConfigured) {\n+        List<TimestampingService> timestampingServices;\n+        // If show configured is true, return configured timestamping services from serverconf db.\n+        // Otherwise return approved timestamping services from global conf.\n+        if (showConfigured) {\n+            List<TspType> tsps = timestampingServiceService.getConfiguredTimestampingServices();\n+            timestampingServices = timestampingServiceConverter.convert(tsps);\n+        } else {\n+            Collection<String> urls = timestampingServiceService.getApprovedTimestampingServices();\n+            timestampingServices = timestampingServiceConverter.convert(urls);\n+        }\n         return new ResponseEntity<>(timestampingServices, HttpStatus.OK);\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('ADD_TSP')\")\n+    public ResponseEntity<TimestampingService> addTimestampingService(TimestampingService timestampingServiceToAdd) {\n+        try {\n+            timestampingServiceService.addConfiguredTimestampingService(timestampingServiceToAdd);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE2MzQ2Ng==", "bodyText": "Maybe consider renaming so that the \"only\" part becomes obvious. show_configured could be interpreted as\n\nno parameter / show_configured = false: show all except \"configured\" ones\nshow_configured = true: show all", "url": "https://github.com/nordic-institute/X-Road/pull/372#discussion_r380163466", "createdAt": "2020-02-17T12:50:22Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/resources/openapi-definition.yaml", "diffHunk": "@@ -3179,6 +3179,14 @@ paths:\n       summary: view the timestamping services\n       operationId: getTimestampingServices\n       description: Administrator views the timestamping services.\n+      parameters:\n+        - in: query\n+          name: show_configured", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE2NjE5NQ==", "bodyText": "using http DELETE with a request body is problematic. Specifications-wise it is on some kind of grey area, and e.g. support from some clients / load balancers etc might vary https://stackoverflow.com/questions/299628/is-an-entity-body-allowed-for-an-http-delete-request\nFor that reason we decided to have e.g. POST /service-clients/{id}/access-rights/delete and to be consistent this should be POST as well.", "url": "https://github.com/nordic-institute/X-Road/pull/372#discussion_r380166195", "createdAt": "2020-02-17T12:56:32Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/resources/openapi-definition.yaml", "diffHunk": "@@ -3235,23 +3243,18 @@ paths:\n           description: an existing item already exists\n         '500':\n           description: internal server error\n-  /timestamping-services/{url}:\n     delete: # ok", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE2NzA5OA==", "bodyText": "Delete and Add now take full TimestampingService object with unnecessary updated_at, message, status. Maybe consider making those readOnly properties, or creating a separate TimestampingServiceIdentifier { name, url } for delete and add, or moving updated_at, message, status to a different object reserved for diagnostics view only.", "url": "https://github.com/nordic-institute/X-Road/pull/372#discussion_r380167098", "createdAt": "2020-02-17T12:58:29Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/resources/openapi-definition.yaml", "diffHunk": "@@ -3235,23 +3243,18 @@ paths:\n           description: an existing item already exists\n         '500':\n           description: internal server error\n-  /timestamping-services/{url}:\n     delete: # ok\n       tags:\n         - security server\n       summary: delete timestamping service\n       operationId: deleteTimestampingService\n       description: Administrator removes timestamping service.\n-      parameters:\n-        - in: path\n-          name: url\n-          description: url of the timestamping service\n-          required: true\n-          schema:\n-            type: string\n-            format: text\n-            minLength: 1\n-            maxLength: 255\n+      requestBody:\n+        description: Timestamping service to delete\n+        content:\n+          application/json:\n+            schema:\n+              $ref: '#/components/schemas/TimestampingService'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE2NzcwOQ==", "bodyText": "Different API structure without the show_configured might be more clear, after all:\nGET /timestamping-services/ (global)\nGET /system/timestamping-services/ (local)\nPOST /system/timestamping-services/ (add local)\nDELETE /system/timestamping-services/ (delete local) (actually POST /system/timestamping-services/delete)", "url": "https://github.com/nordic-institute/X-Road/pull/372#discussion_r380167709", "createdAt": "2020-02-17T12:59:48Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/resources/openapi-definition.yaml", "diffHunk": "@@ -3179,6 +3179,14 @@ paths:\n       summary: view the timestamping services\n       operationId: getTimestampingServices\n       description: Administrator views the timestamping services.\n+      parameters:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8bc1c64e70cf1592b13ae542ac8e69f189960"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a574e7c8cacc4a4472d5f209f55b7e52bcd3b3fa", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/a574e7c8cacc4a4472d5f209f55b7e52bcd3b3fa", "committedDate": "2020-02-17T15:12:45Z", "message": "XRDDEV-883 Updates based on review comments\n\n- Refactor timestamping services API structure\n- Move configured timestamping services endpoints under /system\n- Remove updated_at, message and status attributes from TimestampingService object\n- Create new TimestampingServiceDiagnostics object\n- Update unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e750d03b8d2b96320d11b1605d0d6d56eefa5ba5", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/e750d03b8d2b96320d11b1605d0d6d56eefa5ba5", "committedDate": "2020-02-18T20:26:02Z", "message": "XRDDEV-883 alternative converter/service allocation of responsibilities"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwODU5MDYy", "url": "https://github.com/nordic-institute/X-Road/pull/372#pullrequestreview-360859062", "createdAt": "2020-02-19T06:01:02Z", "commit": {"oid": "e750d03b8d2b96320d11b1605d0d6d56eefa5ba5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4320, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}