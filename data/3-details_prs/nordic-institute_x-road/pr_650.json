{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4Mjk4NTg3", "number": 650, "title": "XRDDEV-1248/XRDDEV-1249", "bodyText": "Add warning dialog when auth key with registered cert is deleted:\n\nWarning dialog is shown when an auth key with a registered certificate is deleted.\nAuth cert is unregistered and key + cert deleted if the dialog is approved.\nAdd loading state to the Delete key button.\nThrow an UnhandledWarningsException if auth key has a registered certificate when it's deleted.\nAdd ignore_warnings URL param to delete key endpoint.\nUpdate OpenAPI description.\nAdd unit test.\n\nFrontend JIRA issue: https://jira.niis.org/browse/XRDDEV-1249\nBackend JIRA issue: https://jira.niis.org/browse/XRDDEV-1248", "createdAt": "2020-08-15T12:04:49Z", "url": "https://github.com/nordic-institute/X-Road/pull/650", "merged": true, "mergeCommit": {"oid": "e0db7f71468815431c6b4a1e394c6ae086bb7545"}, "closed": true, "closedAt": "2020-08-20T11:34:29Z", "author": {"login": "petkivim"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_EE-fAH2gAyNDY4Mjk4NTg3OjdhN2I5NmFlMzFlNGVkNzI1N2NhNmJhNjdmOGVmNjIwOTkzMDk1M2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAuly2gFqTQ3MTUwNTU2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7a7b96ae31e4ed7257ca6ba67f8ef6209930953a", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/7a7b96ae31e4ed7257ca6ba67f8ef6209930953a", "committedDate": "2020-08-15T07:28:22Z", "message": "XRDDEV-1248 Update delete key service\n\n- Throw an UnhandledWarningsException if auth key has a registered certificate when it's deleted.\n- Add ignore_warnings URL param to delete key endpoint.\n- Update OpenAPI description.\n- Add unit test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8179c302e22c28b30ac9700be6d4d7f7396bea45", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/8179c302e22c28b30ac9700be6d4d7f7396bea45", "committedDate": "2020-08-15T07:41:09Z", "message": "XRDDEV-1248 Update warning code and localisation string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5190ad342e08e46a9558d27aaf4c7f72865b162e", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/5190ad342e08e46a9558d27aaf4c7f72865b162e", "committedDate": "2020-08-15T07:43:05Z", "message": "XRDDEV-1249 Add loading state to the Delete key button"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4ecfbc94b2e1cc18cbb82c0ccf92f0df5463937", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/c4ecfbc94b2e1cc18cbb82c0ccf92f0df5463937", "committedDate": "2020-08-15T07:48:11Z", "message": "XRDDEV-1249 Update localisations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bb6dc35d736614a33fb28270855c225cacec00b", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/5bb6dc35d736614a33fb28270855c225cacec00b", "committedDate": "2020-08-15T12:00:52Z", "message": "XRDDEV-1249 Add warning dialog when auth key with registered cert is deleted\n\n- Warning dialog is shown when an auth key with a registered certificate is deleted.\n- Auth cert is unregistered and key + cert deleted if the dialog is approved.\n- Update localisations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "642e4ccf90e7f5a0fa8b9149bb32ee037b647a38", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/642e4ccf90e7f5a0fa8b9149bb32ee037b647a38", "committedDate": "2020-08-15T14:24:17Z", "message": "XRDDEV-1248 Refactor delete key method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f93c21e05a1c119c4689d3206cbfcededf6261d", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/9f93c21e05a1c119c4689d3206cbfcededf6261d", "committedDate": "2020-08-15T15:13:51Z", "message": "XRDDEV-1248 Update comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMjc2MTAy", "url": "https://github.com/nordic-institute/X-Road/pull/650#pullrequestreview-471276102", "createdAt": "2020-08-20T06:19:46Z", "commit": {"oid": "9f93c21e05a1c119c4689d3206cbfcededf6261d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNjoxOTo0NlrOHDsqbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNjo0ODo1MVrOHDt-Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzOTUzMw==", "bodyText": "Swallowing exceptions should almost never be done. Even if UnhandledWarningsException should indeed be impossible, wrapping it as RuntimeException is preferrable, in case there's some weird bug that does cause UnhandledWarningsException, or if someone later changes code so that our current assumptions are not valid anymore. Even if unlikely, I've seen those two things happen, and then it may mean a long bughunt since from outside everything looks like the key delete was successful.\nAdding throw new RuntimeException(e); here also does not have any real downside, in case we are correct and this never happens. Comment is a good one to keep IMO, to explain this to updater.", "url": "https://github.com/nordic-institute/X-Road/pull/650#discussion_r473639533", "createdAt": "2020-08-20T06:19:46Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/KeyService.java", "diffHunk": "@@ -202,15 +206,27 @@ private static String signerFaultCode(String detail) {\n \n     static final String KEY_NOT_FOUND_FAULT_CODE = signerFaultCode(X_KEY_NOT_FOUND);\n \n+    public void deleteKey(String keyId) throws KeyNotFoundException, ActionNotPossibleException,\n+            GlobalConfOutdatedException {\n+        try {\n+            deleteKey(keyId, true);\n+        } catch (UnhandledWarningsException e) {\n+            // Since \"ignoreWarnings = true\", the exception is never thrown", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f93c21e05a1c119c4689d3206cbfcededf6261d"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY0OTc0Nw==", "bodyText": "Hmmm. I feel we might need to better explain users what the warnings related to this operation could be? Like in this case, give specifics so that user understands the warnings are about registered auth certificates?\nYou could also instead (or, also) explain these things in the markdown documentation, but maybe the openapi definition is a pretty good place for this?\nClient add says this in definition-part:\n      description: >\n        Adds new client to the system.\n        Note that with this endpoint it is possible to add an unregistered member as a client.\n        Attempt to add an unregistered member with ClientAdd.ignore_warnings = false causes the operation to fail with a warning in response's ErrorInfo object.\n        Attempt to add an unregistered member with ClientAdd.ignore_warnings = true succeeds.\n\nBut unfortunately this is not consistent, other endpoints with an ignore_warnings possibility do not have the same type of explanation.\nThis ticket could add some explanation of warnings for this endpoint, or maybe documentation for all endpoints could be updated and made consistent in a separate ticket....", "url": "https://github.com/nordic-institute/X-Road/pull/650#discussion_r473649747", "createdAt": "2020-08-20T06:33:47Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/resources/openapi-definition.yaml", "diffHunk": "@@ -2154,6 +2154,14 @@ paths:\n             type: string\n             format: text\n             minLength: 1\n+        - in: query\n+          name: ignore_warnings\n+          description: if true, any ignorable warnings are ignored. if false (or missing),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f93c21e05a1c119c4689d3206cbfcededf6261d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY2MDk1MQ==", "bodyText": "Would be good to add javadocs to old public void deleteKey(String keyId) { so that it explains the ignoreWarnings = true deal. (weird, I thought checkstyle requires javadocs for public methods. It is good practice to have those anyhow)\nMaybe also consider changing old method name to something like deleteKeyAndIgnoreWarnings, or removing it altogether and using deleteKey(keyId, true) instead. Does having a shorthand version, without boolean parameter, make things better or worse? Maybe without it code might be more clear and more explicit about what is the intended action. Well, not sure about that one really.", "url": "https://github.com/nordic-institute/X-Road/pull/650#discussion_r473660951", "createdAt": "2020-08-20T06:48:51Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/KeysApiController.java", "diffHunk": "@@ -225,14 +226,14 @@ private Key getKeyFromService(String keyId) {\n     @Override\n     @PreAuthorize(\"hasAnyAuthority('DELETE_KEY', 'DELETE_AUTH_KEY', 'DELETE_SIGN_KEY')\")\n     @AuditEventMethod(event = DELETE_KEY)\n-    public ResponseEntity<Void> deleteKey(String keyId) {\n+    public ResponseEntity<Void> deleteKey(String keyId, Boolean ignoreWarnings) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f93c21e05a1c119c4689d3206cbfcededf6261d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "867b20c8fa741d6c33c51465aa39e414f413b5af", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/867b20c8fa741d6c33c51465aa39e414f413b5af", "committedDate": "2020-08-20T10:06:07Z", "message": "XRDDEV-1248 Update based on review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ec246a59bdfd25dbbf86edfa35a13a67c40c944", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/4ec246a59bdfd25dbbf86edfa35a13a67c40c944", "committedDate": "2020-08-20T10:08:21Z", "message": "XRDDEV-1248 Update comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNTA1NTYy", "url": "https://github.com/nordic-institute/X-Road/pull/650#pullrequestreview-471505562", "createdAt": "2020-08-20T11:34:09Z", "commit": {"oid": "4ec246a59bdfd25dbbf86edfa35a13a67c40c944"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4056, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}