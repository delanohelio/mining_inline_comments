{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3MjY5MjQ4", "number": 472, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwNjoyMzo1MFrOD1nPNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMDoxODozNFrOD47cfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3NTQzOTkxOnYy", "diffSide": "RIGHT", "path": "src/serverconf/src/main/java/ee/ria/xroad/common/conf/serverconf/IsAuthentication.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwNjoyMzo1MFrOGLIY0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwOToyNDoyMFrOGLOw_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyNDk0Ng==", "bodyText": "Since the original isCerts.contains(auth.getCert()) already verifies that the cert is one of the IS certs, iterating the list is unnecessary. One could after that test safely check the validity of the received certificate (auth.getCert().checkValidity()).\nI'd also argue that it would be more readable (and perhaps a bit more efficient) than using a stream.", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r414324946", "createdAt": "2020-04-24T06:23:50Z", "author": {"login": "jhyoty"}, "path": "src/serverconf/src/main/java/ee/ria/xroad/common/conf/serverconf/IsAuthentication.java", "diffHunk": "@@ -90,10 +93,18 @@ public static void verifyClientAuthentication(ClientId client,\n                         \"Client (%s) has no IS certificates\", client);\n             }\n \n-            if (!isCerts.contains(auth.getCert())) {\n-                throw new CodedException(X_SSL_AUTH_FAILED,\n-                        \"Client (%s) TLS certificate does not match any\"\n-                                + \" IS certificates\", client);\n+            X509Certificate isCert = isCerts.stream()\n+                    .filter(c -> Objects.equals(c, auth.getCert()))\n+                    .findFirst()\n+                    .orElseThrow(() -> new CodedException(X_SSL_AUTH_FAILED,\n+                    \"Client (%s) TLS certificate does not match any\"\n+                                    + \" IS certificates\", client));\n+            try {\n+                isCert.checkValidity();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be9f7a97a340d3d1bfd41083083ce86c4c65a4f4"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyOTQzOA==", "bodyText": "Done", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r414429438", "createdAt": "2020-04-24T09:24:20Z", "author": {"login": "martensoo"}, "path": "src/serverconf/src/main/java/ee/ria/xroad/common/conf/serverconf/IsAuthentication.java", "diffHunk": "@@ -90,10 +93,18 @@ public static void verifyClientAuthentication(ClientId client,\n                         \"Client (%s) has no IS certificates\", client);\n             }\n \n-            if (!isCerts.contains(auth.getCert())) {\n-                throw new CodedException(X_SSL_AUTH_FAILED,\n-                        \"Client (%s) TLS certificate does not match any\"\n-                                + \" IS certificates\", client);\n+            X509Certificate isCert = isCerts.stream()\n+                    .filter(c -> Objects.equals(c, auth.getCert()))\n+                    .findFirst()\n+                    .orElseThrow(() -> new CodedException(X_SSL_AUTH_FAILED,\n+                    \"Client (%s) TLS certificate does not match any\"\n+                                    + \" IS certificates\", client));\n+            try {\n+                isCert.checkValidity();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyNDk0Ng=="}, "originalCommit": {"oid": "be9f7a97a340d3d1bfd41083083ce86c4c65a4f4"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3NjQzNDE0OnYy", "diffSide": "LEFT", "path": "src/serverconf/src/main/java/ee/ria/xroad/common/conf/serverconf/IsAuthentication.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDozMzowOFrOGLRXtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzozODowMVrOGLiOwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3MjExNw==", "bodyText": "The \"does the cert exist\" check is missing.", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r414472117", "createdAt": "2020-04-24T10:33:08Z", "author": {"login": "jhyoty"}, "path": "src/serverconf/src/main/java/ee/ria/xroad/common/conf/serverconf/IsAuthentication.java", "diffHunk": "@@ -89,11 +92,13 @@ public static void verifyClientAuthentication(ClientId client,\n                 throw new CodedException(X_SSL_AUTH_FAILED,\n                         \"Client (%s) has no IS certificates\", client);\n             }\n-\n-            if (!isCerts.contains(auth.getCert())) {\n-                throw new CodedException(X_SSL_AUTH_FAILED,\n-                        \"Client (%s) TLS certificate does not match any\"\n-                                + \" IS certificates\", client);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "101740ce8655ec75b8932dab9d55fe5b3f78f337"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0ODM1NA==", "bodyText": "Should be back now", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r414748354", "createdAt": "2020-04-24T17:38:01Z", "author": {"login": "martensoo"}, "path": "src/serverconf/src/main/java/ee/ria/xroad/common/conf/serverconf/IsAuthentication.java", "diffHunk": "@@ -89,11 +92,13 @@ public static void verifyClientAuthentication(ClientId client,\n                 throw new CodedException(X_SSL_AUTH_FAILED,\n                         \"Client (%s) has no IS certificates\", client);\n             }\n-\n-            if (!isCerts.contains(auth.getCert())) {\n-                throw new CodedException(X_SSL_AUTH_FAILED,\n-                        \"Client (%s) TLS certificate does not match any\"\n-                                + \" IS certificates\", client);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3MjExNw=="}, "originalCommit": {"oid": "101740ce8655ec75b8932dab9d55fe5b3f78f337"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMDIwNzk4OnYy", "diffSide": "RIGHT", "path": "doc/Manuals/ug-syspar_x-road_v6_system_parameters.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMDoxODozNFrOGP6X2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNTo1MToxMlrOGQbQPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMzODIwMA==", "bodyText": "Perhaps the parameter name should be ~ enforce-client-is-certificate-validity-period because there are also other certificates this setting does not control. The explanation could also be a bit more abstract, something like whether to reject a request when client information system certificate is expired or not yet valid; throwing and exception is an implementation detail.", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r419338200", "createdAt": "2020-05-04T10:18:34Z", "author": {"login": "jhyoty"}, "path": "doc/Manuals/ug-syspar_x-road_v6_system_parameters.md", "diffHunk": "@@ -262,7 +263,7 @@ This chapter describes the system parameters used by the components of the X-Roa\n | server-conf-client-cache-size                    | 100                                        |   |   | Maximum number of local clients to keep cached |\n | server-conf-service-cache-size                   | 1000                                       |   |   | Maximum number of services to keep cached |\n | server-conf-acl-cache-size                       | 100000                                     |   |   | Maximum number of access rights to keep cached in memory. |\n-\n+| enforce-certificate-validity-period-check        | false                                      |   |   | Whether to throw an exception about expired or not yet valid certificates. |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "731d1330bc776fede1cfcf9282ca22d71b83d104"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg3NjkyNw==", "bodyText": "Changed the name", "url": "https://github.com/nordic-institute/X-Road/pull/472#discussion_r419876927", "createdAt": "2020-05-05T05:51:12Z", "author": {"login": "martensoo"}, "path": "doc/Manuals/ug-syspar_x-road_v6_system_parameters.md", "diffHunk": "@@ -262,7 +263,7 @@ This chapter describes the system parameters used by the components of the X-Roa\n | server-conf-client-cache-size                    | 100                                        |   |   | Maximum number of local clients to keep cached |\n | server-conf-service-cache-size                   | 1000                                       |   |   | Maximum number of services to keep cached |\n | server-conf-acl-cache-size                       | 100000                                     |   |   | Maximum number of access rights to keep cached in memory. |\n-\n+| enforce-certificate-validity-period-check        | false                                      |   |   | Whether to throw an exception about expired or not yet valid certificates. |", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMzODIwMA=="}, "originalCommit": {"oid": "731d1330bc776fede1cfcf9282ca22d71b83d104"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2839, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}