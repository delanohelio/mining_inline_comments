{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5ODUxNjA5", "number": 415, "title": "XRDDEV-880 Upload anchor", "bodyText": "upload a new configuration anchor\npreview a new configuration anchor\n\nJIRA: https://jira.niis.org/browse/XRDDEV-880", "createdAt": "2020-03-17T13:55:34Z", "url": "https://github.com/nordic-institute/X-Road/pull/415", "merged": true, "mergeCommit": {"oid": "c90a2948f37e758a4eb081a1d3e919bfcbdcf7af"}, "closed": true, "closedAt": "2020-04-03T10:30:01Z", "author": {"login": "carohauta"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOLY0OgH2gAyMzg5ODUxNjA5OmQ1MGQ2MjJhYzBmYmNhYTI0MWVkNjZkMGZjOTdmNDE1MjdmNjZkNjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT74dvgFqTM4NzAxMDIzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d50d622ac0fbcaa241ed66d0fc97f41527f66d69", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/d50d622ac0fbcaa241ed66d0fc97f41527f66d69", "committedDate": "2020-03-16T10:17:05Z", "message": "XRDDEV-880 Upload anchor\n\n* initial service and controller methods\n* API definitions\n* new constructor in ConfigurationAnchorV2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f76443d7569d900e789ae76ae6d4efa0e6a24ccc", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/f76443d7569d900e789ae76ae6d4efa0e6a24ccc", "committedDate": "2020-03-16T15:39:01Z", "message": "XRDDEV-880 Upload anchor // verification and saving"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18454cede040164aa27cfcc3e7ef84015621ad38", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/18454cede040164aa27cfcc3e7ef84015621ad38", "committedDate": "2020-03-17T07:50:38Z", "message": "XRDDEV-880 Upload anchor // cleanup\n\n* still WIP: tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16032a21422bf0c29f54f19db147e33228c06276", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/16032a21422bf0c29f54f19db147e33228c06276", "committedDate": "2020-03-17T12:23:35Z", "message": "XRDDEV-880 Upload anchor // tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca1befc3e91ad4cfb107fb69a71e092452c9c54e", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/ca1befc3e91ad4cfb107fb69a71e092452c9c54e", "committedDate": "2020-03-17T13:50:52Z", "message": "XRDDEV-880 Upload anchor // checkstyle\n\n* added missing tests for ExternalProcessRunner\n* checkstyler fixes\n* test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9c97efc98777f98ac5ffae16fae84bf60f5099f", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/e9c97efc98777f98ac5ffae16fae84bf60f5099f", "committedDate": "2020-03-24T13:25:14Z", "message": "Merge branch 'develop' into XRDDEV-880-upload-anchor\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/SystemServiceTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/620778fef93c1aa59e19ff7d32c2dbebf76bea80", "committedDate": "2020-03-26T06:57:20Z", "message": "Merge branch 'develop' into XRDDEV-880-upload-anchor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNzQzMzM0", "url": "https://github.com/nordic-institute/X-Road/pull/415#pullrequestreview-381743334", "createdAt": "2020-03-26T07:04:42Z", "commit": {"oid": "e9c97efc98777f98ac5ffae16fae84bf60f5099f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwNzoxMzo0NlrOF75yxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMTozMToyMVrOF8CnMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM1NzE4OQ==", "bodyText": "So it seems that this constructor results in a different kind of ConfigurationAnchorV2 object than the filename-based one. Due to differences in AbstractXmlConf.load(byte[]) and AbstractXmlConf.load(String), one results in an object that has FileContentChangeChecker, other does not.\nThis is probably fine, and it makes sense that byte[] based object does not have a FileContentChangeChecker if you dig into the internals to see it, and the new variant of ConfigurationAnchorV2 object is used in such a way that missing FileContentChangeChecker is what we want - but should be clearly documented in the new ConfigurationAnchorV2 and AbstractXmlConf constructors. \"use this if you want to do X, use other if you want to do Y\". Otherwise someone can think one is a convenience constructor that still creates an identical object, and use the wrong constructor.", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398357189", "createdAt": "2020-03-26T07:13:46Z", "author": {"login": "jansu76"}, "path": "src/common-util/src/main/java/ee/ria/xroad/common/conf/globalconf/ConfigurationAnchorV2.java", "diffHunk": "@@ -56,6 +56,13 @@ public ConfigurationAnchorV2(String fileName) {\n                 PrivateParametersSchemaValidatorV2.class); // also applies to stand-alone configuration source\n     }\n \n+    /**\n+     * @param fileBytes the configuration anchor file bytes\n+     */\n+    public ConfigurationAnchorV2(byte[] fileBytes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2MjU0OQ==", "bodyText": "I initially though this should be a PUT but now that I think again, maybe POST is better? Is the logic something like we have a hidden \"sink\" of anchor preview versions? You can add more items to the resource, but you can never get the items out. Kind of like dev/null.\nWhat do you think of plural /system/anchor/previews actually? Would that be more consistent with our naming conventions? If we try to prefer resource names / subjects instead of actions / verbs when possible (preview could be either, not sure which meaning it has now here).", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398362549", "createdAt": "2020-03-26T07:27:40Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/resources/openapi-definition.yaml", "diffHunk": "@@ -3111,17 +3111,47 @@ paths:\n         - security server\n       summary: upload a configuration anchor file\n       operationId: uploadAnchor\n-      description: Administrator uploads configuration anchor file\n+      description: Administrator uploads a configuration anchor file\n       requestBody:\n         description: configuration anchor\n         content:\n-          application/xml:\n+          application/octet-stream:\n+            schema:\n+              type: string\n+              format: binary\n+              description: configuration anchor file\n+      responses:\n+        '201':\n+          description: configuration anchor uploaded\n+        '400':\n+          description: request was invalid\n+        '401':\n+          description: authentication credentials are missing\n+        '403':\n+          description: request has been refused\n+        '404':\n+          description: resource requested does not exists\n+        '406':\n+          description: request specified an invalid format\n+        '409':\n+          description: an existing item already exists\n+        '500':\n+          description: internal server error\n+  /system/anchor/preview:\n+    post: # ok", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2MzMxOQ==", "bodyText": "Maybe should mention that the anchor is also validated, e.g. if it is for wrong instance, error will be returned? Now it sounds like the purpose of this endpoint is only to find out the hash.", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398363319", "createdAt": "2020-03-26T07:29:32Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/resources/openapi-definition.yaml", "diffHunk": "@@ -3111,17 +3111,47 @@ paths:\n         - security server\n       summary: upload a configuration anchor file\n       operationId: uploadAnchor\n-      description: Administrator uploads configuration anchor file\n+      description: Administrator uploads a configuration anchor file\n       requestBody:\n         description: configuration anchor\n         content:\n-          application/xml:\n+          application/octet-stream:\n+            schema:\n+              type: string\n+              format: binary\n+              description: configuration anchor file\n+      responses:\n+        '201':\n+          description: configuration anchor uploaded\n+        '400':\n+          description: request was invalid\n+        '401':\n+          description: authentication credentials are missing\n+        '403':\n+          description: request has been refused\n+        '404':\n+          description: resource requested does not exists\n+        '406':\n+          description: request specified an invalid format\n+        '409':\n+          description: an existing item already exists\n+        '500':\n+          description: internal server error\n+  /system/anchor/preview:\n+    post: # ok\n+      tags:\n+        - security server\n+      summary: Read the configuration anchor file and return the hash for a preview. The anchor will not be saved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2OTM3MA==", "bodyText": "Should throw IOException instead of Exception?", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398369370", "createdAt": "2020-03-26T07:43:51Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/AnchorRepository.java", "diffHunk": "@@ -69,4 +71,12 @@\n     public ConfigurationAnchorV2 loadAnchorFromFile() {\n         return new ConfigurationAnchorV2(CONFIGURATION_ANCHOR_FILENAME);\n     }\n+\n+    /**\n+     * Save anchor. The replacing of the old anchor file is done atomically.\n+     * @return\n+     */\n+    public void saveAndReplace(File anchorFile) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3MjQzNg==", "bodyText": "Nice! \ud83d\udc4d", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398372436", "createdAt": "2020-03-26T07:50:24Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ConfigurationVerifier.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import lombok.Setter;\n+import org.niis.xroad.restapi.exceptions.ErrorDeviation;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Verify internal and external configurations\n+ */\n+@Component\n+public class ConfigurationVerifier {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NTYxMQ==", "bodyText": "Why is ConfigurationVerificationException unchecked? My initial feel was to have it as checked, as validating the contents of the anchor file is a major part of what this method does.\nFirst I commented about if it should be http 400 instead of http 500, but I guess these exceptions are about what happens after global config has been fetched from external source, and that global config is invalid, so 500 is the correct one?", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398375611", "createdAt": "2020-03-26T07:57:18Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3NjQwMw==", "bodyText": "What happens if client sends a GIF file's bytes as an anchor? It should be http 400 bad request, right?", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398376403", "createdAt": "2020-03-26T07:58:47Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/SystemApiController.java", "diffHunk": "@@ -215,4 +215,31 @@ public SystemApiController(InternalTlsCertificateService internalTlsCertificateS\n             throw new InternalServerErrorException(new ErrorDeviation(ANCHOR_FILE_NOT_FOUND));\n         }\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('UPLOAD_ANCHOR')\")\n+    public ResponseEntity<Void> uploadAnchor(Resource anchorResource) {\n+        byte[] anchorBytes = ResourceUtils.springResourceToBytesOrThrowBadRequest(anchorResource);\n+        try {\n+            systemService.uploadAnchor(anchorBytes);\n+        } catch (SystemService.InvalidAnchorInstanceException e) {\n+            throw new BadRequestException(e);\n+        } catch (SystemService.AnchorUploadException e) {\n+            throw new InternalServerErrorException(e);\n+        }\n+        return ApiUtil.createCreatedResponse(\"/api/system/anchor\", null);\n+    }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('UPLOAD_ANCHOR')\")\n+    public ResponseEntity<Anchor> previewAnchor(Resource anchorResource) {\n+        byte[] anchorBytes = ResourceUtils.springResourceToBytesOrThrowBadRequest(anchorResource);\n+        AnchorFile anchorFile = null;\n+        try {\n+            anchorFile = systemService.getAnchorFileFromBytes(anchorBytes);\n+        } catch (SystemService.InvalidAnchorInstanceException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQxODIxNA==", "bodyText": "I guess this is \"if exit code is not 0, or if the process times out\"?\nCould even consider different exceptions for these 2 things, but I don't know if it is warranted.", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398418214", "createdAt": "2020-03-26T09:14:38Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java", "diffHunk": "@@ -104,15 +108,40 @@\n             IOUtils.closeQuietly(process.getErrorStream());\n             IOUtils.closeQuietly(process.getOutputStream());\n         }\n+        ProcessResult processResult = new ProcessResult(commandWithArgsString, exitCode, processOutput);\n+        return processResult;\n+    }\n \n+    /**\n+     * Executes the given command with given arguments and throws a {@link ProcessFailedException} if the process' exit\n+     * code is not 0. Used e.g. for simple script execution when there is no need to handle different exit codes\n+     * @param command the command to execute\n+     * @param args arguments to be appended to the command. Make sure to pass your arguments in the correct order\n+     * (e.g. if your options have values enter them as separate consecutive args).\n+     * @return {@link ProcessResult} which contains the executed command with arguments, exit code (always 0) and the\n+     * output of the executed process\n+     * @throws ProcessNotExecutableException in the case of IOException or if the process is interrupted\n+     * @throws ProcessFailedException if the process' exit code is not 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQzNzk5Nw==", "bodyText": "old UI creates temp file in SystemProperties::getTempFilesPath. Should this do the same? (io_utils.rb#temp_file)", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398437997", "createdAt": "2020-03-26T09:45:26Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {\n+            throw new DeviationAwareRuntimeException(ce, ce.getErrorDeviation());\n+        } catch (CodedException ce) {\n+            throw ce;\n+        } catch (ServiceException | InterruptedException e) {\n+            throw new AnchorUploadException(e);\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Cannot upload a new anchor\", e);\n+        } finally {\n+            if (tempAnchor != null) {\n+                tempAnchor.delete();\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Create a temporary anchor file on the filesystem. This is needed for verifying the anchor with\n+     * configuration-client module (this might be changed in the future). This method does not delete the created\n+     * temporary file. Remember to delete the file after it is no longer needed.\n+     * @param anchorBytes\n+     * @return temporary anchor file\n+     * @throws IOException\n+     */\n+    private File createTemporaryAnchorFile(byte[] anchorBytes) throws IOException {\n+        String tempAnchorPrefix = \"temp-internal-anchor-\";\n+        String tempAnchorSuffix = \".xml\";\n+        File tempAnchor = File.createTempFile(tempAnchorPrefix, tempAnchorSuffix);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0MDkzMw==", "bodyText": "Is this step missing? \n  \n    \n      X-Road/src/proxy-ui/app/controllers/sysparams_controller.rb\n    \n    \n         Line 105\n      in\n      5744273\n    \n    \n    \n    \n\n        \n          \n           download_configuration", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398440933", "createdAt": "2020-03-26T09:50:01Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0NDg1NA==", "bodyText": "Should this in fact be PUT instead of POST? We have one anchor, we are not adding new anchor items to an existing collection of anchors, but \"replacing any existing resource\" which matches this definition:\nhttps://opensource.zalando.com/restful-api-guidelines/#put", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398444854", "createdAt": "2020-03-26T09:56:02Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/resources/openapi-definition.yaml", "diffHunk": "@@ -3111,17 +3111,47 @@ paths:\n         - security server\n       summary: upload a configuration anchor file\n       operationId: uploadAnchor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0NjQ3NA==", "bodyText": "By the way, good choice not adding a new permission for previews \ud83d\udc4d Sometimes we're at risk of creating too fine-grained permissions, I feel", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398446474", "createdAt": "2020-03-26T09:58:25Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/openapi/SystemApiControllerTest.java", "diffHunk": "@@ -310,4 +316,24 @@ public void downloadAnchorNotFound() throws AnchorNotFoundException {\n             // success\n         }\n     }\n+\n+    @Test\n+    @WithMockUser(authorities = { \"UPLOAD_ANCHOR\" })\n+    public void uploadAnchor() throws IOException {\n+        Resource anchorResource = new ByteArrayResource(FileUtils.readFileToByteArray(ANCHOR_FILE));\n+        ResponseEntity<Void> response = systemApiController.uploadAnchor(anchorResource);\n+        assertEquals(HttpStatus.CREATED, response.getStatusCode());\n+        assertEquals(\"/api/system/anchor\", response.getHeaders().getLocation().getPath());\n+    }\n+\n+    @Test\n+    @WithMockUser(authorities = { \"UPLOAD_ANCHOR\" })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0ODMxMQ==", "bodyText": "Does this test actually need to have this try-catch? If exception gets thrown, it will fail anyway?", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398448311", "createdAt": "2020-03-26T10:01:17Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/SystemServiceTest.java", "diffHunk": "@@ -161,4 +173,41 @@ public void deleteConfiguredTimestampingServiceNonExisting() {\n             // success\n         }\n     }\n+\n+    @Test\n+    public void getAnchorFileFromBytes() throws Exception {\n+        byte[] anchorBytes = FileUtils.readFileToByteArray(ANCHOR_FILE);\n+        AnchorFile anchorFile = systemService.getAnchorFileFromBytes(anchorBytes);\n+        assertEquals(ANCHOR_HASH, anchorFile.getHash());\n+    }\n+\n+    @Test(expected = SystemService.InvalidAnchorInstanceException.class)\n+    public void getAnchorFileFromBytesWrongInstance() throws Exception {\n+        when(serverConfService.getSecurityServerOwnerId()).thenReturn(ClientId.create(\"INVALID\", \"GOV\", \"1111\"));\n+        byte[] anchorBytes = FileUtils.readFileToByteArray(ANCHOR_FILE);\n+        systemService.getAnchorFileFromBytes(anchorBytes);\n+    }\n+\n+    @Test\n+    public void uploadAnchor() throws Exception {\n+        byte[] anchorBytes = FileUtils.readFileToByteArray(ANCHOR_FILE);\n+        try {\n+            systemService.uploadAnchor(anchorBytes);\n+        } catch (Exception e) {\n+            fail(\"Should not fail\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ0ODUyOA==", "bodyText": "Maybe add test for uploading garbage bytes?", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398448528", "createdAt": "2020-03-26T10:01:38Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/SystemServiceTest.java", "diffHunk": "@@ -161,4 +173,41 @@ public void deleteConfiguredTimestampingServiceNonExisting() {\n             // success\n         }\n     }\n+\n+    @Test\n+    public void getAnchorFileFromBytes() throws Exception {\n+        byte[] anchorBytes = FileUtils.readFileToByteArray(ANCHOR_FILE);\n+        AnchorFile anchorFile = systemService.getAnchorFileFromBytes(anchorBytes);\n+        assertEquals(ANCHOR_HASH, anchorFile.getHash());\n+    }\n+\n+    @Test(expected = SystemService.InvalidAnchorInstanceException.class)\n+    public void getAnchorFileFromBytesWrongInstance() throws Exception {\n+        when(serverConfService.getSecurityServerOwnerId()).thenReturn(ClientId.create(\"INVALID\", \"GOV\", \"1111\"));\n+        byte[] anchorBytes = FileUtils.readFileToByteArray(ANCHOR_FILE);\n+        systemService.getAnchorFileFromBytes(anchorBytes);\n+    }\n+\n+    @Test\n+    public void uploadAnchor() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NDYzNg==", "bodyText": "Sonar thinks catching InterruptedException here is a bug: https://sonarqube.niis.org/project/issues?id=xroad&open=AXDo4wqfBW8O1Uq1H2wZ&pullRequest=415&resolved=false&types=BUG\nI believe it is a false positive, and this is in line with how other InterruptedExceptions are thrown. However it was not easy to follow the code to come to this conclusion. For a new developer, this would be even more difficult. I think at minimum ExternalProcessRunner (maybe some other classes that use it, too) should have documentation that makes it clear that this has already been done when InterruptedException is thrown out:\n        } catch (InterruptedException e) {\n            // retain the interrupted status\n            Thread.currentThread().interrupt();\n            throw e;", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398464636", "createdAt": "2020-03-26T10:27:40Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {\n+            throw new DeviationAwareRuntimeException(ce, ce.getErrorDeviation());\n+        } catch (CodedException ce) {\n+            throw ce;\n+        } catch (ServiceException | InterruptedException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NTk2NA==", "bodyText": "Sonar suggests this: https://sonarqube.niis.org/project/issues?id=xroad&open=AXDo4wqfBW8O1Uq1H2wb&pullRequest=415&resolved=false&types=VULNERABILITY\nDon't know, maybe throwing RuntimeException would not be bad if delete = false?", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398465964", "createdAt": "2020-03-26T10:29:50Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {\n+            throw new DeviationAwareRuntimeException(ce, ce.getErrorDeviation());\n+        } catch (CodedException ce) {\n+            throw ce;\n+        } catch (ServiceException | InterruptedException e) {\n+            throw new AnchorUploadException(e);\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Cannot upload a new anchor\", e);\n+        } finally {\n+            if (tempAnchor != null) {\n+                tempAnchor.delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NzY1NA==", "bodyText": "Sonar suggests to replace \\n: https://sonarqube.niis.org/project/issues?id=xroad&open=AXDo4wqqBW8O1Uq1H2wd&pullRequest=415&resolved=false&types=CODE_SMELL", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398467654", "createdAt": "2020-03-26T10:32:36Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java", "diffHunk": "@@ -104,15 +108,40 @@\n             IOUtils.closeQuietly(process.getErrorStream());\n             IOUtils.closeQuietly(process.getOutputStream());\n         }\n+        ProcessResult processResult = new ProcessResult(commandWithArgsString, exitCode, processOutput);\n+        return processResult;\n+    }\n \n+    /**\n+     * Executes the given command with given arguments and throws a {@link ProcessFailedException} if the process' exit\n+     * code is not 0. Used e.g. for simple script execution when there is no need to handle different exit codes\n+     * @param command the command to execute\n+     * @param args arguments to be appended to the command. Make sure to pass your arguments in the correct order\n+     * (e.g. if your options have values enter them as separate consecutive args).\n+     * @return {@link ProcessResult} which contains the executed command with arguments, exit code (always 0) and the\n+     * output of the executed process\n+     * @throws ProcessNotExecutableException in the case of IOException or if the process is interrupted\n+     * @throws ProcessFailedException if the process' exit code is not 0\n+     * @throws InterruptedException if the process running thread is interrupted\n+     */\n+    public ProcessResult executeAndThrowOnFailure(String command, String... args) throws ProcessNotExecutableException,\n+            ProcessFailedException, InterruptedException {\n+        ProcessResult processResult = execute(command, args);\n         // if the process fails we attach the output into the exception\n-        if (exitCode != 0) {\n-            String fullCommandString = String.join(\" \", commandWithArgs);\n-            String processOutputString = String.join(\"\\n\", processOutput);\n-            String errorMsg = String.format(\"Failed to run command '%s' with output: \\n %s\", fullCommandString,\n-                    processOutputString);\n+        if (processResult.getExitCode() != 0) {\n+            String processOutputString = String.join(\"\\n\", processResult.processOutput);\n+            String errorMsg = String.format(\"Failed to run command '%s' with output: \\n %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwMTM3OQ==", "bodyText": "instead of\n} catch (ServiceException | InterruptedException e) {\nI think I would prefer\n} catch (ProcessNotExecutableException | ProcessFailedException | InterruptedException e) {\n\nit is more descriptive, it explains which types of errors form an AnchorUploadException. ServiceException is quite abstract. OK, abstraction can intentional also, it could be argued otherwise too. I personally was slightly confused \"where do these ServiceExceptions come from?\" and would have preferred my suggestion.\nServiceException is a bit of a catch-all, so when methods get modified, and new exceptions are added, we may mistakenly translate some new exception type to AnchorUploadException, even if it should have a different handling. So, I think it is good that we force developer to rethink \"is this AnchorUploadException or not\" when new exceptions are added. This, as long as the number of discreet exception types does not get too big, and since it is only 3 at this point, it's not a problem", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398501379", "createdAt": "2020-03-26T11:30:43Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {\n+            throw new DeviationAwareRuntimeException(ce, ce.getErrorDeviation());\n+        } catch (CodedException ce) {\n+            throw ce;\n+        } catch (ServiceException | InterruptedException e) {\n+            throw new AnchorUploadException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwMTY4MQ==", "bodyText": "Could be\n} catch (IOException e) {\nand I think more specific one would be better.", "url": "https://github.com/nordic-institute/X-Road/pull/415#discussion_r398501681", "createdAt": "2020-03-26T11:31:21Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/SystemService.java", "diffHunk": "@@ -184,6 +190,82 @@ public AnchorFile getAnchorFile() throws AnchorNotFoundException {\n         return anchorFile;\n     }\n \n+    /**\n+     * Calculate the hex hash of the given anchor file. Used to verify/preview an anchor file before\n+     * uploading it\n+     * @param anchorBytes\n+     * @return\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     */\n+    public AnchorFile getAnchorFileFromBytes(byte[] anchorBytes) throws InvalidAnchorInstanceException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        AnchorFile anchorFile = new AnchorFile(calculateAnchorHexHash(anchorBytes));\n+        anchorFile.setCreatedAt(FormatUtils.fromDateToOffsetDateTime(anchor.getGeneratedAt()));\n+        return anchorFile;\n+    }\n+\n+    /**\n+     * Upload a new configuration anchor. A temporary anchor file is created on the filesystem in order to run\n+     * the verification process with configuration-client module (via external script).\n+     * @param anchorBytes\n+     * @throws InvalidAnchorInstanceException anchor is not generated in the current instance\n+     * @throws AnchorUploadException in case of external process exceptions\n+     */\n+    public void uploadAnchor(byte[] anchorBytes) throws InvalidAnchorInstanceException, AnchorUploadException {\n+        ConfigurationAnchorV2 anchor = new ConfigurationAnchorV2(anchorBytes);\n+        verifyAnchorInstance(anchor);\n+        File tempAnchor = null;\n+        try {\n+            tempAnchor = createTemporaryAnchorFile(anchorBytes);\n+            configurationVerifier.verifyInternalConfiguration(tempAnchor.getAbsolutePath());\n+            anchorRepository.saveAndReplace(tempAnchor);\n+        } catch (ConfigurationVerifier.ConfigurationVerificationException ce) {\n+            throw new DeviationAwareRuntimeException(ce, ce.getErrorDeviation());\n+        } catch (CodedException ce) {\n+            throw ce;\n+        } catch (ServiceException | InterruptedException e) {\n+            throw new AnchorUploadException(e);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620778fef93c1aa59e19ff7d32c2dbebf76bea80"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c54e75e8ccd6e1dafa0b22f6e097c0394cff5a90", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/c54e75e8ccd6e1dafa0b22f6e097c0394cff5a90", "committedDate": "2020-03-26T15:33:29Z", "message": "XRDDEV-880 Upload anchor // PR fixes 1\n\n* new exception for malformed anchor\n* better documentation\n* api endpoint namings and docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8ac9865f4545ac0d56c750ff9fb49f2e4e0bf53", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/a8ac9865f4545ac0d56c750ff9fb49f2e4e0bf53", "committedDate": "2020-03-27T14:51:56Z", "message": "XRDDEV-880 Upload anchor // PR fixes 2\n\n* was missing a critical step: actually download the configuration from the anchor\n* a lot of javadoc updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2ba2a4b8b005b3f25e041254983e507309ba27b", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/b2ba2a4b8b005b3f25e041254983e507309ba27b", "committedDate": "2020-03-30T08:13:17Z", "message": "XRDDEV-880 Upload anchor // PR fixes 3\n\n* add tests\n* move global conf download to GlobalConfService for easier mocking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5c88908e09f4f79773b62c784dd7fa9e3f2ea04", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/f5c88908e09f4f79773b62c784dd7fa9e3f2ea04", "committedDate": "2020-03-30T08:14:16Z", "message": "Merge branch 'develop' into XRDDEV-880-upload-anchor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91425a01421f2dea1f19947c510c245c570ce32a", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/91425a01421f2dea1f19947c510c245c570ce32a", "committedDate": "2020-04-02T14:26:54Z", "message": "XRDDEV-880 Upload anchor // PR fixes 4\n\n* change conf verification failure to 500"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdf0169e1a95bac6b45765fe7123fa2804509e99", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/fdf0169e1a95bac6b45765fe7123fa2804509e99", "committedDate": "2020-04-03T07:14:00Z", "message": "XRDDEV-880 Upload anchor // PR fixes 5\n\n* add 15s timeout for executing the global conf download\n* more verbose exception handling if the request fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b32a8d50d3711609fe021c90bf025886366807f7", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/b32a8d50d3711609fe021c90bf025886366807f7", "committedDate": "2020-04-03T07:18:13Z", "message": "XRDDEV-880 Upload anchor // PR fixes 6\n\n* increase timeout to 60s"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDEwMjMz", "url": "https://github.com/nordic-institute/X-Road/pull/415#pullrequestreview-387010233", "createdAt": "2020-04-03T07:36:43Z", "commit": {"oid": "b32a8d50d3711609fe021c90bf025886366807f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4159, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}