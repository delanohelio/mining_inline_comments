{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxMTE2NzUx", "number": 743, "title": "XRDDEV-1366 Add defensive checks against bad client configuration", "bodyText": "Add defensive checks against bad client configuration:\n\nCheck member class when new local client is added.\nCheck instance identifier when registering a client.\nCheck member class when registering a client.\nAdd a client with invalid instance identifier to the test configuration.\nAdd a client with invalid member class to the test configuration.\nAdd new tests for invalid member class.\nAdd new tests for invalid instance identifier.\n\nJIRA issue: https://jira.niis.org/browse/XRDDEV-1366", "createdAt": "2020-10-11T10:41:12Z", "url": "https://github.com/nordic-institute/X-Road/pull/743", "merged": true, "mergeCommit": {"oid": "d1ecc4c17e4153d21b1b07434a9046231b350c3b"}, "closed": true, "closedAt": "2020-10-30T12:02:27Z", "author": {"login": "petkivim"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRaFSHgH2gAyNTAxMTE2NzUxOjAwMWRiM2VkYjg5N2FjNzcwNTEyZDAwNGYzNDZhZjM5MGZhMWI4ZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXljFRAFqTUyMDYwMzU4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "001db3edb897ac770512d004f346af390fa1b8ec", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/001db3edb897ac770512d004f346af390fa1b8ec", "committedDate": "2020-10-11T07:17:15Z", "message": "XRDDEV-1366 Add defensive checks against bad client configuration\n\n- Check member class when new local client is added.\n- Check instance identifier when registering a client.\n- Check member class when registering a client.\n- Fix failing tests.\n- Add new tests for invalid member class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04fa8c3fff4ff55b8643bf9379c7bba00c281cdb", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/04fa8c3fff4ff55b8643bf9379c7bba00c281cdb", "committedDate": "2020-10-11T10:35:23Z", "message": "XRDDEV-1366 Update integration tests\n\n- Add a client with invalid instance identifier to the test configuration.\n- Add a client with invalid member class to the test configuration.\n- Update other tests are dependent on the number of the clients in the configuration.\n- Add new tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c961484876e7c55db867756bdcb89285e8bbb65d", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/c961484876e7c55db867756bdcb89285e8bbb65d", "committedDate": "2020-10-11T11:37:31Z", "message": "XRDDEV-1366 Fix Sonarqube issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b93eee7fec4a34221c6095b8395c45b60a755bcc", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/b93eee7fec4a34221c6095b8395c45b60a755bcc", "committedDate": "2020-10-11T11:38:13Z", "message": "XRDDEV-1366 Fix Sonarqube issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNTY1Nzc5", "url": "https://github.com/nordic-institute/X-Road/pull/743#pullrequestreview-520565779", "createdAt": "2020-10-30T11:05:39Z", "commit": {"oid": "b93eee7fec4a34221c6095b8395c45b60a755bcc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxMTowNTozOVrOHrKTQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxMTowNTozOVrOHrKTQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAxOTU4NA==", "bodyText": "There are three methods in ManagementRequestSenderService that take in a ClientId parameter\n\nsendClientRegisterRequest\nsendClientUnregisterRequest\nsendOwnerChangeRequest\n\nWould it make sense to check the validity of the memberClass in all of these cases? Maybe moving the whole checking logic into ManagementRequestSenderService methods listed above.\nOr another way would be to just add the check to unregisterClient and changeOwner methods within ClientService.", "url": "https://github.com/nordic-institute/X-Road/pull/743#discussion_r515019584", "createdAt": "2020-10-30T11:05:39Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -493,13 +495,27 @@ public ClientType deleteTlsCertificate(ClientId id, String certificateHash)\n      * @throws ClientNotFoundException\n      * @throws CannotRegisterOwnerException\n      * @throws ActionNotPossibleException\n+     * @throws InvalidMemberClassException\n+     * @throws InvalidInstanceIdentifierException\n      */\n     public void registerClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException,\n-            CannotRegisterOwnerException, ActionNotPossibleException {\n+            CannotRegisterOwnerException, ActionNotPossibleException, InvalidMemberClassException,\n+            InvalidInstanceIdentifierException {\n \n         auditDataHelper.put(clientId);\n \n         ClientType client = getLocalClientOrThrowNotFound(clientId);\n+\n+        String instanceIdentifier = client.getIdentifier().getXRoadInstance();\n+        if (!instanceIdentifier.equals(globalConfFacade.getInstanceIdentifier())) {\n+            throw new InvalidInstanceIdentifierException(INVALID_INSTANCE_IDENTIFIER + instanceIdentifier);\n+        }\n+\n+        String memberClass = client.getIdentifier().getMemberClass();\n+        if (!isValidMemberClass(memberClass)) {\n+            throw new InvalidMemberClassException(INVALID_MEMBER_CLASS + memberClass);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b93eee7fec4a34221c6095b8395c45b60a755bcc"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNjAzNTg2", "url": "https://github.com/nordic-institute/X-Road/pull/743#pullrequestreview-520603586", "createdAt": "2020-10-30T12:02:18Z", "commit": {"oid": "b93eee7fec4a34221c6095b8395c45b60a755bcc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4014, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}