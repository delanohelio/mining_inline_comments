{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNjIxMDk0", "number": 521, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDo0NTo1OFrOEAiulQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMToyNjoyOVrOEIuCpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDA0NDM3OnYy", "diffSide": "RIGHT", "path": "src/common-verifier/src/main/java/ee/ria/xroad/common/ocsp/OcspVerifier.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDo0NTo1OFrOGb4wcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDo0NTo1OFrOGb4wcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg5NDY0Mg==", "bodyText": "Suggestion: use the cache.get(key, loader). It also makes it possible to remove the synchronized modifier. something like\ntry {\n   final String key = ...\n   return RESPONSE_VALIDITY_CACHE.get(key, () -> verifyResponseValidity(response, subject, issuer));\n } catch (ExecutionException | UncheckedExecutionException e) {\n   throw (Exception)e.getCause();\n }", "url": "https://github.com/nordic-institute/X-Road/pull/521#discussion_r431894642", "createdAt": "2020-05-28T14:45:58Z", "author": {"login": "jhyoty"}, "path": "src/common-verifier/src/main/java/ee/ria/xroad/common/ocsp/OcspVerifier.java", "diffHunk": "@@ -184,11 +192,12 @@ private synchronized SingleResp verifyResponseValidityCached(OCSPResp response,\n                                                                  X509Certificate issuer)\n             throws Exception {\n         String key = SINGLE_RESP + response.hashCode() + subject.hashCode() + issuer.hashCode();\n-        if (!CACHE.isValid(key)) {\n-            CACHE.setValue(key, verifyResponseValidity(response, subject, issuer));\n+        SingleResp responseValidity = RESPONSE_VALIDITY_CACHE.getIfPresent(key);\n+        if (responseValidity == null) {\n+            responseValidity = verifyResponseValidity(response, subject, issuer);\n+            RESPONSE_VALIDITY_CACHE.put(key, responseValidity);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dbb84e2f38baa3bf2f18b2033c89e76b955037b"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyOTMxNTI4OnYy", "diffSide": "RIGHT", "path": "src/op-monitor-daemon/src/main/java/ee/ria/xroad/opmonitordaemon/QueryRequestProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMzoxMToyOVrOGh0FWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMzoxMToyOVrOGh0FWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEwOTUyOQ==", "bodyText": "I think this method becomes unnecessary and we can just call GlobalConf.verifyValidity() instead.", "url": "https://github.com/nordic-institute/X-Road/pull/521#discussion_r438109529", "createdAt": "2020-06-10T13:11:29Z", "author": {"login": "iluwatar"}, "path": "src/op-monitor-daemon/src/main/java/ee/ria/xroad/opmonitordaemon/QueryRequestProcessor.java", "diffHunk": "@@ -78,11 +78,9 @@\n     }\n \n     /**\n-     * Saves the current configurations in thread local storage, to protect\n-     * against configuration reloads during message processing.\n+     * Verifies configuration validity\n      */\n     private void cacheConfigurationForCurrentThread() {\n-        GlobalConf.initForCurrentThread();\n         GlobalConf.verifyValidity();\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbf4c832d350aeced1de31fd99f7952132f778f7"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyOTMyNjcwOnYy", "diffSide": "RIGHT", "path": "src/proxy/src/main/java/ee/ria/xroad/proxy/util/MessageProcessorBase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMzoxNDoyOVrOGh0MrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMzoxNDoyOVrOGh0MrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODExMTQwNQ==", "bodyText": "Same here, having separate method for calling GlobalConf.verifyValidity() is unnecessary", "url": "https://github.com/nordic-institute/X-Road/pull/521#discussion_r438111405", "createdAt": "2020-06-10T13:14:29Z", "author": {"login": "iluwatar"}, "path": "src/proxy/src/main/java/ee/ria/xroad/proxy/util/MessageProcessorBase.java", "diffHunk": "@@ -72,14 +71,10 @@ protected MessageProcessorBase(HttpServletRequest servletRequest,\n     }\n \n     /**\n-     * Saves the current configurations in thread local storage, to protect\n-     * against configuration reloads during message processing.\n+     * Verifies validity\n      */\n     private void cacheConfigurationForCurrentThread() {\n-        GlobalConf.initForCurrentThread();\n         GlobalConf.verifyValidity();\n-\n-        KeyConf.initForCurrentThread();\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbf4c832d350aeced1de31fd99f7952132f778f7"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1Mzc5MjI0OnYy", "diffSide": "RIGHT", "path": "src/common-verifier/src/main/java/ee/ria/xroad/common/conf/globalconfextension/GlobalConfExtensions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNjo1NjoyM1rOGlh-YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNjo1NjoyM1rOGlh-YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAwNzEzNg==", "bodyText": "I think it should be kept volatile. It's similar case in class GlobalConf. See also https://stackoverflow.com/questions/16542402/lazy-initialization-singleton-class-with-volatile-variable", "url": "https://github.com/nordic-institute/X-Road/pull/521#discussion_r442007136", "createdAt": "2020-06-18T06:56:23Z", "author": {"login": "iluwatar"}, "path": "src/common-verifier/src/main/java/ee/ria/xroad/common/conf/globalconfextension/GlobalConfExtensions.java", "diffHunk": "@@ -37,25 +37,22 @@\n  */\n @Slf4j\n public final class GlobalConfExtensions {\n-\n-    // Instance per thread, same way as in GlobalGonf/GlobalConfImpl.\n-    // This way thread safety handling is same as in GlobalConf.\n-    private static final ThreadLocal<GlobalConfExtensions> INSTANCE = new ThreadLocal<GlobalConfExtensions>() {\n-        @Override\n-        protected GlobalConfExtensions initialValue() {\n-            return new GlobalConfExtensions();\n-        }\n-    };\n-\n     private OcspNextUpdate ocspNextUpdate;\n     private OcspFetchInterval ocspFetchInterval;\n+    private static GlobalConfExtensions instance = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f9d731276c0fb69a41d5f71623667a56aa4ef90"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3NTc4NDA0OnYy", "diffSide": "RIGHT", "path": "src/common-verifier/src/main/java/ee/ria/xroad/common/conf/globalconfextension/GlobalConfExtensions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMToyNjoyOVrOGo2eRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMToyNjoyOVrOGo2eRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ4ODcxMA==", "bodyText": "These changes are not sound since the GlobalConfExtensions instance is not thread-safe, and now it is potentially shared by several concurrent threads. Since this task has been open quite some time, I suggest reverting these changes and creating a separate task of fixing GlobalConfExtensions.", "url": "https://github.com/nordic-institute/X-Road/pull/521#discussion_r445488710", "createdAt": "2020-06-25T11:26:29Z", "author": {"login": "jhyoty"}, "path": "src/common-verifier/src/main/java/ee/ria/xroad/common/conf/globalconfextension/GlobalConfExtensions.java", "diffHunk": "@@ -37,25 +37,22 @@\n  */\n @Slf4j\n public final class GlobalConfExtensions {\n-\n-    // Instance per thread, same way as in GlobalGonf/GlobalConfImpl.\n-    // This way thread safety handling is same as in GlobalConf.\n-    private static final ThreadLocal<GlobalConfExtensions> INSTANCE = new ThreadLocal<GlobalConfExtensions>() {\n-        @Override\n-        protected GlobalConfExtensions initialValue() {\n-            return new GlobalConfExtensions();\n-        }\n-    };\n-\n     private OcspNextUpdate ocspNextUpdate;\n     private OcspFetchInterval ocspFetchInterval;\n+    private static volatile GlobalConfExtensions instance = null;\n \n     /**\n      * @return instance\n      */\n     public static GlobalConfExtensions getInstance() {\n-        GlobalConfExtensions configuration = INSTANCE.get();\n-        return configuration;\n+        if (instance == null) {\n+            synchronized (GlobalConfExtensions.class) {\n+                if (instance == null) {\n+                    instance = new GlobalConfExtensions();\n+                }\n+            }\n+        }\n+        return instance;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b1b6f7cf4530e4e0590decfd76ac8d8f305ee16"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2875, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}