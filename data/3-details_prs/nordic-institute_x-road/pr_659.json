{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNzQ3MDA3", "number": 659, "title": "XRDDEV-1269 Login fail signer bug", "bodyText": "Fix a bug which caused login to fail if tokens could not be queried from the signer module when checking the server init status. Also includes a change to the frontend init phase routing logic\nNotice that this PR is targeted for the beta-6.24.0 branch.\nJIRA: https://jira.niis.org/browse/XRDDEV-1269", "createdAt": "2020-08-20T08:16:56Z", "url": "https://github.com/nordic-institute/X-Road/pull/659", "merged": true, "mergeCommit": {"oid": "651954b4a974d0346a3a494e3c76c439dbffebf5"}, "closed": true, "closedAt": "2020-08-24T13:00:52Z", "author": {"login": "carohauta"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdArexjAH2gAyNDcwNzQ3MDA3OjdiMGJiYWRhNmNkOWViODg1Yjc2ZmVkNTMwYWE1NmYwOTRjOGRhZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdB81UTAFqTQ3MzE1NzQwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7b0bbada6cd9eb885b76fed530aa56f094c8dae6", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/7b0bbada6cd9eb885b76fed530aa56f094c8dae6", "committedDate": "2020-08-20T07:56:46Z", "message": "XRDDEV-1269 Fix login failure if signer is unreachable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad19d4c6d8d57374e8898863d9528246c8a54041", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/ad19d4c6d8d57374e8898863d9528246c8a54041", "committedDate": "2020-08-20T08:04:33Z", "message": "Merge branch 'beta-6.24.0' into XRDDEV-1269-login-fail-signer-bug\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/NotificationServiceTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc0059608a486706d30ed069b6d4958d12185e57", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/dc0059608a486706d30ed069b6d4958d12185e57", "committedDate": "2020-08-20T08:08:59Z", "message": "XRDDEV-1269 Init soft token unresolved test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNDAyMzc5", "url": "https://github.com/nordic-institute/X-Road/pull/659#pullrequestreview-471402379", "createdAt": "2020-08-20T09:04:48Z", "commit": {"oid": "7b0bbada6cd9eb885b76fed530aa56f094c8dae6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwOTowNDo0OFrOHD18Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwOTowNDo0OFrOHD18Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc5MTQ5MQ==", "bodyText": "This would cause NPE in InitializationService if null, is that intentional?\n    boolean isSoftwareTokenInitialized = tokenService.isSoftwareTokenInitialized();\n\nRather than return Boolean.TRUE, Boolean.FALSE or null, maybe consider returning an enum with 3 values. Or just catch exceptions in upper layer and handle them there. I think it might be more explicit and make it less likely that someone misuses the return value.\nThis seems to come down to the question you asked\n\nshould the getAllTokens method actually throw a checked exception instead of a runtime exception if signer is unresponsive\n\nIf we want to handle the exception properly on upper layers, then the checked exception would help this a lot. I guess the reasoning behind throw new RuntimeException(\"could not list all tokens\") was assumption that no one really wants to do anything else than http 500 when that happens. And now we do.\nSo there's also the possibility of changing signer communication problems into checked exceptions. But not sure if that's in scope of this ticket. Or, just keep those as RuntimeExceptions and fix the NPE by maybe changing the return value to enum?", "url": "https://github.com/nordic-institute/X-Road/pull/659#discussion_r473791491", "createdAt": "2020-08-20T09:04:48Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenService.java", "diffHunk": "@@ -328,12 +328,19 @@ public TokenInfoAndKeyId getTokenAndKeyIdForCertificateHash(String hash) throws\n     }\n \n     /**\n-     * Whether or not a software token exists AND it's status != TokenStatusInfo.NOT_INITIALIZED\n-     * @return\n+     * Whether or not a software token exists AND it's status != TokenStatusInfo.NOT_INITIALIZED.\n+     * If an exception is thrown when querying signer for the tokens, a null status will be returned\n+     * @return true/false/null\n      */\n-    public boolean isSoftwareTokenInitialized() {\n+    public Boolean isSoftwareTokenInitialized() {\n         boolean isSoftwareTokenInitialized = false;\n-        List<TokenInfo> tokens = getAllTokens();\n+        List<TokenInfo> tokens = null;\n+        try {\n+            tokens = getAllTokens();\n+        } catch (Exception e) {\n+            log.error(\"Could not get software token status from signer\", e);\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b0bbada6cd9eb885b76fed530aa56f094c8dae6"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f9364df05389b8c9ad202df4f229a379c3f03c0", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/4f9364df05389b8c9ad202df4f229a379c3f03c0", "committedDate": "2020-08-20T14:53:44Z", "message": "XRDDEV-1269 TokenInitStatus enum instead of boolean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5d4dcbdfbc8bf57d4bce794d648ea8fe065c81a", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/b5d4dcbdfbc8bf57d4bce794d648ea8fe065c81a", "committedDate": "2020-08-21T06:50:42Z", "message": "XRDDEV-1269 Signer not reachable exception propagation\n\n* send a correct error response when a BeanCreationException is actually caused by unresponsive signer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "258fb8c922321d78bfcfeb3c0558c05d9a405efb", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/258fb8c922321d78bfcfeb3c0558c05d9a405efb", "committedDate": "2020-08-21T06:55:01Z", "message": "Merge branch 'beta-6.24.0' into XRDDEV-1269-login-fail-signer-bug\n\n# Conflicts:\n#\tsrc/proxy-ui-api/frontend/package-lock.json"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a34ce4ee71d1c0e535ad10c698e684ee05176781", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/a34ce4ee71d1c0e535ad10c698e684ee05176781", "committedDate": "2020-08-21T10:22:28Z", "message": "XRDDEV-1269 Fix failing init tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38177d5c1ac45fea62373c6d5311f2552821876b", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/38177d5c1ac45fea62373c6d5311f2552821876b", "committedDate": "2020-08-21T10:34:57Z", "message": "Merge branch 'beta-6.24.0' into XRDDEV-1269-login-fail-signer-bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMTM2MjY5", "url": "https://github.com/nordic-institute/X-Road/pull/659#pullrequestreview-473136269", "createdAt": "2020-08-24T05:52:05Z", "commit": {"oid": "38177d5c1ac45fea62373c6d5311f2552821876b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNTo1MjowNVrOHFVe-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNTo1MjowNVrOHFVe-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM1NjkyMg==", "bodyText": "I think it would be good to explain why we do this. What is the special bond between BeanCreationExceptions and SignerNotReachableExceptions? Otherwise some future developer will be confused.", "url": "https://github.com/nordic-institute/X-Road/pull/659#discussion_r475356922", "createdAt": "2020-08-24T05:52:05Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/exceptions/ApplicationExceptionHandler.java", "diffHunk": "@@ -93,4 +99,24 @@\n         log.error(\"exception caught\", e);\n         return exceptionTranslator.toResponseEntity(e, HttpStatus.FORBIDDEN);\n     }\n+\n+    /**\n+     * check for nested SignerNotReachable exception when BeanCreationException is caught", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38177d5c1ac45fea62373c6d5311f2552821876b"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba9a0fc0f2c228205a27b93a93f65a6c4bd9d9d0", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/ba9a0fc0f2c228205a27b93a93f65a6c4bd9d9d0", "committedDate": "2020-08-24T06:25:04Z", "message": "XRDDEV-1269 Better Javadocs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMTU3NDAw", "url": "https://github.com/nordic-institute/X-Road/pull/659#pullrequestreview-473157400", "createdAt": "2020-08-24T06:43:42Z", "commit": {"oid": "ba9a0fc0f2c228205a27b93a93f65a6c4bd9d9d0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4064, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}