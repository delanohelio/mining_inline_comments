{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4ODgxNjkw", "number": 653, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDoyMDo0NVrOEZgZVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDo0Njo1NFrOEZhKUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MTgwNjMwOnYy", "diffSide": "RIGHT", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDoyMDo0NVrOHCW5Qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDo0Mjo0NVrOHCyckg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIzNDMwNw==", "bodyText": "This method now never returns false, since globalConfFacade.verifyValidity either returns true or throws CodedException?\na private boolean isGlobalConfValid that either returns true or throws exception is pretty nonstandard for a Java method, would be better to return true/false in un-exceptional cases. Maybe the old implementation was better after all?\nI may have posted misleading comments in the slack thread I guess the implementation should then inspect the exception to distinguish which case it is , as it looks like the implementation already did that (well, it did not inspect the error code vs X_OUTDATED_GLOBALCONF, so it was not completely flawless)?", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472234307", "createdAt": "2020-08-18T14:20:45Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -79,35 +73,35 @@ public AlertStatus getAlerts() {\n             alertStatus.setBackupRestoreRunningSince(backupRestoreStartedAt);\n             alertStatus.setCurrentTime(OffsetDateTime.now(ZoneOffset.UTC));\n         }\n-        if (isSecurityServerFullyInitialized()) {\n+\n+        try {\n             alertStatus.setGlobalConfValid(isGlobalConfValid());\n-            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n-        } else {\n+            alertStatus.setGlobalConfValidCheckSuccess(true);\n+        } catch (CodedException e) {\n+            log.error(\"getting global conf status failed\");\n             alertStatus.setGlobalConfValid(false);\n+            alertStatus.setGlobalConfValidCheckSuccess(false);\n+        }\n+\n+        try {\n+            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n+            alertStatus.setSoftTokenPinEnteredCheckSuccess(true);\n+        } catch (Exception e) {\n+            log.error(\"getting soft token pin status failed\");\n             alertStatus.setSoftTokenPinEntered(false);\n+            alertStatus.setSoftTokenPinEnteredCheckSuccess(false);\n         }\n-        return alertStatus;\n-    }\n \n-    private boolean isSecurityServerFullyInitialized() {\n-        InitializationStatusDto initStatusDto = initializationService.getSecurityServerInitializationStatus();\n-        return initStatusDto.isAnchorImported()\n-                && initStatusDto.isServerCodeInitialized()\n-                && initStatusDto.isServerOwnerInitialized()\n-                && initStatusDto.isSoftwareTokenInitialized();\n+        return alertStatus;\n     }\n \n     /**\n      * Verifies that the global configuration is valid.\n      * @return\n      */\n     private boolean isGlobalConfValid() {\n-        try {\n-            globalConfFacade.verifyValidity();\n-            return true;\n-        } catch (CodedException e) {\n-            return false;\n-        }\n+        globalConfFacade.verifyValidity();\n+        return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY4NTcxNA==", "bodyText": "Yes, you're right, the old implementation was better. That is now restored. The logic of the global conf check now works so that when the check throws CodedException the response is:\nglobal_conf_valid: false\nglobal_conf_valid_check_success: true\n\nAnd the check throws any other exception the response is:\nglobal_conf_valid: false\nglobal_conf_valid_check_success: false", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472685714", "createdAt": "2020-08-19T04:42:45Z", "author": {"login": "petkivim"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -79,35 +73,35 @@ public AlertStatus getAlerts() {\n             alertStatus.setBackupRestoreRunningSince(backupRestoreStartedAt);\n             alertStatus.setCurrentTime(OffsetDateTime.now(ZoneOffset.UTC));\n         }\n-        if (isSecurityServerFullyInitialized()) {\n+\n+        try {\n             alertStatus.setGlobalConfValid(isGlobalConfValid());\n-            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n-        } else {\n+            alertStatus.setGlobalConfValidCheckSuccess(true);\n+        } catch (CodedException e) {\n+            log.error(\"getting global conf status failed\");\n             alertStatus.setGlobalConfValid(false);\n+            alertStatus.setGlobalConfValidCheckSuccess(false);\n+        }\n+\n+        try {\n+            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n+            alertStatus.setSoftTokenPinEnteredCheckSuccess(true);\n+        } catch (Exception e) {\n+            log.error(\"getting soft token pin status failed\");\n             alertStatus.setSoftTokenPinEntered(false);\n+            alertStatus.setSoftTokenPinEnteredCheckSuccess(false);\n         }\n-        return alertStatus;\n-    }\n \n-    private boolean isSecurityServerFullyInitialized() {\n-        InitializationStatusDto initStatusDto = initializationService.getSecurityServerInitializationStatus();\n-        return initStatusDto.isAnchorImported()\n-                && initStatusDto.isServerCodeInitialized()\n-                && initStatusDto.isServerOwnerInitialized()\n-                && initStatusDto.isSoftwareTokenInitialized();\n+        return alertStatus;\n     }\n \n     /**\n      * Verifies that the global configuration is valid.\n      * @return\n      */\n     private boolean isGlobalConfValid() {\n-        try {\n-            globalConfFacade.verifyValidity();\n-            return true;\n-        } catch (CodedException e) {\n-            return false;\n-        }\n+        globalConfFacade.verifyValidity();\n+        return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIzNDMwNw=="}, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MTgzMzc1OnYy", "diffSide": "RIGHT", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDoyNjo0N1rOHCXKPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDo0NDoyM1rOHCygHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIzODY1Mw==", "bodyText": "Should we just setSoftTokenPinEnteredCheckSuccess(false) if we know that backup restore is running? Since doing isSoftTokenPinEntered will likely fail doing restore, and possibly cause the \"could not list all tokens\" error to appear with some delay?", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472238653", "createdAt": "2020-08-18T14:26:47Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -79,35 +73,35 @@ public AlertStatus getAlerts() {\n             alertStatus.setBackupRestoreRunningSince(backupRestoreStartedAt);\n             alertStatus.setCurrentTime(OffsetDateTime.now(ZoneOffset.UTC));\n         }\n-        if (isSecurityServerFullyInitialized()) {\n+\n+        try {\n             alertStatus.setGlobalConfValid(isGlobalConfValid());\n-            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n-        } else {\n+            alertStatus.setGlobalConfValidCheckSuccess(true);\n+        } catch (CodedException e) {\n+            log.error(\"getting global conf status failed\");\n             alertStatus.setGlobalConfValid(false);\n+            alertStatus.setGlobalConfValidCheckSuccess(false);\n+        }\n+\n+        try {\n+            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY4NjYyMA==", "bodyText": "That makes sense. Both soft_token_pin_entered and soft_token_pin_entered_check_success are now set to false always when backup / restore is running, and the actual check is skipped.", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472686620", "createdAt": "2020-08-19T04:44:23Z", "author": {"login": "petkivim"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -79,35 +73,35 @@ public AlertStatus getAlerts() {\n             alertStatus.setBackupRestoreRunningSince(backupRestoreStartedAt);\n             alertStatus.setCurrentTime(OffsetDateTime.now(ZoneOffset.UTC));\n         }\n-        if (isSecurityServerFullyInitialized()) {\n+\n+        try {\n             alertStatus.setGlobalConfValid(isGlobalConfValid());\n-            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n-        } else {\n+            alertStatus.setGlobalConfValidCheckSuccess(true);\n+        } catch (CodedException e) {\n+            log.error(\"getting global conf status failed\");\n             alertStatus.setGlobalConfValid(false);\n+            alertStatus.setGlobalConfValidCheckSuccess(false);\n+        }\n+\n+        try {\n+            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIzODY1Mw=="}, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MTkwMTM1OnYy", "diffSide": "RIGHT", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDo0MDo1M1rOHCX0Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDo0Nzo1MlrOHCyosA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0OTQwMg==", "bodyText": "Could just catch any Exception, probably only CodedExceptions should occur now, but we might not have realized a possibility of some other exceptions like RuntimeExceptions or some future changes may make that possible - and we probably want those to also result in setGlobalConfValidCheckSuccess(false)?", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472249402", "createdAt": "2020-08-18T14:40:53Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -79,35 +73,35 @@ public AlertStatus getAlerts() {\n             alertStatus.setBackupRestoreRunningSince(backupRestoreStartedAt);\n             alertStatus.setCurrentTime(OffsetDateTime.now(ZoneOffset.UTC));\n         }\n-        if (isSecurityServerFullyInitialized()) {\n+\n+        try {\n             alertStatus.setGlobalConfValid(isGlobalConfValid());\n-            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n-        } else {\n+            alertStatus.setGlobalConfValidCheckSuccess(true);\n+        } catch (CodedException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY4ODgxNg==", "bodyText": "The implementation was updated so that Exception is catched. It's possible that globalConfFacade.verifyValidity() throws other exceptions too (e.g. RuntimeException). Please see the first comment regarding the updated logic.", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472688816", "createdAt": "2020-08-19T04:47:52Z", "author": {"login": "petkivim"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -79,35 +73,35 @@ public AlertStatus getAlerts() {\n             alertStatus.setBackupRestoreRunningSince(backupRestoreStartedAt);\n             alertStatus.setCurrentTime(OffsetDateTime.now(ZoneOffset.UTC));\n         }\n-        if (isSecurityServerFullyInitialized()) {\n+\n+        try {\n             alertStatus.setGlobalConfValid(isGlobalConfValid());\n-            alertStatus.setSoftTokenPinEntered(isSoftTokenPinEntered());\n-        } else {\n+            alertStatus.setGlobalConfValidCheckSuccess(true);\n+        } catch (CodedException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0OTQwMg=="}, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MTkzMTcwOnYy", "diffSide": "RIGHT", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDo0Njo1NFrOHCYG8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDo0ODoxMFrOHCypYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI1NDE5Mg==", "bodyText": "If alerts are disabled, the status of all alerts true.\n\nIs this comment up to date? Does \"alerts are disabled\" refer to backupRestoreRunningSince?", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472254192", "createdAt": "2020-08-18T14:46:54Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -47,23 +45,19 @@\n  */\n @Slf4j\n @Service\n-@Transactional\n @PreAuthorize(\"isAuthenticated()\")\n public class NotificationService {\n     private OffsetDateTime backupRestoreRunningSince;\n     private final GlobalConfFacade globalConfFacade;\n     private final TokenService tokenService;\n-    private final InitializationService initializationService;\n \n     /**\n      * constructor\n      */\n     @Autowired\n-    public NotificationService(GlobalConfFacade globalConfFacade, TokenService tokenService,\n-            InitializationService initializationService) {\n+    public NotificationService(GlobalConfFacade globalConfFacade, TokenService tokenService) {\n         this.globalConfFacade = globalConfFacade;\n         this.tokenService = tokenService;\n-        this.initializationService = initializationService;\n     }\n \n     /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY4ODk5NQ==", "bodyText": "The comment was updated.", "url": "https://github.com/nordic-institute/X-Road/pull/653#discussion_r472688995", "createdAt": "2020-08-19T04:48:10Z", "author": {"login": "petkivim"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/NotificationService.java", "diffHunk": "@@ -47,23 +45,19 @@\n  */\n @Slf4j\n @Service\n-@Transactional\n @PreAuthorize(\"isAuthenticated()\")\n public class NotificationService {\n     private OffsetDateTime backupRestoreRunningSince;\n     private final GlobalConfFacade globalConfFacade;\n     private final TokenService tokenService;\n-    private final InitializationService initializationService;\n \n     /**\n      * constructor\n      */\n     @Autowired\n-    public NotificationService(GlobalConfFacade globalConfFacade, TokenService tokenService,\n-            InitializationService initializationService) {\n+    public NotificationService(GlobalConfFacade globalConfFacade, TokenService tokenService) {\n         this.globalConfFacade = globalConfFacade;\n         this.tokenService = tokenService;\n-        this.initializationService = initializationService;\n     }\n \n     /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI1NDE5Mg=="}, "originalCommit": {"oid": "9367172506d97e5b4033ce9de6bf0f6f2ebb654b"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2677, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}