{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNjIxMDk0", "number": 521, "title": "XRDDEV-68", "bodyText": "Initial version", "createdAt": "2020-05-27T05:42:36Z", "url": "https://github.com/nordic-institute/X-Road/pull/521", "merged": true, "mergeCommit": {"oid": "f04d7cac2046c3232f09cb5193f1c74604e8ffa1"}, "closed": true, "closedAt": "2020-06-30T11:05:06Z", "author": {"login": "martensoo"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjjJOTgH2gAyNDIzNjIxMDk0OjBkZmE1MDk4N2Y0ZmRjNDFhMTFlOWUzNzg1MDM3YjM0MmVkZjYzOTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwTl9HAFqTQzOTkwNjk5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0dfa50987f4fdc41a11e9e3785037b342edf6394", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/0dfa50987f4fdc41a11e9e3785037b342edf6394", "committedDate": "2020-05-21T19:50:11Z", "message": "XRDDEV-68 change local variable usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58cbdaf590afea6ff9fa147a0b1683ef94ee290a", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/58cbdaf590afea6ff9fa147a0b1683ef94ee290a", "committedDate": "2020-05-26T08:22:33Z", "message": "XRDDEV-68: code style fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8490b97d56f65ccda609d8c9d25d6574b195ae3", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/e8490b97d56f65ccda609d8c9d25d6574b195ae3", "committedDate": "2020-05-26T08:35:11Z", "message": "XRDDEV-68: style issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dbb84e2f38baa3bf2f18b2033c89e76b955037b", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/6dbb84e2f38baa3bf2f18b2033c89e76b955037b", "committedDate": "2020-05-27T05:38:47Z", "message": "XRDDEV-68 Style fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTg3NTk3", "url": "https://github.com/nordic-institute/X-Road/pull/521#pullrequestreview-420187597", "createdAt": "2020-05-28T14:45:58Z", "commit": {"oid": "6dbb84e2f38baa3bf2f18b2033c89e76b955037b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDo0NTo1OFrOGb4wcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDo0NTo1OFrOGb4wcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg5NDY0Mg==", "bodyText": "Suggestion: use the cache.get(key, loader). It also makes it possible to remove the synchronized modifier. something like\ntry {\n   final String key = ...\n   return RESPONSE_VALIDITY_CACHE.get(key, () -> verifyResponseValidity(response, subject, issuer));\n } catch (ExecutionException | UncheckedExecutionException e) {\n   throw (Exception)e.getCause();\n }", "url": "https://github.com/nordic-institute/X-Road/pull/521#discussion_r431894642", "createdAt": "2020-05-28T14:45:58Z", "author": {"login": "jhyoty"}, "path": "src/common-verifier/src/main/java/ee/ria/xroad/common/ocsp/OcspVerifier.java", "diffHunk": "@@ -184,11 +192,12 @@ private synchronized SingleResp verifyResponseValidityCached(OCSPResp response,\n                                                                  X509Certificate issuer)\n             throws Exception {\n         String key = SINGLE_RESP + response.hashCode() + subject.hashCode() + issuer.hashCode();\n-        if (!CACHE.isValid(key)) {\n-            CACHE.setValue(key, verifyResponseValidity(response, subject, issuer));\n+        SingleResp responseValidity = RESPONSE_VALIDITY_CACHE.getIfPresent(key);\n+        if (responseValidity == null) {\n+            responseValidity = verifyResponseValidity(response, subject, issuer);\n+            RESPONSE_VALIDITY_CACHE.put(key, responseValidity);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dbb84e2f38baa3bf2f18b2033c89e76b955037b"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53955ab689f0e44ec846ba95ff7f0102356d3aa4", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/53955ab689f0e44ec846ba95ff7f0102356d3aa4", "committedDate": "2020-05-29T06:01:46Z", "message": "XRDDEV-68 refactoring and adding the test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f2b2b6700164be61ec4f6d5858baafcc5a8e73e", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/0f2b2b6700164be61ec4f6d5858baafcc5a8e73e", "committedDate": "2020-05-29T06:17:09Z", "message": "Merge branch 'develop' into XRDDEV-68-local-variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbf4c832d350aeced1de31fd99f7952132f778f7", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/dbf4c832d350aeced1de31fd99f7952132f778f7", "committedDate": "2020-06-01T14:22:27Z", "message": "XRDDEV-68 limit cache size"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MDM2MjA5", "url": "https://github.com/nordic-institute/X-Road/pull/521#pullrequestreview-428036209", "createdAt": "2020-06-10T13:11:29Z", "commit": {"oid": "dbf4c832d350aeced1de31fd99f7952132f778f7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMzoxMToyOVrOGh0FWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMzoxNDoyOVrOGh0MrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEwOTUyOQ==", "bodyText": "I think this method becomes unnecessary and we can just call GlobalConf.verifyValidity() instead.", "url": "https://github.com/nordic-institute/X-Road/pull/521#discussion_r438109529", "createdAt": "2020-06-10T13:11:29Z", "author": {"login": "iluwatar"}, "path": "src/op-monitor-daemon/src/main/java/ee/ria/xroad/opmonitordaemon/QueryRequestProcessor.java", "diffHunk": "@@ -78,11 +78,9 @@\n     }\n \n     /**\n-     * Saves the current configurations in thread local storage, to protect\n-     * against configuration reloads during message processing.\n+     * Verifies configuration validity\n      */\n     private void cacheConfigurationForCurrentThread() {\n-        GlobalConf.initForCurrentThread();\n         GlobalConf.verifyValidity();\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbf4c832d350aeced1de31fd99f7952132f778f7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODExMTQwNQ==", "bodyText": "Same here, having separate method for calling GlobalConf.verifyValidity() is unnecessary", "url": "https://github.com/nordic-institute/X-Road/pull/521#discussion_r438111405", "createdAt": "2020-06-10T13:14:29Z", "author": {"login": "iluwatar"}, "path": "src/proxy/src/main/java/ee/ria/xroad/proxy/util/MessageProcessorBase.java", "diffHunk": "@@ -72,14 +71,10 @@ protected MessageProcessorBase(HttpServletRequest servletRequest,\n     }\n \n     /**\n-     * Saves the current configurations in thread local storage, to protect\n-     * against configuration reloads during message processing.\n+     * Verifies validity\n      */\n     private void cacheConfigurationForCurrentThread() {\n-        GlobalConf.initForCurrentThread();\n         GlobalConf.verifyValidity();\n-\n-        KeyConf.initForCurrentThread();\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbf4c832d350aeced1de31fd99f7952132f778f7"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed56fd5ef3bf576079e164df105b4a46b483410", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/1ed56fd5ef3bf576079e164df105b4a46b483410", "committedDate": "2020-06-12T06:41:25Z", "message": "XRDDEV-68: removing unnecessary methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "924613aa9d314290557efa882464244f32ebbf65", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/924613aa9d314290557efa882464244f32ebbf65", "committedDate": "2020-06-15T09:45:11Z", "message": "XRDDEV-68 synchronized is used for this purpose"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f9d731276c0fb69a41d5f71623667a56aa4ef90", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/9f9d731276c0fb69a41d5f71623667a56aa4ef90", "committedDate": "2020-06-15T10:13:40Z", "message": "Merge branch 'develop' into XRDDEV-68-local-variables"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTg5ODc4", "url": "https://github.com/nordic-institute/X-Road/pull/521#pullrequestreview-432989878", "createdAt": "2020-06-18T06:56:23Z", "commit": {"oid": "9f9d731276c0fb69a41d5f71623667a56aa4ef90"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNjo1NjoyM1rOGlh-YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNjo1NjoyM1rOGlh-YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAwNzEzNg==", "bodyText": "I think it should be kept volatile. It's similar case in class GlobalConf. See also https://stackoverflow.com/questions/16542402/lazy-initialization-singleton-class-with-volatile-variable", "url": "https://github.com/nordic-institute/X-Road/pull/521#discussion_r442007136", "createdAt": "2020-06-18T06:56:23Z", "author": {"login": "iluwatar"}, "path": "src/common-verifier/src/main/java/ee/ria/xroad/common/conf/globalconfextension/GlobalConfExtensions.java", "diffHunk": "@@ -37,25 +37,22 @@\n  */\n @Slf4j\n public final class GlobalConfExtensions {\n-\n-    // Instance per thread, same way as in GlobalGonf/GlobalConfImpl.\n-    // This way thread safety handling is same as in GlobalConf.\n-    private static final ThreadLocal<GlobalConfExtensions> INSTANCE = new ThreadLocal<GlobalConfExtensions>() {\n-        @Override\n-        protected GlobalConfExtensions initialValue() {\n-            return new GlobalConfExtensions();\n-        }\n-    };\n-\n     private OcspNextUpdate ocspNextUpdate;\n     private OcspFetchInterval ocspFetchInterval;\n+    private static GlobalConfExtensions instance = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f9d731276c0fb69a41d5f71623667a56aa4ef90"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b1b6f7cf4530e4e0590decfd76ac8d8f305ee16", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/7b1b6f7cf4530e4e0590decfd76ac8d8f305ee16", "committedDate": "2020-06-22T11:03:41Z", "message": "XRDDEV-68 Restore volatile usage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NDAxNzQ5", "url": "https://github.com/nordic-institute/X-Road/pull/521#pullrequestreview-437401749", "createdAt": "2020-06-25T11:26:28Z", "commit": {"oid": "7b1b6f7cf4530e4e0590decfd76ac8d8f305ee16"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMToyNjoyOVrOGo2eRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMToyNjoyOVrOGo2eRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ4ODcxMA==", "bodyText": "These changes are not sound since the GlobalConfExtensions instance is not thread-safe, and now it is potentially shared by several concurrent threads. Since this task has been open quite some time, I suggest reverting these changes and creating a separate task of fixing GlobalConfExtensions.", "url": "https://github.com/nordic-institute/X-Road/pull/521#discussion_r445488710", "createdAt": "2020-06-25T11:26:29Z", "author": {"login": "jhyoty"}, "path": "src/common-verifier/src/main/java/ee/ria/xroad/common/conf/globalconfextension/GlobalConfExtensions.java", "diffHunk": "@@ -37,25 +37,22 @@\n  */\n @Slf4j\n public final class GlobalConfExtensions {\n-\n-    // Instance per thread, same way as in GlobalGonf/GlobalConfImpl.\n-    // This way thread safety handling is same as in GlobalConf.\n-    private static final ThreadLocal<GlobalConfExtensions> INSTANCE = new ThreadLocal<GlobalConfExtensions>() {\n-        @Override\n-        protected GlobalConfExtensions initialValue() {\n-            return new GlobalConfExtensions();\n-        }\n-    };\n-\n     private OcspNextUpdate ocspNextUpdate;\n     private OcspFetchInterval ocspFetchInterval;\n+    private static volatile GlobalConfExtensions instance = null;\n \n     /**\n      * @return instance\n      */\n     public static GlobalConfExtensions getInstance() {\n-        GlobalConfExtensions configuration = INSTANCE.get();\n-        return configuration;\n+        if (instance == null) {\n+            synchronized (GlobalConfExtensions.class) {\n+                if (instance == null) {\n+                    instance = new GlobalConfExtensions();\n+                }\n+            }\n+        }\n+        return instance;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b1b6f7cf4530e4e0590decfd76ac8d8f305ee16"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56cd3a864210d8c7c9b7107715452cd43cd98f95", "author": {"user": {"login": "martensoo", "name": "M\u00e4rten Soo"}}, "url": "https://github.com/nordic-institute/X-Road/commit/56cd3a864210d8c7c9b7107715452cd43cd98f95", "committedDate": "2020-06-30T06:37:04Z", "message": "XRDDEV-68 Restore original state for this file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5OTA2OTky", "url": "https://github.com/nordic-institute/X-Road/pull/521#pullrequestreview-439906992", "createdAt": "2020-06-30T11:04:06Z", "commit": {"oid": "56cd3a864210d8c7c9b7107715452cd43cd98f95"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4256, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}