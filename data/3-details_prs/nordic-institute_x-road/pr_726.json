{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxODM1MTA3", "number": 726, "title": "Issue #691 - improvement to build script: if docker is available, the\u2026", "bodyText": "Changes to the build script and the build instructions:\n\nif docker is available, the whole process can be performed in docker containers if passing the -d or --docker-build as a command line option, so that there is no need to install further build dependencies on the build host\nif docker is not available, perform some minimal checking on the build dependencies on the host\nimplement early fail error handling\nchanged the build instructions accordingly\n\nThis PR should not make any changes to existing build environments necessary.", "createdAt": "2020-09-23T14:45:55Z", "url": "https://github.com/nordic-institute/X-Road/pull/726", "merged": true, "mergeCommit": {"oid": "8dbfdb9896e6b08e56098529ac6734dda9a82f53"}, "closed": true, "closedAt": "2021-01-04T13:19:13Z", "author": {"login": "mbert"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLuOQAABqjM3OTg2OTgzODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABds2MF1gFqTU2MTAyMTM4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "329e2d901bed9677a5a036a5c9ddf8ce2f98d2cd", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/329e2d901bed9677a5a036a5c9ddf8ce2f98d2cd", "committedDate": "2020-09-23T13:22:18Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}, "afterCommit": {"oid": "9f8bdb31bd3ce6fa995e6e06117fccc5c68e1461", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/9f8bdb31bd3ce6fa995e6e06117fccc5c68e1461", "committedDate": "2020-09-23T15:21:15Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTU4MzYw", "url": "https://github.com/nordic-institute/X-Road/pull/726#pullrequestreview-552158360", "createdAt": "2020-12-15T07:09:31Z", "commit": {"oid": "9f8bdb31bd3ce6fa995e6e06117fccc5c68e1461"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzowOTozMlrOIF8Dxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwODozMzoyOFrOIF-5lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5Nzc5OQ==", "bodyText": "Docker-build is probably not \"recommended\" as such, at least it is not one to use for actual iterative development, where it is too slow and native gradle build works better.\nI think we also need some sort of introduction text about the two build modes: a) docker b) native gradle build - what are they used for, short description of differences, can you run the app inside inside an IDE with a/b, etc.\nMaybe needs some kind of restructuring as well, since there isn't really mode a & b. You can (and we typically do) compile with native gradle build, but build packages in Docker. Which requires all tools from both a and b.", "url": "https://github.com/nordic-institute/X-Road/pull/726#discussion_r543097799", "createdAt": "2020-12-15T07:09:32Z", "author": {"login": "jansu76"}, "path": "src/BUILD.md", "diffHunk": "@@ -4,7 +4,10 @@ Running the X-Road software requires Linux (Ubuntu or RHEL). As a development en\n \n **Tools**\n \n-*Required for building*\n+*Required for building in Docker (recommended)*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f8bdb31bd3ce6fa995e6e06117fccc5c68e1461"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5OTA5MQ==", "bodyText": "Probably\n\nDocker (for compilation and deb/rpm packaging)\n\nto be exact", "url": "https://github.com/nordic-institute/X-Road/pull/726#discussion_r543099091", "createdAt": "2020-12-15T07:12:17Z", "author": {"login": "jansu76"}, "path": "src/BUILD.md", "diffHunk": "@@ -4,7 +4,10 @@ Running the X-Road software requires Linux (Ubuntu or RHEL). As a development en\n \n **Tools**\n \n-*Required for building*\n+*Required for building in Docker (recommended)*\n+* Docker (for deb/rpm packaging)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f8bdb31bd3ce6fa995e6e06117fccc5c68e1461"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzEzMTM2Ng==", "bodyText": "Is this \"check if image is already built\" logic actually needed?\nThe regular docker image builds (such as ones used for packaging, https://github.com/nordic-institute/X-Road/blob/develop/src/build_packages.sh#L10-L13) already skip building if there are no changes and use build cache https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#leverage-build-cache instead.\nUsing the regular build also has the advantage that it notices if image does need to be rebuild (e.g. changes to Dockerfile), which this does not.", "url": "https://github.com/nordic-institute/X-Road/pull/726#discussion_r543131366", "createdAt": "2020-12-15T08:12:56Z", "author": {"login": "jansu76"}, "path": "src/build_packages.sh", "diffHunk": "@@ -2,27 +2,58 @@\n set -e\n export XROAD=$(cd \"$(dirname \"$0\")\"; pwd)\n \n-if [[ ! \" $* \" =~ \" --packageonly \" ]]; then\n-  ./compile_code.sh \"$@\"\n-fi\n+HAS_DOCKER=\"\"\n+\n+errorExit() {\n+\techo \"*** $*\" 1>&2\n+\texit 1\n+}\n+\n+buildInDocker() {\n+    test -n \"$HAS_DOCKER\" || errorExit \"Error, docker is not installed/running.\"\n+    echo \"Building in docker...\"\n+    BUILD_IMAGE=\"`docker images | grep xroad-build | awk '{ print $1 }'`\"\n+    if [ \"$BUILD_IMAGE\" != \"xroad-build\" ]; then\n+        echo \"Build image 'xroad-build' not found, building it.\"\n+        docker build -q -t xroad-build --build-arg uid=$(id -u) --build-arg gid=$(id -g) $XROAD/packages/docker-compile || errorExit \"Error building build image.\"\n+    fi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f8bdb31bd3ce6fa995e6e06117fccc5c68e1461"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE0NDM0Mw==", "bodyText": "Maybe I would not use shift to remove the parameter. The scripts build_packages.sh and compile_code.sh seem to support parameter carrying so that you can e.g. call build_packages.sh param1 param2 where param1 param2 are passed on as compile_code.sh parameters.\nshift assumes that build-mode parameter (packageonly, docker-build, p, d, and any other parameter which means \"build locally\") is the first one. If order is different, a wrong parameter can get removed. Old script also meant calling build_packages.sh param1 resulted in execution of compile_code.sh param1, but now it executes compile_code.sh which could be a breaking change for some. And also code compile_code.sh does not care about parameter order, maybe this script could use consistent approach.\nI would probably make build-style parameter not required to be the first one, and just pass all parameters to compile_code without shifting. Either that, or document the behavior.", "url": "https://github.com/nordic-institute/X-Road/pull/726#discussion_r543144343", "createdAt": "2020-12-15T08:33:28Z", "author": {"login": "jansu76"}, "path": "src/build_packages.sh", "diffHunk": "@@ -2,27 +2,58 @@\n set -e\n export XROAD=$(cd \"$(dirname \"$0\")\"; pwd)\n \n-if [[ ! \" $* \" =~ \" --packageonly \" ]]; then\n-  ./compile_code.sh \"$@\"\n-fi\n+HAS_DOCKER=\"\"\n+\n+errorExit() {\n+\techo \"*** $*\" 1>&2\n+\texit 1\n+}\n+\n+buildInDocker() {\n+    test -n \"$HAS_DOCKER\" || errorExit \"Error, docker is not installed/running.\"\n+    echo \"Building in docker...\"\n+    BUILD_IMAGE=\"`docker images | grep xroad-build | awk '{ print $1 }'`\"\n+    if [ \"$BUILD_IMAGE\" != \"xroad-build\" ]; then\n+        echo \"Build image 'xroad-build' not found, building it.\"\n+        docker build -q -t xroad-build --build-arg uid=$(id -u) --build-arg gid=$(id -g) $XROAD/packages/docker-compile || errorExit \"Error building build image.\"\n+    fi\n+    docker run --rm -v $XROAD/..:/workspace -w /workspace/src -u builder xroad-build  bash -c \"./update_ruby_dependencies.sh && ./compile_code.sh -nodaemon\" || errorExit \"Error running build of binaries.\"\n+}\n+\n+buildLocally() {\n+    echo \"Building locally...\"\n+    cd $XROAD || errorExit \"Error 'cd $XROAD'.\"\n+    ./compile_code.sh \"$@\" || errorExit \"Error running build of binaries.\"\n+}\n \n if command -v docker &>/dev/null; then\n-    docker build -q -t xroad-deb-bionic \"$XROAD/packages/docker/deb-bionic\"\n-    docker build -q -t xroad-deb-focal \"$XROAD/packages/docker/deb-focal\"\n-    docker build -q -t xroad-rpm \"$XROAD/packages/docker/rpm\"\n-    docker build -q -t xroad-rpm-el8 \"$XROAD/packages/docker/rpm-el8\"\n+    HAS_DOCKER=true\n+fi\n+\n+case \"$1\" in\n+    --packageonly|-p) shift;;\n+    --docker-build|-d) shift; buildInDocker \"$@\";;\n+    *) shift; buildLocally \"$@\";;\n+esac", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f8bdb31bd3ce6fa995e6e06117fccc5c68e1461"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f8bdb31bd3ce6fa995e6e06117fccc5c68e1461", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/9f8bdb31bd3ce6fa995e6e06117fccc5c68e1461", "committedDate": "2020-09-23T15:21:15Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}, "afterCommit": {"oid": "dcbb6f191cd08853b8697f0db2faf048c6d65368", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/dcbb6f191cd08853b8697f0db2faf048c6d65368", "committedDate": "2020-09-23T15:21:15Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dcbb6f191cd08853b8697f0db2faf048c6d65368", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/dcbb6f191cd08853b8697f0db2faf048c6d65368", "committedDate": "2020-09-23T15:21:15Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}, "afterCommit": {"oid": "87216cafb12b43a14a6ad344d6da371fcc28232f", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/87216cafb12b43a14a6ad344d6da371fcc28232f", "committedDate": "2020-12-15T17:45:32Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NTE0MDk3", "url": "https://github.com/nordic-institute/X-Road/pull/726#pullrequestreview-555514097", "createdAt": "2020-12-18T14:10:56Z", "commit": {"oid": "87216cafb12b43a14a6ad344d6da371fcc28232f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNDoxMDo1NlrOIIkTKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNDoxNDozMlrOIIkbdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NDI0OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            case \"$1\" in\n          \n          \n            \n                --packageonly|-p) shift;;\n          \n          \n            \n                --docker-build|-d) shift; buildInDocker \"$@\";;\n          \n          \n            \n                *) buildLocally \"$@\";;\n          \n          \n            \n            esac\n          \n          \n            \n            for i in \"$@\"; do\n          \n          \n            \n            shift\n          \n          \n            \n            case \"$i\" in\n          \n          \n            \n                \"--package-only\"|\"-p\")\n          \n          \n            \n                    PACKAGE_ONLY=1\n          \n          \n            \n                    continue\n          \n          \n            \n                    ;;\n          \n          \n            \n                \"--docker-compile\"|\"-d\")\n          \n          \n            \n                    DOCKER_COMPILE=1\n          \n          \n            \n                    continue\n          \n          \n            \n                    ;;\n          \n          \n            \n                \"--help\"|\"-h\")\n          \n          \n            \n                     usage\n          \n          \n            \n                    ;;\n          \n          \n            \n                *) set -- \"$@\" \"$i\";;\n          \n          \n            \n            esac\n          \n          \n            \n            done\n          \n          \n            \n            \n          \n          \n            \n            if [[ -n \"$PACKAGE_ONLY\" && -n \"$DOCKER_COMPILE\" ]]; then\n          \n          \n            \n                echo \"Can't use both package-only and docker-compile options at the same time\"\n          \n          \n            \n                usage\n          \n          \n            \n            fi\n          \n          \n            \n            \n          \n          \n            \n            if [[ -n \"$PACKAGE_ONLY\" ]]; then\n          \n          \n            \n                echo \"Skipping compilation...\"\n          \n          \n            \n            elif [[ -n \"$DOCKER_COMPILE\" ]]; then\n          \n          \n            \n                buildInDocker \"$@\"\n          \n          \n            \n            else\n          \n          \n            \n                buildLocally \"$@\"\n          \n          \n            \n            fi\n          \n      \n    \n    \n  \n\nSuggestion: parameter handling in the same fashion as compile_code.sh: https://github.com/nordic-institute/X-Road/blob/develop/src/compile_code.sh#L6-L18\n\ndocker-compile, --package-only, -d, -p can appear in any parameter positions, do not have to be the first ones\nthose parameters are removed, and retained parameters are carried over to e.g. compile_code.sh\nalso minor rewording of parameter names and added -h, --help parameter and usage display", "url": "https://github.com/nordic-institute/X-Road/pull/726#discussion_r545854248", "createdAt": "2020-12-18T14:10:56Z", "author": {"login": "jansu76"}, "path": "src/build_packages.sh", "diffHunk": "@@ -2,27 +2,54 @@\n set -e\n export XROAD=$(cd \"$(dirname \"$0\")\"; pwd)\n \n-if [[ ! \" $* \" =~ \" --packageonly \" ]]; then\n-  ./compile_code.sh \"$@\"\n-fi\n+HAS_DOCKER=\"\"\n+\n+errorExit() {\n+\techo \"*** $*\" 1>&2\n+\texit 1\n+}\n+\n+buildInDocker() {\n+    test -n \"$HAS_DOCKER\" || errorExit \"Error, docker is not installed/running.\"\n+    echo \"Building in docker...\"\n+    docker build -q -t xroad-build --build-arg uid=$(id -u) --build-arg gid=$(id -g) $XROAD/packages/docker-compile || errorExit \"Error building build image.\"\n+    docker run --rm -v $XROAD/..:/workspace -w /workspace/src -u builder xroad-build  bash -c \"./update_ruby_dependencies.sh && ./compile_code.sh -nodaemon\" || errorExit \"Error running build of binaries.\"\n+}\n+\n+buildLocally() {\n+    echo \"Building locally...\"\n+    cd $XROAD || errorExit \"Error 'cd $XROAD'.\"\n+    ./compile_code.sh \"$@\" || errorExit \"Error running build of binaries.\"\n+}\n \n if command -v docker &>/dev/null; then\n-    docker build -q -t xroad-deb-bionic \"$XROAD/packages/docker/deb-bionic\"\n-    docker build -q -t xroad-deb-focal \"$XROAD/packages/docker/deb-focal\"\n-    docker build -q -t xroad-rpm \"$XROAD/packages/docker/rpm\"\n-    docker build -q -t xroad-rpm-el8 \"$XROAD/packages/docker/rpm-el8\"\n+    HAS_DOCKER=true\n+fi\n+\n+case \"$1\" in\n+    --packageonly|-p) shift;;\n+    --docker-build|-d) shift; buildInDocker \"$@\";;\n+    *) buildLocally \"$@\";;\n+esac", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87216cafb12b43a14a6ad344d6da371fcc28232f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NjM3NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            usage () {\n          \n          \n            \n              echo \"Usage: $0 [options for $0...] [other options]\"\n          \n          \n            \n              echo \"Options for $0:\"\n          \n          \n            \n              echo \" -p, --package-only    Skip compilation, just build packages'\"\n          \n          \n            \n              echo \" -d, --docker-compile  Compile in docker container instead of native gradle build\"\n          \n          \n            \n              echo \" -h, --help            This help text.\"\n          \n          \n            \n              echo \"Other options are passed on to compile_code.sh\"\n          \n          \n            \n            \n          \n          \n            \n              exit 2\n          \n          \n            \n            }", "url": "https://github.com/nordic-institute/X-Road/pull/726#discussion_r545856375", "createdAt": "2020-12-18T14:14:32Z", "author": {"login": "jansu76"}, "path": "src/build_packages.sh", "diffHunk": "@@ -2,27 +2,54 @@\n set -e\n export XROAD=$(cd \"$(dirname \"$0\")\"; pwd)\n \n-if [[ ! \" $* \" =~ \" --packageonly \" ]]; then\n-  ./compile_code.sh \"$@\"\n-fi\n+HAS_DOCKER=\"\"\n+\n+errorExit() {\n+\techo \"*** $*\" 1>&2\n+\texit 1\n+}\n+\n+buildInDocker() {\n+    test -n \"$HAS_DOCKER\" || errorExit \"Error, docker is not installed/running.\"\n+    echo \"Building in docker...\"\n+    docker build -q -t xroad-build --build-arg uid=$(id -u) --build-arg gid=$(id -g) $XROAD/packages/docker-compile || errorExit \"Error building build image.\"\n+    docker run --rm -v $XROAD/..:/workspace -w /workspace/src -u builder xroad-build  bash -c \"./update_ruby_dependencies.sh && ./compile_code.sh -nodaemon\" || errorExit \"Error running build of binaries.\"\n+}\n+\n+buildLocally() {\n+    echo \"Building locally...\"\n+    cd $XROAD || errorExit \"Error 'cd $XROAD'.\"\n+    ./compile_code.sh \"$@\" || errorExit \"Error running build of binaries.\"\n+}\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87216cafb12b43a14a6ad344d6da371fcc28232f"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87216cafb12b43a14a6ad344d6da371fcc28232f", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/87216cafb12b43a14a6ad344d6da371fcc28232f", "committedDate": "2020-12-15T17:45:32Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}, "afterCommit": {"oid": "225561f98d35fffebc5100bc896adb19f43c35f4", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/225561f98d35fffebc5100bc896adb19f43c35f4", "committedDate": "2020-12-18T15:02:27Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "225561f98d35fffebc5100bc896adb19f43c35f4", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/225561f98d35fffebc5100bc896adb19f43c35f4", "committedDate": "2020-12-18T15:02:27Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}, "afterCommit": {"oid": "f4a6cee42f62d03207909ed37ccfb6b30728a091", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/f4a6cee42f62d03207909ed37ccfb6b30728a091", "committedDate": "2020-12-21T14:48:58Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MDA0OTE4", "url": "https://github.com/nordic-institute/X-Road/pull/726#pullrequestreview-557004918", "createdAt": "2020-12-22T11:17:36Z", "commit": {"oid": "f4a6cee42f62d03207909ed37ccfb6b30728a091"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMToxNzozN1rOIJ3pwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMToxNzo0NVrOIJ3qAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxOTkwNQ==", "bodyText": "Seems unrelated to the PR?", "url": "https://github.com/nordic-institute/X-Road/pull/726#discussion_r547219905", "createdAt": "2020-12-22T11:17:37Z", "author": {"login": "jansu76"}, "path": "src/center-service/Gemfile.lock", "diffHunk": "@@ -99,7 +99,7 @@ GEM\n       rake (>= 0.8.7)\n       rdoc (~> 3.4)\n       thor (>= 0.14.6, < 2.0)\n-    rake (13.0.1)\n+    rake (13.0.3)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4a6cee42f62d03207909ed37ccfb6b30728a091"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxOTk2OQ==", "bodyText": "Seems unrelated to the PR?", "url": "https://github.com/nordic-institute/X-Road/pull/726#discussion_r547219969", "createdAt": "2020-12-22T11:17:45Z", "author": {"login": "jansu76"}, "path": "src/center-ui/Gemfile.lock", "diffHunk": "@@ -99,7 +99,7 @@ GEM\n       rake (>= 0.8.7)\n       rdoc (~> 3.4)\n       thor (>= 0.14.6, < 2.0)\n-    rake (13.0.1)\n+    rake (13.0.3)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4a6cee42f62d03207909ed37ccfb6b30728a091"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4a6cee42f62d03207909ed37ccfb6b30728a091", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/f4a6cee42f62d03207909ed37ccfb6b30728a091", "committedDate": "2020-12-21T14:48:58Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}, "afterCommit": {"oid": "9970b9f1c9e08e2f4f45ca8f62c0bcf366ee0e99", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/9970b9f1c9e08e2f4f45ca8f62c0bcf366ee0e99", "committedDate": "2020-12-22T11:22:00Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MTY5MzE2", "url": "https://github.com/nordic-institute/X-Road/pull/726#pullrequestreview-557169316", "createdAt": "2020-12-22T15:37:36Z", "commit": {"oid": "9970b9f1c9e08e2f4f45ca8f62c0bcf366ee0e99"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNTozNzozN1rOIJ_YrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNTozNzozN1rOIJ_YrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0NjYwNQ==", "bodyText": "Should include a conditional -it parameter to make it possible to interrupt build with Ctrl+C, as in packaging https://github.com/nordic-institute/X-Road/blob/develop/src/build_packages.sh#L16-L18", "url": "https://github.com/nordic-institute/X-Road/pull/726#discussion_r547346605", "createdAt": "2020-12-22T15:37:37Z", "author": {"login": "jansu76"}, "path": "src/build_packages.sh", "diffHunk": "@@ -2,27 +2,65 @@\n set -e\n export XROAD=$(cd \"$(dirname \"$0\")\"; pwd)\n \n-if [[ ! \" $* \" =~ \" --packageonly \" ]]; then\n-  ./compile_code.sh \"$@\"\n-fi\n+HAS_DOCKER=\"\"\n+\n+errorExit() {\n+    echo \"*** $*\" 1>&2\n+    exit 1\n+}\n+\n+usage () {\n+    echo \"Usage: $0 [option for $0...] [other options]\"\n+    echo \"Options for $0:\"\n+    echo \" -p, --package-only    Skip compilation, just build packages'\"\n+    echo \" -d, --docker-compile  Compile in docker container instead of native gradle build\"\n+    echo \" -h, --help            This help text.\"\n+    echo \"The option for $0, if present, must come fist, before other options.\"\n+    echo \"Other options are passed on to compile_code.sh\"\n+    test -z \"$1\" || exit \"$1\"\n+}\n+\n+buildInDocker() {\n+    test -n \"$HAS_DOCKER\" || errorExit \"Error, docker is not installed/running.\"\n+    echo \"Building in docker...\"\n+    docker build -q -t xroad-build --build-arg uid=$(id -u) --build-arg gid=$(id -g) $XROAD/packages/docker-compile || errorExit \"Error building build image.\"\n+    docker run --rm -v $XROAD/..:/workspace -w /workspace/src -u builder xroad-build  bash -c \"./update_ruby_dependencies.sh && ./compile_code.sh -nodaemon\" || errorExit \"Error running build of binaries.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9970b9f1c9e08e2f4f45ca8f62c0bcf366ee0e99"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9970b9f1c9e08e2f4f45ca8f62c0bcf366ee0e99", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/9970b9f1c9e08e2f4f45ca8f62c0bcf366ee0e99", "committedDate": "2020-12-22T11:22:00Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}, "afterCommit": {"oid": "c2be0743362662c4ec67b6ce928b33ea649cbb9f", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/c2be0743362662c4ec67b6ce928b33ea649cbb9f", "committedDate": "2020-12-22T15:50:21Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5OTY2OTUw", "url": "https://github.com/nordic-institute/X-Road/pull/726#pullrequestreview-559966950", "createdAt": "2020-12-30T09:15:22Z", "commit": {"oid": "c2be0743362662c4ec67b6ce928b33ea649cbb9f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwOToxNToyMlrOIMlYVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwOToxNToyMlrOIMlYVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA2NjI2MA==", "bodyText": "Actual expected parameters packageonly and docker-build do not match now what usage says (package-only and docker-compile).\nI would use the names from usage. Change from packageonly to package-only is in principle a breaking change, but has been an undocumented feature and by a quick check should not cause trouble for our CI jobs, at least.", "url": "https://github.com/nordic-institute/X-Road/pull/726#discussion_r550066260", "createdAt": "2020-12-30T09:15:22Z", "author": {"login": "jansu76"}, "path": "src/build_packages.sh", "diffHunk": "@@ -2,27 +2,69 @@\n set -e\n export XROAD=$(cd \"$(dirname \"$0\")\"; pwd)\n \n-if [[ ! \" $* \" =~ \" --packageonly \" ]]; then\n-  ./compile_code.sh \"$@\"\n-fi\n+HAS_DOCKER=\"\"\n+\n+errorExit() {\n+    echo \"*** $*\" 1>&2\n+    exit 1\n+}\n+\n+usage () {\n+    echo \"Usage: $0 [option for $0...] [other options]\"\n+    echo \"Options for $0:\"\n+    echo \" -p, --package-only    Skip compilation, just build packages'\"\n+    echo \" -d, --docker-compile  Compile in docker container instead of native gradle build\"\n+    echo \" -h, --help            This help text.\"\n+    echo \"The option for $0, if present, must come fist, before other options.\"\n+    echo \"Other options are passed on to compile_code.sh\"\n+    test -z \"$1\" || exit \"$1\"\n+}\n+\n+buildInDocker() {\n+    test -n \"$HAS_DOCKER\" || errorExit \"Error, docker is not installed/running.\"\n+    echo \"Building in docker...\"\n+    # check if running attached to terminal\n+    # makes it possible to stop build with Ctrl+C\n+    if [ -t 1 ]; then OPT=\"-it\"; fi\n+\n+    docker build -q -t xroad-build --build-arg uid=$(id -u) --build-arg gid=$(id -g) $XROAD/packages/docker-compile || errorExit \"Error building build image.\"\n+    docker run --rm -v $XROAD/..:/workspace -w /workspace/src -u builder ${OPT} xroad-build  bash -c \"./update_ruby_dependencies.sh && ./compile_code.sh -nodaemon\" || errorExit \"Error running build of binaries.\"\n+}\n+\n+buildLocally() {\n+    echo \"Building locally...\"\n+    cd $XROAD || errorExit \"Error 'cd $XROAD'.\"\n+    ./compile_code.sh \"$@\" || errorExit \"Error running build of binaries.\"\n+}\n \n if command -v docker &>/dev/null; then\n-    docker build -q -t xroad-deb-bionic \"$XROAD/packages/docker/deb-bionic\"\n-    docker build -q -t xroad-deb-focal \"$XROAD/packages/docker/deb-focal\"\n-    docker build -q -t xroad-rpm \"$XROAD/packages/docker/rpm\"\n-    docker build -q -t xroad-rpm-el8 \"$XROAD/packages/docker/rpm-el8\"\n+    HAS_DOCKER=true\n+fi\n+\n+case \"$1\" in\n+    --packageonly|-p) shift;;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2be0743362662c4ec67b6ce928b33ea649cbb9f"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fa2b797359c0cde9e0c929ab8f9e8bfe263c7d9", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/2fa2b797359c0cde9e0c929ab8f9e8bfe263c7d9", "committedDate": "2020-12-30T11:11:15Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2be0743362662c4ec67b6ce928b33ea649cbb9f", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/c2be0743362662c4ec67b6ce928b33ea649cbb9f", "committedDate": "2020-12-22T15:50:21Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}, "afterCommit": {"oid": "2fa2b797359c0cde9e0c929ab8f9e8bfe263c7d9", "author": {"user": null}, "url": "https://github.com/nordic-institute/X-Road/commit/2fa2b797359c0cde9e0c929ab8f9e8bfe263c7d9", "committedDate": "2020-12-30T11:11:15Z", "message": "Issue #691 - improvement to build script: if docker is available, the whole build takes place in docker, also early fail error handling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMDIxMzg5", "url": "https://github.com/nordic-institute/X-Road/pull/726#pullrequestreview-561021389", "createdAt": "2021-01-04T13:17:59Z", "commit": {"oid": "2fa2b797359c0cde9e0c929ab8f9e8bfe263c7d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4086, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}