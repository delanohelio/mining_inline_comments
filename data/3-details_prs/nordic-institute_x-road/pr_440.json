{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1MzAyNzUx", "number": 440, "title": "XRDDEV-971 additional parameters to findClients api", "bodyText": "", "createdAt": "2020-03-29T19:11:40Z", "url": "https://github.com/nordic-institute/X-Road/pull/440", "merged": true, "mergeCommit": {"oid": "3db59f43b2e1a4d09bcf3f9349df59d1fc70c8ac"}, "closed": true, "closedAt": "2020-04-21T20:54:02Z", "author": {"login": "TJaakkola"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPcD8qAH2gAyMzk1MzAyNzUxOjdlZGIwMzZjY2JmMDQ0YmI0NWYzYjdjNjcyYWQ1MTBkYmZmYmFiMjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ1qJ0AH2gAyMzk1MzAyNzUxOmQzZmNjNGY1MDkxZTU5OTNlYzlkMGZjODk1YzA5OWQ5OTk5OTVmZmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7edb036ccbf044bb45f3b7c672ad510dbffbab22", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/7edb036ccbf044bb45f3b7c672ad510dbffbab22", "committedDate": "2020-03-20T08:16:36Z", "message": "XRDDEV-971: Added parameters to /clients -apir\n\n- for fetching only clients that are missing from the security server\n- for fetching only local clients that have a valid sign cert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed0c9c132aae351cd2fdeb209e8b004b2b86a7a6", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/ed0c9c132aae351cd2fdeb209e8b004b2b86a7a6", "committedDate": "2020-03-26T07:21:27Z", "message": "XRDDEV-971: Add filtering options to findClients api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaf774b821286c33efb08bb63dc815e251061e0e", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/eaf774b821286c33efb08bb63dc815e251061e0e", "committedDate": "2020-03-29T19:39:50Z", "message": "Merge branch 'develop' into XRDDEV-971"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e908fd6bf488ef1c328a657ac5bf84cb7154a74", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/5e908fd6bf488ef1c328a657ac5bf84cb7154a74", "committedDate": "2020-03-29T20:36:48Z", "message": "XRDDEV-971: Move OcspUtils.OcspStatusExtractionException handling away from controllers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ac45a09e3bbbaa658a1db47be58d74293db26a1", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/9ac45a09e3bbbaa658a1db47be58d74293db26a1", "committedDate": "2020-03-29T20:47:25Z", "message": "XRDDEV-971: Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4533d26439f5cf6f1f41b01a5811f43a72f3935b", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/4533d26439f5cf6f1f41b01a5811f43a72f3935b", "committedDate": "2020-04-02T18:39:47Z", "message": "Merge branch 'develop' into XRDDEV-971"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4efa96b4de7b3a63b5aa36e13b73de0c2006095", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/b4efa96b4de7b3a63b5aa36e13b73de0c2006095", "committedDate": "2020-04-06T17:58:42Z", "message": "Merge branch 'develop' into XRDDEV-971"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "894c39d46a000befa38e94bd628ae4bb45582938", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/894c39d46a000befa38e94bd628ae4bb45582938", "committedDate": "2020-04-07T10:45:13Z", "message": "Merge branch 'develop' into XRDDEV-971"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5bc2c623b0db5a8c6795d8749bd4f6e3d7e738e", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/d5bc2c623b0db5a8c6795d8749bd4f6e3d7e738e", "committedDate": "2020-04-08T10:52:10Z", "message": "Merge branch 'develop' into XRDDEV-971"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13fc88933e19bbc49671bed730ed3238b5eab6c8", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/13fc88933e19bbc49671bed730ed3238b5eab6c8", "committedDate": "2020-04-08T11:19:16Z", "message": "XRDDEV-971: Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MTk0MDgy", "url": "https://github.com/nordic-institute/X-Road/pull/440#pullrequestreview-396194082", "createdAt": "2020-04-20T07:14:14Z", "commit": {"oid": "13fc88933e19bbc49671bed730ed3238b5eab6c8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzoxNDoxNFrOGIGZpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwODoyMjozOFrOGII2KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE0NjY2Mw==", "bodyText": "Should not throw OpenAPI related exceptions from the service layer.", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411146663", "createdAt": "2020-04-20T07:14:14Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -413,20 +431,51 @@ public ClientType deleteTlsCertificate(ClientId id, String certificateHash)\n      * @param subsystemCode\n      * @param showMembers include members (without subsystemCode) in the results\n      * @param internalSearch search only in the local clients\n+     * @param onlyLocalClientWithValidSignCert include only local clients that have valid sign cert\n+     * @param onlyLocallyMissingClients list only clients that are missing from this security server\n      * @return ClientType list\n      */\n     public List<ClientType> findClients(String name, String instance, String memberClass, String memberCode,\n-            String subsystemCode, boolean showMembers, boolean internalSearch) {\n+            String subsystemCode, boolean showMembers, boolean internalSearch,\n+            boolean onlyLocalClientWithValidSignCert, boolean onlyLocallyMissingClients) {\n+        if ((onlyLocalClientWithValidSignCert || internalSearch) && onlyLocallyMissingClients) {\n+            throw new BadRequestException(\"Illegally using parameters for \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13fc88933e19bbc49671bed730ed3238b5eab6c8"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1NDQ5Nw==", "bodyText": "I was thinking about the parameter names and was wondering if it could be possible to have for example internal_search, external_search (new one) and exclude_local parameters and you could just combine those to get the desired output. But this is pretty complex search already so maybe it would not be so good idea to add even more parameters to the mix.\nBut anyway maybe this parameter could be named simply exclude_local or exclude_local_clients?", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411154497", "createdAt": "2020-04-20T07:28:27Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/resources/openapi-definition.yaml", "diffHunk": "@@ -651,6 +651,20 @@ paths:\n           schema:\n             type: boolean\n             default: true\n+        - in: query\n+          name: only_local_client_with_valid_sign_cert\n+          description: to search only local clients with valid sign cert\n+          required: false\n+          schema:\n+            type: boolean\n+            default: false\n+        - in: query\n+          name: only_locally_missing_clients", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13fc88933e19bbc49671bed730ed3238b5eab6c8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1NTc5Ng==", "bodyText": "If internal_search is true, wouldn't something like has_valid_sign_cert also be descriptive enough?", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411155796", "createdAt": "2020-04-20T07:30:43Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/resources/openapi-definition.yaml", "diffHunk": "@@ -651,6 +651,20 @@ paths:\n           schema:\n             type: boolean\n             default: true\n+        - in: query\n+          name: only_local_client_with_valid_sign_cert", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13fc88933e19bbc49671bed730ed3238b5eab6c8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1ODgxOA==", "bodyText": "Actually coming to think of this: should an exception be thrown at all here? After all the query parameters are just for filtering the results of the request. Returning an empty list because of too excessive filtering does not seem wrong to me \ud83e\udd37\u200d\u2642\ufe0f", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411158818", "createdAt": "2020-04-20T07:36:08Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -413,20 +431,51 @@ public ClientType deleteTlsCertificate(ClientId id, String certificateHash)\n      * @param subsystemCode\n      * @param showMembers include members (without subsystemCode) in the results\n      * @param internalSearch search only in the local clients\n+     * @param onlyLocalClientWithValidSignCert include only local clients that have valid sign cert\n+     * @param onlyLocallyMissingClients list only clients that are missing from this security server\n      * @return ClientType list\n      */\n     public List<ClientType> findClients(String name, String instance, String memberClass, String memberCode,\n-            String subsystemCode, boolean showMembers, boolean internalSearch) {\n+            String subsystemCode, boolean showMembers, boolean internalSearch,\n+            boolean onlyLocalClientWithValidSignCert, boolean onlyLocallyMissingClients) {\n+        if ((onlyLocalClientWithValidSignCert || internalSearch) && onlyLocallyMissingClients) {\n+            throw new BadRequestException(\"Illegally using parameters for \"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE0NjY2Mw=="}, "originalCommit": {"oid": "13fc88933e19bbc49671bed730ed3238b5eab6c8"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2ODMxMQ==", "bodyText": "Could this be added into buildClientSearchPredicate method with a logical and? In it's current state this predicate causes an extra iteration through possibly quite large set of clients in here.", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411168311", "createdAt": "2020-04-20T07:52:44Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -562,6 +611,40 @@ public void changeOwner(String memberClass, String memberCode, String subsystemC\n         return clientTypePredicate;\n     }\n \n+    /**\n+     * Create predicate function for filtering by valid local sign cert\n+     *\n+     * @param onlyLocalClientWithValidSignCert\n+     * @return\n+     */\n+    private Predicate<ClientType> buildValidSignCertPredicate(boolean onlyLocalClientWithValidSignCert) {\n+\n+        if (onlyLocalClientWithValidSignCert) {\n+            Predicate<ClientType> validSignCertPredicate = clientType -> false;\n+            validSignCertPredicate = validSignCertPredicate.or(this::hasValidLocalSignCertCheck);\n+            return validSignCertPredicate;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13fc88933e19bbc49671bed730ed3238b5eab6c8"}, "originalPosition": 147}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE3Nzg4NQ==", "bodyText": "Seems to be a simple utility test -> does not need Spring context or database to run. Removing these annotations will cut about 20 seconds off of the execution time of the test.", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411177885", "createdAt": "2020-04-20T08:08:48Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/util/ClientUtilsTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.util;\n+\n+import ee.ria.xroad.common.identifier.ClientId;\n+import ee.ria.xroad.signer.protocol.dto.CertificateInfo;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.bouncycastle.asn1.x509.CRLReason;\n+import org.bouncycastle.cert.ocsp.RevokedStatus;\n+import org.bouncycastle.cert.ocsp.UnknownStatus;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.springframework.boot.test.autoconfigure.jdbc.AutoConfigureTestDatabase;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+@RunWith(SpringRunner.class)\n+@SpringBootTest\n+@AutoConfigureTestDatabase", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13fc88933e19bbc49671bed730ed3238b5eab6c8"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE4NjcyOQ==", "bodyText": "The Javadoc of ClientId#memberEquals says that \"This comparison ignores subsystem part of the identifier\". Is this fine? Basic equals (overridden in XRoadId) seems to offer a full comparison including the subsystem if that is something that is needed.", "url": "https://github.com/nordic-institute/X-Road/pull/440#discussion_r411186729", "createdAt": "2020-04-20T08:22:38Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/util/ClientUtils.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.util;\n+\n+import ee.ria.xroad.common.identifier.ClientId;\n+import ee.ria.xroad.signer.protocol.dto.CertificateInfo;\n+\n+import java.util.List;\n+\n+public final class ClientUtils {\n+\n+    private ClientUtils() {\n+        // noop\n+    }\n+\n+    /**\n+     *\n+     * @param clientId\n+     * @param certificateInfos\n+     * @return\n+     * @throws OcspUtils.OcspStatusExtractionException\n+     */\n+    public static boolean hasValidLocalSignCert(ClientId clientId, List<CertificateInfo> certificateInfos)\n+            throws OcspUtils.OcspStatusExtractionException {\n+        for (CertificateInfo certificateInfo : certificateInfos) {\n+            String ocspResponseStatus = OcspUtils.getOcspResponseStatus(certificateInfo.getOcspBytes());\n+            if (clientId.memberEquals(certificateInfo.getMemberId())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13fc88933e19bbc49671bed730ed3238b5eab6c8"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7305a0ad36037ce3e858bcc5f2c09920de8a79c7", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/7305a0ad36037ce3e858bcc5f2c09920de8a79c7", "committedDate": "2020-04-21T05:04:10Z", "message": "XRDDEV-971: Changes according to pull request comments:\n\nRenaming findClient api queryparameters\nRemove unnecessary sprint boot initialization in ClientUtilsTest\nRemoved unnecessarily throwing exception when api user uses too restrictive query parameters in findClients call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d57a0a269dd68052b389d7fd3500fb27e9583cc7", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/d57a0a269dd68052b389d7fd3500fb27e9583cc7", "committedDate": "2020-04-21T06:09:59Z", "message": "XRDDEV-971: Optimize and simplify filtering local clients with valid sign certs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84c65317b5381b40805d7b06e840aafb27bf0cd9", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/84c65317b5381b40805d7b06e840aafb27bf0cd9", "committedDate": "2020-04-21T09:36:37Z", "message": "XRDDEV-971: Remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MTk2MDMx", "url": "https://github.com/nordic-institute/X-Road/pull/440#pullrequestreview-397196031", "createdAt": "2020-04-21T10:24:55Z", "commit": {"oid": "84c65317b5381b40805d7b06e840aafb27bf0cd9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00bdab140ef309fec84c5ecdfec9d19317ef4d2b", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/00bdab140ef309fec84c5ecdfec9d19317ef4d2b", "committedDate": "2020-04-21T10:39:40Z", "message": "Merge branch 'develop' into XRDDEV-971"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3fcc4f5091e5993ec9d0fc895c099d999995ffd", "author": {"user": {"login": "TJaakkola", "name": "Tapio Jaakkola"}}, "url": "https://github.com/nordic-institute/X-Road/commit/d3fcc4f5091e5993ec9d0fc895c099d999995ffd", "committedDate": "2020-04-21T15:45:12Z", "message": "XRDDEV-971: Fix tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4180, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}