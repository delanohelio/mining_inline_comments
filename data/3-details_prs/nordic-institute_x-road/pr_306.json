{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4NjUwNDU1", "number": 306, "title": "XRDDEV-806 allowed operations for key, token", "bodyText": "Do not merge before #294\nhttps://jira.niis.org/browse/XRDDEV-806\n\nallowed_operations for key, token\nsome fixes for cert, csr allowed_operations\nadds allowed_operation checks for existing service methods:\ntoken.add_key\ntoken.activate\ntoken.deactivate\ntoken.update_friendly_name\nkey.update_friendly_name\nkey.generate_auth_csr and key.generate_sign_csr\n\njenkins builds are currently broken due to dependencyCheck plugin problem, successful build with dependencyCheck disabled: https://jenkins.niis.org/job/pr-build-pipeline/411/", "createdAt": "2020-01-02T12:57:01Z", "url": "https://github.com/nordic-institute/X-Road/pull/306", "merged": true, "mergeCommit": {"oid": "126ca1e0876da4058cc25e3f17d1b7d7f94d1b9b"}, "closed": true, "closedAt": "2020-01-09T07:11:40Z", "author": {"login": "jansu76"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbvcDyfgH2gAyMzU4NjUwNDU1OjlkZTY5ZWYwYmVhNWQzYjYxMWU4NmJiODVjYzEzOTgzZmUwZGEzMzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4kjzxgFqTM0MDMyMjQ1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9de69ef0bea5d3b611e86bb85cc13983fe0da334", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/9de69ef0bea5d3b611e86bb85cc13983fe0da334", "committedDate": "2019-12-11T22:10:51Z", "message": "XRDDEV-778 add failing tests, refactor TokenTestUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b99ffa9ae5e822aa9f2b441825bd1351b2808d0", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/7b99ffa9ae5e822aa9f2b441825bd1351b2808d0", "committedDate": "2019-12-12T13:03:50Z", "message": "XRDDEV-778 finish implementation, make tests pass"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2b532047c677a99b81811172999903e978abb71", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/f2b532047c677a99b81811172999903e978abb71", "committedDate": "2019-12-12T20:51:09Z", "message": "XRDDEV-778 refactor: move csr methods from KeyService to TokenCertificateService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c7ae18dd618175486650937c9df8043750ecf58", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/3c7ae18dd618175486650937c9df8043750ecf58", "committedDate": "2019-12-13T07:29:46Z", "message": "Merge branch 'develop' into XRDDEV-778-delete-cert\n\nFix Conflicts:\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/CertificateNotFoundException.java\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/KeyService.java\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenCertificateService.java\n\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/openapi/TokenCertificatesApiControllerIntegrationTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc3bfff45afd1fc5544b914fd771070b980df695", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/dc3bfff45afd1fc5544b914fd771070b980df695", "committedDate": "2019-12-13T11:34:19Z", "message": "XRDDEV-778 fix hash.toLowercase handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ce817ab3c6a55bc1924bb70cce8a067190da2cf", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/1ce817ab3c6a55bc1924bb70cce8a067190da2cf", "committedDate": "2019-12-16T09:11:11Z", "message": "XRDDEV-778 add checks for possible actions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6688d233011d53677bc5159bad4339de721f92bc", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/6688d233011d53677bc5159bad4339de721f92bc", "committedDate": "2019-12-17T19:25:53Z", "message": "XRDDEV-778 add possibleActions checking for token and keys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22b98cdef8693d2b9356df3d8172a337e008be05", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/22b98cdef8693d2b9356df3d8172a337e008be05", "committedDate": "2019-12-17T20:33:52Z", "message": "XRDDEV-778 add endpoint for getting possible actions for single cert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6911c814b53965e6e372ac63984ec5683d31a8b", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/f6911c814b53965e6e372ac63984ec5683d31a8b", "committedDate": "2019-12-17T21:19:29Z", "message": "XRDDEV-778 complete cert and csr possible actions listing and verifying"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56f00fdfb0e37b1eb2c3819a826d0408e521df91", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/56f00fdfb0e37b1eb2c3819a826d0408e521df91", "committedDate": "2019-12-17T22:54:35Z", "message": "XRDDEV-778 optimize possible actions -checking by adding getTokenAndKeyIdForCertHash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22c00d9127d5a43d48b4c3ecdce25d18e4046a63", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/22c00d9127d5a43d48b4c3ecdce25d18e4046a63", "committedDate": "2019-12-19T07:29:42Z", "message": "XRDDEV-778 add getTokenAndKeyIdForCertRequestId. as a result. deleteCsr does not take keyId anymore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be7d8e557b01178ebee96013e98ac6fef7ed0c7e", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/be7d8e557b01178ebee96013e98ac6fef7ed0c7e", "committedDate": "2019-12-19T22:33:49Z", "message": "XRDDEV-778 add tests for StateChangeActionHelper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "893772b49428a6940e42cf4e76c34768c4bffe9a", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/893772b49428a6940e42cf4e76c34768c4bffe9a", "committedDate": "2019-12-20T00:26:25Z", "message": "XRDDEV-778 add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4abe5c2d6c39d83052a0ddf5f27f92784ef58021", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/4abe5c2d6c39d83052a0ddf5f27f92784ef58021", "committedDate": "2019-12-20T00:46:52Z", "message": "XRDDEV-778 fix todos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "721d07d8a853cd7f1072f085cfffa11c2b968392", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/721d07d8a853cd7f1072f085cfffa11c2b968392", "committedDate": "2019-12-20T01:18:07Z", "message": "Merge branch 'develop' into XRDDEV-778-delete-cert\n\nFix Conflicts:\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/KeysApiController.java\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenCertificateService.java\n\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/openapi/KeysApiControllerTest.java\n\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/TokenCertificateServiceTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f3e4eadd92849b795779d17393ef66975bce53b", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/8f3e4eadd92849b795779d17393ef66975bce53b", "committedDate": "2019-12-20T13:18:46Z", "message": "XRDDEV-778 add get possible actions for single csr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab0758c4e5708384f0854bcf96ebdc06fc4a2664", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/ab0758c4e5708384f0854bcf96ebdc06fc4a2664", "committedDate": "2019-12-30T12:06:34Z", "message": "XRDDEV-778 fix sonarqube critical duplication issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbadb84f7b92699395d392ce78b6e5615d04ec58", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/cbadb84f7b92699395d392ce78b6e5615d04ec58", "committedDate": "2019-12-30T12:19:21Z", "message": "Merge branch 'develop' into XRDDEV-806-key-token-allowed-operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e214dd17497292c08362044c60dc4875083c7a7", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/6e214dd17497292c08362044c60dc4875083c7a7", "committedDate": "2019-12-31T06:48:25Z", "message": "XRDDEV-806 document business rules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f6b15e83a041d8118ac7c8f5f9370cd7b4b9af9", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/4f6b15e83a041d8118ac7c8f5f9370cd7b4b9af9", "committedDate": "2019-12-31T08:56:48Z", "message": "XRDDEV-806 finished review of old rules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35925459c9b6e46a094be318ae9d45b33c61b004", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/35925459c9b6e46a094be318ae9d45b33c61b004", "committedDate": "2019-12-31T12:49:24Z", "message": "XRDDEV-806 add failing tests, refactor key and token isSavedToConfig()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b405f7cb4e4a6155cbb7014fdc1327e8ba79344", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/7b405f7cb4e4a6155cbb7014fdc1327e8ba79344", "committedDate": "2019-12-31T13:28:26Z", "message": "XRDDEV-806 fix broken old tests, add StateChangeActionMapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c883f0397e6d7a110d230300accd284bafd1a140", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/c883f0397e6d7a110d230300accd284bafd1a140", "committedDate": "2020-01-02T07:07:08Z", "message": "XRDDEV-806 implementation that fixes failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc6850c820c1237e18e0c86f3178b6ecd743cf8f", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/cc6850c820c1237e18e0c86f3178b6ecd743cf8f", "committedDate": "2020-01-02T10:01:41Z", "message": "XRDDEV-806 add possible_actions validation for token.add key, token.update friendly name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fdb45613377adb99ea7651ccb537b1276e5b43f", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/1fdb45613377adb99ea7651ccb537b1276e5b43f", "committedDate": "2020-01-02T11:09:16Z", "message": "XRDDEV-806 add more checks for key, token operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3f887cd34e537922af8402eb48ed8f16ad989ac", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/e3f887cd34e537922af8402eb48ed8f16ad989ac", "committedDate": "2020-01-02T11:56:28Z", "message": "XRDDEV-806 cleanup, renaming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d4eb1b0d99011a973ebed121c200eeeb3c63480", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/7d4eb1b0d99011a973ebed121c200eeeb3c63480", "committedDate": "2020-01-02T12:14:40Z", "message": "XRDDEV-806 cleanup TODOs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fac0f977f987ae0241793419bcd39c158fe0165c", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/fac0f977f987ae0241793419bcd39c158fe0165c", "committedDate": "2020-01-02T12:56:06Z", "message": "XRDDEV-806 add check for token.update_friendly_name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31b1b5213020c395c492f2a6f0cdddbe1859369a", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/31b1b5213020c395c492f2a6f0cdddbe1859369a", "committedDate": "2020-01-02T14:21:11Z", "message": "XRDDEV-806 disable depencencyCheck which is currently broken, temporarily"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "463e6a2f6779a40c8e81876c069276cdf9ef7b84", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/463e6a2f6779a40c8e81876c069276cdf9ef7b84", "committedDate": "2020-01-02T14:54:22Z", "message": "XRDDEV-806 disable depencencyCheck which is currently broken, temporarily"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbe3f9926eeed64edbc9845c384678a68d8f2a93", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/dbe3f9926eeed64edbc9845c384678a68d8f2a93", "committedDate": "2020-01-02T15:08:52Z", "message": "XRDDEV-806 disable depencencyCheck which is currently broken, temporarily"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4bd4ee70b4efdfdf596c4b6ea4cdd12d360764b", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/e4bd4ee70b4efdfdf596c4b6ea4cdd12d360764b", "committedDate": "2020-01-02T15:44:08Z", "message": "XRDDEV-806 revert temp disabled depencencyCheck"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MjIyODU4", "url": "https://github.com/nordic-institute/X-Road/pull/306#pullrequestreview-339222858", "createdAt": "2020-01-07T13:06:45Z", "commit": {"oid": "e4bd4ee70b4efdfdf596c4b6ea4cdd12d360764b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMzowNjo0NlrOFa41TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDoxODo0OVrOFa6o1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzczODQ0NA==", "bodyText": "Could be in the same if-block?", "url": "https://github.com/nordic-institute/X-Road/pull/306#discussion_r363738444", "createdAt": "2020-01-07T13:06:46Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/PossibleActionsRuleEngine.java", "diffHunk": "@@ -0,0 +1,279 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.signer.protocol.dto.CertRequestInfo;\n+import ee.ria.xroad.signer.protocol.dto.CertificateInfo;\n+import ee.ria.xroad.signer.protocol.dto.KeyInfo;\n+import ee.ria.xroad.signer.protocol.dto.KeyUsageInfo;\n+import ee.ria.xroad.signer.protocol.dto.TokenInfo;\n+\n+import org.springframework.stereotype.Component;\n+\n+import java.util.EnumSet;\n+\n+/**\n+ * Validation logic for possible actions done on tokens, keys, certs and csrs\n+ */\n+@Component\n+public class PossibleActionsRuleEngine {\n+\n+    // duplicate definition, since we dont want add direct dependency on signer\n+    public static final String SOFTWARE_TOKEN_ID = \"0\";\n+\n+    /**\n+     * Get possible actions for a token\n+     */\n+    public EnumSet<PossibleActionEnum> getPossibleTokenActions(TokenInfo tokenInfo) {\n+        EnumSet<PossibleActionEnum> actions = EnumSet.noneOf(PossibleActionEnum.class);\n+\n+        if (tokenInfo.isActive()) {\n+            actions.add(PossibleActionEnum.GENERATE_KEY);\n+        }\n+\n+        if (tokenInfo.isActive()) {\n+            actions.add(PossibleActionEnum.TOKEN_DEACTIVATE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4bd4ee70b4efdfdf596c4b6ea4cdd12d360764b"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc1MzE1Mg==", "bodyText": "keyInfo and certRequestInfo not used", "url": "https://github.com/nordic-institute/X-Road/pull/306#discussion_r363753152", "createdAt": "2020-01-07T13:44:57Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/PossibleActionsRuleEngine.java", "diffHunk": "@@ -0,0 +1,279 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import ee.ria.xroad.signer.protocol.dto.CertRequestInfo;\n+import ee.ria.xroad.signer.protocol.dto.CertificateInfo;\n+import ee.ria.xroad.signer.protocol.dto.KeyInfo;\n+import ee.ria.xroad.signer.protocol.dto.KeyUsageInfo;\n+import ee.ria.xroad.signer.protocol.dto.TokenInfo;\n+\n+import org.springframework.stereotype.Component;\n+\n+import java.util.EnumSet;\n+\n+/**\n+ * Validation logic for possible actions done on tokens, keys, certs and csrs\n+ */\n+@Component\n+public class PossibleActionsRuleEngine {\n+\n+    // duplicate definition, since we dont want add direct dependency on signer\n+    public static final String SOFTWARE_TOKEN_ID = \"0\";\n+\n+    /**\n+     * Get possible actions for a token\n+     */\n+    public EnumSet<PossibleActionEnum> getPossibleTokenActions(TokenInfo tokenInfo) {\n+        EnumSet<PossibleActionEnum> actions = EnumSet.noneOf(PossibleActionEnum.class);\n+\n+        if (tokenInfo.isActive()) {\n+            actions.add(PossibleActionEnum.GENERATE_KEY);\n+        }\n+\n+        if (tokenInfo.isActive()) {\n+            actions.add(PossibleActionEnum.TOKEN_DEACTIVATE);\n+        } else {\n+            if (tokenInfo.isAvailable()) {\n+                actions.add(PossibleActionEnum.TOKEN_ACTIVATE);\n+            }\n+        }\n+\n+        if (tokenInfo.isSavedToConfiguration()) {\n+            actions.add(PossibleActionEnum.EDIT_FRIENDLY_NAME);\n+        }\n+\n+        return actions;\n+    }\n+\n+    /**\n+     * key is \"not supported\" if it's an auth key inside other than softtoken (id 0)\n+     */\n+    public boolean isKeyUnsupported(TokenInfo tokenInfo, KeyInfo keyInfo) {\n+        return (!SOFTWARE_TOKEN_ID.equals(tokenInfo.getId()))\n+                && keyInfo.getUsage() == KeyUsageInfo.AUTHENTICATION;\n+\n+    }\n+\n+    /**\n+     * Get possible actions for a key\n+     */\n+    public EnumSet<PossibleActionEnum> getPossibleKeyActions(TokenInfo tokenInfo,\n+            KeyInfo keyInfo) {\n+        EnumSet<PossibleActionEnum> actions = EnumSet.noneOf(PossibleActionEnum.class);\n+\n+        // DELETE\n+        boolean keyNotSupported = isKeyUnsupported(tokenInfo, keyInfo);\n+\n+        // key.js#L26\n+        if (!keyNotSupported\n+            && !(tokenInfo.isReadOnly() && !keyInfo.isSavedToConfiguration())\n+            && (keyInfo.isSavedToConfiguration() || tokenInfo.isActive())) {\n+            actions.add(PossibleActionEnum.DELETE);\n+        }\n+\n+        // GENERATE_AUTH_CSR\n+        // keys.js#35\n+        if (SOFTWARE_TOKEN_ID.equals(tokenInfo.getId())\n+                && (keyInfo.getUsage() == null || keyInfo.getUsage() == KeyUsageInfo.AUTHENTICATION)\n+                && !(!keyInfo.isAvailable() || !tokenInfo.isActive() || keyNotSupported)) {\n+            actions.add(PossibleActionEnum.GENERATE_AUTH_CSR);\n+        }\n+        // GENERATE_SIGN_CSR\n+        if ((keyInfo.getUsage() == null || keyInfo.getUsage() == KeyUsageInfo.SIGNING)\n+                && !(!keyInfo.isAvailable() || !tokenInfo.isActive() || keyNotSupported)) {\n+            actions.add(PossibleActionEnum.GENERATE_SIGN_CSR);\n+        }\n+        // EDIT_FRIENDLY_NAME\n+        if (keyInfo.isSavedToConfiguration()) {\n+            actions.add(PossibleActionEnum.EDIT_FRIENDLY_NAME);\n+        }\n+\n+        return actions;\n+    }\n+\n+    /**\n+     * get possible actions for a certificate\n+     */\n+    public EnumSet<PossibleActionEnum> getPossibleCertificateActions(TokenInfo tokenInfo,\n+            KeyInfo keyInfo,\n+            CertificateInfo certificateInfo) {\n+        EnumSet<PossibleActionEnum> actions = EnumSet.noneOf(PossibleActionEnum.class);\n+        boolean canUnregister = keyInfo.getUsage() == KeyUsageInfo.AUTHENTICATION\n+                && (CertificateInfo.STATUS_REGINPROG.equals(certificateInfo.getStatus())\n+                || CertificateInfo.STATUS_REGISTERED.equals(certificateInfo.getStatus()));\n+        if (canUnregister) {\n+            actions.add(PossibleActionEnum.UNREGISTER);\n+        }\n+        boolean savedToConfiguration = certificateInfo.isSavedToConfiguration();\n+        if (canDeleteCertOrCsr(tokenInfo, savedToConfiguration, canUnregister)) {\n+            actions.add(PossibleActionEnum.DELETE);\n+        }\n+        if (keyInfo.getUsage() == KeyUsageInfo.AUTHENTICATION\n+                && CertificateInfo.STATUS_SAVED.equals(certificateInfo.getStatus())\n+                && (!canUnregister)) {\n+            actions.add(PossibleActionEnum.REGISTER);\n+        }\n+        if (keyInfo.getUsage() != null && certificateInfo.isSavedToConfiguration()) {\n+            if (certificateInfo.isActive()) {\n+                actions.add(PossibleActionEnum.DISABLE);\n+            } else {\n+                actions.add(PossibleActionEnum.ACTIVATE);\n+            }\n+        }\n+        if (!certificateInfo.isSavedToConfiguration()) {\n+            actions.add(PossibleActionEnum.IMPORT_FROM_TOKEN);\n+        }\n+\n+        return actions;\n+    }\n+\n+    /**\n+     * get possible actions for a csr\n+     */\n+    public EnumSet<PossibleActionEnum> getPossibleCsrActions(TokenInfo tokenInfo,\n+            KeyInfo keyInfo,\n+            CertRequestInfo certRequestInfo) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4bd4ee70b4efdfdf596c4b6ea4cdd12d360764b"}, "originalPosition": 158}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2ODAyMA==", "bodyText": "These are probably redundant here", "url": "https://github.com/nordic-institute/X-Road/pull/306#discussion_r363768020", "createdAt": "2020-01-07T14:18:49Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/TokenCertificateServiceTest.java", "diffHunk": "@@ -79,58 +119,359 @@\n     @MockBean\n     private CertificateAuthorityService certificateAuthorityService;\n \n-    @MockBean\n+    @SpyBean\n     private KeyService keyService;\n \n+    @MockBean\n+    private GlobalConfService globalConfService;\n+\n+    @MockBean\n+    private GlobalConfFacade globalConfFacade;\n+\n+    @MockBean\n+    private ClientRepository clientRepository;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4bd4ee70b4efdfdf596c4b6ea4cdd12d360764b"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b37842a8625c57780b48a1a4cff1beb9ab585df", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/2b37842a8625c57780b48a1a4cff1beb9ab585df", "committedDate": "2020-01-08T14:45:42Z", "message": "XRDDEV-778 fixes based on review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b0d2a3a543f24b06be0baa073ca006ea41d6aef", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/9b0d2a3a543f24b06be0baa073ca006ea41d6aef", "committedDate": "2020-01-08T15:05:19Z", "message": "Merge branch 'develop' into XRDDEV-778-delete-cert\n\nFix Conflicts:\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/TokenCertificateService.java\n\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/TokenCertificateServiceTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "072262bbe6af96aad898f5d7a522d9f9dfe99af5", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/072262bbe6af96aad898f5d7a522d9f9dfe99af5", "committedDate": "2020-01-08T15:26:26Z", "message": "XRDDEV-778 cleanup after conflict fixes, remove unused fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dabba7af46c045309a676bde9d6fea0f62e258c", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/4dabba7af46c045309a676bde9d6fea0f62e258c", "committedDate": "2020-01-08T15:44:18Z", "message": "Merge branch 'XRDDEV-778-delete-cert' into XRDDEV-806-key-token-allowed-operations-wip\n\nFix Conflicts:\n\tsrc/common-ui/src/main/java/ee/ria/xroad/commonui/SignerProxy.java\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/StateChangeActionHelper.java\n\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/TokenCertificateServiceTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f7cfc0965cc717c37fd4f4ee506a03b00716753", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/4f7cfc0965cc717c37fd4f4ee506a03b00716753", "committedDate": "2020-01-08T16:44:43Z", "message": "XRDDEV-806 fixes based on review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMzIyNDU0", "url": "https://github.com/nordic-institute/X-Road/pull/306#pullrequestreview-340322454", "createdAt": "2020-01-09T07:10:23Z", "commit": {"oid": "4f7cfc0965cc717c37fd4f4ee506a03b00716753"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4259, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}