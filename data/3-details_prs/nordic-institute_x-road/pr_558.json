{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NjMyMzM4", "number": 558, "title": "XRDDEV-1122", "bodyText": "Fix Add subsystem query\n\nAdd missing query parameter: internal_search=false\n\n\nFix Add client query\n\nFilter out all clients that have local relatives.\nIf the member owning the client or another subsystem of the same member is already present locally, the client is excluded.\n\n\nFix bug in client search with local_valid_sign_cert param\n\nCompare only the member part of the client identifier to member identifiers in the certificates.\n\n\n\nJIRA issues: https://jira.niis.org/browse/XRDDEV-1122", "createdAt": "2020-06-17T06:30:31Z", "url": "https://github.com/nordic-institute/X-Road/pull/558", "merged": true, "mergeCommit": {"oid": "4c38a70e189a509f1b25991eddfab5b6d5d22f4c"}, "closed": true, "closedAt": "2020-06-18T06:17:18Z", "author": {"login": "petkivim"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrxwXSAH2gAyNDM1NjMyMzM4OjVhMWI3MDcxNTMzY2IxOTQ0MmNkOTJhOTUzY2ZjMmUwYjYzYjUwMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsYS4tAFqTQzMjk2OTUxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a1b7071533cb19442cd92a953cfc2e0b63b5011", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/5a1b7071533cb19442cd92a953cfc2e0b63b5011", "committedDate": "2020-06-16T09:23:00Z", "message": "XRDDEV-1122 Fix bug in get subsystems query\n\n- Add missing query parameter: internal_search=false"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "335d95bf2ff84c3c84c7f28277f7864bce52f7b7", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/335d95bf2ff84c3c84c7f28277f7864bce52f7b7", "committedDate": "2020-06-16T09:25:17Z", "message": "XRDDEV-1122 Fix bug in client search with local_valid_sign_cert query param\n\n- Compare only the member part of the client identifier to member identifiers in the certificates."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1d37d78cf382eecaa60e9c637be98ceb56f45be", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/b1d37d78cf382eecaa60e9c637be98ceb56f45be", "committedDate": "2020-06-16T09:41:30Z", "message": "XRDDEV-1122 Remove non-existing query parameter member_missing_sign_cert from get clients query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f94b443acbf31fdff8c306ea81fe34d30a10219", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/4f94b443acbf31fdff8c306ea81fe34d30a10219", "committedDate": "2020-06-17T06:26:13Z", "message": "XRDDEV-1122 Fix Add client list content\n\n- Filter out all clients that have local relatives.\n- If the member owning the client or another subsystem of the same member is already present locally, the client is excluded."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b30304c30e5e0ede95f97d6f191dc13fe1dc00d0", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/b30304c30e5e0ede95f97d6f191dc13fe1dc00d0", "committedDate": "2020-06-17T07:14:52Z", "message": "XRDDEV-1122 Fix failing backend test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMjQ1MTAy", "url": "https://github.com/nordic-institute/X-Road/pull/558#pullrequestreview-432245102", "createdAt": "2020-06-17T09:57:12Z", "commit": {"oid": "b30304c30e5e0ede95f97d6f191dc13fe1dc00d0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwOTo1NzoxMlrOGk-ppw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMDo0NjoxNVrOGlAR1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQyODM5MQ==", "bodyText": "I think adding internal_search=false here doesn't make a difference to the logic as I'm pretty sure that missing field will be interpreted as false anyway. It's not wrong but I guess if it's futile then it could be removed.", "url": "https://github.com/nordic-institute/X-Road/pull/558#discussion_r441428391", "createdAt": "2020-06-17T09:57:12Z", "author": {"login": "TJaakkola"}, "path": "src/proxy-ui-api/frontend/src/views/AddSubsystem/AddSubsystem.vue", "diffHunk": "@@ -255,7 +255,7 @@ export default Vue.extend({\n       // Fetch selectable subsystems\n       api\n         .get(\n-          `/clients?instance=${this.instanceId}&member_class=${this.memberClass}&member_code=${this.memberCode}&show_members=false&exclude_local=true`,\n+          `/clients?instance=${this.instanceId}&member_class=${this.memberClass}&member_code=${this.memberCode}&show_members=false&exclude_local=true&internal_search=false`,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b30304c30e5e0ede95f97d6f191dc13fe1dc00d0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ0NDcyNQ==", "bodyText": "Making an async call inside anothers success-block creates what is called a callback hell. This also introduces an extra period of waiting as the latter call is created after the first has been successfully completed.\nWith Promise.all we can send multiple rest calls and wait for ALL of them have completed successfully. The code sample of how this is done is below. I didn't test it but it's at least nearly there...\n// Fetch list of local clients and filter out global clients\n    // that have local relatives\n    return Promise.all([globalClientsPromise, localClientsPromise])\n      .then( (response) => {\n        const globalClients = response[0];\n        const localClients = response[1];\n        commit('storeSelectableClients', excludeClientsWithLocalRelatives(globalClients.data, localClients.data));\n      })\n      .catch( error => {\n        throw error;\n      });", "url": "https://github.com/nordic-institute/X-Road/pull/558#discussion_r441444725", "createdAt": "2020-06-17T10:26:04Z", "author": {"login": "TJaakkola"}, "path": "src/proxy-ui-api/frontend/src/store/modules/addClient.ts", "diffHunk": "@@ -143,13 +161,21 @@ export const actions: ActionTree<AddClientState, RootState> = {\n     // Fetch clients from backend that can be selected\n     return api\n       .get(\n-        '/clients?exclude_local=true&member_missing_sign_cert=true&internal_search=false&show_members=false',\n+        '/clients?exclude_local=true&internal_search=false&show_members=false',\n       )\n-      .then((res) => {\n-        commit('storeSelectableClients', res.data);\n+      .then((globalClientsRes) => {\n+        // Fetch list of local clients and filter out global clients\n+        // that have local relatives\n+        api.get('/clients').then((localClientsRes) => {\n+            commit('storeSelectableClients',\n+            excludeClientsWithLocalRelatives(globalClientsRes.data, localClientsRes.data));\n+          })\n+          .catch((localClientsError) => {\n+            throw localClientsError;\n+          });\n       })\n-      .catch((error) => {\n-        throw error;\n+      .catch((globalClientsError) => {\n+        throw globalClientsError;\n       });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b30304c30e5e0ede95f97d6f191dc13fe1dc00d0"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ1NTA2Mw==", "bodyText": "Although this code works correctly I think it could be optimized and made in more currently idiomatic javascript way by using array operation some (which is a for loop which will quit looping through if true is returned inside it. Also some will return a false or true value, false is true is not returned).\nHere's an example showing how I would try to make this to be easier to read:\n`\nconst memberEquals = (client: Client, other: Client): boolean =>\nclient.member_class === other.member_class &&\nclient.member_code === other.member_code &&\nclient.instance_id === other.instance_id;\n// Filters out clients that have local relatives.\n// If the member owning the client or another subsystem\n// of the same member is already present locally,\n// the client is excluded.\nconst excludeClientsWithLocalRelatives = (clients: Client[], localClients: Client[]): Client[] => {\nreturn clients.filter((client: Client) => {\nreturn !localClients.some( (localClient: Client) => memberEquals(localClient, client))\n});\n}\n`\nIf memberEquals (not sure if this is a good function name here) returns true then loop is short circuited and false (negated) is returned to the wrapping filter function.\nI didn't test whether this works by just replacing the existing implementation but it should.", "url": "https://github.com/nordic-institute/X-Road/pull/558#discussion_r441455063", "createdAt": "2020-06-17T10:46:15Z", "author": {"login": "TJaakkola"}, "path": "src/proxy-ui-api/frontend/src/store/modules/addClient.ts", "diffHunk": "@@ -134,6 +134,24 @@ export const mutations: MutationTree<AddClientState> = {\n   },\n };\n \n+// Filters out clients that have local relatives.\n+// If the member owning the client or another subsystem\n+// of the same member is already present locally,\n+// the client is excluded.\n+const excludeClientsWithLocalRelatives = (clients: Client[], localClients: Client[]): Client[] => {\n+  return clients.filter((client: Client) => {\n+    let showClient = true;\n+    localClients.forEach((localClient: Client) => {\n+      if (localClient.member_class === client.member_class &&\n+          localClient.member_code === client.member_code &&\n+          localClient.instance_id === client.instance_id) {\n+        showClient = false;\n+      }\n+    });\n+    return showClient;\n+  });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b30304c30e5e0ede95f97d6f191dc13fe1dc00d0"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7de2060b8f6e67d83bf3cc2b78e2481ecd0b8eb", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/c7de2060b8f6e67d83bf3cc2b78e2481ecd0b8eb", "committedDate": "2020-06-17T14:04:59Z", "message": "XRDDEV-1122 Refactor implementation\n\n- Use Promise.all instead of nested callbacks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98df0db00e676dd3c9ac9437422681e2c47e1adf", "author": {"user": {"login": "petkivim", "name": "Petteri Kivim\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/98df0db00e676dd3c9ac9437422681e2c47e1adf", "committedDate": "2020-06-17T14:20:33Z", "message": "XRDDEV-1122 Refactor based review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTY5NTEx", "url": "https://github.com/nordic-institute/X-Road/pull/558#pullrequestreview-432969511", "createdAt": "2020-06-18T06:17:06Z", "commit": {"oid": "98df0db00e676dd3c9ac9437422681e2c47e1adf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4113, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}