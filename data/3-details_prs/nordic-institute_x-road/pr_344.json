{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NDIxOTU2", "number": 344, "title": "XRDDEV-837 Generate internal TLS key cert", "bodyText": "Generate internal TLS key and cert\nhttps://jira.niis.org/browse/XRDDEV-837", "createdAt": "2020-01-29T07:59:06Z", "url": "https://github.com/nordic-institute/X-Road/pull/344", "merged": true, "mergeCommit": {"oid": "9b9566d158dacf17741179e5b37f8e6eb64cdbf0"}, "closed": true, "closedAt": "2020-02-13T07:13:17Z", "author": {"login": "carohauta"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9b7Z_AH2gAyMzY4NDIxOTU2OmFmOWIxOGY0ZGVjZGFmMTUxZjZlMDQ0ZjMxMTQ0Njk1OGUzNTNlMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcD1kZrgFqTM1Nzk5NDg0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "af9b18f4decdaf151f6e044f311446958e353e39", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/af9b18f4decdaf151f6e044f311446958e353e39", "committedDate": "2020-01-24T09:56:38Z", "message": "XRDDEV-837 Generate internal TLS key and cert\n\n* process runner\n* test fixing\n* services and controller method\n* api design"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac16bb5a2c0360ac3fe64b86b5246645de188f5a", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/ac16bb5a2c0360ac3fe64b86b5246645de188f5a", "committedDate": "2020-01-27T13:50:53Z", "message": "XRDDEV-837 Generate internal TLS key and cert\n\n* process exception handling\n* testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8ceab6ea599a280a5ae75d3e7141ca48c79ae52", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/d8ceab6ea599a280a5ae75d3e7141ca48c79ae52", "committedDate": "2020-01-27T14:42:50Z", "message": "XRDDEV-837 Generate internal TLS key and cert // cleaning\n\n* better process exception handling\n* fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10a38d9caa403879f7d762daa4a6e6c9338fade7", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/10a38d9caa403879f7d762daa4a6e6c9338fade7", "committedDate": "2020-01-29T07:57:27Z", "message": "XRDDEV-837 Generate internal TLS key and cert // tests and restart\n\n* basic unit tests\n* added xroad-proxy restart for now"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5OTQ5MzI5", "url": "https://github.com/nordic-institute/X-Road/pull/344#pullrequestreview-349949329", "createdAt": "2020-01-29T09:04:15Z", "commit": {"oid": "10a38d9caa403879f7d762daa4a6e6c9338fade7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTowNDoxNlrOFjA9cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTowNDoxNlrOFjA9cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2MDIwOQ==", "bodyText": "Not doing a full review now, but just noticed this and wanted to add my thoughts.\nThis raises a few questions for me:\n\nmany DeviationAwareExceptions offer constructors that make it possible to copy deviations from another exception (\n  \n    \n      X-Road/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/BadRequestException.java\n    \n    \n        Lines 42 to 44\n      in\n      8b7f2a6\n    \n    \n    \n    \n\n        \n          \n           public BadRequestException(DeviationAware deviations) { \n        \n\n        \n          \n               super(deviations.getErrorDeviation(), deviations.getWarningDeviations()); \n        \n\n        \n          \n           } \n        \n    \n  \n\n). I thought it would maybe better to consider putting this kind of functionality to a DeviationAwareRuntimeException constructor instead. That way \"deviation copying\" theme would always be handled using the same style (target exception / it's constructors) and not sometimes by target exception, sometimes by source exception. Granted there are some problems with that option (lots of constructors)\nstoring localizedMessage to metadata is a bit questionable. Metadata's reason of existence was originally to transfer some structured metadata to frontend: https://confluence.niis.org/pages/viewpage.action?pageId=8520435#APIGuidelines&Examples-Errorhandling. As in \"duplicateService.v1\" in the example. I know we are already breaking this (for example CodedException handling in exceptiontranslator). I fear adding a generic ServiceException.throwAsDeviationAwareRuntimeException will lead into wide use to easily and quickly translate ServiceExceptions into unchecked ones, and this creates an end result where metadata loses it's original purpose, you don't really know what kind of data it contains, and it often leaks exception messages to frontend even if that was not the intention.\n\nI think the API and error object design started from the idea that we want to hide things like the stacktrace, and original unprocessed error message, from the client. And sometimes add something extra, the error metadata, which should be limited and well known and documented in the API - when calling this endpoint you may receive this metadata.\nThen some contradictory requirements started piling up - we want to display all the error detail the old system does, and we don't want to be killed by the complex error handling, and this has caused the metadata idea to suffer and rot a little bit and become fuzzy.\nThere's always a bit of contradiction here - on the other hand we want to \"show same level of detail in error messages as the old UI\" - and on the other hand we want to follow https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/REST_Security_Cheat_Sheet.md#error-handling. I don't think we can create a universal solution for this, we need to decide on it case by case (and consult @petkivim and @raits maybe more often on these), and usually one of the requirements has to compromise (either UI displays less error detail than the old, or we break OWASP recommendations).\nI think I would e.g. feel better if\n    public void generateInternalTlsKeyAndCertificate() {\n        try {\n            externalProcessRunner.execute(generateCertScriptPath, generateCertScriptArgs.split(\"\\\\s+\"));\n            restartXroadProxy();\n        } catch (ProcessNotExecutableException | ProcessFailedException e) {\n            e.throwAsDeviationAwareRuntimeException(KEY_CERT_GENERATION_FAILED);\n        }\n    }\n\n\nwould make it more explicit on how it transforms e.localizedMessage -> e.error.metadata. When thinking about just this code, the difference is small, but I am more worried about how other code will (mis)use ServiceException.throwAsDeviationAwareRuntimeException", "url": "https://github.com/nordic-institute/X-Road/pull/344#discussion_r372260209", "createdAt": "2020-01-29T09:04:16Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceException.java", "diffHunk": "@@ -65,6 +68,28 @@ public ServiceException(String msg, ErrorDeviation errorDeviation) {\n         super(msg, errorDeviation);\n     }\n \n-\n-\n+    /**\n+     * Throws the caught ServiceException as a {@link DeviationAwareRuntimeException}. The cause and\n+     * {@link ErrorDeviation#metadata ErrorDeviation metadata} will be transferred from the original exception\n+     * but a new error code must be provided. If the underlying exception does not have error metadata then the\n+     * localized message of the underlying exception is used as metadata instead. If there is no underlying exception\n+     * at all, then only the error code will be returned within the ErrorDeviation object.\n+     * @param newErrorCode the new error code of the exception\n+     */\n+    public void throwAsDeviationAwareRuntimeException(String newErrorCode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10a38d9caa403879f7d762daa4a6e6c9338fade7"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cf92d02086794fbd1cfce0778c7ec59bd8b5c97", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/9cf92d02086794fbd1cfce0778c7ec59bd8b5c97", "committedDate": "2020-02-10T12:10:56Z", "message": "Merge branch 'develop' into XRDDEV-837-generate-internal-tls-key-cert\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/resources/common-application.yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f22afb719452b7a3a367bf7fe7e65d25e02da650", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/f22afb719452b7a3a367bf7fe7e65d25e02da650", "committedDate": "2020-02-10T13:43:23Z", "message": "XRDDEV-837 Generate internal TLS key and cert // PR fix 1\n\n* change error handling to NOT provide the process output to the API caller\n* log the process output"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5667022c33427c1d268827c4ac57ebf89ddc630a", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/5667022c33427c1d268827c4ac57ebf89ddc630a", "committedDate": "2020-02-11T10:42:16Z", "message": "XRDDEV-837 Generate internal TLS key and cert // cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2Nzg1MDkw", "url": "https://github.com/nordic-institute/X-Road/pull/344#pullrequestreview-356785090", "createdAt": "2020-02-11T16:06:45Z", "commit": {"oid": "5667022c33427c1d268827c4ac57ebf89ddc630a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNjowNjo0NVrOFoPDVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNzoyOToxNVrOFoSObQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczMzk3NQ==", "bodyText": "Running external processes is surprisingly hard! I think I spent a couple of hours looking into it. One option would be to leverage existing libraries to avoid the hard parts. I know of Apache Commons Exec https://commons.apache.org/proper/commons-exec/index.html. It might make things easier or not.\nI also looked into ancient stuff #6 (which we have sometimes used as an job interview exercise!)\nThis is implementation seems to be pretty good though. It avoids the most common pitfalls and is clear and nicely documented. Good job!", "url": "https://github.com/nordic-institute/X-Road/pull/344#discussion_r377733975", "createdAt": "2020-02-11T16:06:45Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+@Slf4j\n+@Component\n+public class ExternalProcessRunner {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5667022c33427c1d268827c4ac57ebf89ddc630a"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczNzMxNQ==", "bodyText": "Maybe consider using this https://docs.oracle.com/javase/8/docs/api/java/lang/Process.html#waitFor-long-java.util.concurrent.TimeUnit- ?\nIf for some reason the command / script hangs (say, something has gone wrong so that it expects input) this would block forever.", "url": "https://github.com/nordic-institute/X-Road/pull/344#discussion_r377737315", "createdAt": "2020-02-11T16:11:50Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+@Slf4j\n+@Component\n+public class ExternalProcessRunner {\n+    /**\n+     * Executes the given command with given arguments.\n+     * @param command the command to execute\n+     * @param args arguments to be appended to the command. Make sure to pass your arguments in the correct order\n+     * (e.g. if your options have values enter them as separate consecutive args).\n+     * @return the output of the executed process as a List of Strings\n+     * @throws ProcessNotExecutableException in the case of IOException or if the process is interrupted\n+     * @throws ProcessFailedException if the process' exit code is not 0\n+     */\n+    public List<String> execute(String command, String... args) throws ProcessNotExecutableException,\n+            ProcessFailedException {\n+        if (StringUtils.isEmpty(command)) {\n+            throw new IllegalArgumentException(\"command cannot be null\");\n+        }\n+\n+        List<String> commandWithArgs = new ArrayList<>();\n+        commandWithArgs.add(command);\n+        if (args != null && args.length > 0) {\n+            commandWithArgs.addAll(Arrays.asList(args));\n+        }\n+        Process process;\n+        ProcessBuilder pb = new ProcessBuilder(commandWithArgs);\n+        // redirect process errors into process's input stream\n+        pb.redirectErrorStream(true);\n+        try {\n+            process = pb.start();\n+        } catch (IOException e) {\n+            throw new ProcessNotExecutableException(e);\n+        }\n+\n+        // gather output into a list of string for returning\n+        List<String> processOutput = new ArrayList<>();\n+        try (BufferedReader br = new BufferedReader(new InputStreamReader(process.getInputStream()))) {\n+            br.lines().forEach(processOutput::add);\n+        } catch (IOException e) {\n+            process.destroy();\n+            throw new ProcessNotExecutableException(e);\n+        }\n+\n+        int exitCode;\n+\n+        try {\n+            exitCode = process.waitFor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5667022c33427c1d268827c4ac57ebf89ddc630a"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc1OTQ4NA==", "bodyText": "So the try-with-resources will guarantee that process.inputStream gets closed, and is closed before this line (or line 80 if no exceptions)...right?\nI believe this is good. It is probably not necessary, but it seems nothing in the javadocs guarantees that the streams will be closed otherwise, and there were some sources that suggest closing.\nIt is probably not necessary = looking at UNIXProcess.destroy() there's code that probably takes care of closing the streams. But again, I see no official guarantee and who knows what UnknownOSProcess.destroy() we could be using some day. Actually UNIXProcess.destroy will maybe try to close an already closed stream, but that is usually not a problem. Ugh, too much vagueness for my liking but what can you do.\nNow I am thinking if we should also close errorStream and outputStream the same way, as suggested by this https://stackoverflow.com/a/7100172/1469083? It is most likely not needed, but doing it in a fail safe way (IOUtils.closeQuietly maybe?) after destroy() should not hurt either...\nSources talking about closing:\n\nhttps://stackoverflow.com/a/7102717/1469083 (and it's comments, about destroy())\nhttps://stackoverflow.com/a/7100172/1469083 and other answers to the question", "url": "https://github.com/nordic-institute/X-Road/pull/344#discussion_r377759484", "createdAt": "2020-02-11T16:45:59Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+@Slf4j\n+@Component\n+public class ExternalProcessRunner {\n+    /**\n+     * Executes the given command with given arguments.\n+     * @param command the command to execute\n+     * @param args arguments to be appended to the command. Make sure to pass your arguments in the correct order\n+     * (e.g. if your options have values enter them as separate consecutive args).\n+     * @return the output of the executed process as a List of Strings\n+     * @throws ProcessNotExecutableException in the case of IOException or if the process is interrupted\n+     * @throws ProcessFailedException if the process' exit code is not 0\n+     */\n+    public List<String> execute(String command, String... args) throws ProcessNotExecutableException,\n+            ProcessFailedException {\n+        if (StringUtils.isEmpty(command)) {\n+            throw new IllegalArgumentException(\"command cannot be null\");\n+        }\n+\n+        List<String> commandWithArgs = new ArrayList<>();\n+        commandWithArgs.add(command);\n+        if (args != null && args.length > 0) {\n+            commandWithArgs.addAll(Arrays.asList(args));\n+        }\n+        Process process;\n+        ProcessBuilder pb = new ProcessBuilder(commandWithArgs);\n+        // redirect process errors into process's input stream\n+        pb.redirectErrorStream(true);\n+        try {\n+            process = pb.start();\n+        } catch (IOException e) {\n+            throw new ProcessNotExecutableException(e);\n+        }\n+\n+        // gather output into a list of string for returning\n+        List<String> processOutput = new ArrayList<>();\n+        try (BufferedReader br = new BufferedReader(new InputStreamReader(process.getInputStream()))) {\n+            br.lines().forEach(processOutput::add);\n+        } catch (IOException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5667022c33427c1d268827c4ac57ebf89ddc630a"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc3OTgxOQ==", "bodyText": "Good that there's the Thread.currentThread().interrupt(); which is important.\nI am a bit unsure about wrapping it in ProcessNotExecutableException though. Would just throwing InterruptedException from the methods be better? InterruptedException has a special meaning and wrapping it in ProcessNotExecutableException kind of hides this info from the callers. Declaring InterruptedException would probably be more \"standard\" / idiomatic way of handling this.\nFor example https://stackoverflow.com/questions/3976344/handling-interruptedexception-in-java has lots of discussion which I kind of interpret advocating throwing InterruptedException unless there's special reason not to.\nWe would have to map InterruptedException -> InternalServerErrorException in the controller anyways, so the change would mostly affect the intermediate layers.", "url": "https://github.com/nordic-institute/X-Road/pull/344#discussion_r377779819", "createdAt": "2020-02-11T17:18:42Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+@Slf4j\n+@Component\n+public class ExternalProcessRunner {\n+    /**\n+     * Executes the given command with given arguments.\n+     * @param command the command to execute\n+     * @param args arguments to be appended to the command. Make sure to pass your arguments in the correct order\n+     * (e.g. if your options have values enter them as separate consecutive args).\n+     * @return the output of the executed process as a List of Strings\n+     * @throws ProcessNotExecutableException in the case of IOException or if the process is interrupted\n+     * @throws ProcessFailedException if the process' exit code is not 0\n+     */\n+    public List<String> execute(String command, String... args) throws ProcessNotExecutableException,\n+            ProcessFailedException {\n+        if (StringUtils.isEmpty(command)) {\n+            throw new IllegalArgumentException(\"command cannot be null\");\n+        }\n+\n+        List<String> commandWithArgs = new ArrayList<>();\n+        commandWithArgs.add(command);\n+        if (args != null && args.length > 0) {\n+            commandWithArgs.addAll(Arrays.asList(args));\n+        }\n+        Process process;\n+        ProcessBuilder pb = new ProcessBuilder(commandWithArgs);\n+        // redirect process errors into process's input stream\n+        pb.redirectErrorStream(true);\n+        try {\n+            process = pb.start();\n+        } catch (IOException e) {\n+            throw new ProcessNotExecutableException(e);\n+        }\n+\n+        // gather output into a list of string for returning\n+        List<String> processOutput = new ArrayList<>();\n+        try (BufferedReader br = new BufferedReader(new InputStreamReader(process.getInputStream()))) {\n+            br.lines().forEach(processOutput::add);\n+        } catch (IOException e) {\n+            process.destroy();\n+            throw new ProcessNotExecutableException(e);\n+        }\n+\n+        int exitCode;\n+\n+        try {\n+            exitCode = process.waitFor();\n+        } catch (InterruptedException e) {\n+            // we don't want to throw the InterruptedException from here but we want to retain the interrupted status", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5667022c33427c1d268827c4ac57ebf89ddc630a"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc4NTk2NQ==", "bodyText": "This stores process output in the ErrorDeviation metadata. I would like to remove that as well - it is in a sense misuse of the metadata. Maybe just add some sort of separate container property in ProcessFailedException (which may be more clear option anyways)?\nThe metadata is removed in an upper layer yes, but it is still a bit problematic when new clients that use ExternalProcessRunner are added.\nWe have DeviationAwareException constructors that take a DeviationAware object as a parameter and copy ErrorDeviation and metadata from there - it feels likely that the process output could start to leak to the API response by mistake. I may have written a better and longer explanation here #344 (comment)", "url": "https://github.com/nordic-institute/X-Road/pull/344#discussion_r377785965", "createdAt": "2020-02-11T17:29:15Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+@Slf4j\n+@Component\n+public class ExternalProcessRunner {\n+    /**\n+     * Executes the given command with given arguments.\n+     * @param command the command to execute\n+     * @param args arguments to be appended to the command. Make sure to pass your arguments in the correct order\n+     * (e.g. if your options have values enter them as separate consecutive args).\n+     * @return the output of the executed process as a List of Strings\n+     * @throws ProcessNotExecutableException in the case of IOException or if the process is interrupted\n+     * @throws ProcessFailedException if the process' exit code is not 0\n+     */\n+    public List<String> execute(String command, String... args) throws ProcessNotExecutableException,\n+            ProcessFailedException {\n+        if (StringUtils.isEmpty(command)) {\n+            throw new IllegalArgumentException(\"command cannot be null\");\n+        }\n+\n+        List<String> commandWithArgs = new ArrayList<>();\n+        commandWithArgs.add(command);\n+        if (args != null && args.length > 0) {\n+            commandWithArgs.addAll(Arrays.asList(args));\n+        }\n+        Process process;\n+        ProcessBuilder pb = new ProcessBuilder(commandWithArgs);\n+        // redirect process errors into process's input stream\n+        pb.redirectErrorStream(true);\n+        try {\n+            process = pb.start();\n+        } catch (IOException e) {\n+            throw new ProcessNotExecutableException(e);\n+        }\n+\n+        // gather output into a list of string for returning\n+        List<String> processOutput = new ArrayList<>();\n+        try (BufferedReader br = new BufferedReader(new InputStreamReader(process.getInputStream()))) {\n+            br.lines().forEach(processOutput::add);\n+        } catch (IOException e) {\n+            process.destroy();\n+            throw new ProcessNotExecutableException(e);\n+        }\n+\n+        int exitCode;\n+\n+        try {\n+            exitCode = process.waitFor();\n+        } catch (InterruptedException e) {\n+            // we don't want to throw the InterruptedException from here but we want to retain the interrupted status\n+            Thread.currentThread().interrupt();\n+            throw new ProcessNotExecutableException(e);\n+        } finally {\n+            // always destroy the process\n+            process.destroy();\n+        }\n+\n+        // if the process fails we attach the output into the exception\n+        if (exitCode != 0) {\n+            String fullCommandString = String.join(\" \", commandWithArgs);\n+            String processOutputString = String.join(\"\\n\", processOutput);\n+            String errorMsg = String.format(\"Failed to run command '%s' with output: \\n %s\", fullCommandString,\n+                    processOutputString);\n+            throw new ProcessFailedException(errorMsg, processOutput);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5667022c33427c1d268827c4ac57ebf89ddc630a"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "283280cb4e60edae7fab0916d0005b8d31fc2237", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/283280cb4e60edae7fab0916d0005b8d31fc2237", "committedDate": "2020-02-12T10:53:31Z", "message": "XRDDEV-837 Generate internal TLS key and cert // PR fix 2\n\n* added external process timeout, confirm stream closings, propagate InterruptedException\n* fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f4f48f025f0ef37f8398c0bcd69b4d7e59bd467", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/8f4f48f025f0ef37f8398c0bcd69b4d7e59bd467", "committedDate": "2020-02-12T11:17:48Z", "message": "XRDDEV-837 Generate internal TLS key and cert // close additional stream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce2fabf67f2ef191338f9cfb9c93ec96bae008e3", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/ce2fabf67f2ef191338f9cfb9c93ec96bae008e3", "committedDate": "2020-02-12T13:37:28Z", "message": "Merge branch 'develop' into XRDDEV-837-generate-internal-tls-key-cert"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NDY0NzYz", "url": "https://github.com/nordic-institute/X-Road/pull/344#pullrequestreview-357464763", "createdAt": "2020-02-12T13:50:24Z", "commit": {"oid": "ce2fabf67f2ef191338f9cfb9c93ec96bae008e3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMzo1MDoyNFrOFovOpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMzo1NTo0N1rOFovbHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI2MTE1OA==", "bodyText": "the comment \"we dont want...\" seems outdated", "url": "https://github.com/nordic-institute/X-Road/pull/344#discussion_r378261158", "createdAt": "2020-02-12T13:50:24Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ExternalProcessRunner.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * The MIT License\n+ * Copyright (c) 2018 Estonian Information System Authority (RIA),\n+ * Nordic Institute for Interoperability Solutions (NIIS), Population Register Centre (VRK)\n+ * Copyright (c) 2015-2017 Estonian Information System Authority (RIA), Population Register Centre (VRK)\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package org.niis.xroad.restapi.service;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.compress.utils.IOUtils;\n+import org.springframework.stereotype.Component;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+@Slf4j\n+@Component\n+public class ExternalProcessRunner {\n+    private static final long TIMEOUT = 60000;\n+\n+    /**\n+     * Executes the given command with given arguments.\n+     * @param command the command to execute\n+     * @param args arguments to be appended to the command. Make sure to pass your arguments in the correct order\n+     * (e.g. if your options have values enter them as separate consecutive args).\n+     * @return the output of the executed process as a List of Strings\n+     * @throws ProcessNotExecutableException in the case of IOException or if the process is interrupted\n+     * @throws ProcessFailedException if the process' exit code is not 0\n+     */\n+    public List<String> execute(String command, String... args) throws ProcessNotExecutableException,\n+            ProcessFailedException, InterruptedException {\n+        if (StringUtils.isEmpty(command)) {\n+            throw new IllegalArgumentException(\"command cannot be null\");\n+        }\n+\n+        List<String> commandWithArgs = new ArrayList<>();\n+        commandWithArgs.add(command);\n+        if (args != null && args.length > 0) {\n+            commandWithArgs.addAll(Arrays.asList(args));\n+        }\n+        Process process;\n+        ProcessBuilder pb = new ProcessBuilder(commandWithArgs);\n+        // redirect process errors into process's input stream\n+        pb.redirectErrorStream(true);\n+        try {\n+            process = pb.start();\n+        } catch (IOException e) {\n+            throw new ProcessNotExecutableException(e);\n+        }\n+\n+        // gather output into a list of string for returning\n+        List<String> processOutput = new ArrayList<>();\n+        try (BufferedReader br = new BufferedReader(new InputStreamReader(process.getInputStream()))) {\n+            br.lines().forEach(processOutput::add);\n+        } catch (IOException e) {\n+            process.destroy();\n+            IOUtils.closeQuietly(process.getErrorStream());\n+            IOUtils.closeQuietly(process.getOutputStream());\n+            throw new ProcessNotExecutableException(e);\n+        }\n+\n+        int exitCode;\n+\n+        try {\n+            boolean hasExited = process.waitFor(TIMEOUT, TimeUnit.MILLISECONDS);\n+            // exit value cannot be asked if the process is still running after timeout - instead throw and destroy\n+            if (!hasExited) {\n+                throw new ProcessFailedException(\"Process timed out\");\n+            }\n+            exitCode = process.exitValue();\n+        } catch (InterruptedException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce2fabf67f2ef191338f9cfb9c93ec96bae008e3"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI2NDM0OA==", "bodyText": "Would it be good to add javadoc @throws documentation explaining where these InterruptedExceptions can originate from? At least to the public main-level service methods (addWsdlServiceDescription, updateWsdlUrl)?", "url": "https://github.com/nordic-institute/X-Road/pull/344#discussion_r378264348", "createdAt": "2020-02-12T13:55:47Z", "author": {"login": "jansu76"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceDescriptionService.java", "diffHunk": "@@ -225,7 +225,7 @@ public ServiceDescriptionType addWsdlServiceDescription(ClientId clientId, Strin\n             UnhandledWarningsException,\n             ServiceAlreadyExistsException,\n             InvalidUrlException,\n-            WsdlUrlAlreadyExistsException {\n+            WsdlUrlAlreadyExistsException, InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce2fabf67f2ef191338f9cfb9c93ec96bae008e3"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2142de3e913f4ee0949fc6cdb7534a6af7bb75d", "author": {"user": {"login": "carohauta", "name": "Caro Hautam\u00e4ki"}}, "url": "https://github.com/nordic-institute/X-Road/commit/d2142de3e913f4ee0949fc6cdb7534a6af7bb75d", "committedDate": "2020-02-12T14:07:42Z", "message": "XRDDEV-837 Generate internal TLS key and cert // PR fix 3\n\n* javadocs and comment fixed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3OTk0ODQ3", "url": "https://github.com/nordic-institute/X-Road/pull/344#pullrequestreview-357994847", "createdAt": "2020-02-13T07:12:35Z", "commit": {"oid": "d2142de3e913f4ee0949fc6cdb7534a6af7bb75d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4285, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}