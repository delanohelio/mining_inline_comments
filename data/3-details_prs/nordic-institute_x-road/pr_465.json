{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MTcwNjA3", "number": 465, "title": "XRDDEV-963 add service client access rights", "bodyText": "https://jira.niis.org/browse/XRDDEV-963", "createdAt": "2020-04-16T07:32:44Z", "url": "https://github.com/nordic-institute/X-Road/pull/465", "merged": true, "mergeCommit": {"oid": "889195c1bd11fed3984ee677b39757b02e6da7bf"}, "closed": true, "closedAt": "2020-05-05T14:52:28Z", "author": {"login": "jansu76"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXkegxgH2gAyNDA0MTcwNjA3OjgxODQ3ZjVhMTljYzk0ZmE5NWIwYzEwODUwZWMwYTgwNDYzYzFhMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceVSLGAFqTQwNTg2NzQ5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "81847f5a19cc94fa95b0c10850ec0a80463c1a00", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/81847f5a19cc94fa95b0c10850ec0a80463c1a00", "committedDate": "2020-04-14T14:36:15Z", "message": "XRDDEV-963 add controller method, service client parameter processing. Tests fail."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "114b721225cb6bf1b83993558ebbf4a2ef27f07a", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/114b721225cb6bf1b83993558ebbf4a2ef27f07a", "committedDate": "2020-04-15T05:48:46Z", "message": "fix broken tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "062c750d71279b692cd123156f814280d0b67f4a", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/062c750d71279b692cd123156f814280d0b67f4a", "committedDate": "2020-04-15T12:30:40Z", "message": "XRDDEV-963 add untested accessRightService.addServiceClientAccessRights and controller implementation, refactor accessRightService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bea5c34d1575b2790f45adbd7fa168274f26e201", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/bea5c34d1575b2790f45adbd7fa168274f26e201", "committedDate": "2020-04-15T14:02:37Z", "message": "XRDDEV-963 make add addServiceClientAccessRights return correct response objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc2cb55995c5e985fd0bb894576049d8697dbcb0", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/cc2cb55995c5e985fd0bb894576049d8697dbcb0", "committedDate": "2020-04-15T15:04:37Z", "message": "XRDDEV-963 fix bad duplicate access right check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae793221541775c986cbfa5e7c8f8bad4f5d4f80", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/ae793221541775c986cbfa5e7c8f8bad4f5d4f80", "committedDate": "2020-04-15T20:26:29Z", "message": "XRDDEV-963 fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4b84f8370ce921c06109dd2553bcf394d6c8a7b", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/a4b84f8370ce921c06109dd2553bcf394d6c8a7b", "committedDate": "2020-04-15T20:27:15Z", "message": "XRDDEV-963 add some accessRightService tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6aeb18ad51fbc2e3cce9e8717907ea0a3a0ea6d", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/a6aeb18ad51fbc2e3cce9e8717907ea0a3a0ea6d", "committedDate": "2020-04-15T21:50:45Z", "message": "XRDDEV-963 add controller test and more service tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "445aed7256f3af7984b58bc1c1edae11f8a6af64", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/445aed7256f3af7984b58bc1c1edae11f8a6af64", "committedDate": "2020-04-15T22:26:35Z", "message": "XRDDEV-963 add EndpointServiceIntegrationTest, refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7f24155feb0080565f3d20feba0744190923070", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/a7f24155feb0080565f3d20feba0744190923070", "committedDate": "2020-04-15T23:17:03Z", "message": "XRDDEV-963 cleanup for TODOs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95f46965e97e79404eacf3c4c8699e382b946048", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/95f46965e97e79404eacf3c4c8699e382b946048", "committedDate": "2020-04-16T12:54:42Z", "message": "XRDDEV-963 fix sonarqube complexity errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcd70ec80d21bcb0e10343d2f4bb40de9930ed17", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/dcd70ec80d21bcb0e10343d2f4bb40de9930ed17", "committedDate": "2020-04-16T16:48:48Z", "message": "Merge branch 'XRDDEV-961_XRDDEV-956' into XRDDEV-963-add-service-client-access-rights\n\nFix Conflicts:\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/AccessRightService.java\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/LocalGroupService.java\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceClientService.java\n\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/openapi/ClientsApiControllerIntegrationTest.java\n\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/openapi/EndpointsApiControllerTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cc3c6605ef83ef4e4fa319522ab98c5f3cb56a9", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/0cc3c6605ef83ef4e4fa319522ab98c5f3cb56a9", "committedDate": "2020-04-17T07:11:54Z", "message": "XRDDEV-936 add better error for bad service client id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffcd4dbb770c961feec718f5e3f865a9c78341f9", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/ffcd4dbb770c961feec718f5e3f865a9c78341f9", "committedDate": "2020-04-20T12:17:43Z", "message": "Merge branch 'XRDDEV-961_XRDDEV-956' into XRDDEV-963-add-service-client-access-rights"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66f7c8cffc405bf5462dc0b5b76a8cd06100b5b6", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/66f7c8cffc405bf5462dc0b5b76a8cd06100b5b6", "committedDate": "2020-04-21T05:56:19Z", "message": "Merge branch 'XRDDEV-961_XRDDEV-956' into XRDDEV-963-add-service-client-access-rights\n\nFix Conflicts:\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/GlobalConfService.java\n\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceClientService.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bfb4104788e4eb8deda0e698f4d08237c4dffd1", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/4bfb4104788e4eb8deda0e698f4d08237c4dffd1", "committedDate": "2020-04-21T09:23:03Z", "message": "XRDDEV-963 add test for serviceClient.rights_given_at"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4758c20fc580f79f679a9dc04b976af72224be4", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/f4758c20fc580f79f679a9dc04b976af72224be4", "committedDate": "2020-04-21T10:22:09Z", "message": "XRDDEV-963 update openapi documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cae91d3142c7c36a7f099f2bb7c9974be600b9d5", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/cae91d3142c7c36a7f099f2bb7c9974be600b9d5", "committedDate": "2020-04-21T11:07:24Z", "message": "XRDDEV-963 refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1447f5cd865e482726850f1af514d162fa89c51", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/e1447f5cd865e482726850f1af514d162fa89c51", "committedDate": "2020-04-24T08:29:05Z", "message": "Merge branch 'develop' into XRDDEV-963-add-service-client-access-rights"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNDQwODI0", "url": "https://github.com/nordic-institute/X-Road/pull/465#pullrequestreview-403440824", "createdAt": "2020-04-30T11:42:36Z", "commit": {"oid": "e1447f5cd865e482726850f1af514d162fa89c51"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMTo0MjozNlrOGOljlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMjo0MjoxMlrOGOneMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk0ODU2NQ==", "bodyText": "globalConfService is not used anymore so it can be removed from this class.", "url": "https://github.com/nordic-institute/X-Road/pull/465#discussion_r417948565", "createdAt": "2020-04-30T11:42:36Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/AccessRightService.java", "diffHunk": "@@ -313,108 +381,161 @@ private ServiceClientDto accessRightTypeToServiceClientDto(AccessRightType acces\n     }\n \n     /**\n-     * Add access rights to given endpoint\n+     * Add access rights for (possibly) multiple subjects, to a given endpoint\n      *\n-     * @param subjectIds\n-     * @param clientType\n-     * @param endpoint\n+     * @param subjectIds access rights subjects to grant access for, \"service clients\"\n+     * @param clientType endpoint owner\n+     * @param endpoint endpoint to add access rights to\n+     * @return map, key = subjectId (service client), value = list of access rights added for the subject\n+     * @throws DuplicateAccessRightException if trying to add existing access right\n+     */\n+    private Map<XRoadId, List<ServiceClientAccessRightDto>> addAccessRights(Set<XRoadId> subjectIds,\n+            ClientType clientType, EndpointType endpoint)\n+            throws DuplicateAccessRightException, LocalGroupNotFoundException {\n+        List<EndpointType> endpoints = Collections.singletonList(endpoint);\n+        return addAccessRightsInternal(subjectIds, clientType, endpoints);\n+    }\n+\n+    /**\n+     * Add access rights for (possibly) multiple subjects, to (possibly) multiple endpoints.\n+     *\n+     * This method is not intended for use from outside, but is package protected for tests.\n+     *\n+     * @param subjectIds access rights subjects to grant access for, \"service clients\"\n+     * @param clientType endpoint owner\n+     * @param endpoints endpoints to add access rights to\n+     * @return map, key = subjectId (service client), value = list of access rights added for the subject\n      * @throws DuplicateAccessRightException if trying to add existing access right\n      */\n-    private void addAccessRights(Set<XRoadId> subjectIds, ClientType clientType, EndpointType endpoint)\n+    Map<XRoadId, List<ServiceClientAccessRightDto>> addAccessRightsInternal(Set<XRoadId> subjectIds,\n+            ClientType clientType, List<EndpointType> endpoints)\n             throws DuplicateAccessRightException, LocalGroupNotFoundException {\n         Date now = new Date();\n \n-        List<LocalGroupType> clientLocalGroups = clientType.getLocalGroup();\n+        if (subjectIds == null || subjectIds.isEmpty()) {\n+            throw new IllegalArgumentException(\"missing subjectIds\");\n+        }\n+        if (endpoints == null || endpoints.isEmpty()) {\n+            throw new IllegalArgumentException(\"missing endpoints\");\n+        }\n \n-        for (XRoadId subjectId : subjectIds) {\n-            // A LocalGroup must belong to this client\n-            if (subjectId.getObjectType() == XRoadObjectType.LOCALGROUP) {\n-                LocalGroupId localGroupId = (LocalGroupId) subjectId;\n-                boolean localGroupNotFound = clientLocalGroups.stream()\n-                        .noneMatch(localGroupType -> localGroupType.getGroupCode()\n-                                .equals(localGroupId.getGroupCode()));\n-                if (localGroupNotFound) {\n-                    String errorMsg = String.format(\"LocalGroup with the groupCode %s does not belong to client %s\",\n-                            subjectId.toShortString(), clientType.getIdentifier().toShortString());\n-                    throw new LocalGroupNotFoundException(errorMsg);\n-                }\n-            }\n-            Optional<AccessRightType> existingAccessRight = clientType.getAcl().stream()\n-                    .filter(accessRightType -> accessRightType.getSubjectId().equals(subjectId))\n-                    .findFirst();\n+        Map<XRoadId, List<ServiceClientAccessRightDto>> addedAccessRights = new HashMap<>();\n \n-            if (existingAccessRight.isPresent() && existingAccessRight.get().getEndpoint().equals(endpoint)) {\n-                throw new DuplicateAccessRightException(\"Subject \" + subjectId.toShortString()\n-                        + \" already has an access right for endpoint \" + endpoint.getId());\n+        for (EndpointType endpoint: endpoints) {\n+            for (XRoadId subjectId : subjectIds) {\n+                ServiceClientAccessRightDto dto = addAccessRightInternal(clientType, now, endpoint, subjectId);\n+                List<ServiceClientAccessRightDto> addedAccessRightsForSubject = addedAccessRights\n+                        .computeIfAbsent(subjectId, k -> new ArrayList<>());\n+                addedAccessRightsForSubject.add(dto);\n             }\n-            AccessRightType newAccessRight = new AccessRightType();\n-            newAccessRight.setEndpoint(endpoint);\n-            newAccessRight.setSubjectId(subjectId);\n-            newAccessRight.setRightsGiven(now);\n-            clientType.getAcl().add(newAccessRight);\n         }\n \n         clientRepository.saveOrUpdate(clientType);\n+        return addedAccessRights;\n     }\n \n-    private Set<XRoadId> mergeSubjectIdsWithLocalgroups(Set<XRoadId> subjectIds, Set<Long> localGroupIds)\n-            throws IdentifierNotFoundException, AccessRightNotFoundException {\n-        // Get persistent entities in order to change relations\n-        Set<XRoadId> txSubjects = new HashSet<>();\n-        if (subjectIds != null && !subjectIds.isEmpty()) {\n-            txSubjects.addAll(getOrPersistSubsystemIds(subjectIds.stream()\n-                    .filter(xRoadId -> xRoadId.getObjectType() == XRoadObjectType.SUBSYSTEM)\n-                    .collect(Collectors.toSet())));\n-            txSubjects.addAll(getOrPersistGlobalGroupIds(subjectIds.stream()\n-                    .filter(xRoadId -> xRoadId.getObjectType() == XRoadObjectType.GLOBALGROUP)\n-                    .collect(Collectors.toSet())));\n-        }\n-        if (localGroupIds != null && localGroupIds.size() > 0) {\n-            Set<XRoadId> localGroupXroadIds = null;\n-            try {\n-                localGroupXroadIds = localGroupService.getLocalGroupIdsAsXroadIds(localGroupIds);\n-            } catch (LocalGroupNotFoundException e) {\n-                throw new AccessRightNotFoundException(e);\n+    /**\n+     * Add access right for a single subject (subjectId), to a single endpoint (endpoint) that belongs to clientType\n+     * @param clientType\n+     * @param rightsGiven\n+     * @param endpoint\n+     * @param subjectId\n+     * @return\n+     * @throws LocalGroupNotFoundException if local group does not exist for given client\n+     * @throws DuplicateAccessRightException if access righ already exists\n+     */\n+    private ServiceClientAccessRightDto addAccessRightInternal(ClientType clientType, Date rightsGiven,\n+            EndpointType endpoint, XRoadId subjectId)\n+            throws LocalGroupNotFoundException, DuplicateAccessRightException {\n+\n+        // A LocalGroup must belong to this client\n+        List<LocalGroupType> clientLocalGroups = clientType.getLocalGroup();\n+\n+        if (subjectId.getObjectType() == XRoadObjectType.LOCALGROUP) {\n+            LocalGroupId localGroupId = (LocalGroupId) subjectId;\n+            boolean localGroupNotFound = clientLocalGroups.stream()\n+                    .noneMatch(localGroupType -> localGroupType.getGroupCode()\n+                            .equals(localGroupId.getGroupCode()));\n+            if (localGroupNotFound) {\n+                String errorMsg = String.format(\"LocalGroup with the groupCode %s does not belong to client %s\",\n+                        subjectId.toShortString(), clientType.getIdentifier().toShortString());\n+                throw new LocalGroupNotFoundException(errorMsg);\n             }\n-            // Get LocalGroupIds from serverconf db - or save them if they don't exist\n-            Set<XRoadId> txLocalGroupXroadIds = identifierService.getOrPersistXroadIds(localGroupXroadIds);\n-            txSubjects.addAll(txLocalGroupXroadIds);\n         }\n-        return txSubjects;\n-    }\n \n-    /**\n-     * Verify that all identifiers are authentic, then get the existing ones from the local db and persist\n-     * the not-existing ones. This is a necessary step if we are changing identifier relations (such as adding\n-     * access rights to services)\n-     * @param subsystemIds {@link GlobalGroupId} or {@link ClientId}\n-     * @return List of XRoadIds ({@link GlobalGroupId} or {@link ClientId})\n-     */\n-    private Set<XRoadId> getOrPersistSubsystemIds(Set<XRoadId> subsystemIds)\n-            throws IdentifierNotFoundException {\n-        // Check that the identifiers exist in globalconf\n-        // LocalGroups must be verified separately! (they do not exist in globalconf)\n-        if (!globalConfService.clientIdentifiersExist(subsystemIds)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1447f5cd865e482726850f1af514d162fa89c51"}, "originalPosition": 344}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3Mjc5Mw==", "bodyText": "Javadoc throws not in sync (missing LocalGroupNotFoundException)", "url": "https://github.com/nordic-institute/X-Road/pull/465#discussion_r417972793", "createdAt": "2020-04-30T12:29:21Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/AccessRightService.java", "diffHunk": "@@ -313,108 +381,161 @@ private ServiceClientDto accessRightTypeToServiceClientDto(AccessRightType acces\n     }\n \n     /**\n-     * Add access rights to given endpoint\n+     * Add access rights for (possibly) multiple subjects, to a given endpoint\n      *\n-     * @param subjectIds\n-     * @param clientType\n-     * @param endpoint\n+     * @param subjectIds access rights subjects to grant access for, \"service clients\"\n+     * @param clientType endpoint owner\n+     * @param endpoint endpoint to add access rights to\n+     * @return map, key = subjectId (service client), value = list of access rights added for the subject\n+     * @throws DuplicateAccessRightException if trying to add existing access right", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1447f5cd865e482726850f1af514d162fa89c51"}, "originalPosition": 208}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3OTk1Mg==", "bodyText": "The .get() should probably be replaced with orElse(null) for service == null to ever be true. Or am I missing something here now?\nEdit: oh yes the filtering will always return a service", "url": "https://github.com/nordic-institute/X-Road/pull/465#discussion_r417979952", "createdAt": "2020-04-30T12:42:12Z", "author": {"login": "carohauta"}, "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/AccessRightService.java", "diffHunk": "@@ -313,108 +381,161 @@ private ServiceClientDto accessRightTypeToServiceClientDto(AccessRightType acces\n     }\n \n     /**\n-     * Add access rights to given endpoint\n+     * Add access rights for (possibly) multiple subjects, to a given endpoint\n      *\n-     * @param subjectIds\n-     * @param clientType\n-     * @param endpoint\n+     * @param subjectIds access rights subjects to grant access for, \"service clients\"\n+     * @param clientType endpoint owner\n+     * @param endpoint endpoint to add access rights to\n+     * @return map, key = subjectId (service client), value = list of access rights added for the subject\n+     * @throws DuplicateAccessRightException if trying to add existing access right\n+     */\n+    private Map<XRoadId, List<ServiceClientAccessRightDto>> addAccessRights(Set<XRoadId> subjectIds,\n+            ClientType clientType, EndpointType endpoint)\n+            throws DuplicateAccessRightException, LocalGroupNotFoundException {\n+        List<EndpointType> endpoints = Collections.singletonList(endpoint);\n+        return addAccessRightsInternal(subjectIds, clientType, endpoints);\n+    }\n+\n+    /**\n+     * Add access rights for (possibly) multiple subjects, to (possibly) multiple endpoints.\n+     *\n+     * This method is not intended for use from outside, but is package protected for tests.\n+     *\n+     * @param subjectIds access rights subjects to grant access for, \"service clients\"\n+     * @param clientType endpoint owner\n+     * @param endpoints endpoints to add access rights to\n+     * @return map, key = subjectId (service client), value = list of access rights added for the subject\n      * @throws DuplicateAccessRightException if trying to add existing access right\n      */\n-    private void addAccessRights(Set<XRoadId> subjectIds, ClientType clientType, EndpointType endpoint)\n+    Map<XRoadId, List<ServiceClientAccessRightDto>> addAccessRightsInternal(Set<XRoadId> subjectIds,\n+            ClientType clientType, List<EndpointType> endpoints)\n             throws DuplicateAccessRightException, LocalGroupNotFoundException {\n         Date now = new Date();\n \n-        List<LocalGroupType> clientLocalGroups = clientType.getLocalGroup();\n+        if (subjectIds == null || subjectIds.isEmpty()) {\n+            throw new IllegalArgumentException(\"missing subjectIds\");\n+        }\n+        if (endpoints == null || endpoints.isEmpty()) {\n+            throw new IllegalArgumentException(\"missing endpoints\");\n+        }\n \n-        for (XRoadId subjectId : subjectIds) {\n-            // A LocalGroup must belong to this client\n-            if (subjectId.getObjectType() == XRoadObjectType.LOCALGROUP) {\n-                LocalGroupId localGroupId = (LocalGroupId) subjectId;\n-                boolean localGroupNotFound = clientLocalGroups.stream()\n-                        .noneMatch(localGroupType -> localGroupType.getGroupCode()\n-                                .equals(localGroupId.getGroupCode()));\n-                if (localGroupNotFound) {\n-                    String errorMsg = String.format(\"LocalGroup with the groupCode %s does not belong to client %s\",\n-                            subjectId.toShortString(), clientType.getIdentifier().toShortString());\n-                    throw new LocalGroupNotFoundException(errorMsg);\n-                }\n-            }\n-            Optional<AccessRightType> existingAccessRight = clientType.getAcl().stream()\n-                    .filter(accessRightType -> accessRightType.getSubjectId().equals(subjectId))\n-                    .findFirst();\n+        Map<XRoadId, List<ServiceClientAccessRightDto>> addedAccessRights = new HashMap<>();\n \n-            if (existingAccessRight.isPresent() && existingAccessRight.get().getEndpoint().equals(endpoint)) {\n-                throw new DuplicateAccessRightException(\"Subject \" + subjectId.toShortString()\n-                        + \" already has an access right for endpoint \" + endpoint.getId());\n+        for (EndpointType endpoint: endpoints) {\n+            for (XRoadId subjectId : subjectIds) {\n+                ServiceClientAccessRightDto dto = addAccessRightInternal(clientType, now, endpoint, subjectId);\n+                List<ServiceClientAccessRightDto> addedAccessRightsForSubject = addedAccessRights\n+                        .computeIfAbsent(subjectId, k -> new ArrayList<>());\n+                addedAccessRightsForSubject.add(dto);\n             }\n-            AccessRightType newAccessRight = new AccessRightType();\n-            newAccessRight.setEndpoint(endpoint);\n-            newAccessRight.setSubjectId(subjectId);\n-            newAccessRight.setRightsGiven(now);\n-            clientType.getAcl().add(newAccessRight);\n         }\n \n         clientRepository.saveOrUpdate(clientType);\n+        return addedAccessRights;\n     }\n \n-    private Set<XRoadId> mergeSubjectIdsWithLocalgroups(Set<XRoadId> subjectIds, Set<Long> localGroupIds)\n-            throws IdentifierNotFoundException, AccessRightNotFoundException {\n-        // Get persistent entities in order to change relations\n-        Set<XRoadId> txSubjects = new HashSet<>();\n-        if (subjectIds != null && !subjectIds.isEmpty()) {\n-            txSubjects.addAll(getOrPersistSubsystemIds(subjectIds.stream()\n-                    .filter(xRoadId -> xRoadId.getObjectType() == XRoadObjectType.SUBSYSTEM)\n-                    .collect(Collectors.toSet())));\n-            txSubjects.addAll(getOrPersistGlobalGroupIds(subjectIds.stream()\n-                    .filter(xRoadId -> xRoadId.getObjectType() == XRoadObjectType.GLOBALGROUP)\n-                    .collect(Collectors.toSet())));\n-        }\n-        if (localGroupIds != null && localGroupIds.size() > 0) {\n-            Set<XRoadId> localGroupXroadIds = null;\n-            try {\n-                localGroupXroadIds = localGroupService.getLocalGroupIdsAsXroadIds(localGroupIds);\n-            } catch (LocalGroupNotFoundException e) {\n-                throw new AccessRightNotFoundException(e);\n+    /**\n+     * Add access right for a single subject (subjectId), to a single endpoint (endpoint) that belongs to clientType\n+     * @param clientType\n+     * @param rightsGiven\n+     * @param endpoint\n+     * @param subjectId\n+     * @return\n+     * @throws LocalGroupNotFoundException if local group does not exist for given client\n+     * @throws DuplicateAccessRightException if access righ already exists\n+     */\n+    private ServiceClientAccessRightDto addAccessRightInternal(ClientType clientType, Date rightsGiven,\n+            EndpointType endpoint, XRoadId subjectId)\n+            throws LocalGroupNotFoundException, DuplicateAccessRightException {\n+\n+        // A LocalGroup must belong to this client\n+        List<LocalGroupType> clientLocalGroups = clientType.getLocalGroup();\n+\n+        if (subjectId.getObjectType() == XRoadObjectType.LOCALGROUP) {\n+            LocalGroupId localGroupId = (LocalGroupId) subjectId;\n+            boolean localGroupNotFound = clientLocalGroups.stream()\n+                    .noneMatch(localGroupType -> localGroupType.getGroupCode()\n+                            .equals(localGroupId.getGroupCode()));\n+            if (localGroupNotFound) {\n+                String errorMsg = String.format(\"LocalGroup with the groupCode %s does not belong to client %s\",\n+                        subjectId.toShortString(), clientType.getIdentifier().toShortString());\n+                throw new LocalGroupNotFoundException(errorMsg);\n             }\n-            // Get LocalGroupIds from serverconf db - or save them if they don't exist\n-            Set<XRoadId> txLocalGroupXroadIds = identifierService.getOrPersistXroadIds(localGroupXroadIds);\n-            txSubjects.addAll(txLocalGroupXroadIds);\n         }\n-        return txSubjects;\n-    }\n \n-    /**\n-     * Verify that all identifiers are authentic, then get the existing ones from the local db and persist\n-     * the not-existing ones. This is a necessary step if we are changing identifier relations (such as adding\n-     * access rights to services)\n-     * @param subsystemIds {@link GlobalGroupId} or {@link ClientId}\n-     * @return List of XRoadIds ({@link GlobalGroupId} or {@link ClientId})\n-     */\n-    private Set<XRoadId> getOrPersistSubsystemIds(Set<XRoadId> subsystemIds)\n-            throws IdentifierNotFoundException {\n-        // Check that the identifiers exist in globalconf\n-        // LocalGroups must be verified separately! (they do not exist in globalconf)\n-        if (!globalConfService.clientIdentifiersExist(subsystemIds)) {\n-            // This exception should be pretty rare since it only occurs if bogus subjects are found\n-            throw new IdentifierNotFoundException();\n+        // list endpoints, which this subject / service client has already been granted access to\n+        Set<EndpointType> existingAccessibleEndpoints = clientType.getAcl().stream()\n+                .filter(accessRightType -> accessRightType.getSubjectId().equals(subjectId))\n+                .map(accessRightType -> accessRightType.getEndpoint())\n+                .collect(Collectors.toSet());\n+\n+        if (existingAccessibleEndpoints.contains(endpoint)) {\n+            throw new DuplicateAccessRightException(\"Subject \" + subjectId.toShortString()\n+                    + \" already has an access right for endpoint \" + endpoint.getId());\n         }\n-        return identifierService.getOrPersistXroadIds(subsystemIds);\n+\n+        AccessRightType newAccessRight = new AccessRightType();\n+        newAccessRight.setEndpoint(endpoint);\n+        newAccessRight.setSubjectId(subjectId);\n+        newAccessRight.setRightsGiven(rightsGiven);\n+        clientType.getAcl().add(newAccessRight);\n+\n+        // return a dto\n+        ServiceClientAccessRightDto dto = ServiceClientAccessRightDto.builder()\n+                .serviceCode(endpoint.getServiceCode())\n+                .rightsGiven(FormatUtils.fromDateToOffsetDateTime(rightsGiven))\n+                .title(getServiceTitle(clientType, endpoint.getServiceCode()))\n+                .build();\n+        return dto;\n+    }\n+\n+    // TO DO: currently duplicate with ServiceClientService, not sure if ServiceClientService will be refactored,\n+    // and what is the correct place if both need this\n+    private String getServiceTitle(ClientType clientType, String serviceCode) {\n+        ServiceType service = clientType.getServiceDescription().stream()\n+                .flatMap(sd -> sd.getService().stream())\n+                .filter(serviceType -> serviceType.getServiceCode().equals(serviceCode))\n+                .findFirst()\n+                .get();\n+\n+        return service == null ? null : service.getTitle();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1447f5cd865e482726850f1af514d162fa89c51"}, "originalPosition": 383}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bf425cf290c1322ca7cc9d10b2e8a4de2962348", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/1bf425cf290c1322ca7cc9d10b2e8a4de2962348", "committedDate": "2020-05-04T05:54:04Z", "message": "XRDDEV-963 fix some PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4419c8f4015f6625385ef8a73e01f2fbce1c8268", "author": {"user": {"login": "jansu76", "name": null}}, "url": "https://github.com/nordic-institute/X-Road/commit/4419c8f4015f6625385ef8a73e01f2fbce1c8268", "committedDate": "2020-05-04T08:50:43Z", "message": "Merge branch 'develop' into XRDDEV-963-add-service-client-access-rights"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1ODY3NDky", "url": "https://github.com/nordic-institute/X-Road/pull/465#pullrequestreview-405867492", "createdAt": "2020-05-05T14:51:40Z", "commit": {"oid": "4419c8f4015f6625385ef8a73e01f2fbce1c8268"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4210, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}