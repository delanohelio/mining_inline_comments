{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyMjE5MjM5", "number": 946, "title": "Support aggregate window functions", "bodyText": "Issue #, if available: #770\nDescription of changes:\nTo reviewers, most file changes are due to 1 and 2a renaming. You can focus on core logic in PeerRowsWindowFrame and AggregateWindowFunction.\n\nUse NamedExpression in logical and physical window operator: this is required because after expression analysis window function lost info in OVER clause, ex. RANK() OVER(expr1), RANK(expr2)\nRefactor window frame\na. Rename existing frame to CurrentRowWindowFrame which only maintains current row (and previous) for ranking window functions.\nb. Add new PeerRowsWindowFrame which preloads all peer rows for aggregate window function (Please check the design doc for more details)\nAdd AggregateWindowFunction adapter class to reuse existing aggregator\n\nDocumentation:\n\nDesign doc: https://github.com/dai-chen/sql/blob/support-aggregate-window-functions-2/docs/dev/AggregateWindowFunction.md\nUser manual: https://github.com/dai-chen/sql/blob/support-aggregate-window-functions-2/docs/user/dql/window.rst#aggregate-functions\nLimitations: https://github.com/dai-chen/sql/blob/support-aggregate-window-functions-2/docs/user/limitations/limitations.rst#limitations-on-window-functions\n\nTODOs: (covered in limitation doc)\n\nOptimize reference to other expression in SELECT clause, ex. SELECT SUM(a), SUM(SUM(a)) OVER(...) ...\n[Low] window function nested in other expression, ex. CASE WHEN SUM(a) OVER(...) ...\nEnable circuit break for window operator in case of worst case happen (elaborated in design doc above).\n\nTesting: Added UT and comparison test.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-12-18T00:45:20Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/946", "merged": true, "mergeCommit": {"oid": "9a08770195b11b3404972062fd335043cb1499fb"}, "closed": true, "closedAt": "2021-01-07T19:13:58Z", "author": {"login": "dai-chen"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmi_ofAH2gAyNTQyMjE5MjM5OjQ0YzdhNTE3NjRjOTIxOTExYWM2NGJjNjcwMDY1OTJhZDUyYWE4YzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdt5DfrAFqTU2Mzc1MTQ5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "44c7a51764c921911ac64bc67006592ad52aa8c1", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/44c7a51764c921911ac64bc67006592ad52aa8c1", "committedDate": "2020-12-15T23:32:38Z", "message": "Change grammar and AST builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cd76bce98522b45c1dc696479c9ea24d4430213", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4cd76bce98522b45c1dc696479c9ea24d4430213", "committedDate": "2020-12-16T00:51:34Z", "message": "Add tostring and getchild for window function AST node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eefd50d6b27ac3cd6a5c1e6a9f79b835cb7f09ce", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/eefd50d6b27ac3cd6a5c1e6a9f79b835cb7f09ce", "committedDate": "2020-12-16T01:05:08Z", "message": "Add aggregate window function class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95ed0bef8d6ffb1b2d424370f82e0c87bc9a54df", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/95ed0bef8d6ffb1b2d424370f82e0c87bc9a54df", "committedDate": "2020-12-16T16:49:06Z", "message": "Add peer window frame and refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b67036fcf6996628ae734d6eb6aacfa3deb620fc", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b67036fcf6996628ae734d6eb6aacfa3deb620fc", "committedDate": "2020-12-16T23:15:15Z", "message": "Name window function and optimize it when analysis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e7c0ceeeb930f1c0e4b5f54a5cdf6395e0d8c95", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4e7c0ceeeb930f1c0e4b5f54a5cdf6395e0d8c95", "committedDate": "2020-12-17T01:56:02Z", "message": "Refactor peer frame by peeking iterator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7d6580281e7aabb660a23058f48d5553aae05cd", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b7d6580281e7aabb660a23058f48d5553aae05cd", "committedDate": "2020-12-17T02:01:42Z", "message": "Comparison test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "656779771fa8d0c4356a833bbfabf4fb0f066cd5", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/656779771fa8d0c4356a833bbfabf4fb0f066cd5", "committedDate": "2020-12-17T22:49:55Z", "message": "Add doctest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f937efa11b71a69cb83c86c7e6325416afe7a910", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f937efa11b71a69cb83c86c7e6325416afe7a910", "committedDate": "2020-12-17T22:50:13Z", "message": "Add more comparison tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4357238e53e003e6867d4dd3ae370c47b634fc93", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4357238e53e003e6867d4dd3ae370c47b634fc93", "committedDate": "2020-12-17T23:41:54Z", "message": "Add java doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cae0143da52b0e683819eab7232390d2413bc2f", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5cae0143da52b0e683819eab7232390d2413bc2f", "committedDate": "2020-12-18T00:01:36Z", "message": "Rename and fix broken UT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99587c629a4edd3935d7322f9908dbb942e378b2", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/99587c629a4edd3935d7322f9908dbb942e378b2", "committedDate": "2020-12-18T00:34:53Z", "message": "Add more IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89ffe710ad7ab3c40e99319745865134258bce76", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/89ffe710ad7ab3c40e99319745865134258bce76", "committedDate": "2020-12-18T01:27:29Z", "message": "Add design doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d29ffce074f4fe80a242fd967144f9c432067cc", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8d29ffce074f4fe80a242fd967144f9c432067cc", "committedDate": "2020-12-18T19:43:48Z", "message": "Prepare PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "464109f5610fe473f19674b1f5edddf691062de2", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/464109f5610fe473f19674b1f5edddf691062de2", "committedDate": "2020-12-19T01:30:08Z", "message": "Fix no sort key bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ec79c160cf3507a3580a9d628508abb2c5a6c50", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1ec79c160cf3507a3580a9d628508abb2c5a6c50", "committedDate": "2021-01-05T18:58:47Z", "message": "Merge branch 'develop' into support-aggregate-window-functions-2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyMjExNjU1", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/946#pullrequestreview-562211655", "createdAt": "2021-01-05T23:31:30Z", "commit": {"oid": "1ec79c160cf3507a3580a9d628508abb2c5a6c50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzozMTozMFrOIOrUFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzozMTozMFrOIOrUFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2MDYyOQ==", "bodyText": "Could we use PeerRowsWindowFrame in here?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/946#discussion_r552260629", "createdAt": "2021-01-05T23:31:30Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/window/ranking/DenseRankFunction.java", "diffHunk": "@@ -30,7 +30,7 @@ public DenseRankFunction() {\n   }\n \n   @Override\n-  protected int rank(CumulativeWindowFrame frame) {\n+  protected int rank(CurrentRowWindowFrame frame) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ec79c160cf3507a3580a9d628508abb2c5a6c50"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyMjMxNTA0", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/946#pullrequestreview-562231504", "createdAt": "2021-01-06T00:14:06Z", "commit": {"oid": "1ec79c160cf3507a3580a9d628508abb2c5a6c50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "012ea5e6a79c60673db1429d72a18f052c21959e", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/012ea5e6a79c60673db1429d72a18f052c21959e", "committedDate": "2021-01-07T18:09:58Z", "message": "Merge branch 'develop' into support-aggregate-window-functions-2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59c758291adc56e9c62be3648e07b918b8741747", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/59c758291adc56e9c62be3648e07b918b8741747", "committedDate": "2021-01-07T18:10:49Z", "message": "Change README"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzNzUxNDk1", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/946#pullrequestreview-563751495", "createdAt": "2021-01-07T19:12:14Z", "commit": {"oid": "59c758291adc56e9c62be3648e07b918b8741747"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 534, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}