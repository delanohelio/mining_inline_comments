{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMTg4Nzgx", "number": 365, "title": "Return Correct Type Information for Fields ", "bodyText": "Issue #, if available:\n#316\nDescription of changes:\nType Information for fields in JDBC format used to be hard-coded in, and would return consistently regardless of the field type itself for scripted fields (e.g ABS(int_type) would always return type double)\nNow, JDBC type information returns correctly based on the field. Script fields in the ORDER BY clause are returned hard-coded, as we currently only return either STRING or NUMBER.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-02-07T01:15:00Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365", "merged": true, "mergeCommit": {"oid": "9769c30329658e60025743f6279b760e33b5c949"}, "closed": true, "closedAt": "2020-02-21T18:12:08Z", "author": {"login": "davidcui1225"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBd6ZHAH2gAyMzcyMTg4NzgxOjNiMTBlMmQwY2Y1NDBmMzQ5M2NlMzllZjNkOTExNDFhY2UzNjc1NWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGjxpcAFqTM2MjgxNzk4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3b10e2d0cf540f3493ce39ef3d91141ace36755e", "author": {"user": {"login": "davidcui1225", "name": "David Cui"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3b10e2d0cf540f3493ce39ef3d91141ace36755e", "committedDate": "2020-02-05T22:31:02Z", "message": "correcting Type Information return for JDBC format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee178aed0d25d4d9d719c80e8d41db10dcc7a5e5", "author": {"user": {"login": "davidcui1225", "name": "David Cui"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ee178aed0d25d4d9d719c80e8d41db10dcc7a5e5", "committedDate": "2020-02-05T22:58:38Z", "message": "added math Constants test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "537c42e861fa35aa6a69829c23bd77e7d4cf2ade", "author": {"user": {"login": "davidcui1225", "name": "David Cui"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/537c42e861fa35aa6a69829c23bd77e7d4cf2ade", "committedDate": "2020-02-07T01:07:29Z", "message": "fixed type assignment for multiple fields and added hard-coding for ORDER BY script fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28", "author": {"user": {"login": "davidcui1225", "name": "David Cui"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f05894ff645f149c4eb6a27d3b31ec018e78ea28", "committedDate": "2020-02-07T01:11:02Z", "message": "minor formatting corrections"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MzY5MTc5", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#pullrequestreview-355369179", "createdAt": "2020-02-07T19:00:43Z", "commit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxOTowMDo0NFrOFnHDMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxOTowMDo0NFrOFnHDMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU1NDI4OA==", "bodyText": "A reminder: the number operators do not always return DOUBLE, for example, abs(integer) should return INTEGER, and sign(...) should always return an integer type.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r376554288", "createdAt": "2020-02-07T19:00:44Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -1023,4 +1015,31 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n                 );\n         }\n     }\n+\n+    public static Schema.Type getOrderByFieldType(Field field) {\n+        String functionName = ((ScriptMethodField) field).getFunctionName().toLowerCase();\n+        if (functionName.equals(\"cast\")) {\n+            String castType = ((SQLCastExpr) field.getExpression()).getDataType().getName();\n+            return getCastFunctionReturnType(castType);\n+        }\n+\n+        if (numberOperators.contains(functionName) || mathConstants.contains(functionName)\n+                || trigFunctions.contains(functionName) || binaryOperators.contains(functionName)) {\n+            return Schema.Type.DOUBLE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MDc4MjI2", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#pullrequestreview-356078226", "createdAt": "2020-02-10T16:27:19Z", "commit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNjoyNzoxOVrOFnstYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNjoyNzoxOVrOFnstYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE3MTI5OQ==", "bodyText": "Is it possible to avoid running performAnalysis two times by build another QueryPlanner around DefaultQueryAction?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377171299", "createdAt": "2020-02-10T16:27:19Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -48,11 +51,14 @@\n     private ResultSet resultSet;\n     private ErrorMessage error;\n     private List<ColumnNode> columnNodeList;\n+    private ColumnTypeProvider scriptColumnType = new ColumnTypeProvider();\n \n     public Protocol(Client client, QueryAction queryAction, Object queryResult, String formatType) {\n         if (queryAction instanceof QueryPlanQueryAction) {\n             this.columnNodeList =\n                     ((QueryPlanRequestBuilder) (((QueryPlanQueryAction) queryAction).explain())).outputColumns();\n+        } else if (queryAction instanceof DefaultQueryAction) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MDM0NjA3", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#pullrequestreview-357034607", "createdAt": "2020-02-11T22:11:02Z", "commit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMjoxMTowMlrOFobCIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMjo0MTo1MFrOFob19A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzMDI3Mw==", "bodyText": "np: remove first space", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377930273", "createdAt": "2020-02-11T22:11:02Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/SelectResultSet.java", "diffHunk": "@@ -325,7 +328,7 @@ private String getFieldName(Field field) {\n                 if (field.getExpression() instanceof SQLCaseExpr) {\n                     return Schema.Type.TEXT;\n                 }\n-                return SQLFunctions.getScriptFunctionReturnType(field);\n+                 return SQLFunctions.getScriptFunctionReturnType(fieldIndex, field, scriptColumnType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNDEzNA==", "bodyText": "In which case fieldIndex is -1?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377934134", "createdAt": "2020-02-11T22:20:04Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -973,28 +974,19 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n      * approach will return type of result column as DOUBLE, although there is enough information to understand that\n      * it might be safely treated as INTEGER.\n      */\n-    public static Schema.Type getScriptFunctionReturnType(Field field) {\n+    public static Schema.Type getScriptFunctionReturnType(\n+            int fieldIndex, Field field, ColumnTypeProvider scriptColumnType) {\n+        Schema.Type returnType = null;\n+        if (scriptColumnType != null && fieldIndex != -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNTcxNw==", "bodyText": "The 2nd argument should be MethodField?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377935717", "createdAt": "2020-02-11T22:23:29Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/SelectResultSet.java", "diffHunk": "@@ -308,7 +311,7 @@ private String getFieldName(Field field) {\n         }\n     }\n \n-    private Schema.Type fetchMethodReturnType(Field field) {\n+    private Schema.Type fetchMethodReturnType(int fieldIndex, Field field) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNjY1NQ==", "bodyText": "2nd argument should be MethodField. Then I think you should reorganize this method like this:\nreturnType\nif (methodField is cast)\n    returnType = ...\nelse\n    returnType = ...\n\nif (returnType == null)\n    throw exception ...\n\nreturn returnType\n\nAfter this, could you add UT for this function because of its importance? Maybe 3 test cases for the if, else and throw exception in SQLFunctionsTest.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377936655", "createdAt": "2020-02-11T22:25:38Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -973,28 +974,19 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n      * approach will return type of result column as DOUBLE, although there is enough information to understand that\n      * it might be safely treated as INTEGER.\n      */\n-    public static Schema.Type getScriptFunctionReturnType(Field field) {\n+    public static Schema.Type getScriptFunctionReturnType(\n+            int fieldIndex, Field field, ColumnTypeProvider scriptColumnType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzOTQyMA==", "bodyText": "Could you add JavaDoc here to clarify that why we stick with hardcoding return type here? Basically I think it's because there are only 2 order by type TEXT and NUMBER in ES so what is returned here is essentially the category of function rather than the actual return type.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377939420", "createdAt": "2020-02-11T22:32:14Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -1023,4 +1015,31 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n                 );\n         }\n     }\n+\n+    public static Schema.Type getOrderByFieldType(Field field) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MDc5NQ==", "bodyText": "I think you're safe to remove all these verifyDataRows() and focus on what this IT want to test (the type in schema). The correctness of data rows should be covered by other IT.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377940795", "createdAt": "2020-02-11T22:35:14Z", "author": {"login": "dai-chen"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/TypeInformationIT.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.rows;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.schema;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.verifyDataRows;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.verifySchema;\n+\n+public class TypeInformationIT extends SQLIntegTestCase {\n+\n+    @Override\n+    protected void init() throws Exception {\n+        loadIndex(Index.ACCOUNT);\n+        loadIndex(Index.ONLINE);\n+    }\n+\n+    /*\n+    numberOperators\n+     */\n+    @Test\n+    public void testAbsWithIntFieldReturnsInt() {\n+        JSONObject response = executeJdbcRequest(\"SELECT ABS(age) FROM \" + TestsConstants.TEST_INDEX_ACCOUNT +\n+                \" ORDER BY age LIMIT 5\");\n+\n+        verifySchema(response, schema(\"ABS(age)\", null, \"long\"));\n+        verifyDataRows(response,\n+                rows(20),\n+                rows(20),\n+                rows(20),\n+                rows(20),\n+                rows(20));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0MzU0MA==", "bodyText": "I think I made this mistake. sin should always return double like log right? Could you help confirm and fix this as well as TAN, ATAN, ATAN2, COS and COSH in ScalarFunction type system?\nFor example, change SIN(func(T(NUMBER)).to(T)), to SIN(func(T(NUMBER)).to(DOUBLE)),.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r377943540", "createdAt": "2020-02-11T22:41:50Z", "author": {"login": "dai-chen"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/TypeInformationIT.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.rows;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.schema;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.verifyDataRows;\n+import static com.amazon.opendistroforelasticsearch.sql.util.MatcherUtils.verifySchema;\n+\n+public class TypeInformationIT extends SQLIntegTestCase {\n+\n+    @Override\n+    protected void init() throws Exception {\n+        loadIndex(Index.ACCOUNT);\n+        loadIndex(Index.ONLINE);\n+    }\n+\n+    /*\n+    numberOperators\n+     */\n+    @Test\n+    public void testAbsWithIntFieldReturnsInt() {\n+        JSONObject response = executeJdbcRequest(\"SELECT ABS(age) FROM \" + TestsConstants.TEST_INDEX_ACCOUNT +\n+                \" ORDER BY age LIMIT 5\");\n+\n+        verifySchema(response, schema(\"ABS(age)\", null, \"long\"));\n+        verifyDataRows(response,\n+                rows(20),\n+                rows(20),\n+                rows(20),\n+                rows(20),\n+                rows(20));\n+    }\n+\n+    @Test\n+    public void testCeilWithLongFieldReturnsLong() {\n+        JSONObject response = executeJdbcRequest(\"SELECT CEIL(balance) FROM \" + TestsConstants.TEST_INDEX_ACCOUNT +\n+                \" ORDER BY balance LIMIT 5\");\n+\n+        verifySchema(response, schema(\"CEIL(balance)\", null, \"long\"));\n+        verifyDataRows(response,\n+                rows(1011),\n+                rows(1031),\n+                rows(1110),\n+                rows(1133),\n+                rows(1172));\n+    }\n+\n+    /*\n+    mathConstants\n+     */\n+    @Test\n+    public void testPiReturnsDouble() {\n+        JSONObject response = executeJdbcRequest(\"SELECT PI() FROM \" + TestsConstants.TEST_INDEX_ACCOUNT\n+                + \" LIMIT 1\");\n+\n+        verifySchema(response, schema(\"PI()\", null, \"double\"));\n+        verifyDataRows(response,\n+                rows(3.141592653589793));\n+    }\n+\n+    /*\n+    stringOperators\n+     */\n+    @Test\n+    public void testUpperWithStringFieldReturnsString() {\n+        JSONObject response = executeJdbcRequest(\"SELECT UPPER(firstname) AS firstname_alias FROM \" +\n+                TestsConstants.TEST_INDEX_ACCOUNT + \" ORDER BY firstname_alias LIMIT 2\");\n+\n+        verifySchema(response, schema(\"firstname_alias\", null, \"text\"));\n+        verifyDataRows(response,\n+                rows(\"ABBOTT\"),\n+                rows(\"ABIGAIL\"));\n+    }\n+\n+    @Test\n+    public void testLowerWithTextFieldReturnsText() {\n+        JSONObject response = executeJdbcRequest(\"SELECT LOWER(firstname) FROM \" +\n+                TestsConstants.TEST_INDEX_ACCOUNT + \" ORDER BY firstname LIMIT 2\");\n+\n+        verifySchema(response, schema(\"LOWER(firstname)\", null, \"text\"));\n+        verifyDataRows(response,\n+                rows(\"abbott\"),\n+                rows(\"abigail\"));\n+    }\n+\n+    /*\n+    stringFunctions\n+     */\n+    @Test\n+    public void testLengthWithTextFieldReturnsInt() {\n+        JSONObject response = executeJdbcRequest(\"SELECT length(firstname) FROM \" +\n+                TestsConstants.TEST_INDEX_ACCOUNT + \" ORDER BY firstname LIMIT 2\");\n+\n+        verifySchema(response, schema(\"length(firstname)\", null, \"integer\"));\n+        verifyDataRows(response,\n+                rows(6),\n+                rows(7));\n+    }\n+\n+    /*\n+    trigFunctions\n+     */\n+    @Test\n+    public void testSinWithLongFieldReturnsLong() {\n+        JSONObject response = executeJdbcRequest(\"SELECT sin(balance) FROM \" +\n+                TestsConstants.TEST_INDEX_ACCOUNT + \" ORDER BY firstname LIMIT 2\");\n+\n+        verifySchema(response, schema(\"sin(balance)\", null, \"long\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f05894ff645f149c4eb6a27d3b31ec018e78ea28"}, "originalPosition": 126}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63", "author": {"user": {"login": "davidcui1225", "name": "David Cui"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63", "committedDate": "2020-02-18T19:14:53Z", "message": "eliminated second performAnalysis() call, refactored ITs and added UTs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMjkwMTcz", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#pullrequestreview-361290173", "createdAt": "2020-02-19T17:29:39Z", "commit": {"oid": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNzoyOTozOVrOFrwlzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNzo0MzoyOVrOFrxEmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQyOTE5OA==", "bodyText": "why change to public?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381429198", "createdAt": "2020-02-19T17:29:39Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/RestSqlAction.java", "diffHunk": "@@ -209,7 +210,7 @@ private boolean isSQLFeatureEnabled() {\n         return allowExplicitIndex && isSqlEnabled;\n     }\n \n-    private static ColumnTypeProvider performAnalysis(String sql) {\n+    public static ColumnTypeProvider performAnalysis(String sql) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzMDc1MA==", "bodyText": "why named scriptColumnType? In my understanding, it not limit to script, right?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381430750", "createdAt": "2020-02-19T17:32:28Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/SelectResultSet.java", "diffHunk": "@@ -65,17 +66,19 @@\n     private String indexName;\n     private String typeName;\n     private List<Schema.Column> columns = new ArrayList<>();\n+    private ColumnTypeProvider scriptColumnType;\n \n     private List<String> head;\n     private long size;\n     private long totalHits;\n     private List<DataRows.Row> rows;\n \n-    public SelectResultSet(Client client, Query query, Object queryResult) {\n+    public SelectResultSet(Client client, Query query, Object queryResult, ColumnTypeProvider scriptColumnType) {\n         this.client = client;\n         this.query = query;\n         this.queryResult = queryResult;\n         this.selectAll = false;\n+        this.scriptColumnType = scriptColumnType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzMjI2Mg==", "bodyText": "remove the empty line", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381432262", "createdAt": "2020-02-19T17:35:03Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/SelectResultSet.java", "diffHunk": "@@ -374,12 +377,14 @@ private String getFieldName(Field field) {\n              * name instead.\n              */\n             if (fieldMap.get(fieldName) instanceof MethodField) {\n-                Field methodField = fieldMap.get(fieldName);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzNTM5MQ==", "bodyText": "Is it possible to handle the unsupported case in SemanticAnalyzer?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381435391", "createdAt": "2020-02-19T17:40:43Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -973,34 +974,27 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n      * approach will return type of result column as DOUBLE, although there is enough information to understand that\n      * it might be safely treated as INTEGER.\n      */\n-    public static Schema.Type getScriptFunctionReturnType(Field field) {\n+    public static Schema.Type getScriptFunctionReturnType(\n+            int fieldIndex, MethodField field, ColumnTypeProvider scriptColumnType) {\n+        Schema.Type returnType;\n         String functionName = ((ScriptMethodField) field).getFunctionName().toLowerCase();\n+        if (!numberOperators.contains(functionName) && !mathConstants.contains(functionName)\n+                && !trigFunctions.contains(functionName) && !stringOperators.contains(functionName)\n+                && !stringFunctions.contains(functionName) && !binaryOperators.contains(functionName)\n+                && !dateFunctions.contains(functionName) && !conditionalFunctions.contains(functionName)\n+                && !utilityFunctions.contains(functionName)) {\n+            throw new UnsupportedOperationException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQzNzA4Mg==", "bodyText": "The input argument could be reduced as (MethodFiled field, Schema.Type resolvedType)", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r381437082", "createdAt": "2020-02-19T17:43:29Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -973,34 +974,27 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n      * approach will return type of result column as DOUBLE, although there is enough information to understand that\n      * it might be safely treated as INTEGER.\n      */\n-    public static Schema.Type getScriptFunctionReturnType(Field field) {\n+    public static Schema.Type getScriptFunctionReturnType(\n+            int fieldIndex, MethodField field, ColumnTypeProvider scriptColumnType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTc1ODk3", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#pullrequestreview-361575897", "createdAt": "2020-02-20T01:18:05Z", "commit": {"oid": "65b58e3396470b9c7ee8c35a73f2a25f5ab6bf63"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6afd24ee177cf4d44162bdea8c1622627a555907", "author": {"user": {"login": "davidcui1225", "name": "David Cui"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6afd24ee177cf4d44162bdea8c1622627a555907", "committedDate": "2020-02-20T22:52:09Z", "message": "addressed comments- refactored columnType variable and removed unsupported case check in SQLFunctions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "016795ece0b3c434d9cce0d251e054e03216f5ae", "author": {"user": {"login": "davidcui1225", "name": "David Cui"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/016795ece0b3c434d9cce0d251e054e03216f5ae", "committedDate": "2020-02-20T23:03:28Z", "message": "removed unused variables in SQLFunctionsTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzk1ODUy", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#pullrequestreview-362395852", "createdAt": "2020-02-21T04:40:27Z", "commit": {"oid": "016795ece0b3c434d9cce0d251e054e03216f5ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo0MDoyN1rOFsrfJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo0MDoyN1rOFsrfJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5NDE0OQ==", "bodyText": "could it be simplified as return resolvedType", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#discussion_r382394149", "createdAt": "2020-02-21T04:40:27Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -974,25 +973,14 @@ public String getCastScriptStatement(String name, String castType, List<KVValue>\n      * approach will return type of result column as DOUBLE, although there is enough information to understand that\n      * it might be safely treated as INTEGER.\n      */\n-    public static Schema.Type getScriptFunctionReturnType(\n-            int fieldIndex, MethodField field, ColumnTypeProvider scriptColumnType) {\n+    public static Schema.Type getScriptFunctionReturnType(MethodField field, Schema.Type resolvedType) {\n         Schema.Type returnType;\n         String functionName = ((ScriptMethodField) field).getFunctionName().toLowerCase();\n-        if (!numberOperators.contains(functionName) && !mathConstants.contains(functionName)\n-                && !trigFunctions.contains(functionName) && !stringOperators.contains(functionName)\n-                && !stringFunctions.contains(functionName) && !binaryOperators.contains(functionName)\n-                && !dateFunctions.contains(functionName) && !conditionalFunctions.contains(functionName)\n-                && !utilityFunctions.contains(functionName)) {\n-            throw new UnsupportedOperationException(\n-                    String.format(\n-                            \"The following method is not supported in Schema: %s\",\n-                            functionName));\n-        }\n         if (functionName.equals(\"cast\")) {\n             String castType = ((SQLCastExpr) field.getExpression()).getDataType().getName();\n             return getCastFunctionReturnType(castType);\n         } else {\n-            returnType = scriptColumnType.get(fieldIndex);\n+            returnType = resolvedType;\n         }\n         return returnType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "016795ece0b3c434d9cce0d251e054e03216f5ae"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32f1fa5054112320146882bc29cc03fa05c193db", "author": {"user": {"login": "davidcui1225", "name": "David Cui"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/32f1fa5054112320146882bc29cc03fa05c193db", "committedDate": "2020-02-21T05:06:18Z", "message": "addressed further comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODE3OTgx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/365#pullrequestreview-362817981", "createdAt": "2020-02-21T18:10:32Z", "commit": {"oid": "32f1fa5054112320146882bc29cc03fa05c193db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 746, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}