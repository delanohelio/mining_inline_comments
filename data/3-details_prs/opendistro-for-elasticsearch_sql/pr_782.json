{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0NDYzNjIy", "number": 782, "title": "Support ORDER BY in new SQL engine", "bodyText": "Issue #, if available:\n\n#123: Order by aggregate function even if it's not in SELECT\n#674: Order by inner field of group by\n#277: Order by aggregate function\n#250: similar as above\n#423: similar as above\n#402: similar as above\n\nDescription of changes:\n\nRelax QualifiedName to UnresolvedExpression in Field so we can support order by any expression for SQL.\nAdd AstSortBuilder that shares replaceIfAliasOrOrdinal() logic with AstAggregationBuilder.\nImprove test framework to support comparison test for ORDER BY queries.\n\nWith these changes, we can support ORDER BY field, scalar function, aggregate function, alias and ordinal. Please see the documentation below for more details.\nDocumentation: https://github.com/dai-chen/sql/blob/support-order-by-in-new-sql-engine/docs/user/dql/basics.rst#example-3-ordering-by-aggregate-functions\nTesting:\n\nAdd new UT and comparison test for basic cases\nAdd comparison tests for issues above for regression test\nBypass legacy OrderIT and dateFunctionNameCaseInsensitiveTest(): the former tests explain output and the latter tests DATE_FORMAT which has different signature in legacy and new engine.\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-10-16T00:05:06Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/782", "merged": true, "mergeCommit": {"oid": "1c492172d56303c40d635066f827e0269e3b6ccc"}, "closed": true, "closedAt": "2020-10-20T19:52:55Z", "author": {"login": "dai-chen"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSlpV7gH2gAyNTA0NDYzNjIyOmM4ZWZkZmZiNmFkMmVlNTRkZmE1ZDc4NjlkYTVhZjYxZDc3MGQ4MzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUdil0gH2gAyNTA0NDYzNjIyOjIyODY5MzNlNmQxMWI2ZTIzNmM5NWI1NGMwMzhlNDdlZGU0MjU2YmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c8efdffb6ad2ee54dfa5d7869da5af61d770d834", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c8efdffb6ad2ee54dfa5d7869da5af61d770d834", "committedDate": "2020-10-14T23:19:31Z", "message": "Change grammar and ast builder to support order by"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "236d3a7b861e9e1d69706d942ea827bd3f2dbfbb", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/236d3a7b861e9e1d69706d942ea827bd3f2dbfbb", "committedDate": "2020-10-14T23:32:56Z", "message": "Add UT for order by function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5370709933263d3a660ca7a69c3dc460671b86d2", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5370709933263d3a660ca7a69c3dc460671b86d2", "committedDate": "2020-10-14T23:57:52Z", "message": "Pass jacoco for sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67eacf2b9b5ad92bb36e0dd99e99ea46587a57a5", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/67eacf2b9b5ad92bb36e0dd99e99ea46587a57a5", "committedDate": "2020-10-15T00:44:11Z", "message": "Fix order by function issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18544fd63f90dc086452c0f8622c452b45a5ae61", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/18544fd63f90dc086452c0f8622c452b45a5ae61", "committedDate": "2020-10-15T17:29:09Z", "message": "Improve test framework to support order by comparison"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4220e7d429e4b93241d1d9c2ead0696756b4448", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c4220e7d429e4b93241d1d9c2ead0696756b4448", "committedDate": "2020-10-15T17:55:38Z", "message": "Add more comparison tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66fe7240a3bf452e401b8bd972a5833455482775", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/66fe7240a3bf452e401b8bd972a5833455482775", "committedDate": "2020-10-15T18:41:16Z", "message": "Add test for issue #123"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd1674586b7736d971169a9e35304b06916b70d2", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/dd1674586b7736d971169a9e35304b06916b70d2", "committedDate": "2020-10-15T18:49:26Z", "message": "Add test for issue #674"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "951f68829f472b0c11a008b38ee157c5d278b7d9", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/951f68829f472b0c11a008b38ee157c5d278b7d9", "committedDate": "2020-10-15T20:18:03Z", "message": "Avoid sort again when explain diff for order by query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c48bcc7f655f081a01cbcdbb5f4ebb7a2ec44be", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8c48bcc7f655f081a01cbcdbb5f4ebb7a2ec44be", "committedDate": "2020-10-15T23:32:19Z", "message": "Replace aggregator in order by clause"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d120ceed4a195d43f2c5e2e9b456e005090fa5c", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5d120ceed4a195d43f2c5e2e9b456e005090fa5c", "committedDate": "2020-10-15T23:53:05Z", "message": "Skip date_format test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5987e257282e0e4e4d22fe1a80957d55887848b2", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5987e257282e0e4e4d22fe1a80957d55887848b2", "committedDate": "2020-10-16T00:19:38Z", "message": "Add doctest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c84a54a7d621792cdd538d6e039b6b60cfe8c1c", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3c84a54a7d621792cdd538d6e039b6b60cfe8c1c", "committedDate": "2020-10-16T00:28:27Z", "message": "Fix doctest format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyODkyMjc0", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/782#pullrequestreview-512892274", "createdAt": "2020-10-20T15:57:51Z", "commit": {"oid": "3c84a54a7d621792cdd538d6e039b6b60cfe8c1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNTo1Nzo1MVrOHlFPRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNTo1Nzo1MVrOHlFPRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0NTE4OA==", "bodyText": "It is also could be sort by, right?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/782#discussion_r508645188", "createdAt": "2020-10-20T15:57:51Z", "author": {"login": "penghuo"}, "path": "sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/context/QuerySpecification.java", "diffHunk": "@@ -86,6 +99,52 @@ public void collect(QuerySpecificationContext query, String queryString) {\n     query.accept(new QuerySpecificationCollector(queryString));\n   }\n \n+  /**\n+   * Replace unresolved expression if it's an alias or ordinal that represents\n+   * an actual expression in SELECT list.\n+   * @param expr item to be replaced\n+   * @return select item that the given expr represents\n+   */\n+  public UnresolvedExpression replaceIfAliasOrOrdinal(UnresolvedExpression expr) {\n+    if (isIntegerLiteral(expr)) {\n+      return getSelectItemByOrdinal(expr);\n+    } else if (isSelectAlias(expr)) {\n+      return getSelectItemByAlias(expr);\n+    } else {\n+      return expr;\n+    }\n+  }\n+\n+  private boolean isIntegerLiteral(UnresolvedExpression expr) {\n+    if (!(expr instanceof Literal)) {\n+      return false;\n+    }\n+\n+    if (((Literal) expr).getType() != DataType.INTEGER) {\n+      throw new SemanticCheckException(StringUtils.format(\n+          \"Non-integer constant [%s] found in GROUP BY clause\", expr));\n+    }\n+    return true;\n+  }\n+\n+  private UnresolvedExpression getSelectItemByOrdinal(UnresolvedExpression expr) {\n+    int ordinal = (Integer) ((Literal) expr).getValue();\n+    if (ordinal <= 0 || ordinal > selectItems.size()) {\n+      throw new SemanticCheckException(StringUtils.format(\n+          \"Group by ordinal [%d] is out of bound of select item list\", ordinal));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c84a54a7d621792cdd538d6e039b6b60cfe8c1c"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyOTAyMzk4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/782#pullrequestreview-512902398", "createdAt": "2020-10-20T16:08:09Z", "commit": {"oid": "3c84a54a7d621792cdd538d6e039b6b60cfe8c1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDI4NzAy", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/782#pullrequestreview-513028702", "createdAt": "2020-10-20T18:39:56Z", "commit": {"oid": "3c84a54a7d621792cdd538d6e039b6b60cfe8c1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c37ae4e3bab69e2ee377922f2b426e94d3a7665", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1c37ae4e3bab69e2ee377922f2b426e94d3a7665", "committedDate": "2020-10-20T19:00:39Z", "message": "Address PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2286933e6d11b6e236c95b54c038e47ede4256be", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2286933e6d11b6e236c95b54c038e47ede4256be", "committedDate": "2020-10-20T19:00:45Z", "message": "Merge branch 'develop' into support-order-by-in-new-sql-engine"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 547, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}