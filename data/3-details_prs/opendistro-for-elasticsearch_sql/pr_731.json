{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxNzk2MzY4", "number": 731, "title": "Support Head Command In PPL", "bodyText": "Issue #684\nDescription of changes:\n\ncore: added support for head operation in a logical & physical layer\nppl: added AstBuilder logic for head command\nupdated documentation with examples for using head command\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-09-08T06:05:05Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731", "merged": true, "mergeCommit": {"oid": "e7171de846baf299225cf3c3825532821e98dac5"}, "closed": true, "closedAt": "2020-09-16T15:54:11Z", "author": {"login": "rupal-bq"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAjPxCAH2gAyNDgxNzk2MzY4OjcwOTI1MWRmNDI1MWQ4ZTQ4ZGQzNzYxYWQ5OWQ5NThjYWExOTQ1MWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJefWggFqTQ4OTc3MDA5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "709251df4251d8e48dd3761ad99d958caa19451e", "author": {"user": {"login": "jordanw-bq", "name": "Jordan Wilson"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/709251df4251d8e48dd3761ad99d958caa19451e", "committedDate": "2020-08-19T22:21:08Z", "message": "initial command impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d632f308ecd53384f1030d2c11cc80bc4a4bdb2e", "author": {"user": {"login": "jordanw-bq", "name": "Jordan Wilson"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d632f308ecd53384f1030d2c11cc80bc4a4bdb2e", "committedDate": "2020-08-20T22:15:57Z", "message": "finish initial head impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3928a5b55d867d1ba44a0fe38b4aefe15ad89763", "author": {"user": {"login": "jordanw-bq", "name": "Jordan Wilson"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3928a5b55d867d1ba44a0fe38b4aefe15ad89763", "committedDate": "2020-08-26T15:32:29Z", "message": "while expression support & UT/ITs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b61b1b58b5b82d64e6e129d950eede3e41cc9ffe", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b61b1b58b5b82d64e6e129d950eede3e41cc9ffe", "committedDate": "2020-08-31T21:33:07Z", "message": "add changes from implement-head-ppl-command"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb19be1940d236bc34ff6e49283c9b831e06a5e7", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/cb19be1940d236bc34ff6e49283c9b831e06a5e7", "committedDate": "2020-08-31T23:16:11Z", "message": "fix checkstyle errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cea2945a4e69212a8ef0d58c8f5f62240b4bbdba", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/cea2945a4e69212a8ef0d58c8f5f62240b4bbdba", "committedDate": "2020-09-01T17:44:35Z", "message": "checkstyle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e9b3be657184ad03a4c26fc44c534f485a6ee41", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1e9b3be657184ad03a4c26fc44c534f485a6ee41", "committedDate": "2020-09-02T19:22:18Z", "message": "- fix null pointer issue for head without while expr\n- update tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "163b0580b576543ebb6577da044a73180b1d1857", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/163b0580b576543ebb6577da044a73180b1d1857", "committedDate": "2020-09-08T01:26:35Z", "message": "fix build errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a8b3f4671ed8f4ec38978039c33a741d1d07579", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2a8b3f4671ed8f4ec38978039c33a741d1d07579", "committedDate": "2020-09-08T02:17:14Z", "message": "fix comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce8c684e372e2be1def56d6178f00a3ffad1d377", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ce8c684e372e2be1def56d6178f00a3ffad1d377", "committedDate": "2020-09-08T05:55:16Z", "message": "update docs & integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c4639f432ec8a33d867ee2f6d18046f24e2dcb5", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2c4639f432ec8a33d867ee2f6d18046f24e2dcb5", "committedDate": "2020-09-08T19:50:58Z", "message": "merge develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b71d253c9997dd9c847d122e9fd2ecf71406c3e", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2b71d253c9997dd9c847d122e9fd2ecf71406c3e", "committedDate": "2020-09-10T23:34:08Z", "message": "change default value for keeplast to true"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e1b9bb1fcca18b4dde808ad837a0cccb65367f9", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1e1b9bb1fcca18b4dde808ad837a0cccb65367f9", "committedDate": "2020-09-11T17:42:35Z", "message": "nit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "480fdf8c5dc86e60007eb4e4a49d7ee93eb9d2a8", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/480fdf8c5dc86e60007eb4e4a49d7ee93eb9d2a8", "committedDate": "2020-09-11T18:26:02Z", "message": "Merge branch 'develop' of https://github.com/rupal-bq/sql into ppl/head\n\n# Conflicts:\n#\tcore/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/logical/LogicalPlanDSL.java\n#\tcore/src/test/java/com/amazon/opendistroforelasticsearch/sql/planner/DefaultImplementorTest.java\n#\tcore/src/test/java/com/amazon/opendistroforelasticsearch/sql/planner/logical/LogicalPlanNodeVisitorTest.java\n#\tcore/src/test/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/PhysicalPlanNodeVisitorTest.java\n#\telasticsearch/src/test/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/executor/ElasticsearchExecutionProtectorTest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTMxMjk0", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#pullrequestreview-487131294", "createdAt": "2020-09-11T21:20:48Z", "commit": {"oid": "480fdf8c5dc86e60007eb4e4a49d7ee93eb9d2a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMToyMDo0OVrOHQuMiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMToyMDo0OVrOHQuMiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI5NjEzOQ==", "bodyText": "Nit: Extra line", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r487296139", "createdAt": "2020-09-11T21:20:49Z", "author": {"login": "lyndonb-bq"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/ast/dsl/AstDSL.java", "diffHunk": "@@ -308,4 +332,5 @@ public static RareTopN rareTopN(UnresolvedPlan input, CommandType commandType,\n     return new RareTopN(input, commandType, noOfResults, Arrays.asList(fields), groupList)\n         .attach(input);\n   }\n+  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "480fdf8c5dc86e60007eb4e4a49d7ee93eb9d2a8"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTQwODUy", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#pullrequestreview-487140852", "createdAt": "2020-09-11T21:43:27Z", "commit": {"oid": "480fdf8c5dc86e60007eb4e4a49d7ee93eb9d2a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMTo0MzoyN1rOHQurfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMTo0MzoyN1rOHQurfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMwNDA2Mg==", "bodyText": "This if statement logically equivalent to:\nif (isNull || isMissing || !booleanValue)\nWould suggest simplifying it to that", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r487304062", "createdAt": "2020-09-11T21:43:27Z", "author": {"login": "lyndonb-bq"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/HeadOperator.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.planner.physical;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprBooleanValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.LiteralExpression;\n+import java.util.Collections;\n+import java.util.List;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.NonNull;\n+\n+@Getter\n+@EqualsAndHashCode\n+public class HeadOperator extends PhysicalPlan {\n+\n+  @Getter\n+  private final PhysicalPlan input;\n+  @Getter\n+  private final Boolean keepLast;\n+  @Getter\n+  private final Expression whileExpr;\n+  @Getter\n+  private final Integer number;\n+\n+  private static final Integer DEFAULT_LIMIT = 10;\n+  private static final Boolean IGNORE_LAST = false;\n+\n+  @EqualsAndHashCode.Exclude\n+  private int recordCount = 0;\n+  @EqualsAndHashCode.Exclude\n+  private boolean foundFirstFalse = false;\n+  @EqualsAndHashCode.Exclude\n+  private ExprValue next;\n+\n+  @NonNull\n+  public HeadOperator(PhysicalPlan input) {\n+    this(input, IGNORE_LAST, new LiteralExpression(ExprBooleanValue.of(true)), DEFAULT_LIMIT);\n+  }\n+\n+  /**\n+   * HeadOperator Constructor.\n+   *\n+   * @param input     Input {@link PhysicalPlan}\n+   * @param keepLast  Controls whether the last result in the result set is retained. The last\n+   *                  result returned is the result that caused the whileExpr to evaluate\n+   *                  to false or NULL.\n+   * @param whileExpr The search returns results until this expression evaluates to false\n+   * @param number    Number of specified results\n+   */\n+  @NonNull\n+  public HeadOperator(PhysicalPlan input, Boolean keepLast, Expression whileExpr, Integer number) {\n+    this.input = input;\n+    this.keepLast = keepLast;\n+    this.whileExpr = whileExpr;\n+    this.number = number;\n+  }\n+\n+  @Override\n+  public <R, C> R accept(PhysicalPlanNodeVisitor<R, C> visitor, C context) {\n+    return visitor.visitHead(this, context);\n+  }\n+\n+  @Override\n+  public List<PhysicalPlan> getChild() {\n+    return Collections.singletonList(input);\n+  }\n+\n+  @Override\n+  public boolean hasNext() {\n+    while (input.hasNext() && !foundFirstFalse) {\n+      ExprValue inputVal = input.next();\n+      ExprValue exprValue = whileExpr.valueOf(inputVal.bindingTuples());\n+\n+      if (recordCount < number) {\n+        if (!(!(exprValue.isNull() || exprValue.isMissing()) && (exprValue.booleanValue()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "480fdf8c5dc86e60007eb4e4a49d7ee93eb9d2a8"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bf61cba4dc5a8e5e704ba649328d86536b29076", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7bf61cba4dc5a8e5e704ba649328d86536b29076", "committedDate": "2020-09-11T23:45:36Z", "message": "Merge branch 'develop' of https://github.com/rupal-bq/sql into ppl/head"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4", "committedDate": "2020-09-12T00:36:15Z", "message": "address PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MDgxNTU4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#pullrequestreview-488081558", "createdAt": "2020-09-14T19:35:27Z", "commit": {"oid": "6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MDgxNzM4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#pullrequestreview-488081738", "createdAt": "2020-09-14T19:35:44Z", "commit": {"oid": "6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjMxMzA1", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#pullrequestreview-488231305", "createdAt": "2020-09-14T23:55:26Z", "commit": {"oid": "6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMzo1NToyN1rOHRrigw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMzo1NToyN1rOHRrigw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMTE4Nw==", "bodyText": "2019 -> 2020", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r488301187", "createdAt": "2020-09-14T23:55:27Z", "author": {"login": "penghuo"}, "path": "core/src/test/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/RareTopNOperatorTest.java", "diffHunk": "@@ -1,3 +1,18 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjMyNTE2", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#pullrequestreview-488232516", "createdAt": "2020-09-14T23:58:57Z", "commit": {"oid": "6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMzo1ODo1N1rOHRrmtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMzo1ODo1N1rOHRrmtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwMjI2MQ==", "bodyText": "Doc", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#discussion_r488302261", "createdAt": "2020-09-14T23:58:57Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/HeadOperator.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.planner.physical;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprBooleanValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.LiteralExpression;\n+import java.util.Collections;\n+import java.util.List;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.NonNull;\n+\n+@Getter", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c65bd3cd58bf146a29c706bfc1dbe1a3117c7c4"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "857b9ddcd6d26a471efbc9a19971f7603d964175", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/857b9ddcd6d26a471efbc9a19971f7603d964175", "committedDate": "2020-09-15T01:13:10Z", "message": "address PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MTM3NDYz", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#pullrequestreview-489137463", "createdAt": "2020-09-15T21:59:24Z", "commit": {"oid": "857b9ddcd6d26a471efbc9a19971f7603d964175"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NzcwMDkz", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/731#pullrequestreview-489770093", "createdAt": "2020-09-16T15:53:57Z", "commit": {"oid": "857b9ddcd6d26a471efbc9a19971f7603d964175"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 634, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}