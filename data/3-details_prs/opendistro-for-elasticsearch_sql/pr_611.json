{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1OTc0MDM4", "number": 611, "title": "ODBC: Report error from Excel when executing an invalid query", "bodyText": "Issue #, if available: #601\nDescription of changes:\n\nsave error type and details on connection errors\nstart checking error type when reporting error (first: query syntax)\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-07-23T22:01:42Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611", "merged": true, "mergeCommit": {"oid": "3368d6015bf36de6cf1623465e91a4a87326cf5a"}, "closed": true, "closedAt": "2020-07-25T01:19:44Z", "author": {"login": "jordanw-bq"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc32wdJgH2gAyNDU1OTc0MDM4OjFjNjA1ZGE5MmQzODJmOWVlZDdkMDFhZWM0OTVlMzM2NDhkOWVmZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4OM8ZgFqTQ1NTI0ODg4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1c605da92d382f9eed7d01aec495e33648d9efdd", "author": {"user": {"login": "jordanw-bq", "name": "Jordan Wilson"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1c605da92d382f9eed7d01aec495e33648d9efdd", "committedDate": "2020-07-23T21:59:43Z", "message": "add support for ODBC 2.x SQLError function\n\n- save error type and details on connection errors\n- start checking error type when reporting error (first: query syntax)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTMxNDY5", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#pullrequestreview-454531469", "createdAt": "2020-07-23T22:13:52Z", "commit": {"oid": "1c605da92d382f9eed7d01aec495e33648d9efdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMjoxMzo1MlrOG2dYWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMjoxMzo1MlrOG2dYWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1NzY1OQ==", "bodyText": "You should check this Statement, connection, then environment rather than the other way around. The most recently constructed handle gets priority.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#discussion_r459757659", "createdAt": "2020-07-23T22:13:52Z", "author": {"login": "jduo"}, "path": "sql-odbc/src/odfesqlodbc/odbcapi.c", "diffHunk": "@@ -1367,4 +1367,33 @@ SQLRETURN SQL_API SQLColAttributes(SQLHSTMT StatementHandle,\n     LEAVE_STMT_CS(stmt);\n     return ret;\n }\n+\n+/*\tSQLError -> SQLDiagRec */\n+RETCODE SQL_API SQLError(SQLHENV EnvironmentHandle, SQLHDBC ConnectionHandle,\n+                         SQLHSTMT StatementHandle, SQLCHAR *Sqlstate,\n+                         SQLINTEGER *NativeError, SQLCHAR *MessageText,\n+                         SQLSMALLINT BufferLength, SQLSMALLINT *TextLength) {\n+    RETCODE ret;\n+    SQLSMALLINT RecNumber = 1;\n+\n+    MYLOG(ES_TRACE, \"entering\\n\");\n+\n+    if (EnvironmentHandle) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c605da92d382f9eed7d01aec495e33648d9efdd"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTMzMjUx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#pullrequestreview-454533251", "createdAt": "2020-07-23T22:17:49Z", "commit": {"oid": "1c605da92d382f9eed7d01aec495e33648d9efdd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMjoxNzo0OVrOG2deLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMjoxNzo0OVrOG2deLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1OTE0OQ==", "bodyText": "SQLCHAR inputs aren't guaranteed to be UTF-8. On Windows it depends on the OS codepage for example (usually codepage CP1252), though on Windows the DM does the conversion for you. This should likely be a separate issue to fix.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#discussion_r459759149", "createdAt": "2020-07-23T22:17:49Z", "author": {"login": "jduo"}, "path": "sql-odbc/src/odfesqlodbc/odbcapiw.c", "diffHunk": "@@ -1005,3 +1006,63 @@ RETCODE SQL_API SQLSetConnectOptionW(HDBC ConnectionHandle, SQLUSMALLINT Option,\n     LEAVE_CONN_CS(conn);\n     return ret;\n }\n+\n+RETCODE SQL_API SQLErrorW(SQLHENV EnvironmentHandle, SQLHDBC ConnectionHandle,\n+                          SQLHSTMT StatementHandle, SQLWCHAR *Sqlstate,\n+                          SQLINTEGER *NativeError, SQLWCHAR *MessageText,\n+                          SQLSMALLINT BufferLength, SQLSMALLINT *TextLength) {\n+    RETCODE ret;\n+    SQLSMALLINT buflen;\n+    SQLSMALLINT tlen = 0;\n+    SQLSMALLINT RecNumber = 1;\n+    char qstr_ansi[8], *mtxt = NULL;\n+\n+    MYLOG(ES_TRACE, \"entering\\n\");\n+    buflen = 0;\n+    if (MessageText && BufferLength > 0) {\n+        buflen = BufferLength;\n+        mtxt = malloc(buflen);\n+    }\n+\n+    if (EnvironmentHandle) {\n+        ret = ESAPI_EnvError(EnvironmentHandle, RecNumber, (SQLCHAR *)qstr_ansi,\n+                             NativeError, (SQLCHAR *)mtxt, buflen, &tlen, 0);\n+    } else if (ConnectionHandle) {\n+        ret = ESAPI_ConnectError(ConnectionHandle, RecNumber,\n+                                 (SQLCHAR *)qstr_ansi, NativeError,\n+                                 (SQLCHAR *)mtxt, buflen, &tlen, 0);\n+    } else if (StatementHandle) {\n+        ret = ESAPI_StmtError(StatementHandle, RecNumber, (SQLCHAR *)qstr_ansi,\n+                              NativeError, (SQLCHAR *)mtxt, buflen, &tlen, 0);\n+    } else {\n+        ret = SQL_ERROR;\n+    }\n+\n+    if (SQL_SUCCEEDED(ret)) {\n+        if (Sqlstate)\n+            utf8_to_ucs2(qstr_ansi, -1, Sqlstate, 6);\n+        if (mtxt && tlen <= BufferLength) {\n+            SQLULEN ulen = utf8_to_ucs2_lf(mtxt, tlen, FALSE, MessageText,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c605da92d382f9eed7d01aec495e33648d9efdd"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20cc23e1555073d377c61f900b3468dcb1786d45", "author": {"user": {"login": "jordanw-bq", "name": "Jordan Wilson"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/20cc23e1555073d377c61f900b3468dcb1786d45", "committedDate": "2020-07-23T23:28:58Z", "message": "qualify error enum names to avoid conflict with Windows libraries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MDczOTU3", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#pullrequestreview-455073957", "createdAt": "2020-07-24T17:45:46Z", "commit": {"oid": "20cc23e1555073d377c61f900b3468dcb1786d45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0b1eda7353061a863e4ceab3c83d301d021f127", "author": {"user": {"login": "jordanw-bq", "name": "Jordan Wilson"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d0b1eda7353061a863e4ceab3c83d301d021f127", "committedDate": "2020-07-24T21:08:33Z", "message": "reversing order of SQLError handle checks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjA0MTEx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#pullrequestreview-455204111", "createdAt": "2020-07-24T21:51:09Z", "commit": {"oid": "d0b1eda7353061a863e4ceab3c83d301d021f127"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjA0MjMw", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#pullrequestreview-455204230", "createdAt": "2020-07-24T21:51:27Z", "commit": {"oid": "d0b1eda7353061a863e4ceab3c83d301d021f127"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjQwNDIz", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#pullrequestreview-455240423", "createdAt": "2020-07-25T00:10:05Z", "commit": {"oid": "d0b1eda7353061a863e4ceab3c83d301d021f127"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjQ4ODgx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/611#pullrequestreview-455248881", "createdAt": "2020-07-25T01:18:39Z", "commit": {"oid": "d0b1eda7353061a863e4ceab3c83d301d021f127"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 599, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}