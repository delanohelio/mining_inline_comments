{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MTM2Mjk2", "number": 851, "title": "Support LIMIT, OFFSET in new engine", "bodyText": "Issue #, if available:\nDescription of changes:\n\nAdded limit and offset in grammar\nAdded logical limit and limit operator in planning\nPushed down limit to dsl\nAdded unit tests and comparison tests\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-11-24T02:52:35Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851", "merged": true, "mergeCommit": {"oid": "3468bcf1a5ce9393823a6549960d0e7c462d1714"}, "closed": true, "closedAt": "2020-12-12T02:09:06Z", "author": {"login": "chloe-zh"}, "timelineItems": {"totalCount": 48, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfgo-GAH2gAyNTI2MTM2Mjk2OjZhYjBhYTkyZDRjNTY0OWYwN2Q1NjUxNzkzMDIxMjRlOTE0NGI3MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlSZN0AH2gAyNTI2MTM2Mjk2OmM2ZmY0NGJjMmIzNjQyN2Y1NjFlYWFmYzAwOGQyZmU2ZThkZDRhYmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6ab0aa92d4c5649f07d565179302124e9144b722", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6ab0aa92d4c5649f07d565179302124e9144b722", "committedDate": "2020-11-24T02:50:36Z", "message": "support limit and offset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2581dd8efc5b96b49f132f3235cd7b7055ed7d2e", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2581dd8efc5b96b49f132f3235cd7b7055ed7d2e", "committedDate": "2020-11-24T20:11:01Z", "message": "Merge remote-tracking branch 'upstream/develop' into limit-offset\n\n# Conflicts:\n#\tcore/src/test/java/com/amazon/opendistroforelasticsearch/sql/planner/DefaultImplementorTest.java\n#\telasticsearch/src/test/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/executor/ElasticsearchExecutionProtectorTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "091619ed93df748506a789e175609d62449129be", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/091619ed93df748506a789e175609d62449129be", "committedDate": "2020-11-24T21:15:10Z", "message": "Merge remote-tracking branch 'upstream/develop' into limit-offset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18d2bb583dbfab5f247a310ed4fc990f503f0857", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/18d2bb583dbfab5f247a310ed4fc990f503f0857", "committedDate": "2020-11-24T22:13:43Z", "message": "ignored some test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d698db4e8bd1745733638042bb12b9854016cc01", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d698db4e8bd1745733638042bb12b9854016cc01", "committedDate": "2020-11-25T02:57:11Z", "message": "added merge rules"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NjI2MDEw", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-538626010", "createdAt": "2020-11-25T15:42:32Z", "commit": {"oid": "18d2bb583dbfab5f247a310ed4fc990f503f0857"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo0MjozM1rOH55MGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo0MjozM1rOH55MGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ2Nzg2Nw==", "bodyText": "The orignal definition of getTable is get Table from storage engine by name, the size paramater doesn't make sense in here.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r530467867", "createdAt": "2020-11-25T15:42:33Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/storage/StorageEngine.java", "diffHunk": "@@ -23,5 +23,5 @@\n   /**\n    * Get {@link Table} from storage engine.\n    */\n-  Table getTable(String name);\n+  Table getTable(String name, Integer size);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18d2bb583dbfab5f247a310ed4fc990f503f0857"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NjM2MTA2", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-538636106", "createdAt": "2020-11-25T15:53:06Z", "commit": {"oid": "18d2bb583dbfab5f247a310ed4fc990f503f0857"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo1MzowNlrOH55rLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo1MzowNlrOH55rLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ3NTgyMQ==", "bodyText": "Does it need to be the reduce operation which take all the rows from downstream at open stage?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r530475821", "createdAt": "2020-11-25T15:53:06Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/LimitOperator.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.planner.physical;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterators;\n+import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+\n+@RequiredArgsConstructor\n+@Getter\n+@ToString\n+@EqualsAndHashCode\n+public class LimitOperator extends PhysicalPlan {\n+  private final PhysicalPlan input;\n+  private final Integer limit;\n+  private final Integer offset;\n+  private Iterator<ExprValue> iterator;\n+\n+  @Override\n+  public void open() {\n+    super.open();\n+\n+    List<ExprValue> results = new LinkedList<>();\n+    while (input.hasNext()) {\n+      results.add(input.next());\n+    }\n+    iterator = Iterators.limit(offset(results.iterator(), offset), limit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18d2bb583dbfab5f247a310ed4fc990f503f0857"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf73d2aaf7c7d497785ac47e656748d2a2e642a5", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/bf73d2aaf7c7d497785ac47e656748d2a2e642a5", "committedDate": "2020-11-25T17:47:24Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab6e80f55487fa371c371b340dce0bcb0f93bc1b", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ab6e80f55487fa371c371b340dce0bcb0f93bc1b", "committedDate": "2020-11-25T18:10:00Z", "message": "address comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ab02e48f11357e4588fc96e18ae08d0de57ca5d", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5ab02e48f11357e4588fc96e18ae08d0de57ca5d", "committedDate": "2020-11-25T18:23:32Z", "message": "+ issue 441"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ace67a4d6021c26c64c155bd23bcdca96de7eb6", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6ace67a4d6021c26c64c155bd23bcdca96de7eb6", "committedDate": "2020-11-25T18:35:28Z", "message": "added doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6bdfa0aba6698e7e1332ba1bcc0dfb1229057f0", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f6bdfa0aba6698e7e1332ba1bcc0dfb1229057f0", "committedDate": "2020-11-25T19:14:28Z", "message": "Merge branch 'limit-optimize' into limit-offset"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NzU5MzAx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-538759301", "createdAt": "2020-11-25T18:30:55Z", "commit": {"oid": "18d2bb583dbfab5f247a310ed4fc990f503f0857"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxODozMDo1NVrOH5_jqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxODozMDo1NVrOH5_jqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3MjIwMA==", "bodyText": "Please check back once my JDBC formatter PR merged: #854. With this formatter, new engine response would be same as before which may avoid this issue.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r530572200", "createdAt": "2020-11-25T18:30:55Z", "author": {"login": "dai-chen"}, "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/legacy/PrettyFormatResponseIT.java", "diffHunk": "@@ -290,6 +290,7 @@ public void groupByMultipleFields() throws IOException {\n     assertContainsData(getDataRows(response), fields);\n   }\n \n+  @Ignore(\"Skip this test due to inconsistency in total hits\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18d2bb583dbfab5f247a310ed4fc990f503f0857"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce6bd6f5e86d41c499ecd9e95b01b163ffdd2568", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ce6bd6f5e86d41c499ecd9e95b01b163ffdd2568", "committedDate": "2020-11-25T22:36:31Z", "message": "added rule to push limit under sort"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODg3ODUx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-538887851", "createdAt": "2020-11-25T22:40:25Z", "commit": {"oid": "6ace67a4d6021c26c64c155bd23bcdca96de7eb6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMjo0MDoyNVrOH6GCLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMjo0MDoyNVrOH6GCLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY3ODMxNw==", "bodyText": "In this case, OFFSET clause should be required? Otherwise these 2 cases may have overlap: https://github.com/antlr/grammars-v4/blob/master/sql/mysql/Positive-Technologies/MySqlParser.g4#L1083", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r530678317", "createdAt": "2020-11-25T22:40:25Z", "author": {"login": "dai-chen"}, "path": "sql/src/main/antlr/OpenDistroSQLParser.g4", "diffHunk": "@@ -116,6 +117,11 @@ orderByElement\n     : expression order=(ASC | DESC)? (NULLS (FIRST | LAST))?\n     ;\n \n+limitClause\n+    : LIMIT (offset=decimalLiteral COMMA)? limit=decimalLiteral\n+    | LIMIT limit=decimalLiteral (OFFSET offset=decimalLiteral)?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ace67a4d6021c26c64c155bd23bcdca96de7eb6"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "977d14cef816ade851883a11ee75a3c150a5f4c6", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/977d14cef816ade851883a11ee75a3c150a5f4c6", "committedDate": "2020-11-26T05:26:04Z", "message": "added test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8d0cc7a6161e1a0a5fcbab72638dc54852717f1", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c8d0cc7a6161e1a0a5fcbab72638dc54852717f1", "committedDate": "2020-11-26T05:48:45Z", "message": "removed redundant lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94d170f07ed52c45e2ffb59c22e9f628bb6da62c", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/94d170f07ed52c45e2ffb59c22e9f628bb6da62c", "committedDate": "2020-11-26T06:01:58Z", "message": "added a note in manual"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77f64944fb246dd89b825fd3dd642a7be6c5a027", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/77f64944fb246dd89b825fd3dd642a7be6c5a027", "committedDate": "2020-11-26T06:39:04Z", "message": "set query size limit to 10000 in integration test for new engine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a26332548a78515e2bcb9bf92b1749b81f2ec785", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a26332548a78515e2bcb9bf92b1749b81f2ec785", "committedDate": "2020-11-27T19:44:29Z", "message": "set query size limit back to 200"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3cc15b6c8fe54fa99eef2b4d06d4acd8929de27", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a3cc15b6c8fe54fa99eef2b4d06d4acd8929de27", "committedDate": "2020-11-27T20:19:09Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29e7fd684993dbf262560b821cb9f416558cfcba", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/29e7fd684993dbf262560b821cb9f416558cfcba", "committedDate": "2020-12-01T20:08:00Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9fcb3b57efc553369ef322ae8323772f9f49391", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e9fcb3b57efc553369ef322ae8323772f9f49391", "committedDate": "2020-12-01T22:45:51Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a5f4fd2f4fe871d23f4270c8abfbd692b8d3f30", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3a5f4fd2f4fe871d23f4270c8abfbd692b8d3f30", "committedDate": "2020-12-01T22:46:02Z", "message": "Merge remote-tracking branch 'upstream/develop' into limit-offset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e294164d39259d21466151b6f3fab07978445e17", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e294164d39259d21466151b6f3fab07978445e17", "committedDate": "2020-12-01T23:04:44Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3210068b960e4f27e5a899de73024f32406927f", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b3210068b960e4f27e5a899de73024f32406927f", "committedDate": "2020-12-01T23:32:20Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c294b42196b83063d753232dca95dd27b35ab2ef", "committedDate": "2020-12-02T04:08:27Z", "message": "update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTMxODYx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-543131861", "createdAt": "2020-12-02T18:40:19Z", "commit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MDoxOVrOH9o_Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MDoxOVrOH9o_Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM5NjczNA==", "bodyText": "could you add the reason why it is ignored?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r534396734", "createdAt": "2020-12-02T18:40:19Z", "author": {"login": "penghuo"}, "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/legacy/TypeInformationIT.java", "diffHunk": "@@ -65,6 +67,7 @@ public void testPiReturnsDouble() {\n   /*\n   stringOperators\n    */\n+  @Ignore", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTMyNDEw", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-543132410", "createdAt": "2020-12-02T18:41:01Z", "commit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MTowMlrOH9pBCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MTowMlrOH9pBCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM5NzE5NQ==", "bodyText": "doc?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r534397195", "createdAt": "2020-12-02T18:41:02Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/LimitOperator.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.planner.physical;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.google.common.collect.ImmutableList;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+\n+@RequiredArgsConstructor\n+@Getter\n+@ToString\n+@EqualsAndHashCode\n+public class LimitOperator extends PhysicalPlan {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTM0MDk0", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-543134094", "createdAt": "2020-12-02T18:43:13Z", "commit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MzoxM1rOH9pGFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MzoxM1rOH9pGFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM5ODQ4NA==", "bodyText": "The input operator hasn't been opened?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r534398484", "createdAt": "2020-12-02T18:43:13Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/LimitOperator.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.planner.physical;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.google.common.collect.ImmutableList;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+\n+@RequiredArgsConstructor\n+@Getter\n+@ToString\n+@EqualsAndHashCode\n+public class LimitOperator extends PhysicalPlan {\n+  private final PhysicalPlan input;\n+  private final Integer limit;\n+  private final Integer offset;\n+  private Integer count = 0;\n+\n+  @Override\n+  public void open() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTQ0MTc3", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-543144177", "createdAt": "2020-12-02T18:56:19Z", "commit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1NjoxOVrOH9pmyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1NjoxOVrOH9pmyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwNjg1Ng==", "bodyText": "why the limit can't been push down?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r534406856", "createdAt": "2020-12-02T18:56:19Z", "author": {"login": "penghuo"}, "path": "elasticsearch/src/test/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/storage/ElasticsearchIndexTest.java", "diffHunk": "@@ -341,4 +345,72 @@ void shouldImplIndexScanWithSort() {\n     assertTrue(plan instanceof ProjectOperator);\n     assertTrue(((ProjectOperator) plan).getInput() instanceof ElasticsearchIndexScan);\n   }\n+\n+  @Test\n+  void shouldImplIndexScanWithLimit() {\n+    when(settings.getSettingValue(Settings.Key.QUERY_SIZE_LIMIT)).thenReturn(200);\n+\n+    ReferenceExpression field = ref(\"name\", STRING);\n+    NamedExpression named = named(\"n\", field);\n+\n+    String indexName = \"test\";\n+    ElasticsearchIndex index = new ElasticsearchIndex(client, settings, indexName);\n+    PhysicalPlan plan = index.implement(\n+        project(\n+            indexScan(\n+                indexName,\n+                1, 1\n+            ),\n+            named));\n+\n+    assertTrue(plan instanceof ProjectOperator);\n+    assertTrue(((ProjectOperator) plan).getInput() instanceof ElasticsearchIndexScan);\n+  }\n+\n+  @Test\n+  void shouldImplIndexScanWithSortAndLimit() {\n+    when(settings.getSettingValue(Settings.Key.QUERY_SIZE_LIMIT)).thenReturn(200);\n+\n+    ReferenceExpression field = ref(\"name\", STRING);\n+    NamedExpression named = named(\"n\", field);\n+    Expression sortExpr = ref(\"name\", STRING);\n+\n+    String indexName = \"test\";\n+    ElasticsearchIndex index = new ElasticsearchIndex(client, settings, indexName);\n+    PhysicalPlan plan = index.implement(\n+        project(\n+            indexScan(\n+                indexName,\n+                sortExpr,\n+                1, 1\n+            ),\n+            named));\n+\n+    assertTrue(plan instanceof ProjectOperator);\n+    assertTrue(((ProjectOperator) plan).getInput() instanceof ElasticsearchIndexScan);\n+  }\n+\n+  @Test\n+  void shouldNotPushDownLimitFarFromRelationButUpdateScanSize() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTQ1NzI4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-543145728", "createdAt": "2020-12-02T18:58:21Z", "commit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1ODoyMlrOH9prnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1ODoyMlrOH9prnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwODA5Mg==", "bodyText": "This rule may be effect by limit push down. e.g. agg -> limit -> relation. with current rules,\n\nagg -> IndexScan\nIndexAggScan, which is unexpected.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r534408092", "createdAt": "2020-12-02T18:58:22Z", "author": {"login": "penghuo"}, "path": "elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/ElasticsearchLogicalPlanOptimizerFactory.java", "diffHunk": "@@ -41,6 +43,8 @@ public static LogicalPlanOptimizer create() {\n         new MergeAggAndIndexScan(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0226b39ea00065de5228f1b4115435a5ec52fa50", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0226b39ea00065de5228f1b4115435a5ec52fa50", "committedDate": "2020-12-02T21:16:11Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "103531f1eb2d5c91db646829895c3eb54cd3135a", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/103531f1eb2d5c91db646829895c3eb54cd3135a", "committedDate": "2020-12-02T22:34:12Z", "message": "set default query size limit for integration tests to 10000"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f1e80d92f2ffb52ed7590fea9ec637314d1fa65", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8f1e80d92f2ffb52ed7590fea9ec637314d1fa65", "committedDate": "2020-12-02T23:20:22Z", "message": "added java doc for LimitOperator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6fd47762d7d77cbc030d57d38d0775d337b829e", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c6fd47762d7d77cbc030d57d38d0775d337b829e", "committedDate": "2020-12-08T00:12:15Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ce50ca7ffb2c66ae6cbf3f98cca429336998d87", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/9ce50ca7ffb2c66ae6cbf3f98cca429336998d87", "committedDate": "2020-12-08T00:16:29Z", "message": "Merge remote-tracking branch 'upstream/develop' into limit-offset\n\n# Conflicts:\n#\telasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/ElasticsearchLogicalPlanOptimizerFactory.java\n#\telasticsearch/src/test/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/ElasticsearchLogicOptimizerTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a044b7afbb74a5fc19d33cab432b73d7a603781", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4a044b7afbb74a5fc19d33cab432b73d7a603781", "committedDate": "2020-12-08T02:13:16Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd63cb5e7d1e01e49628b6b934f0dff9b333a51f", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/bd63cb5e7d1e01e49628b6b934f0dff9b333a51f", "committedDate": "2020-12-09T02:40:56Z", "message": "added doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4375198313a18b6cc7c6bae39a334d55b8a34b59", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4375198313a18b6cc7c6bae39a334d55b8a34b59", "committedDate": "2020-12-09T02:43:25Z", "message": "Merge remote-tracking branch 'upstream/develop' into limit-offset\n\n# Conflicts:\n#\tinteg-test/src/test/resources/correctness/queries/select.txt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjY4NTg3", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-550668587", "createdAt": "2020-12-12T00:55:26Z", "commit": {"oid": "4375198313a18b6cc7c6bae39a334d55b8a34b59"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDo1NToyN1rOIEYJ-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDo1NToyN1rOIEYJ-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2MDk4Ng==", "bodyText": "(See for Optimizations <../admin/settings.rst#opendistro.query.size_limit> details), the Optimizations should be Settings, right?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r541460986", "createdAt": "2020-12-12T00:55:27Z", "author": {"login": "penghuo"}, "path": "docs/user/dql/basics.rst", "diffHunk": "@@ -1099,3 +1099,20 @@ Result set:\n +--------------+\n \n \n+Offset position can be given following the OFFSET keyword as well, here is an example::\n+\n+    >od SELECT age FROM accounts ORDER BY age LIMIT 2 OFFSET 1\n+    fetched rows / total rows = 2/2\n+    +-------+\n+    | age   |\n+    |-------|\n+    | 32    |\n+    | 33    |\n+    +-------+\n+\n+\n+Limitation\n+----------\n+Generally, sort plan is pushed down into the Elasticsearch DSL in plan optimization, but note that if a query has complex sorting, like sort expression, which would not be pushed down during optimization (see `Optimizations <../optimization/optimization.rst>`_ for details), but computed in local memory. However, the engine fetches the index of a default size that is set in plugin setting (See for `Optimizations <../admin/settings.rst#opendistro.query.size_limit>` details). Therefore, the result might not be absolutely correct if the index size is larger than the default size of index scan. For example, the engine has a index scan size of 200 and the index size is 500. Then a query with limit 300 can only fetch 200 rows of the index, compute and return the sorted result with 200 rows, while the rest 300 rows of the index are ignored and would not be fetched into the engine. To get an absolutely correct result, it is suggested to set the query size limit to a larger value before run the query.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4375198313a18b6cc7c6bae39a334d55b8a34b59"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0eaae98f6ba13e9a95daf8dc1faa2ec59824bdbb", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0eaae98f6ba13e9a95daf8dc1faa2ec59824bdbb", "committedDate": "2020-12-12T01:03:14Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56e217d068c1c8a1116eea958655f48ce69201ac", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/56e217d068c1c8a1116eea958655f48ce69201ac", "committedDate": "2020-12-12T01:05:31Z", "message": "Merge remote-tracking branch 'upstream/develop' into limit-offset\n\n# Conflicts:\n#\tinteg-test/src/test/resources/correctness/queries/select.txt\n#\tinteg-test/src/test/resources/correctness/queries/subquries.txt\n#\tsql/src/test/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/AstBuilderTest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTY1Nzc2", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-550565776", "createdAt": "2020-12-11T20:45:26Z", "commit": {"oid": "4375198313a18b6cc7c6bae39a334d55b8a34b59"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo0NToyN1rOIEMiWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo0NToyN1rOIEMiWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3MDYxNg==", "bodyText": "The second argument should be an \"integer\"?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r541270616", "createdAt": "2020-12-11T20:45:27Z", "author": {"login": "dai-chen"}, "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/legacy/SQLIntegTestCase.java", "diffHunk": "@@ -77,6 +78,8 @@\n \n   public static final String PERSISTENT = \"persistent\";\n   public static final String TRANSIENT = \"transient\";\n+  public static final Integer DEFAULT_QUERY_SIZE_LIMIT =\n+      Integer.parseInt(System.getProperty(\"defaultQuerySizeLimit\", \"false\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4375198313a18b6cc7c6bae39a334d55b8a34b59"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjcxNDky", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-550671492", "createdAt": "2020-12-12T01:12:09Z", "commit": {"oid": "4375198313a18b6cc7c6bae39a334d55b8a34b59"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMToxMjozOFrOIEYZsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMToxMjozOFrOIEYZsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2NTAxMQ==", "bodyText": "move to ElasticsearchLogicalIndexScan?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r541465011", "createdAt": "2020-12-12T01:12:38Z", "author": {"login": "penghuo"}, "path": "elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/rule/MergeAggAndIndexScan.java", "diffHunk": "@@ -64,4 +65,8 @@ public LogicalPlan apply(LogicalAggregation aggregation,\n         .groupByList(aggregation.getGroupByList())\n         .build();\n   }\n+\n+  private boolean hasLimitInIndexScan(ElasticsearchLogicalIndexScan indexScan) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56e217d068c1c8a1116eea958655f48ce69201ac"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjcyMTE4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-550672118", "createdAt": "2020-12-12T01:16:05Z", "commit": {"oid": "56e217d068c1c8a1116eea958655f48ce69201ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjczMjEz", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#pullrequestreview-550673213", "createdAt": "2020-12-12T01:23:24Z", "commit": {"oid": "56e217d068c1c8a1116eea958655f48ce69201ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMToyMzoyNFrOIEYixA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMToyMzoyNFrOIEYixA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2NzMzMg==", "bodyText": "Btw, so no Limit operator created if LIMIT clause absent in query. In this case what's the size in DSL generated? I recall we wanted to create a Limit operator with a default value here anyway?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r541467332", "createdAt": "2020-12-12T01:23:24Z", "author": {"login": "dai-chen"}, "path": "sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/AstBuilder.java", "diffHunk": "@@ -111,7 +112,16 @@ public UnresolvedPlan visitQuerySpecification(QuerySpecificationContext queryCon\n       return project.attach(emptyValue);\n     }\n \n-    UnresolvedPlan result = project.attach(visit(queryContext.fromClause()));\n+    // If limit (and offset) keyword exists:\n+    // Add Limit node, plan structure becomes:\n+    // Project -> Limit -> visit(fromClause)\n+    // Else:\n+    // Project -> visit(fromClause)\n+    UnresolvedPlan from = visit(queryContext.fromClause());\n+    if (queryContext.limitClause() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56e217d068c1c8a1116eea958655f48ce69201ac"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6ff44bc2b36427f561eaafc008d2fe6e8dd4aba", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c6ff44bc2b36427f561eaafc008d2fe6e8dd4aba", "committedDate": "2020-12-12T01:38:16Z", "message": "update"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 570, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}