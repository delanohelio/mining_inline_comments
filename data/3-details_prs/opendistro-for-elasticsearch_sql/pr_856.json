{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NjkwMDM0", "number": 856, "title": "Sort aggregation push down", "bodyText": "Description of changes:\n\nAdd the sort push down rule for aggregation.\nDesribe the optimization and limitation in https://github.com/penghuo/sql/blob/sort-aggregation-push-down/docs/user/optimization/optimization.rst\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-11-25T21:00:39Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/856", "merged": true, "mergeCommit": {"oid": "80033fcce1622112c2c61963b9daa542d9586a9a"}, "closed": true, "closedAt": "2020-12-04T01:03:37Z", "author": {"login": "penghuo"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfz0ILgH2gAyNTI3NjkwMDM0OmUwOTQyNDkwM2Q2NTNlNjFlYzUxM2MxZDgxY2M3YjlhOTRhOTg0NzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdisrxxAH2gAyNTI3NjkwMDM0OjM0NWRhYTFlODhlYzBkYWJhYjhkZjA2MWFlOTE1MDQyY2IzMjMyODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e09424903d653e61ec513c1d81cc7b9a94a98470", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e09424903d653e61ec513c1d81cc7b9a94a98470", "committedDate": "2020-11-25T01:10:59Z", "message": "init"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8163ae9b1ddd4554b702d334e38888c357e9826", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c8163ae9b1ddd4554b702d334e38888c357e9826", "committedDate": "2020-11-25T05:46:42Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f83d9bbd01a2a702cef2d3a86fbba7f2efbbc6c", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8f83d9bbd01a2a702cef2d3a86fbba7f2efbbc6c", "committedDate": "2020-11-25T15:31:30Z", "message": "fix IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "741653c8d4aed10a01a77583fc09c5ad555cdc93", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/741653c8d4aed10a01a77583fc09c5ad555cdc93", "committedDate": "2020-11-25T17:45:53Z", "message": "add doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9562eeb6fd070dd989f93b265e991ac1ea99cf8", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f9562eeb6fd070dd989f93b265e991ac1ea99cf8", "committedDate": "2020-11-25T18:14:59Z", "message": "update doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06fd9914ae2ab676147b7fc3cf136f9db23a128e", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/06fd9914ae2ab676147b7fc3cf136f9db23a128e", "committedDate": "2020-11-25T18:22:03Z", "message": "fix issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f72bb4831a94081c9ace8d7cd49076164d94eb1b", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f72bb4831a94081c9ace8d7cd49076164d94eb1b", "committedDate": "2020-11-25T18:44:43Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0212f2fb27592120b0480f679c60fcdef8311a99", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0212f2fb27592120b0480f679c60fcdef8311a99", "committedDate": "2020-11-25T19:16:39Z", "message": "change doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27e1487501de74c2f07d0a1793c1e49cea9d6d89", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/27e1487501de74c2f07d0a1793c1e49cea9d6d89", "committedDate": "2020-11-25T19:17:48Z", "message": "change doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d00a0baacaaf17ecc09e45be1e51d0a64de94e7", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4d00a0baacaaf17ecc09e45be1e51d0a64de94e7", "committedDate": "2020-11-25T19:19:44Z", "message": "update doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzY0NDkz", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/856#pullrequestreview-542364493", "createdAt": "2020-12-01T22:53:17Z", "commit": {"oid": "4d00a0baacaaf17ecc09e45be1e51d0a64de94e7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNTU5Njcz", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/856#pullrequestreview-541559673", "createdAt": "2020-12-01T07:49:09Z", "commit": {"oid": "4d00a0baacaaf17ecc09e45be1e51d0a64de94e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwNzo0OTowOVrOH8bv5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwNzo0OTowOVrOH8bv5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEzMTIzOQ==", "bodyText": "Merge sort -- IndexAgg?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/856#discussion_r533131239", "createdAt": "2020-12-01T07:49:09Z", "author": {"login": "chloe-zh"}, "path": "elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/rule/MergeSortAndIndexAgg.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ *\n+ *    Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *    Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *    You may not use this file except in compliance with the License.\n+ *    A copy of the License is located at\n+ *\n+ *        http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *    or in the \"license\" file accompanying this file. This file is distributed\n+ *    on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *    express or implied. See the License for the specific language governing\n+ *    permissions and limitations under the License.\n+ *\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.elasticsearch.planner.logical.rule;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.planner.optimizer.pattern.Patterns.source;\n+import static com.facebook.presto.matching.Pattern.typeOf;\n+\n+import com.amazon.opendistroforelasticsearch.sql.ast.tree.Sort;\n+import com.amazon.opendistroforelasticsearch.sql.elasticsearch.planner.logical.ElasticsearchLogicalIndexAgg;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.ReferenceExpression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.aggregation.NamedAggregator;\n+import com.amazon.opendistroforelasticsearch.sql.planner.logical.LogicalPlan;\n+import com.amazon.opendistroforelasticsearch.sql.planner.logical.LogicalSort;\n+import com.amazon.opendistroforelasticsearch.sql.planner.optimizer.Rule;\n+import com.facebook.presto.matching.Capture;\n+import com.facebook.presto.matching.Captures;\n+import com.facebook.presto.matching.Pattern;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.stream.Collectors;\n+import lombok.Getter;\n+import lombok.experimental.Accessors;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+/**\n+ * Merge Aggregation -- IndexAgg to IndexScanAggregation.\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d00a0baacaaf17ecc09e45be1e51d0a64de94e7"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzY0ODQ5", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/856#pullrequestreview-543364849", "createdAt": "2020-12-03T01:10:51Z", "commit": {"oid": "4d00a0baacaaf17ecc09e45be1e51d0a64de94e7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "709980023e73ac435aade9a018be846cecfd640f", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/709980023e73ac435aade9a018be846cecfd640f", "committedDate": "2020-12-03T16:57:33Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07cbae42896f158ce0d729967abcf77d2f57255b", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/07cbae42896f158ce0d729967abcf77d2f57255b", "committedDate": "2020-12-03T17:02:49Z", "message": "merge from develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "345daa1e88ec0dabab8df061ae915042cb323283", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/345daa1e88ec0dabab8df061ae915042cb323283", "committedDate": "2020-12-04T00:34:18Z", "message": "Merge branch 'develop' into sort-aggregation-push-down"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 573, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}