{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MTM2Mjk2", "number": 851, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo0MjozM1rOE9SQqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMToyMzoyNFrOFETf5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNjk3NzY4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/storage/StorageEngine.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo0MjozM1rOH55MGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo0MjozM1rOH55MGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ2Nzg2Nw==", "bodyText": "The orignal definition of getTable is get Table from storage engine by name, the size paramater doesn't make sense in here.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r530467867", "createdAt": "2020-11-25T15:42:33Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/storage/StorageEngine.java", "diffHunk": "@@ -23,5 +23,5 @@\n   /**\n    * Get {@link Table} from storage engine.\n    */\n-  Table getTable(String name);\n+  Table getTable(String name, Integer size);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18d2bb583dbfab5f247a310ed4fc990f503f0857"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNzAyNzg0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/LimitOperator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo1MzowNlrOH55rLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxODozODo1MlrOH5_ypw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ3NTgyMQ==", "bodyText": "Does it need to be the reduce operation which take all the rows from downstream at open stage?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r530475821", "createdAt": "2020-11-25T15:53:06Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/LimitOperator.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.planner.physical;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterators;\n+import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+\n+@RequiredArgsConstructor\n+@Getter\n+@ToString\n+@EqualsAndHashCode\n+public class LimitOperator extends PhysicalPlan {\n+  private final PhysicalPlan input;\n+  private final Integer limit;\n+  private final Integer offset;\n+  private Iterator<ExprValue> iterator;\n+\n+  @Override\n+  public void open() {\n+    super.open();\n+\n+    List<ExprValue> results = new LinkedList<>();\n+    while (input.hasNext()) {\n+      results.add(input.next());\n+    }\n+    iterator = Iterators.limit(offset(results.iterator(), offset), limit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18d2bb583dbfab5f247a310ed4fc990f503f0857"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3NjAzOQ==", "bodyText": "Changed to only block the rows out of the offset-limit window", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r530576039", "createdAt": "2020-11-25T18:38:52Z", "author": {"login": "chloe-zh"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/LimitOperator.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.planner.physical;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterators;\n+import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+\n+@RequiredArgsConstructor\n+@Getter\n+@ToString\n+@EqualsAndHashCode\n+public class LimitOperator extends PhysicalPlan {\n+  private final PhysicalPlan input;\n+  private final Integer limit;\n+  private final Integer offset;\n+  private Iterator<ExprValue> iterator;\n+\n+  @Override\n+  public void open() {\n+    super.open();\n+\n+    List<ExprValue> results = new LinkedList<>();\n+    while (input.hasNext()) {\n+      results.add(input.next());\n+    }\n+    iterator = Iterators.limit(offset(results.iterator(), offset), limit);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ3NTgyMQ=="}, "originalCommit": {"oid": "18d2bb583dbfab5f247a310ed4fc990f503f0857"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNzY0NDMwOnYy", "diffSide": "RIGHT", "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/legacy/PrettyFormatResponseIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxODozMDo1NVrOH5_jqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxODozMDo1NVrOH5_jqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3MjIwMA==", "bodyText": "Please check back once my JDBC formatter PR merged: #854. With this formatter, new engine response would be same as before which may avoid this issue.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r530572200", "createdAt": "2020-11-25T18:30:55Z", "author": {"login": "dai-chen"}, "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/legacy/PrettyFormatResponseIT.java", "diffHunk": "@@ -290,6 +290,7 @@ public void groupByMultipleFields() throws IOException {\n     assertContainsData(getDataRows(response), fields);\n   }\n \n+  @Ignore(\"Skip this test due to inconsistency in total hits\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18d2bb583dbfab5f247a310ed4fc990f503f0857"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyODMzNTM3OnYy", "diffSide": "RIGHT", "path": "sql/src/main/antlr/OpenDistroSQLParser.g4", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMjo0MDoyNVrOH6GCLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMjo0MDoyNVrOH6GCLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY3ODMxNw==", "bodyText": "In this case, OFFSET clause should be required? Otherwise these 2 cases may have overlap: https://github.com/antlr/grammars-v4/blob/master/sql/mysql/Positive-Technologies/MySqlParser.g4#L1083", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r530678317", "createdAt": "2020-11-25T22:40:25Z", "author": {"login": "dai-chen"}, "path": "sql/src/main/antlr/OpenDistroSQLParser.g4", "diffHunk": "@@ -116,6 +117,11 @@ orderByElement\n     : expression order=(ASC | DESC)? (NULLS (FIRST | LAST))?\n     ;\n \n+limitClause\n+    : LIMIT (offset=decimalLiteral COMMA)? limit=decimalLiteral\n+    | LIMIT limit=decimalLiteral (OFFSET offset=decimalLiteral)?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ace67a4d6021c26c64c155bd23bcdca96de7eb6"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MjkwNDA3OnYy", "diffSide": "RIGHT", "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/legacy/TypeInformationIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MDoxOVrOH9o_Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MDoxOVrOH9o_Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM5NjczNA==", "bodyText": "could you add the reason why it is ignored?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r534396734", "createdAt": "2020-12-02T18:40:19Z", "author": {"login": "penghuo"}, "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/legacy/TypeInformationIT.java", "diffHunk": "@@ -65,6 +67,7 @@ public void testPiReturnsDouble() {\n   /*\n   stringOperators\n    */\n+  @Ignore", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MjkwNzAzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/LimitOperator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MTowMlrOH9pBCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MTowMlrOH9pBCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM5NzE5NQ==", "bodyText": "doc?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r534397195", "createdAt": "2020-12-02T18:41:02Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/LimitOperator.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.planner.physical;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.google.common.collect.ImmutableList;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+\n+@RequiredArgsConstructor\n+@Getter\n+@ToString\n+@EqualsAndHashCode\n+public class LimitOperator extends PhysicalPlan {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MjkxNDY0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/LimitOperator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MzoxM1rOH9pGFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo0MzoxM1rOH9pGFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM5ODQ4NA==", "bodyText": "The input operator hasn't been opened?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r534398484", "createdAt": "2020-12-02T18:43:13Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/planner/physical/LimitOperator.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.planner.physical;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.google.common.collect.ImmutableList;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+\n+@RequiredArgsConstructor\n+@Getter\n+@ToString\n+@EqualsAndHashCode\n+public class LimitOperator extends PhysicalPlan {\n+  private final PhysicalPlan input;\n+  private final Integer limit;\n+  private final Integer offset;\n+  private Integer count = 0;\n+\n+  @Override\n+  public void open() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1Mjk2ODg2OnYy", "diffSide": "RIGHT", "path": "elasticsearch/src/test/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/storage/ElasticsearchIndexTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1NjoxOVrOH9pmyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjozNTo0NlrOH9xBBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwNjg1Ng==", "bodyText": "why the limit can't been push down?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r534406856", "createdAt": "2020-12-02T18:56:19Z", "author": {"login": "penghuo"}, "path": "elasticsearch/src/test/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/storage/ElasticsearchIndexTest.java", "diffHunk": "@@ -341,4 +345,72 @@ void shouldImplIndexScanWithSort() {\n     assertTrue(plan instanceof ProjectOperator);\n     assertTrue(((ProjectOperator) plan).getInput() instanceof ElasticsearchIndexScan);\n   }\n+\n+  @Test\n+  void shouldImplIndexScanWithLimit() {\n+    when(settings.getSettingValue(Settings.Key.QUERY_SIZE_LIMIT)).thenReturn(200);\n+\n+    ReferenceExpression field = ref(\"name\", STRING);\n+    NamedExpression named = named(\"n\", field);\n+\n+    String indexName = \"test\";\n+    ElasticsearchIndex index = new ElasticsearchIndex(client, settings, indexName);\n+    PhysicalPlan plan = index.implement(\n+        project(\n+            indexScan(\n+                indexName,\n+                1, 1\n+            ),\n+            named));\n+\n+    assertTrue(plan instanceof ProjectOperator);\n+    assertTrue(((ProjectOperator) plan).getInput() instanceof ElasticsearchIndexScan);\n+  }\n+\n+  @Test\n+  void shouldImplIndexScanWithSortAndLimit() {\n+    when(settings.getSettingValue(Settings.Key.QUERY_SIZE_LIMIT)).thenReturn(200);\n+\n+    ReferenceExpression field = ref(\"name\", STRING);\n+    NamedExpression named = named(\"n\", field);\n+    Expression sortExpr = ref(\"name\", STRING);\n+\n+    String indexName = \"test\";\n+    ElasticsearchIndex index = new ElasticsearchIndex(client, settings, indexName);\n+    PhysicalPlan plan = index.implement(\n+        project(\n+            indexScan(\n+                indexName,\n+                sortExpr,\n+                1, 1\n+            ),\n+            named));\n+\n+    assertTrue(plan instanceof ProjectOperator);\n+    assertTrue(((ProjectOperator) plan).getInput() instanceof ElasticsearchIndexScan);\n+  }\n+\n+  @Test\n+  void shouldNotPushDownLimitFarFromRelationButUpdateScanSize() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyODI2MA==", "bodyText": "it's for the case when sort is not pushed down", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r534528260", "createdAt": "2020-12-02T22:35:46Z", "author": {"login": "chloe-zh"}, "path": "elasticsearch/src/test/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/storage/ElasticsearchIndexTest.java", "diffHunk": "@@ -341,4 +345,72 @@ void shouldImplIndexScanWithSort() {\n     assertTrue(plan instanceof ProjectOperator);\n     assertTrue(((ProjectOperator) plan).getInput() instanceof ElasticsearchIndexScan);\n   }\n+\n+  @Test\n+  void shouldImplIndexScanWithLimit() {\n+    when(settings.getSettingValue(Settings.Key.QUERY_SIZE_LIMIT)).thenReturn(200);\n+\n+    ReferenceExpression field = ref(\"name\", STRING);\n+    NamedExpression named = named(\"n\", field);\n+\n+    String indexName = \"test\";\n+    ElasticsearchIndex index = new ElasticsearchIndex(client, settings, indexName);\n+    PhysicalPlan plan = index.implement(\n+        project(\n+            indexScan(\n+                indexName,\n+                1, 1\n+            ),\n+            named));\n+\n+    assertTrue(plan instanceof ProjectOperator);\n+    assertTrue(((ProjectOperator) plan).getInput() instanceof ElasticsearchIndexScan);\n+  }\n+\n+  @Test\n+  void shouldImplIndexScanWithSortAndLimit() {\n+    when(settings.getSettingValue(Settings.Key.QUERY_SIZE_LIMIT)).thenReturn(200);\n+\n+    ReferenceExpression field = ref(\"name\", STRING);\n+    NamedExpression named = named(\"n\", field);\n+    Expression sortExpr = ref(\"name\", STRING);\n+\n+    String indexName = \"test\";\n+    ElasticsearchIndex index = new ElasticsearchIndex(client, settings, indexName);\n+    PhysicalPlan plan = index.implement(\n+        project(\n+            indexScan(\n+                indexName,\n+                sortExpr,\n+                1, 1\n+            ),\n+            named));\n+\n+    assertTrue(plan instanceof ProjectOperator);\n+    assertTrue(((ProjectOperator) plan).getInput() instanceof ElasticsearchIndexScan);\n+  }\n+\n+  @Test\n+  void shouldNotPushDownLimitFarFromRelationButUpdateScanSize() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwNjg1Ng=="}, "originalCommit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1Mjk3NjU5OnYy", "diffSide": "RIGHT", "path": "elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/ElasticsearchLogicalPlanOptimizerFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1ODoyMlrOH9prnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODo1ODoyMlrOH9prnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQwODA5Mg==", "bodyText": "This rule may be effect by limit push down. e.g. agg -> limit -> relation. with current rules,\n\nagg -> IndexScan\nIndexAggScan, which is unexpected.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r534408092", "createdAt": "2020-12-02T18:58:22Z", "author": {"login": "penghuo"}, "path": "elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/ElasticsearchLogicalPlanOptimizerFactory.java", "diffHunk": "@@ -41,6 +43,8 @@ public static LogicalPlanOptimizer create() {\n         new MergeAggAndIndexScan(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c294b42196b83063d753232dca95dd27b35ab2ef"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5OTMzNzM5OnYy", "diffSide": "RIGHT", "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/legacy/SQLIntegTestCase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo0NToyN1rOIEMiWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTozODo1NFrOIEYvFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3MDYxNg==", "bodyText": "The second argument should be an \"integer\"?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r541270616", "createdAt": "2020-12-11T20:45:27Z", "author": {"login": "dai-chen"}, "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/legacy/SQLIntegTestCase.java", "diffHunk": "@@ -77,6 +78,8 @@\n \n   public static final String PERSISTENT = \"persistent\";\n   public static final String TRANSIENT = \"transient\";\n+  public static final Integer DEFAULT_QUERY_SIZE_LIMIT =\n+      Integer.parseInt(System.getProperty(\"defaultQuerySizeLimit\", \"false\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4375198313a18b6cc7c6bae39a334d55b8a34b59"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3MDQ4Ng==", "bodyText": "changed to 200", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r541470486", "createdAt": "2020-12-12T01:38:54Z", "author": {"login": "chloe-zh"}, "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/legacy/SQLIntegTestCase.java", "diffHunk": "@@ -77,6 +78,8 @@\n \n   public static final String PERSISTENT = \"persistent\";\n   public static final String TRANSIENT = \"transient\";\n+  public static final Integer DEFAULT_QUERY_SIZE_LIMIT =\n+      Integer.parseInt(System.getProperty(\"defaultQuerySizeLimit\", \"false\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3MDYxNg=="}, "originalCommit": {"oid": "4375198313a18b6cc7c6bae39a334d55b8a34b59"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwMDUzMDAyOnYy", "diffSide": "RIGHT", "path": "docs/user/dql/basics.rst", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDo1NToyN1rOIEYJ-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDo1ODo0OVrOIEYNBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2MDk4Ng==", "bodyText": "(See for Optimizations <../admin/settings.rst#opendistro.query.size_limit> details), the Optimizations should be Settings, right?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r541460986", "createdAt": "2020-12-12T00:55:27Z", "author": {"login": "penghuo"}, "path": "docs/user/dql/basics.rst", "diffHunk": "@@ -1099,3 +1099,20 @@ Result set:\n +--------------+\n \n \n+Offset position can be given following the OFFSET keyword as well, here is an example::\n+\n+    >od SELECT age FROM accounts ORDER BY age LIMIT 2 OFFSET 1\n+    fetched rows / total rows = 2/2\n+    +-------+\n+    | age   |\n+    |-------|\n+    | 32    |\n+    | 33    |\n+    +-------+\n+\n+\n+Limitation\n+----------\n+Generally, sort plan is pushed down into the Elasticsearch DSL in plan optimization, but note that if a query has complex sorting, like sort expression, which would not be pushed down during optimization (see `Optimizations <../optimization/optimization.rst>`_ for details), but computed in local memory. However, the engine fetches the index of a default size that is set in plugin setting (See for `Optimizations <../admin/settings.rst#opendistro.query.size_limit>` details). Therefore, the result might not be absolutely correct if the index size is larger than the default size of index scan. For example, the engine has a index scan size of 200 and the index size is 500. Then a query with limit 300 can only fetch 200 rows of the index, compute and return the sorted result with 200 rows, while the rest 300 rows of the index are ignored and would not be fetched into the engine. To get an absolutely correct result, it is suggested to set the query size limit to a larger value before run the query.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4375198313a18b6cc7c6bae39a334d55b8a34b59"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2MTc2Ng==", "bodyText": "yes, will change it", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r541461766", "createdAt": "2020-12-12T00:58:49Z", "author": {"login": "chloe-zh"}, "path": "docs/user/dql/basics.rst", "diffHunk": "@@ -1099,3 +1099,20 @@ Result set:\n +--------------+\n \n \n+Offset position can be given following the OFFSET keyword as well, here is an example::\n+\n+    >od SELECT age FROM accounts ORDER BY age LIMIT 2 OFFSET 1\n+    fetched rows / total rows = 2/2\n+    +-------+\n+    | age   |\n+    |-------|\n+    | 32    |\n+    | 33    |\n+    +-------+\n+\n+\n+Limitation\n+----------\n+Generally, sort plan is pushed down into the Elasticsearch DSL in plan optimization, but note that if a query has complex sorting, like sort expression, which would not be pushed down during optimization (see `Optimizations <../optimization/optimization.rst>`_ for details), but computed in local memory. However, the engine fetches the index of a default size that is set in plugin setting (See for `Optimizations <../admin/settings.rst#opendistro.query.size_limit>` details). Therefore, the result might not be absolutely correct if the index size is larger than the default size of index scan. For example, the engine has a index scan size of 200 and the index size is 500. Then a query with limit 300 can only fetch 200 rows of the index, compute and return the sorted result with 200 rows, while the rest 300 rows of the index are ignored and would not be fetched into the engine. To get an absolutely correct result, it is suggested to set the query size limit to a larger value before run the query.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2MDk4Ng=="}, "originalCommit": {"oid": "4375198313a18b6cc7c6bae39a334d55b8a34b59"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwMDU2MjQ3OnYy", "diffSide": "RIGHT", "path": "elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/rule/MergeAggAndIndexScan.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMToxMjozOFrOIEYZsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMTozOTowM1rOIEYvNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2NTAxMQ==", "bodyText": "move to ElasticsearchLogicalIndexScan?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r541465011", "createdAt": "2020-12-12T01:12:38Z", "author": {"login": "penghuo"}, "path": "elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/rule/MergeAggAndIndexScan.java", "diffHunk": "@@ -64,4 +65,8 @@ public LogicalPlan apply(LogicalAggregation aggregation,\n         .groupByList(aggregation.getGroupByList())\n         .build();\n   }\n+\n+  private boolean hasLimitInIndexScan(ElasticsearchLogicalIndexScan indexScan) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56e217d068c1c8a1116eea958655f48ce69201ac"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3MDUxOQ==", "bodyText": "done", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r541470519", "createdAt": "2020-12-12T01:39:03Z", "author": {"login": "chloe-zh"}, "path": "elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/planner/logical/rule/MergeAggAndIndexScan.java", "diffHunk": "@@ -64,4 +65,8 @@ public LogicalPlan apply(LogicalAggregation aggregation,\n         .groupByList(aggregation.getGroupByList())\n         .build();\n   }\n+\n+  private boolean hasLimitInIndexScan(ElasticsearchLogicalIndexScan indexScan) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2NTAxMQ=="}, "originalCommit": {"oid": "56e217d068c1c8a1116eea958655f48ce69201ac"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwMDU4MDg1OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/AstBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMToyMzoyNFrOIEYixA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMToyMzoyNFrOIEYixA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2NzMzMg==", "bodyText": "Btw, so no Limit operator created if LIMIT clause absent in query. In this case what's the size in DSL generated? I recall we wanted to create a Limit operator with a default value here anyway?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/851#discussion_r541467332", "createdAt": "2020-12-12T01:23:24Z", "author": {"login": "dai-chen"}, "path": "sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/AstBuilder.java", "diffHunk": "@@ -111,7 +112,16 @@ public UnresolvedPlan visitQuerySpecification(QuerySpecificationContext queryCon\n       return project.attach(emptyValue);\n     }\n \n-    UnresolvedPlan result = project.attach(visit(queryContext.fromClause()));\n+    // If limit (and offset) keyword exists:\n+    // Add Limit node, plan structure becomes:\n+    // Project -> Limit -> visit(fromClause)\n+    // Else:\n+    // Project -> visit(fromClause)\n+    UnresolvedPlan from = visit(queryContext.fromClause());\n+    if (queryContext.limitClause() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56e217d068c1c8a1116eea958655f48ce69201ac"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1923, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}