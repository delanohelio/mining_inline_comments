{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMTk5NDc5", "number": 393, "title": "Fix failure in IT test with external cluster", "bodyText": "Issue #, if available:\n#391 causes github workflow failure\nDescription of changes:\n\nFix failure in IT test with external cluster, basically the previous PR #391 which caused a github workflow failure\nAdd try with resource to avoid JMX connector won't close when an exception is thrown.\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-03-24T18:57:13Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/393", "merged": true, "mergeCommit": {"oid": "941065bc565b298a1e94a213fd3eccbc51e459b5"}, "closed": true, "closedAt": "2020-03-24T21:30:15Z", "author": {"login": "zhongnansu"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ3OY9AH2gAyMzkzMTk5NDc5OjJhOWM1NjNhNDk2Y2IyM2NhNDI0YThiOTJkNTJmOTdiOTE2ZWRjNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ5un1gH2gAyMzkzMTk5NDc5OjI5YTNmZmQ0OWYxN2MyNGE2NDgwMmY4MmY3YjA2YmQzN2NlY2NkM2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2a9c563a496cb23ca424a8b92d52f97b916edc42", "author": {"user": {"login": "zhongnansu", "name": "Zhongnan Su"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2a9c563a496cb23ca424a8b92d52f97b916edc42", "committedDate": "2020-03-24T18:29:22Z", "message": "fix failure in IT test with external cluster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59e43ac5686abc8cd8a572c111cff65b386878c3", "author": {"user": {"login": "zhongnansu", "name": "Zhongnan Su"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/59e43ac5686abc8cd8a572c111cff65b386878c3", "committedDate": "2020-03-24T18:42:32Z", "message": "Merge pull request #3 from zhongnansu/fixExternal\n\nfix failure in IT test with external cluster"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNjExNTk3", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/393#pullrequestreview-380611597", "createdAt": "2020-03-24T19:00:20Z", "commit": {"oid": "59e43ac5686abc8cd8a572c111cff65b386878c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNjU2MTgx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/393#pullrequestreview-380656181", "createdAt": "2020-03-24T20:05:51Z", "commit": {"oid": "59e43ac5686abc8cd8a572c111cff65b386878c3"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMDowNTo1MVrOF7BExA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMDowNjozNlrOF7BGOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQyNzkwOA==", "bodyText": "Would be better if we keep the full error stack by throw new RuntimeException(\"Failed to dump coverage\", ex);", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/393#discussion_r397427908", "createdAt": "2020-03-24T20:05:51Z", "author": {"login": "dai-chen"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/SQLIntegTestCase.java", "diffHunk": "@@ -107,23 +106,25 @@ protected boolean preserveClusterUponCompletion() {\n     }\n \n     @AfterClass\n-    public static void dumpCoverage() throws IOException, MalformedObjectNameException {\n+    public static void dumpCoverage() {\n         // jacoco.dir is set in sqlplugin-coverage.gradle, if it doesn't exist we don't\n         // want to collect coverage so we can return early\n         String jacocoBuildPath = System.getProperty(\"jacoco.dir\");\n-        if (jacocoBuildPath.isEmpty()) {\n+        if (jacocoBuildPath == null || jacocoBuildPath.isEmpty()) {\n             return;\n         }\n \n         String serverUrl = \"service:jmx:rmi:///jndi/rmi://127.0.0.1:7777/jmxrmi\";\n-        JMXConnector connector = JMXConnectorFactory.connect(new JMXServiceURL(serverUrl));\n-        IProxy proxy = MBeanServerInvocationHandler.newProxyInstance(\n-                connector.getMBeanServerConnection(), new ObjectName(\"org.jacoco:type=Runtime\"), IProxy.class,\n-                false);\n-\n-        Path path = Paths.get(jacocoBuildPath + \"/integTest.exec\");\n-        Files.write(path, proxy.getExecutionData(false));\n-        connector.close();\n+        try(JMXConnector connector = JMXConnectorFactory.connect(new JMXServiceURL(serverUrl))) {\n+            IProxy proxy = MBeanServerInvocationHandler.newProxyInstance(\n+                    connector.getMBeanServerConnection(), new ObjectName(\"org.jacoco:type=Runtime\"), IProxy.class,\n+                    false);\n+\n+            Path path = Paths.get(jacocoBuildPath + \"/integTest.exec\");\n+            Files.write(path, proxy.getExecutionData(false));\n+        } catch (Exception ex) {\n+            throw new RuntimeException(\"Failed to dump coverage: \" + ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59e43ac5686abc8cd8a572c111cff65b386878c3"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQyODI4Mw==", "bodyText": "np: isNullOrEmpty in Strings or StringUtils is cleaner.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/393#discussion_r397428283", "createdAt": "2020-03-24T20:06:36Z", "author": {"login": "dai-chen"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/SQLIntegTestCase.java", "diffHunk": "@@ -107,23 +106,25 @@ protected boolean preserveClusterUponCompletion() {\n     }\n \n     @AfterClass\n-    public static void dumpCoverage() throws IOException, MalformedObjectNameException {\n+    public static void dumpCoverage() {\n         // jacoco.dir is set in sqlplugin-coverage.gradle, if it doesn't exist we don't\n         // want to collect coverage so we can return early\n         String jacocoBuildPath = System.getProperty(\"jacoco.dir\");\n-        if (jacocoBuildPath.isEmpty()) {\n+        if (jacocoBuildPath == null || jacocoBuildPath.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59e43ac5686abc8cd8a572c111cff65b386878c3"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b03492594d33bd2d0b55d73119ec9152bf75ba29", "author": {"user": {"login": "zhongnansu", "name": "Zhongnan Su"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b03492594d33bd2d0b55d73119ec9152bf75ba29", "committedDate": "2020-03-24T20:27:41Z", "message": "fix message and clean code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29a3ffd49f17c24a64802f82f7b06bd37ceccd3e", "author": {"user": {"login": "zhongnansu", "name": "Zhongnan Su"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/29a3ffd49f17c24a64802f82f7b06bd37ceccd3e", "committedDate": "2020-03-24T21:24:23Z", "message": "update release doc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 768, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}