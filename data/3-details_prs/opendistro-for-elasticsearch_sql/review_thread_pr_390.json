{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMjQ1OTk5", "number": 390, "reviewThreads": {"totalCount": 42, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMjowNzo0OFrODpsYsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxODoyOTowMFrODxVqCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDQ1NDI0OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMjowNzo0OFrOF5CDCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjo1Mjo0MFrOF5bs2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM0NjY5OA==", "bodyText": "suggestion: tempResponse -> firstResponse", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395346698", "createdAt": "2020-03-19T22:07:48Z", "author": {"login": "penghuo"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.ResponseException;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestsConstants.TEST_INDEX_ACCOUNT;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class CursorIT extends SQLIntegTestCase {\n+\n+    private static final String JDBC = \"jdbc\";\n+\n+    @Override\n+    protected void init() throws Exception {\n+        loadIndex(Index.ACCOUNT);\n+    }\n+\n+    @Test\n+    public void invalidFetchSize() throws IOException {\n+        // invalid fetch_size --> negative(-2), non-numeric(\"hello\")\n+        // acceptable fetch_size --> positive numbers, even in string form \"532.4\"\n+        String query = StringUtils.format(\"SELECT firstname, state FROM %s\", TestsConstants.TEST_INDEX_ACCOUNT);\n+        Response response = null;\n+        try {\n+            String queryResult = executeFetchQuery(query, -2, JDBC);\n+        } catch (ResponseException ex) {\n+            response = ex.getResponse();\n+        }\n+\n+        JSONObject resp = new JSONObject(TestUtils.getResponseBody(response));\n+        assertThat(resp.getInt(\"status\"), equalTo(400));\n+        assertThat(resp.query(\"/error/reason\"), equalTo(\"Invalid SQL query\"));\n+        assertThat(resp.query(\"/error/details\"), equalTo(\"Fetch_size must be greater or equal to 0\"));\n+        assertThat(resp.query(\"/error/type\"), equalTo(\"IllegalArgumentException\"));\n+    }\n+\n+    @Test\n+    public void noPaginationWhenFetchSizeZero() throws IOException {\n+        // fetch_size = 0, default to non-pagination behaviour for simple queries\n+        // this can be checked by checking that cursor is not present, and old default limit applies\n+        String selectQuery = StringUtils.format(\"SELECT firstname, state FROM %s\", TEST_INDEX_ACCOUNT);\n+        JSONObject response = new JSONObject(executeFetchQuery(selectQuery, 0, JDBC));\n+        assertFalse(response.has(\"cursor\"));\n+        assertThat(response.getJSONArray(\"datarows\").length(), equalTo(200));\n+    }\n+\n+    @Test\n+    public void validNumberOfPages() throws IOException {\n+        // the index has 1000 records, with fetch size of 50 we should get 20 pages with no cursor on last page\n+        String selectQuery = StringUtils.format(\"SELECT firstname, state FROM %s\", TEST_INDEX_ACCOUNT);\n+        JSONObject response = new JSONObject(executeFetchQuery(selectQuery, 50, JDBC));\n+        String cursor = response.getString(\"cursor\");\n+        int pageCount = 1;\n+\n+        while (!cursor.isEmpty()) { //this condition also checks that there is no cursor on last page\n+            response = executeCursorQuery(cursor);\n+            cursor = response.optString(\"cursor\");\n+            pageCount++;\n+        }\n+\n+        assertThat(pageCount, equalTo(20));\n+\n+        // using random value here, with fetch size of 28 we should get 36 pages (ceil of 1000/28)\n+        response = new JSONObject(executeFetchQuery(selectQuery, 28, JDBC));\n+        cursor = response.getString(\"cursor\");\n+        System.out.println(response);\n+        pageCount = 1;\n+\n+        while (!cursor.isEmpty()) {\n+            response = executeCursorQuery(cursor);\n+            cursor = response.optString(\"cursor\");\n+            pageCount++;\n+        }\n+        assertThat(pageCount, equalTo(36));\n+    }\n+\n+\n+    @Test\n+    public void validTotalResultWithAndWithoutPagination() throws IOException {\n+        // simple query - accounts index has 1000 docs, using higher limit to get all docs\n+        String selectQuery = StringUtils.format(\"SELECT firstname, state FROM %s \", TEST_INDEX_ACCOUNT );\n+        verifyWithAndWithoutPaginationResponse(selectQuery + \" LIMIT 2000\" , selectQuery , 80);\n+    }\n+\n+    @Test\n+    public void validTotalResultWithAndWithoutPaginationWhereClause() throws IOException {\n+        String selectQuery = StringUtils.format(\n+                \"SELECT firstname, state FROM %s WHERE balance < 25000 AND age > 32\", TEST_INDEX_ACCOUNT\n+        );\n+        verifyWithAndWithoutPaginationResponse(selectQuery + \" LIMIT 2000\" , selectQuery , 17);\n+    }\n+\n+    @Test\n+    public void validTotalResultWithAndWithoutPaginationOrderBy() throws IOException {\n+        String selectQuery = StringUtils.format(\n+                \"SELECT firstname, state FROM %s ORDER BY balance DESC \", TEST_INDEX_ACCOUNT\n+        );\n+        verifyWithAndWithoutPaginationResponse(selectQuery + \" LIMIT 2000\" , selectQuery , 26);\n+    }\n+\n+    @Test\n+    public void validTotalResultWithAndWithoutPaginationWhereAndOrderBy() throws IOException {\n+        String selectQuery = StringUtils.format(\n+                \"SELECT firstname, state FROM %s WHERE balance < 25000 ORDER BY balance ASC \", TEST_INDEX_ACCOUNT\n+        );\n+        verifyWithAndWithoutPaginationResponse(selectQuery + \" LIMIT 2000\" , selectQuery , 80);\n+\n+    }\n+\n+    //TODO: add test cases for nested and subqueries after checking both works as part of query coverage test\n+\n+    @Test\n+    public void noCursorWhenResultsLessThanFetchSize() throws IOException {\n+        // fetch_size is 100, but actual number of rows returned from ElasticSearch is 97\n+        // a scroll context will be opened but will be closed after first page as all records are fetched\n+        String selectQuery = StringUtils.format(\n+                \"SELECT * FROM %s WHERE balance < 25000 AND age > 36 LIMIT 2000\", TEST_INDEX_ACCOUNT\n+        );\n+        JSONObject response = new JSONObject(executeFetchQuery(selectQuery, 100, JDBC));\n+        assertFalse(response.has(\"cursor\"));\n+    }\n+\n+\n+\n+    @Test\n+    public void defaultBehaviorWhenCursorSettingIsDisabled() throws IOException {\n+        updateClusterSettings(new ClusterSetting(PERSISTENT, \"opendistro.sql.cursor.enabled\", \"false\"));\n+        String query = StringUtils.format(\"SELECT firstname, email, state FROM %s\", TEST_INDEX_ACCOUNT);\n+        JSONObject response = new JSONObject(executeFetchQuery(query, 100, JDBC));\n+        assertFalse(response.has(\"cursor\"));\n+\n+        updateClusterSettings(new ClusterSetting(PERSISTENT, \"opendistro.sql.cursor.enabled\", null));\n+        query = StringUtils.format(\"SELECT firstname, email, state FROM %s\", TEST_INDEX_ACCOUNT);\n+        response = new JSONObject(executeFetchQuery(query, 100, JDBC));\n+        assertTrue(response.has(\"cursor\"));\n+\n+        wipeAllClusterSettings();\n+    }\n+\n+\n+    @Test\n+    public void testCursorSettings() throws IOException {\n+        // Assert default cursor settings\n+        JSONObject clusterSettings = getAllClusterSettings();\n+        assertThat(clusterSettings.query(\"/defaults/opendistro.sql.cursor.enabled\"), equalTo(\"true\"));\n+        assertThat(clusterSettings.query(\"/defaults/opendistro.sql.cursor.fetch_size\"), equalTo(\"1000\"));\n+        assertThat(clusterSettings.query(\"/defaults/opendistro.sql.cursor.keep_alive\"), equalTo(\"1m\"));\n+\n+        updateClusterSettings(new ClusterSetting(PERSISTENT, \"opendistro.sql.cursor.enabled\", \"false\"));\n+        updateClusterSettings(new ClusterSetting(TRANSIENT, \"opendistro.sql.cursor.fetch_size\", \"400\"));\n+        updateClusterSettings(new ClusterSetting(PERSISTENT, \"opendistro.sql.cursor.keep_alive\", \"200s\"));\n+\n+        clusterSettings = getAllClusterSettings();\n+        assertThat(clusterSettings.query(\"/persistent/opendistro.sql.cursor.enabled\"), equalTo(\"false\"));\n+        assertThat(clusterSettings.query(\"/transient/opendistro.sql.cursor.fetch_size\"), equalTo(\"400\"));\n+        assertThat(clusterSettings.query(\"/persistent/opendistro.sql.cursor.keep_alive\"), equalTo(\"200s\"));\n+\n+        wipeAllClusterSettings();\n+    }\n+\n+\n+    @Test\n+    public void testDefaultFetchSize() throws IOException {\n+        // the default fetch size is 1000\n+        // using non-nested query here as page will have more rows on flattening\n+        String query = StringUtils.format(\"SELECT firstname, email, state FROM %s\", TEST_INDEX_ACCOUNT);\n+        JSONObject response = new JSONObject(executeFetchLessQuery(query, JDBC));\n+        JSONArray datawRows = response.optJSONArray(\"datarows\");\n+        assertThat(datawRows.length(), equalTo(1000));\n+\n+        updateClusterSettings(new ClusterSetting(TRANSIENT, \"opendistro.sql.cursor.fetch_size\", \"786\"));\n+        response = new JSONObject(executeFetchLessQuery(query, JDBC));\n+        datawRows = response.optJSONArray(\"datarows\");\n+        assertThat(datawRows.length(), equalTo(786));\n+\n+        wipeAllClusterSettings();\n+    }\n+\n+    @Test\n+    public void testCursorCloseAPI() throws IOException {\n+        // multiple invocation of closing cursor should return success\n+        // fetch page using old cursor should throw error\n+        String selectQuery = StringUtils.format(\n+                \"SELECT firstname, state FROM %s WHERE balance > 100 and age < 40\", TEST_INDEX_ACCOUNT);\n+        JSONObject result = new JSONObject(executeFetchQuery(selectQuery, 50, JDBC));\n+        String cursor = result.getString(\"cursor\");\n+\n+        // Retrieving next 10 pages out of remaining 19 pages\n+        for(int i =0 ; i < 10 ; i++) {\n+            result = executeCursorQuery(cursor);\n+            cursor = result.optString(\"cursor\");\n+        }\n+        //Closing the cursor\n+        JSONObject closeResp = executeCursorCloseQuery(cursor);\n+        assertThat(closeResp.getBoolean(\"succeeded\"), equalTo(true));\n+\n+        //Closing the cursor multiple times is idempotent\n+        for(int i =0 ; i < 5 ; i++) {\n+            closeResp = executeCursorCloseQuery(cursor);\n+            assertThat(closeResp.getBoolean(\"succeeded\"), equalTo(true));\n+        }\n+\n+        // using the cursor after its cleared, will throw exception\n+        Response response = null;\n+        try {\n+            JSONObject queryResult = executeCursorQuery(cursor);\n+        } catch (ResponseException ex) {\n+            response = ex.getResponse();\n+        }\n+\n+        JSONObject resp = new JSONObject(TestUtils.getResponseBody(response));\n+        assertThat(resp.getInt(\"status\"), equalTo(404));\n+        assertThat(resp.query(\"/error/reason\"), equalTo(\"all shards failed\"));\n+        assertThat(resp.query(\"/error/caused_by/reason\").toString(), containsString(\"No search context found\"));\n+        assertThat(resp.query(\"/error/type\"), equalTo(\"search_phase_execution_exception\"));\n+    }\n+\n+\n+    @Test\n+    public void invalidCursorIdNotDecodable() throws IOException {\n+        // could be either not decode-able\n+        String randomCursor = \"eyJzY2hlbWEiOlt7Im5hbWUiOiJmaXJzdG5hbWUiLCJ0eXBlIjoidGV4dCJ9LHsibmFtZSI6InN0Y\";\n+\n+        Response response = null;\n+        try {\n+            JSONObject resp = executeCursorQuery(randomCursor);\n+        } catch (ResponseException ex) {\n+            response = ex.getResponse();\n+        }\n+\n+        JSONObject resp = new JSONObject(TestUtils.getResponseBody(response));\n+        assertThat(resp.getInt(\"status\"), equalTo(400));\n+        assertThat(resp.query(\"/error/type\"), equalTo(\"illegal_argument_exception\"));\n+    }\n+\n+    @Test\n+    public void respectLimitPassedInSelectClause() throws IOException {\n+        //TODO:\n+//        String query = StringUtils.format(\"SELECT firstname, email, state FROM %s LIMIT 800\", TEST_INDEX_ACCOUNT);\n+//        String result = executeFetchQuery(query, 50, \"jdbc\");\n+        assertThat(1, equalTo(1));\n+    }\n+\n+\n+    @Test\n+    public void noPaginationWithNonJDBCFormat() throws IOException {\n+        // checking for CSV, RAW format\n+        String query = StringUtils.format(\"SELECT firstname, email, state FROM %s LIMIT 2000\", TEST_INDEX_ACCOUNT);\n+        String csvResult = executeFetchQuery(query, 100, \"csv\");\n+        String[] rows = csvResult.split(\"\\n\");\n+        // all the 1000 records (+1 for header) are retrieved instead of fetch_size number of records\n+        assertThat(rows.length, equalTo(1001));\n+\n+        String rawResult = executeFetchQuery(query, 100, \"raw\");\n+        rows = rawResult.split(\"\\n\");\n+        // all the 1000 records (NO headers) are retrieved instead of fetch_size number of records\n+        assertThat(rows.length, equalTo(1000));\n+    }\n+\n+\n+    public void verifyWithAndWithoutPaginationResponse(String sqlQuery, String cursorQuery, int fetch_size) throws IOException {\n+        // we are only checking here for schema and aatarows\n+        JSONObject withoutCursorResponse = new JSONObject(executeFetchQuery(sqlQuery, 0, JDBC));\n+\n+        JSONObject withCursorResponse = new JSONObject(\"{\\\"schema\\\":[],\\\"datarows\\\":[]}\");\n+        JSONArray schema = withCursorResponse.getJSONArray(\"schema\");\n+        JSONArray dataRows = withCursorResponse.getJSONArray(\"datarows\");\n+\n+        JSONObject tempResponse = new JSONObject(executeFetchQuery(cursorQuery, fetch_size, JDBC));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 291}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2NzAwMQ==", "bodyText": "Keeping it simply response as the variable is being re-used to hold subsequent page results.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395767001", "createdAt": "2020-03-20T16:52:40Z", "author": {"login": "abbashus"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.ResponseException;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestsConstants.TEST_INDEX_ACCOUNT;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class CursorIT extends SQLIntegTestCase {\n+\n+    private static final String JDBC = \"jdbc\";\n+\n+    @Override\n+    protected void init() throws Exception {\n+        loadIndex(Index.ACCOUNT);\n+    }\n+\n+    @Test\n+    public void invalidFetchSize() throws IOException {\n+        // invalid fetch_size --> negative(-2), non-numeric(\"hello\")\n+        // acceptable fetch_size --> positive numbers, even in string form \"532.4\"\n+        String query = StringUtils.format(\"SELECT firstname, state FROM %s\", TestsConstants.TEST_INDEX_ACCOUNT);\n+        Response response = null;\n+        try {\n+            String queryResult = executeFetchQuery(query, -2, JDBC);\n+        } catch (ResponseException ex) {\n+            response = ex.getResponse();\n+        }\n+\n+        JSONObject resp = new JSONObject(TestUtils.getResponseBody(response));\n+        assertThat(resp.getInt(\"status\"), equalTo(400));\n+        assertThat(resp.query(\"/error/reason\"), equalTo(\"Invalid SQL query\"));\n+        assertThat(resp.query(\"/error/details\"), equalTo(\"Fetch_size must be greater or equal to 0\"));\n+        assertThat(resp.query(\"/error/type\"), equalTo(\"IllegalArgumentException\"));\n+    }\n+\n+    @Test\n+    public void noPaginationWhenFetchSizeZero() throws IOException {\n+        // fetch_size = 0, default to non-pagination behaviour for simple queries\n+        // this can be checked by checking that cursor is not present, and old default limit applies\n+        String selectQuery = StringUtils.format(\"SELECT firstname, state FROM %s\", TEST_INDEX_ACCOUNT);\n+        JSONObject response = new JSONObject(executeFetchQuery(selectQuery, 0, JDBC));\n+        assertFalse(response.has(\"cursor\"));\n+        assertThat(response.getJSONArray(\"datarows\").length(), equalTo(200));\n+    }\n+\n+    @Test\n+    public void validNumberOfPages() throws IOException {\n+        // the index has 1000 records, with fetch size of 50 we should get 20 pages with no cursor on last page\n+        String selectQuery = StringUtils.format(\"SELECT firstname, state FROM %s\", TEST_INDEX_ACCOUNT);\n+        JSONObject response = new JSONObject(executeFetchQuery(selectQuery, 50, JDBC));\n+        String cursor = response.getString(\"cursor\");\n+        int pageCount = 1;\n+\n+        while (!cursor.isEmpty()) { //this condition also checks that there is no cursor on last page\n+            response = executeCursorQuery(cursor);\n+            cursor = response.optString(\"cursor\");\n+            pageCount++;\n+        }\n+\n+        assertThat(pageCount, equalTo(20));\n+\n+        // using random value here, with fetch size of 28 we should get 36 pages (ceil of 1000/28)\n+        response = new JSONObject(executeFetchQuery(selectQuery, 28, JDBC));\n+        cursor = response.getString(\"cursor\");\n+        System.out.println(response);\n+        pageCount = 1;\n+\n+        while (!cursor.isEmpty()) {\n+            response = executeCursorQuery(cursor);\n+            cursor = response.optString(\"cursor\");\n+            pageCount++;\n+        }\n+        assertThat(pageCount, equalTo(36));\n+    }\n+\n+\n+    @Test\n+    public void validTotalResultWithAndWithoutPagination() throws IOException {\n+        // simple query - accounts index has 1000 docs, using higher limit to get all docs\n+        String selectQuery = StringUtils.format(\"SELECT firstname, state FROM %s \", TEST_INDEX_ACCOUNT );\n+        verifyWithAndWithoutPaginationResponse(selectQuery + \" LIMIT 2000\" , selectQuery , 80);\n+    }\n+\n+    @Test\n+    public void validTotalResultWithAndWithoutPaginationWhereClause() throws IOException {\n+        String selectQuery = StringUtils.format(\n+                \"SELECT firstname, state FROM %s WHERE balance < 25000 AND age > 32\", TEST_INDEX_ACCOUNT\n+        );\n+        verifyWithAndWithoutPaginationResponse(selectQuery + \" LIMIT 2000\" , selectQuery , 17);\n+    }\n+\n+    @Test\n+    public void validTotalResultWithAndWithoutPaginationOrderBy() throws IOException {\n+        String selectQuery = StringUtils.format(\n+                \"SELECT firstname, state FROM %s ORDER BY balance DESC \", TEST_INDEX_ACCOUNT\n+        );\n+        verifyWithAndWithoutPaginationResponse(selectQuery + \" LIMIT 2000\" , selectQuery , 26);\n+    }\n+\n+    @Test\n+    public void validTotalResultWithAndWithoutPaginationWhereAndOrderBy() throws IOException {\n+        String selectQuery = StringUtils.format(\n+                \"SELECT firstname, state FROM %s WHERE balance < 25000 ORDER BY balance ASC \", TEST_INDEX_ACCOUNT\n+        );\n+        verifyWithAndWithoutPaginationResponse(selectQuery + \" LIMIT 2000\" , selectQuery , 80);\n+\n+    }\n+\n+    //TODO: add test cases for nested and subqueries after checking both works as part of query coverage test\n+\n+    @Test\n+    public void noCursorWhenResultsLessThanFetchSize() throws IOException {\n+        // fetch_size is 100, but actual number of rows returned from ElasticSearch is 97\n+        // a scroll context will be opened but will be closed after first page as all records are fetched\n+        String selectQuery = StringUtils.format(\n+                \"SELECT * FROM %s WHERE balance < 25000 AND age > 36 LIMIT 2000\", TEST_INDEX_ACCOUNT\n+        );\n+        JSONObject response = new JSONObject(executeFetchQuery(selectQuery, 100, JDBC));\n+        assertFalse(response.has(\"cursor\"));\n+    }\n+\n+\n+\n+    @Test\n+    public void defaultBehaviorWhenCursorSettingIsDisabled() throws IOException {\n+        updateClusterSettings(new ClusterSetting(PERSISTENT, \"opendistro.sql.cursor.enabled\", \"false\"));\n+        String query = StringUtils.format(\"SELECT firstname, email, state FROM %s\", TEST_INDEX_ACCOUNT);\n+        JSONObject response = new JSONObject(executeFetchQuery(query, 100, JDBC));\n+        assertFalse(response.has(\"cursor\"));\n+\n+        updateClusterSettings(new ClusterSetting(PERSISTENT, \"opendistro.sql.cursor.enabled\", null));\n+        query = StringUtils.format(\"SELECT firstname, email, state FROM %s\", TEST_INDEX_ACCOUNT);\n+        response = new JSONObject(executeFetchQuery(query, 100, JDBC));\n+        assertTrue(response.has(\"cursor\"));\n+\n+        wipeAllClusterSettings();\n+    }\n+\n+\n+    @Test\n+    public void testCursorSettings() throws IOException {\n+        // Assert default cursor settings\n+        JSONObject clusterSettings = getAllClusterSettings();\n+        assertThat(clusterSettings.query(\"/defaults/opendistro.sql.cursor.enabled\"), equalTo(\"true\"));\n+        assertThat(clusterSettings.query(\"/defaults/opendistro.sql.cursor.fetch_size\"), equalTo(\"1000\"));\n+        assertThat(clusterSettings.query(\"/defaults/opendistro.sql.cursor.keep_alive\"), equalTo(\"1m\"));\n+\n+        updateClusterSettings(new ClusterSetting(PERSISTENT, \"opendistro.sql.cursor.enabled\", \"false\"));\n+        updateClusterSettings(new ClusterSetting(TRANSIENT, \"opendistro.sql.cursor.fetch_size\", \"400\"));\n+        updateClusterSettings(new ClusterSetting(PERSISTENT, \"opendistro.sql.cursor.keep_alive\", \"200s\"));\n+\n+        clusterSettings = getAllClusterSettings();\n+        assertThat(clusterSettings.query(\"/persistent/opendistro.sql.cursor.enabled\"), equalTo(\"false\"));\n+        assertThat(clusterSettings.query(\"/transient/opendistro.sql.cursor.fetch_size\"), equalTo(\"400\"));\n+        assertThat(clusterSettings.query(\"/persistent/opendistro.sql.cursor.keep_alive\"), equalTo(\"200s\"));\n+\n+        wipeAllClusterSettings();\n+    }\n+\n+\n+    @Test\n+    public void testDefaultFetchSize() throws IOException {\n+        // the default fetch size is 1000\n+        // using non-nested query here as page will have more rows on flattening\n+        String query = StringUtils.format(\"SELECT firstname, email, state FROM %s\", TEST_INDEX_ACCOUNT);\n+        JSONObject response = new JSONObject(executeFetchLessQuery(query, JDBC));\n+        JSONArray datawRows = response.optJSONArray(\"datarows\");\n+        assertThat(datawRows.length(), equalTo(1000));\n+\n+        updateClusterSettings(new ClusterSetting(TRANSIENT, \"opendistro.sql.cursor.fetch_size\", \"786\"));\n+        response = new JSONObject(executeFetchLessQuery(query, JDBC));\n+        datawRows = response.optJSONArray(\"datarows\");\n+        assertThat(datawRows.length(), equalTo(786));\n+\n+        wipeAllClusterSettings();\n+    }\n+\n+    @Test\n+    public void testCursorCloseAPI() throws IOException {\n+        // multiple invocation of closing cursor should return success\n+        // fetch page using old cursor should throw error\n+        String selectQuery = StringUtils.format(\n+                \"SELECT firstname, state FROM %s WHERE balance > 100 and age < 40\", TEST_INDEX_ACCOUNT);\n+        JSONObject result = new JSONObject(executeFetchQuery(selectQuery, 50, JDBC));\n+        String cursor = result.getString(\"cursor\");\n+\n+        // Retrieving next 10 pages out of remaining 19 pages\n+        for(int i =0 ; i < 10 ; i++) {\n+            result = executeCursorQuery(cursor);\n+            cursor = result.optString(\"cursor\");\n+        }\n+        //Closing the cursor\n+        JSONObject closeResp = executeCursorCloseQuery(cursor);\n+        assertThat(closeResp.getBoolean(\"succeeded\"), equalTo(true));\n+\n+        //Closing the cursor multiple times is idempotent\n+        for(int i =0 ; i < 5 ; i++) {\n+            closeResp = executeCursorCloseQuery(cursor);\n+            assertThat(closeResp.getBoolean(\"succeeded\"), equalTo(true));\n+        }\n+\n+        // using the cursor after its cleared, will throw exception\n+        Response response = null;\n+        try {\n+            JSONObject queryResult = executeCursorQuery(cursor);\n+        } catch (ResponseException ex) {\n+            response = ex.getResponse();\n+        }\n+\n+        JSONObject resp = new JSONObject(TestUtils.getResponseBody(response));\n+        assertThat(resp.getInt(\"status\"), equalTo(404));\n+        assertThat(resp.query(\"/error/reason\"), equalTo(\"all shards failed\"));\n+        assertThat(resp.query(\"/error/caused_by/reason\").toString(), containsString(\"No search context found\"));\n+        assertThat(resp.query(\"/error/type\"), equalTo(\"search_phase_execution_exception\"));\n+    }\n+\n+\n+    @Test\n+    public void invalidCursorIdNotDecodable() throws IOException {\n+        // could be either not decode-able\n+        String randomCursor = \"eyJzY2hlbWEiOlt7Im5hbWUiOiJmaXJzdG5hbWUiLCJ0eXBlIjoidGV4dCJ9LHsibmFtZSI6InN0Y\";\n+\n+        Response response = null;\n+        try {\n+            JSONObject resp = executeCursorQuery(randomCursor);\n+        } catch (ResponseException ex) {\n+            response = ex.getResponse();\n+        }\n+\n+        JSONObject resp = new JSONObject(TestUtils.getResponseBody(response));\n+        assertThat(resp.getInt(\"status\"), equalTo(400));\n+        assertThat(resp.query(\"/error/type\"), equalTo(\"illegal_argument_exception\"));\n+    }\n+\n+    @Test\n+    public void respectLimitPassedInSelectClause() throws IOException {\n+        //TODO:\n+//        String query = StringUtils.format(\"SELECT firstname, email, state FROM %s LIMIT 800\", TEST_INDEX_ACCOUNT);\n+//        String result = executeFetchQuery(query, 50, \"jdbc\");\n+        assertThat(1, equalTo(1));\n+    }\n+\n+\n+    @Test\n+    public void noPaginationWithNonJDBCFormat() throws IOException {\n+        // checking for CSV, RAW format\n+        String query = StringUtils.format(\"SELECT firstname, email, state FROM %s LIMIT 2000\", TEST_INDEX_ACCOUNT);\n+        String csvResult = executeFetchQuery(query, 100, \"csv\");\n+        String[] rows = csvResult.split(\"\\n\");\n+        // all the 1000 records (+1 for header) are retrieved instead of fetch_size number of records\n+        assertThat(rows.length, equalTo(1001));\n+\n+        String rawResult = executeFetchQuery(query, 100, \"raw\");\n+        rows = rawResult.split(\"\\n\");\n+        // all the 1000 records (NO headers) are retrieved instead of fetch_size number of records\n+        assertThat(rows.length, equalTo(1000));\n+    }\n+\n+\n+    public void verifyWithAndWithoutPaginationResponse(String sqlQuery, String cursorQuery, int fetch_size) throws IOException {\n+        // we are only checking here for schema and aatarows\n+        JSONObject withoutCursorResponse = new JSONObject(executeFetchQuery(sqlQuery, 0, JDBC));\n+\n+        JSONObject withCursorResponse = new JSONObject(\"{\\\"schema\\\":[],\\\"datarows\\\":[]}\");\n+        JSONArray schema = withCursorResponse.getJSONArray(\"schema\");\n+        JSONArray dataRows = withCursorResponse.getJSONArray(\"datarows\");\n+\n+        JSONObject tempResponse = new JSONObject(executeFetchQuery(cursorQuery, fetch_size, JDBC));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM0NjY5OA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 291}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDQ5ODk4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMjoyNTo0NVrOF5CenQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMDo0MTo0M1rOF5E5sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1Mzc1Nw==", "bodyText": "delete it", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395353757", "createdAt": "2020-03-19T22:25:45Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "diffHunk": "@@ -57,6 +68,16 @@ public String getSql() {\n         return this.sql;\n     }\n \n+    public String cursor() {\n+        return this.cursor;\n+//        return (jsonContent == null) ? null : jsonContent.getString(SqlRequestFactory.SQL_CURSOR_FIELD_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5MzQ1Ng==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395393456", "createdAt": "2020-03-20T00:41:43Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "diffHunk": "@@ -57,6 +68,16 @@ public String getSql() {\n         return this.sql;\n     }\n \n+    public String cursor() {\n+        return this.cursor;\n+//        return (jsonContent == null) ? null : jsonContent.getString(SqlRequestFactory.SQL_CURSOR_FIELD_NAME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1Mzc1Nw=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDUwNzYwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMjoyOToyMlrOF5Cj2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQwMTozMjo1MFrOGEJVKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1NTA5OA==", "bodyText": "null or 0?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395355098", "createdAt": "2020-03-19T22:29:22Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "diffHunk": "@@ -59,16 +61,36 @@ private static SqlRequest parseSqlRequestFromPayload(RestRequest restRequest) {\n         JSONObject jsonContent;\n         try {\n             jsonContent = new JSONObject(content);\n+            if (jsonContent.has(SQL_CURSOR_FIELD_NAME)) {\n+                return new SqlRequest(jsonContent.getString(SQL_CURSOR_FIELD_NAME));\n+            }\n         } catch (JSONException e) {\n             throw new IllegalArgumentException(\"Failed to parse request payload\", e);\n         }\n         String sql = jsonContent.getString(SQL_FIELD_NAME);\n+\n         if (jsonContent.has(PARAM_FIELD_NAME)) { // is a PreparedStatement\n             JSONArray paramArray = jsonContent.getJSONArray(PARAM_FIELD_NAME);\n             List<PreparedStatementRequest.PreparedStatementParameter> parameters = parseParameters(paramArray);\n             return new PreparedStatementRequest(sql, jsonContent, parameters);\n         }\n-        return new SqlRequest(sql, jsonContent);\n+        return new SqlRequest(sql, validateAndGetFetchSize(jsonContent), jsonContent);\n+    }\n+\n+\n+    private static Integer validateAndGetFetchSize(JSONObject jsonContent) {\n+        Integer fetchSize = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NjA0OQ==", "bodyText": "+1", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395386049", "createdAt": "2020-03-20T00:09:52Z", "author": {"login": "davidcui1225"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "diffHunk": "@@ -59,16 +61,36 @@ private static SqlRequest parseSqlRequestFromPayload(RestRequest restRequest) {\n         JSONObject jsonContent;\n         try {\n             jsonContent = new JSONObject(content);\n+            if (jsonContent.has(SQL_CURSOR_FIELD_NAME)) {\n+                return new SqlRequest(jsonContent.getString(SQL_CURSOR_FIELD_NAME));\n+            }\n         } catch (JSONException e) {\n             throw new IllegalArgumentException(\"Failed to parse request payload\", e);\n         }\n         String sql = jsonContent.getString(SQL_FIELD_NAME);\n+\n         if (jsonContent.has(PARAM_FIELD_NAME)) { // is a PreparedStatement\n             JSONArray paramArray = jsonContent.getJSONArray(PARAM_FIELD_NAME);\n             List<PreparedStatementRequest.PreparedStatementParameter> parameters = parseParameters(paramArray);\n             return new PreparedStatementRequest(sql, jsonContent, parameters);\n         }\n-        return new SqlRequest(sql, jsonContent);\n+        return new SqlRequest(sql, validateAndGetFetchSize(jsonContent), jsonContent);\n+    }\n+\n+\n+    private static Integer validateAndGetFetchSize(JSONObject jsonContent) {\n+        Integer fetchSize = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1NTA5OA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5NDE0OQ==", "bodyText": "null to imply that fetch_size was not passed in query. In DefaultQueryAction, if fetch_size == null, we will use the fetch_size value from cluster settings.\nfetch_size == 0 will imply falling back to non-paginated behavior.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395394149", "createdAt": "2020-03-20T00:45:11Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "diffHunk": "@@ -59,16 +61,36 @@ private static SqlRequest parseSqlRequestFromPayload(RestRequest restRequest) {\n         JSONObject jsonContent;\n         try {\n             jsonContent = new JSONObject(content);\n+            if (jsonContent.has(SQL_CURSOR_FIELD_NAME)) {\n+                return new SqlRequest(jsonContent.getString(SQL_CURSOR_FIELD_NAME));\n+            }\n         } catch (JSONException e) {\n             throw new IllegalArgumentException(\"Failed to parse request payload\", e);\n         }\n         String sql = jsonContent.getString(SQL_FIELD_NAME);\n+\n         if (jsonContent.has(PARAM_FIELD_NAME)) { // is a PreparedStatement\n             JSONArray paramArray = jsonContent.getJSONArray(PARAM_FIELD_NAME);\n             List<PreparedStatementRequest.PreparedStatementParameter> parameters = parseParameters(paramArray);\n             return new PreparedStatementRequest(sql, jsonContent, parameters);\n         }\n-        return new SqlRequest(sql, jsonContent);\n+        return new SqlRequest(sql, validateAndGetFetchSize(jsonContent), jsonContent);\n+    }\n+\n+\n+    private static Integer validateAndGetFetchSize(JSONObject jsonContent) {\n+        Integer fetchSize = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1NTA5OA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxMDY0Nw==", "bodyText": "I suggest to use Optional instead of null value in this case.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406310647", "createdAt": "2020-04-09T16:01:43Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "diffHunk": "@@ -59,16 +61,36 @@ private static SqlRequest parseSqlRequestFromPayload(RestRequest restRequest) {\n         JSONObject jsonContent;\n         try {\n             jsonContent = new JSONObject(content);\n+            if (jsonContent.has(SQL_CURSOR_FIELD_NAME)) {\n+                return new SqlRequest(jsonContent.getString(SQL_CURSOR_FIELD_NAME));\n+            }\n         } catch (JSONException e) {\n             throw new IllegalArgumentException(\"Failed to parse request payload\", e);\n         }\n         String sql = jsonContent.getString(SQL_FIELD_NAME);\n+\n         if (jsonContent.has(PARAM_FIELD_NAME)) { // is a PreparedStatement\n             JSONArray paramArray = jsonContent.getJSONArray(PARAM_FIELD_NAME);\n             List<PreparedStatementRequest.PreparedStatementParameter> parameters = parseParameters(paramArray);\n             return new PreparedStatementRequest(sql, jsonContent, parameters);\n         }\n-        return new SqlRequest(sql, jsonContent);\n+        return new SqlRequest(sql, validateAndGetFetchSize(jsonContent), jsonContent);\n+    }\n+\n+\n+    private static Integer validateAndGetFetchSize(JSONObject jsonContent) {\n+        Integer fetchSize = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1NTA5OA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzAwMDM2Mw==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407000363", "createdAt": "2020-04-11T01:32:50Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "diffHunk": "@@ -59,16 +61,36 @@ private static SqlRequest parseSqlRequestFromPayload(RestRequest restRequest) {\n         JSONObject jsonContent;\n         try {\n             jsonContent = new JSONObject(content);\n+            if (jsonContent.has(SQL_CURSOR_FIELD_NAME)) {\n+                return new SqlRequest(jsonContent.getString(SQL_CURSOR_FIELD_NAME));\n+            }\n         } catch (JSONException e) {\n             throw new IllegalArgumentException(\"Failed to parse request payload\", e);\n         }\n         String sql = jsonContent.getString(SQL_FIELD_NAME);\n+\n         if (jsonContent.has(PARAM_FIELD_NAME)) { // is a PreparedStatement\n             JSONArray paramArray = jsonContent.getJSONArray(PARAM_FIELD_NAME);\n             List<PreparedStatementRequest.PreparedStatementParameter> parameters = parseParameters(paramArray);\n             return new PreparedStatementRequest(sql, jsonContent, parameters);\n         }\n-        return new SqlRequest(sql, jsonContent);\n+        return new SqlRequest(sql, validateAndGetFetchSize(jsonContent), jsonContent);\n+    }\n+\n+\n+    private static Integer validateAndGetFetchSize(JSONObject jsonContent) {\n+        Integer fetchSize = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1NTA5OA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDUxODA5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMjozMzo1NlrOF5Cqig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMDo1MTozOFrOF5FBsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1NjgxMA==", "bodyText": "In which case the exception will been throw? Does it been tested?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395356810", "createdAt": "2020-03-19T22:33:56Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "diffHunk": "@@ -59,16 +61,36 @@ private static SqlRequest parseSqlRequestFromPayload(RestRequest restRequest) {\n         JSONObject jsonContent;\n         try {\n             jsonContent = new JSONObject(content);\n+            if (jsonContent.has(SQL_CURSOR_FIELD_NAME)) {\n+                return new SqlRequest(jsonContent.getString(SQL_CURSOR_FIELD_NAME));\n+            }\n         } catch (JSONException e) {\n             throw new IllegalArgumentException(\"Failed to parse request payload\", e);\n         }\n         String sql = jsonContent.getString(SQL_FIELD_NAME);\n+\n         if (jsonContent.has(PARAM_FIELD_NAME)) { // is a PreparedStatement\n             JSONArray paramArray = jsonContent.getJSONArray(PARAM_FIELD_NAME);\n             List<PreparedStatementRequest.PreparedStatementParameter> parameters = parseParameters(paramArray);\n             return new PreparedStatementRequest(sql, jsonContent, parameters);\n         }\n-        return new SqlRequest(sql, jsonContent);\n+        return new SqlRequest(sql, validateAndGetFetchSize(jsonContent), jsonContent);\n+    }\n+\n+\n+    private static Integer validateAndGetFetchSize(JSONObject jsonContent) {\n+        Integer fetchSize = null;\n+        try {\n+            if (jsonContent.has(SQL_FETCH_FIELD_NAME)) {\n+                fetchSize = jsonContent.getInt(SQL_FETCH_FIELD_NAME);\n+                if (fetchSize < 0) {\n+                    throw new IllegalArgumentException(\"Fetch_size must be greater or equal to 0\");\n+                }\n+            }\n+        } catch (JSONException e) {\n+            throw new IllegalArgumentException(\"Failed to parse field [\" + SQL_FETCH_FIELD_NAME +\"]\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5NTUwNA==", "bodyText": "This exception will be thrown when passing non-numeric value to fetch_size , for example \"fetch_size\" : \"hello world\". An IllegalArgumentException is thrown to be caught as client error (400) in RestSqlAction.java. Will add a test for this.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395395504", "createdAt": "2020-03-20T00:51:38Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "diffHunk": "@@ -59,16 +61,36 @@ private static SqlRequest parseSqlRequestFromPayload(RestRequest restRequest) {\n         JSONObject jsonContent;\n         try {\n             jsonContent = new JSONObject(content);\n+            if (jsonContent.has(SQL_CURSOR_FIELD_NAME)) {\n+                return new SqlRequest(jsonContent.getString(SQL_CURSOR_FIELD_NAME));\n+            }\n         } catch (JSONException e) {\n             throw new IllegalArgumentException(\"Failed to parse request payload\", e);\n         }\n         String sql = jsonContent.getString(SQL_FIELD_NAME);\n+\n         if (jsonContent.has(PARAM_FIELD_NAME)) { // is a PreparedStatement\n             JSONArray paramArray = jsonContent.getJSONArray(PARAM_FIELD_NAME);\n             List<PreparedStatementRequest.PreparedStatementParameter> parameters = parseParameters(paramArray);\n             return new PreparedStatementRequest(sql, jsonContent, parameters);\n         }\n-        return new SqlRequest(sql, jsonContent);\n+        return new SqlRequest(sql, validateAndGetFetchSize(jsonContent), jsonContent);\n+    }\n+\n+\n+    private static Integer validateAndGetFetchSize(JSONObject jsonContent) {\n+        Integer fetchSize = null;\n+        try {\n+            if (jsonContent.has(SQL_FETCH_FIELD_NAME)) {\n+                fetchSize = jsonContent.getInt(SQL_FETCH_FIELD_NAME);\n+                if (fetchSize < 0) {\n+                    throw new IllegalArgumentException(\"Fetch_size must be greater or equal to 0\");\n+                }\n+            }\n+        } catch (JSONException e) {\n+            throw new IllegalArgumentException(\"Failed to parse field [\" + SQL_FETCH_FIELD_NAME +\"]\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1NjgxMA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDUyMzM4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/SqlSettings.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMjozNjo0N1rOF5CuGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODowNjo1MFrOGDjsOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1NzcyMw==", "bodyText": "Have you updated the doc in PluginSettingIT?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395357723", "createdAt": "2020-03-19T22:36:47Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/SqlSettings.java", "diffHunk": "@@ -68,6 +73,13 @@ public SqlSettings() {\n         settings.put(METRICS_ROLLING_INTERVAL, Setting.longSetting(METRICS_ROLLING_INTERVAL, 60L, 1L,\n                 NodeScope, Dynamic));\n \n+        // Settings for cursor\n+        settings.put(CURSOR_ENABLED, Setting.boolSetting(CURSOR_ENABLED, true, NodeScope, Dynamic));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2MjM1MA==", "bodyText": "Will do.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395362350", "createdAt": "2020-03-19T22:50:00Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/SqlSettings.java", "diffHunk": "@@ -68,6 +73,13 @@ public SqlSettings() {\n         settings.put(METRICS_ROLLING_INTERVAL, Setting.longSetting(METRICS_ROLLING_INTERVAL, 60L, 1L,\n                 NodeScope, Dynamic));\n \n+        // Settings for cursor\n+        settings.put(CURSOR_ENABLED, Setting.boolSetting(CURSOR_ENABLED, true, NodeScope, Dynamic));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1NzcyMw=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM4MzY3NQ==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406383675", "createdAt": "2020-04-09T18:06:50Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/SqlSettings.java", "diffHunk": "@@ -68,6 +73,13 @@ public SqlSettings() {\n         settings.put(METRICS_ROLLING_INTERVAL, Setting.longSetting(METRICS_ROLLING_INTERVAL, 60L, 1L,\n                 NodeScope, Dynamic));\n \n+        // Settings for cursor\n+        settings.put(CURSOR_ENABLED, Setting.boolSetting(CURSOR_ENABLED, true, NodeScope, Dynamic));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1NzcyMw=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDU1ODY0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorActionRequestRestExecutorFactory.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMjo1MjozNFrOF5DDwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDo1NTowOVrOGDcdlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2MzI2NA==", "bodyText": "what happen if it is an explain request", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395363264", "createdAt": "2020-03-19T22:52:34Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorActionRequestRestExecutorFactory.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import org.elasticsearch.rest.RestRequest;\n+\n+public class CursorActionRequestRestExecutorFactory {\n+    //TODO: add javadocs, see RestExecutor\n+\n+    public static CursorRestExecutor createExecutor(RestRequest request, String cursor, Format format) {\n+        if (isCursorCloseRequest(request)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2NzY2OQ==", "bodyText": "As per plugin usage ,  _explain does make sense with cursor. Will handle this case.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395367669", "createdAt": "2020-03-19T23:05:32Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorActionRequestRestExecutorFactory.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import org.elasticsearch.rest.RestRequest;\n+\n+public class CursorActionRequestRestExecutorFactory {\n+    //TODO: add javadocs, see RestExecutor\n+\n+    public static CursorRestExecutor createExecutor(RestRequest request, String cursor, Format format) {\n+        if (isCursorCloseRequest(request)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2MzI2NA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2NTIzNg==", "bodyText": "Handled this case. Added integration test for same.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406265236", "createdAt": "2020-04-09T14:55:09Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorActionRequestRestExecutorFactory.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import org.elasticsearch.rest.RestRequest;\n+\n+public class CursorActionRequestRestExecutorFactory {\n+    //TODO: add javadocs, see RestExecutor\n+\n+    public static CursorRestExecutor createExecutor(RestRequest request, String cursor, Format format) {\n+        if (isCursorCloseRequest(request)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2MzI2NA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDU2MDc2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorRestExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMjo1MzozMFrOF5DFEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzoyMTowNlrOF5DoHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2MzYwMw==", "bodyText": "Doc", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395363603", "createdAt": "2020-03-19T22:53:30Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorRestExecutor.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.RestChannel;\n+\n+import java.util.Map;\n+\n+public interface CursorRestExecutor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MjU3NA==", "bodyText": "Will add.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395372574", "createdAt": "2020-03-19T23:21:06Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorRestExecutor.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.RestChannel;\n+\n+import java.util.Map;\n+\n+public interface CursorRestExecutor {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2MzYwMw=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDU3OTA5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorAsyncRestExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzowMTozOVrOF5DQPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODowNzoyMFrOGDjtMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2NjQ2MQ==", "bodyText": "What is the function of this? If it is not supported, just thrown an exception.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395366461", "createdAt": "2020-03-19T23:01:39Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorAsyncRestExecutor.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.query.QueryAction;\n+import com.amazon.opendistroforelasticsearch.sql.query.join.BackOffRetryStrategy;\n+import com.amazon.opendistroforelasticsearch.sql.utils.LogUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.QUERY_SLOWLOG;\n+\n+public class CursorAsyncRestExecutor implements CursorRestExecutor {\n+    /**\n+     * Custom thread pool name managed by ES\n+     */\n+    public static final String SQL_WORKER_THREAD_POOL_NAME = \"sql-worker\";\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorAsyncRestExecutor.class);\n+\n+    private static final Predicate<QueryAction> ALL_ACTION_IS_BLOCKING = anyAction -> true;\n+\n+    /**\n+     * Delegated rest executor to async\n+     */\n+    private final CursorRestExecutor executor;\n+\n+    /**\n+     * Request type that expect to async to avoid blocking\n+     */\n+    private final Predicate<QueryAction> isBlocking;\n+\n+    CursorAsyncRestExecutor(CursorRestExecutor executor) {\n+        this(executor, ALL_ACTION_IS_BLOCKING);\n+    }\n+\n+    CursorAsyncRestExecutor(CursorRestExecutor executor, Predicate<QueryAction> isBlocking) {\n+        this.executor = executor;\n+        this.isBlocking = isBlocking;\n+    }\n+\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        LOG.info(\"executing something inside CursorAsyncRestExecutor execute \");\n+        async(client, params, channel);\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM4MzkyMw==", "bodyText": "Removed this method.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406383923", "createdAt": "2020-04-09T18:07:20Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorAsyncRestExecutor.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.query.QueryAction;\n+import com.amazon.opendistroforelasticsearch.sql.query.join.BackOffRetryStrategy;\n+import com.amazon.opendistroforelasticsearch.sql.utils.LogUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.QUERY_SLOWLOG;\n+\n+public class CursorAsyncRestExecutor implements CursorRestExecutor {\n+    /**\n+     * Custom thread pool name managed by ES\n+     */\n+    public static final String SQL_WORKER_THREAD_POOL_NAME = \"sql-worker\";\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorAsyncRestExecutor.class);\n+\n+    private static final Predicate<QueryAction> ALL_ACTION_IS_BLOCKING = anyAction -> true;\n+\n+    /**\n+     * Delegated rest executor to async\n+     */\n+    private final CursorRestExecutor executor;\n+\n+    /**\n+     * Request type that expect to async to avoid blocking\n+     */\n+    private final Predicate<QueryAction> isBlocking;\n+\n+    CursorAsyncRestExecutor(CursorRestExecutor executor) {\n+        this(executor, ALL_ACTION_IS_BLOCKING);\n+    }\n+\n+    CursorAsyncRestExecutor(CursorRestExecutor executor, Predicate<QueryAction> isBlocking) {\n+        this.executor = executor;\n+        this.isBlocking = isBlocking;\n+    }\n+\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        LOG.info(\"executing something inside CursorAsyncRestExecutor execute \");\n+        async(client, params, channel);\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2NjQ2MQ=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDU4NTIwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorAsyncRestExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzowNDo0OVrOF5DUBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzoyMDowOVrOF5Dm_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2NzQyOQ==", "bodyText": "It almost as same as AsyncRestExecutor. Any improvement?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395367429", "createdAt": "2020-03-19T23:04:49Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorAsyncRestExecutor.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.query.QueryAction;\n+import com.amazon.opendistroforelasticsearch.sql.query.join.BackOffRetryStrategy;\n+import com.amazon.opendistroforelasticsearch.sql.utils.LogUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.QUERY_SLOWLOG;\n+\n+public class CursorAsyncRestExecutor implements CursorRestExecutor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MjI4Nw==", "bodyText": "The signature of execute methods in CursorRestExecutor does not take QueryAction as parameter. Will try to combine them in one.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395372287", "createdAt": "2020-03-19T23:20:09Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorAsyncRestExecutor.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.query.QueryAction;\n+import com.amazon.opendistroforelasticsearch.sql.query.join.BackOffRetryStrategy;\n+import com.amazon.opendistroforelasticsearch.sql.utils.LogUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.function.Predicate;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.QUERY_SLOWLOG;\n+\n+public class CursorAsyncRestExecutor implements CursorRestExecutor {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2NzQyOQ=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDU4NzgwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzowNjowM1rOF5DVog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjo0Mjo1MFrOGDHrhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2Nzg0Mg==", "bodyText": "Log.error?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395367842", "createdAt": "2020-03-19T23:06:03Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MjQzNQ==", "bodyText": "Will add.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395372435", "createdAt": "2020-03-19T23:20:36Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2Nzg0Mg=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyNDc0Mg==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r405924742", "createdAt": "2020-04-09T02:42:50Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2Nzg0Mg=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDU5NDI0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzowOToxNVrOF5DZnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjo0MjozNlrOGDHrPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2ODg2MA==", "bodyText": "Add separate class to encapsulate is much better.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395368860", "createdAt": "2020-03-19T23:09:15Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        String decodedCursorContext = new String(Base64.getDecoder().decode(cursorId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyNDY2OQ==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r405924669", "createdAt": "2020-04-09T02:42:36Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        String decodedCursorContext = new String(Base64.getDecoder().decode(cursorId));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2ODg2MA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDYwNzYzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzoxNTo1OVrOF5DiBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjo0MjoyNFrOGDHrDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MTAxNA==", "bodyText": "Instead of using JSONObject, I suggest to abstract cursor as JavaBean.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395371014", "createdAt": "2020-03-19T23:15:59Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        String decodedCursorContext = new String(Base64.getDecoder().decode(cursorId));\n+        JSONObject cursorJson = new JSONObject(decodedCursorContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyNDYyMA==", "bodyText": "Abstracted all cursor encode/decode logic via Cursor interface and individual implementation.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r405924620", "createdAt": "2020-04-09T02:42:24Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        String decodedCursorContext = new String(Base64.getDecoder().decode(cursorId));\n+        JSONObject cursorJson = new JSONObject(decodedCursorContext);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MTAxNA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDYxNTA0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzoxOTo0NlrOF5DmmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzoyNDo0MlrOF5DsNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MjE4NA==", "bodyText": "Why the response is different?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395372184", "createdAt": "2020-03-19T23:19:46Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        String decodedCursorContext = new String(Base64.getDecoder().decode(cursorId));\n+        JSONObject cursorJson = new JSONObject(decodedCursorContext);\n+\n+        String type = cursorJson.optString(\"type\", null); // see if it is a good case to use Optionals\n+        CursorType cursorType = null;\n+\n+        if (type != null) {\n+            cursorType = CursorType.valueOf(type);\n+        }\n+\n+        if (cursorType!=null) {\n+            switch(cursorType) {\n+                case DEFAULT:\n+                    return handleDefaultCursorCloseRequest(client, cursorJson);\n+                case AGGREGATION:\n+                    return handleAggregationCursorCloseRequest(client, cursorJson);\n+                case JOIN:\n+                    return handleJoinCursorCloseRequest(client, cursorJson);\n+                default: throw new VerificationException(\"Unsupported cursor\");\n+            }\n+        }\n+\n+        throw new VerificationException(\"Invalid cursor\");\n+    }\n+\n+    private String handleDefaultCursorCloseRequest(Client client, JSONObject cursorContext) {\n+        String scrollId = cursorContext.getString(\"scrollId\");\n+        ClearScrollResponse clearScrollResponse = client.prepareClearScroll().addScrollId(scrollId).get();\n+        if (clearScrollResponse.isSucceeded()) {\n+            return SUCCEEDED_TRUE;\n+        } else {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            return SUCCEEDED_FALSE;\n+        }\n+    }\n+\n+    private String handleAggregationCursorCloseRequest(Client client, JSONObject cursorContext) {\n+        return SUCCEEDED_TRUE;\n+    }\n+\n+    private String handleJoinCursorCloseRequest(Client client, JSONObject cursorContext) {\n+        return SUCCEEDED_FALSE;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MzYyMw==", "bodyText": "Bad copy, will make it consistent.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395373623", "createdAt": "2020-03-19T23:24:42Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        String decodedCursorContext = new String(Base64.getDecoder().decode(cursorId));\n+        JSONObject cursorJson = new JSONObject(decodedCursorContext);\n+\n+        String type = cursorJson.optString(\"type\", null); // see if it is a good case to use Optionals\n+        CursorType cursorType = null;\n+\n+        if (type != null) {\n+            cursorType = CursorType.valueOf(type);\n+        }\n+\n+        if (cursorType!=null) {\n+            switch(cursorType) {\n+                case DEFAULT:\n+                    return handleDefaultCursorCloseRequest(client, cursorJson);\n+                case AGGREGATION:\n+                    return handleAggregationCursorCloseRequest(client, cursorJson);\n+                case JOIN:\n+                    return handleJoinCursorCloseRequest(client, cursorJson);\n+                default: throw new VerificationException(\"Unsupported cursor\");\n+            }\n+        }\n+\n+        throw new VerificationException(\"Invalid cursor\");\n+    }\n+\n+    private String handleDefaultCursorCloseRequest(Client client, JSONObject cursorContext) {\n+        String scrollId = cursorContext.getString(\"scrollId\");\n+        ClearScrollResponse clearScrollResponse = client.prepareClearScroll().addScrollId(scrollId).get();\n+        if (clearScrollResponse.isSucceeded()) {\n+            return SUCCEEDED_TRUE;\n+        } else {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            return SUCCEEDED_FALSE;\n+        }\n+    }\n+\n+    private String handleAggregationCursorCloseRequest(Client client, JSONObject cursorContext) {\n+        return SUCCEEDED_TRUE;\n+    }\n+\n+    private String handleJoinCursorCloseRequest(Client client, JSONObject cursorContext) {\n+        return SUCCEEDED_FALSE;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MjE4NA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDYyMzU3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzoyNDoxNFrOF5Drsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjo1MzowM1rOGEs-lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MzQ5MQ==", "bodyText": "Should we also catch SQLFeatureNotSupportedException in here?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395373491", "createdAt": "2020-03-19T23:24:14Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.sql.SQLFeatureNotSupportedException;\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4NDQwNg==", "bodyText": "Not needed after refactoring.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407584406", "createdAt": "2020-04-13T16:53:03Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.sql.SQLFeatureNotSupportedException;\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3MzQ5MQ=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDY1MTUwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzozOTozM1rOF5D9Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxODowNToyMFrOGEBsJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3NzkzOQ==", "bodyText": "could be removed.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395377939", "createdAt": "2020-03-19T23:39:33Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -153,6 +198,36 @@ private String outputInTableFormat() {\n         return null;\n     }\n \n+\n+    public String cursorFormat() {\n+        if (status == OK_STATUS && cursorContext!=null) {\n+            switch (formatType) {\n+                case \"jdbc\":\n+                    return cursorOutputInJDBCFormat();\n+                case \"table\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3ODUwNQ==", "bodyText": "Which part- case table?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395378505", "createdAt": "2020-03-19T23:41:40Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -153,6 +198,36 @@ private String outputInTableFormat() {\n         return null;\n     }\n \n+\n+    public String cursorFormat() {\n+        if (status == OK_STATUS && cursorContext!=null) {\n+            switch (formatType) {\n+                case \"jdbc\":\n+                    return cursorOutputInJDBCFormat();\n+                case \"table\":", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3NzkzOQ=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyMzE4OA==", "bodyText": "Yes, do we support table?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406323188", "createdAt": "2020-04-09T16:22:19Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -153,6 +198,36 @@ private String outputInTableFormat() {\n         return null;\n     }\n \n+\n+    public String cursorFormat() {\n+        if (status == OK_STATUS && cursorContext!=null) {\n+            switch (formatType) {\n+                case \"jdbc\":\n+                    return cursorOutputInJDBCFormat();\n+                case \"table\":", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3NzkzOQ=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg3NTE3NQ==", "bodyText": "Removed.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406875175", "createdAt": "2020-04-10T18:05:20Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -153,6 +198,36 @@ private String outputInTableFormat() {\n         return null;\n     }\n \n+\n+    public String cursorFormat() {\n+        if (status == OK_STATUS && cursorContext!=null) {\n+            switch (formatType) {\n+                case \"jdbc\":\n+                    return cursorOutputInJDBCFormat();\n+                case \"table\":", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM3NzkzOQ=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDY4MTE5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ResultSet.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzo1Njo0MFrOF5EPcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjo0MDo0NFrOGDHppA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MjY0Mg==", "bodyText": "return null or cursor?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395382642", "createdAt": "2020-03-19T23:56:40Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ResultSet.java", "diffHunk": "@@ -48,4 +50,8 @@ protected boolean matchesPattern(String string, String pattern) {\n         Matcher matcher = p.matcher(string);\n         return matcher.find();\n     }\n+\n+    public String getCursor() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyNDI2MA==", "bodyText": "Removed this method as part of refactoring.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r405924260", "createdAt": "2020-04-09T02:40:44Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ResultSet.java", "diffHunk": "@@ -48,4 +50,8 @@ protected boolean matchesPattern(String string, String pattern) {\n         Matcher matcher = p.matcher(string);\n         return matcher.find();\n     }\n+\n+    public String getCursor() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MjY0Mg=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDY5NDExOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMDowNDoyOFrOF5EXkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjo0MDoxNFrOGDHpNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NDcyMg==", "bodyText": "FeatureNotSupportedExecption?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395384722", "createdAt": "2020-03-20T00:04:28Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -203,4 +278,79 @@ private JSONArray dataEntry(Row dataRow, Schema schema) {\n         }\n         return entry;\n     }\n-}\n+\n+    public void generateCursorId() {\n+        // TODO: only to be used for generating cursor from first page\n+        // for subsequent pages the cursorType and cursor should be set from\n+        switch(cursorType) {\n+            case DEFAULT:\n+                int pages_left = pagesLeft();\n+                if (options.get(\"scrollId\") != null && pages_left > 0) {\n+                    JSONObject cursorJson = new JSONObject();\n+                    cursorJson.put(\"type\", cursorType.name());\n+                    cursorJson.put(\"schema\", getSchemaAsJson());\n+                    cursorJson.put(\"scrollId\", options.get(\"scrollId\"));\n+                    cursorJson.put(\"left\", pagesLeft());\n+                    setIndexNameInCursor(cursorJson);\n+                    setFieldAliasMapInCursor(cursorJson);\n+                    cursor = encodeCursorContext(cursorJson);\n+\n+                } else {\n+                    // explicitly setting this to null to avoid any ambiguity\n+                    cursor = null;\n+                }\n+                options.remove(\"scrollId\");\n+                options.remove(\"fetch_size\");\n+                break;\n+            case AGGREGATION:\n+                throw new ElasticsearchException(\"Cursor not yet supported for GROUP BY queries\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 179}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyNDE1MA==", "bodyText": "Removed this logic as part of refactoring.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r405924150", "createdAt": "2020-04-09T02:40:14Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -203,4 +278,79 @@ private JSONArray dataEntry(Row dataRow, Schema schema) {\n         }\n         return entry;\n     }\n-}\n+\n+    public void generateCursorId() {\n+        // TODO: only to be used for generating cursor from first page\n+        // for subsequent pages the cursorType and cursor should be set from\n+        switch(cursorType) {\n+            case DEFAULT:\n+                int pages_left = pagesLeft();\n+                if (options.get(\"scrollId\") != null && pages_left > 0) {\n+                    JSONObject cursorJson = new JSONObject();\n+                    cursorJson.put(\"type\", cursorType.name());\n+                    cursorJson.put(\"schema\", getSchemaAsJson());\n+                    cursorJson.put(\"scrollId\", options.get(\"scrollId\"));\n+                    cursorJson.put(\"left\", pagesLeft());\n+                    setIndexNameInCursor(cursorJson);\n+                    setFieldAliasMapInCursor(cursorJson);\n+                    cursor = encodeCursorContext(cursorJson);\n+\n+                } else {\n+                    // explicitly setting this to null to avoid any ambiguity\n+                    cursor = null;\n+                }\n+                options.remove(\"scrollId\");\n+                options.remove(\"fetch_size\");\n+                break;\n+            case AGGREGATION:\n+                throw new ElasticsearchException(\"Cursor not yet supported for GROUP BY queries\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NDcyMg=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 179}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDY5Njc3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMDowNjoxNlrOF5EZQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjozOToxMlrOGDHoOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NTE1Mw==", "bodyText": "why remove?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395385153", "createdAt": "2020-03-20T00:06:16Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -203,4 +278,79 @@ private JSONArray dataEntry(Row dataRow, Schema schema) {\n         }\n         return entry;\n     }\n-}\n+\n+    public void generateCursorId() {\n+        // TODO: only to be used for generating cursor from first page\n+        // for subsequent pages the cursorType and cursor should be set from\n+        switch(cursorType) {\n+            case DEFAULT:\n+                int pages_left = pagesLeft();\n+                if (options.get(\"scrollId\") != null && pages_left > 0) {\n+                    JSONObject cursorJson = new JSONObject();\n+                    cursorJson.put(\"type\", cursorType.name());\n+                    cursorJson.put(\"schema\", getSchemaAsJson());\n+                    cursorJson.put(\"scrollId\", options.get(\"scrollId\"));\n+                    cursorJson.put(\"left\", pagesLeft());\n+                    setIndexNameInCursor(cursorJson);\n+                    setFieldAliasMapInCursor(cursorJson);\n+                    cursor = encodeCursorContext(cursorJson);\n+\n+                } else {\n+                    // explicitly setting this to null to avoid any ambiguity\n+                    cursor = null;\n+                }\n+                options.remove(\"scrollId\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyMzg5Ng==", "bodyText": "Removed this logic as part of refactoring.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r405923896", "createdAt": "2020-04-09T02:39:12Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -203,4 +278,79 @@ private JSONArray dataEntry(Row dataRow, Schema schema) {\n         }\n         return entry;\n     }\n-}\n+\n+    public void generateCursorId() {\n+        // TODO: only to be used for generating cursor from first page\n+        // for subsequent pages the cursorType and cursor should be set from\n+        switch(cursorType) {\n+            case DEFAULT:\n+                int pages_left = pagesLeft();\n+                if (options.get(\"scrollId\") != null && pages_left > 0) {\n+                    JSONObject cursorJson = new JSONObject();\n+                    cursorJson.put(\"type\", cursorType.name());\n+                    cursorJson.put(\"schema\", getSchemaAsJson());\n+                    cursorJson.put(\"scrollId\", options.get(\"scrollId\"));\n+                    cursorJson.put(\"left\", pagesLeft());\n+                    setIndexNameInCursor(cursorJson);\n+                    setFieldAliasMapInCursor(cursorJson);\n+                    cursor = encodeCursorContext(cursorJson);\n+\n+                } else {\n+                    // explicitly setting this to null to avoid any ambiguity\n+                    cursor = null;\n+                }\n+                options.remove(\"scrollId\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NTE1Mw=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 175}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDY5OTE1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMDowNzozN1rOF5Eanw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjozODoyNlrOGDHnRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NTUwMw==", "bodyText": "suggest to separate cursor related code from Protocol and add UT for that.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395385503", "createdAt": "2020-03-20T00:07:37Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -203,4 +278,79 @@ private JSONArray dataEntry(Row dataRow, Schema schema) {\n         }\n         return entry;\n     }\n-}\n+\n+    public void generateCursorId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyMzY1NQ==", "bodyText": "Refactored cursor related code from Protocol.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r405923655", "createdAt": "2020-04-09T02:38:26Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -203,4 +278,79 @@ private JSONArray dataEntry(Row dataRow, Schema schema) {\n         }\n         return entry;\n     }\n-}\n+\n+    public void generateCursorId() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NTUwMw=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 155}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDcwMjU4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMDowOTo0NlrOF5EcnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMTowMTozNFrOF5FKAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NjAxMw==", "bodyText": "if fetchSize is initialized to null, will this throw a NullPointerException?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395386013", "createdAt": "2020-03-20T00:09:46Z", "author": {"login": "davidcui1225"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "diffHunk": "@@ -59,16 +61,36 @@ private static SqlRequest parseSqlRequestFromPayload(RestRequest restRequest) {\n         JSONObject jsonContent;\n         try {\n             jsonContent = new JSONObject(content);\n+            if (jsonContent.has(SQL_CURSOR_FIELD_NAME)) {\n+                return new SqlRequest(jsonContent.getString(SQL_CURSOR_FIELD_NAME));\n+            }\n         } catch (JSONException e) {\n             throw new IllegalArgumentException(\"Failed to parse request payload\", e);\n         }\n         String sql = jsonContent.getString(SQL_FIELD_NAME);\n+\n         if (jsonContent.has(PARAM_FIELD_NAME)) { // is a PreparedStatement\n             JSONArray paramArray = jsonContent.getJSONArray(PARAM_FIELD_NAME);\n             List<PreparedStatementRequest.PreparedStatementParameter> parameters = parseParameters(paramArray);\n             return new PreparedStatementRequest(sql, jsonContent, parameters);\n         }\n-        return new SqlRequest(sql, jsonContent);\n+        return new SqlRequest(sql, validateAndGetFetchSize(jsonContent), jsonContent);\n+    }\n+\n+\n+    private static Integer validateAndGetFetchSize(JSONObject jsonContent) {\n+        Integer fetchSize = null;\n+        try {\n+            if (jsonContent.has(SQL_FETCH_FIELD_NAME)) {\n+                fetchSize = jsonContent.getInt(SQL_FETCH_FIELD_NAME);\n+                if (fetchSize < 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5NzYzMw==", "bodyText": "This will never throw NullPointerException, as we are either assigning integer value to fetch_size or throwing JSONException", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395397633", "createdAt": "2020-03-20T01:01:34Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequestFactory.java", "diffHunk": "@@ -59,16 +61,36 @@ private static SqlRequest parseSqlRequestFromPayload(RestRequest restRequest) {\n         JSONObject jsonContent;\n         try {\n             jsonContent = new JSONObject(content);\n+            if (jsonContent.has(SQL_CURSOR_FIELD_NAME)) {\n+                return new SqlRequest(jsonContent.getString(SQL_CURSOR_FIELD_NAME));\n+            }\n         } catch (JSONException e) {\n             throw new IllegalArgumentException(\"Failed to parse request payload\", e);\n         }\n         String sql = jsonContent.getString(SQL_FIELD_NAME);\n+\n         if (jsonContent.has(PARAM_FIELD_NAME)) { // is a PreparedStatement\n             JSONArray paramArray = jsonContent.getJSONArray(PARAM_FIELD_NAME);\n             List<PreparedStatementRequest.PreparedStatementParameter> parameters = parseParameters(paramArray);\n             return new PreparedStatementRequest(sql, jsonContent, parameters);\n         }\n-        return new SqlRequest(sql, jsonContent);\n+        return new SqlRequest(sql, validateAndGetFetchSize(jsonContent), jsonContent);\n+    }\n+\n+\n+    private static Integer validateAndGetFetchSize(JSONObject jsonContent) {\n+        Integer fetchSize = null;\n+        try {\n+            if (jsonContent.has(SQL_FETCH_FIELD_NAME)) {\n+                fetchSize = jsonContent.getInt(SQL_FETCH_FIELD_NAME);\n+                if (fetchSize < 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NjAxMw=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDcwNTAyOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMDoxMToyMVrOF5EeIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxODowMDoxNlrOF5eA_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NjQwMg==", "bodyText": "should these style of comments go outside of the actual test case as a JavaDoc comment?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395386402", "createdAt": "2020-03-20T00:11:21Z", "author": {"login": "davidcui1225"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.ResponseException;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestsConstants.TEST_INDEX_ACCOUNT;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class CursorIT extends SQLIntegTestCase {\n+\n+    private static final String JDBC = \"jdbc\";\n+\n+    @Override\n+    protected void init() throws Exception {\n+        loadIndex(Index.ACCOUNT);\n+    }\n+\n+    @Test\n+    public void invalidFetchSize() throws IOException {\n+        // invalid fetch_size --> negative(-2), non-numeric(\"hello\")\n+        // acceptable fetch_size --> positive numbers, even in string form \"532.4\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5NzEwNA==", "bodyText": "Not necessary for tests, does not affect readability or clarity. Its a best practice for code exposed as public libraries.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395397104", "createdAt": "2020-03-20T00:58:35Z", "author": {"login": "abbashus"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.ResponseException;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestsConstants.TEST_INDEX_ACCOUNT;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class CursorIT extends SQLIntegTestCase {\n+\n+    private static final String JDBC = \"jdbc\";\n+\n+    @Override\n+    protected void init() throws Exception {\n+        loadIndex(Index.ACCOUNT);\n+    }\n+\n+    @Test\n+    public void invalidFetchSize() throws IOException {\n+        // invalid fetch_size --> negative(-2), non-numeric(\"hello\")\n+        // acceptable fetch_size --> positive numbers, even in string form \"532.4\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NjQwMg=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgwNDkyNw==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395804927", "createdAt": "2020-03-20T18:00:16Z", "author": {"login": "abbashus"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.ResponseException;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestsConstants.TEST_INDEX_ACCOUNT;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class CursorIT extends SQLIntegTestCase {\n+\n+    private static final String JDBC = \"jdbc\";\n+\n+    @Override\n+    protected void init() throws Exception {\n+        loadIndex(Index.ACCOUNT);\n+    }\n+\n+    @Test\n+    public void invalidFetchSize() throws IOException {\n+        // invalid fetch_size --> negative(-2), non-numeric(\"hello\")\n+        // acceptable fetch_size --> positive numbers, even in string form \"532.4\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4NjQwMg=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDcwNzQzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/QueryIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMDoxMjo1OFrOF5Efmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMDoyMjozMFrOF5Eofg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4Njc3OA==", "bodyText": "if the scrollhint is deprecated should we delete these tests?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395386778", "createdAt": "2020-03-20T00:12:58Z", "author": {"login": "davidcui1225"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/QueryIT.java", "diffHunk": "@@ -1297,6 +1297,7 @@ public void isNotNullTest() throws IOException {\n     }\n \n     @Test\n+    @Ignore(\"Use of scroll hint is deprecated in lieu of cursor support\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4OTA1NA==", "bodyText": "Even I had the same concern, will delete these tests.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395389054", "createdAt": "2020-03-20T00:22:30Z", "author": {"login": "abbashus"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/QueryIT.java", "diffHunk": "@@ -1297,6 +1297,7 @@ public void isNotNullTest() throws IOException {\n     }\n \n     @Test\n+    @Ignore(\"Use of scroll hint is deprecated in lieu of cursor support\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4Njc3OA=="}, "originalCommit": {"oid": "3cb9ffb1def7eaa8bc64be0c74e854cde39f9ff8"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MzI4OTI5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNzo1NTo0OVrOF5d27Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjozNzo0NlrOGDHmsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgwMjM0OQ==", "bodyText": "Add type in error message?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395802349", "createdAt": "2020-03-20T17:55:49Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        String decodedCursorContext = new String(Base64.getDecoder().decode(cursorId));\n+        JSONObject cursorJson = new JSONObject(decodedCursorContext);\n+\n+        String type = cursorJson.optString(\"type\", null); // see if it is a good case to use Optionals\n+        CursorType cursorType = null;\n+\n+        if (type != null) {\n+            cursorType = CursorType.valueOf(type);\n+        }\n+\n+        if (cursorType!=null) {\n+            switch(cursorType) {\n+                case DEFAULT:\n+                    return handleDefaultCursorCloseRequest(client, cursorJson);\n+                case AGGREGATION:\n+                    return handleAggregationCursorCloseRequest(client, cursorJson);\n+                case JOIN:\n+                    return handleJoinCursorCloseRequest(client, cursorJson);\n+                default: throw new VerificationException(\"Unsupported cursor\");\n+            }\n+        }\n+\n+        throw new VerificationException(\"Invalid cursor\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edbb36c61572c9207bef39b92a153ce89589f7d5"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyMzUwNw==", "bodyText": "Added logging for invalid cursor type. Not adding type as part of exception message to hide implementation.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r405923507", "createdAt": "2020-04-09T02:37:46Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        String decodedCursorContext = new String(Base64.getDecoder().decode(cursorId));\n+        JSONObject cursorJson = new JSONObject(decodedCursorContext);\n+\n+        String type = cursorJson.optString(\"type\", null); // see if it is a good case to use Optionals\n+        CursorType cursorType = null;\n+\n+        if (type != null) {\n+            cursorType = CursorType.valueOf(type);\n+        }\n+\n+        if (cursorType!=null) {\n+            switch(cursorType) {\n+                case DEFAULT:\n+                    return handleDefaultCursorCloseRequest(client, cursorJson);\n+                case AGGREGATION:\n+                    return handleAggregationCursorCloseRequest(client, cursorJson);\n+                case JOIN:\n+                    return handleJoinCursorCloseRequest(client, cursorJson);\n+                default: throw new VerificationException(\"Unsupported cursor\");\n+            }\n+        }\n+\n+        throw new VerificationException(\"Invalid cursor\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgwMjM0OQ=="}, "originalCommit": {"oid": "edbb36c61572c9207bef39b92a153ce89589f7d5"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MzMyNjkyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxODowNzoxOFrOF5ePsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjozMjo0OFrOGDHiAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgwODY5MQ==", "bodyText": "I recall this may throw Enum exception.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r395808691", "createdAt": "2020-03-20T18:07:18Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.sql.SQLFeatureNotSupportedException;\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+\n+        String decodedCursorContext = new String(Base64.getDecoder().decode(cursorId));\n+        JSONObject cursorJson = new JSONObject(decodedCursorContext);\n+\n+        String type = cursorJson.optString(\"type\", null); // see if it is a good case to use Optionals\n+        CursorType cursorType = null;\n+\n+        if (type != null) {\n+            cursorType = CursorType.valueOf(type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edbb36c61572c9207bef39b92a153ce89589f7d5"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyMjMwNw==", "bodyText": "This logic has been removed after refactoring.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r405922307", "createdAt": "2020-04-09T02:32:48Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.sql.SQLFeatureNotSupportedException;\n+import java.util.Base64;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            e.printStackTrace();\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+\n+        String decodedCursorContext = new String(Base64.getDecoder().decode(cursorId));\n+        JSONObject cursorJson = new JSONObject(decodedCursorContext);\n+\n+        String type = cursorJson.optString(\"type\", null); // see if it is a good case to use Optionals\n+        CursorType cursorType = null;\n+\n+        if (type != null) {\n+            cursorType = CursorType.valueOf(type);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgwODY5MQ=="}, "originalCommit": {"oid": "edbb36c61572c9207bef39b92a153ce89589f7d5"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MTIwMjA3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNToxNjoxOFrOF_Fjgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjozMjoxMVrOGDHhcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY5NTYxOQ==", "bodyText": "Since we're adding new fields to the protocol and version information is missing, could you add a version field too? For example, version missing or 1.0 means \"old\" client code and version = 2.0 means \"new\".", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r401695619", "createdAt": "2020-04-01T15:16:18Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "diffHunk": "@@ -36,11 +36,22 @@\n \n     String sql;\n     JSONObject jsonContent;\n+    String cursor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afd251fd2c05322d494dfd711936c85c02d6ccd2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE5MTE1Nw==", "bodyText": "I took a quick look into version field of other protocol. Take Internet Protocol (IP) for example, the first field in the header is version which indicates IPv4 or IPv6. What follows this field in the header differs for different version so application is aware of how to parse the entire header.\nIn our case, because we are only adding new fields, probably we can delay adding version field. We need to reconsider this and may need to refactor our protocol carefully (ex. divide into header and body) when adding such as binary protocol.\nReference: https://en.wikipedia.org/wiki/IPv4#Version and https://en.wikipedia.org/wiki/IPv6_packet#Fixed_header", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r403191157", "createdAt": "2020-04-03T17:49:47Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "diffHunk": "@@ -36,11 +36,22 @@\n \n     String sql;\n     JSONObject jsonContent;\n+    String cursor;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY5NTYxOQ=="}, "originalCommit": {"oid": "afd251fd2c05322d494dfd711936c85c02d6ccd2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkyMjE2MQ==", "bodyText": "Yes, we can add this later if needed. This will not break existing clients now as we adding new field and not modifying/deleting existing one.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r405922161", "createdAt": "2020-04-09T02:32:11Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "diffHunk": "@@ -36,11 +36,22 @@\n \n     String sql;\n     JSONObject jsonContent;\n+    String cursor;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY5NTYxOQ=="}, "originalCommit": {"oid": "afd251fd2c05322d494dfd711936c85c02d6ccd2"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MTIzNDYxOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNToyMzoyNFrOF_F4Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMjozMjowNVrOGADBnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcwMDk0Mg==", "bodyText": "I assume cursor can work with PreparedStatement. If so, could you check if our cursor implementation can work with prepared statement request and add test case here?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r401700942", "createdAt": "2020-04-01T15:23:24Z", "author": {"login": "dai-chen"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "diffHunk": "@@ -0,0 +1,373 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.ResponseException;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestUtils.getResponseBody;\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestsConstants.TEST_INDEX_ACCOUNT;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class CursorIT extends SQLIntegTestCase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afd251fd2c05322d494dfd711936c85c02d6ccd2"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3MTAzMA==", "bodyText": "Sure, will confirm and add a test case as well.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r401971030", "createdAt": "2020-04-01T23:37:39Z", "author": {"login": "abbashus"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "diffHunk": "@@ -0,0 +1,373 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.ResponseException;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestUtils.getResponseBody;\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestsConstants.TEST_INDEX_ACCOUNT;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class CursorIT extends SQLIntegTestCase {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcwMDk0Mg=="}, "originalCommit": {"oid": "afd251fd2c05322d494dfd711936c85c02d6ccd2"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3MzE3OA==", "bodyText": "Thanks!", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r401973178", "createdAt": "2020-04-01T23:44:06Z", "author": {"login": "dai-chen"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "diffHunk": "@@ -0,0 +1,373 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.ResponseException;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestUtils.getResponseBody;\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestsConstants.TEST_INDEX_ACCOUNT;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class CursorIT extends SQLIntegTestCase {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcwMDk0Mg=="}, "originalCommit": {"oid": "afd251fd2c05322d494dfd711936c85c02d6ccd2"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcwMjc1MQ==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r402702751", "createdAt": "2020-04-03T02:32:05Z", "author": {"login": "abbashus"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/CursorIT.java", "diffHunk": "@@ -0,0 +1,373 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.esintgtest;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.ResponseException;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestUtils.getResponseBody;\n+import static com.amazon.opendistroforelasticsearch.sql.esintgtest.TestsConstants.TEST_INDEX_ACCOUNT;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class CursorIT extends SQLIntegTestCase {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcwMDk0Mg=="}, "originalCommit": {"oid": "afd251fd2c05322d494dfd711936c85c02d6ccd2"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTM5NDU5OnYy", "diffSide": "RIGHT", "path": "docs/user/admin/settings.rst", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNTozOToxMlrOGDeUqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzowNzoyN1rOGDsR2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NTcyMw==", "bodyText": "what is the meaning of \"node scope\"? does it means the setting only apply to specific node?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406295723", "createdAt": "2020-04-09T15:39:12Z", "author": {"login": "penghuo"}, "path": "docs/user/admin/settings.rst", "diffHunk": "@@ -384,3 +384,129 @@ Result set::\n \t  \"timed_out\" : false\n \t}\n \n+opendistro.sql.cursor.enabled\n+=============================\n+\n+Description\n+-----------\n+\n+User can enable/disable pagination for all queries that are supported.\n+\n+1. The default value is false.\n+2. This setting is node scope.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM4MDczOQ==", "bodyText": "what is the meaning of \"node scope\"?\n\nThis is a cluster wide setting, change on one node will be reflected on all other nodes.\nNot sure, why it is named like this. This is not different from all other settings we already have.\n\ndoes it means the setting only apply to specific node?\n\nNo.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406380739", "createdAt": "2020-04-09T18:01:24Z", "author": {"login": "abbashus"}, "path": "docs/user/admin/settings.rst", "diffHunk": "@@ -384,3 +384,129 @@ Result set::\n \t  \"timed_out\" : false\n \t}\n \n+opendistro.sql.cursor.enabled\n+=============================\n+\n+Description\n+-----------\n+\n+User can enable/disable pagination for all queries that are supported.\n+\n+1. The default value is false.\n+2. This setting is node scope.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NTcyMw=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyNDM3OA==", "bodyText": "I may have a little context here. I recall the name was from ES Setting in which there is a NodeScope and IndexScope.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406524378", "createdAt": "2020-04-09T23:07:27Z", "author": {"login": "dai-chen"}, "path": "docs/user/admin/settings.rst", "diffHunk": "@@ -384,3 +384,129 @@ Result set::\n \t  \"timed_out\" : false\n \t}\n \n+opendistro.sql.cursor.enabled\n+=============================\n+\n+Description\n+-----------\n+\n+User can enable/disable pagination for all queries that are supported.\n+\n+1. The default value is false.\n+2. This setting is node scope.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NTcyMw=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTU1MjA5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/query/DefaultQueryAction.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjoxOTo1N1rOGDf59w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQwMTozMjoxMlrOGEJU6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyMTY1NQ==", "bodyText": "Do we have UT to test the logic in here. IMO, the  setting, fetchSize, rowCount has different combination which determine the scroll logic which should be covered in the UT.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406321655", "createdAt": "2020-04-09T16:19:57Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/query/DefaultQueryAction.java", "diffHunk": "@@ -78,51 +84,61 @@ public void initialize(SearchRequestBuilder request) {\n \n     @Override\n     public SqlElasticSearchRequestBuilder explain() throws SqlParseException {\n-        Hint scrollHint = null;\n-        for (Hint hint : select.getHints()) {\n-            if (hint.getType() == HintType.USE_SCROLL) {\n-                scrollHint = hint;\n-                break;\n-            }\n-        }\n-        if (scrollHint != null && scrollHint.getParams()[0] instanceof String) {\n-            return new SqlElasticSearchRequestBuilder(new SearchScrollRequestBuilder(client,\n-                    SearchScrollAction.INSTANCE, (String) scrollHint.getParams()[0])\n-                    .setScroll(new TimeValue((Integer) scrollHint.getParams()[1])));\n-        }\n+        Objects.requireNonNull(this.sqlRequest, \"SqlRequest is required for ES request build\");\n+        buildRequest();\n+        checkAndSetScroll();\n+        return new SqlElasticSearchRequestBuilder(request);\n+    }\n \n+    private void buildRequest() throws SqlParseException {\n         this.request = new SearchRequestBuilder(client, SearchAction.INSTANCE);\n         setIndicesAndTypes();\n-\n         setFields(select.getFields());\n         setWhere(select.getWhere());\n         setSorts(select.getOrderBys());\n-        setLimit(select.getOffset(), select.getRowCount());\n-\n-        if (scrollHint != null) {\n-            if (!select.isOrderdSelect()) {\n-                request.addSort(FieldSortBuilder.DOC_FIELD_NAME, SortOrder.ASC);\n-            }\n-            request.setSize((Integer) scrollHint.getParams()[0])\n-                    .setScroll(new TimeValue((Integer) scrollHint.getParams()[1]));\n-        } else {\n-            request.setSearchType(SearchType.DFS_QUERY_THEN_FETCH);\n-        }\n         updateRequestWithIndexAndRoutingOptions(select, request);\n         updateRequestWithHighlight(select, request);\n         updateRequestWithCollapse(select, request);\n         updateRequestWithPostFilter(select, request);\n         updateRequestWithInnerHits(select, request);\n+    }\n \n-        return new SqlElasticSearchRequestBuilder(request);\n+    private void checkAndSetScroll() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM4MzIyMQ==", "bodyText": "Will add unit test for this.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406383221", "createdAt": "2020-04-09T18:05:54Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/query/DefaultQueryAction.java", "diffHunk": "@@ -78,51 +84,61 @@ public void initialize(SearchRequestBuilder request) {\n \n     @Override\n     public SqlElasticSearchRequestBuilder explain() throws SqlParseException {\n-        Hint scrollHint = null;\n-        for (Hint hint : select.getHints()) {\n-            if (hint.getType() == HintType.USE_SCROLL) {\n-                scrollHint = hint;\n-                break;\n-            }\n-        }\n-        if (scrollHint != null && scrollHint.getParams()[0] instanceof String) {\n-            return new SqlElasticSearchRequestBuilder(new SearchScrollRequestBuilder(client,\n-                    SearchScrollAction.INSTANCE, (String) scrollHint.getParams()[0])\n-                    .setScroll(new TimeValue((Integer) scrollHint.getParams()[1])));\n-        }\n+        Objects.requireNonNull(this.sqlRequest, \"SqlRequest is required for ES request build\");\n+        buildRequest();\n+        checkAndSetScroll();\n+        return new SqlElasticSearchRequestBuilder(request);\n+    }\n \n+    private void buildRequest() throws SqlParseException {\n         this.request = new SearchRequestBuilder(client, SearchAction.INSTANCE);\n         setIndicesAndTypes();\n-\n         setFields(select.getFields());\n         setWhere(select.getWhere());\n         setSorts(select.getOrderBys());\n-        setLimit(select.getOffset(), select.getRowCount());\n-\n-        if (scrollHint != null) {\n-            if (!select.isOrderdSelect()) {\n-                request.addSort(FieldSortBuilder.DOC_FIELD_NAME, SortOrder.ASC);\n-            }\n-            request.setSize((Integer) scrollHint.getParams()[0])\n-                    .setScroll(new TimeValue((Integer) scrollHint.getParams()[1]));\n-        } else {\n-            request.setSearchType(SearchType.DFS_QUERY_THEN_FETCH);\n-        }\n         updateRequestWithIndexAndRoutingOptions(select, request);\n         updateRequestWithHighlight(select, request);\n         updateRequestWithCollapse(select, request);\n         updateRequestWithPostFilter(select, request);\n         updateRequestWithInnerHits(select, request);\n+    }\n \n-        return new SqlElasticSearchRequestBuilder(request);\n+    private void checkAndSetScroll() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyMTY1NQ=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzAwMDI5Nw==", "bodyText": "Added.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407000297", "createdAt": "2020-04-11T01:32:12Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/query/DefaultQueryAction.java", "diffHunk": "@@ -78,51 +84,61 @@ public void initialize(SearchRequestBuilder request) {\n \n     @Override\n     public SqlElasticSearchRequestBuilder explain() throws SqlParseException {\n-        Hint scrollHint = null;\n-        for (Hint hint : select.getHints()) {\n-            if (hint.getType() == HintType.USE_SCROLL) {\n-                scrollHint = hint;\n-                break;\n-            }\n-        }\n-        if (scrollHint != null && scrollHint.getParams()[0] instanceof String) {\n-            return new SqlElasticSearchRequestBuilder(new SearchScrollRequestBuilder(client,\n-                    SearchScrollAction.INSTANCE, (String) scrollHint.getParams()[0])\n-                    .setScroll(new TimeValue((Integer) scrollHint.getParams()[1])));\n-        }\n+        Objects.requireNonNull(this.sqlRequest, \"SqlRequest is required for ES request build\");\n+        buildRequest();\n+        checkAndSetScroll();\n+        return new SqlElasticSearchRequestBuilder(request);\n+    }\n \n+    private void buildRequest() throws SqlParseException {\n         this.request = new SearchRequestBuilder(client, SearchAction.INSTANCE);\n         setIndicesAndTypes();\n-\n         setFields(select.getFields());\n         setWhere(select.getWhere());\n         setSorts(select.getOrderBys());\n-        setLimit(select.getOffset(), select.getRowCount());\n-\n-        if (scrollHint != null) {\n-            if (!select.isOrderdSelect()) {\n-                request.addSort(FieldSortBuilder.DOC_FIELD_NAME, SortOrder.ASC);\n-            }\n-            request.setSize((Integer) scrollHint.getParams()[0])\n-                    .setScroll(new TimeValue((Integer) scrollHint.getParams()[1]));\n-        } else {\n-            request.setSearchType(SearchType.DFS_QUERY_THEN_FETCH);\n-        }\n         updateRequestWithIndexAndRoutingOptions(select, request);\n         updateRequestWithHighlight(select, request);\n         updateRequestWithCollapse(select, request);\n         updateRequestWithPostFilter(select, request);\n         updateRequestWithInnerHits(select, request);\n+    }\n \n-        return new SqlElasticSearchRequestBuilder(request);\n+    private void checkAndSetScroll() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyMTY1NQ=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTYzNDc5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjo0MToyM1rOGDgttQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzo1NToxNlrOGEvFDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNDkwMQ==", "bodyText": "Two concerns.\n\nThe execute method is almost as same as CursorResultExecutor.execute, only difference is the LOG.error. Is it possible to avoid the duplication.\nIn case we already define the Curser, could we construct CursorCloseExecutor by using cursor and encapsulate the Cursor construct operation in CursorFactory?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406334901", "createdAt": "2020-04-09T16:41:23Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorCloseExecutor.class);\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM4MjkyOA==", "bodyText": "Sure, will give a shot to refactor as described.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406382928", "createdAt": "2020-04-09T18:05:19Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorCloseExecutor.class);\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNDkwMQ=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5ODYzMQ==", "bodyText": "Keeping it as it now, little tricky to refactor.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407598631", "createdAt": "2020-04-13T17:19:12Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorCloseExecutor.class);\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNDkwMQ=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYxMTYxMg==", "bodyText": "In my opinion, the cursor format \":\" which should be encapsulated to Cursor implementation and should not been exposed to caller.\nWe can leave it for now for time consideration, Please consider add UT to cover the logic in CursorCloseExecutor and CursorResultExecutor. If possible, add the issue to tracking the refactoring.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407611612", "createdAt": "2020-04-13T17:42:31Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorCloseExecutor.class);\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNDkwMQ=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYxODgyOQ==", "bodyText": "#426.\nAdding UTs.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407618829", "createdAt": "2020-04-13T17:55:16Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorCloseExecutor.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.json.JSONException;\n+\n+import java.util.Map;\n+\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorCloseExecutor implements CursorRestExecutor {\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorCloseExecutor.class);\n+\n+    private static final String SUCCEEDED_TRUE = \"{\\\"succeeded\\\":true}\";\n+    private static final String SUCCEEDED_FALSE = \"{\\\"succeeded\\\":false}\";\n+\n+    private String cursorId;\n+\n+    public CursorCloseExecutor(String cursorId) {\n+        this.cursorId = cursorId;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNDkwMQ=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTY3MzU5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjo1Mjo0MVrOGDhG-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzo1MzoyOVrOGDjO4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM0MTM2OQ==", "bodyText": "In case of rowsLeft = 0, we still include the newScrollId in response?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406341369", "createdAt": "2020-04-09T16:52:41Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+\n+import java.util.Arrays;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        /**\n+         * All cursor's are of the form <cursorType>:<base64 encoded cursor>\n+         * The serialized form before encoding is upto Cursor implementation\n+         */\n+        String[] splittedCursor = cursorId.split(\":\");\n+\n+        if (splittedCursor.length!=2) {\n+            throw new VerificationException(\"Not able to parse invalid cursor\");\n+        }\n+\n+        String type = splittedCursor[0];\n+        CursorType cursorType = CursorType.getById(type);\n+\n+        if (cursorType!=CursorType.NULL) {\n+            switch(cursorType) {\n+                case DEFAULT:\n+                    DefaultCursor defaultCursor = DefaultCursor.from(splittedCursor[1]);\n+                    return handleDefaultCursorRequest(client, defaultCursor);\n+                case AGGREGATION:\n+                case JOIN:\n+                default: throw new VerificationException(\"Unsupported cursor\");\n+            }\n+        }\n+\n+        throw new VerificationException(\"Not able to parse invalid cursor\");\n+    }\n+\n+    private String handleDefaultCursorRequest(Client client, DefaultCursor cursor) {\n+        String previousScrollId = cursor.getScrollId();\n+        LocalClusterState clusterState = LocalClusterState.state();\n+        TimeValue scrollTimeout = clusterState.getSettingValue(CURSOR_KEEPALIVE);\n+        SearchResponse scrollResponse = client.prepareSearchScroll(previousScrollId).setScroll(scrollTimeout).get();\n+        SearchHits searchHits = scrollResponse.getHits();\n+        SearchHit[] searchHitArray = searchHits.getHits();\n+        String newScrollId = scrollResponse.getScrollId();\n+\n+        int rowsLeft = (int) cursor.getRowsLeft();\n+        int fetch = cursor.getFetchSize();\n+\n+        if (rowsLeft < fetch && rowsLeft < searchHitArray.length) {\n+            /**\n+             * This condition implies we are on the last page, and we might need to truncate the result from SearchHit[]\n+             * Avoid truncating in following two scenarios\n+             * 1. number of rows to be sent equals fetchSize\n+             * 2. size of SearchHit[] is already less that rows that needs to be sent\n+             *\n+             * Else truncate to desired number of rows\n+             */\n+            SearchHit[] newSearchHits = Arrays.copyOf(searchHitArray, rowsLeft);\n+            searchHits = new SearchHits(newSearchHits, searchHits.getTotalHits(), searchHits.getMaxScore());\n+        }\n+\n+        rowsLeft = rowsLeft - fetch;\n+\n+        if (rowsLeft <=0) {\n+            /** Clear the scroll context on last page */\n+            ClearScrollResponse clearScrollResponse = client.prepareClearScroll().addScrollId(newScrollId).get();\n+            if (!clearScrollResponse.isSucceeded()) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+                LOG.info(\"Error closing the cursor context {} \", newScrollId);\n+            }\n+        }\n+\n+        cursor.setRowsLeft(rowsLeft);\n+        cursor.setScrollId(newScrollId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3NjE2MA==", "bodyText": "No, as part of cursor generation if rowsleft <=0 the cursor is set to null, and thus omitted from response. See DefaultCursor.generateId().  The code was structured like this to avoid if...else condition and the final logic to generate cursor id delegated to implementing class.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406376160", "createdAt": "2020-04-09T17:53:29Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+\n+import java.util.Arrays;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        /**\n+         * All cursor's are of the form <cursorType>:<base64 encoded cursor>\n+         * The serialized form before encoding is upto Cursor implementation\n+         */\n+        String[] splittedCursor = cursorId.split(\":\");\n+\n+        if (splittedCursor.length!=2) {\n+            throw new VerificationException(\"Not able to parse invalid cursor\");\n+        }\n+\n+        String type = splittedCursor[0];\n+        CursorType cursorType = CursorType.getById(type);\n+\n+        if (cursorType!=CursorType.NULL) {\n+            switch(cursorType) {\n+                case DEFAULT:\n+                    DefaultCursor defaultCursor = DefaultCursor.from(splittedCursor[1]);\n+                    return handleDefaultCursorRequest(client, defaultCursor);\n+                case AGGREGATION:\n+                case JOIN:\n+                default: throw new VerificationException(\"Unsupported cursor\");\n+            }\n+        }\n+\n+        throw new VerificationException(\"Not able to parse invalid cursor\");\n+    }\n+\n+    private String handleDefaultCursorRequest(Client client, DefaultCursor cursor) {\n+        String previousScrollId = cursor.getScrollId();\n+        LocalClusterState clusterState = LocalClusterState.state();\n+        TimeValue scrollTimeout = clusterState.getSettingValue(CURSOR_KEEPALIVE);\n+        SearchResponse scrollResponse = client.prepareSearchScroll(previousScrollId).setScroll(scrollTimeout).get();\n+        SearchHits searchHits = scrollResponse.getHits();\n+        SearchHit[] searchHitArray = searchHits.getHits();\n+        String newScrollId = scrollResponse.getScrollId();\n+\n+        int rowsLeft = (int) cursor.getRowsLeft();\n+        int fetch = cursor.getFetchSize();\n+\n+        if (rowsLeft < fetch && rowsLeft < searchHitArray.length) {\n+            /**\n+             * This condition implies we are on the last page, and we might need to truncate the result from SearchHit[]\n+             * Avoid truncating in following two scenarios\n+             * 1. number of rows to be sent equals fetchSize\n+             * 2. size of SearchHit[] is already less that rows that needs to be sent\n+             *\n+             * Else truncate to desired number of rows\n+             */\n+            SearchHit[] newSearchHits = Arrays.copyOf(searchHitArray, rowsLeft);\n+            searchHits = new SearchHits(newSearchHits, searchHits.getTotalHits(), searchHits.getMaxScore());\n+        }\n+\n+        rowsLeft = rowsLeft - fetch;\n+\n+        if (rowsLeft <=0) {\n+            /** Clear the scroll context on last page */\n+            ClearScrollResponse clearScrollResponse = client.prepareClearScroll().addScrollId(newScrollId).get();\n+            if (!clearScrollResponse.isSucceeded()) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+                LOG.info(\"Error closing the cursor context {} \", newScrollId);\n+            }\n+        }\n+\n+        cursor.setRowsLeft(rowsLeft);\n+        cursor.setScrollId(newScrollId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM0MTM2OQ=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTY4MDU4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/cursor/DefaultCursor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjo1NDo0MlrOGDhLjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODowNDoyNVrOGDjnYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM0MjU0Mg==", "bodyText": "minor: consider to use Lombok to auto generate get/set method.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406342542", "createdAt": "2020-04-09T16:54:42Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/cursor/DefaultCursor.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Schema;\n+import com.google.common.base.Strings;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+\n+/**\n+ * Minimum metdata that will be serialized for generating cursorId for\n+ * SELECT .... FROM .. ORDER BY .... queries\n+ */\n+public class DefaultCursor implements Cursor {\n+\n+    /** Make sure all keys are unique to prevent overriding\n+     * and as small as possible to make cursor compact\n+     */\n+    private static final String FETCH_SIZE = \"f\";\n+    private static final String ROWS_LEFT = \"l\";\n+    private static final String INDEX_PATTERN = \"i\";\n+    private static final String SCROLL_ID = \"s\";\n+    private static final String SCHEMA_COLUMNS = \"c\";\n+    private static final String FIELD_ALIAS_MAP = \"a\";\n+\n+    /** To get mappings for index to check if type is date needed for\n+     * @see com.amazon.opendistroforelasticsearch.sql.executor.format.DateFieldFormatter */\n+    private String indexPattern;\n+\n+    /** List of Schema.Column for maintaining field order and generating null values of missing fields */\n+    private List<Schema.Column> columns;\n+\n+    /** To delegate to correct cursor handler to get next page*/\n+    private final CursorType type = CursorType.DEFAULT;\n+\n+    /**\n+     * Truncate the @see DataRows to respect LIMIT clause and/or to identify last page to close scroll context.\n+     * docsLeft is decremented by fetch_size for call to get page of result.\n+     */\n+    private long rowsLeft;\n+\n+    /** @see com.amazon.opendistroforelasticsearch.sql.executor.format.SelectResultSet */\n+    private Map<String, String> fieldAliasMap;\n+\n+    /** To get next batch of result */\n+    private String scrollId;\n+\n+    /** To reduce the number of rows left by fetchSize */\n+    private Integer fetchSize;\n+\n+\n+    private Integer limit;\n+\n+    @Override\n+    public CursorType getType() {\n+        return type;\n+    }\n+\n+    @Override\n+    public String generateCursorId() {\n+        if (rowsLeft <=0 || Strings.isNullOrEmpty(scrollId)) {\n+            return null;\n+        }\n+        JSONObject json = new JSONObject();\n+        json.put(FETCH_SIZE, fetchSize);\n+        json.put(ROWS_LEFT, rowsLeft);\n+        json.put(INDEX_PATTERN, indexPattern);\n+        json.put(SCROLL_ID, scrollId);\n+        json.put(SCHEMA_COLUMNS, getSchemaAsJson());\n+        json.put(FIELD_ALIAS_MAP, fieldAliasMap);\n+        return String.format(\"%s:%s\", type.getId(), encodeCursor(json));\n+    }\n+\n+    public static DefaultCursor from(String cursorId) {\n+        /**\n+         * It is assumed that cursorId here is the second part of the original cursor passed\n+         * by the client after removing first part which identifies cursor type\n+         */\n+         JSONObject json = decodeCursor(cursorId);\n+         DefaultCursor cursor = new DefaultCursor();\n+         cursor.setFetchSize(json.getInt(FETCH_SIZE));\n+         cursor.setRowsLeft(json.getLong(ROWS_LEFT));\n+         cursor.setIndexPattern(json.getString(INDEX_PATTERN));\n+         cursor.setScrollId(json.getString(SCROLL_ID));\n+         cursor.setColumns(getColumnsFromSchema(json.getJSONArray(SCHEMA_COLUMNS)));\n+         cursor.setFieldAliasMap(fieldAliasMap(json.getJSONObject(FIELD_ALIAS_MAP)));\n+\n+         return cursor;\n+    }\n+\n+\n+    public String getIndexPattern() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM4MjQzMg==", "bodyText": "Sure, will consider using Lombok.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406382432", "createdAt": "2020-04-09T18:04:25Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/cursor/DefaultCursor.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Schema;\n+import com.google.common.base.Strings;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+\n+/**\n+ * Minimum metdata that will be serialized for generating cursorId for\n+ * SELECT .... FROM .. ORDER BY .... queries\n+ */\n+public class DefaultCursor implements Cursor {\n+\n+    /** Make sure all keys are unique to prevent overriding\n+     * and as small as possible to make cursor compact\n+     */\n+    private static final String FETCH_SIZE = \"f\";\n+    private static final String ROWS_LEFT = \"l\";\n+    private static final String INDEX_PATTERN = \"i\";\n+    private static final String SCROLL_ID = \"s\";\n+    private static final String SCHEMA_COLUMNS = \"c\";\n+    private static final String FIELD_ALIAS_MAP = \"a\";\n+\n+    /** To get mappings for index to check if type is date needed for\n+     * @see com.amazon.opendistroforelasticsearch.sql.executor.format.DateFieldFormatter */\n+    private String indexPattern;\n+\n+    /** List of Schema.Column for maintaining field order and generating null values of missing fields */\n+    private List<Schema.Column> columns;\n+\n+    /** To delegate to correct cursor handler to get next page*/\n+    private final CursorType type = CursorType.DEFAULT;\n+\n+    /**\n+     * Truncate the @see DataRows to respect LIMIT clause and/or to identify last page to close scroll context.\n+     * docsLeft is decremented by fetch_size for call to get page of result.\n+     */\n+    private long rowsLeft;\n+\n+    /** @see com.amazon.opendistroforelasticsearch.sql.executor.format.SelectResultSet */\n+    private Map<String, String> fieldAliasMap;\n+\n+    /** To get next batch of result */\n+    private String scrollId;\n+\n+    /** To reduce the number of rows left by fetchSize */\n+    private Integer fetchSize;\n+\n+\n+    private Integer limit;\n+\n+    @Override\n+    public CursorType getType() {\n+        return type;\n+    }\n+\n+    @Override\n+    public String generateCursorId() {\n+        if (rowsLeft <=0 || Strings.isNullOrEmpty(scrollId)) {\n+            return null;\n+        }\n+        JSONObject json = new JSONObject();\n+        json.put(FETCH_SIZE, fetchSize);\n+        json.put(ROWS_LEFT, rowsLeft);\n+        json.put(INDEX_PATTERN, indexPattern);\n+        json.put(SCROLL_ID, scrollId);\n+        json.put(SCHEMA_COLUMNS, getSchemaAsJson());\n+        json.put(FIELD_ALIAS_MAP, fieldAliasMap);\n+        return String.format(\"%s:%s\", type.getId(), encodeCursor(json));\n+    }\n+\n+    public static DefaultCursor from(String cursorId) {\n+        /**\n+         * It is assumed that cursorId here is the second part of the original cursor passed\n+         * by the client after removing first part which identifies cursor type\n+         */\n+         JSONObject json = decodeCursor(cursorId);\n+         DefaultCursor cursor = new DefaultCursor();\n+         cursor.setFetchSize(json.getInt(FETCH_SIZE));\n+         cursor.setRowsLeft(json.getLong(ROWS_LEFT));\n+         cursor.setIndexPattern(json.getString(INDEX_PATTERN));\n+         cursor.setScrollId(json.getString(SCROLL_ID));\n+         cursor.setColumns(getColumnsFromSchema(json.getJSONArray(SCHEMA_COLUMNS)));\n+         cursor.setFieldAliasMap(fieldAliasMap(json.getJSONObject(FIELD_ALIAS_MAP)));\n+\n+         return cursor;\n+    }\n+\n+\n+    public String getIndexPattern() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM0MjU0Mg=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjg0NzM0OnYy", "diffSide": "RIGHT", "path": "docs/user/admin/settings.rst", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzoxNjo1MFrOGDsdGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQwMTozMjowNVrOGEJU2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyNzI1OQ==", "bodyText": "np: space between open.Cursor", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406527259", "createdAt": "2020-04-09T23:16:50Z", "author": {"login": "dai-chen"}, "path": "docs/user/admin/settings.rst", "diffHunk": "@@ -384,3 +384,129 @@ Result set::\n \t  \"timed_out\" : false\n \t}\n \n+opendistro.sql.cursor.enabled\n+=============================\n+\n+Description\n+-----------\n+\n+User can enable/disable pagination for all queries that are supported.\n+\n+1. The default value is false.\n+2. This setting is node scope.\n+3. This setting can be updated dynamically.\n+\n+\n+Example\n+-------\n+\n+You can update the setting with a new value like this.\n+\n+SQL query::\n+\n+\t>> curl -H 'Content-Type: application/json' -X PUT localhost:9200/_opendistro/_sql/settings -d '{\n+\t  \"transient\" : {\n+\t    \"opendistro.sql.cursor.enabled\" : \"true\"\n+\t  }\n+\t}'\n+\n+Result set::\n+\n+\t{\n+\t  \"acknowledged\" : true,\n+\t  \"persistent\" : { },\n+\t  \"transient\" : {\n+\t    \"opendistro\" : {\n+\t      \"sql\" : {\n+\t        \"cursor\" : {\n+\t          \"enabled\" : \"true\"\n+\t        }\n+\t      }\n+\t    }\n+\t  }\n+\t}\n+\n+opendistro.sql.cursor.fetch_size\n+================================\n+\n+Description\n+-----------\n+\n+User can set the default fetch_size for all queries that are supported by pagination.explicit `fetch_size` passed in request will override this value\n+\n+1. The default value is 1000.\n+2. This setting is node scope.\n+3. This setting can be updated dynamically.\n+\n+\n+Example\n+-------\n+\n+You can update the setting with a new value like this.\n+\n+SQL query::\n+\n+\t>> curl -H 'Content-Type: application/json' -X PUT localhost:9200/_opendistro/_sql/settings -d '{\n+\t  \"transient\" : {\n+\t    \"opendistro.sql.cursor.fetch_size\" : \"50\"\n+\t  }\n+\t}'\n+\n+Result set::\n+\n+\t{\n+\t  \"acknowledged\" : true,\n+\t  \"persistent\" : { },\n+\t  \"transient\" : {\n+\t    \"opendistro\" : {\n+\t      \"sql\" : {\n+\t        \"cursor\" : {\n+\t          \"fetch_size\" : \"50\"\n+\t        }\n+\t      }\n+\t    }\n+\t  }\n+\t}\n+\n+opendistro.sql.cursor.keep_alive\n+================================\n+\n+Description\n+-----------\n+\n+User can set this value to indicate how long the cursor context should be kept open.Cursor contexts are resource heavy, and a lower value should be used if possible.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzAwMDI4Mg==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407000282", "createdAt": "2020-04-11T01:32:05Z", "author": {"login": "abbashus"}, "path": "docs/user/admin/settings.rst", "diffHunk": "@@ -384,3 +384,129 @@ Result set::\n \t  \"timed_out\" : false\n \t}\n \n+opendistro.sql.cursor.enabled\n+=============================\n+\n+Description\n+-----------\n+\n+User can enable/disable pagination for all queries that are supported.\n+\n+1. The default value is false.\n+2. This setting is node scope.\n+3. This setting can be updated dynamically.\n+\n+\n+Example\n+-------\n+\n+You can update the setting with a new value like this.\n+\n+SQL query::\n+\n+\t>> curl -H 'Content-Type: application/json' -X PUT localhost:9200/_opendistro/_sql/settings -d '{\n+\t  \"transient\" : {\n+\t    \"opendistro.sql.cursor.enabled\" : \"true\"\n+\t  }\n+\t}'\n+\n+Result set::\n+\n+\t{\n+\t  \"acknowledged\" : true,\n+\t  \"persistent\" : { },\n+\t  \"transient\" : {\n+\t    \"opendistro\" : {\n+\t      \"sql\" : {\n+\t        \"cursor\" : {\n+\t          \"enabled\" : \"true\"\n+\t        }\n+\t      }\n+\t    }\n+\t  }\n+\t}\n+\n+opendistro.sql.cursor.fetch_size\n+================================\n+\n+Description\n+-----------\n+\n+User can set the default fetch_size for all queries that are supported by pagination.explicit `fetch_size` passed in request will override this value\n+\n+1. The default value is 1000.\n+2. This setting is node scope.\n+3. This setting can be updated dynamically.\n+\n+\n+Example\n+-------\n+\n+You can update the setting with a new value like this.\n+\n+SQL query::\n+\n+\t>> curl -H 'Content-Type: application/json' -X PUT localhost:9200/_opendistro/_sql/settings -d '{\n+\t  \"transient\" : {\n+\t    \"opendistro.sql.cursor.fetch_size\" : \"50\"\n+\t  }\n+\t}'\n+\n+Result set::\n+\n+\t{\n+\t  \"acknowledged\" : true,\n+\t  \"persistent\" : { },\n+\t  \"transient\" : {\n+\t    \"opendistro\" : {\n+\t      \"sql\" : {\n+\t        \"cursor\" : {\n+\t          \"fetch_size\" : \"50\"\n+\t        }\n+\t      }\n+\t    }\n+\t  }\n+\t}\n+\n+opendistro.sql.cursor.keep_alive\n+================================\n+\n+Description\n+-----------\n+\n+User can set this value to indicate how long the cursor context should be kept open.Cursor contexts are resource heavy, and a lower value should be used if possible.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyNzI1OQ=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjg1NzA0OnYy", "diffSide": "RIGHT", "path": "docs/user/interfaces/endpoint.rst", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzoyMTo0OFrOGDsirw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwMDowMDo1OFrOGDtLMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyODY4Nw==", "bodyText": "I think this section can be moved to new example 3 in Request Format in protocol doc: https://github.com/opendistro-for-elasticsearch/sql/blob/master/docs/user/interfaces/protocol.rst#request-format.\nAs for endpoint, I think the new cursor close API can be documented here?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406528687", "createdAt": "2020-04-09T23:21:48Z", "author": {"login": "dai-chen"}, "path": "docs/user/interfaces/endpoint.rst", "diffHunk": "@@ -91,3 +91,62 @@ Explain::\n \t  }\n \t}\n \n+Cursor\n+======\n+\n+Description\n+-----------\n+\n+To get paginated response for a query, user needs to provide `fetch_size` parameter as part of normal query. The value of `fetch_size` should be greater than `0`. In absence of `fetch_size`, default value of 1000 is used. A value of `0` will fallback to non-paginated response. This feature is only available over `jdbc` format for now.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTA1Nw==", "bodyText": "I did trying adding it as example 3 in ProtocolIT ,  but I was not getting correct cursor response, also the explain output was showing non-scroll explain with from field. So omitted as it would have required extra plumbing.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406539057", "createdAt": "2020-04-10T00:00:58Z", "author": {"login": "abbashus"}, "path": "docs/user/interfaces/endpoint.rst", "diffHunk": "@@ -91,3 +91,62 @@ Explain::\n \t  }\n \t}\n \n+Cursor\n+======\n+\n+Description\n+-----------\n+\n+To get paginated response for a query, user needs to provide `fetch_size` parameter as part of normal query. The value of `fetch_size` should be greater than `0`. In absence of `fetch_size`, default value of 1000 is used. A value of `0` will fallback to non-paginated response. This feature is only available over `jdbc` format for now.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyODY4Nw=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjg1OTE0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/cursor/CursorType.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzoyMjo1MlrOGDsj4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzoyMjo1MlrOGDsj4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyODk5NQ==", "bodyText": "Could you add some JavaDoc here?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406528995", "createdAt": "2020-04-09T23:22:52Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/cursor/CursorType.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.cursor;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public enum CursorType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjg5MjE1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorAsyncRestExecutor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzo0MToxMFrOGDs24A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzoxMzoyM1rOGEtpkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzMzg1Ng==", "bodyText": "Any chance to reuse AsyncRestExecutor? I don't see any special logic here and you can make AsyncRestExecutor async all cursor request.\n    AsyncRestExecutor(RestExecutor executor) {\n        this(executor, ALL_ACTION_IS_BLOCKING);\n    }", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406533856", "createdAt": "2020-04-09T23:41:10Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorAsyncRestExecutor.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.query.join.BackOffRetryStrategy;\n+import com.amazon.opendistroforelasticsearch.sql.utils.LogUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.QUERY_SLOWLOG;\n+\n+public class CursorAsyncRestExecutor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTE1Nw==", "bodyText": "Sure, will give a shot.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r406539157", "createdAt": "2020-04-10T00:01:23Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorAsyncRestExecutor.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.query.join.BackOffRetryStrategy;\n+import com.amazon.opendistroforelasticsearch.sql.utils.LogUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.QUERY_SLOWLOG;\n+\n+public class CursorAsyncRestExecutor {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzMzg1Ng=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5NTQxMA==", "bodyText": "Not straightforward to use AsyncRestExecutor here. AsyncRestExecutor requires using QueryAction, which we don't have for Cursor request.  Keeping it as it is for now.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407595410", "createdAt": "2020-04-13T17:13:23Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorAsyncRestExecutor.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.query.join.BackOffRetryStrategy;\n+import com.amazon.opendistroforelasticsearch.sql.utils.LogUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.QUERY_SLOWLOG;\n+\n+public class CursorAsyncRestExecutor {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzMzg1Ng=="}, "originalCommit": {"oid": "63868ec5991b1849ca1b40eadf1a0b46572d225a"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDM0Mjc5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/cursor/DefaultCursor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzowOToyNVrOGEthVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxODoxMzo1OFrOGEvuNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5MzMwMw==", "bodyText": "Where is this used?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407593303", "createdAt": "2020-04-13T17:09:25Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/cursor/DefaultCursor.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Schema;\n+import com.google.common.base.Strings;\n+import lombok.Getter;\n+import lombok.NoArgsConstructor;\n+import lombok.NonNull;\n+import lombok.Setter;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+\n+/**\n+ * Minimum metdata that will be serialized for generating cursorId for\n+ * SELECT .... FROM .. ORDER BY .... queries\n+ */\n+@Getter\n+@Setter\n+@NoArgsConstructor\n+public class DefaultCursor implements Cursor {\n+\n+    /** Make sure all keys are unique to prevent overriding\n+     * and as small as possible to make cursor compact\n+     */\n+    private static final String FETCH_SIZE = \"f\";\n+    private static final String ROWS_LEFT = \"l\";\n+    private static final String INDEX_PATTERN = \"i\";\n+    private static final String SCROLL_ID = \"s\";\n+    private static final String SCHEMA_COLUMNS = \"c\";\n+    private static final String FIELD_ALIAS_MAP = \"a\";\n+\n+    /** To get mappings for index to check if type is date needed for\n+     * @see com.amazon.opendistroforelasticsearch.sql.executor.format.DateFieldFormatter */\n+    @NonNull\n+    private String indexPattern;\n+\n+    /** List of Schema.Column for maintaining field order and generating null values of missing fields */\n+    @NonNull\n+    private List<Schema.Column> columns;\n+\n+    /** To delegate to correct cursor handler to get next page*/\n+    private final CursorType type = CursorType.DEFAULT;\n+\n+    /**\n+     * Truncate the @see DataRows to respect LIMIT clause and/or to identify last page to close scroll context.\n+     * docsLeft is decremented by fetch_size for call to get page of result.\n+     */\n+    private long rowsLeft;\n+\n+    /** @see com.amazon.opendistroforelasticsearch.sql.executor.format.SelectResultSet */\n+    @NonNull\n+    private Map<String, String> fieldAliasMap;\n+\n+    /** To get next batch of result */\n+    private String scrollId;\n+\n+    /** To reduce the number of rows left by fetchSize */\n+    @NonNull\n+    private Integer fetchSize;\n+\n+    private Integer limit;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72cbe34e8b86f6d9698e8e1a688b305b3e5709e7"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyOTM2NQ==", "bodyText": "Used to pass limit from PrettyFormatExecutor-> Protocol -> SelectResultSet", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407629365", "createdAt": "2020-04-13T18:13:58Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/cursor/DefaultCursor.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Schema;\n+import com.google.common.base.Strings;\n+import lombok.Getter;\n+import lombok.NoArgsConstructor;\n+import lombok.NonNull;\n+import lombok.Setter;\n+import org.json.JSONArray;\n+import org.json.JSONObject;\n+\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+\n+/**\n+ * Minimum metdata that will be serialized for generating cursorId for\n+ * SELECT .... FROM .. ORDER BY .... queries\n+ */\n+@Getter\n+@Setter\n+@NoArgsConstructor\n+public class DefaultCursor implements Cursor {\n+\n+    /** Make sure all keys are unique to prevent overriding\n+     * and as small as possible to make cursor compact\n+     */\n+    private static final String FETCH_SIZE = \"f\";\n+    private static final String ROWS_LEFT = \"l\";\n+    private static final String INDEX_PATTERN = \"i\";\n+    private static final String SCROLL_ID = \"s\";\n+    private static final String SCHEMA_COLUMNS = \"c\";\n+    private static final String FIELD_ALIAS_MAP = \"a\";\n+\n+    /** To get mappings for index to check if type is date needed for\n+     * @see com.amazon.opendistroforelasticsearch.sql.executor.format.DateFieldFormatter */\n+    @NonNull\n+    private String indexPattern;\n+\n+    /** List of Schema.Column for maintaining field order and generating null values of missing fields */\n+    @NonNull\n+    private List<Schema.Column> columns;\n+\n+    /** To delegate to correct cursor handler to get next page*/\n+    private final CursorType type = CursorType.DEFAULT;\n+\n+    /**\n+     * Truncate the @see DataRows to respect LIMIT clause and/or to identify last page to close scroll context.\n+     * docsLeft is decremented by fetch_size for call to get page of result.\n+     */\n+    private long rowsLeft;\n+\n+    /** @see com.amazon.opendistroforelasticsearch.sql.executor.format.SelectResultSet */\n+    @NonNull\n+    private Map<String, String> fieldAliasMap;\n+\n+    /** To get next batch of result */\n+    private String scrollId;\n+\n+    /** To reduce the number of rows left by fetchSize */\n+    @NonNull\n+    private Integer fetchSize;\n+\n+    private Integer limit;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5MzMwMw=="}, "originalCommit": {"oid": "72cbe34e8b86f6d9698e8e1a688b305b3e5709e7"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDM4NjY2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzoyMjoxN1rOGEt89w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxODoyMjozMVrOGEv_4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMDM3NQ==", "bodyText": "Is it possible that more colons present in Base64 encoded string after first colon? ex. colon in field name selected. If so could we only split the whole string by first colon found?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407600375", "createdAt": "2020-04-13T17:22:17Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+\n+import java.util.Arrays;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        /**\n+         * All cursor's are of the form <cursorType>:<base64 encoded cursor>\n+         * The serialized form before encoding is upto Cursor implementation\n+         */\n+        String[] splittedCursor = cursorId.split(\":\");\n+\n+        if (splittedCursor.length!=2) {\n+            throw new VerificationException(\"Not able to parse invalid cursor\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72cbe34e8b86f6d9698e8e1a688b305b3e5709e7"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYzMzg4OQ==", "bodyText": "Is it possible that more colons present in Base64 encoded string after first colon?\n\nNo possible as whole string after first : is Base64 encoded.\n\nIf so could we only split the whole string by first colon found?\n\nSure, will change to  cursorId.split(\":\", 2)", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407633889", "createdAt": "2020-04-13T18:22:31Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+\n+import java.util.Arrays;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        /**\n+         * All cursor's are of the form <cursorType>:<base64 encoded cursor>\n+         * The serialized form before encoding is upto Cursor implementation\n+         */\n+        String[] splittedCursor = cursorId.split(\":\");\n+\n+        if (splittedCursor.length!=2) {\n+            throw new VerificationException(\"Not able to parse invalid cursor\");\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMDM3NQ=="}, "originalCommit": {"oid": "72cbe34e8b86f6d9698e8e1a688b305b3e5709e7"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDQwMjMxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzoyNjo1MVrOGEuGqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMDoxODo1NFrOGEzzDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMjg1Ng==", "bodyText": "To simplify the logic and handle all invalid cursor (ex. helloworld:..., I think this should be handled in the switch too.\nswitch (cursorType) {\n    case DEFAULT: return ...\n    case AGGREGATION or JOIN: throw unsupported feature exception with cursor type\n    default: throw verification exception with cursor type\n}", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407602856", "createdAt": "2020-04-13T17:26:51Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+\n+import java.util.Arrays;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        /**\n+         * All cursor's are of the form <cursorType>:<base64 encoded cursor>\n+         * The serialized form before encoding is upto Cursor implementation\n+         */\n+        String[] splittedCursor = cursorId.split(\":\");\n+\n+        if (splittedCursor.length!=2) {\n+            throw new VerificationException(\"Not able to parse invalid cursor\");\n+        }\n+\n+        String type = splittedCursor[0];\n+        CursorType cursorType = CursorType.getById(type);\n+\n+        if (cursorType!=CursorType.NULL) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72cbe34e8b86f6d9698e8e1a688b305b3e5709e7"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY5NjE0MA==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407696140", "createdAt": "2020-04-13T20:18:54Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+\n+import java.util.Arrays;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        /**\n+         * All cursor's are of the form <cursorType>:<base64 encoded cursor>\n+         * The serialized form before encoding is upto Cursor implementation\n+         */\n+        String[] splittedCursor = cursorId.split(\":\");\n+\n+        if (splittedCursor.length!=2) {\n+            throw new VerificationException(\"Not able to parse invalid cursor\");\n+        }\n+\n+        String type = splittedCursor[0];\n+        CursorType cursorType = CursorType.getById(type);\n+\n+        if (cursorType!=CursorType.NULL) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMjg1Ng=="}, "originalCommit": {"oid": "72cbe34e8b86f6d9698e8e1a688b305b3e5709e7"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDQ2NDA1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzo0NDo0MFrOGEut2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxOTowMTozMFrOGExUKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYxMjg4OA==", "bodyText": "I think you can pass a number, say limit, to your new added Protocol constructor to skip unwanted rows when generating  response. Then you don't need to create and copy to another array which may be costly.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407612888", "createdAt": "2020-04-13T17:44:40Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+\n+import java.util.Arrays;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        /**\n+         * All cursor's are of the form <cursorType>:<base64 encoded cursor>\n+         * The serialized form before encoding is upto Cursor implementation\n+         */\n+        String[] splittedCursor = cursorId.split(\":\");\n+\n+        if (splittedCursor.length!=2) {\n+            throw new VerificationException(\"Not able to parse invalid cursor\");\n+        }\n+\n+        String type = splittedCursor[0];\n+        CursorType cursorType = CursorType.getById(type);\n+\n+        if (cursorType!=CursorType.NULL) {\n+            switch(cursorType) {\n+                case DEFAULT:\n+                    DefaultCursor defaultCursor = DefaultCursor.from(splittedCursor[1]);\n+                    return handleDefaultCursorRequest(client, defaultCursor);\n+                case AGGREGATION:\n+                case JOIN:\n+                default: throw new VerificationException(\"Unsupported cursor\");\n+            }\n+        }\n+\n+        throw new VerificationException(\"Not able to parse invalid cursor\");\n+    }\n+\n+    private String handleDefaultCursorRequest(Client client, DefaultCursor cursor) {\n+        String previousScrollId = cursor.getScrollId();\n+        LocalClusterState clusterState = LocalClusterState.state();\n+        TimeValue scrollTimeout = clusterState.getSettingValue(CURSOR_KEEPALIVE);\n+        SearchResponse scrollResponse = client.prepareSearchScroll(previousScrollId).setScroll(scrollTimeout).get();\n+        SearchHits searchHits = scrollResponse.getHits();\n+        SearchHit[] searchHitArray = searchHits.getHits();\n+        String newScrollId = scrollResponse.getScrollId();\n+\n+        int rowsLeft = (int) cursor.getRowsLeft();\n+        int fetch = cursor.getFetchSize();\n+\n+        if (rowsLeft < fetch && rowsLeft < searchHitArray.length) {\n+            /**\n+             * This condition implies we are on the last page, and we might need to truncate the result from SearchHit[]\n+             * Avoid truncating in following two scenarios\n+             * 1. number of rows to be sent equals fetchSize\n+             * 2. size of SearchHit[] is already less that rows that needs to be sent\n+             *\n+             * Else truncate to desired number of rows\n+             */\n+            SearchHit[] newSearchHits = Arrays.copyOf(searchHitArray, rowsLeft);\n+            searchHits = new SearchHits(newSearchHits, searchHits.getTotalHits(), searchHits.getMaxScore());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14d2b7c9be30398188705911e319b055a511239f"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY0MjI3MA==", "bodyText": "Good suggestion, will do, wasn't apparent initially.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407642270", "createdAt": "2020-04-13T18:37:46Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+\n+import java.util.Arrays;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        /**\n+         * All cursor's are of the form <cursorType>:<base64 encoded cursor>\n+         * The serialized form before encoding is upto Cursor implementation\n+         */\n+        String[] splittedCursor = cursorId.split(\":\");\n+\n+        if (splittedCursor.length!=2) {\n+            throw new VerificationException(\"Not able to parse invalid cursor\");\n+        }\n+\n+        String type = splittedCursor[0];\n+        CursorType cursorType = CursorType.getById(type);\n+\n+        if (cursorType!=CursorType.NULL) {\n+            switch(cursorType) {\n+                case DEFAULT:\n+                    DefaultCursor defaultCursor = DefaultCursor.from(splittedCursor[1]);\n+                    return handleDefaultCursorRequest(client, defaultCursor);\n+                case AGGREGATION:\n+                case JOIN:\n+                default: throw new VerificationException(\"Unsupported cursor\");\n+            }\n+        }\n+\n+        throw new VerificationException(\"Not able to parse invalid cursor\");\n+    }\n+\n+    private String handleDefaultCursorRequest(Client client, DefaultCursor cursor) {\n+        String previousScrollId = cursor.getScrollId();\n+        LocalClusterState clusterState = LocalClusterState.state();\n+        TimeValue scrollTimeout = clusterState.getSettingValue(CURSOR_KEEPALIVE);\n+        SearchResponse scrollResponse = client.prepareSearchScroll(previousScrollId).setScroll(scrollTimeout).get();\n+        SearchHits searchHits = scrollResponse.getHits();\n+        SearchHit[] searchHitArray = searchHits.getHits();\n+        String newScrollId = scrollResponse.getScrollId();\n+\n+        int rowsLeft = (int) cursor.getRowsLeft();\n+        int fetch = cursor.getFetchSize();\n+\n+        if (rowsLeft < fetch && rowsLeft < searchHitArray.length) {\n+            /**\n+             * This condition implies we are on the last page, and we might need to truncate the result from SearchHit[]\n+             * Avoid truncating in following two scenarios\n+             * 1. number of rows to be sent equals fetchSize\n+             * 2. size of SearchHit[] is already less that rows that needs to be sent\n+             *\n+             * Else truncate to desired number of rows\n+             */\n+            SearchHit[] newSearchHits = Arrays.copyOf(searchHitArray, rowsLeft);\n+            searchHits = new SearchHits(newSearchHits, searchHits.getTotalHits(), searchHits.getMaxScore());\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYxMjg4OA=="}, "originalCommit": {"oid": "14d2b7c9be30398188705911e319b055a511239f"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY1NTQ2NA==", "bodyText": "I realized that though we can skip unwanted DataRows.Row using limit, but this will apply to final flattened row, and will impact correctness result for nested queries.\nFor example:\nIf the final page has rowLeft as 2, implying two un-nested doc, and assuming each doc has atleast 3 nested docs. If use above logic there will be 2 Row, instead of 8 that we expect.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407655464", "createdAt": "2020-04-13T19:01:30Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/cursor/CursorResultExecutor.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.cursor;\n+\n+import com.amazon.opendistroforelasticsearch.sql.cursor.CursorType;\n+import com.amazon.opendistroforelasticsearch.sql.cursor.DefaultCursor;\n+import com.amazon.opendistroforelasticsearch.sql.esdomain.LocalClusterState;\n+import com.amazon.opendistroforelasticsearch.sql.executor.Format;\n+import com.amazon.opendistroforelasticsearch.sql.executor.format.Protocol;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.MetricName;\n+import com.amazon.opendistroforelasticsearch.sql.metrics.Metrics;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.matchtoterm.VerificationException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestChannel;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.json.JSONException;\n+\n+import java.util.Arrays;\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.plugin.SqlSettings.CURSOR_KEEPALIVE;\n+import static org.elasticsearch.rest.RestStatus.OK;\n+\n+public class CursorResultExecutor implements CursorRestExecutor {\n+\n+    private String cursorId;\n+    private Format format;\n+\n+    private static final Logger LOG = LogManager.getLogger(CursorResultExecutor.class);\n+\n+    public CursorResultExecutor(String cursorId, Format format) {\n+        this.cursorId = cursorId;\n+        this.format = format;\n+    }\n+\n+    public void execute(Client client, Map<String, String> params, RestChannel channel) throws Exception {\n+        try {\n+            String formattedResponse = execute(client, params);\n+            channel.sendResponse(new BytesRestResponse(OK, \"application/json; charset=UTF-8\", formattedResponse));\n+        } catch (IllegalArgumentException | JSONException e) {\n+            Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            LOG.error(\"Error parsing the cursor\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        } catch (ElasticsearchException e) {\n+            int status = (e.status().getStatus());\n+            if (status > 399 && status < 500) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_CUS).increment();\n+            } else if (status > 499) {\n+                Metrics.getInstance().getNumericalMetric(MetricName.FAILED_REQ_COUNT_SYS).increment();\n+            }\n+            LOG.error(\"Error completing cursor request\", e);\n+            channel.sendResponse(new BytesRestResponse(channel, e));\n+        }\n+    }\n+\n+    public String execute(Client client, Map<String, String> params) throws Exception {\n+        /**\n+         * All cursor's are of the form <cursorType>:<base64 encoded cursor>\n+         * The serialized form before encoding is upto Cursor implementation\n+         */\n+        String[] splittedCursor = cursorId.split(\":\");\n+\n+        if (splittedCursor.length!=2) {\n+            throw new VerificationException(\"Not able to parse invalid cursor\");\n+        }\n+\n+        String type = splittedCursor[0];\n+        CursorType cursorType = CursorType.getById(type);\n+\n+        if (cursorType!=CursorType.NULL) {\n+            switch(cursorType) {\n+                case DEFAULT:\n+                    DefaultCursor defaultCursor = DefaultCursor.from(splittedCursor[1]);\n+                    return handleDefaultCursorRequest(client, defaultCursor);\n+                case AGGREGATION:\n+                case JOIN:\n+                default: throw new VerificationException(\"Unsupported cursor\");\n+            }\n+        }\n+\n+        throw new VerificationException(\"Not able to parse invalid cursor\");\n+    }\n+\n+    private String handleDefaultCursorRequest(Client client, DefaultCursor cursor) {\n+        String previousScrollId = cursor.getScrollId();\n+        LocalClusterState clusterState = LocalClusterState.state();\n+        TimeValue scrollTimeout = clusterState.getSettingValue(CURSOR_KEEPALIVE);\n+        SearchResponse scrollResponse = client.prepareSearchScroll(previousScrollId).setScroll(scrollTimeout).get();\n+        SearchHits searchHits = scrollResponse.getHits();\n+        SearchHit[] searchHitArray = searchHits.getHits();\n+        String newScrollId = scrollResponse.getScrollId();\n+\n+        int rowsLeft = (int) cursor.getRowsLeft();\n+        int fetch = cursor.getFetchSize();\n+\n+        if (rowsLeft < fetch && rowsLeft < searchHitArray.length) {\n+            /**\n+             * This condition implies we are on the last page, and we might need to truncate the result from SearchHit[]\n+             * Avoid truncating in following two scenarios\n+             * 1. number of rows to be sent equals fetchSize\n+             * 2. size of SearchHit[] is already less that rows that needs to be sent\n+             *\n+             * Else truncate to desired number of rows\n+             */\n+            SearchHit[] newSearchHits = Arrays.copyOf(searchHitArray, rowsLeft);\n+            searchHits = new SearchHits(newSearchHits, searchHits.getTotalHits(), searchHits.getMaxScore());\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYxMjg4OA=="}, "originalCommit": {"oid": "14d2b7c9be30398188705911e319b055a511239f"}, "originalPosition": 128}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDQ5MjA3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/PrettyFormatRestExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzo1Mjo1N1rOGEu_pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzo1Mjo1N1rOGEu_pA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYxNzQ0NA==", "bodyText": "I think NullCursor could be a constant in Cursor interface and no need to create every time.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407617444", "createdAt": "2020-04-13T17:52:57Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/PrettyFormatRestExecutor.java", "diffHunk": "@@ -81,4 +91,29 @@ public String execute(Client client, Map<String, String> params, QueryAction que\n \n         return protocol.format();\n     }\n+\n+    /**\n+     * QueryActionElasticExecutor.executeAnyAction() returns SearchHits inside SearchResponse.\n+     * In order to get scroll ID if any, we need to execute DefaultQueryAction ourselves for SearchResponse.\n+     */\n+    private Protocol buildProtocolForDefaultQuery(Client client, DefaultQueryAction queryAction)\n+            throws SqlParseException {\n+\n+        SearchResponse response = (SearchResponse) queryAction.explain().get();\n+        String scrollId = response.getScrollId();\n+\n+        Protocol protocol;\n+        if (!Strings.isNullOrEmpty(scrollId)) {\n+            DefaultCursor defaultCursor = new DefaultCursor();\n+            defaultCursor.setScrollId(scrollId);\n+            defaultCursor.setLimit(queryAction.getSelect().getRowCount());\n+            defaultCursor.setFetchSize(queryAction.getSqlRequest().fetchSize());\n+            protocol = new Protocol(client, queryAction, response.getHits(), format, defaultCursor);\n+        } else {\n+            NullCursor nullCursor = new NullCursor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14d2b7c9be30398188705911e319b055a511239f"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDUxNzUyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzo1OTo0MVrOGEvPfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMDoxODozNlrOGEzyfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMTUwMw==", "bodyText": "Why not just change existing format and outputInJdbcFormat? I think ideally we should have single interface method in Protocol.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407621503", "createdAt": "2020-04-13T17:59:41Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -153,6 +182,30 @@ private String outputInTableFormat() {\n         return null;\n     }\n \n+    public String cursorFormat() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14d2b7c9be30398188705911e319b055a511239f"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY5NTk5Ng==", "bodyText": "True, ideally we should have single interface method in Protocol, but not doing it here for two reasons:\n\nWe don't support non-JDBC format for cursor.\nAlso protocol is different for cursor result  either datarows or datarows + cursor.\n\nWe can do a check to know if first page or subsequent pages, but the code does not turn out to be clean.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407695996", "createdAt": "2020-04-13T20:18:36Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -153,6 +182,30 @@ private String outputInTableFormat() {\n         return null;\n     }\n \n+    public String cursorFormat() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYyMTUwMw=="}, "originalCommit": {"oid": "14d2b7c9be30398188705911e319b055a511239f"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDYxNjQzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/SelectResultSet.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxODoyOTowMFrOGEwN7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxODozMTozNFrOGEwTWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYzNzQ4NQ==", "bodyText": "I saw this cursor populate logic and scroll close logic in both here and CursorResultExecutor. Is it due to different code path?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407637485", "createdAt": "2020-04-13T18:29:00Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/SelectResultSet.java", "diffHunk": "@@ -525,20 +579,66 @@ private void extractData() {\n \n             this.rows = populateRows(searchHits);\n             this.size = rows.size();\n-            this.totalHits = Math.max(size, // size may be greater than totalHits after nested rows be flatten\n-                    Optional.ofNullable(searchHits.getTotalHits()).map(th -> th.value)\n-                            .orElse(0L));\n-\n+            this.internalTotalHits = Optional.ofNullable(searchHits.getTotalHits()).map(th -> th.value).orElse(0L);\n+            // size may be greater than totalHits after nested rows be flatten\n+            this.totalHits = Math.max(size, internalTotalHits);\n         } else if (queryResult instanceof Aggregations) {\n             Aggregations aggregations = (Aggregations) queryResult;\n \n             this.rows = populateRows(aggregations);\n             this.size = rows.size();\n+            this.internalTotalHits = size;\n             // Total hits is not available from Aggregations so 'size' is used\n             this.totalHits = size;\n         }\n     }\n \n+    private void populateCursor() {\n+        switch(cursor.getType()) {\n+            case DEFAULT:\n+                populateDefaultCursor((DefaultCursor) cursor);\n+            default:\n+                return;\n+        }\n+    }\n+\n+    private void populateDefaultCursor(DefaultCursor cursor) {\n+        /**\n+         * Assumption: scrollId, fetchSize, limit already being set in\n+         * @see PrettyFormatRestExecutor.buildProtocolForDefaultQuery()\n+         */\n+\n+        Integer limit = cursor.getLimit();\n+        long rowsLeft = rowsLeft(cursor.getFetchSize(), cursor.getLimit());\n+        if (rowsLeft <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14d2b7c9be30398188705911e319b055a511239f"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYzODg3Mg==", "bodyText": "Yes, this logic is for first page request.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/390#discussion_r407638872", "createdAt": "2020-04-13T18:31:34Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/SelectResultSet.java", "diffHunk": "@@ -525,20 +579,66 @@ private void extractData() {\n \n             this.rows = populateRows(searchHits);\n             this.size = rows.size();\n-            this.totalHits = Math.max(size, // size may be greater than totalHits after nested rows be flatten\n-                    Optional.ofNullable(searchHits.getTotalHits()).map(th -> th.value)\n-                            .orElse(0L));\n-\n+            this.internalTotalHits = Optional.ofNullable(searchHits.getTotalHits()).map(th -> th.value).orElse(0L);\n+            // size may be greater than totalHits after nested rows be flatten\n+            this.totalHits = Math.max(size, internalTotalHits);\n         } else if (queryResult instanceof Aggregations) {\n             Aggregations aggregations = (Aggregations) queryResult;\n \n             this.rows = populateRows(aggregations);\n             this.size = rows.size();\n+            this.internalTotalHits = size;\n             // Total hits is not available from Aggregations so 'size' is used\n             this.totalHits = size;\n         }\n     }\n \n+    private void populateCursor() {\n+        switch(cursor.getType()) {\n+            case DEFAULT:\n+                populateDefaultCursor((DefaultCursor) cursor);\n+            default:\n+                return;\n+        }\n+    }\n+\n+    private void populateDefaultCursor(DefaultCursor cursor) {\n+        /**\n+         * Assumption: scrollId, fetchSize, limit already being set in\n+         * @see PrettyFormatRestExecutor.buildProtocolForDefaultQuery()\n+         */\n+\n+        Integer limit = cursor.getLimit();\n+        long rowsLeft = rowsLeft(cursor.getFetchSize(), cursor.getLimit());\n+        if (rowsLeft <= 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYzNzQ4NQ=="}, "originalCommit": {"oid": "14d2b7c9be30398188705911e319b055a511239f"}, "originalPosition": 145}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2197, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}