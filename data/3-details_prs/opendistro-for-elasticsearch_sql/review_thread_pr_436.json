{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2OTM2NDc5", "number": 436, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjoyNDo0NVrOD0du8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMDoxNTo0NVrOD0ftPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzM5Njk5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/data/model/ExprType.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjoyNDo0NVrOGJbBtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNDozNToyN1rOGJi8Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUzMzE3NQ==", "bodyText": "One of the two STRING should be STRUCT? Probably JDK EnumSet could be good use here if order doesn't matter.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412533175", "createdAt": "2020-04-21T22:24:45Z", "author": {"login": "dai-chen"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/data/model/ExprType.java", "diffHunk": "@@ -29,4 +32,7 @@\n     ARRAY,\n \n     MISSING;\n+\n+    public static List<ExprType> NUMBERS = Arrays.asList(DOUBLE, FLOAT, LONG, INTEGER);\n+    public static List<ExprType> VALID = Arrays.asList(DOUBLE, FLOAT, LONG, INTEGER, BOOLEAN, STRING, STRING, ARRAY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY2Mjg2Ng==", "bodyText": "sure, seem no where to use it now. remove now.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412662866", "createdAt": "2020-04-22T04:35:27Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/data/model/ExprType.java", "diffHunk": "@@ -29,4 +32,7 @@\n     ARRAY,\n \n     MISSING;\n+\n+    public static List<ExprType> NUMBERS = Arrays.asList(DOUBLE, FLOAT, LONG, INTEGER);\n+    public static List<ExprType> VALID = Arrays.asList(DOUBLE, FLOAT, LONG, INTEGER, BOOLEAN, STRING, STRING, ARRAY);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUzMzE3NQ=="}, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzQ3MjAzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/data/model/ExprType.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjo0ODozNVrOGJbrgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNDozNTo1MlrOGJi82A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0Mzg3Mg==", "bodyText": "Missed JavaDoc here.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412543872", "createdAt": "2020-04-21T22:48:35Z", "author": {"login": "dai-chen"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/data/model/ExprType.java", "diffHunk": "@@ -15,6 +15,9 @@\n \n package com.amazon.opendistroforelasticsearch.sql.data.model;\n \n+import java.util.Arrays;\n+import java.util.List;\n+\n public enum ExprType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY2MzAwMA==", "bodyText": "added.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412663000", "createdAt": "2020-04-22T04:35:52Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/data/model/ExprType.java", "diffHunk": "@@ -15,6 +15,9 @@\n \n package com.amazon.opendistroforelasticsearch.sql.data.model;\n \n+import java.util.Arrays;\n+import java.util.List;\n+\n public enum ExprType {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0Mzg3Mg=="}, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzQ4MzY3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/env/Environment.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjo1MjozMlrOGJbyIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNDozODoxMVrOGJi_3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0NTU3MA==", "bodyText": "The generic type name could be more clear? For example, Environment<Symbol, Value> or <Name, Value> etc.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412545570", "createdAt": "2020-04-21T22:52:32Z", "author": {"login": "dai-chen"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/env/Environment.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.env;\n+\n+/**\n+ * The definition of the environment.\n+ */\n+public interface Environment<T, R> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY2Mzc3NQ==", "bodyText": "Done. preferred <Expr, Value>, because there is no symbol concept defined.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412663775", "createdAt": "2020-04-22T04:38:11Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/env/Environment.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.env;\n+\n+/**\n+ * The definition of the environment.\n+ */\n+public interface Environment<T, R> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0NTU3MA=="}, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzYwNjI3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/FunctionSignature.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMzozMzozNVrOGJc0pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNDo1MDoxMVrOGJ6oIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU2MjU5OA==", "bodyText": "Since exception is thrown if function name or #args unmatched, I think we can also throw exception for param types directly?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412562598", "createdAt": "2020-04-21T23:33:35Z", "author": {"login": "dai-chen"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/FunctionSignature.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.amazon.opendistroforelasticsearch.sql.expression.function;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+\n+import java.util.List;\n+\n+/**\n+ * Function signature is composed by function name and arguments list.\n+ */\n+@Getter\n+@RequiredArgsConstructor\n+@EqualsAndHashCode\n+public class FunctionSignature {\n+    private final FunctionName functionName;\n+    private final List<ExprType> paramTypeList;\n+\n+    /**\n+     * Check the function signature match or not.\n+     *\n+     * @return 0: exactly match, Integer.MAX: not match, by widening rule small number means better match.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA1MDkxMw==", "bodyText": "Good point. Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r413050913", "createdAt": "2020-04-22T14:50:11Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/FunctionSignature.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.amazon.opendistroforelasticsearch.sql.expression.function;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+\n+import java.util.List;\n+\n+/**\n+ * Function signature is composed by function name and arguments list.\n+ */\n+@Getter\n+@RequiredArgsConstructor\n+@EqualsAndHashCode\n+public class FunctionSignature {\n+    private final FunctionName functionName;\n+    private final List<ExprType> paramTypeList;\n+\n+    /**\n+     * Check the function signature match or not.\n+     *\n+     * @return 0: exactly match, Integer.MAX: not match, by widening rule small number means better match.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU2MjU5OA=="}, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzYxMzg5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/FunctionResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMzozNjoyM1rOGJc4xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNDoyMjo1N1rOGKV7Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU2MzY1NA==", "bodyText": "So we just need the closest signature which means the PriorityQueue could be replaced by a FunctionSignature and an integer as its similarity?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412563654", "createdAt": "2020-04-21T23:36:23Z", "author": {"login": "dai-chen"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/FunctionResolver.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.amazon.opendistroforelasticsearch.sql.expression.function;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import lombok.Builder;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Singular;\n+\n+import java.util.AbstractMap;\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.PriorityQueue;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The Function Resolver hold the overload {@link FunctionExpressionBuilder} implementation.\n+ * is composed by {@link FunctionName} which identified the function name\n+ * and a map of {@link FunctionSignature} and {@link FunctionExpressionBuilder}\n+ * to represent the overloaded implementation\n+ */\n+@Builder\n+@RequiredArgsConstructor\n+public class FunctionResolver {\n+    @Getter\n+    private final FunctionName functionName;\n+    @Singular(\"functionBundle\")\n+    private final Map<FunctionSignature, FunctionExpressionBuilder> functionBundle;\n+\n+    /**\n+     * Resolve the {@link FunctionExpressionBuilder} by using input {@link FunctionSignature}.\n+     * If found the {@link FunctionExpressionBuilder} exactly match the input {@link FunctionSignature}, return it.\n+     * If applying the widening rule, found the most match one, return it.\n+     * If nothing found, throw {@link ExpressionEvaluationException}\n+     */\n+    public FunctionExpressionBuilder resolve(FunctionSignature unresolvedSignature) {\n+        PriorityQueue<Map.Entry<Integer, FunctionSignature>> functionMatchQueue = new PriorityQueue<>(\n+                Comparator.comparing(Map.Entry::getKey));\n+\n+        for (FunctionSignature functionSignature : functionBundle.keySet()) {\n+            int matchingDegree = unresolvedSignature.match(functionSignature);\n+            if (matchingDegree == 0) {\n+                return functionBundle.get(functionSignature);\n+            } else if (matchingDegree != Integer.MAX_VALUE) {\n+                functionMatchQueue.add(new AbstractMap.SimpleEntry<>(matchingDegree, functionSignature));\n+            }\n+        }\n+\n+        if (functionMatchQueue.isEmpty()) {\n+            throw new ExpressionEvaluationException(\n+                    String.format(\"%s function expected %s, but get %s\", functionName,\n+                            formatFunctions(functionBundle.keySet()),\n+                            formatTypes(unresolvedSignature.getParamTypeList())\n+                    ));\n+        } else {\n+            return functionBundle.get(functionMatchQueue.peek().getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5ODE3MA==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r413498170", "createdAt": "2020-04-23T04:22:57Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/FunctionResolver.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.amazon.opendistroforelasticsearch.sql.expression.function;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import lombok.Builder;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.Singular;\n+\n+import java.util.AbstractMap;\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.PriorityQueue;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The Function Resolver hold the overload {@link FunctionExpressionBuilder} implementation.\n+ * is composed by {@link FunctionName} which identified the function name\n+ * and a map of {@link FunctionSignature} and {@link FunctionExpressionBuilder}\n+ * to represent the overloaded implementation\n+ */\n+@Builder\n+@RequiredArgsConstructor\n+public class FunctionResolver {\n+    @Getter\n+    private final FunctionName functionName;\n+    @Singular(\"functionBundle\")\n+    private final Map<FunctionSignature, FunctionExpressionBuilder> functionBundle;\n+\n+    /**\n+     * Resolve the {@link FunctionExpressionBuilder} by using input {@link FunctionSignature}.\n+     * If found the {@link FunctionExpressionBuilder} exactly match the input {@link FunctionSignature}, return it.\n+     * If applying the widening rule, found the most match one, return it.\n+     * If nothing found, throw {@link ExpressionEvaluationException}\n+     */\n+    public FunctionExpressionBuilder resolve(FunctionSignature unresolvedSignature) {\n+        PriorityQueue<Map.Entry<Integer, FunctionSignature>> functionMatchQueue = new PriorityQueue<>(\n+                Comparator.comparing(Map.Entry::getKey));\n+\n+        for (FunctionSignature functionSignature : functionBundle.keySet()) {\n+            int matchingDegree = unresolvedSignature.match(functionSignature);\n+            if (matchingDegree == 0) {\n+                return functionBundle.get(functionSignature);\n+            } else if (matchingDegree != Integer.MAX_VALUE) {\n+                functionMatchQueue.add(new AbstractMap.SimpleEntry<>(matchingDegree, functionSignature));\n+            }\n+        }\n+\n+        if (functionMatchQueue.isEmpty()) {\n+            throw new ExpressionEvaluationException(\n+                    String.format(\"%s function expected %s, but get %s\", functionName,\n+                            formatFunctions(functionBundle.keySet()),\n+                            formatTypes(unresolvedSignature.getParamTypeList())\n+                    ));\n+        } else {\n+            return functionBundle.get(functionMatchQueue.peek().getValue());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU2MzY1NA=="}, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzYzMzEwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/scalar/OperatorUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMzo0MzoyMlrOGJdDIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjowMTowMlrOGJ-PDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU2NjMwNw==", "bodyText": "Better to have some doc for T, U, R's meaning.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412566307", "createdAt": "2020-04-21T23:43:22Z", "author": {"login": "dai-chen"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/scalar/OperatorUtils.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.scalar;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.FunctionExpression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.env.Environment;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.FunctionExpressionBuilder;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.FunctionName;\n+import lombok.experimental.UtilityClass;\n+\n+import java.util.function.BiFunction;\n+import java.util.function.Function;\n+\n+@UtilityClass\n+public class OperatorUtils {\n+    public static <T, R> FunctionExpressionBuilder binaryOperator(FunctionName functionName,\n+                                                                  BiFunction<T, T, R> function,\n+                                                                  Function<ExprValue, T> observer,\n+                                                                  ExprType returnType) {\n+        return binaryOperator(functionName, function, observer, observer, returnType);\n+    }\n+\n+    public static <T, U, R> FunctionExpressionBuilder binaryOperator(FunctionName functionName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzExMDAzMQ==", "bodyText": "Sure. Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r413110031", "createdAt": "2020-04-22T16:01:02Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/scalar/OperatorUtils.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.scalar;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.FunctionExpression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.env.Environment;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.FunctionExpressionBuilder;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.FunctionName;\n+import lombok.experimental.UtilityClass;\n+\n+import java.util.function.BiFunction;\n+import java.util.function.Function;\n+\n+@UtilityClass\n+public class OperatorUtils {\n+    public static <T, R> FunctionExpressionBuilder binaryOperator(FunctionName functionName,\n+                                                                  BiFunction<T, T, R> function,\n+                                                                  Function<ExprValue, T> observer,\n+                                                                  ExprType returnType) {\n+        return binaryOperator(functionName, function, observer, observer, returnType);\n+    }\n+\n+    public static <T, U, R> FunctionExpressionBuilder binaryOperator(FunctionName functionName,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU2NjMwNw=="}, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzY2NTkzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/FunctionSignature.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMzo1NTowM1rOGJdUZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNDo1MDozN1rOGJ6prw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU3MDcyNA==", "bodyText": "Is it better to use IMPOSSIBLE_WIDENING?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412570724", "createdAt": "2020-04-21T23:55:03Z", "author": {"login": "dai-chen"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/FunctionSignature.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.amazon.opendistroforelasticsearch.sql.expression.function;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+\n+import java.util.List;\n+\n+/**\n+ * Function signature is composed by function name and arguments list.\n+ */\n+@Getter\n+@RequiredArgsConstructor\n+@EqualsAndHashCode\n+public class FunctionSignature {\n+    private final FunctionName functionName;\n+    private final List<ExprType> paramTypeList;\n+\n+    /**\n+     * Check the function signature match or not.\n+     *\n+     * @return 0: exactly match, Integer.MAX: not match, by widening rule small number means better match.\n+     */\n+    public int match(FunctionSignature functionSignature) {\n+        if (!functionName.equals(functionSignature.getFunctionName())) {\n+            throw new ExpressionEvaluationException(\n+                    String.format(\"expression name: %s and %s doesn't match\",\n+                            functionName,\n+                            functionSignature.getFunctionName()));\n+        }\n+        List<ExprType> functionTypeList = functionSignature.getParamTypeList();\n+        if (paramTypeList.size() != functionTypeList.size()) {\n+            throw new ExpressionEvaluationException(\n+                    String.format(\"%s expression expected %d argument, but actually are %d\",\n+                            functionName,\n+                            paramTypeList.size(),\n+                            functionTypeList.size()));\n+        }\n+        int matchDegree = 0;\n+        for (int i = 0; i < paramTypeList.size(); i++) {\n+            ExprType paramType = paramTypeList.get(i);\n+            ExprType funcType = functionTypeList.get(i);\n+            int match = WideningTypeRule.distance(paramType, funcType);\n+            if (match == Integer.MAX_VALUE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA1MTMxMQ==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r413051311", "createdAt": "2020-04-22T14:50:37Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/FunctionSignature.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.amazon.opendistroforelasticsearch.sql.expression.function;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.RequiredArgsConstructor;\n+\n+import java.util.List;\n+\n+/**\n+ * Function signature is composed by function name and arguments list.\n+ */\n+@Getter\n+@RequiredArgsConstructor\n+@EqualsAndHashCode\n+public class FunctionSignature {\n+    private final FunctionName functionName;\n+    private final List<ExprType> paramTypeList;\n+\n+    /**\n+     * Check the function signature match or not.\n+     *\n+     * @return 0: exactly match, Integer.MAX: not match, by widening rule small number means better match.\n+     */\n+    public int match(FunctionSignature functionSignature) {\n+        if (!functionName.equals(functionSignature.getFunctionName())) {\n+            throw new ExpressionEvaluationException(\n+                    String.format(\"expression name: %s and %s doesn't match\",\n+                            functionName,\n+                            functionSignature.getFunctionName()));\n+        }\n+        List<ExprType> functionTypeList = functionSignature.getParamTypeList();\n+        if (paramTypeList.size() != functionTypeList.size()) {\n+            throw new ExpressionEvaluationException(\n+                    String.format(\"%s expression expected %d argument, but actually are %d\",\n+                            functionName,\n+                            paramTypeList.size(),\n+                            functionTypeList.size()));\n+        }\n+        int matchDegree = 0;\n+        for (int i = 0; i < paramTypeList.size(); i++) {\n+            ExprType paramType = paramTypeList.get(i);\n+            ExprType funcType = functionTypeList.get(i);\n+            int match = WideningTypeRule.distance(paramType, funcType);\n+            if (match == Integer.MAX_VALUE) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU3MDcyNA=="}, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzY2ODU3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/WideningTypeRule.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMzo1NTo1OVrOGJdVxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNToxNzo0NVrOGJ8E5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU3MTA3Ng==", "bodyText": "\"but distance(FLOAT, INTEGER) =\" impossible?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412571076", "createdAt": "2020-04-21T23:55:59Z", "author": {"login": "dai-chen"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/WideningTypeRule.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.function;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import com.google.common.collect.ImmutableMap;\n+import lombok.experimental.UtilityClass;\n+\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.ARRAY;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.BOOLEAN;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.DOUBLE;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.FLOAT;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.INTEGER;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.LONG;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.MISSING;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.STRING;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.STRUCT;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.UNKNOWN;\n+\n+/**\n+ * The definition of widening type rule for expression value.\n+ * ExprType     Widens to data types\n+ * INTEGER      LONG, FLOAT, DOUBLE\n+ * LONG         FLOAT, DOUBLE\n+ * FLOAT        DOUBLE\n+ * DOUBLE       DOUBLE\n+ * STRING       STRING\n+ * BOOLEAN      BOOLEAN\n+ * ARRAY        ARRAY\n+ * STRUCT       STRUCT\n+ */\n+@UtilityClass\n+public class WideningTypeRule {\n+    public static final int IMPOSSIBLE_WIDENING = Integer.MAX_VALUE;\n+    public static final int TYPE_EQUAL = 0;\n+\n+    private static final Map<ExprType, ExprType> typeToWidenParent;\n+\n+    static {\n+        ImmutableMap.Builder<ExprType, ExprType> builder = new ImmutableMap.Builder<>();\n+        builder.put(INTEGER, LONG);\n+        builder.put(LONG, FLOAT);\n+        builder.put(FLOAT, DOUBLE);\n+        builder.put(DOUBLE, UNKNOWN);\n+        builder.put(STRING, UNKNOWN);\n+        builder.put(BOOLEAN, UNKNOWN);\n+        builder.put(ARRAY, UNKNOWN);\n+        builder.put(STRUCT, UNKNOWN);\n+        builder.put(MISSING, UNKNOWN);\n+        typeToWidenParent = builder.build();\n+    }\n+\n+    /**\n+     * The widening distance is calculated from the leaf to root.\n+     * e.g. distance(INTEGER, FLOAT) = 2, but distance(FLOAT, INTEGER) =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA3NDY2Mw==", "bodyText": "Done.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r413074663", "createdAt": "2020-04-22T15:17:45Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/function/WideningTypeRule.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.function;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.exception.ExpressionEvaluationException;\n+import com.google.common.collect.ImmutableMap;\n+import lombok.experimental.UtilityClass;\n+\n+import java.util.Map;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.ARRAY;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.BOOLEAN;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.DOUBLE;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.FLOAT;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.INTEGER;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.LONG;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.MISSING;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.STRING;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.STRUCT;\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprType.UNKNOWN;\n+\n+/**\n+ * The definition of widening type rule for expression value.\n+ * ExprType     Widens to data types\n+ * INTEGER      LONG, FLOAT, DOUBLE\n+ * LONG         FLOAT, DOUBLE\n+ * FLOAT        DOUBLE\n+ * DOUBLE       DOUBLE\n+ * STRING       STRING\n+ * BOOLEAN      BOOLEAN\n+ * ARRAY        ARRAY\n+ * STRUCT       STRUCT\n+ */\n+@UtilityClass\n+public class WideningTypeRule {\n+    public static final int IMPOSSIBLE_WIDENING = Integer.MAX_VALUE;\n+    public static final int TYPE_EQUAL = 0;\n+\n+    private static final Map<ExprType, ExprType> typeToWidenParent;\n+\n+    static {\n+        ImmutableMap.Builder<ExprType, ExprType> builder = new ImmutableMap.Builder<>();\n+        builder.put(INTEGER, LONG);\n+        builder.put(LONG, FLOAT);\n+        builder.put(FLOAT, DOUBLE);\n+        builder.put(DOUBLE, UNKNOWN);\n+        builder.put(STRING, UNKNOWN);\n+        builder.put(BOOLEAN, UNKNOWN);\n+        builder.put(ARRAY, UNKNOWN);\n+        builder.put(STRUCT, UNKNOWN);\n+        builder.put(MISSING, UNKNOWN);\n+        typeToWidenParent = builder.build();\n+    }\n+\n+    /**\n+     * The widening distance is calculated from the leaf to root.\n+     * e.g. distance(INTEGER, FLOAT) = 2, but distance(FLOAT, INTEGER) =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU3MTA3Ng=="}, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzcyMDMxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/scalar/OperatorUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMDoxNTo0NVrOGJdw-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNDoyMjozMlrOGKV60A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU3ODA0Mg==", "bodyText": "Just a question, do we handle NULL or MISSING somewhere? Not sure about SPL spec but both are following some rules to propagate during evaluation in SQL and PartiQL spec.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r412578042", "createdAt": "2020-04-22T00:15:45Z", "author": {"login": "dai-chen"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/scalar/OperatorUtils.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.scalar;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.FunctionExpression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.env.Environment;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.FunctionExpressionBuilder;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.FunctionName;\n+import lombok.experimental.UtilityClass;\n+\n+import java.util.function.BiFunction;\n+import java.util.function.Function;\n+\n+@UtilityClass\n+public class OperatorUtils {\n+    public static <T, R> FunctionExpressionBuilder binaryOperator(FunctionName functionName,\n+                                                                  BiFunction<T, T, R> function,\n+                                                                  Function<ExprValue, T> observer,\n+                                                                  ExprType returnType) {\n+        return binaryOperator(functionName, function, observer, observer, returnType);\n+    }\n+\n+    public static <T, U, R> FunctionExpressionBuilder binaryOperator(FunctionName functionName,\n+                                                                     BiFunction<T, U, R> function,\n+                                                                     Function<ExprValue, T> observer1,\n+                                                                     Function<ExprValue, U> observer2,\n+                                                                     ExprType returnType) {\n+        return arguments -> new FunctionExpression(functionName, arguments) {\n+            @Override\n+            public ExprValue valueOf(Environment<Expression, ExprValue> env) {\n+                ExprValue arg1 = arguments.get(0).valueOf(env);\n+                ExprValue arg2 = arguments.get(1).valueOf(env);\n+                return ExprValueUtils.fromObjectValue(\n+                        function.apply(observer1.apply(arg1), observer2.apply(arg2)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ5ODA2NA==", "bodyText": "Thanks for this important call out. Add support for null value and missing value. Update the description doc accordingly.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/436#discussion_r413498064", "createdAt": "2020-04-23T04:22:32Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/expression/scalar/OperatorUtils.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.expression.scalar;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprType;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils;\n+import com.amazon.opendistroforelasticsearch.sql.expression.Expression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.FunctionExpression;\n+import com.amazon.opendistroforelasticsearch.sql.expression.env.Environment;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.FunctionExpressionBuilder;\n+import com.amazon.opendistroforelasticsearch.sql.expression.function.FunctionName;\n+import lombok.experimental.UtilityClass;\n+\n+import java.util.function.BiFunction;\n+import java.util.function.Function;\n+\n+@UtilityClass\n+public class OperatorUtils {\n+    public static <T, R> FunctionExpressionBuilder binaryOperator(FunctionName functionName,\n+                                                                  BiFunction<T, T, R> function,\n+                                                                  Function<ExprValue, T> observer,\n+                                                                  ExprType returnType) {\n+        return binaryOperator(functionName, function, observer, observer, returnType);\n+    }\n+\n+    public static <T, U, R> FunctionExpressionBuilder binaryOperator(FunctionName functionName,\n+                                                                     BiFunction<T, U, R> function,\n+                                                                     Function<ExprValue, T> observer1,\n+                                                                     Function<ExprValue, U> observer2,\n+                                                                     ExprType returnType) {\n+        return arguments -> new FunctionExpression(functionName, arguments) {\n+            @Override\n+            public ExprValue valueOf(Environment<Expression, ExprValue> env) {\n+                ExprValue arg1 = arguments.get(0).valueOf(env);\n+                ExprValue arg2 = arguments.get(1).valueOf(env);\n+                return ExprValueUtils.fromObjectValue(\n+                        function.apply(observer1.apply(arg1), observer2.apply(arg2)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU3ODA0Mg=="}, "originalCommit": {"oid": "0a6aae95203cb2f8de26b00d3b1d2d277a18a7a4"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2049, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}