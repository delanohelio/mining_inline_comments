{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMTY0OTcy", "number": 753, "title": "Support ranking window functions", "bodyText": "Issue #, if available: #751\nDescription of changes: This PR is to add basic support for ranking window functions.\n\nAdd window operator and related code changes: AST/logical/physical window operator, visitor and other util code.\nAdd ranking window functions: ROW_NUMBER, RANK and DENSE_RANK.\nRename PPL_ASC/DESC to DEFAULT_ASC/DESC.\n\nTo-Dos: Window function name: for now toString() is used as symbol name. This restricts multiple use of same window function, ex. SELECT RANK() OVER(...), RANK() OVER(...).\nDesign: In Abstract Syntax Tree (AST), the window function is still on the project item list in Project AST node. After analyzing, it is separated into an individual logical Window operator with window function and its definition along with Sort operator that guarantee order of input data of window operator. Eventually both converts to its correspondent physical operators.\n\nTesting: Add UT and comparison test: https://github.com/dai-chen/sql/blob/window-function-poc/integ-test/src/test/resources/correctness/queries/window.txt\nDocumentation: (Note that you need to enable the new SQL engine to try out this feature: https://github.com/opendistro-for-elasticsearch/sql/blob/master/docs/user/admin/settings.rst#opendistro-sql-engine-new-enabled)\n\nRanking functions: https://github.com/opendistro-for-elasticsearch/sql/blob/develop/docs/user/dql/window.rst\nLimitations: https://github.com/opendistro-for-elasticsearch/sql/blob/develop/docs/user/limitations/limitations.rst\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-09-22T20:02:53Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/753", "merged": true, "mergeCommit": {"oid": "7e5f5820f9b668e5f6c6caeb38d6558e5ff7eb24"}, "closed": true, "closedAt": "2020-10-09T21:41:41Z", "author": {"login": "dai-chen"}, "timelineItems": {"totalCount": 43, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEvXfsAH2gAyNDkxMTY0OTcyOjY1MzhjYTFiYTg1NWVhMzg3Y2EzMmNjNjgzMzIyMDJkZDhkNGQ4MGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQ9AfTAH2gAyNDkxMTY0OTcyOjFkMWQ4ZWIxZjBjMzI2ZmQ3MWQ3ZjQwMGE3ZjEyNDUxNWNhYjY5ZjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6538ca1ba855ea387ca32cc68332202dd8d4d80f", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6538ca1ba855ea387ca32cc68332202dd8d4d80f", "committedDate": "2020-09-01T22:44:08Z", "message": "Build AST and logical window node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c68fb6f6ca90d41a1881635dbbe00ba9dd152bd7", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c68fb6f6ca90d41a1881635dbbe00ba9dd152bd7", "committedDate": "2020-09-01T23:37:22Z", "message": "Build physical plan"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52ce14f50fb90dc320ea8a63824fb74f55d0e38d", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/52ce14f50fb90dc320ea8a63824fb74f55d0e38d", "committedDate": "2020-09-02T00:42:34Z", "message": "Implement row number"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9711467767d54e5aaad115df7c318003a63b9289", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/9711467767d54e5aaad115df7c318003a63b9289", "committedDate": "2020-09-18T19:06:02Z", "message": "Add UT for AST builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e41faf22736bdd3242b9acacae836eae03de8f69", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e41faf22736bdd3242b9acacae836eae03de8f69", "committedDate": "2020-09-18T22:04:39Z", "message": "Add UT for analyzer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e471ba188629b6a903031246bbb8947ef2828a12", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e471ba188629b6a903031246bbb8947ef2828a12", "committedDate": "2020-09-18T22:26:58Z", "message": "Add UT for implementor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d98db6ca522640a98651ee2f69bb8ecb1f18b0a9", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d98db6ca522640a98651ee2f69bb8ecb1f18b0a9", "committedDate": "2020-09-18T22:29:48Z", "message": "Pass checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "045e31c68ef825af3a08e90d30207e4c5bd55db3", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/045e31c68ef825af3a08e90d30207e4c5bd55db3", "committedDate": "2020-09-18T22:35:17Z", "message": "Pass jacoco"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a1af4594152aa4b02ace75b71bf097c28a7494", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c1a1af4594152aa4b02ace75b71bf097c28a7494", "committedDate": "2020-09-18T23:50:00Z", "message": "Refactor window frame"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9609378cb181c68e50e0b56f1bb6da8fa8915ce4", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/9609378cb181c68e50e0b56f1bb6da8fa8915ce4", "committedDate": "2020-09-18T23:59:24Z", "message": "Refactor ranking function base"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "972e2f16f10345823e22887df3eb2f83d1d65c03", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/972e2f16f10345823e22887df3eb2f83d1d65c03", "committedDate": "2020-09-19T00:07:48Z", "message": "Pass jacoco"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "888b8baf14936e5fbb5867802628a8027a1efba3", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/888b8baf14936e5fbb5867802628a8027a1efba3", "committedDate": "2020-09-19T00:41:48Z", "message": "Add rank function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e68842c5f76a3d92c16a93affb95b94a17e8afc4", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e68842c5f76a3d92c16a93affb95b94a17e8afc4", "committedDate": "2020-09-19T00:51:33Z", "message": "Add dense rank function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5aaede09bb07671a2003a29bb4f48a44541ef5bc", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5aaede09bb07671a2003a29bb4f48a44541ef5bc", "committedDate": "2020-09-22T17:01:05Z", "message": "Add UT for window operator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b91b09f12946724bbd6c6e7dcda7c9d3c2aa9125", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b91b09f12946724bbd6c6e7dcda7c9d3c2aa9125", "committedDate": "2020-09-22T18:58:48Z", "message": "Merge branch 'develop' into window-function-poc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03f73e0342c9a729731006cb4e23e3198c3b94f1", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/03f73e0342c9a729731006cb4e23e3198c3b94f1", "committedDate": "2020-09-22T20:59:51Z", "message": "Add explain and UT for window operator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ccfd34dd412de4978fde84d9fdd3c7ec1defbca", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0ccfd34dd412de4978fde84d9fdd3c7ec1defbca", "committedDate": "2020-09-22T23:10:05Z", "message": "Add doctest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83ae07500b5a7d2e38e110aefb58eb540cda5692", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/83ae07500b5a7d2e38e110aefb58eb540cda5692", "committedDate": "2020-09-22T23:44:46Z", "message": "Support sort desc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d93eda0a57644b28cd19d7bde8f9fcf33e3f2fee", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d93eda0a57644b28cd19d7bde8f9fcf33e3f2fee", "committedDate": "2020-09-22T23:51:49Z", "message": "Add comparison test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d68411d163865b66b7db2b56748eb9f8aca0ee2c", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d68411d163865b66b7db2b56748eb9f8aca0ee2c", "committedDate": "2020-09-23T17:11:20Z", "message": "Add comparison test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32d1e227f7608fb387aaac87bd9ace15cccfba11", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/32d1e227f7608fb387aaac87bd9ace15cccfba11", "committedDate": "2020-09-23T22:58:29Z", "message": "Enable memory protection for SQL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38be399e503b3b20c96166ae9a74ebe134d7e952", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/38be399e503b3b20c96166ae9a74ebe134d7e952", "committedDate": "2020-09-24T17:03:02Z", "message": "Merge branch 'develop' into window-function-poc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbb3d66163d66c596b7e085a7be3ffb014d55d24", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/fbb3d66163d66c596b7e085a7be3ffb014d55d24", "committedDate": "2020-09-24T20:25:21Z", "message": "Optimize window function in project list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7221c83199dae9504032b8cf712d8af94b7c332", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c7221c83199dae9504032b8cf712d8af94b7c332", "committedDate": "2020-09-24T20:46:23Z", "message": "Update doctest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2d8db3055929ae9dcb2c397ba9bb2c7ee109b76", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a2d8db3055929ae9dcb2c397ba9bb2c7ee109b76", "committedDate": "2020-09-24T20:59:55Z", "message": "Pass jacoco"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97804b13a2fd9c5b751f194925b19ac0ecd2c512", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/97804b13a2fd9c5b751f194925b19ac0ecd2c512", "committedDate": "2020-09-24T22:24:27Z", "message": "Rename default sort option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e9e0cfa012322cbef380b72bc751371567cd88a", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0e9e0cfa012322cbef380b72bc751371567cd88a", "committedDate": "2020-09-24T22:32:21Z", "message": "Set sort count to 0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffb3d8e515b81209393cfb5e06cd5b30b6648bc2", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ffb3d8e515b81209393cfb5e06cd5b30b6648bc2", "committedDate": "2020-09-24T23:37:11Z", "message": "Fix reference replace bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "986332380c87c78180dae7ca39dfce40c3667cbe", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/986332380c87c78180dae7ca39dfce40c3667cbe", "committedDate": "2020-09-25T00:16:38Z", "message": "Add more comparison test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95020741a283e2d2138a4e9f805e6480030b91a7", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/95020741a283e2d2138a4e9f805e6480030b91a7", "committedDate": "2020-09-25T00:22:37Z", "message": "Add more comparison test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d16ee793cb8fa90ceec14b1863288e9afaa95e1a", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d16ee793cb8fa90ceec14b1863288e9afaa95e1a", "committedDate": "2020-09-29T21:30:07Z", "message": "Merge branch 'develop' into window-function-poc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efb30368dd7c0893a87a9c90086f00e0704118d0", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/efb30368dd7c0893a87a9c90086f00e0704118d0", "committedDate": "2020-09-30T00:02:46Z", "message": "Prepare PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdcfa03fcbc335a7f0f274238a6bda98e4dfe2bd", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/bdcfa03fcbc335a7f0f274238a6bda98e4dfe2bd", "committedDate": "2020-09-30T00:39:47Z", "message": "Fix empty order by issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da7dc306eabb53a85e610f57bd3a33e01f05bfc2", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/da7dc306eabb53a85e610f57bd3a33e01f05bfc2", "committedDate": "2020-09-30T17:48:20Z", "message": "Add order by in test queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f08c7de39918765d9250b19cac669091655e4b1", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8f08c7de39918765d9250b19cac669091655e4b1", "committedDate": "2020-09-30T18:29:12Z", "message": "Add limitation doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzcxMTU4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/753#pullrequestreview-502371158", "createdAt": "2020-10-05T19:51:50Z", "commit": {"oid": "8f08c7de39918765d9250b19cac669091655e4b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOTo1MTo1MFrOHcreJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOTo1MTo1MFrOHcreJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgzNDQwNA==", "bodyText": "How about this?\nFor now, only the field defined in index is allowd, all the other caculated fields (calculated by scalar or aggregated function) is not allowed.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/753#discussion_r499834404", "createdAt": "2020-10-05T19:51:50Z", "author": {"login": "penghuo"}, "path": "docs/user/limitations/limitations.rst", "diffHunk": "@@ -54,6 +54,17 @@ For example, e.g. `SELECT depo.name, avg(empo.age) FROM empo JOIN depo WHERE emp\n Here's a link to the Github issue - [Issue 110](https://github.com/opendistro-for-elasticsearch/sql/issues/110).\n \n \n+Limitations on Window Functions\n+===============================\n+\n+For now it's not allowed to use non-regular fields (calculated by scalar or aggregated function) in window definition. For example, ``avg_flight_time`` is not accessible to the rank window definition as follows::", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f08c7de39918765d9250b19cac669091655e4b1"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dff099c593bde689a0eadc78781996ecb1a18061", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/dff099c593bde689a0eadc78781996ecb1a18061", "committedDate": "2020-10-06T20:39:46Z", "message": "Merge branch 'develop' into window-function-poc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af644d7b02f572de79f423a87e3e7a3e662e7d66", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/af644d7b02f572de79f423a87e3e7a3e662e7d66", "committedDate": "2020-10-07T19:16:07Z", "message": "Refactor window frame"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d074e0e0ec069eca45b9aad74be38258e1b1c84", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6d074e0e0ec069eca45b9aad74be38258e1b1c84", "committedDate": "2020-10-07T20:48:34Z", "message": "Add javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23f25f49bd195349ce41807d3af0847d29f603e9", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/23f25f49bd195349ce41807d3af0847d29f603e9", "committedDate": "2020-10-07T21:57:33Z", "message": "Address comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0OTQ1MzE5", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/753#pullrequestreview-504945319", "createdAt": "2020-10-08T16:10:39Z", "commit": {"oid": "23f25f49bd195349ce41807d3af0847d29f603e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1ODYzMzA1", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/753#pullrequestreview-505863305", "createdAt": "2020-10-09T17:26:16Z", "commit": {"oid": "23f25f49bd195349ce41807d3af0847d29f603e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d1d8eb1f0c326fd71d7f400a7f124515cab69f6", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1d1d8eb1f0c326fd71d7f400a7f124515cab69f6", "committedDate": "2020-10-09T21:24:46Z", "message": "Merge branch 'develop' into window-function-poc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 653, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}