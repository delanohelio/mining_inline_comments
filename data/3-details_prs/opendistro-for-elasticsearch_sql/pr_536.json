{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNDk3MTU0", "number": 536, "title": "Enforce comparison test in new SQL module", "bodyText": "Issue #, if available: #535\nDescription of changes: Last year we developed a test framework which verifies result by comparing with other SQL implementation. It was integrated with Gradle task to automate the testing. However, due to problems in old codebase, it was only used for reporting instead of being mandatory for plugin build. Now as we start shift to new query engine, the success of comparison test results should be enforced. Reference: https://github.com/opendistro-for-elasticsearch/sql/blob/develop/docs/dev/Testing.md.\n\nAdd SQL test base class and a new IT class SQLCorrectnessIT to read all queries in specific folder.\nImprove test framework by explaining the difference that caused the test case failure.\n\nFor now test case file is simply a txt file organized in folders under src/resources/correctness in integ-test module. There are 3 categories:\n\nexpressions: test cases for all expressions such as arithmetic, predicate and function expressions.\nqueries: test cases for different queries such as SELECT-FROM-WHERE, GROUP BY, JOINs etc.\nbugfixes: test cases for bug fix to make sure no regression in future release.\n\n$ tree -L 2 -I \"resources\" integ-test/src/test/resources/correctness\ninteg-test/src/test/resources/correctness\n\u251c\u2500\u2500 bugfixes\n\u2502   \u2514\u2500\u2500 521.txt\n\u251c\u2500\u2500 expressions\n\u2502   \u251c\u2500\u2500 arithmetics.txt\n\u2502   \u251c\u2500\u2500 functions.txt\n\u2502   \u251c\u2500\u2500 literals.txt\n\u2502   \u2514\u2500\u2500 predicates.txt\n\u251c\u2500\u2500 queries\n\u2502   \u251c\u2500\u2500 groupby.txt\n\u2502   \u251c\u2500\u2500 joins.txt\n\u2502   \u251c\u2500\u2500 select.txt\n\u2502   \u2514\u2500\u2500 subqueries.txt\n\u251c\u2500\u2500 kibana_sample_data_ecommerce.csv\n\u251c\u2500\u2500 kibana_sample_data_ecommerce.json\n\u251c\u2500\u2500 kibana_sample_data_flights.csv\n\u2514\u2500\u2500 kibana_sample_data_flights.json\n\nFor example, for failed test case, a new explain field is added to describe which column type or data row is different.\n{\n   \"summary\":{\n      \"total\":1,\n      \"success\":0,\n      \"failure\":1\n   },\n   \"tests\":[\n      {\n         \"result\":\"Failed\",\n         \"explain\":\"Data row at [0] is different: this=[Row(values=[hello])], other=[Row(values=[world])]\",\n         \"resultSets\":[\n            {\n               \"schema\":[\n                  {\n                     \"name\":\"firstName\",\n                     \"type\":\"text\"\n                  }\n               ],\n               \"dataRows\":[\n                  [\n                     \"hello\"\n                  ]\n               ],\n               \"database\":\"Elasticsearch\"\n            },\n            {\n               \"schema\":[\n                  {\n                     \"name\":\"firstName\",\n                     \"type\":\"text\"\n                  }\n               ],\n               \"dataRows\":[\n                  [\n                     \"world\"\n                  ]\n               ],\n               \"database\":\"H2\"\n            }\n         ],\n         \"id\":1,\n         \"sql\":\"SELECT * FROM accounts\"\n      }\n   ]\n}\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-06-29T15:38:49Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/536", "merged": true, "mergeCommit": {"oid": "d60997bd82077ded62d4f61eea38612410fd5a6f"}, "closed": true, "closedAt": "2020-07-01T16:37:07Z", "author": {"login": "dai-chen"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvLnU5AH2gAyNDQxNDk3MTU0OmMzMThkYzVmM2NhNGI2ODdmOGFjY2E2NjRmMTgyODZiNGI0OGU0YmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwsi1TgFqTQ0MTAwOTYwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c318dc5f3ca4b687f8acca664f18286b4b48e4bb", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c318dc5f3ca4b687f8acca664f18286b4b48e4bb", "committedDate": "2020-06-26T23:12:26Z", "message": "Add comparison test base class and sample IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5023d4cf0616879e6ce12ad830a3b885221037d5", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5023d4cf0616879e6ce12ad830a3b885221037d5", "committedDate": "2020-06-26T23:12:26Z", "message": "Close connection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "099fd2a25e390d69ac7b26b4d8f7e228ec7ebea7", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/099fd2a25e390d69ac7b26b4d8f7e228ec7ebea7", "committedDate": "2020-06-26T23:12:26Z", "message": "Add refresh=true"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9957c3ba10e3f0d30e31568060d5196e28bfb0fb", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/9957c3ba10e3f0d30e31568060d5196e28bfb0fb", "committedDate": "2020-06-26T23:12:26Z", "message": "Add refresh=true"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ac52fd0572b9294060eefe0a441a6b60ec171de", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6ac52fd0572b9294060eefe0a441a6b60ec171de", "committedDate": "2020-06-26T23:12:27Z", "message": "Add comment to explain why not close REST client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f13832301847101a443fe8d40df33b336318fbe0", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f13832301847101a443fe8d40df33b336318fbe0", "committedDate": "2020-06-26T23:12:27Z", "message": "Organize test case in txt file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a684062f357057e7176190eb5504314b703aa5e", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6a684062f357057e7176190eb5504314b703aa5e", "committedDate": "2020-06-26T23:14:06Z", "message": "Support fetch size 0 which is default request by JDBC driver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "900b465f5ed1ac570252036cbd4468aff9c5ae37", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/900b465f5ed1ac570252036cbd4468aff9c5ae37", "committedDate": "2020-06-26T23:14:20Z", "message": "Explain comparison test result for easy troubleshooting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f1283498209028defb94a0c851f6929ae9932c0", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7f1283498209028defb94a0c851f6929ae9932c0", "committedDate": "2020-06-26T23:14:20Z", "message": "Run queries in a file by a batch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51de1d558979c202539cfb445d1825c5672b0c5e", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/51de1d558979c202539cfb445d1825c5672b0c5e", "committedDate": "2020-06-26T23:14:21Z", "message": "Prepare for PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a887e89e61926c1adbf71bcc1fe33f5ebc846c18", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a887e89e61926c1adbf71bcc1fe33f5ebc846c18", "committedDate": "2020-06-26T23:43:23Z", "message": "Prepare PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15f972d332b13ccdbd23823495158579f25fd08a", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/15f972d332b13ccdbd23823495158579f25fd08a", "committedDate": "2020-06-29T15:14:43Z", "message": "Remove unused query files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMjk5ODI0", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/536#pullrequestreview-440299824", "createdAt": "2020-06-30T18:56:21Z", "commit": {"oid": "15f972d332b13ccdbd23823495158579f25fd08a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxODo1NjoyMVrOGrKSyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxODo1NjoyMVrOGrKSyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzkxMDYwMQ==", "bodyText": "Shall we also include missing values in compareTo?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/536#discussion_r447910601", "createdAt": "2020-06-30T18:56:21Z", "author": {"login": "chloe-zh"}, "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/correctness/runner/resultset/Row.java", "diffHunk": "@@ -56,4 +57,32 @@ private Object roundFloatNum(Object value) {\n     return value;\n   }\n \n+  @SuppressWarnings(\"unchecked\")\n+  @Override\n+  public int compareTo(Row other) {\n+    List<Object> thisObjects = new ArrayList<>(values);\n+    List<Object> otherObjects = new ArrayList<>(other.values);\n+\n+    for (int i = 0; i < thisObjects.size(); i++) {\n+      Object thisObject = thisObjects.get(i);\n+      Object otherObject = otherObjects.get(i);\n+\n+      /*\n+       * Only one is null, otherwise (both null or non-null) go ahead.\n+       * Always consider NULL is greater which means NULL comes last in ASC and first in DESC\n+       */\n+      if (thisObject == null ^ otherObject == null) {\n+        return thisObject == null ? 1 : -1;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15f972d332b13ccdbd23823495158579f25fd08a"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87b589200289e8957ab09ffbde0545d87f1569a9", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/87b589200289e8957ab09ffbde0545d87f1569a9", "committedDate": "2020-06-30T20:14:38Z", "message": "Merge branch 'develop' into enforce-comparison-test-merged"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDg3MDgy", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/536#pullrequestreview-440487082", "createdAt": "2020-07-01T01:21:47Z", "commit": {"oid": "87b589200289e8957ab09ffbde0545d87f1569a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDA5NjA2", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/536#pullrequestreview-441009606", "createdAt": "2020-07-01T16:08:19Z", "commit": {"oid": "87b589200289e8957ab09ffbde0545d87f1569a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 704, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}