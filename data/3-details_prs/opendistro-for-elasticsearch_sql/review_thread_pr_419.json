{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMjI3MTk4", "number": 419, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzo1OTowNVrODwattg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzo1NjoyM1rODwmrFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMDk1OTI2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/QueryDataMask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzo1OTowNVrOGDZ_Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzoxODowM1rOGDh_5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIyNDcwNg==", "bodyText": "np:\nfor -> to\ninfo -> information\nsql -> SQL\nSame elsewhere.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406224706", "createdAt": "2020-04-09T13:59:05Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/QueryDataMask.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ *\n+ *  * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *  * You may not use this file except in compliance with the License.\n+ *  * A copy of the License is located at\n+ *  *\n+ *  *    http://www.apache.org/licenses/LICENSE-2.0\n+ *  *\n+ *  * or in the \"license\" file accompanying this file. This file is distributed\n+ *  * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  * express or implied. See the License for the specific language governing\n+ *  * permissions and limitations under the License.\n+ *\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.utils;\n+\n+import com.alibaba.druid.sql.ast.expr.SQLQueryExpr;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.identifier.RemoveSensitiveDataRule;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.utils.Util.toSqlExpr;\n+\n+/**\n+ * Utility class for mask sensitive info in incoming sql queries", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a651357dcb86bb4777c1c99728bb7aa7f2c2e320"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1NTk0Mw==", "bodyText": "Will do, thanks!", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406355943", "createdAt": "2020-04-09T17:18:03Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/QueryDataMask.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ *\n+ *  * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *  * You may not use this file except in compliance with the License.\n+ *  * A copy of the License is located at\n+ *  *\n+ *  *    http://www.apache.org/licenses/LICENSE-2.0\n+ *  *\n+ *  * or in the \"license\" file accompanying this file. This file is distributed\n+ *  * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  * express or implied. See the License for the specific language governing\n+ *  * permissions and limitations under the License.\n+ *\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.utils;\n+\n+import com.alibaba.druid.sql.ast.expr.SQLQueryExpr;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.identifier.RemoveSensitiveDataRule;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.utils.Util.toSqlExpr;\n+\n+/**\n+ * Utility class for mask sensitive info in incoming sql queries", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIyNDcwNg=="}, "originalCommit": {"oid": "a651357dcb86bb4777c1c99728bb7aa7f2c2e320"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTA5OTM5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDozMToxOVrOGDbYUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzoyMDozMVrOGDiFeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0NzUwNg==", "bodyText": "Consider using\nprivate static final Logger LOG = LogManager.getLogger(SqlRequest.class);\n\n...\n\nLOG.error(\"Caught an exception when masking sensitive data \",  e)\n\n\nLet the stack trace be logged for faster debugging, instead of Exception name.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406247506", "createdAt": "2020-04-09T14:31:19Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "diffHunk": "@@ -105,4 +107,15 @@ public BoolQueryBuilder checkAndAddFilter(BoolQueryBuilder boolQuery) throws Sql\n         }\n         return boolQuery;\n     }\n+\n+    public String removeSensitiveData() {\n+        String query = \"\";\n+        try {\n+            query = QueryDataMask.maskData(this.sql);\n+        } catch (Exception e) {\n+            LogManager.getLogger().error(\"Caught an exception when removing sensitive data: \"\n+                    + e.getClass().getSimpleName());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a651357dcb86bb4777c1c99728bb7aa7f2c2e320"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1NzM2OA==", "bodyText": "Sounds good, will do. Thanks!", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406357368", "createdAt": "2020-04-09T17:20:31Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "diffHunk": "@@ -105,4 +107,15 @@ public BoolQueryBuilder checkAndAddFilter(BoolQueryBuilder boolQuery) throws Sql\n         }\n         return boolQuery;\n     }\n+\n+    public String removeSensitiveData() {\n+        String query = \"\";\n+        try {\n+            query = QueryDataMask.maskData(this.sql);\n+        } catch (Exception e) {\n+            LogManager.getLogger().error(\"Caught an exception when removing sensitive data: \"\n+                    + e.getClass().getSimpleName());\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0NzUwNg=="}, "originalCommit": {"oid": "a651357dcb86bb4777c1c99728bb7aa7f2c2e320"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTE3OTA1OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/unittest/utils/QueryDataMaskTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDo0ODo1NlrOGDcKnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDo0ODo1NlrOGDcKnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2MDM4MA==", "bodyText": "Does this only works for simple queries?\nCan you add tests for nested, subquery, join and union/minus queries as well for better coverage.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406260380", "createdAt": "2020-04-09T14:48:56Z", "author": {"login": "abbashus"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/unittest/utils/QueryDataMaskTest.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ *\n+ *  * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *  * You may not use this file except in compliance with the License.\n+ *  * A copy of the License is located at\n+ *  *\n+ *  *    http://www.apache.org/licenses/LICENSE-2.0\n+ *  *\n+ *  * or in the \"license\" file accompanying this file. This file is distributed\n+ *  * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  * express or implied. See the License for the specific language governing\n+ *  * permissions and limitations under the License.\n+ *\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.unittest.utils;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.QueryDataMask;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class QueryDataMaskTest {\n+\n+    @Test\n+    public void selectQueriesShouldMaskSensitiveDataWithStars() {\n+        String maskedQuery = QueryDataMask.maskData(\"SELECT age FROM accounts\");\n+        String expectedQuery = \"SELECT *** FROM ***\";\n+        Assert.assertEquals(maskedQuery, expectedQuery);\n+    }\n+\n+    @Test\n+    public void selectQueriesShouldMaskAllSensitiveData() {\n+        String query = \"SELECT ABS(balance), lastname FROM accounts WHERE age > 30\";\n+        String maskedQuery = QueryDataMask.maskData(query);\n+        Assert.assertEquals(maskedQuery, \"SELECT ABS(***), *** FROM *** WHERE *** > 30\");\n+    }\n+\n+    @Test\n+    public void selectQueriesWithQuotedIdentifiersShouldMaskSensitiveData() {\n+        String maskedQuery = QueryDataMask.maskData(\"SELECT `age` FROM accounts\");\n+        String expectedQuery = \"SELECT *** FROM ***\";\n+        Assert.assertEquals(maskedQuery, expectedQuery);\n+    }\n+\n+    @Test\n+    public void selectQueriesWithQuotedIdentifiersWithSpacesShouldMaskSensitiveData() {\n+        String maskedQuery = QueryDataMask.maskData(\"SELECT `a   g e` FROM accounts\");\n+        String expectedQuery = \"SELECT *** FROM ***\";\n+        Assert.assertEquals(maskedQuery, expectedQuery);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a651357dcb86bb4777c1c99728bb7aa7f2c2e320"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTI2ODczOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/unittest/utils/QueryDataMaskTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNTowOTowNlrOGDdDzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzowNjoyN1rOGDhmUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3NTAyMQ==", "bodyText": "Question, what is definition sensitive data? age or 30?\nIMO, the value is more sensitive than field. e.g. password = '123456', it more make sense to mask the value like password = 'xxx'", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406275021", "createdAt": "2020-04-09T15:09:06Z", "author": {"login": "penghuo"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/unittest/utils/QueryDataMaskTest.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ *\n+ *  * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *  * You may not use this file except in compliance with the License.\n+ *  * A copy of the License is located at\n+ *  *\n+ *  *    http://www.apache.org/licenses/LICENSE-2.0\n+ *  *\n+ *  * or in the \"license\" file accompanying this file. This file is distributed\n+ *  * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  * express or implied. See the License for the specific language governing\n+ *  * permissions and limitations under the License.\n+ *\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.unittest.utils;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.QueryDataMask;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class QueryDataMaskTest {\n+\n+    @Test\n+    public void selectQueriesShouldMaskSensitiveDataWithStars() {\n+        String maskedQuery = QueryDataMask.maskData(\"SELECT age FROM accounts\");\n+        String expectedQuery = \"SELECT *** FROM ***\";\n+        Assert.assertEquals(maskedQuery, expectedQuery);\n+    }\n+\n+    @Test\n+    public void selectQueriesShouldMaskAllSensitiveData() {\n+        String query = \"SELECT ABS(balance), lastname FROM accounts WHERE age > 30\";\n+        String maskedQuery = QueryDataMask.maskData(query);\n+        Assert.assertEquals(maskedQuery, \"SELECT ABS(***), *** FROM *** WHERE *** > 30\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a651357dcb86bb4777c1c99728bb7aa7f2c2e320"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM0OTM5Mg==", "bodyText": "Agree. I think we can just mask all values (rewrite literals, number, string etc.)", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406349392", "createdAt": "2020-04-09T17:06:27Z", "author": {"login": "dai-chen"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/unittest/utils/QueryDataMaskTest.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ *\n+ *  * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *  * You may not use this file except in compliance with the License.\n+ *  * A copy of the License is located at\n+ *  *\n+ *  *    http://www.apache.org/licenses/LICENSE-2.0\n+ *  *\n+ *  * or in the \"license\" file accompanying this file. This file is distributed\n+ *  * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  * express or implied. See the License for the specific language governing\n+ *  * permissions and limitations under the License.\n+ *\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.unittest.utils;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.QueryDataMask;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class QueryDataMaskTest {\n+\n+    @Test\n+    public void selectQueriesShouldMaskSensitiveDataWithStars() {\n+        String maskedQuery = QueryDataMask.maskData(\"SELECT age FROM accounts\");\n+        String expectedQuery = \"SELECT *** FROM ***\";\n+        Assert.assertEquals(maskedQuery, expectedQuery);\n+    }\n+\n+    @Test\n+    public void selectQueriesShouldMaskAllSensitiveData() {\n+        String query = \"SELECT ABS(balance), lastname FROM accounts WHERE age > 30\";\n+        String maskedQuery = QueryDataMask.maskData(query);\n+        Assert.assertEquals(maskedQuery, \"SELECT ABS(***), *** FROM *** WHERE *** > 30\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3NTAyMQ=="}, "originalCommit": {"oid": "a651357dcb86bb4777c1c99728bb7aa7f2c2e320"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTMzMTQyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/StringUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNToyNDozMFrOGDdsfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNToyNDozMFrOGDdsfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4NTQzOQ==", "bodyText": "add UT", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406285439", "createdAt": "2020-04-09T15:24:30Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/StringUtils.java", "diffHunk": "@@ -126,6 +126,11 @@ public static boolean isNumeric(String text) {\n         return Doubles.tryParse(text) != null;\n     }\n \n+    public static String getFirstWord(String sql) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a651357dcb86bb4777c1c99728bb7aa7f2c2e320"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTM0NjU3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/RestSqlAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNToyNzozNlrOGDd2CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNToyNzozNlrOGDd2CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4Nzg4MA==", "bodyText": "why adding a method on SqlRequest? could we use QueryDataMask.mask(sqlRequest.sql) instead.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406287880", "createdAt": "2020-04-09T15:27:36Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/RestSqlAction.java", "diffHunk": "@@ -112,7 +112,8 @@ protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient cli\n             }\n \n             final SqlRequest sqlRequest = SqlRequestFactory.getSqlRequest(request);\n-            LOG.info(\"[{}] Incoming request {}: {}\", LogUtils.getRequestId(), request.uri(), sqlRequest.getSql());\n+            LOG.info(\"[{}] Incoming request {}: {}\", LogUtils.getRequestId(), request.uri(),\n+                    sqlRequest.removeSensitiveData());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a651357dcb86bb4777c1c99728bb7aa7f2c2e320"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjIyNzM3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/rewriter/identifier/RemoveSensitiveDataRule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxOTozMzoxN1rOGDmiug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxOTozMzoxN1rOGDmiug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzMDM5NA==", "bodyText": "np: getIdentifierSet  -> getDataSet ?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406430394", "createdAt": "2020-04-09T19:33:17Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/rewriter/identifier/RemoveSensitiveDataRule.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.rewriter.identifier;\n+\n+import com.alibaba.druid.sql.ast.expr.SQLIdentifierExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLQueryExpr;\n+import com.alibaba.druid.sql.dialect.mysql.visitor.MySqlASTVisitorAdapter;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.RewriteRule;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+public class RemoveSensitiveDataRule extends MySqlASTVisitorAdapter implements RewriteRule<SQLQueryExpr> {\n+\n+    private Set<String> dataSet = new HashSet<>();\n+\n+    @Override\n+    public boolean visit(SQLIdentifierExpr identifierExpr) {\n+        dataSet.add(identifierExpr.getName());\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean match(SQLQueryExpr expr) {\n+        return true;\n+    }\n+\n+    @Override\n+    public void rewrite(SQLQueryExpr expr) {\n+        expr.accept(this);\n+    }\n+\n+    public Set<String> getIdentifierSet() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead3b80ab5d2879f71248eeb5bce776b35b19876"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjUwNjUzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMTowMTo0M1rOGDpRdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMTowMTo0M1rOGDpRdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3NTEyNQ==", "bodyText": "As Peng commented, I think you can either move all mask logic here or just call maskData() outside along with getSql().", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406475125", "createdAt": "2020-04-09T21:01:43Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "diffHunk": "@@ -105,4 +109,14 @@ public BoolQueryBuilder checkAndAddFilter(BoolQueryBuilder boolQuery) throws Sql\n         }\n         return boolQuery;\n     }\n+\n+    public String removeSensitiveData() {\n+        String query = \"\";\n+        try {\n+            query = QueryDataMask.maskData(this.sql);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead3b80ab5d2879f71248eeb5bce776b35b19876"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjUyMTg2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/rewriter/identifier/RemoveSensitiveDataRule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMTowNjo0NlrOGDpbCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMTowNjo0NlrOGDpbCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3NzU3Nw==", "bodyText": "Because values (literals) in query is more sensitive, you may need to rewrite methods like visit(SQLNumberExpr x), visit(SQLCharExpr x) etc. We can add a few UTs to cover common literals such as string, numerical, bool, datetime etc.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406477577", "createdAt": "2020-04-09T21:06:46Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/rewriter/identifier/RemoveSensitiveDataRule.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.rewriter.identifier;\n+\n+import com.alibaba.druid.sql.ast.expr.SQLIdentifierExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLQueryExpr;\n+import com.alibaba.druid.sql.dialect.mysql.visitor.MySqlASTVisitorAdapter;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.RewriteRule;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+public class RemoveSensitiveDataRule extends MySqlASTVisitorAdapter implements RewriteRule<SQLQueryExpr> {\n+\n+    private Set<String> dataSet = new HashSet<>();\n+\n+    @Override\n+    public boolean visit(SQLIdentifierExpr identifierExpr) {\n+        dataSet.add(identifierExpr.getName());\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead3b80ab5d2879f71248eeb5bce776b35b19876"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjUzNzg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/QueryDataMask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMToxMTo1MlrOGDpkug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMToxMTo1MlrOGDpkug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ4MDA1OA==", "bodyText": "I think you can move all logic in this class into RemoveSensitiveDataRule except rebuilding. (rename it to MaskSensitiveDataRule?) Then you just need a util method for rebuilding AST (after applied our masking rule) to a query string.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406480058", "createdAt": "2020-04-09T21:11:52Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/QueryDataMask.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.utils;\n+\n+import com.alibaba.druid.sql.ast.expr.SQLQueryExpr;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.identifier.RemoveSensitiveDataRule;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.utils.Util.toSqlExpr;\n+\n+/**\n+ * Utility class to mask sensitive information in incoming SQL queries\n+ */\n+public class QueryDataMask {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead3b80ab5d2879f71248eeb5bce776b35b19876"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjg5ODE0OnYy", "diffSide": "LEFT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzo0NDozOFrOGDs6Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzo0NDozOFrOGDs6Wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNDc0Ng==", "bodyText": "unnecessary change", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406534746", "createdAt": "2020-04-09T23:44:38Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/request/SqlRequest.java", "diffHunk": "@@ -37,7 +37,6 @@\n     String sql;\n     JSONObject jsonContent;\n \n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37d461537f3b01be48435476a6ea620e16ec6816"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjkxNTQzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/unittest/utils/QueryDataAnonymizerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzo1NDoxM1rOGDtEVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzo1NjozNVrOGDtGmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNzMwMw==", "bodyText": "Curious what will be the output in log4j, does it output multiple line for the same query?\nIf so, I would suggest to remove the newline to make it in same line. Because usually, we process the log data by using line based tools and group the data with request id. e.g., grep requestId=xxx which will return all the log corresponding to specific request.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406537303", "createdAt": "2020-04-09T23:54:13Z", "author": {"login": "penghuo"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/unittest/utils/QueryDataAnonymizerTest.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.unittest.utils;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.QueryDataAnonymizer;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class QueryDataAnonymizerTest {\n+\n+    @Test\n+    public void queriesShouldHaveAnonymousFieldAndIndex() {\n+        String query = \"SELECT ABS(balance) FROM accounts WHERE age > 30 GROUP BY ABS(balance)\";\n+        String expectedQuery = \"(\\n\" +\n+                \"\\tSELECT ABS(identifier)\\n\" +\n+                \"\\tFROM table\\n\" +\n+                \"\\tWHERE identifier > number\\n\" +\n+                \"\\tGROUP BY ABS(identifier)\\n\" +\n+                \"\\t)\";\n+        Assert.assertEquals(expectedQuery, QueryDataAnonymizer.anonymizeData(query));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37d461537f3b01be48435476a6ea620e16ec6816"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNzg4MQ==", "bodyText": "yes, it outputs multiple lines and tabs in the front of every line as well. ok that makes sense, i will remove the redundant returns and tabs.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406537881", "createdAt": "2020-04-09T23:56:35Z", "author": {"login": "chloe-zh"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/unittest/utils/QueryDataAnonymizerTest.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.unittest.utils;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.QueryDataAnonymizer;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class QueryDataAnonymizerTest {\n+\n+    @Test\n+    public void queriesShouldHaveAnonymousFieldAndIndex() {\n+        String query = \"SELECT ABS(balance) FROM accounts WHERE age > 30 GROUP BY ABS(balance)\";\n+        String expectedQuery = \"(\\n\" +\n+                \"\\tSELECT ABS(identifier)\\n\" +\n+                \"\\tFROM table\\n\" +\n+                \"\\tWHERE identifier > number\\n\" +\n+                \"\\tGROUP BY ABS(identifier)\\n\" +\n+                \"\\t)\";\n+        Assert.assertEquals(expectedQuery, QueryDataAnonymizer.anonymizeData(query));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNzMwMw=="}, "originalCommit": {"oid": "37d461537f3b01be48435476a6ea620e16ec6816"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjkxODYzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/rewriter/identifier/AnonymizeSensitiveDataRule.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzo1NjoyM1rOGDtGVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwMDoxNTowNVrOGDtaaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNzgxNQ==", "bodyText": "Please add some doc here.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406537815", "createdAt": "2020-04-09T23:56:23Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/rewriter/identifier/AnonymizeSensitiveDataRule.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.rewriter.identifier;\n+\n+import com.alibaba.druid.sql.ast.expr.SQLBooleanExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLCharExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLIdentifierExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLIntegerExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLNumberExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLQueryExpr;\n+import com.alibaba.druid.sql.ast.statement.SQLExprTableSource;\n+import com.alibaba.druid.sql.dialect.mysql.visitor.MySqlASTVisitorAdapter;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.RewriteRule;\n+\n+public class AnonymizeSensitiveDataRule extends MySqlASTVisitorAdapter implements RewriteRule<SQLQueryExpr> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37d461537f3b01be48435476a6ea620e16ec6816"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0Mjk1Mw==", "bodyText": "Will do, thanks!", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/419#discussion_r406542953", "createdAt": "2020-04-10T00:15:05Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/rewriter/identifier/AnonymizeSensitiveDataRule.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.rewriter.identifier;\n+\n+import com.alibaba.druid.sql.ast.expr.SQLBooleanExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLCharExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLIdentifierExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLIntegerExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLNumberExpr;\n+import com.alibaba.druid.sql.ast.expr.SQLQueryExpr;\n+import com.alibaba.druid.sql.ast.statement.SQLExprTableSource;\n+import com.alibaba.druid.sql.dialect.mysql.visitor.MySqlASTVisitorAdapter;\n+import com.amazon.opendistroforelasticsearch.sql.rewriter.RewriteRule;\n+\n+public class AnonymizeSensitiveDataRule extends MySqlASTVisitorAdapter implements RewriteRule<SQLQueryExpr> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNzgxNQ=="}, "originalCommit": {"oid": "37d461537f3b01be48435476a6ea620e16ec6816"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2221, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}