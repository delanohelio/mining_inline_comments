{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MzM0NTQ0", "number": 913, "title": "add fix to handle functions applied to literal ", "bodyText": "Issue #899\nDescription of changes:\n\nadded filter for functions with literal in select clause\nadded unit test\nadded manual IT because the comparison test didn't work for the date function.\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-12-10T23:24:33Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913", "merged": true, "mergeCommit": {"oid": "8a443053258f3546b8df595a23c6b4c9938975d5"}, "closed": true, "closedAt": "2020-12-14T19:05:57Z", "author": {"login": "rupal-bq"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk7BMsgH2gAyNTM2MzM0NTQ0OjdmOWFmMjNhMjRiNjllN2M1OWEzNzgwM2ViMDZkNTMzNmRhZjQ0OGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmKk-uAFqTU1MTgwNjE4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7f9af23a24b69e7c59a37803eb06d5336daf448c", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7f9af23a24b69e7c59a37803eb06d5336daf448c", "committedDate": "2020-12-10T22:24:13Z", "message": "add functions with literal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0260ffa4b77389e0fc165a06242a7c7aadb1c41e", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0260ffa4b77389e0fc165a06242a7c7aadb1c41e", "committedDate": "2020-12-10T23:56:08Z", "message": "Merge branch 'develop' of https://github.com/rupal-bq/sql into sql-having-clause-issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNDA5MzAz", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#pullrequestreview-550409303", "createdAt": "2020-12-11T18:15:25Z", "commit": {"oid": "0260ffa4b77389e0fc165a06242a7c7aadb1c41e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoxNToyNVrOIEEWrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoxNToyNVrOIEEWrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNjU1Ng==", "bodyText": "I think we need to check this recursively, ex. ABS(ABS(age)). Could we merge isNonLiteral() to this method as base case for recursion?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#discussion_r541136556", "createdAt": "2020-12-11T18:15:25Z", "author": {"login": "dai-chen"}, "path": "sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/AstAggregationBuilder.java", "diffHunk": "@@ -137,6 +139,15 @@ private boolean isNonLiteral(UnresolvedExpression expr) {\n     return !(expr instanceof Literal);\n   }\n \n+  private boolean isNonLiteralFunction(UnresolvedExpression expr) {\n+    if (expr instanceof Function) {\n+      List<? extends Node> children = expr.getChild();\n+      return children.stream()\n+              .allMatch(child -> isNonLiteral((UnresolvedExpression) child));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0260ffa4b77389e0fc165a06242a7c7aadb1c41e"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNDIyMTA3", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#pullrequestreview-550422107", "createdAt": "2020-12-11T18:23:25Z", "commit": {"oid": "0260ffa4b77389e0fc165a06242a7c7aadb1c41e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoyMzoyNVrOIEEn9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoyMzoyNVrOIEEn9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE0MDk4MA==", "bodyText": "Could you add some more test queries as comparison test for this issue in https://github.com/opendistro-for-elasticsearch/sql/tree/develop/integ-test/src/test/resources/correctness/bugfixes", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#discussion_r541140980", "createdAt": "2020-12-11T18:23:25Z", "author": {"login": "dai-chen"}, "path": "integ-test/src/test/java/com/amazon/opendistroforelasticsearch/sql/sql/DateTimeFunctionIT.java", "diffHunk": "@@ -60,6 +60,15 @@ public void testDateInGroupBy() throws IOException{\n             rows(\"2018-08-11\"));\n   }\n \n+  @Test\n+  public void testDateWithHavingClauseOnly() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0260ffa4b77389e0fc165a06242a7c7aadb1c41e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41e9d7391abf1f2cdf8d38a4f6fe1a8b880a02b2", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/41e9d7391abf1f2cdf8d38a4f6fe1a8b880a02b2", "committedDate": "2020-12-12T01:52:19Z", "message": "address PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3b8282cbd9c5c90a409a68c5156604f1eac9e69", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b3b8282cbd9c5c90a409a68c5156604f1eac9e69", "committedDate": "2020-12-12T01:58:37Z", "message": "remove unnecessary check. anyMatch returns false for empty list."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNzM5NTYy", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#pullrequestreview-551739562", "createdAt": "2020-12-14T18:03:02Z", "commit": {"oid": "b3b8282cbd9c5c90a409a68c5156604f1eac9e69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dace04d726b646cd9530b66c928be1c8e501754", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5dace04d726b646cd9530b66c928be1c8e501754", "committedDate": "2020-12-14T18:28:53Z", "message": "remove isNonLiteral()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODA2MTgw", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/913#pullrequestreview-551806180", "createdAt": "2020-12-14T19:05:48Z", "commit": {"oid": "5dace04d726b646cd9530b66c928be1c8e501754"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 591, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}