{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MDE2OTE1", "number": 374, "title": "Integration test with external ES cluster", "bodyText": "Issue #, if available: #353\nDescription of changes: To automate the sanity test for new release, we need the capability to run all our integration tests with external cluster setup by release candidate artifacts, such as docker, rpm, zip etc. To make this happen, this PR covered the following code changes:\n\nMigrating to ESRestTestCase: we used ESIntegTestCase which has problem with external cluster.\nRemoving index type: we used deprecated index type which is going to be removed in ES 8 and will be rejected by external cluster.\nFixing broken tests: some ES API in use is actually deprecated and previous internal cluster didn't complain.\n\nFor reviewers: Since this is quite a large PR (all test index, data and queries using type need to be changed), please focus on SQLIntegTestCase only for your convenience.\nTesting:\n\nAll tests: ./gradlew build\nTest with internal cluster: ./gradlew integTestRunner\nTest with external cluster: ./gradlew integTestRunner -Dtests.cluster= -Dtests.rest.cluster=127.0.0.1:9200 (not sure why tests.cluster is required though it is not in use by new ESIntegTestCase)\nComparison test: ./gradlew integTestRunner -DtestType=comparison\nDoc test: ./gradlew integTestRunner -DtestType=doctest\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-03-05T01:25:11Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374", "merged": true, "mergeCommit": {"oid": "56a2f4470f3ccbff92acf180386fc66e1a5acfee"}, "closed": true, "closedAt": "2020-03-05T22:16:19Z", "author": {"login": "dai-chen"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcI6sfdAH2gAyMzg0MDE2OTE1Ojg0YTQzODE0Yzk3ZDQ5ODIxYzhiYjIzMTc4MmEwMWUxYjcyYjdiNmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKy-D_AFqTM2OTk1MDc3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "84a43814c97d49821c8bb231782a01e1b72b7b6a", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/84a43814c97d49821c8bb231782a01e1b72b7b6a", "committedDate": "2020-02-29T02:00:34Z", "message": "Fix build issue by migrating to RestTestCase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65099b8a1c1d50556876c8943ab3116eae6594e8", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/65099b8a1c1d50556876c8943ab3116eae6594e8", "committedDate": "2020-03-03T00:12:21Z", "message": "Fix query IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf0ecf8de2e6288db3b0c4728e5fc16dc62bdba2", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/bf0ecf8de2e6288db3b0c4728e5fc16dc62bdba2", "committedDate": "2020-03-03T00:21:25Z", "message": "Fix subquery IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a288fcf6abfe297c0bcc27693796297d468babe0", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a288fcf6abfe297c0bcc27693796297d468babe0", "committedDate": "2020-03-03T01:07:34Z", "message": "Fix csv formatter and SQL functions IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1fd82e10ed2cc997d605557b6b9dea0bbe8b4d7", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c1fd82e10ed2cc997d605557b6b9dea0bbe8b4d7", "committedDate": "2020-03-03T01:21:54Z", "message": "Fix aggregation and delete IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6efc9998fd168443c74cf029f34c15de4866e525", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6efc9998fd168443c74cf029f34c15de4866e525", "committedDate": "2020-03-03T19:10:18Z", "message": "Fix date IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44a949ada0f7002998647b13167203a0d34a631a", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/44a949ada0f7002998647b13167203a0d34a631a", "committedDate": "2020-03-03T23:35:59Z", "message": "Fix jdbc IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98692513b6d3651027b425b9abe4774aba0c3973", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/98692513b6d3651027b425b9abe4774aba0c3973", "committedDate": "2020-03-04T00:54:01Z", "message": "Fix show and metadata IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d699c18e9c0ad80725f6d69f0dd55f2c8cf05d97", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d699c18e9c0ad80725f6d69f0dd55f2c8cf05d97", "committedDate": "2020-03-04T16:25:49Z", "message": "Fix subquery IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa0df3a5862e11e59ede0c6e18094d07eae478df", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/aa0df3a5862e11e59ede0c6e18094d07eae478df", "committedDate": "2020-03-04T22:15:20Z", "message": "Fix date functions UT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cc5c10d451bf28a14eafea577897f781a690d68", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3cc5c10d451bf28a14eafea577897f781a690d68", "committedDate": "2020-03-04T23:58:38Z", "message": "Fix test data setup and cleanup issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56fe234449ea655c53ac6f253b495e908cd3cd2a", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/56fe234449ea655c53ac6f253b495e908cd3cd2a", "committedDate": "2020-03-05T00:33:05Z", "message": "Fix correctness IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "941e7ae8d3395db48eb70f8305abf2bb8165c76a", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/941e7ae8d3395db48eb70f8305abf2bb8165c76a", "committedDate": "2020-03-05T01:02:02Z", "message": "Fix doctest IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3507e3783a9d87004b51069ae88924fcb5f53bfb", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3507e3783a9d87004b51069ae88924fcb5f53bfb", "committedDate": "2020-03-05T01:02:43Z", "message": "Merge branch 'master' into integ-test-migration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NzcwOTQ2", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#pullrequestreview-369770946", "createdAt": "2020-03-05T17:30:27Z", "commit": {"oid": "3507e3783a9d87004b51069ae88924fcb5f53bfb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74aa82cc49bbaca6f67275f36697420316e97c3d", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/74aa82cc49bbaca6f67275f36697420316e97c3d", "committedDate": "2020-03-05T19:25:55Z", "message": "Add JavaDoc on base class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODY5NTYw", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#pullrequestreview-369869560", "createdAt": "2020-03-05T19:55:36Z", "commit": {"oid": "3507e3783a9d87004b51069ae88924fcb5f53bfb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTo1NTozNlrOFyh4rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTo1NTozNlrOFyh4rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUyODMwMA==", "bodyText": "What is the reason to change this? Aren't we loosing the assertion.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#discussion_r388528300", "createdAt": "2020-03-05T19:55:36Z", "author": {"login": "abbashus"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/MetaDataQueriesIT.java", "diffHunk": "@@ -256,7 +256,7 @@ public void showWildcardIndex() throws IOException {\n \n         String pattern = String.format(\"%s.*\", TestsConstants.TEST_INDEX);\n         JSONArray dataRows = getDataRows(response);\n-        assertThat(dataRows.length(), equalTo(3));\n+        assertThat(dataRows.length(), greaterThan(0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3507e3783a9d87004b51069ae88924fcb5f53bfb"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "677f46e847b95666f1a9875993c14aa0add439f0", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/677f46e847b95666f1a9875993c14aa0add439f0", "committedDate": "2020-03-05T20:09:16Z", "message": "Address PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODgzMTg4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#pullrequestreview-369883188", "createdAt": "2020-03-05T20:17:19Z", "commit": {"oid": "677f46e847b95666f1a9875993c14aa0add439f0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDoxNzoxOVrOFyikEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDoxNzoxOVrOFyikEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUzOTQxMA==", "bodyText": "What is this change about?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#discussion_r388539410", "createdAt": "2020-03-05T20:17:19Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/query/maker/AggMaker.java", "diffHunk": "@@ -555,6 +555,9 @@ private DateHistogramAggregationBuilder dateHistogram(MethodField field) throws\n                     case \"interval\":\n                         dateHistogram.dateHistogramInterval(new DateHistogramInterval(kv.value.toString()));\n                         break;\n+                    case \"fixed_interval\":\n+                        dateHistogram.fixedInterval(new DateHistogramInterval(kv.value.toString()));\n+                        break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "677f46e847b95666f1a9875993c14aa0add439f0"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODg0Mjg1", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#pullrequestreview-369884285", "createdAt": "2020-03-05T20:19:03Z", "commit": {"oid": "677f46e847b95666f1a9875993c14aa0add439f0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDoxOTowM1rOFyioTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDoxOTowM1rOFyioTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU0MDQ5Mg==", "bodyText": "Sorry, not very clear about this change. Can you give an example how this affects things.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#discussion_r388540492", "createdAt": "2020-03-05T20:19:03Z", "author": {"login": "abbashus"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/utils/SQLFunctions.java", "diffHunk": "@@ -530,9 +536,14 @@ private static String quoteParams(String... params) {\n         }\n     }\n \n+    /** Explicitly pass in name used to generate variable ID because methodName is not always valid */\n+    private Tuple<String, String> dateFunctionTemplate(String name, String methodName, SQLExpr field) {\n+        String id = nextId(name);\n+        return new Tuple<>(id, def(id, doc(field) + \".value.\" + methodName));\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "677f46e847b95666f1a9875993c14aa0add439f0"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64911605fbd54786b40e4269ea5c5a26ccb92127", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/64911605fbd54786b40e4269ea5c5a26ccb92127", "committedDate": "2020-03-05T20:26:18Z", "message": "Address PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTUwNzc1", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/374#pullrequestreview-369950775", "createdAt": "2020-03-05T22:08:22Z", "commit": {"oid": "64911605fbd54786b40e4269ea5c5a26ccb92127"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 754, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}