{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NDk3NzQx", "number": 818, "title": "Support CASE clause in new engine", "bodyText": "Issue #, if available: N/A\nDescription of changes: Add support for CASE clause in new SQL engine.\n\nAdd AST and expression node for CASE and WHEN clause.\nImplement evaluation and type check. Because CASE clause is different from regular functions, it's not registered into function repository which usually performs the type check.\n\nTODO: Case function for PPL is not done yet. Reference: https://docs.splunk.com/Documentation/Splunk/8.1.0/SearchReference/ConditionalFunctions\nDocumentation: https://github.com/dai-chen/sql/blob/support-case-statement-in-new-engine/docs/user/dql/functions.rst#case\nTesting:\n\nAdd UT.\nAdd comparison test in https://github.com/dai-chen/sql/blob/support-case-statement-in-new-engine/integ-test/src/test/resources/correctness/expressions/conditionals.txt\nIgnore and fix broken legacy test cases.\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-11-11T22:59:18Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/818", "merged": true, "mergeCommit": {"oid": "2a98508cfd2d0320020a25bc1e6d78baac9a4c4a"}, "closed": true, "closedAt": "2020-11-16T21:21:18Z", "author": {"login": "dai-chen"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda7dRJAH2gAyNTE5NDk3NzQxOmRmODIyY2Q0ZDBmNzVlYmQ3NGM5NjEwZjMzNTZjMmNmNDliMzA1MTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddLkLvgH2gAyNTE5NDk3NzQxOmMzYWVjMmM4Y2VmNjFkOTkzM2ZlODZiMzgzNTUzN2RjNzEzYmIxYWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "df822cd4d0f75ebd74c9610f3356c2cf49b30517", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/df822cd4d0f75ebd74c9610f3356c2cf49b30517", "committedDate": "2020-11-09T21:15:38Z", "message": "Change grammar and UT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c70956a51caf95076990b2989ca759504f30528", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3c70956a51caf95076990b2989ca759504f30528", "committedDate": "2020-11-09T21:15:39Z", "message": "Add case expression"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2db99d08216b133f913414c16ab049de4556f7b4", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2db99d08216b133f913414c16ab049de4556f7b4", "committedDate": "2020-11-09T21:15:39Z", "message": "Pass jacoco in sql module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86c8be9252ed71b1cb7191a12dc06f68bc3fa1d4", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/86c8be9252ed71b1cb7191a12dc06f68bc3fa1d4", "committedDate": "2020-11-10T23:43:26Z", "message": "Pass jacoco in core module and refactor when clause"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f40cf474ea947e37dec99cb7da32d9fa65be0354", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f40cf474ea947e37dec99cb7da32d9fa65be0354", "committedDate": "2020-11-11T02:15:21Z", "message": "Fix broken IT and add javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7890d56f49a24365246cfa73ae6fb5b58e963acf", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7890d56f49a24365246cfa73ae6fb5b58e963acf", "committedDate": "2020-11-11T02:25:16Z", "message": "Add comparison test for basic case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dbb36ebb350eba8e980548a7c41f8635a328df4", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7dbb36ebb350eba8e980548a7c41f8635a328df4", "committedDate": "2020-11-11T02:29:55Z", "message": "Add comparison test for complex case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05fdfea64d5d528a0eb5110a248b7b5dd5eacef8", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/05fdfea64d5d528a0eb5110a248b7b5dd5eacef8", "committedDate": "2020-11-11T21:32:38Z", "message": "Add doctest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59d52b198c81b751a58413d9fb69fd63d3c16edf", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/59d52b198c81b751a58413d9fb69fd63d3c16edf", "committedDate": "2020-11-11T22:50:23Z", "message": "Add type check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "509c64835044066c663871ff2e423bf8e0204c40", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/509c64835044066c663871ff2e423bf8e0204c40", "committedDate": "2020-11-11T23:27:54Z", "message": "Prepare PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd8a7c45bf985426cd52229dfc3d876d41560db", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/abd8a7c45bf985426cd52229dfc3d876d41560db", "committedDate": "2020-11-11T23:50:27Z", "message": "Prepare PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e25a2308b21bf001509229939056f2781ab65bf", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0e25a2308b21bf001509229939056f2781ab65bf", "committedDate": "2020-11-13T21:06:09Z", "message": "Merge branch 'develop' into support-case-statement-in-new-engine"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDUxNTUx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/818#pullrequestreview-530451551", "createdAt": "2020-11-13T22:14:18Z", "commit": {"oid": "0e25a2308b21bf001509229939056f2781ab65bf"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMjoxNDoxOFrOHzBV-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMjoyMjoyMlrOHzBgqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2MTQzNQ==", "bodyText": "The case_value and compare_value could be expression, right? Could we refer the T-SQL definition https://docs.microsoft.com/en-us/sql/t-sql/language-elements/case-transact-sql?view=sql-server-ver15", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/818#discussion_r523261435", "createdAt": "2020-11-13T22:14:18Z", "author": {"login": "penghuo"}, "path": "docs/user/dql/functions.rst", "diffHunk": "@@ -1832,3 +1832,82 @@ Description\n Specifications:\n \n 1. ISNULL(ES_TYPE) -> INTEGER\n+\n+\n+CASE\n+----\n+\n+Description\n+>>>>>>>>>>>\n+\n+``CASE`` statement has two forms with slightly different syntax: Simple Case and Searched Case.\n+\n+Simple case syntax compares a case value with each compare value in ``WHEN`` clause and return its result if matched. Otherwise, result in ``ELSE`` clause is returned (or ``NULL`` if absent). Note that case value, compare value and result can be any expression::\n+\n+   CASE case_value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e25a2308b21bf001509229939056f2781ab65bf"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI2NDE2OQ==", "bodyText": "Can we merge two different case...when logic in the AstBuilder?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/818#discussion_r523264169", "createdAt": "2020-11-13T22:22:22Z", "author": {"login": "penghuo"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/analysis/ExpressionAnalyzer.java", "diffHunk": "@@ -163,6 +169,43 @@ public Expression visitCompare(Compare node, AnalysisContext context) {\n         repository.compile(functionName, Arrays.asList(left, right));\n   }\n \n+  @Override\n+  public Expression visitCase(Case node, AnalysisContext context) {\n+    List<WhenClause> whens = new ArrayList<>();\n+    for (When when : node.getWhenClauses()) {\n+      if (node.getCaseValue() == null) {\n+        whens.add((WhenClause) analyze(when, context));\n+      } else {\n+        // Merge case value and condition (compare value) into a single equal condition\n+        whens.add((WhenClause) analyze(\n+            new When(\n+                new Function(\"=\", Arrays.asList(node.getCaseValue(), when.getCondition())),\n+                when.getResult()\n+            ), context));\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e25a2308b21bf001509229939056f2781ab65bf"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDU5MzAx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/818#pullrequestreview-530459301", "createdAt": "2020-11-13T22:33:00Z", "commit": {"oid": "0e25a2308b21bf001509229939056f2781ab65bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDY1MDgx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/818#pullrequestreview-530465081", "createdAt": "2020-11-13T22:48:39Z", "commit": {"oid": "0e25a2308b21bf001509229939056f2781ab65bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3aec2c8cef61d9933fe86b3835537dc713bb1ae", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c3aec2c8cef61d9933fe86b3835537dc713bb1ae", "committedDate": "2020-11-16T21:09:31Z", "message": "Address PR comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 553, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}