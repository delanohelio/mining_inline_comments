{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNDc5NTM5", "number": 362, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDowNToyOVrODc0XNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzoyNjoyMlrODj5K2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTQ0NjI5OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/TestsConstants.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDowNToyOVrOFlEOxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMzo0NDozOFrOFvlECA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxMDk0OA==", "bodyText": "Is it possible to merge with the existing bank index?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r374410948", "createdAt": "2020-02-04T00:05:29Z", "author": {"login": "penghuo"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/TestsConstants.java", "diffHunk": "@@ -42,6 +42,7 @@\n     public final static String TEST_INDEX_JOIN_TYPE = TEST_INDEX + \"_join_type\";\n     public final static String TEST_INDEX_BANK = TEST_INDEX + \"_bank\";\n     public final static String TEST_INDEX_BANK_TWO = TEST_INDEX_BANK + \"_two\";\n+    public final static String TEST_INDEX_BANK_WITH_NULL_VALUES = TEST_INDEX_BANK + \"_with_null_values\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ca2fea95c9f4666a4bb71af36b7a45fc690af4d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzNDYzMg==", "bodyText": "I wonder if that will cause broken tests that use the bank index if inject null value into it.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r385434632", "createdAt": "2020-02-27T23:44:38Z", "author": {"login": "chloe-zh"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/TestsConstants.java", "diffHunk": "@@ -42,6 +42,7 @@\n     public final static String TEST_INDEX_JOIN_TYPE = TEST_INDEX + \"_join_type\";\n     public final static String TEST_INDEX_BANK = TEST_INDEX + \"_bank\";\n     public final static String TEST_INDEX_BANK_TWO = TEST_INDEX_BANK + \"_two\";\n+    public final static String TEST_INDEX_BANK_WITH_NULL_VALUES = TEST_INDEX_BANK + \"_with_null_values\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxMDk0OA=="}, "originalCommit": {"oid": "6ca2fea95c9f4666a4bb71af36b7a45fc690af4d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTQ4NDg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoyNjo0NFrOFlEmQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoyNjo0NFrOFlEmQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNjk2Mg==", "bodyText": "Because ElasticsearchErrorMessage is dedicated to ElasticsearchException, I think you can pass in e only and get everything you need inside the constructor.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r374416962", "createdAt": "2020-02-04T00:26:44Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -65,7 +66,9 @@ public Protocol(Client client, QueryAction queryAction, Object queryResult, Stri\n     public Protocol(Exception e) {\n         this.formatType = null;\n         this.status = ERROR_STATUS;\n-        this.error = new ErrorMessage(e, ERROR_STATUS);\n+        this.error = e instanceof ElasticsearchException ? new ElasticsearchErrorMessage((ElasticsearchException) e,\n+                ((ElasticsearchException) e).status().getStatus())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90a74457a72cea06b2dba678718d6e55ec40e414"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTQ5MTQzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/QueryIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDozMDo0MlrOFlEqgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMzozNDo1MlrOFvk4Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxODA1MQ==", "bodyText": "the assert will not be executed when the errMsgs.length = 0", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r374418051", "createdAt": "2020-02-04T00:30:42Z", "author": {"login": "penghuo"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/QueryIT.java", "diffHunk": "@@ -1773,6 +1776,40 @@ public void caseWhenJdbcResponseTest() {\n         );\n     }\n \n+    @Test\n+    public void functionInCaseFieldShouldThrowESExceptionDueToIllegalScriptInJdbc() {\n+        String response = executeQuery(\n+                \"select case lower(firstname) when 'amber' then '1' else '2' end as cases from \" + TEST_INDEX_ACCOUNT,\n+                \"jdbc\");\n+        queryInJdbcResponseShouldIndicateESException(response, \"SearchPhaseExecutionException\",\n+                \"For more details, please send request for Json format\");\n+    }\n+\n+    @Test\n+    public void functionCallWithIllegalScriptShouldThrowESExceptionInJdbc() {\n+        String response = executeQuery(\"select log(balance + 2) from \" + TEST_INDEX_BANK,\n+                \"jdbc\");\n+        queryInJdbcResponseShouldIndicateESException(response, \"SearchPhaseExecutionException\",\n+                \"please send request for Json format to see the raw response from elasticsearch engine.\");\n+    }\n+\n+    @Ignore(\"Goes in different route, does not call PrettyFormatRestExecutor.execute methods.\" +\n+            \"The performRequest method in RestClient doesn't throw any exceptions for null value fields in script\")\n+    @Test\n+    public void functionArgWithNullValueFieldShouldThrowESExceptionInJdbc() {\n+        String response = executeQuery(\n+                \"select log(balance) from \" + TEST_INDEX_BANK_WITH_NULL_VALUES, \"jdbc\");\n+        queryInJdbcResponseShouldIndicateESException(response, \"SearchPhaseExecutionException\",\n+                \"For more details, please send request for Json format\");\n+    }\n+\n+    private void queryInJdbcResponseShouldIndicateESException(String response, String exceptionType, String... errMsgs) {\n+        Assert.assertThat(response, containsString(exceptionType));\n+        for (String errMsg: errMsgs) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ca2fea95c9f4666a4bb71af36b7a45fc690af4d"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzMTYzNA==", "bodyText": "the error messages are the expected messages the unit tests input. The test does not assert the message if no messages are put.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r385431634", "createdAt": "2020-02-27T23:34:52Z", "author": {"login": "chloe-zh"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/QueryIT.java", "diffHunk": "@@ -1773,6 +1776,40 @@ public void caseWhenJdbcResponseTest() {\n         );\n     }\n \n+    @Test\n+    public void functionInCaseFieldShouldThrowESExceptionDueToIllegalScriptInJdbc() {\n+        String response = executeQuery(\n+                \"select case lower(firstname) when 'amber' then '1' else '2' end as cases from \" + TEST_INDEX_ACCOUNT,\n+                \"jdbc\");\n+        queryInJdbcResponseShouldIndicateESException(response, \"SearchPhaseExecutionException\",\n+                \"For more details, please send request for Json format\");\n+    }\n+\n+    @Test\n+    public void functionCallWithIllegalScriptShouldThrowESExceptionInJdbc() {\n+        String response = executeQuery(\"select log(balance + 2) from \" + TEST_INDEX_BANK,\n+                \"jdbc\");\n+        queryInJdbcResponseShouldIndicateESException(response, \"SearchPhaseExecutionException\",\n+                \"please send request for Json format to see the raw response from elasticsearch engine.\");\n+    }\n+\n+    @Ignore(\"Goes in different route, does not call PrettyFormatRestExecutor.execute methods.\" +\n+            \"The performRequest method in RestClient doesn't throw any exceptions for null value fields in script\")\n+    @Test\n+    public void functionArgWithNullValueFieldShouldThrowESExceptionInJdbc() {\n+        String response = executeQuery(\n+                \"select log(balance) from \" + TEST_INDEX_BANK_WITH_NULL_VALUES, \"jdbc\");\n+        queryInJdbcResponseShouldIndicateESException(response, \"SearchPhaseExecutionException\",\n+                \"For more details, please send request for Json format\");\n+    }\n+\n+    private void queryInJdbcResponseShouldIndicateESException(String response, String exceptionType, String... errMsgs) {\n+        Assert.assertThat(response, containsString(exceptionType));\n+        for (String errMsg: errMsgs) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxODA1MQ=="}, "originalCommit": {"oid": "6ca2fea95c9f4666a4bb71af36b7a45fc690af4d"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTUwMjMyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDozNzowMVrOFlExCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMjozNjoyM1rOFnOxGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxOTcyMw==", "bodyText": "Is this try-catch required? Same for fetchDetails and fetchSearchPhaseExecutionExceptionDetails.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r374419723", "createdAt": "2020-02-04T00:37:01Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.SearchPhaseExecutionException;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+\n+public class ElasticsearchErrorMessage extends ErrorMessage {\n+\n+    private static final Logger LOG = LogManager.getLogger();\n+\n+    ElasticsearchErrorMessage(ElasticsearchException exception, int status) {\n+        super(exception, status);\n+    }\n+\n+    @Override\n+    protected String fetchReason() {\n+        String detailedMsg = \"\";\n+        try {\n+            detailedMsg = \": \" + exception.getMessage();\n+        } catch (Exception e) {\n+            LOG.error(\"Error occurred when fetching ES exception reasons\", e);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90a74457a72cea06b2dba678718d6e55ec40e414"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY4MDcyOA==", "bodyText": "Have removed the unnecessary try-catchs, thanks!", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r376680728", "createdAt": "2020-02-08T02:36:23Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.SearchPhaseExecutionException;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+\n+public class ElasticsearchErrorMessage extends ErrorMessage {\n+\n+    private static final Logger LOG = LogManager.getLogger();\n+\n+    ElasticsearchErrorMessage(ElasticsearchException exception, int status) {\n+        super(exception, status);\n+    }\n+\n+    @Override\n+    protected String fetchReason() {\n+        String detailedMsg = \"\";\n+        try {\n+            detailedMsg = \": \" + exception.getMessage();\n+        } catch (Exception e) {\n+            LOG.error(\"Error occurred when fetching ES exception reasons\", e);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxOTcyMw=="}, "originalCommit": {"oid": "90a74457a72cea06b2dba678718d6e55ec40e414"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTUwNTI0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDozODo0MlrOFlEyyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDozODo0MlrOFlEyyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQyMDE2OA==", "bodyText": "Do we need else for other cases? ex. call super.fetchDetails() to get default message.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r374420168", "createdAt": "2020-02-04T00:38:42Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.SearchPhaseExecutionException;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+\n+public class ElasticsearchErrorMessage extends ErrorMessage {\n+\n+    private static final Logger LOG = LogManager.getLogger();\n+\n+    ElasticsearchErrorMessage(ElasticsearchException exception, int status) {\n+        super(exception, status);\n+    }\n+\n+    @Override\n+    protected String fetchReason() {\n+        String detailedMsg = \"\";\n+        try {\n+            detailedMsg = \": \" + exception.getMessage();\n+        } catch (Exception e) {\n+            LOG.error(\"Error occurred when fetching ES exception reasons\", e);\n+        }\n+        return \"Error occurred in Elasticsearch engine\" + detailedMsg;\n+    }\n+\n+    /** Currently Sql-Jdbc plugin only supports string type as reason and details in the error messages */\n+    @Override\n+    protected String fetchDetails() {\n+        StringBuilder details = new StringBuilder();\n+        try {\n+            if (exception instanceof SearchPhaseExecutionException) {\n+                String detail = fetchSearchPhaseExecutionExceptionDetails((SearchPhaseExecutionException) exception);\n+                details.append(detail);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90a74457a72cea06b2dba678718d6e55ec40e414"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTUxMTk1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ErrorMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDo0Mjo0MlrOFlE21w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDo0Mjo0MlrOFlE21w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQyMTIwNw==", "bodyText": "Could you remove this field and pass it to fetchReason and fetchDetails instead?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r374421207", "createdAt": "2020-02-04T00:42:42Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ErrorMessage.java", "diffHunk": "@@ -20,7 +20,7 @@\n \n public class ErrorMessage {\n \n-    private Exception exception;\n+    protected Exception exception;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90a74457a72cea06b2dba678718d6e55ec40e414"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTU1MjUzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMTowNzoxNVrOFlFPKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMTowNzoxNVrOFlFPKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQyNzQzMw==", "bodyText": "np: adding a space at the end of the error string will make it easier to read the exception message", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r374427433", "createdAt": "2020-02-04T01:07:15Z", "author": {"login": "davidcui1225"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.SearchPhaseExecutionException;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+\n+public class ElasticsearchErrorMessage extends ErrorMessage {\n+\n+    private static final Logger LOG = LogManager.getLogger();\n+\n+    ElasticsearchErrorMessage(ElasticsearchException exception, int status) {\n+        super(exception, status);\n+    }\n+\n+    @Override\n+    protected String fetchReason() {\n+        String detailedMsg = \"\";\n+        try {\n+            detailedMsg = \": \" + exception.getMessage();\n+        } catch (Exception e) {\n+            LOG.error(\"Error occurred when fetching ES exception reasons\", e);\n+        }\n+        return \"Error occurred in Elasticsearch engine\" + detailedMsg;\n+    }\n+\n+    /** Currently Sql-Jdbc plugin only supports string type as reason and details in the error messages */\n+    @Override\n+    protected String fetchDetails() {\n+        StringBuilder details = new StringBuilder();\n+        if (exception instanceof SearchPhaseExecutionException) {\n+            String detail = fetchSearchPhaseExecutionExceptionDetails((SearchPhaseExecutionException) exception);\n+            details.append(detail);\n+        } else {\n+            details.append(defaultDetails((ElasticsearchException) exception));\n+        }\n+        details.append(\"\\nFor more details, please send request for Json format to see the raw response from \"\n+                + \"elasticsearch engine.\");\n+        return details.toString();\n+    }\n+\n+    private String defaultDetails(ElasticsearchException exception) {\n+        String detailedMsg = \"\";\n+        try {\n+            detailedMsg = exception.getDetailedMessage();\n+        } catch (Exception e) {\n+            LOG.error(\"Error occurred when fetching ES exception details\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ca2fea95c9f4666a4bb71af36b7a45fc690af4d"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTU1Mzg0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMTowODowMlrOFlFP5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMzo0MzowOVrOFvlCNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQyNzYyMw==", "bodyText": "add the scope for constructor or using lombok", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r374427623", "createdAt": "2020-02-04T01:08:02Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.SearchPhaseExecutionException;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+\n+public class ElasticsearchErrorMessage extends ErrorMessage {\n+\n+    private static final Logger LOG = LogManager.getLogger();\n+\n+    ElasticsearchErrorMessage(ElasticsearchException exception, int status) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ca2fea95c9f4666a4bb71af36b7a45fc690af4d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzNDE2Ng==", "bodyText": "Did you mean set the access? I've set it to public", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r385434166", "createdAt": "2020-02-27T23:43:09Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.SearchPhaseExecutionException;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+\n+public class ElasticsearchErrorMessage extends ErrorMessage {\n+\n+    private static final Logger LOG = LogManager.getLogger();\n+\n+    ElasticsearchErrorMessage(ElasticsearchException exception, int status) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQyNzYyMw=="}, "originalCommit": {"oid": "6ca2fea95c9f4666a4bb71af36b7a45fc690af4d"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTg1NTU4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwNDo1NjowMVrOFlIFww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMjozODoyOFrOFnOxrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3NDE3OQ==", "bodyText": "is it possible to use factory method to construct the ErrorMessage", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r374474179", "createdAt": "2020-02-04T04:56:01Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -65,7 +66,13 @@ public Protocol(Client client, QueryAction queryAction, Object queryResult, Stri\n     public Protocol(Exception e) {\n         this.formatType = null;\n         this.status = ERROR_STATUS;\n-        this.error = new ErrorMessage(e, ERROR_STATUS);\n+        this.error = e instanceof ElasticsearchException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ca2fea95c9f4666a4bb71af36b7a45fc690af4d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY4MDg3OQ==", "bodyText": "Yes, the factory is done, thanks!", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r376680879", "createdAt": "2020-02-08T02:38:28Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -65,7 +66,13 @@ public Protocol(Client client, QueryAction queryAction, Object queryResult, Stri\n     public Protocol(Exception e) {\n         this.formatType = null;\n         this.status = ERROR_STATUS;\n-        this.error = new ErrorMessage(e, ERROR_STATUS);\n+        this.error = e instanceof ElasticsearchException", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3NDE3OQ=="}, "originalCommit": {"oid": "6ca2fea95c9f4666a4bb71af36b7a45fc690af4d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTkzNDM3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwNTo1NTowOFrOFlI0iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwNTo1NTowOFrOFlI0iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ4NjE1Mw==", "bodyText": "Not sure how easily ElasticsearchErrorMessage could be extended to handle different error type? Is it the valid use cases?\nIs it possible to create different ErrorMessage class for different exception type? for example,\npublic class ElasticsearchErrorMessage extends ErrorMessage<ElasticsearchException> {\n    public ElasticsearchErrorMessage(ElasticsearchException exception, int status) {\n        super(exception, status);\n    }\n    \n    @Override\n    protected String fetchReason() {\n        return exception.getMessage();\n    }\n\n    @Override\n    protected String fetchDetails() {\n        return exception.getDetailedMessage();\n    }\n}", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r374486153", "createdAt": "2020-02-04T05:55:08Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.SearchPhaseExecutionException;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+\n+public class ElasticsearchErrorMessage extends ErrorMessage {\n+\n+    private static final Logger LOG = LogManager.getLogger();\n+\n+    ElasticsearchErrorMessage(ElasticsearchException exception, int status) {\n+        super(exception, status);\n+    }\n+\n+    @Override\n+    protected String fetchReason() {\n+        String detailedMsg = \"\";\n+        try {\n+            detailedMsg = \": \" + exception.getMessage();\n+        } catch (Exception e) {\n+            LOG.error(\"Error occurred when fetching ES exception reasons\", e);\n+        }\n+        return \"Error occurred in Elasticsearch engine\" + detailedMsg;\n+    }\n+\n+    /** Currently Sql-Jdbc plugin only supports string type as reason and details in the error messages */\n+    @Override\n+    protected String fetchDetails() {\n+        StringBuilder details = new StringBuilder();\n+        if (exception instanceof SearchPhaseExecutionException) {\n+            String detail = fetchSearchPhaseExecutionExceptionDetails((SearchPhaseExecutionException) exception);\n+            details.append(detail);\n+        } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ca2fea95c9f4666a4bb71af36b7a45fc690af4d"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODIzNDQ0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ErrorMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMjo1NToxN1rOFocLZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMjo1NToxN1rOFocLZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0OTAyOA==", "bodyText": "Any reason to use generic type here? I assume there is no difference in our case.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r377949028", "createdAt": "2020-02-11T22:55:17Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ErrorMessage.java", "diffHunk": "@@ -18,16 +18,16 @@\n import org.elasticsearch.rest.RestStatus;\n import org.json.JSONObject;\n \n-public class ErrorMessage {\n+public class ErrorMessage<E extends Exception> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2e0f6a0e0589127413447fd73c4982523daceaf"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzODIzOTg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ErrorMessageFactory.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMjo1NzoyMFrOFocOkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMzowNzowOVrOFocdBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0OTg0Mw==", "bodyText": "Please add a little JavaDoc on this new class and public method. And also consider adding UT because your factory method has logic in unwrapCause().", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r377949843", "createdAt": "2020-02-11T22:57:20Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ErrorMessageFactory.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import org.elasticsearch.ElasticsearchException;\n+\n+public class ErrorMessageFactory {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2e0f6a0e0589127413447fd73c4982523daceaf"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MzMzMQ==", "bodyText": "Ok sure, will do.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r377953331", "createdAt": "2020-02-11T23:06:34Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ErrorMessageFactory.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import org.elasticsearch.ElasticsearchException;\n+\n+public class ErrorMessageFactory {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0OTg0Mw=="}, "originalCommit": {"oid": "a2e0f6a0e0589127413447fd73c4982523daceaf"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MzU0MA==", "bodyText": "Thanks!", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r377953540", "createdAt": "2020-02-11T23:07:09Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ErrorMessageFactory.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import org.elasticsearch.ElasticsearchException;\n+\n+public class ErrorMessageFactory {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0OTg0Mw=="}, "originalCommit": {"oid": "a2e0f6a0e0589127413447fd73c4982523daceaf"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NTIyNzE5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODo0Nzo0M1rOFpfaOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMTo0MzozM1rOFpklUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA1MDU1NQ==", "bodyText": "remove this?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r379050555", "createdAt": "2020-02-13T18:47:43Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -198,4 +199,21 @@ private JSONArray dataEntry(Row dataRow, Schema schema) {\n         }\n         return entry;\n     }\n+\n+    public static Throwable unwrapCause(Throwable t) {\n+        Throwable result = t;\n+        int layer = 0;\n+        // limit the unwrapping up to 5 layers\n+        while (result != null && layer < 5) {\n+            if (result instanceof ElasticsearchException) {\n+                return result;\n+            }\n+            if (result.getCause() == null) {\n+                return result;\n+            }\n+            result = result.getCause();\n+            layer++;\n+        }\n+        return result;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62e84d516f00d6ddfea5b9b8bad832f8e7dbdec5"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEzNTMxMw==", "bodyText": "Some exceptions that wrapped ES exceptions as the causes are thrown out. This method is to recognize them.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r379135313", "createdAt": "2020-02-13T21:43:33Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/Protocol.java", "diffHunk": "@@ -198,4 +199,21 @@ private JSONArray dataEntry(Row dataRow, Schema schema) {\n         }\n         return entry;\n     }\n+\n+    public static Throwable unwrapCause(Throwable t) {\n+        Throwable result = t;\n+        int layer = 0;\n+        // limit the unwrapping up to 5 layers\n+        while (result != null && layer < 5) {\n+            if (result instanceof ElasticsearchException) {\n+                return result;\n+            }\n+            if (result.getCause() == null) {\n+                return result;\n+            }\n+            result = result.getCause();\n+            layer++;\n+        }\n+        return result;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA1MDU1NQ=="}, "originalCommit": {"oid": "62e84d516f00d6ddfea5b9b8bad832f8e7dbdec5"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NzEzMjIwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMDowODo0NFrOFvlhAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNzozOTo0NVrOFwovzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MjA0OQ==", "bodyText": "np: can be reduced to one line? details.append(fetchSearchPhaseExecutionExceptionDetails((SearchPhaseExecutionException) exception);", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r385442049", "createdAt": "2020-02-28T00:08:44Z", "author": {"login": "davidcui1225"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.SearchPhaseExecutionException;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+\n+public class ElasticsearchErrorMessage extends ErrorMessage<ElasticsearchException> {\n+\n+    ElasticsearchErrorMessage(ElasticsearchException exception, int status) {\n+        super(exception, status);\n+    }\n+\n+    @Override\n+    protected String fetchReason() {\n+        return \"Error occurred in Elasticsearch engine: \" + exception.getMessage();\n+    }\n+\n+    /** Currently Sql-Jdbc plugin only supports string type as reason and details in the error messages */\n+    @Override\n+    protected String fetchDetails() {\n+        StringBuilder details = new StringBuilder();\n+        if (exception instanceof SearchPhaseExecutionException) {\n+            String detail = fetchSearchPhaseExecutionExceptionDetails((SearchPhaseExecutionException) exception);\n+            details.append(detail);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8bc91d5ddd50b43ebe29975b8ed791caf4f05a2"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0MzU2NA==", "bodyText": "yes, done now. thanks!", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r386543564", "createdAt": "2020-03-02T17:39:45Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/ElasticsearchErrorMessage.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.utils.StringUtils;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.search.SearchPhaseExecutionException;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+\n+public class ElasticsearchErrorMessage extends ErrorMessage<ElasticsearchException> {\n+\n+    ElasticsearchErrorMessage(ElasticsearchException exception, int status) {\n+        super(exception, status);\n+    }\n+\n+    @Override\n+    protected String fetchReason() {\n+        return \"Error occurred in Elasticsearch engine: \" + exception.getMessage();\n+    }\n+\n+    /** Currently Sql-Jdbc plugin only supports string type as reason and details in the error messages */\n+    @Override\n+    protected String fetchDetails() {\n+        StringBuilder details = new StringBuilder();\n+        if (exception instanceof SearchPhaseExecutionException) {\n+            String detail = fetchSearchPhaseExecutionExceptionDetails((SearchPhaseExecutionException) exception);\n+            details.append(detail);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MjA0OQ=="}, "originalCommit": {"oid": "f8bc91d5ddd50b43ebe29975b8ed791caf4f05a2"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTYzMzY2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/RestSqlAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzoyNjoxMFrOFv85gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNzozOToyNlrOFwovIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyNTE1Mg==", "bodyText": "Using ErrorMessageFactory.createErrorMessage?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r385825152", "createdAt": "2020-02-28T17:26:10Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/RestSqlAction.java", "diffHunk": "@@ -202,7 +202,7 @@ private void sendResponse(final RestChannel channel, final String message, final\n     }\n \n     private void reportError(final RestChannel channel, final Exception e, final RestStatus status) {\n-        sendResponse(channel, new ErrorMessage(e, status.getStatus()).toString(), status);\n+        sendResponse(channel, new ErrorMessage<>(e, status.getStatus()).toString(), status);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8bc91d5ddd50b43ebe29975b8ed791caf4f05a2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0MzM5NA==", "bodyText": "Done, thanks!", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r386543394", "createdAt": "2020-03-02T17:39:26Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/RestSqlAction.java", "diffHunk": "@@ -202,7 +202,7 @@ private void sendResponse(final RestChannel channel, final String message, final\n     }\n \n     private void reportError(final RestChannel channel, final Exception e, final RestStatus status) {\n-        sendResponse(channel, new ErrorMessage(e, status.getStatus()).toString(), status);\n+        sendResponse(channel, new ErrorMessage<>(e, status.getStatus()).toString(), status);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyNTE1Mg=="}, "originalCommit": {"oid": "f8bc91d5ddd50b43ebe29975b8ed791caf4f05a2"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTYzNDE2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/RestSqlStatsAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzoyNjoyMlrOFv85yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNzozOTo0MFrOFwovjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyNTIyNw==", "bodyText": "Using ErrorMessageFactory.createErrorMessage?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r385825227", "createdAt": "2020-02-28T17:26:22Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/RestSqlStatsAction.java", "diffHunk": "@@ -69,7 +69,7 @@ protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient cli\n             LOG.error(\"Failed during Query SQL STATS Action.\", e);\n \n             return channel -> channel.sendResponse(new BytesRestResponse(SERVICE_UNAVAILABLE,\n-                    new ErrorMessage(e, SERVICE_UNAVAILABLE.getStatus()).toString()));\n+                    new ErrorMessage<>(e, SERVICE_UNAVAILABLE.getStatus()).toString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8bc91d5ddd50b43ebe29975b8ed791caf4f05a2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0MzUwMg==", "bodyText": "It's done, thanks!", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/362#discussion_r386543502", "createdAt": "2020-03-02T17:39:40Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/plugin/RestSqlStatsAction.java", "diffHunk": "@@ -69,7 +69,7 @@ protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient cli\n             LOG.error(\"Failed during Query SQL STATS Action.\", e);\n \n             return channel -> channel.sendResponse(new BytesRestResponse(SERVICE_UNAVAILABLE,\n-                    new ErrorMessage(e, SERVICE_UNAVAILABLE.getStatus()).toString()));\n+                    new ErrorMessage<>(e, SERVICE_UNAVAILABLE.getStatus()).toString()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyNTIyNw=="}, "originalCommit": {"oid": "f8bc91d5ddd50b43ebe29975b8ed791caf4f05a2"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2168, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}