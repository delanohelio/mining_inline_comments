{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3OTIxOTYx", "number": 381, "title": "FIX: field function name letter case preserved in select with group by", "bodyText": "Issue #, if available:\n#373\nDescription of changes:\nmain:\n(1) SQLToOperatorConverter.java: add a function to extract raw SQLMethodInvokerExpr method names appearing in select fields\n(2) SQLAggregationParser.java: pass in raw method names into .parse and make adapted changes such that columnNode name is populated with the raw expression name.\ntest:\n(3) SQLAggregationParserTest: adapted .parse calls and added a unit test to verify raw function name gets populated in column node.\n(4) JdbcTestIT: fixed a test case assertion\n(5) TypeInformationIT: added a schema verifying integration test\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-03-13T18:37:08Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381", "merged": true, "mergeCommit": {"oid": "ad8ad3a920ce9ed6ba1f9559a04ef3ece8621028"}, "closed": true, "closedAt": "2020-03-19T20:43:31Z", "author": {"login": "chenqi0805"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNTJxXAH2gAyMzg3OTIxOTYxOjI0ZGQ4MmU4MWFjMzEwMzA4MzIzYTI2ZDU4YjVhNGJkYWI5ZWQ0M2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPNramAFqTM3NzgzNDcyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "24dd82e81ac310308323a26d58b5a4bdab9ed43b", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/24dd82e81ac310308323a26d58b5a4bdab9ed43b", "committedDate": "2020-03-13T16:45:58Z", "message": "FIX: Method field name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5", "committedDate": "2020-03-13T17:47:15Z", "message": "Merge branch 'master' into fix/373-field-name-letter-case-preserved-under-groupby"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTUzMDcx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#pullrequestreview-376553071", "createdAt": "2020-03-18T04:11:32Z", "commit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoxMTozMlrOF31yWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoxMTozMlrOF31yWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5NzI0MA==", "bodyText": "private?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#discussion_r394097240", "createdAt": "2020-03-18T04:11:32Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/query/planner/converter/SQLToOperatorConverter.java", "diffHunk": "@@ -76,6 +82,19 @@ public boolean visit(MySqlSelectQueryBlock query) {\n         return aggregationParser.getColumnNodes();\n     }\n \n+    public List<String> extractSelectFunctionNames(List<SQLSelectItem> selectItems) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTUzMzc5", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#pullrequestreview-376553379", "createdAt": "2020-03-18T04:12:36Z", "commit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoxMjozNlrOF31zUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoxMjozNlrOF31zUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5NzQ4OA==", "bodyText": "why change to assertTrue?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#discussion_r394097488", "createdAt": "2020-03-18T04:12:36Z", "author": {"login": "penghuo"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/JdbcTestIT.java", "diffHunk": "@@ -118,15 +118,16 @@ public void stringOperatorNameCaseInsensitiveTest() {\n \n     @Test\n     public void dateFunctionNameCaseInsensitiveTest() {\n-        assertEquals(\n+        assertTrue(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTU0MDQy", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#pullrequestreview-376554042", "createdAt": "2020-03-18T04:15:10Z", "commit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoxNToxMFrOF311hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoxNToxMFrOF311hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5ODA1Mg==", "bodyText": "Is it possible to make it as the function to avoid duplicate code in all the test cases?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#discussion_r394098052", "createdAt": "2020-03-18T04:15:10Z", "author": {"login": "penghuo"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/unittest/planner/converter/SQLAggregationParserTest.java", "diffHunk": "@@ -55,7 +59,9 @@ public void parseAggWithoutExpressionShouldPass() {\n                      \"FROM kibana_sample_data_flights \" +\n                      \"GROUP BY dayOfWeek\";\n         SQLAggregationParser parser = new SQLAggregationParser(new ColumnTypeProvider());\n-        parser.parse(mYSqlSelectQueryBlock(sql));\n+        MySqlSelectQueryBlock query = mYSqlSelectQueryBlock(sql);\n+        List<String> selectMethodNames = prepareRawMethodNames(query, true);\n+        parser.parse(query, selectMethodNames);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTU0NTc4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#pullrequestreview-376554578", "createdAt": "2020-03-18T04:17:07Z", "commit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoxNzowN1rOF313Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoxNzowN1rOF313Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5ODQ3OA==", "bodyText": "Is it the same function used in SQLToOperatorConverter?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#discussion_r394098478", "createdAt": "2020-03-18T04:17:07Z", "author": {"login": "penghuo"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/unittest/planner/converter/SQLAggregationParserTest.java", "diffHunk": "@@ -247,7 +306,28 @@ public void aggregationWithNestedShouldThrowException() {\n                      + \"FROM t \"\n                      + \"GROUP BY nested(projects.name.keyword, 'projects')\";\n         SQLAggregationParser parser = new SQLAggregationParser(new ColumnTypeProvider());\n-        parser.parse(mYSqlSelectQueryBlock(sql));\n+        MySqlSelectQueryBlock query = mYSqlSelectQueryBlock(sql);\n+        List<String> selectMethodNames = prepareRawMethodNames(query, true);\n+        parser.parse(query, selectMethodNames);\n+    }\n+\n+    private List<String> prepareRawMethodNames(MySqlSelectQueryBlock query, Boolean fillWithNull) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "originalPosition": 192}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTU2MDA0", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#pullrequestreview-376556004", "createdAt": "2020-03-18T04:22:25Z", "commit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoyMjoyNlrOF317xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoyMjoyNlrOF317xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5OTY1NA==", "bodyText": "Instead of just extracting the selectMethodNames, Is it possible to generate the final select name list regardless the field is method or not?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#discussion_r394099654", "createdAt": "2020-03-18T04:22:26Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/query/planner/converter/SQLToOperatorConverter.java", "diffHunk": "@@ -54,11 +57,14 @@ public SQLToOperatorConverter(Client client, ColumnTypeProvider columnTypeProvid\n \n     @Override\n     public boolean visit(MySqlSelectQueryBlock query) {\n+        //1. extract function names in select\n+        List<String> selectMethodNames = extractSelectFunctionNames(query.getSelectList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTU2MTM1", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#pullrequestreview-376556135", "createdAt": "2020-03-18T04:22:54Z", "commit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoyMjo1NFrOF318Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDoyMjo1NFrOF318Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5OTc4Mg==", "bodyText": "Avoid to use null value, Consider to use Optional if it is necessary.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#discussion_r394099782", "createdAt": "2020-03-18T04:22:54Z", "author": {"login": "penghuo"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/query/planner/converter/SQLToOperatorConverter.java", "diffHunk": "@@ -76,6 +82,19 @@ public boolean visit(MySqlSelectQueryBlock query) {\n         return aggregationParser.getColumnNodes();\n     }\n \n+    public List<String> extractSelectFunctionNames(List<SQLSelectItem> selectItems) {\n+        List<String> methodNames = new ArrayList<>();\n+        for (SQLSelectItem selectItem: selectItems){\n+            SQLExpr selectItemExpr = selectItem.getExpr();\n+            if (selectItemExpr instanceof SQLMethodInvokeExpr) {\n+                methodNames.add(((SQLMethodInvokeExpr) selectItemExpr).getMethodName());\n+            } else {\n+                methodNames.add(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTU2MTc4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#pullrequestreview-376556178", "createdAt": "2020-03-18T04:23:04Z", "commit": {"oid": "6ceba91ccf609ca7a3f87791bcbc38a7ff5863f5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e59e2eb4a736ee682e1bad056144e0a17d3002f2", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e59e2eb4a736ee682e1bad056144e0a17d3002f2", "committedDate": "2020-03-18T15:42:48Z", "message": "REF: parser logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b138beb811c02599cb88e4fd72b4e90b07bfa4c", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/5b138beb811c02599cb88e4fd72b4e90b07bfa4c", "committedDate": "2020-03-18T15:47:43Z", "message": "RMV: remove unused function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae275fd14a56487f6296c3868e5773c126ff0344", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ae275fd14a56487f6296c3868e5773c126ff0344", "committedDate": "2020-03-18T15:49:57Z", "message": "STY: unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7aaf016d7cc28a84dc41d088de9bf3300b3ed7a", "author": {"user": {"login": "chenqi0805", "name": "Qi Chen"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c7aaf016d7cc28a84dc41d088de9bf3300b3ed7a", "committedDate": "2020-03-18T15:51:51Z", "message": "STY: unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODMzMjU1", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#pullrequestreview-377833255", "createdAt": "2020-03-19T15:29:35Z", "commit": {"oid": "c7aaf016d7cc28a84dc41d088de9bf3300b3ed7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODM0NzI4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/381#pullrequestreview-377834728", "createdAt": "2020-03-19T15:31:08Z", "commit": {"oid": "c7aaf016d7cc28a84dc41d088de9bf3300b3ed7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 758, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}