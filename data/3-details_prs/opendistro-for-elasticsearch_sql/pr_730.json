{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwNDM4MDgy", "number": 730, "title": "Aggregation expression pushdown", "bodyText": "Description of changes\n\nAdd the aggregation push down logic.\n\nlimitation\n\nWithout logical plan optimization, only support two types of aggregation push down (1) agg-relation, (2) agg-filter-relation\nExpression over aggregation is not supported yet, which is only required by SQL.\nThe bucket size is limited as 1000 now.\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-09-05T04:44:22Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/730", "merged": true, "mergeCommit": {"oid": "e56d7ff96db6b66e4c11a7ac1cd721702a8cb428"}, "closed": true, "closedAt": "2020-09-11T16:49:17Z", "author": {"login": "penghuo"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFR2njAH2gAyNDgwNDM4MDgyOmEzNTA1YzY4M2JlODNlMTFmOWE4NjQ3ZTQ5MWYwY2ZjNWZmODgzNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH25JgAH2gAyNDgwNDM4MDgyOjBlNzJiODM1ZTdiYTg1NWE5MTAyZDljZmNhN2ZhYjgyYzIwN2Y1M2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a3505c683be83e11f9a8647e491f0cfc5ff88377", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a3505c683be83e11f9a8647e491f0cfc5ff88377", "committedDate": "2020-09-03T14:54:54Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa36031139d28192d88bcf32c3c4cb0a10aa0c7a", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/fa36031139d28192d88bcf32c3c4cb0a10aa0c7a", "committedDate": "2020-09-03T14:55:08Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b73ba01b9511daaabdc0296f76a3000fa96ca23", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8b73ba01b9511daaabdc0296f76a3000fa96ca23", "committedDate": "2020-09-04T06:16:48Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6153132a380efc3b8a683c65e53ea87140a110cd", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/6153132a380efc3b8a683c65e53ea87140a110cd", "committedDate": "2020-09-05T01:06:29Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70352ac613569fe16eb16498cab1695d45092fdb", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/70352ac613569fe16eb16498cab1695d45092fdb", "committedDate": "2020-09-05T01:38:13Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d187b4dfbe1bd703c5b761ae3aab96bd650cfd37", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d187b4dfbe1bd703c5b761ae3aab96bd650cfd37", "committedDate": "2020-09-05T04:36:13Z", "message": "update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMDMxODU3", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/730#pullrequestreview-483031857", "createdAt": "2020-09-05T05:20:55Z", "commit": {"oid": "d187b4dfbe1bd703c5b761ae3aab96bd650cfd37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6be0eb39a9772a8b155612b8cc88477141a7309", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e6be0eb39a9772a8b155612b8cc88477141a7309", "committedDate": "2020-09-08T17:52:38Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cef95b50c70b7c1e88be90561c436053bc22278c", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/cef95b50c70b7c1e88be90561c436053bc22278c", "committedDate": "2020-09-08T21:16:22Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85eb68b2ce2839521cc85db8a677190f9438400a", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/85eb68b2ce2839521cc85db8a677190f9438400a", "committedDate": "2020-09-08T22:35:03Z", "message": "merge from develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e89512a3a031e5201c70e20ff7ab2b73559f99d", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7e89512a3a031e5201c70e20ff7ab2b73559f99d", "committedDate": "2020-09-09T21:59:47Z", "message": "support SQL use cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mzc3MzAx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/730#pullrequestreview-486377301", "createdAt": "2020-09-10T23:28:27Z", "commit": {"oid": "7e89512a3a031e5201c70e20ff7ab2b73559f99d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzoyODoyN1rOHQJFXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzoyODoyN1rOHQJFXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4ODA5NA==", "bodyText": "np: same as AstBuilder.getTextInQuery() and can move to some parsing util class?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/730#discussion_r486688094", "createdAt": "2020-09-10T23:28:27Z", "author": {"login": "dai-chen"}, "path": "sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/context/QuerySpecification.java", "diffHunk": "@@ -117,13 +125,22 @@ public Void visitGroupByElement(GroupByElementContext ctx) {\n \n     @Override\n     public Void visitAggregateFunctionCall(AggregateFunctionCallContext ctx) {\n-      aggregators.add((AggregateFunction) visitAstExpression(ctx));\n+      aggregators.add(AstDSL.alias(getTextInQuery(ctx), visitAstExpression(ctx)));\n       return super.visitAggregateFunctionCall(ctx);\n     }\n \n     private UnresolvedExpression visitAstExpression(ParseTree tree) {\n       return expressionBuilder.visit(tree);\n     }\n+\n+    /**\n+     * Get original text in query.\n+     */\n+    private String getTextInQuery(ParserRuleContext ctx) {\n+      Token start = ctx.getStart();\n+      Token stop = ctx.getStop();\n+      return queryString.substring(start.getStartIndex(), stop.getStopIndex() + 1);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e89512a3a031e5201c70e20ff7ab2b73559f99d"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e72b835e7ba855a9102d9cfca7fab82c207f53a", "author": {"user": {"login": "penghuo", "name": "Peng Huo"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/0e72b835e7ba855a9102d9cfca7fab82c207f53a", "committedDate": "2020-09-11T15:12:00Z", "message": "address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 633, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}