{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0ODM4ODg1", "number": 671, "title": "Lucene query pushdown optimization", "bodyText": "Issue #, if available:\nDescription of changes: The major changes in this PR are new added LuceneQuery abstraction and its subclass to implement different Lucene query APIs. To clarify, Lucene query here means Lucene query via Elasticsearch DSL. We don't bypass DSL and call Lucene directly.\nProblem Statement: In PR #663, we register our expression as new script language and optimize expression evaluation by pushdown to script query in Elasticsearch DSL. However, what was not covered yet is that how we can leverage Lucene API for expression that can be optimized. For certain expression, we want to optimize filtering expression further by pushing down to Lucene query fully or partially.\nSolution: The core logic is in FilterQueryBuilder.visitFunction method which is executed in the top down way:\n\nAND, OR, NOT: Translate to bool query and visit left/right side recursively\nFunctions that Lucene may support: Translate to Lucene query if left side is a reference (field name) and right is a literal. Otherwise go to 3.\nFunctions that Lucene doesn't support or argument is not valid as mentioned in 2: Serialize the expression (subtree with current function node as root) and translate to script query.\n\nHere is an example to help understand. AND is translated to bool filter query directly (case #1). The name = 'John' is eligible because = can be translated to Lucene term query and left side (first argument) is a reference and right side is a literal (case #2). ABS(age) = 30 is translated to a script query (case #3).\n\nTesting: new UT and PPL IT can pass. Since we don't have explain API yet, SQL IT and doctest will be added later.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-08-07T21:20:50Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/671", "merged": true, "mergeCommit": {"oid": "4962a376abb1f1bb122a39aff9eac32e09dd5e31"}, "closed": true, "closedAt": "2020-08-17T18:18:14Z", "author": {"login": "dai-chen"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc945d9gH2gAyNDY0ODM4ODg1OjRlYzkyYWI5OTU0YjExNzNhZWNlNTQzZjExOWY5ZTRhNmRlMjdkM2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_2XWEgH2gAyNDY0ODM4ODg1OmJkZmJhODdhYjU3MzJmNTYxZTQwYzY5MmViMzFjZDQ3YTgyYzA5NDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4ec92ab9954b1173aece543f119f9e4a6de27d3b", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/4ec92ab9954b1173aece543f119f9e4a6de27d3b", "committedDate": "2020-08-11T15:52:55Z", "message": "Add lucene builder interface and term query impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f666886b39b82c6990e6010334b62c5ee12db4a2", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f666886b39b82c6990e6010334b62c5ee12db4a2", "committedDate": "2020-08-11T15:55:03Z", "message": "Add lucene query interface and term query impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a332fa4997ea297bf098315218c49d55eb7924b", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1a332fa4997ea297bf098315218c49d55eb7924b", "committedDate": "2020-08-11T15:55:03Z", "message": "Add range query impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e95041264648b8a71f7e1a58a1a1291a682fd3aa", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e95041264648b8a71f7e1a58a1a1291a682fd3aa", "committedDate": "2020-08-11T15:55:03Z", "message": "Add more UT for range query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2dcde417fb70bcc640e64709dbd9c1566dec81e", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a2dcde417fb70bcc640e64709dbd9c1566dec81e", "committedDate": "2020-08-11T15:55:03Z", "message": "Add wildcard query impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40e659b8ae745d4cb9ad39cf59cc229688027570", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/40e659b8ae745d4cb9ad39cf59cc229688027570", "committedDate": "2020-08-11T15:55:03Z", "message": "Add exists query impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d47881083e517ddc4f990d25ab67fbe1ab7a9acb", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d47881083e517ddc4f990d25ab67fbe1ab7a9acb", "committedDate": "2020-08-11T15:55:03Z", "message": "Pass jacoco test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da47f8b5dfe81e34d75a2f1157095b5d9d571457", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/da47f8b5dfe81e34d75a2f1157095b5d9d571457", "committedDate": "2020-08-07T20:55:19Z", "message": "Pass jacoco test"}, "afterCommit": {"oid": "d47881083e517ddc4f990d25ab67fbe1ab7a9acb", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/d47881083e517ddc4f990d25ab67fbe1ab7a9acb", "committedDate": "2020-08-11T15:55:03Z", "message": "Pass jacoco test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f347b011ace1a0c6fcb253c8350bf40ad87d513", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/2f347b011ace1a0c6fcb253c8350bf40ad87d513", "committedDate": "2020-08-11T16:13:08Z", "message": "Prepare PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24b5e1a0b251e6707c5ed4f97ec207148e8bf28e", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/24b5e1a0b251e6707c5ed4f97ec207148e8bf28e", "committedDate": "2020-08-13T14:38:47Z", "message": "Only push down filter close to relation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "366f42ccc472a74a09bd0a2fba27413ba6dc4aae", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/366f42ccc472a74a09bd0a2fba27413ba6dc4aae", "committedDate": "2020-08-13T18:36:57Z", "message": "Prepare PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a0053e128f21969d16974c80ecd14bb0e35c45a", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3a0053e128f21969d16974c80ecd14bb0e35c45a", "committedDate": "2020-08-13T18:46:41Z", "message": "Merge branch 'develop' into lucene-pushdown-optimization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3OTM0Mzc2", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/671#pullrequestreview-467934376", "createdAt": "2020-08-15T01:03:19Z", "commit": {"oid": "3a0053e128f21969d16974c80ecd14bb0e35c45a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQwMTowMzoxOVrOHBGlIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQwMTowMzoxOVrOHBGlIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkxODQzMg==", "bodyText": "could you add doc for this limitation?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/671#discussion_r470918432", "createdAt": "2020-08-15T01:03:19Z", "author": {"login": "penghuo"}, "path": "elasticsearch/src/main/java/com/amazon/opendistroforelasticsearch/sql/elasticsearch/storage/script/filter/lucene/TermQuery.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ *    Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *    Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *    You may not use this file except in compliance with the License.\n+ *    A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *    or in the \"license\" file accompanying this file. This file is distributed\n+ *    on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *    express or implied. See the License for the specific language governing\n+ *    permissions and limitations under the License.\n+ *\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.elasticsearch.storage.script.filter.lucene;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.elasticsearch.data.type.ElasticsearchDataType.ES_TEXT_KEYWORD;\n+\n+import com.amazon.opendistroforelasticsearch.sql.data.model.ExprValue;\n+import com.amazon.opendistroforelasticsearch.sql.data.type.ExprType;\n+import org.elasticsearch.index.query.QueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilders;\n+\n+/**\n+ * Lucene query that build term query for equality comparison.\n+ */\n+public class TermQuery extends LuceneQuery {\n+\n+  @Override\n+  protected QueryBuilder doBuild(String fieldName, ExprType fieldType, ExprValue literal) {\n+    if (fieldType == ES_TEXT_KEYWORD) { // Assume inner field name is always \"keyword\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a0053e128f21969d16974c80ecd14bb0e35c45a"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3OTM0NTQx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/671#pullrequestreview-467934541", "createdAt": "2020-08-15T01:04:46Z", "commit": {"oid": "3a0053e128f21969d16974c80ecd14bb0e35c45a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MTA5OTE4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/671#pullrequestreview-468109918", "createdAt": "2020-08-17T00:21:26Z", "commit": {"oid": "3a0053e128f21969d16974c80ecd14bb0e35c45a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f0793b72fef56b704e4aa264b04c0e62265f94f", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/1f0793b72fef56b704e4aa264b04c0e62265f94f", "committedDate": "2020-08-17T16:09:31Z", "message": "Merge branch 'develop' into lucene-pushdown-optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38e93680dac15e1ad0c0acc29980b5be9f80e20c", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/38e93680dac15e1ad0c0acc29980b5be9f80e20c", "committedDate": "2020-08-17T17:53:02Z", "message": "Add limitation doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "284433334cb025a5e5b5013838fad3296e0325e9", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/284433334cb025a5e5b5013838fad3296e0325e9", "committedDate": "2020-08-17T18:02:25Z", "message": "Add limitation doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdfba87ab5732f561e40c692eb31cd47a82c0943", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/bdfba87ab5732f561e40c692eb31cd47a82c0943", "committedDate": "2020-08-17T18:03:41Z", "message": "Add limitation doc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 617, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}