{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2ODcwNjQw", "number": 854, "title": "Add JDBC formatter in new SQL engine", "bodyText": "Issue #, if available: N/A\nDescription of changes: Add a new JDBC formatter to format new engine response as before. This is intend to avoid impact on user after new SQL engine enabled in future. The main differences between this and default JSON formatter include:\n\nalias field in schema\nstatus field is added\nData type: convert to legacy type name for compatibility, including ES_TEXT, ES_TEXT_KEYWORD, STRUCT, ARRAY.\nError response: follow exactly same format as before. Treat syntax and query engine exception as client error.\n\nNote that this is only for SQL and will take effect without format parameter or with format=jdbc New PPL doesn't need this.\nTODO:\n\nAdd version field and do version check on client side: simply adding new field causes JDBC driver broken, so need to change both sides together later.\nFor now total field is always same as size: need to use total number of hits as before\n\nTesting:\n\nAdd new JdbcFormatIT\nAdd back legacy IT removed earlier due to response format issue: AggregationExpressionIT and QueryIT\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-11-25T00:01:56Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/854", "merged": true, "mergeCommit": {"oid": "85202b67492fbc2924ec40b90cad9c5475048708"}, "closed": true, "closedAt": "2020-12-01T22:30:23Z", "author": {"login": "dai-chen"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdb8soxgH2gAyNTI2ODcwNjQwOmE0ZGFlMWZlMTQwNzUwNjk3ZWRhOWI0ZDRkYmIyMGFkMDVjZTVjNWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiAvjWAH2gAyNTI2ODcwNjQwOmY2ZTNhZDM4OGY2YjFlMWRjNTMxNzllNDdlMWY1MTUxOGUzZTE1MzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a4dae1fe140750697eda9b4d4dbb20ad05ce5c5d", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a4dae1fe140750697eda9b4d4dbb20ad05ce5c5d", "committedDate": "2020-11-13T01:16:15Z", "message": "Add jdbc formatter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04e905679bde9a04b6712987e51673559cb14413", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/04e905679bde9a04b6712987e51673559cb14413", "committedDate": "2020-11-21T00:19:33Z", "message": "Merge branch 'develop' into add-jdbc-formatter-in-new-engine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ff1a6a7f95c4e3baec51e7e8c2e720601023f98", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3ff1a6a7f95c4e3baec51e7e8c2e720601023f98", "committedDate": "2020-11-21T00:37:07Z", "message": "Add error response format method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a88a2ecee2ef4d15dfdeec3627965461d88b80a9", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a88a2ecee2ef4d15dfdeec3627965461d88b80a9", "committedDate": "2020-11-23T18:46:34Z", "message": "Add java doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb959a88462e8ed0bb8c642024f5c1c9b47b3c36", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/eb959a88462e8ed0bb8c642024f5c1c9b47b3c36", "committedDate": "2020-11-23T19:03:51Z", "message": "Convert type to lower case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40502874c00b562683b1dada925376cf8c89d610", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/40502874c00b562683b1dada925376cf8c89d610", "committedDate": "2020-11-23T19:29:36Z", "message": "Enable branch coverage and pass jacoco"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1c237b3983f3edf0e2ac69599d00efd44767125", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a1c237b3983f3edf0e2ac69599d00efd44767125", "committedDate": "2020-11-23T23:02:53Z", "message": "Remove version for now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd41b79eababac86f2df75e83652a76997c24e3f", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/dd41b79eababac86f2df75e83652a76997c24e3f", "committedDate": "2020-11-23T23:13:14Z", "message": "Fix broken ITs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7670710caa1c7ccec8e34f13caebdc4ad161142", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f7670710caa1c7ccec8e34f13caebdc4ad161142", "committedDate": "2020-11-24T18:54:11Z", "message": "Change error code to 503"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a090ace712d347c209bbe2263352dcd1f6f2acf6", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/a090ace712d347c209bbe2263352dcd1f6f2acf6", "committedDate": "2020-11-24T21:59:34Z", "message": "Add back legcy ITs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f862215369df74c8d502488e0c5e2be2815a2c2f", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f862215369df74c8d502488e0c5e2be2815a2c2f", "committedDate": "2020-11-24T23:05:28Z", "message": "Convert all legacy types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dad8736d664aa5fc5cfc1a12875faca17c441d19", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/dad8736d664aa5fc5cfc1a12875faca17c441d19", "committedDate": "2020-11-24T23:30:42Z", "message": "Add IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11df761d4408cf0b490f3c2d61d4962c4c86cb8e", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/11df761d4408cf0b490f3c2d61d4962c4c86cb8e", "committedDate": "2020-11-25T00:01:08Z", "message": "Prepare PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b48a5443f131e40ce88d9550633bb2ee338ab864", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b48a5443f131e40ce88d9550633bb2ee338ab864", "committedDate": "2020-11-25T00:47:40Z", "message": "Prepare PR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODQ2MTM5", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/854#pullrequestreview-538846139", "createdAt": "2020-11-25T21:06:57Z", "commit": {"oid": "b48a5443f131e40ce88d9550633bb2ee338ab864"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMTowNjo1OFrOH6D3dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMTowNjo1OFrOH6D3dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY0MjgwNw==", "bodyText": "How to handle the missing value?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/854#discussion_r530642807", "createdAt": "2020-11-25T21:06:58Z", "author": {"login": "penghuo"}, "path": "protocol/src/test/java/com/amazon/opendistroforelasticsearch/sql/protocol/response/format/JdbcResponseFormatterTest.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ *    Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *    Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *    You may not use this file except in compliance with the License.\n+ *    A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *    or in the \"license\" file accompanying this file. This file is distributed\n+ *    on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *    express or implied. See the License for the specific language governing\n+ *    permissions and limitations under the License.\n+ *\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.protocol.response.format;\n+\n+import static com.amazon.opendistroforelasticsearch.sql.data.model.ExprValueUtils.tupleValue;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.ARRAY;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.INTEGER;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.STRING;\n+import static com.amazon.opendistroforelasticsearch.sql.data.type.ExprCoreType.STRUCT;\n+import static com.amazon.opendistroforelasticsearch.sql.elasticsearch.data.type.ElasticsearchDataType.ES_TEXT;\n+import static com.amazon.opendistroforelasticsearch.sql.elasticsearch.data.type.ElasticsearchDataType.ES_TEXT_KEYWORD;\n+import static com.amazon.opendistroforelasticsearch.sql.executor.ExecutionEngine.Schema;\n+import static com.amazon.opendistroforelasticsearch.sql.executor.ExecutionEngine.Schema.Column;\n+import static com.amazon.opendistroforelasticsearch.sql.protocol.response.format.JsonResponseFormatter.Style.COMPACT;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import com.amazon.opendistroforelasticsearch.sql.common.antlr.SyntaxCheckException;\n+import com.amazon.opendistroforelasticsearch.sql.exception.SemanticCheckException;\n+import com.amazon.opendistroforelasticsearch.sql.protocol.response.QueryResult;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.gson.JsonParser;\n+import org.junit.jupiter.api.Test;\n+\n+class JdbcResponseFormatterTest {\n+\n+  private final JdbcResponseFormatter formatter = new JdbcResponseFormatter(COMPACT);\n+\n+  @Test\n+  void format_response() {\n+    QueryResult response = new QueryResult(\n+        new Schema(ImmutableList.of(\n+            new Column(\"name\", \"name\", STRING),\n+            new Column(\"address1\", \"address1\", ES_TEXT),\n+            new Column(\"address2\", \"address2\", ES_TEXT_KEYWORD),\n+            new Column(\"location\", \"location\", STRUCT),\n+            new Column(\"employer\", \"employer\", ARRAY),\n+            new Column(\"age\", \"age\", INTEGER))),\n+        ImmutableList.of(\n+            tupleValue(ImmutableMap.of(\"name\", \"John\", \"age\", 20))));\n+\n+    assertJsonEquals(\n+        \"{\"\n+            + \"\\\"schema\\\":[\"\n+            + \"{\\\"name\\\":\\\"name\\\",\\\"alias\\\":\\\"name\\\",\\\"type\\\":\\\"keyword\\\"},\"\n+            + \"{\\\"name\\\":\\\"address1\\\",\\\"alias\\\":\\\"address1\\\",\\\"type\\\":\\\"text\\\"},\"\n+            + \"{\\\"name\\\":\\\"address2\\\",\\\"alias\\\":\\\"address2\\\",\\\"type\\\":\\\"text\\\"},\"\n+            + \"{\\\"name\\\":\\\"location\\\",\\\"alias\\\":\\\"location\\\",\\\"type\\\":\\\"object\\\"},\"\n+            + \"{\\\"name\\\":\\\"employer\\\",\\\"alias\\\":\\\"employer\\\",\\\"type\\\":\\\"nested\\\"},\"\n+            + \"{\\\"name\\\":\\\"age\\\",\\\"alias\\\":\\\"age\\\",\\\"type\\\":\\\"integer\\\"}\"\n+            + \"],\"\n+            + \"\\\"datarows\\\":[[\\\"John\\\",20]],\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b48a5443f131e40ce88d9550633bb2ee338ab864"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e05cd8f16fe54e01d67a1b200aea9de604630bd3", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e05cd8f16fe54e01d67a1b200aea9de604630bd3", "committedDate": "2020-11-25T22:34:17Z", "message": "Merge branch 'develop' into add-jdbc-formatter-in-new-engine"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODk3Mjkz", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/854#pullrequestreview-538897293", "createdAt": "2020-11-25T23:08:35Z", "commit": {"oid": "e05cd8f16fe54e01d67a1b200aea9de604630bd3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d6fbd31980b399c0dc537b59146e6f2974969c7", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3d6fbd31980b399c0dc537b59146e6f2974969c7", "committedDate": "2020-11-26T00:13:12Z", "message": "Address PR comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e516d4ca78f4068d61cffb007ac4fffe5e560ab", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3e516d4ca78f4068d61cffb007ac4fffe5e560ab", "committedDate": "2020-11-26T01:25:58Z", "message": "Merge branch 'develop' into add-jdbc-formatter-in-new-engine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c403c0bbaba852398cfd27b5e573803dffc7b9c6", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c403c0bbaba852398cfd27b5e573803dffc7b9c6", "committedDate": "2020-11-26T01:27:50Z", "message": "Remove valueMap"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzAyOTEx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/854#pullrequestreview-542302911", "createdAt": "2020-12-01T21:17:02Z", "commit": {"oid": "c403c0bbaba852398cfd27b5e573803dffc7b9c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6e3ad388f6b1e1dc53179e47e1f51518e3e1532", "author": {"user": {"login": "dai-chen", "name": "Chen Dai"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/f6e3ad388f6b1e1dc53179e47e1f51518e3e1532", "committedDate": "2020-12-01T21:22:36Z", "message": "Merge branch 'develop' into add-jdbc-formatter-in-new-engine"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 572, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}