{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNjk3Mjc2", "number": 337, "title": "Fix JDBC response for delete query", "bodyText": "Issue: #131\nDescription of changes:\nFixes the JDBC output format of delete query\nPreviously\n==== _opendistro/_sql?_format=jdbc ====\n{\n  \"error\": {\n    \"reason\": \"There was internal problem at backend\",\n    \"details\": \"class com.amazon.opendistroforelasticsearch.sql.domain.Delete cannot be cast to class com.amazon.opendistroforelasticsearch.sql.domain.Select (com.amazon.opendistroforelasticsearch.sql.domain.Delete and com.amazon.opendistroforelasticsearch.sql.domain.Select are in unnamed module of loader java.net.FactoryURLClassLoader @46963479)\",\n    \"type\": \"ClassCastException\"\n  },\n  \"status\": 500\n}\n\nNow\n{\n  \"schema\": [{\n    \"name\": \"deleted_rows\",\n    \"type\": \"long\"\n  }],\n  \"total\": 1,\n  \"datarows\": [[1]],\n  \"size\": 1,\n  \"status\": 200\n}\n\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-01-08T23:13:57Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/337", "merged": true, "mergeCommit": {"oid": "31f8624fc541d9c7220bb0c5dc24f55f087dd145"}, "closed": true, "closedAt": "2020-01-13T21:36:14Z", "author": {"login": "abbashus"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4doCaAH2gAyMzYwNjk3Mjc2OmIxNDY5MDMwYmYyZGExNzM2ZDliYmNjMjI0ZWNhMThlZjQzODY3MzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6DTOXgFqTM0MjE1MzcxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b1469030bf2da1736d9bbcc224eca18ef4386733", "author": {"user": {"login": "abbashus", "name": "Abbas Hussain"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b1469030bf2da1736d9bbcc224eca18ef4386733", "committedDate": "2020-01-08T23:05:40Z", "message": "Fix JDBC response for Delete queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3634d25f555d6a7a448b4c55a5896f32e6a338d3", "author": {"user": {"login": "abbashus", "name": "Abbas Hussain"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3634d25f555d6a7a448b4c55a5896f32e6a338d3", "committedDate": "2020-01-08T23:06:59Z", "message": "Add integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47fc33aa570e5e54f1e0c4a1ec2d512a2def240a", "author": {"user": {"login": "abbashus", "name": "Abbas Hussain"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/47fc33aa570e5e54f1e0c4a1ec2d512a2def240a", "committedDate": "2020-01-08T23:08:57Z", "message": "Merge branch 'master' into improve-delete"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMjEzMzY5", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/337#pullrequestreview-340213369", "createdAt": "2020-01-08T23:35:52Z", "commit": {"oid": "47fc33aa570e5e54f1e0c4a1ec2d512a2def240a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzozNTo1MlrOFbnHjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMzozNTo1MlrOFbnHjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5Njc4MA==", "bodyText": "What if the data type is not LONG? Do we need to retrieve the data type from the schema rather than hard coding?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/337#discussion_r364496780", "createdAt": "2020-01-08T23:35:52Z", "author": {"login": "chloe-zh"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/DeleteResultSet.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.domain.Delete;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.index.reindex.BulkByScrollResponse;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class DeleteResultSet extends ResultSet {\n+    private Delete query;\n+    private Object queryResult;\n+\n+    private static final String DELETED = \"deleted_rows\";\n+\n+    public DeleteResultSet(Client client, Delete query, Object queryResult) {\n+        this.client = client;\n+        this.query = query;\n+        this.queryResult = queryResult;\n+        this.schema = new Schema(loadColumns());\n+        this.dataRows = new DataRows(loadRows());\n+    }\n+\n+    private List<Schema.Column> loadColumns() {\n+        return Collections.singletonList(new Schema.Column(DELETED, null, Schema.Type.LONG));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47fc33aa570e5e54f1e0c4a1ec2d512a2def240a"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMjIzNDEw", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/337#pullrequestreview-340223410", "createdAt": "2020-01-09T00:07:49Z", "commit": {"oid": "47fc33aa570e5e54f1e0c4a1ec2d512a2def240a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMDowNzo0OVrOFbnnRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMDowNzo0OVrOFbnnRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUwNDkwMw==", "bodyText": "Should assertion for total and size be equalTo(totalHits)? And any reason not to use total or size as deleted rows directly?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/337#discussion_r364504903", "createdAt": "2020-01-09T00:07:49Z", "author": {"login": "dai-chen"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/DeleteIT.java", "diffHunk": "@@ -77,12 +68,76 @@ public void deleteWithConditionTest() throws IOException, InterruptedException {\n         // To prevent flakiness, the minimum value of 2000 msec works fine.\n         Thread.sleep(2000);\n \n-        selectQuery = String.format(\n-            Locale.ROOT,\n-            \"SELECT * FROM %s/phrase\",\n+        selectQuery = StringUtils.format(\"SELECT * FROM %s/phrase\", TestsConstants.TEST_INDEX_PHRASE);\n+\n+        response = executeRequest(makeRequest(selectQuery));\n+        assertThat(getTotalHits(response), equalTo(5));\n+    }\n+\n+    @Test\n+    public void deleteAllWithJdbcFormat() throws IOException, InterruptedException {\n+        String selectQuery = StringUtils.format(\"SELECT * FROM %s/account\", TestsConstants.TEST_INDEX_ACCOUNT);\n+        JSONObject response = executeRequest(makeRequest(selectQuery));\n+        int totalHits = getTotalHits(response);\n+\n+        String deleteQuery = StringUtils.format(\"DELETE FROM %s/account\", TestsConstants.TEST_INDEX_ACCOUNT);\n+\n+        response = new JSONObject(executeQuery(deleteQuery, \"jdbc\"));\n+        System.out.println(response);\n+        assertThat(response.query(\"/schema/0/name\"), equalTo(\"deleted_rows\"));\n+        assertThat(response.query(\"/schema/0/type\"), equalTo(\"long\"));\n+        assertThat(response.query(\"/datarows/0/0\"), equalTo(totalHits));\n+        assertThat(response.query(\"/total\"), equalTo(1));\n+        assertThat(response.query(\"/status\"), equalTo(200));\n+        assertThat(response.query(\"/size\"), equalTo(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47fc33aa570e5e54f1e0c4a1ec2d512a2def240a"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMjI1ODQ4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/337#pullrequestreview-340225848", "createdAt": "2020-01-09T00:16:14Z", "commit": {"oid": "47fc33aa570e5e54f1e0c4a1ec2d512a2def240a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMDoxNjoxNVrOFbnvZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMDoxNjoxNVrOFbnvZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUwNjk4Mw==", "bodyText": "Probably not necessary for this data class. But it would be better to add a UT for test coverage.", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/337#discussion_r364506983", "createdAt": "2020-01-09T00:16:15Z", "author": {"login": "dai-chen"}, "path": "src/main/java/com/amazon/opendistroforelasticsearch/sql/executor/format/DeleteResultSet.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ *   Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.executor.format;\n+\n+import com.amazon.opendistroforelasticsearch.sql.domain.Delete;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.index.reindex.BulkByScrollResponse;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class DeleteResultSet extends ResultSet {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47fc33aa570e5e54f1e0c4a1ec2d512a2def240a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNjg3NzI1", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/337#pullrequestreview-340687725", "createdAt": "2020-01-09T17:22:27Z", "commit": {"oid": "47fc33aa570e5e54f1e0c4a1ec2d512a2def240a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzoyMjoyN1rOFb9nzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzoyMjoyN1rOFb9nzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2NTQ4Ng==", "bodyText": "Perhaps not necessary- but I think it could be beneficial to add 1-2 more variety of queries to test with", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/337#discussion_r364865486", "createdAt": "2020-01-09T17:22:27Z", "author": {"login": "davidcui1225"}, "path": "src/test/java/com/amazon/opendistroforelasticsearch/sql/esintgtest/DeleteIT.java", "diffHunk": "@@ -77,12 +68,76 @@ public void deleteWithConditionTest() throws IOException, InterruptedException {\n         // To prevent flakiness, the minimum value of 2000 msec works fine.\n         Thread.sleep(2000);\n \n-        selectQuery = String.format(\n-            Locale.ROOT,\n-            \"SELECT * FROM %s/phrase\",\n+        selectQuery = StringUtils.format(\"SELECT * FROM %s/phrase\", TestsConstants.TEST_INDEX_PHRASE);\n+\n+        response = executeRequest(makeRequest(selectQuery));\n+        assertThat(getTotalHits(response), equalTo(5));\n+    }\n+\n+    @Test\n+    public void deleteAllWithJdbcFormat() throws IOException, InterruptedException {\n+        String selectQuery = StringUtils.format(\"SELECT * FROM %s/account\", TestsConstants.TEST_INDEX_ACCOUNT);\n+        JSONObject response = executeRequest(makeRequest(selectQuery));\n+        int totalHits = getTotalHits(response);\n+\n+        String deleteQuery = StringUtils.format(\"DELETE FROM %s/account\", TestsConstants.TEST_INDEX_ACCOUNT);\n+\n+        response = new JSONObject(executeQuery(deleteQuery, \"jdbc\"));\n+        System.out.println(response);\n+        assertThat(response.query(\"/schema/0/name\"), equalTo(\"deleted_rows\"));\n+        assertThat(response.query(\"/schema/0/type\"), equalTo(\"long\"));\n+        assertThat(response.query(\"/datarows/0/0\"), equalTo(totalHits));\n+        assertThat(response.query(\"/total\"), equalTo(1));\n+        assertThat(response.query(\"/status\"), equalTo(200));\n+        assertThat(response.query(\"/size\"), equalTo(1));\n+\n+        // The documents are not deleted immediately, causing the next search call to return all results.\n+        // To prevent flakiness, the minimum value of 2000 msec works fine.\n+        Thread.sleep(2000);\n+\n+        response = executeRequest(makeRequest(selectQuery));\n+        assertThat(getTotalHits(response), equalTo(0));\n+\n+        // Multiple invocation of delete query should return deleted == 0\n+        response = new JSONObject(executeQuery(deleteQuery, \"jdbc\"));\n+        assertThat(response.query(\"/datarows/0/0\"), equalTo(0));\n+    }\n+\n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47fc33aa570e5e54f1e0c4a1ec2d512a2def240a"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d64794a1f174a8d917bc794af8c7c73ddcb15c", "author": {"user": {"login": "abbashus", "name": "Abbas Hussain"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/98d64794a1f174a8d917bc794af8c7c73ddcb15c", "committedDate": "2020-01-10T23:40:52Z", "message": "Add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdbe3777d387250837ce983728ee33d18aee1a7a", "author": {"user": {"login": "abbashus", "name": "Abbas Hussain"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/fdbe3777d387250837ce983728ee33d18aee1a7a", "committedDate": "2020-01-10T23:52:31Z", "message": "Remove un-needed comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNDg1MDc4", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/337#pullrequestreview-341485078", "createdAt": "2020-01-11T00:24:50Z", "commit": {"oid": "98d64794a1f174a8d917bc794af8c7c73ddcb15c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d1755ef30feaf888261edef4e0fac8e00f2613b", "author": {"user": {"login": "abbashus", "name": "Abbas Hussain"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8d1755ef30feaf888261edef4e0fac8e00f2613b", "committedDate": "2020-01-13T19:40:51Z", "message": "Merge branch 'master' into improve-delete"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMTUzNzE3", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/337#pullrequestreview-342153717", "createdAt": "2020-01-13T21:33:15Z", "commit": {"oid": "8d1755ef30feaf888261edef4e0fac8e00f2613b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 726, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}