{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMjczMTg5", "number": 822, "title": "Support subquery in FROM clause in new engine", "bodyText": "Issue #, if available:\n#375\nDescription of changes:\n\nAdded subquery in FROM as table source in grammar and parser\nCreated new tree node RelationSubquery in AST standing for subquery as table\nAdded test cases\nSkipped a broken test case in SubqueryIT.java caused by different schema in new engine\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-11-13T02:12:38Z", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/822", "merged": true, "mergeCommit": {"oid": "d5bf60c7387a19599e010db34ec78b4894e73fcd"}, "closed": true, "closedAt": "2020-11-17T02:00:28Z", "author": {"login": "chloe-zh"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbleyDAH2gAyNTIwMjczMTg5OjEzNGVmZGYzMjZkNzczMjQyNzNmMzA5YjdiNWJlNzQ3OTJlODI0NWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddPkwpAH2gAyNTIwMjczMTg5OmM2NGEwNThlYzk2ZTE1ZDliNjczYWE1ZTM2ODM3Y2FkMzc3ZGMzMjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "134efdf326d77324273f309b7b5be74792e8245a", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/134efdf326d77324273f309b7b5be74792e8245a", "committedDate": "2020-11-11T22:13:18Z", "message": "support subquery in from"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b06b8a75424f482b0f79eda67133b517859e92ad", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/b06b8a75424f482b0f79eda67133b517859e92ad", "committedDate": "2020-11-11T22:26:04Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf540cc7d38a22781a0c9590429ee877e3175b99", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/cf540cc7d38a22781a0c9590429ee877e3175b99", "committedDate": "2020-11-11T22:34:36Z", "message": "added java doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c84ae16caf72413d221678e37bdb371b8592b28", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/8c84ae16caf72413d221678e37bdb371b8592b28", "committedDate": "2020-11-11T23:33:24Z", "message": "added unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9755afd2bff872615d3f27f73ddb2b9c279c9d3e", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/9755afd2bff872615d3f27f73ddb2b9c279c9d3e", "committedDate": "2020-11-13T00:58:55Z", "message": "added comparison test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec1b49f15238703770c14853e177c2e9d4c6641d", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/ec1b49f15238703770c14853e177c2e9d4c6641d", "committedDate": "2020-11-13T01:25:26Z", "message": "skipped a broken test in SubqueryIT.java due to different schema in new engine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b31737b1ed8c1445c44fd1294a5a2ffb43f11d8", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/3b31737b1ed8c1445c44fd1294a5a2ffb43f11d8", "committedDate": "2020-11-13T02:02:40Z", "message": "added case for issue #375"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38707baa6a32ba75879c1497f220bcb0e452bd77", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/38707baa6a32ba75879c1497f220bcb0e452bd77", "committedDate": "2020-11-13T02:05:58Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "080cf31b8843ee80e84b0818c315a372732131bc", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/080cf31b8843ee80e84b0818c315a372732131bc", "committedDate": "2020-11-13T19:50:00Z", "message": "Merge remote-tracking branch 'upstream/develop' into from-subquery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "348b054a2321789a2fb05df98a2f26f026ffe0d9", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/348b054a2321789a2fb05df98a2f26f026ffe0d9", "committedDate": "2020-11-13T20:29:36Z", "message": "update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDE4OTMx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/822#pullrequestreview-530418931", "createdAt": "2020-11-13T21:13:01Z", "commit": {"oid": "348b054a2321789a2fb05df98a2f26f026ffe0d9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToxMzowMVrOHy_u8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMjo0MVrOHy__Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNTA1OA==", "bodyText": "Since alias is not optional in ANTLR grammar, is this check necessary?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/822#discussion_r523235058", "createdAt": "2020-11-13T21:13:01Z", "author": {"login": "dai-chen"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/ast/tree/RelationSubquery.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.sql.ast.tree;\n+\n+import com.amazon.opendistroforelasticsearch.sql.ast.AbstractNodeVisitor;\n+import com.amazon.opendistroforelasticsearch.sql.exception.SemanticCheckException;\n+import com.google.common.collect.ImmutableList;\n+import java.util.List;\n+import java.util.Locale;\n+import lombok.AllArgsConstructor;\n+import lombok.EqualsAndHashCode;\n+import lombok.RequiredArgsConstructor;\n+import lombok.ToString;\n+\n+/**\n+ * Logical plan node of RelationSubquery.\n+ */\n+@AllArgsConstructor\n+@EqualsAndHashCode(callSuper = false)\n+@RequiredArgsConstructor\n+@ToString\n+public class RelationSubquery extends UnresolvedPlan {\n+  private UnresolvedPlan query;\n+  private String alias;\n+\n+  /**\n+   * Take subquery alias as table name.\n+   */\n+  public String getAliasAsTableName() {\n+    if (alias == null) {\n+      throw new SemanticCheckException(\n+          String.format(Locale.ROOT, \"missing table alias for subquery %s\", toString()));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "348b054a2321789a2fb05df98a2f26f026ffe0d9"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNjM5OQ==", "bodyText": "Since we can support subquery now, do we need to pop up context somewhere?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/822#discussion_r523236399", "createdAt": "2020-11-13T21:16:10Z", "author": {"login": "dai-chen"}, "path": "core/src/main/java/com/amazon/opendistroforelasticsearch/sql/analysis/Analyzer.java", "diffHunk": "@@ -118,6 +119,17 @@ public LogicalPlan visitRelation(Relation node, AnalysisContext context) {\n     return new LogicalRelation(node.getTableName());\n   }\n \n+  @Override\n+  public LogicalPlan visitRelationSubquery(RelationSubquery node, AnalysisContext context) {\n+    context.push();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "348b054a2321789a2fb05df98a2f26f026ffe0d9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzOTI2Mw==", "bodyText": "Is this visit necessary?", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/822#discussion_r523239263", "createdAt": "2020-11-13T21:22:41Z", "author": {"login": "dai-chen"}, "path": "sql/src/main/java/com/amazon/opendistroforelasticsearch/sql/sql/parser/context/QuerySpecification.java", "diffHunk": "@@ -170,9 +171,10 @@ public QuerySpecificationCollector(String queryString) {\n     }\n \n     @Override\n-    public Void visitQuerySpecification(QuerySpecificationContext ctx) {\n-      // TODO: avoid collect sub-query\n-      return super.visitQuerySpecification(ctx);\n+    public Void visitSubqueryAsRelation(SubqueryAsRelationContext ctx) {\n+      // skip collecting subquery for current layer\n+      visit(ctx.alias());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "348b054a2321789a2fb05df98a2f26f026ffe0d9"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2d4f241640eda92f80d56376b09757eef24656d", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/e2d4f241640eda92f80d56376b09757eef24656d", "committedDate": "2020-11-13T23:57:11Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTIyMzc2", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/822#pullrequestreview-530522376", "createdAt": "2020-11-14T01:16:41Z", "commit": {"oid": "e2d4f241640eda92f80d56376b09757eef24656d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTExNDMx", "url": "https://github.com/opendistro-for-elasticsearch/sql/pull/822#pullrequestreview-531511431", "createdAt": "2020-11-16T16:51:19Z", "commit": {"oid": "e2d4f241640eda92f80d56376b09757eef24656d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55996732cb6fbc894b73c8a47a139645de3cf454", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/55996732cb6fbc894b73c8a47a139645de3cf454", "committedDate": "2020-11-16T20:16:55Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7083bede0169e7827f2bfa2b6bf2aaeb55f80144", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/7083bede0169e7827f2bfa2b6bf2aaeb55f80144", "committedDate": "2020-11-16T21:52:50Z", "message": "put the context push after subquery analysis recursion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c64a058ec96e15d9b673aa5e36837cad377dc327", "author": {"user": {"login": "chloe-zh", "name": "Chloe"}}, "url": "https://github.com/opendistro-for-elasticsearch/sql/commit/c64a058ec96e15d9b673aa5e36837cad377dc327", "committedDate": "2020-11-17T01:49:46Z", "message": "Merge remote-tracking branch 'upstream/develop' into from-subquery"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 559, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}