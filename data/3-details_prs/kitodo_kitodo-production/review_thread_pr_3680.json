{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxODAxNjE5", "number": 3680, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwODowMDowNVrOD_kGZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzozMzowMFrOEDVHMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3OTc4MzQzOnYy", "diffSide": "RIGHT", "path": "Kitodo/src/main/java/org/kitodo/export/ExportMets.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwODowMDowNVrOGaS6-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwODowMDowNVrOGaS6-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIyNjE3MQ==", "bodyText": "A save to DB is missing here (and above in ExportDms).\nPlease adjust ExportMetsIT to test reload from DB.", "url": "https://github.com/kitodo/kitodo-production/pull/3680#discussion_r430226171", "createdAt": "2020-05-26T08:00:05Z", "author": {"login": "Kathrin-Huber"}, "path": "Kitodo/src/main/java/org/kitodo/export/ExportMets.java", "diffHunk": "@@ -63,12 +63,15 @@\n     public void startExport(Process process) throws IOException, DAOException {\n         User user = ServiceManager.getUserService().getAuthenticatedUser();\n         URI userHome = ServiceManager.getUserService().getHomeDirectory(user);\n+        boolean exported = process.isExported();\n+        process.setExported(true);\n         boolean exportSucessfull = startExport(process, userHome);\n         if (exportSucessfull) {\n-            process.setExported(true);\n-        }\n-        if (Objects.nonNull(process.getParent())) {\n-            startExport(process.getParent());\n+            if (Objects.nonNull(process.getParent())) {\n+                startExport(process.getParent());\n+            }\n+        } else {\n+            process.setExported(exported);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "628461e92e6e22c84773df1ff3d5e1e5d0ca94c6"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxOTIyODU2OnYy", "diffSide": "LEFT", "path": "Kitodo/src/test/java/org/kitodo/production/exporter/download/ExportMetsIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzoxNzo1N1rOGgRxOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwODozOTo1M1rOGgUQAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ5ODc0Ng==", "bodyText": "You are just removing Asserts here?\nAre they not working? Or should they be negated?\nBoth Asserts seems to be valid.", "url": "https://github.com/kitodo/kitodo-production/pull/3680#discussion_r436498746", "createdAt": "2020-06-08T07:17:57Z", "author": {"login": "Kathrin-Huber"}, "path": "Kitodo/src/test/java/org/kitodo/production/exporter/download/ExportMetsIT.java", "diffHunk": "@@ -100,7 +100,6 @@ public void exportMetsTest() throws Exception {\n             fileService.createDirectory(ConfigCore.getUriParameter(ParameterCore.DIR_USERS), userDirectory);\n         }\n \n-        Assert.assertFalse(\"exportedFlag of process should be false\", process.isExported());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ddb192bc4f3107b4cd84e48c371e0299bafc670"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUzOTM5Mg==", "bodyText": "They don't work anymore because I changed it, and I think it should be like this: The exported flag should only be set when exported to DMS, but not if an export to the home directory is carried out. The flag should not be set when exporting to the home directory, isn\u2019t it? That's why I removed the tests for it, too.", "url": "https://github.com/kitodo/kitodo-production/pull/3680#discussion_r436539392", "createdAt": "2020-06-08T08:39:53Z", "author": {"login": "matthias-ronge"}, "path": "Kitodo/src/test/java/org/kitodo/production/exporter/download/ExportMetsIT.java", "diffHunk": "@@ -100,7 +100,6 @@ public void exportMetsTest() throws Exception {\n             fileService.createDirectory(ConfigCore.getUriParameter(ParameterCore.DIR_USERS), userDirectory);\n         }\n \n-        Assert.assertFalse(\"exportedFlag of process should be false\", process.isExported());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ5ODc0Ng=="}, "originalCommit": {"oid": "5ddb192bc4f3107b4cd84e48c371e0299bafc670"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxOTI2ODQ2OnYy", "diffSide": "RIGHT", "path": "Kitodo/src/main/java/org/kitodo/export/ExportDms.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzozMjowN1rOGgSJfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzozMjowN1rOGgSJfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUwNDk1OA==", "bodyText": "Is there a reason to save the process, when the process flagis not changed again? I think this save is only neccessary when export failed and exportflag changed back. It is indeed only neccessary if the flag ACTUALLY changed. This also counts for first save. So if the process is already exported, no save is needed at all", "url": "https://github.com/kitodo/kitodo-production/pull/3680#discussion_r436504958", "createdAt": "2020-06-08T07:32:07Z", "author": {"login": "Kathrin-Huber"}, "path": "Kitodo/src/main/java/org/kitodo/export/ExportDms.java", "diffHunk": "@@ -69,14 +70,19 @@ public ExportDms(boolean exportImages) {\n      *            Process object\n      */\n     @Override\n-    public void startExport(Process process) throws IOException, DAOException {\n+    public void startExport(Process process) throws DAOException, DataException, IOException {\n+        boolean exported = process.isExported();\n+        process.setExported(true);\n+        ServiceManager.getProcessService().save(process);\n         boolean exportSucessfull = startExport(process, (URI) null);\n         if (exportSucessfull) {\n-            process.setExported(true);\n-        }\n-        if (Objects.nonNull(process.getParent())) {\n-            startExport(process.getParent());\n+            if (Objects.nonNull(process.getParent())) {\n+                startExport(process.getParent());\n+            }\n+        } else {\n+            process.setExported(exported);\n         }\n+        ServiceManager.getProcessService().save(process);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ddb192bc4f3107b4cd84e48c371e0299bafc670"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxOTI3MDkwOnYy", "diffSide": "RIGHT", "path": "Kitodo/src/main/java/org/kitodo/export/ExportDms.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzozMzowMFrOGgSLDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzozMzowMFrOGgSLDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUwNTM1Nw==", "bodyText": "DAOException and IOExceotion are never thrown in this method. So if you are already changing the signatur, remove not needed exceptions.", "url": "https://github.com/kitodo/kitodo-production/pull/3680#discussion_r436505357", "createdAt": "2020-06-08T07:33:00Z", "author": {"login": "Kathrin-Huber"}, "path": "Kitodo/src/main/java/org/kitodo/export/ExportDms.java", "diffHunk": "@@ -69,14 +70,19 @@ public ExportDms(boolean exportImages) {\n      *            Process object\n      */\n     @Override\n-    public void startExport(Process process) throws IOException, DAOException {\n+    public void startExport(Process process) throws DAOException, DataException, IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ddb192bc4f3107b4cd84e48c371e0299bafc670"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3921, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}