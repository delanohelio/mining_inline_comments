{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MTg1NDc5", "number": 3924, "title": "Automatically assign media units to the effective root element", "bodyText": "Fixes #3434\nFollow-up pull request to #3921 (immediate diff)", "createdAt": "2020-08-11T15:35:19Z", "url": "https://github.com/kitodo/kitodo-production/pull/3924", "merged": true, "mergeCommit": {"oid": "b88e802f6c741d9b5daa17c8fbb6614c215a6a3e"}, "closed": true, "closedAt": "2020-08-20T19:29:09Z", "author": {"login": "matthias-ronge"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc94vACgBqjM2NDM4MTY1NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAxe7fABqjM2NzU2NzQzNTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7457fa6e132c80b5bbd8a3fcb13e233be94b351e", "author": {"user": null}, "url": "https://github.com/kitodo/kitodo-production/commit/7457fa6e132c80b5bbd8a3fcb13e233be94b351e", "committedDate": "2020-08-11T15:30:51Z", "message": "Automatically assign media units to the effective root element"}, "afterCommit": {"oid": "0101a9dc268bd04bc1cfb0e8205db4c6196f77d4", "author": {"user": null}, "url": "https://github.com/kitodo/kitodo-production/commit/0101a9dc268bd04bc1cfb0e8205db4c6196f77d4", "committedDate": "2020-08-11T15:40:56Z", "message": "Automatically assign media units to the effective root element"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MjM1ODk2", "url": "https://github.com/kitodo/kitodo-production/pull/3924#pullrequestreview-468235896", "createdAt": "2020-08-17T07:42:16Z", "commit": {"oid": "0101a9dc268bd04bc1cfb0e8205db4c6196f77d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzo0MjoxNlrOHBdxuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzo0MjoxNlrOHBdxuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5ODQ5MQ==", "bodyText": "Please give a more descriptive name", "url": "https://github.com/kitodo/kitodo-production/pull/3924#discussion_r471298491", "createdAt": "2020-08-17T07:42:16Z", "author": {"login": "Kathrin-Huber"}, "path": "Kitodo-API/src/main/java/org/kitodo/api/dataformat/View.java", "diffHunk": "@@ -20,6 +20,20 @@\n  * {@code MediaUnit} as a whole.\n  */\n public class View {\n+\n+    /**\n+     * Creates a new view with a media unit.\n+     * \n+     * @param mediaUnit\n+     *            media unit to set in the view\n+     * @return a new view with a media unit\n+     */\n+    public static View of(MediaUnit mediaUnit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0101a9dc268bd04bc1cfb0e8205db4c6196f77d4"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MjM2MzQw", "url": "https://github.com/kitodo/kitodo-production/pull/3924#pullrequestreview-468236340", "createdAt": "2020-08-17T07:43:00Z", "commit": {"oid": "0101a9dc268bd04bc1cfb0e8205db4c6196f77d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzo0MzowMFrOHBdy9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzo0MzowMFrOHBdy9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5ODgwNw==", "bodyText": "why \"automatically\" ? Please remove this prefix", "url": "https://github.com/kitodo/kitodo-production/pull/3924#discussion_r471298807", "createdAt": "2020-08-17T07:43:00Z", "author": {"login": "Kathrin-Huber"}, "path": "Kitodo/src/main/java/org/kitodo/production/services/file/FileService.java", "diffHunk": "@@ -1017,18 +1018,34 @@ public void searchForMedia(Process process, Workpiece workpiece) throws InvalidI\n         }\n         List<String> canonicals = getCanonicalFileNamePartsAndSanitizeAbsoluteURIs(workpiece, subfolders,\n             process.getProcessBaseUri());\n-        addNewURIsToExistingMediaUnits(mediaToAdd, workpiece.getAllMediaUnitsSorted(), canonicals);\n+        addNewURIsToExistingMediaUnits(mediaToAdd, workpiece.getAllMediaUnitsFilteredByTypePageAndSorted(), canonicals);\n         mediaToAdd.keySet().removeAll(canonicals);\n         addNewMediaToWorkpiece(canonicals, mediaToAdd, workpiece);\n         renumberMediaUnits(workpiece, true);\n         if (ConfigCore.getBooleanParameter(ParameterCore.WITH_AUTOMATIC_PAGINATION)) {\n             repaginateMediaUnits(workpiece);\n         }\n+        if (Workpiece.treeStream(workpiece.getRootElement())\n+                .allMatch(includedStructuralElement -> includedStructuralElement.getViews().isEmpty())) {\n+            automaticallyAssignMediaUnitsToEffectiveRootRecursive(workpiece, workpiece.getRootElement());\n+        }\n         if (logger.isTraceEnabled()) {\n             logger.trace(\"Searching for media took {} ms\", TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - begin));\n         }\n     }\n \n+    private void automaticallyAssignMediaUnitsToEffectiveRootRecursive(Workpiece workpiece,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0101a9dc268bd04bc1cfb0e8205db4c6196f77d4"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d26ced829d56c0ea5b4483d90f7550236c3bdfe", "author": {"user": null}, "url": "https://github.com/kitodo/kitodo-production/commit/9d26ced829d56c0ea5b4483d90f7550236c3bdfe", "committedDate": "2020-08-17T12:44:46Z", "message": "Remove 'automatically'"}, "afterCommit": {"oid": "b329b2e7e4701054d63db5f9482929da2b95120c", "author": {"user": null}, "url": "https://github.com/kitodo/kitodo-production/commit/b329b2e7e4701054d63db5f9482929da2b95120c", "committedDate": "2020-08-18T14:48:19Z", "message": "Automatically assign media units to the effective root element"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fe9476c1e2fe33a67ca819400045a3d99b4d717", "author": {"user": null}, "url": "https://github.com/kitodo/kitodo-production/commit/7fe9476c1e2fe33a67ca819400045a3d99b4d717", "committedDate": "2020-08-19T15:13:46Z", "message": "Deduplicate method treeStream() into class Workpiece"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c77e4b16fb3ccda680641e3031cddf1ab008e31", "author": {"user": null}, "url": "https://github.com/kitodo/kitodo-production/commit/9c77e4b16fb3ccda680641e3031cddf1ab008e31", "committedDate": "2020-08-19T15:13:46Z", "message": "Deduplicate method treeStream() into class Workpiece"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b329b2e7e4701054d63db5f9482929da2b95120c", "author": {"user": null}, "url": "https://github.com/kitodo/kitodo-production/commit/b329b2e7e4701054d63db5f9482929da2b95120c", "committedDate": "2020-08-18T14:48:19Z", "message": "Automatically assign media units to the effective root element"}, "afterCommit": {"oid": "503e93faf575cb76c7b69e043a905e676933b6f7", "author": {"user": null}, "url": "https://github.com/kitodo/kitodo-production/commit/503e93faf575cb76c7b69e043a905e676933b6f7", "committedDate": "2020-08-19T15:24:29Z", "message": "Automatically assign media units to the effective root element"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d759ddc2e5f21c303013cdcd59831131ed434f58", "author": {"user": null}, "url": "https://github.com/kitodo/kitodo-production/commit/d759ddc2e5f21c303013cdcd59831131ed434f58", "committedDate": "2020-08-20T14:55:44Z", "message": "Automatically assign media units to the effective root element"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "503e93faf575cb76c7b69e043a905e676933b6f7", "author": {"user": null}, "url": "https://github.com/kitodo/kitodo-production/commit/503e93faf575cb76c7b69e043a905e676933b6f7", "committedDate": "2020-08-19T15:24:29Z", "message": "Automatically assign media units to the effective root element"}, "afterCommit": {"oid": "d759ddc2e5f21c303013cdcd59831131ed434f58", "author": {"user": null}, "url": "https://github.com/kitodo/kitodo-production/commit/d759ddc2e5f21c303013cdcd59831131ed434f58", "committedDate": "2020-08-20T14:55:44Z", "message": "Automatically assign media units to the effective root element"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2839, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}