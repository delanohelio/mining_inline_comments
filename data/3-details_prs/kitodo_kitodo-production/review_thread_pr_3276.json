{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1OTc4MTE5", "number": 3276, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzoxODo0NVrODmrI0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwOToxOTowMlrODoo53w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxODc5MjUwOnYy", "diffSide": "RIGHT", "path": "Kitodo/src/main/java/org/kitodo/production/services/schema/SchemaService.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzoxODo0NVrOF0OWRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNDowMDoyMlrOF04JsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMwNTM0OQ==", "bodyText": "If it is not exported, then the childLinksForExport should not be converted. So \"false\" is more intuitive here, isn't it?", "url": "https://github.com/kitodo/kitodo-production/pull/3276#discussion_r390305349", "createdAt": "2020-03-10T13:18:45Z", "author": {"login": "Kathrin-Huber"}, "path": "Kitodo/src/main/java/org/kitodo/production/services/schema/SchemaService.java", "diffHunk": "@@ -225,18 +226,24 @@ private void addUse(Subfolder useFolder, String canonical, MediaUnit mediaUnit)\n         mediaUnit.getMediaFiles().put(mediaVariant, mediaFile);\n     }\n \n-    private void convertChildrenLinksForExport(Workpiece workpiece, IncludedStructuralElement structure,\n+    private boolean convertChildrenLinksForExport(Workpiece workpiece, IncludedStructuralElement structure,\n                                                LegacyPrefsHelper prefs) throws DAOException, IOException {\n \n         LinkedMetsResource link = structure.getLink();\n         if (Objects.nonNull(link)) {\n             int linkedProcessId = ServiceManager.getProcessService().processIdFromUri(link.getUri());\n             Process process = ServiceManager.getProcessService().getById(linkedProcessId);\n+            if (!process.isExported()) {\n+                return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f76063fe7002faa4ad6279abb73ff8dfbc57d33f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkxNjY3Nw==", "bodyText": "This is to avoid negative conditionals.", "url": "https://github.com/kitodo/kitodo-production/pull/3276#discussion_r390916677", "createdAt": "2020-03-11T11:48:13Z", "author": {"login": "matthias-ronge"}, "path": "Kitodo/src/main/java/org/kitodo/production/services/schema/SchemaService.java", "diffHunk": "@@ -225,18 +226,24 @@ private void addUse(Subfolder useFolder, String canonical, MediaUnit mediaUnit)\n         mediaUnit.getMediaFiles().put(mediaVariant, mediaFile);\n     }\n \n-    private void convertChildrenLinksForExport(Workpiece workpiece, IncludedStructuralElement structure,\n+    private boolean convertChildrenLinksForExport(Workpiece workpiece, IncludedStructuralElement structure,\n                                                LegacyPrefsHelper prefs) throws DAOException, IOException {\n \n         LinkedMetsResource link = structure.getLink();\n         if (Objects.nonNull(link)) {\n             int linkedProcessId = ServiceManager.getProcessService().processIdFromUri(link.getUri());\n             Process process = ServiceManager.getProcessService().getById(linkedProcessId);\n+            if (!process.isExported()) {\n+                return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMwNTM0OQ=="}, "originalCommit": {"oid": "f76063fe7002faa4ad6279abb73ff8dfbc57d33f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk4MDAwMQ==", "bodyText": "if (!process.isExported()) is a \"negative conditional\", isn't it?", "url": "https://github.com/kitodo/kitodo-production/pull/3276#discussion_r390980001", "createdAt": "2020-03-11T13:45:40Z", "author": {"login": "solth"}, "path": "Kitodo/src/main/java/org/kitodo/production/services/schema/SchemaService.java", "diffHunk": "@@ -225,18 +226,24 @@ private void addUse(Subfolder useFolder, String canonical, MediaUnit mediaUnit)\n         mediaUnit.getMediaFiles().put(mediaVariant, mediaFile);\n     }\n \n-    private void convertChildrenLinksForExport(Workpiece workpiece, IncludedStructuralElement structure,\n+    private boolean convertChildrenLinksForExport(Workpiece workpiece, IncludedStructuralElement structure,\n                                                LegacyPrefsHelper prefs) throws DAOException, IOException {\n \n         LinkedMetsResource link = structure.getLink();\n         if (Objects.nonNull(link)) {\n             int linkedProcessId = ServiceManager.getProcessService().processIdFromUri(link.getUri());\n             Process process = ServiceManager.getProcessService().getById(linkedProcessId);\n+            if (!process.isExported()) {\n+                return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMwNTM0OQ=="}, "originalCommit": {"oid": "f76063fe7002faa4ad6279abb73ff8dfbc57d33f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk4ODkwNw==", "bodyText": "Would you prefer a process.isNotYetExported()?", "url": "https://github.com/kitodo/kitodo-production/pull/3276#discussion_r390988907", "createdAt": "2020-03-11T13:58:27Z", "author": {"login": "matthias-ronge"}, "path": "Kitodo/src/main/java/org/kitodo/production/services/schema/SchemaService.java", "diffHunk": "@@ -225,18 +226,24 @@ private void addUse(Subfolder useFolder, String canonical, MediaUnit mediaUnit)\n         mediaUnit.getMediaFiles().put(mediaVariant, mediaFile);\n     }\n \n-    private void convertChildrenLinksForExport(Workpiece workpiece, IncludedStructuralElement structure,\n+    private boolean convertChildrenLinksForExport(Workpiece workpiece, IncludedStructuralElement structure,\n                                                LegacyPrefsHelper prefs) throws DAOException, IOException {\n \n         LinkedMetsResource link = structure.getLink();\n         if (Objects.nonNull(link)) {\n             int linkedProcessId = ServiceManager.getProcessService().processIdFromUri(link.getUri());\n             Process process = ServiceManager.getProcessService().getById(linkedProcessId);\n+            if (!process.isExported()) {\n+                return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMwNTM0OQ=="}, "originalCommit": {"oid": "f76063fe7002faa4ad6279abb73ff8dfbc57d33f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk5MDI1Nw==", "bodyText": "What is wrong about\nif (process.isExported()) {\n    return false;\n}\n\n?", "url": "https://github.com/kitodo/kitodo-production/pull/3276#discussion_r390990257", "createdAt": "2020-03-11T14:00:22Z", "author": {"login": "solth"}, "path": "Kitodo/src/main/java/org/kitodo/production/services/schema/SchemaService.java", "diffHunk": "@@ -225,18 +226,24 @@ private void addUse(Subfolder useFolder, String canonical, MediaUnit mediaUnit)\n         mediaUnit.getMediaFiles().put(mediaVariant, mediaFile);\n     }\n \n-    private void convertChildrenLinksForExport(Workpiece workpiece, IncludedStructuralElement structure,\n+    private boolean convertChildrenLinksForExport(Workpiece workpiece, IncludedStructuralElement structure,\n                                                LegacyPrefsHelper prefs) throws DAOException, IOException {\n \n         LinkedMetsResource link = structure.getLink();\n         if (Objects.nonNull(link)) {\n             int linkedProcessId = ServiceManager.getProcessService().processIdFromUri(link.getUri());\n             Process process = ServiceManager.getProcessService().getById(linkedProcessId);\n+            if (!process.isExported()) {\n+                return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMwNTM0OQ=="}, "originalCommit": {"oid": "f76063fe7002faa4ad6279abb73ff8dfbc57d33f"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzOTM5NjY2OnYy", "diffSide": "RIGHT", "path": "Kitodo/src/main/java/org/kitodo/production/services/schema/SchemaService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwOToxODozNlrOF3TtMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwOToxODozNlrOF3TtMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUzODg2Nw==", "bodyText": "now you have even two negative conditions. Please swap the if contents", "url": "https://github.com/kitodo/kitodo-production/pull/3276#discussion_r393538867", "createdAt": "2020-03-17T09:18:36Z", "author": {"login": "Kathrin-Huber"}, "path": "Kitodo/src/main/java/org/kitodo/production/services/schema/SchemaService.java", "diffHunk": "@@ -226,24 +226,38 @@ private void addUse(Subfolder useFolder, String canonical, MediaUnit mediaUnit)\n         mediaUnit.getMediaFiles().put(mediaVariant, mediaFile);\n     }\n \n-    private boolean convertChildrenLinksForExport(Workpiece workpiece, IncludedStructuralElement structure,\n+    /**\n+     * Replaces internal links in child structure elements with a publicly\n+     * resolvable link. Checks whether the linked process has not yet been\n+     * exported, in which case false is returned to delete the link from the\n+     * parental list.\n+     *\n+     * @param workpiece\n+     *            current workpiece\n+     * @param structure\n+     *            current structure\n+     * @param prefs\n+     *            legacy ruleset wrapper\n+     * @return whether the current structure shall not be deleted\n+     */\n+    private boolean convertChildrenLinksForExportRecursive(Workpiece workpiece, IncludedStructuralElement structure,\n                                                LegacyPrefsHelper prefs) throws DAOException, IOException {\n \n         LinkedMetsResource link = structure.getLink();\n         if (Objects.nonNull(link)) {\n             int linkedProcessId = ServiceManager.getProcessService().processIdFromUri(link.getUri());\n             Process process = ServiceManager.getProcessService().getById(linkedProcessId);\n             if (!process.isExported()) {\n-                return true;\n+                return false;\n             }\n             setLinkForExport(structure, process, prefs, workpiece);\n         }\n         for (Iterator<IncludedStructuralElement> iterator = structure.getChildren().iterator(); iterator.hasNext();) {\n-            if (convertChildrenLinksForExport(workpiece, iterator.next(), prefs)) {\n+            if (!convertChildrenLinksForExportRecursive(workpiece, iterator.next(), prefs)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f94367d0fce65f89a1643b781472933ed3d4921f"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzOTM5ODA3OnYy", "diffSide": "RIGHT", "path": "Kitodo/src/main/java/org/kitodo/production/services/schema/SchemaService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwOToxOTowMlrOF3TuGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwOToxOTowMlrOF3TuGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUzOTA5Ng==", "bodyText": "please don't use the word \"recursive\" in a method.", "url": "https://github.com/kitodo/kitodo-production/pull/3276#discussion_r393539096", "createdAt": "2020-03-17T09:19:02Z", "author": {"login": "Kathrin-Huber"}, "path": "Kitodo/src/main/java/org/kitodo/production/services/schema/SchemaService.java", "diffHunk": "@@ -86,7 +86,7 @@\n         set(workpiece, MdSec.TECH_MD, \"purlUrl\", vp.replace(process.getProject().getMetsPurl()));\n         set(workpiece, MdSec.TECH_MD, \"contentIDs\", vp.replace(process.getProject().getMetsContentIDs()));\n \n-        convertChildrenLinksForExport(workpiece, workpiece.getRootElement(), prefs);\n+        convertChildrenLinksForExportRecursive(workpiece, workpiece.getRootElement(), prefs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f94367d0fce65f89a1643b781472933ed3d4921f"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4009, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}