{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMjM5ODk4", "number": 990, "title": "feat(LicenseDataModel): Merge LiceneObligation with Obligation", "bodyText": "Please provide a summary of your changes here.\n\n\nWhich issue is this pull request belonging to and how is it solving it? (#989)\nDid you add or update any new dependencies that are required for your change? -No\n\nIssue: Fixes: #989\nSuggest Reviewer\nHow To Test?\n\nNeed to test the license import and export functionality and adding obligation to licenses\n\nChecklist\nMust:\n\n All related issues are referenced in commit messages and in PR\n\nSigned-off-by: Smruti Prakash Sahoo smruti.sahoo@siemens.com", "createdAt": "2020-09-21T11:52:25Z", "url": "https://github.com/eclipse/sw360/pull/990", "merged": true, "mergeCommit": {"oid": "0cebbb8fca05a06233bb753655d85dbf44e74931"}, "closed": true, "closedAt": "2020-10-01T12:00:15Z", "author": {"login": "smrutis1"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLEKzEgBqjM3ODg5Mzg0NDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOO6OzgFqTUwMDIxNjAxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "575fa9df77a6e6e33400ecc096879e6dec07c8bb", "author": {"user": {"login": "smrutis1", "name": "Smruti Prakash Sahoo"}}, "url": "https://github.com/eclipse/sw360/commit/575fa9df77a6e6e33400ecc096879e6dec07c8bb", "committedDate": "2020-09-21T11:45:30Z", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>"}, "afterCommit": {"oid": "a40cf71c8f103382e82c09e5e35aed3220ec51b3", "author": {"user": {"login": "smrutis1", "name": "Smruti Prakash Sahoo"}}, "url": "https://github.com/eclipse/sw360/commit/a40cf71c8f103382e82c09e5e35aed3220ec51b3", "committedDate": "2020-09-21T14:21:06Z", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a40cf71c8f103382e82c09e5e35aed3220ec51b3", "author": {"user": {"login": "smrutis1", "name": "Smruti Prakash Sahoo"}}, "url": "https://github.com/eclipse/sw360/commit/a40cf71c8f103382e82c09e5e35aed3220ec51b3", "committedDate": "2020-09-21T14:21:06Z", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>"}, "afterCommit": {"oid": "5851700c910a390b448554a5f227662f732d8ec5", "author": {"user": {"login": "smrutis1", "name": "Smruti Prakash Sahoo"}}, "url": "https://github.com/eclipse/sw360/commit/5851700c910a390b448554a5f227662f732d8ec5", "committedDate": "2020-09-22T05:16:18Z", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjI4MzYw", "url": "https://github.com/eclipse/sw360/pull/990#pullrequestreview-495228360", "createdAt": "2020-09-24T05:25:29Z", "commit": {"oid": "5851700c910a390b448554a5f227662f732d8ec5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNToyNToyOVrOHXKLlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNzo0ODozM1rOHXN9Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA0NjEwMQ==", "bodyText": "Kindly remove unused imports.", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r494046101", "createdAt": "2020-09-24T05:25:29Z", "author": {"login": "JaideepPalit"}, "path": "backend/src/src-licenses/src/test/java/org/eclipse/sw360/licenses/TestLicenseClient.java", "diffHunk": "@@ -12,7 +12,7 @@\n import com.google.common.collect.ImmutableList;\n import org.eclipse.sw360.datahandler.thrift.licenses.License;\n import org.eclipse.sw360.datahandler.thrift.licenses.LicenseService;\n-import org.eclipse.sw360.datahandler.thrift.licenses.LicenseObligation;\n+/*import org.eclipse.sw360.datahandler.thrift.licenses.LicenseObligation;*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5851700c910a390b448554a5f227662f732d8ec5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA0NzA3MQ==", "bodyText": "Kindly consider removing commented lines from language properties", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r494047071", "createdAt": "2020-09-24T05:28:56Z", "author": {"login": "JaideepPalit"}, "path": "frontend/sw360-portlet/src/main/resources/content/Language.properties", "diffHunk": "@@ -1138,7 +1138,7 @@ to.be.replaced=To be replaced\n obligation=Obligation\n obligation.details=Obligation Details\n obligations=Obligations\n-obligations.and.obligations=Todos and Obligations\n+#obligations.and.obligations=Todos and Obligations", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5851700c910a390b448554a5f227662f732d8ec5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1NjI2OA==", "bodyText": "Remove commented code", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r494056268", "createdAt": "2020-09-24T05:58:31Z", "author": {"login": "JaideepPalit"}, "path": "libraries/lib-datahandler/src/main/java/org/eclipse/sw360/datahandler/thrift/ThriftUtils.java", "diffHunk": "@@ -55,7 +55,8 @@\n             .add(AttachmentContent.class) // Attachment service\n             .add(AttachmentUsage.class) // Attachment service\n             .add(Component.class).add(Release.class) // Component service\n-            .add(License.class).add(Obligation.class).add(LicenseObligation.class) // License service\n+            .add(License.class).add(Obligation.class)\n+//            .add(LicenseObligation.class) // License service", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5851700c910a390b448554a5f227662f732d8ec5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEwNzk3OQ==", "bodyText": "Maybe more info can be added to this statement like Id.\nCurrent O/P\nGetting all obligation with field obligationDatabaseIds\nfound 7 obligation with field obligationDatabaseIds in db!\nRemoving field name obligationDatabaseIds starts\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r494107979", "createdAt": "2020-09-24T07:48:33Z", "author": {"login": "JaideepPalit"}, "path": "scripts/migrations/030_obligation_field_update.py", "diffHunk": "@@ -0,0 +1,86 @@\n+#!/usr/bin/python\n+# -----------------------------------------------------------------------------\n+# Copyright Siemens AG, 2020. Part of the SW360 Portal Project.\n+#\n+# This program and the accompanying materials are made\n+# available under the terms of the Eclipse Public License 2.0\n+# which is available at https://www.eclipse.org/legal/epl-2.0/\n+#\n+# SPDX-License-Identifier: EPL-2.0\n+#\n+# This is a manual database migration script. It is assumed that a\n+# dedicated framework for automatic migration will be written in the\n+# future. When that happens, this script should be refactored to conform\n+# to the framework's prerequisites to be run by the framework. For\n+# example, server address and db name should be parameterized, the code\n+# reorganized into a single class or function, etc.\n+#\n+# This script removes the \"obligationDatabaseIds\" from obligation\n+# ---------------------------------------------------------------------------------------------------------------------------------------------------------------\n+\n+import time\n+import couchdb\n+import json\n+from webbrowser import get\n+\n+# ---------------------------------------\n+# constants\n+# ---------------------------------------\n+\n+DRY_RUN = True\n+\n+COUCHSERVER = \"http://localhost:5984/\"\n+DBNAME = 'sw360db'\n+\n+couch=couchdb.Server(COUCHSERVER)\n+db = couch[DBNAME]\n+\n+# set fieldName\n+deleteFieldName = \"obligationDatabaseIds\"\n+\n+# ----------------------------------------\n+# queries\n+# ----------------------------------------\n+\n+# get all obligation with field \"obligationDatabaseIds\"\n+obligation_with_obligationDatabaseIds_query = {\"selector\": {\"type\": {\"$eq\": \"obligation\"},deleteFieldName: {\"$exists\": True}}}\n+\n+# ---------------------------------------\n+# functions\n+# ---------------------------------------\n+\n+def removeFieldName(qryResult, fieldToBeRemoved, log):\n+    print 'Removing field name '+fieldToBeRemoved+' starts'\n+    log['Updated obligation fields '+fieldToBeRemoved] = []\n+    for entity in qryResult:\n+        del entity[''+fieldToBeRemoved+'']\n+        if not DRY_RUN:\n+            db.save(entity)\n+            print 'Removing field name '+fieldToBeRemoved+' done'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5851700c910a390b448554a5f227662f732d8ec5"}, "originalPosition": 59}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5851700c910a390b448554a5f227662f732d8ec5", "author": {"user": {"login": "smrutis1", "name": "Smruti Prakash Sahoo"}}, "url": "https://github.com/eclipse/sw360/commit/5851700c910a390b448554a5f227662f732d8ec5", "committedDate": "2020-09-22T05:16:18Z", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>"}, "afterCommit": {"oid": "c1abe6a7680532c20a6128d00b76b3cd3d157640", "author": {"user": {"login": "smrutis1", "name": "Smruti Prakash Sahoo"}}, "url": "https://github.com/eclipse/sw360/commit/c1abe6a7680532c20a6128d00b76b3cd3d157640", "committedDate": "2020-09-25T14:01:30Z", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1abe6a7680532c20a6128d00b76b3cd3d157640", "author": {"user": {"login": "smrutis1", "name": "Smruti Prakash Sahoo"}}, "url": "https://github.com/eclipse/sw360/commit/c1abe6a7680532c20a6128d00b76b3cd3d157640", "committedDate": "2020-09-25T14:01:30Z", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>"}, "afterCommit": {"oid": "014d288603b583b38d318f950001d466e2d8d752", "author": {"user": {"login": "smrutis1", "name": "Smruti Prakash Sahoo"}}, "url": "https://github.com/eclipse/sw360/commit/014d288603b583b38d318f950001d466e2d8d752", "committedDate": "2020-10-01T05:35:48Z", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTI5Njg5", "url": "https://github.com/eclipse/sw360/pull/990#pullrequestreview-500129689", "createdAt": "2020-10-01T08:42:19Z", "commit": {"oid": "014d288603b583b38d318f950001d466e2d8d752"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODo0MjoxOVrOHbAYXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODo0MjoxOVrOHbAYXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3OTgzNw==", "bodyText": "that seems to be the only relevant part for the if-else", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r498079837", "createdAt": "2020-10-01T08:42:19Z", "author": {"login": "mcjaeger"}, "path": "frontend/sw360-portlet/src/main/java/org/eclipse/sw360/portal/portlets/licenses/LicensesPortlet.java", "diffHunk": "@@ -405,46 +410,55 @@ public void addObligations(ActionRequest request, ActionResponse response) throw\n         String licenseID = request.getParameter(LICENSE_ID);\n         String[] obligationIds = request.getParameterValues(\"obligations\");\n         String obligsText = request.getParameter(\"obligText\");\n+        String obligTitle = request.getParameter(\"obligTitle\");\n         String[] bools = request.getParameterValues(\"bools\");\n \n-\n-        Obligation oblig = new Obligation();\n-        //add temporary id\n-        oblig.setId(TMP_TODO_ID_PREFIX + UUID.randomUUID().toString());\n-        if (obligationIds != null) {\n-            for (String obligationId : obligationIds) {\n-                if (obligationId != null && !obligationId.isEmpty()) {\n-                    oblig.addToObligationDatabaseIds(obligationId);\n-                }\n-            }\n-        } else {\n-            oblig.setObligationDatabaseIds(Collections.emptySet());\n-        }\n-        oblig.setText(obligsText);\n-        oblig.setTitle(StringUtils.EMPTY);\n-\n         User user = UserCacheHolder.getUserFromRequest(request);\n         String moderationComment = request.getParameter(PortalConstants.MODERATION_REQUEST_COMMENT);\n         if(moderationComment != null) {\n             user.setCommentMadeDuringModerationRequest(moderationComment);\n         }\n \n-        oblig.addToWhitelist(user.getDepartment());\n-\n-        if (bools != null) {\n-            List<String> theBools = Arrays.asList(bools);\n-            oblig.setDevelopment(theBools.contains(\"development\"));\n-            oblig.setDistribution(theBools.contains(\"distribution\"));\n-        } else {\n-            oblig.setDevelopment(false);\n-            oblig.setDistribution(false);\n-        }\n         try {\n             LicenseService.Iface client = thriftClients.makeLicenseClient();\n-            RequestStatus requestStatus = client.addObligationsToLicense(oblig, licenseID, user);\n-\n-            setSessionMessage(request, requestStatus, \"License\", \"update\");\n-\n+            if (null == obligationIds) {\n+                if (CommonUtils.isNotNullEmptyOrWhitespace(obligsText)) {\n+                    Obligation obl = new Obligation();\n+                    obl.setId(TMP_OBLIGATION_ID_PREFIX + UUID.randomUUID().toString());\n+                    obl.setText(obligsText);\n+                    obl.addToWhitelist(user.getDepartment());\n+                    obl.setTitle(obligTitle);\n+                    obl.setObligationLevel(ObligationLevel.LICENSE_OBLIGATION);\n+                    if (bools != null) {\n+                        List<String> theBools = Arrays.asList(bools);\n+                        obl.setDevelopment(theBools.contains(\"development\"));\n+                        obl.setDistribution(theBools.contains(\"distribution\"));\n+                    } else {\n+                        obl.setDevelopment(false);\n+                        obl.setDistribution(false);\n+                    }\n+                    RequestStatus requestStatus = client.addObligationsToLicense(obl, licenseID, user);\n+                    setSessionMessage(request, requestStatus, \"License\", \"update\");\n+                }\n+            } else {\n+                List<Obligation> obls = client.getObligationsByIds(Arrays.asList(obligationIds));\n+                obls.stream().filter(Objects::nonNull).forEach(obl -> wrapException(() -> {\n+                    Obligation oblCopy = obl.deepCopy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "014d288603b583b38d318f950001d466e2d8d752"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcfec496e632f4c465f621ad9f30edcf21b85455", "author": {"user": {"login": "smrutis1", "name": "Smruti Prakash Sahoo"}}, "url": "https://github.com/eclipse/sw360/commit/fcfec496e632f4c465f621ad9f30edcf21b85455", "committedDate": "2020-10-01T09:51:32Z", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "014d288603b583b38d318f950001d466e2d8d752", "author": {"user": {"login": "smrutis1", "name": "Smruti Prakash Sahoo"}}, "url": "https://github.com/eclipse/sw360/commit/014d288603b583b38d318f950001d466e2d8d752", "committedDate": "2020-10-01T05:35:48Z", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>"}, "afterCommit": {"oid": "fcfec496e632f4c465f621ad9f30edcf21b85455", "author": {"user": {"login": "smrutis1", "name": "Smruti Prakash Sahoo"}}, "url": "https://github.com/eclipse/sw360/commit/fcfec496e632f4c465f621ad9f30edcf21b85455", "committedDate": "2020-10-01T09:51:32Z", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMjE2MDE3", "url": "https://github.com/eclipse/sw360/pull/990#pullrequestreview-500216017", "createdAt": "2020-10-01T10:34:27Z", "commit": {"oid": "fcfec496e632f4c465f621ad9f30edcf21b85455"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4846, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}